!function(window,undefined){var readyList,rootjQuery,core_strundefined=typeof undefined,location=window.location,document=window.document,docElem=document.documentElement,_jQuery=window.jQuery,_$=window.$,class2type={},core_deletedIds=[],core_concat=core_deletedIds.concat,core_push=core_deletedIds.push,core_slice=core_deletedIds.slice,core_indexOf=core_deletedIds.indexOf,core_toString=class2type.toString,core_hasOwn=class2type.hasOwnProperty,core_trim="1.10.2".trim,jQuery=function(selector,context){return new jQuery.fn.init(selector,context,rootjQuery)},core_pnum=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,core_rnotwhite=/\S+/g,rtrim=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,rquickExpr=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,rsingleTag=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,rvalidchars=/^[\],:{}\s]*$/,rvalidbraces=/(?:^|:|,)(?:\s*\[)+/g,rvalidescape=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,rvalidtokens=/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,rmsPrefix=/^-ms-/,rdashAlpha=/-([\da-z])/gi,fcamelCase=function(all,letter){return letter.toUpperCase()},completed=function(event){(document.addEventListener||"load"===event.type||"complete"===document.readyState)&&(detach(),jQuery.ready())},detach=function(){document.addEventListener?(document.removeEventListener("DOMContentLoaded",completed,!1),window.removeEventListener("load",completed,!1)):(document.detachEvent("onreadystatechange",completed),window.detachEvent("onload",completed))};jQuery.fn=jQuery.prototype={jquery:"1.10.2",constructor:jQuery,init:function(selector,context,rootjQuery){var match,elem;if(!selector)return this;if("string"==typeof selector){if(!(match="<"===selector.charAt(0)&&">"===selector.charAt(selector.length-1)&&selector.length>=3?[null,selector,null]:rquickExpr.exec(selector))||!match[1]&&context)return!context||context.jquery?(context||rootjQuery).find(selector):this.constructor(context).find(selector);if(match[1]){if(context=context instanceof jQuery?context[0]:context,jQuery.merge(this,jQuery.parseHTML(match[1],context&&context.nodeType?context.ownerDocument||context:document,!0)),rsingleTag.test(match[1])&&jQuery.isPlainObject(context))for(match in context)jQuery.isFunction(this[match])?this[match](context[match]):this.attr(match,context[match]);return this}if((elem=document.getElementById(match[2]))&&elem.parentNode){if(elem.id!==match[2])return rootjQuery.find(selector);this.length=1,this[0]=elem}return this.context=document,this.selector=selector,this}return selector.nodeType?(this.context=this[0]=selector,this.length=1,this):jQuery.isFunction(selector)?rootjQuery.ready(selector):(selector.selector!==undefined&&(this.selector=selector.selector,this.context=selector.context),jQuery.makeArray(selector,this))},selector:"",length:0,toArray:function(){return core_slice.call(this)},get:function(num){return null==num?this.toArray():num<0?this[this.length+num]:this[num]},pushStack:function(elems){var ret=jQuery.merge(this.constructor(),elems);return ret.prevObject=this,ret.context=this.context,ret},each:function(callback,args){return jQuery.each(this,callback,args)},ready:function(fn){return jQuery.ready.promise().done(fn),this},slice:function(){return this.pushStack(core_slice.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(i){var len=this.length,j=+i+(i<0?len:0);return this.pushStack(j>=0&&j<len?[this[j]]:[])},map:function(callback){return this.pushStack(jQuery.map(this,function(elem,i){return callback.call(elem,i,elem)}))},end:function(){return this.prevObject||this.constructor(null)},push:core_push,sort:[].sort,splice:[].splice},jQuery.fn.init.prototype=jQuery.fn,jQuery.extend=jQuery.fn.extend=function(){var src,copyIsArray,copy,name,options,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=!1;for("boolean"==typeof target&&(deep=target,target=arguments[1]||{},i=2),"object"==typeof target||jQuery.isFunction(target)||(target={}),length===i&&(target=this,--i);i<length;i++)if(null!=(options=arguments[i]))for(name in options)src=target[name],copy=options[name],target!==copy&&(deep&&copy&&(jQuery.isPlainObject(copy)||(copyIsArray=jQuery.isArray(copy)))?(copyIsArray?(copyIsArray=!1,clone=src&&jQuery.isArray(src)?src:[]):clone=src&&jQuery.isPlainObject(src)?src:{},target[name]=jQuery.extend(deep,clone,copy)):copy!==undefined&&(target[name]=copy));return target},jQuery.extend({expando:"jQuery"+("1.10.2"+Math.random()).replace(/\D/g,""),noConflict:function(deep){return window.$===jQuery&&(window.$=_$),deep&&window.jQuery===jQuery&&(window.jQuery=_jQuery),jQuery},isReady:!1,readyWait:1,holdReady:function(hold){hold?jQuery.readyWait++:jQuery.ready(!0)},ready:function(wait){if(!0===wait?!--jQuery.readyWait:!jQuery.isReady){if(!document.body)return setTimeout(jQuery.ready);jQuery.isReady=!0,!0!==wait&&--jQuery.readyWait>0||(readyList.resolveWith(document,[jQuery]),jQuery.fn.trigger&&jQuery(document).trigger("ready").off("ready"))}},isFunction:function(obj){return"function"===jQuery.type(obj)},isArray:Array.isArray||function(obj){return"array"===jQuery.type(obj)},isWindow:function(obj){return null!=obj&&obj==obj.window},isNumeric:function(obj){return!isNaN(parseFloat(obj))&&isFinite(obj)},type:function(obj){return null==obj?String(obj):"object"==typeof obj||"function"==typeof obj?class2type[core_toString.call(obj)]||"object":typeof obj},isPlainObject:function(obj){var key;if(!obj||"object"!==jQuery.type(obj)||obj.nodeType||jQuery.isWindow(obj))return!1;try{if(obj.constructor&&!core_hasOwn.call(obj,"constructor")&&!core_hasOwn.call(obj.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}if(jQuery.support.ownLast)for(key in obj)return core_hasOwn.call(obj,key);for(key in obj);return key===undefined||core_hasOwn.call(obj,key)},isEmptyObject:function(obj){var name;for(name in obj)return!1;return!0},error:function(msg){throw new Error(msg)},parseHTML:function(data,context,keepScripts){if(!data||"string"!=typeof data)return null;"boolean"==typeof context&&(keepScripts=context,context=!1),context=context||document;var parsed=rsingleTag.exec(data),scripts=!keepScripts&&[];return parsed?[context.createElement(parsed[1])]:(parsed=jQuery.buildFragment([data],context,scripts),scripts&&jQuery(scripts).remove(),jQuery.merge([],parsed.childNodes))},parseJSON:function(data){return window.JSON&&window.JSON.parse?window.JSON.parse(data):null===data?data:"string"==typeof data&&(data=jQuery.trim(data))&&rvalidchars.test(data.replace(rvalidescape,"@").replace(rvalidtokens,"]").replace(rvalidbraces,""))?new Function("return "+data)():void jQuery.error("Invalid JSON: "+data)},parseXML:function(data){var xml,tmp;if(!data||"string"!=typeof data)return null;try{window.DOMParser?(tmp=new DOMParser,xml=tmp.parseFromString(data,"text/xml")):(xml=new ActiveXObject("Microsoft.XMLDOM"),xml.async="false",xml.loadXML(data))}catch(e){xml=undefined}return xml&&xml.documentElement&&!xml.getElementsByTagName("parsererror").length||jQuery.error("Invalid XML: "+data),xml},noop:function(){},globalEval:function(data){data&&jQuery.trim(data)&&(window.execScript||function(data){window.eval.call(window,data)})(data)},camelCase:function(string){return string.replace(rmsPrefix,"ms-").replace(rdashAlpha,fcamelCase)},nodeName:function(elem,name){return elem.nodeName&&elem.nodeName.toLowerCase()===name.toLowerCase()},each:function(obj,callback,args){var i=0,length=obj.length,isArray=isArraylike(obj);if(args){if(isArray)for(;i<length&&!1!==callback.apply(obj[i],args);i++);else for(i in obj)if(!1===callback.apply(obj[i],args))break}else if(isArray)for(;i<length&&!1!==callback.call(obj[i],i,obj[i]);i++);else for(i in obj)if(!1===callback.call(obj[i],i,obj[i]))break;return obj},trim:core_trim&&!core_trim.call("\ufeffÂ ")?function(text){return null==text?"":core_trim.call(text)}:function(text){return null==text?"":(text+"").replace(rtrim,"")},makeArray:function(arr,results){var ret=results||[];return null!=arr&&(isArraylike(Object(arr))?jQuery.merge(ret,"string"==typeof arr?[arr]:arr):core_push.call(ret,arr)),ret},inArray:function(elem,arr,i){var len;if(arr){if(core_indexOf)return core_indexOf.call(arr,elem,i);for(len=arr.length,i=i?i<0?Math.max(0,len+i):i:0;i<len;i++)if(i in arr&&arr[i]===elem)return i}return-1},merge:function(first,second){var l=second.length,i=first.length,j=0;if("number"==typeof l)for(;j<l;j++)first[i++]=second[j];else for(;second[j]!==undefined;)first[i++]=second[j++];return first.length=i,first},grep:function(elems,callback,inv){var retVal,ret=[],i=0,length=elems.length;for(inv=!!inv;i<length;i++)retVal=!!callback(elems[i],i),inv!==retVal&&ret.push(elems[i]);return ret},map:function(elems,callback,arg){var value,i=0,length=elems.length,isArray=isArraylike(elems),ret=[];if(isArray)for(;i<length;i++)null!=(value=callback(elems[i],i,arg))&&(ret[ret.length]=value);else for(i in elems)null!=(value=callback(elems[i],i,arg))&&(ret[ret.length]=value);return core_concat.apply([],ret)},guid:1,proxy:function(fn,context){var args,proxy,tmp;return"string"==typeof context&&(tmp=fn[context],context=fn,fn=tmp),jQuery.isFunction(fn)?(args=core_slice.call(arguments,2),proxy=function(){return fn.apply(context||this,args.concat(core_slice.call(arguments)))},proxy.guid=fn.guid=fn.guid||jQuery.guid++,proxy):undefined},access:function(elems,fn,key,value,chainable,emptyGet,raw){var i=0,length=elems.length,bulk=null==key;if("object"===jQuery.type(key)){chainable=!0;for(i in key)jQuery.access(elems,fn,i,key[i],!0,emptyGet,raw)}else if(value!==undefined&&(chainable=!0,jQuery.isFunction(value)||(raw=!0),bulk&&(raw?(fn.call(elems,value),fn=null):(bulk=fn,fn=function(elem,key,value){return bulk.call(jQuery(elem),value)})),fn))for(;i<length;i++)fn(elems[i],key,raw?value:value.call(elems[i],i,fn(elems[i],key)));return chainable?elems:bulk?fn.call(elems):length?fn(elems[0],key):emptyGet},now:function(){return(new Date).getTime()},swap:function(elem,options,callback,args){var ret,name,old={};for(name in options)old[name]=elem.style[name],elem.style[name]=options[name];ret=callback.apply(elem,args||[]);for(name in options)elem.style[name]=old[name];return ret}}),jQuery.ready.promise=function(obj){if(!readyList)if(readyList=jQuery.Deferred(),"complete"===document.readyState)setTimeout(jQuery.ready);else if(document.addEventListener)document.addEventListener("DOMContentLoaded",completed,!1),window.addEventListener("load",completed,!1);else{document.attachEvent("onreadystatechange",completed),window.attachEvent("onload",completed);var top=!1;try{top=null==window.frameElement&&document.documentElement}catch(e){}top&&top.doScroll&&function doScrollCheck(){if(!jQuery.isReady){try{top.doScroll("left")}catch(e){return setTimeout(doScrollCheck,50)}detach(),jQuery.ready()}}()}return readyList.promise(obj)},jQuery.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(i,name){class2type["[object "+name+"]"]=name.toLowerCase()});function isArraylike(obj){var length=obj.length,type=jQuery.type(obj);return!jQuery.isWindow(obj)&&(!(1!==obj.nodeType||!length)||("array"===type||"function"!==type&&(0===length||"number"==typeof length&&length>0&&length-1 in obj)))}rootjQuery=jQuery(document),function(window,undefined){var i,support,cachedruns,Expr,getText,isXML,compile,outermostContext,sortInput,setDocument,document,docElem,documentIsHTML,rbuggyQSA,rbuggyMatches,matches,contains,expando="sizzle"+-new Date,preferredDoc=window.document,dirruns=0,done=0,classCache=createCache(),tokenCache=createCache(),compilerCache=createCache(),hasDuplicate=!1,sortOrder=function(a,b){return a===b?(hasDuplicate=!0,0):0},MAX_NEGATIVE=1<<31,hasOwn={}.hasOwnProperty,arr=[],pop=arr.pop,push_native=arr.push,push=arr.push,slice=arr.slice,indexOf=arr.indexOf||function(elem){for(var i=0,len=this.length;i<len;i++)if(this[i]===elem)return i;return-1},booleans="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",whitespace="[\\x20\\t\\r\\n\\f]",characterEncoding="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",identifier=characterEncoding.replace("w","w#"),attributes="\\["+whitespace+"*("+characterEncoding+")"+whitespace+"*(?:([*^$|!~]?=)"+whitespace+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+identifier+")|)|)"+whitespace+"*\\]",pseudos=":("+characterEncoding+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+attributes.replace(3,8)+")*)|.*)\\)|)",rtrim=new RegExp("^"+whitespace+"+|((?:^|[^\\\\])(?:\\\\.)*)"+whitespace+"+$","g"),rcomma=new RegExp("^"+whitespace+"*,"+whitespace+"*"),rcombinators=new RegExp("^"+whitespace+"*([>+~]|"+whitespace+")"+whitespace+"*"),rsibling=new RegExp(whitespace+"*[+~]"),rattributeQuotes=new RegExp("="+whitespace+"*([^\\]'\"]*)"+whitespace+"*\\]","g"),rpseudo=new RegExp(pseudos),ridentifier=new RegExp("^"+identifier+"$"),matchExpr={ID:new RegExp("^#("+characterEncoding+")"),CLASS:new RegExp("^\\.("+characterEncoding+")"),TAG:new RegExp("^("+characterEncoding.replace("w","w*")+")"),ATTR:new RegExp("^"+attributes),PSEUDO:new RegExp("^"+pseudos),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+whitespace+"*(even|odd|(([+-]|)(\\d*)n|)"+whitespace+"*(?:([+-]|)"+whitespace+"*(\\d+)|))"+whitespace+"*\\)|)","i"),bool:new RegExp("^(?:"+booleans+")$","i"),needsContext:new RegExp("^"+whitespace+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+whitespace+"*((?:-\\d)?\\d*)"+whitespace+"*\\)|)(?=[^-]|$)","i")},rnative=/^[^{]+\{\s*\[native \w/,rquickExpr=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,rinputs=/^(?:input|select|textarea|button)$/i,rheader=/^h\d$/i,rescape=/'|\\/g,runescape=new RegExp("\\\\([\\da-f]{1,6}"+whitespace+"?|("+whitespace+")|.)","ig"),funescape=function(_,escaped,escapedWhitespace){var high="0x"+escaped-65536;return high!==high||escapedWhitespace?escaped:high<0?String.fromCharCode(high+65536):String.fromCharCode(high>>10|55296,1023&high|56320)};try{push.apply(arr=slice.call(preferredDoc.childNodes),preferredDoc.childNodes),arr[preferredDoc.childNodes.length].nodeType}catch(e){push={apply:arr.length?function(target,els){push_native.apply(target,slice.call(els))}:function(target,els){for(var j=target.length,i=0;target[j++]=els[i++];);target.length=j-1}}}function Sizzle(selector,context,results,seed){var match,elem,m,nodeType,i,groups,old,nid,newContext,newSelector;if((context?context.ownerDocument||context:preferredDoc)!==document&&setDocument(context),context=context||document,results=results||[],!selector||"string"!=typeof selector)return results;if(1!==(nodeType=context.nodeType)&&9!==nodeType)return[];if(documentIsHTML&&!seed){if(match=rquickExpr.exec(selector))if(m=match[1]){if(9===nodeType){if(!(elem=context.getElementById(m))||!elem.parentNode)return results;if(elem.id===m)return results.push(elem),results}else if(context.ownerDocument&&(elem=context.ownerDocument.getElementById(m))&&contains(context,elem)&&elem.id===m)return results.push(elem),results}else{if(match[2])return push.apply(results,context.getElementsByTagName(selector)),results;if((m=match[3])&&support.getElementsByClassName&&context.getElementsByClassName)return push.apply(results,context.getElementsByClassName(m)),results}if(support.qsa&&(!rbuggyQSA||!rbuggyQSA.test(selector))){if(nid=old=expando,newContext=context,newSelector=9===nodeType&&selector,1===nodeType&&"object"!==context.nodeName.toLowerCase()){for(groups=tokenize(selector),(old=context.getAttribute("id"))?nid=old.replace(rescape,"\\$&"):context.setAttribute("id",nid),nid="[id='"+nid+"'] ",i=groups.length;i--;)groups[i]=nid+toSelector(groups[i]);newContext=rsibling.test(selector)&&context.parentNode||context,newSelector=groups.join(",")}if(newSelector)try{return push.apply(results,newContext.querySelectorAll(newSelector)),results}catch(qsaError){}finally{old||context.removeAttribute("id")}}}return select(selector.replace(rtrim,"$1"),context,results,seed)}function createCache(){var keys=[];function cache(key,value){return keys.push(key+=" ")>Expr.cacheLength&&delete cache[keys.shift()],cache[key]=value}return cache}function markFunction(fn){return fn[expando]=!0,fn}function assert(fn){var div=document.createElement("div");try{return!!fn(div)}catch(e){return!1}finally{div.parentNode&&div.parentNode.removeChild(div),div=null}}function addHandle(attrs,handler){for(var arr=attrs.split("|"),i=attrs.length;i--;)Expr.attrHandle[arr[i]]=handler}function siblingCheck(a,b){var cur=b&&a,diff=cur&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||MAX_NEGATIVE)-(~a.sourceIndex||MAX_NEGATIVE);if(diff)return diff;if(cur)for(;cur=cur.nextSibling;)if(cur===b)return-1;return a?1:-1}function createPositionalPseudo(fn){return markFunction(function(argument){return argument=+argument,markFunction(function(seed,matches){for(var j,matchIndexes=fn([],seed.length,argument),i=matchIndexes.length;i--;)seed[j=matchIndexes[i]]&&(seed[j]=!(matches[j]=seed[j]))})})}isXML=Sizzle.isXML=function(elem){var documentElement=elem&&(elem.ownerDocument||elem).documentElement;return!!documentElement&&"HTML"!==documentElement.nodeName},support=Sizzle.support={},setDocument=Sizzle.setDocument=function(node){var doc=node?node.ownerDocument||node:preferredDoc,parent=doc.defaultView;return doc!==document&&9===doc.nodeType&&doc.documentElement?(document=doc,docElem=doc.documentElement,documentIsHTML=!isXML(doc),parent&&parent.attachEvent&&parent!==parent.top&&parent.attachEvent("onbeforeunload",function(){setDocument()}),support.attributes=assert(function(div){return div.className="i",!div.getAttribute("className")}),support.getElementsByTagName=assert(function(div){return div.appendChild(doc.createComment("")),!div.getElementsByTagName("*").length}),support.getElementsByClassName=assert(function(div){return div.innerHTML="<div class='a'></div><div class='a i'></div>",div.firstChild.className="i",2===div.getElementsByClassName("i").length}),support.getById=assert(function(div){return docElem.appendChild(div).id=expando,!doc.getElementsByName||!doc.getElementsByName(expando).length}),support.getById?(Expr.find.ID=function(id,context){if(void 0!==context.getElementById&&documentIsHTML){var m=context.getElementById(id);return m&&m.parentNode?[m]:[]}},Expr.filter.ID=function(id){var attrId=id.replace(runescape,funescape);return function(elem){return elem.getAttribute("id")===attrId}}):(delete Expr.find.ID,Expr.filter.ID=function(id){var attrId=id.replace(runescape,funescape);return function(elem){var node=void 0!==elem.getAttributeNode&&elem.getAttributeNode("id");return node&&node.value===attrId}}),Expr.find.TAG=support.getElementsByTagName?function(tag,context){if(void 0!==context.getElementsByTagName)return context.getElementsByTagName(tag)}:function(tag,context){var elem,tmp=[],i=0,results=context.getElementsByTagName(tag);if("*"===tag){for(;elem=results[i++];)1===elem.nodeType&&tmp.push(elem);return tmp}return results},Expr.find.CLASS=support.getElementsByClassName&&function(className,context){if(void 0!==context.getElementsByClassName&&documentIsHTML)return context.getElementsByClassName(className)},rbuggyMatches=[],rbuggyQSA=[],(support.qsa=rnative.test(doc.querySelectorAll))&&(assert(function(div){div.innerHTML="<select><option selected=''></option></select>",div.querySelectorAll("[selected]").length||rbuggyQSA.push("\\["+whitespace+"*(?:value|"+booleans+")"),div.querySelectorAll(":checked").length||rbuggyQSA.push(":checked")}),assert(function(div){var input=doc.createElement("input");input.setAttribute("type","hidden"),div.appendChild(input).setAttribute("t",""),div.querySelectorAll("[t^='']").length&&rbuggyQSA.push("[*^$]="+whitespace+"*(?:''|\"\")"),div.querySelectorAll(":enabled").length||rbuggyQSA.push(":enabled",":disabled"),div.querySelectorAll("*,:x"),rbuggyQSA.push(",.*:")})),(support.matchesSelector=rnative.test(matches=docElem.webkitMatchesSelector||docElem.mozMatchesSelector||docElem.oMatchesSelector||docElem.msMatchesSelector))&&assert(function(div){support.disconnectedMatch=matches.call(div,"div"),matches.call(div,"[s!='']:x"),rbuggyMatches.push("!=",pseudos)}),rbuggyQSA=rbuggyQSA.length&&new RegExp(rbuggyQSA.join("|")),rbuggyMatches=rbuggyMatches.length&&new RegExp(rbuggyMatches.join("|")),contains=rnative.test(docElem.contains)||docElem.compareDocumentPosition?function(a,b){var adown=9===a.nodeType?a.documentElement:a,bup=b&&b.parentNode;return a===bup||!(!bup||1!==bup.nodeType||!(adown.contains?adown.contains(bup):a.compareDocumentPosition&&16&a.compareDocumentPosition(bup)))}:function(a,b){if(b)for(;b=b.parentNode;)if(b===a)return!0;return!1},sortOrder=docElem.compareDocumentPosition?function(a,b){if(a===b)return hasDuplicate=!0,0;var compare=b.compareDocumentPosition&&a.compareDocumentPosition&&a.compareDocumentPosition(b);return compare?1&compare||!support.sortDetached&&b.compareDocumentPosition(a)===compare?a===doc||contains(preferredDoc,a)?-1:b===doc||contains(preferredDoc,b)?1:sortInput?indexOf.call(sortInput,a)-indexOf.call(sortInput,b):0:4&compare?-1:1:a.compareDocumentPosition?-1:1}:function(a,b){var cur,i=0,aup=a.parentNode,bup=b.parentNode,ap=[a],bp=[b];if(a===b)return hasDuplicate=!0,0;if(!aup||!bup)return a===doc?-1:b===doc?1:aup?-1:bup?1:sortInput?indexOf.call(sortInput,a)-indexOf.call(sortInput,b):0;if(aup===bup)return siblingCheck(a,b);for(cur=a;cur=cur.parentNode;)ap.unshift(cur);for(cur=b;cur=cur.parentNode;)bp.unshift(cur);for(;ap[i]===bp[i];)i++;return i?siblingCheck(ap[i],bp[i]):ap[i]===preferredDoc?-1:bp[i]===preferredDoc?1:0},doc):document},Sizzle.matches=function(expr,elements){return Sizzle(expr,null,null,elements)},Sizzle.matchesSelector=function(elem,expr){if((elem.ownerDocument||elem)!==document&&setDocument(elem),expr=expr.replace(rattributeQuotes,"='$1']"),support.matchesSelector&&documentIsHTML&&(!rbuggyMatches||!rbuggyMatches.test(expr))&&(!rbuggyQSA||!rbuggyQSA.test(expr)))try{var ret=matches.call(elem,expr);if(ret||support.disconnectedMatch||elem.document&&11!==elem.document.nodeType)return ret}catch(e){}return Sizzle(expr,document,null,[elem]).length>0},Sizzle.contains=function(context,elem){return(context.ownerDocument||context)!==document&&setDocument(context),contains(context,elem)},Sizzle.attr=function(elem,name){(elem.ownerDocument||elem)!==document&&setDocument(elem);var fn=Expr.attrHandle[name.toLowerCase()],val=fn&&hasOwn.call(Expr.attrHandle,name.toLowerCase())?fn(elem,name,!documentIsHTML):void 0;return void 0===val?support.attributes||!documentIsHTML?elem.getAttribute(name):(val=elem.getAttributeNode(name))&&val.specified?val.value:null:val},Sizzle.error=function(msg){throw new Error("Syntax error, unrecognized expression: "+msg)},Sizzle.uniqueSort=function(results){var elem,duplicates=[],j=0,i=0;if(hasDuplicate=!support.detectDuplicates,sortInput=!support.sortStable&&results.slice(0),results.sort(sortOrder),hasDuplicate){for(;elem=results[i++];)elem===results[i]&&(j=duplicates.push(i));for(;j--;)results.splice(duplicates[j],1)}return results},getText=Sizzle.getText=function(elem){var node,ret="",i=0,nodeType=elem.nodeType;if(nodeType){if(1===nodeType||9===nodeType||11===nodeType){if("string"==typeof elem.textContent)return elem.textContent;for(elem=elem.firstChild;elem;elem=elem.nextSibling)ret+=getText(elem)}else if(3===nodeType||4===nodeType)return elem.nodeValue}else for(;node=elem[i];i++)ret+=getText(node);return ret},Expr=Sizzle.selectors={cacheLength:50,createPseudo:markFunction,match:matchExpr,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(match){return match[1]=match[1].replace(runescape,funescape),match[3]=(match[4]||match[5]||"").replace(runescape,funescape),"~="===match[2]&&(match[3]=" "+match[3]+" "),match.slice(0,4)},CHILD:function(match){return match[1]=match[1].toLowerCase(),"nth"===match[1].slice(0,3)?(match[3]||Sizzle.error(match[0]),match[4]=+(match[4]?match[5]+(match[6]||1):2*("even"===match[3]||"odd"===match[3])),match[5]=+(match[7]+match[8]||"odd"===match[3])):match[3]&&Sizzle.error(match[0]),match},PSEUDO:function(match){var excess,unquoted=!match[5]&&match[2];return matchExpr.CHILD.test(match[0])?null:(match[3]&&void 0!==match[4]?match[2]=match[4]:unquoted&&rpseudo.test(unquoted)&&(excess=tokenize(unquoted,!0))&&(excess=unquoted.indexOf(")",unquoted.length-excess)-unquoted.length)&&(match[0]=match[0].slice(0,excess),match[2]=unquoted.slice(0,excess)),match.slice(0,3))}},filter:{TAG:function(nodeNameSelector){var nodeName=nodeNameSelector.replace(runescape,funescape).toLowerCase();return"*"===nodeNameSelector?function(){return!0}:function(elem){return elem.nodeName&&elem.nodeName.toLowerCase()===nodeName}},CLASS:function(className){var pattern=classCache[className+" "];return pattern||(pattern=new RegExp("(^|"+whitespace+")"+className+"("+whitespace+"|$)"))&&classCache(className,function(elem){return pattern.test("string"==typeof elem.className&&elem.className||void 0!==elem.getAttribute&&elem.getAttribute("class")||"")})},ATTR:function(name,operator,check){return function(elem){var result=Sizzle.attr(elem,name);return null==result?"!="===operator:!operator||(result+="","="===operator?result===check:"!="===operator?result!==check:"^="===operator?check&&0===result.indexOf(check):"*="===operator?check&&result.indexOf(check)>-1:"$="===operator?check&&result.slice(-check.length)===check:"~="===operator?(" "+result+" ").indexOf(check)>-1:"|="===operator&&(result===check||result.slice(0,check.length+1)===check+"-"))}},CHILD:function(type,what,argument,first,last){var simple="nth"!==type.slice(0,3),forward="last"!==type.slice(-4),ofType="of-type"===what;return 1===first&&0===last?function(elem){return!!elem.parentNode}:function(elem,context,xml){var cache,outerCache,node,diff,nodeIndex,start,dir=simple!==forward?"nextSibling":"previousSibling",parent=elem.parentNode,name=ofType&&elem.nodeName.toLowerCase(),useCache=!xml&&!ofType;if(parent){if(simple){for(;dir;){for(node=elem;node=node[dir];)if(ofType?node.nodeName.toLowerCase()===name:1===node.nodeType)return!1;start=dir="only"===type&&!start&&"nextSibling"}return!0}if(start=[forward?parent.firstChild:parent.lastChild],forward&&useCache){for(outerCache=parent[expando]||(parent[expando]={}),cache=outerCache[type]||[],nodeIndex=cache[0]===dirruns&&cache[1],diff=cache[0]===dirruns&&cache[2],node=nodeIndex&&parent.childNodes[nodeIndex];node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop();)if(1===node.nodeType&&++diff&&node===elem){outerCache[type]=[dirruns,nodeIndex,diff];break}}else if(useCache&&(cache=(elem[expando]||(elem[expando]={}))[type])&&cache[0]===dirruns)diff=cache[1];else for(;(node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop())&&((ofType?node.nodeName.toLowerCase()!==name:1!==node.nodeType)||!++diff||(useCache&&((node[expando]||(node[expando]={}))[type]=[dirruns,diff]),node!==elem)););return(diff-=last)===first||diff%first==0&&diff/first>=0}}},PSEUDO:function(pseudo,argument){var args,fn=Expr.pseudos[pseudo]||Expr.setFilters[pseudo.toLowerCase()]||Sizzle.error("unsupported pseudo: "+pseudo);return fn[expando]?fn(argument):fn.length>1?(args=[pseudo,pseudo,"",argument],Expr.setFilters.hasOwnProperty(pseudo.toLowerCase())?markFunction(function(seed,matches){for(var idx,matched=fn(seed,argument),i=matched.length;i--;)idx=indexOf.call(seed,matched[i]),seed[idx]=!(matches[idx]=matched[i])}):function(elem){return fn(elem,0,args)}):fn}},pseudos:{not:markFunction(function(selector){var input=[],results=[],matcher=compile(selector.replace(rtrim,"$1"));return matcher[expando]?markFunction(function(seed,matches,context,xml){for(var elem,unmatched=matcher(seed,null,xml,[]),i=seed.length;i--;)(elem=unmatched[i])&&(seed[i]=!(matches[i]=elem))}):function(elem,context,xml){return input[0]=elem,matcher(input,null,xml,results),!results.pop()}}),has:markFunction(function(selector){return function(elem){return Sizzle(selector,elem).length>0}}),contains:markFunction(function(text){return function(elem){return(elem.textContent||elem.innerText||getText(elem)).indexOf(text)>-1}}),lang:markFunction(function(lang){return ridentifier.test(lang||"")||Sizzle.error("unsupported lang: "+lang),lang=lang.replace(runescape,funescape).toLowerCase(),function(elem){var elemLang;do{if(elemLang=documentIsHTML?elem.lang:elem.getAttribute("xml:lang")||elem.getAttribute("lang"))return(elemLang=elemLang.toLowerCase())===lang||0===elemLang.indexOf(lang+"-")}while((elem=elem.parentNode)&&1===elem.nodeType);return!1}}),target:function(elem){var hash=window.location&&window.location.hash;return hash&&hash.slice(1)===elem.id},root:function(elem){return elem===docElem},focus:function(elem){return elem===document.activeElement&&(!document.hasFocus||document.hasFocus())&&!!(elem.type||elem.href||~elem.tabIndex)},enabled:function(elem){return!1===elem.disabled},disabled:function(elem){return!0===elem.disabled},checked:function(elem){var nodeName=elem.nodeName.toLowerCase();return"input"===nodeName&&!!elem.checked||"option"===nodeName&&!!elem.selected},selected:function(elem){return elem.parentNode&&elem.parentNode.selectedIndex,!0===elem.selected},empty:function(elem){for(elem=elem.firstChild;elem;elem=elem.nextSibling)if(elem.nodeName>"@"||3===elem.nodeType||4===elem.nodeType)return!1;return!0},parent:function(elem){return!Expr.pseudos.empty(elem)},header:function(elem){return rheader.test(elem.nodeName)},input:function(elem){return rinputs.test(elem.nodeName)},button:function(elem){var name=elem.nodeName.toLowerCase();return"input"===name&&"button"===elem.type||"button"===name},text:function(elem){var attr;return"input"===elem.nodeName.toLowerCase()&&"text"===elem.type&&(null==(attr=elem.getAttribute("type"))||attr.toLowerCase()===elem.type)},first:createPositionalPseudo(function(){return[0]}),last:createPositionalPseudo(function(matchIndexes,length){return[length-1]}),eq:createPositionalPseudo(function(matchIndexes,length,argument){return[argument<0?argument+length:argument]}),even:createPositionalPseudo(function(matchIndexes,length){for(var i=0;i<length;i+=2)matchIndexes.push(i);return matchIndexes}),odd:createPositionalPseudo(function(matchIndexes,length){for(var i=1;i<length;i+=2)matchIndexes.push(i);return matchIndexes}),lt:createPositionalPseudo(function(matchIndexes,length,argument){for(var i=argument<0?argument+length:argument;--i>=0;)matchIndexes.push(i);return matchIndexes}),gt:createPositionalPseudo(function(matchIndexes,length,argument){for(var i=argument<0?argument+length:argument;++i<length;)matchIndexes.push(i);return matchIndexes})}},Expr.pseudos.nth=Expr.pseudos.eq;for(i in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})Expr.pseudos[i]=function(type){return function(elem){return"input"===elem.nodeName.toLowerCase()&&elem.type===type}}(i);for(i in{submit:!0,reset:!0})Expr.pseudos[i]=function(type){return function(elem){var name=elem.nodeName.toLowerCase();return("input"===name||"button"===name)&&elem.type===type}}(i);function setFilters(){}setFilters.prototype=Expr.filters=Expr.pseudos,Expr.setFilters=new setFilters;function tokenize(selector,parseOnly){var matched,match,tokens,type,soFar,groups,preFilters,cached=tokenCache[selector+" "];if(cached)return parseOnly?0:cached.slice(0);for(soFar=selector,groups=[],preFilters=Expr.preFilter;soFar;){matched&&!(match=rcomma.exec(soFar))||(match&&(soFar=soFar.slice(match[0].length)||soFar),groups.push(tokens=[])),matched=!1,(match=rcombinators.exec(soFar))&&(matched=match.shift(),tokens.push({value:matched,type:match[0].replace(rtrim," ")}),soFar=soFar.slice(matched.length));for(type in Expr.filter)!(match=matchExpr[type].exec(soFar))||preFilters[type]&&!(match=preFilters[type](match))||(matched=match.shift(),tokens.push({value:matched,type:type,matches:match}),soFar=soFar.slice(matched.length));if(!matched)break}return parseOnly?soFar.length:soFar?Sizzle.error(selector):tokenCache(selector,groups).slice(0)}function toSelector(tokens){
for(var i=0,len=tokens.length,selector="";i<len;i++)selector+=tokens[i].value;return selector}function addCombinator(matcher,combinator,base){var dir=combinator.dir,checkNonElements=base&&"parentNode"===dir,doneName=done++;return combinator.first?function(elem,context,xml){for(;elem=elem[dir];)if(1===elem.nodeType||checkNonElements)return matcher(elem,context,xml)}:function(elem,context,xml){var data,cache,outerCache,dirkey=dirruns+" "+doneName;if(xml){for(;elem=elem[dir];)if((1===elem.nodeType||checkNonElements)&&matcher(elem,context,xml))return!0}else for(;elem=elem[dir];)if(1===elem.nodeType||checkNonElements)if(outerCache=elem[expando]||(elem[expando]={}),(cache=outerCache[dir])&&cache[0]===dirkey){if(!0===(data=cache[1])||data===cachedruns)return!0===data}else if(cache=outerCache[dir]=[dirkey],cache[1]=matcher(elem,context,xml)||cachedruns,!0===cache[1])return!0}}function elementMatcher(matchers){return matchers.length>1?function(elem,context,xml){for(var i=matchers.length;i--;)if(!matchers[i](elem,context,xml))return!1;return!0}:matchers[0]}function condense(unmatched,map,filter,context,xml){for(var elem,newUnmatched=[],i=0,len=unmatched.length,mapped=null!=map;i<len;i++)(elem=unmatched[i])&&(filter&&!filter(elem,context,xml)||(newUnmatched.push(elem),mapped&&map.push(i)));return newUnmatched}function setMatcher(preFilter,selector,matcher,postFilter,postFinder,postSelector){return postFilter&&!postFilter[expando]&&(postFilter=setMatcher(postFilter)),postFinder&&!postFinder[expando]&&(postFinder=setMatcher(postFinder,postSelector)),markFunction(function(seed,results,context,xml){var temp,i,elem,preMap=[],postMap=[],preexisting=results.length,elems=seed||multipleContexts(selector||"*",context.nodeType?[context]:context,[]),matcherIn=!preFilter||!seed&&selector?elems:condense(elems,preMap,preFilter,context,xml),matcherOut=matcher?postFinder||(seed?preFilter:preexisting||postFilter)?[]:results:matcherIn;if(matcher&&matcher(matcherIn,matcherOut,context,xml),postFilter)for(temp=condense(matcherOut,postMap),postFilter(temp,[],context,xml),i=temp.length;i--;)(elem=temp[i])&&(matcherOut[postMap[i]]=!(matcherIn[postMap[i]]=elem));if(seed){if(postFinder||preFilter){if(postFinder){for(temp=[],i=matcherOut.length;i--;)(elem=matcherOut[i])&&temp.push(matcherIn[i]=elem);postFinder(null,matcherOut=[],temp,xml)}for(i=matcherOut.length;i--;)(elem=matcherOut[i])&&(temp=postFinder?indexOf.call(seed,elem):preMap[i])>-1&&(seed[temp]=!(results[temp]=elem))}}else matcherOut=condense(matcherOut===results?matcherOut.splice(preexisting,matcherOut.length):matcherOut),postFinder?postFinder(null,results,matcherOut,xml):push.apply(results,matcherOut)})}function matcherFromTokens(tokens){for(var checkContext,matcher,j,len=tokens.length,leadingRelative=Expr.relative[tokens[0].type],implicitRelative=leadingRelative||Expr.relative[" "],i=leadingRelative?1:0,matchContext=addCombinator(function(elem){return elem===checkContext},implicitRelative,!0),matchAnyContext=addCombinator(function(elem){return indexOf.call(checkContext,elem)>-1},implicitRelative,!0),matchers=[function(elem,context,xml){return!leadingRelative&&(xml||context!==outermostContext)||((checkContext=context).nodeType?matchContext(elem,context,xml):matchAnyContext(elem,context,xml))}];i<len;i++)if(matcher=Expr.relative[tokens[i].type])matchers=[addCombinator(elementMatcher(matchers),matcher)];else{if(matcher=Expr.filter[tokens[i].type].apply(null,tokens[i].matches),matcher[expando]){for(j=++i;j<len&&!Expr.relative[tokens[j].type];j++);return setMatcher(i>1&&elementMatcher(matchers),i>1&&toSelector(tokens.slice(0,i-1).concat({value:" "===tokens[i-2].type?"*":""})).replace(rtrim,"$1"),matcher,i<j&&matcherFromTokens(tokens.slice(i,j)),j<len&&matcherFromTokens(tokens=tokens.slice(j)),j<len&&toSelector(tokens))}matchers.push(matcher)}return elementMatcher(matchers)}function matcherFromGroupMatchers(elementMatchers,setMatchers){var matcherCachedRuns=0,bySet=setMatchers.length>0,byElement=elementMatchers.length>0,superMatcher=function(seed,context,xml,results,expandContext){var elem,j,matcher,setMatched=[],matchedCount=0,i="0",unmatched=seed&&[],outermost=null!=expandContext,contextBackup=outermostContext,elems=seed||byElement&&Expr.find.TAG("*",expandContext&&context.parentNode||context),dirrunsUnique=dirruns+=null==contextBackup?1:Math.random()||.1;for(outermost&&(outermostContext=context!==document&&context,cachedruns=matcherCachedRuns);null!=(elem=elems[i]);i++){if(byElement&&elem){for(j=0;matcher=elementMatchers[j++];)if(matcher(elem,context,xml)){results.push(elem);break}outermost&&(dirruns=dirrunsUnique,cachedruns=++matcherCachedRuns)}bySet&&((elem=!matcher&&elem)&&matchedCount--,seed&&unmatched.push(elem))}if(matchedCount+=i,bySet&&i!==matchedCount){for(j=0;matcher=setMatchers[j++];)matcher(unmatched,setMatched,context,xml);if(seed){if(matchedCount>0)for(;i--;)unmatched[i]||setMatched[i]||(setMatched[i]=pop.call(results));setMatched=condense(setMatched)}push.apply(results,setMatched),outermost&&!seed&&setMatched.length>0&&matchedCount+setMatchers.length>1&&Sizzle.uniqueSort(results)}return outermost&&(dirruns=dirrunsUnique,outermostContext=contextBackup),unmatched};return bySet?markFunction(superMatcher):superMatcher}compile=Sizzle.compile=function(selector,group){var i,setMatchers=[],elementMatchers=[],cached=compilerCache[selector+" "];if(!cached){for(group||(group=tokenize(selector)),i=group.length;i--;)cached=matcherFromTokens(group[i]),cached[expando]?setMatchers.push(cached):elementMatchers.push(cached);cached=compilerCache(selector,matcherFromGroupMatchers(elementMatchers,setMatchers))}return cached};function multipleContexts(selector,contexts,results){for(var i=0,len=contexts.length;i<len;i++)Sizzle(selector,contexts[i],results);return results}function select(selector,context,results,seed){var i,tokens,token,type,find,match=tokenize(selector);if(!seed&&1===match.length){if(tokens=match[0]=match[0].slice(0),tokens.length>2&&"ID"===(token=tokens[0]).type&&support.getById&&9===context.nodeType&&documentIsHTML&&Expr.relative[tokens[1].type]){if(!(context=(Expr.find.ID(token.matches[0].replace(runescape,funescape),context)||[])[0]))return results;selector=selector.slice(tokens.shift().value.length)}for(i=matchExpr.needsContext.test(selector)?0:tokens.length;i--&&(token=tokens[i],!Expr.relative[type=token.type]);)if((find=Expr.find[type])&&(seed=find(token.matches[0].replace(runescape,funescape),rsibling.test(tokens[0].type)&&context.parentNode||context))){if(tokens.splice(i,1),!(selector=seed.length&&toSelector(tokens)))return push.apply(results,seed),results;break}}return compile(selector,match)(seed,context,!documentIsHTML,results,rsibling.test(selector)),results}support.sortStable=expando.split("").sort(sortOrder).join("")===expando,support.detectDuplicates=hasDuplicate,setDocument(),support.sortDetached=assert(function(div1){return 1&div1.compareDocumentPosition(document.createElement("div"))}),assert(function(div){return div.innerHTML="<a href='#'></a>","#"===div.firstChild.getAttribute("href")})||addHandle("type|href|height|width",function(elem,name,isXML){if(!isXML)return elem.getAttribute(name,"type"===name.toLowerCase()?1:2)}),support.attributes&&assert(function(div){return div.innerHTML="<input/>",div.firstChild.setAttribute("value",""),""===div.firstChild.getAttribute("value")})||addHandle("value",function(elem,name,isXML){if(!isXML&&"input"===elem.nodeName.toLowerCase())return elem.defaultValue}),assert(function(div){return null==div.getAttribute("disabled")})||addHandle(booleans,function(elem,name,isXML){var val;if(!isXML)return(val=elem.getAttributeNode(name))&&val.specified?val.value:!0===elem[name]?name.toLowerCase():null}),jQuery.find=Sizzle,jQuery.expr=Sizzle.selectors,jQuery.expr[":"]=jQuery.expr.pseudos,jQuery.unique=Sizzle.uniqueSort,jQuery.text=Sizzle.getText,jQuery.isXMLDoc=Sizzle.isXML,jQuery.contains=Sizzle.contains}(window);var optionsCache={};function createOptions(options){var object=optionsCache[options]={};return jQuery.each(options.match(core_rnotwhite)||[],function(_,flag){object[flag]=!0}),object}jQuery.Callbacks=function(options){options="string"==typeof options?optionsCache[options]||createOptions(options):jQuery.extend({},options);var firing,memory,fired,firingLength,firingIndex,firingStart,list=[],stack=!options.once&&[],fire=function(data){for(memory=options.memory&&data,fired=!0,firingIndex=firingStart||0,firingStart=0,firingLength=list.length,firing=!0;list&&firingIndex<firingLength;firingIndex++)if(!1===list[firingIndex].apply(data[0],data[1])&&options.stopOnFalse){memory=!1;break}firing=!1,list&&(stack?stack.length&&fire(stack.shift()):memory?list=[]:self.disable())},self={add:function(){if(list){var start=list.length;!function add(args){jQuery.each(args,function(_,arg){var type=jQuery.type(arg);"function"===type?options.unique&&self.has(arg)||list.push(arg):arg&&arg.length&&"string"!==type&&add(arg)})}(arguments),firing?firingLength=list.length:memory&&(firingStart=start,fire(memory))}return this},remove:function(){return list&&jQuery.each(arguments,function(_,arg){for(var index;(index=jQuery.inArray(arg,list,index))>-1;)list.splice(index,1),firing&&(index<=firingLength&&firingLength--,index<=firingIndex&&firingIndex--)}),this},has:function(fn){return fn?jQuery.inArray(fn,list)>-1:!(!list||!list.length)},empty:function(){return list=[],firingLength=0,this},disable:function(){return list=stack=memory=undefined,this},disabled:function(){return!list},lock:function(){return stack=undefined,memory||self.disable(),this},locked:function(){return!stack},fireWith:function(context,args){return!list||fired&&!stack||(args=args||[],args=[context,args.slice?args.slice():args],firing?stack.push(args):fire(args)),this},fire:function(){return self.fireWith(this,arguments),this},fired:function(){return!!fired}};return self},jQuery.extend({Deferred:function(func){var tuples=[["resolve","done",jQuery.Callbacks("once memory"),"resolved"],["reject","fail",jQuery.Callbacks("once memory"),"rejected"],["notify","progress",jQuery.Callbacks("memory")]],state="pending",promise={state:function(){return state},always:function(){return deferred.done(arguments).fail(arguments),this},then:function(){var fns=arguments;return jQuery.Deferred(function(newDefer){jQuery.each(tuples,function(i,tuple){var action=tuple[0],fn=jQuery.isFunction(fns[i])&&fns[i];deferred[tuple[1]](function(){var returned=fn&&fn.apply(this,arguments);returned&&jQuery.isFunction(returned.promise)?returned.promise().done(newDefer.resolve).fail(newDefer.reject).progress(newDefer.notify):newDefer[action+"With"](this===promise?newDefer.promise():this,fn?[returned]:arguments)})}),fns=null}).promise()},promise:function(obj){return null!=obj?jQuery.extend(obj,promise):promise}},deferred={};return promise.pipe=promise.then,jQuery.each(tuples,function(i,tuple){var list=tuple[2],stateString=tuple[3];promise[tuple[1]]=list.add,stateString&&list.add(function(){state=stateString},tuples[1^i][2].disable,tuples[2][2].lock),deferred[tuple[0]]=function(){return deferred[tuple[0]+"With"](this===deferred?promise:this,arguments),this},deferred[tuple[0]+"With"]=list.fireWith}),promise.promise(deferred),func&&func.call(deferred,deferred),deferred},when:function(subordinate){var progressValues,progressContexts,resolveContexts,i=0,resolveValues=core_slice.call(arguments),length=resolveValues.length,remaining=1!==length||subordinate&&jQuery.isFunction(subordinate.promise)?length:0,deferred=1===remaining?subordinate:jQuery.Deferred(),updateFunc=function(i,contexts,values){return function(value){contexts[i]=this,values[i]=arguments.length>1?core_slice.call(arguments):value,values===progressValues?deferred.notifyWith(contexts,values):--remaining||deferred.resolveWith(contexts,values)}};if(length>1)for(progressValues=new Array(length),progressContexts=new Array(length),resolveContexts=new Array(length);i<length;i++)resolveValues[i]&&jQuery.isFunction(resolveValues[i].promise)?resolveValues[i].promise().done(updateFunc(i,resolveContexts,resolveValues)).fail(deferred.reject).progress(updateFunc(i,progressContexts,progressValues)):--remaining;return remaining||deferred.resolveWith(resolveContexts,resolveValues),deferred.promise()}}),jQuery.support=function(support){var all,a,input,select,fragment,opt,eventName,isSupported,i,div=document.createElement("div");if(div.setAttribute("className","t"),div.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",all=div.getElementsByTagName("*")||[],!(a=div.getElementsByTagName("a")[0])||!a.style||!all.length)return support;select=document.createElement("select"),opt=select.appendChild(document.createElement("option")),input=div.getElementsByTagName("input")[0],a.style.cssText="top:1px;float:left;opacity:.5",support.getSetAttribute="t"!==div.className,support.leadingWhitespace=3===div.firstChild.nodeType,support.tbody=!div.getElementsByTagName("tbody").length,support.htmlSerialize=!!div.getElementsByTagName("link").length,support.style=/top/.test(a.getAttribute("style")),support.hrefNormalized="/a"===a.getAttribute("href"),support.opacity=/^0.5/.test(a.style.opacity),support.cssFloat=!!a.style.cssFloat,support.checkOn=!!input.value,support.optSelected=opt.selected,support.enctype=!!document.createElement("form").enctype,support.html5Clone="<:nav></:nav>"!==document.createElement("nav").cloneNode(!0).outerHTML,support.inlineBlockNeedsLayout=!1,support.shrinkWrapBlocks=!1,support.pixelPosition=!1,support.deleteExpando=!0,support.noCloneEvent=!0,support.reliableMarginRight=!0,support.boxSizingReliable=!0,input.checked=!0,support.noCloneChecked=input.cloneNode(!0).checked,select.disabled=!0,support.optDisabled=!opt.disabled;try{delete div.test}catch(e){support.deleteExpando=!1}input=document.createElement("input"),input.setAttribute("value",""),support.input=""===input.getAttribute("value"),input.value="t",input.setAttribute("type","radio"),support.radioValue="t"===input.value,input.setAttribute("checked","t"),input.setAttribute("name","t"),fragment=document.createDocumentFragment(),fragment.appendChild(input),support.appendChecked=input.checked,support.checkClone=fragment.cloneNode(!0).cloneNode(!0).lastChild.checked,div.attachEvent&&(div.attachEvent("onclick",function(){support.noCloneEvent=!1}),div.cloneNode(!0).click());for(i in{submit:!0,change:!0,focusin:!0})div.setAttribute(eventName="on"+i,"t"),support[i+"Bubbles"]=eventName in window||!1===div.attributes[eventName].expando;div.style.backgroundClip="content-box",div.cloneNode(!0).style.backgroundClip="",support.clearCloneStyle="content-box"===div.style.backgroundClip;for(i in jQuery(support))break;return support.ownLast="0"!==i,jQuery(function(){var container,marginDiv,tds,divReset="padding:0;margin:0;border:0;display:block;box-sizing:content-box;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;",body=document.getElementsByTagName("body")[0];body&&(container=document.createElement("div"),container.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",body.appendChild(container).appendChild(div),div.innerHTML="<table><tr><td></td><td>t</td></tr></table>",tds=div.getElementsByTagName("td"),tds[0].style.cssText="padding:0;margin:0;border:0;display:none",isSupported=0===tds[0].offsetHeight,tds[0].style.display="",tds[1].style.display="none",support.reliableHiddenOffsets=isSupported&&0===tds[0].offsetHeight,div.innerHTML="",div.style.cssText="box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;",jQuery.swap(body,null!=body.style.zoom?{zoom:1}:{},function(){support.boxSizing=4===div.offsetWidth}),window.getComputedStyle&&(support.pixelPosition="1%"!==(window.getComputedStyle(div,null)||{}).top,support.boxSizingReliable="4px"===(window.getComputedStyle(div,null)||{width:"4px"}).width,marginDiv=div.appendChild(document.createElement("div")),marginDiv.style.cssText=div.style.cssText=divReset,marginDiv.style.marginRight=marginDiv.style.width="0",div.style.width="1px",support.reliableMarginRight=!parseFloat((window.getComputedStyle(marginDiv,null)||{}).marginRight)),typeof div.style.zoom!==core_strundefined&&(div.innerHTML="",div.style.cssText=divReset+"width:1px;padding:1px;display:inline;zoom:1",support.inlineBlockNeedsLayout=3===div.offsetWidth,div.style.display="block",div.innerHTML="<div></div>",div.firstChild.style.width="5px",support.shrinkWrapBlocks=3!==div.offsetWidth,support.inlineBlockNeedsLayout&&(body.style.zoom=1)),body.removeChild(container),container=div=tds=marginDiv=null)}),all=select=fragment=opt=a=input=null,support}({});var rbrace=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,rmultiDash=/([A-Z])/g;function internalData(elem,name,data,pvt){if(jQuery.acceptData(elem)){var ret,thisCache,internalKey=jQuery.expando,isNode=elem.nodeType,cache=isNode?jQuery.cache:elem,id=isNode?elem[internalKey]:elem[internalKey]&&internalKey;if(id&&cache[id]&&(pvt||cache[id].data)||data!==undefined||"string"!=typeof name)return id||(id=isNode?elem[internalKey]=core_deletedIds.pop()||jQuery.guid++:internalKey),cache[id]||(cache[id]=isNode?{}:{toJSON:jQuery.noop}),"object"!=typeof name&&"function"!=typeof name||(pvt?cache[id]=jQuery.extend(cache[id],name):cache[id].data=jQuery.extend(cache[id].data,name)),thisCache=cache[id],pvt||(thisCache.data||(thisCache.data={}),thisCache=thisCache.data),data!==undefined&&(thisCache[jQuery.camelCase(name)]=data),"string"==typeof name?null==(ret=thisCache[name])&&(ret=thisCache[jQuery.camelCase(name)]):ret=thisCache,ret}}function internalRemoveData(elem,name,pvt){if(jQuery.acceptData(elem)){var thisCache,i,isNode=elem.nodeType,cache=isNode?jQuery.cache:elem,id=isNode?elem[jQuery.expando]:jQuery.expando;if(cache[id]){if(name&&(thisCache=pvt?cache[id]:cache[id].data)){jQuery.isArray(name)?name=name.concat(jQuery.map(name,jQuery.camelCase)):name in thisCache?name=[name]:(name=jQuery.camelCase(name),name=name in thisCache?[name]:name.split(" ")),i=name.length;for(;i--;)delete thisCache[name[i]];if(pvt?!isEmptyDataObject(thisCache):!jQuery.isEmptyObject(thisCache))return}(pvt||(delete cache[id].data,isEmptyDataObject(cache[id])))&&(isNode?jQuery.cleanData([elem],!0):jQuery.support.deleteExpando||cache!=cache.window?delete cache[id]:cache[id]=null)}}}jQuery.extend({cache:{},noData:{applet:!0,embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(elem){return!!(elem=elem.nodeType?jQuery.cache[elem[jQuery.expando]]:elem[jQuery.expando])&&!isEmptyDataObject(elem)},data:function(elem,name,data){return internalData(elem,name,data)},removeData:function(elem,name){return internalRemoveData(elem,name)},_data:function(elem,name,data){return internalData(elem,name,data,!0)},_removeData:function(elem,name){return internalRemoveData(elem,name,!0)},acceptData:function(elem){if(elem.nodeType&&1!==elem.nodeType&&9!==elem.nodeType)return!1;var noData=elem.nodeName&&jQuery.noData[elem.nodeName.toLowerCase()];return!noData||!0!==noData&&elem.getAttribute("classid")===noData}}),jQuery.fn.extend({data:function(key,value){var attrs,name,data=null,i=0,elem=this[0];if(key===undefined){if(this.length&&(data=jQuery.data(elem),1===elem.nodeType&&!jQuery._data(elem,"parsedAttrs"))){for(attrs=elem.attributes;i<attrs.length;i++)name=attrs[i].name,0===name.indexOf("data-")&&(name=jQuery.camelCase(name.slice(5)),dataAttr(elem,name,data[name]));jQuery._data(elem,"parsedAttrs",!0)}return data}return"object"==typeof key?this.each(function(){jQuery.data(this,key)}):arguments.length>1?this.each(function(){jQuery.data(this,key,value)}):elem?dataAttr(elem,key,jQuery.data(elem,key)):null},removeData:function(key){return this.each(function(){jQuery.removeData(this,key)})}});function dataAttr(elem,key,data){if(data===undefined&&1===elem.nodeType){var name="data-"+key.replace(rmultiDash,"-$1").toLowerCase();if("string"==typeof(data=elem.getAttribute(name))){try{data="true"===data||"false"!==data&&("null"===data?null:+data+""===data?+data:rbrace.test(data)?jQuery.parseJSON(data):data)}catch(e){}jQuery.data(elem,key,data)}else data=undefined}return data}function isEmptyDataObject(obj){var name;for(name in obj)if(("data"!==name||!jQuery.isEmptyObject(obj[name]))&&"toJSON"!==name)return!1;return!0}jQuery.extend({queue:function(elem,type,data){var queue;if(elem)return type=(type||"fx")+"queue",queue=jQuery._data(elem,type),data&&(!queue||jQuery.isArray(data)?queue=jQuery._data(elem,type,jQuery.makeArray(data)):queue.push(data)),queue||[]},dequeue:function(elem,type){type=type||"fx";var queue=jQuery.queue(elem,type),startLength=queue.length,fn=queue.shift(),hooks=jQuery._queueHooks(elem,type),next=function(){jQuery.dequeue(elem,type)};"inprogress"===fn&&(fn=queue.shift(),startLength--),fn&&("fx"===type&&queue.unshift("inprogress"),delete hooks.stop,fn.call(elem,next,hooks)),!startLength&&hooks&&hooks.empty.fire()},_queueHooks:function(elem,type){var key=type+"queueHooks";return jQuery._data(elem,key)||jQuery._data(elem,key,{empty:jQuery.Callbacks("once memory").add(function(){jQuery._removeData(elem,type+"queue"),jQuery._removeData(elem,key)})})}}),jQuery.fn.extend({queue:function(type,data){var setter=2;return"string"!=typeof type&&(data=type,type="fx",setter--),arguments.length<setter?jQuery.queue(this[0],type):data===undefined?this:this.each(function(){var queue=jQuery.queue(this,type,data);jQuery._queueHooks(this,type),"fx"===type&&"inprogress"!==queue[0]&&jQuery.dequeue(this,type)})},dequeue:function(type){return this.each(function(){jQuery.dequeue(this,type)})},delay:function(time,type){return time=jQuery.fx?jQuery.fx.speeds[time]||time:time,type=type||"fx",this.queue(type,function(next,hooks){var timeout=setTimeout(next,time);hooks.stop=function(){clearTimeout(timeout)}})},clearQueue:function(type){return this.queue(type||"fx",[])},promise:function(type,obj){var tmp,count=1,defer=jQuery.Deferred(),elements=this,i=this.length,resolve=function(){--count||defer.resolveWith(elements,[elements])};for("string"!=typeof type&&(obj=type,type=undefined),type=type||"fx";i--;)(tmp=jQuery._data(elements[i],type+"queueHooks"))&&tmp.empty&&(count++,tmp.empty.add(resolve));return resolve(),defer.promise(obj)}});var nodeHook,boolHook,rclass=/[\t\r\n\f]/g,rreturn=/\r/g,rfocusable=/^(?:input|select|textarea|button|object)$/i,rclickable=/^(?:a|area)$/i,ruseDefault=/^(?:checked|selected)$/i,getSetAttribute=jQuery.support.getSetAttribute,getSetInput=jQuery.support.input;jQuery.fn.extend({attr:function(name,value){return jQuery.access(this,jQuery.attr,name,value,arguments.length>1)},removeAttr:function(name){return this.each(function(){jQuery.removeAttr(this,name)})},prop:function(name,value){return jQuery.access(this,jQuery.prop,name,value,arguments.length>1)},removeProp:function(name){return name=jQuery.propFix[name]||name,this.each(function(){try{this[name]=undefined,delete this[name]}catch(e){}})},addClass:function(value){var classes,elem,cur,clazz,j,i=0,len=this.length,proceed="string"==typeof value&&value;if(jQuery.isFunction(value))return this.each(function(j){jQuery(this).addClass(value.call(this,j,this.className))});if(proceed)for(classes=(value||"").match(core_rnotwhite)||[];i<len;i++)if(elem=this[i],cur=1===elem.nodeType&&(elem.className?(" "+elem.className+" ").replace(rclass," "):" ")){for(j=0;clazz=classes[j++];)cur.indexOf(" "+clazz+" ")<0&&(cur+=clazz+" ");elem.className=jQuery.trim(cur)}return this},removeClass:function(value){var classes,elem,cur,clazz,j,i=0,len=this.length,proceed=0===arguments.length||"string"==typeof value&&value;if(jQuery.isFunction(value))return this.each(function(j){jQuery(this).removeClass(value.call(this,j,this.className))});if(proceed)for(classes=(value||"").match(core_rnotwhite)||[];i<len;i++)if(elem=this[i],cur=1===elem.nodeType&&(elem.className?(" "+elem.className+" ").replace(rclass," "):"")){for(j=0;clazz=classes[j++];)for(;cur.indexOf(" "+clazz+" ")>=0;)cur=cur.replace(" "+clazz+" "," ");elem.className=value?jQuery.trim(cur):""}return this},toggleClass:function(value,stateVal){var type=typeof value;return"boolean"==typeof stateVal&&"string"===type?stateVal?this.addClass(value):this.removeClass(value):jQuery.isFunction(value)?this.each(function(i){jQuery(this).toggleClass(value.call(this,i,this.className,stateVal),stateVal)}):this.each(function(){if("string"===type)for(var className,i=0,self=jQuery(this),classNames=value.match(core_rnotwhite)||[];className=classNames[i++];)self.hasClass(className)?self.removeClass(className):self.addClass(className);else type!==core_strundefined&&"boolean"!==type||(this.className&&jQuery._data(this,"__className__",this.className),this.className=this.className||!1===value?"":jQuery._data(this,"__className__")||"")})},hasClass:function(selector){for(var className=" "+selector+" ",i=0,l=this.length;i<l;i++)if(1===this[i].nodeType&&(" "+this[i].className+" ").replace(rclass," ").indexOf(className)>=0)return!0;return!1},val:function(value){var ret,hooks,isFunction,elem=this[0];{if(arguments.length)return isFunction=jQuery.isFunction(value),this.each(function(i){var val;1===this.nodeType&&(val=isFunction?value.call(this,i,jQuery(this).val()):value,null==val?val="":"number"==typeof val?val+="":jQuery.isArray(val)&&(val=jQuery.map(val,function(value){return null==value?"":value+""})),(hooks=jQuery.valHooks[this.type]||jQuery.valHooks[this.nodeName.toLowerCase()])&&"set"in hooks&&hooks.set(this,val,"value")!==undefined||(this.value=val))});if(elem)return(hooks=jQuery.valHooks[elem.type]||jQuery.valHooks[elem.nodeName.toLowerCase()])&&"get"in hooks&&(ret=hooks.get(elem,"value"))!==undefined?ret:(ret=elem.value,"string"==typeof ret?ret.replace(rreturn,""):null==ret?"":ret)}}}),jQuery.extend({valHooks:{option:{get:function(elem){var val=jQuery.find.attr(elem,"value");return null!=val?val:elem.text}},select:{get:function(elem){for(var value,option,options=elem.options,index=elem.selectedIndex,one="select-one"===elem.type||index<0,values=one?null:[],max=one?index+1:options.length,i=index<0?max:one?index:0;i<max;i++)if(option=options[i],(option.selected||i===index)&&(jQuery.support.optDisabled?!option.disabled:null===option.getAttribute("disabled"))&&(!option.parentNode.disabled||!jQuery.nodeName(option.parentNode,"optgroup"))){if(value=jQuery(option).val(),one)return value;values.push(value)}return values},set:function(elem,value){for(var optionSet,option,options=elem.options,values=jQuery.makeArray(value),i=options.length;i--;)option=options[i],(option.selected=jQuery.inArray(jQuery(option).val(),values)>=0)&&(optionSet=!0);return optionSet||(elem.selectedIndex=-1),values}}},attr:function(elem,name,value){var hooks,ret,nType=elem.nodeType;if(elem&&3!==nType&&8!==nType&&2!==nType)return typeof elem.getAttribute===core_strundefined?jQuery.prop(elem,name,value):(1===nType&&jQuery.isXMLDoc(elem)||(name=name.toLowerCase(),hooks=jQuery.attrHooks[name]||(jQuery.expr.match.bool.test(name)?boolHook:nodeHook)),value===undefined?hooks&&"get"in hooks&&null!==(ret=hooks.get(elem,name))?ret:(ret=jQuery.find.attr(elem,name),null==ret?undefined:ret):null!==value?hooks&&"set"in hooks&&(ret=hooks.set(elem,value,name))!==undefined?ret:(elem.setAttribute(name,value+""),value):void jQuery.removeAttr(elem,name))},removeAttr:function(elem,value){var name,propName,i=0,attrNames=value&&value.match(core_rnotwhite);if(attrNames&&1===elem.nodeType)for(;name=attrNames[i++];)propName=jQuery.propFix[name]||name,jQuery.expr.match.bool.test(name)?getSetInput&&getSetAttribute||!ruseDefault.test(name)?elem[propName]=!1:elem[jQuery.camelCase("default-"+name)]=elem[propName]=!1:jQuery.attr(elem,name,""),elem.removeAttribute(getSetAttribute?name:propName)},attrHooks:{type:{set:function(elem,value){if(!jQuery.support.radioValue&&"radio"===value&&jQuery.nodeName(elem,"input")){var val=elem.value;return elem.setAttribute("type",value),val&&(elem.value=val),value}}}},propFix:{for:"htmlFor",class:"className"},prop:function(elem,name,value){var ret,hooks,notxml,nType=elem.nodeType;if(elem&&3!==nType&&8!==nType&&2!==nType)return notxml=1!==nType||!jQuery.isXMLDoc(elem),notxml&&(name=jQuery.propFix[name]||name,hooks=jQuery.propHooks[name]),value!==undefined?hooks&&"set"in hooks&&(ret=hooks.set(elem,value,name))!==undefined?ret:elem[name]=value:hooks&&"get"in hooks&&null!==(ret=hooks.get(elem,name))?ret:elem[name]},propHooks:{tabIndex:{get:function(elem){var tabindex=jQuery.find.attr(elem,"tabindex");return tabindex?parseInt(tabindex,10):rfocusable.test(elem.nodeName)||rclickable.test(elem.nodeName)&&elem.href?0:-1}}}}),boolHook={set:function(elem,value,name){return!1===value?jQuery.removeAttr(elem,name):getSetInput&&getSetAttribute||!ruseDefault.test(name)?elem.setAttribute(!getSetAttribute&&jQuery.propFix[name]||name,name):elem[jQuery.camelCase("default-"+name)]=elem[name]=!0,name}},jQuery.each(jQuery.expr.match.bool.source.match(/\w+/g),function(i,name){var getter=jQuery.expr.attrHandle[name]||jQuery.find.attr;jQuery.expr.attrHandle[name]=getSetInput&&getSetAttribute||!ruseDefault.test(name)?function(elem,name,isXML){var fn=jQuery.expr.attrHandle[name],ret=isXML?undefined:(jQuery.expr.attrHandle[name]=undefined)!=getter(elem,name,isXML)?name.toLowerCase():null;return jQuery.expr.attrHandle[name]=fn,ret}:function(elem,name,isXML){return isXML?undefined:elem[jQuery.camelCase("default-"+name)]?name.toLowerCase():null}}),getSetInput&&getSetAttribute||(jQuery.attrHooks.value={set:function(elem,value,name){if(!jQuery.nodeName(elem,"input"))return nodeHook&&nodeHook.set(elem,value,name);elem.defaultValue=value}}),getSetAttribute||(nodeHook={set:function(elem,value,name){var ret=elem.getAttributeNode(name);return ret||elem.setAttributeNode(ret=elem.ownerDocument.createAttribute(name)),ret.value=value+="","value"===name||value===elem.getAttribute(name)?value:undefined}},jQuery.expr.attrHandle.id=jQuery.expr.attrHandle.name=jQuery.expr.attrHandle.coords=function(elem,name,isXML){var ret;return isXML?undefined:(ret=elem.getAttributeNode(name))&&""!==ret.value?ret.value:null},jQuery.valHooks.button={get:function(elem,name){var ret=elem.getAttributeNode(name);return ret&&ret.specified?ret.value:undefined},set:nodeHook.set},jQuery.attrHooks.contenteditable={set:function(elem,value,name){nodeHook.set(elem,""!==value&&value,name)}},jQuery.each(["width","height"],function(i,name){jQuery.attrHooks[name]={set:function(elem,value){if(""===value)return elem.setAttribute(name,"auto"),value}}})),jQuery.support.hrefNormalized||jQuery.each(["href","src"],function(i,name){jQuery.propHooks[name]={get:function(elem){return elem.getAttribute(name,4)}}}),jQuery.support.style||(jQuery.attrHooks.style={get:function(elem){return elem.style.cssText||undefined},set:function(elem,value){return elem.style.cssText=value+""}}),jQuery.support.optSelected||(jQuery.propHooks.selected={get:function(elem){var parent=elem.parentNode;return parent&&(parent.selectedIndex,parent.parentNode&&parent.parentNode.selectedIndex),null}}),jQuery.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){jQuery.propFix[this.toLowerCase()]=this}),jQuery.support.enctype||(jQuery.propFix.enctype="encoding"),jQuery.each(["radio","checkbox"],function(){jQuery.valHooks[this]={set:function(elem,value){if(jQuery.isArray(value))return elem.checked=jQuery.inArray(jQuery(elem).val(),value)>=0}},jQuery.support.checkOn||(jQuery.valHooks[this].get=function(elem){return null===elem.getAttribute("value")?"on":elem.value})});var rformElems=/^(?:input|select|textarea)$/i,rkeyEvent=/^key/,rmouseEvent=/^(?:mouse|contextmenu)|click/,rfocusMorph=/^(?:focusinfocus|focusoutblur)$/,rtypenamespace=/^([^.]*)(?:\.(.+)|)$/;function returnTrue(){return!0}function returnFalse(){return!1}function safeActiveElement(){try{return document.activeElement}catch(err){}}jQuery.event={global:{},add:function(elem,types,handler,data,selector){
var tmp,events,t,handleObjIn,special,eventHandle,handleObj,handlers,type,namespaces,origType,elemData=jQuery._data(elem);if(elemData){for(handler.handler&&(handleObjIn=handler,handler=handleObjIn.handler,selector=handleObjIn.selector),handler.guid||(handler.guid=jQuery.guid++),(events=elemData.events)||(events=elemData.events={}),(eventHandle=elemData.handle)||(eventHandle=elemData.handle=function(e){return typeof jQuery===core_strundefined||e&&jQuery.event.triggered===e.type?undefined:jQuery.event.dispatch.apply(eventHandle.elem,arguments)},eventHandle.elem=elem),types=(types||"").match(core_rnotwhite)||[""],t=types.length;t--;)tmp=rtypenamespace.exec(types[t])||[],type=origType=tmp[1],namespaces=(tmp[2]||"").split(".").sort(),type&&(special=jQuery.event.special[type]||{},type=(selector?special.delegateType:special.bindType)||type,special=jQuery.event.special[type]||{},handleObj=jQuery.extend({type:type,origType:origType,data:data,handler:handler,guid:handler.guid,selector:selector,needsContext:selector&&jQuery.expr.match.needsContext.test(selector),namespace:namespaces.join(".")},handleObjIn),(handlers=events[type])||(handlers=events[type]=[],handlers.delegateCount=0,special.setup&&!1!==special.setup.call(elem,data,namespaces,eventHandle)||(elem.addEventListener?elem.addEventListener(type,eventHandle,!1):elem.attachEvent&&elem.attachEvent("on"+type,eventHandle))),special.add&&(special.add.call(elem,handleObj),handleObj.handler.guid||(handleObj.handler.guid=handler.guid)),selector?handlers.splice(handlers.delegateCount++,0,handleObj):handlers.push(handleObj),jQuery.event.global[type]=!0);elem=null}},remove:function(elem,types,handler,selector,mappedTypes){var j,handleObj,tmp,origCount,t,events,special,handlers,type,namespaces,origType,elemData=jQuery.hasData(elem)&&jQuery._data(elem);if(elemData&&(events=elemData.events)){for(types=(types||"").match(core_rnotwhite)||[""],t=types.length;t--;)if(tmp=rtypenamespace.exec(types[t])||[],type=origType=tmp[1],namespaces=(tmp[2]||"").split(".").sort(),type){for(special=jQuery.event.special[type]||{},type=(selector?special.delegateType:special.bindType)||type,handlers=events[type]||[],tmp=tmp[2]&&new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)"),origCount=j=handlers.length;j--;)handleObj=handlers[j],!mappedTypes&&origType!==handleObj.origType||handler&&handler.guid!==handleObj.guid||tmp&&!tmp.test(handleObj.namespace)||selector&&selector!==handleObj.selector&&("**"!==selector||!handleObj.selector)||(handlers.splice(j,1),handleObj.selector&&handlers.delegateCount--,special.remove&&special.remove.call(elem,handleObj));origCount&&!handlers.length&&(special.teardown&&!1!==special.teardown.call(elem,namespaces,elemData.handle)||jQuery.removeEvent(elem,type,elemData.handle),delete events[type])}else for(type in events)jQuery.event.remove(elem,type+types[t],handler,selector,!0);jQuery.isEmptyObject(events)&&(delete elemData.handle,jQuery._removeData(elem,"events"))}},trigger:function(event,data,elem,onlyHandlers){var handle,ontype,cur,bubbleType,special,tmp,i,eventPath=[elem||document],type=core_hasOwn.call(event,"type")?event.type:event,namespaces=core_hasOwn.call(event,"namespace")?event.namespace.split("."):[];if(cur=tmp=elem=elem||document,3!==elem.nodeType&&8!==elem.nodeType&&!rfocusMorph.test(type+jQuery.event.triggered)&&(type.indexOf(".")>=0&&(namespaces=type.split("."),type=namespaces.shift(),namespaces.sort()),ontype=type.indexOf(":")<0&&"on"+type,event=event[jQuery.expando]?event:new jQuery.Event(type,"object"==typeof event&&event),event.isTrigger=onlyHandlers?2:3,event.namespace=namespaces.join("."),event.namespace_re=event.namespace?new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,event.result=undefined,event.target||(event.target=elem),data=null==data?[event]:jQuery.makeArray(data,[event]),special=jQuery.event.special[type]||{},onlyHandlers||!special.trigger||!1!==special.trigger.apply(elem,data))){if(!onlyHandlers&&!special.noBubble&&!jQuery.isWindow(elem)){for(bubbleType=special.delegateType||type,rfocusMorph.test(bubbleType+type)||(cur=cur.parentNode);cur;cur=cur.parentNode)eventPath.push(cur),tmp=cur;tmp===(elem.ownerDocument||document)&&eventPath.push(tmp.defaultView||tmp.parentWindow||window)}for(i=0;(cur=eventPath[i++])&&!event.isPropagationStopped();)event.type=i>1?bubbleType:special.bindType||type,handle=(jQuery._data(cur,"events")||{})[event.type]&&jQuery._data(cur,"handle"),handle&&handle.apply(cur,data),(handle=ontype&&cur[ontype])&&jQuery.acceptData(cur)&&handle.apply&&!1===handle.apply(cur,data)&&event.preventDefault();if(event.type=type,!onlyHandlers&&!event.isDefaultPrevented()&&(!special._default||!1===special._default.apply(eventPath.pop(),data))&&jQuery.acceptData(elem)&&ontype&&elem[type]&&!jQuery.isWindow(elem)){tmp=elem[ontype],tmp&&(elem[ontype]=null),jQuery.event.triggered=type;try{elem[type]()}catch(e){}jQuery.event.triggered=undefined,tmp&&(elem[ontype]=tmp)}return event.result}},dispatch:function(event){event=jQuery.event.fix(event);var i,ret,handleObj,matched,j,handlerQueue=[],args=core_slice.call(arguments),handlers=(jQuery._data(this,"events")||{})[event.type]||[],special=jQuery.event.special[event.type]||{};if(args[0]=event,event.delegateTarget=this,!special.preDispatch||!1!==special.preDispatch.call(this,event)){for(handlerQueue=jQuery.event.handlers.call(this,event,handlers),i=0;(matched=handlerQueue[i++])&&!event.isPropagationStopped();)for(event.currentTarget=matched.elem,j=0;(handleObj=matched.handlers[j++])&&!event.isImmediatePropagationStopped();)event.namespace_re&&!event.namespace_re.test(handleObj.namespace)||(event.handleObj=handleObj,event.data=handleObj.data,(ret=((jQuery.event.special[handleObj.origType]||{}).handle||handleObj.handler).apply(matched.elem,args))!==undefined&&!1===(event.result=ret)&&(event.preventDefault(),event.stopPropagation()));return special.postDispatch&&special.postDispatch.call(this,event),event.result}},handlers:function(event,handlers){var sel,handleObj,matches,i,handlerQueue=[],delegateCount=handlers.delegateCount,cur=event.target;if(delegateCount&&cur.nodeType&&(!event.button||"click"!==event.type))for(;cur!=this;cur=cur.parentNode||this)if(1===cur.nodeType&&(!0!==cur.disabled||"click"!==event.type)){for(matches=[],i=0;i<delegateCount;i++)handleObj=handlers[i],sel=handleObj.selector+" ",matches[sel]===undefined&&(matches[sel]=handleObj.needsContext?jQuery(sel,this).index(cur)>=0:jQuery.find(sel,this,null,[cur]).length),matches[sel]&&matches.push(handleObj);matches.length&&handlerQueue.push({elem:cur,handlers:matches})}return delegateCount<handlers.length&&handlerQueue.push({elem:this,handlers:handlers.slice(delegateCount)}),handlerQueue},fix:function(event){if(event[jQuery.expando])return event;var i,prop,copy,type=event.type,originalEvent=event,fixHook=this.fixHooks[type];for(fixHook||(this.fixHooks[type]=fixHook=rmouseEvent.test(type)?this.mouseHooks:rkeyEvent.test(type)?this.keyHooks:{}),copy=fixHook.props?this.props.concat(fixHook.props):this.props,event=new jQuery.Event(originalEvent),i=copy.length;i--;)prop=copy[i],event[prop]=originalEvent[prop];return event.target||(event.target=originalEvent.srcElement||document),3===event.target.nodeType&&(event.target=event.target.parentNode),event.metaKey=!!event.metaKey,fixHook.filter?fixHook.filter(event,originalEvent):event},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(event,original){return null==event.which&&(event.which=null!=original.charCode?original.charCode:original.keyCode),event}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(event,original){var body,eventDoc,doc,button=original.button,fromElement=original.fromElement;return null==event.pageX&&null!=original.clientX&&(eventDoc=event.target.ownerDocument||document,doc=eventDoc.documentElement,body=eventDoc.body,event.pageX=original.clientX+(doc&&doc.scrollLeft||body&&body.scrollLeft||0)-(doc&&doc.clientLeft||body&&body.clientLeft||0),event.pageY=original.clientY+(doc&&doc.scrollTop||body&&body.scrollTop||0)-(doc&&doc.clientTop||body&&body.clientTop||0)),!event.relatedTarget&&fromElement&&(event.relatedTarget=fromElement===event.target?original.toElement:fromElement),event.which||button===undefined||(event.which=1&button?1:2&button?3:4&button?2:0),event}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==safeActiveElement()&&this.focus)try{return this.focus(),!1}catch(e){}},delegateType:"focusin"},blur:{trigger:function(){if(this===safeActiveElement()&&this.blur)return this.blur(),!1},delegateType:"focusout"},click:{trigger:function(){if(jQuery.nodeName(this,"input")&&"checkbox"===this.type&&this.click)return this.click(),!1},_default:function(event){return jQuery.nodeName(event.target,"a")}},beforeunload:{postDispatch:function(event){event.result!==undefined&&(event.originalEvent.returnValue=event.result)}}},simulate:function(type,elem,event,bubble){var e=jQuery.extend(new jQuery.Event,event,{type:type,isSimulated:!0,originalEvent:{}});bubble?jQuery.event.trigger(e,null,elem):jQuery.event.dispatch.call(elem,e),e.isDefaultPrevented()&&event.preventDefault()}},jQuery.removeEvent=document.removeEventListener?function(elem,type,handle){elem.removeEventListener&&elem.removeEventListener(type,handle,!1)}:function(elem,type,handle){var name="on"+type;elem.detachEvent&&(typeof elem[name]===core_strundefined&&(elem[name]=null),elem.detachEvent(name,handle))},jQuery.Event=function(src,props){if(!(this instanceof jQuery.Event))return new jQuery.Event(src,props);src&&src.type?(this.originalEvent=src,this.type=src.type,this.isDefaultPrevented=src.defaultPrevented||!1===src.returnValue||src.getPreventDefault&&src.getPreventDefault()?returnTrue:returnFalse):this.type=src,props&&jQuery.extend(this,props),this.timeStamp=src&&src.timeStamp||jQuery.now(),this[jQuery.expando]=!0},jQuery.Event.prototype={isDefaultPrevented:returnFalse,isPropagationStopped:returnFalse,isImmediatePropagationStopped:returnFalse,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=returnTrue,e&&(e.preventDefault?e.preventDefault():e.returnValue=!1)},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=returnTrue,e&&(e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=returnTrue,this.stopPropagation()}},jQuery.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(orig,fix){jQuery.event.special[orig]={delegateType:fix,bindType:fix,handle:function(event){var ret,target=this,related=event.relatedTarget,handleObj=event.handleObj;return related&&(related===target||jQuery.contains(target,related))||(event.type=handleObj.origType,ret=handleObj.handler.apply(this,arguments),event.type=fix),ret}}}),jQuery.support.submitBubbles||(jQuery.event.special.submit={setup:function(){if(jQuery.nodeName(this,"form"))return!1;jQuery.event.add(this,"click._submit keypress._submit",function(e){var elem=e.target,form=jQuery.nodeName(elem,"input")||jQuery.nodeName(elem,"button")?elem.form:undefined;form&&!jQuery._data(form,"submitBubbles")&&(jQuery.event.add(form,"submit._submit",function(event){event._submit_bubble=!0}),jQuery._data(form,"submitBubbles",!0))})},postDispatch:function(event){event._submit_bubble&&(delete event._submit_bubble,this.parentNode&&!event.isTrigger&&jQuery.event.simulate("submit",this.parentNode,event,!0))},teardown:function(){if(jQuery.nodeName(this,"form"))return!1;jQuery.event.remove(this,"._submit")}}),jQuery.support.changeBubbles||(jQuery.event.special.change={setup:function(){if(rformElems.test(this.nodeName))return"checkbox"!==this.type&&"radio"!==this.type||(jQuery.event.add(this,"propertychange._change",function(event){"checked"===event.originalEvent.propertyName&&(this._just_changed=!0)}),jQuery.event.add(this,"click._change",function(event){this._just_changed&&!event.isTrigger&&(this._just_changed=!1),jQuery.event.simulate("change",this,event,!0)})),!1;jQuery.event.add(this,"beforeactivate._change",function(e){var elem=e.target;rformElems.test(elem.nodeName)&&!jQuery._data(elem,"changeBubbles")&&(jQuery.event.add(elem,"change._change",function(event){!this.parentNode||event.isSimulated||event.isTrigger||jQuery.event.simulate("change",this.parentNode,event,!0)}),jQuery._data(elem,"changeBubbles",!0))})},handle:function(event){var elem=event.target;if(this!==elem||event.isSimulated||event.isTrigger||"radio"!==elem.type&&"checkbox"!==elem.type)return event.handleObj.handler.apply(this,arguments)},teardown:function(){return jQuery.event.remove(this,"._change"),!rformElems.test(this.nodeName)}}),jQuery.support.focusinBubbles||jQuery.each({focus:"focusin",blur:"focusout"},function(orig,fix){var attaches=0,handler=function(event){jQuery.event.simulate(fix,event.target,jQuery.event.fix(event),!0)};jQuery.event.special[fix]={setup:function(){0==attaches++&&document.addEventListener(orig,handler,!0)},teardown:function(){0==--attaches&&document.removeEventListener(orig,handler,!0)}}}),jQuery.fn.extend({on:function(types,selector,data,fn,one){var type,origFn;if("object"==typeof types){"string"!=typeof selector&&(data=data||selector,selector=undefined);for(type in types)this.on(type,selector,data,types[type],one);return this}if(null==data&&null==fn?(fn=selector,data=selector=undefined):null==fn&&("string"==typeof selector?(fn=data,data=undefined):(fn=data,data=selector,selector=undefined)),!1===fn)fn=returnFalse;else if(!fn)return this;return 1===one&&(origFn=fn,fn=function(event){return jQuery().off(event),origFn.apply(this,arguments)},fn.guid=origFn.guid||(origFn.guid=jQuery.guid++)),this.each(function(){jQuery.event.add(this,types,fn,data,selector)})},one:function(types,selector,data,fn){return this.on(types,selector,data,fn,1)},off:function(types,selector,fn){var handleObj,type;if(types&&types.preventDefault&&types.handleObj)return handleObj=types.handleObj,jQuery(types.delegateTarget).off(handleObj.namespace?handleObj.origType+"."+handleObj.namespace:handleObj.origType,handleObj.selector,handleObj.handler),this;if("object"==typeof types){for(type in types)this.off(type,selector,types[type]);return this}return!1!==selector&&"function"!=typeof selector||(fn=selector,selector=undefined),!1===fn&&(fn=returnFalse),this.each(function(){jQuery.event.remove(this,types,fn,selector)})},trigger:function(type,data){return this.each(function(){jQuery.event.trigger(type,data,this)})},triggerHandler:function(type,data){var elem=this[0];if(elem)return jQuery.event.trigger(type,data,elem,!0)}});var isSimple=/^.[^:#\[\.,]*$/,rparentsprev=/^(?:parents|prev(?:Until|All))/,rneedsContext=jQuery.expr.match.needsContext,guaranteedUnique={children:!0,contents:!0,next:!0,prev:!0};jQuery.fn.extend({find:function(selector){var i,ret=[],self=this,len=self.length;if("string"!=typeof selector)return this.pushStack(jQuery(selector).filter(function(){for(i=0;i<len;i++)if(jQuery.contains(self[i],this))return!0}));for(i=0;i<len;i++)jQuery.find(selector,self[i],ret);return ret=this.pushStack(len>1?jQuery.unique(ret):ret),ret.selector=this.selector?this.selector+" "+selector:selector,ret},has:function(target){var i,targets=jQuery(target,this),len=targets.length;return this.filter(function(){for(i=0;i<len;i++)if(jQuery.contains(this,targets[i]))return!0})},not:function(selector){return this.pushStack(winnow(this,selector||[],!0))},filter:function(selector){return this.pushStack(winnow(this,selector||[],!1))},is:function(selector){return!!winnow(this,"string"==typeof selector&&rneedsContext.test(selector)?jQuery(selector):selector||[],!1).length},closest:function(selectors,context){for(var cur,i=0,l=this.length,ret=[],pos=rneedsContext.test(selectors)||"string"!=typeof selectors?jQuery(selectors,context||this.context):0;i<l;i++)for(cur=this[i];cur&&cur!==context;cur=cur.parentNode)if(cur.nodeType<11&&(pos?pos.index(cur)>-1:1===cur.nodeType&&jQuery.find.matchesSelector(cur,selectors))){cur=ret.push(cur);break}return this.pushStack(ret.length>1?jQuery.unique(ret):ret)},index:function(elem){return elem?"string"==typeof elem?jQuery.inArray(this[0],jQuery(elem)):jQuery.inArray(elem.jquery?elem[0]:elem,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(selector,context){var set="string"==typeof selector?jQuery(selector,context):jQuery.makeArray(selector&&selector.nodeType?[selector]:selector),all=jQuery.merge(this.get(),set);return this.pushStack(jQuery.unique(all))},addBack:function(selector){return this.add(null==selector?this.prevObject:this.prevObject.filter(selector))}});function sibling(cur,dir){do{cur=cur[dir]}while(cur&&1!==cur.nodeType);return cur}jQuery.each({parent:function(elem){var parent=elem.parentNode;return parent&&11!==parent.nodeType?parent:null},parents:function(elem){return jQuery.dir(elem,"parentNode")},parentsUntil:function(elem,i,until){return jQuery.dir(elem,"parentNode",until)},next:function(elem){return sibling(elem,"nextSibling")},prev:function(elem){return sibling(elem,"previousSibling")},nextAll:function(elem){return jQuery.dir(elem,"nextSibling")},prevAll:function(elem){return jQuery.dir(elem,"previousSibling")},nextUntil:function(elem,i,until){return jQuery.dir(elem,"nextSibling",until)},prevUntil:function(elem,i,until){return jQuery.dir(elem,"previousSibling",until)},siblings:function(elem){return jQuery.sibling((elem.parentNode||{}).firstChild,elem)},children:function(elem){return jQuery.sibling(elem.firstChild)},contents:function(elem){return jQuery.nodeName(elem,"iframe")?elem.contentDocument||elem.contentWindow.document:jQuery.merge([],elem.childNodes)}},function(name,fn){jQuery.fn[name]=function(until,selector){var ret=jQuery.map(this,fn,until);return"Until"!==name.slice(-5)&&(selector=until),selector&&"string"==typeof selector&&(ret=jQuery.filter(selector,ret)),this.length>1&&(guaranteedUnique[name]||(ret=jQuery.unique(ret)),rparentsprev.test(name)&&(ret=ret.reverse())),this.pushStack(ret)}}),jQuery.extend({filter:function(expr,elems,not){var elem=elems[0];return not&&(expr=":not("+expr+")"),1===elems.length&&1===elem.nodeType?jQuery.find.matchesSelector(elem,expr)?[elem]:[]:jQuery.find.matches(expr,jQuery.grep(elems,function(elem){return 1===elem.nodeType}))},dir:function(elem,dir,until){for(var matched=[],cur=elem[dir];cur&&9!==cur.nodeType&&(until===undefined||1!==cur.nodeType||!jQuery(cur).is(until));)1===cur.nodeType&&matched.push(cur),cur=cur[dir];return matched},sibling:function(n,elem){for(var r=[];n;n=n.nextSibling)1===n.nodeType&&n!==elem&&r.push(n);return r}});function winnow(elements,qualifier,not){if(jQuery.isFunction(qualifier))return jQuery.grep(elements,function(elem,i){return!!qualifier.call(elem,i,elem)!==not});if(qualifier.nodeType)return jQuery.grep(elements,function(elem){return elem===qualifier!==not});if("string"==typeof qualifier){if(isSimple.test(qualifier))return jQuery.filter(qualifier,elements,not);qualifier=jQuery.filter(qualifier,elements)}return jQuery.grep(elements,function(elem){return jQuery.inArray(elem,qualifier)>=0!==not})}function createSafeFragment(document){var list=nodeNames.split("|"),safeFrag=document.createDocumentFragment();if(safeFrag.createElement)for(;list.length;)safeFrag.createElement(list.pop());return safeFrag}var nodeNames="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",rinlinejQuery=/ jQuery\d+="(?:null|\d+)"/g,rnoshimcache=new RegExp("<(?:"+nodeNames+")[\\s/>]","i"),rleadingWhitespace=/^\s+/,rxhtmlTag=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,rtagName=/<([\w:]+)/,rtbody=/<tbody/i,rhtml=/<|&#?\w+;/,rnoInnerhtml=/<(?:script|style|link)/i,manipulation_rcheckableType=/^(?:checkbox|radio)$/i,rchecked=/checked\s*(?:[^=]|=\s*.checked.)/i,rscriptType=/^$|\/(?:java|ecma)script/i,rscriptTypeMasked=/^true\/(.*)/,rcleanScript=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,wrapMap={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:jQuery.support.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},safeFragment=createSafeFragment(document),fragmentDiv=safeFragment.appendChild(document.createElement("div"));wrapMap.optgroup=wrapMap.option,wrapMap.tbody=wrapMap.tfoot=wrapMap.colgroup=wrapMap.caption=wrapMap.thead,wrapMap.th=wrapMap.td,jQuery.fn.extend({text:function(value){return jQuery.access(this,function(value){return value===undefined?jQuery.text(this):this.empty().append((this[0]&&this[0].ownerDocument||document).createTextNode(value))},null,value,arguments.length)},append:function(){return this.domManip(arguments,function(elem){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){manipulationTarget(this,elem).appendChild(elem)}})},prepend:function(){return this.domManip(arguments,function(elem){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var target=manipulationTarget(this,elem);target.insertBefore(elem,target.firstChild)}})},before:function(){return this.domManip(arguments,function(elem){this.parentNode&&this.parentNode.insertBefore(elem,this)})},after:function(){return this.domManip(arguments,function(elem){this.parentNode&&this.parentNode.insertBefore(elem,this.nextSibling)})},remove:function(selector,keepData){for(var elem,elems=selector?jQuery.filter(selector,this):this,i=0;null!=(elem=elems[i]);i++)keepData||1!==elem.nodeType||jQuery.cleanData(getAll(elem)),elem.parentNode&&(keepData&&jQuery.contains(elem.ownerDocument,elem)&&setGlobalEval(getAll(elem,"script")),elem.parentNode.removeChild(elem));return this},empty:function(){for(var elem,i=0;null!=(elem=this[i]);i++){for(1===elem.nodeType&&jQuery.cleanData(getAll(elem,!1));elem.firstChild;)elem.removeChild(elem.firstChild);elem.options&&jQuery.nodeName(elem,"select")&&(elem.options.length=0)}return this},clone:function(dataAndEvents,deepDataAndEvents){return dataAndEvents=null!=dataAndEvents&&dataAndEvents,deepDataAndEvents=null==deepDataAndEvents?dataAndEvents:deepDataAndEvents,this.map(function(){return jQuery.clone(this,dataAndEvents,deepDataAndEvents)})},html:function(value){return jQuery.access(this,function(value){var elem=this[0]||{},i=0,l=this.length;if(value===undefined)return 1===elem.nodeType?elem.innerHTML.replace(rinlinejQuery,""):undefined;if("string"==typeof value&&!rnoInnerhtml.test(value)&&(jQuery.support.htmlSerialize||!rnoshimcache.test(value))&&(jQuery.support.leadingWhitespace||!rleadingWhitespace.test(value))&&!wrapMap[(rtagName.exec(value)||["",""])[1].toLowerCase()]){value=value.replace(rxhtmlTag,"<$1></$2>");try{for(;i<l;i++)elem=this[i]||{},1===elem.nodeType&&(jQuery.cleanData(getAll(elem,!1)),elem.innerHTML=value);elem=0}catch(e){}}elem&&this.empty().append(value)},null,value,arguments.length)},replaceWith:function(){var args=jQuery.map(this,function(elem){return[elem.nextSibling,elem.parentNode]}),i=0;return this.domManip(arguments,function(elem){var next=args[i++],parent=args[i++];parent&&(next&&next.parentNode!==parent&&(next=this.nextSibling),jQuery(this).remove(),parent.insertBefore(elem,next))},!0),i?this:this.remove()},detach:function(selector){return this.remove(selector,!0)},domManip:function(args,callback,allowIntersection){args=core_concat.apply([],args);var first,node,hasScripts,scripts,doc,fragment,i=0,l=this.length,set=this,iNoClone=l-1,value=args[0],isFunction=jQuery.isFunction(value);if(isFunction||!(l<=1||"string"!=typeof value||jQuery.support.checkClone)&&rchecked.test(value))return this.each(function(index){var self=set.eq(index);isFunction&&(args[0]=value.call(this,index,self.html())),self.domManip(args,callback,allowIntersection)});if(l&&(fragment=jQuery.buildFragment(args,this[0].ownerDocument,!1,!allowIntersection&&this),first=fragment.firstChild,1===fragment.childNodes.length&&(fragment=first),first)){for(scripts=jQuery.map(getAll(fragment,"script"),disableScript),hasScripts=scripts.length;i<l;i++)node=fragment,i!==iNoClone&&(node=jQuery.clone(node,!0,!0),hasScripts&&jQuery.merge(scripts,getAll(node,"script"))),callback.call(this[i],node,i);if(hasScripts)for(doc=scripts[scripts.length-1].ownerDocument,jQuery.map(scripts,restoreScript),i=0;i<hasScripts;i++)node=scripts[i],rscriptType.test(node.type||"")&&!jQuery._data(node,"globalEval")&&jQuery.contains(doc,node)&&(node.src?jQuery._evalUrl(node.src):jQuery.globalEval((node.text||node.textContent||node.innerHTML||"").replace(rcleanScript,"")));fragment=first=null}return this}});function manipulationTarget(elem,content){return jQuery.nodeName(elem,"table")&&jQuery.nodeName(1===content.nodeType?content:content.firstChild,"tr")?elem.getElementsByTagName("tbody")[0]||elem.appendChild(elem.ownerDocument.createElement("tbody")):elem}function disableScript(elem){return elem.type=(null!==jQuery.find.attr(elem,"type"))+"/"+elem.type,elem}function restoreScript(elem){var match=rscriptTypeMasked.exec(elem.type);return match?elem.type=match[1]:elem.removeAttribute("type"),elem}function setGlobalEval(elems,refElements){for(var elem,i=0;null!=(elem=elems[i]);i++)jQuery._data(elem,"globalEval",!refElements||jQuery._data(refElements[i],"globalEval"))}function cloneCopyEvent(src,dest){if(1===dest.nodeType&&jQuery.hasData(src)){var type,i,l,oldData=jQuery._data(src),curData=jQuery._data(dest,oldData),events=oldData.events;if(events){delete curData.handle,curData.events={};for(type in events)for(i=0,l=events[type].length;i<l;i++)jQuery.event.add(dest,type,events[type][i])}curData.data&&(curData.data=jQuery.extend({},curData.data))}}function fixCloneNodeIssues(src,dest){var nodeName,e,data;if(1===dest.nodeType){if(nodeName=dest.nodeName.toLowerCase(),!jQuery.support.noCloneEvent&&dest[jQuery.expando]){data=jQuery._data(dest);for(e in data.events)jQuery.removeEvent(dest,e,data.handle);dest.removeAttribute(jQuery.expando)}"script"===nodeName&&dest.text!==src.text?(disableScript(dest).text=src.text,restoreScript(dest)):"object"===nodeName?(dest.parentNode&&(dest.outerHTML=src.outerHTML),jQuery.support.html5Clone&&src.innerHTML&&!jQuery.trim(dest.innerHTML)&&(dest.innerHTML=src.innerHTML)):"input"===nodeName&&manipulation_rcheckableType.test(src.type)?(dest.defaultChecked=dest.checked=src.checked,dest.value!==src.value&&(dest.value=src.value)):"option"===nodeName?dest.defaultSelected=dest.selected=src.defaultSelected:"input"!==nodeName&&"textarea"!==nodeName||(dest.defaultValue=src.defaultValue)}}jQuery.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(name,original){jQuery.fn[name]=function(selector){for(var elems,i=0,ret=[],insert=jQuery(selector),last=insert.length-1;i<=last;i++)elems=i===last?this:this.clone(!0),jQuery(insert[i])[original](elems),core_push.apply(ret,elems.get());return this.pushStack(ret)}});function getAll(context,tag){var elems,elem,i=0,found=typeof context.getElementsByTagName!==core_strundefined?context.getElementsByTagName(tag||"*"):typeof context.querySelectorAll!==core_strundefined?context.querySelectorAll(tag||"*"):undefined;if(!found)for(found=[],elems=context.childNodes||context;null!=(elem=elems[i]);i++)!tag||jQuery.nodeName(elem,tag)?found.push(elem):jQuery.merge(found,getAll(elem,tag));return tag===undefined||tag&&jQuery.nodeName(context,tag)?jQuery.merge([context],found):found}function fixDefaultChecked(elem){manipulation_rcheckableType.test(elem.type)&&(elem.defaultChecked=elem.checked)}jQuery.extend({clone:function(elem,dataAndEvents,deepDataAndEvents){var destElements,node,clone,i,srcElements,inPage=jQuery.contains(elem.ownerDocument,elem);if(jQuery.support.html5Clone||jQuery.isXMLDoc(elem)||!rnoshimcache.test("<"+elem.nodeName+">")?clone=elem.cloneNode(!0):(fragmentDiv.innerHTML=elem.outerHTML,fragmentDiv.removeChild(clone=fragmentDiv.firstChild)),!(jQuery.support.noCloneEvent&&jQuery.support.noCloneChecked||1!==elem.nodeType&&11!==elem.nodeType||jQuery.isXMLDoc(elem)))for(destElements=getAll(clone),srcElements=getAll(elem),i=0;null!=(node=srcElements[i]);++i)destElements[i]&&fixCloneNodeIssues(node,destElements[i]);if(dataAndEvents)if(deepDataAndEvents)for(srcElements=srcElements||getAll(elem),destElements=destElements||getAll(clone),i=0;null!=(node=srcElements[i]);i++)cloneCopyEvent(node,destElements[i]);else cloneCopyEvent(elem,clone);return destElements=getAll(clone,"script"),destElements.length>0&&setGlobalEval(destElements,!inPage&&getAll(elem,"script")),destElements=srcElements=node=null,clone},buildFragment:function(elems,context,scripts,selection){for(var j,elem,contains,tmp,tag,tbody,wrap,l=elems.length,safe=createSafeFragment(context),nodes=[],i=0;i<l;i++)if((elem=elems[i])||0===elem)if("object"===jQuery.type(elem))jQuery.merge(nodes,elem.nodeType?[elem]:elem);else if(rhtml.test(elem)){for(tmp=tmp||safe.appendChild(context.createElement("div")),tag=(rtagName.exec(elem)||["",""])[1].toLowerCase(),wrap=wrapMap[tag]||wrapMap._default,tmp.innerHTML=wrap[1]+elem.replace(rxhtmlTag,"<$1></$2>")+wrap[2],j=wrap[0];j--;)tmp=tmp.lastChild;if(!jQuery.support.leadingWhitespace&&rleadingWhitespace.test(elem)&&nodes.push(context.createTextNode(rleadingWhitespace.exec(elem)[0])),!jQuery.support.tbody)for(elem="table"!==tag||rtbody.test(elem)?"<table>"!==wrap[1]||rtbody.test(elem)?0:tmp:tmp.firstChild,j=elem&&elem.childNodes.length;j--;)jQuery.nodeName(tbody=elem.childNodes[j],"tbody")&&!tbody.childNodes.length&&elem.removeChild(tbody);for(jQuery.merge(nodes,tmp.childNodes),tmp.textContent="";tmp.firstChild;)tmp.removeChild(tmp.firstChild);tmp=safe.lastChild}else nodes.push(context.createTextNode(elem));for(tmp&&safe.removeChild(tmp),jQuery.support.appendChecked||jQuery.grep(getAll(nodes,"input"),fixDefaultChecked),i=0;elem=nodes[i++];)if((!selection||-1===jQuery.inArray(elem,selection))&&(contains=jQuery.contains(elem.ownerDocument,elem),tmp=getAll(safe.appendChild(elem),"script"),contains&&setGlobalEval(tmp),scripts))for(j=0;elem=tmp[j++];)rscriptType.test(elem.type||"")&&scripts.push(elem);return tmp=null,safe},cleanData:function(elems,acceptData){for(var elem,type,id,data,i=0,internalKey=jQuery.expando,cache=jQuery.cache,deleteExpando=jQuery.support.deleteExpando,special=jQuery.event.special;null!=(elem=elems[i]);i++)if((acceptData||jQuery.acceptData(elem))&&(id=elem[internalKey],data=id&&cache[id])){if(data.events)for(type in data.events)special[type]?jQuery.event.remove(elem,type):jQuery.removeEvent(elem,type,data.handle);cache[id]&&(delete cache[id],deleteExpando?delete elem[internalKey]:typeof elem.removeAttribute!==core_strundefined?elem.removeAttribute(internalKey):elem[internalKey]=null,core_deletedIds.push(id))}},_evalUrl:function(url){return jQuery.ajax({url:url,type:"GET",dataType:"script",async:!1,global:!1,throws:!0})}}),jQuery.fn.extend({wrapAll:function(html){if(jQuery.isFunction(html))return this.each(function(i){jQuery(this).wrapAll(html.call(this,i))});if(this[0]){var wrap=jQuery(html,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&wrap.insertBefore(this[0]),wrap.map(function(){for(var elem=this;elem.firstChild&&1===elem.firstChild.nodeType;)elem=elem.firstChild;return elem}).append(this)}return this},wrapInner:function(html){return jQuery.isFunction(html)?this.each(function(i){jQuery(this).wrapInner(html.call(this,i))}):this.each(function(){var self=jQuery(this),contents=self.contents();contents.length?contents.wrapAll(html):self.append(html)})},wrap:function(html){var isFunction=jQuery.isFunction(html);return this.each(function(i){
jQuery(this).wrapAll(isFunction?html.call(this,i):html)})},unwrap:function(){return this.parent().each(function(){jQuery.nodeName(this,"body")||jQuery(this).replaceWith(this.childNodes)}).end()}});var iframe,getStyles,curCSS,ralpha=/alpha\([^)]*\)/i,ropacity=/opacity\s*=\s*([^)]*)/,rposition=/^(top|right|bottom|left)$/,rdisplayswap=/^(none|table(?!-c[ea]).+)/,rmargin=/^margin/,rnumsplit=new RegExp("^("+core_pnum+")(.*)$","i"),rnumnonpx=new RegExp("^("+core_pnum+")(?!px)[a-z%]+$","i"),rrelNum=new RegExp("^([+-])=("+core_pnum+")","i"),elemdisplay={BODY:"block"},cssShow={position:"absolute",visibility:"hidden",display:"block"},cssNormalTransform={letterSpacing:0,fontWeight:400},cssExpand=["Top","Right","Bottom","Left"],cssPrefixes=["Webkit","O","Moz","ms"];function vendorPropName(style,name){if(name in style)return name;for(var capName=name.charAt(0).toUpperCase()+name.slice(1),origName=name,i=cssPrefixes.length;i--;)if((name=cssPrefixes[i]+capName)in style)return name;return origName}function isHidden(elem,el){return elem=el||elem,"none"===jQuery.css(elem,"display")||!jQuery.contains(elem.ownerDocument,elem)}function showHide(elements,show){for(var display,elem,hidden,values=[],index=0,length=elements.length;index<length;index++)elem=elements[index],elem.style&&(values[index]=jQuery._data(elem,"olddisplay"),display=elem.style.display,show?(values[index]||"none"!==display||(elem.style.display=""),""===elem.style.display&&isHidden(elem)&&(values[index]=jQuery._data(elem,"olddisplay",css_defaultDisplay(elem.nodeName)))):values[index]||(hidden=isHidden(elem),(display&&"none"!==display||!hidden)&&jQuery._data(elem,"olddisplay",hidden?display:jQuery.css(elem,"display"))));for(index=0;index<length;index++)elem=elements[index],elem.style&&(show&&"none"!==elem.style.display&&""!==elem.style.display||(elem.style.display=show?values[index]||"":"none"));return elements}jQuery.fn.extend({css:function(name,value){return jQuery.access(this,function(elem,name,value){var len,styles,map={},i=0;if(jQuery.isArray(name)){for(styles=getStyles(elem),len=name.length;i<len;i++)map[name[i]]=jQuery.css(elem,name[i],!1,styles);return map}return value!==undefined?jQuery.style(elem,name,value):jQuery.css(elem,name)},name,value,arguments.length>1)},show:function(){return showHide(this,!0)},hide:function(){return showHide(this)},toggle:function(state){return"boolean"==typeof state?state?this.show():this.hide():this.each(function(){isHidden(this)?jQuery(this).show():jQuery(this).hide()})}}),jQuery.extend({cssHooks:{opacity:{get:function(elem,computed){if(computed){var ret=curCSS(elem,"opacity");return""===ret?"1":ret}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{float:jQuery.support.cssFloat?"cssFloat":"styleFloat"},style:function(elem,name,value,extra){if(elem&&3!==elem.nodeType&&8!==elem.nodeType&&elem.style){var ret,type,hooks,origName=jQuery.camelCase(name),style=elem.style;if(name=jQuery.cssProps[origName]||(jQuery.cssProps[origName]=vendorPropName(style,origName)),hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName],value===undefined)return hooks&&"get"in hooks&&(ret=hooks.get(elem,!1,extra))!==undefined?ret:style[name];if(!(type=typeof value,"string"===type&&(ret=rrelNum.exec(value))&&(value=(ret[1]+1)*ret[2]+parseFloat(jQuery.css(elem,name)),type="number"),null==value||"number"===type&&isNaN(value)||("number"!==type||jQuery.cssNumber[origName]||(value+="px"),jQuery.support.clearCloneStyle||""!==value||0!==name.indexOf("background")||(style[name]="inherit"),hooks&&"set"in hooks&&(value=hooks.set(elem,value,extra))===undefined)))try{style[name]=value}catch(e){}}},css:function(elem,name,extra,styles){var num,val,hooks,origName=jQuery.camelCase(name);return name=jQuery.cssProps[origName]||(jQuery.cssProps[origName]=vendorPropName(elem.style,origName)),hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName],hooks&&"get"in hooks&&(val=hooks.get(elem,!0,extra)),val===undefined&&(val=curCSS(elem,name,styles)),"normal"===val&&name in cssNormalTransform&&(val=cssNormalTransform[name]),""===extra||extra?(num=parseFloat(val),!0===extra||jQuery.isNumeric(num)?num||0:val):val}}),window.getComputedStyle?(getStyles=function(elem){return window.getComputedStyle(elem,null)},curCSS=function(elem,name,_computed){var width,minWidth,maxWidth,computed=_computed||getStyles(elem),ret=computed?computed.getPropertyValue(name)||computed[name]:undefined,style=elem.style;return computed&&(""!==ret||jQuery.contains(elem.ownerDocument,elem)||(ret=jQuery.style(elem,name)),rnumnonpx.test(ret)&&rmargin.test(name)&&(width=style.width,minWidth=style.minWidth,maxWidth=style.maxWidth,style.minWidth=style.maxWidth=style.width=ret,ret=computed.width,style.width=width,style.minWidth=minWidth,style.maxWidth=maxWidth)),ret}):document.documentElement.currentStyle&&(getStyles=function(elem){return elem.currentStyle},curCSS=function(elem,name,_computed){var left,rs,rsLeft,computed=_computed||getStyles(elem),ret=computed?computed[name]:undefined,style=elem.style;return null==ret&&style&&style[name]&&(ret=style[name]),rnumnonpx.test(ret)&&!rposition.test(name)&&(left=style.left,rs=elem.runtimeStyle,rsLeft=rs&&rs.left,rsLeft&&(rs.left=elem.currentStyle.left),style.left="fontSize"===name?"1em":ret,ret=style.pixelLeft+"px",style.left=left,rsLeft&&(rs.left=rsLeft)),""===ret?"auto":ret});function setPositiveNumber(elem,value,subtract){var matches=rnumsplit.exec(value);return matches?Math.max(0,matches[1]-(subtract||0))+(matches[2]||"px"):value}function augmentWidthOrHeight(elem,name,extra,isBorderBox,styles){for(var i=extra===(isBorderBox?"border":"content")?4:"width"===name?1:0,val=0;i<4;i+=2)"margin"===extra&&(val+=jQuery.css(elem,extra+cssExpand[i],!0,styles)),isBorderBox?("content"===extra&&(val-=jQuery.css(elem,"padding"+cssExpand[i],!0,styles)),"margin"!==extra&&(val-=jQuery.css(elem,"border"+cssExpand[i]+"Width",!0,styles))):(val+=jQuery.css(elem,"padding"+cssExpand[i],!0,styles),"padding"!==extra&&(val+=jQuery.css(elem,"border"+cssExpand[i]+"Width",!0,styles)));return val}function getWidthOrHeight(elem,name,extra){var valueIsBorderBox=!0,val="width"===name?elem.offsetWidth:elem.offsetHeight,styles=getStyles(elem),isBorderBox=jQuery.support.boxSizing&&"border-box"===jQuery.css(elem,"boxSizing",!1,styles);if(val<=0||null==val){if(val=curCSS(elem,name,styles),(val<0||null==val)&&(val=elem.style[name]),rnumnonpx.test(val))return val;valueIsBorderBox=isBorderBox&&(jQuery.support.boxSizingReliable||val===elem.style[name]),val=parseFloat(val)||0}return val+augmentWidthOrHeight(elem,name,extra||(isBorderBox?"border":"content"),valueIsBorderBox,styles)+"px"}function css_defaultDisplay(nodeName){var doc=document,display=elemdisplay[nodeName];return display||(display=actualDisplay(nodeName,doc),"none"!==display&&display||(iframe=(iframe||jQuery("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(doc.documentElement),doc=(iframe[0].contentWindow||iframe[0].contentDocument).document,doc.write("<!doctype html><html><body>"),doc.close(),display=actualDisplay(nodeName,doc),iframe.detach()),elemdisplay[nodeName]=display),display}function actualDisplay(name,doc){var elem=jQuery(doc.createElement(name)).appendTo(doc.body),display=jQuery.css(elem[0],"display");return elem.remove(),display}jQuery.each(["height","width"],function(i,name){jQuery.cssHooks[name]={get:function(elem,computed,extra){if(computed)return 0===elem.offsetWidth&&rdisplayswap.test(jQuery.css(elem,"display"))?jQuery.swap(elem,cssShow,function(){return getWidthOrHeight(elem,name,extra)}):getWidthOrHeight(elem,name,extra)},set:function(elem,value,extra){var styles=extra&&getStyles(elem);return setPositiveNumber(elem,value,extra?augmentWidthOrHeight(elem,name,extra,jQuery.support.boxSizing&&"border-box"===jQuery.css(elem,"boxSizing",!1,styles),styles):0)}}}),jQuery.support.opacity||(jQuery.cssHooks.opacity={get:function(elem,computed){return ropacity.test((computed&&elem.currentStyle?elem.currentStyle.filter:elem.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":computed?"1":""},set:function(elem,value){var style=elem.style,currentStyle=elem.currentStyle,opacity=jQuery.isNumeric(value)?"alpha(opacity="+100*value+")":"",filter=currentStyle&&currentStyle.filter||style.filter||"";style.zoom=1,(value>=1||""===value)&&""===jQuery.trim(filter.replace(ralpha,""))&&style.removeAttribute&&(style.removeAttribute("filter"),""===value||currentStyle&&!currentStyle.filter)||(style.filter=ralpha.test(filter)?filter.replace(ralpha,opacity):filter+" "+opacity)}}),jQuery(function(){jQuery.support.reliableMarginRight||(jQuery.cssHooks.marginRight={get:function(elem,computed){if(computed)return jQuery.swap(elem,{display:"inline-block"},curCSS,[elem,"marginRight"])}}),!jQuery.support.pixelPosition&&jQuery.fn.position&&jQuery.each(["top","left"],function(i,prop){jQuery.cssHooks[prop]={get:function(elem,computed){if(computed)return computed=curCSS(elem,prop),rnumnonpx.test(computed)?jQuery(elem).position()[prop]+"px":computed}}})}),jQuery.expr&&jQuery.expr.filters&&(jQuery.expr.filters.hidden=function(elem){return elem.offsetWidth<=0&&elem.offsetHeight<=0||!jQuery.support.reliableHiddenOffsets&&"none"===(elem.style&&elem.style.display||jQuery.css(elem,"display"))},jQuery.expr.filters.visible=function(elem){return!jQuery.expr.filters.hidden(elem)}),jQuery.each({margin:"",padding:"",border:"Width"},function(prefix,suffix){jQuery.cssHooks[prefix+suffix]={expand:function(value){for(var i=0,expanded={},parts="string"==typeof value?value.split(" "):[value];i<4;i++)expanded[prefix+cssExpand[i]+suffix]=parts[i]||parts[i-2]||parts[0];return expanded}},rmargin.test(prefix)||(jQuery.cssHooks[prefix+suffix].set=setPositiveNumber)});var r20=/%20/g,rbracket=/\[\]$/,rCRLF=/\r?\n/g,rsubmitterTypes=/^(?:submit|button|image|reset|file)$/i,rsubmittable=/^(?:input|select|textarea|keygen)/i;jQuery.fn.extend({serialize:function(){return jQuery.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var elements=jQuery.prop(this,"elements");return elements?jQuery.makeArray(elements):this}).filter(function(){var type=this.type;return this.name&&!jQuery(this).is(":disabled")&&rsubmittable.test(this.nodeName)&&!rsubmitterTypes.test(type)&&(this.checked||!manipulation_rcheckableType.test(type))}).map(function(i,elem){var val=jQuery(this).val();return null==val?null:jQuery.isArray(val)?jQuery.map(val,function(val){return{name:elem.name,value:val.replace(rCRLF,"\r\n")}}):{name:elem.name,value:val.replace(rCRLF,"\r\n")}}).get()}}),jQuery.param=function(a,traditional){var prefix,s=[],add=function(key,value){value=jQuery.isFunction(value)?value():null==value?"":value,s[s.length]=encodeURIComponent(key)+"="+encodeURIComponent(value)};if(traditional===undefined&&(traditional=jQuery.ajaxSettings&&jQuery.ajaxSettings.traditional),jQuery.isArray(a)||a.jquery&&!jQuery.isPlainObject(a))jQuery.each(a,function(){add(this.name,this.value)});else for(prefix in a)buildParams(prefix,a[prefix],traditional,add);return s.join("&").replace(r20,"+")};function buildParams(prefix,obj,traditional,add){var name;if(jQuery.isArray(obj))jQuery.each(obj,function(i,v){traditional||rbracket.test(prefix)?add(prefix,v):buildParams(prefix+"["+("object"==typeof v?i:"")+"]",v,traditional,add)});else if(traditional||"object"!==jQuery.type(obj))add(prefix,obj);else for(name in obj)buildParams(prefix+"["+name+"]",obj[name],traditional,add)}jQuery.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(i,name){jQuery.fn[name]=function(data,fn){return arguments.length>0?this.on(name,null,data,fn):this.trigger(name)}}),jQuery.fn.extend({hover:function(fnOver,fnOut){return this.mouseenter(fnOver).mouseleave(fnOut||fnOver)},bind:function(types,data,fn){return this.on(types,null,data,fn)},unbind:function(types,fn){return this.off(types,null,fn)},delegate:function(selector,types,data,fn){return this.on(types,selector,data,fn)},undelegate:function(selector,types,fn){return 1===arguments.length?this.off(selector,"**"):this.off(types,selector||"**",fn)}});var ajaxLocParts,ajaxLocation,ajax_nonce=jQuery.now(),ajax_rquery=/\?/,rhash=/#.*$/,rts=/([?&])_=[^&]*/,rheaders=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,rlocalProtocol=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,rnoContent=/^(?:GET|HEAD)$/,rprotocol=/^\/\//,rurl=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,_load=jQuery.fn.load,prefilters={},transports={},allTypes="*/".concat("*");try{ajaxLocation=location.href}catch(e){ajaxLocation=document.createElement("a"),ajaxLocation.href="",ajaxLocation=ajaxLocation.href}ajaxLocParts=rurl.exec(ajaxLocation.toLowerCase())||[];function addToPrefiltersOrTransports(structure){return function(dataTypeExpression,func){"string"!=typeof dataTypeExpression&&(func=dataTypeExpression,dataTypeExpression="*");var dataType,i=0,dataTypes=dataTypeExpression.toLowerCase().match(core_rnotwhite)||[];if(jQuery.isFunction(func))for(;dataType=dataTypes[i++];)"+"===dataType[0]?(dataType=dataType.slice(1)||"*",(structure[dataType]=structure[dataType]||[]).unshift(func)):(structure[dataType]=structure[dataType]||[]).push(func)}}function inspectPrefiltersOrTransports(structure,options,originalOptions,jqXHR){var inspected={},seekingTransport=structure===transports;function inspect(dataType){var selected;return inspected[dataType]=!0,jQuery.each(structure[dataType]||[],function(_,prefilterOrFactory){var dataTypeOrTransport=prefilterOrFactory(options,originalOptions,jqXHR);return"string"!=typeof dataTypeOrTransport||seekingTransport||inspected[dataTypeOrTransport]?seekingTransport?!(selected=dataTypeOrTransport):void 0:(options.dataTypes.unshift(dataTypeOrTransport),inspect(dataTypeOrTransport),!1)}),selected}return inspect(options.dataTypes[0])||!inspected["*"]&&inspect("*")}function ajaxExtend(target,src){var deep,key,flatOptions=jQuery.ajaxSettings.flatOptions||{};for(key in src)src[key]!==undefined&&((flatOptions[key]?target:deep||(deep={}))[key]=src[key]);return deep&&jQuery.extend(!0,target,deep),target}jQuery.fn.load=function(url,params,callback){if("string"!=typeof url&&_load)return _load.apply(this,arguments);var selector,response,type,self=this,off=url.indexOf(" ");return off>=0&&(selector=url.slice(off,url.length),url=url.slice(0,off)),jQuery.isFunction(params)?(callback=params,params=undefined):params&&"object"==typeof params&&(type="POST"),self.length>0&&jQuery.ajax({url:url,type:type,dataType:"html",data:params}).done(function(responseText){response=arguments,self.html(selector?jQuery("<div>").append(jQuery.parseHTML(responseText)).find(selector):responseText)}).complete(callback&&function(jqXHR,status){self.each(callback,response||[jqXHR.responseText,status,jqXHR])}),this},jQuery.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(i,type){jQuery.fn[type]=function(fn){return this.on(type,fn)}}),jQuery.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ajaxLocation,type:"GET",isLocal:rlocalProtocol.test(ajaxLocParts[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":allTypes,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":jQuery.parseJSON,"text xml":jQuery.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(target,settings){return settings?ajaxExtend(ajaxExtend(target,jQuery.ajaxSettings),settings):ajaxExtend(jQuery.ajaxSettings,target)},ajaxPrefilter:addToPrefiltersOrTransports(prefilters),ajaxTransport:addToPrefiltersOrTransports(transports),ajax:function(url,options){"object"==typeof url&&(options=url,url=undefined),options=options||{};var parts,i,cacheURL,responseHeadersString,timeoutTimer,fireGlobals,transport,responseHeaders,s=jQuery.ajaxSetup({},options),callbackContext=s.context||s,globalEventContext=s.context&&(callbackContext.nodeType||callbackContext.jquery)?jQuery(callbackContext):jQuery.event,deferred=jQuery.Deferred(),completeDeferred=jQuery.Callbacks("once memory"),statusCode=s.statusCode||{},requestHeaders={},requestHeadersNames={},state=0,strAbort="canceled",jqXHR={readyState:0,getResponseHeader:function(key){var match;if(2===state){if(!responseHeaders)for(responseHeaders={};match=rheaders.exec(responseHeadersString);)responseHeaders[match[1].toLowerCase()]=match[2];match=responseHeaders[key.toLowerCase()]}return null==match?null:match},getAllResponseHeaders:function(){return 2===state?responseHeadersString:null},setRequestHeader:function(name,value){var lname=name.toLowerCase();return state||(name=requestHeadersNames[lname]=requestHeadersNames[lname]||name,requestHeaders[name]=value),this},overrideMimeType:function(type){return state||(s.mimeType=type),this},statusCode:function(map){var code;if(map)if(state<2)for(code in map)statusCode[code]=[statusCode[code],map[code]];else jqXHR.always(map[jqXHR.status]);return this},abort:function(statusText){var finalText=statusText||strAbort;return transport&&transport.abort(finalText),done(0,finalText),this}};if(deferred.promise(jqXHR).complete=completeDeferred.add,jqXHR.success=jqXHR.done,jqXHR.error=jqXHR.fail,s.url=((url||s.url||ajaxLocation)+"").replace(rhash,"").replace(rprotocol,ajaxLocParts[1]+"//"),s.type=options.method||options.type||s.method||s.type,s.dataTypes=jQuery.trim(s.dataType||"*").toLowerCase().match(core_rnotwhite)||[""],null==s.crossDomain&&(parts=rurl.exec(s.url.toLowerCase()),s.crossDomain=!(!parts||parts[1]===ajaxLocParts[1]&&parts[2]===ajaxLocParts[2]&&(parts[3]||("http:"===parts[1]?"80":"443"))===(ajaxLocParts[3]||("http:"===ajaxLocParts[1]?"80":"443")))),s.data&&s.processData&&"string"!=typeof s.data&&(s.data=jQuery.param(s.data,s.traditional)),inspectPrefiltersOrTransports(prefilters,s,options,jqXHR),2===state)return jqXHR;fireGlobals=s.global,fireGlobals&&0==jQuery.active++&&jQuery.event.trigger("ajaxStart"),s.type=s.type.toUpperCase(),s.hasContent=!rnoContent.test(s.type),cacheURL=s.url,s.hasContent||(s.data&&(cacheURL=s.url+=(ajax_rquery.test(cacheURL)?"&":"?")+s.data,delete s.data),!1===s.cache&&(s.url=rts.test(cacheURL)?cacheURL.replace(rts,"$1_="+ajax_nonce++):cacheURL+(ajax_rquery.test(cacheURL)?"&":"?")+"_="+ajax_nonce++)),s.ifModified&&(jQuery.lastModified[cacheURL]&&jqXHR.setRequestHeader("If-Modified-Since",jQuery.lastModified[cacheURL]),jQuery.etag[cacheURL]&&jqXHR.setRequestHeader("If-None-Match",jQuery.etag[cacheURL])),(s.data&&s.hasContent&&!1!==s.contentType||options.contentType)&&jqXHR.setRequestHeader("Content-Type",s.contentType),jqXHR.setRequestHeader("Accept",s.dataTypes[0]&&s.accepts[s.dataTypes[0]]?s.accepts[s.dataTypes[0]]+("*"!==s.dataTypes[0]?", "+allTypes+"; q=0.01":""):s.accepts["*"]);for(i in s.headers)jqXHR.setRequestHeader(i,s.headers[i]);if(s.beforeSend&&(!1===s.beforeSend.call(callbackContext,jqXHR,s)||2===state))return jqXHR.abort();strAbort="abort";for(i in{success:1,error:1,complete:1})jqXHR[i](s[i]);if(transport=inspectPrefiltersOrTransports(transports,s,options,jqXHR)){jqXHR.readyState=1,fireGlobals&&globalEventContext.trigger("ajaxSend",[jqXHR,s]),s.async&&s.timeout>0&&(timeoutTimer=setTimeout(function(){jqXHR.abort("timeout")},s.timeout));try{state=1,transport.send(requestHeaders,done)}catch(e){if(!(state<2))throw e;done(-1,e)}}else done(-1,"No Transport");function done(status,nativeStatusText,responses,headers){var isSuccess,success,error,response,modified,statusText=nativeStatusText;2!==state&&(state=2,timeoutTimer&&clearTimeout(timeoutTimer),transport=undefined,responseHeadersString=headers||"",jqXHR.readyState=status>0?4:0,isSuccess=status>=200&&status<300||304===status,responses&&(response=ajaxHandleResponses(s,jqXHR,responses)),response=ajaxConvert(s,response,jqXHR,isSuccess),isSuccess?(s.ifModified&&(modified=jqXHR.getResponseHeader("Last-Modified"),modified&&(jQuery.lastModified[cacheURL]=modified),(modified=jqXHR.getResponseHeader("etag"))&&(jQuery.etag[cacheURL]=modified)),204===status||"HEAD"===s.type?statusText="nocontent":304===status?statusText="notmodified":(statusText=response.state,success=response.data,error=response.error,isSuccess=!error)):(error=statusText,!status&&statusText||(statusText="error",status<0&&(status=0))),jqXHR.status=status,jqXHR.statusText=(nativeStatusText||statusText)+"",isSuccess?deferred.resolveWith(callbackContext,[success,statusText,jqXHR]):deferred.rejectWith(callbackContext,[jqXHR,statusText,error]),jqXHR.statusCode(statusCode),statusCode=undefined,fireGlobals&&globalEventContext.trigger(isSuccess?"ajaxSuccess":"ajaxError",[jqXHR,s,isSuccess?success:error]),completeDeferred.fireWith(callbackContext,[jqXHR,statusText]),fireGlobals&&(globalEventContext.trigger("ajaxComplete",[jqXHR,s]),--jQuery.active||jQuery.event.trigger("ajaxStop")))}return jqXHR},getJSON:function(url,data,callback){return jQuery.get(url,data,callback,"json")},getScript:function(url,callback){return jQuery.get(url,undefined,callback,"script")}}),jQuery.each(["get","post"],function(i,method){jQuery[method]=function(url,data,callback,type){return jQuery.isFunction(data)&&(type=type||callback,callback=data,data=undefined),jQuery.ajax({url:url,type:method,dataType:type,data:data,success:callback})}});function ajaxHandleResponses(s,jqXHR,responses){for(var firstDataType,ct,finalDataType,type,contents=s.contents,dataTypes=s.dataTypes;"*"===dataTypes[0];)dataTypes.shift(),ct===undefined&&(ct=s.mimeType||jqXHR.getResponseHeader("Content-Type"));if(ct)for(type in contents)if(contents[type]&&contents[type].test(ct)){dataTypes.unshift(type);break}if(dataTypes[0]in responses)finalDataType=dataTypes[0];else{for(type in responses){if(!dataTypes[0]||s.converters[type+" "+dataTypes[0]]){finalDataType=type;break}firstDataType||(firstDataType=type)}finalDataType=finalDataType||firstDataType}if(finalDataType)return finalDataType!==dataTypes[0]&&dataTypes.unshift(finalDataType),responses[finalDataType]}function ajaxConvert(s,response,jqXHR,isSuccess){var conv2,current,conv,tmp,prev,converters={},dataTypes=s.dataTypes.slice();if(dataTypes[1])for(conv in s.converters)converters[conv.toLowerCase()]=s.converters[conv];for(current=dataTypes.shift();current;)if(s.responseFields[current]&&(jqXHR[s.responseFields[current]]=response),!prev&&isSuccess&&s.dataFilter&&(response=s.dataFilter(response,s.dataType)),prev=current,current=dataTypes.shift())if("*"===current)current=prev;else if("*"!==prev&&prev!==current){if(!(conv=converters[prev+" "+current]||converters["* "+current]))for(conv2 in converters)if(tmp=conv2.split(" "),tmp[1]===current&&(conv=converters[prev+" "+tmp[0]]||converters["* "+tmp[0]])){!0===conv?conv=converters[conv2]:!0!==converters[conv2]&&(current=tmp[0],dataTypes.unshift(tmp[1]));break}if(!0!==conv)if(conv&&s.throws)response=conv(response);else try{response=conv(response)}catch(e){return{state:"parsererror",error:conv?e:"No conversion from "+prev+" to "+current}}}return{state:"success",data:response}}jQuery.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(text){return jQuery.globalEval(text),text}}}),jQuery.ajaxPrefilter("script",function(s){s.cache===undefined&&(s.cache=!1),s.crossDomain&&(s.type="GET",s.global=!1)}),jQuery.ajaxTransport("script",function(s){if(s.crossDomain){var script,head=document.head||jQuery("head")[0]||document.documentElement;return{send:function(_,callback){script=document.createElement("script"),script.async=!0,s.scriptCharset&&(script.charset=s.scriptCharset),script.src=s.url,script.onload=script.onreadystatechange=function(_,isAbort){(isAbort||!script.readyState||/loaded|complete/.test(script.readyState))&&(script.onload=script.onreadystatechange=null,script.parentNode&&script.parentNode.removeChild(script),script=null,isAbort||callback(200,"success"))},head.insertBefore(script,head.firstChild)},abort:function(){script&&script.onload(undefined,!0)}}}});var oldCallbacks=[],rjsonp=/(=)\?(?=&|$)|\?\?/;jQuery.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var callback=oldCallbacks.pop()||jQuery.expando+"_"+ajax_nonce++;return this[callback]=!0,callback}}),jQuery.ajaxPrefilter("json jsonp",function(s,originalSettings,jqXHR){var callbackName,overwritten,responseContainer,jsonProp=!1!==s.jsonp&&(rjsonp.test(s.url)?"url":"string"==typeof s.data&&!(s.contentType||"").indexOf("application/x-www-form-urlencoded")&&rjsonp.test(s.data)&&"data");if(jsonProp||"jsonp"===s.dataTypes[0])return callbackName=s.jsonpCallback=jQuery.isFunction(s.jsonpCallback)?s.jsonpCallback():s.jsonpCallback,jsonProp?s[jsonProp]=s[jsonProp].replace(rjsonp,"$1"+callbackName):!1!==s.jsonp&&(s.url+=(ajax_rquery.test(s.url)?"&":"?")+s.jsonp+"="+callbackName),s.converters["script json"]=function(){return responseContainer||jQuery.error(callbackName+" was not called"),responseContainer[0]},s.dataTypes[0]="json",overwritten=window[callbackName],window[callbackName]=function(){responseContainer=arguments},jqXHR.always(function(){window[callbackName]=overwritten,s[callbackName]&&(s.jsonpCallback=originalSettings.jsonpCallback,oldCallbacks.push(callbackName)),responseContainer&&jQuery.isFunction(overwritten)&&overwritten(responseContainer[0]),responseContainer=overwritten=undefined}),"script"});var xhrCallbacks,xhrSupported,xhrId=0,xhrOnUnloadAbort=window.ActiveXObject&&function(){var key;for(key in xhrCallbacks)xhrCallbacks[key](undefined,!0)};function createStandardXHR(){try{return new window.XMLHttpRequest}catch(e){}}function createActiveXHR(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}jQuery.ajaxSettings.xhr=window.ActiveXObject?function(){return!this.isLocal&&createStandardXHR()||createActiveXHR()}:createStandardXHR,xhrSupported=jQuery.ajaxSettings.xhr(),jQuery.support.cors=!!xhrSupported&&"withCredentials"in xhrSupported,(xhrSupported=jQuery.support.ajax=!!xhrSupported)&&jQuery.ajaxTransport(function(s){if(!s.crossDomain||jQuery.support.cors){var callback;return{send:function(headers,complete){var handle,i,xhr=s.xhr();if(s.username?xhr.open(s.type,s.url,s.async,s.username,s.password):xhr.open(s.type,s.url,s.async),s.xhrFields)for(i in s.xhrFields)xhr[i]=s.xhrFields[i];s.mimeType&&xhr.overrideMimeType&&xhr.overrideMimeType(s.mimeType),s.crossDomain||headers["X-Requested-With"]||(headers["X-Requested-With"]="XMLHttpRequest");try{for(i in headers)xhr.setRequestHeader(i,headers[i])}catch(err){}xhr.send(s.hasContent&&s.data||null),callback=function(_,isAbort){var status,responseHeaders,statusText,responses;try{if(callback&&(isAbort||4===xhr.readyState))if(callback=undefined,handle&&(xhr.onreadystatechange=jQuery.noop,xhrOnUnloadAbort&&delete xhrCallbacks[handle]),isAbort)4!==xhr.readyState&&xhr.abort();else{responses={},status=xhr.status,responseHeaders=xhr.getAllResponseHeaders(),"string"==typeof xhr.responseText&&(responses.text=xhr.responseText);try{statusText=xhr.statusText}catch(e){statusText=""}status||!s.isLocal||s.crossDomain?1223===status&&(status=204):status=responses.text?200:404}}catch(firefoxAccessException){isAbort||complete(-1,firefoxAccessException)}responses&&complete(status,statusText,responses,responseHeaders)},s.async?4===xhr.readyState?setTimeout(callback):(handle=++xhrId,xhrOnUnloadAbort&&(xhrCallbacks||(xhrCallbacks={},jQuery(window).unload(xhrOnUnloadAbort)),xhrCallbacks[handle]=callback),xhr.onreadystatechange=callback):callback()},abort:function(){callback&&callback(undefined,!0)}}}});var fxNow,timerId,rfxtypes=/^(?:toggle|show|hide)$/,rfxnum=new RegExp("^(?:([+-])=|)("+core_pnum+")([a-z%]*)$","i"),rrun=/queueHooks$/,animationPrefilters=[defaultPrefilter],tweeners={"*":[function(prop,value){var tween=this.createTween(prop,value),target=tween.cur(),parts=rfxnum.exec(value),unit=parts&&parts[3]||(jQuery.cssNumber[prop]?"":"px"),start=(jQuery.cssNumber[prop]||"px"!==unit&&+target)&&rfxnum.exec(jQuery.css(tween.elem,prop)),scale=1,maxIterations=20;if(start&&start[3]!==unit){unit=unit||start[3],parts=parts||[],start=+target||1;do{scale=scale||".5",start/=scale,jQuery.style(tween.elem,prop,start+unit)}while(scale!==(scale=tween.cur()/target)&&1!==scale&&--maxIterations)}return parts&&(start=tween.start=+start||+target||0,tween.unit=unit,tween.end=parts[1]?start+(parts[1]+1)*parts[2]:+parts[2]),tween}]};function createFxNow(){return setTimeout(function(){fxNow=undefined}),fxNow=jQuery.now()}function createTween(value,prop,animation){for(var tween,collection=(tweeners[prop]||[]).concat(tweeners["*"]),index=0,length=collection.length;index<length;index++)if(tween=collection[index].call(animation,prop,value))return tween}function Animation(elem,properties,options){var result,stopped,index=0,length=animationPrefilters.length,deferred=jQuery.Deferred().always(function(){delete tick.elem}),tick=function(){if(stopped)return!1;for(var currentTime=fxNow||createFxNow(),remaining=Math.max(0,animation.startTime+animation.duration-currentTime),temp=remaining/animation.duration||0,percent=1-temp,index=0,length=animation.tweens.length;index<length;index++)animation.tweens[index].run(percent);return deferred.notifyWith(elem,[animation,percent,remaining]),percent<1&&length?remaining:(deferred.resolveWith(elem,[animation]),!1)},animation=deferred.promise({elem:elem,props:jQuery.extend({},properties),opts:jQuery.extend(!0,{specialEasing:{}},options),originalProperties:properties,originalOptions:options,startTime:fxNow||createFxNow(),duration:options.duration,tweens:[],createTween:function(prop,end){var tween=jQuery.Tween(elem,animation.opts,prop,end,animation.opts.specialEasing[prop]||animation.opts.easing);return animation.tweens.push(tween),tween},stop:function(gotoEnd){var index=0,length=gotoEnd?animation.tweens.length:0;if(stopped)return this;for(stopped=!0;index<length;index++)animation.tweens[index].run(1);return gotoEnd?deferred.resolveWith(elem,[animation,gotoEnd]):deferred.rejectWith(elem,[animation,gotoEnd]),this}}),props=animation.props;for(propFilter(props,animation.opts.specialEasing);index<length;index++)if(result=animationPrefilters[index].call(animation,elem,props,animation.opts))return result;return jQuery.map(props,createTween,animation),jQuery.isFunction(animation.opts.start)&&animation.opts.start.call(elem,animation),jQuery.fx.timer(jQuery.extend(tick,{elem:elem,anim:animation,queue:animation.opts.queue})),animation.progress(animation.opts.progress).done(animation.opts.done,animation.opts.complete).fail(animation.opts.fail).always(animation.opts.always)}function propFilter(props,specialEasing){var index,name,easing,value,hooks;for(index in props)if(name=jQuery.camelCase(index),easing=specialEasing[name],value=props[index],jQuery.isArray(value)&&(easing=value[1],value=props[index]=value[0]),index!==name&&(props[name]=value,delete props[index]),(hooks=jQuery.cssHooks[name])&&"expand"in hooks){value=hooks.expand(value),delete props[name];for(index in value)index in props||(props[index]=value[index],specialEasing[index]=easing)}else specialEasing[name]=easing}jQuery.Animation=jQuery.extend(Animation,{tweener:function(props,callback){jQuery.isFunction(props)?(callback=props,props=["*"]):props=props.split(" ");for(var prop,index=0,length=props.length;index<length;index++)prop=props[index],tweeners[prop]=tweeners[prop]||[],tweeners[prop].unshift(callback)},prefilter:function(callback,prepend){prepend?animationPrefilters.unshift(callback):animationPrefilters.push(callback)}});function defaultPrefilter(elem,props,opts){
var prop,value,toggle,tween,hooks,oldfire,anim=this,orig={},style=elem.style,hidden=elem.nodeType&&isHidden(elem),dataShow=jQuery._data(elem,"fxshow");opts.queue||(hooks=jQuery._queueHooks(elem,"fx"),null==hooks.unqueued&&(hooks.unqueued=0,oldfire=hooks.empty.fire,hooks.empty.fire=function(){hooks.unqueued||oldfire()}),hooks.unqueued++,anim.always(function(){anim.always(function(){hooks.unqueued--,jQuery.queue(elem,"fx").length||hooks.empty.fire()})})),1===elem.nodeType&&("height"in props||"width"in props)&&(opts.overflow=[style.overflow,style.overflowX,style.overflowY],"inline"===jQuery.css(elem,"display")&&"none"===jQuery.css(elem,"float")&&(jQuery.support.inlineBlockNeedsLayout&&"inline"!==css_defaultDisplay(elem.nodeName)?style.zoom=1:style.display="inline-block")),opts.overflow&&(style.overflow="hidden",jQuery.support.shrinkWrapBlocks||anim.always(function(){style.overflow=opts.overflow[0],style.overflowX=opts.overflow[1],style.overflowY=opts.overflow[2]}));for(prop in props)if(value=props[prop],rfxtypes.exec(value)){if(delete props[prop],toggle=toggle||"toggle"===value,value===(hidden?"hide":"show"))continue;orig[prop]=dataShow&&dataShow[prop]||jQuery.style(elem,prop)}if(!jQuery.isEmptyObject(orig)){dataShow?"hidden"in dataShow&&(hidden=dataShow.hidden):dataShow=jQuery._data(elem,"fxshow",{}),toggle&&(dataShow.hidden=!hidden),hidden?jQuery(elem).show():anim.done(function(){jQuery(elem).hide()}),anim.done(function(){var prop;jQuery._removeData(elem,"fxshow");for(prop in orig)jQuery.style(elem,prop,orig[prop])});for(prop in orig)tween=createTween(hidden?dataShow[prop]:0,prop,anim),prop in dataShow||(dataShow[prop]=tween.start,hidden&&(tween.end=tween.start,tween.start="width"===prop||"height"===prop?1:0))}}function Tween(elem,options,prop,end,easing){return new Tween.prototype.init(elem,options,prop,end,easing)}jQuery.Tween=Tween,Tween.prototype={constructor:Tween,init:function(elem,options,prop,end,easing,unit){this.elem=elem,this.prop=prop,this.easing=easing||"swing",this.options=options,this.start=this.now=this.cur(),this.end=end,this.unit=unit||(jQuery.cssNumber[prop]?"":"px")},cur:function(){var hooks=Tween.propHooks[this.prop];return hooks&&hooks.get?hooks.get(this):Tween.propHooks._default.get(this)},run:function(percent){var eased,hooks=Tween.propHooks[this.prop];return this.options.duration?this.pos=eased=jQuery.easing[this.easing](percent,this.options.duration*percent,0,1,this.options.duration):this.pos=eased=percent,this.now=(this.end-this.start)*eased+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),hooks&&hooks.set?hooks.set(this):Tween.propHooks._default.set(this),this}},Tween.prototype.init.prototype=Tween.prototype,Tween.propHooks={_default:{get:function(tween){var result;return null==tween.elem[tween.prop]||tween.elem.style&&null!=tween.elem.style[tween.prop]?(result=jQuery.css(tween.elem,tween.prop,""),result&&"auto"!==result?result:0):tween.elem[tween.prop]},set:function(tween){jQuery.fx.step[tween.prop]?jQuery.fx.step[tween.prop](tween):tween.elem.style&&(null!=tween.elem.style[jQuery.cssProps[tween.prop]]||jQuery.cssHooks[tween.prop])?jQuery.style(tween.elem,tween.prop,tween.now+tween.unit):tween.elem[tween.prop]=tween.now}}},Tween.propHooks.scrollTop=Tween.propHooks.scrollLeft={set:function(tween){tween.elem.nodeType&&tween.elem.parentNode&&(tween.elem[tween.prop]=tween.now)}},jQuery.each(["toggle","show","hide"],function(i,name){var cssFn=jQuery.fn[name];jQuery.fn[name]=function(speed,easing,callback){return null==speed||"boolean"==typeof speed?cssFn.apply(this,arguments):this.animate(genFx(name,!0),speed,easing,callback)}}),jQuery.fn.extend({fadeTo:function(speed,to,easing,callback){return this.filter(isHidden).css("opacity",0).show().end().animate({opacity:to},speed,easing,callback)},animate:function(prop,speed,easing,callback){var empty=jQuery.isEmptyObject(prop),optall=jQuery.speed(speed,easing,callback),doAnimation=function(){var anim=Animation(this,jQuery.extend({},prop),optall);(empty||jQuery._data(this,"finish"))&&anim.stop(!0)};return doAnimation.finish=doAnimation,empty||!1===optall.queue?this.each(doAnimation):this.queue(optall.queue,doAnimation)},stop:function(type,clearQueue,gotoEnd){var stopQueue=function(hooks){var stop=hooks.stop;delete hooks.stop,stop(gotoEnd)};return"string"!=typeof type&&(gotoEnd=clearQueue,clearQueue=type,type=undefined),clearQueue&&!1!==type&&this.queue(type||"fx",[]),this.each(function(){var dequeue=!0,index=null!=type&&type+"queueHooks",timers=jQuery.timers,data=jQuery._data(this);if(index)data[index]&&data[index].stop&&stopQueue(data[index]);else for(index in data)data[index]&&data[index].stop&&rrun.test(index)&&stopQueue(data[index]);for(index=timers.length;index--;)timers[index].elem!==this||null!=type&&timers[index].queue!==type||(timers[index].anim.stop(gotoEnd),dequeue=!1,timers.splice(index,1));!dequeue&&gotoEnd||jQuery.dequeue(this,type)})},finish:function(type){return!1!==type&&(type=type||"fx"),this.each(function(){var index,data=jQuery._data(this),queue=data[type+"queue"],hooks=data[type+"queueHooks"],timers=jQuery.timers,length=queue?queue.length:0;for(data.finish=!0,jQuery.queue(this,type,[]),hooks&&hooks.stop&&hooks.stop.call(this,!0),index=timers.length;index--;)timers[index].elem===this&&timers[index].queue===type&&(timers[index].anim.stop(!0),timers.splice(index,1));for(index=0;index<length;index++)queue[index]&&queue[index].finish&&queue[index].finish.call(this);delete data.finish})}});function genFx(type,includeWidth){var which,attrs={height:type},i=0;for(includeWidth=includeWidth?1:0;i<4;i+=2-includeWidth)which=cssExpand[i],attrs["margin"+which]=attrs["padding"+which]=type;return includeWidth&&(attrs.opacity=attrs.width=type),attrs}jQuery.each({slideDown:genFx("show"),slideUp:genFx("hide"),slideToggle:genFx("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(name,props){jQuery.fn[name]=function(speed,easing,callback){return this.animate(props,speed,easing,callback)}}),jQuery.speed=function(speed,easing,fn){var opt=speed&&"object"==typeof speed?jQuery.extend({},speed):{complete:fn||!fn&&easing||jQuery.isFunction(speed)&&speed,duration:speed,easing:fn&&easing||easing&&!jQuery.isFunction(easing)&&easing};return opt.duration=jQuery.fx.off?0:"number"==typeof opt.duration?opt.duration:opt.duration in jQuery.fx.speeds?jQuery.fx.speeds[opt.duration]:jQuery.fx.speeds._default,null!=opt.queue&&!0!==opt.queue||(opt.queue="fx"),opt.old=opt.complete,opt.complete=function(){jQuery.isFunction(opt.old)&&opt.old.call(this),opt.queue&&jQuery.dequeue(this,opt.queue)},opt},jQuery.easing={linear:function(p){return p},swing:function(p){return.5-Math.cos(p*Math.PI)/2}},jQuery.timers=[],jQuery.fx=Tween.prototype.init,jQuery.fx.tick=function(){var timer,timers=jQuery.timers,i=0;for(fxNow=jQuery.now();i<timers.length;i++)(timer=timers[i])()||timers[i]!==timer||timers.splice(i--,1);timers.length||jQuery.fx.stop(),fxNow=undefined},jQuery.fx.timer=function(timer){timer()&&jQuery.timers.push(timer)&&jQuery.fx.start()},jQuery.fx.interval=13,jQuery.fx.start=function(){timerId||(timerId=setInterval(jQuery.fx.tick,jQuery.fx.interval))},jQuery.fx.stop=function(){clearInterval(timerId),timerId=null},jQuery.fx.speeds={slow:600,fast:200,_default:400},jQuery.fx.step={},jQuery.expr&&jQuery.expr.filters&&(jQuery.expr.filters.animated=function(elem){return jQuery.grep(jQuery.timers,function(fn){return elem===fn.elem}).length}),jQuery.fn.offset=function(options){if(arguments.length)return options===undefined?this:this.each(function(i){jQuery.offset.setOffset(this,options,i)});var docElem,win,box={top:0,left:0},elem=this[0],doc=elem&&elem.ownerDocument;if(doc)return docElem=doc.documentElement,jQuery.contains(docElem,elem)?(typeof elem.getBoundingClientRect!==core_strundefined&&(box=elem.getBoundingClientRect()),win=getWindow(doc),{top:box.top+(win.pageYOffset||docElem.scrollTop)-(docElem.clientTop||0),left:box.left+(win.pageXOffset||docElem.scrollLeft)-(docElem.clientLeft||0)}):box},jQuery.offset={setOffset:function(elem,options,i){var position=jQuery.css(elem,"position");"static"===position&&(elem.style.position="relative");var curTop,curLeft,curElem=jQuery(elem),curOffset=curElem.offset(),curCSSTop=jQuery.css(elem,"top"),curCSSLeft=jQuery.css(elem,"left"),calculatePosition=("absolute"===position||"fixed"===position)&&jQuery.inArray("auto",[curCSSTop,curCSSLeft])>-1,props={},curPosition={};calculatePosition?(curPosition=curElem.position(),curTop=curPosition.top,curLeft=curPosition.left):(curTop=parseFloat(curCSSTop)||0,curLeft=parseFloat(curCSSLeft)||0),jQuery.isFunction(options)&&(options=options.call(elem,i,curOffset)),null!=options.top&&(props.top=options.top-curOffset.top+curTop),null!=options.left&&(props.left=options.left-curOffset.left+curLeft),"using"in options?options.using.call(elem,props):curElem.css(props)}},jQuery.fn.extend({position:function(){if(this[0]){var offsetParent,offset,parentOffset={top:0,left:0},elem=this[0];return"fixed"===jQuery.css(elem,"position")?offset=elem.getBoundingClientRect():(offsetParent=this.offsetParent(),offset=this.offset(),jQuery.nodeName(offsetParent[0],"html")||(parentOffset=offsetParent.offset()),parentOffset.top+=jQuery.css(offsetParent[0],"borderTopWidth",!0),parentOffset.left+=jQuery.css(offsetParent[0],"borderLeftWidth",!0)),{top:offset.top-parentOffset.top-jQuery.css(elem,"marginTop",!0),left:offset.left-parentOffset.left-jQuery.css(elem,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var offsetParent=this.offsetParent||docElem;offsetParent&&!jQuery.nodeName(offsetParent,"html")&&"static"===jQuery.css(offsetParent,"position");)offsetParent=offsetParent.offsetParent;return offsetParent||docElem})}}),jQuery.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(method,prop){var top=/Y/.test(prop);jQuery.fn[method]=function(val){return jQuery.access(this,function(elem,method,val){var win=getWindow(elem);if(val===undefined)return win?prop in win?win[prop]:win.document.documentElement[method]:elem[method];win?win.scrollTo(top?jQuery(win).scrollLeft():val,top?val:jQuery(win).scrollTop()):elem[method]=val},method,val,arguments.length,null)}});function getWindow(elem){return jQuery.isWindow(elem)?elem:9===elem.nodeType&&(elem.defaultView||elem.parentWindow)}jQuery.each({Height:"height",Width:"width"},function(name,type){jQuery.each({padding:"inner"+name,content:type,"":"outer"+name},function(defaultExtra,funcName){jQuery.fn[funcName]=function(margin,value){var chainable=arguments.length&&(defaultExtra||"boolean"!=typeof margin),extra=defaultExtra||(!0===margin||!0===value?"margin":"border");return jQuery.access(this,function(elem,type,value){var doc;return jQuery.isWindow(elem)?elem.document.documentElement["client"+name]:9===elem.nodeType?(doc=elem.documentElement,Math.max(elem.body["scroll"+name],doc["scroll"+name],elem.body["offset"+name],doc["offset"+name],doc["client"+name])):value===undefined?jQuery.css(elem,type,extra):jQuery.style(elem,type,value,extra)},type,chainable?margin:undefined,chainable,null)}})}),jQuery.fn.size=function(){return this.length},jQuery.fn.andSelf=jQuery.fn.addBack,"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=jQuery:(window.jQuery=window.$=jQuery,"function"==typeof define&&define.amd&&define("jquery",[],function(){return jQuery}))}(window),function(a){var h,i,b="0.3.4",c="hasOwnProperty",d=/[\.\/]/,f=function(){},g=function(a,b){return a-b},j={n:{}},k=function(a,b){var n,d=i,e=Array.prototype.slice.call(arguments,2),f=k.listeners(a),l=0,o=[],p={},q=[],r=h;h=a,i=0;for(var t=0,u=f.length;t<u;t++)"zIndex"in f[t]&&(o.push(f[t].zIndex),f[t].zIndex<0&&(p[f[t].zIndex]=f[t]));for(o.sort(g);o[l]<0;)if(n=p[o[l++]],q.push(n.apply(b,e)),i)return i=d,q;for(t=0;t<u;t++)if("zIndex"in(n=f[t]))if(n.zIndex==o[l]){if(q.push(n.apply(b,e)),i)break;do{if(l++,(n=p[o[l]])&&q.push(n.apply(b,e)),i)break}while(n)}else p[n.zIndex]=n;else if(q.push(n.apply(b,e)),i)break;return i=d,h=r,q.length?q:null};k.listeners=function(a){var f,g,h,i,k,l,m,n,b=a.split(d),c=j,o=[c],p=[];for(i=0,k=b.length;i<k;i++){for(n=[],l=0,m=o.length;l<m;l++)for(c=o[l].n,g=[c[b[i]],c["*"]],h=2;h--;)(f=g[h])&&(n.push(f),p=p.concat(f.f||[]));o=n}return p},k.on=function(a,b){for(var c=a.split(d),e=j,g=0,h=c.length;g<h;g++)e=e.n,!e[c[g]]&&(e[c[g]]={n:{}}),e=e[c[g]];for(e.f=e.f||[],g=0,h=e.f.length;g<h;g++)if(e.f[g]==b)return f;return e.f.push(b),function(a){+a==+a&&(b.zIndex=+a)}},k.stop=function(){i=1},k.nt=function(a){return a?new RegExp("(?:\\.|\\/|^)"+a+"(?:\\.|\\/|$)").test(h):h},k.off=k.unbind=function(a,b){var g,h,i,k,l,m,n,f=a.split(d),o=[j];for(k=0,l=f.length;k<l;k++)for(m=0;m<o.length;m+=i.length-2){if(i=[m,1],g=o[m].n,"*"!=f[k])g[f[k]]&&i.push(g[f[k]]);else for(h in g)g[c](h)&&i.push(g[h]);o.splice.apply(o,i)}for(k=0,l=o.length;k<l;k++)for(g=o[k];g.n;){if(b){if(g.f){for(m=0,n=g.f.length;m<n;m++)if(g.f[m]==b){g.f.splice(m,1);break}!g.f.length&&delete g.f}for(h in g.n)if(g.n[c](h)&&g.n[h].f){var p=g.n[h].f;for(m=0,n=p.length;m<n;m++)if(p[m]==b){p.splice(m,1);break}!p.length&&delete g.n[h].f}}else{delete g.f;for(h in g.n)g.n[c](h)&&g.n[h].f&&delete g.n[h].f}g=g.n}},k.once=function(a,b){var c=function(){var d=b.apply(this,arguments);return k.unbind(a,c),d};return k.on(a,c)},k.version=b,k.toString=function(){return"You are running Eve "+b},"undefined"!=typeof module&&module.exports?module.exports=k:"undefined"!=typeof define?define("eve",[],function(){return k}):a.eve=k}(this),function(){function cF(a){for(var b=0;b<cy.length;b++)cy[b].el.paper==a&&cy.splice(b--,1)}function cE(b,d,e,f,h,i){e=Q(e);var j,k,l,o,p,q,t=b.ms,u={},v={},w={};if(f)for(y=0,z=cy.length;y<z;y++){var x=cy[y];if(x.el.id==d.id&&x.anim==b){x.percent!=e?(cy.splice(y,1),l=1):k=x,d.attr(x.totalOrigin);break}}else f=+v;for(var y=0,z=b.percents.length;y<z;y++){if(b.percents[y]==e||b.percents[y]>f*b.top){e=b.percents[y],p=b.percents[y-1]||0,t=t/b.top*(e-p),o=b.percents[y+1],j=b.anim[e];break}f&&d.attr(b.anim[b.percents[y]])}if(j){if(k)k.initstatus=f,k.start=new Date-k.ms*f;else{for(var A in j)if(j[g](A)&&(U[g](A)||d.paper.customAttributes[g](A)))switch(u[A]=d.attr(A),null==u[A]&&(u[A]=T[A]),v[A]=j[A],U[A]){case C:w[A]=(v[A]-u[A])/t;break;case"colour":u[A]=a.getRGB(u[A]);var B=a.getRGB(v[A]);w[A]={r:(B.r-u[A].r)/t,g:(B.g-u[A].g)/t,b:(B.b-u[A].b)/t};break;case"path":var D=bR(u[A],v[A]),E=D[1];for(u[A]=D[0],w[A]=[],y=0,z=u[A].length;y<z;y++){w[A][y]=[0];for(var F=1,G=u[A][y].length;F<G;F++)w[A][y][F]=(E[y][F]-u[A][y][F])/t}break;case"transform":var H=d._,I=ca(H[A],v[A]);if(I)for(u[A]=I.from,v[A]=I.to,w[A]=[],w[A].real=!0,y=0,z=u[A].length;y<z;y++)for(w[A][y]=[u[A][y][0]],F=1,G=u[A][y].length;F<G;F++)w[A][y][F]=(v[A][y][F]-u[A][y][F])/t;else{var J=d.matrix||new cb,K={_:{transform:H.transform},getBBox:function(){return d.getBBox(1)}};u[A]=[J.a,J.b,J.c,J.d,J.e,J.f],b$(K,v[A]),v[A]=K._.transform,w[A]=[(K.matrix.a-J.a)/t,(K.matrix.b-J.b)/t,(K.matrix.c-J.c)/t,(K.matrix.d-J.d)/t,(K.matrix.e-J.e)/t,(K.matrix.f-J.f)/t]}break;case"csv":var L=r(j[A])[s](c),M=r(u[A])[s](c);if("clip-rect"==A)for(u[A]=M,w[A]=[],y=M.length;y--;)w[A][y]=(L[y]-u[A][y])/t;v[A]=L;break;default:for(L=[][n](j[A]),M=[][n](u[A]),w[A]=[],y=d.paper.customAttributes[A].length;y--;)w[A][y]=((L[y]||0)-(M[y]||0))/t}var O=j.easing,P=a.easing_formulas[O];if(!P)if((P=r(O).match(N))&&5==P.length){var R=P;P=function(a){return cC(a,+R[1],+R[2],+R[3],+R[4],t)}}else P=bf;if(q=j.start||b.start||+new Date,x={anim:b,percent:e,timestamp:q,start:q+(b.del||0),status:0,initstatus:f||0,stop:!1,ms:t,easing:P,from:u,diff:w,to:v,el:d,callback:j.callback,prev:p,next:o,repeat:i||b.times,origin:d.attr(),totalOrigin:h},cy.push(x),f&&!k&&!l&&(x.stop=!0,x.start=new Date-t*f,1==cy.length))return cA();l&&(x.start=new Date-x.ms*f),1==cy.length&&cz(cA)}eve("raphael.anim.start."+d.id,d,b)}}function cD(a,b){var c=[],d={};if(this.ms=b,this.times=1,a){for(var e in a)a[g](e)&&(d[Q(e)]=a[e],c.push(Q(e)));c.sort(bd)}this.anim=d,this.top=c[c.length-1],this.percents=c}function cC(a,b,c,d,e,f){function o(a,b){var c,d,e,f,j,k;for(e=a,k=0;k<8;k++){if(f=m(e)-a,z(f)<b)return e;if(j=(3*i*e+2*h)*e+g,z(j)<1e-6)break;e-=f/j}if(c=0,d=1,e=a,e<c)return c;if(e>d)return d;for(;c<d;){if(f=m(e),z(f-a)<b)return e;a>f?c=e:d=e,e=(d-c)/2+c}return e}function m(a){return((i*a+h)*a+g)*a}var g=3*b,h=3*(d-b)-g,i=1-g-h,j=3*c,k=3*(e-c)-j,l=1-j-k;return function(a,b){var c=o(a,b);return((l*c+k)*c+j)*c}(a,1/(200*f))}function cq(){return this.x+q+this.y+q+this.width+" Ã "+this.height}function cb(a,b,c,d,e,f){null!=a?(this.a=+a,this.b=+b,this.c=+c,this.d=+d,this.e=+e,this.f=+f):(this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0)}function bH(b,c,d){b=a._path2curve(b),c=a._path2curve(c);for(var e,f,g,h,i,j,k,l,m,n,o=d?0:[],p=0,q=b.length;p<q;p++){var r=b[p];if("M"==r[0])e=i=r[1],f=j=r[2];else{"C"==r[0]?(m=[e,f].concat(r.slice(1)),e=m[6],f=m[7]):(m=[e,f,e,f,i,j,i,j],e=i,f=j);for(var s=0,t=c.length;s<t;s++){var u=c[s];if("M"==u[0])g=k=u[1],h=l=u[2];else{"C"==u[0]?(n=[g,h].concat(u.slice(1)),g=n[6],h=n[7]):(n=[g,h,g,h,k,l,k,l],g=k,h=l);var v=bG(m,n,d);if(d)o+=v;else{for(var w=0,x=v.length;w<x;w++)v[w].segment1=p,v[w].segment2=s,v[w].bez1=m,v[w].bez2=n;o=o.concat(v)}}}}}return o}function bG(b,c,d){var e=a.bezierBBox(b),f=a.bezierBBox(c);if(!a.isBBoxIntersect(e,f))return d?0:[];for(var g=bB.apply(0,b),h=bB.apply(0,c),i=~~(g/5),j=~~(h/5),k=[],l=[],m={},n=d?0:[],o=0;o<i+1;o++){var p=a.findDotsAtSegment.apply(a,b.concat(o/i));k.push({x:p.x,y:p.y,t:o/i})}for(o=0;o<j+1;o++)p=a.findDotsAtSegment.apply(a,c.concat(o/j)),l.push({x:p.x,y:p.y,t:o/j});for(o=0;o<i;o++)for(var q=0;q<j;q++){var r=k[o],s=k[o+1],t=l[q],u=l[q+1],v=z(s.x-r.x)<.001?"y":"x",w=z(u.x-t.x)<.001?"y":"x",x=bD(r.x,r.y,s.x,s.y,t.x,t.y,u.x,u.y);if(x){if(m[x.x.toFixed(4)]==x.y.toFixed(4))continue;m[x.x.toFixed(4)]=x.y.toFixed(4);var y=r.t+z((x[v]-r[v])/(s[v]-r[v]))*(s.t-r.t),A=t.t+z((x[w]-t[w])/(u[w]-t[w]))*(u.t-t.t);y>=0&&y<=1&&A>=0&&A<=1&&(d?n++:n.push({x:x.x,y:x.y,t1:y,t2:A}))}}return n}function bD(a,b,c,d,e,f,g,h){if(!(x(a,c)<y(e,g)||y(a,c)>x(e,g)||x(b,d)<y(f,h)||y(b,d)>x(f,h))){var i=(a*d-b*c)*(e-g)-(a-c)*(e*h-f*g),j=(a*d-b*c)*(f-h)-(b-d)*(e*h-f*g),k=(a-c)*(f-h)-(b-d)*(e-g);if(!k)return;var l=i/k,m=j/k,n=+l.toFixed(2),o=+m.toFixed(2);if(n<+y(a,c).toFixed(2)||n>+x(a,c).toFixed(2)||n<+y(e,g).toFixed(2)||n>+x(e,g).toFixed(2)||o<+y(b,d).toFixed(2)||o>+x(b,d).toFixed(2)||o<+y(f,h).toFixed(2)||o>+x(f,h).toFixed(2))return;return{x:l,y:m}}}function bC(a,b,c,d,e,f,g,h,i){if(!(i<0||bB(a,b,c,d,e,f,g,h)<i)){var m,k=.5,l=1-k;for(m=bB(a,b,c,d,e,f,g,h,l);z(m-i)>.01;)k/=2,l+=(m<i?1:-1)*k,m=bB(a,b,c,d,e,f,g,h,l);return l}}function bB(a,b,c,d,e,f,g,h,i){null==i&&(i=1),i=i>1?1:i<0?0:i;for(var j=i/2,l=[-.1252,.1252,-.3678,.3678,-.5873,.5873,-.7699,.7699,-.9041,.9041,-.9816,.9816],m=[.2491,.2491,.2335,.2335,.2032,.2032,.1601,.1601,.1069,.1069,.0472,.0472],n=0,o=0;o<12;o++){var p=j*l[o]+j,q=bA(p,a,c,e,g),r=bA(p,b,d,f,h),s=q*q+r*r;n+=m[o]*w.sqrt(s)}return j*n}function bA(a,b,c,d,e){return a*(a*(-3*b+9*c-9*d+3*e)+6*b-12*c+6*d)-3*b+3*c}function by(a,b){for(var c=[],d=0,e=a.length;e-2*!b>d;d+=2){var f=[{x:+a[d-2],y:+a[d-1]},{x:+a[d],y:+a[d+1]},{x:+a[d+2],y:+a[d+3]},{x:+a[d+4],y:+a[d+5]}];b?d?e-4==d?f[3]={x:+a[0],y:+a[1]}:e-2==d&&(f[2]={x:+a[0],y:+a[1]},f[3]={x:+a[2],y:+a[3]}):f[0]={x:+a[e-2],y:+a[e-1]}:e-4==d?f[3]=f[2]:d||(f[0]={x:+a[d],y:+a[d+1]}),c.push(["C",(-f[0].x+6*f[1].x+f[2].x)/6,(-f[0].y+6*f[1].y+f[2].y)/6,(f[1].x+6*f[2].x-f[3].x)/6,(f[1].y+6*f[2].y-f[3].y)/6,f[2].x,f[2].y])}return c}function bx(){return this.hex}function bv(a,b,c){function d(){var e=Array.prototype.slice.call(arguments,0),f=e.join("â"),h=d.cache=d.cache||{},i=d.count=d.count||[];return h[g](f)?(bu(i,f),c?c(h[f]):h[f]):(i.length>=1e3&&delete h[i.shift()],i.push(f),h[f]=a[m](b,e),c?c(h[f]):h[f])}return d}function bu(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return a.push(a.splice(c,1)[0])}function bm(a){if(Object(a)!==a)return a;var b=new a.constructor;for(var c in a)a[g](c)&&(b[c]=bm(a[c]));return b}function a(c){if(a.is(c,"function"))return b?c():eve.on("raphael.DOMload",c);if(a.is(c,E))return a._engine.create[m](a,c.splice(0,3+a.is(c[0],C))).add(c);var d=Array.prototype.slice.call(arguments,0);if(a.is(d[d.length-1],"function")){var e=d.pop();return b?e.call(a._engine.create[m](a,d)):eve.on("raphael.DOMload",function(){e.call(a._engine.create[m](a,d))})}return a._engine.create[m](a,arguments)}a.version="2.1.0",a.eve=eve;var b,k,c=/[, ]+/,d={circle:1,rect:1,path:1,ellipse:1,text:1,image:1},e=/\{(\d+)\}/g,g="hasOwnProperty",h={doc:document,win:window},i={was:Object.prototype[g].call(h.win,"Raphael"),is:h.win.Raphael},j=function(){this.ca=this.customAttributes={}},m="apply",n="concat",o="createTouch"in h.doc,p="",q=" ",r=String,s="split",t="click dblclick mousedown mousemove mouseout mouseover mouseup touchstart touchmove touchend touchcancel"[s](q),u={mousedown:"touchstart",mousemove:"touchmove",mouseup:"touchend"},v=r.prototype.toLowerCase,w=Math,x=w.max,y=w.min,z=w.abs,A=w.pow,B=w.PI,C="number",D="string",E="array",H=Object.prototype.toString,L=(a._ISURL=/^url\(['"]?([^\)]+?)['"]?\)$/i,/^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgba?\(\s*([\d\.]+%?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+%?(?:\s*,\s*[\d\.]+%?)?)\s*\)|hsba?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsla?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\))\s*$/i),M={NaN:1,Infinity:1,"-Infinity":1},N=/^(?:cubic-)?bezier\(([^,]+),([^,]+),([^,]+),([^\)]+)\)/,O=w.round,Q=parseFloat,R=parseInt,S=r.prototype.toUpperCase,T=a._availableAttrs={"arrow-end":"none","arrow-start":"none",blur:0,"clip-rect":"0 0 1e9 1e9",cursor:"default",cx:0,cy:0,fill:"#fff","fill-opacity":1,font:'10px "Arial"',"font-family":'"Arial"',"font-size":"10","font-style":"normal","font-weight":400,gradient:0,height:0,href:"http://raphaeljs.com/","letter-spacing":0,opacity:1,path:"M0,0",r:0,rx:0,ry:0,src:"",stroke:"#000","stroke-dasharray":"","stroke-linecap":"butt","stroke-linejoin":"butt","stroke-miterlimit":0,"stroke-opacity":1,"stroke-width":1,target:"_blank","text-anchor":"middle",title:"Raphael",transform:"",width:0,x:0,y:0},U=a._availableAnimAttrs={blur:C,"clip-rect":"csv",cx:C,cy:C,fill:"colour","fill-opacity":C,"font-size":C,height:C,opacity:C,path:"path",r:C,rx:C,ry:C,stroke:"colour","stroke-opacity":C,"stroke-width":C,transform:"transform",width:C,x:C,y:C},W=/[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/,X={hs:1,rg:1},Y=/,?([achlmqrstvxz]),?/gi,Z=/([achlmrqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,$=/([rstm])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,_=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/gi,bb=(a._radial_gradient=/^r(?:\(([^,]+?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*([^\)]+?)\))?/,{}),bd=function(a,b){return Q(a)-Q(b)},be=function(){},bf=function(a){return a},bg=a._rectPath=function(a,b,c,d,e){return e?[["M",a+e,b],["l",c-2*e,0],["a",e,e,0,0,1,e,e],["l",0,d-2*e],["a",e,e,0,0,1,-e,e],["l",2*e-c,0],["a",e,e,0,0,1,-e,-e],["l",0,2*e-d],["a",e,e,0,0,1,e,-e],["z"]]:[["M",a,b],["l",c,0],["l",0,d],["l",-c,0],["z"]]},bh=function(a,b,c,d){return null==d&&(d=c),[["M",a,b],["m",0,-d],["a",c,d,0,1,1,0,2*d],["a",c,d,0,1,1,0,-2*d],["z"]]},bi=a._getPath={path:function(a){return a.attr("path")},circle:function(a){var b=a.attrs;return bh(b.cx,b.cy,b.r)},ellipse:function(a){var b=a.attrs;return bh(b.cx,b.cy,b.rx,b.ry)},rect:function(a){var b=a.attrs;return bg(b.x,b.y,b.width,b.height,b.r)},image:function(a){var b=a.attrs;return bg(b.x,b.y,b.width,b.height)},text:function(a){var b=a._getBBox();return bg(b.x,b.y,b.width,b.height)}},bj=a.mapPath=function(a,b){if(!b)return a;var c,d,e,f,g,h,i;for(a=bR(a),e=0,g=a.length;e<g;e++)for(i=a[e],f=1,h=i.length;f<h;f+=2)c=b.x(i[f],i[f+1]),d=b.y(i[f],i[f+1]),i[f]=c,i[f+1]=d;return a};if(a._g=h,a.type=h.win.SVGAngle||h.doc.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML","VML"==a.type){var bl,bk=h.doc.createElement("div");if(bk.innerHTML='<v:shape adj="1"/>',bl=bk.firstChild,bl.style.behavior="url(#default#VML)",!bl||"object"!=typeof bl.adj)return a.type=p;bk=null}a.svg=!(a.vml="VML"==a.type),a._Paper=j,a.fn=k=j.prototype=a.prototype,a._id=0,a._oid=0,a.is=function(a,b){return b=v.call(b),"finite"==b?!M[g](+a):"array"==b?a instanceof Array:"null"==b&&null===a||b==typeof a&&null!==a||"object"==b&&a===Object(a)||"array"==b&&Array.isArray&&Array.isArray(a)||H.call(a).slice(8,-1).toLowerCase()==b},a.angle=function(b,c,d,e,f,g){if(null==f){var h=b-d,i=c-e;return h||i?(180+180*w.atan2(-i,-h)/B+360)%360:0}return a.angle(b,c,f,g)-a.angle(d,e,f,g)},a.rad=function(a){return a%360*B/180},a.deg=function(a){return 180*a/B%360},a.snapTo=function(b,c,d){if(d=a.is(d,"finite")?d:10,a.is(b,E)){for(var e=b.length;e--;)if(z(b[e]-c)<=d)return b[e]}else{b=+b;var f=c%b;if(f<d)return c-f;if(f>b-d)return c-f+b}return c};a.createUUID=function(a,b){return function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(a,b).toUpperCase()}}(/[xy]/g,function(a){var b=16*w.random()|0;return("x"==a?b:3&b|8).toString(16)});a.setWindow=function(b){eve("raphael.setWindow",a,h.win,b),h.win=b,h.doc=h.win.document,a._engine.initWin&&a._engine.initWin(h.win)};var bo=function(b){if(a.vml){var d,c=/^\s+|\s+$/g;try{var e=new ActiveXObject("htmlfile");e.write("<body>"),e.close(),d=e.body}catch(f){d=createPopup().document.body}var g=d.createTextRange();bo=bv(function(a){try{d.style.color=r(a).replace(c,p);var b=g.queryCommandValue("ForeColor");return b=(255&b)<<16|65280&b|(16711680&b)>>>16,"#"+("000000"+b.toString(16)).slice(-6)}catch(e){return"none"}})}else{var i=h.doc.createElement("i");i.title="RaphaÃ«l Colour Picker",i.style.display="none",h.doc.body.appendChild(i),bo=bv(function(a){return i.style.color=a,h.doc.defaultView.getComputedStyle(i,p).getPropertyValue("color")})}return bo(b)},bp=function(){return"hsb("+[this.h,this.s,this.b]+")"},bq=function(){return"hsl("+[this.h,this.s,this.l]+")"},br=function(){return this.hex},bs=function(b,c,d){if(null==c&&a.is(b,"object")&&"r"in b&&"g"in b&&"b"in b&&(d=b.b,c=b.g,b=b.r),null==c&&a.is(b,D)){var e=a.getRGB(b);b=e.r,c=e.g,d=e.b}return(b>1||c>1||d>1)&&(b/=255,c/=255,d/=255),[b,c,d]},bt=function(b,c,d,e){b*=255,c*=255,d*=255;var f={r:b,g:c,b:d,hex:a.rgb(b,c,d),toString:br};return a.is(e,"finite")&&(f.opacity=e),f};a.color=function(b){var c;return a.is(b,"object")&&"h"in b&&"s"in b&&"b"in b?(c=a.hsb2rgb(b),b.r=c.r,b.g=c.g,b.b=c.b,b.hex=c.hex):a.is(b,"object")&&"h"in b&&"s"in b&&"l"in b?(c=a.hsl2rgb(b),b.r=c.r,b.g=c.g,b.b=c.b,b.hex=c.hex):(a.is(b,"string")&&(b=a.getRGB(b)),a.is(b,"object")&&"r"in b&&"g"in b&&"b"in b?(c=a.rgb2hsl(b),b.h=c.h,b.s=c.s,b.l=c.l,c=a.rgb2hsb(b),b.v=c.b):(b={hex:"none"},b.r=b.g=b.b=b.h=b.s=b.v=b.l=-1)),b.toString=br,b},a.hsb2rgb=function(a,b,c,d){this.is(a,"object")&&"h"in a&&"s"in a&&"b"in a&&(c=a.b,b=a.s,a=a.h,d=a.o),a*=360;var e,f,g,h,i;return a=a%360/60,i=c*b,h=i*(1-z(a%2-1)),e=f=g=c-i,a=~~a,e+=[i,h,0,0,h,i][a],f+=[h,i,i,h,0,0][a],g+=[0,0,h,i,i,h][a],bt(e,f,g,d)},a.hsl2rgb=function(a,b,c,d){this.is(a,"object")&&"h"in a&&"s"in a&&"l"in a&&(c=a.l,b=a.s,a=a.h),(a>1||b>1||c>1)&&(a/=360,b/=100,c/=100),a*=360;var e,f,g,h,i;return a=a%360/60,i=2*b*(c<.5?c:1-c),h=i*(1-z(a%2-1)),e=f=g=c-i/2,a=~~a,e+=[i,h,0,0,h,i][a],f+=[h,i,i,h,0,0][a],g+=[0,0,h,i,i,h][a],bt(e,f,g,d)},a.rgb2hsb=function(a,b,c){c=bs(a,b,c),a=c[0],b=c[1],c=c[2];var d,e,f,g;return f=x(a,b,c),g=f-y(a,b,c),d=0==g?null:f==a?(b-c)/g:f==b?(c-a)/g+2:(a-b)/g+4,d=(d+360)%6*60/360,e=0==g?0:g/f,{h:d,s:e,b:f,toString:bp}},a.rgb2hsl=function(a,b,c){c=bs(a,b,c),a=c[0],b=c[1],c=c[2];var d,e,f,g,h,i;return g=x(a,b,c),h=y(a,b,c),i=g-h,d=0==i?null:g==a?(b-c)/i:g==b?(c-a)/i+2:(a-b)/i+4,d=(d+360)%6*60/360,f=(g+h)/2,e=0==i?0:f<.5?i/(2*f):i/(2-2*f),{h:d,s:e,l:f,toString:bq}},a._path2string=function(){return this.join(",").replace(Y,"$1")};a._preload=function(a,b){var c=h.doc.createElement("img");c.style.cssText="position:absolute;left:-9999em;top:-9999em",c.onload=function(){b.call(this),this.onload=null,h.doc.body.removeChild(this)},c.onerror=function(){h.doc.body.removeChild(this)},h.doc.body.appendChild(c),c.src=a};a.getRGB=bv(function(b){if(!b||(b=r(b)).indexOf("-")+1)return{r:-1,g:-1,b:-1,hex:"none",error:1,toString:bx};if("none"==b)return{r:-1,g:-1,b:-1,hex:"none",toString:bx};!X[g](b.toLowerCase().substring(0,2))&&"#"!=b.charAt()&&(b=bo(b));var d,e,f,h,i,j,k=b.match(L);return k?(k[2]&&(f=R(k[2].substring(5),16),e=R(k[2].substring(3,5),16),d=R(k[2].substring(1,3),16)),k[3]&&(f=R((i=k[3].charAt(3))+i,16),e=R((i=k[3].charAt(2))+i,16),d=R((i=k[3].charAt(1))+i,16)),k[4]&&(j=k[4][s](W),d=Q(j[0]),"%"==j[0].slice(-1)&&(d*=2.55),e=Q(j[1]),"%"==j[1].slice(-1)&&(e*=2.55),f=Q(j[2]),"%"==j[2].slice(-1)&&(f*=2.55),"rgba"==k[1].toLowerCase().slice(0,4)&&(h=Q(j[3])),j[3]&&"%"==j[3].slice(-1)&&(h/=100)),k[5]?(j=k[5][s](W),d=Q(j[0]),"%"==j[0].slice(-1)&&(d*=2.55),e=Q(j[1]),"%"==j[1].slice(-1)&&(e*=2.55),f=Q(j[2]),"%"==j[2].slice(-1)&&(f*=2.55),("deg"==j[0].slice(-3)||"Â°"==j[0].slice(-1))&&(d/=360),"hsba"==k[1].toLowerCase().slice(0,4)&&(h=Q(j[3])),j[3]&&"%"==j[3].slice(-1)&&(h/=100),a.hsb2rgb(d,e,f,h)):k[6]?(j=k[6][s](W),d=Q(j[0]),"%"==j[0].slice(-1)&&(d*=2.55),e=Q(j[1]),"%"==j[1].slice(-1)&&(e*=2.55),f=Q(j[2]),"%"==j[2].slice(-1)&&(f*=2.55),("deg"==j[0].slice(-3)||"Â°"==j[0].slice(-1))&&(d/=360),"hsla"==k[1].toLowerCase().slice(0,4)&&(h=Q(j[3])),j[3]&&"%"==j[3].slice(-1)&&(h/=100),a.hsl2rgb(d,e,f,h)):(k={r:d,g:e,b:f,toString:bx},k.hex="#"+(16777216|f|e<<8|d<<16).toString(16).slice(1),a.is(h,"finite")&&(k.opacity=h),k)):{r:-1,g:-1,b:-1,hex:"none",error:1,toString:bx}},a),a.hsb=bv(function(b,c,d){return a.hsb2rgb(b,c,d).hex}),a.hsl=bv(function(b,c,d){return a.hsl2rgb(b,c,d).hex}),a.rgb=bv(function(a,b,c){return"#"+(16777216|c|b<<8|a<<16).toString(16).slice(1)}),a.getColor=function(a){var b=this.getColor.start=this.getColor.start||{h:0,s:1,b:a||.75},c=this.hsb2rgb(b.h,b.s,b.b);return b.h+=.075,b.h>1&&(b.h=0,b.s-=.2,b.s<=0&&(this.getColor.start={h:0,s:1,b:b.b})),c.hex},a.getColor.reset=function(){delete this.start},a.parsePathString=function(b){if(!b)return null;var c=bz(b);if(c.arr)return bJ(c.arr);var d={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},e=[];return a.is(b,E)&&a.is(b[0],E)&&(e=bJ(b)),e.length||r(b).replace(Z,function(a,b,c){var f=[],g=b.toLowerCase();if(c.replace(_,function(a,b){b&&f.push(+b)}),
"m"==g&&f.length>2&&(e.push([b][n](f.splice(0,2))),g="l",b="m"==b?"l":"L"),"r"==g)e.push([b][n](f));else for(;f.length>=d[g]&&(e.push([b][n](f.splice(0,d[g]))),d[g]););}),e.toString=a._path2string,c.arr=bJ(e),e},a.parseTransformString=bv(function(b){if(!b)return null;var d=[];return a.is(b,E)&&a.is(b[0],E)&&(d=bJ(b)),d.length||r(b).replace($,function(a,b,c){var e=[];v.call(b);c.replace(_,function(a,b){b&&e.push(+b)}),d.push([b][n](e))}),d.toString=a._path2string,d});var bz=function(a){var b=bz.ps=bz.ps||{};return b[a]?b[a].sleep=100:b[a]={sleep:100},setTimeout(function(){for(var c in b)b[g](c)&&c!=a&&!--b[c].sleep&&delete b[c]}),b[a]};a.findDotsAtSegment=function(a,b,c,d,e,f,g,h,i){var j=1-i,k=A(j,3),l=A(j,2),m=i*i,n=m*i,o=k*a+3*l*i*c+3*j*i*i*e+n*g,p=k*b+3*l*i*d+3*j*i*i*f+n*h,q=a+2*i*(c-a)+m*(e-2*c+a),r=b+2*i*(d-b)+m*(f-2*d+b),s=c+2*i*(e-c)+m*(g-2*e+c),t=d+2*i*(f-d)+m*(h-2*f+d),u=j*a+i*c,v=j*b+i*d,x=j*e+i*g,y=j*f+i*h,z=90-180*w.atan2(q-s,r-t)/B;return(q>s||r<t)&&(z+=180),{x:o,y:p,m:{x:q,y:r},n:{x:s,y:t},start:{x:u,y:v},end:{x:x,y:y},alpha:z}},a.bezierBBox=function(b,c,d,e,f,g,h,i){a.is(b,"array")||(b=[b,c,d,e,f,g,h,i]);var j=bQ.apply(null,b);return{x:j.min.x,y:j.min.y,x2:j.max.x,y2:j.max.y,width:j.max.x-j.min.x,height:j.max.y-j.min.y}},a.isPointInsideBBox=function(a,b,c){return b>=a.x&&b<=a.x2&&c>=a.y&&c<=a.y2},a.isBBoxIntersect=function(b,c){var d=a.isPointInsideBBox;return d(c,b.x,b.y)||d(c,b.x2,b.y)||d(c,b.x,b.y2)||d(c,b.x2,b.y2)||d(b,c.x,c.y)||d(b,c.x2,c.y)||d(b,c.x,c.y2)||d(b,c.x2,c.y2)||(b.x<c.x2&&b.x>c.x||c.x<b.x2&&c.x>b.x)&&(b.y<c.y2&&b.y>c.y||c.y<b.y2&&c.y>b.y)},a.pathIntersection=function(a,b){return bH(a,b)},a.pathIntersectionNumber=function(a,b){return bH(a,b,1)},a.isPointInsidePath=function(b,c,d){var e=a.pathBBox(b);return a.isPointInsideBBox(e,c,d)&&bH(b,[["M",c,d],["H",e.x2+10]],1)%2==1},a._removedFactory=function(a){return function(){eve("raphael.log",null,"RaphaÃ«l: you are calling to method â"+a+"â of removed object",a)}};var bI=a.pathBBox=function(a){var b=bz(a);if(b.bbox)return b.bbox;if(!a)return{x:0,y:0,width:0,height:0,x2:0,y2:0};a=bR(a);for(var g,c=0,d=0,e=[],f=[],h=0,i=a.length;h<i;h++)if(g=a[h],"M"==g[0])c=g[1],d=g[2],e.push(c),f.push(d);else{var j=bQ(c,d,g[1],g[2],g[3],g[4],g[5],g[6]);e=e[n](j.min.x,j.max.x),f=f[n](j.min.y,j.max.y),c=g[5],d=g[6]}var k=y[m](0,e),l=y[m](0,f),o=x[m](0,e),p=x[m](0,f),q={x:k,y:l,x2:o,y2:p,width:o-k,height:p-l};return b.bbox=bm(q),q},bJ=function(b){var c=bm(b);return c.toString=a._path2string,c},bK=a._pathToRelative=function(b){var c=bz(b);if(c.rel)return bJ(c.rel);a.is(b,E)&&a.is(b&&b[0],E)||(b=a.parsePathString(b));var d=[],e=0,f=0,g=0,h=0,i=0;"M"==b[0][0]&&(e=b[0][1],f=b[0][2],g=e,h=f,i++,d.push(["M",e,f]));for(var j=i,k=b.length;j<k;j++){var l=d[j]=[],m=b[j];if(m[0]!=v.call(m[0]))switch(l[0]=v.call(m[0]),l[0]){case"a":l[1]=m[1],l[2]=m[2],l[3]=m[3],l[4]=m[4],l[5]=m[5],l[6]=+(m[6]-e).toFixed(3),l[7]=+(m[7]-f).toFixed(3);break;case"v":l[1]=+(m[1]-f).toFixed(3);break;case"m":g=m[1],h=m[2];default:for(var n=1,o=m.length;n<o;n++)l[n]=+(m[n]-(n%2?e:f)).toFixed(3)}else{l=d[j]=[],"m"==m[0]&&(g=m[1]+e,h=m[2]+f);for(var p=0,q=m.length;p<q;p++)d[j][p]=m[p]}var r=d[j].length;switch(d[j][0]){case"z":e=g,f=h;break;case"h":e+=+d[j][r-1];break;case"v":f+=+d[j][r-1];break;default:e+=+d[j][r-2],f+=+d[j][r-1]}}return d.toString=a._path2string,c.rel=bJ(d),d},bL=a._pathToAbsolute=function(b){var c=bz(b);if(c.abs)return bJ(c.abs);if(a.is(b,E)&&a.is(b&&b[0],E)||(b=a.parsePathString(b)),!b||!b.length)return[["M",0,0]];var d=[],e=0,f=0,g=0,h=0,i=0;"M"==b[0][0]&&(e=+b[0][1],f=+b[0][2],g=e,h=f,i++,d[0]=["M",e,f]);for(var k,l,j=3==b.length&&"M"==b[0][0]&&"R"==b[1][0].toUpperCase()&&"Z"==b[2][0].toUpperCase(),m=i,o=b.length;m<o;m++){if(d.push(k=[]),l=b[m],l[0]!=S.call(l[0]))switch(k[0]=S.call(l[0]),k[0]){case"A":k[1]=l[1],k[2]=l[2],k[3]=l[3],k[4]=l[4],k[5]=l[5],k[6]=+(l[6]+e),k[7]=+(l[7]+f);break;case"V":k[1]=+l[1]+f;break;case"H":k[1]=+l[1]+e;break;case"R":for(var p=[e,f][n](l.slice(1)),q=2,r=p.length;q<r;q++)p[q]=+p[q]+e,p[++q]=+p[q]+f;d.pop(),d=d[n](by(p,j));break;case"M":g=+l[1]+e,h=+l[2]+f;default:for(q=1,r=l.length;q<r;q++)k[q]=+l[q]+(q%2?e:f)}else if("R"==l[0])p=[e,f][n](l.slice(1)),d.pop(),d=d[n](by(p,j)),k=["R"][n](l.slice(-2));else for(var s=0,t=l.length;s<t;s++)k[s]=l[s];switch(k[0]){case"Z":e=g,f=h;break;case"H":e=k[1];break;case"V":f=k[1];break;case"M":g=k[k.length-2],h=k[k.length-1];default:e=k[k.length-2],f=k[k.length-1]}}return d.toString=a._path2string,c.abs=bJ(d),d},bM=function(a,b,c,d){return[a,b,c,d,c,d]},bN=function(a,b,c,d,e,f){var g=1/3,h=2/3;return[g*a+h*c,g*b+h*d,g*e+h*c,g*f+h*d,e,f]},bO=function(a,b,c,d,e,f,g,h,i,j){var o,k=120*B/180,l=B/180*(+e||0),m=[],p=bv(function(a,b,c){return{x:a*w.cos(c)-b*w.sin(c),y:a*w.sin(c)+b*w.cos(c)}});if(j)E=j[0],F=j[1],C=j[2],D=j[3];else{o=p(a,b,-l),a=o.x,b=o.y,o=p(h,i,-l),h=o.x,i=o.y;var t=(w.cos(B/180*e),w.sin(B/180*e),(a-h)/2),u=(b-i)/2,v=t*t/(c*c)+u*u/(d*d);v>1&&(v=w.sqrt(v),c*=v,d*=v);var x=c*c,y=d*d,A=(f==g?-1:1)*w.sqrt(z((x*y-x*u*u-y*t*t)/(x*u*u+y*t*t))),C=A*c*u/d+(a+h)/2,D=A*-d*t/c+(b+i)/2,E=w.asin(((b-D)/d).toFixed(9)),F=w.asin(((i-D)/d).toFixed(9));E=a<C?B-E:E,F=h<C?B-F:F,E<0&&(E=2*B+E),F<0&&(F=2*B+F),g&&E>F&&(E-=2*B),!g&&F>E&&(F-=2*B)}var G=F-E;if(z(G)>k){var H=F,I=h,J=i;F=E+k*(g&&F>E?1:-1),h=C+c*w.cos(F),i=D+d*w.sin(F),m=bO(h,i,c,d,e,0,g,I,J,[F,H,C,D])}G=F-E;var K=w.cos(E),L=w.sin(E),M=w.cos(F),N=w.sin(F),O=w.tan(G/4),P=4/3*c*O,Q=4/3*d*O,R=[a,b],S=[a+P*L,b-Q*K],T=[h+P*N,i-Q*M],U=[h,i];if(S[0]=2*R[0]-S[0],S[1]=2*R[1]-S[1],j)return[S,T,U][n](m);m=[S,T,U][n](m).join()[s](",");for(var V=[],W=0,X=m.length;W<X;W++)V[W]=W%2?p(m[W-1],m[W],l).y:p(m[W],m[W+1],l).x;return V},bP=function(a,b,c,d,e,f,g,h,i){var j=1-i;return{x:A(j,3)*a+3*A(j,2)*i*c+3*j*i*i*e+A(i,3)*g,y:A(j,3)*b+3*A(j,2)*i*d+3*j*i*i*f+A(i,3)*h}},bQ=bv(function(a,b,c,d,e,f,g,h){var q,i=e-2*c+a-(g-2*e+c),j=2*(c-a)-2*(e-c),k=a-c,l=(-j+w.sqrt(j*j-4*i*k))/2/i,n=(-j-w.sqrt(j*j-4*i*k))/2/i,o=[b,h],p=[a,g];return z(l)>"1e12"&&(l=.5),z(n)>"1e12"&&(n=.5),l>0&&l<1&&(q=bP(a,b,c,d,e,f,g,h,l),p.push(q.x),o.push(q.y)),n>0&&n<1&&(q=bP(a,b,c,d,e,f,g,h,n),p.push(q.x),o.push(q.y)),i=f-2*d+b-(h-2*f+d),j=2*(d-b)-2*(f-d),k=b-d,l=(-j+w.sqrt(j*j-4*i*k))/2/i,n=(-j-w.sqrt(j*j-4*i*k))/2/i,z(l)>"1e12"&&(l=.5),z(n)>"1e12"&&(n=.5),l>0&&l<1&&(q=bP(a,b,c,d,e,f,g,h,l),p.push(q.x),o.push(q.y)),n>0&&n<1&&(q=bP(a,b,c,d,e,f,g,h,n),p.push(q.x),o.push(q.y)),{min:{x:y[m](0,p),y:y[m](0,o)},max:{x:x[m](0,p),y:x[m](0,o)}}}),bR=a._path2curve=bv(function(a,b){var c=!b&&bz(a);if(!b&&c.curve)return bJ(c.curve);for(var d=bL(a),e=b&&bL(b),f={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},g={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},h=(function(a,b){var c,d;if(!a)return["C",b.x,b.y,b.x,b.y,b.x,b.y];switch(!(a[0]in{T:1,Q:1})&&(b.qx=b.qy=null),a[0]){case"M":b.X=a[1],b.Y=a[2];break;case"A":a=["C"][n](bO[m](0,[b.x,b.y][n](a.slice(1))));break;case"S":c=b.x+(b.x-(b.bx||b.x)),d=b.y+(b.y-(b.by||b.y)),a=["C",c,d][n](a.slice(1));break;case"T":b.qx=b.x+(b.x-(b.qx||b.x)),b.qy=b.y+(b.y-(b.qy||b.y)),a=["C"][n](bN(b.x,b.y,b.qx,b.qy,a[1],a[2]));break;case"Q":b.qx=a[1],b.qy=a[2],a=["C"][n](bN(b.x,b.y,a[1],a[2],a[3],a[4]));break;case"L":a=["C"][n](bM(b.x,b.y,a[1],a[2]));break;case"H":a=["C"][n](bM(b.x,b.y,a[1],b.y));break;case"V":a=["C"][n](bM(b.x,b.y,b.x,a[1]));break;case"Z":a=["C"][n](bM(b.x,b.y,b.X,b.Y))}return a}),i=function(a,b){if(a[b].length>7){a[b].shift();for(var c=a[b];c.length;)a.splice(b++,0,["C"][n](c.splice(0,6)));a.splice(b,1),l=x(d.length,e&&e.length||0)}},j=function(a,b,c,f,g){a&&b&&"M"==a[g][0]&&"M"!=b[g][0]&&(b.splice(g,0,["M",f.x,f.y]),c.bx=0,c.by=0,c.x=a[g][1],c.y=a[g][2],l=x(d.length,e&&e.length||0))},k=0,l=x(d.length,e&&e.length||0);k<l;k++){d[k]=h(d[k],f),i(d,k),e&&(e[k]=h(e[k],g)),e&&i(e,k),j(d,e,f,g,k),j(e,d,g,f,k);var o=d[k],p=e&&e[k],q=o.length,r=e&&p.length;f.x=o[q-2],f.y=o[q-1],f.bx=Q(o[q-4])||f.x,f.by=Q(o[q-3])||f.y,g.bx=e&&(Q(p[r-4])||g.x),g.by=e&&(Q(p[r-3])||g.y),g.x=e&&p[r-2],g.y=e&&p[r-1]}return e||(c.curve=bJ(d)),e?[d,e]:d},null,bJ),bT=(a._parseDots=bv(function(b){for(var c=[],d=0,e=b.length;d<e;d++){var f={},g=b[d].match(/^([^:]*):?([\d\.]*)/);if(f.color=a.getRGB(g[1]),f.color.error)return null;f.color=f.color.hex,g[2]&&(f.offset=g[2]+"%"),c.push(f)}for(d=1,e=c.length-1;d<e;d++)if(!c[d].offset){for(var h=Q(c[d-1].offset||0),i=0,j=d+1;j<e;j++)if(c[j].offset){i=c[j].offset;break}i||(i=100,j=e),i=Q(i);for(var k=(i-h)/(j-d+1);d<j;d++)h+=k,c[d].offset=h+"%"}return c}),a._tear=function(a,b){a==b.top&&(b.top=a.prev),a==b.bottom&&(b.bottom=a.next),a.next&&(a.next.prev=a.prev),a.prev&&(a.prev.next=a.next)}),bY=(a._tofront=function(a,b){b.top!==a&&(bT(a,b),a.next=null,a.prev=b.top,b.top.next=a,b.top=a)},a._toback=function(a,b){b.bottom!==a&&(bT(a,b),a.next=b.bottom,a.prev=null,b.bottom.prev=a,b.bottom=a)},a._insertafter=function(a,b,c){bT(a,c),b==c.top&&(c.top=a),b.next&&(b.next.prev=a),a.next=b.next,a.prev=b,b.next=a},a._insertbefore=function(a,b,c){bT(a,c),b==c.bottom&&(c.bottom=a),b.prev&&(b.prev.next=a),a.prev=b.prev,b.prev=a,a.next=b},a.toMatrix=function(a,b){var c=bI(a),d={_:{transform:p},getBBox:function(){return c}};return b$(d,b),d.matrix}),b$=(a.transformPath=function(a,b){return bj(a,bY(a,b))},a._extractTransform=function(b,c){if(null==c)return b._.transform;c=r(c).replace(/\.{3}|\u2026/g,b._.transform||p);var d=a.parseTransformString(c),e=0,f=0,g=0,h=1,i=1,j=b._,k=new cb;if(j.transform=d||[],d)for(var l=0,m=d.length;l<m;l++){var u,v,w,x,y,n=d[l],o=n.length,q=r(n[0]).toLowerCase(),s=n[0]!=q,t=s?k.invert():0;"t"==q&&3==o?s?(u=t.x(0,0),v=t.y(0,0),w=t.x(n[1],n[2]),x=t.y(n[1],n[2]),k.translate(w-u,x-v)):k.translate(n[1],n[2]):"r"==q?2==o?(y=y||b.getBBox(1),k.rotate(n[1],y.x+y.width/2,y.y+y.height/2),e+=n[1]):4==o&&(s?(w=t.x(n[2],n[3]),x=t.y(n[2],n[3]),k.rotate(n[1],w,x)):k.rotate(n[1],n[2],n[3]),e+=n[1]):"s"==q?2==o||3==o?(y=y||b.getBBox(1),k.scale(n[1],n[o-1],y.x+y.width/2,y.y+y.height/2),h*=n[1],i*=n[o-1]):5==o&&(s?(w=t.x(n[3],n[4]),x=t.y(n[3],n[4]),k.scale(n[1],n[2],w,x)):k.scale(n[1],n[2],n[3],n[4]),h*=n[1],i*=n[2]):"m"==q&&7==o&&k.add(n[1],n[2],n[3],n[4],n[5],n[6]),j.dirtyT=1,b.matrix=k}b.matrix=k,j.sx=h,j.sy=i,j.deg=e,j.dx=f=k.e,j.dy=g=k.f,1==h&&1==i&&!e&&j.bbox?(j.bbox.x+=+f,j.bbox.y+=+g):j.dirtyT=1}),b_=function(a){var b=a[0];switch(b.toLowerCase()){case"t":return[b,0,0];case"m":return[b,1,0,0,1,0,0];case"r":return 4==a.length?[b,0,a[2],a[3]]:[b,0];case"s":return 5==a.length?[b,1,1,a[3],a[4]]:3==a.length?[b,1,1]:[b,1]}},ca=a._equaliseTransform=function(b,c){c=r(c).replace(/\.{3}|\u2026/g,b),b=a.parseTransformString(b)||[],c=a.parseTransformString(c)||[];for(var h,i,j,k,d=x(b.length,c.length),e=[],f=[],g=0;g<d;g++){if(j=b[g]||b_(c[g]),k=c[g]||b_(j),j[0]!=k[0]||"r"==j[0].toLowerCase()&&(j[2]!=k[2]||j[3]!=k[3])||"s"==j[0].toLowerCase()&&(j[3]!=k[3]||j[4]!=k[4]))return;for(e[g]=[],f[g]=[],h=0,i=x(j.length,k.length);h<i;h++)h in j&&(e[g][h]=j[h]),h in k&&(f[g][h]=k[h])}return{from:e,to:f}};a._getContainer=function(b,c,d,e){var f;if(null!=(f=null!=e||a.is(b,"object")?b:h.doc.getElementById(b)))return f.tagName?null==c?{container:f,width:f.style.pixelWidth||f.offsetWidth,height:f.style.pixelHeight||f.offsetHeight}:{container:f,width:c,height:d}:{container:1,x:b,y:c,width:d,height:e}},a.pathToRelative=bK,a._engine={},a.path2curve=bR,a.matrix=function(a,b,c,d,e,f){return new cb(a,b,c,d,e,f)},function(b){function d(a){var b=w.sqrt(c(a));a[0]&&(a[0]/=b),a[1]&&(a[1]/=b)}function c(a){return a[0]*a[0]+a[1]*a[1]}b.add=function(a,b,c,d,e,f){var j,k,l,m,g=[[],[],[]],h=[[this.a,this.c,this.e],[this.b,this.d,this.f],[0,0,1]],i=[[a,c,e],[b,d,f],[0,0,1]];for(a&&a instanceof cb&&(i=[[a.a,a.c,a.e],[a.b,a.d,a.f],[0,0,1]]),j=0;j<3;j++)for(k=0;k<3;k++){for(m=0,l=0;l<3;l++)m+=h[j][l]*i[l][k];g[j][k]=m}this.a=g[0][0],this.b=g[1][0],this.c=g[0][1],this.d=g[1][1],this.e=g[0][2],this.f=g[1][2]},b.invert=function(){var a=this,b=a.a*a.d-a.b*a.c;return new cb(a.d/b,-a.b/b,-a.c/b,a.a/b,(a.c*a.f-a.d*a.e)/b,(a.b*a.e-a.a*a.f)/b)},b.clone=function(){return new cb(this.a,this.b,this.c,this.d,this.e,this.f)},b.translate=function(a,b){this.add(1,0,0,1,a,b)},b.scale=function(a,b,c,d){null==b&&(b=a),(c||d)&&this.add(1,0,0,1,c,d),this.add(a,0,0,b,0,0),(c||d)&&this.add(1,0,0,1,-c,-d)},b.rotate=function(b,c,d){b=a.rad(b),c=c||0,d=d||0;var e=+w.cos(b).toFixed(9),f=+w.sin(b).toFixed(9);this.add(e,f,-f,e,c,d),this.add(1,0,0,1,-c,-d)},b.x=function(a,b){return a*this.a+b*this.c+this.e},b.y=function(a,b){return a*this.b+b*this.d+this.f},b.get=function(a){return+this[r.fromCharCode(97+a)].toFixed(4)},b.toString=function(){return a.svg?"matrix("+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)].join()+")":[this.get(0),this.get(2),this.get(1),this.get(3),0,0].join()},b.toFilter=function(){return"progid:DXImageTransform.Microsoft.Matrix(M11="+this.get(0)+", M12="+this.get(2)+", M21="+this.get(1)+", M22="+this.get(3)+", Dx="+this.get(4)+", Dy="+this.get(5)+", sizingmethod='auto expand')"},b.offset=function(){return[this.e.toFixed(4),this.f.toFixed(4)]},b.split=function(){var b={};b.dx=this.e,b.dy=this.f;var e=[[this.a,this.c],[this.b,this.d]];b.scalex=w.sqrt(c(e[0])),d(e[0]),b.shear=e[0][0]*e[1][0]+e[0][1]*e[1][1],e[1]=[e[1][0]-e[0][0]*b.shear,e[1][1]-e[0][1]*b.shear],b.scaley=w.sqrt(c(e[1])),d(e[1]),b.shear/=b.scaley;var f=-e[0][1],g=e[1][1];return g<0?(b.rotate=a.deg(w.acos(g)),f<0&&(b.rotate=360-b.rotate)):b.rotate=a.deg(w.asin(f)),b.isSimple=!(+b.shear.toFixed(9)||b.scalex.toFixed(9)!=b.scaley.toFixed(9)&&b.rotate),b.isSuperSimple=!+b.shear.toFixed(9)&&b.scalex.toFixed(9)==b.scaley.toFixed(9)&&!b.rotate,b.noRotation=!+b.shear.toFixed(9)&&!b.rotate,b},b.toTransformString=function(a){var b=a||this[s]();return b.isSimple?(b.scalex=+b.scalex.toFixed(4),b.scaley=+b.scaley.toFixed(4),b.rotate=+b.rotate.toFixed(4),(b.dx||b.dy?"t"+[b.dx,b.dy]:p)+(1!=b.scalex||1!=b.scaley?"s"+[b.scalex,b.scaley,0,0]:p)+(b.rotate?"r"+[b.rotate,0,0]:p)):"m"+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)]}}(cb.prototype);var cc=navigator.userAgent.match(/Version\/(.*?)\s/)||navigator.userAgent.match(/Chrome\/(\d+)/);"Apple Computer, Inc."==navigator.vendor&&(cc&&cc[1]<4||"iP"==navigator.platform.slice(0,2))||"Google Inc."==navigator.vendor&&cc&&cc[1]<8?k.safari=function(){var a=this.rect(-99,-99,this.width+99,this.height+99).attr({stroke:"none"});setTimeout(function(){a.remove()})}:k.safari=be;for(var cd=function(){this.returnValue=!1},ce=function(){return this.originalEvent.preventDefault()},cf=function(){this.cancelBubble=!0},cg=function(){return this.originalEvent.stopPropagation()},ch=function(){return h.doc.addEventListener?function(a,b,c,d){var e=o&&u[b]?u[b]:b,f=function(e){var f=h.doc.documentElement.scrollTop||h.doc.body.scrollTop,i=h.doc.documentElement.scrollLeft||h.doc.body.scrollLeft,j=e.clientX+i,k=e.clientY+f;if(o&&u[g](b))for(var l=0,m=e.targetTouches&&e.targetTouches.length;l<m;l++)if(e.targetTouches[l].target==a){var n=e;e=e.targetTouches[l],e.originalEvent=n,e.preventDefault=ce,e.stopPropagation=cg;break}return c.call(d,e,j,k)};return a.addEventListener(e,f,!1),function(){return a.removeEventListener(e,f,!1),!0}}:h.doc.attachEvent?function(a,b,c,d){var e=function(a){a=a||h.win.event;var b=h.doc.documentElement.scrollTop||h.doc.body.scrollTop,e=h.doc.documentElement.scrollLeft||h.doc.body.scrollLeft,f=a.clientX+e,g=a.clientY+b;return a.preventDefault=a.preventDefault||cd,a.stopPropagation=a.stopPropagation||cf,c.call(d,a,f,g)};return a.attachEvent("on"+b,e),function(){return a.detachEvent("on"+b,e),!0}}:void 0}(),ci=[],cj=function(a){for(var f,b=a.clientX,c=a.clientY,d=h.doc.documentElement.scrollTop||h.doc.body.scrollTop,e=h.doc.documentElement.scrollLeft||h.doc.body.scrollLeft,g=ci.length;g--;){if(f=ci[g],o){for(var j,i=a.touches.length;i--;)if(j=a.touches[i],j.identifier==f.el._drag.id){b=j.clientX,c=j.clientY,(a.originalEvent?a.originalEvent:a).preventDefault();break}}else a.preventDefault();var l,k=f.el.node,m=k.nextSibling,n=k.parentNode,p=k.style.display;h.win.opera&&n.removeChild(k),k.style.display="none",l=f.el.paper.getElementByPoint(b,c),k.style.display=p,h.win.opera&&(m?n.insertBefore(k,m):n.appendChild(k)),l&&eve("raphael.drag.over."+f.el.id,f.el,l),b+=e,c+=d,eve("raphael.drag.move."+f.el.id,f.move_scope||f.el,b-f.el._drag.x,c-f.el._drag.y,b,c,a)}},ck=function(b){a.unmousemove(cj).unmouseup(ck);for(var d,c=ci.length;c--;)d=ci[c],d.el._drag={},eve("raphael.drag.end."+d.el.id,d.end_scope||d.start_scope||d.move_scope||d.el,b);ci=[]},cl=a.el={},cm=t.length;cm--;)!function(b){a[b]=cl[b]=function(c,d){return a.is(c,"function")&&(this.events=this.events||[],this.events.push({name:b,f:c,unbind:ch(this.shape||this.node||h.doc,b,c,d||this)})),this},a["un"+b]=cl["un"+b]=function(a){for(var c=this.events||[],d=c.length;d--;)if(c[d].name==b&&c[d].f==a)return c[d].unbind(),c.splice(d,1),!c.length&&delete this.events,this;return this}}(t[cm]);cl.data=function(b,c){var d=bb[this.id]=bb[this.id]||{};if(1==arguments.length){if(a.is(b,"object")){for(var e in b)b[g](e)&&this.data(e,b[e]);return this}return eve("raphael.data.get."+this.id,this,d[b],b),d[b]}return d[b]=c,eve("raphael.data.set."+this.id,this,c,b),this},cl.removeData=function(a){return null==a?bb[this.id]={}:bb[this.id]&&delete bb[this.id][a],this},cl.hover=function(a,b,c,d){return this.mouseover(a,c).mouseout(b,d||c)},cl.unhover=function(a,b){return this.unmouseover(a).unmouseout(b)};var cn=[];cl.drag=function(b,c,d,e,f,g){function i(i){(i.originalEvent||i).preventDefault();var j=h.doc.documentElement.scrollTop||h.doc.body.scrollTop,k=h.doc.documentElement.scrollLeft||h.doc.body.scrollLeft;this._drag.x=i.clientX+k,this._drag.y=i.clientY+j,this._drag.id=i.identifier,!ci.length&&a.mousemove(cj).mouseup(ck),ci.push({el:this,move_scope:e,start_scope:f,end_scope:g}),c&&eve.on("raphael.drag.start."+this.id,c),b&&eve.on("raphael.drag.move."+this.id,b),d&&eve.on("raphael.drag.end."+this.id,d),eve("raphael.drag.start."+this.id,f||e||this,i.clientX+k,i.clientY+j,i)}return this._drag={},cn.push({el:this,start:i}),this.mousedown(i),this},cl.onDragOver=function(a){a?eve.on("raphael.drag.over."+this.id,a):eve.unbind("raphael.drag.over."+this.id)},cl.undrag=function(){for(var b=cn.length;b--;)cn[b].el==this&&(this.unmousedown(cn[b].start),cn.splice(b,1),eve.unbind("raphael.drag.*."+this.id));!cn.length&&a.unmousemove(cj).unmouseup(ck)},k.circle=function(b,c,d){var e=a._engine.circle(this,b||0,c||0,d||0);return this.__set__&&this.__set__.push(e),e},k.rect=function(b,c,d,e,f){var g=a._engine.rect(this,b||0,c||0,d||0,e||0,f||0);return this.__set__&&this.__set__.push(g),g},k.ellipse=function(b,c,d,e){var f=a._engine.ellipse(this,b||0,c||0,d||0,e||0);return this.__set__&&this.__set__.push(f),f},k.path=function(b){b&&!a.is(b,D)&&!a.is(b[0],E)&&(b+=p);var c=a._engine.path(a.format[m](a,arguments),this);return this.__set__&&this.__set__.push(c),c},k.image=function(b,c,d,e,f){var g=a._engine.image(this,b||"about:blank",c||0,d||0,e||0,f||0);return this.__set__&&this.__set__.push(g),g},k.text=function(b,c,d){var e=a._engine.text(this,b||0,c||0,r(d));return this.__set__&&this.__set__.push(e),e},k.set=function(b){!a.is(b,"array")&&(b=Array.prototype.splice.call(arguments,0,arguments.length));var c=new cG(b);return this.__set__&&this.__set__.push(c),c},k.setStart=function(a){this.__set__=a||this.set()},k.setFinish=function(a){var b=this.__set__;return delete this.__set__,b},k.setSize=function(b,c){return a._engine.setSize.call(this,b,c)},k.setViewBox=function(b,c,d,e,f){return a._engine.setViewBox.call(this,b,c,d,e,f)},k.top=k.bottom=null,k.raphael=a;var co=function(a){var b=a.getBoundingClientRect(),c=a.ownerDocument,d=c.body,e=c.documentElement,f=e.clientTop||d.clientTop||0,g=e.clientLeft||d.clientLeft||0;return{y:b.top+(h.win.pageYOffset||e.scrollTop||d.scrollTop)-f,x:b.left+(h.win.pageXOffset||e.scrollLeft||d.scrollLeft)-g}};k.getElementByPoint=function(a,b){var c=this,d=c.canvas,e=h.doc.elementFromPoint(a,b);if(h.win.opera&&"svg"==e.tagName){var f=co(d),g=d.createSVGRect();g.x=a-f.x,g.y=b-f.y,g.width=g.height=1;var i=d.getIntersectionList(g,null);i.length&&(e=i[i.length-1])}if(!e)return null;for(;e.parentNode&&e!=d.parentNode&&!e.raphael;)e=e.parentNode;return e==c.canvas.parentNode&&(e=d),e=e&&e.raphael?c.getById(e.raphaelid):null},k.getById=function(a){for(var b=this.bottom;b;){if(b.id==a)return b;b=b.next}return null},k.forEach=function(a,b){for(var c=this.bottom;c;){if(!1===a.call(b,c))return this;c=c.next}return this},k.getElementsByPoint=function(a,b){var c=this.set();return this.forEach(function(d){d.isPointInside(a,b)&&c.push(d)}),c},cl.isPointInside=function(b,c){var d=this.realPath=this.realPath||bi[this.type](this);return a.isPointInsidePath(d,b,c)},cl.getBBox=function(a){if(this.removed)return{};var b=this._;return a?(!b.dirty&&b.bboxwt||(this.realPath=bi[this.type](this),b.bboxwt=bI(this.realPath),b.bboxwt.toString=cq,b.dirty=0),b.bboxwt):((b.dirty||b.dirtyT||!b.bbox)&&(!b.dirty&&this.realPath||(b.bboxwt=0,this.realPath=bi[this.type](this)),b.bbox=bI(bj(this.realPath,this.matrix)),b.bbox.toString=cq,b.dirty=b.dirtyT=0),b.bbox)},cl.clone=function(){if(this.removed)return null;var a=this.paper[this.type]().attr(this.attr());return this.__set__&&this.__set__.push(a),a},cl.glow=function(a){if("text"==this.type)return null;a=a||{};var b={width:(a.width||10)+(+this.attr("stroke-width")||1),fill:a.fill||!1,opacity:a.opacity||.5,offsetx:a.offsetx||0,offsety:a.offsety||0,color:a.color||"#000"},c=b.width/2,d=this.paper,e=d.set(),f=this.realPath||bi[this.type](this);f=this.matrix?bj(f,this.matrix):f;for(var g=1;g<c+1;g++)e.push(d.path(f).attr({stroke:b.color,fill:b.fill?b.color:"none","stroke-linejoin":"round","stroke-linecap":"round","stroke-width":+(b.width/c*g).toFixed(3),opacity:+(b.opacity/c).toFixed(3)}));return e.insertBefore(this).translate(b.offsetx,b.offsety)};var cs=function(b,c,d,e,f,g,h,i,j){return null==j?bB(b,c,d,e,f,g,h,i):a.findDotsAtSegment(b,c,d,e,f,g,h,i,bC(b,c,d,e,f,g,h,i,j))},ct=function(b,c){return function(d,e,f){d=bR(d);for(var g,h,i,j,m,k="",l={},n=0,o=0,p=d.length;o<p;o++){if(i=d[o],"M"==i[0])g=+i[1],h=+i[2];else{if(j=cs(g,h,i[1],i[2],i[3],i[4],i[5],i[6]),n+j>e){if(c&&!l.start){if(m=cs(g,h,i[1],i[2],i[3],i[4],i[5],i[6],e-n),k+=["C"+m.start.x,m.start.y,m.m.x,m.m.y,m.x,m.y],f)return k;l.start=k,k=["M"+m.x,m.y+"C"+m.n.x,m.n.y,m.end.x,m.end.y,i[5],i[6]].join(),n+=j,g=+i[5],h=+i[6];continue}if(!b&&!c)return m=cs(g,h,i[1],i[2],i[3],i[4],i[5],i[6],e-n),{x:m.x,y:m.y,alpha:m.alpha}}n+=j,g=+i[5],h=+i[6]}k+=i.shift()+i}return l.end=k,m=b?n:c?l:a.findDotsAtSegment(g,h,i[0],i[1],i[2],i[3],i[4],i[5],1),m.alpha&&(m={x:m.x,y:m.y,alpha:m.alpha}),m}},cu=ct(1),cv=ct(),cw=ct(0,1);a.getTotalLength=cu,a.getPointAtLength=cv,a.getSubpath=function(a,b,c){if(this.getTotalLength(a)-c<1e-6)return cw(a,b).end;var d=cw(a,c,1);return b?cw(d,b).end:d},cl.getTotalLength=function(){if("path"==this.type)return this.node.getTotalLength?this.node.getTotalLength():cu(this.attrs.path)},cl.getPointAtLength=function(a){if("path"==this.type)return cv(this.attrs.path,a)},cl.getSubpath=function(b,c){if("path"==this.type)return a.getSubpath(this.attrs.path,b,c)};var cx=a.easing_formulas={linear:function(a){return a},"<":function(a){return A(a,1.7)},">":function(a){return A(a,.48)},"<>":function(a){var b=.48-a/1.04,c=w.sqrt(.1734+b*b),d=c-b,e=A(z(d),1/3)*(d<0?-1:1),f=-c-b,g=A(z(f),1/3)*(f<0?-1:1),h=e+g+.5;return 3*(1-h)*h*h+h*h*h},backIn:function(a){var b=1.70158;return a*a*((b+1)*a-b)},backOut:function(a){a-=1;var b=1.70158;return a*a*((b+1)*a+b)+1},elastic:function(a){return a==!!a?a:A(2,-10*a)*w.sin(2*(a-.075)*B/.3)+1},bounce:function(a){var d,b=7.5625,c=2.75;return a<1/c?d=b*a*a:a<2/c?(a-=1.5/c,d=b*a*a+.75):a<2.5/c?(a-=2.25/c,d=b*a*a+.9375):(a-=2.625/c,d=b*a*a+.984375),d}};cx.easeIn=cx["ease-in"]=cx["<"],cx.easeOut=cx["ease-out"]=cx[">"],cx.easeInOut=cx["ease-in-out"]=cx["<>"],cx["back-in"]=cx.backIn,cx["back-out"]=cx.backOut;var cy=[],cz=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){setTimeout(a,16)},cA=function(){for(var b=+new Date,c=0;c<cy.length;c++){var d=cy[c];if(!d.el.removed&&!d.paused){var p,s,e=b-d.start,f=d.ms,h=d.easing,i=d.from,j=d.diff,k=d.to,m=(d.t,d.el),o={},r={};if(d.initstatus?(e=(d.initstatus*d.anim.top-d.prev)/(d.percent-d.prev)*f,d.status=d.initstatus,delete d.initstatus,d.stop&&cy.splice(c--,1)):d.status=(d.prev+(d.percent-d.prev)*(e/f))/d.anim.top,!(e<0))if(e<f){var t=h(e/f);for(var u in i)if(i[g](u)){switch(U[u]){case C:p=+i[u]+t*f*j[u];break;case"colour":p="rgb("+[cB(O(i[u].r+t*f*j[u].r)),cB(O(i[u].g+t*f*j[u].g)),cB(O(i[u].b+t*f*j[u].b))].join(",")+")";break;case"path":p=[];for(var v=0,w=i[u].length;v<w;v++){p[v]=[i[u][v][0]];for(var x=1,y=i[u][v].length;x<y;x++)p[v][x]=+i[u][v][x]+t*f*j[u][v][x];p[v]=p[v].join(q)}p=p.join(q);break;case"transform":if(j[u].real)for(p=[],v=0,w=i[u].length;v<w;v++)for(p[v]=[i[u][v][0]],x=1,y=i[u][v].length;x<y;x++)p[v][x]=i[u][v][x]+t*f*j[u][v][x];else{var z=function(a){return+i[u][a]+t*f*j[u][a]};p=[["m",z(0),z(1),z(2),z(3),z(4),z(5)]]}break;case"csv":if("clip-rect"==u)for(p=[],v=4;v--;)p[v]=+i[u][v]+t*f*j[u][v];break;default:var A=[][n](i[u]);for(p=[],v=m.paper.customAttributes[u].length;v--;)p[v]=+A[v]+t*f*j[u][v]}o[u]=p}m.attr(o),function(a,b,c){setTimeout(function(){eve("raphael.anim.frame."+a,b,c)})}(m.id,m,d.anim)}else{if(function(b,c,d){setTimeout(function(){eve("raphael.anim.frame."+c.id,c,d),eve("raphael.anim.finish."+c.id,c,d),a.is(b,"function")&&b.call(c)})}(d.callback,m,d.anim),m.attr(k),cy.splice(c--,1),d.repeat>1&&!d.next){for(s in k)k[g](s)&&(r[s]=d.totalOrigin[s]);d.el.attr(r),cE(d.anim,d.el,d.anim.percents[0],null,d.totalOrigin,d.repeat-1)}d.next&&!d.stop&&cE(d.anim,d.el,d.next,null,d.totalOrigin,d.repeat)}}}a.svg&&m&&m.paper&&m.paper.safari(),cy.length&&cz(cA)},cB=function(a){return a>255?255:a<0?0:a};cl.animateWith=function(b,c,d,e,f,g){var h=this;if(h.removed)return g&&g.call(h),h;var i=d instanceof cD?d:a.animation(d,e,f,g);cE(i,h,i.percents[0],null,h.attr());for(var l=0,m=cy.length;l<m;l++)if(cy[l].anim==c&&cy[l].el==b){cy[m-1].start=cy[l].start;break}return h},cl.onAnimation=function(a){return a?eve.on("raphael.anim.frame."+this.id,a):eve.unbind("raphael.anim.frame."+this.id),this},cD.prototype.delay=function(a){var b=new cD(this.anim,this.ms);return b.times=this.times,b.del=+a||0,b},cD.prototype.repeat=function(a){var b=new cD(this.anim,this.ms);return b.del=this.del,b.times=w.floor(x(a,0))||1,b},a.animation=function(b,c,d,e){if(b instanceof cD)return b;!a.is(d,"function")&&d||(e=e||d||null,d=null),b=Object(b),c=+c||0;var h,i,f={};for(i in b)b[g](i)&&Q(i)!=i&&Q(i)+"%"!=i&&(h=!0,f[i]=b[i]);return h?(d&&(f.easing=d),e&&(f.callback=e),new cD({100:f},c)):new cD(b,c)},cl.animate=function(b,c,d,e){var f=this;if(f.removed)return e&&e.call(f),f;var g=b instanceof cD?b:a.animation(b,c,d,e);return cE(g,f,g.percents[0],null,f.attr()),f},cl.setTime=function(a,b){return a&&null!=b&&this.status(a,y(b,a.ms)/a.ms),this},cl.status=function(a,b){var e,f,c=[],d=0;if(null!=b)return cE(a,this,-1,y(b,1)),this;for(e=cy.length;d<e;d++)if(f=cy[d],f.el.id==this.id&&(!a||f.anim==a)){if(a)return f.status;c.push({anim:f.anim,status:f.status})}return a?0:c},cl.pause=function(a){for(var b=0;b<cy.length;b++)cy[b].el.id==this.id&&(!a||cy[b].anim==a)&&!1!==eve("raphael.anim.pause."+this.id,this,cy[b].anim)&&(cy[b].paused=!0);return this},cl.resume=function(a){for(var b=0;b<cy.length;b++)if(cy[b].el.id==this.id&&(!a||cy[b].anim==a)){var c=cy[b];!1!==eve("raphael.anim.resume."+this.id,this,c.anim)&&(delete c.paused,this.status(c.anim,c.status))}return this},cl.stop=function(a){for(var b=0;b<cy.length;b++)cy[b].el.id==this.id&&(!a||cy[b].anim==a)&&!1!==eve("raphael.anim.stop."+this.id,this,cy[b].anim)&&cy.splice(b--,1);return this},eve.on("raphael.remove",cF),eve.on("raphael.clear",cF),cl.toString=function(){return"RaphaÃ«lâs object"};var cG=function(a){if(this.items=[],this.length=0,this.type="set",a)for(var b=0,c=a.length;b<c;b++)a[b]&&(a[b].constructor==cl.constructor||a[b].constructor==cG)&&(this[this.items.length]=this.items[this.items.length]=a[b],this.length++)},cH=cG.prototype;cH.push=function(){for(var a,b,c=0,d=arguments.length;c<d;c++)(a=arguments[c])&&(a.constructor==cl.constructor||a.constructor==cG)&&(b=this.items.length,this[b]=this.items[b]=a,this.length++);return this},cH.pop=function(){return this.length&&delete this[this.length--],this.items.pop()},cH.forEach=function(a,b){for(var c=0,d=this.items.length;c<d;c++)if(!1===a.call(b,this.items[c],c))return this;return this};for(var cI in cl)cl[g](cI)&&(cH[cI]=function(a){return function(){var b=arguments;return this.forEach(function(c){c[a][m](c,b)})}}(cI));cH.attr=function(b,c){if(b&&a.is(b,E)&&a.is(b[0],"object"))for(var d=0,e=b.length;d<e;d++)this.items[d].attr(b[d]);else for(var f=0,g=this.items.length;f<g;f++)this.items[f].attr(b,c);return this},cH.clear=function(){for(;this.length;)this.pop()},cH.splice=function(a,b,c){a=a<0?x(this.length+a,0):a,b=x(0,y(this.length-a,b));var g,d=[],e=[],f=[];for(g=2;g<arguments.length;g++)f.push(arguments[g]);for(g=0;g<b;g++)e.push(this[a+g]);for(;g<this.length-a;g++)d.push(this[a+g]);var h=f.length;for(g=0;g<h+d.length;g++)this.items[a+g]=this[a+g]=g<h?f[g]:d[g-h];for(g=this.items.length=this.length-=b-h;this[g];)delete this[g++];return new cG(e)},cH.exclude=function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]==a)return this.splice(b,1),!0},cH.animate=function(b,c,d,e){(a.is(d,"function")||!d)&&(e=d||null);var h,j,f=this.items.length,g=f,i=this;if(!f)return this;e&&(j=function(){!--f&&e.call(i)}),d=a.is(d,D)?d:j;var k=a.animation(b,c,d,j);for(h=this.items[--g].animate(k);g--;)this.items[g]&&!this.items[g].removed&&this.items[g].animateWith(h,k,k);return this},cH.insertAfter=function(a){for(var b=this.items.length;b--;)this.items[b].insertAfter(a);return this},cH.getBBox=function(){for(var a=[],b=[],c=[],d=[],e=this.items.length;e--;)if(!this.items[e].removed){var f=this.items[e].getBBox();a.push(f.x),b.push(f.y),c.push(f.x+f.width),d.push(f.y+f.height)}return a=y[m](0,a),b=y[m](0,b),c=x[m](0,c),d=x[m](0,d),{x:a,y:b,x2:c,y2:d,width:c-a,height:d-b}},cH.clone=function(a){a=new cG;for(var b=0,c=this.items.length;b<c;b++)a.push(this.items[b].clone());return a},cH.toString=function(){return"RaphaÃ«lâs set"},a.registerFont=function(a){if(!a.face)return a;this.fonts=this.fonts||{};var b={w:a.w,face:{},glyphs:{}},c=a.face["font-family"];for(var d in a.face)a.face[g](d)&&(b.face[d]=a.face[d]);if(this.fonts[c]?this.fonts[c].push(b):this.fonts[c]=[b],!a.svg){b.face["units-per-em"]=R(a.face["units-per-em"],10);for(var e in a.glyphs)if(a.glyphs[g](e)){var f=a.glyphs[e];if(b.glyphs[e]={w:f.w,k:{},d:f.d&&"M"+f.d.replace(/[mlcxtrv]/g,function(a){return{l:"L",c:"C",x:"z",t:"m",r:"l",v:"c"}[a]||"M"})+"z"},f.k)for(var h in f.k)f[g](h)&&(b.glyphs[e].k[h]=f.k[h])}}return a},k.getFont=function(b,c,d,e){if(e=e||"normal",d=d||"normal",c=+c||{normal:400,bold:700,lighter:300,bolder:800}[c]||400,a.fonts){var f=a.fonts[b];if(!f){var h=new RegExp("(^|\\s)"+b.replace(/[^\w\d\s+!~.:_-]/g,p)+"(\\s|$)","i");for(var i in a.fonts)if(a.fonts[g](i)&&h.test(i)){f=a.fonts[i];break}}var j;if(f)for(var k=0,l=f.length;k<l&&(j=f[k],j.face["font-weight"]!=c||j.face["font-style"]!=d&&j.face["font-style"]||j.face["font-stretch"]!=e);k++);return j}},k.print=function(b,d,e,f,g,h,i){h=h||"middle",i=x(y(i||0,1),-1);var n,j=r(e)[s](p),k=0,l=0,m=p;if(a.is(f,e)&&(f=this.getFont(f)),f){n=(g||16)/f.face["units-per-em"];for(var o=f.face.bbox[s](c),q=+o[0],t=o[3]-o[1],u=0,v=+o[1]+("baseline"==h?t+ +f.face.descent:t/2),w=0,z=j.length;w<z;w++){if("\n"==j[w])k=0,B=0,l=0,u+=t;else{var A=l&&f.glyphs[j[w-1]]||{},B=f.glyphs[j[w]];k+=l?(A.w||f.w)+(A.k&&A.k[j[w]]||0)+f.w*i:0,l=1}B&&B.d&&(m+=a.transformPath(B.d,["t",k*n,u*n,"s",n,n,q,v,"t",(b-q)/n,(d-v)/n]))}}return this.path(m).attr({fill:"#000",stroke:"none"})},k.add=function(b){
if(a.is(b,"array"))for(var h,c=this.set(),e=0,f=b.length;e<f;e++)h=b[e]||{},d[g](h.type)&&c.push(this[h.type]().attr(h));return c},a.format=function(b,c){var d=a.is(c,E)?[0][n](c):arguments;return b&&a.is(b,D)&&d.length-1&&(b=b.replace(e,function(a,b){return null==d[++b]?p:d[b]})),b||p},a.fullfill=function(){var a=/\{([^\}]+)\}/g,b=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,c=function(a,c,d){var e=d;return c.replace(b,function(a,b,c,d,f){b=b||d,e&&(b in e&&(e=e[b]),"function"==typeof e&&f&&(e=e()))}),e=(null==e||e==d?a:e)+""};return function(b,d){return String(b).replace(a,function(a,b){return c(a,b,d)})}}(),a.ninja=function(){return i.was?h.win.Raphael=i.is:delete Raphael,a},a.st=cH,function(b,c,d){function e(){/in/.test(b.readyState)?setTimeout(e,9):a.eve("raphael.DOMload")}null==b.readyState&&b.addEventListener&&(b.addEventListener(c,d=function(){b.removeEventListener(c,d,!1),b.readyState="complete"},!1),b.readyState="loading"),e()}(document,"DOMContentLoaded"),i.was?h.win.Raphael=a:Raphael=a,eve.on("raphael.DOMload",function(){b=!0})}(),window.Raphael.svg&&function(a){var b="hasOwnProperty",c=String,d=parseFloat,e=parseInt,f=Math,g=f.max,h=f.abs,i=f.pow,j=/[, ]+/,k=a.eve,l="",m=" ",n="http://www.w3.org/1999/xlink",o={block:"M5,0 0,2.5 5,5z",classic:"M5,0 0,2.5 5,5 3.5,3 3.5,2z",diamond:"M2.5,0 5,2.5 2.5,5 0,2.5z",open:"M6,1 1,3.5 6,6",oval:"M2.5,0A2.5,2.5,0,0,1,2.5,5 2.5,2.5,0,0,1,2.5,0z"},p={};a.toString=function(){return"Your browser supports SVG.\nYou are running RaphaÃ«l "+this.version};var q=function(d,e){if(e){"string"==typeof d&&(d=q(d));for(var f in e)e[b](f)&&("xlink:"==f.substring(0,6)?d.setAttributeNS(n,f.substring(6),c(e[f])):d.setAttribute(f,c(e[f])))}else d=a._g.doc.createElementNS("http://www.w3.org/2000/svg",d),d.style&&(d.style.webkitTapHighlightColor="rgba(0,0,0,0)");return d},r=function(b,e){var j="linear",k=b.id+e,m=.5,n=.5,o=b.node,p=b.paper,r=o.style,s=a._g.doc.getElementById(k);if(!s){if(e=c(e).replace(a._radial_gradient,function(a,b,c){if(j="radial",b&&c){m=d(b),n=d(c);var e=2*(n>.5)-1;i(m-.5,2)+i(n-.5,2)>.25&&(n=f.sqrt(.25-i(m-.5,2))*e+.5)&&.5!=n&&(n=n.toFixed(5)-1e-5*e)}return l}),e=e.split(/\s*\-\s*/),"linear"==j){var t=e.shift();if(t=-d(t),isNaN(t))return null;var u=[0,0,f.cos(a.rad(t)),f.sin(a.rad(t))],v=1/(g(h(u[2]),h(u[3]))||1);u[2]*=v,u[3]*=v,u[2]<0&&(u[0]=-u[2],u[2]=0),u[3]<0&&(u[1]=-u[3],u[3]=0)}var w=a._parseDots(e);if(!w)return null;if(k=k.replace(/[\(\)\s,\xb0#]/g,"_"),b.gradient&&k!=b.gradient.id&&(p.defs.removeChild(b.gradient),delete b.gradient),!b.gradient){s=q(j+"Gradient",{id:k}),b.gradient=s,q(s,"radial"==j?{fx:m,fy:n}:{x1:u[0],y1:u[1],x2:u[2],y2:u[3],gradientTransform:b.matrix.invert()}),p.defs.appendChild(s);for(var x=0,y=w.length;x<y;x++)s.appendChild(q("stop",{offset:w[x].offset?w[x].offset:x?"100%":"0%","stop-color":w[x].color||"#fff"}))}}return q(o,{fill:"url(#"+k+")",opacity:1,"fill-opacity":1}),r.fill=l,r.opacity=1,r.fillOpacity=1,1},s=function(a){var b=a.getBBox(1);q(a.pattern,{patternTransform:a.matrix.invert()+" translate("+b.x+","+b.y+")"})},t=function(d,e,f){if("path"==d.type){for(var s,t,u,v,w,g=c(e).toLowerCase().split("-"),h=d.paper,i=f?"end":"start",j=d.node,k=d.attrs,m=k["stroke-width"],n=g.length,r="classic",x=3,y=3,z=5;n--;)switch(g[n]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":r=g[n];break;case"wide":y=5;break;case"narrow":y=2;break;case"long":x=5;break;case"short":x=2}if("open"==r?(x+=2,y+=2,z+=2,u=1,v=f?4:1,w={fill:"none",stroke:k.stroke}):(v=u=x/2,w={fill:k.stroke,stroke:"none"}),d._.arrows?f?(d._.arrows.endPath&&p[d._.arrows.endPath]--,d._.arrows.endMarker&&p[d._.arrows.endMarker]--):(d._.arrows.startPath&&p[d._.arrows.startPath]--,d._.arrows.startMarker&&p[d._.arrows.startMarker]--):d._.arrows={},"none"!=r){var A="raphael-marker-"+r,B="raphael-marker-"+i+r+x+y;a._g.doc.getElementById(A)?p[A]++:(h.defs.appendChild(q(q("path"),{"stroke-linecap":"round",d:o[r],id:A})),p[A]=1);var D,C=a._g.doc.getElementById(B);C?(p[B]++,D=C.getElementsByTagName("use")[0]):(C=q(q("marker"),{id:B,markerHeight:y,markerWidth:x,orient:"auto",refX:v,refY:y/2}),D=q(q("use"),{"xlink:href":"#"+A,transform:(f?"rotate(180 "+x/2+" "+y/2+") ":l)+"scale("+x/z+","+y/z+")","stroke-width":(1/((x/z+y/z)/2)).toFixed(4)}),C.appendChild(D),h.defs.appendChild(C),p[B]=1),q(D,w);var F=u*("diamond"!=r&&"oval"!=r);f?(s=d._.arrows.startdx*m||0,t=a.getTotalLength(k.path)-F*m):(s=F*m,t=a.getTotalLength(k.path)-(d._.arrows.enddx*m||0)),w={},w["marker-"+i]="url(#"+B+")",(t||s)&&(w.d=Raphael.getSubpath(k.path,s,t)),q(j,w),d._.arrows[i+"Path"]=A,d._.arrows[i+"Marker"]=B,d._.arrows[i+"dx"]=F,d._.arrows[i+"Type"]=r,d._.arrows[i+"String"]=e}else f?(s=d._.arrows.startdx*m||0,t=a.getTotalLength(k.path)-s):(s=0,t=a.getTotalLength(k.path)-(d._.arrows.enddx*m||0)),d._.arrows[i+"Path"]&&q(j,{d:Raphael.getSubpath(k.path,s,t)}),delete d._.arrows[i+"Path"],delete d._.arrows[i+"Marker"],delete d._.arrows[i+"dx"],delete d._.arrows[i+"Type"],delete d._.arrows[i+"String"];for(w in p)if(p[b](w)&&!p[w]){var G=a._g.doc.getElementById(w);G&&G.parentNode.removeChild(G)}}},u={"":[0],none:[0],"-":[3,1],".":[1,1],"-.":[3,1,1,1],"-..":[3,1,1,1,1,1],". ":[1,3],"- ":[4,3],"--":[8,3],"- .":[4,3,1,3],"--.":[8,3,1,3],"--..":[8,3,1,3,1,3]},v=function(a,b,d){if(b=u[c(b).toLowerCase()]){for(var e=a.attrs["stroke-width"]||"1",f={round:e,square:e,butt:0}[a.attrs["stroke-linecap"]||d["stroke-linecap"]]||0,g=[],h=b.length;h--;)g[h]=b[h]*e+(h%2?1:-1)*f;q(a.node,{"stroke-dasharray":g.join(",")})}},w=function(d,f){var i=d.node,k=d.attrs,m=i.style.visibility;i.style.visibility="hidden";for(var o in f)if(f[b](o)){if(!a._availableAttrs[b](o))continue;var p=f[o];switch(k[o]=p,o){case"blur":d.blur(p);break;case"href":case"title":case"target":var u=i.parentNode;if("a"!=u.tagName.toLowerCase()){var w=q("a");u.insertBefore(w,i),w.appendChild(i),u=w}"target"==o?u.setAttributeNS(n,"show","blank"==p?"new":p):u.setAttributeNS(n,o,p);break;case"cursor":i.style.cursor=p;break;case"transform":d.transform(p);break;case"arrow-start":t(d,p);break;case"arrow-end":t(d,p,1);break;case"clip-rect":var x=c(p).split(j);if(4==x.length){d.clip&&d.clip.parentNode.parentNode.removeChild(d.clip.parentNode);var z=q("clipPath"),A=q("rect");z.id=a.createUUID(),q(A,{x:x[0],y:x[1],width:x[2],height:x[3]}),z.appendChild(A),d.paper.defs.appendChild(z),q(i,{"clip-path":"url(#"+z.id+")"}),d.clip=A}if(!p){var B=i.getAttribute("clip-path");if(B){var C=a._g.doc.getElementById(B.replace(/(^url\(#|\)$)/g,l));C&&C.parentNode.removeChild(C),q(i,{"clip-path":l}),delete d.clip}}break;case"path":"path"==d.type&&(q(i,{d:p?k.path=a._pathToAbsolute(p):"M0,0"}),d._.dirty=1,d._.arrows&&("startString"in d._.arrows&&t(d,d._.arrows.startString),"endString"in d._.arrows&&t(d,d._.arrows.endString,1)));break;case"width":if(i.setAttribute(o,p),d._.dirty=1,!k.fx)break;o="x",p=k.x;case"x":k.fx&&(p=-k.x-(k.width||0));case"rx":if("rx"==o&&"rect"==d.type)break;case"cx":i.setAttribute(o,p),d.pattern&&s(d),d._.dirty=1;break;case"height":if(i.setAttribute(o,p),d._.dirty=1,!k.fy)break;o="y",p=k.y;case"y":k.fy&&(p=-k.y-(k.height||0));case"ry":if("ry"==o&&"rect"==d.type)break;case"cy":i.setAttribute(o,p),d.pattern&&s(d),d._.dirty=1;break;case"r":"rect"==d.type?q(i,{rx:p,ry:p}):i.setAttribute(o,p),d._.dirty=1;break;case"src":"image"==d.type&&i.setAttributeNS(n,"href",p);break;case"stroke-width":1==d._.sx&&1==d._.sy||(p/=g(h(d._.sx),h(d._.sy))||1),d.paper._vbSize&&(p*=d.paper._vbSize),i.setAttribute(o,p),k["stroke-dasharray"]&&v(d,k["stroke-dasharray"],f),d._.arrows&&("startString"in d._.arrows&&t(d,d._.arrows.startString),"endString"in d._.arrows&&t(d,d._.arrows.endString,1));break;case"stroke-dasharray":v(d,p,f);break;case"fill":var D=c(p).match(a._ISURL);if(D){z=q("pattern");var F=q("image");z.id=a.createUUID(),q(z,{x:0,y:0,patternUnits:"userSpaceOnUse",height:1,width:1}),q(F,{x:0,y:0,"xlink:href":D[1]}),z.appendChild(F),function(b){a._preload(D[1],function(){var a=this.offsetWidth,c=this.offsetHeight;q(b,{width:a,height:c}),q(F,{width:a,height:c}),d.paper.safari()})}(z),d.paper.defs.appendChild(z),q(i,{fill:"url(#"+z.id+")"}),d.pattern=z,d.pattern&&s(d);break}var G=a.getRGB(p);if(G.error){if(("circle"==d.type||"ellipse"==d.type||"r"!=c(p).charAt())&&r(d,p)){if("opacity"in k||"fill-opacity"in k){var H=a._g.doc.getElementById(i.getAttribute("fill").replace(/^url\(#|\)$/g,l));if(H){var I=H.getElementsByTagName("stop");q(I[I.length-1],{"stop-opacity":("opacity"in k?k.opacity:1)*("fill-opacity"in k?k["fill-opacity"]:1)})}}k.gradient=p,k.fill="none";break}}else delete f.gradient,delete k.gradient,!a.is(k.opacity,"undefined")&&a.is(f.opacity,"undefined")&&q(i,{opacity:k.opacity}),!a.is(k["fill-opacity"],"undefined")&&a.is(f["fill-opacity"],"undefined")&&q(i,{"fill-opacity":k["fill-opacity"]});G[b]("opacity")&&q(i,{"fill-opacity":G.opacity>1?G.opacity/100:G.opacity});case"stroke":G=a.getRGB(p),i.setAttribute(o,G.hex),"stroke"==o&&G[b]("opacity")&&q(i,{"stroke-opacity":G.opacity>1?G.opacity/100:G.opacity}),"stroke"==o&&d._.arrows&&("startString"in d._.arrows&&t(d,d._.arrows.startString),"endString"in d._.arrows&&t(d,d._.arrows.endString,1));break;case"gradient":("circle"==d.type||"ellipse"==d.type||"r"!=c(p).charAt())&&r(d,p);break;case"opacity":k.gradient&&!k[b]("stroke-opacity")&&q(i,{"stroke-opacity":p>1?p/100:p});case"fill-opacity":if(k.gradient){(H=a._g.doc.getElementById(i.getAttribute("fill").replace(/^url\(#|\)$/g,l)))&&(I=H.getElementsByTagName("stop"),q(I[I.length-1],{"stop-opacity":p}));break}default:"font-size"==o&&(p=e(p,10)+"px");var J=o.replace(/(\-.)/g,function(a){return a.substring(1).toUpperCase()});i.style[J]=p,d._.dirty=1,i.setAttribute(o,p)}}y(d,f),i.style.visibility=m},y=function(d,f){if("text"==d.type&&(f[b]("text")||f[b]("font")||f[b]("font-size")||f[b]("x")||f[b]("y"))){var g=d.attrs,h=d.node,i=h.firstChild?e(a._g.doc.defaultView.getComputedStyle(h.firstChild,l).getPropertyValue("font-size"),10):10;if(f[b]("text")){for(g.text=f.text;h.firstChild;)h.removeChild(h.firstChild);for(var m,j=c(f.text).split("\n"),k=[],n=0,o=j.length;n<o;n++)m=q("tspan"),n&&q(m,{dy:1.2*i,x:g.x}),m.appendChild(a._g.doc.createTextNode(j[n])),h.appendChild(m),k[n]=m}else for(k=h.getElementsByTagName("tspan"),n=0,o=k.length;n<o;n++)n?q(k[n],{dy:1.2*i,x:g.x}):q(k[0],{dy:0});q(h,{x:g.x,y:g.y}),d._.dirty=1;var p=d._getBBox(),r=g.y-(p.y+p.height/2);r&&a.is(r,"finite")&&q(k[0],{dy:r})}},z=function(b,c){this[0]=this.node=b,b.raphael=!0,this.id=a._oid++,b.raphaelid=this.id,this.matrix=a.matrix(),this.realPath=null,this.paper=c,this.attrs=this.attrs||{},this._={transform:[],sx:1,sy:1,deg:0,dx:0,dy:0,dirty:1},!c.bottom&&(c.bottom=this),this.prev=c.top,c.top&&(c.top.next=this),c.top=this,this.next=null},A=a.el;z.prototype=A,A.constructor=z,a._engine.path=function(a,b){var c=q("path");b.canvas&&b.canvas.appendChild(c);var d=new z(c,b);return d.type="path",w(d,{fill:"none",stroke:"#000",path:a}),d},A.rotate=function(a,b,e){if(this.removed)return this;if(a=c(a).split(j),a.length-1&&(b=d(a[1]),e=d(a[2])),a=d(a[0]),null==e&&(b=e),null==b||null==e){var f=this.getBBox(1);b=f.x+f.width/2,e=f.y+f.height/2}return this.transform(this._.transform.concat([["r",a,b,e]])),this},A.scale=function(a,b,e,f){if(this.removed)return this;if(a=c(a).split(j),a.length-1&&(b=d(a[1]),e=d(a[2]),f=d(a[3])),a=d(a[0]),null==b&&(b=a),null==f&&(e=f),null==e||null==f)var g=this.getBBox(1);return e=null==e?g.x+g.width/2:e,f=null==f?g.y+g.height/2:f,this.transform(this._.transform.concat([["s",a,b,e,f]])),this},A.translate=function(a,b){return this.removed?this:(a=c(a).split(j),a.length-1&&(b=d(a[1])),a=d(a[0])||0,b=+b||0,this.transform(this._.transform.concat([["t",a,b]])),this)},A.transform=function(c){var d=this._;if(null==c)return d.transform;if(a._extractTransform(this,c),this.clip&&q(this.clip,{transform:this.matrix.invert()}),this.pattern&&s(this),this.node&&q(this.node,{transform:this.matrix}),1!=d.sx||1!=d.sy){var e=this.attrs[b]("stroke-width")?this.attrs["stroke-width"]:1;this.attr({"stroke-width":e})}return this},A.hide=function(){return!this.removed&&this.paper.safari(this.node.style.display="none"),this},A.show=function(){return!this.removed&&this.paper.safari(this.node.style.display=""),this},A.remove=function(){if(!this.removed&&this.node.parentNode){var b=this.paper;b.__set__&&b.__set__.exclude(this),k.unbind("raphael.*.*."+this.id),this.gradient&&b.defs.removeChild(this.gradient),a._tear(this,b),"a"==this.node.parentNode.tagName.toLowerCase()?this.node.parentNode.parentNode.removeChild(this.node.parentNode):this.node.parentNode.removeChild(this.node);for(var c in this)this[c]="function"==typeof this[c]?a._removedFactory(c):null;this.removed=!0}},A._getBBox=function(){if("none"==this.node.style.display){this.show();var a=!0}var b={};try{b=this.node.getBBox()}catch(c){}finally{b=b||{}}return a&&this.hide(),b},A.attr=function(c,d){if(this.removed)return this;if(null==c){var e={};for(var f in this.attrs)this.attrs[b](f)&&(e[f]=this.attrs[f]);return e.gradient&&"none"==e.fill&&(e.fill=e.gradient)&&delete e.gradient,e.transform=this._.transform,e}if(null==d&&a.is(c,"string")){if("fill"==c&&"none"==this.attrs.fill&&this.attrs.gradient)return this.attrs.gradient;if("transform"==c)return this._.transform;for(var g=c.split(j),h={},i=0,l=g.length;i<l;i++)c=g[i],c in this.attrs?h[c]=this.attrs[c]:a.is(this.paper.customAttributes[c],"function")?h[c]=this.paper.customAttributes[c].def:h[c]=a._availableAttrs[c];return l-1?h:h[g[0]]}if(null==d&&a.is(c,"array")){for(h={},i=0,l=c.length;i<l;i++)h[c[i]]=this.attr(c[i]);return h}if(null!=d){var m={};m[c]=d}else null!=c&&a.is(c,"object")&&(m=c);for(var n in m)k("raphael.attr."+n+"."+this.id,this,m[n]);for(n in this.paper.customAttributes)if(this.paper.customAttributes[b](n)&&m[b](n)&&a.is(this.paper.customAttributes[n],"function")){var o=this.paper.customAttributes[n].apply(this,[].concat(m[n]));this.attrs[n]=m[n];for(var p in o)o[b](p)&&(m[p]=o[p])}return w(this,m),this},A.toFront=function(){if(this.removed)return this;"a"==this.node.parentNode.tagName.toLowerCase()?this.node.parentNode.parentNode.appendChild(this.node.parentNode):this.node.parentNode.appendChild(this.node);var b=this.paper;return b.top!=this&&a._tofront(this,b),this},A.toBack=function(){if(this.removed)return this;var b=this.node.parentNode;"a"==b.tagName.toLowerCase()?b.parentNode.insertBefore(this.node.parentNode,this.node.parentNode.parentNode.firstChild):b.firstChild!=this.node&&b.insertBefore(this.node,this.node.parentNode.firstChild),a._toback(this,this.paper);this.paper;return this},A.insertAfter=function(b){if(this.removed)return this;var c=b.node||b[b.length-1].node;return c.nextSibling?c.parentNode.insertBefore(this.node,c.nextSibling):c.parentNode.appendChild(this.node),a._insertafter(this,b,this.paper),this},A.insertBefore=function(b){if(this.removed)return this;var c=b.node||b[0].node;return c.parentNode.insertBefore(this.node,c),a._insertbefore(this,b,this.paper),this},A.blur=function(b){var c=this;if(0!=+b){var d=q("filter"),e=q("feGaussianBlur");c.attrs.blur=b,d.id=a.createUUID(),q(e,{stdDeviation:+b||1.5}),d.appendChild(e),c.paper.defs.appendChild(d),c._blur=d,q(c.node,{filter:"url(#"+d.id+")"})}else c._blur&&(c._blur.parentNode.removeChild(c._blur),delete c._blur,delete c.attrs.blur),c.node.removeAttribute("filter")},a._engine.circle=function(a,b,c,d){var e=q("circle");a.canvas&&a.canvas.appendChild(e);var f=new z(e,a);return f.attrs={cx:b,cy:c,r:d,fill:"none",stroke:"#000"},f.type="circle",q(e,f.attrs),f},a._engine.rect=function(a,b,c,d,e,f){var g=q("rect");a.canvas&&a.canvas.appendChild(g);var h=new z(g,a);return h.attrs={x:b,y:c,width:d,height:e,r:f||0,rx:f||0,ry:f||0,fill:"none",stroke:"#000"},h.type="rect",q(g,h.attrs),h},a._engine.ellipse=function(a,b,c,d,e){var f=q("ellipse");a.canvas&&a.canvas.appendChild(f);var g=new z(f,a);return g.attrs={cx:b,cy:c,rx:d,ry:e,fill:"none",stroke:"#000"},g.type="ellipse",q(f,g.attrs),g},a._engine.image=function(a,b,c,d,e,f){var g=q("image");q(g,{x:c,y:d,width:e,height:f,preserveAspectRatio:"none"}),g.setAttributeNS(n,"href",b),a.canvas&&a.canvas.appendChild(g);var h=new z(g,a);return h.attrs={x:c,y:d,width:e,height:f,src:b},h.type="image",h},a._engine.text=function(b,c,d,e){var f=q("text");b.canvas&&b.canvas.appendChild(f);var g=new z(f,b);return g.attrs={x:c,y:d,"text-anchor":"middle",text:e,font:a._availableAttrs.font,stroke:"none",fill:"#000"},g.type="text",w(g,g.attrs),g},a._engine.setSize=function(a,b){return this.width=a||this.width,this.height=b||this.height,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this._viewBox&&this.setViewBox.apply(this,this._viewBox),this},a._engine.create=function(){var b=a._getContainer.apply(0,arguments),c=b&&b.container,d=b.x,e=b.y,f=b.width,g=b.height;if(!c)throw new Error("SVG container not found.");var j,h=q("svg"),i="overflow:hidden;";return d=d||0,e=e||0,f=f||512,g=g||342,q(h,{height:g,version:1.1,width:f,xmlns:"http://www.w3.org/2000/svg"}),1==c?(h.style.cssText=i+"position:absolute;left:"+d+"px;top:"+e+"px",a._g.doc.body.appendChild(h),j=1):(h.style.cssText=i+"position:relative",c.firstChild?c.insertBefore(h,c.firstChild):c.appendChild(h)),c=new a._Paper,c.width=f,c.height=g,c.canvas=h,c.clear(),c._left=c._top=0,j&&(c.renderfix=function(){}),c.renderfix(),c},a._engine.setViewBox=function(a,b,c,d,e){k("raphael.setViewBox",this,this._viewBox,[a,b,c,d,e]);var j,l,f=g(c/this.width,d/this.height),h=this.top,i=e?"meet":"xMinYMin";for(null==a?(this._vbSize&&(f=1),delete this._vbSize,j="0 0 "+this.width+m+this.height):(this._vbSize=f,j=a+m+b+m+c+m+d),q(this.canvas,{viewBox:j,preserveAspectRatio:i});f&&h;)l="stroke-width"in h.attrs?h.attrs["stroke-width"]:1,h.attr({"stroke-width":l}),h._.dirty=1,h._.dirtyT=1,h=h.prev;return this._viewBox=[a,b,c,d,!!e],this},a.prototype.renderfix=function(){var c,a=this.canvas,b=a.style;try{c=a.getScreenCTM()||a.createSVGMatrix()}catch(d){c=a.createSVGMatrix()}var e=-c.e%1,f=-c.f%1;(e||f)&&(e&&(this._left=(this._left+e)%1,b.left=this._left+"px"),f&&(this._top=(this._top+f)%1,b.top=this._top+"px"))},a.prototype.clear=function(){a.eve("raphael.clear",this);for(var b=this.canvas;b.firstChild;)b.removeChild(b.firstChild);this.bottom=this.top=null,(this.desc=q("desc")).appendChild(a._g.doc.createTextNode("Created with RaphaÃ«l "+a.version)),b.appendChild(this.desc),b.appendChild(this.defs=q("defs"))},a.prototype.remove=function(){k("raphael.remove",this),this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);for(var b in this)this[b]="function"==typeof this[b]?a._removedFactory(b):null};var B=a.st;for(var C in A)A[b](C)&&!B[b](C)&&(B[C]=function(a){return function(){var b=arguments;return this.forEach(function(c){c[a].apply(c,b)})}}(C))}(window.Raphael),window.Raphael.vml&&function(a){var b="hasOwnProperty",c=String,d=parseFloat,e=Math,f=e.round,g=e.max,h=e.min,i=e.abs,j="fill",k=/[, ]+/,l=a.eve,n=" ",o="",p={M:"m",L:"l",C:"c",Z:"x",m:"t",l:"r",c:"v",z:"x"},q=/([clmz]),?([^clmz]*)/gi,r=/ progid:\S+Blur\([^\)]+\)/g,s=/-?[^,\s-]+/g,t="position:absolute;left:0;top:0;width:1px;height:1px",u=21600,v={path:1,rect:1,image:1},w={circle:1,ellipse:1},x=function(b){var d=/[ahqstv]/gi,e=a._pathToAbsolute;if(c(b).match(d)&&(e=a._path2curve),d=/[clmz]/g,e==a._pathToAbsolute&&!c(b).match(d)){var g=c(b).replace(q,function(a,b,c){var d=[],e="m"==b.toLowerCase(),g=p[b];return c.replace(s,function(a){e&&2==d.length&&(g+=d+p["m"==b?"l":"L"],d=[]),d.push(f(a*u))}),g+d});return g}var i,j,h=e(b);g=[];for(var k=0,l=h.length;k<l;k++){i=h[k],"z"==(j=h[k][0].toLowerCase())&&(j="x");for(var m=1,r=i.length;m<r;m++)j+=f(i[m]*u)+(m!=r-1?",":o);g.push(j)}return g.join(n)},y=function(b,c,d){var e=a.matrix();return e.rotate(-b,.5,.5),{dx:e.x(c,d),dy:e.y(c,d)}},z=function(a,b,c,d,e,f){var g=a._,h=a.matrix,k=g.fillpos,l=a.node,m=l.style,o=1,p="",r=u/b,s=u/c;if(m.visibility="hidden",b&&c){if(l.coordsize=i(r)+n+i(s),m.rotation=f*(b*c<0?-1:1),f){var t=y(f,d,e);d=t.dx,e=t.dy}if(b<0&&(p+="x"),c<0&&(p+=" y")&&(o=-1),m.flip=p,l.coordorigin=d*-r+n+e*-s,k||g.fillsize){var v=l.getElementsByTagName(j);v=v&&v[0],l.removeChild(v),k&&(t=y(f,h.x(k[0],k[1]),h.y(k[0],k[1])),v.position=t.dx*o+n+t.dy*o),g.fillsize&&(v.size=g.fillsize[0]*i(b)+n+g.fillsize[1]*i(c)),l.appendChild(v)}m.visibility="visible"}};a.toString=function(){return"Your browser doesnât support SVG. Falling down to VML.\nYou are running RaphaÃ«l "+this.version};var A=function(a,b,d){for(var e=c(b).toLowerCase().split("-"),f=d?"end":"start",g=e.length,h="classic",i="medium",j="medium";g--;)switch(e[g]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":h=e[g];break;case"wide":case"narrow":j=e[g];break;case"long":case"short":i=e[g]}var k=a.node.getElementsByTagName("stroke")[0];k[f+"arrow"]=h,k[f+"arrowlength"]=i,k[f+"arrowwidth"]=j},B=function(e,i){e.attrs=e.attrs||{};var l=e.node,m=e.attrs,p=l.style,r=v[e.type]&&(i.x!=m.x||i.y!=m.y||i.width!=m.width||i.height!=m.height||i.cx!=m.cx||i.cy!=m.cy||i.rx!=m.rx||i.ry!=m.ry||i.r!=m.r),s=w[e.type]&&(m.cx!=i.cx||m.cy!=i.cy||m.r!=i.r||m.rx!=i.rx||m.ry!=i.ry),t=e;for(var y in i)i[b](y)&&(m[y]=i[y]);if(r&&(m.path=a._getPath[e.type](e),e._.dirty=1),i.href&&(l.href=i.href),i.title&&(l.title=i.title),i.target&&(l.target=i.target),i.cursor&&(p.cursor=i.cursor),"blur"in i&&e.blur(i.blur),(i.path&&"path"==e.type||r)&&(l.path=x(~c(m.path).toLowerCase().indexOf("r")?a._pathToAbsolute(m.path):m.path),"image"==e.type&&(e._.fillpos=[m.x,m.y],e._.fillsize=[m.width,m.height],z(e,1,1,0,0,0))),"transform"in i&&e.transform(i.transform),s){var B=+m.cx,D=+m.cy,E=+m.rx||+m.r||0,G=+m.ry||+m.r||0;l.path=a.format("ar{0},{1},{2},{3},{4},{1},{4},{1}x",f((B-E)*u),f((D-G)*u),f((B+E)*u),f((D+G)*u),f(B*u))}if("clip-rect"in i){var H=c(i["clip-rect"]).split(k);if(4==H.length){H[2]=+H[2]+ +H[0],H[3]=+H[3]+ +H[1];var I=l.clipRect||a._g.doc.createElement("div"),J=I.style;J.clip=a.format("rect({1}px {2}px {3}px {0}px)",H),l.clipRect||(J.position="absolute",J.top=0,J.left=0,J.width=e.paper.width+"px",J.height=e.paper.height+"px",l.parentNode.insertBefore(I,l),I.appendChild(l),l.clipRect=I)}i["clip-rect"]||l.clipRect&&(l.clipRect.style.clip="auto")}if(e.textpath){var K=e.textpath.style;i.font&&(K.font=i.font),i["font-family"]&&(K.fontFamily='"'+i["font-family"].split(",")[0].replace(/^['"]+|['"]+$/g,o)+'"'),i["font-size"]&&(K.fontSize=i["font-size"]),i["font-weight"]&&(K.fontWeight=i["font-weight"]),i["font-style"]&&(K.fontStyle=i["font-style"])}if("arrow-start"in i&&A(t,i["arrow-start"]),"arrow-end"in i&&A(t,i["arrow-end"],1),null!=i.opacity||null!=i["stroke-width"]||null!=i.fill||null!=i.src||null!=i.stroke||null!=i["stroke-width"]||null!=i["stroke-opacity"]||null!=i["fill-opacity"]||null!=i["stroke-dasharray"]||null!=i["stroke-miterlimit"]||null!=i["stroke-linejoin"]||null!=i["stroke-linecap"]){var L=l.getElementsByTagName(j);if(L=L&&L[0],!L&&(L=F(j)),"image"==e.type&&i.src&&(L.src=i.src),i.fill&&(L.on=!0),null!=L.on&&"none"!=i.fill&&null!==i.fill||(L.on=!1),L.on&&i.fill){var N=c(i.fill).match(a._ISURL);if(N){L.parentNode==l&&l.removeChild(L),L.rotate=!0,L.src=N[1],L.type="tile";var O=e.getBBox(1);L.position=O.x+n+O.y,e._.fillpos=[O.x,O.y],a._preload(N[1],function(){e._.fillsize=[this.offsetWidth,this.offsetHeight]})}else L.color=a.getRGB(i.fill).hex,L.src=o,L.type="solid",a.getRGB(i.fill).error&&(t.type in{circle:1,ellipse:1}||"r"!=c(i.fill).charAt())&&C(t,i.fill,L)&&(m.fill="none",m.gradient=i.fill,L.rotate=!1)}if("fill-opacity"in i||"opacity"in i){var P=((+m["fill-opacity"]+1||2)-1)*((+m.opacity+1||2)-1)*((+a.getRGB(i.fill).o+1||2)-1);P=h(g(P,0),1),L.opacity=P,L.src&&(L.color="none")}l.appendChild(L);var Q=l.getElementsByTagName("stroke")&&l.getElementsByTagName("stroke")[0],T=!1;!Q&&(T=Q=F("stroke")),(i.stroke&&"none"!=i.stroke||i["stroke-width"]||null!=i["stroke-opacity"]||i["stroke-dasharray"]||i["stroke-miterlimit"]||i["stroke-linejoin"]||i["stroke-linecap"])&&(Q.on=!0),("none"==i.stroke||null===i.stroke||null==Q.on||0==i.stroke||0==i["stroke-width"])&&(Q.on=!1);var U=a.getRGB(i.stroke);Q.on&&i.stroke&&(Q.color=U.hex),P=((+m["stroke-opacity"]+1||2)-1)*((+m.opacity+1||2)-1)*((+U.o+1||2)-1);var V=.75*(d(i["stroke-width"])||1);if(P=h(g(P,0),1),null==i["stroke-width"]&&(V=m["stroke-width"]),i["stroke-width"]&&(Q.weight=V),V&&V<1&&(P*=V)&&(Q.weight=1),Q.opacity=P,i["stroke-linejoin"]&&(Q.joinstyle=i["stroke-linejoin"]||"miter"),Q.miterlimit=i["stroke-miterlimit"]||8,i["stroke-linecap"]&&(Q.endcap="butt"==i["stroke-linecap"]?"flat":"square"==i["stroke-linecap"]?"square":"round"),i["stroke-dasharray"]){var W={"-":"shortdash",".":"shortdot","-.":"shortdashdot","-..":"shortdashdotdot",". ":"dot","- ":"dash","--":"longdash","- .":"dashdot","--.":"longdashdot","--..":"longdashdotdot"};Q.dashstyle=W[b](i["stroke-dasharray"])?W[i["stroke-dasharray"]]:o}T&&l.appendChild(Q)}if("text"==t.type){t.paper.canvas.style.display=o;var X=t.paper.span,Z=m.font&&m.font.match(/\d+(?:\.\d*)?(?=px)/);p=X.style,m.font&&(p.font=m.font),m["font-family"]&&(p.fontFamily=m["font-family"]),m["font-weight"]&&(p.fontWeight=m["font-weight"]),m["font-style"]&&(p.fontStyle=m["font-style"]),Z=d(m["font-size"]||Z&&Z[0])||10,p.fontSize=100*Z+"px",t.textpath.string&&(X.innerHTML=c(t.textpath.string).replace(/</g,"&#60;").replace(/&/g,"&#38;").replace(/\n/g,"<br>"));var $=X.getBoundingClientRect();t.W=m.w=($.right-$.left)/100,t.H=m.h=($.bottom-$.top)/100,t.X=m.x,t.Y=m.y+t.H/2,("x"in i||"y"in i)&&(t.path.v=a.format("m{0},{1}l{2},{1}",f(m.x*u),f(m.y*u),f(m.x*u)+1));for(var _=["x","y","text","font","font-family","font-weight","font-style","font-size"],ba=0,bb=_.length;ba<bb;ba++)if(_[ba]in i){t._.dirty=1;break}switch(m["text-anchor"]){case"start":t.textpath.style["v-text-align"]="left",t.bbx=t.W/2;break;case"end":t.textpath.style["v-text-align"]="right",t.bbx=-t.W/2;break;default:t.textpath.style["v-text-align"]="center",t.bbx=0}t.textpath.style["v-text-kern"]=!0}},C=function(b,f,g){b.attrs=b.attrs||{};var i=(b.attrs,Math.pow),l="linear",m=".5 .5";if(b.attrs.gradient=f,f=c(f).replace(a._radial_gradient,function(a,b,c){return l="radial",b&&c&&(b=d(b),c=d(c),i(b-.5,2)+i(c-.5,2)>.25&&(c=e.sqrt(.25-i(b-.5,2))*(2*(c>.5)-1)+.5),m=b+n+c),o}),f=f.split(/\s*\-\s*/),"linear"==l){var p=f.shift();if(p=-d(p),isNaN(p))return null}var q=a._parseDots(f);if(!q)return null;if(b=b.shape||b.node,q.length){b.removeChild(g),g.on=!0,g.method="none",g.color=q[0].color,g.color2=q[q.length-1].color;for(var r=[],s=0,t=q.length;s<t;s++)q[s].offset&&r.push(q[s].offset+n+q[s].color);g.colors=r.length?r.join():"0% "+g.color,"radial"==l?(g.type="gradientTitle",g.focus="100%",g.focussize="0 0",g.focusposition=m,g.angle=0):(g.type="gradient",g.angle=(270-p)%360),b.appendChild(g)}return 1},D=function(b,c){this[0]=this.node=b,b.raphael=!0,this.id=a._oid++,b.raphaelid=this.id,this.X=0,this.Y=0,this.attrs={},this.paper=c,this.matrix=a.matrix(),this._={transform:[],sx:1,sy:1,dx:0,dy:0,deg:0,dirty:1,dirtyT:1},!c.bottom&&(c.bottom=this),this.prev=c.top,c.top&&(c.top.next=this),c.top=this,this.next=null},E=a.el;D.prototype=E,E.constructor=D,E.transform=function(b){if(null==b)return this._.transform;var f,d=this.paper._viewBoxShift,e=d?"s"+[d.scale,d.scale]+"-1-1t"+[d.dx,d.dy]:o;d&&(f=b=c(b).replace(/\.{3}|\u2026/g,this._.transform||o)),a._extractTransform(this,e+b);var j,g=this.matrix.clone(),h=this.skew,i=this.node,k=~c(this.attrs.fill).indexOf("-"),l=!c(this.attrs.fill).indexOf("url(");if(g.translate(-.5,-.5),l||k||"image"==this.type)if(h.matrix="1 0 0 1",h.offset="0 0",j=g.split(),k&&j.noRotation||!j.isSimple){i.style.filter=g.toFilter();var m=this.getBBox(),p=this.getBBox(1),q=m.x-p.x,r=m.y-p.y;i.coordorigin=q*-u+n+r*-u,z(this,1,1,q,r,0)}else i.style.filter=o,z(this,j.scalex,j.scaley,j.dx,j.dy,j.rotate);else i.style.filter=o,h.matrix=c(g),h.offset=g.offset();return f&&(this._.transform=f),this},E.rotate=function(a,b,e){if(this.removed)return this;if(null!=a){if(a=c(a).split(k),a.length-1&&(b=d(a[1]),e=d(a[2])),a=d(a[0]),null==e&&(b=e),null==b||null==e){var f=this.getBBox(1);b=f.x+f.width/2,e=f.y+f.height/2}return this._.dirtyT=1,this.transform(this._.transform.concat([["r",a,b,e]])),this}},E.translate=function(a,b){return this.removed?this:(a=c(a).split(k),a.length-1&&(b=d(a[1])),a=d(a[0])||0,b=+b||0,this._.bbox&&(this._.bbox.x+=a,this._.bbox.y+=b),this.transform(this._.transform.concat([["t",a,b]])),this)},E.scale=function(a,b,e,f){if(this.removed)return this;if(a=c(a).split(k),a.length-1&&(b=d(a[1]),e=d(a[2]),f=d(a[3]),isNaN(e)&&(e=null),isNaN(f)&&(f=null)),a=d(a[0]),null==b&&(b=a),null==f&&(e=f),null==e||null==f)var g=this.getBBox(1);return e=null==e?g.x+g.width/2:e,f=null==f?g.y+g.height/2:f,this.transform(this._.transform.concat([["s",a,b,e,f]])),this._.dirtyT=1,this},E.hide=function(){return!this.removed&&(this.node.style.display="none"),this},E.show=function(){return!this.removed&&(this.node.style.display=o),this},E._getBBox=function(){return this.removed?{}:{x:this.X+(this.bbx||0)-this.W/2,y:this.Y-this.H,width:this.W,height:this.H}},E.remove=function(){if(!this.removed&&this.node.parentNode){this.paper.__set__&&this.paper.__set__.exclude(this),a.eve.unbind("raphael.*.*."+this.id),a._tear(this,this.paper),this.node.parentNode.removeChild(this.node),this.shape&&this.shape.parentNode.removeChild(this.shape);for(var b in this)this[b]="function"==typeof this[b]?a._removedFactory(b):null;this.removed=!0}},E.attr=function(c,d){if(this.removed)return this;if(null==c){var e={};for(var f in this.attrs)this.attrs[b](f)&&(e[f]=this.attrs[f]);return e.gradient&&"none"==e.fill&&(e.fill=e.gradient)&&delete e.gradient,e.transform=this._.transform,e}if(null==d&&a.is(c,"string")){if(c==j&&"none"==this.attrs.fill&&this.attrs.gradient)return this.attrs.gradient;for(var g=c.split(k),h={},i=0,m=g.length;i<m;i++)c=g[i],c in this.attrs?h[c]=this.attrs[c]:a.is(this.paper.customAttributes[c],"function")?h[c]=this.paper.customAttributes[c].def:h[c]=a._availableAttrs[c];return m-1?h:h[g[0]]}if(this.attrs&&null==d&&a.is(c,"array")){for(h={},i=0,m=c.length;i<m;i++)h[c[i]]=this.attr(c[i]);return h}var n;null!=d&&(n={},n[c]=d),null==d&&a.is(c,"object")&&(n=c);for(var o in n)l("raphael.attr."+o+"."+this.id,this,n[o]);if(n){for(o in this.paper.customAttributes)if(this.paper.customAttributes[b](o)&&n[b](o)&&a.is(this.paper.customAttributes[o],"function")){var p=this.paper.customAttributes[o].apply(this,[].concat(n[o]));this.attrs[o]=n[o];for(var q in p)p[b](q)&&(n[q]=p[q])}n.text&&"text"==this.type&&(this.textpath.string=n.text),B(this,n)}return this},E.toFront=function(){return!this.removed&&this.node.parentNode.appendChild(this.node),this.paper&&this.paper.top!=this&&a._tofront(this,this.paper),this},E.toBack=function(){return this.removed?this:(this.node.parentNode.firstChild!=this.node&&(this.node.parentNode.insertBefore(this.node,this.node.parentNode.firstChild),a._toback(this,this.paper)),this)},E.insertAfter=function(b){return this.removed?this:(b.constructor==a.st.constructor&&(b=b[b.length-1]),b.node.nextSibling?b.node.parentNode.insertBefore(this.node,b.node.nextSibling):b.node.parentNode.appendChild(this.node),a._insertafter(this,b,this.paper),this)},E.insertBefore=function(b){return this.removed?this:(b.constructor==a.st.constructor&&(b=b[0]),b.node.parentNode.insertBefore(this.node,b.node),a._insertbefore(this,b,this.paper),this)},E.blur=function(b){var c=this.node.runtimeStyle,d=c.filter;d=d.replace(r,o),0!=+b?(this.attrs.blur=b,c.filter=d+n+" progid:DXImageTransform.Microsoft.Blur(pixelradius="+(+b||1.5)+")",c.margin=a.format("-{0}px 0 0 -{0}px",f(+b||1.5))):(c.filter=d,c.margin=0,delete this.attrs.blur)},a._engine.path=function(a,b){var c=F("shape");c.style.cssText=t,c.coordsize=u+n+u,c.coordorigin=b.coordorigin;var d=new D(c,b),e={fill:"none",stroke:"#000"};a&&(e.path=a),d.type="path",d.path=[],d.Path=o,B(d,e),b.canvas.appendChild(c);var f=F("skew");return f.on=!0,c.appendChild(f),d.skew=f,d.transform(o),d},
a._engine.rect=function(b,c,d,e,f,g){var h=a._rectPath(c,d,e,f,g),i=b.path(h),j=i.attrs;return i.X=j.x=c,i.Y=j.y=d,i.W=j.width=e,i.H=j.height=f,j.r=g,j.path=h,i.type="rect",i},a._engine.ellipse=function(a,b,c,d,e){var f=a.path();f.attrs;return f.X=b-d,f.Y=c-e,f.W=2*d,f.H=2*e,f.type="ellipse",B(f,{cx:b,cy:c,rx:d,ry:e}),f},a._engine.circle=function(a,b,c,d){var e=a.path();e.attrs;return e.X=b-d,e.Y=c-d,e.W=e.H=2*d,e.type="circle",B(e,{cx:b,cy:c,r:d}),e},a._engine.image=function(b,c,d,e,f,g){var h=a._rectPath(d,e,f,g),i=b.path(h).attr({stroke:"none"}),k=i.attrs,l=i.node,m=l.getElementsByTagName(j)[0];return k.src=c,i.X=k.x=d,i.Y=k.y=e,i.W=k.width=f,i.H=k.height=g,k.path=h,i.type="image",m.parentNode==l&&l.removeChild(m),m.rotate=!0,m.src=c,m.type="tile",i._.fillpos=[d,e],i._.fillsize=[f,g],l.appendChild(m),z(i,1,1,0,0,0),i},a._engine.text=function(b,d,e,g){var h=F("shape"),i=F("path"),j=F("textpath");d=d||0,e=e||0,g=g||"",i.v=a.format("m{0},{1}l{2},{1}",f(d*u),f(e*u),f(d*u)+1),i.textpathok=!0,j.string=c(g),j.on=!0,h.style.cssText=t,h.coordsize=u+n+u,h.coordorigin="0 0";var k=new D(h,b),l={fill:"#000",stroke:"none",font:a._availableAttrs.font,text:g};k.shape=h,k.path=i,k.textpath=j,k.type="text",k.attrs.text=c(g),k.attrs.x=d,k.attrs.y=e,k.attrs.w=1,k.attrs.h=1,B(k,l),h.appendChild(j),h.appendChild(i),b.canvas.appendChild(h);var m=F("skew");return m.on=!0,h.appendChild(m),k.skew=m,k.transform(o),k},a._engine.setSize=function(b,c){var d=this.canvas.style;return this.width=b,this.height=c,b==+b&&(b+="px"),c==+c&&(c+="px"),d.width=b,d.height=c,d.clip="rect(0 "+b+" "+c+" 0)",this._viewBox&&a._engine.setViewBox.apply(this,this._viewBox),this},a._engine.setViewBox=function(b,c,d,e,f){a.eve("raphael.setViewBox",this,this._viewBox,[b,c,d,e,f]);var k,l,h=this.width,i=this.height,j=1/g(d/h,e/i);return f&&(k=i/e,l=h/d,d*k<h&&(b-=(h-d*k)/2/k),e*l<i&&(c-=(i-e*l)/2/l)),this._viewBox=[b,c,d,e,!!f],this._viewBoxShift={dx:-b,dy:-c,scale:j},this.forEach(function(a){a.transform("...")}),this};var F;a._engine.initWin=function(a){var b=a.document;b.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)");try{!b.namespaces.rvml&&b.namespaces.add("rvml","urn:schemas-microsoft-com:vml"),F=function(a){return b.createElement("<rvml:"+a+' class="rvml">')}}catch(c){F=function(a){return b.createElement("<"+a+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">')}}},a._engine.initWin(a._g.win),a._engine.create=function(){var b=a._getContainer.apply(0,arguments),c=b.container,d=b.height,f=b.width,g=b.x,h=b.y;if(!c)throw new Error("VML container not found.");var i=new a._Paper,j=i.canvas=a._g.doc.createElement("div"),k=j.style;return g=g||0,h=h||0,f=f||512,d=d||342,i.width=f,i.height=d,f==+f&&(f+="px"),d==+d&&(d+="px"),i.coordsize=216e5+n+216e5,i.coordorigin="0 0",i.span=a._g.doc.createElement("span"),i.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;",j.appendChild(i.span),k.cssText=a.format("top:0;left:0;width:{0};height:{1};display:inline-block;position:relative;clip:rect(0 {0} {1} 0);overflow:hidden",f,d),1==c?(a._g.doc.body.appendChild(j),k.left=g+"px",k.top=h+"px",k.position="absolute"):c.firstChild?c.insertBefore(j,c.firstChild):c.appendChild(j),i.renderfix=function(){},i},a.prototype.clear=function(){a.eve("raphael.clear",this),this.canvas.innerHTML=o,this.span=a._g.doc.createElement("span"),this.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;",this.canvas.appendChild(this.span),this.bottom=this.top=null},a.prototype.remove=function(){a.eve("raphael.remove",this),this.canvas.parentNode.removeChild(this.canvas);for(var b in this)this[b]="function"==typeof this[b]?a._removedFactory(b):null;return!0};var G=a.st;for(var H in E)E[b](H)&&!G[b](H)&&(G[H]=function(a){return function(){var b=arguments;return this.forEach(function(c){c[a].apply(c,b)})}}(H))}(window.Raphael),"undefined"!=typeof exports&&(exports.erase=erase);function erase(paths,erasePath,eraseRadius){eraseRadius=eraseRadius||20;var newPaths=[];if(erasePath.points=cleanPath(erasePath.points),1===erasePath.points.length){for(var p=0;p<paths.length;p++)!function(path){var eX=erasePath.points[0][0],eY=erasePath.points[0][1],i=0,last=0;if(1===path.points.length&&!withinCircle(path.points[0][0],path.points[0][1],eX,eY,eraseRadius))return void newPaths.push(path);for(var newPath;i<path.points.length-1;){var p0=path.points[i],p1=path.points[i+1],p0_withinCircle=withinCircle(p0[0],p0[1],eX,eY,eraseRadius),p1_withinCircle=withinCircle(p1[0],p1[1],eX,eY,eraseRadius);if(p0_withinCircle&&p1_withinCircle)i++,last=i;else if(p0_withinCircle&&!p1_withinCircle){var x=getCircleIntersection(p0[0],p0[1],p1[0],p1[1],eX,eY,eraseRadius);x?(path.points[i]=x,last=i):i++}else if(!p0_withinCircle&&p1_withinCircle){var x=getCircleIntersection(p1[0],p1[1],p0[0],p0[1],eX,eY,eraseRadius);x&&(newPath={points:path.points.slice(last,i+1),attrs:path.attrs},newPath.points.push(x),newPaths.push(newPath)),i++,last=i}else{var possIntersects=getCircleIntersections(p0[0],p0[1],p1[0],p1[1],eX,eY,eraseRadius);possIntersects?(newPath={points:path.points.slice(last,i+1),attrs:path.attrs},newPath.points[newPath.points.length-1][0]===possIntersects[0][0]&&newPath[newPath.points.length-1][1]===possIntersects[0][1]||newPath.points.push(possIntersects[0]),newPath.points.length>1&&newPaths.push(newPath),path.points[i]=possIntersects[1],path.points[i+1]&&path.points[i+1][0]==possIntersects[1][0]&&path.points[i+1][1]==possIntersects[1][1]&&i++,last=i):i++}}last!==i&&(newPath={points:path.points.slice(last,path.points.length),attrs:path.attrs})&&newPaths.push(newPath)}(paths[p]);paths=newPaths}else for(var e=0;e<erasePath.points.length-1;e++){for(var p=0;p<paths.length;p++)!function(path,i){var e0=erasePath.points[i],e1=erasePath.points[i+1],i=0,last=0;if(1===path.points.length){var p0_locationIndex=withinCapsule(path.points[0][0],path.points[0][1],e0[0],e0[1],e1[0],e1[1],eraseRadius);if(-1===p0_locationIndex.indexOf(1))return void newPaths.push(path)}for(var newPath;i<path.points.length-1;){var p0=path.points[i],p1=path.points[i+1],p0_locationIndex=withinCapsule(p0[0],p0[1],e0[0],e0[1],e1[0],e1[1],eraseRadius),p1_locationIndex=withinCapsule(p1[0],p1[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);if(-1!==p0_locationIndex.indexOf(1)&&-1!==p1_locationIndex.indexOf(1))i++,last=i;else if(-1!==p0_locationIndex.indexOf(1)&&-1===p1_locationIndex.indexOf(1)){var x=getCapsuleIntersection(p0[0],p0[1],p0_locationIndex,p1[0],p1[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);x?(path.points[i]=x,last=i):i++}else if(-1===p0_locationIndex.indexOf(1)&&-1!==p1_locationIndex.indexOf(1)){var x=getCapsuleIntersection(p1[0],p1[1],p1_locationIndex,p0[0],p0[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);x?(newPath={points:path.points.slice(last,i+1),attrs:path.attrs},newPath.points.push(x),newPaths.push(newPath),i++,last=i):i++}else{var possIntersects=getCapsuleIntersections(p0[0],p0[1],p1[0],p1[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);possIntersects?(newPath={points:path.points.slice(last,i+1),attrs:path.attrs},newPath.points[newPath.points.length-1][0]===possIntersects[0][0]&&newPath.points[newPath.points.length-1][1]===possIntersects[0][1]||newPath.points.push(possIntersects[0]),newPath.points.length>1&&newPaths.push(newPath),path.points[i]=possIntersects[1],path.points[i+1]&&path.points[i+1][0]==possIntersects[1][0]&&path.points[i+1][1]==possIntersects[1][1]&&i++,last=i):i++}}last!==i&&(newPath={points:path.points.slice(last,path.points.length),attrs:path.attrs})&&newPaths.push(newPath)}(paths[p],e);paths=newPaths,newPaths=[]}for(var r=0;r<paths.length;r++)for(var rr=0;rr<paths[r].points.length;rr++)paths[r].points[rr][0]=Math.round(paths[r].points[rr][0]),paths[r].points[rr][1]=Math.round(paths[r].points[rr][1]);return paths}function cleanPath(path){var cleaned=[];if(1===path.length)cleaned=path;else{for(pClean=0;pClean<path.length-1;)path[pClean][0]===path[pClean+1][0]&&path[pClean][1]===path[pClean+1][1]||cleaned.push(path[pClean]),pClean++;0!==path.length&&0===cleaned.length&&cleaned.push(path[0]),path[path.length-1][0]===path[cleaned.length-1][0]&&path[path.length-1][1]===path[cleaned.length-1][1]||cleaned.push(path[pClean])}return cleaned}function getDistance(aX,aY,bX,bY){return Math.sqrt(Math.pow(bX-aX,2)+Math.pow(bY-aY,2))}function withinCircle(x,y,cX,cY,r){return getDistance(x,y,cX,cY)<r?1:0}function withinBox(pX,pY,aX,aY,bX,bY,r){var vec_ab=[bX-aX,bY-aY],vec_ap=[pX-aX,pY-aY],vec_n=[-vec_ab[1],vec_ab[0]],mag_n=Math.sqrt(Math.pow(vec_n[0],2)+Math.pow(vec_n[1],2)),u_vec_n=[vec_n[0]/mag_n,vec_n[1]/mag_n],mag_ab=Math.sqrt(Math.pow(vec_ab[0],2)+Math.pow(vec_ab[1],2)),u_vec_ab=[vec_ab[0]/mag_ab,vec_ab[1]/mag_ab],ap_proj_ab=vec_ap[0]*u_vec_ab[0]+vec_ap[1]*u_vec_ab[1];if(ap_proj_ab<=0||ap_proj_ab>=mag_ab)return 0;var ap_proj_n=vec_ap[0]*u_vec_n[0]+vec_ap[1]*u_vec_n[1];return ap_proj_n>=r||ap_proj_n<=-r?0:1}function withinCapsule(pX,pY,aX,aY,bX,bY,r){var locationIndex=[];return locationIndex.push(withinCircle(pX,pY,aX,aY,r)),locationIndex.push(withinCircle(pX,pY,bX,bY,r)),locationIndex.push(withinBox(pX,pY,aX,aY,bX,bY,r)),locationIndex}function getParallelSegments(aX,aY,bX,bY,r){var vec_v=[bX-aX,bY-aY],vec_n=[-vec_v[1],vec_v[0]],mag_n=Math.sqrt(Math.pow(vec_n[0],2)+Math.pow(vec_n[1],2)),u_vec_n=[vec_n[0]/mag_n,vec_n[1]/mag_n];return[[aX+r*u_vec_n[0],aY+r*u_vec_n[1]],[aX-r*u_vec_n[0],aY-r*u_vec_n[1]],[bX-r*u_vec_n[0],bY-r*u_vec_n[1]],[bX+r*u_vec_n[0],bY+r*u_vec_n[1]]]}function getCircleIntersection(aX,aY,bX,bY,cX,cY,r){var b,vec_ac=[cX-aX,cY-aY],vec_ab=[bX-aX,bY-aY],mag_ab=Math.sqrt(Math.pow(vec_ab[0],2)+Math.pow(vec_ab[1],2)),u_vec_ab=[vec_ab[0]/mag_ab,vec_ab[1]/mag_ab],ac_proj_ab=vec_ac[0]*u_vec_ab[0]+vec_ac[1]*u_vec_ab[1],rightPoint=[aX+ac_proj_ab*u_vec_ab[0],aY+ac_proj_ab*u_vec_ab[1]],distCToRightPoint=Math.sqrt(Math.pow(cX-rightPoint[0],2)+Math.pow(cY-rightPoint[1],2));if(0===distCToRightPoint)b=r;else var b=Math.sqrt(Math.pow(r,2)-Math.pow(distCToRightPoint,2));var intersection=[aX+ac_proj_ab*u_vec_ab[0]+b*u_vec_ab[0],aY+ac_proj_ab*u_vec_ab[1]+b*u_vec_ab[1]];return intersection[0]===aX&&intersection[1]===aY?null:intersection}function getCircleIntersections(aX,aY,bX,bY,cX,cY,r){var vec_ac=[cX-aX,cY-aY],vec_ab=[bX-aX,bY-aY],vec_n=[-vec_ab[1],vec_ab[0]],mag_n=Math.sqrt(Math.pow(vec_n[0],2)+Math.pow(vec_n[1],2)),u_vec_n=[vec_n[0]/mag_n,vec_n[1]/mag_n],mag_d=vec_ac[0]*u_vec_n[0]+vec_ac[1]*u_vec_n[1],closest=getClosestPointOnSegment([aX,aY],[bX,bY],[cX,cY]);if(getLength([closest[0]-cX,closest[1]-cY])>=r)return null;var x=Math.sqrt(Math.pow(r,2)-Math.pow(mag_d,2)),vec_cd=[cX-mag_d*u_vec_n[0],cY-mag_d*u_vec_n[1]],mag_ab=Math.sqrt(Math.pow(vec_ab[0],2)+Math.pow(vec_ab[1],2)),u_vec_ab=[vec_ab[0]/mag_ab,vec_ab[1]/mag_ab],intersections=[[vec_cd[0]-u_vec_ab[0]*x,vec_cd[1]-u_vec_ab[1]*x],[vec_cd[0]+u_vec_ab[0]*x,vec_cd[1]+u_vec_ab[1]*x]];return intersections[0][0]===aX&&intersections[0][1]===aY?null:intersections}function getLineIntersection(aX,aY,bX,bY,cX,cY,dX,dY){var s1_x,s1_y,s2_x,s2_y;s1_x=bX-aX,s1_y=bY-aY,s2_x=dX-cX,s2_y=dY-cY;var s,t;if(-s2_x*s1_y+s1_x*s2_y==0)return null;if(s=(-s1_y*(aX-cX)+s1_x*(aY-cY))/(-s2_x*s1_y+s1_x*s2_y),t=(s2_x*(aY-cY)-s2_y*(aX-cX))/(-s2_x*s1_y+s1_x*s2_y),s>=0&&s<=1&&t>=0&&t<=1){return[aX+t*s1_x,aY+t*s1_y]}return null}function getCapsuleIntersection(aX,aY,locationIndex,bX,bY,c0_x,c0_y,c1_x,c1_y,r){var box=getParallelSegments(c0_x,c0_y,c1_x,c1_y,r),intersections=[];if(locationIndex[0]&&!locationIndex[1]){intersections.push(getCircleIntersection(aX,aY,bX,bY,c0_x,c0_y,r)),intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1])),intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]));var i=getCircleIntersections(aX,aY,bX,bY,c1_x,c1_y,r);i&&intersections.push(i[0],i[1])}else if(!locationIndex[0]&&locationIndex[1]){intersections.push(getCircleIntersection(aX,aY,bX,bY,c1_x,c1_y,r)),intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1])),intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]));var i=getCircleIntersections(aX,aY,bX,bY,c0_x,c0_y,r);i&&intersections.push(i[0],i[1])}else if(locationIndex[0]&&locationIndex[1])intersections.push(getCircleIntersection(aX,aY,bX,bY,c0_x,c0_y,r)),intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1])),intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1])),intersections.push(getCircleIntersection(aX,aY,bX,bY,c1_x,c1_y,r));else{var i=getCircleIntersections(aX,aY,bX,bY,c1_x,c1_y,r),j=getCircleIntersections(aX,aY,bX,bY,c0_x,c0_y,r);i&&intersections.push(i[0],i[1]),j&&intersections.push(j[0],j[1]),intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1])),intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]))}for(var intersection=[aX,aY],n=0;n<intersections.length;n++)intersections[n]&&getDistance(intersections[n][0],intersections[n][1],bX,bY)<getDistance(intersection[0],intersection[1],bX,bY)&&(intersection=intersections[n]);return intersection[0]===aX&&intersection[1]===aY?null:intersection}function getCapsuleIntersections(aX,aY,bX,bY,c0_x,c0_y,c1_x,c1_y,r){var box=getParallelSegments(c0_x,c0_y,c1_x,c1_y,r),intersections=[],tmp=getCircleIntersections(aX,aY,bX,bY,c0_x,c0_y,r);tmp&&intersections.push(tmp[0],tmp[1]),tmp=getCircleIntersections(aX,aY,bX,bY,c1_x,c1_y,r),tmp&&intersections.push(tmp[0],tmp[1]),intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1])),intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]));for(var intersection0=[bX,bY],intersection1=[aX,aY],n=0;n<intersections.length;n++)intersections[n]&&getDistance(intersections[n][0],intersections[n][1],aX,aY)<getDistance(intersection0[0],intersection0[1],aX,aY)&&(intersection0=intersections[n]);for(var m=0;m<intersections.length;m++)intersections[m]&&getDistance(intersections[m][0],intersections[m][1],bX,bY)<getDistance(intersection1[0],intersection1[1],bX,bY)&&(intersection1=intersections[m]);return intersection0[0]===bX&&intersection0[1]===bY||intersection1[0]===aX&&intersection1[1]===aY?null:[intersection0,intersection1]}var getLength=function(P){return Math.sqrt(P[0]*P[0]+P[1]*P[1])},EPS=1e-6,getClosestPointOnSegment=function(A,B,P){var AB=[B[0]-A[0],B[1]-A[1]],len=getLength(AB);if(len<EPS)return A;var PA=[P[0]-A[0],P[1]-A[1]],k=(AB[0]*PA[0]+AB[1]*PA[1])/len;return k<0?A:k>len?B:[A[0]+AB[0]*k/len,A[1]+AB[1]*k/len]};void 0===jQuery.migrateMute&&(jQuery.migrateMute=!0),function(e,t,n){function r(n){var r=t.console;i[n]||(i[n]=!0,e.migrateWarnings.push(n),r&&r.warn&&!e.migrateMute&&(r.warn("JQMIGRATE: "+n),e.migrateTrace&&r.trace&&r.trace()))}function a(t,a,i,o){if(Object.defineProperty)try{return Object.defineProperty(t,a,{configurable:!0,enumerable:!0,get:function(){return r(o),i},set:function(e){r(o),i=e}}),n}catch(s){}e._definePropertyBroken=!0,t[a]=i}var i={};e.migrateWarnings=[],!e.migrateMute&&t.console&&t.console.log&&t.console.log("JQMIGRATE: Logging is active"),e.migrateTrace===n&&(e.migrateTrace=!0),e.migrateReset=function(){i={},e.migrateWarnings.length=0},"BackCompat"===document.compatMode&&r("jQuery is not compatible with Quirks Mode");var o=e("<input/>",{size:1}).attr("size")&&e.attrFn,s=e.attr,u=e.attrHooks.value&&e.attrHooks.value.get||function(){return null},c=e.attrHooks.value&&e.attrHooks.value.set||function(){return n},l=/^(?:input|button)$/i,d=/^[238]$/,p=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,f=/^(?:checked|selected)$/i;a(e,"attrFn",o||{},"jQuery.attrFn is deprecated"),e.attr=function(t,a,i,u){var c=a.toLowerCase(),g=t&&t.nodeType;return u&&(4>s.length&&r("jQuery.fn.attr( props, pass ) is deprecated"),t&&!d.test(g)&&(o?a in o:e.isFunction(e.fn[a])))?e(t)[a](i):("type"===a&&i!==n&&l.test(t.nodeName)&&t.parentNode&&r("Can't change the 'type' of an input or button in IE 6/7/8"),!e.attrHooks[c]&&p.test(c)&&(e.attrHooks[c]={get:function(t,r){var a,i=e.prop(t,r);return!0===i||"boolean"!=typeof i&&(a=t.getAttributeNode(r))&&!1!==a.nodeValue?r.toLowerCase():n},set:function(t,n,r){var a;return!1===n?e.removeAttr(t,r):(a=e.propFix[r]||r,a in t&&(t[a]=!0),t.setAttribute(r,r.toLowerCase())),r}},f.test(c)&&r("jQuery.fn.attr('"+c+"') may use property instead of attribute")),s.call(e,t,a,i))},e.attrHooks.value={get:function(e,t){var n=(e.nodeName||"").toLowerCase();return"button"===n?u.apply(this,arguments):("input"!==n&&"option"!==n&&r("jQuery.fn.attr('value') no longer gets properties"),t in e?e.value:null)},set:function(e,t){var a=(e.nodeName||"").toLowerCase();return"button"===a?c.apply(this,arguments):("input"!==a&&"option"!==a&&r("jQuery.fn.attr('value', val) no longer sets properties"),e.value=t,n)}};var g,h,v=e.fn.init,m=e.parseJSON,y=/^([^<]*)(<[\w\W]+>)([^>]*)$/;e.fn.init=function(t,n,a){var i;return t&&"string"==typeof t&&!e.isPlainObject(n)&&(i=y.exec(e.trim(t)))&&i[0]&&("<"!==t.charAt(0)&&r("$(html) HTML strings must start with '<' character"),i[3]&&r("$(html) HTML text after last tag is ignored"),"#"===i[0].charAt(0)&&(r("HTML string cannot start with a '#' character"),e.error("JQMIGRATE: Invalid selector string (XSS)")),n&&n.context&&(n=n.context),e.parseHTML)?v.call(this,e.parseHTML(i[2],n,!0),n,a):v.apply(this,arguments)},e.fn.init.prototype=e.fn,e.parseJSON=function(e){return e||null===e?m.apply(this,arguments):(r("jQuery.parseJSON requires a valid JSON string"),null)},e.uaMatch=function(e){e=e.toLowerCase();var t=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||0>e.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return{browser:t[1]||"",version:t[2]||"0"}},e.browser||(g=e.uaMatch(navigator.userAgent),h={},g.browser&&(h[g.browser]=!0,h.version=g.version),h.chrome?h.webkit=!0:h.webkit&&(h.safari=!0),e.browser=h),a(e,"browser",e.browser,"jQuery.browser is deprecated"),e.sub=function(){function t(e,n){return new t.fn.init(e,n)}e.extend(!0,t,this),t.superclass=this,t.fn=t.prototype=this(),t.fn.constructor=t,t.sub=this.sub,t.fn.init=function(r,a){return a&&a instanceof e&&!(a instanceof t)&&(a=t(a)),e.fn.init.call(this,r,a,n)},t.fn.init.prototype=t.fn;var n=t(document);return r("jQuery.sub() is deprecated"),t},e.ajaxSetup({converters:{"text json":e.parseJSON}});var b=e.fn.data;e.fn.data=function(t){var a,i,o=this[0];return!o||"events"!==t||1!==arguments.length||(a=e.data(o,t),i=e._data(o,t),a!==n&&a!==i||i===n)?b.apply(this,arguments):(r("Use of jQuery.fn.data('events') is deprecated"),i)};var j=/\/(java|ecma)script/i,w=e.fn.andSelf||e.fn.addBack;e.fn.andSelf=function(){return r("jQuery.fn.andSelf() replaced by jQuery.fn.addBack()"),w.apply(this,arguments)},e.clean||(e.clean=function(t,a,i,o){a=a||document,a=!a.nodeType&&a[0]||a,a=a.ownerDocument||a,r("jQuery.clean() is deprecated");var s,u,c,l,d=[];if(e.merge(d,e.buildFragment(t,a).childNodes),i)for(c=function(e){return!e.type||j.test(e.type)?o?o.push(e.parentNode?e.parentNode.removeChild(e):e):i.appendChild(e):n},s=0;null!=(u=d[s]);s++)e.nodeName(u,"script")&&c(u)||(i.appendChild(u),u.getElementsByTagName!==n&&(l=e.grep(e.merge([],u.getElementsByTagName("script")),c),d.splice.apply(d,[s+1,0].concat(l)),s+=l.length));return d});var Q=e.event.add,x=e.event.remove,k=e.event.trigger,N=e.fn.toggle,T=e.fn.live,M=e.fn.die,S="ajaxStart|ajaxStop|ajaxSend|ajaxComplete|ajaxError|ajaxSuccess",C=RegExp("\\b(?:"+S+")\\b"),H=/(?:^|\s)hover(\.\S+|)\b/,A=function(t){return"string"!=typeof t||e.event.special.hover?t:(H.test(t)&&r("'hover' pseudo-event is deprecated, use 'mouseenter mouseleave'"),t&&t.replace(H,"mouseenter$1 mouseleave$1"))};e.event.props&&"attrChange"!==e.event.props[0]&&e.event.props.unshift("attrChange","attrName","relatedNode","srcElement"),e.event.dispatch&&a(e.event,"handle",e.event.dispatch,"jQuery.event.handle is undocumented and deprecated"),e.event.add=function(e,t,n,a,i){e!==document&&C.test(t)&&r("AJAX events should be attached to document: "+t),Q.call(this,e,A(t||""),n,a,i)},e.event.remove=function(e,t,n,r,a){x.call(this,e,A(t)||"",n,r,a)},e.fn.error=function(){var e=Array.prototype.slice.call(arguments,0);return r("jQuery.fn.error() is deprecated"),e.splice(0,0,"error"),arguments.length?this.bind.apply(this,e):(this.triggerHandler.apply(this,e),this)},e.fn.toggle=function(t,n){if(!e.isFunction(t)||!e.isFunction(n))return N.apply(this,arguments);r("jQuery.fn.toggle(handler, handler...) is deprecated");var a=arguments,i=t.guid||e.guid++,o=0,s=function(n){var r=(e._data(this,"lastToggle"+t.guid)||0)%o;return e._data(this,"lastToggle"+t.guid,r+1),n.preventDefault(),a[r].apply(this,arguments)||!1};for(s.guid=i;a.length>o;)a[o++].guid=i;return this.click(s)},e.fn.live=function(t,n,a){return r("jQuery.fn.live() is deprecated"),T?T.apply(this,arguments):(e(this.context).on(t,this.selector,n,a),this)},e.fn.die=function(t,n){return r("jQuery.fn.die() is deprecated"),M?M.apply(this,arguments):(e(this.context).off(t,this.selector||"**",n),this)},e.event.trigger=function(e,t,n,a){return n||C.test(e)||r("Global events are undocumented and deprecated"),k.call(this,e,t,n||document,a)},e.each(S.split("|"),function(t,n){e.event.special[n]={setup:function(){var t=this;return t!==document&&(e.event.add(document,n+"."+e.guid,function(){e.event.trigger(n,null,t,!0)}),e._data(this,n,e.guid++)),!1},teardown:function(){return this!==document&&e.event.remove(document,n+"."+e._data(this,n)),!1}}})}(jQuery,window),function(){var root=this,previousUnderscore=root._,ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype,push=ArrayProto.push,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind,nativeCreate=Object.create,Ctor=function(){},_=function(obj){return obj instanceof _?obj:this instanceof _?void(this._wrapped=obj):new _(obj)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=_),exports._=_):root._=_,_.VERSION="1.8.3";var optimizeCb=function(func,context,argCount){if(void 0===context)return func;switch(null==argCount?3:argCount){case 1:return function(value){return func.call(context,value)};case 2:return function(value,other){return func.call(context,value,other)};case 3:return function(value,index,collection){return func.call(context,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(context,accumulator,value,index,collection)}}return function(){return func.apply(context,arguments)}},cb=function(value,context,argCount){return null==value?_.identity:_.isFunction(value)?optimizeCb(value,context,argCount):_.isObject(value)?_.matcher(value):_.property(value)};_.iteratee=function(value,context){return cb(value,context,1/0)};var createAssigner=function(keysFunc,undefinedOnly){return function(obj){var length=arguments.length;if(length<2||null==obj)return obj;for(var index=1;index<length;index++)for(var source=arguments[index],keys=keysFunc(source),l=keys.length,i=0;i<l;i++){var key=keys[i];undefinedOnly&&void 0!==obj[key]||(obj[key]=source[key])}return obj}},baseCreate=function(prototype){if(!_.isObject(prototype))return{};if(nativeCreate)return nativeCreate(prototype);Ctor.prototype=prototype;var result=new Ctor;return Ctor.prototype=null,result},property=function(key){return function(obj){return null==obj?void 0:obj[key]}},MAX_ARRAY_INDEX=Math.pow(2,53)-1,getLength=property("length"),isArrayLike=function(collection){var length=getLength(collection);return"number"==typeof length&&length>=0&&length<=MAX_ARRAY_INDEX};_.each=_.forEach=function(obj,iteratee,context){iteratee=optimizeCb(iteratee,context);var i,length;if(isArrayLike(obj))for(i=0,length=obj.length;i<length;i++)iteratee(obj[i],i,obj);else{var keys=_.keys(obj);for(i=0,length=keys.length;i<length;i++)iteratee(obj[keys[i]],keys[i],obj)}return obj},_.map=_.collect=function(obj,iteratee,context){iteratee=cb(iteratee,context);for(var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,results=Array(length),index=0;index<length;index++){var currentKey=keys?keys[index]:index;results[index]=iteratee(obj[currentKey],currentKey,obj)}return results};function createReduce(dir){function iterator(obj,iteratee,memo,keys,index,length){for(;index>=0&&index<length;index+=dir){var currentKey=keys?keys[index]:index;memo=iteratee(memo,obj[currentKey],currentKey,obj)}return memo}return function(obj,iteratee,memo,context){iteratee=optimizeCb(iteratee,context,4);var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,index=dir>0?0:length-1;return arguments.length<3&&(memo=obj[keys?keys[index]:index],index+=dir),iterator(obj,iteratee,memo,keys,index,length)}}_.reduce=_.foldl=_.inject=createReduce(1),_.reduceRight=_.foldr=createReduce(-1),_.find=_.detect=function(obj,predicate,context){var key;if(void 0!==(key=isArrayLike(obj)?_.findIndex(obj,predicate,context):_.findKey(obj,predicate,context))&&-1!==key)return obj[key]},_.filter=_.select=function(obj,predicate,context){var results=[];return predicate=cb(predicate,context),_.each(obj,function(value,index,list){predicate(value,index,list)&&results.push(value)}),results},_.reject=function(obj,predicate,context){return _.filter(obj,_.negate(cb(predicate)),context)},_.every=_.all=function(obj,predicate,context){predicate=cb(predicate,context);for(var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,index=0;index<length;index++){var currentKey=keys?keys[index]:index;if(!predicate(obj[currentKey],currentKey,obj))return!1}return!0},_.some=_.any=function(obj,predicate,context){predicate=cb(predicate,context);for(var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,index=0;index<length;index++){var currentKey=keys?keys[index]:index;if(predicate(obj[currentKey],currentKey,obj))return!0}return!1},_.contains=_.includes=_.include=function(obj,item,fromIndex,guard){return isArrayLike(obj)||(obj=_.values(obj)),("number"!=typeof fromIndex||guard)&&(fromIndex=0),_.indexOf(obj,item,fromIndex)>=0},_.invoke=function(obj,method){var args=slice.call(arguments,2),isFunc=_.isFunction(method);return _.map(obj,function(value){var func=isFunc?method:value[method];return null==func?func:func.apply(value,args)})},_.pluck=function(obj,key){return _.map(obj,_.property(key))},_.where=function(obj,attrs){return _.filter(obj,_.matcher(attrs))},_.findWhere=function(obj,attrs){return _.find(obj,_.matcher(attrs))},_.max=function(obj,iteratee,context){var value,computed,result=-1/0,lastComputed=-1/0;if(null==iteratee&&null!=obj){obj=isArrayLike(obj)?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++)(value=obj[i])>result&&(result=value)}else iteratee=cb(iteratee,context),_.each(obj,function(value,index,list){((computed=iteratee(value,index,list))>lastComputed||computed===-1/0&&result===-1/0)&&(result=value,lastComputed=computed)});return result},_.min=function(obj,iteratee,context){var value,computed,result=1/0,lastComputed=1/0;if(null==iteratee&&null!=obj){obj=isArrayLike(obj)?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++)(value=obj[i])<result&&(result=value)}else iteratee=cb(iteratee,context),_.each(obj,function(value,index,list){((computed=iteratee(value,index,list))<lastComputed||computed===1/0&&result===1/0)&&(result=value,lastComputed=computed)});return result},_.shuffle=function(obj){for(var rand,set=isArrayLike(obj)?obj:_.values(obj),length=set.length,shuffled=Array(length),index=0;index<length;index++)rand=_.random(0,index),rand!==index&&(shuffled[index]=shuffled[rand]),shuffled[rand]=set[index];return shuffled},_.sample=function(obj,n,guard){return null==n||guard?(isArrayLike(obj)||(obj=_.values(obj)),obj[_.random(obj.length-1)]):_.shuffle(obj).slice(0,Math.max(0,n))},_.sortBy=function(obj,iteratee,context){return iteratee=cb(iteratee,context),_.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iteratee(value,index,list)}}).sort(function(left,right){var a=left.criteria,b=right.criteria;if(a!==b){if(a>b||void 0===a)return 1;if(a<b||void 0===b)return-1}return left.index-right.index}),"value")};var group=function(behavior){return function(obj,iteratee,context){var result={};return iteratee=cb(iteratee,context),_.each(obj,function(value,index){var key=iteratee(value,index,obj);behavior(result,value,key)}),result}};_.groupBy=group(function(result,value,key){_.has(result,key)?result[key].push(value):result[key]=[value]}),_.indexBy=group(function(result,value,key){result[key]=value}),_.countBy=group(function(result,value,key){_.has(result,key)?result[key]++:result[key]=1}),_.toArray=function(obj){return obj?_.isArray(obj)?slice.call(obj):isArrayLike(obj)?_.map(obj,_.identity):_.values(obj):[]},_.size=function(obj){return null==obj?0:isArrayLike(obj)?obj.length:_.keys(obj).length},_.partition=function(obj,predicate,context){predicate=cb(predicate,context);var pass=[],fail=[];return _.each(obj,function(value,key,obj){(predicate(value,key,obj)?pass:fail).push(value)}),[pass,fail]},_.first=_.head=_.take=function(array,n,guard){if(null!=array)return null==n||guard?array[0]:_.initial(array,array.length-n)},_.initial=function(array,n,guard){return slice.call(array,0,Math.max(0,array.length-(null==n||guard?1:n)))},_.last=function(array,n,guard){if(null!=array)return null==n||guard?array[array.length-1]:_.rest(array,Math.max(0,array.length-n))},_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,null==n||guard?1:n)},_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,strict,startIndex){for(var output=[],idx=0,i=startIndex||0,length=getLength(input);i<length;i++){var value=input[i];if(isArrayLike(value)&&(_.isArray(value)||_.isArguments(value))){shallow||(value=flatten(value,shallow,strict));var j=0,len=value.length;for(output.length+=len;j<len;)output[idx++]=value[j++]}else strict||(output[idx++]=value)}return output};_.flatten=function(array,shallow){return flatten(array,shallow,!1)},_.without=function(array){return _.difference(array,slice.call(arguments,1))},_.uniq=_.unique=function(array,isSorted,iteratee,context){_.isBoolean(isSorted)||(context=iteratee,iteratee=isSorted,isSorted=!1),null!=iteratee&&(iteratee=cb(iteratee,context));for(var result=[],seen=[],i=0,length=getLength(array);i<length;i++){var value=array[i],computed=iteratee?iteratee(value,i,array):value;isSorted?(i&&seen===computed||result.push(value),seen=computed):iteratee?_.contains(seen,computed)||(seen.push(computed),result.push(value)):_.contains(result,value)||result.push(value)}return result},_.union=function(){return _.uniq(flatten(arguments,!0,!0))},_.intersection=function(array){for(var result=[],argsLength=arguments.length,i=0,length=getLength(array);i<length;i++){var item=array[i];if(!_.contains(result,item)){for(var j=1;j<argsLength&&_.contains(arguments[j],item);j++);j===argsLength&&result.push(item)}}return result},_.difference=function(array){var rest=flatten(arguments,!0,!0,1);return _.filter(array,function(value){return!_.contains(rest,value)})},_.zip=function(){return _.unzip(arguments)},_.unzip=function(array){for(var length=array&&_.max(array,getLength).length||0,result=Array(length),index=0;index<length;index++)result[index]=_.pluck(array,index);return result},_.object=function(list,values){for(var result={},i=0,length=getLength(list);i<length;i++)values?result[list[i]]=values[i]:result[list[i][0]]=list[i][1];return result};function createPredicateIndexFinder(dir){return function(array,predicate,context){predicate=cb(predicate,context);for(var length=getLength(array),index=dir>0?0:length-1;index>=0&&index<length;index+=dir)if(predicate(array[index],index,array))return index;return-1}}
_.findIndex=createPredicateIndexFinder(1),_.findLastIndex=createPredicateIndexFinder(-1),_.sortedIndex=function(array,obj,iteratee,context){iteratee=cb(iteratee,context,1);for(var value=iteratee(obj),low=0,high=getLength(array);low<high;){var mid=Math.floor((low+high)/2);iteratee(array[mid])<value?low=mid+1:high=mid}return low};function createIndexFinder(dir,predicateFind,sortedIndex){return function(array,item,idx){var i=0,length=getLength(array);if("number"==typeof idx)dir>0?i=idx>=0?idx:Math.max(idx+length,i):length=idx>=0?Math.min(idx+1,length):idx+length+1;else if(sortedIndex&&idx&&length)return idx=sortedIndex(array,item),array[idx]===item?idx:-1;if(item!==item)return idx=predicateFind(slice.call(array,i,length),_.isNaN),idx>=0?idx+i:-1;for(idx=dir>0?i:length-1;idx>=0&&idx<length;idx+=dir)if(array[idx]===item)return idx;return-1}}_.indexOf=createIndexFinder(1,_.findIndex,_.sortedIndex),_.lastIndexOf=createIndexFinder(-1,_.findLastIndex),_.range=function(start,stop,step){null==stop&&(stop=start||0,start=0),step=step||1;for(var length=Math.max(Math.ceil((stop-start)/step),0),range=Array(length),idx=0;idx<length;idx++,start+=step)range[idx]=start;return range};var executeBound=function(sourceFunc,boundFunc,context,callingContext,args){if(!(callingContext instanceof boundFunc))return sourceFunc.apply(context,args);var self=baseCreate(sourceFunc.prototype),result=sourceFunc.apply(self,args);return _.isObject(result)?result:self};_.bind=function(func,context){if(nativeBind&&func.bind===nativeBind)return nativeBind.apply(func,slice.call(arguments,1));if(!_.isFunction(func))throw new TypeError("Bind must be called on a function");var args=slice.call(arguments,2),bound=function(){return executeBound(func,bound,context,this,args.concat(slice.call(arguments)))};return bound},_.partial=function(func){var boundArgs=slice.call(arguments,1),bound=function(){for(var position=0,length=boundArgs.length,args=Array(length),i=0;i<length;i++)args[i]=boundArgs[i]===_?arguments[position++]:boundArgs[i];for(;position<arguments.length;)args.push(arguments[position++]);return executeBound(func,bound,this,this,args)};return bound},_.bindAll=function(obj){var i,key,length=arguments.length;if(length<=1)throw new Error("bindAll must be passed function names");for(i=1;i<length;i++)key=arguments[i],obj[key]=_.bind(obj[key],obj);return obj},_.memoize=function(func,hasher){var memoize=function(key){var cache=memoize.cache,address=""+(hasher?hasher.apply(this,arguments):key);return _.has(cache,address)||(cache[address]=func.apply(this,arguments)),cache[address]};return memoize.cache={},memoize},_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)},_.defer=_.partial(_.delay,_,1),_.throttle=function(func,wait,options){var context,args,result,timeout=null,previous=0;options||(options={});var later=function(){previous=!1===options.leading?0:_.now(),timeout=null,result=func.apply(context,args),timeout||(context=args=null)};return function(){var now=_.now();previous||!1!==options.leading||(previous=now);var remaining=wait-(now-previous);return context=this,args=arguments,remaining<=0||remaining>wait?(timeout&&(clearTimeout(timeout),timeout=null),previous=now,result=func.apply(context,args),timeout||(context=args=null)):timeout||!1===options.trailing||(timeout=setTimeout(later,remaining)),result}},_.debounce=function(func,wait,immediate){var timeout,args,context,timestamp,result,later=function(){var last=_.now()-timestamp;last<wait&&last>=0?timeout=setTimeout(later,wait-last):(timeout=null,immediate||(result=func.apply(context,args),timeout||(context=args=null)))};return function(){context=this,args=arguments,timestamp=_.now();var callNow=immediate&&!timeout;return timeout||(timeout=setTimeout(later,wait)),callNow&&(result=func.apply(context,args),context=args=null),result}},_.wrap=function(func,wrapper){return _.partial(wrapper,func)},_.negate=function(predicate){return function(){return!predicate.apply(this,arguments)}},_.compose=function(){var args=arguments,start=args.length-1;return function(){for(var i=start,result=args[start].apply(this,arguments);i--;)result=args[i].call(this,result);return result}},_.after=function(times,func){return function(){if(--times<1)return func.apply(this,arguments)}},_.before=function(times,func){var memo;return function(){return--times>0&&(memo=func.apply(this,arguments)),times<=1&&(func=null),memo}},_.once=_.partial(_.before,2);var hasEnumBug=!{toString:null}.propertyIsEnumerable("toString"),nonEnumerableProps=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];function collectNonEnumProps(obj,keys){var nonEnumIdx=nonEnumerableProps.length,constructor=obj.constructor,proto=_.isFunction(constructor)&&constructor.prototype||ObjProto,prop="constructor";for(_.has(obj,prop)&&!_.contains(keys,prop)&&keys.push(prop);nonEnumIdx--;)(prop=nonEnumerableProps[nonEnumIdx])in obj&&obj[prop]!==proto[prop]&&!_.contains(keys,prop)&&keys.push(prop)}_.keys=function(obj){if(!_.isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)_.has(obj,key)&&keys.push(key);return hasEnumBug&&collectNonEnumProps(obj,keys),keys},_.allKeys=function(obj){if(!_.isObject(obj))return[];var keys=[];for(var key in obj)keys.push(key);return hasEnumBug&&collectNonEnumProps(obj,keys),keys},_.values=function(obj){for(var keys=_.keys(obj),length=keys.length,values=Array(length),i=0;i<length;i++)values[i]=obj[keys[i]];return values},_.mapObject=function(obj,iteratee,context){iteratee=cb(iteratee,context);for(var currentKey,keys=_.keys(obj),length=keys.length,results={},index=0;index<length;index++)currentKey=keys[index],results[currentKey]=iteratee(obj[currentKey],currentKey,obj);return results},_.pairs=function(obj){for(var keys=_.keys(obj),length=keys.length,pairs=Array(length),i=0;i<length;i++)pairs[i]=[keys[i],obj[keys[i]]];return pairs},_.invert=function(obj){for(var result={},keys=_.keys(obj),i=0,length=keys.length;i<length;i++)result[obj[keys[i]]]=keys[i];return result},_.functions=_.methods=function(obj){var names=[];for(var key in obj)_.isFunction(obj[key])&&names.push(key);return names.sort()},_.extend=createAssigner(_.allKeys),_.extendOwn=_.assign=createAssigner(_.keys),_.findKey=function(obj,predicate,context){predicate=cb(predicate,context);for(var key,keys=_.keys(obj),i=0,length=keys.length;i<length;i++)if(key=keys[i],predicate(obj[key],key,obj))return key},_.pick=function(object,oiteratee,context){var iteratee,keys,result={},obj=object;if(null==obj)return result;_.isFunction(oiteratee)?(keys=_.allKeys(obj),iteratee=optimizeCb(oiteratee,context)):(keys=flatten(arguments,!1,!1,1),iteratee=function(value,key,obj){return key in obj},obj=Object(obj));for(var i=0,length=keys.length;i<length;i++){var key=keys[i],value=obj[key];iteratee(value,key,obj)&&(result[key]=value)}return result},_.omit=function(obj,iteratee,context){if(_.isFunction(iteratee))iteratee=_.negate(iteratee);else{var keys=_.map(flatten(arguments,!1,!1,1),String);iteratee=function(value,key){return!_.contains(keys,key)}}return _.pick(obj,iteratee,context)},_.defaults=createAssigner(_.allKeys,!0),_.create=function(prototype,props){var result=baseCreate(prototype);return props&&_.extendOwn(result,props),result},_.clone=function(obj){return _.isObject(obj)?_.isArray(obj)?obj.slice():_.extend({},obj):obj},_.tap=function(obj,interceptor){return interceptor(obj),obj},_.isMatch=function(object,attrs){var keys=_.keys(attrs),length=keys.length;if(null==object)return!length;for(var obj=Object(object),i=0;i<length;i++){var key=keys[i];if(attrs[key]!==obj[key]||!(key in obj))return!1}return!0};var eq=function(a,b,aStack,bStack){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;a instanceof _&&(a=a._wrapped),b instanceof _&&(b=b._wrapped);var className=toString.call(a);if(className!==toString.call(b))return!1;switch(className){case"[object RegExp]":case"[object String]":return""+a==""+b;case"[object Number]":return+a!=+a?+b!=+b:0==+a?1/+a==1/b:+a==+b;case"[object Date]":case"[object Boolean]":return+a==+b}var areArrays="[object Array]"===className;if(!areArrays){if("object"!=typeof a||"object"!=typeof b)return!1;var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)&&"constructor"in a&&"constructor"in b)return!1}aStack=aStack||[],bStack=bStack||[];for(var length=aStack.length;length--;)if(aStack[length]===a)return bStack[length]===b;if(aStack.push(a),bStack.push(b),areArrays){if((length=a.length)!==b.length)return!1;for(;length--;)if(!eq(a[length],b[length],aStack,bStack))return!1}else{var key,keys=_.keys(a);if(length=keys.length,_.keys(b).length!==length)return!1;for(;length--;)if(key=keys[length],!_.has(b,key)||!eq(a[key],b[key],aStack,bStack))return!1}return aStack.pop(),bStack.pop(),!0};_.isEqual=function(a,b){return eq(a,b)},_.isEmpty=function(obj){return null==obj||(isArrayLike(obj)&&(_.isArray(obj)||_.isString(obj)||_.isArguments(obj))?0===obj.length:0===_.keys(obj).length)},_.isElement=function(obj){return!(!obj||1!==obj.nodeType)},_.isArray=nativeIsArray||function(obj){return"[object Array]"===toString.call(obj)},_.isObject=function(obj){var type=typeof obj;return"function"===type||"object"===type&&!!obj},_.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(name){_["is"+name]=function(obj){return toString.call(obj)==="[object "+name+"]"}}),_.isArguments(arguments)||(_.isArguments=function(obj){return _.has(obj,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(_.isFunction=function(obj){return"function"==typeof obj||!1}),_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))},_.isNaN=function(obj){return _.isNumber(obj)&&obj!==+obj},_.isBoolean=function(obj){return!0===obj||!1===obj||"[object Boolean]"===toString.call(obj)},_.isNull=function(obj){return null===obj},_.isUndefined=function(obj){return void 0===obj},_.has=function(obj,key){return null!=obj&&hasOwnProperty.call(obj,key)},_.noConflict=function(){return root._=previousUnderscore,this},_.identity=function(value){return value},_.constant=function(value){return function(){return value}},_.noop=function(){},_.property=property,_.propertyOf=function(obj){return null==obj?function(){}:function(key){return obj[key]}},_.matcher=_.matches=function(attrs){return attrs=_.extendOwn({},attrs),function(obj){return _.isMatch(obj,attrs)}},_.times=function(n,iteratee,context){var accum=Array(Math.max(0,n));iteratee=optimizeCb(iteratee,context,1);for(var i=0;i<n;i++)accum[i]=iteratee(i);return accum},_.random=function(min,max){return null==max&&(max=min,min=0),min+Math.floor(Math.random()*(max-min+1))},_.now=Date.now||function(){return(new Date).getTime()};var escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},unescapeMap=_.invert(escapeMap),createEscaper=function(map){var escaper=function(match){return map[match]},source="(?:"+_.keys(map).join("|")+")",testRegexp=RegExp(source),replaceRegexp=RegExp(source,"g");return function(string){return string=null==string?"":""+string,testRegexp.test(string)?string.replace(replaceRegexp,escaper):string}};_.escape=createEscaper(escapeMap),_.unescape=createEscaper(unescapeMap),_.result=function(object,property,fallback){var value=null==object?void 0:object[property];return void 0===value&&(value=fallback),_.isFunction(value)?value.call(object):value};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id},_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/,escapes={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},escaper=/\\|'|\r|\n|\u2028|\u2029/g,escapeChar=function(match){return"\\"+escapes[match]};_.template=function(text,settings,oldSettings){!settings&&oldSettings&&(settings=oldSettings),settings=_.defaults({},settings,_.templateSettings);var matcher=RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g"),index=0,source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){return source+=text.slice(index,offset).replace(escaper,escapeChar),index=offset+match.length,escape?source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'":interpolate?source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'":evaluate&&(source+="';\n"+evaluate+"\n__p+='"),match}),source+="';\n",settings.variable||(source="with(obj||{}){\n"+source+"}\n"),source="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{var render=new Function(settings.variable||"obj","_",source)}catch(e){throw e.source=source,e}var template=function(data){return render.call(this,data,_)};return template.source="function("+(settings.variable||"obj")+"){\n"+source+"}",template},_.chain=function(obj){var instance=_(obj);return instance._chain=!0,instance};var result=function(instance,obj){return instance._chain?_(obj).chain():obj};_.mixin=function(obj){_.each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];return push.apply(args,arguments),result(this,func.apply(_,args))}})},_.mixin(_),_.each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;return method.apply(obj,arguments),"shift"!==name&&"splice"!==name||0!==obj.length||delete obj[0],result(this,obj)}}),_.each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result(this,method.apply(this._wrapped,arguments))}}),_.prototype.value=function(){return this._wrapped},_.prototype.valueOf=_.prototype.toJSON=_.prototype.value,_.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return _})}.call(this),function(e,t){"use strict";var n=t.prototype.trim,r=t.prototype.trimRight,i=t.prototype.trimLeft,s=function(e){return 1*e||0},o=function(e,t){if(t<1)return"";for(var n="";t>0;)1&t&&(n+=e),t>>=1,e+=e;return n},u=[].slice,a=function(e){return null==e?"\\s":e.source?e.source:"["+p.escapeRegExp(e)+"]"},f={lt:"<",gt:">",quot:'"',apos:"'",amp:"&"},l={};for(var c in f)l[f[c]]=c;var h=function(){function e(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}var n=o,r=function(){return r.cache.hasOwnProperty(arguments[0])||(r.cache[arguments[0]]=r.parse(arguments[0])),r.format.call(null,r.cache[arguments[0]],arguments)};return r.format=function(r,i){var a,l,c,p,d,v,m,s=1,o=r.length,u="",f=[];for(l=0;l<o;l++)if("string"===(u=e(r[l])))f.push(r[l]);else if("array"===u){if(p=r[l],p[2])for(a=i[s],c=0;c<p[2].length;c++){if(!a.hasOwnProperty(p[2][c]))throw new Error(h('[_.sprintf] property "%s" does not exist',p[2][c]));a=a[p[2][c]]}else a=p[1]?i[p[1]]:i[s++];if(/[^s]/.test(p[8])&&"number"!=e(a))throw new Error(h("[_.sprintf] expecting number but found %s",e(a)));switch(p[8]){case"b":a=a.toString(2);break;case"c":a=t.fromCharCode(a);break;case"d":a=parseInt(a,10);break;case"e":a=p[7]?a.toExponential(p[7]):a.toExponential();break;case"f":a=p[7]?parseFloat(a).toFixed(p[7]):parseFloat(a);break;case"o":a=a.toString(8);break;case"s":a=(a=t(a))&&p[7]?a.substring(0,p[7]):a;break;case"u":a=Math.abs(a);break;case"x":a=a.toString(16);break;case"X":a=a.toString(16).toUpperCase()}a=/[def]/.test(p[8])&&p[3]&&a>=0?"+"+a:a,v=p[4]?"0"==p[4]?"0":p[4].charAt(1):" ",m=p[6]-t(a).length,d=p[6]?n(v,m):"",f.push(p[5]?a+d:d+a)}return f.join("")},r.cache={},r.parse=function(e){for(var t=e,n=[],r=[],i=0;t;){if(null!==(n=/^[^\x25]+/.exec(t)))r.push(n[0]);else if(null!==(n=/^\x25{2}/.exec(t)))r.push("%");else{if(null===(n=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(t)))throw new Error("[_.sprintf] huh?");if(n[2]){i|=1;var s=[],o=n[2],u=[];if(null===(u=/^([a-z_][a-z_\d]*)/i.exec(o)))throw new Error("[_.sprintf] huh?");for(s.push(u[1]);""!==(o=o.substring(u[0].length));)if(null!==(u=/^\.([a-z_][a-z_\d]*)/i.exec(o)))s.push(u[1]);else{if(null===(u=/^\[(\d+)\]/.exec(o)))throw new Error("[_.sprintf] huh?");s.push(u[1])}n[2]=s}else i|=2;if(3===i)throw new Error("[_.sprintf] mixing positional and named placeholders is not (yet) supported");r.push(n)}t=t.substring(n[0].length)}return r},r}(),p={VERSION:"2.3.0",isBlank:function(e){return null==e&&(e=""),/^\s*$/.test(e)},stripTags:function(e){return null==e?"":t(e).replace(/<\/?[^>]+>/g,"")},capitalize:function(e){return e=null==e?"":t(e),e.charAt(0).toUpperCase()+e.slice(1)},chop:function(e,n){return null==e?[]:(e=t(e),n=~~n,n>0?e.match(new RegExp(".{1,"+n+"}","g")):[e])},clean:function(e){return p.strip(e).replace(/\s+/g," ")},count:function(e,n){return null==e||null==n?0:t(e).split(n).length-1},chars:function(e){return null==e?[]:t(e).split("")},swapCase:function(e){return null==e?"":t(e).replace(/\S/g,function(e){return e===e.toUpperCase()?e.toLowerCase():e.toUpperCase()})},escapeHTML:function(e){return null==e?"":t(e).replace(/[&<>"']/g,function(e){return"&"+l[e]+";"})},unescapeHTML:function(e){return null==e?"":t(e).replace(/\&([^;]+);/g,function(e,n){var r;return n in f?f[n]:(r=n.match(/^#x([\da-fA-F]+)$/))?t.fromCharCode(parseInt(r[1],16)):(r=n.match(/^#(\d+)$/))?t.fromCharCode(~~r[1]):e})},escapeRegExp:function(e){return null==e?"":t(e).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")},splice:function(e,t,n,r){var i=p.chars(e);return i.splice(~~t,~~n,r),i.join("")},insert:function(e,t,n){return p.splice(e,t,0,n)},include:function(e,n){return""===n||null!=e&&-1!==t(e).indexOf(n)},join:function(){var e=u.call(arguments),t=e.shift();return null==t&&(t=""),e.join(t)},lines:function(e){return null==e?[]:t(e).split("\n")},reverse:function(e){return p.chars(e).reverse().join("")},startsWith:function(e,n){return""===n||null!=e&&null!=n&&(e=t(e),n=t(n),e.length>=n.length&&e.slice(0,n.length)===n)},endsWith:function(e,n){return""===n||null!=e&&null!=n&&(e=t(e),n=t(n),e.length>=n.length&&e.slice(e.length-n.length)===n)},succ:function(e){return null==e?"":(e=t(e),e.slice(0,-1)+t.fromCharCode(e.charCodeAt(e.length-1)+1))},titleize:function(e){return null==e?"":t(e).replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})},camelize:function(e){return p.trim(e).replace(/[-_\s]+(.)?/g,function(e,t){return t.toUpperCase()})},underscored:function(e){return p.trim(e).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},dasherize:function(e){return p.trim(e).replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").toLowerCase()},classify:function(e){return p.titleize(t(e).replace(/_/g," ")).replace(/\s/g,"")},humanize:function(e){return p.capitalize(p.underscored(e).replace(/_id$/,"").replace(/_/g," "))},trim:function(e,r){return null==e?"":!r&&n?n.call(e):(r=a(r),t(e).replace(new RegExp("^"+r+"+|"+r+"+$","g"),""))},ltrim:function(e,n){return null==e?"":!n&&i?i.call(e):(n=a(n),t(e).replace(new RegExp("^"+n+"+"),""))},rtrim:function(e,n){return null==e?"":!n&&r?r.call(e):(n=a(n),t(e).replace(new RegExp(n+"+$"),""))},truncate:function(e,n,r){return null==e?"":(e=t(e),r=r||"...",n=~~n,e.length>n?e.slice(0,n)+r:e)},prune:function(e,n,r){if(null==e)return"";if(e=t(e),n=~~n,r=null!=r?t(r):"...",e.length<=n)return e;var i=function(e){return e.toUpperCase()!==e.toLowerCase()?"A":" "},s=e.slice(0,n+1).replace(/.(?=\W*\w*$)/g,i);return s=s.slice(s.length-2).match(/\w\w/)?s.replace(/\s*\S+$/,""):p.rtrim(s.slice(0,s.length-1)),(s+r).length>e.length?e:e.slice(0,s.length)+r},words:function(e,t){return p.isBlank(e)?[]:p.trim(e,t).split(t||/\s+/)},pad:function(e,n,r,i){e=null==e?"":t(e),n=~~n;var s=0;switch(r?r.length>1&&(r=r.charAt(0)):r=" ",i){case"right":return s=n-e.length,e+o(r,s);case"both":return s=n-e.length,o(r,Math.ceil(s/2))+e+o(r,Math.floor(s/2));default:return s=n-e.length,o(r,s)+e}},lpad:function(e,t,n){return p.pad(e,t,n)},rpad:function(e,t,n){return p.pad(e,t,n,"right")},lrpad:function(e,t,n){return p.pad(e,t,n,"both")},sprintf:h,vsprintf:function(e,t){return t.unshift(e),h.apply(null,t)},toNumber:function(e,n){if(null==e||""==e)return 0;e=t(e);var r=s(s(e).toFixed(~~n));return 0!==r||e.match(/^0+$/)?r:Number.NaN},numberFormat:function(e,t,n,r){if(isNaN(e)||null==e)return"";e=e.toFixed(~~t),r=r||",";var i=e.split("."),s=i[0],o=i[1]?(n||".")+i[1]:"";return s.replace(/(\d)(?=(?:\d{3})+$)/g,"$1"+r)+o},strRight:function(e,n){if(null==e)return"";e=t(e),n=null!=n?t(n):n;var r=n?e.indexOf(n):-1;return~r?e.slice(r+n.length,e.length):e},strRightBack:function(e,n){if(null==e)return"";e=t(e),n=null!=n?t(n):n;var r=n?e.lastIndexOf(n):-1;return~r?e.slice(r+n.length,e.length):e},strLeft:function(e,n){if(null==e)return"";e=t(e),n=null!=n?t(n):n;var r=n?e.indexOf(n):-1;return~r?e.slice(0,r):e},strLeftBack:function(e,t){if(null==e)return"";e+="",t=null!=t?""+t:t;var n=e.lastIndexOf(t);return~n?e.slice(0,n):e},toSentence:function(e,t,n,r){t=t||", ",n=n||" and ";var i=e.slice(),s=i.pop();return e.length>2&&r&&(n=p.rtrim(t)+n),i.length?i.join(t)+n+s:s},toSentenceSerial:function(){var e=u.call(arguments);return e[3]=!0,p.toSentence.apply(p,e)},slugify:function(e){if(null==e)return"";var n="ÄÃ Ã¡Ã¤Ã¢Ã£Ã¥Ã¦ÄÄÃ¨Ã©Ã«ÃªÃ¬Ã­Ã¯Ã®ÅÅÃ²Ã³Ã¶Ã´ÃµÃ¸Ã¹ÃºÃ¼Ã»Ã±Ã§Å¼Åº",i=new RegExp(a(n),"g");return e=t(e).toLowerCase().replace(i,function(e){return"aaaaaaaaceeeeeiiiilnoooooouuuunczz".charAt(n.indexOf(e))||"-"}),p.dasherize(e.replace(/[^\w\s-]/g,""))},surround:function(e,t){return[t,e,t].join("")},quote:function(e){return p.surround(e,'"')},exports:function(){var e={};for(var t in this)this.hasOwnProperty(t)&&!t.match(/^(?:include|contains|reverse)$/)&&(e[t]=this[t]);return e},repeat:function(e,n,r){if(null==e)return"";if(n=~~n,null==r)return o(t(e),n);for(var i=[];n>0;i[--n]=e);return i.join(r)},levenshtein:function(e,n){if(null==e&&null==n)return 0;if(null==e)return t(n).length;if(null==n)return t(e).length;e=t(e),n=t(n);for(var i,s,r=[],o=0;o<=n.length;o++)for(var u=0;u<=e.length;u++)s=o&&u?e.charAt(u-1)===n.charAt(o-1)?i:Math.min(r[u],r[u-1],i)+1:o+u,i=r[u],r[u]=s;return r.pop()}};p.strip=p.trim,p.lstrip=p.ltrim,p.rstrip=p.rtrim,p.center=p.lrpad,p.rjust=p.lpad,p.ljust=p.rpad,p.contains=p.include,p.q=p.quote,"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(module.exports=p),exports._s=p):"function"==typeof define&&define.amd?define("underscore.string",[],function(){return p}):(e._=e._||{},e._.string=e._.str=p)}(this,String),function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):factory("object"==typeof exports?require("jquery"):jQuery)}(function($){var ua=navigator.userAgent,iPhone=/iphone/i.test(ua),chrome=/chrome/i.test(ua),android=/android/i.test(ua);$.mask={definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"},autoclear:!0,allowpartial:!1,dataName:"rawMaskFn",placeholder:"_"},$.fn.extend({caret:function(begin,end){if(0!==this.length&&!this.is(":hidden")&&this.get(0)===document.activeElement)return"number"==typeof begin?(end="number"==typeof end?end:begin,this.each(function(){this.setSelectionRange(begin,end)})):(begin=this[0].selectionStart,end=this[0].selectionEnd,{begin:begin,end:end})},unmask:function(){return this.trigger("unmask")},mask:function(mask,settings){var input,defs,tests,partialPosition,firstNonMaskPos,lastRequiredNonMaskPos,len,oldVal;if(!mask&&this.length>0){input=$(this[0]);var fn=input.data($.mask.dataName);return fn?fn():void 0}return settings=$.extend({autoclear:$.mask.autoclear,allowpartial:$.mask.allowpartial,placeholder:$.mask.placeholder,completed:null},settings),defs=$.mask.definitions,tests=[],partialPosition=len=mask.length,firstNonMaskPos=null,mask=String(mask),$.each(mask.split(""),function(i,c){"?"==c?(len--,partialPosition=i):defs[c]?(tests.push(new RegExp(defs[c])),null===firstNonMaskPos&&(firstNonMaskPos=tests.length-1),i<partialPosition&&(lastRequiredNonMaskPos=tests.length-1)):tests.push(null)}),this.trigger("unmask").each(function(){var input=$(this),buffer=$.map(mask.split(""),function(c,i){if("?"!=c)return defs[c]?getPlaceholder(i):c}),defaultBuffer=buffer.join(""),focusText=input.val();function tryFireCompleted(){if(settings.completed){for(var i=firstNonMaskPos;i<=lastRequiredNonMaskPos;i++)if(tests[i]&&buffer[i]===getPlaceholder(i))return;settings.completed.call(input)}}function getPlaceholder(i){return i<settings.placeholder.length?settings.placeholder.charAt(i):settings.placeholder.charAt(0)}function seekNext(pos){for(;++pos<len&&!tests[pos];);return pos}function seekPrev(pos){for(;--pos>=0&&!tests[pos];);return pos}function shiftL(begin,end){var i,j;if(!(begin<0)){for(i=begin,j=seekNext(end);i<len;i++)if(tests[i]){if(!(j<len&&tests[i].test(buffer[j])))break;buffer[i]=buffer[j],buffer[j]=getPlaceholder(j),j=seekNext(j)}writeBuffer(),input.caret(Math.max(firstNonMaskPos,begin))}}function shiftR(pos){var i,c,j,t;for(i=pos,c=getPlaceholder(pos);i<len;i++)if(tests[i]){if(j=seekNext(i),t=buffer[i],buffer[i]=c,!(j<len&&tests[j].test(t)))break;c=t}}function androidInputEvent(e){var curVal=input.val(),pos=input.caret();if(oldVal&&oldVal.length&&oldVal.length>curVal.length){for(checkVal(!0);pos.begin>0&&!tests[pos.begin-1];)pos.begin--;if(0===pos.begin)for(;pos.begin<firstNonMaskPos&&!tests[pos.begin];)pos.begin++;input.caret(pos.begin,pos.begin)}else{var lastEnteredValue=(checkVal(!0),curVal.charAt(pos.begin));pos.begin<len&&(tests[pos.begin]?tests[pos.begin].test(lastEnteredValue)&&pos.begin++:(pos.begin++,tests[pos.begin].test(lastEnteredValue)&&pos.begin++)),input.caret(pos.begin,pos.begin)}tryFireCompleted()}function blurEvent(e){checkVal(),input.val()!=focusText&&input.change()}function keydownEvent(e){if(!input.prop("readonly")){var pos,begin,end,k=e.which||e.keyCode;oldVal=input.val(),8===k||46===k||iPhone&&127===k?(pos=input.caret(),begin=pos.begin,end=pos.end,end-begin==0&&(begin=46!==k?seekPrev(begin):end=seekNext(begin-1),end=46===k?seekNext(end):end),clearBuffer(begin,end),shiftL(begin,end-1),e.preventDefault()):13===k?blurEvent.call(this,e):27===k&&(input.val(focusText),input.caret(0,checkVal()),e.preventDefault())}}function keypressEvent(e){if(!input.prop("readonly")){var p,c,next,k=e.which||e.keyCode,pos=input.caret();if(!(e.ctrlKey||e.altKey||e.metaKey||k<32)&&k&&13!==k){if(pos.end-pos.begin!=0&&(clearBuffer(pos.begin,pos.end),shiftL(pos.begin,pos.end-1)),(p=seekNext(pos.begin-1))<len&&(c=String.fromCharCode(k),tests[p].test(c))){if(shiftR(p),buffer[p]=c,writeBuffer(),next=seekNext(p),android){var proxy=function(){$.proxy($.fn.caret,input,next)()};setTimeout(proxy,0)}else input.caret(next);pos.begin<=lastRequiredNonMaskPos&&tryFireCompleted()}e.preventDefault()}}}function clearBuffer(start,end){var i;for(i=start;i<end&&i<len;i++)tests[i]&&(buffer[i]=getPlaceholder(i))}function writeBuffer(){input.val(buffer.join(""))}function isEmpty(){for(var c,i=0,empty=!0;empty&&i<buffer.length;)c=buffer[i],tests[i]&&tests[i].test(c)&&(empty=!1),i++;return empty}function checkVal(allow){var i,c,pos,test=input.val(),lastMatch=-1;for(i=0,pos=0;i<len;i++)if(!settings.allowpartial&&tests[i]){for(buffer[i]=getPlaceholder(i);pos++<test.length;)if(c=test.charAt(pos-1),tests[i].test(c)){buffer[i]=c,lastMatch=i;break}if(pos>test.length){clearBuffer(i+1,len);break}}else settings.allowpartial&&tests[i]?(test.length&&(buffer[i]=test.charAt(pos),pos++),i<partialPosition&&(lastMatch=i)):(buffer[i]===test.charAt(pos)&&pos++,i<partialPosition&&(lastMatch=i));return allow?writeBuffer():lastMatch+1<partialPosition?settings.autoclear||buffer.join("")===defaultBuffer?(input.val()&&input.val(""),clearBuffer(0,len)):writeBuffer():(writeBuffer(),input.val(input.val().substring(0,lastMatch+1))),partialPosition?i:firstNonMaskPos}input.data($.mask.dataName,function(){return $.map(buffer,function(c,i){return tests[i]&&c!=getPlaceholder(i)?c:null}).join("")});var isClick=!1;input.one("unmask",function(){input.off(".mask").removeData($.mask.dataName)}).on("mousedown.mask",function(e){isClick=!0}).on("click.mask",function(){isClick=!1}).on("focus.mask",function(ev){input.prop("readonly")||isClick&&!isEmpty()||(isEmpty()?setTimeout(function(){input.caret(0)},0):(input.caret(0,checkVal()),ev.preventDefault()))}).on("blur.mask",blurEvent).on("keydown.mask",keydownEvent).on("keypress.mask",keypressEvent).on("input.mask paste.mask",function(){input.prop("readonly")||setTimeout(function(){var pos=checkVal(!0);input.caret(pos),tryFireCompleted()},0)}),chrome&&android&&input.off("input.mask").on("input.mask",androidInputEvent),checkVal()})}})}),function(E){function t(c,a,e){var f,k,l,h,m,w,n,v,g=0,b=[],d=0,q=!1,r=!1,p=[],t=[],u=!1;if(e=e||{},f=e.encoding||"UTF8",v=e.numRounds||1,l=y(a,f),v!==parseInt(v,10)||1>v)throw Error("numRounds must a integer >= 1");if("SHA-1"!==c)throw Error("Chosen SHA variant is not supported");m=512,w=z,n=F,h=160,k=x(c),this.setHMACKey=function(a,b,d){var e;if(!0===r)throw Error("HMAC key already set");if(!0===q)throw Error("Cannot set HMAC key after finalizing hash");if(!0===u)throw Error("Cannot set HMAC key after calling update");if(f=(d||{}).encoding||"UTF8",b=y(b,f)(a),a=b.binLen,b=b.value,e=m>>>3,d=e/4-1,e<a/8){for(b=n(b,a,0,x(c));b.length<=d;)b.push(0);b[d]&=4294967040}else if(e>a/8){for(;b.length<=d;)b.push(0);b[d]&=4294967040}for(a=0;a<=d;a+=1)p[a]=909522486^b[a],t[a]=1549556828^b[a];k=w(p,k),g=m,r=!0},this.update=function(a){var c,e,f,h=0,n=m>>>5;for(c=l(a,b,d),a=c.binLen,e=c.value,c=a>>>5,f=0;f<c;f+=n)h+m<=a&&(k=w(e.slice(f,f+n),k),h+=m);g+=h,b=e.slice(h>>>5),d=a%m,u=!0},this.getHash=function(a,e){var f,l,m;if(!0===r)throw Error("Cannot call getHash after setting HMAC key");switch(m=A(e),a){case"HEX":f=function(a){return B(a,m)};break;case"B64":f=function(a){return C(a,m)};break;case"BYTES":f=D;break;default:throw Error("format must be HEX, B64, or BYTES")}if(!1===q)for(k=n(b,d,g,k),l=1;l<v;l+=1)k=n(k,h,0,x(c));return q=!0,f(k)},this.getHMAC=function(a,e){var f,l,p;if(!1===r)throw Error("Cannot call getHMAC without first setting HMAC key");switch(p=A(e),a){case"HEX":f=function(a){return B(a,p)};break;case"B64":f=function(a){return C(a,p)};break;case"BYTES":f=D;break;default:throw Error("outputFormat must be HEX, B64, or BYTES")}return!1===q&&(l=n(b,d,g,k),k=w(t,x(c)),k=n(l,h,m,k)),q=!0,f(k)}}function G(c,a,e){var b,d,f,k,l,g=c.length;if(a=a||[0],e=e||0,l=e>>>3,0!=g%2)throw Error("String of HEX type must be in byte increments");for(b=0;b<g;b+=2){if(d=parseInt(c.substr(b,2),16),isNaN(d))throw Error("String of HEX type contains invalid characters");for(k=(b>>>1)+l,f=k>>>2;a.length<=f;)a.push(0);a[f]|=d<<8*(3-k%4)}return{value:a,binLen:4*g+e}}function H(c,a,e){var b,d,f,k,g=[],g=a||[0];for(e=e||0,d=e>>>3,b=0;b<c.length;b+=1)a=c.charCodeAt(b),k=b+d,f=k>>>2,g.length<=f&&g.push(0),g[f]|=a<<8*(3-k%4);return{value:g,binLen:8*c.length+e}}function I(c,a,e){var d,f,k,l,h,m,g=[],b=0,g=a||[0];if(e=e||0,a=e>>>3,-1===c.search(/^[a-zA-Z0-9=+\/]+$/))throw Error("Invalid character in base-64 string");if(f=c.indexOf("="),c=c.replace(/\=/g,""),-1!==f&&f<c.length)throw Error("Invalid '=' found in base-64 string");for(f=0;f<c.length;f+=4){for(h=c.substr(f,4),k=l=0;k<h.length;k+=1)d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(h[k]),l|=d<<18-6*k;for(k=0;k<h.length-1;k+=1){for(m=b+a,d=m>>>2;g.length<=d;)g.push(0);g[d]|=(l>>>16-8*k&255)<<8*(3-m%4),b+=1}}return{value:g,binLen:8*b+e}}function B(c,a){var b,d,e="",g=4*c.length;for(b=0;b<g;b+=1)d=c[b>>>2]>>>8*(3-b%4),e+="0123456789abcdef".charAt(d>>>4&15)+"0123456789abcdef".charAt(15&d);return a.outputUpper?e.toUpperCase():e}function C(c,a){var b,d,f,e="",g=4*c.length;for(b=0;b<g;b+=3)for(f=b+1>>>2,d=c.length<=f?0:c[f],f=b+2>>>2,f=c.length<=f?0:c[f],f=(c[b>>>2]>>>8*(3-b%4)&255)<<16|(d>>>8*(3-(b+1)%4)&255)<<8|f>>>8*(3-(b+2)%4)&255,
d=0;4>d;d+=1)8*b+6*d<=32*c.length?e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(f>>>6*(3-d)&63):e+=a.b64Pad;return e}function D(c){var g,b,a="",e=4*c.length;for(g=0;g<e;g+=1)b=c[g>>>2]>>>8*(3-g%4)&255,a+=String.fromCharCode(b);return a}function A(c){var a={outputUpper:!1,b64Pad:"="};if(c=c||{},a.outputUpper=c.outputUpper||!1,a.b64Pad=c.b64Pad||"=","boolean"!=typeof a.outputUpper)throw Error("Invalid outputUpper formatting option");if("string"!=typeof a.b64Pad)throw Error("Invalid b64Pad formatting option");return a}function y(c,a){var e;switch(a){case"UTF8":case"UTF16BE":case"UTF16LE":break;default:throw Error("encoding must be UTF8, UTF16BE, or UTF16LE")}switch(c){case"HEX":e=G;break;case"TEXT":e=function(e,b,d){var h,m,p,n,q,f=[],c=[],l=0,f=b||[0];if(b=d||0,p=b>>>3,"UTF8"===a)for(h=0;h<e.length;h+=1)for(d=e.charCodeAt(h),c=[],128>d?c.push(d):2048>d?(c.push(192|d>>>6),c.push(128|63&d)):55296>d||57344<=d?c.push(224|d>>>12,128|d>>>6&63,128|63&d):(h+=1,d=65536+((1023&d)<<10|1023&e.charCodeAt(h)),c.push(240|d>>>18,128|d>>>12&63,128|d>>>6&63,128|63&d)),m=0;m<c.length;m+=1){for(q=l+p,n=q>>>2;f.length<=n;)f.push(0);f[n]|=c[m]<<8*(3-q%4),l+=1}else if("UTF16BE"===a||"UTF16LE"===a)for(h=0;h<e.length;h+=1){for(d=e.charCodeAt(h),"UTF16LE"===a&&(m=255&d,d=m<<8|d>>>8),q=l+p,n=q>>>2;f.length<=n;)f.push(0);f[n]|=d<<8*(2-q%4),l+=2}return{value:f,binLen:8*l+b}};break;case"B64":e=I;break;case"BYTES":e=H;break;default:throw Error("format must be HEX, TEXT, B64, or BYTES")}return e}function r(c,a){return c<<a|c>>>32-a}function p(c,a){var e=(65535&c)+(65535&a);return((c>>>16)+(a>>>16)+(e>>>16)&65535)<<16|65535&e}function u(c,a,e,g,b){var d=(65535&c)+(65535&a)+(65535&e)+(65535&g)+(65535&b);return((c>>>16)+(a>>>16)+(e>>>16)+(g>>>16)+(b>>>16)+(d>>>16)&65535)<<16|65535&d}function x(c){if("SHA-1"!==c)throw Error("No SHA variants supported");return c=[1732584193,4023233417,2562383102,271733878,3285377520]}function z(c,a){var g,b,d,f,k,l,h,e=[];for(g=a[0],b=a[1],d=a[2],f=a[3],k=a[4],h=0;80>h;h+=1)e[h]=16>h?c[h]:r(e[h-3]^e[h-8]^e[h-14]^e[h-16],1),l=20>h?u(r(g,5),b&d^~b&f,k,1518500249,e[h]):40>h?u(r(g,5),b^d^f,k,1859775393,e[h]):60>h?u(r(g,5),b&d^b&f^d&f,k,2400959708,e[h]):u(r(g,5),b^d^f,k,3395469782,e[h]),k=f,f=d,d=r(b,30),b=g,g=l;return a[0]=p(g,a[0]),a[1]=p(b,a[1]),a[2]=p(d,a[2]),a[3]=p(f,a[3]),a[4]=p(k,a[4]),a}function F(c,a,e,g){var b;for(b=15+(a+65>>>9<<4);c.length<=b;)c.push(0);for(c[a>>>5]|=128<<24-a%32,c[b]=a+e,e=c.length,a=0;a<e;a+=16)g=z(c.slice(a,a+16),g);return g}"function"==typeof define&&define.amd?define(function(){return t}):"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports?module.exports=exports=t:exports=t:E.jsSHA=t}(this),function(){"use strict";var document="undefined"!=typeof window&&void 0!==window.document?window.document:{},isCommonjs="undefined"!=typeof module&&module.exports,keyboardAllowed="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element,fn=function(){for(var val,fnMap=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],i=0,l=fnMap.length,ret={};i<l;i++)if((val=fnMap[i])&&val[1]in document){for(i=0;i<val.length;i++)ret[fnMap[0][i]]=val[i];return ret}return!1}(),eventNameMap={change:fn.fullscreenchange,error:fn.fullscreenerror},screenfull={request:function(elem){var request=fn.requestFullscreen;elem=elem||document.documentElement,/ Version\/5\.1(?:\.\d+)? Safari\//.test(navigator.userAgent)?elem[request]():elem[request](keyboardAllowed?Element.ALLOW_KEYBOARD_INPUT:{})},exit:function(){document[fn.exitFullscreen]()},toggle:function(elem){this.isFullscreen?this.exit():this.request(elem)},onchange:function(callback){this.on("change",callback)},onerror:function(callback){this.on("error",callback)},on:function(event,callback){var eventName=eventNameMap[event];eventName&&document.addEventListener(eventName,callback,!1)},off:function(event,callback){var eventName=eventNameMap[event];eventName&&document.removeEventListener(eventName,callback,!1)},raw:fn};if(!fn)return void(isCommonjs?module.exports=!1:window.screenfull=!1);Object.defineProperties(screenfull,{isFullscreen:{get:function(){return Boolean(document[fn.fullscreenElement])}},element:{enumerable:!0,get:function(){return document[fn.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return Boolean(document[fn.fullscreenEnabled])}}}),isCommonjs?module.exports=screenfull:window.screenfull=screenfull}(),function($){$.fn.getStyles=function(only,except){var style,name,product={};if(only&&only instanceof Array)for(var i=0,l=only.length;i<l;i++)name=only[i],product[name]=this.css(name);else if(this.length){var dom=this.get(0);if(window.getComputedStyle){var pattern=/\-([a-z])/g,uc=function(a,b){return b.toUpperCase()},camelize=function(string){return string.replace(pattern,uc)};if(style=window.getComputedStyle(dom,null)){var camel,value;if(style.length)for(var i=0,l=style.length;i<l;i++)name=style[i],camel=camelize(name),value=style.getPropertyValue(name),product[camel]=value;else for(name in style)camel=camelize(name),value=style.getPropertyValue(name)||style[name],product[camel]=value}}else if(style=dom.currentStyle)for(name in style)product[name]=style[name];else if(style=dom.style)for(name in style)"function"!=typeof style[name]&&(product[name]=style[name])}if(except&&except instanceof Array)for(var i=0,l=except.length;i<l;i++)name=except[i],delete product[name];return product},$.fn.copyCSS=function(source,only,except){var styles=$(source).getStyles(only,except);return this.css(styles),this}}(jQuery),function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.Recorder=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";module.exports=require("./recorder").Recorder},{"./recorder":2}],2:[function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.Recorder=void 0;var _inlineWorker=require("inline-worker"),_inlineWorker2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(_inlineWorker);function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var Recorder=exports.Recorder=function(){function Recorder(cfg){var _this=this;_classCallCheck(this,Recorder),this.config={bufferLen:4096,numChannels:2,mimeType:"audio/wav"},this.recording=!1,this.callbacks={getBuffer:[],exportWAV:[]},Object.assign(this.config,cfg),this.context=this.config.context,this.node=this.config.processor||(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=function(e){if(_this.recording){for(var buffer=[],channel=0;channel<_this.config.numChannels;channel++)buffer.push(e.inputBuffer.getChannelData(channel));_this.worker.postMessage({command:"record",buffer:buffer})}},this.node.connect(this.context.destination);var self={};this.worker=new _inlineWorker2.default(function(){var recLength=0,recBuffers=[],sampleRate=void 0,numChannels=void 0;self.onmessage=function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"exportWAV":exportWAV(e.data.type);break;case"getBuffer":getBuffer();break;case"clear":clear()}};function init(config){sampleRate=config.sampleRate,numChannels=config.numChannels,initBuffers()}function record(inputBuffer){for(var channel=0;channel<numChannels;channel++)recBuffers[channel].push(inputBuffer[channel]);recLength+=inputBuffer[0].length}function exportWAV(type){for(var buffers=[],channel=0;channel<numChannels;channel++)buffers.push(mergeBuffers(recBuffers[channel],recLength));var interleaved=void 0;interleaved=2===numChannels?interleave(buffers[0],buffers[1]):buffers[0];var dataview=encodeWAV(interleaved),audioBlob=new Blob([dataview],{type:type});self.postMessage({command:"exportWAV",data:audioBlob})}function getBuffer(){for(var buffers=[],channel=0;channel<numChannels;channel++)buffers.push(mergeBuffers(recBuffers[channel],recLength));self.postMessage({command:"getBuffer",data:buffers})}function clear(){recLength=0,recBuffers=[],initBuffers()}function initBuffers(){for(var channel=0;channel<numChannels;channel++)recBuffers[channel]=[]}function mergeBuffers(recBuffers,recLength){for(var result=new Float32Array(recLength),offset=0,i=0;i<recBuffers.length;i++)result.set(recBuffers[i],offset),offset+=recBuffers[i].length;return result}function interleave(inputL,inputR){for(var length=inputL.length+inputR.length,result=new Float32Array(length),index=0,inputIndex=0;index<length;)result[index++]=inputL[inputIndex],result[index++]=inputR[inputIndex],inputIndex++;return result}function floatTo16BitPCM(output,offset,input){for(var i=0;i<input.length;i++,offset+=2){var s=Math.max(-1,Math.min(1,input[i]));output.setInt16(offset,s<0?32768*s:32767*s,!0)}}function writeString(view,offset,string){for(var i=0;i<string.length;i++)view.setUint8(offset+i,string.charCodeAt(i))}function encodeWAV(samples){var buffer=new ArrayBuffer(44+2*samples.length),view=new DataView(buffer);return writeString(view,0,"RIFF"),view.setUint32(4,36+2*samples.length,!0),writeString(view,8,"WAVE"),writeString(view,12,"fmt "),view.setUint32(16,16,!0),view.setUint16(20,1,!0),view.setUint16(22,numChannels,!0),view.setUint32(24,sampleRate,!0),view.setUint32(28,4*sampleRate,!0),view.setUint16(32,2*numChannels,!0),view.setUint16(34,16,!0),writeString(view,36,"data"),view.setUint32(40,2*samples.length,!0),floatTo16BitPCM(view,44,samples),view}},self),this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels}}),this.worker.onmessage=function(e){var cb=_this.callbacks[e.data.command].pop();"function"==typeof cb&&cb(e.data.data)}}return _createClass(Recorder,[{key:"record",value:function(){this.recording=!0}},{key:"stop",value:function(){this.recording=!1}},{key:"clear",value:function(){this.worker.postMessage({command:"clear"})}},{key:"getBuffer",value:function(cb){if(!(cb=cb||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(cb),this.worker.postMessage({command:"getBuffer"})}},{key:"exportWAV",value:function(cb,mimeType){if(mimeType=mimeType||this.config.mimeType,!(cb=cb||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(cb),this.worker.postMessage({command:"exportWAV",type:mimeType})}}],[{key:"forceDownload",value:function(blob,filename){var url=(window.URL||window.webkitURL).createObjectURL(blob),link=window.document.createElement("a");link.href=url,link.download=filename||"output.wav";var click=document.createEvent("Event");click.initEvent("click",!0,!0),link.dispatchEvent(click)}}]),Recorder}();exports.default=Recorder},{"inline-worker":3}],3:[function(require,module,exports){"use strict";module.exports=require("./inline-worker")},{"./inline-worker":4}],4:[function(require,module,exports){(function(global){"use strict";var _createClass=function(){function defineProperties(target,props){for(var key in props){var prop=props[key];prop.configurable=!0,prop.value&&(prop.writable=!0)}Object.defineProperties(target,props)}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},WORKER_ENABLED=!!(global===global.window&&global.URL&&global.Blob&&global.Worker),InlineWorker=function(){function InlineWorker(func,self){var _this=this;if(_classCallCheck(this,InlineWorker),WORKER_ENABLED){var functionBody=func.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],url=global.URL.createObjectURL(new global.Blob([functionBody],{type:"text/javascript"}));return new global.Worker(url)}this.self=self,this.self.postMessage=function(data){setTimeout(function(){_this.onmessage({data:data})},0)},setTimeout(function(){func.call(self)},0)}return _createClass(InlineWorker,{postMessage:{value:function(data){var _this=this;setTimeout(function(){_this.self.onmessage({data:data})},0)}}}),InlineWorker}();module.exports=InlineWorker}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)});var TWEEN=TWEEN||function(){var _tweens=[];return{getAll:function(){return _tweens},removeAll:function(){_tweens=[]},add:function(tween){_tweens.push(tween)},remove:function(tween){var i=_tweens.indexOf(tween);-1!==i&&_tweens.splice(i,1)},update:function(time,preserve){if(0===_tweens.length)return!1;var i=0;for(time=void 0!==time?time:TWEEN.now();i<_tweens.length;)_tweens[i].update(time)||preserve?i++:_tweens.splice(i,1);return!0}}}();"undefined"==typeof window&&"undefined"!=typeof process?TWEEN.now=function(){var time=process.hrtime();return 1e3*time[0]+time[1]/1e6}:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?TWEEN.now=window.performance.now.bind(window.performance):void 0!==Date.now?TWEEN.now=Date.now:TWEEN.now=function(){return(new Date).getTime()},TWEEN.Tween=function(object){var _repeatDelayTime,_object=object,_valuesStart={},_valuesEnd={},_valuesStartRepeat={},_duration=1e3,_repeat=0,_yoyo=!1,_isPlaying=!1,_reversed=!1,_delayTime=0,_startTime=null,_easingFunction=TWEEN.Easing.Linear.None,_interpolationFunction=TWEEN.Interpolation.Linear,_chainedTweens=[],_onStartCallback=null,_onStartCallbackFired=!1,_onUpdateCallback=null,_onCompleteCallback=null,_onStopCallback=null;this.to=function(properties,duration){return _valuesEnd=properties,void 0!==duration&&(_duration=duration),this},this.start=function(time){TWEEN.add(this),_isPlaying=!0,_onStartCallbackFired=!1,_startTime=void 0!==time?time:TWEEN.now(),_startTime+=_delayTime;for(var property in _valuesEnd){if(_valuesEnd[property]instanceof Array){if(0===_valuesEnd[property].length)continue;_valuesEnd[property]=[_object[property]].concat(_valuesEnd[property])}void 0!==_object[property]&&(_valuesStart[property]=_object[property],_valuesStart[property]instanceof Array==!1&&(_valuesStart[property]*=1),_valuesStartRepeat[property]=_valuesStart[property]||0)}return this},this.stop=function(){return _isPlaying?(TWEEN.remove(this),_isPlaying=!1,null!==_onStopCallback&&_onStopCallback.call(_object,_object),this.stopChainedTweens(),this):this},this.end=function(){return this.update(_startTime+_duration),this},this.stopChainedTweens=function(){for(var i=0,numChainedTweens=_chainedTweens.length;i<numChainedTweens;i++)_chainedTweens[i].stop()},this.delay=function(amount){return _delayTime=amount,this},this.repeat=function(times){return _repeat=times,this},this.repeatDelay=function(amount){return _repeatDelayTime=amount,this},this.yoyo=function(yoyo){return _yoyo=yoyo,this},this.easing=function(easing){return _easingFunction=easing,this},this.interpolation=function(interpolation){return _interpolationFunction=interpolation,this},this.chain=function(){return _chainedTweens=arguments,this},this.onStart=function(callback){return _onStartCallback=callback,this},this.onUpdate=function(callback){return _onUpdateCallback=callback,this},this.onComplete=function(callback){return _onCompleteCallback=callback,this},this.onStop=function(callback){return _onStopCallback=callback,this},this.update=function(time){var property,elapsed,value;if(time<_startTime)return!0;!1===_onStartCallbackFired&&(null!==_onStartCallback&&_onStartCallback.call(_object,_object),_onStartCallbackFired=!0),elapsed=(time-_startTime)/_duration,elapsed=elapsed>1?1:elapsed,value=_easingFunction(elapsed);for(property in _valuesEnd)if(void 0!==_valuesStart[property]){var start=_valuesStart[property]||0,end=_valuesEnd[property];end instanceof Array?_object[property]=_interpolationFunction(end,value):("string"==typeof end&&(end="+"===end.charAt(0)||"-"===end.charAt(0)?start+parseFloat(end):parseFloat(end)),"number"==typeof end&&(_object[property]=start+(end-start)*value))}if(null!==_onUpdateCallback&&_onUpdateCallback.call(_object,value),1===elapsed){if(_repeat>0){isFinite(_repeat)&&_repeat--;for(property in _valuesStartRepeat){if("string"==typeof _valuesEnd[property]&&(_valuesStartRepeat[property]=_valuesStartRepeat[property]+parseFloat(_valuesEnd[property])),_yoyo){var tmp=_valuesStartRepeat[property];_valuesStartRepeat[property]=_valuesEnd[property],_valuesEnd[property]=tmp}_valuesStart[property]=_valuesStartRepeat[property]}return _yoyo&&(_reversed=!_reversed),_startTime=void 0!==_repeatDelayTime?time+_repeatDelayTime:time+_delayTime,!0}null!==_onCompleteCallback&&_onCompleteCallback.call(_object,_object);for(var i=0,numChainedTweens=_chainedTweens.length;i<numChainedTweens;i++)_chainedTweens[i].start(_startTime+_duration);return!1}return!0}},TWEEN.Easing={Linear:{None:function(k){return k}},Quadratic:{In:function(k){return k*k},Out:function(k){return k*(2-k)},InOut:function(k){return(k*=2)<1?.5*k*k:-.5*(--k*(k-2)-1)}},Cubic:{In:function(k){return k*k*k},Out:function(k){return--k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k:.5*((k-=2)*k*k+2)}},Quartic:{In:function(k){return k*k*k*k},Out:function(k){return 1- --k*k*k*k},InOut:function(k){return(k*=2)<1?.5*k*k*k*k:-.5*((k-=2)*k*k*k-2)}},Quintic:{In:function(k){return k*k*k*k*k},Out:function(k){return--k*k*k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k*k*k:.5*((k-=2)*k*k*k*k+2)}},Sinusoidal:{In:function(k){return 1-Math.cos(k*Math.PI/2)},Out:function(k){return Math.sin(k*Math.PI/2)},InOut:function(k){return.5*(1-Math.cos(Math.PI*k))}},Exponential:{In:function(k){return 0===k?0:Math.pow(1024,k-1)},Out:function(k){return 1===k?1:1-Math.pow(2,-10*k)},InOut:function(k){return 0===k?0:1===k?1:(k*=2)<1?.5*Math.pow(1024,k-1):.5*(2-Math.pow(2,-10*(k-1)))}},Circular:{In:function(k){return 1-Math.sqrt(1-k*k)},Out:function(k){return Math.sqrt(1- --k*k)},InOut:function(k){return(k*=2)<1?-.5*(Math.sqrt(1-k*k)-1):.5*(Math.sqrt(1-(k-=2)*k)+1)}},Elastic:{In:function(k){return 0===k?0:1===k?1:-Math.pow(2,10*(k-1))*Math.sin(5*(k-1.1)*Math.PI)},Out:function(k){return 0===k?0:1===k?1:Math.pow(2,-10*k)*Math.sin(5*(k-.1)*Math.PI)+1},InOut:function(k){return 0===k?0:1===k?1:(k*=2,k<1?-.5*Math.pow(2,10*(k-1))*Math.sin(5*(k-1.1)*Math.PI):.5*Math.pow(2,-10*(k-1))*Math.sin(5*(k-1.1)*Math.PI)+1)}},Back:{In:function(k){var s=1.70158;return k*k*((s+1)*k-s)},Out:function(k){var s=1.70158;return--k*k*((s+1)*k+s)+1},InOut:function(k){var s=2.5949095;return(k*=2)<1?k*k*((s+1)*k-s)*.5:.5*((k-=2)*k*((s+1)*k+s)+2)}},Bounce:{In:function(k){return 1-TWEEN.Easing.Bounce.Out(1-k)},Out:function(k){return k<1/2.75?7.5625*k*k:k<2/2.75?7.5625*(k-=1.5/2.75)*k+.75:k<2.5/2.75?7.5625*(k-=2.25/2.75)*k+.9375:7.5625*(k-=2.625/2.75)*k+.984375},InOut:function(k){return k<.5?.5*TWEEN.Easing.Bounce.In(2*k):.5*TWEEN.Easing.Bounce.Out(2*k-1)+.5}}},TWEEN.Interpolation={Linear:function(v,k){var m=v.length-1,f=m*k,i=Math.floor(f),fn=TWEEN.Interpolation.Utils.Linear;return k<0?fn(v[0],v[1],f):k>1?fn(v[m],v[m-1],m-f):fn(v[i],v[i+1>m?m:i+1],f-i)},Bezier:function(v,k){for(var b=0,n=v.length-1,pw=Math.pow,bn=TWEEN.Interpolation.Utils.Bernstein,i=0;i<=n;i++)b+=pw(1-k,n-i)*pw(k,i)*v[i]*bn(n,i);return b},CatmullRom:function(v,k){var m=v.length-1,f=m*k,i=Math.floor(f),fn=TWEEN.Interpolation.Utils.CatmullRom;return v[0]===v[m]?(k<0&&(i=Math.floor(f=m*(1+k))),fn(v[(i-1+m)%m],v[i],v[(i+1)%m],v[(i+2)%m],f-i)):k<0?v[0]-(fn(v[0],v[0],v[1],v[1],-f)-v[0]):k>1?v[m]-(fn(v[m],v[m],v[m-1],v[m-1],f-m)-v[m]):fn(v[i?i-1:0],v[i],v[m<i+1?m:i+1],v[m<i+2?m:i+2],f-i)},Utils:{Linear:function(p0,p1,t){return(p1-p0)*t+p0},Bernstein:function(n,i){var fc=TWEEN.Interpolation.Utils.Factorial;return fc(n)/fc(i)/fc(n-i)},Factorial:function(){var a=[1];return function(n){var s=1;if(a[n])return a[n];for(var i=n;i>1;i--)s*=i;return a[n]=s,s}}(),CatmullRom:function(p0,p1,p2,p3,t){var v0=.5*(p2-p0),v1=.5*(p3-p1),t2=t*t;return(2*p1-2*p2+v0+v1)*(t*t2)+(-3*p1+3*p2-2*v0-v1)*t2+v0*t+p1}}},function(root){"function"==typeof define&&define.amd?define([],function(){return TWEEN}):"undefined"!=typeof module&&"object"==typeof exports?module.exports=TWEEN:void 0!==root&&(root.TWEEN=TWEEN)}(this);var isRenderGGBElementEnabled=!1,scriptLoadStarted=!1,html5AppletsToProcess=null,ggbHTML5LoadedCodebaseIsWebSimple=!1,ggbHTML5LoadedCodebaseVersion=null,ggbHTML5LoadedScript=null,GGBApplet=function(){"use strict";for(var applet={},ggbVersion="5.0",parameters={},views=null,html5NoWebSimple=!1,html5NoWebSimpleParamExists=!1,appletID=null,initComplete=!1,html5OverwrittenCodebaseVersion=null,html5OverwrittenCodebase=null,i=0;i<arguments.length;i++){var p=arguments[i];if(null!==p)switch(typeof p){case"number":ggbVersion=p.toFixed(1);break;case"string":p.match(new RegExp("^[0-9]\\.[0-9]+$"))?ggbVersion=p:appletID=p;break;case"object":void 0!==p.is3D?views=p:parameters=p;break;case"boolean":html5NoWebSimple=p,html5NoWebSimpleParamExists=!0}}null===views&&(views={is3D:!1,AV:!1,SV:!1,CV:!1,EV2:!1,CP:!1,PC:!1,DA:!1,FI:!1,PV:!1,macro:!1},void 0===parameters.material_id||html5NoWebSimpleParamExists||(html5NoWebSimple=!0)),null!==appletID&&void 0===parameters.id&&(parameters.id=appletID);var jnlpFilePath="",html5Codebase="",isHTML5Offline=!1,loadedAppletType=null,html5CodebaseVersion=null,html5CodebaseScript=null,html5CodebaseIsWebSimple=!1,previewImagePath=null,previewLoadingPath=null,previewPlayPath=null,fonts_css_url=null;void 0!==parameters.height&&(parameters.height=Math.round(parameters.height)),void 0!==parameters.width&&(parameters.width=Math.round(parameters.width));var parseVersion=function(d){return parseFloat(d)>4?parseFloat(d):5};applet.setHTML5Codebase=function(codebase,offline){html5OverwrittenCodebase=codebase,setHTML5CodebaseInternal(codebase,offline)},applet.setJavaCodebase=applet.setJavaCodebaseVersion=applet.isCompiledInstalled=applet.setPreCompiledScriptPath=applet.setPreCompiledResourcePath=function(){},applet.setHTML5CodebaseVersion=function(version,offline){var numVersion=parseFloat(version);if(NaN!==numVersion&&numVersion<5)return void console.log("The GeoGebra HTML5 codebase version "+numVersion+" is deprecated. Using version latest instead.");html5OverwrittenCodebaseVersion=version,setDefaultHTML5CodebaseForVersion(version,offline)},applet.getHTML5CodebaseVersion=function(){return html5CodebaseVersion},applet.getParameters=function(){return parameters},applet.setFontsCSSURL=function(url){fonts_css_url=url},applet.setGiacJSURL=function(url){},applet.setJNLPFile=function(newJnlpFilePath){jnlpFilePath=newJnlpFilePath},applet.setJNLPBaseDir=function(baseDir){},applet.inject=function(){function isOwnIFrame(){return window.frameElement&&window.frameElement.getAttribute("data-singleton")}for(var container,type="auto",container_ID=parameters.id,noPreview=!1,i=0;i<arguments.length;i++){var p=arguments[i];"string"==typeof p?(p=p.toLowerCase(),p.match(/^(prefer)?(java|html5|compiled|auto|screenshot)$/)?type=p:container_ID=arguments[i]):"boolean"==typeof p?noPreview=p:p instanceof HTMLElement&&(container=p)}continueInject();function continueInject(){if(!initComplete)return void setTimeout(continueInject,200);type=detectAppletType(type);var appletElem=container||document.getElementById(container_ID);if(!appletElem)return void console.log("possibly bug on ajax loading? ");if(applet.removeExistingApplet(appletElem,!1),void 0===parameters.width&&appletElem.clientWidth&&(parameters.width=appletElem.clientWidth),void 0===parameters.height&&appletElem.clientHeight&&(parameters.height=appletElem.clientHeight),parameters.width&&parameters.height||"html5"!==type||(delete parameters.width,delete parameters.height),loadedAppletType=type,"screenshot"===type)injectScreenshot(appletElem,parameters);else{var playButton=!1;parameters.hasOwnProperty("playButton")&&parameters.playButton||parameters.hasOwnProperty("clickToLoad")&&parameters.clickToLoad?playButton=!0:parameters.hasOwnProperty("playButtonAutoDecide")&&parameters.playButtonAutoDecide&&(playButton=(!isInIframe()||isOwnIFrame())&&isMobileDevice()),playButton?(loadedAppletType="screenshot",injectPlayButton(appletElem,parameters,noPreview,type)):injectHTML5Applet(appletElem,parameters,noPreview)}}};function isInIframe(){try{return window.self!==window.top}catch(e){return!0}}function isMobileDevice(){return(!parameters.hasOwnProperty("screenshotGenerator")||!parameters.screenshotGenerator)&&Math.max(screen.width,screen.height)<800}applet.getViews=function(){return views},applet.isJavaInstalled=function(){return!1};var getTubeURL=function(){return void 0!==parameters.tubeurl?parameters.tubeurl:window.location.host.indexOf("www.geogebra.org")>-1||window.location.host.indexOf("alpha.geogebra.org")>-1||window.location.host.indexOf("groot.geogebra.org")>-1||window.location.host.indexOf("beta.geogebra.org")>-1||window.location.host.indexOf("stage.geogebra.org")>-1?window.location.protocol+"//"+window.location.host:"https://www.geogebra.org"};function createCORSRequest(method,url){var xhr=new XMLHttpRequest;return"withCredentials"in xhr?xhr.open(method,url,!0):"undefined"!=typeof XDomainRequest?(xhr=new XDomainRequest,xhr.open(method,url)):xhr=null,xhr}applet.isHTML5Installed=function(){if(isInternetExplorer()){if((views.is3D||"web3d.nocache.js"===html5CodebaseScript)&&getIEVersion()<11)return!1;if(getIEVersion()<10)return!1}return!0},applet.getLoadedAppletType=function(){return loadedAppletType},applet.setPreviewImage=function(previewFilePath,loadingFilePath,playFilePath){previewImagePath=previewFilePath,previewLoadingPath=loadingFilePath,previewPlayPath=playFilePath},applet.removeExistingApplet=function(appletParent,showScreenshot){var i;for("string"==typeof appletParent&&(appletParent=document.getElementById(appletParent)),loadedAppletType=null,i=0;i<appletParent.childNodes.length;i++){var tag=appletParent.childNodes[i].tagName,className=appletParent.childNodes[i].className;"applet_screenshot"===appletParent.childNodes[i].className?showScreenshot?(appletParent.childNodes[i].style.display="block",loadedAppletType="screenshot"):appletParent.childNodes[i].style.display="none":"APPLET"!==tag&&"ARTICLE"!==tag&&"DIV"!==tag||"applet_scaler prerender"===className||(appletParent.removeChild(appletParent.childNodes[i]),i--)}var appName=void 0!==parameters.id?parameters.id:"ggbApplet",app=window[appName];app&&"object"==typeof app&&"function"==typeof app.getBase64&&(app.remove(),window[appName]=null)},applet.refreshHitPoints=function(){if(parseVersion(ggbHTML5LoadedCodebaseVersion)>=5)return!0;var app=applet.getAppletObject();return!(!app||"function"!=typeof app.recalculateEnvironments)&&(app.recalculateEnvironments(),!0)},applet.startAnimation=function(){var app=applet.getAppletObject();return!(!app||"function"!=typeof app.startAnimation)&&(app.startAnimation(),!0)},applet.stopAnimation=function(){var app=applet.getAppletObject();return!(!app||"function"!=typeof app.stopAnimation)&&(app.stopAnimation(),!0)},applet.getAppletObject=function(){var appName=void 0!==parameters.id?parameters.id:"ggbApplet";return window[appName]},applet.resize=function(){};var valBoolean=function(value){return value&&"false"!==value},injectHTML5Applet=function(appletElem,parameters,noPreview){parseVersion(html5CodebaseVersion)<=4.2&&(noPreview=!0);var loadScript=!isRenderGGBElementEnabled&&!scriptLoadStarted;(!isRenderGGBElementEnabled&&!scriptLoadStarted||ggbHTML5LoadedCodebaseVersion!==html5CodebaseVersion||ggbHTML5LoadedCodebaseIsWebSimple&&!html5CodebaseIsWebSimple)&&(loadScript=!0,isRenderGGBElementEnabled=!1,scriptLoadStarted=!1);var article=document.createElement("article"),oriWidth=parameters.width,oriHeight=parameters.height;if(parameters.disableAutoScale=void 0===parameters.disableAutoScale?GGBAppletUtils.isFlexibleWorksheetEditor():parameters.disableAutoScale,void 0!==parameters.width)if(parseVersion(html5CodebaseVersion)<=4.4)valBoolean(parameters.showToolBar)&&(parameters.height-=7),valBoolean(parameters.showAlgebraInput)&&(parameters.height-=37),parameters.width<605&&valBoolean(parameters.showToolBar)&&(parameters.width=605,oriWidth=605);else{var minWidth=100;(valBoolean(parameters.showToolBar)||valBoolean(parameters.showMenuBar))&&(parameters.hasOwnProperty("customToolBar")&&(parameters.customToolbar=parameters.customToolBar),minWidth=valBoolean(parameters.showMenuBar)?245:155),oriWidth<minWidth&&(parameters.width=minWidth,oriWidth=minWidth)}article.className="notranslate",article.style.border="none",article.style.display="inline-block";for(var key in parameters)parameters.hasOwnProperty(key)&&"appletOnLoad"!==key&&article.setAttribute("data-param-"+key,parameters[key]);if(fonts_css_url&&article.setAttribute("data-param-fontscssurl",fonts_css_url),applet.resize=function(){GGBAppletUtils.responsiveResize(appletElem,parameters)},"function"==typeof jQuery)jQuery(window).resize(function(){applet.resize()});else{var oldOnResize=null;void 0!==window.onresize&&"function"==typeof window.onresize&&(oldOnResize=window.onresize),window.onresize=function(){applet.resize(),"function"==typeof oldOnResize&&oldOnResize()}}var oriAppletOnload="function"==typeof parameters.appletOnLoad?parameters.appletOnLoad:function(){};if(noPreview||void 0===parameters.width){var appletScaler=document.createElement("div");appletScaler.className="applet_scaler",appletScaler.style.position="relative",appletScaler.style.display="block",appletScaler.appendChild(article),appletElem.appendChild(appletScaler),parameters.appletOnLoad=function(api){applet.resize(),oriAppletOnload(api)}}else{parameters.hasOwnProperty("showSplash")||article.setAttribute("data-param-showSplash","false");var previewPositioner=appletElem.querySelector(".applet_scaler.prerender"),preRendered=null!==previewPositioner;if(preRendered)var previewContainer=previewPositioner.querySelector(".ggb_preview");else{var previewContainer=createScreenShotDiv(oriWidth,oriHeight,parameters.borderColor,!1);previewPositioner=document.createElement("div"),previewPositioner.className="applet_scaler",previewPositioner.style.position="relative",previewPositioner.style.display="block",previewPositioner.style.width=oriWidth+"px",previewPositioner.style.height=oriHeight+"px"}
window.GGBT_spinner&&window.GGBT_spinner.attachSpinner(previewPositioner,"66%"),parseVersion(html5CodebaseVersion)>=5?(parameters.appletOnLoad=function(api){var preview=appletElem.querySelector(".ggb_preview");preview&&preview.parentNode.removeChild(preview),window.GGBT_spinner&&window.GGBT_spinner.removeSpinner(previewPositioner),window.GGBT_wsf_view?$(window).trigger("resize"):window.onresize(),oriAppletOnload(api)},preRendered||previewPositioner.appendChild(previewContainer)):article.appendChild(previewContainer),previewPositioner.appendChild(article),preRendered||appletElem.appendChild(previewPositioner),setTimeout(function(){applet.resize()},1)}function renderGGBElementWithParams(article,parameters){parameters&&"function"==typeof parameters.appletOnLoad&&"function"==typeof renderGGBElement?renderGGBElement(article,parameters.appletOnLoad):renderGGBElement(article),log("GeoGebra HTML5 applet injected and rendered with previously loaded codebase.",parameters)}function renderGGBElementOnTube(a,parameters){"undefined"==typeof renderGGBElement?(null===html5AppletsToProcess&&(html5AppletsToProcess=[]),html5AppletsToProcess.push({article:a,params:parameters}),window.renderGGBElementReady=function(){isRenderGGBElementEnabled=!0,null!==html5AppletsToProcess&&html5AppletsToProcess.length&&(html5AppletsToProcess.forEach(function(obj){renderGGBElementWithParams(obj.article,obj.params)}),html5AppletsToProcess=null)},parseVersion(html5CodebaseVersion)<5&&(a.className+=" geogebraweb")):renderGGBElementWithParams(a,parameters)}if(loadScript){scriptLoadStarted=!0;for(var i=0;i<article.childNodes.length;i++){"TABLE"===article.childNodes[i].tagName&&(article.removeChild(article.childNodes[i]),i--)}if(null!==ggbHTML5LoadedScript){var el=document.querySelector('script[src="'+ggbHTML5LoadedScript+'"]');void 0!==el&&null!==el&&el.parentNode.removeChild(el)}var script=document.createElement("script"),scriptLoaded=function(){renderGGBElementOnTube(article,parameters)};script.src=html5Codebase+html5CodebaseScript,ggbHTML5LoadedCodebaseIsWebSimple=html5CodebaseIsWebSimple,ggbHTML5LoadedCodebaseVersion=html5CodebaseVersion,ggbHTML5LoadedScript=script.src,log("GeoGebra HTML5 codebase loaded: '"+html5Codebase+"'.",parameters),html5OverwrittenCodebase||html5OverwrittenCodebaseVersion&&"5.0"!=html5OverwrittenCodebaseVersion?html5Codebase.requirejs?require(["geogebra/runtime/js/web3d/web3d.nocache"],scriptLoaded):(script.onload=scriptLoaded,appletElem.appendChild(script)):(html5CodebaseIsWebSimple?webSimple.succeeded=webSimple.succeeded||webSimple():web3d.succeeded=web3d.succeeded||web3d(),scriptLoaded())}else renderGGBElementOnTube(article,parameters);parameters.height=oriHeight,parameters.width=oriWidth},injectScreenshot=function(appletElem,parameters,showPlayButton){var previewContainer=createScreenShotDiv(parameters.width,parameters.height,parameters.borderColor,showPlayButton),previewPositioner=document.createElement("div");previewPositioner.style.position="relative",previewPositioner.style.display="block",previewPositioner.style.width=parameters.width+"px",previewPositioner.style.height=parameters.height+"px",previewPositioner.className="applet_screenshot applet_scaler"+(showPlayButton?" applet_screenshot_play":""),previewPositioner.appendChild(previewContainer);var scale=GGBAppletUtils.getScale(parameters,appletElem,showPlayButton);if(showPlayButton?(appletElem.appendChild(getPlayButton()),window.GGBT_wsf_view||(appletElem.style.position="relative")):window.GGBT_spinner&&window.GGBT_spinner.attachSpinner(previewPositioner,"66%"),appletElem.appendChild(previewPositioner),1===scale||isNaN(scale)||(GGBAppletUtils.scaleElement(previewPositioner,scale),previewPositioner.style.width=parameters.width+"px",previewPositioner.style.height=parameters.height+"px",previewPositioner.parentNode.style.width=parameters.width*scale+"px",previewPositioner.parentNode.style.height=parameters.height*scale+"px"),applet.resize=function(){resizeScreenshot(appletElem,previewContainer,previewPositioner,showPlayButton)},"function"==typeof jQuery)jQuery(window).resize(function(){applet.resize()});else{var oldOnResize=null;void 0!==window.onresize&&"function"==typeof window.onresize&&(oldOnResize=window.onresize),window.onresize=function(){applet.resize(),"function"==typeof oldOnResize&&oldOnResize()}}applet.resize()};function resizeScreenshot(appletElem,previewContainer,previewPositioner,showPlayButton,oldOnResize){if(appletElem.contains(previewContainer)){if("object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()){if("fullscreencontent"!==appletElem.id)return;window.GGBT_wsf_view.setCloseBtnPosition(appletElem)}var scale=GGBAppletUtils.getScale(parameters,appletElem,showPlayButton);null!==previewPositioner.parentNode&&(isNaN(scale)||1===scale?(GGBAppletUtils.scaleElement(previewPositioner,1),previewPositioner.parentNode.style.width=parameters.width+"px",previewPositioner.parentNode.style.height=parameters.height+"px"):(GGBAppletUtils.scaleElement(previewPositioner,scale),previewPositioner.parentNode.style.width=parameters.width*scale+"px",previewPositioner.parentNode.style.height=parameters.height*scale+"px")),"object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()&&GGBAppletUtils.positionCenter(appletElem),"object"==typeof window.GGBT_ws_header_footer&&window.GGBT_ws_header_footer.setWsScrollerHeight(),"function"==typeof oldOnResize&&oldOnResize()}}applet.onExitFullscreen=function(fullscreenContainer,appletElem){appletElem.appendChild(fullscreenContainer)};var injectPlayButton=function(appletElem,parameters,noPreview,type){injectScreenshot(appletElem,parameters,!0);for(var play=function(){var elems=[];for(i=0;i<appletElem.childNodes.length;i++)elems.push(appletElem.childNodes[i]);if(window.GGBT_wsf_view){var content=window.GGBT_wsf_view.renderFullScreen(appletElem,parameters.id),container=document.getElementById("fullscreencontainer"),oldcontent=jQuery(appletElem).find(".fullscreencontent");oldcontent.length>0?(content.remove(),oldcontent.attr("id","fullscreencontent").show(),jQuery(container).append(oldcontent),window.onresize()):injectHTML5Applet(content,parameters,!1),window.GGBT_wsf_view.launchFullScreen(container)}else loadedAppletType=type,injectHTML5Applet(appletElem,parameters,!1);if(!window.GGBT_wsf_view)for(i=0;i<elems.length;i++)appletElem.removeChild(elems[i])},imgs=appletElem.getElementsByClassName("ggb_preview_play"),i=0;i<imgs.length;i++)imgs[i].addEventListener("click",play,!1),imgs[i].addEventListener("ontouchstart",play,!1);"function"==typeof window.ggbAppletPlayerOnload&&window.ggbAppletPlayerOnload(appletElem),isMobileDevice()&&window.GGBT_wsf_view&&$(".wsf-element-fullscreen-button").remove()},getPlayButton=function(){var playButtonContainer=document.createElement("div");if(playButtonContainer.className="ggb_preview_play icon-applet-play",!window.GGBT_wsf_view){var css='.icon-applet-play {   width: 100%;   height: 100%;box-sizing: border-box;position: absolute;z-index: 1001;cursor: pointer;border-width: 0px;   background-color: transparent;background-repeat: no-repeat;left: 0;top: 0;background-position: center center;   background-image: url("'+getTubeURL()+'/images/worksheet/icon-start-applet.png");}.icon-applet-play:hover {background-image: url("'+getTubeURL()+'/images/worksheet/icon-start-applet-hover.png");}',style=document.createElement("style");style.styleSheet?style.styleSheet.cssText=css:style.appendChild(document.createTextNode(css)),document.getElementsByTagName("head")[0].appendChild(style)}return playButtonContainer},createScreenShotDiv=function(oriWidth,oriHeight,borderColor,showPlayButton){var previewContainer=document.createElement("div");previewContainer.className="ggb_preview",previewContainer.style.position="absolute",previewContainer.style.zIndex="90",previewContainer.style.width=oriWidth-2+"px",previewContainer.style.height=oriHeight-2+"px",previewContainer.style.top="0px",previewContainer.style.left="0px",previewContainer.style.overflow="hidden",previewContainer.style.backgroundColor="white";var bc="lightgrey";void 0!==borderColor&&(bc="none"===borderColor?"transparent":borderColor),previewContainer.style.border="1px solid "+bc;var preview=document.createElement("img");if(preview.style.position="relative",preview.style.zIndex="1000",preview.style.top="-1px",preview.style.left="-1px",null!==previewImagePath&&preview.setAttribute("src",previewImagePath),preview.style.opacity=.7,null!==previewLoadingPath){var previewOverlay,pWidth,pHeight;if(!showPlayButton){previewOverlay=document.createElement("img"),previewOverlay.style.position="absolute",previewOverlay.style.zIndex="1001",previewOverlay.style.opacity=1,preview.style.opacity=.3,pWidth=360,pWidth>oriWidth/4*3&&(pWidth=oriWidth/4*3),pHeight=pWidth/5.8,previewOverlay.setAttribute("src",previewLoadingPath),previewOverlay.setAttribute("width",pWidth),previewOverlay.setAttribute("height",pHeight);var pX=(oriWidth-pWidth)/2,pY=(oriHeight-pHeight)/2;previewOverlay.style.left=pX+"px",previewOverlay.style.top=pY+"px",previewContainer.appendChild(previewOverlay)}}return previewContainer.appendChild(preview),previewContainer},detectAppletType=function(preferredType){return preferredType=preferredType.toLowerCase(),"html5"===preferredType||"screenshot"===preferredType?preferredType:"html5"},getIEVersion=function(){var a=navigator.appVersion;return a.indexOf("Trident/7.0")>0?11:a.indexOf("MSIE")+1?parseFloat(a.split("MSIE")[1]):999},isInternetExplorer=function(){return 999!==getIEVersion()},modules=["web","webSimple","web3d","tablet","tablet3d","phone"],setDefaultHTML5CodebaseForVersion=function(version,offline){if(html5CodebaseVersion=version,offline)return void setHTML5CodebaseInternal(html5CodebaseVersion,!0);var hasWebSimple=!html5NoWebSimple;if(hasWebSimple){var v=parseVersion(html5CodebaseVersion);!isNaN(v)&&v<4.4&&(hasWebSimple=!1)}var protocol,codebase;protocol="http"===window.location.protocol.substr(0,4)?window.location.protocol:"http:";var index=html5CodebaseVersion.indexOf("//");codebase=index>0?html5CodebaseVersion:0===index?protocol+html5CodebaseVersion:"https://cdn.geogebra.org/apps/latest/";for(var key in modules)if(html5CodebaseVersion.slice(-1*modules[key].length)===modules[key]||html5CodebaseVersion.slice(-1*(modules[key].length+1))===modules[key]+"/")return void setHTML5CodebaseInternal(codebase,!1);GGBAppletUtils.isFlexibleWorksheetEditor()||!hasWebSimple||views.is3D||views.AV||views.SV||views.CV||views.EV2||views.CP||views.PC||views.DA||views.FI||views.PV||valBoolean(parameters.showToolBar)||valBoolean(parameters.showMenuBar)||valBoolean(parameters.showAlgebraInput)||valBoolean(parameters.enableRightClick)||parameters.appName&&"classic"!=parameters.appName?codebase+="web3d/":codebase+="webSimple/",setHTML5CodebaseInternal(codebase,!1)},setHTML5CodebaseInternal=function(codebase,offline){if(codebase.requirejs)return void(html5Codebase=codebase);"/"!==codebase.slice(-1)&&(codebase+="/"),html5Codebase=codebase,null===offline&&(offline=-1===codebase.indexOf("http")),isHTML5Offline=offline,html5CodebaseScript="web.nocache.js",html5CodebaseIsWebSimple=!1;var folders=html5Codebase.split("/");folders.length>1&&(offline||"webSimple"!==folders[folders.length-2]?modules.indexOf(folders[folders.length-2])>=0&&(html5CodebaseScript=folders[folders.length-2]+".nocache.js"):(html5CodebaseScript="webSimple.nocache.js",html5CodebaseIsWebSimple=!0)),folders=codebase.split("/"),html5CodebaseVersion=folders[folders.length-3],"test"===html5CodebaseVersion.substr(0,4)?html5CodebaseVersion=html5CodebaseVersion.substr(4,1)+"."+html5CodebaseVersion.substr(5,1):"war"!==html5CodebaseVersion.substr(0,3)&&"beta"!==html5CodebaseVersion.substr(0,4)||(html5CodebaseVersion="5.0");var numVersion=parseFloat(html5CodebaseVersion);NaN!==numVersion&&numVersion<5&&(console.log("The GeoGebra HTML5 codebase version "+numVersion+" is deprecated. Using version latest instead."),setDefaultHTML5CodebaseForVersion("5.0",offline))},log=function(text,parameters){window.console&&window.console.log&&(!parameters||void 0===parameters.showLogging||parameters.showLogging&&"false"!==parameters.showLogging)&&console.log(text)};void 0!==parameters.material_id?function(successCallback,materialsApiURL){var tubeurl=materialsApiURL?materialsApiURL.substring(0,materialsApiURL.indexOf("/",8)):getTubeURL(),api_request={request:{"-api":"1.0.0",login:{"-type":"cookie","-getuserinfo":"false"},task:{"-type":"fetch",fields:{field:[{"-name":"id"},{"-name":"geogebra_format"},{"-name":"width"},{"-name":"height"},{"-name":"toolbar"},{"-name":"menubar"},{"-name":"inputbar"},{"-name":"stylebar"},{"-name":"reseticon"},{"-name":"labeldrags"},{"-name":"shiftdragzoom"},{"-name":"rightclick"},{"-name":"ggbbase64"},{"-name":"preview_url"},{"-name":"appname"}]},filters:{field:[{"-name":"id","#text":""+parameters.material_id}]},order:{"-by":"id","-type":"asc"},limit:{"-num":"1"}}}},success=function(){var text=xhr.responseText,jsondata=JSON.parse(text),item=null;for(i=0;jsondata.responses&&i<jsondata.responses.response.length;i++)void 0!==jsondata.responses.response[i].item&&(item=jsondata.responses.response[i].item);if(null===item)return void onError();""!==item.geogebra_format&&(ggbVersion=item.geogebra_format),void 0===parameters.ggbBase64&&(parameters.ggbBase64=item.ggbBase64),void 0===parameters.width&&(parameters.width=item.width),void 0===parameters.height&&(parameters.height=item.height),void 0===parameters.showToolBar&&(parameters.showToolBar="true"===item.toolbar),void 0===parameters.showMenuBar&&(parameters.showMenuBar="true"===item.menubar),void 0===parameters.showAlgebraInput&&(parameters.showAlgebraInput="true"===item.inputbar),void 0===parameters.allowStyleBar&&(parameters.allowStyleBar="true"===item.stylebar),void 0===parameters.showResetIcon&&(parameters.showResetIcon="true"===item.reseticon),void 0===parameters.enableLabelDrags&&(parameters.enableLabelDrags="true"===item.labeldrags),void 0===parameters.enableShiftDragZoom&&(parameters.enableShiftDragZoom="true"===item.shiftdragzoom),void 0===parameters.enableRightClick&&(parameters.enableRightClick="true"===item.rightclick),void 0===parameters.showToolBarHelp&&(parameters.showToolBarHelp=parameters.showToolBar),void 0===parameters.appname&&(parameters.appname=item.appname),parseFloat(item.geogebra_format)>=5&&(views.is3D=!0);var previewUrl=void 0===item.previewUrl?tubeurl+"/files/material-"+item.id+".png":item.previewUrl;applet.setPreviewImage(previewImagePath||previewUrl,tubeurl+"/images/GeoGebra_loading.png",tubeurl+"/images/applet_play.png"),successCallback()},url=tubeurl+"/api/json.php",xhr=createCORSRequest("POST",url),onError=function(){parameters.onError&&parameters.onError(),log("Error: The request for fetching material_id "+parameters.material_id+" from tube was not successful.")};if(!xhr)return void onError();xhr.onload=success,xhr.onerror=onError,xhr.onprogress=function(){},xhr.setRequestHeader&&xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),xhr.send(JSON.stringify(api_request))}(continueInit,parameters.materialsApi):continueInit();function continueInit(){var html5Version=ggbVersion;null!==html5OverwrittenCodebaseVersion?html5Version=html5OverwrittenCodebaseVersion:parseFloat(html5Version)<5&&(html5Version="5.0"),setDefaultHTML5CodebaseForVersion(html5Version,!1),null!==html5OverwrittenCodebase&&setHTML5CodebaseInternal(html5OverwrittenCodebase,isHTML5Offline),initComplete=!0}return applet},GGBAppletUtils=function(){"use strict";function isFlexibleWorksheetEditor(){return void 0!==window.GGBT_wsf_edit}function scaleElement(el,scale){1!=scale?(el.style.transformOrigin="0% 0% 0px",el.style.webkitTransformOrigin="0% 0% 0px",el.style.transform="scale("+scale+","+scale+")",el.style.webkitTransform="scale("+scale+","+scale+")",el.style.maxWidth="initial",null!==el.querySelector(".ggb_preview")&&(el.querySelector(".ggb_preview").style.maxWidth="initial"),void 0!==el.querySelectorAll(".ggb_preview img")[0]&&(el.querySelectorAll(".ggb_preview img")[0].style.maxWidth="initial"),void 0!==el.querySelectorAll(".ggb_preview img")[1]&&(el.querySelectorAll(".ggb_preview img")[1].style.maxWidth="initial")):(el.style.transform="none",el.style.webkitTransform="none")}function getWidthHeight(appletElem,appletWidth,allowUpscale,autoHeight,noBorder,scaleContainerClass){var container=null;if(void 0!=scaleContainerClass&&""!=scaleContainerClass)for(var parent=appletElem.parentNode;null!=parent;){if((" "+parent.className+" ").indexOf(" "+scaleContainerClass+" ")>-1){container=parent;break}parent=parent.parentNode}var myWidth=0,myHeight=0,windowWidth=0,border=0,borderRight=0,borderLeft=0,borderTop=0;if(container)myWidth=container.offsetWidth,myHeight=Math.max(autoHeight?container.offsetWidth:0,container.offsetHeight);else{if(window.innerWidth&&document.documentElement.clientWidth?(myWidth=Math.min(window.innerWidth,document.documentElement.clientWidth),myHeight=Math.min(window.innerHeight,document.documentElement.clientHeight),windowWidth=myWidth):"number"==typeof window.innerWidth?(myWidth=window.innerWidth,myHeight=window.innerHeight,windowWidth=window.innerWidth):document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)?(myWidth=document.documentElement.clientWidth,myHeight=document.documentElement.clientHeight,windowWidth=document.documentElement.clientWidth):document.body&&(document.body.clientWidth||document.body.clientHeight)&&(myWidth=document.body.clientWidth,myHeight=document.body.clientHeight,windowWidth=document.documentElement.clientWidth),appletElem){var rect=appletElem.getBoundingClientRect();rect.left>0&&rect.left<=myWidth&&(void 0===noBorder||!noBorder)&&("rtl"===document.dir?(borderRight=myWidth-rect.width-rect.left,borderLeft=windowWidth<=480?10:30):(borderLeft=rect.left,borderRight=windowWidth<=480?10:30),border=borderLeft+borderRight)}if(appletElem&&"object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()){appletElem.getBoundingClientRect();"closePositionRight"===window.GGBT_wsf_view.getCloseBtnPosition()?(border=40,borderTop=0):"closePositionTop"===window.GGBT_wsf_view.getCloseBtnPosition()&&(border=0,borderTop=40)}}return appletElem&&((void 0===allowUpscale||!allowUpscale)&&appletWidth>0&&appletWidth+border<myWidth?myWidth=appletWidth:myWidth-=border,"object"!=typeof window.GGBT_wsf_view||!window.GGBT_wsf_view.isFullscreen()||void 0!==allowUpscale&&allowUpscale||(myHeight-=borderTop)),{width:myWidth,height:myHeight}}function calcScale(parameters,appletElem,allowUpscale,showPlayButton,scaleContainerClass){if(parameters.isScreenshoGenerator)return 1;var ignoreHeight=void 0!==showPlayButton&&showPlayButton,noScaleMargin=void 0!=parameters.noScaleMargin&&parameters.noScaleMargin,autoHeight=function(value){return value&&"false"!==value}(parameters.autoHeight),windowSize=getWidthHeight(appletElem,parameters.width,allowUpscale,autoHeight,ignoreHeight&&window.GGBT_wsf_view||noScaleMargin,scaleContainerClass),windowWidth=parseInt(windowSize.width),appletWidth=parameters.width,appletHeight=parameters.height;if(void 0===appletWidth){var articles=appletElem.getElementsByTagName("article");1===articles.length&&(appletWidth=articles[0].offsetWidth,appletHeight=articles[0].offsetHeight)}var xscale=windowWidth/appletWidth,yscale=ignoreHeight?1:windowSize.height/appletHeight;return void 0===allowUpscale||allowUpscale||(xscale=Math.min(1,xscale),yscale=Math.min(1,yscale)),Math.min(xscale,yscale)}function getScale(parameters,appletElem,showPlayButton){var autoScale,scale=1,allowUpscale=!1;return parameters.hasOwnProperty("allowUpscale")&&(allowUpscale=parameters.allowUpscale),parameters.hasOwnProperty("scale")&&(scale=parseFloat(parameters.scale),(isNaN(scale)||null===scale||0===scale)&&(scale=1),scale>1&&(allowUpscale=!0)),appletElem&&"object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()&&(allowUpscale=!0),parameters.hasOwnProperty("disableAutoScale")&&parameters.disableAutoScale?scale:(autoScale=calcScale(parameters,appletElem,allowUpscale,showPlayButton,parameters.scaleContainerClass),!allowUpscale||parameters.hasOwnProperty("scale")&&1!==scale?Math.min(scale,autoScale):autoScale)}function positionCenter(appletElem){var windowWidth=Math.min(window.innerWidth,document.documentElement.clientWidth),windowHeight=Math.min(window.innerHeight,document.documentElement.clientHeight),appletRect=appletElem.getBoundingClientRect(),calcHorizontalBorder=(windowWidth-appletRect.width)/2,calcVerticalBorder=(windowHeight-appletRect.height)/2;calcVerticalBorder<0&&(calcVerticalBorder=0),appletElem.style.position="relative","closePositionRight"===window.GGBT_wsf_view.getCloseBtnPosition()?(appletElem.style.left=calcHorizontalBorder<40?"40px":calcHorizontalBorder+"px",appletElem.style.top=calcVerticalBorder+"px"):"closePositionTop"===window.GGBT_wsf_view.getCloseBtnPosition()&&(appletElem.style.top=calcVerticalBorder<40?"40px":calcVerticalBorder+"px",appletElem.style.left=calcHorizontalBorder+"px")}function responsiveResize(appletElem,parameters){var article=appletElem.getElementsByTagName("article")[0];if(article){if("object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()){var articles=appletElem.getElementsByTagName("article");if(articles.length>0&&parameters.id!==articles[0].getAttribute("data-param-id"))return;window.GGBT_wsf_view.setCloseBtnPosition(appletElem)}if(article.parentElement&&/fullscreen/.test(article.parentElement.className))return;var scale=getScale(parameters,appletElem);isFlexibleWorksheetEditor()&&article.setAttribute("data-param-scale",scale);for(var scaleElem=null,i=0;i<appletElem.childNodes.length;i++)if(void 0!==appletElem.childNodes[i].className&&appletElem.childNodes[i].className.match(/^applet_scaler/)){scaleElem=appletElem.childNodes[i];break}if(null!==scaleElem&&null!==scaleElem.querySelector(".noscale"))return;var appName=void 0!==parameters.id?parameters.id:"ggbApplet",app=window[appName];null!=app&&app.recalculateEnvironments||null===scaleElem||scaleElem.className.match(/fullscreen/)||(scaleElem.parentNode.style.transform="",isNaN(scale)||1===scale?(scaleElement(scaleElem,1),scaleElem.parentNode.style.width=parameters.width+"px",scaleElem.parentNode.style.height=parameters.height+"px"):(scaleElem.parentNode.style.width=parameters.width*scale+"px",scaleElem.parentNode.style.height=parameters.height*scale+"px",scaleElement(scaleElem,scale))),"object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()&&positionCenter(appletElem),window.GGBT_wsf_view&&!window.GGBT_wsf_view.isFullscreen()&&window.GGBT_wsf_general.adjustContentToResize($(article).parents(".content-added-content"))}}return{responsiveResize:responsiveResize,isFlexibleWorksheetEditor:isFlexibleWorksheetEditor,positionCenter:positionCenter,getScale:getScale,scaleElement:scaleElement}}();"function"==typeof define&&define.amd&&define([],function(){return GGBApplet}),GGBAppletUtils.makeModule=function(name,permutation){function webModule(){var I="bootstrap",J="begin",K="gwt.codesvr."+name+"=",L="gwt.codesvr=",M=name,N="startup",O="DUMMY",P=0,Q=1,R="iframe",S="position:absolute; width:0; height:0; border:none; left: -1000px;",T=" top: -1000px;",U="CSS1Compat",V="<!doctype html>",W="",X="<html><head></head><body></body></html>",Y="undefined",Z="readystatechange",$=10,_="Chrome",ab='eval("',bb='");',cb="script",db="javascript",eb="moduleStartup",fb="moduleRequested",gb="Failed to load ",hb="head",ib="meta",jb="name",kb=name+"::",lb="::",mb="gwt:property",nb="content",ob="=",pb="gwt:onPropertyErrorFn",qb='Bad handler "',rb='" for "gwt:onPropertyErrorFn"',sb="gwt:onLoadErrorFn",tb='" for "gwt:onLoadErrorFn"',ub="#",vb="?",wb="/",xb="img",yb="clear.cache.gif",zb="baseUrl",Ab=name+".nocache.js",Bb="base",Cb="//",Db="user.agent",Eb="webkit",Fb="safari",Gb="msie",Hb=11,Ib="ie10",Jb=9,Kb="ie9",Lb=8,Mb="ie8",Nb="gecko",Ob="gecko1_8",Pb=2,Qb=3,Rb=4,Sb="selectingPermutation",Tb=name+".devmode.js",Ub=permutation,Vb=":1",Wb=":2",Xb=":3",Yb=":",Zb=".cache.js",$b="loadExternalRefs",_b="end",o=window,p=document;function q(){var a=o.location.search;return-1!=a.indexOf(K)||-1!=a.indexOf(L)}function r(a,b){}webModule.__sendStats=r,webModule.__moduleName=M,webModule.__errFn=null,webModule.__moduleBase=O,webModule.__softPermutationId=P,webModule.__computePropValue=null,webModule.__getPropMap=null,webModule.__installRunAsyncCode=function(){},webModule.__gwtStartLoadingFragment=function(){return null},webModule.__gwt_isKnownPropertyValue=function(){return!1},webModule.__gwt_getMetaProperty=function(){return null};var s=null,t=o.__gwt_activeModules=o.__gwt_activeModules||{};t[M]={moduleName:M},webModule.__moduleStartupDone=function(e){var f=t[M].bindings;t[M].bindings=function(){for(var a=f?f():{},b=e[webModule.__softPermutationId],c=P;c<b.length;c++){var d=b[c];a[d[P]]=d[Q]}return a}};var u;function v(){return w(),u}function w(){if(!u){var a=p.createElement(R);a.id=M,a.style.cssText=S+T,a.tabIndex=-1,p.body.appendChild(a),u=a.contentWindow.document,u.open();var b=document.compatMode==U?V:W;u.write(b+X),u.close()}}function A(k){function l(a){function b(){return typeof p.readyState==Y?typeof p.body!=Y&&null!=p.body:/loaded|complete/.test(p.readyState)}var c=b();if(c)return void a();function d(){if(!c){if(!b())return;c=!0,a(),p.removeEventListener&&p.removeEventListener(Z,d,!1),e&&clearInterval(e)}}p.addEventListener&&p.addEventListener(Z,d,!1);var e=setInterval(function(){d()},$)}function m(c){function d(a,b){a.removeChild(b)}var g,e=v(),f=e.body;if(navigator.userAgent.indexOf(_)>-1&&window.JSON){var h=e.createDocumentFragment();h.appendChild(e.createTextNode(ab));for(var i=P;i<c.length;i++){var j=window.JSON.stringify(c[i]);h.appendChild(e.createTextNode(j.substring(Q,j.length-Q)))}h.appendChild(e.createTextNode(bb)),g=e.createElement(cb),g.language=db,g.appendChild(h),f.appendChild(g),d(f,g)}else for(var i=P;i<c.length;i++)g=e.createElement(cb),g.language=db,g.text=c[i],f.appendChild(g),d(f,g)}webModule.onScriptDownloaded=function(a){l(function(){m(a)})};var n=p.createElement(cb);n.src=k,webModule.__errFn&&(n.onerror=function(){webModule.__errFn(M,new Error(gb+code))}),p.getElementsByTagName(hb)[P].appendChild(n)}webModule.__startLoadingFragment=function(a){return D(a)},webModule.__installRunAsyncCode=function(a){var b=v(),c=b.body,d=b.createElement(cb);d.language=db,d.text=a,c.appendChild(d),c.removeChild(d)};function B(){for(var c={},d,e,f=p.getElementsByTagName(ib),g=P,h=f.length;g<h;++g){var i=f[g],j=i.getAttribute(jb),k;if(j){if(j=j.replace(kb,W),j.indexOf(lb)>=P)continue;if(j==mb){if(k=i.getAttribute(nb)){var l,m=k.indexOf(ob);m>=P?(j=k.substring(P,m),l=k.substring(m+Q)):(j=k,l=W),c[j]=l}}else if(j==pb){if(k=i.getAttribute(nb))try{d=eval(k)}catch(a){alert(qb+k+rb)}}else if(j==sb&&(k=i.getAttribute(nb)))try{e=eval(k)}catch(a){alert(qb+k+tb)}}}__gwt_getMetaProperty=function(a){var b=c[a];return null==b?null:b},s=d,webModule.__errFn=e}function C(){function e(a){var b=a.lastIndexOf(ub);-1==b&&(b=a.length);var c=a.indexOf(vb);-1==c&&(c=a.length);var d=a.lastIndexOf(wb,Math.min(c,b));return d>=P?a.substring(P,d+Q):W}var k=function(){var a=__gwt_getMetaProperty(zb);return null!=a?a:W}();return k==W&&(k=function(){for(var a=p.getElementsByTagName(cb),b=P;b<a.length;++b)if(-1!=a[b].src.indexOf(Ab))return e(a[b].src);return W}()),k==W&&(k=function(){var a=p.getElementsByTagName(Bb);return a.length>P?a[a.length-Q].href:W}()),k==W&&function(){var a=p.location;return a.href==a.protocol+Cb+a.host+a.pathname+a.search+a.hash}()&&(k=e(p.location.href)),k=function(a){if(a.match(/^\w+:\/\//));else{var b=p.createElement(xb);b.src=a+yb,a=e(b.src)}return a}(k)}function D(a){return a.match(/^\//)?a:a.match(/^[a-zA-Z]+:\/\//)?a:webModule.__moduleBase+a}function F(){var f=[],g=P;function h(a,b){for(var c=f,d=P,e=a.length-Q;d<e;++d)c=c[a[d]]||(c[a[d]]=[]);c[a[e]]=b}var i=[],j=[];function k(a){var b=j[a](),c=i[a];if(b in c)return b;var d=[];for(var e in c)d[c[e]]=e;throw s&&s(a,d,b),null}if(j[Db]=function(){var a=navigator.userAgent.toLowerCase(),b=p.documentMode;return function(){return-1!=a.indexOf(Eb)}()?Fb:function(){return-1!=a.indexOf(Gb)&&b>=$&&b<Hb}()?Ib:function(){return-1!=a.indexOf(Gb)&&b>=Jb&&b<Hb}()?Kb:function(){return-1!=a.indexOf(Gb)&&b>=Lb&&b<Hb}()?Mb:function(){return-1!=a.indexOf(Nb)||b>=Hb}()?Ob:Fb},i[Db]={gecko1_8:P,ie10:Q,ie8:Pb,ie9:Qb,safari:Rb},__gwt_isKnownPropertyValue=function(a,b){return b in i[a]},webModule.__getPropMap=function(){var a={};for(var b in i)i.hasOwnProperty(b)&&(a[b]=k(b));return a},webModule.__computePropValue=k,o.__gwt_activeModules[M].bindings=webModule.__getPropMap,q())return D(Tb);var l;try{h([Ob],Ub),h([Ib],Ub+Vb),h([Kb],Ub+Wb),h([Fb],Ub+Xb),l=f[k(Db)];var m=l.indexOf(Yb);-1!=m&&(g=parseInt(l.substring(m+Q),$),l=l.substring(P,m))}catch(a){}return webModule.__softPermutationId=g,D(l+Zb)}function G(){o.__gwt_stylesLoaded||(o.__gwt_stylesLoaded={})}B(),webModule.__moduleBase="https://cdn.geogebra.org/apps/latest/"+name+"/",t[M].moduleBase=webModule.__moduleBase;var H=F();return G(),A(H),!0}return webModule},"function"!=typeof window.web3d&&(web3d=GGBAppletUtils.makeModule("web3d","12DD9077EF918DCD14C081861B4DBB92")),"function"!=typeof window.webSimple&&(webSimple=GGBAppletUtils.makeModule("webSimple","071BACE69702ED544D8A8B4B63C3C2A1")),function(window,document,undefined){var j=!0,k=null,l=!1;function p(a){return function(){return this[a]}}var aa=this;function q(a,b){var c=a.split("."),d=aa;!(c[0]in d)&&d.execScript&&d.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());)c.length||void 0===b?d=d[e]?d[e]:d[e]={}:d[e]=b}function ba(a,b,c){return a.call.apply(a.bind,arguments)}function ca(a,b,c){if(!a)throw Error();if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(c,d),a.apply(b,c)}}return function(){return a.apply(b,arguments)}}function s(a,b,c){return s=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ba:ca,s.apply(k,arguments)}var da=Date.now||function(){return+new Date};function ea(a,b){this.G=a,this.u=b||a,this.z=this.u.document}ea.prototype.createElement=function(a,b,c){if(a=this.z.createElement(a),b)for(var d in b)b.hasOwnProperty(d)&&("style"==d?a.style.cssText=b[d]:a.setAttribute(d,b[d]));return c&&a.appendChild(this.z.createTextNode(c)),a};function fa(a,b,c){a=a.z.getElementsByTagName(b)[0],a||(a=document.documentElement),a&&a.lastChild&&a.insertBefore(c,a.lastChild)}function t(a,b){for(var c=a.className.split(/\s+/),d=0,e=c.length;d<e;d++)if(c[d]==b)return;c.push(b),a.className=c.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function u(a,b){for(var c=a.className.split(/\s+/),d=[],e=0,f=c.length;e<f;e++)c[e]!=b&&d.push(c[e]);a.className=d.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function ga(a,b){for(var c=a.className.split(/\s+/),d=0,e=c.length;d<e;d++)if(c[d]==b)return j;return l}function v(a){var b=a.u.location.protocol;return"about:"==b&&(b=a.G.location.protocol),"https:"==b?"https:":"http:"}function w(a,b){var c=a.createElement("link",{rel:"stylesheet",href:b}),d=l;c.onload=function(){d||(d=j)},c.onerror=function(){d||(d=j)},fa(a,"head",c)}function x(a,b,c,d){var e=a.z.getElementsByTagName("head")[0];if(e){var f=a.createElement("script",{src:b}),g=l;return f.onload=f.onreadystatechange=function(){g||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(g=j,c&&c(k),f.onload=f.onreadystatechange=k,"HEAD"==f.parentNode.tagName&&e.removeChild(f))},e.appendChild(f),window.setTimeout(function(){g||(g=j,c&&c(Error("Script load timeout")))},d||5e3),f}return k}function y(a,b,c){this.w=a,this.S=b,this.za=c}q("webfont.BrowserInfo",y),y.prototype.pa=p("w"),y.prototype.hasWebFontSupport=y.prototype.pa,y.prototype.qa=p("S"),y.prototype.hasWebKitFallbackBug=y.prototype.qa,y.prototype.ra=p("za"),
y.prototype.hasWebKitMetricsBug=y.prototype.ra;function z(a,b,c,d){this.e=a!=k?a:k,this.o=b!=k?b:k,this.aa=c!=k?c:k,this.f=d!=k?d:k}var ha=/^([0-9]+)(?:[\._-]([0-9]+))?(?:[\._-]([0-9]+))?(?:[\._+-]?(.*))?$/;z.prototype.toString=function(){return[this.e,this.o||"",this.aa||"",this.f||""].join("")};function A(a){a=ha.exec(a);var b=k,c=k,d=k,e=k;return a&&(a[1]!==k&&a[1]&&(b=parseInt(a[1],10)),a[2]!==k&&a[2]&&(c=parseInt(a[2],10)),a[3]!==k&&a[3]&&(d=parseInt(a[3],10)),a[4]!==k&&a[4]&&(e=/^[0-9]+$/.test(a[4])?parseInt(a[4],10):a[4])),new z(b,c,d,e)}function B(a,b,c,d,e,f,g,h,m,n,r){this.J=a,this.Fa=b,this.ya=c,this.fa=d,this.Da=e,this.ea=f,this.wa=g,this.Ea=h,this.va=m,this.da=n,this.k=r}q("webfont.UserAgent",B),B.prototype.getName=p("J"),B.prototype.getName=B.prototype.getName,B.prototype.oa=p("ya"),B.prototype.getVersion=B.prototype.oa,B.prototype.ka=p("fa"),B.prototype.getEngine=B.prototype.ka,B.prototype.la=p("ea"),B.prototype.getEngineVersion=B.prototype.la,B.prototype.ma=p("wa"),B.prototype.getPlatform=B.prototype.ma,B.prototype.na=p("va"),B.prototype.getPlatformVersion=B.prototype.na,B.prototype.ja=p("da"),B.prototype.getDocumentMode=B.prototype.ja,B.prototype.ia=p("k"),B.prototype.getBrowserInfo=B.prototype.ia;function C(a,b){this.a=a,this.H=b}var ia=new B("Unknown",new z,"Unknown","Unknown",new z,"Unknown","Unknown",new z,"Unknown",void 0,new y(l,l,l));C.prototype.parse=function(){var a;if(-1!=this.a.indexOf("MSIE")){a=D(this);var b=E(this),c=A(b),d=F(this.a,/MSIE ([\d\w\.]+)/,1),e=A(d);a=new B("MSIE",e,d,"MSIE",e,d,a,c,b,G(this.H),new y("Windows"==a&&6<=e.e||"Windows Phone"==a&&8<=c.e,l,l))}else if(-1!=this.a.indexOf("Opera"))a:{a="Unknown";var b=F(this.a,/Presto\/([\d\w\.]+)/,1),c=A(b),d=E(this),e=A(d),f=G(this.H);if(c.e!==k?a="Presto":(-1!=this.a.indexOf("Gecko")&&(a="Gecko"),b=F(this.a,/rv:([^\)]+)/,1),c=A(b)),-1!=this.a.indexOf("Opera Mini/")){var g=F(this.a,/Opera Mini\/([\d\.]+)/,1),h=A(g);a=new B("OperaMini",h,g,a,c,b,D(this),e,d,f,new y(l,l,l))}else{if(-1!=this.a.indexOf("Version/")&&(g=F(this.a,/Version\/([\d\.]+)/,1),h=A(g),h.e!==k)){a=new B("Opera",h,g,a,c,b,D(this),e,d,f,new y(10<=h.e,l,l));break a}g=F(this.a,/Opera[\/ ]([\d\.]+)/,1),h=A(g),a=h.e!==k?new B("Opera",h,g,a,c,b,D(this),e,d,f,new y(10<=h.e,l,l)):new B("Opera",new z,"Unknown",a,c,b,D(this),e,d,f,new y(l,l,l))}}else/OPR\/[\d.]+/.test(this.a)?a=ja(this):/AppleWeb(K|k)it/.test(this.a)?a=ja(this):-1!=this.a.indexOf("Gecko")?(a="Unknown",b=new z,c="Unknown",d=E(this),e=A(d),f=l,-1!=this.a.indexOf("Firefox")?(a="Firefox",c=F(this.a,/Firefox\/([\d\w\.]+)/,1),b=A(c),f=3<=b.e&&5<=b.o):-1!=this.a.indexOf("Mozilla")&&(a="Mozilla"),g=F(this.a,/rv:([^\)]+)/,1),h=A(g),f||(f=1<h.e||1==h.e&&9<h.o||1==h.e&&9==h.o&&2<=h.aa||g.match(/1\.9\.1b[123]/)!=k||g.match(/1\.9\.1\.[\d\.]+/)!=k),a=new B(a,b,c,"Gecko",h,g,D(this),e,d,G(this.H),new y(f,l,l))):a=ia;return a};function D(a){var b=F(a.a,/(iPod|iPad|iPhone|Android|Windows Phone|BB\d{2}|BlackBerry)/,1);return""!=b?(/BB\d{2}/.test(b)&&(b="BlackBerry"),b):(a=F(a.a,/(Linux|Mac_PowerPC|Macintosh|Windows|CrOS)/,1),""!=a?("Mac_PowerPC"==a&&(a="Macintosh"),a):"Unknown")}function E(a){var b=F(a.a,/(OS X|Windows NT|Android) ([^;)]+)/,2);if(b||(b=F(a.a,/Windows Phone( OS)? ([^;)]+)/,2))||(b=F(a.a,/(iPhone )?OS ([\d_]+)/,2)))return b;if(b=F(a.a,/(?:Linux|CrOS) ([^;)]+)/,1))for(var b=b.split(/\s/),c=0;c<b.length;c+=1)if(/^[\d\._]+$/.test(b[c]))return b[c];return(a=F(a.a,/(BB\d{2}|BlackBerry).*?Version\/([^\s]*)/,2))?a:"Unknown"}function ja(a){var b=D(a),c=E(a),d=A(c),e=F(a.a,/AppleWeb(?:K|k)it\/([\d\.\+]+)/,1),f=A(e),g="Unknown",h=new z,m="Unknown",n=l;return/OPR\/[\d.]+/.test(a.a)?g="Opera":-1!=a.a.indexOf("Chrome")||-1!=a.a.indexOf("CrMo")||-1!=a.a.indexOf("CriOS")?g="Chrome":/Silk\/\d/.test(a.a)?g="Silk":"BlackBerry"==b||"Android"==b?g="BuiltinBrowser":-1!=a.a.indexOf("PhantomJS")?g="PhantomJS":-1!=a.a.indexOf("Safari")?g="Safari":-1!=a.a.indexOf("AdobeAIR")&&(g="AdobeAIR"),"BuiltinBrowser"==g?m="Unknown":"Silk"==g?m=F(a.a,/Silk\/([\d\._]+)/,1):"Chrome"==g?m=F(a.a,/(Chrome|CrMo|CriOS)\/([\d\.]+)/,2):-1!=a.a.indexOf("Version/")?m=F(a.a,/Version\/([\d\.\w]+)/,1):"AdobeAIR"==g?m=F(a.a,/AdobeAIR\/([\d\.]+)/,1):"Opera"==g?m=F(a.a,/OPR\/([\d.]+)/,1):"PhantomJS"==g&&(m=F(a.a,/PhantomJS\/([\d.]+)/,1)),h=A(m),n="AdobeAIR"==g?2<h.e||2==h.e&&5<=h.o:"BlackBerry"==b?10<=d.e:"Android"==b?2<d.e||2==d.e&&1<d.o:526<=f.e||525<=f.e&&13<=f.o,new B(g,h,m,"AppleWebKit",f,e,b,d,c,G(a.H),new y(n,536>f.e||536==f.e&&11>f.o,"iPhone"==b||"iPad"==b||"iPod"==b||"Macintosh"==b))}function F(a,b,c){return(a=a.match(b))&&a[c]?a[c]:""}function G(a){if(a.documentMode)return a.documentMode}function ka(a){this.ua=a||"-"}ka.prototype.f=function(a){for(var b=[],c=0;c<arguments.length;c++)b.push(arguments[c].replace(/[\W_]+/g,"").toLowerCase());return b.join(this.ua)};function H(a,b){this.J=a,this.T=4,this.K="n";var c=(b||"n4").match(/^([nio])([1-9])$/i);c&&(this.K=c[1],this.T=parseInt(c[2],10))}H.prototype.getName=p("J");function I(a){return a.K+a.T}function la(a){var b=4,c="n",d=k;return a&&((d=a.match(/(normal|oblique|italic)/i))&&d[1]&&(c=d[1].substr(0,1).toLowerCase()),(d=a.match(/([1-9]00|normal|bold)/i))&&d[1]&&(/bold/i.test(d[1])?b=7:/[1-9]00/.test(d[1])&&(b=parseInt(d[1].substr(0,1),10)))),c+b}function ma(a,b,c){this.c=a,this.h=b,this.M=c,this.j="wf",this.g=new ka("-")}function na(a){t(a.h,a.g.f(a.j,"loading")),J(a,"loading")}function K(a){u(a.h,a.g.f(a.j,"loading")),ga(a.h,a.g.f(a.j,"active"))||t(a.h,a.g.f(a.j,"inactive")),J(a,"inactive")}function J(a,b,c){a.M[b]&&(c?a.M[b](c.getName(),I(c)):a.M[b]())}function L(a,b){this.c=a,this.C=b,this.s=this.c.createElement("span",{"aria-hidden":"true"},this.C)}function M(a,b){var c;c=[];for(var d=b.J.split(/,\s*/),e=0;e<d.length;e++){var f=d[e].replace(/['"]/g,"");-1==f.indexOf(" ")?c.push(f):c.push("'"+f+"'")}c=c.join(","),d="normal",e=b.T+"00","o"===b.K?d="oblique":"i"===b.K&&(d="italic"),a.s.style.cssText="position:absolute;top:-999px;left:-999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+c+";font-style:"+d+";font-weight:"+e+";"}function N(a){fa(a.c,"body",a.s)}L.prototype.remove=function(){var a=this.s;a.parentNode&&a.parentNode.removeChild(a)};function oa(a,b,c,d,e,f,g,h){this.U=a,this.sa=b,this.c=c,this.q=d,this.C=h||"BESbswy",this.k=e,this.F={},this.R=f||5e3,this.Y=g||k,this.B=this.A=k,a=new L(this.c,this.C),N(a);for(var m in O)O.hasOwnProperty(m)&&(M(a,new H(O[m],I(this.q))),this.F[O[m]]=a.s.offsetWidth);a.remove()}var O={Ca:"serif",Ba:"sans-serif",Aa:"monospace"};oa.prototype.start=function(){this.A=new L(this.c,this.C),N(this.A),this.B=new L(this.c,this.C),N(this.B),this.xa=da(),M(this.A,new H(this.q.getName()+",serif",I(this.q))),M(this.B,new H(this.q.getName()+",sans-serif",I(this.q))),qa(this)};function ra(a,b,c){for(var d in O)if(O.hasOwnProperty(d)&&b===a.F[O[d]]&&c===a.F[O[d]])return j;return l}function qa(a){var b=a.A.s.offsetWidth,c=a.B.s.offsetWidth;b===a.F.serif&&c===a.F["sans-serif"]||a.k.S&&ra(a,b,c)?da()-a.xa>=a.R?a.k.S&&ra(a,b,c)&&(a.Y===k||a.Y.hasOwnProperty(a.q.getName()))?P(a,a.U):P(a,a.sa):setTimeout(s(function(){qa(this)},a),25):P(a,a.U)}function P(a,b){a.A.remove(),a.B.remove(),b(a.q)}function R(a,b,c,d){this.c=b,this.t=c,this.N=0,this.ba=this.X=l,this.R=d,this.k=a.k}function sa(a,b,c,d,e){if(0===b.length&&e)K(a.t);else for(a.N+=b.length,e&&(a.X=e),e=0;e<b.length;e++){var f=b[e],g=c[f.getName()],h=a.t,m=f;t(h.h,h.g.f(h.j,m.getName(),I(m).toString(),"loading")),J(h,"fontloading",m),new oa(s(a.ga,a),s(a.ha,a),a.c,f,a.k,a.R,d,g).start()}}R.prototype.ga=function(a){var b=this.t;u(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"loading")),u(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"inactive")),t(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"active")),J(b,"fontactive",a),this.ba=j,ta(this)},R.prototype.ha=function(a){var b=this.t;u(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"loading")),ga(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"active"))||t(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"inactive")),J(b,"fontinactive",a),ta(this)};function ta(a){0==--a.N&&a.X&&(a.ba?(a=a.t,u(a.h,a.g.f(a.j,"loading")),u(a.h,a.g.f(a.j,"inactive")),t(a.h,a.g.f(a.j,"active")),J(a,"active")):K(a.t))}function S(a,b,c){this.G=a,this.V=b,this.a=c,this.O=this.P=0}function T(a,b){U.V.Z[a]=b}S.prototype.load=function(a){var b=a.context||this.G;if(this.c=new ea(this.G,b),b=new ma(this.c,b.document.documentElement,a),this.a.k.w){var f,c=this.V,d=this.c,e=[];for(f in a)if(a.hasOwnProperty(f)){var g=c.Z[f];g&&e.push(g(a[f],d))}for(a=a.timeout,this.O=this.P=e.length,a=new R(this.a,this.c,b,a),f=0,c=e.length;f<c;f++)d=e[f],d.v(this.a,s(this.ta,this,d,b,a))}else K(b)},S.prototype.ta=function(a,b,c,d){var e=this;d?a.load(function(a,d,h){var m=0==--e.P;m&&na(b),setTimeout(function(){sa(c,a,d||{},h||k,m)},0)}):(a=0==--this.P,this.O--,a&&(0==this.O?K(b):na(b)),sa(c,[],{},k,a))};var ua=window,va=new C(navigator.userAgent,document).parse(),U=ua.WebFont=new S(window,new function(){this.Z={}},va);U.load=U.load;function V(a,b){this.c=a,this.d=b}V.prototype.load=function(a){var b,c,d=this.d.urls||[],e=this.d.families||[];for(b=0,c=d.length;b<c;b++)w(this.c,d[b]);for(d=[],b=0,c=e.length;b<c;b++){var f=e[b].split(":");if(f[1])for(var g=f[1].split(","),h=0;h<g.length;h+=1)d.push(new H(f[0],g[h]));else d.push(new H(f[0]))}a(d)},V.prototype.v=function(a,b){return b(a.k.w)},T("custom",function(a,b){return new V(b,a)});function W(a,b){this.c=a,this.d=b,this.m=[]}W.prototype.D=function(a){return v(this.c)+(this.d.api||"//f.fontdeck.com/s/css/js/")+(this.c.u.location.hostname||this.c.G.location.hostname)+"/"+a+".js"},W.prototype.v=function(a,b){var c=this.d.id,d=this.c.u,e=this;c?(d.__webfontfontdeckmodule__||(d.__webfontfontdeckmodule__={}),d.__webfontfontdeckmodule__[c]=function(a,c){for(var d=0,m=c.fonts.length;d<m;++d){var n=c.fonts[d];e.m.push(new H(n.name,la("font-weight:"+n.weight+";font-style:"+n.style)))}b(a)},x(this.c,this.D(c),function(a){a&&b(l)})):b(l)},W.prototype.load=function(a){a(this.m)},T("fontdeck",function(a,b){return new W(b,a)});function wa(a,b,c){this.L=a||b+xa,this.p=[],this.Q=[],this.ca=c||""}var xa="//fonts.googleapis.com/css";wa.prototype.f=function(){if(0==this.p.length)throw Error("No fonts to load !");if(-1!=this.L.indexOf("kit="))return this.L;for(var a=this.p.length,b=[],c=0;c<a;c++)b.push(this.p[c].replace(/ /g,"+"));return a=this.L+"?family="+b.join("%7C"),0<this.Q.length&&(a+="&subset="+this.Q.join(",")),0<this.ca.length&&(a+="&text="+encodeURIComponent(this.ca)),a};function ya(a){this.p=a,this.$=[],this.I={}}var za={latin:"BESbswy",cyrillic:"&#1081;&#1103;&#1046;",greek:"&#945;&#946;&#931;",khmer:"&#x1780;&#x1781;&#x1782;",Hanuman:"&#x1780;&#x1781;&#x1782;"},Aa={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},Ba={i:"i",italic:"i",n:"n",normal:"n"},Ca=RegExp("^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$");ya.prototype.parse=function(){for(var a=this.p.length,b=0;b<a;b++){var c=this.p[b].split(":"),d=c[0].replace(/\+/g," "),e=["n4"];if(2<=c.length){var f,g=c[1];if(f=[],g)for(var g=g.split(","),h=g.length,m=0;m<h;m++){var n;if(n=g[m],n.match(/^[\w]+$/)){n=Ca.exec(n.toLowerCase());var r=void 0;if(n==k)r="";else{if(r=void 0,(r=n[1])==k||""==r)r="4";else var pa=Aa[r],r=pa||(isNaN(r)?"4":r.substr(0,1));r=[n[2]==k||""==n[2]?"n":Ba[n[2]],r].join("")}n=r}else n="";n&&f.push(n)}0<f.length&&(e=f),3==c.length&&(c=c[2],f=[],c=c?c.split(","):f,0<c.length&&(c=za[c[0]])&&(this.I[d]=c))}for(this.I[d]||(c=za[d])&&(this.I[d]=c),c=0;c<e.length;c+=1)this.$.push(new H(d,e[c]))}};function X(a,b,c){this.a=a,this.c=b,this.d=c}var Da={Arimo:j,Cousine:j,Tinos:j};X.prototype.v=function(a,b){b(a.k.w)},X.prototype.load=function(a){var b=this.c;if("MSIE"==this.a.getName()&&this.d.blocking!=j){var c=s(this.W,this,a),d=function(){b.z.body?c():setTimeout(d,0)};d()}else this.W(a)},X.prototype.W=function(a){for(var b=this.c,c=new wa(this.d.api,v(b),this.d.text),d=this.d.families,e=d.length,f=0;f<e;f++){var g=d[f].split(":");3==g.length&&c.Q.push(g.pop());var h="";2==g.length&&""!=g[1]&&(h=":"),c.p.push(g.join(h))}d=new ya(d),d.parse(),w(b,c.f()),a(d.$,d.I,Da)},T("google",function(a,b){return new X(new C(navigator.userAgent,document).parse(),b,a)});function Y(a,b){this.c=a,this.d=b}var Ea={regular:"n4",bold:"n7",italic:"i4",bolditalic:"i7",r:"n4",b:"n7",i:"i4",bi:"i7"};Y.prototype.v=function(a,b){return b(a.k.w)},Y.prototype.load=function(a){w(this.c,v(this.c)+"//webfonts.fontslive.com/css/"+this.d.key+".css");for(var b=this.d.families,c=[],d=0,e=b.length;d<e;d++)c.push.apply(c,Fa(b[d]));a(c)};function Fa(a){var b=a.split(":");if(a=b[0],b[1]){for(var c=b[1].split(","),b=[],d=0,e=c.length;d<e;d++){var f=c[d];if(f){var g=Ea[f];b.push(g||f)}}for(c=[],d=0;d<b.length;d+=1)c.push(new H(a,b[d]));return c}return[new H(a)]}T("ascender",function(a,b){return new Y(b,a)});function Z(a,b,c){this.a=a,this.c=b,this.d=c,this.m=[]}Z.prototype.v=function(a,b){var c=this,d=c.d.projectId,e=c.d.version;if(d){var f=c.c.u;x(this.c,c.D(d,e),function(e){if(e)b(l);else{if(f["__mti_fntLst"+d]&&(e=f["__mti_fntLst"+d]()))for(var h=0;h<e.length;h++)c.m.push(new H(e[h].fontfamily));b(a.k.w)}}).id="__MonotypeAPIScript__"+d}else b(l)},Z.prototype.D=function(a,b){return v(this.c)+"//"+(this.d.api||"fast.fonts.com/jsapi").replace(/^.*http(s?):(\/\/)?/,"")+"/"+a+".js"+(b?"?v="+b:"")},Z.prototype.load=function(a){a(this.m)},T("monotype",function(a,b){return new Z(new C(navigator.userAgent,document).parse(),b,a)});function $(a,b){this.c=a,this.d=b,this.m=[]}$.prototype.D=function(a){var b=v(this.c);return(this.d.api||b+"//use.typekit.net")+"/"+a+".js"},$.prototype.v=function(a,b){var c=this.d.id,d=this.d,e=this.c.u,f=this;c?(e.__webfonttypekitmodule__||(e.__webfonttypekitmodule__={}),e.__webfonttypekitmodule__[c]=function(c){c(a,d,function(a,c,d){for(var e=0;e<c.length;e+=1){var g=d[c[e]];if(g)for(var Q=0;Q<g.length;Q+=1)f.m.push(new H(c[e],g[Q]));else f.m.push(new H(c[e]))}b(a)})},x(this.c,this.D(c),function(a){a&&b(l)},2e3)):b(l)},$.prototype.load=function(a){a(this.m)},T("typekit",function(a,b){return new $(b,a)}),window.WebFontConfig&&U.load(window.WebFontConfig)}(this,document);function Vec2(x_,y_){this.x=x_,this.y=y_,this.mulS=function(value){return new Vec2(this.x*value,this.y*value)},this.mulV=function(vec_){return new Vec2(this.x*vec_.x,this.y*vec_.y)},this.divS=function(value){return new Vec2(this.x/value,this.y/value)},this.addS=function(value){return new Vec2(this.x+value,this.y+value)},this.addV=function(vec_){return new Vec2(this.x+vec_.x,this.y+vec_.y)},this.subS=function(value){return new Vec2(this.x-value,this.y-value)},this.subV=function(vec_){return new Vec2(this.x-vec_.x,this.y-vec_.y)},this.abs=function(){return new Vec2(Math.abs(this.x),Math.abs(this.y))},this.dot=function(vec_){return this.x*vec_.x+this.y*vec_.y},this.length=function(){return Math.sqrt(this.dot(this))},this.lengthSqr=function(){return this.dot(this)},this.angle=function(vec_){vec_=vec_||new Vec2(1,0);var n1=new Vec2(this.x,this.y),n2=new Vec2(vec_.x,vec_.y);return n1.normalize(),n2.normalize(),Math.atan2(n1.y,n1.x)-Math.atan2(n2.y,n2.x)},this.lerp=function(vec_,value){return new Vec2(this.x+(vec_.x-this.x)*value,this.y+(vec_.y-this.y)*value)},this.normalize=function(){var vlen=this.length();this.x=this.x/vlen,this.y=this.y/vlen},this.round=function(){this.x=Math.round(this.x),this.y=Math.round(this.y)},this.equals=function(o){return this.x==o.x&&this.y==o.y},this.asCSS=function(){return{left:this.x,top:this.y}}}Vec2.fromCSS=function(css){return new Vec2(parseInt(css.left,10),parseInt(css.top,10))};var saveAs=saveAs||function(view){"use strict";if(!(void 0===view||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view},save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),can_use_save_link="download"in save_link,click=function(node){var event=new MouseEvent("click");node.dispatchEvent(event)},is_safari=/constructor/i.test(view.HTMLElement),is_chrome_ios=/CriOS\/[\d]+/.test(navigator.userAgent),throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex},0)},revoke=function(file){var revoker=function(){"string"==typeof file?get_URL().revokeObjectURL(file):file.remove()};setTimeout(revoker,4e4)},dispatch=function(filesaver,event_types,event){event_types=[].concat(event_types);for(var i=event_types.length;i--;){var listener=filesaver["on"+event_types[i]];if("function"==typeof listener)try{listener.call(filesaver,event||filesaver)}catch(ex){throw_outside(ex)}}},auto_bom=function(blob){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)?new Blob([String.fromCharCode(65279),blob],{type:blob.type}):blob},FileSaver=function(blob,name,no_auto_bom){no_auto_bom||(blob=auto_bom(blob));var object_url,filesaver=this,type=blob.type,force="application/octet-stream"===type,dispatch_all=function(){dispatch(filesaver,"writestart progress write writeend".split(" "))};if(filesaver.readyState=filesaver.INIT,can_use_save_link)return object_url=get_URL().createObjectURL(blob),void setTimeout(function(){save_link.href=object_url,save_link.download=name,click(save_link),dispatch_all(),revoke(object_url),filesaver.readyState=filesaver.DONE});!function(){if((is_chrome_ios||force&&is_safari)&&view.FileReader){var reader=new FileReader;return reader.onloadend=function(){var url=is_chrome_ios?reader.result:reader.result.replace(/^data:[^;]*;/,"data:attachment/file;");view.open(url,"_blank")||(view.location.href=url),url=void 0,filesaver.readyState=filesaver.DONE,dispatch_all()},reader.readAsDataURL(blob),void(filesaver.readyState=filesaver.INIT)}if(object_url||(object_url=get_URL().createObjectURL(blob)),force)view.location.href=object_url;else{view.open(object_url,"_blank")||(view.location.href=object_url)}filesaver.readyState=filesaver.DONE,dispatch_all(),revoke(object_url)}()},FS_proto=FileSaver.prototype,saveAs=function(blob,name,no_auto_bom){return new FileSaver(blob,name||blob.name||"download",no_auto_bom)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(blob,name,no_auto_bom){return name=name||blob.name||"download",no_auto_bom||(blob=auto_bom(blob)),navigator.msSaveOrOpenBlob(blob,name)}:(FS_proto.abort=function(){},FS_proto.readyState=FS_proto.INIT=0,FS_proto.WRITING=1,FS_proto.DONE=2,FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null,saveAs)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);if("undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define([],function(){return saveAs}),window.triggerOnUnload=function(){a5.mainBuilder.onWindowUnload()},!window.Node)var Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};var cbSplit;cbSplit||(cbSplit=function(str,separator,limit){if("[object RegExp]"!==Object.prototype.toString.call(separator))return cbSplit._nativeSplit.call(str,separator,limit);var separator2,match,lastIndex,lastLength,output=[],lastLastIndex=0,flags=(separator.ignoreCase?"i":"")+(separator.multiline?"m":"")+(separator.sticky?"y":""),separator=RegExp(separator.source,flags+"g");if(str+="",cbSplit._compliantExecNpcg||(separator2=RegExp("^"+separator.source+"$(?!\\s)",flags)),void 0===limit||+limit<0)limit=1/0;else if(!(limit=Math.floor(+limit)))return[];for(;(match=separator.exec(str))&&!((lastIndex=match.index+match[0].length)>lastLastIndex&&(output.push(str.slice(lastLastIndex,match.index)),!cbSplit._compliantExecNpcg&&match.length>1&&match[0].replace(separator2,function(){for(var i=1;i<arguments.length-2;i++)void 0===arguments[i]&&(match[i]=void 0)}),match.length>1&&match.index<str.length&&Array.prototype.push.apply(output,match.slice(1)),lastLength=match[0].length,lastLastIndex=lastIndex,output.length>=limit));)separator.lastIndex===match.index&&separator.lastIndex++;return lastLastIndex===str.length?!lastLength&&separator.test("")||output.push(""):output.push(str.slice(lastLastIndex)),output.length>limit?output.slice(0,limit):output},cbSplit._compliantExecNpcg=void 0===/()??/.exec("")[1],cbSplit._nativeSplit=String.prototype.split),String.prototype.split=function(separator,limit){return cbSplit(this,separator,limit)},Function.prototype.bind||(Function.prototype.bind=function(context){var func=this;return function(){func.apply(context,arguments)}}),Array.prototype.forEach||(Array.prototype.forEach=function(fun){var len=this.length>>>0;if("function"!=typeof fun)throw new TypeError;for(var thisp=arguments[1],i=0;i<len;i++)i in this&&fun.call(thisp,this[i],i,this)}),Function.prototype.bind&&"undefined"!=typeof console&&"object"==typeof console.log&&["log","info","warn","error","assert","dir","clear","profile","profileEnd"].forEach(function(method){console[method]=this.bind(console[method],console)},Function.prototype.call),Function.prototype.bindTo||(Function.prototype.bindTo=function(context){var func=this;return function(){func.apply(context,arguments)}}),String.prototype.trim||(String.prototype.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")}),Array.prototype.extract||(Array.prototype.extract=function(){for(var na=[],cnt=0;cnt<arguments.length;cnt++)na.push(this[arguments[cnt]]);return na}),Array.prototype.remove||(Array.prototype.remove=function(element){for(var i=0;i<this.length;i++)if(this[i]==element)return this.splice(i,1),i;return-1}),Array.prototype.removeAt||(Array.prototype.removeAt=function(pos){var ret=this[pos];return this.splice(pos,1),ret}),Array.prototype.indexOf||(Array.prototype.indexOf=function(element){for(var i=0;i<this.length;i++)if(this[i]==element)return i;return-1}),Array.prototype.contains||(Array.prototype.contains=function(element){for(var i=0;i<this.length;i++)if(this[i]==element)return!0;return!1}),Array.prototype.sameSet||(Array.prototype.sameSet=function(set){var valid=this.length==set.length;if(valid)for(var i=0;i<this.length;i++)set.contains(this[i])||(valid=!1);return valid}),window.len||(window.len=function(obj){var key,size=0;for(key in obj)obj.hasOwnProperty(key)&&size++;return size}),class_space={},window.objectCounter=0,function(global){function _getProp(class_name){return _(class_name.split(".")).reduce(function(res,current){return res[current]},global)}var initializing=!1,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(class_name,prop){if(!prop&&!(prop=_getProp(class_name)))throw"Invalid Class Definition";var _super=this.prototype;initializing=!0;var prototype=new this;initializing=!1;for(var name in prop)prototype[name]="function"==typeof prop[name]&&"function"==typeof _super[name]&&fnTest.test(prop[name])?function(name,fn){return function(){"init"==name&&void 0===this._uid&&(this._uid=class_name+":"+window.objectCounter++);var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);return this._super=tmp,ret}}(name,prop[name]):prop[name];function Class(){!initializing&&this.init&&(this._class_name=class_name,this.init.apply(this,arguments))}Class.prototype=prototype,Class.constructor=Class,Class.extend=arguments.callee,class_space[class_name]=Class;var namespace=window,modules=class_name.split("."),className=modules.splice(modules.length-1,1);modules.forEach(function(v){v in namespace||(namespace[v]={}),namespace=namespace[v]}),namespace[className[0]]=Class}}(this),Class.extend("Obj",{bind:function(event,callback,context,options){options=options||{},this.events=this.events||{},_.each(event.split(" "),function(event){this.events[event]=this.events[event]||[],this.events[event].push(_.extend({callback:callback,context:context},options))},this)},unbind:function(name,func){if(_.isFunction(name)&&_.isUndefined(func)&&(func=name,name=void 0),_.isString(name)&&_.isFunction(func))this.events&&_.each(name.split(" "),function(event){this.events[event]&&(this.events[event]=_.reject(this.events[event],function(e){return e.callback===func}))},this);else if(_.isString(name)&&_.isUndefined(func))this.events&&_.each(name.split(" "),function(event){this.events[event]&&delete this.events[event]},this);else if(_.isUndefined(name)&&_.isFunction(func))this.events&&_.each(this.events,function(value,key){this.events[key]=_.reject(this.events[key],function(e){return e.callback===func})},this);else{if(!_.isUndefined(name)||!_.isUndefined(func))throw"invalid parameters";this.events=null}},trigger:function(event){var args=Array.prototype.slice.call(arguments,1);this._logTriggerCalls&&logger.info("trigger",event,"on",this,"with parameters",args),this.eachEvent(event,function(callback,context){callback.apply(context,args)}),this.eachEvent(event+":deferred",function(callback,context){_.defer(function(){callback.apply(context,args)})})},eachEvent:function(name,callback){this.events&&(_.each(this.events[name],function(event){callback.call(this,event.callback,event.context||this)},this),this.events[name]=_.reject(this.events[name],function(event){return event.once}))},_instance_of:function(clazz){return this._class_name==clazz},_enableTriggerLogs:function(enable){_.isUndefined(enable)&&(enable=!0),this._logTriggerCalls=enable}}),Obj.extend("Listeners",{init:function(model){this.model=model,this.callbacks=[],this.name=null},getName:function(){if(null==this.name)for(var x in this.model)this.model[x]==this&&(this.name=x);return this.name},register:function(func,context){if(null!=context)throw"only one parameter supported";this.callbacks.push(func)},remove:function(func,context){if(null!=context)throw"only one parameter supported";this.callbacks.remove(func)},call:function(argus){var args=$.extend({},argus||{});this.callbacks.forEach(function(f){f.apply(window,[args])})},callWithouthParents:function(argus){var args=$.extend({},argus||{});args.model=this.model,this._call($.extend({},args))},callEach:function(argus){var args=$.extend({},argus||{});args.model=this.model,this._call($.extend({},args))},_call:function(args){var model=this.model;this.callbacks.forEach(function(f){args.caller=model,f.apply(window,[args])})}}),Obj.extend("Logger",{log:function(log){"undefined"!=typeof console&&void 0!==console.log&&($.browser.msie&&"8.0"==$.browser.version?console.log(this.join(arguments)):console.log.apply(console,arguments))},join:function(args){for(var ret="",cnt=0;cnt<args.length;cnt++)ret+=args[cnt],cnt<args.length-1&&(ret+=" ");return ret},raise:function(){throw"undefined"!=typeof console&&void 0!==console.error?console.error.apply(console,arguments):alert(this.join(arguments)),this.join(arguments)},warn:function(message){"undefined"!=typeof console&&void 0!==console.warn&&console.warn.apply(console,arguments)},info:function(message){"undefined"!=typeof console&&void 0!==console.info&&console.info.apply(console,arguments)},error:function(){"undefined"!=typeof console&&void 0!==console.error?console.error.apply(console,arguments):alert(this.join(arguments))},timeStart:function(){var d=new Date;this._time=6e4*d.getMinutes()+1e3*d.getSeconds()+d.getMilliseconds()},time:function(){var d=new Date,time=6e4*d.getMinutes()+1e3*d.getSeconds()+d.getMilliseconds();if("undefined"!=typeof console){var args=[].splice.call(arguments,0);args.splice(0,0,time-this._time);try{console.log.apply(console,args)}catch(e){}}}}),logger=new Logger,$(function(){var userAgent=a5.utils.parseUserAgent(),body=jQuery("body");for(key in userAgent)userAgent[key]&&body.addClass(key);$("body").mousedown(function(){$("body").addClass("mouse_pressed")}).mouseup(function(){$("body").removeClass("mouse_pressed")}).mouseleave(function(){$("body").removeClass("mouse_pressed")})});var a5={logger:{},components:{header_audio:{}},model:{interaction:{}},view:{interaction:{},dialog:{}},parsers:{},models:{variable:{},item:{interaction:{choize:{}},response:{declaration:{}}},forms:{},options:{}},utils:{array:{}},service:{lms:{},media:{},scroll:{}},preprocessor:{},annotations:{},animations:{},dp:{}};a5.models.interaction={},a5.models.HighlightInteraction={},a5.views={},a5.views.interaction={},a5.model_builder={interaction:{}},a5.model_postBuilder={},function(a5,$,_){a5.Engine=function(){var Engine=function(params){params=params||{},this._ready=$.Deferred(),a5.performance=new a5.PerformanceBenchmark,this._channel=params.channel,a5.eventBus.trigger("performance:engine_overhead:start"),a5.eventBus.bind("lo:ready",this._onReady,this),_.bindAll(this,"_loadConfig","_loadDP","_loadLayout","_init","_start","_initLRS","_initLMS","_setA5andLOInfo","_openVideo","_openAudio")};return _(Engine.prototype).extend({channel:function(){return this._channel},initialize:function(config){return this._loadConfig=_.partial(this._loadConfig,config),this._initialized=this._initialized||$.when().then(function(){a5.eventBus.trigger("performance:engine_config_load:start")}).then(this._loadConfig).then(function(){a5.eventBus.trigger("performance:engine_config_load:end"),a5.eventBus.trigger("performance:engine_dp_load:start")}).then(this._loadDP).then(function(){a5.eventBus.trigger("performance:engine_dp_load:end"),a5.eventBus.trigger("performance:engine_layout_load:start")}).then(this._loadLayout).then(function(){a5.eventBus.trigger("performance:engine_layout_load:end"),a5.eventBus.trigger("performance:engine_init_load:start")}).then(this._init).then(function(){a5.eventBus.trigger("performance:engine_init_load:end")}).then(function(){if(this.config.get("start_on_init"))return this._start()}.bind(this)),this._initialized},finalize:function(){return $.when().then(this._close)},start:function(){return $.when().then(this._start)},ready:function(){return this._ready.promise()},addEventListener:function(event,callback,context,options){a5.eventBus.bind(event,callback,context,options)},removeEventListener:function(name,func){a5.eventBus.unbind(name,func)},register:function(key,val){a5.registry[key]=val},lookup:function(key){return a5.registry[key]},invoke:function(key){var val=this.lookup(key);return _.isFunction(val)&&(val=val.apply(this,Array.prototype.slice.call(arguments,1))),val},isBook:function(){return"ebook"===this.config.get("type").toLowerCase()},isLO:function(){return"standard"===this.config.get("type").toLowerCase()},getBook:function(){return this.book=this.book||new a5.Book(this)},getLO:function(){return this.lo=this.lo||new a5.LearningObject(this)},getSize:function(){return{width:this.layout.width,height:this.layout.height}},openVideo:function(parameters){return $.when(parameters).then(this._openVideo)},openAudio:function(parameters){return $.when(parameters).then(this._openAudio)},_onReady:function(){this._ready.resolve()},_setA5andLOInfo:function(config){A5.LMS_NO_STORE=config.lms_no_store,A5.LMS_NO_RESTORE=config.lms_no_restore,A5.ENGINE_ROOT=config.engine_root,A5.SKIN_URL=config.skin_url,A5.SKIN_ROOT=config.skin_root,A5.SKIN_TYPE=config.skin_type,A5.RECORDING_RTMP_SERVER=config.recording_rtmp_server,A5.TOOLBELT_URL=config.toolbelt_url,A5.START_TASK=config.start_task,A5.DEFAULT_SAVEAS_FILENAME=config.default_saveas_filename,A5.DICTIONARY_REF=config.dictionary_ref,A5.EXTERNAL_URL_BUILDER=config.external_url_builder,A5.LMS_CLOSE=!config.lms_no_close,A5.DEFAULT_PAGES_PER_SCREEN=config.book_pages_per_screen,A5.PAGES_PER_SCREEN_SOURCE=config.book_pages_per_screen_source,A5.LO_WITHOUT_CONTROLS=config.lo_without_controls,A5.GEOGEBRA=config.geogebra,
A5.MATHJAX=config.mathjax,A5.WIRIS_QUIZ_LIBRARY_RESOURCES_URL=config.wiris_quiz_library_resources_url,A5.WIRIS_QUIZ_VALIDATION_SERVICE_URL=config.wiris_quiz_validation_service_url,A5.ITEM_BANK_API_URL=config.item_bank_api_url,A5.CKEDITOR_FOLDER_PATH=config.ckeditor_folder_path,A5.REACT_BUNDLE_FOLDER_PATH=config.react_bundle_folder_path,A5.LRS_ACTOR=config.lrs_actor,A5.LRS_ENDPOINT=config.lrs_endpoint,A5.LRS_AUTH=config.lrs_auth,A5.LRS_ACTIVITY_ID=config.lrs_activity_id,A5.LRS_REGISTRATION=config.lrs_registration,A5.BUDDY_CONFIG=config.buddyConfig,A5.ASSET_URL_BUILDER=config.asset_url_builder,window.LOInfo=config.LOInfo||{}},_initLMS:function(){var allAPIs=_.map(this.config.get("lms_apis").split(","),function(name){return new a5.service.lms[name+"API"](this)},this);return a5.service.lms.foundAPIs=_(allAPIs).chain().filter(function(api){return api.hasAPI()}).value(),logger.info("LMS APIs tested: ",_.map(allAPIs,function(a){return a._class_name.substring(15)}).join(", ")),logger.info("LMS APIs found: ",_.map(a5.service.lms.foundAPIs,function(a){return a._class_name.substring(15)}).join(", ")),a5.service.lms.API=new a5.service.lms.APIFacade(new a5.service.lms.MultiAPI(a5.service.lms.foundAPIs),!this.config.get("lms_no_store"),!this.config.get("lms_no_restore")),a5.service.lms.hasAPI=function(API){return _.find(a5.service.lms.foundAPIs,function(api){return api._class_name.substring(15)==API})},a5.service.lms.API.start()},_initLRS:function(){var lmsApis=this.config.get("lms_apis").split(",");if(_.contains(lmsApis,"TinCan"))return this.invoke("init-lrs",{endpoint:this.config.get("lrs_endpoint")})},_initAudio:function(){a5.service.media.audio=new a5.service.media.audio_manager.Creator({urlBuilder:this.config.get("audio_url_builder"),preferOga:this.config.get("audio_format_prefer_oga"),formats:this.config.get("audio_formats"),debug:this.config.get("debug")}),$(window).on("unload",function(){a5.service.media.audio.pauseAll()})},_initVideo:function(){a5.service.media.video=new a5.service.media.video_manager.Creator({url:this.config.get("video_videojs_swf_path"),urlBuilder:this.config.get("video_url_builder"),preferWebm:this.config.get("video_format_prefer_webm"),formats:this.config.get("video_formats")}),$(window).on("unload",function(){a5.service.media.video.pauseAll()})},_initTTS:function(){a5.service.media.tts_audio=new a5.service.media.tts_audio_manager.Creator({urlBuilder:this.config.get("tts_audio_url_builder")})},_initToolbelt:function(){a5.service.toolbelt=new a5.service.Toolbelt},_initSTT:function(){a5.service.media.stt=new a5.service.media.SpeechToText},_initTemplateService:function(){a5.service.templates=new a5.service.Templates({dp:this.dp})},_initBuilders:function(){var builders=["Anchor","PPEbookBuilder","PPAudioBook","ICDialogueRecording","ISHangman"];_.each(builders,function(builder){a5.model_builder.builders.push(new a5.model_builder[builder](this))},this)},_initRecorder:function(){a5.service.media.audio_recorder=new a5.service.media.recorder_manager.AudioRecorder},_initSpecialChars:function(){window.CATspecialChars={},window.CATspecialChars.French=["&#192;","&#224;","&#194;","&#226;","&#198;","&#230;","&#199;","&#231;","&#201;","&#233;","&#200;","&#232;","&#202;","&#234;","&#203;","&#235;","&#206;","&#238;","&#207;","&#239;","&#212;","&#244;","&#338;","&#339;","&#217;","&#249;","&#219;","&#251;","&#220;","&#252;","&#376;","&#255;"],window.CATspecialChars.Spanish=["&#193;","&#225;","&#201;","&#233;","&#205;","&#237;","&#211;","&#243;","&#218;","&#250;","&#220;","&#252;","&#209;","&#241;","&#191;","&#161;"],window.CATspecialChars.German=["&#196;","&#228;","&#214;","&#246;","&#220;","&#252;","&#223;"],window.CATspecialChars.Ancient_Greek=["&#913;","&#945;","&#925;","&#957;","&#914;","&#946;","&#926;","&#958;","&#915;","&#947;","&#927;","&#959;","&#916;","&#948;","&#928;","&#960;","&#917;","&#949;","&#929;","&#961;","&#918;","&#950;","&#931;","&#963;","&#962;","&#919;","&#951;","&#932;","&#964;","&#920;","&#952;","&#933;","&#965;","&#921;","&#953;","&#934;","&#966;","&#922;","&#954;","&#935;","&#967;","&#923;","&#955;","&#936;","&#968;","&#924;","&#956;","&#937;","&#969;"],window.CATspecialChars.Scientific_Characters=["&#8652;","&#8592;","&#8594;","&#91;","&#93;","&#40;","&#41;","&#43;","&#8722;","&#247;","&#215;","&#177;","&#8805;","&#62;","&#60;","&#8804;","&#8734;","&#176;","&#8212;","&#8801;","&#61;","&#948;&#43;","&#948;&#8722;","&#10677;","&#8733;","&#8730;"],window.CATspecialChars.Arithmetic_Operators=["&#43;","&#8758;","&#8226","&#8722;","&#60;","&#62;","&#61;","&#8539;","&#188;","&#189;","&#190;"],window.CATspecialChars.Swedish=["&#197;","&#229"],window.CATspecialChars.Danish=["&#197;","&#229","&#198","&#230","&#216","&#248"],window.CATspecialChars.Polish=["&#380;","&#347","&#243","&#321","&#322","&#261","&#324","&#263","&#378","&#281"],window.CATspecialChars.Turkish=["&#286;","&#287","&#304","&#305","&#350","&#351","&#199","&#231"]},_startSizeObserver:function(){$(window).on("resize",function(){this.layout.checkSize()}.bind(this)),a5.eventBus.bind("interaction:show",function(interaction){this.layout.checkSize(),interaction.bind("screen_transition:end",function(){this.layout.checkSize()},this,{once:!0})},this),a5.mainBuilder&&a5.mainBuilder.bind("frequent_score_update",function(){this.layout.checkSize()},this)},_loadConfig:function(externalConfig){return this.config=new a5.Config,this.config.load(externalConfig).then(this._setA5andLOInfo)},_loadDP:function(){var dpOptions={path:this.config.get("skin_url"),enginePath:this.config.get("engine_root"),development:this.config.get("debug")};this.dp="git"===this.config.get("skin_type")?new a5.GitDesignPack(dpOptions):new a5.DesignPack(dpOptions)},_loadLayout:function(){return this.layout=new a5.Layout({dp:this.dp}),this.layout.load()},_initPostMessager:function(){a5.service.postMessager=new a5.service.PostMessager},_initLibraryLoader:function(){a5.service.libraryLoader=new a5.service.ExternalLibraryLoader},_initReactEngineInterface:function(){a5.service.reactEngineInterface=new a5.service.React.EngineInterface},_init:function(){return $.when().then(this._initLRS).then(this._initLMS).then(function(){this._initAudio(),this._initVideo(),this._initTTS(),this._initToolbelt(),this._initSTT(),this._initTemplateService(),this._initBuilders(),this._initRecorder(),this._initPostMessager(),this._initLibraryLoader(),this._initReactEngineInterface(),this._initSpecialChars()}.bind(this))},_start:function(){a5.mainBuilder=new a5.MainBuilder,a5.mainBuilder.engine=this,a5.mainBuilder.layout=this.layout,a5.mainBuilder.metadata=this.config.get("metadata")||new a5.models.Metadata;var screens=this.config.get("screens");_(screens).each(function(scr){a5.mainBuilder.addInteraction(scr.name,scr.preview,scr.helpText,scr.resources)}),this._startSizeObserver(),a5.mainBuilder.start(),a5.eventBus.trigger("performance:engine_overhead:end")},_close:function(){a5.mainBuilder&&a5.mainBuilder.close()},_openVideo:function(parameters){$("body").removeClass("standalone-video standalone-audio"),a5.service.media.video.pauseAll(),a5.service.media.audio.pauseAll();var deferred=$.Deferred(),view=new a5.view.Video({layout:this.layout,ref:parameters.ref,subtitles:parameters.subtitles,transcript:parameters.transcript});return $("body").addClass("standalone-video"),$("#content_wrap").html(view.$el),view.bind("ready",function(){this.layout.checkSize(),deferred.resolve()}.bind(this)),view.render(),deferred.promise()},_openAudio:function(parameters){$("body").removeClass("standalone-video standalone-audio"),a5.service.media.video.pauseAll(),a5.service.media.audio.pauseAll();var deferred=$.Deferred(),view=new a5.view.Audio({layout:this.layout,ref:parameters.ref,subtitles:parameters.subtitles,transcript:parameters.transcript});return $("body").addClass("standalone-audio"),$("#content_wrap").html(view.$el),view.bind("ready",function(){this.layout.checkSize(),deferred.resolve()}.bind(this)),view.render(),deferred.promise()}}),Engine}()}(a5,jQuery,_),function(a5,$,_){a5.Book=function(){var Book=function(engine){this.engine=engine,_.bindAll(this,"_openPage","_openTOC","_closeTOC","_bookmark","_unbookmark","_sendBack","_bringFront")};return _(Book.prototype).extend({ready:function(){return this.engine.ready()},close:function(){return this.engine.finalize()},setProperties:function(properties){this.model=properties.model,this.view=properties.view},addEventListener:function(event,callback,context,options){this.engine.addEventListener("book:"+event,callback,context,options)},removeEventListener:function(name,func){this.engine.removeEventListener("book:"+name,func)},register:function(key,val){this.engine.register("book:"+key,val)},lookup:function(key){return this.engine.lookup("book:"+key)},invoke:function(key){return this.engine.invoke("book:"+key)},openPage:function(page){return $.when(page).then(this._openPage)},getCurrentPage:function(){return this.model.getCurrentPageNumber()},openTOC:function(){return $.when().then(this._openTOC)},closeTOC:function(){return $.when().then(this._closeTOC)},getBookmarks:function(){return this.model.getBookmarks()},unbookmark:function(page){return $.when(page).then(this._unbookmark)},bookmark:function(page,text){return $.when(page,text).then(this._bookmark)},getNotes:function(){return this.model.getNotes()},sendBack:function(){return $.when().then(this._sendBack)},bringFront:function(){return $.when().then(this._bringFront)},addFileHotspot:function(page,options){this.view.addFileHotspot(page,options)},setPagesPerScreen:function(pagesPerScreen){this.model.setPagesPerScreen(pagesPerScreen)},getPagesPerScreen:function(){return this.model.getPagesPerScreen()},resourcePanelMode:function(mode){if(!_.isUndefined(mode)){var oldMode=this.model.resourcePanelMode;this.model.resourcePanelMode=mode,this.model.trigger("change:resourcePanelMode",{oldMode:oldMode,newMode:mode})}return this.model.resourcePanelMode},toggleFullscreen:function(fullscreen){this.view.toggleFullscreen(fullscreen)},pauseMedia:function(){a5.service.media.pauseAll()},getSize:function(){return this.engine.getSize()},getPages:function(){return this.model.serializePages()},_openPage:function(page){this.model.openPageNumber(page)},_openTOC:function(){this.view.openToc()},_closeTOC:function(){this.view.closeToc()},_unbookmark:function(page){this.model.unbookmark(page)},_bookmark:function(page,text){this.model.bookmark(page,text)},_sendBack:function(){this.view.sendBack()},_bringFront:function(){this.view.bringFront()}}),Book}()}(a5,jQuery,_),function(a5,$,_){a5.LearningObject=function(){var LearningObject=function(engine){this.engine=engine,_.bindAll(this,"_goNext","_goPrev","_goToExerciseScreen","_goToResultScreen","_submit","_checkAnswer","_sendScores")};return _(LearningObject.prototype).extend({ready:function(){return this.engine.ready()},close:function(){return this.engine.finalize()},addEventListener:function(event,callback,context,options){this.engine.addEventListener(event,callback,context,options)},removeEventListener:function(name,func){this.engine.removeEventListener(name,func)},register:function(key,val){this.engine.register(key,val)},lookup:function(key){return this.engine.lookup(key)},invoke:function(key){return this.engine.invoke(key)},getCurrentInteraction:function(){return a5.mainBuilder.getCurrentInteraction().visibleIndex},getCurrentScreen:function(){return a5.mainBuilder.getCurrentInteraction().visibleIndex+(a5.mainBuilder.hasIntroScreen()?1:0)},currentScreen:function(){return this.getCurrentScreen()},goNext:function(){return $.when().then(this._goNext)},goPrev:function(){return $.when().then(this._goPrev)},goToExerciseScreen:function(){return $.when().then(this._goToExerciseScreen)},reviewAnswers:function(){return this.goToExerciseScreen()},goToResultScreen:function(){return $.when().then(this._goToResultScreen)},showResults:function(){return this.goToResultScreen()},getNumberOfInteractions:function(){return a5.mainBuilder.getNumberOfInteractions()},getNumberOfScreens:function(){return a5.mainBuilder.getNumberOfInteractions()+(a5.mainBuilder.hasIntroScreen()?1:0)},totalScreens:function(){return this.getNumberOfScreens()},submit:function(){return $.when().then(this._submit)},checkAnswer:function(){return $.when().then(this._checkAnswer)},checkAnswers:function(){return this.checkAnswer()},showAnswer:function(){return $.when().then(this._showAnswer)},showAnswers:function(){return this.showAnswer()},sendScores:function(){return $.when().then(this._sendScores)},pauseMedia:function(){a5.service.media.pauseAll()},getSize:function(){return this.engine.getSize()},getControlsStatus:function(buttonId){return a5.mainBuilder.controls.getStatus(buttonId)},getAvailableFontSizes:function(){return a5.mainBuilder.getAvailableFontSizes()},getDefaultFontSize:function(){return a5.mainBuilder.getDefaultFontSize()},getCurrentFontSize:function(){return a5.mainBuilder.getCurrentFontSize()},setFontSize:function(size){a5.mainBuilder.setFontSize(size)},resetFontSize:function(){a5.mainBuilder.resetFontSize()},setFontFamily:function(family){a5.mainBuilder.setFontFamily(family)},resetFontFamily:function(family){a5.mainBuilder.resetFontFamily(family)},openNotes:function(){a5.mainBuilder.openNotes()},closeNotes:function(){a5.mainBuilder.closeNotes()},getNotes:function(){return a5.mainBuilder.note},_goNext:function(){a5.mainBuilder.hasNext()&&a5.mainBuilder.goNext()},_goPrev:function(){a5.mainBuilder.hasPrev()&&a5.mainBuilder.goPrev()},_goToExerciseScreen:function(){a5.mainBuilder.goToExerciseScreen()},_goToResultScreen:function(){a5.mainBuilder.goToResultScreen()},_submit:function(){return a5.mainBuilder.submit()},_checkAnswer:function(){a5.mainBuilder.checkAnswer()},_showAnswer:function(){a5.mainBuilder.showAnswer()},_sendScores:function(){return a5.mainBuilder.sendScores()}}),LearningObject}()}(a5,jQuery,_),function(a5,$,_){window.A5||(A5={}),window.LOInfo||(LOInfo={}),a5.Config=function(){var _getURLParameter=function(name){name=name.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?&]"+name+"=([^&#]*)"),results=regex.exec(location.search);return null==results?"":decodeURIComponent(results[1].replace(/\+/g," "))},Config=function(){this.config={},this.config.start_on_init=!0,this.config.lms_apis="Scorm,Author,Console",this.config.lms_no_store=!1,this.config.lms_no_restore=!1,this.config.lms_no_close=!1,this.config.toolbelt_url="//toolbelt-test.avallain.com",this.config.default_saveas_filename="StudentUserName_CourseName_Topic",this.config.recording_rtmp_server="lnr-runtime.author5.avallain.com",this.config.asset_url_builder=function(id){return id},this.config.audio_url_builder=this.config.video_url_builder=function(id,format){return"media/"+id+"."+format},this.config.external_url_builder=null,this.config.tts_audio_url_builder=function(lang,speaker,text){return a5.config.get("tts_audio_service_url")+"?lang="+encodeURIComponent(lang)+"&speaker="+encodeURIComponent(speaker)+"&text="+encodeURIComponent(text)},this.config.tts_audio_service_url="http://www.writeon.ie/speaktext.do",this.config.tts_audio_lang="en",this.config.tts_audio_voice="Acapela Telecom HQ TTS English (UK) (Rachel 22 kHz)",this.config.audio_formats="mp3,oga",this.config.video_formats="webm,mp4",this.config.debug=!1,this.config.skin_type="classic",this.config.type="Standard",this.config.book_pages_per_screen=2,this.config.book_pages_per_screen_source="default",this.config.lo_without_controls=!1,this.config.geogebra="//author-engine-production.avallain.net/geogebra/v5/HTML5/5.0/web/",this.config.mathjax="//author-engine-production.avallain.net/mathjax/2.7.1",this.config.wiris_quiz_library_resources_url="//author-engine-production.avallain.net/wirisquiz/3.52.0/resources",this.config.wiris_quiz_validation_service_url="",this.config.item_bank_api_url="https://api-avallain-author-dev.avallain.net/api/v2/items_bank_items_for_engine",this.config.ckeditor_folder_path="lib/third-party/ckeditor_4.5.7/",this.config.LOInfo={},_.bindAll(this,"_merge","_loadLearningObjectInfoConfig")};return Config.prototype.get=function(key){return this.config[key]},Config.prototype.set=function(key,value){this.config[key]=value},Config.prototype.load=function(external){var authorConfig=this._loadAuthorConfig(),urlConfig=this._loadURLConfig(),externalConfig=this._loadExternalConfig(external),learningObjectConfig=this._loadLearningObjectInfoConfig();return $.when.apply(this,[learningObjectConfig,authorConfig,externalConfig,urlConfig]).then(this._merge)},Config.prototype._merge=function(learningObjectConfig,authorConfig,externalConfig,urlConfig){if(_.extend(this.config,learningObjectConfig,authorConfig,externalConfig,urlConfig),!this.config.lms_apis.match(/Dummy/gi)){var lms_apis=_.compact(this.config.lms_apis.split(","));lms_apis.push("Dummy"),this.config.lms_apis=lms_apis.join(",")}this.config.engine_root&&this.config.engine_root.replace(/http(s)*:/,""),this.config.toolbelt_url&&(this.config.toolbelt_url.replace(/http(s)*:/,""),this.config.toolbelt_url=("https:"===window.location.protocol?"https:":"http:")+this.config.toolbelt_url);var startTask=parseInt(this.config.start_task,10);_.isNaN(startTask)?this.config.start_task=void 0:this.config.start_task=startTask,this.config.skin_url&&_.isUndefined(this.config.skin_root)&&(this.config.skin_root=this.config.skin_url),this.config.video_videojs_swf_path||(this.config.video_videojs_swf_path=this.config.engine_root+"lib/third-party/video-js/video-js.swf"),this.config.react_bundle_folder_path||(this.config.react_bundle_folder_path=this.config.engine_root),this.config.tts_build_token=function(text){return a5.sha1hex(text+"4e042af043922a2b7025573e637722ca").replace(/^0+/,"")},this.config.tts_audio_url_builder=_.bind(function(text){var speaker=this.config.tts_audio_voice,token=this.config.tts_build_token(text);return this.config.tts_audio_service_url+"?speaker="+encodeURIComponent(speaker)+"&text="+encodeURIComponent(text)+"&token="+encodeURIComponent(token)},this),/http(s)*:/.test(window.location.protocol)&&_(["audio_url_builder","video_url_builder","tts_audio_url_builder","external_url_builder","asset_url_builder"]).each(function(fn){var oldFn=this.config[fn];_.isFunction(oldFn)&&(this.config[fn]=function(){var ret=oldFn.apply(this,arguments)||"";return logger.log("Sanitized "+ret+" url to avoid mixed content warnings."),ret.replace(/http(s)*:/,"")})},this);var audioFormats=this.config.audio_formats.split(",");this.config.audio_formats=_.invoke(audioFormats,"trim");var videoFormats=this.config.video_formats.split(",");this.config.video_formats=_.invoke(videoFormats,"trim");var book_pages_per_screen=parseInt(this.config.book_pages_per_screen,10);return _.isNaN(book_pages_per_screen)?this.config.book_pages_per_screen=void 0:this.config.book_pages_per_screen=book_pages_per_screen,this.config},Config.prototype._loadLearningObjectInfo=function(){return(new a5.utils.Loader).load("LearningObjectInfo.xml")},Config.prototype._parseLearningObjectInfo=function(data){var config={};try{var xml=$.parseXML(data.text),$lo=$(xml).find("LearningObjectInfo"),$screens=$lo.find("screens > screen"),$engine=($lo.find("resources > resource"),$lo.find("engine")),$dp=$lo.find("designPack");config.lms_apis=$lo.find("lmsApis").text()||void 0,config.engine_root=$engine.find("root").text()||void 0,config.skin_type=$dp.find("type").text()||void 0,config.skin_url=$dp.find("root").text()||void 0,config.recording_rtmp_server=$lo.find("lnrServer").text()||void 0,config.type=$lo.find("> type").text()||void 0,$lo.find("toolbeltServer").text()&&(config.toolbelt_url="//"+$lo.find("toolbeltServer").text());var lnrCDNURL=$lo.find("lnrCDNURL").text(),assetCDNURL=$lo.find("assetCDNURL").text();assetCDNURL&&(lnrCDNURL&&(config.audio_url_builder=function(id,format){return(0===id.indexOf("r5_")?lnrCDNURL:assetCDNURL)+"/"+id+"."+format},config.video_url_builder=function(id,format){return assetCDNURL+"/"+id+"."+format}),config.asset_url_builder=function(id){return id?(/^https?:\/\/|^\/\//i.test(id)?"":assetCDNURL+"/")+id:""});var tts={};try{tts=JSON.parse($lo.find("tts"))}catch(e){}config.tts_audio_service_url=tts.TTS_AUDIO_SERVICE_URL,config.tts_audio_voice=tts.TTS_AUDIO_VOICE;var audioFormats=$lo.find("audio").text(),videoFormats=$lo.find("video").text();audioFormats&&(config.audio_formats=audioFormats),videoFormats&&(config.video_formats=videoFormats),config.LOInfo={UID:$lo.find("UID").text(),ID:$lo.find("ID").text(),title:$lo.find("> title").text(),mode:$lo.find("mode").text(),LOOptions:$lo.find("LOOptions").text()};var metadata=new a5.models.Metadata;metadata.load($lo),config.metadata=metadata,config.screens=[],$screens.each(function(index,screenNode){var $screenNode=$(screenNode),screenName=$screenNode.find("> name").text(),screenHelpText=$screenNode.find("> helpText").text(),resources=$screenNode.find("> resources > resource").map(function(_,res){var $res=$(res);return{identifier:$res.find("> identifier").text(),rights:$res.find("> rights").text()}}).get();(screenName||screenHelpText||resources.length)&&config.screens.push({name:screenName,preview:$screenNode.find("> previewImageFullPath").text(),helpText:screenHelpText,resources:resources})})}catch(e){logger.warn("invalid LearningObjectInfo.xml")}return config=_(config).omit(function(value,key){return _.isUndefined(value)})},Config.prototype._loadLearningObjectInfoConfig=function(){var deferred=$.Deferred();return $.when().then(this._loadLearningObjectInfo).then(this._parseLearningObjectInfo).done(function(config){deferred.resolve(config)}).fail(function(){deferred.resolve({})}),deferred.promise()},Config.prototype._loadExternalConfig=function(external){external=external||{};var config=external,xmlList=external.xmls;return xmlList&&(config.screens=_(xmlList).map(function(xml){return{name:decodeURIComponent(xml),preview:!1}})),config=_(config).omit(function(value,key){return _.isUndefined(value)})},Config.prototype._loadAuthorConfig=function(author){author=author||A5;var config={};return config.lms_apis=author.LMS_APIS,config.lms_no_store=author.LMS_NO_STORE,config.lms_no_restore=author.LMS_NO_RESTORE,config.engine_root=author.ENGINE_ROOT,config.skin_type=author.SKIN_TYPE,config.skin_url=author.SKIN_URL,config.skin_root=author.SKIN_ROOT,config.toolbelt_url=author.TOOLBELT_URL,config.recording_rtmp_server=author.RECORDING_RTMP_SERVER,config.default_saveas_filename=author.DEFAULT_SAVEAS_FILENAME,config.asset_url_builder=author.ASSET_URL_BUILDER,config.audio_url_builder=author.AUDIO_URL_BUILDER,config.video_url_builder=author.VIDEO_URL_BUILDER,config.external_url_builder=author.EXTERNAL_URL_BUILDER,config.tts_audio_url_builder=author.TTS_AUDIO_URL_BUILDER,config.tts_audio_service_url=author.TTS_AUDIO_SERVICE_URL||window.LOInfo.TTS_AUDIO_SERVICE_URL,config.tts_audio_lang=author.TTS_AUDIO_LANG,config.tts_audio_voice=author.TTS_AUDIO_VOICE||window.LOInfo.TTS_AUDIO_VOICE,config.video_videojs_swf_path=author.VIDEO_VIDEOJS_SWF_PATH,config.audio_formats=author.AUDIO_FORMATS,config.video_formats=author.VIDEO_FORMATS,config.debug=!!author.DEBUG,config.start_task=author.START_TASK,config.book_pages_per_screen=author.DEFAULT_PAGES_PER_SCREEN,config.lo_without_controls=author.LO_WITHOUT_CONTROLS,config.geogebra=author.GEOGEBRA,config.mathjax=author.MATHJAX,config.wiris_quiz_library_resources_url=author.WIRIS_QUIZ_LIBRARY_RESOURCES_URL,config.wiris_quiz_validation_service_url=author.WIRIS_QUIZ_VALIDATION_SERVICE_URL,config.item_bank_api_url=author.ITEM_BANK_API_URL,config.ckeditor_folder_path=author.CKEDITOR_FOLDER_PATH,config.react_bundle_folder_path=author.REACT_BUNDLE_FOLDER_PATH,config.book_pages_per_screen&&(config.book_pages_per_screen_source="author"),_.isEmpty(window.LOInfo)||(config.LOInfo=window.LOInfo),config=_(config).omit(function(value,key){return _.isUndefined(value)})},Config.prototype._loadURLConfig=function(){var config={};config.lms_apis=_getURLParameter("a5_lms_api"),config.lms_no_store="false"===_getURLParameter("a5_store"),config.lms_no_restore="false"===_getURLParameter("a5_restore"),config.lms_no_close="false"===_getURLParameter("a5_lms_close"),config.dictionary_ref=_getURLParameter("a5_dictionary_ref"),config.audio_format_prefer_oga="oga"===_getURLParameter("a5_audio_format_prefer"),config.video_format_prefer_webm="webm"===_getURLParameter("a5_video_format_prefer"),config.start_task=_getURLParameter("a5_start_task"),config.book_pages_per_screen=_getURLParameter("a5_book_pages_per_screen"),config.lo_without_controls="true"===_getURLParameter("lo_without_controls"),config.buddyConfig=_getURLParameter("buddy"),config.book_pages_per_screen&&(config.book_pages_per_screen_source="url");var xmlList=_getURLParameter("xmlList");return xmlList&&(config.screens=_(xmlList.split(",")).map(function(xml){return{name:decodeURIComponent(xml),preview:!1}})),config.skin_url=_getURLParameter("package"),config.lrs_endpoint=_getURLParameter("endpoint"),config=_(config).omit(function(value,key){return!value})},Config}()}(a5,jQuery,_),function($){a5.dp.config={allowLOSelfClosing:!1,allowPauseRecordings:!0,annotationsDefaultTool:"pointer",annotationsKeepPaletteOpen:!1,annotationsUseRealEraser:!1,appendAttachmentTo:!1,appendCountdownTo:!1,appendFeedbackTo:!1,appendHintsTo:!1,appendHelpTextTo:!1,appendOfflineTextTo:!1,appendTeamScoreTo:!1,audioPreloadDisabled:!1,audioTinyPlayerPlayspeedButton:.5,audioVolumeStore:!0,audioUseNativeControls:!1,avatarAutostartDisabled:!1,avatarHideWhenHintsOff:!1,avatarSupport:!1,avatarUrlBuilder:function(id,fmt){return a5.mainBuilder.layout.packageURL+id+"."+fmt},bookAnnotationsLanguage:"en",bookAnnotationsToolbarAppendTo:".ebook .toolbar .tools.btn",bookAnnotationsToolbarAsPopup:!0,bookAnnotationsToolbarDragOnlyFromHandle:!1,bookAnnotationsToolbarInsideBounds:!1,bookAnnotationsToolbarPosition:!1,bookBookmarkMultiple:!1,bookCountdownTime:"00:20:00",bookDialogModal:!0,bookExternalFullscreen:!1,bookHotspotPopupModal:!0,bookKeyboardPanStep:20,bookNotesAsTabPanel:!1,bookNotesEditor:!1,bookNotesExportFormats:"rtf",bookPanelsType:"dialog",bookShowCurrentPagePlaceholder:!1,bookStickyNoteMinSize:!1,bookStickyNoteWithTitle:!1,bookTooltipDelay:1e3,bookTooltipDuration:4e3,bookZoomMarqueeClick:50,bookZoomMax:!1,bookZoomMin:!1,bookZoomPreserve:!0,bookZoomSinglePage:!1,bookZoomPinchStep:5,bookZoomStep:20,bookZoomWheelStep:5,boxdropAnswersPosition:!1,catchGameMovementSpeed:0,closeLOAfterSubmit:!1,colouringOpacity:1,confirmBeforeClose:!1,confirmBeforeSubmit:"if-unanswered",contentSize:function(){return{width:$(document).width(),height:$(document).height()}},continuousEnumerationInsideGaps:!1,displayFeedbackAfterSeeAnswer:!1,draggableHotspotWindow:!1,draggableOptions:{},drawRectLinkLines:!1,droppableToleranceRadius:30,dropdownNativeSelect:!1,exclusionBottom:0,exclusionTop:0,forceCorrectedAfterSubmitAttempts:!1,feedbackClickToggle:!1,flashfirstanswerDefaultDuration:1500,fontSizeDefault:!1,fontSizeSteps:!1,gapfillBehaviourApplicable:"all",hideSingleColorMarkButtons:!1,ICTextgapActive:!0,IMProofingSignalDuration:2e3,keepDragElementInsideContentZone:!0,linkingLinesAnswersCorrectColor:null,linkingLinesAnswersCorrectStyle:"solid",linkingLinesAnswersWrongColor:null,linkingLinesAnswersWrongStyle:"solid",linkingLinesColors:null,linkingLinesContainedEvents:!1,linkingLinesDefaultColor:null,linkingLinesFeedbackCorrectColor:null,linkingLinesFeedbackCorrectStyle:"solid",linkingLinesFeedbackWrongColor:null,linkingLinesFeedbackWrongStyle:"solid",linkingLinesLineWidth:null,linkingLinesPrefillColor:null,linkingLinesPrefillStyle:"solid",linkingLinesPreserveColorAfterCorrect:!1,linkingLinesTouchDirection:[0,1],linkingLinesTouchDuration:1e3,linkingLinesUnattemptedColor:null,linkingLinesUnattemptedStyle:"solid",linkingMultipleLinesAnswersCorrectColor:null,linkingMultipleLinesAnswersCorrectStyle:"solid",linkingMultipleLinesAnswersHoverColor:null,linkingMultipleLinesAnswersWrongColor:null,linkingMultipleLinesAnswersWrongStyle:"dotted",linkingMultipleLinesDefaultColor:null,linkingMultipleLinesFeedbackCorrectColor:null,linkingMultipleLinesFeedbackCorrectStyle:"solid",linkingMultipleLinesFeedbackWrongColor:null,linkingMultipleLinesFeedbackWrongStyle:"dotted",linkingMultipleLinesHoverColor:null,linkingMultipleLinesLineWidth:null,linkingMultipleLinesPrefillColor:null,linkingMultipleLinesPrefillStyle:"solid",linkingMultipleLinesPreserveColorAfterCorrect:!1,linkingMultipleLinesUnattemptedColor:null,linkingMultipleLinesUnattemptedStyle:"solid",linkingMultipleLinesSeeNextAnswerColor:null,linkingMultipleLinesSeeNextAnswerStyle:null,linkingSelectionAreaEnabled:!1,loadScreensOnDemand:!1,loNotesEditor:!1,markableActsAsToggle:!1,markingDefaultColors:{$default:["#A30000","#365403","#575700","#005F61","#9E0086","#6D524A"]},mathsGapDefaultWidth:100,mediaAreaFixedInView:!1,metadataAsCssClasses:!1,mobileBreakpoint:0,mousewheelActsAsPan:!1,multipleResourceMaximum:10,nonModalDialogs:[],ompairsNew:!1,ossortingCloneCss:!0,ossequenceTransitionDelay:0,pelmanismFailedPairTime:2e3,pelmanismShowAnswerDelay:1e3,positionedTranscript:!0,postMessageUIManagement:!1,ppslideshowDelay:6,ppslideshowEndingTime:.4,ppslideshowMagnifyEnd:"70%",ppslideshowMagnifyStart:"50%",ppslideshowMaxTime:10,ppslideshowMinTime:2,ppslideshowStep:1,protectBookPages:!1,protectImages:!1,reactActivitiesEnabled:!1,reactActivities:["Input:Completion:Crossword"],referenceOpenInTab:!1,resetCheckAttemptsAfterSkipScreen:!1,responsiveAttachments:!1,responsiveSupplements:!1,revealHideAlwaysVisible:!1,screenTransitionDuration:1e3,screenTransitionEnabled:!1,screenTransitionStart:function($from,$to){},screenTransitionEnd:function($from,$to){},showActivityFeedbackAfterSeeAnswersBeforeInteraction:!1,skipDialogs:!1,snakeFont:"italic 20px Georgia",snakeHeight:0,snakeHorizontalSpread:100,snakeSpace:18,snakeVerticalMax:60,snakeVerticalMin:20,snakeWidth:0,specificFeedbackAuto:!1,specificFeedbackDiv:!1,teamScoringDelay:2e3,videoUseNativeControls:!1,wordsearchCellSize:32,wordsearchCheckmarks:!1},Object.defineProperty(a5.dp.config,"tooltipClearance",{set:function(obj){logger.warn("Deprecated 'tooltipClearance' option used. Not needed anymore")}}),Object.defineProperty(a5.dp.config,"snake",{set:function(obj){logger.warn("Deprecated 'snake' object. Use flat properties instead (snakeSpace, snakeWidth, snakeHeight, snakeFont)"),obj.space&&(a5.dp.config.snakeSpace=obj.space),obj.width&&(a5.dp.config.snakeWidth=obj.width),obj.height&&(a5.dp.config.snakeHeight=obj.height),obj.font&&(a5.dp.config.snakeFont=obj.font)}}),Object.defineProperty(a5.dp.config,"ppslideshowOptions",{set:function(obj){logger.warn("Deprecated 'ppslideshowOptions' object. Use flat properties instead (ppslideshowStep, ppslideshowDelay, ppslideshowMagnifyStart, ppslideshowMagnifyEnd, ppslideshowMinTime, ppslideshowMaxTime, ppslideshowEndingTime)"),obj.step&&(a5.dp.config.ppslideshowStep=obj.step),obj.delay&&(a5.dp.config.ppslideshowDelay=obj.delay),obj.magnifyStart&&(a5.dp.config.ppslideshowMagnifyStart=obj.magnifyStart),obj.magnifyEnd&&(a5.dp.config.ppslideshowMagnifyEnd=obj.magnifyEnd),obj.minTime&&(a5.dp.config.ppslideshowMinTime=obj.minTime),obj.maxTime&&(a5.dp.config.ppslideshowMaxTime=obj.maxTime),obj.endingTime&&(a5.dp.config.ppslideshowEndingTime=obj.endingTime)}}),Object.defineProperty(a5.dp.config,"wordsearch",{set:function(obj){logger.warn("Deprecated 'wordsearch' object. Use flat properties instead (wordsearchCellSize, wordsearchCheckmarks)"),obj.cellSize&&(a5.dp.config.wordsearchCellSize=obj.cellSize),obj.checkmarks&&(a5.dp.config.wordsearchCheckmarks=obj.checkmarks)}})}(jQuery),function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):factory(jQuery)}(function($){$.ui=$.ui||{},$.extend($.ui,{version:"1.11.4",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),$.fn.extend({scrollParent:function(includeHidden){
var position=this.css("position"),excludeStaticParent="absolute"===position,overflowRegex=includeHidden?/(auto|scroll|hidden)/:/(auto|scroll)/,scrollParent=this.parents().filter(function(){var parent=$(this);return(!excludeStaticParent||"static"!==parent.css("position"))&&overflowRegex.test(parent.css("overflow")+parent.css("overflow-y")+parent.css("overflow-x"))}).eq(0);return"fixed"!==position&&scrollParent.length?scrollParent:$(this[0].ownerDocument||document)},uniqueId:function(){var uuid=0;return function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++uuid)})}}(),removeUniqueId:function(){return this.each(function(){/^ui-id-\d+$/.test(this.id)&&$(this).removeAttr("id")})}});function focusable(element,isTabIndexNotNaN){var map,mapName,img,nodeName=element.nodeName.toLowerCase();return"area"===nodeName?(map=element.parentNode,mapName=map.name,!(!element.href||!mapName||"map"!==map.nodeName.toLowerCase())&&(!!(img=$("img[usemap='#"+mapName+"']")[0])&&visible(img))):(/^(input|select|textarea|button|object)$/.test(nodeName)?!element.disabled:"a"===nodeName?element.href||isTabIndexNotNaN:isTabIndexNotNaN)&&visible(element)}function visible(element){return $.expr.filters.visible(element)&&!$(element).parents().addBack().filter(function(){return"hidden"===$.css(this,"visibility")}).length}$.extend($.expr[":"],{data:$.expr.createPseudo?$.expr.createPseudo(function(dataName){return function(elem){return!!$.data(elem,dataName)}}):function(elem,i,match){return!!$.data(elem,match[3])},focusable:function(element){return focusable(element,!isNaN($.attr(element,"tabindex")))},tabbable:function(element){var tabIndex=$.attr(element,"tabindex"),isTabIndexNaN=isNaN(tabIndex);return(isTabIndexNaN||tabIndex>=0)&&focusable(element,!isTabIndexNaN)}}),$("<a>").outerWidth(1).jquery||$.each(["Width","Height"],function(i,name){var side="Width"===name?["Left","Right"]:["Top","Bottom"],type=name.toLowerCase(),orig={innerWidth:$.fn.innerWidth,innerHeight:$.fn.innerHeight,outerWidth:$.fn.outerWidth,outerHeight:$.fn.outerHeight};function reduce(elem,size,border,margin){return $.each(side,function(){size-=parseFloat($.css(elem,"padding"+this))||0,border&&(size-=parseFloat($.css(elem,"border"+this+"Width"))||0),margin&&(size-=parseFloat($.css(elem,"margin"+this))||0)}),size}$.fn["inner"+name]=function(size){return void 0===size?orig["inner"+name].call(this):this.each(function(){$(this).css(type,reduce(this,size)+"px")})},$.fn["outer"+name]=function(size,margin){return"number"!=typeof size?orig["outer"+name].call(this,size):this.each(function(){$(this).css(type,reduce(this,size,!0,margin)+"px")})}}),$.fn.addBack||($.fn.addBack=function(selector){return this.add(null==selector?this.prevObject:this.prevObject.filter(selector))}),$("<a>").data("a-b","a").removeData("a-b").data("a-b")&&($.fn.removeData=function(removeData){return function(key){return arguments.length?removeData.call(this,$.camelCase(key)):removeData.call(this)}}($.fn.removeData)),$.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),$.fn.extend({focus:function(orig){return function(delay,fn){return"number"==typeof delay?this.each(function(){var elem=this;setTimeout(function(){$(elem).focus(),fn&&fn.call(elem)},delay)}):orig.apply(this,arguments)}}($.fn.focus),disableSelection:function(){var eventType="onselectstart"in document.createElement("div")?"selectstart":"mousedown";return function(){return this.bind(eventType+".ui-disableSelection",function(event){event.preventDefault()})}}(),enableSelection:function(){return this.unbind(".ui-disableSelection")},zIndex:function(zIndex){if(void 0!==zIndex)return this.css("zIndex",zIndex);if(this.length)for(var position,value,elem=$(this[0]);elem.length&&elem[0]!==document;){if(("absolute"===(position=elem.css("position"))||"relative"===position||"fixed"===position)&&(value=parseInt(elem.css("zIndex"),10),!isNaN(value)&&0!==value))return value;elem=elem.parent()}return 0}}),$.ui.plugin={add:function(module,option,set){var i,proto=$.ui[module].prototype;for(i in set)proto.plugins[i]=proto.plugins[i]||[],proto.plugins[i].push([option,set[i]])},call:function(instance,name,args,allowDisconnected){var i,set=instance.plugins[name];if(set&&(allowDisconnected||instance.element[0].parentNode&&11!==instance.element[0].parentNode.nodeType))for(i=0;i<set.length;i++)instance.options[set[i][0]]&&set[i][1].apply(instance.element,args)}};var widget_uuid=0,widget_slice=Array.prototype.slice;$.cleanData=function(orig){return function(elems){var events,elem,i;for(i=0;null!=(elem=elems[i]);i++)try{events=$._data(elem,"events"),events&&events.remove&&$(elem).triggerHandler("remove")}catch(e){}orig(elems)}}($.cleanData),$.widget=function(name,base,prototype){var fullName,existingConstructor,constructor,basePrototype,proxiedPrototype={},namespace=name.split(".")[0];return name=name.split(".")[1],fullName=namespace+"-"+name,prototype||(prototype=base,base=$.Widget),$.expr[":"][fullName.toLowerCase()]=function(elem){return!!$.data(elem,fullName)},$[namespace]=$[namespace]||{},existingConstructor=$[namespace][name],constructor=$[namespace][name]=function(options,element){if(!this._createWidget)return new constructor(options,element);arguments.length&&this._createWidget(options,element)},$.extend(constructor,existingConstructor,{version:prototype.version,_proto:$.extend({},prototype),_childConstructors:[]}),basePrototype=new base,basePrototype.options=$.widget.extend({},basePrototype.options),$.each(prototype,function(prop,value){if(!$.isFunction(value))return void(proxiedPrototype[prop]=value);proxiedPrototype[prop]=function(){var _super=function(){return base.prototype[prop].apply(this,arguments)},_superApply=function(args){return base.prototype[prop].apply(this,args)};return function(){var returnValue,__super=this._super,__superApply=this._superApply;return this._super=_super,this._superApply=_superApply,returnValue=value.apply(this,arguments),this._super=__super,this._superApply=__superApply,returnValue}}()}),constructor.prototype=$.widget.extend(basePrototype,{widgetEventPrefix:existingConstructor?basePrototype.widgetEventPrefix||name:name},proxiedPrototype,{constructor:constructor,namespace:namespace,widgetName:name,widgetFullName:fullName}),existingConstructor?($.each(existingConstructor._childConstructors,function(i,child){var childPrototype=child.prototype;$.widget(childPrototype.namespace+"."+childPrototype.widgetName,constructor,child._proto)}),delete existingConstructor._childConstructors):base._childConstructors.push(constructor),$.widget.bridge(name,constructor),constructor},$.widget.extend=function(target){for(var key,value,input=widget_slice.call(arguments,1),inputIndex=0,inputLength=input.length;inputIndex<inputLength;inputIndex++)for(key in input[inputIndex])value=input[inputIndex][key],input[inputIndex].hasOwnProperty(key)&&void 0!==value&&($.isPlainObject(value)?target[key]=$.isPlainObject(target[key])?$.widget.extend({},target[key],value):$.widget.extend({},value):target[key]=value);return target},$.widget.bridge=function(name,object){var fullName=object.prototype.widgetFullName||name;$.fn[name]=function(options){var isMethodCall="string"==typeof options,args=widget_slice.call(arguments,1),returnValue=this;return isMethodCall?this.each(function(){var methodValue,instance=$.data(this,fullName);return"instance"===options?(returnValue=instance,!1):instance?$.isFunction(instance[options])&&"_"!==options.charAt(0)?(methodValue=instance[options].apply(instance,args),methodValue!==instance&&void 0!==methodValue?(returnValue=methodValue&&methodValue.jquery?returnValue.pushStack(methodValue.get()):methodValue,!1):void 0):$.error("no such method '"+options+"' for "+name+" widget instance"):$.error("cannot call methods on "+name+" prior to initialization; attempted to call method '"+options+"'")}):(args.length&&(options=$.widget.extend.apply(null,[options].concat(args))),this.each(function(){var instance=$.data(this,fullName);instance?(instance.option(options||{}),instance._init&&instance._init()):$.data(this,fullName,new object(options,this))})),returnValue}},$.Widget=function(){},$.Widget._childConstructors=[],$.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(options,element){element=$(element||this.defaultElement||this)[0],this.element=$(element),this.uuid=widget_uuid++,this.eventNamespace="."+this.widgetName+this.uuid,this.bindings=$(),this.hoverable=$(),this.focusable=$(),element!==this&&($.data(element,this.widgetFullName,this),this._on(!0,this.element,{remove:function(event){event.target===element&&this.destroy()}}),this.document=$(element.style?element.ownerDocument:element.document||element),this.window=$(this.document[0].defaultView||this.document[0].parentWindow)),this.options=$.widget.extend({},this.options,this._getCreateOptions(),options),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:$.noop,_getCreateEventData:$.noop,_create:$.noop,_init:$.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetFullName).removeData($.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")},_destroy:$.noop,widget:function(){return this.element},option:function(key,value){var parts,curOption,i,options=key;if(0===arguments.length)return $.widget.extend({},this.options);if("string"==typeof key)if(options={},parts=key.split("."),key=parts.shift(),parts.length){for(curOption=options[key]=$.widget.extend({},this.options[key]),i=0;i<parts.length-1;i++)curOption[parts[i]]=curOption[parts[i]]||{},curOption=curOption[parts[i]];if(key=parts.pop(),1===arguments.length)return void 0===curOption[key]?null:curOption[key];curOption[key]=value}else{if(1===arguments.length)return void 0===this.options[key]?null:this.options[key];options[key]=value}return this._setOptions(options),this},_setOptions:function(options){var key;for(key in options)this._setOption(key,options[key]);return this},_setOption:function(key,value){return this.options[key]=value,"disabled"===key&&(this.widget().toggleClass(this.widgetFullName+"-disabled",!!value),value&&(this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus"))),this},enable:function(){return this._setOptions({disabled:!1})},disable:function(){return this._setOptions({disabled:!0})},_on:function(suppressDisabledCheck,element,handlers){var delegateElement,instance=this;"boolean"!=typeof suppressDisabledCheck&&(handlers=element,element=suppressDisabledCheck,suppressDisabledCheck=!1),handlers?(element=delegateElement=$(element),this.bindings=this.bindings.add(element)):(handlers=element,element=this.element,delegateElement=this.widget()),$.each(handlers,function(event,handler){function handlerProxy(){if(suppressDisabledCheck||!0!==instance.options.disabled&&!$(this).hasClass("ui-state-disabled"))return("string"==typeof handler?instance[handler]:handler).apply(instance,arguments)}"string"!=typeof handler&&(handlerProxy.guid=handler.guid=handler.guid||handlerProxy.guid||$.guid++);var match=event.match(/^([\w:-]*)\s*(.*)$/),eventName=match[1]+instance.eventNamespace,selector=match[2];selector?delegateElement.delegate(selector,eventName,handlerProxy):element.bind(eventName,handlerProxy)})},_off:function(element,eventName){eventName=(eventName||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,element.unbind(eventName).undelegate(eventName),this.bindings=$(this.bindings.not(element).get()),this.focusable=$(this.focusable.not(element).get()),this.hoverable=$(this.hoverable.not(element).get())},_delay:function(handler,delay){function handlerProxy(){return("string"==typeof handler?instance[handler]:handler).apply(instance,arguments)}var instance=this;return setTimeout(handlerProxy,delay||0)},_hoverable:function(element){this.hoverable=this.hoverable.add(element),this._on(element,{mouseenter:function(event){$(event.currentTarget).addClass("ui-state-hover")},mouseleave:function(event){$(event.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(element){this.focusable=this.focusable.add(element),this._on(element,{focusin:function(event){$(event.currentTarget).addClass("ui-state-focus")},focusout:function(event){$(event.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(type,event,data){var prop,orig,callback=this.options[type];if(data=data||{},event=$.Event(event),event.type=(type===this.widgetEventPrefix?type:this.widgetEventPrefix+type).toLowerCase(),event.target=this.element[0],orig=event.originalEvent)for(prop in orig)prop in event||(event[prop]=orig[prop]);return this.element.trigger(event,data),!($.isFunction(callback)&&!1===callback.apply(this.element[0],[event].concat(data))||event.isDefaultPrevented())}},$.each({show:"fadeIn",hide:"fadeOut"},function(method,defaultEffect){$.Widget.prototype["_"+method]=function(element,options,callback){"string"==typeof options&&(options={effect:options});var hasOptions,effectName=options?!0===options||"number"==typeof options?defaultEffect:options.effect||defaultEffect:method;options=options||{},"number"==typeof options&&(options={duration:options}),hasOptions=!$.isEmptyObject(options),options.complete=callback,options.delay&&element.delay(options.delay),hasOptions&&$.effects&&$.effects.effect[effectName]?element[method](options):effectName!==method&&element[effectName]?element[effectName](options.duration,options.easing,callback):element.queue(function(next){$(this)[method](),callback&&callback.call(element[0]),next()})}});var mouseHandled=($.widget,!1);$(document).mouseup(function(){mouseHandled=!1});$.widget("ui.mouse",{version:"1.11.4",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var that=this;this.element.bind("mousedown."+this.widgetName,function(event){return that._mouseDown(event)}).bind("click."+this.widgetName,function(event){if(!0===$.data(event.target,that.widgetName+".preventClickEvent"))return $.removeData(event.target,that.widgetName+".preventClickEvent"),event.stopImmediatePropagation(),!1}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&this.document.unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(event){if(!mouseHandled){this._mouseMoved=!1,this._mouseStarted&&this._mouseUp(event),this._mouseDownEvent=event;var that=this,btnIsLeft=1===event.which,elIsCancel=!("string"!=typeof this.options.cancel||!event.target.nodeName)&&$(event.target).closest(this.options.cancel).length;return!(btnIsLeft&&!elIsCancel&&this._mouseCapture(event))||(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){that.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(event)&&this._mouseDelayMet(event)&&(this._mouseStarted=!1!==this._mouseStart(event),!this._mouseStarted)?(event.preventDefault(),!0):(!0===$.data(event.target,this.widgetName+".preventClickEvent")&&$.removeData(event.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(event){return that._mouseMove(event)},this._mouseUpDelegate=function(event){return that._mouseUp(event)},this.document.bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),event.preventDefault(),mouseHandled=!0,!0))}},_mouseMove:function(event){if(this._mouseMoved){if($.ui.ie&&(!document.documentMode||document.documentMode<9)&&!event.button)return this._mouseUp(event);if(!event.which)return this._mouseUp(event)}return(event.which||event.button)&&(this._mouseMoved=!0),this._mouseStarted?(this._mouseDrag(event),event.preventDefault()):(this._mouseDistanceMet(event)&&this._mouseDelayMet(event)&&(this._mouseStarted=!1!==this._mouseStart(this._mouseDownEvent,event),this._mouseStarted?this._mouseDrag(event):this._mouseUp(event)),!this._mouseStarted)},_mouseUp:function(event){return this.document.unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,event.target===this._mouseDownEvent.target&&$.data(event.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(event)),mouseHandled=!1,!1},_mouseDistanceMet:function(event){return Math.max(Math.abs(this._mouseDownEvent.pageX-event.pageX),Math.abs(this._mouseDownEvent.pageY-event.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}});!function(){$.ui=$.ui||{};var cachedScrollbarWidth,supportsOffsetFractions,max=Math.max,abs=Math.abs,round=Math.round,rhorizontal=/left|center|right/,rvertical=/top|center|bottom/,roffset=/[\+\-]\d+(\.[\d]+)?%?/,rposition=/^\w+/,rpercent=/%$/,_position=$.fn.position;function getOffsets(offsets,width,height){return[parseFloat(offsets[0])*(rpercent.test(offsets[0])?width/100:1),parseFloat(offsets[1])*(rpercent.test(offsets[1])?height/100:1)]}function parseCss(element,property){return parseInt($.css(element,property),10)||0}function getDimensions(elem){var raw=elem[0];return 9===raw.nodeType?{width:elem.width(),height:elem.height(),offset:{top:0,left:0}}:$.isWindow(raw)?{width:elem.width(),height:elem.height(),offset:{top:elem.scrollTop(),left:elem.scrollLeft()}}:raw.preventDefault?{width:0,height:0,offset:{top:raw.pageY,left:raw.pageX}}:{width:elem.outerWidth(),height:elem.outerHeight(),offset:elem.offset()}}$.position={scrollbarWidth:function(){if(void 0!==cachedScrollbarWidth)return cachedScrollbarWidth;var w1,w2,div=$("<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"),innerDiv=div.children()[0];return $("body").append(div),w1=innerDiv.offsetWidth,div.css("overflow","scroll"),w2=innerDiv.offsetWidth,w1===w2&&(w2=div[0].clientWidth),div.remove(),cachedScrollbarWidth=w1-w2},getScrollInfo:function(within){var overflowX=within.isWindow||within.isDocument?"":within.element.css("overflow-x"),overflowY=within.isWindow||within.isDocument?"":within.element.css("overflow-y"),hasOverflowX="scroll"===overflowX||"auto"===overflowX&&within.width<within.element[0].scrollWidth;return{width:"scroll"===overflowY||"auto"===overflowY&&within.height<within.element[0].scrollHeight?$.position.scrollbarWidth():0,height:hasOverflowX?$.position.scrollbarWidth():0}},getWithinInfo:function(element){var withinElement=$(element||window),isWindow=$.isWindow(withinElement[0]),isDocument=!!withinElement[0]&&9===withinElement[0].nodeType;return{element:withinElement,isWindow:isWindow,isDocument:isDocument,offset:withinElement.offset()||{left:0,top:0},scrollLeft:withinElement.scrollLeft(),scrollTop:withinElement.scrollTop(),width:isWindow||isDocument?withinElement.width():withinElement.outerWidth(),height:isWindow||isDocument?withinElement.height():withinElement.outerHeight()}}},$.fn.position=function(options){if(!options||!options.of)return _position.apply(this,arguments);options=$.extend({},options);var atOffset,targetWidth,targetHeight,targetOffset,basePosition,dimensions,target=$(options.of),within=$.position.getWithinInfo(options.within),scrollInfo=$.position.getScrollInfo(within),collision=(options.collision||"flip").split(" "),offsets={};return dimensions=getDimensions(target),target[0].preventDefault&&(options.at="left top"),targetWidth=dimensions.width,targetHeight=dimensions.height,targetOffset=dimensions.offset,basePosition=$.extend({},targetOffset),$.each(["my","at"],function(){var horizontalOffset,verticalOffset,pos=(options[this]||"").split(" ");1===pos.length&&(pos=rhorizontal.test(pos[0])?pos.concat(["center"]):rvertical.test(pos[0])?["center"].concat(pos):["center","center"]),pos[0]=rhorizontal.test(pos[0])?pos[0]:"center",pos[1]=rvertical.test(pos[1])?pos[1]:"center",horizontalOffset=roffset.exec(pos[0]),verticalOffset=roffset.exec(pos[1]),offsets[this]=[horizontalOffset?horizontalOffset[0]:0,verticalOffset?verticalOffset[0]:0],options[this]=[rposition.exec(pos[0])[0],rposition.exec(pos[1])[0]]}),1===collision.length&&(collision[1]=collision[0]),"right"===options.at[0]?basePosition.left+=targetWidth:"center"===options.at[0]&&(basePosition.left+=targetWidth/2),"bottom"===options.at[1]?basePosition.top+=targetHeight:"center"===options.at[1]&&(basePosition.top+=targetHeight/2),atOffset=getOffsets(offsets.at,targetWidth,targetHeight),basePosition.left+=atOffset[0],basePosition.top+=atOffset[1],this.each(function(){var collisionPosition,using,elem=$(this),elemWidth=elem.outerWidth(),elemHeight=elem.outerHeight(),marginLeft=parseCss(this,"marginLeft"),marginTop=parseCss(this,"marginTop"),collisionWidth=elemWidth+marginLeft+parseCss(this,"marginRight")+scrollInfo.width,collisionHeight=elemHeight+marginTop+parseCss(this,"marginBottom")+scrollInfo.height,position=$.extend({},basePosition),myOffset=getOffsets(offsets.my,elem.outerWidth(),elem.outerHeight());"right"===options.my[0]?position.left-=elemWidth:"center"===options.my[0]&&(position.left-=elemWidth/2),"bottom"===options.my[1]?position.top-=elemHeight:"center"===options.my[1]&&(position.top-=elemHeight/2),position.left+=myOffset[0],position.top+=myOffset[1],supportsOffsetFractions||(position.left=round(position.left),position.top=round(position.top)),collisionPosition={marginLeft:marginLeft,marginTop:marginTop},$.each(["left","top"],function(i,dir){$.ui.position[collision[i]]&&$.ui.position[collision[i]][dir](position,{targetWidth:targetWidth,targetHeight:targetHeight,elemWidth:elemWidth,elemHeight:elemHeight,collisionPosition:collisionPosition,collisionWidth:collisionWidth,collisionHeight:collisionHeight,offset:[atOffset[0]+myOffset[0],atOffset[1]+myOffset[1]],my:options.my,at:options.at,within:within,elem:elem})}),options.using&&(using=function(props){var left=targetOffset.left-position.left,right=left+targetWidth-elemWidth,top=targetOffset.top-position.top,bottom=top+targetHeight-elemHeight,feedback={target:{element:target,left:targetOffset.left,top:targetOffset.top,width:targetWidth,height:targetHeight},element:{element:elem,left:position.left,top:position.top,width:elemWidth,height:elemHeight},horizontal:right<0?"left":left>0?"right":"center",vertical:bottom<0?"top":top>0?"bottom":"middle"};targetWidth<elemWidth&&abs(left+right)<targetWidth&&(feedback.horizontal="center"),targetHeight<elemHeight&&abs(top+bottom)<targetHeight&&(feedback.vertical="middle"),max(abs(left),abs(right))>max(abs(top),abs(bottom))?feedback.important="horizontal":feedback.important="vertical",options.using.call(this,props,feedback)}),elem.offset($.extend(position,{using:using}))})},$.ui.position={fit:{left:function(position,data){var newOverRight,within=data.within,withinOffset=within.isWindow?within.scrollLeft:within.offset.left,outerWidth=within.width,collisionPosLeft=position.left-data.collisionPosition.marginLeft,overLeft=withinOffset-collisionPosLeft,overRight=collisionPosLeft+data.collisionWidth-outerWidth-withinOffset;data.collisionWidth>outerWidth?overLeft>0&&overRight<=0?(newOverRight=position.left+overLeft+data.collisionWidth-outerWidth-withinOffset,position.left+=overLeft-newOverRight):position.left=overRight>0&&overLeft<=0?withinOffset:overLeft>overRight?withinOffset+outerWidth-data.collisionWidth:withinOffset:overLeft>0?position.left+=overLeft:overRight>0?position.left-=overRight:position.left=max(position.left-collisionPosLeft,position.left)},top:function(position,data){var newOverBottom,within=data.within,withinOffset=within.isWindow?within.scrollTop:within.offset.top,outerHeight=data.within.height,collisionPosTop=position.top-data.collisionPosition.marginTop,overTop=withinOffset-collisionPosTop,overBottom=collisionPosTop+data.collisionHeight-outerHeight-withinOffset;data.collisionHeight>outerHeight?overTop>0&&overBottom<=0?(newOverBottom=position.top+overTop+data.collisionHeight-outerHeight-withinOffset,position.top+=overTop-newOverBottom):position.top=overBottom>0&&overTop<=0?withinOffset:overTop>overBottom?withinOffset+outerHeight-data.collisionHeight:withinOffset:overTop>0?position.top+=overTop:overBottom>0?position.top-=overBottom:position.top=max(position.top-collisionPosTop,position.top)}},flip:{left:function(position,data){var newOverRight,newOverLeft,within=data.within,withinOffset=within.offset.left+within.scrollLeft,outerWidth=within.width,offsetLeft=within.isWindow?within.scrollLeft:within.offset.left,collisionPosLeft=position.left-data.collisionPosition.marginLeft,overLeft=collisionPosLeft-offsetLeft,overRight=collisionPosLeft+data.collisionWidth-outerWidth-offsetLeft,myOffset="left"===data.my[0]?-data.elemWidth:"right"===data.my[0]?data.elemWidth:0,atOffset="left"===data.at[0]?data.targetWidth:"right"===data.at[0]?-data.targetWidth:0,offset=-2*data.offset[0];overLeft<0?((newOverRight=position.left+myOffset+atOffset+offset+data.collisionWidth-outerWidth-withinOffset)<0||newOverRight<abs(overLeft))&&(position.left+=myOffset+atOffset+offset):overRight>0&&((newOverLeft=position.left-data.collisionPosition.marginLeft+myOffset+atOffset+offset-offsetLeft)>0||abs(newOverLeft)<overRight)&&(position.left+=myOffset+atOffset+offset)},top:function(position,data){var newOverTop,newOverBottom,within=data.within,withinOffset=within.offset.top+within.scrollTop,outerHeight=within.height,offsetTop=within.isWindow?within.scrollTop:within.offset.top,collisionPosTop=position.top-data.collisionPosition.marginTop,overTop=collisionPosTop-offsetTop,overBottom=collisionPosTop+data.collisionHeight-outerHeight-offsetTop,top="top"===data.my[1],myOffset=top?-data.elemHeight:"bottom"===data.my[1]?data.elemHeight:0,atOffset="top"===data.at[1]?data.targetHeight:"bottom"===data.at[1]?-data.targetHeight:0,offset=-2*data.offset[1];overTop<0?((newOverBottom=position.top+myOffset+atOffset+offset+data.collisionHeight-outerHeight-withinOffset)<0||newOverBottom<abs(overTop))&&(position.top+=myOffset+atOffset+offset):overBottom>0&&((newOverTop=position.top-data.collisionPosition.marginTop+myOffset+atOffset+offset-offsetTop)>0||abs(newOverTop)<overBottom)&&(position.top+=myOffset+atOffset+offset)}},flipfit:{left:function(){$.ui.position.flip.left.apply(this,arguments),$.ui.position.fit.left.apply(this,arguments)},top:function(){$.ui.position.flip.top.apply(this,arguments),$.ui.position.fit.top.apply(this,arguments)}}},function(){var testElement,testElementParent,testElementStyle,offsetLeft,i,body=document.getElementsByTagName("body")[0],div=document.createElement("div");testElement=document.createElement(body?"div":"body"),testElementStyle={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},body&&$.extend(testElementStyle,{position:"absolute",left:"-1000px",top:"-1000px"});for(i in testElementStyle)testElement.style[i]=testElementStyle[i];testElement.appendChild(div),testElementParent=body||document.documentElement,testElementParent.insertBefore(testElement,testElementParent.firstChild),div.style.cssText="position: absolute; left: 10.7432222px;",offsetLeft=$(div).offset().left,supportsOffsetFractions=offsetLeft>10&&offsetLeft<11,testElement.innerHTML="",testElementParent.removeChild(testElement)}()}();$.ui.position;$.widget("ui.draggable",$.ui.mouse,{version:"1.11.4",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"===this.options.helper&&this._setPositionRelative(),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._setHandleClassName(),this._mouseInit()},_setOption:function(key,value){this._super(key,value),"handle"===key&&(this._removeHandleClassName(),this._setHandleClassName())},_destroy:function(){if((this.helper||this.element).is(".ui-draggable-dragging"))return void(this.destroyOnClear=!0);this.element.removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._removeHandleClassName(),this._mouseDestroy()},_mouseCapture:function(event){var o=this.options;return this._blurActiveElement(event),!(this.helper||o.disabled||$(event.target).closest(".ui-resizable-handle").length>0)&&(this.handle=this._getHandle(event),!!this.handle&&(this._blockFrames(!0===o.iframeFix?"iframe":o.iframeFix),!0))},_blockFrames:function(selector){this.iframeBlocks=this.document.find(selector).map(function(){var iframe=$(this);return $("<div>").css("position","absolute").appendTo(iframe.parent()).outerWidth(iframe.outerWidth()).outerHeight(iframe.outerHeight()).offset(iframe.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_blurActiveElement:function(event){var document=this.document[0];if(this.handleElement.is(event.target))try{document.activeElement&&"body"!==document.activeElement.nodeName.toLowerCase()&&$(document.activeElement).blur()}catch(error){}},_mouseStart:function(event){var o=this.options;return this.helper=this._createHelper(event),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),$.ui.ddmanager&&($.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(!0),this.offsetParent=this.helper.offsetParent(),this.hasFixedAncestor=this.helper.parents().filter(function(){return"fixed"===$(this).css("position")}).length>0,this.positionAbs=this.element.offset(),this._refreshOffsets(event),this.originalPosition=this.position=this._generatePosition(event,!1),this.originalPageX=event.pageX,this.originalPageY=event.pageY,o.cursorAt&&this._adjustOffsetFromHelper(o.cursorAt),this._setContainment(),!1===this._trigger("start",event)?(this._clear(),!1):(this._cacheHelperProportions(),$.ui.ddmanager&&!o.dropBehaviour&&$.ui.ddmanager.prepareOffsets(this,event),this._normalizeRightBottom(),this._mouseDrag(event,!0),$.ui.ddmanager&&$.ui.ddmanager.dragStart(this,event),!0)},_refreshOffsets:function(event){this.offset={top:this.positionAbs.top-this.margins.top,left:this.positionAbs.left-this.margins.left,scroll:!1,parent:this._getParentOffset(),relative:this._getRelativeOffset()},this.offset.click={left:event.pageX-this.offset.left,top:event.pageY-this.offset.top}},_mouseDrag:function(event,noPropagation){if(this.hasFixedAncestor&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(event,!0),this.positionAbs=this._convertPositionTo("absolute"),!noPropagation){var ui=this._uiHash();if(!1===this._trigger("drag",event,ui))return this._mouseUp({}),!1;this.position=ui.position}return this.helper[0].style.left=this.position.left+"px",this.helper[0].style.top=this.position.top+"px",$.ui.ddmanager&&$.ui.ddmanager.drag(this,event),!1},_mouseStop:function(event){var that=this,dropped=!1;return $.ui.ddmanager&&!this.options.dropBehaviour&&(dropped=$.ui.ddmanager.drop(this,event)),this.dropped&&(dropped=this.dropped,this.dropped=!1),"invalid"===this.options.revert&&!dropped||"valid"===this.options.revert&&dropped||!0===this.options.revert||$.isFunction(this.options.revert)&&this.options.revert.call(this.element,dropped)?$(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){!1!==that._trigger("stop",event)&&that._clear()}):!1!==this._trigger("stop",event)&&this._clear(),!1},
_mouseUp:function(event){return this._unblockFrames(),$.ui.ddmanager&&$.ui.ddmanager.dragStop(this,event),this.handleElement.is(event.target)&&this.element.focus(),$.ui.mouse.prototype._mouseUp.call(this,event)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(event){return!this.options.handle||!!$(event.target).closest(this.element.find(this.options.handle)).length},_setHandleClassName:function(){this.handleElement=this.options.handle?this.element.find(this.options.handle):this.element,this.handleElement.addClass("ui-draggable-handle")},_removeHandleClassName:function(){this.handleElement.removeClass("ui-draggable-handle")},_createHelper:function(event){var o=this.options,helperIsFunction=$.isFunction(o.helper),helper=helperIsFunction?$(o.helper.apply(this.element[0],[event])):"clone"===o.helper?this.element.clone().removeAttr("id"):this.element;return helper.parents("body").length||helper.appendTo("parent"===o.appendTo?this.element[0].parentNode:o.appendTo),helperIsFunction&&helper[0]===this.element[0]&&this._setPositionRelative(),helper[0]===this.element[0]||/(fixed|absolute)/.test(helper.css("position"))||helper.css("position","absolute"),helper},_setPositionRelative:function(){/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative")},_adjustOffsetFromHelper:function(obj){"string"==typeof obj&&(obj=obj.split(" ")),$.isArray(obj)&&(obj={left:+obj[0],top:+obj[1]||0}),"left"in obj&&(this.offset.click.left=obj.left+this.margins.left),"right"in obj&&(this.offset.click.left=this.helperProportions.width-obj.right+this.margins.left),"top"in obj&&(this.offset.click.top=obj.top+this.margins.top),"bottom"in obj&&(this.offset.click.top=this.helperProportions.height-obj.bottom+this.margins.top)},_isRootNode:function(element){return/(html|body)/i.test(element.tagName)||element===this.document[0]},_getParentOffset:function(){var po=this.offsetParent.offset(),document=this.document[0];return"absolute"===this.cssPosition&&this.scrollParent[0]!==document&&$.contains(this.scrollParent[0],this.offsetParent[0])&&(po.left+=this.scrollParent.scrollLeft(),po.top+=this.scrollParent.scrollTop()),this._isRootNode(this.offsetParent[0])&&(po={top:0,left:0}),{top:po.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:po.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"!==this.cssPosition)return{top:0,left:0};var p=this.element.position(),scrollIsRootNode=this._isRootNode(this.scrollParent[0]);return{top:p.top-(parseInt(this.helper.css("top"),10)||0)+(scrollIsRootNode?0:this.scrollParent.scrollTop()),left:p.left-(parseInt(this.helper.css("left"),10)||0)+(scrollIsRootNode?0:this.scrollParent.scrollLeft())}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var isUserScrollable,c,ce,o=this.options,document=this.document[0];return this.relativeContainer=null,o.containment?"window"===o.containment?void(this.containment=[$(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,$(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,$(window).scrollLeft()+$(window).width()-this.helperProportions.width-this.margins.left,$(window).scrollTop()+($(window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):"document"===o.containment?void(this.containment=[0,0,$(document).width()-this.helperProportions.width-this.margins.left,($(document).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):o.containment.constructor===Array?void(this.containment=o.containment):("parent"===o.containment&&(o.containment=this.helper[0].parentNode),c=$(o.containment),void((ce=c[0])&&(isUserScrollable=/(scroll|auto)/.test(c.css("overflow")),this.containment=[(parseInt(c.css("borderLeftWidth"),10)||0)+(parseInt(c.css("paddingLeft"),10)||0),(parseInt(c.css("borderTopWidth"),10)||0)+(parseInt(c.css("paddingTop"),10)||0),(isUserScrollable?Math.max(ce.scrollWidth,ce.offsetWidth):ce.offsetWidth)-(parseInt(c.css("borderRightWidth"),10)||0)-(parseInt(c.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(isUserScrollable?Math.max(ce.scrollHeight,ce.offsetHeight):ce.offsetHeight)-(parseInt(c.css("borderBottomWidth"),10)||0)-(parseInt(c.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relativeContainer=c))):void(this.containment=null)},_convertPositionTo:function(d,pos){pos||(pos=this.position);var mod="absolute"===d?1:-1,scrollIsRootNode=this._isRootNode(this.scrollParent[0]);return{top:pos.top+this.offset.relative.top*mod+this.offset.parent.top*mod-("fixed"===this.cssPosition?-this.offset.scroll.top:scrollIsRootNode?0:this.offset.scroll.top)*mod,left:pos.left+this.offset.relative.left*mod+this.offset.parent.left*mod-("fixed"===this.cssPosition?-this.offset.scroll.left:scrollIsRootNode?0:this.offset.scroll.left)*mod}},_generatePosition:function(event,constrainPosition){var containment,co,top,left,o=this.options,scrollIsRootNode=this._isRootNode(this.scrollParent[0]),pageX=event.pageX,pageY=event.pageY;return scrollIsRootNode&&this.offset.scroll||(this.offset.scroll={top:this.scrollParent.scrollTop(),left:this.scrollParent.scrollLeft()}),constrainPosition&&(this.containment&&(this.relativeContainer?(co=this.relativeContainer.offset(),containment=[this.containment[0]+co.left,this.containment[1]+co.top,this.containment[2]+co.left,this.containment[3]+co.top]):containment=this.containment,event.pageX-this.offset.click.left<containment[0]&&(pageX=containment[0]+this.offset.click.left),event.pageY-this.offset.click.top<containment[1]&&(pageY=containment[1]+this.offset.click.top),event.pageX-this.offset.click.left>containment[2]&&(pageX=containment[2]+this.offset.click.left),event.pageY-this.offset.click.top>containment[3]&&(pageY=containment[3]+this.offset.click.top)),o.grid&&(top=o.grid[1]?this.originalPageY+Math.round((pageY-this.originalPageY)/o.grid[1])*o.grid[1]:this.originalPageY,pageY=containment?top-this.offset.click.top>=containment[1]||top-this.offset.click.top>containment[3]?top:top-this.offset.click.top>=containment[1]?top-o.grid[1]:top+o.grid[1]:top,left=o.grid[0]?this.originalPageX+Math.round((pageX-this.originalPageX)/o.grid[0])*o.grid[0]:this.originalPageX,pageX=containment?left-this.offset.click.left>=containment[0]||left-this.offset.click.left>containment[2]?left:left-this.offset.click.left>=containment[0]?left-o.grid[0]:left+o.grid[0]:left),"y"===o.axis&&(pageX=this.originalPageX),"x"===o.axis&&(pageY=this.originalPageY)),{top:pageY-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.offset.scroll.top:scrollIsRootNode?0:this.offset.scroll.top),left:pageX-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.offset.scroll.left:scrollIsRootNode?0:this.offset.scroll.left)}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]===this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1,this.destroyOnClear&&this.destroy()},_normalizeRightBottom:function(){"y"!==this.options.axis&&"auto"!==this.helper.css("right")&&(this.helper.width(this.helper.width()),this.helper.css("right","auto")),"x"!==this.options.axis&&"auto"!==this.helper.css("bottom")&&(this.helper.height(this.helper.height()),this.helper.css("bottom","auto"))},_trigger:function(type,event,ui){return ui=ui||this._uiHash(),$.ui.plugin.call(this,type,[event,ui,this],!0),/^(drag|start|stop)/.test(type)&&(this.positionAbs=this._convertPositionTo("absolute"),ui.offset=this.positionAbs),$.Widget.prototype._trigger.call(this,type,event,ui)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),$.ui.plugin.add("draggable","connectToSortable",{start:function(event,ui,draggable){var uiSortable=$.extend({},ui,{item:draggable.element});draggable.sortables=[],$(draggable.options.connectToSortable).each(function(){var sortable=$(this).sortable("instance");sortable&&!sortable.options.disabled&&(draggable.sortables.push(sortable),sortable.refreshPositions(),sortable._trigger("activate",event,uiSortable))})},stop:function(event,ui,draggable){var uiSortable=$.extend({},ui,{item:draggable.element});draggable.cancelHelperRemoval=!1,$.each(draggable.sortables,function(){var sortable=this;sortable.isOver?(sortable.isOver=0,draggable.cancelHelperRemoval=!0,sortable.cancelHelperRemoval=!1,sortable._storedCSS={position:sortable.placeholder.css("position"),top:sortable.placeholder.css("top"),left:sortable.placeholder.css("left")},sortable._mouseStop(event),sortable.options.helper=sortable.options._helper):(sortable.cancelHelperRemoval=!0,sortable._trigger("deactivate",event,uiSortable))})},drag:function(event,ui,draggable){$.each(draggable.sortables,function(){var innermostIntersecting=!1,sortable=this;sortable.positionAbs=draggable.positionAbs,sortable.helperProportions=draggable.helperProportions,sortable.offset.click=draggable.offset.click,sortable._intersectsWith(sortable.containerCache)&&(innermostIntersecting=!0,$.each(draggable.sortables,function(){return this.positionAbs=draggable.positionAbs,this.helperProportions=draggable.helperProportions,this.offset.click=draggable.offset.click,this!==sortable&&this._intersectsWith(this.containerCache)&&$.contains(sortable.element[0],this.element[0])&&(innermostIntersecting=!1),innermostIntersecting})),innermostIntersecting?(sortable.isOver||(sortable.isOver=1,draggable._parent=ui.helper.parent(),sortable.currentItem=ui.helper.appendTo(sortable.element).data("ui-sortable-item",!0),sortable.options._helper=sortable.options.helper,sortable.options.helper=function(){return ui.helper[0]},event.target=sortable.currentItem[0],sortable._mouseCapture(event,!0),sortable._mouseStart(event,!0,!0),sortable.offset.click.top=draggable.offset.click.top,sortable.offset.click.left=draggable.offset.click.left,sortable.offset.parent.left-=draggable.offset.parent.left-sortable.offset.parent.left,sortable.offset.parent.top-=draggable.offset.parent.top-sortable.offset.parent.top,draggable._trigger("toSortable",event),draggable.dropped=sortable.element,$.each(draggable.sortables,function(){this.refreshPositions()}),draggable.currentItem=draggable.element,sortable.fromOutside=draggable),sortable.currentItem&&(sortable._mouseDrag(event),ui.position=sortable.position)):sortable.isOver&&(sortable.isOver=0,sortable.cancelHelperRemoval=!0,sortable.options._revert=sortable.options.revert,sortable.options.revert=!1,sortable._trigger("out",event,sortable._uiHash(sortable)),sortable._mouseStop(event,!0),sortable.options.revert=sortable.options._revert,sortable.options.helper=sortable.options._helper,sortable.placeholder&&sortable.placeholder.remove(),ui.helper.appendTo(draggable._parent),draggable._refreshOffsets(event),ui.position=draggable._generatePosition(event,!0),draggable._trigger("fromSortable",event),draggable.dropped=!1,$.each(draggable.sortables,function(){this.refreshPositions()}))})}}),$.ui.plugin.add("draggable","cursor",{start:function(event,ui,instance){var t=$("body"),o=instance.options;t.css("cursor")&&(o._cursor=t.css("cursor")),t.css("cursor",o.cursor)},stop:function(event,ui,instance){var o=instance.options;o._cursor&&$("body").css("cursor",o._cursor)}}),$.ui.plugin.add("draggable","opacity",{start:function(event,ui,instance){var t=$(ui.helper),o=instance.options;t.css("opacity")&&(o._opacity=t.css("opacity")),t.css("opacity",o.opacity)},stop:function(event,ui,instance){var o=instance.options;o._opacity&&$(ui.helper).css("opacity",o._opacity)}}),$.ui.plugin.add("draggable","scroll",{start:function(event,ui,i){i.scrollParentNotHidden||(i.scrollParentNotHidden=i.helper.scrollParent(!1)),i.scrollParentNotHidden[0]!==i.document[0]&&"HTML"!==i.scrollParentNotHidden[0].tagName&&(i.overflowOffset=i.scrollParentNotHidden.offset())},drag:function(event,ui,i){var o=i.options,scrolled=!1,scrollParent=i.scrollParentNotHidden[0],document=i.document[0];scrollParent!==document&&"HTML"!==scrollParent.tagName?(o.axis&&"x"===o.axis||(i.overflowOffset.top+scrollParent.offsetHeight-event.pageY<o.scrollSensitivity?scrollParent.scrollTop=scrolled=scrollParent.scrollTop+o.scrollSpeed:event.pageY-i.overflowOffset.top<o.scrollSensitivity&&(scrollParent.scrollTop=scrolled=scrollParent.scrollTop-o.scrollSpeed)),o.axis&&"y"===o.axis||(i.overflowOffset.left+scrollParent.offsetWidth-event.pageX<o.scrollSensitivity?scrollParent.scrollLeft=scrolled=scrollParent.scrollLeft+o.scrollSpeed:event.pageX-i.overflowOffset.left<o.scrollSensitivity&&(scrollParent.scrollLeft=scrolled=scrollParent.scrollLeft-o.scrollSpeed))):(o.axis&&"x"===o.axis||(event.pageY-$(document).scrollTop()<o.scrollSensitivity?scrolled=$(document).scrollTop($(document).scrollTop()-o.scrollSpeed):$(window).height()-(event.pageY-$(document).scrollTop())<o.scrollSensitivity&&(scrolled=$(document).scrollTop($(document).scrollTop()+o.scrollSpeed))),o.axis&&"y"===o.axis||(event.pageX-$(document).scrollLeft()<o.scrollSensitivity?scrolled=$(document).scrollLeft($(document).scrollLeft()-o.scrollSpeed):$(window).width()-(event.pageX-$(document).scrollLeft())<o.scrollSensitivity&&(scrolled=$(document).scrollLeft($(document).scrollLeft()+o.scrollSpeed)))),!1!==scrolled&&$.ui.ddmanager&&!o.dropBehaviour&&$.ui.ddmanager.prepareOffsets(i,event)}}),$.ui.plugin.add("draggable","snap",{start:function(event,ui,i){var o=i.options;i.snapElements=[],$(o.snap.constructor!==String?o.snap.items||":data(ui-draggable)":o.snap).each(function(){var $t=$(this),$o=$t.offset();this!==i.element[0]&&i.snapElements.push({item:this,width:$t.outerWidth(),height:$t.outerHeight(),top:$o.top,left:$o.left})})},drag:function(event,ui,inst){var ts,bs,ls,rs,l,r,t,b,i,first,o=inst.options,d=o.snapTolerance,x1=ui.offset.left,x2=x1+inst.helperProportions.width,y1=ui.offset.top,y2=y1+inst.helperProportions.height;for(i=inst.snapElements.length-1;i>=0;i--)l=inst.snapElements[i].left-inst.margins.left,r=l+inst.snapElements[i].width,t=inst.snapElements[i].top-inst.margins.top,b=t+inst.snapElements[i].height,x2<l-d||x1>r+d||y2<t-d||y1>b+d||!$.contains(inst.snapElements[i].item.ownerDocument,inst.snapElements[i].item)?(inst.snapElements[i].snapping&&inst.options.snap.release&&inst.options.snap.release.call(inst.element,event,$.extend(inst._uiHash(),{snapItem:inst.snapElements[i].item})),inst.snapElements[i].snapping=!1):("inner"!==o.snapMode&&(ts=Math.abs(t-y2)<=d,bs=Math.abs(b-y1)<=d,ls=Math.abs(l-x2)<=d,rs=Math.abs(r-x1)<=d,ts&&(ui.position.top=inst._convertPositionTo("relative",{top:t-inst.helperProportions.height,left:0}).top),bs&&(ui.position.top=inst._convertPositionTo("relative",{top:b,left:0}).top),ls&&(ui.position.left=inst._convertPositionTo("relative",{top:0,left:l-inst.helperProportions.width}).left),rs&&(ui.position.left=inst._convertPositionTo("relative",{top:0,left:r}).left)),first=ts||bs||ls||rs,"outer"!==o.snapMode&&(ts=Math.abs(t-y1)<=d,bs=Math.abs(b-y2)<=d,ls=Math.abs(l-x1)<=d,rs=Math.abs(r-x2)<=d,ts&&(ui.position.top=inst._convertPositionTo("relative",{top:t,left:0}).top),bs&&(ui.position.top=inst._convertPositionTo("relative",{top:b-inst.helperProportions.height,left:0}).top),ls&&(ui.position.left=inst._convertPositionTo("relative",{top:0,left:l}).left),rs&&(ui.position.left=inst._convertPositionTo("relative",{top:0,left:r-inst.helperProportions.width}).left)),!inst.snapElements[i].snapping&&(ts||bs||ls||rs||first)&&inst.options.snap.snap&&inst.options.snap.snap.call(inst.element,event,$.extend(inst._uiHash(),{snapItem:inst.snapElements[i].item})),inst.snapElements[i].snapping=ts||bs||ls||rs||first)}}),$.ui.plugin.add("draggable","stack",{start:function(event,ui,instance){var min,o=instance.options,group=$.makeArray($(o.stack)).sort(function(a,b){return(parseInt($(a).css("zIndex"),10)||0)-(parseInt($(b).css("zIndex"),10)||0)});group.length&&(min=parseInt($(group[0]).css("zIndex"),10)||0,$(group).each(function(i){$(this).css("zIndex",min+i)}),this.css("zIndex",min+group.length))}}),$.ui.plugin.add("draggable","zIndex",{start:function(event,ui,instance){var t=$(ui.helper),o=instance.options;t.css("zIndex")&&(o._zIndex=t.css("zIndex")),t.css("zIndex",o.zIndex)},stop:function(event,ui,instance){var o=instance.options;o._zIndex&&$(ui.helper).css("zIndex",o._zIndex)}});$.ui.draggable;$.widget("ui.droppable",{version:"1.11.4",widgetEventPrefix:"drop",options:{accept:"*",activeClass:!1,addClasses:!0,greedy:!1,hoverClass:!1,scope:"default",tolerance:"intersect",activate:null,deactivate:null,drop:null,out:null,over:null},_create:function(){var proportions,o=this.options,accept=o.accept;this.isover=!1,this.isout=!0,this.accept=$.isFunction(accept)?accept:function(d){return d.is(accept)},this.proportions=function(){if(!arguments.length)return proportions||(proportions={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight});proportions=arguments[0]},this._addToManager(o.scope),o.addClasses&&this.element.addClass("ui-droppable")},_addToManager:function(scope){$.ui.ddmanager.droppables[scope]=$.ui.ddmanager.droppables[scope]||[],$.ui.ddmanager.droppables[scope].push(this)},_splice:function(drop){for(var i=0;i<drop.length;i++)drop[i]===this&&drop.splice(i,1)},_destroy:function(){var drop=$.ui.ddmanager.droppables[this.options.scope];this._splice(drop),this.element.removeClass("ui-droppable ui-droppable-disabled")},_setOption:function(key,value){if("accept"===key)this.accept=$.isFunction(value)?value:function(d){return d.is(value)};else if("scope"===key){var drop=$.ui.ddmanager.droppables[this.options.scope];this._splice(drop),this._addToManager(value)}this._super(key,value)},_activate:function(event){var draggable=$.ui.ddmanager.current;this.options.activeClass&&this.element.addClass(this.options.activeClass),draggable&&this._trigger("activate",event,this.ui(draggable))},_deactivate:function(event){var draggable=$.ui.ddmanager.current;this.options.activeClass&&this.element.removeClass(this.options.activeClass),draggable&&this._trigger("deactivate",event,this.ui(draggable))},_over:function(event){var draggable=$.ui.ddmanager.current;draggable&&(draggable.currentItem||draggable.element)[0]!==this.element[0]&&this.accept.call(this.element[0],draggable.currentItem||draggable.element)&&(this.options.hoverClass&&this.element.addClass(this.options.hoverClass),this._trigger("over",event,this.ui(draggable)))},_out:function(event){var draggable=$.ui.ddmanager.current;draggable&&(draggable.currentItem||draggable.element)[0]!==this.element[0]&&this.accept.call(this.element[0],draggable.currentItem||draggable.element)&&(this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("out",event,this.ui(draggable)))},_drop:function(event,custom){var draggable=custom||$.ui.ddmanager.current,childrenIntersection=!1;return!(!draggable||(draggable.currentItem||draggable.element)[0]===this.element[0])&&(this.element.find(":data(ui-droppable)").not(".ui-draggable-dragging").each(function(){var inst=$(this).droppable("instance");if(inst.options.greedy&&!inst.options.disabled&&inst.options.scope===draggable.options.scope&&inst.accept.call(inst.element[0],draggable.currentItem||draggable.element)&&$.ui.intersect(draggable,$.extend(inst,{offset:inst.element.offset()}),inst.options.tolerance,event))return childrenIntersection=!0,!1}),!childrenIntersection&&(!!this.accept.call(this.element[0],draggable.currentItem||draggable.element)&&(this.options.activeClass&&this.element.removeClass(this.options.activeClass),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("drop",event,this.ui(draggable)),this.element)))},ui:function(c){return{draggable:c.currentItem||c.element,helper:c.helper,position:c.position,offset:c.positionAbs}}}),$.ui.intersect=function(){function isOverAxis(x,reference,size){return x>=reference&&x<reference+size}return function(draggable,droppable,toleranceMode,event){if(!droppable.offset)return!1;var x1=(draggable.positionAbs||draggable.position.absolute).left+draggable.margins.left,y1=(draggable.positionAbs||draggable.position.absolute).top+draggable.margins.top,x2=x1+draggable.helperProportions.width,y2=y1+draggable.helperProportions.height,l=droppable.offset.left,t=droppable.offset.top,r=l+droppable.proportions().width,b=t+droppable.proportions().height;switch(toleranceMode){case"fit":return l<=x1&&x2<=r&&t<=y1&&y2<=b;case"intersect":return l<x1+draggable.helperProportions.width/2&&x2-draggable.helperProportions.width/2<r&&t<y1+draggable.helperProportions.height/2&&y2-draggable.helperProportions.height/2<b;case"pointer":return isOverAxis(event.pageY,t,droppable.proportions().height)&&isOverAxis(event.pageX,l,droppable.proportions().width);case"touch":return(y1>=t&&y1<=b||y2>=t&&y2<=b||y1<t&&y2>b)&&(x1>=l&&x1<=r||x2>=l&&x2<=r||x1<l&&x2>r);default:return!1}}}(),$.ui.ddmanager={current:null,droppables:{default:[]},prepareOffsets:function(t,event){var i,j,m=$.ui.ddmanager.droppables[t.options.scope]||[],type=event?event.type:null,list=(t.currentItem||t.element).find(":data(ui-droppable)").addBack();droppablesLoop:for(i=0;i<m.length;i++)if(!(m[i].options.disabled||t&&!m[i].accept.call(m[i].element[0],t.currentItem||t.element))){for(j=0;j<list.length;j++)if(list[j]===m[i].element[0]){m[i].proportions().height=0;continue droppablesLoop}m[i].visible="none"!==m[i].element.css("display"),m[i].visible&&("mousedown"===type&&m[i]._activate.call(m[i],event),m[i].offset=m[i].element.offset(),m[i].proportions({width:m[i].element[0].offsetWidth,height:m[i].element[0].offsetHeight}))}},drop:function(draggable,event){var dropped=!1;return $.each(($.ui.ddmanager.droppables[draggable.options.scope]||[]).slice(),function(){this.options&&(!this.options.disabled&&this.visible&&$.ui.intersect(draggable,this,this.options.tolerance,event)&&(dropped=this._drop.call(this,event)||dropped),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],draggable.currentItem||draggable.element)&&(this.isout=!0,this.isover=!1,this._deactivate.call(this,event)))}),dropped},dragStart:function(draggable,event){draggable.element.parentsUntil("body").bind("scroll.droppable",function(){draggable.options.refreshPositions||$.ui.ddmanager.prepareOffsets(draggable,event)})},drag:function(draggable,event){draggable.options.refreshPositions&&$.ui.ddmanager.prepareOffsets(draggable,event),$.each($.ui.ddmanager.droppables[draggable.options.scope]||[],function(){if(!this.options.disabled&&!this.greedyChild&&this.visible){var parentInstance,scope,parent,intersects=$.ui.intersect(draggable,this,this.options.tolerance,event),c=!intersects&&this.isover?"isout":intersects&&!this.isover?"isover":null;c&&(this.options.greedy&&(scope=this.options.scope,parent=this.element.parents(":data(ui-droppable)").filter(function(){return $(this).droppable("instance").options.scope===scope}),parent.length&&(parentInstance=$(parent[0]).droppable("instance"),parentInstance.greedyChild="isover"===c)),parentInstance&&"isover"===c&&(parentInstance.isover=!1,parentInstance.isout=!0,parentInstance._out.call(parentInstance,event)),this[c]=!0,this["isout"===c?"isover":"isout"]=!1,this["isover"===c?"_over":"_out"].call(this,event),parentInstance&&"isout"===c&&(parentInstance.isout=!1,parentInstance.isover=!0,parentInstance._over.call(parentInstance,event)))}})},dragStop:function(draggable,event){draggable.element.parentsUntil("body").unbind("scroll.droppable"),draggable.options.refreshPositions||$.ui.ddmanager.prepareOffsets(draggable,event)}};$.ui.droppable;$.widget("ui.resizable",$.ui.mouse,{version:"1.11.4",widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:90,resize:null,start:null,stop:null},_num:function(value){return parseInt(value,10)||0},_isNumber:function(value){return!isNaN(parseInt(value,10))},_hasScroll:function(el,a){if("hidden"===$(el).css("overflow"))return!1;var scroll=a&&"left"===a?"scrollLeft":"scrollTop",has=!1;return el[scroll]>0||(el[scroll]=1,has=el[scroll]>0,el[scroll]=0,has)},_create:function(){var n,i,handle,axis,hname,that=this,o=this.options;if(this.element.addClass("ui-resizable"),$.extend(this,{_aspectRatio:!!o.aspectRatio,aspectRatio:o.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:o.helper||o.ghost||o.animate?o.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/^(canvas|textarea|input|select|button|img)$/i)&&(this.element.wrap($("<div class='ui-wrapper' style='overflow: hidden;'></div>").css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("ui-resizable",this.element.resizable("instance")),this.elementIsWrapper=!0,this.element.css({marginLeft:this.originalElement.css("marginLeft"),marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom")}),this.originalElement.css({marginLeft:0,marginTop:0,marginRight:0,marginBottom:0}),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css({margin:this.originalElement.css("margin")}),this._proportionallyResize()),this.handles=o.handles||($(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se"),this._handles=$(),this.handles.constructor===String)for("all"===this.handles&&(this.handles="n,e,s,w,se,sw,ne,nw"),n=this.handles.split(","),this.handles={},i=0;i<n.length;i++)handle=$.trim(n[i]),hname="ui-resizable-"+handle,axis=$("<div class='ui-resizable-handle "+hname+"'></div>"),axis.css({zIndex:o.zIndex}),"se"===handle&&axis.addClass("ui-icon ui-icon-gripsmall-diagonal-se"),this.handles[handle]=".ui-resizable-"+handle,this.element.append(axis);this._renderAxis=function(target){var i,axis,padPos,padWrapper;target=target||this.element;for(i in this.handles)this.handles[i].constructor===String?this.handles[i]=this.element.children(this.handles[i]).first().show():(this.handles[i].jquery||this.handles[i].nodeType)&&(this.handles[i]=$(this.handles[i]),this._on(this.handles[i],{mousedown:that._mouseDown})),this.elementIsWrapper&&this.originalElement[0].nodeName.match(/^(textarea|input|select|button)$/i)&&(axis=$(this.handles[i],this.element),padWrapper=/sw|ne|nw|se|n|s/.test(i)?axis.outerHeight():axis.outerWidth(),padPos=["padding",/ne|nw|n/.test(i)?"Top":/se|sw|s/.test(i)?"Bottom":/^e$/.test(i)?"Right":"Left"].join(""),target.css(padPos,padWrapper),this._proportionallyResize()),this._handles=this._handles.add(this.handles[i])},this._renderAxis(this.element),this._handles=this._handles.add(this.element.find(".ui-resizable-handle")),this._handles.disableSelection(),this._handles.mouseover(function(){that.resizing||(this.className&&(axis=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i)),that.axis=axis&&axis[1]?axis[1]:"se")}),o.autoHide&&(this._handles.hide(),$(this.element).addClass("ui-resizable-autohide").mouseenter(function(){o.disabled||($(this).removeClass("ui-resizable-autohide"),that._handles.show())}).mouseleave(function(){o.disabled||that.resizing||($(this).addClass("ui-resizable-autohide"),that._handles.hide())})),this._mouseInit()},_destroy:function(){this._mouseDestroy();var wrapper,_destroy=function(exp){$(exp).removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing").removeData("resizable").removeData("ui-resizable").unbind(".resizable").find(".ui-resizable-handle").remove()};return this.elementIsWrapper&&(_destroy(this.element),wrapper=this.element,this.originalElement.css({position:wrapper.css("position"),width:wrapper.outerWidth(),height:wrapper.outerHeight(),top:wrapper.css("top"),left:wrapper.css("left")}).insertAfter(wrapper),wrapper.remove()),this.originalElement.css("resize",this.originalResizeStyle),_destroy(this.originalElement),this},_mouseCapture:function(event){var i,handle,capture=!1;for(i in this.handles)((handle=$(this.handles[i])[0])===event.target||$.contains(handle,event.target))&&(capture=!0);return!this.options.disabled&&capture},_mouseStart:function(event){var curleft,curtop,cursor,o=this.options,el=this.element;return this.resizing=!0,this._renderProxy(),curleft=this._num(this.helper.css("left")),curtop=this._num(this.helper.css("top")),o.containment&&(curleft+=$(o.containment).scrollLeft()||0,curtop+=$(o.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:curleft,top:curtop},this.size=this._helper?{width:this.helper.width(),height:this.helper.height()}:{width:el.width(),height:el.height()},this.originalSize=this._helper?{width:el.outerWidth(),height:el.outerHeight()}:{width:el.width(),height:el.height()},this.sizeDiff={width:el.outerWidth()-el.width(),height:el.outerHeight()-el.height()},this.originalPosition={left:curleft,top:curtop},this.originalMousePosition={left:event.pageX,top:event.pageY},this.aspectRatio="number"==typeof o.aspectRatio?o.aspectRatio:this.originalSize.width/this.originalSize.height||1,cursor=$(".ui-resizable-"+this.axis).css("cursor"),$("body").css("cursor","auto"===cursor?this.axis+"-resize":cursor),el.addClass("ui-resizable-resizing"),this._propagate("start",event),!0},_mouseDrag:function(event){var data,props,smp=this.originalMousePosition,a=this.axis,dx=event.pageX-smp.left||0,dy=event.pageY-smp.top||0,trigger=this._change[a];return this._updatePrevProperties(),!!trigger&&(data=trigger.apply(this,[event,dx,dy]),this._updateVirtualBoundaries(event.shiftKey),(this._aspectRatio||event.shiftKey)&&(data=this._updateRatio(data,event)),data=this._respectSize(data,event),this._updateCache(data),this._propagate("resize",event),props=this._applyChanges(),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),$.isEmptyObject(props)||(this._updatePrevProperties(),this._trigger("resize",event,this.ui()),this._applyChanges()),!1)},_mouseStop:function(event){this.resizing=!1;var pr,ista,soffseth,soffsetw,s,left,top,o=this.options,that=this;return this._helper&&(pr=this._proportionallyResizeElements,ista=pr.length&&/textarea/i.test(pr[0].nodeName),soffseth=ista&&this._hasScroll(pr[0],"left")?0:that.sizeDiff.height,soffsetw=ista?0:that.sizeDiff.width,s={width:that.helper.width()-soffsetw,height:that.helper.height()-soffseth},left=parseInt(that.element.css("left"),10)+(that.position.left-that.originalPosition.left)||null,top=parseInt(that.element.css("top"),10)+(that.position.top-that.originalPosition.top)||null,o.animate||this.element.css($.extend(s,{top:top,left:left})),that.helper.height(that.size.height),that.helper.width(that.size.width),this._helper&&!o.animate&&this._proportionallyResize()),$("body").css("cursor","auto"),this.element.removeClass("ui-resizable-resizing"),this._propagate("stop",event),this._helper&&this.helper.remove(),!1},_updatePrevProperties:function(){this.prevPosition={top:this.position.top,left:this.position.left},
this.prevSize={width:this.size.width,height:this.size.height}},_applyChanges:function(){var props={};return this.position.top!==this.prevPosition.top&&(props.top=this.position.top+"px"),this.position.left!==this.prevPosition.left&&(props.left=this.position.left+"px"),this.size.width!==this.prevSize.width&&(props.width=this.size.width+"px"),this.size.height!==this.prevSize.height&&(props.height=this.size.height+"px"),this.helper.css(props),props},_updateVirtualBoundaries:function(forceAspectRatio){var pMinWidth,pMaxWidth,pMinHeight,pMaxHeight,b,o=this.options;b={minWidth:this._isNumber(o.minWidth)?o.minWidth:0,maxWidth:this._isNumber(o.maxWidth)?o.maxWidth:1/0,minHeight:this._isNumber(o.minHeight)?o.minHeight:0,maxHeight:this._isNumber(o.maxHeight)?o.maxHeight:1/0},(this._aspectRatio||forceAspectRatio)&&(pMinWidth=b.minHeight*this.aspectRatio,pMinHeight=b.minWidth/this.aspectRatio,pMaxWidth=b.maxHeight*this.aspectRatio,pMaxHeight=b.maxWidth/this.aspectRatio,pMinWidth>b.minWidth&&(b.minWidth=pMinWidth),pMinHeight>b.minHeight&&(b.minHeight=pMinHeight),pMaxWidth<b.maxWidth&&(b.maxWidth=pMaxWidth),pMaxHeight<b.maxHeight&&(b.maxHeight=pMaxHeight)),this._vBoundaries=b},_updateCache:function(data){this.offset=this.helper.offset(),this._isNumber(data.left)&&(this.position.left=data.left),this._isNumber(data.top)&&(this.position.top=data.top),this._isNumber(data.height)&&(this.size.height=data.height),this._isNumber(data.width)&&(this.size.width=data.width)},_updateRatio:function(data){var cpos=this.position,csize=this.size,a=this.axis;return this._isNumber(data.height)?data.width=data.height*this.aspectRatio:this._isNumber(data.width)&&(data.height=data.width/this.aspectRatio),"sw"===a&&(data.left=cpos.left+(csize.width-data.width),data.top=null),"nw"===a&&(data.top=cpos.top+(csize.height-data.height),data.left=cpos.left+(csize.width-data.width)),data},_respectSize:function(data){var o=this._vBoundaries,a=this.axis,ismaxw=this._isNumber(data.width)&&o.maxWidth&&o.maxWidth<data.width,ismaxh=this._isNumber(data.height)&&o.maxHeight&&o.maxHeight<data.height,isminw=this._isNumber(data.width)&&o.minWidth&&o.minWidth>data.width,isminh=this._isNumber(data.height)&&o.minHeight&&o.minHeight>data.height,dw=this.originalPosition.left+this.originalSize.width,dh=this.position.top+this.size.height,cw=/sw|nw|w/.test(a),ch=/nw|ne|n/.test(a);return isminw&&(data.width=o.minWidth),isminh&&(data.height=o.minHeight),ismaxw&&(data.width=o.maxWidth),ismaxh&&(data.height=o.maxHeight),isminw&&cw&&(data.left=dw-o.minWidth),ismaxw&&cw&&(data.left=dw-o.maxWidth),isminh&&ch&&(data.top=dh-o.minHeight),ismaxh&&ch&&(data.top=dh-o.maxHeight),data.width||data.height||data.left||!data.top?data.width||data.height||data.top||!data.left||(data.left=null):data.top=null,data},_getPaddingPlusBorderDimensions:function(element){for(var i=0,widths=[],borders=[element.css("borderTopWidth"),element.css("borderRightWidth"),element.css("borderBottomWidth"),element.css("borderLeftWidth")],paddings=[element.css("paddingTop"),element.css("paddingRight"),element.css("paddingBottom"),element.css("paddingLeft")];i<4;i++)widths[i]=parseInt(borders[i],10)||0,widths[i]+=parseInt(paddings[i],10)||0;return{height:widths[0]+widths[2],width:widths[1]+widths[3]}},_proportionallyResize:function(){if(this._proportionallyResizeElements.length)for(var prel,i=0,element=this.helper||this.element;i<this._proportionallyResizeElements.length;i++)prel=this._proportionallyResizeElements[i],this.outerDimensions||(this.outerDimensions=this._getPaddingPlusBorderDimensions(prel)),prel.css({height:element.height()-this.outerDimensions.height||0,width:element.width()-this.outerDimensions.width||0})},_renderProxy:function(){var el=this.element,o=this.options;this.elementOffset=el.offset(),this._helper?(this.helper=this.helper||$("<div style='overflow:hidden;'></div>"),this.helper.addClass(this._helper).css({width:this.element.outerWidth()-1,height:this.element.outerHeight()-1,position:"absolute",left:this.elementOffset.left+"px",top:this.elementOffset.top+"px",zIndex:++o.zIndex}),this.helper.appendTo("body").disableSelection()):this.helper=this.element},_change:{e:function(event,dx){return{width:this.originalSize.width+dx}},w:function(event,dx){var cs=this.originalSize;return{left:this.originalPosition.left+dx,width:cs.width-dx}},n:function(event,dx,dy){var cs=this.originalSize;return{top:this.originalPosition.top+dy,height:cs.height-dy}},s:function(event,dx,dy){return{height:this.originalSize.height+dy}},se:function(event,dx,dy){return $.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[event,dx,dy]))},sw:function(event,dx,dy){return $.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[event,dx,dy]))},ne:function(event,dx,dy){return $.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[event,dx,dy]))},nw:function(event,dx,dy){return $.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[event,dx,dy]))}},_propagate:function(n,event){$.ui.plugin.call(this,n,[event,this.ui()]),"resize"!==n&&this._trigger(n,event,this.ui())},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}),$.ui.plugin.add("resizable","animate",{stop:function(event){var that=$(this).resizable("instance"),o=that.options,pr=that._proportionallyResizeElements,ista=pr.length&&/textarea/i.test(pr[0].nodeName),soffseth=ista&&that._hasScroll(pr[0],"left")?0:that.sizeDiff.height,soffsetw=ista?0:that.sizeDiff.width,style={width:that.size.width-soffsetw,height:that.size.height-soffseth},left=parseInt(that.element.css("left"),10)+(that.position.left-that.originalPosition.left)||null,top=parseInt(that.element.css("top"),10)+(that.position.top-that.originalPosition.top)||null;that.element.animate($.extend(style,top&&left?{top:top,left:left}:{}),{duration:o.animateDuration,easing:o.animateEasing,step:function(){var data={width:parseInt(that.element.css("width"),10),height:parseInt(that.element.css("height"),10),top:parseInt(that.element.css("top"),10),left:parseInt(that.element.css("left"),10)};pr&&pr.length&&$(pr[0]).css({width:data.width,height:data.height}),that._updateCache(data),that._propagate("resize",event)}})}}),$.ui.plugin.add("resizable","containment",{start:function(){var element,p,co,ch,cw,width,height,that=$(this).resizable("instance"),o=that.options,el=that.element,oc=o.containment,ce=oc instanceof $?oc.get(0):/parent/.test(oc)?el.parent().get(0):oc;ce&&(that.containerElement=$(ce),/document/.test(oc)||oc===document?(that.containerOffset={left:0,top:0},that.containerPosition={left:0,top:0},that.parentData={element:$(document),left:0,top:0,width:$(document).width(),height:$(document).height()||document.body.parentNode.scrollHeight}):(element=$(ce),p=[],$(["Top","Right","Left","Bottom"]).each(function(i,name){p[i]=that._num(element.css("padding"+name))}),that.containerOffset=element.offset(),that.containerPosition=element.position(),that.containerSize={height:element.innerHeight()-p[3],width:element.innerWidth()-p[1]},co=that.containerOffset,ch=that.containerSize.height,cw=that.containerSize.width,width=that._hasScroll(ce,"left")?ce.scrollWidth:cw,height=that._hasScroll(ce)?ce.scrollHeight:ch,that.parentData={element:ce,left:co.left,top:co.top,width:width,height:height}))},resize:function(event){var woset,hoset,isParent,isOffsetRelative,that=$(this).resizable("instance"),o=that.options,co=that.containerOffset,cp=that.position,pRatio=that._aspectRatio||event.shiftKey,cop={top:0,left:0},ce=that.containerElement,continueResize=!0;ce[0]!==document&&/static/.test(ce.css("position"))&&(cop=co),cp.left<(that._helper?co.left:0)&&(that.size.width=that.size.width+(that._helper?that.position.left-co.left:that.position.left-cop.left),pRatio&&(that.size.height=that.size.width/that.aspectRatio,continueResize=!1),that.position.left=o.helper?co.left:0),cp.top<(that._helper?co.top:0)&&(that.size.height=that.size.height+(that._helper?that.position.top-co.top:that.position.top),pRatio&&(that.size.width=that.size.height*that.aspectRatio,continueResize=!1),that.position.top=that._helper?co.top:0),isParent=that.containerElement.get(0)===that.element.parent().get(0),isOffsetRelative=/relative|absolute/.test(that.containerElement.css("position")),isParent&&isOffsetRelative?(that.offset.left=that.parentData.left+that.position.left,that.offset.top=that.parentData.top+that.position.top):(that.offset.left=that.element.offset().left,that.offset.top=that.element.offset().top),woset=Math.abs(that.sizeDiff.width+(that._helper?that.offset.left-cop.left:that.offset.left-co.left)),hoset=Math.abs(that.sizeDiff.height+(that._helper?that.offset.top-cop.top:that.offset.top-co.top)),woset+that.size.width>=that.parentData.width&&(that.size.width=that.parentData.width-woset,pRatio&&(that.size.height=that.size.width/that.aspectRatio,continueResize=!1)),hoset+that.size.height>=that.parentData.height&&(that.size.height=that.parentData.height-hoset,pRatio&&(that.size.width=that.size.height*that.aspectRatio,continueResize=!1)),continueResize||(that.position.left=that.prevPosition.left,that.position.top=that.prevPosition.top,that.size.width=that.prevSize.width,that.size.height=that.prevSize.height)},stop:function(){var that=$(this).resizable("instance"),o=that.options,co=that.containerOffset,cop=that.containerPosition,ce=that.containerElement,helper=$(that.helper),ho=helper.offset(),w=helper.outerWidth()-that.sizeDiff.width,h=helper.outerHeight()-that.sizeDiff.height;that._helper&&!o.animate&&/relative/.test(ce.css("position"))&&$(this).css({left:ho.left-cop.left-co.left,width:w,height:h}),that._helper&&!o.animate&&/static/.test(ce.css("position"))&&$(this).css({left:ho.left-cop.left-co.left,width:w,height:h})}}),$.ui.plugin.add("resizable","alsoResize",{start:function(){var that=$(this).resizable("instance"),o=that.options;$(o.alsoResize).each(function(){var el=$(this);el.data("ui-resizable-alsoresize",{width:parseInt(el.width(),10),height:parseInt(el.height(),10),left:parseInt(el.css("left"),10),top:parseInt(el.css("top"),10)})})},resize:function(event,ui){var that=$(this).resizable("instance"),o=that.options,os=that.originalSize,op=that.originalPosition,delta={height:that.size.height-os.height||0,width:that.size.width-os.width||0,top:that.position.top-op.top||0,left:that.position.left-op.left||0};$(o.alsoResize).each(function(){var el=$(this),start=$(this).data("ui-resizable-alsoresize"),style={},css=el.parents(ui.originalElement[0]).length?["width","height"]:["width","height","top","left"];$.each(css,function(i,prop){var sum=(start[prop]||0)+(delta[prop]||0);sum&&sum>=0&&(style[prop]=sum||null)}),el.css(style)})},stop:function(){$(this).removeData("resizable-alsoresize")}}),$.ui.plugin.add("resizable","ghost",{start:function(){var that=$(this).resizable("instance"),o=that.options,cs=that.size;that.ghost=that.originalElement.clone(),that.ghost.css({opacity:.25,display:"block",position:"relative",height:cs.height,width:cs.width,margin:0,left:0,top:0}).addClass("ui-resizable-ghost").addClass("string"==typeof o.ghost?o.ghost:""),that.ghost.appendTo(that.helper)},resize:function(){var that=$(this).resizable("instance");that.ghost&&that.ghost.css({position:"relative",height:that.size.height,width:that.size.width})},stop:function(){var that=$(this).resizable("instance");that.ghost&&that.helper&&that.helper.get(0).removeChild(that.ghost.get(0))}}),$.ui.plugin.add("resizable","grid",{resize:function(){var outerDimensions,that=$(this).resizable("instance"),o=that.options,cs=that.size,os=that.originalSize,op=that.originalPosition,a=that.axis,grid="number"==typeof o.grid?[o.grid,o.grid]:o.grid,gridX=grid[0]||1,gridY=grid[1]||1,ox=Math.round((cs.width-os.width)/gridX)*gridX,oy=Math.round((cs.height-os.height)/gridY)*gridY,newWidth=os.width+ox,newHeight=os.height+oy,isMaxWidth=o.maxWidth&&o.maxWidth<newWidth,isMaxHeight=o.maxHeight&&o.maxHeight<newHeight,isMinWidth=o.minWidth&&o.minWidth>newWidth,isMinHeight=o.minHeight&&o.minHeight>newHeight;o.grid=grid,isMinWidth&&(newWidth+=gridX),isMinHeight&&(newHeight+=gridY),isMaxWidth&&(newWidth-=gridX),isMaxHeight&&(newHeight-=gridY),/^(se|s|e)$/.test(a)?(that.size.width=newWidth,that.size.height=newHeight):/^(ne)$/.test(a)?(that.size.width=newWidth,that.size.height=newHeight,that.position.top=op.top-oy):/^(sw)$/.test(a)?(that.size.width=newWidth,that.size.height=newHeight,that.position.left=op.left-ox):((newHeight-gridY<=0||newWidth-gridX<=0)&&(outerDimensions=that._getPaddingPlusBorderDimensions(this)),newHeight-gridY>0?(that.size.height=newHeight,that.position.top=op.top-oy):(newHeight=gridY-outerDimensions.height,that.size.height=newHeight,that.position.top=op.top+os.height-newHeight),newWidth-gridX>0?(that.size.width=newWidth,that.position.left=op.left-ox):(newWidth=gridX-outerDimensions.width,that.size.width=newWidth,that.position.left=op.left+os.width-newWidth))}});$.ui.resizable,$.widget("ui.selectable",$.ui.mouse,{version:"1.11.4",options:{appendTo:"body",autoRefresh:!0,distance:0,filter:"*",tolerance:"touch",selected:null,selecting:null,start:null,stop:null,unselected:null,unselecting:null},_create:function(){var selectees,that=this;this.element.addClass("ui-selectable"),this.dragged=!1,this.refresh=function(){selectees=$(that.options.filter,that.element[0]),selectees.addClass("ui-selectee"),selectees.each(function(){var $this=$(this),pos=$this.offset();$.data(this,"selectable-item",{element:this,$element:$this,left:pos.left,top:pos.top,right:pos.left+$this.outerWidth(),bottom:pos.top+$this.outerHeight(),startselected:!1,selected:$this.hasClass("ui-selected"),selecting:$this.hasClass("ui-selecting"),unselecting:$this.hasClass("ui-unselecting")})})},this.refresh(),this.selectees=selectees.addClass("ui-selectee"),this._mouseInit(),this.helper=$("<div class='ui-selectable-helper'></div>")},_destroy:function(){this.selectees.removeClass("ui-selectee").removeData("selectable-item"),this.element.removeClass("ui-selectable ui-selectable-disabled"),this._mouseDestroy()},_mouseStart:function(event){var that=this,options=this.options;this.opos=[event.pageX,event.pageY],this.options.disabled||(this.selectees=$(options.filter,this.element[0]),this._trigger("start",event),$(options.appendTo).append(this.helper),this.helper.css({left:event.pageX,top:event.pageY,width:0,height:0}),options.autoRefresh&&this.refresh(),this.selectees.filter(".ui-selected").each(function(){var selectee=$.data(this,"selectable-item");selectee.startselected=!0,event.metaKey||event.ctrlKey||(selectee.$element.removeClass("ui-selected"),selectee.selected=!1,selectee.$element.addClass("ui-unselecting"),selectee.unselecting=!0,that._trigger("unselecting",event,{unselecting:selectee.element}))}),$(event.target).parents().addBack().each(function(){var doSelect,selectee=$.data(this,"selectable-item");if(selectee)return doSelect=!event.metaKey&&!event.ctrlKey||!selectee.$element.hasClass("ui-selected"),selectee.$element.removeClass(doSelect?"ui-unselecting":"ui-selected").addClass(doSelect?"ui-selecting":"ui-unselecting"),selectee.unselecting=!doSelect,selectee.selecting=doSelect,selectee.selected=doSelect,doSelect?that._trigger("selecting",event,{selecting:selectee.element}):that._trigger("unselecting",event,{unselecting:selectee.element}),!1}))},_mouseDrag:function(event){if(this.dragged=!0,!this.options.disabled){var tmp,that=this,options=this.options,x1=this.opos[0],y1=this.opos[1],x2=event.pageX,y2=event.pageY;return x1>x2&&(tmp=x2,x2=x1,x1=tmp),y1>y2&&(tmp=y2,y2=y1,y1=tmp),this.helper.css({left:x1,top:y1,width:x2-x1,height:y2-y1}),this.selectees.each(function(){var selectee=$.data(this,"selectable-item"),hit=!1;selectee&&selectee.element!==that.element[0]&&("touch"===options.tolerance?hit=!(selectee.left>x2||selectee.right<x1||selectee.top>y2||selectee.bottom<y1):"fit"===options.tolerance&&(hit=selectee.left>x1&&selectee.right<x2&&selectee.top>y1&&selectee.bottom<y2),hit?(selectee.selected&&(selectee.$element.removeClass("ui-selected"),selectee.selected=!1),selectee.unselecting&&(selectee.$element.removeClass("ui-unselecting"),selectee.unselecting=!1),selectee.selecting||(selectee.$element.addClass("ui-selecting"),selectee.selecting=!0,that._trigger("selecting",event,{selecting:selectee.element}))):(selectee.selecting&&((event.metaKey||event.ctrlKey)&&selectee.startselected?(selectee.$element.removeClass("ui-selecting"),selectee.selecting=!1,selectee.$element.addClass("ui-selected"),selectee.selected=!0):(selectee.$element.removeClass("ui-selecting"),selectee.selecting=!1,selectee.startselected&&(selectee.$element.addClass("ui-unselecting"),selectee.unselecting=!0),that._trigger("unselecting",event,{unselecting:selectee.element}))),selectee.selected&&(event.metaKey||event.ctrlKey||selectee.startselected||(selectee.$element.removeClass("ui-selected"),selectee.selected=!1,selectee.$element.addClass("ui-unselecting"),selectee.unselecting=!0,that._trigger("unselecting",event,{unselecting:selectee.element})))))}),!1}},_mouseStop:function(event){var that=this;return this.dragged=!1,$(".ui-unselecting",this.element[0]).each(function(){var selectee=$.data(this,"selectable-item");selectee.$element.removeClass("ui-unselecting"),selectee.unselecting=!1,selectee.startselected=!1,that._trigger("unselected",event,{unselected:selectee.element})}),$(".ui-selecting",this.element[0]).each(function(){var selectee=$.data(this,"selectable-item");selectee.$element.removeClass("ui-selecting").addClass("ui-selected"),selectee.selecting=!1,selectee.selected=!0,selectee.startselected=!0,that._trigger("selected",event,{selected:selectee.element})}),this._trigger("stop",event),this.helper.remove(),!1}}),$.widget("ui.sortable",$.ui.mouse,{version:"1.11.4",widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3,activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_isOverAxis:function(x,reference,size){return x>=reference&&x<reference+size},_isFloating:function(item){return/left|right/.test(item.css("float"))||/inline|table-cell/.test(item.css("display"))},_create:function(){this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.offset=this.element.offset(),this._mouseInit(),this._setHandleClassName(),this.ready=!0},_setOption:function(key,value){this._super(key,value),"handle"===key&&this._setHandleClassName()},_setHandleClassName:function(){this.element.find(".ui-sortable-handle").removeClass("ui-sortable-handle"),$.each(this.items,function(){(this.instance.options.handle?this.item.find(this.instance.options.handle):this.item).addClass("ui-sortable-handle")})},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled").find(".ui-sortable-handle").removeClass("ui-sortable-handle"),this._mouseDestroy();for(var i=this.items.length-1;i>=0;i--)this.items[i].item.removeData(this.widgetName+"-item");return this},_mouseCapture:function(event,overrideHandle){var currentItem=null,validHandle=!1,that=this;return!this.reverting&&(!this.options.disabled&&"static"!==this.options.type&&(this._refreshItems(event),$(event.target).parents().each(function(){if($.data(this,that.widgetName+"-item")===that)return currentItem=$(this),!1}),$.data(event.target,that.widgetName+"-item")===that&&(currentItem=$(event.target)),!!currentItem&&(!(this.options.handle&&!overrideHandle&&($(this.options.handle,currentItem).find("*").addBack().each(function(){this===event.target&&(validHandle=!0)}),!validHandle))&&(this.currentItem=currentItem,this._removeCurrentsFromItems(),!0))))},_mouseStart:function(event,overrideHandle,noActivation){var i,body,o=this.options;if(this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(event),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},$.extend(this.offset,{click:{left:event.pageX-this.offset.left,top:event.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(event),this.originalPageX=event.pageX,this.originalPageY=event.pageY,o.cursorAt&&this._adjustOffsetFromHelper(o.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!==this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),o.containment&&this._setContainment(),o.cursor&&"auto"!==o.cursor&&(body=this.document.find("body"),this.storedCursor=body.css("cursor"),body.css("cursor",o.cursor),this.storedStylesheet=$("<style>*{ cursor: "+o.cursor+" !important; }</style>").appendTo(body)),o.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",o.opacity)),o.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",o.zIndex)),this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",event,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions(),!noActivation)for(i=this.containers.length-1;i>=0;i--)this.containers[i]._trigger("activate",event,this._uiHash(this));return $.ui.ddmanager&&($.ui.ddmanager.current=this),$.ui.ddmanager&&!o.dropBehaviour&&$.ui.ddmanager.prepareOffsets(this,event),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(event),!0},_mouseDrag:function(event){var i,item,itemElement,intersection,o=this.options,scrolled=!1;for(this.position=this._generatePosition(event),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-event.pageY<o.scrollSensitivity?this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop+o.scrollSpeed:event.pageY-this.overflowOffset.top<o.scrollSensitivity&&(this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop-o.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-event.pageX<o.scrollSensitivity?this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft+o.scrollSpeed:event.pageX-this.overflowOffset.left<o.scrollSensitivity&&(this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft-o.scrollSpeed)):(event.pageY-this.document.scrollTop()<o.scrollSensitivity?scrolled=this.document.scrollTop(this.document.scrollTop()-o.scrollSpeed):this.window.height()-(event.pageY-this.document.scrollTop())<o.scrollSensitivity&&(scrolled=this.document.scrollTop(this.document.scrollTop()+o.scrollSpeed)),event.pageX-this.document.scrollLeft()<o.scrollSensitivity?scrolled=this.document.scrollLeft(this.document.scrollLeft()-o.scrollSpeed):this.window.width()-(event.pageX-this.document.scrollLeft())<o.scrollSensitivity&&(scrolled=this.document.scrollLeft(this.document.scrollLeft()+o.scrollSpeed))),!1!==scrolled&&$.ui.ddmanager&&!o.dropBehaviour&&$.ui.ddmanager.prepareOffsets(this,event)),this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),i=this.items.length-1;i>=0;i--)if(item=this.items[i],itemElement=item.item[0],(intersection=this._intersectsWithPointer(item))&&item.instance===this.currentContainer&&!(itemElement===this.currentItem[0]||this.placeholder[1===intersection?"next":"prev"]()[0]===itemElement||$.contains(this.placeholder[0],itemElement)||"semi-dynamic"===this.options.type&&$.contains(this.element[0],itemElement))){if(this.direction=1===intersection?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(item))break;this._rearrange(event,item),this._trigger("change",event,this._uiHash());break}return this._contactContainers(event),$.ui.ddmanager&&$.ui.ddmanager.drag(this,event),this._trigger("sort",event,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(event,noPropagation){if(event){if($.ui.ddmanager&&!this.options.dropBehaviour&&$.ui.ddmanager.drop(this,event),this.options.revert){var that=this,cur=this.placeholder.offset(),axis=this.options.axis,animation={};axis&&"x"!==axis||(animation.left=cur.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollLeft)),axis&&"y"!==axis||(animation.top=cur.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollTop)),this.reverting=!0,$(this.helper).animate(animation,parseInt(this.options.revert,10)||500,function(){that._clear(event)})}else this._clear(event,noPropagation);return!1}},cancel:function(){if(this.dragging){this._mouseUp({target:null}),"original"===this.options.helper?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();for(var i=this.containers.length-1;i>=0;i--)this.containers[i]._trigger("deactivate",null,this._uiHash(this)),this.containers[i].containerCache.over&&(this.containers[i]._trigger("out",null,this._uiHash(this)),this.containers[i].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),"original"!==this.options.helper&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),$.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?$(this.domPosition.prev).after(this.currentItem):$(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(o){var items=this._getItemsAsjQuery(o&&o.connected),str=[];return o=o||{},$(items).each(function(){var res=($(o.item||this).attr(o.attribute||"id")||"").match(o.expression||/(.+)[\-=_](.+)/);res&&str.push((o.key||res[1]+"[]")+"="+(o.key&&o.expression?res[1]:res[2]))}),!str.length&&o.key&&str.push(o.key+"="),str.join("&")},toArray:function(o){var items=this._getItemsAsjQuery(o&&o.connected),ret=[];return o=o||{},items.each(function(){ret.push($(o.item||this).attr(o.attribute||"id")||"")}),ret},_intersectsWith:function(item){var x1=this.positionAbs.left,x2=x1+this.helperProportions.width,y1=this.positionAbs.top,y2=y1+this.helperProportions.height,l=item.left,r=l+item.width,t=item.top,b=t+item.height,dyClick=this.offset.click.top,dxClick=this.offset.click.left,isOverElementHeight="x"===this.options.axis||y1+dyClick>t&&y1+dyClick<b,isOverElementWidth="y"===this.options.axis||x1+dxClick>l&&x1+dxClick<r,isOverElement=isOverElementHeight&&isOverElementWidth;return"pointer"===this.options.tolerance||this.options.forcePointerForContainers||"pointer"!==this.options.tolerance&&this.helperProportions[this.floating?"width":"height"]>item[this.floating?"width":"height"]?isOverElement:l<x1+this.helperProportions.width/2&&x2-this.helperProportions.width/2<r&&t<y1+this.helperProportions.height/2&&y2-this.helperProportions.height/2<b},_intersectsWithPointer:function(item){var isOverElementHeight="x"===this.options.axis||this._isOverAxis(this.positionAbs.top+this.offset.click.top,item.top,item.height),isOverElementWidth="y"===this.options.axis||this._isOverAxis(this.positionAbs.left+this.offset.click.left,item.left,item.width),isOverElement=isOverElementHeight&&isOverElementWidth,verticalDirection=this._getDragVerticalDirection(),horizontalDirection=this._getDragHorizontalDirection();return!!isOverElement&&(this.floating?horizontalDirection&&"right"===horizontalDirection||"down"===verticalDirection?2:1:verticalDirection&&("down"===verticalDirection?2:1))},_intersectsWithSides:function(item){var isOverBottomHalf=this._isOverAxis(this.positionAbs.top+this.offset.click.top,item.top+item.height/2,item.height),isOverRightHalf=this._isOverAxis(this.positionAbs.left+this.offset.click.left,item.left+item.width/2,item.width),verticalDirection=this._getDragVerticalDirection(),horizontalDirection=this._getDragHorizontalDirection();return this.floating&&horizontalDirection?"right"===horizontalDirection&&isOverRightHalf||"left"===horizontalDirection&&!isOverRightHalf:verticalDirection&&("down"===verticalDirection&&isOverBottomHalf||"up"===verticalDirection&&!isOverBottomHalf)},_getDragVerticalDirection:function(){var delta=this.positionAbs.top-this.lastPositionAbs.top;return 0!==delta&&(delta>0?"down":"up")},_getDragHorizontalDirection:function(){var delta=this.positionAbs.left-this.lastPositionAbs.left;return 0!==delta&&(delta>0?"right":"left")},refresh:function(event){return this._refreshItems(event),this._setHandleClassName(),this.refreshPositions(),this},_connectWith:function(){var options=this.options;return options.connectWith.constructor===String?[options.connectWith]:options.connectWith},_getItemsAsjQuery:function(connected){var i,j,cur,inst,items=[],queries=[],connectWith=this._connectWith();if(connectWith&&connected)for(i=connectWith.length-1;i>=0;i--)for(cur=$(connectWith[i],this.document[0]),j=cur.length-1;j>=0;j--)(inst=$.data(cur[j],this.widgetFullName))&&inst!==this&&!inst.options.disabled&&queries.push([$.isFunction(inst.options.items)?inst.options.items.call(inst.element):$(inst.options.items,inst.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),inst]);queries.push([$.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):$(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);function addItems(){items.push(this)}for(i=queries.length-1;i>=0;i--)queries[i][0].each(addItems);return $(items)},_removeCurrentsFromItems:function(){var list=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=$.grep(this.items,function(item){for(var j=0;j<list.length;j++)if(list[j]===item.item[0])return!1;return!0})},_refreshItems:function(event){this.items=[],this.containers=[this];var i,j,cur,inst,targetData,_queries,item,queriesLength,items=this.items,queries=[[$.isFunction(this.options.items)?this.options.items.call(this.element[0],event,{item:this.currentItem}):$(this.options.items,this.element),this]],connectWith=this._connectWith();if(connectWith&&this.ready)for(i=connectWith.length-1;i>=0;i--)for(cur=$(connectWith[i],this.document[0]),j=cur.length-1;j>=0;j--)(inst=$.data(cur[j],this.widgetFullName))&&inst!==this&&!inst.options.disabled&&(queries.push([$.isFunction(inst.options.items)?inst.options.items.call(inst.element[0],event,{item:this.currentItem}):$(inst.options.items,inst.element),inst]),this.containers.push(inst));for(i=queries.length-1;i>=0;i--)for(targetData=queries[i][1],_queries=queries[i][0],j=0,queriesLength=_queries.length;j<queriesLength;j++)item=$(_queries[j]),item.data(this.widgetName+"-item",targetData),items.push({item:item,instance:targetData,width:0,height:0,left:0,top:0})},refreshPositions:function(fast){this.floating=!!this.items.length&&("x"===this.options.axis||this._isFloating(this.items[0].item)),this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());var i,item,t,p;for(i=this.items.length-1;i>=0;i--)item=this.items[i],
item.instance!==this.currentContainer&&this.currentContainer&&item.item[0]!==this.currentItem[0]||(t=this.options.toleranceElement?$(this.options.toleranceElement,item.item):item.item,fast||(item.width=t.outerWidth(),item.height=t.outerHeight()),p=t.offset(),item.left=p.left,item.top=p.top);if(this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(i=this.containers.length-1;i>=0;i--)p=this.containers[i].element.offset(),this.containers[i].containerCache.left=p.left,this.containers[i].containerCache.top=p.top,this.containers[i].containerCache.width=this.containers[i].element.outerWidth(),this.containers[i].containerCache.height=this.containers[i].element.outerHeight();return this},_createPlaceholder:function(that){that=that||this;var className,o=that.options;o.placeholder&&o.placeholder.constructor!==String||(className=o.placeholder,o.placeholder={element:function(){var nodeName=that.currentItem[0].nodeName.toLowerCase(),element=$("<"+nodeName+">",that.document[0]).addClass(className||that.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper");return"tbody"===nodeName?that._createTrPlaceholder(that.currentItem.find("tr").eq(0),$("<tr>",that.document[0]).appendTo(element)):"tr"===nodeName?that._createTrPlaceholder(that.currentItem,element):"img"===nodeName&&element.attr("src",that.currentItem.attr("src")),className||element.css("visibility","hidden"),element},update:function(container,p){className&&!o.forcePlaceholderSize||(p.height()||p.height(that.currentItem.innerHeight()-parseInt(that.currentItem.css("paddingTop")||0,10)-parseInt(that.currentItem.css("paddingBottom")||0,10)),p.width()||p.width(that.currentItem.innerWidth()-parseInt(that.currentItem.css("paddingLeft")||0,10)-parseInt(that.currentItem.css("paddingRight")||0,10)))}}),that.placeholder=$(o.placeholder.element.call(that.element,that.currentItem)),that.currentItem.after(that.placeholder),o.placeholder.update(that,that.placeholder)},_createTrPlaceholder:function(sourceTr,targetTr){var that=this;sourceTr.children().each(function(){$("<td>&#160;</td>",that.document[0]).attr("colspan",$(this).attr("colspan")||1).appendTo(targetTr)})},_contactContainers:function(event){var i,j,dist,itemWithLeastDistance,posProperty,sizeProperty,cur,nearBottom,floating,axis,innermostContainer=null,innermostIndex=null;for(i=this.containers.length-1;i>=0;i--)if(!$.contains(this.currentItem[0],this.containers[i].element[0]))if(this._intersectsWith(this.containers[i].containerCache)){if(innermostContainer&&$.contains(this.containers[i].element[0],innermostContainer.element[0]))continue;innermostContainer=this.containers[i],innermostIndex=i}else this.containers[i].containerCache.over&&(this.containers[i]._trigger("out",event,this._uiHash(this)),this.containers[i].containerCache.over=0);if(innermostContainer)if(1===this.containers.length)this.containers[innermostIndex].containerCache.over||(this.containers[innermostIndex]._trigger("over",event,this._uiHash(this)),this.containers[innermostIndex].containerCache.over=1);else{for(dist=1e4,itemWithLeastDistance=null,floating=innermostContainer.floating||this._isFloating(this.currentItem),posProperty=floating?"left":"top",sizeProperty=floating?"width":"height",axis=floating?"clientX":"clientY",j=this.items.length-1;j>=0;j--)$.contains(this.containers[innermostIndex].element[0],this.items[j].item[0])&&this.items[j].item[0]!==this.currentItem[0]&&(cur=this.items[j].item.offset()[posProperty],nearBottom=!1,event[axis]-cur>this.items[j][sizeProperty]/2&&(nearBottom=!0),Math.abs(event[axis]-cur)<dist&&(dist=Math.abs(event[axis]-cur),itemWithLeastDistance=this.items[j],this.direction=nearBottom?"up":"down"));if(!itemWithLeastDistance&&!this.options.dropOnEmpty)return;if(this.currentContainer===this.containers[innermostIndex])return void(this.currentContainer.containerCache.over||(this.containers[innermostIndex]._trigger("over",event,this._uiHash()),this.currentContainer.containerCache.over=1));itemWithLeastDistance?this._rearrange(event,itemWithLeastDistance,null,!0):this._rearrange(event,null,this.containers[innermostIndex].element,!0),this._trigger("change",event,this._uiHash()),this.containers[innermostIndex]._trigger("change",event,this._uiHash(this)),this.currentContainer=this.containers[innermostIndex],this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[innermostIndex]._trigger("over",event,this._uiHash(this)),this.containers[innermostIndex].containerCache.over=1}},_createHelper:function(event){var o=this.options,helper=$.isFunction(o.helper)?$(o.helper.apply(this.element[0],[event,this.currentItem])):"clone"===o.helper?this.currentItem.clone():this.currentItem;return helper.parents("body").length||$("parent"!==o.appendTo?o.appendTo:this.currentItem[0].parentNode)[0].appendChild(helper[0]),helper[0]===this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),helper[0].style.width&&!o.forceHelperSize||helper.width(this.currentItem.width()),helper[0].style.height&&!o.forceHelperSize||helper.height(this.currentItem.height()),helper},_adjustOffsetFromHelper:function(obj){"string"==typeof obj&&(obj=obj.split(" ")),$.isArray(obj)&&(obj={left:+obj[0],top:+obj[1]||0}),"left"in obj&&(this.offset.click.left=obj.left+this.margins.left),"right"in obj&&(this.offset.click.left=this.helperProportions.width-obj.right+this.margins.left),"top"in obj&&(this.offset.click.top=obj.top+this.margins.top),"bottom"in obj&&(this.offset.click.top=this.helperProportions.height-obj.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var po=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==this.document[0]&&$.contains(this.scrollParent[0],this.offsetParent[0])&&(po.left+=this.scrollParent.scrollLeft(),po.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===this.document[0].body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&$.ui.ie)&&(po={top:0,left:0}),{top:po.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:po.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"===this.cssPosition){var p=this.currentItem.position();return{top:p.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:p.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var ce,co,over,o=this.options;"parent"===o.containment&&(o.containment=this.helper[0].parentNode),"document"!==o.containment&&"window"!==o.containment||(this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,"document"===o.containment?this.document.width():this.window.width()-this.helperProportions.width-this.margins.left,("document"===o.containment?this.document.width():this.window.height()||this.document[0].body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),/^(document|window|parent)$/.test(o.containment)||(ce=$(o.containment)[0],co=$(o.containment).offset(),over="hidden"!==$(ce).css("overflow"),this.containment=[co.left+(parseInt($(ce).css("borderLeftWidth"),10)||0)+(parseInt($(ce).css("paddingLeft"),10)||0)-this.margins.left,co.top+(parseInt($(ce).css("borderTopWidth"),10)||0)+(parseInt($(ce).css("paddingTop"),10)||0)-this.margins.top,co.left+(over?Math.max(ce.scrollWidth,ce.offsetWidth):ce.offsetWidth)-(parseInt($(ce).css("borderLeftWidth"),10)||0)-(parseInt($(ce).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,co.top+(over?Math.max(ce.scrollHeight,ce.offsetHeight):ce.offsetHeight)-(parseInt($(ce).css("borderTopWidth"),10)||0)-(parseInt($(ce).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top])},_convertPositionTo:function(d,pos){pos||(pos=this.position);var mod="absolute"===d?1:-1,scroll="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&$.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,scrollIsRootNode=/(html|body)/i.test(scroll[0].tagName);return{top:pos.top+this.offset.relative.top*mod+this.offset.parent.top*mod-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():scrollIsRootNode?0:scroll.scrollTop())*mod,left:pos.left+this.offset.relative.left*mod+this.offset.parent.left*mod-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():scrollIsRootNode?0:scroll.scrollLeft())*mod}},_generatePosition:function(event){var top,left,o=this.options,pageX=event.pageX,pageY=event.pageY,scroll="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&$.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,scrollIsRootNode=/(html|body)/i.test(scroll[0].tagName);return"relative"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&this.scrollParent[0]!==this.offsetParent[0]||(this.offset.relative=this._getRelativeOffset()),this.originalPosition&&(this.containment&&(event.pageX-this.offset.click.left<this.containment[0]&&(pageX=this.containment[0]+this.offset.click.left),event.pageY-this.offset.click.top<this.containment[1]&&(pageY=this.containment[1]+this.offset.click.top),event.pageX-this.offset.click.left>this.containment[2]&&(pageX=this.containment[2]+this.offset.click.left),event.pageY-this.offset.click.top>this.containment[3]&&(pageY=this.containment[3]+this.offset.click.top)),o.grid&&(top=this.originalPageY+Math.round((pageY-this.originalPageY)/o.grid[1])*o.grid[1],pageY=this.containment?top-this.offset.click.top>=this.containment[1]&&top-this.offset.click.top<=this.containment[3]?top:top-this.offset.click.top>=this.containment[1]?top-o.grid[1]:top+o.grid[1]:top,left=this.originalPageX+Math.round((pageX-this.originalPageX)/o.grid[0])*o.grid[0],pageX=this.containment?left-this.offset.click.left>=this.containment[0]&&left-this.offset.click.left<=this.containment[2]?left:left-this.offset.click.left>=this.containment[0]?left-o.grid[0]:left+o.grid[0]:left)),{top:pageY-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():scrollIsRootNode?0:scroll.scrollTop()),left:pageX-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():scrollIsRootNode?0:scroll.scrollLeft())}},_rearrange:function(event,i,a,hardRefresh){a?a[0].appendChild(this.placeholder[0]):i.item[0].parentNode.insertBefore(this.placeholder[0],"down"===this.direction?i.item[0]:i.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var counter=this.counter;this._delay(function(){counter===this.counter&&this.refreshPositions(!hardRefresh)})},_clear:function(event,noPropagation){this.reverting=!1;var i,delayedTriggers=[];if(!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null,this.helper[0]===this.currentItem[0]){for(i in this._storedCSS)"auto"!==this._storedCSS[i]&&"static"!==this._storedCSS[i]||(this._storedCSS[i]="");this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else this.currentItem.show();this.fromOutside&&!noPropagation&&delayedTriggers.push(function(event){this._trigger("receive",event,this._uiHash(this.fromOutside))}),!this.fromOutside&&this.domPosition.prev===this.currentItem.prev().not(".ui-sortable-helper")[0]&&this.domPosition.parent===this.currentItem.parent()[0]||noPropagation||delayedTriggers.push(function(event){this._trigger("update",event,this._uiHash())}),this!==this.currentContainer&&(noPropagation||(delayedTriggers.push(function(event){this._trigger("remove",event,this._uiHash())}),delayedTriggers.push(function(c){return function(event){c._trigger("receive",event,this._uiHash(this))}}.call(this,this.currentContainer)),delayedTriggers.push(function(c){return function(event){c._trigger("update",event,this._uiHash(this))}}.call(this,this.currentContainer))));function delayEvent(type,instance,container){return function(event){container._trigger(type,event,instance._uiHash(instance))}}for(i=this.containers.length-1;i>=0;i--)noPropagation||delayedTriggers.push(delayEvent("deactivate",this,this.containers[i])),this.containers[i].containerCache.over&&(delayedTriggers.push(delayEvent("out",this,this.containers[i])),this.containers[i].containerCache.over=0);if(this.storedCursor&&(this.document.find("body").css("cursor",this.storedCursor),this.storedStylesheet.remove()),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex","auto"===this._storedZIndex?"":this._storedZIndex),this.dragging=!1,noPropagation||this._trigger("beforeStop",event,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.cancelHelperRemoval||(this.helper[0]!==this.currentItem[0]&&this.helper.remove(),this.helper=null),!noPropagation){for(i=0;i<delayedTriggers.length;i++)delayedTriggers[i].call(this,event);this._trigger("stop",event,this._uiHash())}return this.fromOutside=!1,!this.cancelHelperRemoval},_trigger:function(){!1===$.Widget.prototype._trigger.apply(this,arguments)&&this.cancel()},_uiHash:function(_inst){var inst=_inst||this;return{helper:inst.helper,placeholder:inst.placeholder||$([]),position:inst.position,originalPosition:inst.originalPosition,offset:inst.positionAbs,item:inst.currentItem,sender:_inst?_inst.element:null}}}),$.widget("ui.accordion",{version:"1.11.4",options:{active:0,animate:{},collapsible:!1,event:"click",header:"> li > :first-child,> :not(li):even",heightStyle:"auto",icons:{activeHeader:"ui-icon-triangle-1-s",header:"ui-icon-triangle-1-e"},activate:null,beforeActivate:null},hideProps:{borderTopWidth:"hide",borderBottomWidth:"hide",paddingTop:"hide",paddingBottom:"hide",height:"hide"},showProps:{borderTopWidth:"show",borderBottomWidth:"show",paddingTop:"show",paddingBottom:"show",height:"show"},_create:function(){var options=this.options;this.prevShow=this.prevHide=$(),this.element.addClass("ui-accordion ui-widget ui-helper-reset").attr("role","tablist"),options.collapsible||!1!==options.active&&null!=options.active||(options.active=0),this._processPanels(),options.active<0&&(options.active+=this.headers.length),this._refresh()},_getCreateEventData:function(){return{header:this.active,panel:this.active.length?this.active.next():$()}},_createIcons:function(){var icons=this.options.icons;icons&&($("<span>").addClass("ui-accordion-header-icon ui-icon "+icons.header).prependTo(this.headers),this.active.children(".ui-accordion-header-icon").removeClass(icons.header).addClass(icons.activeHeader),this.headers.addClass("ui-accordion-icons"))},_destroyIcons:function(){this.headers.removeClass("ui-accordion-icons").children(".ui-accordion-header-icon").remove()},_destroy:function(){var contents;this.element.removeClass("ui-accordion ui-widget ui-helper-reset").removeAttr("role"),this.headers.removeClass("ui-accordion-header ui-accordion-header-active ui-state-default ui-corner-all ui-state-active ui-state-disabled ui-corner-top").removeAttr("role").removeAttr("aria-expanded").removeAttr("aria-selected").removeAttr("aria-controls").removeAttr("tabIndex").removeUniqueId(),this._destroyIcons(),contents=this.headers.next().removeClass("ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content ui-accordion-content-active ui-state-disabled").css("display","").removeAttr("role").removeAttr("aria-hidden").removeAttr("aria-labelledby").removeUniqueId(),"content"!==this.options.heightStyle&&contents.css("height","")},_setOption:function(key,value){if("active"===key)return void this._activate(value);"event"===key&&(this.options.event&&this._off(this.headers,this.options.event),this._setupEvents(value)),this._super(key,value),"collapsible"!==key||value||!1!==this.options.active||this._activate(0),"icons"===key&&(this._destroyIcons(),value&&this._createIcons()),"disabled"===key&&(this.element.toggleClass("ui-state-disabled",!!value).attr("aria-disabled",value),this.headers.add(this.headers.next()).toggleClass("ui-state-disabled",!!value))},_keydown:function(event){if(!event.altKey&&!event.ctrlKey){var keyCode=$.ui.keyCode,length=this.headers.length,currentIndex=this.headers.index(event.target),toFocus=!1;switch(event.keyCode){case keyCode.RIGHT:case keyCode.DOWN:toFocus=this.headers[(currentIndex+1)%length];break;case keyCode.LEFT:case keyCode.UP:toFocus=this.headers[(currentIndex-1+length)%length];break;case keyCode.SPACE:case keyCode.ENTER:this._eventHandler(event);break;case keyCode.HOME:toFocus=this.headers[0];break;case keyCode.END:toFocus=this.headers[length-1]}toFocus&&($(event.target).attr("tabIndex",-1),$(toFocus).attr("tabIndex",0),toFocus.focus(),event.preventDefault())}},_panelKeyDown:function(event){event.keyCode===$.ui.keyCode.UP&&event.ctrlKey&&$(event.currentTarget).prev().focus()},refresh:function(){var options=this.options;this._processPanels(),!1===options.active&&!0===options.collapsible||!this.headers.length?(options.active=!1,this.active=$()):!1===options.active?this._activate(0):this.active.length&&!$.contains(this.element[0],this.active[0])?this.headers.length===this.headers.find(".ui-state-disabled").length?(options.active=!1,this.active=$()):this._activate(Math.max(0,options.active-1)):options.active=this.headers.index(this.active),this._destroyIcons(),this._refresh()},_processPanels:function(){var prevHeaders=this.headers,prevPanels=this.panels;this.headers=this.element.find(this.options.header).addClass("ui-accordion-header ui-state-default ui-corner-all"),this.panels=this.headers.next().addClass("ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom").filter(":not(.ui-accordion-content-active)").hide(),prevPanels&&(this._off(prevHeaders.not(this.headers)),this._off(prevPanels.not(this.panels)))},_refresh:function(){var maxHeight,options=this.options,heightStyle=options.heightStyle,parent=this.element.parent();this.active=this._findActive(options.active).addClass("ui-accordion-header-active ui-state-active ui-corner-top").removeClass("ui-corner-all"),this.active.next().addClass("ui-accordion-content-active").show(),this.headers.attr("role","tab").each(function(){var header=$(this),headerId=header.uniqueId().attr("id"),panel=header.next(),panelId=panel.uniqueId().attr("id");header.attr("aria-controls",panelId),panel.attr("aria-labelledby",headerId)}).next().attr("role","tabpanel"),this.headers.not(this.active).attr({"aria-selected":"false","aria-expanded":"false",tabIndex:-1}).next().attr({"aria-hidden":"true"}).hide(),this.active.length?this.active.attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0}).next().attr({"aria-hidden":"false"}):this.headers.eq(0).attr("tabIndex",0),this._createIcons(),this._setupEvents(options.event),"fill"===heightStyle?(maxHeight=parent.height(),this.element.siblings(":visible").each(function(){var elem=$(this),position=elem.css("position");"absolute"!==position&&"fixed"!==position&&(maxHeight-=elem.outerHeight(!0))}),this.headers.each(function(){maxHeight-=$(this).outerHeight(!0)}),this.headers.next().each(function(){$(this).height(Math.max(0,maxHeight-$(this).innerHeight()+$(this).height()))}).css("overflow","auto")):"auto"===heightStyle&&(maxHeight=0,this.headers.next().each(function(){maxHeight=Math.max(maxHeight,$(this).css("height","").height())}).height(maxHeight))},_activate:function(index){var active=this._findActive(index)[0];active!==this.active[0]&&(active=active||this.active[0],this._eventHandler({target:active,currentTarget:active,preventDefault:$.noop}))},_findActive:function(selector){return"number"==typeof selector?this.headers.eq(selector):$()},_setupEvents:function(event){var events={keydown:"_keydown"};event&&$.each(event.split(" "),function(index,eventName){events[eventName]="_eventHandler"}),this._off(this.headers.add(this.headers.next())),this._on(this.headers,events),this._on(this.headers.next(),{keydown:"_panelKeyDown"}),this._hoverable(this.headers),this._focusable(this.headers)},_eventHandler:function(event){var options=this.options,active=this.active,clicked=$(event.currentTarget),clickedIsActive=clicked[0]===active[0],collapsing=clickedIsActive&&options.collapsible,toShow=collapsing?$():clicked.next(),toHide=active.next(),eventData={oldHeader:active,oldPanel:toHide,newHeader:collapsing?$():clicked,newPanel:toShow};event.preventDefault(),clickedIsActive&&!options.collapsible||!1===this._trigger("beforeActivate",event,eventData)||(options.active=!collapsing&&this.headers.index(clicked),this.active=clickedIsActive?$():clicked,this._toggle(eventData),active.removeClass("ui-accordion-header-active ui-state-active"),options.icons&&active.children(".ui-accordion-header-icon").removeClass(options.icons.activeHeader).addClass(options.icons.header),clickedIsActive||(clicked.removeClass("ui-corner-all").addClass("ui-accordion-header-active ui-state-active ui-corner-top"),options.icons&&clicked.children(".ui-accordion-header-icon").removeClass(options.icons.header).addClass(options.icons.activeHeader),clicked.next().addClass("ui-accordion-content-active")))},_toggle:function(data){var toShow=data.newPanel,toHide=this.prevShow.length?this.prevShow:data.oldPanel;this.prevShow.add(this.prevHide).stop(!0,!0),this.prevShow=toShow,this.prevHide=toHide,this.options.animate?this._animate(toShow,toHide,data):(toHide.hide(),toShow.show(),this._toggleComplete(data)),toHide.attr({"aria-hidden":"true"}),toHide.prev().attr({"aria-selected":"false","aria-expanded":"false"}),toShow.length&&toHide.length?toHide.prev().attr({tabIndex:-1,"aria-expanded":"false"}):toShow.length&&this.headers.filter(function(){return 0===parseInt($(this).attr("tabIndex"),10)}).attr("tabIndex",-1),toShow.attr("aria-hidden","false").prev().attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0})},_animate:function(toShow,toHide,data){var total,easing,duration,that=this,adjust=0,boxSizing=toShow.css("box-sizing"),down=toShow.length&&(!toHide.length||toShow.index()<toHide.index()),animate=this.options.animate||{},options=down&&animate.down||animate,complete=function(){that._toggleComplete(data)};return"number"==typeof options&&(duration=options),"string"==typeof options&&(easing=options),easing=easing||options.easing||animate.easing,duration=duration||options.duration||animate.duration,toHide.length?toShow.length?(total=toShow.show().outerHeight(),toHide.animate(this.hideProps,{duration:duration,easing:easing,step:function(now,fx){fx.now=Math.round(now)}}),void toShow.hide().animate(this.showProps,{duration:duration,easing:easing,complete:complete,step:function(now,fx){fx.now=Math.round(now),"height"!==fx.prop?"content-box"===boxSizing&&(adjust+=fx.now):"content"!==that.options.heightStyle&&(fx.now=Math.round(total-toHide.outerHeight()-adjust),adjust=0)}})):toHide.animate(this.hideProps,duration,easing,complete):toShow.animate(this.showProps,duration,easing,complete)},_toggleComplete:function(data){var toHide=data.oldPanel;toHide.removeClass("ui-accordion-content-active").prev().removeClass("ui-corner-top").addClass("ui-corner-all"),toHide.length&&(toHide.parent()[0].className=toHide.parent()[0].className),this._trigger("activate",null,data)}}),$.widget("ui.menu",{version:"1.11.4",defaultElement:"<ul>",delay:300,options:{icons:{submenu:"ui-icon-carat-1-e"},items:"> *",menus:"ul",position:{my:"left-1 top",at:"right top"},role:"menu",blur:null,focus:null,select:null},_create:function(){this.activeMenu=this.element,this.mouseHandled=!1,this.element.uniqueId().addClass("ui-menu ui-widget ui-widget-content").toggleClass("ui-menu-icons",!!this.element.find(".ui-icon").length).attr({role:this.options.role,tabIndex:0}),this.options.disabled&&this.element.addClass("ui-state-disabled").attr("aria-disabled","true"),this._on({"mousedown .ui-menu-item":function(event){event.preventDefault()},"click .ui-menu-item":function(event){var target=$(event.target);!this.mouseHandled&&target.not(".ui-state-disabled").length&&(this.select(event),event.isPropagationStopped()||(this.mouseHandled=!0),target.has(".ui-menu").length?this.expand(event):!this.element.is(":focus")&&$(this.document[0].activeElement).closest(".ui-menu").length&&(this.element.trigger("focus",[!0]),this.active&&1===this.active.parents(".ui-menu").length&&clearTimeout(this.timer)))},"mouseenter .ui-menu-item":function(event){if(!this.previousFilter){var target=$(event.currentTarget);target.siblings(".ui-state-active").removeClass("ui-state-active"),this.focus(event,target)}},mouseleave:"collapseAll","mouseleave .ui-menu":"collapseAll",focus:function(event,keepActiveItem){var item=this.active||this.element.find(this.options.items).eq(0);keepActiveItem||this.focus(event,item)},blur:function(event){this._delay(function(){$.contains(this.element[0],this.document[0].activeElement)||this.collapseAll(event)})},keydown:"_keydown"}),this.refresh(),this._on(this.document,{click:function(event){this._closeOnDocumentClick(event)&&this.collapseAll(event),this.mouseHandled=!1}})},_destroy:function(){this.element.removeAttr("aria-activedescendant").find(".ui-menu").addBack().removeClass("ui-menu ui-widget ui-widget-content ui-menu-icons ui-front").removeAttr("role").removeAttr("tabIndex").removeAttr("aria-labelledby").removeAttr("aria-expanded").removeAttr("aria-hidden").removeAttr("aria-disabled").removeUniqueId().show(),this.element.find(".ui-menu-item").removeClass("ui-menu-item").removeAttr("role").removeAttr("aria-disabled").removeUniqueId().removeClass("ui-state-hover").removeAttr("tabIndex").removeAttr("role").removeAttr("aria-haspopup").children().each(function(){var elem=$(this);elem.data("ui-menu-submenu-carat")&&elem.remove()}),this.element.find(".ui-menu-divider").removeClass("ui-menu-divider ui-widget-content")},_keydown:function(event){var match,prev,character,skip,preventDefault=!0;switch(event.keyCode){case $.ui.keyCode.PAGE_UP:this.previousPage(event);break;case $.ui.keyCode.PAGE_DOWN:this.nextPage(event);break;case $.ui.keyCode.HOME:this._move("first","first",event);break;case $.ui.keyCode.END:this._move("last","last",event);break;case $.ui.keyCode.UP:this.previous(event);break;case $.ui.keyCode.DOWN:this.next(event);break;case $.ui.keyCode.LEFT:this.collapse(event);break;case $.ui.keyCode.RIGHT:this.active&&!this.active.is(".ui-state-disabled")&&this.expand(event);break;case $.ui.keyCode.ENTER:case $.ui.keyCode.SPACE:this._activate(event);break;case $.ui.keyCode.ESCAPE:this.collapse(event);break;default:preventDefault=!1,prev=this.previousFilter||"",character=String.fromCharCode(event.keyCode),skip=!1,clearTimeout(this.filterTimer),character===prev?skip=!0:character=prev+character,match=this._filterMenuItems(character),match=skip&&-1!==match.index(this.active.next())?this.active.nextAll(".ui-menu-item"):match,match.length||(character=String.fromCharCode(event.keyCode),match=this._filterMenuItems(character)),match.length?(this.focus(event,match),this.previousFilter=character,this.filterTimer=this._delay(function(){delete this.previousFilter},1e3)):delete this.previousFilter}preventDefault&&event.preventDefault()},_activate:function(event){this.active.is(".ui-state-disabled")||(this.active.is("[aria-haspopup='true']")?this.expand(event):this.select(event))},refresh:function(){var menus,items,that=this,icon=this.options.icons.submenu,submenus=this.element.find(this.options.menus);this.element.toggleClass("ui-menu-icons",!!this.element.find(".ui-icon").length),submenus.filter(":not(.ui-menu)").addClass("ui-menu ui-widget ui-widget-content ui-front").hide().attr({role:this.options.role,"aria-hidden":"true","aria-expanded":"false"}).each(function(){var menu=$(this),item=menu.parent(),submenuCarat=$("<span>").addClass("ui-menu-icon ui-icon "+icon).data("ui-menu-submenu-carat",!0);item.attr("aria-haspopup","true").prepend(submenuCarat),menu.attr("aria-labelledby",item.attr("id"))}),menus=submenus.add(this.element),items=menus.find(this.options.items),items.not(".ui-menu-item").each(function(){var item=$(this);that._isDivider(item)&&item.addClass("ui-widget-content ui-menu-divider")}),items.not(".ui-menu-item, .ui-menu-divider").addClass("ui-menu-item").uniqueId().attr({tabIndex:-1,role:this._itemRole()}),items.filter(".ui-state-disabled").attr("aria-disabled","true"),this.active&&!$.contains(this.element[0],this.active[0])&&this.blur()},_itemRole:function(){return{menu:"menuitem",listbox:"option"}[this.options.role]},_setOption:function(key,value){"icons"===key&&this.element.find(".ui-menu-icon").removeClass(this.options.icons.submenu).addClass(value.submenu),"disabled"===key&&this.element.toggleClass("ui-state-disabled",!!value).attr("aria-disabled",value),this._super(key,value)},focus:function(event,item){var nested,focused;this.blur(event,event&&"focus"===event.type),this._scrollIntoView(item),this.active=item.first(),focused=this.active.addClass("ui-state-focus").removeClass("ui-state-active"),this.options.role&&this.element.attr("aria-activedescendant",focused.attr("id")),this.active.parent().closest(".ui-menu-item").addClass("ui-state-active"),event&&"keydown"===event.type?this._close():this.timer=this._delay(function(){this._close()},this.delay),nested=item.children(".ui-menu"),nested.length&&event&&/^mouse/.test(event.type)&&this._startOpening(nested),this.activeMenu=item.parent(),this._trigger("focus",event,{item:item})},_scrollIntoView:function(item){var borderTop,paddingTop,offset,scroll,elementHeight,itemHeight;this._hasScroll()&&(borderTop=parseFloat($.css(this.activeMenu[0],"borderTopWidth"))||0,paddingTop=parseFloat($.css(this.activeMenu[0],"paddingTop"))||0,offset=item.offset().top-this.activeMenu.offset().top-borderTop-paddingTop,scroll=this.activeMenu.scrollTop(),elementHeight=this.activeMenu.height(),itemHeight=item.outerHeight(),offset<0?this.activeMenu.scrollTop(scroll+offset):offset+itemHeight>elementHeight&&this.activeMenu.scrollTop(scroll+offset-elementHeight+itemHeight))},blur:function(event,fromFocus){fromFocus||clearTimeout(this.timer),this.active&&(this.active.removeClass("ui-state-focus"),this.active=null,this._trigger("blur",event,{item:this.active}))},_startOpening:function(submenu){clearTimeout(this.timer),"true"===submenu.attr("aria-hidden")&&(this.timer=this._delay(function(){this._close(),this._open(submenu)},this.delay))},_open:function(submenu){var position=$.extend({of:this.active},this.options.position);clearTimeout(this.timer),this.element.find(".ui-menu").not(submenu.parents(".ui-menu")).hide().attr("aria-hidden","true"),submenu.show().removeAttr("aria-hidden").attr("aria-expanded","true").position(position)},collapseAll:function(event,all){clearTimeout(this.timer),this.timer=this._delay(function(){var currentMenu=all?this.element:$(event&&event.target).closest(this.element.find(".ui-menu"));currentMenu.length||(currentMenu=this.element),this._close(currentMenu),this.blur(event),this.activeMenu=currentMenu},this.delay)},_close:function(startMenu){startMenu||(startMenu=this.active?this.active.parent():this.element),startMenu.find(".ui-menu").hide().attr("aria-hidden","true").attr("aria-expanded","false").end().find(".ui-state-active").not(".ui-state-focus").removeClass("ui-state-active")},_closeOnDocumentClick:function(event){return!$(event.target).closest(".ui-menu").length},_isDivider:function(item){return!/[^\-\u2014\u2013\s]/.test(item.text())},collapse:function(event){
var newItem=this.active&&this.active.parent().closest(".ui-menu-item",this.element);newItem&&newItem.length&&(this._close(),this.focus(event,newItem))},expand:function(event){var newItem=this.active&&this.active.children(".ui-menu ").find(this.options.items).first();newItem&&newItem.length&&(this._open(newItem.parent()),this._delay(function(){this.focus(event,newItem)}))},next:function(event){this._move("next","first",event)},previous:function(event){this._move("prev","last",event)},isFirstItem:function(){return this.active&&!this.active.prevAll(".ui-menu-item").length},isLastItem:function(){return this.active&&!this.active.nextAll(".ui-menu-item").length},_move:function(direction,filter,event){var next;this.active&&(next="first"===direction||"last"===direction?this.active["first"===direction?"prevAll":"nextAll"](".ui-menu-item").eq(-1):this.active[direction+"All"](".ui-menu-item").eq(0)),next&&next.length&&this.active||(next=this.activeMenu.find(this.options.items)[filter]()),this.focus(event,next)},nextPage:function(event){var item,base,height;if(!this.active)return void this.next(event);this.isLastItem()||(this._hasScroll()?(base=this.active.offset().top,height=this.element.height(),this.active.nextAll(".ui-menu-item").each(function(){return item=$(this),item.offset().top-base-height<0}),this.focus(event,item)):this.focus(event,this.activeMenu.find(this.options.items)[this.active?"last":"first"]()))},previousPage:function(event){var item,base,height;if(!this.active)return void this.next(event);this.isFirstItem()||(this._hasScroll()?(base=this.active.offset().top,height=this.element.height(),this.active.prevAll(".ui-menu-item").each(function(){return item=$(this),item.offset().top-base+height>0}),this.focus(event,item)):this.focus(event,this.activeMenu.find(this.options.items).first()))},_hasScroll:function(){return this.element.outerHeight()<this.element.prop("scrollHeight")},select:function(event){this.active=this.active||$(event.target).closest(".ui-menu-item");var ui={item:this.active};this.active.has(".ui-menu").length||this.collapseAll(event,!0),this._trigger("select",event,ui)},_filterMenuItems:function(character){var escapedCharacter=character.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),regex=new RegExp("^"+escapedCharacter,"i");return this.activeMenu.find(this.options.items).filter(".ui-menu-item").filter(function(){return regex.test($.trim($(this).text()))})}});$.widget("ui.autocomplete",{version:"1.11.4",defaultElement:"<input>",options:{appendTo:null,autoFocus:!1,delay:300,minLength:1,position:{my:"left top",at:"left bottom",collision:"none"},source:null,change:null,close:null,focus:null,open:null,response:null,search:null,select:null},requestIndex:0,pending:0,_create:function(){var suppressKeyPress,suppressKeyPressRepeat,suppressInput,nodeName=this.element[0].nodeName.toLowerCase(),isTextarea="textarea"===nodeName,isInput="input"===nodeName;this.isMultiLine=!!isTextarea||!isInput&&this.element.prop("isContentEditable"),this.valueMethod=this.element[isTextarea||isInput?"val":"text"],this.isNewMenu=!0,this.element.addClass("ui-autocomplete-input").attr("autocomplete","off"),this._on(this.element,{keydown:function(event){if(this.element.prop("readOnly"))return suppressKeyPress=!0,suppressInput=!0,void(suppressKeyPressRepeat=!0);suppressKeyPress=!1,suppressInput=!1,suppressKeyPressRepeat=!1;var keyCode=$.ui.keyCode;switch(event.keyCode){case keyCode.PAGE_UP:suppressKeyPress=!0,this._move("previousPage",event);break;case keyCode.PAGE_DOWN:suppressKeyPress=!0,this._move("nextPage",event);break;case keyCode.UP:suppressKeyPress=!0,this._keyEvent("previous",event);break;case keyCode.DOWN:suppressKeyPress=!0,this._keyEvent("next",event);break;case keyCode.ENTER:this.menu.active&&(suppressKeyPress=!0,event.preventDefault(),this.menu.select(event));break;case keyCode.TAB:this.menu.active&&this.menu.select(event);break;case keyCode.ESCAPE:this.menu.element.is(":visible")&&(this.isMultiLine||this._value(this.term),this.close(event),event.preventDefault());break;default:suppressKeyPressRepeat=!0,this._searchTimeout(event)}},keypress:function(event){if(suppressKeyPress)return suppressKeyPress=!1,void(this.isMultiLine&&!this.menu.element.is(":visible")||event.preventDefault());if(!suppressKeyPressRepeat){var keyCode=$.ui.keyCode;switch(event.keyCode){case keyCode.PAGE_UP:this._move("previousPage",event);break;case keyCode.PAGE_DOWN:this._move("nextPage",event);break;case keyCode.UP:this._keyEvent("previous",event);break;case keyCode.DOWN:this._keyEvent("next",event)}}},input:function(event){if(suppressInput)return suppressInput=!1,void event.preventDefault();this._searchTimeout(event)},focus:function(){this.selectedItem=null,this.previous=this._value()},blur:function(event){if(this.cancelBlur)return void delete this.cancelBlur;clearTimeout(this.searching),this.close(event),this._change(event)}}),this._initSource(),this.menu=$("<ul>").addClass("ui-autocomplete ui-front").appendTo(this._appendTo()).menu({role:null}).hide().menu("instance"),this._on(this.menu.element,{mousedown:function(event){event.preventDefault(),this.cancelBlur=!0,this._delay(function(){delete this.cancelBlur});var menuElement=this.menu.element[0];$(event.target).closest(".ui-menu-item").length||this._delay(function(){var that=this;this.document.one("mousedown",function(event){event.target===that.element[0]||event.target===menuElement||$.contains(menuElement,event.target)||that.close()})})},menufocus:function(event,ui){var label,item;if(this.isNewMenu&&(this.isNewMenu=!1,event.originalEvent&&/^mouse/.test(event.originalEvent.type)))return this.menu.blur(),void this.document.one("mousemove",function(){$(event.target).trigger(event.originalEvent)});item=ui.item.data("ui-autocomplete-item"),!1!==this._trigger("focus",event,{item:item})&&event.originalEvent&&/^key/.test(event.originalEvent.type)&&this._value(item.value),(label=ui.item.attr("aria-label")||item.value)&&$.trim(label).length&&(this.liveRegion.children().hide(),$("<div>").text(label).appendTo(this.liveRegion))},menuselect:function(event,ui){var item=ui.item.data("ui-autocomplete-item"),previous=this.previous;this.element[0]!==this.document[0].activeElement&&(this.element.focus(),this.previous=previous,this._delay(function(){this.previous=previous,this.selectedItem=item})),!1!==this._trigger("select",event,{item:item})&&this._value(item.value),this.term=this._value(),this.close(event),this.selectedItem=item}}),this.liveRegion=$("<span>",{role:"status","aria-live":"assertive","aria-relevant":"additions"}).addClass("ui-helper-hidden-accessible").appendTo(this.document[0].body),this._on(this.window,{beforeunload:function(){this.element.removeAttr("autocomplete")}})},_destroy:function(){clearTimeout(this.searching),this.element.removeClass("ui-autocomplete-input").removeAttr("autocomplete"),this.menu.element.remove(),this.liveRegion.remove()},_setOption:function(key,value){this._super(key,value),"source"===key&&this._initSource(),"appendTo"===key&&this.menu.element.appendTo(this._appendTo()),"disabled"===key&&value&&this.xhr&&this.xhr.abort()},_appendTo:function(){var element=this.options.appendTo;return element&&(element=element.jquery||element.nodeType?$(element):this.document.find(element).eq(0)),element&&element[0]||(element=this.element.closest(".ui-front")),element.length||(element=this.document[0].body),element},_initSource:function(){var array,url,that=this;$.isArray(this.options.source)?(array=this.options.source,this.source=function(request,response){response($.ui.autocomplete.filter(array,request.term))}):"string"==typeof this.options.source?(url=this.options.source,this.source=function(request,response){that.xhr&&that.xhr.abort(),that.xhr=$.ajax({url:url,data:request,dataType:"json",success:function(data){response(data)},error:function(){response([])}})}):this.source=this.options.source},_searchTimeout:function(event){clearTimeout(this.searching),this.searching=this._delay(function(){var equalValues=this.term===this._value(),menuVisible=this.menu.element.is(":visible"),modifierKey=event.altKey||event.ctrlKey||event.metaKey||event.shiftKey;equalValues&&(!equalValues||menuVisible||modifierKey)||(this.selectedItem=null,this.search(null,event))},this.options.delay)},search:function(value,event){return value=null!=value?value:this._value(),this.term=this._value(),value.length<this.options.minLength?this.close(event):!1!==this._trigger("search",event)?this._search(value):void 0},_search:function(value){this.pending++,this.element.addClass("ui-autocomplete-loading"),this.cancelSearch=!1,this.source({term:value},this._response())},_response:function(){var index=++this.requestIndex;return $.proxy(function(content){index===this.requestIndex&&this.__response(content),--this.pending||this.element.removeClass("ui-autocomplete-loading")},this)},__response:function(content){content&&(content=this._normalize(content)),this._trigger("response",null,{content:content}),!this.options.disabled&&content&&content.length&&!this.cancelSearch?(this._suggest(content),this._trigger("open")):this._close()},close:function(event){this.cancelSearch=!0,this._close(event)},_close:function(event){this.menu.element.is(":visible")&&(this.menu.element.hide(),this.menu.blur(),this.isNewMenu=!0,this._trigger("close",event))},_change:function(event){this.previous!==this._value()&&this._trigger("change",event,{item:this.selectedItem})},_normalize:function(items){return items.length&&items[0].label&&items[0].value?items:$.map(items,function(item){return"string"==typeof item?{label:item,value:item}:$.extend({},item,{label:item.label||item.value,value:item.value||item.label})})},_suggest:function(items){var ul=this.menu.element.empty();this._renderMenu(ul,items),this.isNewMenu=!0,this.menu.refresh(),ul.show(),this._resizeMenu(),ul.position($.extend({of:this.element},this.options.position)),this.options.autoFocus&&this.menu.next()},_resizeMenu:function(){var ul=this.menu.element;ul.outerWidth(Math.max(ul.width("").outerWidth()+1,this.element.outerWidth()))},_renderMenu:function(ul,items){var that=this;$.each(items,function(index,item){that._renderItemData(ul,item)})},_renderItemData:function(ul,item){return this._renderItem(ul,item).data("ui-autocomplete-item",item)},_renderItem:function(ul,item){return $("<li>").text(item.label).appendTo(ul)},_move:function(direction,event){return this.menu.element.is(":visible")?this.menu.isFirstItem()&&/^previous/.test(direction)||this.menu.isLastItem()&&/^next/.test(direction)?(this.isMultiLine||this._value(this.term),void this.menu.blur()):void this.menu[direction](event):void this.search(null,event)},widget:function(){return this.menu.element},_value:function(){return this.valueMethod.apply(this.element,arguments)},_keyEvent:function(keyEvent,event){this.isMultiLine&&!this.menu.element.is(":visible")||(this._move(keyEvent,event),event.preventDefault())}}),$.extend($.ui.autocomplete,{escapeRegex:function(value){return value.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")},filter:function(array,term){var matcher=new RegExp($.ui.autocomplete.escapeRegex(term),"i");return $.grep(array,function(value){return matcher.test(value.label||value.value||value)})}}),$.widget("ui.autocomplete",$.ui.autocomplete,{options:{messages:{noResults:"No search results.",results:function(amount){return amount+(amount>1?" results are":" result is")+" available, use up and down arrow keys to navigate."}}},__response:function(content){var message;this._superApply(arguments),this.options.disabled||this.cancelSearch||(message=content&&content.length?this.options.messages.results(content.length):this.options.messages.noResults,this.liveRegion.children().hide(),$("<div>").text(message).appendTo(this.liveRegion))}});var lastActive,baseClasses=($.ui.autocomplete,"ui-button ui-widget ui-state-default ui-corner-all"),typeClasses="ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",formResetHandler=function(){var form=$(this);setTimeout(function(){form.find(":ui-button").button("refresh")},1)},radioGroup=function(radio){var name=radio.name,form=radio.form,radios=$([]);return name&&(name=name.replace(/'/g,"\\'"),radios=form?$(form).find("[name='"+name+"'][type=radio]"):$("[name='"+name+"'][type=radio]",radio.ownerDocument).filter(function(){return!this.form})),radios};$.widget("ui.button",{version:"1.11.4",defaultElement:"<button>",options:{disabled:null,text:!0,label:null,icons:{primary:null,secondary:null}},_create:function(){this.element.closest("form").unbind("reset"+this.eventNamespace).bind("reset"+this.eventNamespace,formResetHandler),"boolean"!=typeof this.options.disabled?this.options.disabled=!!this.element.prop("disabled"):this.element.prop("disabled",this.options.disabled),this._determineButtonType(),this.hasTitle=!!this.buttonElement.attr("title");var that=this,options=this.options,toggleButton="checkbox"===this.type||"radio"===this.type,activeClass=toggleButton?"":"ui-state-active";null===options.label&&(options.label="input"===this.type?this.buttonElement.val():this.buttonElement.html()),this._hoverable(this.buttonElement),this.buttonElement.addClass(baseClasses).attr("role","button").bind("mouseenter"+this.eventNamespace,function(){options.disabled||this===lastActive&&$(this).addClass("ui-state-active")}).bind("mouseleave"+this.eventNamespace,function(){options.disabled||$(this).removeClass(activeClass)}).bind("click"+this.eventNamespace,function(event){options.disabled&&(event.preventDefault(),event.stopImmediatePropagation())}),this._on({focus:function(){this.buttonElement.addClass("ui-state-focus")},blur:function(){this.buttonElement.removeClass("ui-state-focus")}}),toggleButton&&this.element.bind("change"+this.eventNamespace,function(){that.refresh()}),"checkbox"===this.type?this.buttonElement.bind("click"+this.eventNamespace,function(){if(options.disabled)return!1}):"radio"===this.type?this.buttonElement.bind("click"+this.eventNamespace,function(){if(options.disabled)return!1;$(this).addClass("ui-state-active"),that.buttonElement.attr("aria-pressed","true");var radio=that.element[0];radioGroup(radio).not(radio).map(function(){return $(this).button("widget")[0]}).removeClass("ui-state-active").attr("aria-pressed","false")}):(this.buttonElement.bind("mousedown"+this.eventNamespace,function(){if(options.disabled)return!1;$(this).addClass("ui-state-active"),lastActive=this,that.document.one("mouseup",function(){lastActive=null})}).bind("mouseup"+this.eventNamespace,function(){if(options.disabled)return!1;$(this).removeClass("ui-state-active")}).bind("keydown"+this.eventNamespace,function(event){if(options.disabled)return!1;event.keyCode!==$.ui.keyCode.SPACE&&event.keyCode!==$.ui.keyCode.ENTER||$(this).addClass("ui-state-active")}).bind("keyup"+this.eventNamespace+" blur"+this.eventNamespace,function(){$(this).removeClass("ui-state-active")}),this.buttonElement.is("a")&&this.buttonElement.keyup(function(event){event.keyCode===$.ui.keyCode.SPACE&&$(this).click()})),this._setOption("disabled",options.disabled),this._resetButton()},_determineButtonType:function(){var ancestor,labelSelector,checked;this.element.is("[type=checkbox]")?this.type="checkbox":this.element.is("[type=radio]")?this.type="radio":this.element.is("input")?this.type="input":this.type="button","checkbox"===this.type||"radio"===this.type?(ancestor=this.element.parents().last(),labelSelector="label[for='"+this.element.attr("id")+"']",this.buttonElement=ancestor.find(labelSelector),this.buttonElement.length||(ancestor=ancestor.length?ancestor.siblings():this.element.siblings(),this.buttonElement=ancestor.filter(labelSelector),this.buttonElement.length||(this.buttonElement=ancestor.find(labelSelector))),this.element.addClass("ui-helper-hidden-accessible"),checked=this.element.is(":checked"),checked&&this.buttonElement.addClass("ui-state-active"),this.buttonElement.prop("aria-pressed",checked)):this.buttonElement=this.element},widget:function(){return this.buttonElement},_destroy:function(){this.element.removeClass("ui-helper-hidden-accessible"),this.buttonElement.removeClass(baseClasses+" ui-state-active "+typeClasses).removeAttr("role").removeAttr("aria-pressed").html(this.buttonElement.find(".ui-button-text").html()),this.hasTitle||this.buttonElement.removeAttr("title")},_setOption:function(key,value){if(this._super(key,value),"disabled"===key)return this.widget().toggleClass("ui-state-disabled",!!value),this.element.prop("disabled",!!value),void(value&&("checkbox"===this.type||"radio"===this.type?this.buttonElement.removeClass("ui-state-focus"):this.buttonElement.removeClass("ui-state-focus ui-state-active")));this._resetButton()},refresh:function(){var isDisabled=this.element.is("input, button")?this.element.is(":disabled"):this.element.hasClass("ui-button-disabled");isDisabled!==this.options.disabled&&this._setOption("disabled",isDisabled),"radio"===this.type?radioGroup(this.element[0]).each(function(){$(this).is(":checked")?$(this).button("widget").addClass("ui-state-active").attr("aria-pressed","true"):$(this).button("widget").removeClass("ui-state-active").attr("aria-pressed","false")}):"checkbox"===this.type&&(this.element.is(":checked")?this.buttonElement.addClass("ui-state-active").attr("aria-pressed","true"):this.buttonElement.removeClass("ui-state-active").attr("aria-pressed","false"))},_resetButton:function(){if("input"===this.type)return void(this.options.label&&this.element.val(this.options.label));var buttonElement=this.buttonElement.removeClass(typeClasses),buttonText=$("<span></span>",this.document[0]).addClass("ui-button-text").html(this.options.label).appendTo(buttonElement.empty()).text(),icons=this.options.icons,multipleIcons=icons.primary&&icons.secondary,buttonClasses=[];icons.primary||icons.secondary?(this.options.text&&buttonClasses.push("ui-button-text-icon"+(multipleIcons?"s":icons.primary?"-primary":"-secondary")),icons.primary&&buttonElement.prepend("<span class='ui-button-icon-primary ui-icon "+icons.primary+"'></span>"),icons.secondary&&buttonElement.append("<span class='ui-button-icon-secondary ui-icon "+icons.secondary+"'></span>"),this.options.text||(buttonClasses.push(multipleIcons?"ui-button-icons-only":"ui-button-icon-only"),this.hasTitle||buttonElement.attr("title",$.trim(buttonText)))):buttonClasses.push("ui-button-text-only"),buttonElement.addClass(buttonClasses.join(" "))}}),$.widget("ui.buttonset",{version:"1.11.4",options:{items:"button, input[type=button], input[type=submit], input[type=reset], input[type=checkbox], input[type=radio], a, :data(ui-button)"},_create:function(){this.element.addClass("ui-buttonset")},_init:function(){this.refresh()},_setOption:function(key,value){"disabled"===key&&this.buttons.button("option",key,value),this._super(key,value)},refresh:function(){var rtl="rtl"===this.element.css("direction"),allButtons=this.element.find(this.options.items),existingButtons=allButtons.filter(":ui-button");allButtons.not(":ui-button").button(),existingButtons.button("refresh"),this.buttons=allButtons.map(function(){return $(this).button("widget")[0]}).removeClass("ui-corner-all ui-corner-left ui-corner-right").filter(":first").addClass(rtl?"ui-corner-right":"ui-corner-left").end().filter(":last").addClass(rtl?"ui-corner-left":"ui-corner-right").end().end()},_destroy:function(){this.element.removeClass("ui-buttonset"),this.buttons.map(function(){return $(this).button("widget")[0]}).removeClass("ui-corner-left ui-corner-right").end().button("destroy")}});$.ui.button;$.extend($.ui,{datepicker:{version:"1.11.4"}});var datepicker_instActive;function datepicker_getZindex(elem){for(var position,value;elem.length&&elem[0]!==document;){if(("absolute"===(position=elem.css("position"))||"relative"===position||"fixed"===position)&&(value=parseInt(elem.css("zIndex"),10),!isNaN(value)&&0!==value))return value;elem=elem.parent()}return 0}function Datepicker(){this._curInst=null,this._keyEvent=!1,this._disabledInputs=[],this._datepickerShowing=!1,this._inDialog=!1,this._mainDivId="ui-datepicker-div",this._inlineClass="ui-datepicker-inline",this._appendClass="ui-datepicker-append",this._triggerClass="ui-datepicker-trigger",this._dialogClass="ui-datepicker-dialog",this._disableClass="ui-datepicker-disabled",this._unselectableClass="ui-datepicker-unselectable",this._currentClass="ui-datepicker-current-day",this._dayOverClass="ui-datepicker-days-cell-over",this.regional=[],this.regional[""]={closeText:"Done",prevText:"Prev",nextText:"Next",currentText:"Today",monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],dayNamesMin:["Su","Mo","Tu","We","Th","Fr","Sa"],weekHeader:"Wk",dateFormat:"mm/dd/yy",firstDay:0,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},this._defaults={showOn:"focus",showAnim:"fadeIn",showOptions:{},defaultDate:null,appendText:"",buttonText:"...",buttonImage:"",buttonImageOnly:!1,hideIfNoPrevNext:!1,navigationAsDateFormat:!1,gotoCurrent:!1,changeMonth:!1,changeYear:!1,yearRange:"c-10:c+10",showOtherMonths:!1,selectOtherMonths:!1,showWeek:!1,calculateWeek:this.iso8601Week,shortYearCutoff:"+10",minDate:null,maxDate:null,duration:"fast",beforeShowDay:null,beforeShow:null,onSelect:null,onChangeMonthYear:null,onClose:null,numberOfMonths:1,showCurrentAtPos:0,stepMonths:1,stepBigMonths:12,altField:"",altFormat:"",constrainInput:!0,showButtonPanel:!1,autoSize:!1,disabled:!1},$.extend(this._defaults,this.regional[""]),this.regional.en=$.extend(!0,{},this.regional[""]),this.regional["en-US"]=$.extend(!0,{},this.regional.en),this.dpDiv=datepicker_bindHover($("<div id='"+this._mainDivId+"' class='ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>"))}$.extend(Datepicker.prototype,{markerClassName:"hasDatepicker",maxRows:4,_widgetDatepicker:function(){return this.dpDiv},setDefaults:function(settings){return datepicker_extendRemove(this._defaults,settings||{}),this},_attachDatepicker:function(target,settings){var nodeName,inline,inst;nodeName=target.nodeName.toLowerCase(),inline="div"===nodeName||"span"===nodeName,target.id||(this.uuid+=1,target.id="dp"+this.uuid),inst=this._newInst($(target),inline),inst.settings=$.extend({},settings||{}),"input"===nodeName?this._connectDatepicker(target,inst):inline&&this._inlineDatepicker(target,inst)},_newInst:function(target,inline){return{id:target[0].id.replace(/([^A-Za-z0-9_\-])/g,"\\\\$1"),input:target,selectedDay:0,selectedMonth:0,selectedYear:0,drawMonth:0,drawYear:0,inline:inline,dpDiv:inline?datepicker_bindHover($("<div class='"+this._inlineClass+" ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>")):this.dpDiv}},_connectDatepicker:function(target,inst){var input=$(target);inst.append=$([]),inst.trigger=$([]),input.hasClass(this.markerClassName)||(this._attachments(input,inst),input.addClass(this.markerClassName).keydown(this._doKeyDown).keypress(this._doKeyPress).keyup(this._doKeyUp),this._autoSize(inst),$.data(target,"datepicker",inst),inst.settings.disabled&&this._disableDatepicker(target))},_attachments:function(input,inst){var showOn,buttonText,buttonImage,appendText=this._get(inst,"appendText"),isRTL=this._get(inst,"isRTL");inst.append&&inst.append.remove(),appendText&&(inst.append=$("<span class='"+this._appendClass+"'>"+appendText+"</span>"),input[isRTL?"before":"after"](inst.append)),input.unbind("focus",this._showDatepicker),inst.trigger&&inst.trigger.remove(),showOn=this._get(inst,"showOn"),"focus"!==showOn&&"both"!==showOn||input.focus(this._showDatepicker),"button"!==showOn&&"both"!==showOn||(buttonText=this._get(inst,"buttonText"),buttonImage=this._get(inst,"buttonImage"),inst.trigger=$(this._get(inst,"buttonImageOnly")?$("<img/>").addClass(this._triggerClass).attr({src:buttonImage,alt:buttonText,title:buttonText}):$("<button type='button'></button>").addClass(this._triggerClass).html(buttonImage?$("<img/>").attr({src:buttonImage,alt:buttonText,title:buttonText}):buttonText)),input[isRTL?"before":"after"](inst.trigger),inst.trigger.click(function(){return $.datepicker._datepickerShowing&&$.datepicker._lastInput===input[0]?$.datepicker._hideDatepicker():$.datepicker._datepickerShowing&&$.datepicker._lastInput!==input[0]?($.datepicker._hideDatepicker(),$.datepicker._showDatepicker(input[0])):$.datepicker._showDatepicker(input[0]),!1}))},_autoSize:function(inst){if(this._get(inst,"autoSize")&&!inst.inline){var findMax,max,maxI,i,date=new Date(2009,11,20),dateFormat=this._get(inst,"dateFormat");dateFormat.match(/[DM]/)&&(findMax=function(names){for(max=0,maxI=0,i=0;i<names.length;i++)names[i].length>max&&(max=names[i].length,maxI=i);return maxI},date.setMonth(findMax(this._get(inst,dateFormat.match(/MM/)?"monthNames":"monthNamesShort"))),date.setDate(findMax(this._get(inst,dateFormat.match(/DD/)?"dayNames":"dayNamesShort"))+20-date.getDay())),inst.input.attr("size",this._formatDate(inst,date).length)}},_inlineDatepicker:function(target,inst){var divSpan=$(target);divSpan.hasClass(this.markerClassName)||(divSpan.addClass(this.markerClassName).append(inst.dpDiv),$.data(target,"datepicker",inst),this._setDate(inst,this._getDefaultDate(inst),!0),this._updateDatepicker(inst),this._updateAlternate(inst),inst.settings.disabled&&this._disableDatepicker(target),inst.dpDiv.css("display","block"))},_dialogDatepicker:function(input,date,onSelect,settings,pos){var id,browserWidth,browserHeight,scrollX,scrollY,inst=this._dialogInst;return inst||(this.uuid+=1,id="dp"+this.uuid,this._dialogInput=$("<input type='text' id='"+id+"' style='position: absolute; top: -100px; width: 0px;'/>"),this._dialogInput.keydown(this._doKeyDown),$("body").append(this._dialogInput),inst=this._dialogInst=this._newInst(this._dialogInput,!1),inst.settings={},$.data(this._dialogInput[0],"datepicker",inst)),datepicker_extendRemove(inst.settings,settings||{}),date=date&&date.constructor===Date?this._formatDate(inst,date):date,this._dialogInput.val(date),this._pos=pos?pos.length?pos:[pos.pageX,pos.pageY]:null,this._pos||(browserWidth=document.documentElement.clientWidth,browserHeight=document.documentElement.clientHeight,scrollX=document.documentElement.scrollLeft||document.body.scrollLeft,scrollY=document.documentElement.scrollTop||document.body.scrollTop,this._pos=[browserWidth/2-100+scrollX,browserHeight/2-150+scrollY]),this._dialogInput.css("left",this._pos[0]+20+"px").css("top",this._pos[1]+"px"),inst.settings.onSelect=onSelect,this._inDialog=!0,this.dpDiv.addClass(this._dialogClass),this._showDatepicker(this._dialogInput[0]),$.blockUI&&$.blockUI(this.dpDiv),$.data(this._dialogInput[0],"datepicker",inst),this},_destroyDatepicker:function(target){var nodeName,$target=$(target),inst=$.data(target,"datepicker");$target.hasClass(this.markerClassName)&&(nodeName=target.nodeName.toLowerCase(),$.removeData(target,"datepicker"),"input"===nodeName?(inst.append.remove(),inst.trigger.remove(),$target.removeClass(this.markerClassName).unbind("focus",this._showDatepicker).unbind("keydown",this._doKeyDown).unbind("keypress",this._doKeyPress).unbind("keyup",this._doKeyUp)):"div"!==nodeName&&"span"!==nodeName||$target.removeClass(this.markerClassName).empty(),datepicker_instActive===inst&&(datepicker_instActive=null))},_enableDatepicker:function(target){var nodeName,inline,$target=$(target),inst=$.data(target,"datepicker");$target.hasClass(this.markerClassName)&&(nodeName=target.nodeName.toLowerCase(),"input"===nodeName?(target.disabled=!1,inst.trigger.filter("button").each(function(){this.disabled=!1}).end().filter("img").css({opacity:"1.0",cursor:""})):"div"!==nodeName&&"span"!==nodeName||(inline=$target.children("."+this._inlineClass),inline.children().removeClass("ui-state-disabled"),inline.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!1)),this._disabledInputs=$.map(this._disabledInputs,function(value){return value===target?null:value}))},_disableDatepicker:function(target){var nodeName,inline,$target=$(target),inst=$.data(target,"datepicker");$target.hasClass(this.markerClassName)&&(nodeName=target.nodeName.toLowerCase(),"input"===nodeName?(target.disabled=!0,inst.trigger.filter("button").each(function(){this.disabled=!0}).end().filter("img").css({opacity:"0.5",cursor:"default"})):"div"!==nodeName&&"span"!==nodeName||(inline=$target.children("."+this._inlineClass),inline.children().addClass("ui-state-disabled"),inline.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!0)),this._disabledInputs=$.map(this._disabledInputs,function(value){return value===target?null:value}),this._disabledInputs[this._disabledInputs.length]=target)},_isDisabledDatepicker:function(target){if(!target)return!1;for(var i=0;i<this._disabledInputs.length;i++)if(this._disabledInputs[i]===target)return!0;return!1},_getInst:function(target){try{return $.data(target,"datepicker")}catch(err){throw"Missing instance data for this datepicker"}},_optionDatepicker:function(target,name,value){var settings,date,minDate,maxDate,inst=this._getInst(target);if(2===arguments.length&&"string"==typeof name)return"defaults"===name?$.extend({},$.datepicker._defaults):inst?"all"===name?$.extend({},inst.settings):this._get(inst,name):null;settings=name||{},"string"==typeof name&&(settings={},settings[name]=value),inst&&(this._curInst===inst&&this._hideDatepicker(),date=this._getDateDatepicker(target,!0),minDate=this._getMinMaxDate(inst,"min"),maxDate=this._getMinMaxDate(inst,"max"),datepicker_extendRemove(inst.settings,settings),null!==minDate&&void 0!==settings.dateFormat&&void 0===settings.minDate&&(inst.settings.minDate=this._formatDate(inst,minDate)),null!==maxDate&&void 0!==settings.dateFormat&&void 0===settings.maxDate&&(inst.settings.maxDate=this._formatDate(inst,maxDate)),"disabled"in settings&&(settings.disabled?this._disableDatepicker(target):this._enableDatepicker(target)),this._attachments($(target),inst),this._autoSize(inst),this._setDate(inst,date),this._updateAlternate(inst),this._updateDatepicker(inst))},_changeDatepicker:function(target,name,value){this._optionDatepicker(target,name,value)},_refreshDatepicker:function(target){var inst=this._getInst(target);inst&&this._updateDatepicker(inst)},_setDateDatepicker:function(target,date){var inst=this._getInst(target);inst&&(this._setDate(inst,date),this._updateDatepicker(inst),this._updateAlternate(inst))},_getDateDatepicker:function(target,noDefault){var inst=this._getInst(target);return inst&&!inst.inline&&this._setDateFromField(inst,noDefault),inst?this._getDate(inst):null},_doKeyDown:function(event){var onSelect,dateStr,sel,inst=$.datepicker._getInst(event.target),handled=!0,isRTL=inst.dpDiv.is(".ui-datepicker-rtl");if(inst._keyEvent=!0,$.datepicker._datepickerShowing)switch(event.keyCode){case 9:$.datepicker._hideDatepicker(),handled=!1;break;case 13:return sel=$("td."+$.datepicker._dayOverClass+":not(."+$.datepicker._currentClass+")",inst.dpDiv),sel[0]&&$.datepicker._selectDay(event.target,inst.selectedMonth,inst.selectedYear,sel[0]),onSelect=$.datepicker._get(inst,"onSelect"),onSelect?(dateStr=$.datepicker._formatDate(inst),onSelect.apply(inst.input?inst.input[0]:null,[dateStr,inst])):$.datepicker._hideDatepicker(),!1;case 27:$.datepicker._hideDatepicker();break;case 33:$.datepicker._adjustDate(event.target,event.ctrlKey?-$.datepicker._get(inst,"stepBigMonths"):-$.datepicker._get(inst,"stepMonths"),"M");break;case 34:$.datepicker._adjustDate(event.target,event.ctrlKey?+$.datepicker._get(inst,"stepBigMonths"):+$.datepicker._get(inst,"stepMonths"),"M");break;case 35:(event.ctrlKey||event.metaKey)&&$.datepicker._clearDate(event.target),handled=event.ctrlKey||event.metaKey;break;case 36:
(event.ctrlKey||event.metaKey)&&$.datepicker._gotoToday(event.target),handled=event.ctrlKey||event.metaKey;break;case 37:(event.ctrlKey||event.metaKey)&&$.datepicker._adjustDate(event.target,isRTL?1:-1,"D"),handled=event.ctrlKey||event.metaKey,event.originalEvent.altKey&&$.datepicker._adjustDate(event.target,event.ctrlKey?-$.datepicker._get(inst,"stepBigMonths"):-$.datepicker._get(inst,"stepMonths"),"M");break;case 38:(event.ctrlKey||event.metaKey)&&$.datepicker._adjustDate(event.target,-7,"D"),handled=event.ctrlKey||event.metaKey;break;case 39:(event.ctrlKey||event.metaKey)&&$.datepicker._adjustDate(event.target,isRTL?-1:1,"D"),handled=event.ctrlKey||event.metaKey,event.originalEvent.altKey&&$.datepicker._adjustDate(event.target,event.ctrlKey?+$.datepicker._get(inst,"stepBigMonths"):+$.datepicker._get(inst,"stepMonths"),"M");break;case 40:(event.ctrlKey||event.metaKey)&&$.datepicker._adjustDate(event.target,7,"D"),handled=event.ctrlKey||event.metaKey;break;default:handled=!1}else 36===event.keyCode&&event.ctrlKey?$.datepicker._showDatepicker(this):handled=!1;handled&&(event.preventDefault(),event.stopPropagation())},_doKeyPress:function(event){var chars,chr,inst=$.datepicker._getInst(event.target);if($.datepicker._get(inst,"constrainInput"))return chars=$.datepicker._possibleChars($.datepicker._get(inst,"dateFormat")),chr=String.fromCharCode(null==event.charCode?event.keyCode:event.charCode),event.ctrlKey||event.metaKey||chr<" "||!chars||chars.indexOf(chr)>-1},_doKeyUp:function(event){var date,inst=$.datepicker._getInst(event.target);if(inst.input.val()!==inst.lastVal)try{date=$.datepicker.parseDate($.datepicker._get(inst,"dateFormat"),inst.input?inst.input.val():null,$.datepicker._getFormatConfig(inst)),date&&($.datepicker._setDateFromField(inst),$.datepicker._updateAlternate(inst),$.datepicker._updateDatepicker(inst))}catch(err){}return!0},_showDatepicker:function(input){if(input=input.target||input,"input"!==input.nodeName.toLowerCase()&&(input=$("input",input.parentNode)[0]),!$.datepicker._isDisabledDatepicker(input)&&$.datepicker._lastInput!==input){var inst,beforeShow,beforeShowSettings,isFixed,offset,showAnim,duration;inst=$.datepicker._getInst(input),$.datepicker._curInst&&$.datepicker._curInst!==inst&&($.datepicker._curInst.dpDiv.stop(!0,!0),inst&&$.datepicker._datepickerShowing&&$.datepicker._hideDatepicker($.datepicker._curInst.input[0])),beforeShow=$.datepicker._get(inst,"beforeShow"),beforeShowSettings=beforeShow?beforeShow.apply(input,[input,inst]):{},!1!==beforeShowSettings&&(datepicker_extendRemove(inst.settings,beforeShowSettings),inst.lastVal=null,$.datepicker._lastInput=input,$.datepicker._setDateFromField(inst),$.datepicker._inDialog&&(input.value=""),$.datepicker._pos||($.datepicker._pos=$.datepicker._findPos(input),$.datepicker._pos[1]+=input.offsetHeight),isFixed=!1,$(input).parents().each(function(){return!(isFixed|="fixed"===$(this).css("position"))}),offset={left:$.datepicker._pos[0],top:$.datepicker._pos[1]},$.datepicker._pos=null,inst.dpDiv.empty(),inst.dpDiv.css({position:"absolute",display:"block",top:"-1000px"}),$.datepicker._updateDatepicker(inst),offset=$.datepicker._checkOffset(inst,offset,isFixed),inst.dpDiv.css({position:$.datepicker._inDialog&&$.blockUI?"static":isFixed?"fixed":"absolute",display:"none",left:offset.left+"px",top:offset.top+"px"}),inst.inline||(showAnim=$.datepicker._get(inst,"showAnim"),duration=$.datepicker._get(inst,"duration"),inst.dpDiv.css("z-index",datepicker_getZindex($(input))+1),$.datepicker._datepickerShowing=!0,$.effects&&$.effects.effect[showAnim]?inst.dpDiv.show(showAnim,$.datepicker._get(inst,"showOptions"),duration):inst.dpDiv[showAnim||"show"](showAnim?duration:null),$.datepicker._shouldFocusInput(inst)&&inst.input.focus(),$.datepicker._curInst=inst))}},_updateDatepicker:function(inst){this.maxRows=4,datepicker_instActive=inst,inst.dpDiv.empty().append(this._generateHTML(inst)),this._attachHandlers(inst);var origyearshtml,numMonths=this._getNumberOfMonths(inst),cols=numMonths[1],activeCell=inst.dpDiv.find("."+this._dayOverClass+" a");activeCell.length>0&&datepicker_handleMouseover.apply(activeCell.get(0)),inst.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width(""),cols>1&&inst.dpDiv.addClass("ui-datepicker-multi-"+cols).css("width",17*cols+"em"),inst.dpDiv[(1!==numMonths[0]||1!==numMonths[1]?"add":"remove")+"Class"]("ui-datepicker-multi"),inst.dpDiv[(this._get(inst,"isRTL")?"add":"remove")+"Class"]("ui-datepicker-rtl"),inst===$.datepicker._curInst&&$.datepicker._datepickerShowing&&$.datepicker._shouldFocusInput(inst)&&inst.input.focus(),inst.yearshtml&&(origyearshtml=inst.yearshtml,setTimeout(function(){origyearshtml===inst.yearshtml&&inst.yearshtml&&inst.dpDiv.find("select.ui-datepicker-year:first").replaceWith(inst.yearshtml),origyearshtml=inst.yearshtml=null},0))},_shouldFocusInput:function(inst){return inst.input&&inst.input.is(":visible")&&!inst.input.is(":disabled")&&!inst.input.is(":focus")},_checkOffset:function(inst,offset,isFixed){var dpWidth=inst.dpDiv.outerWidth(),dpHeight=inst.dpDiv.outerHeight(),inputWidth=inst.input?inst.input.outerWidth():0,inputHeight=inst.input?inst.input.outerHeight():0,viewWidth=document.documentElement.clientWidth+(isFixed?0:$(document).scrollLeft()),viewHeight=document.documentElement.clientHeight+(isFixed?0:$(document).scrollTop());return offset.left-=this._get(inst,"isRTL")?dpWidth-inputWidth:0,offset.left-=isFixed&&offset.left===inst.input.offset().left?$(document).scrollLeft():0,offset.top-=isFixed&&offset.top===inst.input.offset().top+inputHeight?$(document).scrollTop():0,offset.left-=Math.min(offset.left,offset.left+dpWidth>viewWidth&&viewWidth>dpWidth?Math.abs(offset.left+dpWidth-viewWidth):0),offset.top-=Math.min(offset.top,offset.top+dpHeight>viewHeight&&viewHeight>dpHeight?Math.abs(dpHeight+inputHeight):0),offset},_findPos:function(obj){for(var position,inst=this._getInst(obj),isRTL=this._get(inst,"isRTL");obj&&("hidden"===obj.type||1!==obj.nodeType||$.expr.filters.hidden(obj));)obj=obj[isRTL?"previousSibling":"nextSibling"];return position=$(obj).offset(),[position.left,position.top]},_hideDatepicker:function(input){var showAnim,duration,postProcess,onClose,inst=this._curInst;!inst||input&&inst!==$.data(input,"datepicker")||this._datepickerShowing&&(showAnim=this._get(inst,"showAnim"),duration=this._get(inst,"duration"),postProcess=function(){$.datepicker._tidyDialog(inst)},$.effects&&($.effects.effect[showAnim]||$.effects[showAnim])?inst.dpDiv.hide(showAnim,$.datepicker._get(inst,"showOptions"),duration,postProcess):inst.dpDiv["slideDown"===showAnim?"slideUp":"fadeIn"===showAnim?"fadeOut":"hide"](showAnim?duration:null,postProcess),showAnim||postProcess(),this._datepickerShowing=!1,onClose=this._get(inst,"onClose"),onClose&&onClose.apply(inst.input?inst.input[0]:null,[inst.input?inst.input.val():"",inst]),this._lastInput=null,this._inDialog&&(this._dialogInput.css({position:"absolute",left:"0",top:"-100px"}),$.blockUI&&($.unblockUI(),$("body").append(this.dpDiv))),this._inDialog=!1)},_tidyDialog:function(inst){inst.dpDiv.removeClass(this._dialogClass).unbind(".ui-datepicker-calendar")},_checkExternalClick:function(event){if($.datepicker._curInst){var $target=$(event.target),inst=$.datepicker._getInst($target[0]);($target[0].id===$.datepicker._mainDivId||0!==$target.parents("#"+$.datepicker._mainDivId).length||$target.hasClass($.datepicker.markerClassName)||$target.closest("."+$.datepicker._triggerClass).length||!$.datepicker._datepickerShowing||$.datepicker._inDialog&&$.blockUI)&&(!$target.hasClass($.datepicker.markerClassName)||$.datepicker._curInst===inst)||$.datepicker._hideDatepicker()}},_adjustDate:function(id,offset,period){var target=$(id),inst=this._getInst(target[0]);this._isDisabledDatepicker(target[0])||(this._adjustInstDate(inst,offset+("M"===period?this._get(inst,"showCurrentAtPos"):0),period),this._updateDatepicker(inst))},_gotoToday:function(id){var date,target=$(id),inst=this._getInst(target[0]);this._get(inst,"gotoCurrent")&&inst.currentDay?(inst.selectedDay=inst.currentDay,inst.drawMonth=inst.selectedMonth=inst.currentMonth,inst.drawYear=inst.selectedYear=inst.currentYear):(date=new Date,inst.selectedDay=date.getDate(),inst.drawMonth=inst.selectedMonth=date.getMonth(),inst.drawYear=inst.selectedYear=date.getFullYear()),this._notifyChange(inst),this._adjustDate(target)},_selectMonthYear:function(id,select,period){var target=$(id),inst=this._getInst(target[0]);inst["selected"+("M"===period?"Month":"Year")]=inst["draw"+("M"===period?"Month":"Year")]=parseInt(select.options[select.selectedIndex].value,10),this._notifyChange(inst),this._adjustDate(target)},_selectDay:function(id,month,year,td){var inst,target=$(id);$(td).hasClass(this._unselectableClass)||this._isDisabledDatepicker(target[0])||(inst=this._getInst(target[0]),inst.selectedDay=inst.currentDay=$("a",td).html(),inst.selectedMonth=inst.currentMonth=month,inst.selectedYear=inst.currentYear=year,this._selectDate(id,this._formatDate(inst,inst.currentDay,inst.currentMonth,inst.currentYear)))},_clearDate:function(id){var target=$(id);this._selectDate(target,"")},_selectDate:function(id,dateStr){var onSelect,target=$(id),inst=this._getInst(target[0]);dateStr=null!=dateStr?dateStr:this._formatDate(inst),inst.input&&inst.input.val(dateStr),this._updateAlternate(inst),onSelect=this._get(inst,"onSelect"),onSelect?onSelect.apply(inst.input?inst.input[0]:null,[dateStr,inst]):inst.input&&inst.input.trigger("change"),inst.inline?this._updateDatepicker(inst):(this._hideDatepicker(),this._lastInput=inst.input[0],"object"!=typeof inst.input[0]&&inst.input.focus(),this._lastInput=null)},_updateAlternate:function(inst){var altFormat,date,dateStr,altField=this._get(inst,"altField");altField&&(altFormat=this._get(inst,"altFormat")||this._get(inst,"dateFormat"),date=this._getDate(inst),dateStr=this.formatDate(altFormat,date,this._getFormatConfig(inst)),$(altField).each(function(){$(this).val(dateStr)}))},noWeekends:function(date){var day=date.getDay();return[day>0&&day<6,""]},iso8601Week:function(date){var time,checkDate=new Date(date.getTime());return checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7)),time=checkDate.getTime(),checkDate.setMonth(0),checkDate.setDate(1),Math.floor(Math.round((time-checkDate)/864e5)/7)+1},parseDate:function(format,value,settings){if(null==format||null==value)throw"Invalid arguments";if(""===(value="object"==typeof value?value.toString():value+""))return null;var iFormat,dim,extra,date,iValue=0,shortYearCutoffTemp=(settings?settings.shortYearCutoff:null)||this._defaults.shortYearCutoff,shortYearCutoff="string"!=typeof shortYearCutoffTemp?shortYearCutoffTemp:(new Date).getFullYear()%100+parseInt(shortYearCutoffTemp,10),dayNamesShort=(settings?settings.dayNamesShort:null)||this._defaults.dayNamesShort,dayNames=(settings?settings.dayNames:null)||this._defaults.dayNames,monthNamesShort=(settings?settings.monthNamesShort:null)||this._defaults.monthNamesShort,monthNames=(settings?settings.monthNames:null)||this._defaults.monthNames,year=-1,month=-1,day=-1,doy=-1,literal=!1,lookAhead=function(match){var matches=iFormat+1<format.length&&format.charAt(iFormat+1)===match;return matches&&iFormat++,matches},getNumber=function(match){var isDoubled=lookAhead(match),size="@"===match?14:"!"===match?20:"y"===match&&isDoubled?4:"o"===match?3:2,minSize="y"===match?size:1,digits=new RegExp("^\\d{"+minSize+","+size+"}"),num=value.substring(iValue).match(digits);if(!num)throw"Missing number at position "+iValue;return iValue+=num[0].length,parseInt(num[0],10)},getName=function(match,shortNames,longNames){var index=-1,names=$.map(lookAhead(match)?longNames:shortNames,function(v,k){return[[k,v]]}).sort(function(a,b){return-(a[1].length-b[1].length)});if($.each(names,function(i,pair){var name=pair[1];if(value.substr(iValue,name.length).toLowerCase()===name.toLowerCase())return index=pair[0],iValue+=name.length,!1}),-1!==index)return index+1;throw"Unknown name at position "+iValue},checkLiteral=function(){if(value.charAt(iValue)!==format.charAt(iFormat))throw"Unexpected literal at position "+iValue;iValue++};for(iFormat=0;iFormat<format.length;iFormat++)if(literal)"'"!==format.charAt(iFormat)||lookAhead("'")?checkLiteral():literal=!1;else switch(format.charAt(iFormat)){case"d":day=getNumber("d");break;case"D":getName("D",dayNamesShort,dayNames);break;case"o":doy=getNumber("o");break;case"m":month=getNumber("m");break;case"M":month=getName("M",monthNamesShort,monthNames);break;case"y":year=getNumber("y");break;case"@":date=new Date(getNumber("@")),year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate();break;case"!":date=new Date((getNumber("!")-this._ticksTo1970)/1e4),year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate();break;case"'":lookAhead("'")?checkLiteral():literal=!0;break;default:checkLiteral()}if(iValue<value.length&&(extra=value.substr(iValue),!/^\s+/.test(extra)))throw"Extra/unparsed characters found in date: "+extra;if(-1===year?year=(new Date).getFullYear():year<100&&(year+=(new Date).getFullYear()-(new Date).getFullYear()%100+(year<=shortYearCutoff?0:-100)),doy>-1)for(month=1,day=doy;;){if(dim=this._getDaysInMonth(year,month-1),day<=dim)break;month++,day-=dim}if(date=this._daylightSavingAdjust(new Date(year,month-1,day)),date.getFullYear()!==year||date.getMonth()+1!==month||date.getDate()!==day)throw"Invalid date";return date},ATOM:"yy-mm-dd",COOKIE:"D, dd M yy",ISO_8601:"yy-mm-dd",RFC_822:"D, d M y",RFC_850:"DD, dd-M-y",RFC_1036:"D, d M y",RFC_1123:"D, d M yy",RFC_2822:"D, d M yy",RSS:"D, d M y",TICKS:"!",TIMESTAMP:"@",W3C:"yy-mm-dd",_ticksTo1970:24*(718685+Math.floor(492.5)-Math.floor(19.7)+Math.floor(4.925))*60*60*1e7,formatDate:function(format,date,settings){if(!date)return"";var iFormat,dayNamesShort=(settings?settings.dayNamesShort:null)||this._defaults.dayNamesShort,dayNames=(settings?settings.dayNames:null)||this._defaults.dayNames,monthNamesShort=(settings?settings.monthNamesShort:null)||this._defaults.monthNamesShort,monthNames=(settings?settings.monthNames:null)||this._defaults.monthNames,lookAhead=function(match){var matches=iFormat+1<format.length&&format.charAt(iFormat+1)===match;return matches&&iFormat++,matches},formatNumber=function(match,value,len){var num=""+value;if(lookAhead(match))for(;num.length<len;)num="0"+num;return num},formatName=function(match,value,shortNames,longNames){return lookAhead(match)?longNames[value]:shortNames[value]},output="",literal=!1;if(date)for(iFormat=0;iFormat<format.length;iFormat++)if(literal)"'"!==format.charAt(iFormat)||lookAhead("'")?output+=format.charAt(iFormat):literal=!1;else switch(format.charAt(iFormat)){case"d":output+=formatNumber("d",date.getDate(),2);break;case"D":output+=formatName("D",date.getDay(),dayNamesShort,dayNames);break;case"o":output+=formatNumber("o",Math.round((new Date(date.getFullYear(),date.getMonth(),date.getDate()).getTime()-new Date(date.getFullYear(),0,0).getTime())/864e5),3);break;case"m":output+=formatNumber("m",date.getMonth()+1,2);break;case"M":output+=formatName("M",date.getMonth(),monthNamesShort,monthNames);break;case"y":output+=lookAhead("y")?date.getFullYear():(date.getYear()%100<10?"0":"")+date.getYear()%100;break;case"@":output+=date.getTime();break;case"!":output+=1e4*date.getTime()+this._ticksTo1970;break;case"'":lookAhead("'")?output+="'":literal=!0;break;default:output+=format.charAt(iFormat)}return output},_possibleChars:function(format){var iFormat,chars="",literal=!1,lookAhead=function(match){var matches=iFormat+1<format.length&&format.charAt(iFormat+1)===match;return matches&&iFormat++,matches};for(iFormat=0;iFormat<format.length;iFormat++)if(literal)"'"!==format.charAt(iFormat)||lookAhead("'")?chars+=format.charAt(iFormat):literal=!1;else switch(format.charAt(iFormat)){case"d":case"m":case"y":case"@":chars+="0123456789";break;case"D":case"M":return null;case"'":lookAhead("'")?chars+="'":literal=!0;break;default:chars+=format.charAt(iFormat)}return chars},_get:function(inst,name){return void 0!==inst.settings[name]?inst.settings[name]:this._defaults[name]},_setDateFromField:function(inst,noDefault){if(inst.input.val()!==inst.lastVal){var dateFormat=this._get(inst,"dateFormat"),dates=inst.lastVal=inst.input?inst.input.val():null,defaultDate=this._getDefaultDate(inst),date=defaultDate,settings=this._getFormatConfig(inst);try{date=this.parseDate(dateFormat,dates,settings)||defaultDate}catch(event){dates=noDefault?"":dates}inst.selectedDay=date.getDate(),inst.drawMonth=inst.selectedMonth=date.getMonth(),inst.drawYear=inst.selectedYear=date.getFullYear(),inst.currentDay=dates?date.getDate():0,inst.currentMonth=dates?date.getMonth():0,inst.currentYear=dates?date.getFullYear():0,this._adjustInstDate(inst)}},_getDefaultDate:function(inst){return this._restrictMinMax(inst,this._determineDate(inst,this._get(inst,"defaultDate"),new Date))},_determineDate:function(inst,date,defaultDate){var newDate=null==date||""===date?defaultDate:"string"==typeof date?function(offset){try{return $.datepicker.parseDate($.datepicker._get(inst,"dateFormat"),offset,$.datepicker._getFormatConfig(inst))}catch(e){}for(var date=(offset.toLowerCase().match(/^c/)?$.datepicker._getDate(inst):null)||new Date,year=date.getFullYear(),month=date.getMonth(),day=date.getDate(),pattern=/([+\-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,matches=pattern.exec(offset);matches;){switch(matches[2]||"d"){case"d":case"D":day+=parseInt(matches[1],10);break;case"w":case"W":day+=7*parseInt(matches[1],10);break;case"m":case"M":month+=parseInt(matches[1],10),day=Math.min(day,$.datepicker._getDaysInMonth(year,month));break;case"y":case"Y":year+=parseInt(matches[1],10),day=Math.min(day,$.datepicker._getDaysInMonth(year,month))}matches=pattern.exec(offset)}return new Date(year,month,day)}(date):"number"==typeof date?isNaN(date)?defaultDate:function(offset){var date=new Date;return date.setDate(date.getDate()+offset),date}(date):new Date(date.getTime());return newDate=newDate&&"Invalid Date"===newDate.toString()?defaultDate:newDate,newDate&&(newDate.setHours(0),newDate.setMinutes(0),newDate.setSeconds(0),newDate.setMilliseconds(0)),this._daylightSavingAdjust(newDate)},_daylightSavingAdjust:function(date){return date?(date.setHours(date.getHours()>12?date.getHours()+2:0),date):null},_setDate:function(inst,date,noChange){var clear=!date,origMonth=inst.selectedMonth,origYear=inst.selectedYear,newDate=this._restrictMinMax(inst,this._determineDate(inst,date,new Date));inst.selectedDay=inst.currentDay=newDate.getDate(),inst.drawMonth=inst.selectedMonth=inst.currentMonth=newDate.getMonth(),inst.drawYear=inst.selectedYear=inst.currentYear=newDate.getFullYear(),origMonth===inst.selectedMonth&&origYear===inst.selectedYear||noChange||this._notifyChange(inst),this._adjustInstDate(inst),inst.input&&inst.input.val(clear?"":this._formatDate(inst))},_getDate:function(inst){return!inst.currentYear||inst.input&&""===inst.input.val()?null:this._daylightSavingAdjust(new Date(inst.currentYear,inst.currentMonth,inst.currentDay))},_attachHandlers:function(inst){var stepMonths=this._get(inst,"stepMonths"),id="#"+inst.id.replace(/\\\\/g,"\\");inst.dpDiv.find("[data-handler]").map(function(){var handler={prev:function(){$.datepicker._adjustDate(id,-stepMonths,"M")},next:function(){$.datepicker._adjustDate(id,+stepMonths,"M")},hide:function(){$.datepicker._hideDatepicker()},today:function(){$.datepicker._gotoToday(id)},selectDay:function(){return $.datepicker._selectDay(id,+this.getAttribute("data-month"),+this.getAttribute("data-year"),this),!1},selectMonth:function(){return $.datepicker._selectMonthYear(id,this,"M"),!1},selectYear:function(){return $.datepicker._selectMonthYear(id,this,"Y"),!1}};$(this).bind(this.getAttribute("data-event"),handler[this.getAttribute("data-handler")])})},_generateHTML:function(inst){var maxDraw,prevText,prev,nextText,next,currentText,gotoDate,controls,buttonPanel,firstDay,showWeek,dayNames,dayNamesMin,monthNames,monthNamesShort,beforeShowDay,showOtherMonths,selectOtherMonths,defaultDate,html,dow,row,group,col,selectedDate,cornerClass,calender,thead,day,daysInMonth,leadDays,curRows,numRows,printDate,dRow,tbody,daySettings,otherMonth,unselectable,tempDate=new Date,today=this._daylightSavingAdjust(new Date(tempDate.getFullYear(),tempDate.getMonth(),tempDate.getDate())),isRTL=this._get(inst,"isRTL"),showButtonPanel=this._get(inst,"showButtonPanel"),hideIfNoPrevNext=this._get(inst,"hideIfNoPrevNext"),navigationAsDateFormat=this._get(inst,"navigationAsDateFormat"),numMonths=this._getNumberOfMonths(inst),showCurrentAtPos=this._get(inst,"showCurrentAtPos"),stepMonths=this._get(inst,"stepMonths"),isMultiMonth=1!==numMonths[0]||1!==numMonths[1],currentDate=this._daylightSavingAdjust(inst.currentDay?new Date(inst.currentYear,inst.currentMonth,inst.currentDay):new Date(9999,9,9)),minDate=this._getMinMaxDate(inst,"min"),maxDate=this._getMinMaxDate(inst,"max"),drawMonth=inst.drawMonth-showCurrentAtPos,drawYear=inst.drawYear;if(drawMonth<0&&(drawMonth+=12,drawYear--),maxDate)for(maxDraw=this._daylightSavingAdjust(new Date(maxDate.getFullYear(),maxDate.getMonth()-numMonths[0]*numMonths[1]+1,maxDate.getDate())),maxDraw=minDate&&maxDraw<minDate?minDate:maxDraw;this._daylightSavingAdjust(new Date(drawYear,drawMonth,1))>maxDraw;)--drawMonth<0&&(drawMonth=11,drawYear--);for(inst.drawMonth=drawMonth,inst.drawYear=drawYear,prevText=this._get(inst,"prevText"),prevText=navigationAsDateFormat?this.formatDate(prevText,this._daylightSavingAdjust(new Date(drawYear,drawMonth-stepMonths,1)),this._getFormatConfig(inst)):prevText,prev=this._canAdjustMonth(inst,-1,drawYear,drawMonth)?"<a class='ui-datepicker-prev ui-corner-all' data-handler='prev' data-event='click' title='"+prevText+"'><span class='ui-icon ui-icon-circle-triangle-"+(isRTL?"e":"w")+"'>"+prevText+"</span></a>":hideIfNoPrevNext?"":"<a class='ui-datepicker-prev ui-corner-all ui-state-disabled' title='"+prevText+"'><span class='ui-icon ui-icon-circle-triangle-"+(isRTL?"e":"w")+"'>"+prevText+"</span></a>",nextText=this._get(inst,"nextText"),nextText=navigationAsDateFormat?this.formatDate(nextText,this._daylightSavingAdjust(new Date(drawYear,drawMonth+stepMonths,1)),this._getFormatConfig(inst)):nextText,next=this._canAdjustMonth(inst,1,drawYear,drawMonth)?"<a class='ui-datepicker-next ui-corner-all' data-handler='next' data-event='click' title='"+nextText+"'><span class='ui-icon ui-icon-circle-triangle-"+(isRTL?"w":"e")+"'>"+nextText+"</span></a>":hideIfNoPrevNext?"":"<a class='ui-datepicker-next ui-corner-all ui-state-disabled' title='"+nextText+"'><span class='ui-icon ui-icon-circle-triangle-"+(isRTL?"w":"e")+"'>"+nextText+"</span></a>",currentText=this._get(inst,"currentText"),gotoDate=this._get(inst,"gotoCurrent")&&inst.currentDay?currentDate:today,currentText=navigationAsDateFormat?this.formatDate(currentText,gotoDate,this._getFormatConfig(inst)):currentText,controls=inst.inline?"":"<button type='button' class='ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all' data-handler='hide' data-event='click'>"+this._get(inst,"closeText")+"</button>",buttonPanel=showButtonPanel?"<div class='ui-datepicker-buttonpane ui-widget-content'>"+(isRTL?controls:"")+(this._isInRange(inst,gotoDate)?"<button type='button' class='ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all' data-handler='today' data-event='click'>"+currentText+"</button>":"")+(isRTL?"":controls)+"</div>":"",firstDay=parseInt(this._get(inst,"firstDay"),10),firstDay=isNaN(firstDay)?0:firstDay,showWeek=this._get(inst,"showWeek"),dayNames=this._get(inst,"dayNames"),dayNamesMin=this._get(inst,"dayNamesMin"),monthNames=this._get(inst,"monthNames"),monthNamesShort=this._get(inst,"monthNamesShort"),beforeShowDay=this._get(inst,"beforeShowDay"),showOtherMonths=this._get(inst,"showOtherMonths"),selectOtherMonths=this._get(inst,"selectOtherMonths"),defaultDate=this._getDefaultDate(inst),html="",row=0;row<numMonths[0];row++){for(group="",this.maxRows=4,col=0;col<numMonths[1];col++){if(selectedDate=this._daylightSavingAdjust(new Date(drawYear,drawMonth,inst.selectedDay)),cornerClass=" ui-corner-all",calender="",isMultiMonth){if(calender+="<div class='ui-datepicker-group",numMonths[1]>1)switch(col){case 0:calender+=" ui-datepicker-group-first",cornerClass=" ui-corner-"+(isRTL?"right":"left");break;case numMonths[1]-1:calender+=" ui-datepicker-group-last",cornerClass=" ui-corner-"+(isRTL?"left":"right");break;default:calender+=" ui-datepicker-group-middle",cornerClass=""}calender+="'>"}for(calender+="<div class='ui-datepicker-header ui-widget-header ui-helper-clearfix"+cornerClass+"'>"+(/all|left/.test(cornerClass)&&0===row?isRTL?next:prev:"")+(/all|right/.test(cornerClass)&&0===row?isRTL?prev:next:"")+this._generateMonthYearHeader(inst,drawMonth,drawYear,minDate,maxDate,row>0||col>0,monthNames,monthNamesShort)+"</div><table class='ui-datepicker-calendar'><thead><tr>",thead=showWeek?"<th class='ui-datepicker-week-col'>"+this._get(inst,"weekHeader")+"</th>":"",dow=0;dow<7;dow++)day=(dow+firstDay)%7,thead+="<th scope='col'"+((dow+firstDay+6)%7>=5?" class='ui-datepicker-week-end'":"")+"><span title='"+dayNames[day]+"'>"+dayNamesMin[day]+"</span></th>";for(calender+=thead+"</tr></thead><tbody>",daysInMonth=this._getDaysInMonth(drawYear,drawMonth),drawYear===inst.selectedYear&&drawMonth===inst.selectedMonth&&(inst.selectedDay=Math.min(inst.selectedDay,daysInMonth)),leadDays=(this._getFirstDayOfMonth(drawYear,drawMonth)-firstDay+7)%7,curRows=Math.ceil((leadDays+daysInMonth)/7),numRows=isMultiMonth&&this.maxRows>curRows?this.maxRows:curRows,this.maxRows=numRows,printDate=this._daylightSavingAdjust(new Date(drawYear,drawMonth,1-leadDays)),dRow=0;dRow<numRows;dRow++){for(calender+="<tr>",tbody=showWeek?"<td class='ui-datepicker-week-col'>"+this._get(inst,"calculateWeek")(printDate)+"</td>":"",dow=0;dow<7;dow++)daySettings=beforeShowDay?beforeShowDay.apply(inst.input?inst.input[0]:null,[printDate]):[!0,""],otherMonth=printDate.getMonth()!==drawMonth,unselectable=otherMonth&&!selectOtherMonths||!daySettings[0]||minDate&&printDate<minDate||maxDate&&printDate>maxDate,tbody+="<td class='"+((dow+firstDay+6)%7>=5?" ui-datepicker-week-end":"")+(otherMonth?" ui-datepicker-other-month":"")+(printDate.getTime()===selectedDate.getTime()&&drawMonth===inst.selectedMonth&&inst._keyEvent||defaultDate.getTime()===printDate.getTime()&&defaultDate.getTime()===selectedDate.getTime()?" "+this._dayOverClass:"")+(unselectable?" "+this._unselectableClass+" ui-state-disabled":"")+(otherMonth&&!showOtherMonths?"":" "+daySettings[1]+(printDate.getTime()===currentDate.getTime()?" "+this._currentClass:"")+(printDate.getTime()===today.getTime()?" ui-datepicker-today":""))+"'"+(otherMonth&&!showOtherMonths||!daySettings[2]?"":" title='"+daySettings[2].replace(/'/g,"&#39;")+"'")+(unselectable?"":" data-handler='selectDay' data-event='click' data-month='"+printDate.getMonth()+"' data-year='"+printDate.getFullYear()+"'")+">"+(otherMonth&&!showOtherMonths?"&#xa0;":unselectable?"<span class='ui-state-default'>"+printDate.getDate()+"</span>":"<a class='ui-state-default"+(printDate.getTime()===today.getTime()?" ui-state-highlight":"")+(printDate.getTime()===currentDate.getTime()?" ui-state-active":"")+(otherMonth?" ui-priority-secondary":"")+"' href='#'>"+printDate.getDate()+"</a>")+"</td>",printDate.setDate(printDate.getDate()+1),printDate=this._daylightSavingAdjust(printDate);calender+=tbody+"</tr>"}drawMonth++,drawMonth>11&&(drawMonth=0,drawYear++),calender+="</tbody></table>"+(isMultiMonth?"</div>"+(numMonths[0]>0&&col===numMonths[1]-1?"<div class='ui-datepicker-row-break'></div>":""):""),group+=calender}html+=group}return html+=buttonPanel,inst._keyEvent=!1,html},_generateMonthYearHeader:function(inst,drawMonth,drawYear,minDate,maxDate,secondary,monthNames,monthNamesShort){var inMinYear,inMaxYear,month,years,thisYear,determineYear,year,endYear,changeMonth=this._get(inst,"changeMonth"),changeYear=this._get(inst,"changeYear"),showMonthAfterYear=this._get(inst,"showMonthAfterYear"),html="<div class='ui-datepicker-title'>",monthHtml="";if(secondary||!changeMonth)monthHtml+="<span class='ui-datepicker-month'>"+monthNames[drawMonth]+"</span>";else{for(inMinYear=minDate&&minDate.getFullYear()===drawYear,inMaxYear=maxDate&&maxDate.getFullYear()===drawYear,monthHtml+="<select class='ui-datepicker-month' data-handler='selectMonth' data-event='change'>",month=0;month<12;month++)(!inMinYear||month>=minDate.getMonth())&&(!inMaxYear||month<=maxDate.getMonth())&&(monthHtml+="<option value='"+month+"'"+(month===drawMonth?" selected='selected'":"")+">"+monthNamesShort[month]+"</option>");monthHtml+="</select>"}if(showMonthAfterYear||(html+=monthHtml+(!secondary&&changeMonth&&changeYear?"":"&#xa0;")),!inst.yearshtml)if(inst.yearshtml="",secondary||!changeYear)html+="<span class='ui-datepicker-year'>"+drawYear+"</span>";else{for(years=this._get(inst,"yearRange").split(":"),thisYear=(new Date).getFullYear(),determineYear=function(value){var year=value.match(/c[+\-].*/)?drawYear+parseInt(value.substring(1),10):value.match(/[+\-].*/)?thisYear+parseInt(value,10):parseInt(value,10);return isNaN(year)?thisYear:year},year=determineYear(years[0]),endYear=Math.max(year,determineYear(years[1]||"")),year=minDate?Math.max(year,minDate.getFullYear()):year,endYear=maxDate?Math.min(endYear,maxDate.getFullYear()):endYear,inst.yearshtml+="<select class='ui-datepicker-year' data-handler='selectYear' data-event='change'>";year<=endYear;year++)inst.yearshtml+="<option value='"+year+"'"+(year===drawYear?" selected='selected'":"")+">"+year+"</option>";inst.yearshtml+="</select>",html+=inst.yearshtml,inst.yearshtml=null}return html+=this._get(inst,"yearSuffix"),showMonthAfterYear&&(html+=(!secondary&&changeMonth&&changeYear?"":"&#xa0;")+monthHtml),html+="</div>"},_adjustInstDate:function(inst,offset,period){var year=inst.drawYear+("Y"===period?offset:0),month=inst.drawMonth+("M"===period?offset:0),day=Math.min(inst.selectedDay,this._getDaysInMonth(year,month))+("D"===period?offset:0),date=this._restrictMinMax(inst,this._daylightSavingAdjust(new Date(year,month,day)));inst.selectedDay=date.getDate(),inst.drawMonth=inst.selectedMonth=date.getMonth(),inst.drawYear=inst.selectedYear=date.getFullYear(),"M"!==period&&"Y"!==period||this._notifyChange(inst)},_restrictMinMax:function(inst,date){var minDate=this._getMinMaxDate(inst,"min"),maxDate=this._getMinMaxDate(inst,"max"),newDate=minDate&&date<minDate?minDate:date;return maxDate&&newDate>maxDate?maxDate:newDate},_notifyChange:function(inst){var onChange=this._get(inst,"onChangeMonthYear");onChange&&onChange.apply(inst.input?inst.input[0]:null,[inst.selectedYear,inst.selectedMonth+1,inst])},_getNumberOfMonths:function(inst){var numMonths=this._get(inst,"numberOfMonths");return null==numMonths?[1,1]:"number"==typeof numMonths?[1,numMonths]:numMonths},_getMinMaxDate:function(inst,minMax){return this._determineDate(inst,this._get(inst,minMax+"Date"),null)},_getDaysInMonth:function(year,month){return 32-this._daylightSavingAdjust(new Date(year,month,32)).getDate()},_getFirstDayOfMonth:function(year,month){return new Date(year,month,1).getDay()},_canAdjustMonth:function(inst,offset,curYear,curMonth){var numMonths=this._getNumberOfMonths(inst),date=this._daylightSavingAdjust(new Date(curYear,curMonth+(offset<0?offset:numMonths[0]*numMonths[1]),1));return offset<0&&date.setDate(this._getDaysInMonth(date.getFullYear(),date.getMonth())),this._isInRange(inst,date)},_isInRange:function(inst,date){var yearSplit,currentYear,minDate=this._getMinMaxDate(inst,"min"),maxDate=this._getMinMaxDate(inst,"max"),minYear=null,maxYear=null,years=this._get(inst,"yearRange");return years&&(yearSplit=years.split(":"),currentYear=(new Date).getFullYear(),minYear=parseInt(yearSplit[0],10),maxYear=parseInt(yearSplit[1],10),yearSplit[0].match(/[+\-].*/)&&(minYear+=currentYear),
yearSplit[1].match(/[+\-].*/)&&(maxYear+=currentYear)),(!minDate||date.getTime()>=minDate.getTime())&&(!maxDate||date.getTime()<=maxDate.getTime())&&(!minYear||date.getFullYear()>=minYear)&&(!maxYear||date.getFullYear()<=maxYear)},_getFormatConfig:function(inst){var shortYearCutoff=this._get(inst,"shortYearCutoff");return shortYearCutoff="string"!=typeof shortYearCutoff?shortYearCutoff:(new Date).getFullYear()%100+parseInt(shortYearCutoff,10),{shortYearCutoff:shortYearCutoff,dayNamesShort:this._get(inst,"dayNamesShort"),dayNames:this._get(inst,"dayNames"),monthNamesShort:this._get(inst,"monthNamesShort"),monthNames:this._get(inst,"monthNames")}},_formatDate:function(inst,day,month,year){day||(inst.currentDay=inst.selectedDay,inst.currentMonth=inst.selectedMonth,inst.currentYear=inst.selectedYear);var date=day?"object"==typeof day?day:this._daylightSavingAdjust(new Date(year,month,day)):this._daylightSavingAdjust(new Date(inst.currentYear,inst.currentMonth,inst.currentDay));return this.formatDate(this._get(inst,"dateFormat"),date,this._getFormatConfig(inst))}});function datepicker_bindHover(dpDiv){var selector="button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";return dpDiv.delegate(selector,"mouseout",function(){$(this).removeClass("ui-state-hover"),-1!==this.className.indexOf("ui-datepicker-prev")&&$(this).removeClass("ui-datepicker-prev-hover"),-1!==this.className.indexOf("ui-datepicker-next")&&$(this).removeClass("ui-datepicker-next-hover")}).delegate(selector,"mouseover",datepicker_handleMouseover)}function datepicker_handleMouseover(){$.datepicker._isDisabledDatepicker(datepicker_instActive.inline?datepicker_instActive.dpDiv.parent()[0]:datepicker_instActive.input[0])||($(this).parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover"),$(this).addClass("ui-state-hover"),-1!==this.className.indexOf("ui-datepicker-prev")&&$(this).addClass("ui-datepicker-prev-hover"),-1!==this.className.indexOf("ui-datepicker-next")&&$(this).addClass("ui-datepicker-next-hover"))}function datepicker_extendRemove(target,props){$.extend(target,props);for(var name in props)null==props[name]&&(target[name]=props[name]);return target}$.fn.datepicker=function(options){if(!this.length)return this;$.datepicker.initialized||($(document).mousedown($.datepicker._checkExternalClick),$.datepicker.initialized=!0),0===$("#"+$.datepicker._mainDivId).length&&$("body").append($.datepicker.dpDiv);var otherArgs=Array.prototype.slice.call(arguments,1);return"string"!=typeof options||"isDisabled"!==options&&"getDate"!==options&&"widget"!==options?"option"===options&&2===arguments.length&&"string"==typeof arguments[1]?$.datepicker["_"+options+"Datepicker"].apply($.datepicker,[this[0]].concat(otherArgs)):this.each(function(){"string"==typeof options?$.datepicker["_"+options+"Datepicker"].apply($.datepicker,[this].concat(otherArgs)):$.datepicker._attachDatepicker(this,options)}):$.datepicker["_"+options+"Datepicker"].apply($.datepicker,[this[0]].concat(otherArgs))},$.datepicker=new Datepicker,$.datepicker.initialized=!1,$.datepicker.uuid=(new Date).getTime(),$.datepicker.version="1.11.4";$.datepicker,$.widget("ui.dialog",{version:"1.11.4",options:{appendTo:"body",autoOpen:!0,buttons:[],closeOnEscape:!0,closeText:"Close",dialogClass:"",draggable:!0,hide:null,height:"auto",maxHeight:null,maxWidth:null,minHeight:150,minWidth:150,modal:!1,position:{my:"center",at:"center",of:window,collision:"fit",using:function(pos){var topOffset=$(this).css(pos).offset().top;topOffset<0&&$(this).css("top",pos.top-topOffset)}},resizable:!0,show:null,title:null,width:300,beforeClose:null,close:null,drag:null,dragStart:null,dragStop:null,focus:null,open:null,resize:null,resizeStart:null,resizeStop:null},sizeRelatedOptions:{buttons:!0,height:!0,maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0,width:!0},resizableRelatedOptions:{maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0},_create:function(){this.originalCss={display:this.element[0].style.display,width:this.element[0].style.width,minHeight:this.element[0].style.minHeight,maxHeight:this.element[0].style.maxHeight,height:this.element[0].style.height},this.originalPosition={parent:this.element.parent(),index:this.element.parent().children().index(this.element)},this.originalTitle=this.element.attr("title"),this.options.title=this.options.title||this.originalTitle,this._createWrapper(),this.element.show().removeAttr("title").addClass("ui-dialog-content ui-widget-content").appendTo(this.uiDialog),this._createTitlebar(),this._createButtonPane(),this.options.draggable&&$.fn.draggable&&this._makeDraggable(),this.options.resizable&&$.fn.resizable&&this._makeResizable(),this._isOpen=!1,this._trackFocus()},_init:function(){this.options.autoOpen&&this.open()},_appendTo:function(){var element=this.options.appendTo;return element&&(element.jquery||element.nodeType)?$(element):this.document.find(element||"body").eq(0)},_destroy:function(){var next,originalPosition=this.originalPosition;this._untrackInstance(),this._destroyOverlay(),this.element.removeUniqueId().removeClass("ui-dialog-content ui-widget-content").css(this.originalCss).detach(),this.uiDialog.stop(!0,!0).remove(),this.originalTitle&&this.element.attr("title",this.originalTitle),next=originalPosition.parent.children().eq(originalPosition.index),next.length&&next[0]!==this.element[0]?next.before(this.element):originalPosition.parent.append(this.element)},widget:function(){return this.uiDialog},disable:$.noop,enable:$.noop,close:function(event){var activeElement,that=this;if(this._isOpen&&!1!==this._trigger("beforeClose",event)){if(this._isOpen=!1,this._focusedElement=null,this._destroyOverlay(),this._untrackInstance(),!this.opener.filter(":focusable").focus().length)try{activeElement=this.document[0].activeElement,activeElement&&"body"!==activeElement.nodeName.toLowerCase()&&$(activeElement).blur()}catch(error){}this._hide(this.uiDialog,this.options.hide,function(){that._trigger("close",event)})}},isOpen:function(){return this._isOpen},moveToTop:function(){this._moveToTop()},_moveToTop:function(event,silent){var moved=!1,zIndices=this.uiDialog.siblings(".ui-front:visible").map(function(){return+$(this).css("z-index")}).get(),zIndexMax=Math.max.apply(null,zIndices);return zIndexMax>=+this.uiDialog.css("z-index")&&(this.uiDialog.css("z-index",zIndexMax+1),moved=!0),moved&&!silent&&this._trigger("focus",event),moved},open:function(){var that=this;if(this._isOpen)return void(this._moveToTop()&&this._focusTabbable());this._isOpen=!0,this.opener=$(this.document[0].activeElement),this._size(),this._position(),this._createOverlay(),this._moveToTop(null,!0),this.overlay&&this.overlay.css("z-index",this.uiDialog.css("z-index")-1),this._show(this.uiDialog,this.options.show,function(){that._focusTabbable(),that._trigger("focus")}),this._makeFocusTarget(),this._trigger("open")},_focusTabbable:function(){var hasFocus=this._focusedElement;hasFocus||(hasFocus=this.element.find("[autofocus]")),hasFocus.length||(hasFocus=this.element.find(":tabbable")),hasFocus.length||(hasFocus=this.uiDialogButtonPane.find(":tabbable")),hasFocus.length||(hasFocus=this.uiDialogTitlebarClose.filter(":tabbable")),hasFocus.length||(hasFocus=this.uiDialog),hasFocus.eq(0).focus()},_keepFocus:function(event){function checkFocus(){var activeElement=this.document[0].activeElement;this.uiDialog[0]===activeElement||$.contains(this.uiDialog[0],activeElement)||this._focusTabbable()}event.preventDefault(),checkFocus.call(this),this._delay(checkFocus)},_createWrapper:function(){this.uiDialog=$("<div>").addClass("ui-dialog ui-widget ui-widget-content ui-corner-all ui-front "+this.options.dialogClass).hide().attr({tabIndex:-1,role:"dialog"}).appendTo(this._appendTo()),this._on(this.uiDialog,{keydown:function(event){if(this.options.closeOnEscape&&!event.isDefaultPrevented()&&event.keyCode&&event.keyCode===$.ui.keyCode.ESCAPE)return event.preventDefault(),void this.close(event);if(event.keyCode===$.ui.keyCode.TAB&&!event.isDefaultPrevented()){var tabbables=this.uiDialog.find(":tabbable"),first=tabbables.filter(":first"),last=tabbables.filter(":last");event.target!==last[0]&&event.target!==this.uiDialog[0]||event.shiftKey?event.target!==first[0]&&event.target!==this.uiDialog[0]||!event.shiftKey||(this._delay(function(){last.focus()}),event.preventDefault()):(this._delay(function(){first.focus()}),event.preventDefault())}},mousedown:function(event){this._moveToTop(event)&&this._focusTabbable()}}),this.element.find("[aria-describedby]").length||this.uiDialog.attr({"aria-describedby":this.element.uniqueId().attr("id")})},_createTitlebar:function(){var uiDialogTitle;this.uiDialogTitlebar=$("<div>").addClass("ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix").prependTo(this.uiDialog),this._on(this.uiDialogTitlebar,{mousedown:function(event){$(event.target).closest(".ui-dialog-titlebar-close")||this.uiDialog.focus()}}),this.uiDialogTitlebarClose=$("<button type='button'></button>").button({label:this.options.closeText,icons:{primary:"ui-icon-closethick"},text:!1}).addClass("ui-dialog-titlebar-close").appendTo(this.uiDialogTitlebar),this._on(this.uiDialogTitlebarClose,{click:function(event){event.preventDefault(),this.close(event)}}),uiDialogTitle=$("<span>").uniqueId().addClass("ui-dialog-title").prependTo(this.uiDialogTitlebar),this._title(uiDialogTitle),this.uiDialog.attr({"aria-labelledby":uiDialogTitle.attr("id")})},_title:function(title){this.options.title||title.html("&#160;"),title.text(this.options.title)},_createButtonPane:function(){this.uiDialogButtonPane=$("<div>").addClass("ui-dialog-buttonpane ui-widget-content ui-helper-clearfix"),this.uiButtonSet=$("<div>").addClass("ui-dialog-buttonset").appendTo(this.uiDialogButtonPane),this._createButtons()},_createButtons:function(){var that=this,buttons=this.options.buttons;if(this.uiDialogButtonPane.remove(),this.uiButtonSet.empty(),$.isEmptyObject(buttons)||$.isArray(buttons)&&!buttons.length)return void this.uiDialog.removeClass("ui-dialog-buttons");$.each(buttons,function(name,props){var click,buttonOptions;props=$.isFunction(props)?{click:props,text:name}:props,props=$.extend({type:"button"},props),click=props.click,props.click=function(){click.apply(that.element[0],arguments)},buttonOptions={icons:props.icons,text:props.showText},delete props.icons,delete props.showText,$("<button></button>",props).button(buttonOptions).appendTo(that.uiButtonSet)}),this.uiDialog.addClass("ui-dialog-buttons"),this.uiDialogButtonPane.appendTo(this.uiDialog)},_makeDraggable:function(){var that=this,options=this.options;function filteredUi(ui){return{position:ui.position,offset:ui.offset}}this.uiDialog.draggable({cancel:".ui-dialog-content, .ui-dialog-titlebar-close",handle:".ui-dialog-titlebar",containment:"document",start:function(event,ui){$(this).addClass("ui-dialog-dragging"),that._blockFrames(),that._trigger("dragStart",event,filteredUi(ui))},drag:function(event,ui){that._trigger("drag",event,filteredUi(ui))},stop:function(event,ui){var left=ui.offset.left-that.document.scrollLeft(),top=ui.offset.top-that.document.scrollTop();options.position={my:"left top",at:"left"+(left>=0?"+":"")+left+" top"+(top>=0?"+":"")+top,of:that.window},$(this).removeClass("ui-dialog-dragging"),that._unblockFrames(),that._trigger("dragStop",event,filteredUi(ui))}})},_makeResizable:function(){var that=this,options=this.options,handles=options.resizable,position=this.uiDialog.css("position"),resizeHandles="string"==typeof handles?handles:"n,e,s,w,se,sw,ne,nw";function filteredUi(ui){return{originalPosition:ui.originalPosition,originalSize:ui.originalSize,position:ui.position,size:ui.size}}this.uiDialog.resizable({cancel:".ui-dialog-content",containment:"document",alsoResize:this.element,maxWidth:options.maxWidth,maxHeight:options.maxHeight,minWidth:options.minWidth,minHeight:this._minHeight(),handles:resizeHandles,start:function(event,ui){$(this).addClass("ui-dialog-resizing"),that._blockFrames(),that._trigger("resizeStart",event,filteredUi(ui))},resize:function(event,ui){that._trigger("resize",event,filteredUi(ui))},stop:function(event,ui){var offset=that.uiDialog.offset(),left=offset.left-that.document.scrollLeft(),top=offset.top-that.document.scrollTop();options.height=that.uiDialog.height(),options.width=that.uiDialog.width(),options.position={my:"left top",at:"left"+(left>=0?"+":"")+left+" top"+(top>=0?"+":"")+top,of:that.window},$(this).removeClass("ui-dialog-resizing"),that._unblockFrames(),that._trigger("resizeStop",event,filteredUi(ui))}}).css("position",position)},_trackFocus:function(){this._on(this.widget(),{focusin:function(event){this._makeFocusTarget(),this._focusedElement=$(event.target)}})},_makeFocusTarget:function(){this._untrackInstance(),this._trackingInstances().unshift(this)},_untrackInstance:function(){var instances=this._trackingInstances(),exists=$.inArray(this,instances);-1!==exists&&instances.splice(exists,1)},_trackingInstances:function(){var instances=this.document.data("ui-dialog-instances");return instances||(instances=[],this.document.data("ui-dialog-instances",instances)),instances},_minHeight:function(){var options=this.options;return"auto"===options.height?options.minHeight:Math.min(options.minHeight,options.height)},_position:function(){var isVisible=this.uiDialog.is(":visible");isVisible||this.uiDialog.show(),this.uiDialog.position(this.options.position),isVisible||this.uiDialog.hide()},_setOptions:function(options){var that=this,resize=!1,resizableOptions={};$.each(options,function(key,value){that._setOption(key,value),key in that.sizeRelatedOptions&&(resize=!0),key in that.resizableRelatedOptions&&(resizableOptions[key]=value)}),resize&&(this._size(),this._position()),this.uiDialog.is(":data(ui-resizable)")&&this.uiDialog.resizable("option",resizableOptions)},_setOption:function(key,value){var isDraggable,isResizable,uiDialog=this.uiDialog;"dialogClass"===key&&uiDialog.removeClass(this.options.dialogClass).addClass(value),"disabled"!==key&&(this._super(key,value),"appendTo"===key&&this.uiDialog.appendTo(this._appendTo()),"buttons"===key&&this._createButtons(),"closeText"===key&&this.uiDialogTitlebarClose.button({label:""+value}),"draggable"===key&&(isDraggable=uiDialog.is(":data(ui-draggable)"),isDraggable&&!value&&uiDialog.draggable("destroy"),!isDraggable&&value&&this._makeDraggable()),"position"===key&&this._position(),"resizable"===key&&(isResizable=uiDialog.is(":data(ui-resizable)"),isResizable&&!value&&uiDialog.resizable("destroy"),isResizable&&"string"==typeof value&&uiDialog.resizable("option","handles",value),isResizable||!1===value||this._makeResizable()),"title"===key&&this._title(this.uiDialogTitlebar.find(".ui-dialog-title")))},_size:function(){var nonContentHeight,minContentHeight,maxContentHeight,options=this.options;this.element.show().css({width:"auto",minHeight:0,maxHeight:"none",height:0}),options.minWidth>options.width&&(options.width=options.minWidth),nonContentHeight=this.uiDialog.css({height:"auto",width:options.width}).outerHeight(),minContentHeight=Math.max(0,options.minHeight-nonContentHeight),maxContentHeight="number"==typeof options.maxHeight?Math.max(0,options.maxHeight-nonContentHeight):"none","auto"===options.height?this.element.css({minHeight:minContentHeight,maxHeight:maxContentHeight,height:"auto"}):this.element.height(Math.max(0,options.height-nonContentHeight)),this.uiDialog.is(":data(ui-resizable)")&&this.uiDialog.resizable("option","minHeight",this._minHeight())},_blockFrames:function(){this.iframeBlocks=this.document.find("iframe").map(function(){var iframe=$(this);return $("<div>").css({position:"absolute",width:iframe.outerWidth(),height:iframe.outerHeight()}).appendTo(iframe.parent()).offset(iframe.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_allowInteraction:function(event){return!!$(event.target).closest(".ui-dialog").length||!!$(event.target).closest(".ui-datepicker").length},_createOverlay:function(){if(this.options.modal){var isOpening=!0;this._delay(function(){isOpening=!1}),this.document.data("ui-dialog-overlays")||this._on(this.document,{focusin:function(event){isOpening||this._allowInteraction(event)||(event.preventDefault(),this._trackingInstances()[0]._focusTabbable())}}),this.overlay=$("<div>").addClass("ui-widget-overlay ui-front").appendTo(this._appendTo()),this._on(this.overlay,{mousedown:"_keepFocus"}),this.document.data("ui-dialog-overlays",(this.document.data("ui-dialog-overlays")||0)+1)}},_destroyOverlay:function(){if(this.options.modal&&this.overlay){var overlays=this.document.data("ui-dialog-overlays")-1;overlays?this.document.data("ui-dialog-overlays",overlays):this.document.unbind("focusin").removeData("ui-dialog-overlays"),this.overlay.remove(),this.overlay=null}}}),$.widget("ui.progressbar",{version:"1.11.4",options:{max:100,value:0,change:null,complete:null},min:0,_create:function(){this.oldValue=this.options.value=this._constrainedValue(),this.element.addClass("ui-progressbar ui-widget ui-widget-content ui-corner-all").attr({role:"progressbar","aria-valuemin":this.min}),this.valueDiv=$("<div class='ui-progressbar-value ui-widget-header ui-corner-left'></div>").appendTo(this.element),this._refreshValue()},_destroy:function(){this.element.removeClass("ui-progressbar ui-widget ui-widget-content ui-corner-all").removeAttr("role").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuenow"),this.valueDiv.remove()},value:function(newValue){if(void 0===newValue)return this.options.value;this.options.value=this._constrainedValue(newValue),this._refreshValue()},_constrainedValue:function(newValue){return void 0===newValue&&(newValue=this.options.value),this.indeterminate=!1===newValue,"number"!=typeof newValue&&(newValue=0),!this.indeterminate&&Math.min(this.options.max,Math.max(this.min,newValue))},_setOptions:function(options){var value=options.value;delete options.value,this._super(options),this.options.value=this._constrainedValue(value),this._refreshValue()},_setOption:function(key,value){"max"===key&&(value=Math.max(this.min,value)),"disabled"===key&&this.element.toggleClass("ui-state-disabled",!!value).attr("aria-disabled",value),this._super(key,value)},_percentage:function(){return this.indeterminate?100:100*(this.options.value-this.min)/(this.options.max-this.min)},_refreshValue:function(){var value=this.options.value,percentage=this._percentage();this.valueDiv.toggle(this.indeterminate||value>this.min).toggleClass("ui-corner-right",value===this.options.max).width(percentage.toFixed(0)+"%"),this.element.toggleClass("ui-progressbar-indeterminate",this.indeterminate),this.indeterminate?(this.element.removeAttr("aria-valuenow"),this.overlayDiv||(this.overlayDiv=$("<div class='ui-progressbar-overlay'></div>").appendTo(this.valueDiv))):(this.element.attr({"aria-valuemax":this.options.max,"aria-valuenow":value}),this.overlayDiv&&(this.overlayDiv.remove(),this.overlayDiv=null)),this.oldValue!==value&&(this.oldValue=value,this._trigger("change")),value===this.options.max&&this._trigger("complete")}}),$.widget("ui.selectmenu",{version:"1.11.4",defaultElement:"<select>",options:{appendTo:null,disabled:null,icons:{button:"ui-icon-triangle-1-s"},position:{my:"left top",at:"left bottom",collision:"none"},width:null,change:null,close:null,focus:null,open:null,select:null},_create:function(){var selectmenuId=this.element.uniqueId().attr("id");this.ids={element:selectmenuId,button:selectmenuId+"-button",menu:selectmenuId+"-menu"},this._drawButton(),this._drawMenu(),this.options.disabled&&this.disable()},_drawButton:function(){var that=this;this.label=$("label[for='"+this.ids.element+"']").attr("for",this.ids.button),this._on(this.label,{click:function(event){this.button.focus(),event.preventDefault()}}),this.element.hide(),this.button=$("<span>",{class:"ui-selectmenu-button ui-widget ui-state-default ui-corner-all",tabindex:this.options.disabled?-1:0,id:this.ids.button,role:"combobox","aria-expanded":"false","aria-autocomplete":"list","aria-owns":this.ids.menu,"aria-haspopup":"true"}).insertAfter(this.element),$("<span>",{class:"ui-icon "+this.options.icons.button}).prependTo(this.button),this.buttonText=$("<span>",{class:"ui-selectmenu-text"}).appendTo(this.button),this._setText(this.buttonText,this.element.find("option:selected").text()),this._resizeButton(),this._on(this.button,this._buttonEvents),this.button.one("focusin",function(){that.menuItems||that._refreshMenu()}),this._hoverable(this.button),this._focusable(this.button)},_drawMenu:function(){var that=this;this.menu=$("<ul>",{"aria-hidden":"true","aria-labelledby":this.ids.button,id:this.ids.menu}),this.menuWrap=$("<div>",{class:"ui-selectmenu-menu ui-front"}).append(this.menu).appendTo(this._appendTo()),this.menuInstance=this.menu.menu({role:"listbox",select:function(event,ui){event.preventDefault(),that._setSelection(),that._select(ui.item.data("ui-selectmenu-item"),event)},focus:function(event,ui){var item=ui.item.data("ui-selectmenu-item");null!=that.focusIndex&&item.index!==that.focusIndex&&(that._trigger("focus",event,{item:item}),that.isOpen||that._select(item,event)),that.focusIndex=item.index,that.button.attr("aria-activedescendant",that.menuItems.eq(item.index).attr("id"))}}).menu("instance"),this.menu.addClass("ui-corner-bottom").removeClass("ui-corner-all"),this.menuInstance._off(this.menu,"mouseleave"),this.menuInstance._closeOnDocumentClick=function(){return!1},this.menuInstance._isDivider=function(){return!1}},refresh:function(){this._refreshMenu(),this._setText(this.buttonText,this._getSelectedItem().text()),this.options.width||this._resizeButton()},_refreshMenu:function(){this.menu.empty();var item,options=this.element.find("option");options.length&&(this._parseOptions(options),this._renderMenu(this.menu,this.items),this.menuInstance.refresh(),this.menuItems=this.menu.find("li").not(".ui-selectmenu-optgroup"),item=this._getSelectedItem(),this.menuInstance.focus(null,item),this._setAria(item.data("ui-selectmenu-item")),this._setOption("disabled",this.element.prop("disabled")))},open:function(event){this.options.disabled||(this.menuItems?(this.menu.find(".ui-state-focus").removeClass("ui-state-focus"),this.menuInstance.focus(null,this._getSelectedItem())):this._refreshMenu(),this.isOpen=!0,this._toggleAttr(),this._resizeMenu(),this._position(),this._on(this.document,this._documentClick),this._trigger("open",event))},_position:function(){this.menuWrap.position($.extend({of:this.button},this.options.position))},close:function(event){this.isOpen&&(this.isOpen=!1,this._toggleAttr(),this.range=null,this._off(this.document),this._trigger("close",event))},widget:function(){return this.button},menuWidget:function(){return this.menu},_renderMenu:function(ul,items){var that=this,currentOptgroup="";$.each(items,function(index,item){item.optgroup!==currentOptgroup&&($("<li>",{class:"ui-selectmenu-optgroup ui-menu-divider"+(item.element.parent("optgroup").prop("disabled")?" ui-state-disabled":""),text:item.optgroup}).appendTo(ul),currentOptgroup=item.optgroup),that._renderItemData(ul,item)})},_renderItemData:function(ul,item){return this._renderItem(ul,item).data("ui-selectmenu-item",item)},_renderItem:function(ul,item){var li=$("<li>");return item.disabled&&li.addClass("ui-state-disabled"),this._setText(li,item.label),li.appendTo(ul)},_setText:function(element,value){value?element.text(value):element.html("&#160;")},_move:function(direction,event){var item,next,filter=".ui-menu-item";this.isOpen?item=this.menuItems.eq(this.focusIndex):(item=this.menuItems.eq(this.element[0].selectedIndex),filter+=":not(.ui-state-disabled)"),next="first"===direction||"last"===direction?item["first"===direction?"prevAll":"nextAll"](filter).eq(-1):item[direction+"All"](filter).eq(0),next.length&&this.menuInstance.focus(event,next)},_getSelectedItem:function(){return this.menuItems.eq(this.element[0].selectedIndex)},_toggle:function(event){this[this.isOpen?"close":"open"](event)},_setSelection:function(){var selection;this.range&&(window.getSelection?(selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(this.range)):this.range.select(),this.button.focus())},_documentClick:{mousedown:function(event){this.isOpen&&($(event.target).closest(".ui-selectmenu-menu, #"+this.ids.button).length||this.close(event))}},_buttonEvents:{mousedown:function(){var selection;window.getSelection?(selection=window.getSelection(),selection.rangeCount&&(this.range=selection.getRangeAt(0))):this.range=document.selection.createRange()},click:function(event){this._setSelection(),this._toggle(event)},keydown:function(event){var preventDefault=!0;switch(event.keyCode){case $.ui.keyCode.TAB:case $.ui.keyCode.ESCAPE:this.close(event),preventDefault=!1;break;case $.ui.keyCode.ENTER:this.isOpen&&this._selectFocusedItem(event);break;case $.ui.keyCode.UP:event.altKey?this._toggle(event):this._move("prev",event);break;case $.ui.keyCode.DOWN:event.altKey?this._toggle(event):this._move("next",event);break;case $.ui.keyCode.SPACE:this.isOpen?this._selectFocusedItem(event):this._toggle(event);break;case $.ui.keyCode.LEFT:this._move("prev",event);break;case $.ui.keyCode.RIGHT:this._move("next",event);break;case $.ui.keyCode.HOME:case $.ui.keyCode.PAGE_UP:this._move("first",event);break;case $.ui.keyCode.END:case $.ui.keyCode.PAGE_DOWN:this._move("last",event);break;default:this.menu.trigger(event),preventDefault=!1}preventDefault&&event.preventDefault()}},_selectFocusedItem:function(event){var item=this.menuItems.eq(this.focusIndex);item.hasClass("ui-state-disabled")||this._select(item.data("ui-selectmenu-item"),event)},_select:function(item,event){var oldIndex=this.element[0].selectedIndex;this.element[0].selectedIndex=item.index,this._setText(this.buttonText,item.label),this._setAria(item),this._trigger("select",event,{item:item}),item.index!==oldIndex&&this._trigger("change",event,{item:item}),this.close(event)},_setAria:function(item){var id=this.menuItems.eq(item.index).attr("id");this.button.attr({"aria-labelledby":id,"aria-activedescendant":id}),this.menu.attr("aria-activedescendant",id)},_setOption:function(key,value){"icons"===key&&this.button.find("span.ui-icon").removeClass(this.options.icons.button).addClass(value.button),this._super(key,value),"appendTo"===key&&this.menuWrap.appendTo(this._appendTo()),"disabled"===key&&(this.menuInstance.option("disabled",value),this.button.toggleClass("ui-state-disabled",value).attr("aria-disabled",value),this.element.prop("disabled",value),value?(this.button.attr("tabindex",-1),this.close()):this.button.attr("tabindex",0)),"width"===key&&this._resizeButton()},_appendTo:function(){var element=this.options.appendTo;return element&&(element=element.jquery||element.nodeType?$(element):this.document.find(element).eq(0)),element&&element[0]||(element=this.element.closest(".ui-front")),element.length||(element=this.document[0].body),element},_toggleAttr:function(){this.button.toggleClass("ui-corner-top",this.isOpen).toggleClass("ui-corner-all",!this.isOpen).attr("aria-expanded",this.isOpen),this.menuWrap.toggleClass("ui-selectmenu-open",this.isOpen),this.menu.attr("aria-hidden",!this.isOpen)},_resizeButton:function(){var width=this.options.width;width||(width=this.element.show().outerWidth(),this.element.hide()),this.button.outerWidth(width)},_resizeMenu:function(){this.menu.outerWidth(Math.max(this.button.outerWidth(),this.menu.width("").outerWidth()+1))},_getCreateOptions:function(){return{disabled:this.element.prop("disabled")}},_parseOptions:function(options){var data=[];options.each(function(index,item){var option=$(item),optgroup=option.parent("optgroup");data.push({element:option,index:index,value:option.val(),label:option.text(),optgroup:optgroup.attr("label")||"",disabled:optgroup.prop("disabled")||option.prop("disabled")})}),this.items=data},_destroy:function(){this.menuWrap.remove(),this.button.remove(),this.element.show(),this.element.removeUniqueId(),this.label.attr("for",this.ids.element)}}),$.widget("ui.slider",$.ui.mouse,{version:"1.11.4",widgetEventPrefix:"slide",options:{animate:!1,distance:0,max:100,min:0,orientation:"horizontal",range:!1,step:1,value:0,values:null,change:null,slide:null,start:null,stop:null},numPages:5,_create:function(){this._keySliding=!1,this._mouseSliding=!1,this._animateOff=!0,this._handleIndex=null,this._detectOrientation(),this._mouseInit(),this._calculateNewMax(),this.element.addClass("ui-slider ui-slider-"+this.orientation+" ui-widget ui-widget-content ui-corner-all"),this._refresh(),this._setOption("disabled",this.options.disabled),this._animateOff=!1},_refresh:function(){this._createRange(),this._createHandles(),this._setupEvents(),this._refreshValue()},_createHandles:function(){var i,handleCount,options=this.options,existingHandles=this.element.find(".ui-slider-handle").addClass("ui-state-default ui-corner-all"),handles=[];for(handleCount=options.values&&options.values.length||1,existingHandles.length>handleCount&&(existingHandles.slice(handleCount).remove(),existingHandles=existingHandles.slice(0,handleCount)),i=existingHandles.length;i<handleCount;i++)handles.push("<span class='ui-slider-handle ui-state-default ui-corner-all' tabindex='0'></span>");this.handles=existingHandles.add($(handles.join("")).appendTo(this.element)),this.handle=this.handles.eq(0),this.handles.each(function(i){$(this).data("ui-slider-handle-index",i)})},_createRange:function(){var options=this.options,classes="";options.range?(!0===options.range&&(options.values?options.values.length&&2!==options.values.length?options.values=[options.values[0],options.values[0]]:$.isArray(options.values)&&(options.values=options.values.slice(0)):options.values=[this._valueMin(),this._valueMin()]),this.range&&this.range.length?this.range.removeClass("ui-slider-range-min ui-slider-range-max").css({left:"",bottom:""}):(this.range=$("<div></div>").appendTo(this.element),classes="ui-slider-range ui-widget-header ui-corner-all"),this.range.addClass(classes+("min"===options.range||"max"===options.range?" ui-slider-range-"+options.range:""))):(this.range&&this.range.remove(),this.range=null)},_setupEvents:function(){this._off(this.handles),this._on(this.handles,this._handleEvents),this._hoverable(this.handles),this._focusable(this.handles)},_destroy:function(){this.handles.remove(),this.range&&this.range.remove(),this.element.removeClass("ui-slider ui-slider-horizontal ui-slider-vertical ui-widget ui-widget-content ui-corner-all"),this._mouseDestroy()},_mouseCapture:function(event){var position,normValue,distance,closestHandle,index,offset,mouseOverHandle,that=this,o=this.options;return!o.disabled&&(this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()},this.elementOffset=this.element.offset(),position={x:event.pageX,y:event.pageY},normValue=this._normValueFromMouse(position),distance=this._valueMax()-this._valueMin()+1,this.handles.each(function(i){var thisDistance=Math.abs(normValue-that.values(i));(distance>thisDistance||distance===thisDistance&&(i===that._lastChangedValue||that.values(i)===o.min))&&(distance=thisDistance,closestHandle=$(this),index=i)}),!1!==this._start(event,index)&&(this._mouseSliding=!0,this._handleIndex=index,closestHandle.addClass("ui-state-active").focus(),offset=closestHandle.offset(),mouseOverHandle=!$(event.target).parents().addBack().is(".ui-slider-handle"),this._clickOffset=mouseOverHandle?{left:0,top:0}:{left:event.pageX-offset.left-closestHandle.width()/2,top:event.pageY-offset.top-closestHandle.height()/2-(parseInt(closestHandle.css("borderTopWidth"),10)||0)-(parseInt(closestHandle.css("borderBottomWidth"),10)||0)+(parseInt(closestHandle.css("marginTop"),10)||0)},this.handles.hasClass("ui-state-hover")||this._slide(event,index,normValue),this._animateOff=!0,!0))},_mouseStart:function(){return!0},_mouseDrag:function(event){var position={x:event.pageX,y:event.pageY
},normValue=this._normValueFromMouse(position);return this._slide(event,this._handleIndex,normValue),!1},_mouseStop:function(event){return this.handles.removeClass("ui-state-active"),this._mouseSliding=!1,this._stop(event,this._handleIndex),this._change(event,this._handleIndex),this._handleIndex=null,this._clickOffset=null,this._animateOff=!1,!1},_detectOrientation:function(){this.orientation="vertical"===this.options.orientation?"vertical":"horizontal"},_normValueFromMouse:function(position){var pixelTotal,pixelMouse,percentMouse,valueTotal,valueMouse;return"horizontal"===this.orientation?(pixelTotal=this.elementSize.width,pixelMouse=position.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)):(pixelTotal=this.elementSize.height,pixelMouse=position.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)),percentMouse=pixelMouse/pixelTotal,percentMouse>1&&(percentMouse=1),percentMouse<0&&(percentMouse=0),"vertical"===this.orientation&&(percentMouse=1-percentMouse),valueTotal=this._valueMax()-this._valueMin(),valueMouse=this._valueMin()+percentMouse*valueTotal,this._trimAlignValue(valueMouse)},_start:function(event,index){var uiHash={handle:this.handles[index],value:this.value()};return this.options.values&&this.options.values.length&&(uiHash.value=this.values(index),uiHash.values=this.values()),this._trigger("start",event,uiHash)},_slide:function(event,index,newVal){var otherVal,newValues,allowed;this.options.values&&this.options.values.length?(otherVal=this.values(index?0:1),2===this.options.values.length&&!0===this.options.range&&(0===index&&newVal>otherVal||1===index&&newVal<otherVal)&&(newVal=otherVal),newVal!==this.values(index)&&(newValues=this.values(),newValues[index]=newVal,allowed=this._trigger("slide",event,{handle:this.handles[index],value:newVal,values:newValues}),otherVal=this.values(index?0:1),!1!==allowed&&this.values(index,newVal))):newVal!==this.value()&&!1!==(allowed=this._trigger("slide",event,{handle:this.handles[index],value:newVal}))&&this.value(newVal)},_stop:function(event,index){var uiHash={handle:this.handles[index],value:this.value()};this.options.values&&this.options.values.length&&(uiHash.value=this.values(index),uiHash.values=this.values()),this._trigger("stop",event,uiHash)},_change:function(event,index){if(!this._keySliding&&!this._mouseSliding){var uiHash={handle:this.handles[index],value:this.value()};this.options.values&&this.options.values.length&&(uiHash.value=this.values(index),uiHash.values=this.values()),this._lastChangedValue=index,this._trigger("change",event,uiHash)}},value:function(newValue){return arguments.length?(this.options.value=this._trimAlignValue(newValue),this._refreshValue(),void this._change(null,0)):this._value()},values:function(index,newValue){var vals,newValues,i;if(arguments.length>1)return this.options.values[index]=this._trimAlignValue(newValue),this._refreshValue(),void this._change(null,index);if(!arguments.length)return this._values();if(!$.isArray(arguments[0]))return this.options.values&&this.options.values.length?this._values(index):this.value();for(vals=this.options.values,newValues=arguments[0],i=0;i<vals.length;i+=1)vals[i]=this._trimAlignValue(newValues[i]),this._change(null,i);this._refreshValue()},_setOption:function(key,value){var i,valsLength=0;switch("range"===key&&!0===this.options.range&&("min"===value?(this.options.value=this._values(0),this.options.values=null):"max"===value&&(this.options.value=this._values(this.options.values.length-1),this.options.values=null)),$.isArray(this.options.values)&&(valsLength=this.options.values.length),"disabled"===key&&this.element.toggleClass("ui-state-disabled",!!value),this._super(key,value),key){case"orientation":this._detectOrientation(),this.element.removeClass("ui-slider-horizontal ui-slider-vertical").addClass("ui-slider-"+this.orientation),this._refreshValue(),this.handles.css("horizontal"===value?"bottom":"left","");break;case"value":this._animateOff=!0,this._refreshValue(),this._change(null,0),this._animateOff=!1;break;case"values":for(this._animateOff=!0,this._refreshValue(),i=0;i<valsLength;i+=1)this._change(null,i);this._animateOff=!1;break;case"step":case"min":case"max":this._animateOff=!0,this._calculateNewMax(),this._refreshValue(),this._animateOff=!1;break;case"range":this._animateOff=!0,this._refresh(),this._animateOff=!1}},_value:function(){var val=this.options.value;return val=this._trimAlignValue(val)},_values:function(index){var val,vals,i;if(arguments.length)return val=this.options.values[index],val=this._trimAlignValue(val);if(this.options.values&&this.options.values.length){for(vals=this.options.values.slice(),i=0;i<vals.length;i+=1)vals[i]=this._trimAlignValue(vals[i]);return vals}return[]},_trimAlignValue:function(val){if(val<=this._valueMin())return this._valueMin();if(val>=this._valueMax())return this._valueMax();var step=this.options.step>0?this.options.step:1,valModStep=(val-this._valueMin())%step,alignValue=val-valModStep;return 2*Math.abs(valModStep)>=step&&(alignValue+=valModStep>0?step:-step),parseFloat(alignValue.toFixed(5))},_calculateNewMax:function(){var max=this.options.max,min=this._valueMin(),step=this.options.step;max=Math.floor(+(max-min).toFixed(this._precision())/step)*step+min,this.max=parseFloat(max.toFixed(this._precision()))},_precision:function(){var precision=this._precisionOf(this.options.step);return null!==this.options.min&&(precision=Math.max(precision,this._precisionOf(this.options.min))),precision},_precisionOf:function(num){var str=num.toString(),decimal=str.indexOf(".");return-1===decimal?0:str.length-decimal-1},_valueMin:function(){return this.options.min},_valueMax:function(){return this.max},_refreshValue:function(){var lastValPercent,valPercent,value,valueMin,valueMax,oRange=this.options.range,o=this.options,that=this,animate=!this._animateOff&&o.animate,_set={};this.options.values&&this.options.values.length?this.handles.each(function(i){valPercent=(that.values(i)-that._valueMin())/(that._valueMax()-that._valueMin())*100,_set["horizontal"===that.orientation?"left":"bottom"]=valPercent+"%",$(this).stop(1,1)[animate?"animate":"css"](_set,o.animate),!0===that.options.range&&("horizontal"===that.orientation?(0===i&&that.range.stop(1,1)[animate?"animate":"css"]({left:valPercent+"%"},o.animate),1===i&&that.range[animate?"animate":"css"]({width:valPercent-lastValPercent+"%"},{queue:!1,duration:o.animate})):(0===i&&that.range.stop(1,1)[animate?"animate":"css"]({bottom:valPercent+"%"},o.animate),1===i&&that.range[animate?"animate":"css"]({height:valPercent-lastValPercent+"%"},{queue:!1,duration:o.animate}))),lastValPercent=valPercent}):(value=this.value(),valueMin=this._valueMin(),valueMax=this._valueMax(),valPercent=valueMax!==valueMin?(value-valueMin)/(valueMax-valueMin)*100:0,_set["horizontal"===this.orientation?"left":"bottom"]=valPercent+"%",this.handle.stop(1,1)[animate?"animate":"css"](_set,o.animate),"min"===oRange&&"horizontal"===this.orientation&&this.range.stop(1,1)[animate?"animate":"css"]({width:valPercent+"%"},o.animate),"max"===oRange&&"horizontal"===this.orientation&&this.range[animate?"animate":"css"]({width:100-valPercent+"%"},{queue:!1,duration:o.animate}),"min"===oRange&&"vertical"===this.orientation&&this.range.stop(1,1)[animate?"animate":"css"]({height:valPercent+"%"},o.animate),"max"===oRange&&"vertical"===this.orientation&&this.range[animate?"animate":"css"]({height:100-valPercent+"%"},{queue:!1,duration:o.animate}))},_handleEvents:{keydown:function(event){var curVal,newVal,step,index=$(event.target).data("ui-slider-handle-index");switch(event.keyCode){case $.ui.keyCode.HOME:case $.ui.keyCode.END:case $.ui.keyCode.PAGE_UP:case $.ui.keyCode.PAGE_DOWN:case $.ui.keyCode.UP:case $.ui.keyCode.RIGHT:case $.ui.keyCode.DOWN:case $.ui.keyCode.LEFT:if(event.preventDefault(),!this._keySliding&&(this._keySliding=!0,$(event.target).addClass("ui-state-active"),!1===this._start(event,index)))return}switch(step=this.options.step,curVal=newVal=this.options.values&&this.options.values.length?this.values(index):this.value(),event.keyCode){case $.ui.keyCode.HOME:newVal=this._valueMin();break;case $.ui.keyCode.END:newVal=this._valueMax();break;case $.ui.keyCode.PAGE_UP:newVal=this._trimAlignValue(curVal+(this._valueMax()-this._valueMin())/this.numPages);break;case $.ui.keyCode.PAGE_DOWN:newVal=this._trimAlignValue(curVal-(this._valueMax()-this._valueMin())/this.numPages);break;case $.ui.keyCode.UP:case $.ui.keyCode.RIGHT:if(curVal===this._valueMax())return;newVal=this._trimAlignValue(curVal+step);break;case $.ui.keyCode.DOWN:case $.ui.keyCode.LEFT:if(curVal===this._valueMin())return;newVal=this._trimAlignValue(curVal-step)}this._slide(event,index,newVal)},keyup:function(event){var index=$(event.target).data("ui-slider-handle-index");this._keySliding&&(this._keySliding=!1,this._stop(event,index),this._change(event,index),$(event.target).removeClass("ui-state-active"))}}});function spinner_modifier(fn){return function(){var previous=this.element.val();fn.apply(this,arguments),this._refresh(),previous!==this.element.val()&&this._trigger("change")}}var jQuery=($.widget("ui.spinner",{version:"1.11.4",defaultElement:"<input>",widgetEventPrefix:"spin",options:{culture:null,icons:{down:"ui-icon-triangle-1-s",up:"ui-icon-triangle-1-n"},incremental:!0,max:null,min:null,numberFormat:null,page:10,step:1,change:null,spin:null,start:null,stop:null},_create:function(){this._setOption("max",this.options.max),this._setOption("min",this.options.min),this._setOption("step",this.options.step),""!==this.value()&&this._value(this.element.val(),!0),this._draw(),this._on(this._events),this._refresh(),this._on(this.window,{beforeunload:function(){this.element.removeAttr("autocomplete")}})},_getCreateOptions:function(){var options={},element=this.element;return $.each(["min","max","step"],function(i,option){var value=element.attr(option);void 0!==value&&value.length&&(options[option]=value)}),options},_events:{keydown:function(event){this._start(event)&&this._keydown(event)&&event.preventDefault()},keyup:"_stop",focus:function(){this.previous=this.element.val()},blur:function(event){if(this.cancelBlur)return void delete this.cancelBlur;this._stop(),this._refresh(),this.previous!==this.element.val()&&this._trigger("change",event)},mousewheel:function(event,delta){if(delta){if(!this.spinning&&!this._start(event))return!1;this._spin((delta>0?1:-1)*this.options.step,event),clearTimeout(this.mousewheelTimer),this.mousewheelTimer=this._delay(function(){this.spinning&&this._stop(event)},100),event.preventDefault()}},"mousedown .ui-spinner-button":function(event){var previous;previous=this.element[0]===this.document[0].activeElement?this.previous:this.element.val();function checkFocus(){this.element[0]===this.document[0].activeElement||(this.element.focus(),this.previous=previous,this._delay(function(){this.previous=previous}))}event.preventDefault(),checkFocus.call(this),this.cancelBlur=!0,this._delay(function(){delete this.cancelBlur,checkFocus.call(this)}),!1!==this._start(event)&&this._repeat(null,$(event.currentTarget).hasClass("ui-spinner-up")?1:-1,event)},"mouseup .ui-spinner-button":"_stop","mouseenter .ui-spinner-button":function(event){if($(event.currentTarget).hasClass("ui-state-active"))return!1!==this._start(event)&&void this._repeat(null,$(event.currentTarget).hasClass("ui-spinner-up")?1:-1,event)},"mouseleave .ui-spinner-button":"_stop"},_draw:function(){var uiSpinner=this.uiSpinner=this.element.addClass("ui-spinner-input").attr("autocomplete","off").wrap(this._uiSpinnerHtml()).parent().append(this._buttonHtml());this.element.attr("role","spinbutton"),this.buttons=uiSpinner.find(".ui-spinner-button").attr("tabIndex",-1).button().removeClass("ui-corner-all"),this.buttons.height()>Math.ceil(.5*uiSpinner.height())&&uiSpinner.height()>0&&uiSpinner.height(uiSpinner.height()),this.options.disabled&&this.disable()},_keydown:function(event){var options=this.options,keyCode=$.ui.keyCode;switch(event.keyCode){case keyCode.UP:return this._repeat(null,1,event),!0;case keyCode.DOWN:return this._repeat(null,-1,event),!0;case keyCode.PAGE_UP:return this._repeat(null,options.page,event),!0;case keyCode.PAGE_DOWN:return this._repeat(null,-options.page,event),!0}return!1},_uiSpinnerHtml:function(){return"<span class='ui-spinner ui-widget ui-widget-content ui-corner-all'></span>"},_buttonHtml:function(){return"<a class='ui-spinner-button ui-spinner-up ui-corner-tr'><span class='ui-icon "+this.options.icons.up+"'>&#9650;</span></a><a class='ui-spinner-button ui-spinner-down ui-corner-br'><span class='ui-icon "+this.options.icons.down+"'>&#9660;</span></a>"},_start:function(event){return!(!this.spinning&&!1===this._trigger("start",event))&&(this.counter||(this.counter=1),this.spinning=!0,!0)},_repeat:function(i,steps,event){i=i||500,clearTimeout(this.timer),this.timer=this._delay(function(){this._repeat(40,steps,event)},i),this._spin(steps*this.options.step,event)},_spin:function(step,event){var value=this.value()||0;this.counter||(this.counter=1),value=this._adjustValue(value+step*this._increment(this.counter)),this.spinning&&!1===this._trigger("spin",event,{value:value})||(this._value(value),this.counter++)},_increment:function(i){var incremental=this.options.incremental;return incremental?$.isFunction(incremental)?incremental(i):Math.floor(i*i*i/5e4-i*i/500+17*i/200+1):1},_precision:function(){var precision=this._precisionOf(this.options.step);return null!==this.options.min&&(precision=Math.max(precision,this._precisionOf(this.options.min))),precision},_precisionOf:function(num){var str=num.toString(),decimal=str.indexOf(".");return-1===decimal?0:str.length-decimal-1},_adjustValue:function(value){var base,aboveMin,options=this.options;return base=null!==options.min?options.min:0,aboveMin=value-base,aboveMin=Math.round(aboveMin/options.step)*options.step,value=base+aboveMin,value=parseFloat(value.toFixed(this._precision())),null!==options.max&&value>options.max?options.max:null!==options.min&&value<options.min?options.min:value},_stop:function(event){this.spinning&&(clearTimeout(this.timer),clearTimeout(this.mousewheelTimer),this.counter=0,this.spinning=!1,this._trigger("stop",event))},_setOption:function(key,value){if("culture"===key||"numberFormat"===key){var prevValue=this._parse(this.element.val());return this.options[key]=value,void this.element.val(this._format(prevValue))}"max"!==key&&"min"!==key&&"step"!==key||"string"==typeof value&&(value=this._parse(value)),"icons"===key&&(this.buttons.first().find(".ui-icon").removeClass(this.options.icons.up).addClass(value.up),this.buttons.last().find(".ui-icon").removeClass(this.options.icons.down).addClass(value.down)),this._super(key,value),"disabled"===key&&(this.widget().toggleClass("ui-state-disabled",!!value),this.element.prop("disabled",!!value),this.buttons.button(value?"disable":"enable"))},_setOptions:spinner_modifier(function(options){this._super(options)}),_parse:function(val){return"string"==typeof val&&""!==val&&(val=window.Globalize&&this.options.numberFormat?Globalize.parseFloat(val,10,this.options.culture):+val),""===val||isNaN(val)?null:val},_format:function(value){return""===value?"":window.Globalize&&this.options.numberFormat?Globalize.format(value,this.options.numberFormat,this.options.culture):value},_refresh:function(){this.element.attr({"aria-valuemin":this.options.min,"aria-valuemax":this.options.max,"aria-valuenow":this._parse(this.element.val())})},isValid:function(){var value=this.value();return null!==value&&value===this._adjustValue(value)},_value:function(value,allowAny){var parsed;""!==value&&null!==(parsed=this._parse(value))&&(allowAny||(parsed=this._adjustValue(parsed)),value=this._format(parsed)),this.element.val(value),this._refresh()},_destroy:function(){this.element.removeClass("ui-spinner-input").prop("disabled",!1).removeAttr("autocomplete").removeAttr("role").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuenow"),this.uiSpinner.replaceWith(this.element)},stepUp:spinner_modifier(function(steps){this._stepUp(steps)}),_stepUp:function(steps){this._start()&&(this._spin((steps||1)*this.options.step),this._stop())},stepDown:spinner_modifier(function(steps){this._stepDown(steps)}),_stepDown:function(steps){this._start()&&(this._spin((steps||1)*-this.options.step),this._stop())},pageUp:spinner_modifier(function(pages){this._stepUp((pages||1)*this.options.page)}),pageDown:spinner_modifier(function(pages){this._stepDown((pages||1)*this.options.page)}),value:function(newVal){if(!arguments.length)return this._parse(this.element.val());spinner_modifier(this._value).call(this,newVal)},widget:function(){return this.uiSpinner}}),$.widget("ui.tabs",{version:"1.11.4",delay:300,options:{active:null,collapsible:!1,event:"click",heightStyle:"content",hide:null,show:null,activate:null,beforeActivate:null,beforeLoad:null,load:null},_isLocal:function(){var rhash=/#.*$/;return function(anchor){var anchorUrl,locationUrl;anchor=anchor.cloneNode(!1),anchorUrl=anchor.href.replace(rhash,""),locationUrl=location.href.replace(rhash,"");try{anchorUrl=decodeURIComponent(anchorUrl)}catch(error){}try{locationUrl=decodeURIComponent(locationUrl)}catch(error){}return anchor.hash.length>1&&anchorUrl===locationUrl}}(),_create:function(){var that=this,options=this.options;this.running=!1,this.element.addClass("ui-tabs ui-widget ui-widget-content ui-corner-all").toggleClass("ui-tabs-collapsible",options.collapsible),this._processTabs(),options.active=this._initialActive(),$.isArray(options.disabled)&&(options.disabled=$.unique(options.disabled.concat($.map(this.tabs.filter(".ui-state-disabled"),function(li){return that.tabs.index(li)}))).sort()),!1!==this.options.active&&this.anchors.length?this.active=this._findActive(options.active):this.active=$(),this._refresh(),this.active.length&&this.load(options.active)},_initialActive:function(){var active=this.options.active,collapsible=this.options.collapsible,locationHash=location.hash.substring(1);return null===active&&(locationHash&&this.tabs.each(function(i,tab){if($(tab).attr("aria-controls")===locationHash)return active=i,!1}),null===active&&(active=this.tabs.index(this.tabs.filter(".ui-tabs-active"))),null!==active&&-1!==active||(active=!!this.tabs.length&&0)),!1!==active&&-1===(active=this.tabs.index(this.tabs.eq(active)))&&(active=!collapsible&&0),!collapsible&&!1===active&&this.anchors.length&&(active=0),active},_getCreateEventData:function(){return{tab:this.active,panel:this.active.length?this._getPanelForTab(this.active):$()}},_tabKeydown:function(event){var focusedTab=$(this.document[0].activeElement).closest("li"),selectedIndex=this.tabs.index(focusedTab),goingForward=!0;if(!this._handlePageNav(event)){switch(event.keyCode){case $.ui.keyCode.RIGHT:case $.ui.keyCode.DOWN:selectedIndex++;break;case $.ui.keyCode.UP:case $.ui.keyCode.LEFT:goingForward=!1,selectedIndex--;break;case $.ui.keyCode.END:selectedIndex=this.anchors.length-1;break;case $.ui.keyCode.HOME:selectedIndex=0;break;case $.ui.keyCode.SPACE:return event.preventDefault(),clearTimeout(this.activating),void this._activate(selectedIndex);case $.ui.keyCode.ENTER:return event.preventDefault(),clearTimeout(this.activating),void this._activate(selectedIndex!==this.options.active&&selectedIndex);default:return}event.preventDefault(),clearTimeout(this.activating),selectedIndex=this._focusNextTab(selectedIndex,goingForward),event.ctrlKey||event.metaKey||(focusedTab.attr("aria-selected","false"),this.tabs.eq(selectedIndex).attr("aria-selected","true"),this.activating=this._delay(function(){this.option("active",selectedIndex)},this.delay))}},_panelKeydown:function(event){this._handlePageNav(event)||event.ctrlKey&&event.keyCode===$.ui.keyCode.UP&&(event.preventDefault(),this.active.focus())},_handlePageNav:function(event){return event.altKey&&event.keyCode===$.ui.keyCode.PAGE_UP?(this._activate(this._focusNextTab(this.options.active-1,!1)),!0):event.altKey&&event.keyCode===$.ui.keyCode.PAGE_DOWN?(this._activate(this._focusNextTab(this.options.active+1,!0)),!0):void 0},_findNextTab:function(index,goingForward){var lastTabIndex=this.tabs.length-1;for(;-1!==$.inArray(function(){return index>lastTabIndex&&(index=0),index<0&&(index=lastTabIndex),index}(),this.options.disabled);)index=goingForward?index+1:index-1;return index},_focusNextTab:function(index,goingForward){return index=this._findNextTab(index,goingForward),this.tabs.eq(index).focus(),index},_setOption:function(key,value){return"active"===key?void this._activate(value):"disabled"===key?void this._setupDisabled(value):(this._super(key,value),"collapsible"===key&&(this.element.toggleClass("ui-tabs-collapsible",value),value||!1!==this.options.active||this._activate(0)),"event"===key&&this._setupEvents(value),void("heightStyle"===key&&this._setupHeightStyle(value)))},_sanitizeSelector:function(hash){return hash?hash.replace(/[!"$%&'()*+,.\/:;<=>?@\[\]\^`{|}~]/g,"\\$&"):""},refresh:function(){var options=this.options,lis=this.tablist.children(":has(a[href])");options.disabled=$.map(lis.filter(".ui-state-disabled"),function(tab){return lis.index(tab)}),this._processTabs(),!1!==options.active&&this.anchors.length?this.active.length&&!$.contains(this.tablist[0],this.active[0])?this.tabs.length===options.disabled.length?(options.active=!1,this.active=$()):this._activate(this._findNextTab(Math.max(0,options.active-1),!1)):options.active=this.tabs.index(this.active):(options.active=!1,this.active=$()),this._refresh()},_refresh:function(){this._setupDisabled(this.options.disabled),this._setupEvents(this.options.event),this._setupHeightStyle(this.options.heightStyle),this.tabs.not(this.active).attr({"aria-selected":"false","aria-expanded":"false",tabIndex:-1}),this.panels.not(this._getPanelForTab(this.active)).hide().attr({"aria-hidden":"true"}),this.active.length?(this.active.addClass("ui-tabs-active ui-state-active").attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0}),this._getPanelForTab(this.active).show().attr({"aria-hidden":"false"})):this.tabs.eq(0).attr("tabIndex",0)},_processTabs:function(){var that=this,prevTabs=this.tabs,prevAnchors=this.anchors,prevPanels=this.panels;this.tablist=this._getList().addClass("ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all").attr("role","tablist").delegate("> li","mousedown"+this.eventNamespace,function(event){$(this).is(".ui-state-disabled")&&event.preventDefault()}).delegate(".ui-tabs-anchor","focus"+this.eventNamespace,function(){$(this).closest("li").is(".ui-state-disabled")&&this.blur()}),this.tabs=this.tablist.find("> li:has(a[href])").addClass("ui-state-default ui-corner-top").attr({role:"tab",tabIndex:-1}),this.anchors=this.tabs.map(function(){return $("a",this)[0]}).addClass("ui-tabs-anchor").attr({role:"presentation",tabIndex:-1}),this.panels=$(),this.anchors.each(function(i,anchor){var selector,panel,panelId,anchorId=$(anchor).uniqueId().attr("id"),tab=$(anchor).closest("li"),originalAriaControls=tab.attr("aria-controls");that._isLocal(anchor)?(selector=anchor.hash,panelId=selector.substring(1),panel=that.element.find(that._sanitizeSelector(selector))):(panelId=tab.attr("aria-controls")||$({}).uniqueId()[0].id,selector="#"+panelId,panel=that.element.find(selector),panel.length||(panel=that._createPanel(panelId),panel.insertAfter(that.panels[i-1]||that.tablist)),panel.attr("aria-live","polite")),panel.length&&(that.panels=that.panels.add(panel)),originalAriaControls&&tab.data("ui-tabs-aria-controls",originalAriaControls),tab.attr({"aria-controls":panelId,"aria-labelledby":anchorId}),panel.attr("aria-labelledby",anchorId)}),this.panels.addClass("ui-tabs-panel ui-widget-content ui-corner-bottom").attr("role","tabpanel"),prevTabs&&(this._off(prevTabs.not(this.tabs)),this._off(prevAnchors.not(this.anchors)),this._off(prevPanels.not(this.panels)))},_getList:function(){return this.tablist||this.element.find("ol,ul").eq(0)},_createPanel:function(id){return $("<div>").attr("id",id).addClass("ui-tabs-panel ui-widget-content ui-corner-bottom").data("ui-tabs-destroy",!0)},_setupDisabled:function(disabled){$.isArray(disabled)&&(disabled.length?disabled.length===this.anchors.length&&(disabled=!0):disabled=!1);for(var li,i=0;li=this.tabs[i];i++)!0===disabled||-1!==$.inArray(i,disabled)?$(li).addClass("ui-state-disabled").attr("aria-disabled","true"):$(li).removeClass("ui-state-disabled").removeAttr("aria-disabled");this.options.disabled=disabled},_setupEvents:function(event){var events={};event&&$.each(event.split(" "),function(index,eventName){events[eventName]="_eventHandler"}),this._off(this.anchors.add(this.tabs).add(this.panels)),this._on(!0,this.anchors,{click:function(event){event.preventDefault()}}),this._on(this.anchors,events),this._on(this.tabs,{keydown:"_tabKeydown"}),this._on(this.panels,{keydown:"_panelKeydown"}),this._focusable(this.tabs),this._hoverable(this.tabs)},_setupHeightStyle:function(heightStyle){var maxHeight,parent=this.element.parent();"fill"===heightStyle?(maxHeight=parent.height(),maxHeight-=this.element.outerHeight()-this.element.height(),this.element.siblings(":visible").each(function(){var elem=$(this),position=elem.css("position");"absolute"!==position&&"fixed"!==position&&(maxHeight-=elem.outerHeight(!0))}),this.element.children().not(this.panels).each(function(){maxHeight-=$(this).outerHeight(!0)}),this.panels.each(function(){$(this).height(Math.max(0,maxHeight-$(this).innerHeight()+$(this).height()))}).css("overflow","auto")):"auto"===heightStyle&&(maxHeight=0,this.panels.each(function(){maxHeight=Math.max(maxHeight,$(this).height("").height())}).height(maxHeight))},_eventHandler:function(event){var options=this.options,active=this.active,anchor=$(event.currentTarget),tab=anchor.closest("li"),clickedIsActive=tab[0]===active[0],collapsing=clickedIsActive&&options.collapsible,toShow=collapsing?$():this._getPanelForTab(tab),toHide=active.length?this._getPanelForTab(active):$(),eventData={oldTab:active,oldPanel:toHide,newTab:collapsing?$():tab,newPanel:toShow};event.preventDefault(),tab.hasClass("ui-state-disabled")||tab.hasClass("ui-tabs-loading")||this.running||clickedIsActive&&!options.collapsible||!1===this._trigger("beforeActivate",event,eventData)||(options.active=!collapsing&&this.tabs.index(tab),this.active=clickedIsActive?$():tab,this.xhr&&this.xhr.abort(),toHide.length||toShow.length||$.error("jQuery UI Tabs: Mismatching fragment identifier."),toShow.length&&this.load(this.tabs.index(tab),event),this._toggle(event,eventData))},_toggle:function(event,eventData){var that=this,toShow=eventData.newPanel,toHide=eventData.oldPanel;this.running=!0;function complete(){that.running=!1,that._trigger("activate",event,eventData)}function show(){eventData.newTab.closest("li").addClass("ui-tabs-active ui-state-active"),toShow.length&&that.options.show?that._show(toShow,that.options.show,complete):(toShow.show(),complete())}toHide.length&&this.options.hide?this._hide(toHide,this.options.hide,function(){eventData.oldTab.closest("li").removeClass("ui-tabs-active ui-state-active"),show()}):(eventData.oldTab.closest("li").removeClass("ui-tabs-active ui-state-active"),toHide.hide(),show()),toHide.attr("aria-hidden","true"),eventData.oldTab.attr({"aria-selected":"false","aria-expanded":"false"}),toShow.length&&toHide.length?eventData.oldTab.attr("tabIndex",-1):toShow.length&&this.tabs.filter(function(){return 0===$(this).attr("tabIndex")}).attr("tabIndex",-1),toShow.attr("aria-hidden","false"),eventData.newTab.attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0})},_activate:function(index){var anchor,active=this._findActive(index);active[0]!==this.active[0]&&(active.length||(active=this.active),anchor=active.find(".ui-tabs-anchor")[0],this._eventHandler({target:anchor,currentTarget:anchor,preventDefault:$.noop}))},_findActive:function(index){return!1===index?$():this.tabs.eq(index)},_getIndex:function(index){return"string"==typeof index&&(index=this.anchors.index(this.anchors.filter("[href$='"+index+"']"))),index},_destroy:function(){this.xhr&&this.xhr.abort(),this.element.removeClass("ui-tabs ui-widget ui-widget-content ui-corner-all ui-tabs-collapsible"),this.tablist.removeClass("ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all").removeAttr("role"),this.anchors.removeClass("ui-tabs-anchor").removeAttr("role").removeAttr("tabIndex").removeUniqueId(),this.tablist.unbind(this.eventNamespace),this.tabs.add(this.panels).each(function(){$.data(this,"ui-tabs-destroy")?$(this).remove():$(this).removeClass("ui-state-default ui-state-active ui-state-disabled ui-corner-top ui-corner-bottom ui-widget-content ui-tabs-active ui-tabs-panel").removeAttr("tabIndex").removeAttr("aria-live").removeAttr("aria-busy").removeAttr("aria-selected").removeAttr("aria-labelledby").removeAttr("aria-hidden").removeAttr("aria-expanded").removeAttr("role")}),this.tabs.each(function(){var li=$(this),prev=li.data("ui-tabs-aria-controls");prev?li.attr("aria-controls",prev).removeData("ui-tabs-aria-controls"):li.removeAttr("aria-controls")}),this.panels.show(),"content"!==this.options.heightStyle&&this.panels.css("height","")},enable:function(index){var disabled=this.options.disabled;!1!==disabled&&(void 0===index?disabled=!1:(index=this._getIndex(index),disabled=$.isArray(disabled)?$.map(disabled,function(num){return num!==index?num:null}):$.map(this.tabs,function(li,num){return num!==index?num:null})),this._setupDisabled(disabled))},disable:function(index){var disabled=this.options.disabled;if(!0!==disabled){if(void 0===index)disabled=!0;else{if(index=this._getIndex(index),-1!==$.inArray(index,disabled))return;disabled=$.isArray(disabled)?$.merge([index],disabled).sort():[index]}this._setupDisabled(disabled)}},load:function(index,event){index=this._getIndex(index);var that=this,tab=this.tabs.eq(index),anchor=tab.find(".ui-tabs-anchor"),panel=this._getPanelForTab(tab),eventData={tab:tab,panel:panel},complete=function(jqXHR,status){"abort"===status&&that.panels.stop(!1,!0),tab.removeClass("ui-tabs-loading"),panel.removeAttr("aria-busy"),jqXHR===that.xhr&&delete that.xhr};this._isLocal(anchor[0])||(this.xhr=$.ajax(this._ajaxSettings(anchor,event,eventData)),this.xhr&&"canceled"!==this.xhr.statusText&&(tab.addClass("ui-tabs-loading"),panel.attr("aria-busy","true"),this.xhr.done(function(response,status,jqXHR){setTimeout(function(){panel.html(response),that._trigger("load",event,eventData),complete(jqXHR,status)},1)}).fail(function(jqXHR,status){setTimeout(function(){complete(jqXHR,status)},1)})))},_ajaxSettings:function(anchor,event,eventData){var that=this;return{url:anchor.attr("href"),beforeSend:function(jqXHR,settings){return that._trigger("beforeLoad",event,$.extend({jqXHR:jqXHR,ajaxSettings:settings},eventData))}}},_getPanelForTab:function(tab){var id=$(tab).attr("aria-controls");return this.element.find(this._sanitizeSelector("#"+id))}}),$.widget("ui.tooltip",{version:"1.11.4",options:{content:function(){var title=$(this).attr("title")||"";return $("<a>").text(title).html()},hide:!0,items:"[title]:not([disabled])",position:{my:"left top+15",at:"left bottom",collision:"flipfit flip"},show:!0,tooltipClass:null,track:!1,close:null,open:null},_addDescribedBy:function(elem,id){var describedby=(elem.attr("aria-describedby")||"").split(/\s+/);describedby.push(id),elem.data("ui-tooltip-id",id).attr("aria-describedby",$.trim(describedby.join(" ")))},_removeDescribedBy:function(elem){var id=elem.data("ui-tooltip-id"),describedby=(elem.attr("aria-describedby")||"").split(/\s+/),index=$.inArray(id,describedby);-1!==index&&describedby.splice(index,1),elem.removeData("ui-tooltip-id"),describedby=$.trim(describedby.join(" ")),describedby?elem.attr("aria-describedby",describedby):elem.removeAttr("aria-describedby")},_create:function(){this._on({mouseover:"open",focusin:"open"}),this.tooltips={},this.parents={},this.options.disabled&&this._disable(),this.liveRegion=$("<div>").attr({
role:"log","aria-live":"assertive","aria-relevant":"additions"}).addClass("ui-helper-hidden-accessible").appendTo(this.document[0].body)},_setOption:function(key,value){var that=this;if("disabled"===key)return this[value?"_disable":"_enable"](),void(this.options[key]=value);this._super(key,value),"content"===key&&$.each(this.tooltips,function(id,tooltipData){that._updateContent(tooltipData.element)})},_disable:function(){var that=this;$.each(this.tooltips,function(id,tooltipData){var event=$.Event("blur");event.target=event.currentTarget=tooltipData.element[0],that.close(event,!0)}),this.element.find(this.options.items).addBack().each(function(){var element=$(this);element.is("[title]")&&element.data("ui-tooltip-title",element.attr("title")).removeAttr("title")})},_enable:function(){this.element.find(this.options.items).addBack().each(function(){var element=$(this);element.data("ui-tooltip-title")&&element.attr("title",element.data("ui-tooltip-title"))})},open:function(event){var that=this,target=$(event?event.target:this.element).closest(this.options.items);target.length&&!target.data("ui-tooltip-id")&&(target.attr("title")&&target.data("ui-tooltip-title",target.attr("title")),target.data("ui-tooltip-open",!0),event&&"mouseover"===event.type&&target.parents().each(function(){var blurEvent,parent=$(this);parent.data("ui-tooltip-open")&&(blurEvent=$.Event("blur"),blurEvent.target=blurEvent.currentTarget=this,that.close(blurEvent,!0)),parent.attr("title")&&(parent.uniqueId(),that.parents[this.id]={element:this,title:parent.attr("title")},parent.attr("title",""))}),this._registerCloseHandlers(event,target),this._updateContent(target,event))},_updateContent:function(target,event){var content,contentOption=this.options.content,that=this,eventType=event?event.type:null;if("string"==typeof contentOption)return this._open(event,target,contentOption);(content=contentOption.call(target[0],function(response){that._delay(function(){target.data("ui-tooltip-open")&&(event&&(event.type=eventType),this._open(event,target,response))})}))&&this._open(event,target,content)},_open:function(event,target,content){var tooltipData,tooltip,delayedShow,a11yContent,positionOption=$.extend({},this.options.position);function position(event){positionOption.of=event,tooltip.is(":hidden")||tooltip.position(positionOption)}if(content){if(tooltipData=this._find(target))return void tooltipData.tooltip.find(".ui-tooltip-content").html(content);target.is("[title]")&&(event&&"mouseover"===event.type?target.attr("title",""):target.removeAttr("title")),tooltipData=this._tooltip(target),tooltip=tooltipData.tooltip,this._addDescribedBy(target,tooltip.attr("id")),tooltip.find(".ui-tooltip-content").html(content),this.liveRegion.children().hide(),content.clone?(a11yContent=content.clone(),a11yContent.removeAttr("id").find("[id]").removeAttr("id")):a11yContent=content,$("<div>").html(a11yContent).appendTo(this.liveRegion),this.options.track&&event&&/^mouse/.test(event.type)?(this._on(this.document,{mousemove:position}),position(event)):tooltip.position($.extend({of:target},this.options.position)),tooltip.hide(),this._show(tooltip,this.options.show),this.options.show&&this.options.show.delay&&(delayedShow=this.delayedShow=setInterval(function(){tooltip.is(":visible")&&(position(positionOption.of),clearInterval(delayedShow))},$.fx.interval)),this._trigger("open",event,{tooltip:tooltip})}},_registerCloseHandlers:function(event,target){var events={keyup:function(event){if(event.keyCode===$.ui.keyCode.ESCAPE){var fakeEvent=$.Event(event);fakeEvent.currentTarget=target[0],this.close(fakeEvent,!0)}}};target[0]!==this.element[0]&&(events.remove=function(){this._removeTooltip(this._find(target).tooltip)}),event&&"mouseover"!==event.type||(events.mouseleave="close"),event&&"focusin"!==event.type||(events.focusout="close"),this._on(!0,target,events)},close:function(event){var tooltip,that=this,target=$(event?event.currentTarget:this.element),tooltipData=this._find(target);if(!tooltipData)return void target.removeData("ui-tooltip-open");tooltip=tooltipData.tooltip,tooltipData.closing||(clearInterval(this.delayedShow),target.data("ui-tooltip-title")&&!target.attr("title")&&target.attr("title",target.data("ui-tooltip-title")),this._removeDescribedBy(target),tooltipData.hiding=!0,tooltip.stop(!0),this._hide(tooltip,this.options.hide,function(){that._removeTooltip($(this))}),target.removeData("ui-tooltip-open"),this._off(target,"mouseleave focusout keyup"),target[0]!==this.element[0]&&this._off(target,"remove"),this._off(this.document,"mousemove"),event&&"mouseleave"===event.type&&$.each(this.parents,function(id,parent){$(parent.element).attr("title",parent.title),delete that.parents[id]}),tooltipData.closing=!0,this._trigger("close",event,{tooltip:tooltip}),tooltipData.hiding||(tooltipData.closing=!1))},_tooltip:function(element){var tooltip=$("<div>").attr("role","tooltip").addClass("ui-tooltip ui-widget ui-corner-all ui-widget-content "+(this.options.tooltipClass||"")),id=tooltip.uniqueId().attr("id");return $("<div>").addClass("ui-tooltip-content").appendTo(tooltip),tooltip.appendTo(this.document[0].body),this.tooltips[id]={element:element,tooltip:tooltip}},_find:function(target){var id=target.data("ui-tooltip-id");return id?this.tooltips[id]:null},_removeTooltip:function(tooltip){tooltip.remove(),delete this.tooltips[tooltip.attr("id")]},_destroy:function(){var that=this;$.each(this.tooltips,function(id,tooltipData){var event=$.Event("blur"),element=tooltipData.element;event.target=event.currentTarget=element[0],that.close(event,!0),$("#"+id).remove(),element.data("ui-tooltip-title")&&(element.attr("title")||element.attr("title",element.data("ui-tooltip-title")),element.removeData("ui-tooltip-title"))}),this.liveRegion.remove()}}),$);$.effects={effect:{}},function(jQuery,undefined){var colors,rplusequals=/^([\-+])=\s*(\d+\.?\d*)/,stringParsers=[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(execResult){return[execResult[1],execResult[2],execResult[3],execResult[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(execResult){return[2.55*execResult[1],2.55*execResult[2],2.55*execResult[3],execResult[4]]}},{re:/#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})/,parse:function(execResult){return[parseInt(execResult[1],16),parseInt(execResult[2],16),parseInt(execResult[3],16)]}},{re:/#([a-f0-9])([a-f0-9])([a-f0-9])/,parse:function(execResult){return[parseInt(execResult[1]+execResult[1],16),parseInt(execResult[2]+execResult[2],16),parseInt(execResult[3]+execResult[3],16)]}},{re:/hsla?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,space:"hsla",parse:function(execResult){return[execResult[1],execResult[2]/100,execResult[3]/100,execResult[4]]}}],color=jQuery.Color=function(color,green,blue,alpha){return new jQuery.Color.fn.parse(color,green,blue,alpha)},spaces={rgba:{props:{red:{idx:0,type:"byte"},green:{idx:1,type:"byte"},blue:{idx:2,type:"byte"}}},hsla:{props:{hue:{idx:0,type:"degrees"},saturation:{idx:1,type:"percent"},lightness:{idx:2,type:"percent"}}}},propTypes={byte:{floor:!0,max:255},percent:{max:1},degrees:{mod:360,floor:!0}},support=color.support={},supportElem=jQuery("<p>")[0],each=jQuery.each;supportElem.style.cssText="background-color:rgba(1,1,1,.5)",support.rgba=supportElem.style.backgroundColor.indexOf("rgba")>-1,each(spaces,function(spaceName,space){space.cache="_"+spaceName,space.props.alpha={idx:3,type:"percent",def:1}});function clamp(value,prop,allowEmpty){var type=propTypes[prop.type]||{};return null==value?allowEmpty||!prop.def?null:prop.def:(value=type.floor?~~value:parseFloat(value),isNaN(value)?prop.def:type.mod?(value+type.mod)%type.mod:0>value?0:type.max<value?type.max:value)}function stringParse(string){var inst=color(),rgba=inst._rgba=[];return string=string.toLowerCase(),each(stringParsers,function(i,parser){var parsed,match=parser.re.exec(string),values=match&&parser.parse(match),spaceName=parser.space||"rgba";if(values)return parsed=inst[spaceName](values),inst[spaces[spaceName].cache]=parsed[spaces[spaceName].cache],rgba=inst._rgba=parsed._rgba,!1}),rgba.length?("0,0,0,0"===rgba.join()&&jQuery.extend(rgba,colors.transparent),inst):colors[string]}color.fn=jQuery.extend(color.prototype,{parse:function(red,green,blue,alpha){if(void 0===red)return this._rgba=[null,null,null,null],this;(red.jquery||red.nodeType)&&(red=jQuery(red).css(green),green=void 0);var inst=this,type=jQuery.type(red),rgba=this._rgba=[];return void 0!==green&&(red=[red,green,blue,alpha],type="array"),"string"===type?this.parse(stringParse(red)||colors._default):"array"===type?(each(spaces.rgba.props,function(key,prop){rgba[prop.idx]=clamp(red[prop.idx],prop)}),this):"object"===type?(red instanceof color?each(spaces,function(spaceName,space){red[space.cache]&&(inst[space.cache]=red[space.cache].slice())}):each(spaces,function(spaceName,space){var cache=space.cache;each(space.props,function(key,prop){if(!inst[cache]&&space.to){if("alpha"===key||null==red[key])return;inst[cache]=space.to(inst._rgba)}inst[cache][prop.idx]=clamp(red[key],prop,!0)}),inst[cache]&&jQuery.inArray(null,inst[cache].slice(0,3))<0&&(inst[cache][3]=1,space.from&&(inst._rgba=space.from(inst[cache])))}),this):void 0},is:function(compare){var is=color(compare),same=!0,inst=this;return each(spaces,function(_,space){var localCache,isCache=is[space.cache];return isCache&&(localCache=inst[space.cache]||space.to&&space.to(inst._rgba)||[],each(space.props,function(_,prop){if(null!=isCache[prop.idx])return same=isCache[prop.idx]===localCache[prop.idx]})),same}),same},_space:function(){var used=[],inst=this;return each(spaces,function(spaceName,space){inst[space.cache]&&used.push(spaceName)}),used.pop()},transition:function(other,distance){var end=color(other),spaceName=end._space(),space=spaces[spaceName],startColor=0===this.alpha()?color("transparent"):this,start=startColor[space.cache]||space.to(startColor._rgba),result=start.slice();return end=end[space.cache],each(space.props,function(key,prop){var index=prop.idx,startValue=start[index],endValue=end[index],type=propTypes[prop.type]||{};null!==endValue&&(null===startValue?result[index]=endValue:(type.mod&&(endValue-startValue>type.mod/2?startValue+=type.mod:startValue-endValue>type.mod/2&&(startValue-=type.mod)),result[index]=clamp((endValue-startValue)*distance+startValue,prop)))}),this[spaceName](result)},blend:function(opaque){if(1===this._rgba[3])return this;var rgb=this._rgba.slice(),a=rgb.pop(),blend=color(opaque)._rgba;return color(jQuery.map(rgb,function(v,i){return(1-a)*blend[i]+a*v}))},toRgbaString:function(){var prefix="rgba(",rgba=jQuery.map(this._rgba,function(v,i){return null==v?i>2?1:0:v});return 1===rgba[3]&&(rgba.pop(),prefix="rgb("),prefix+rgba.join()+")"},toHslaString:function(){var prefix="hsla(",hsla=jQuery.map(this.hsla(),function(v,i){return null==v&&(v=i>2?1:0),i&&i<3&&(v=Math.round(100*v)+"%"),v});return 1===hsla[3]&&(hsla.pop(),prefix="hsl("),prefix+hsla.join()+")"},toHexString:function(includeAlpha){var rgba=this._rgba.slice(),alpha=rgba.pop();return includeAlpha&&rgba.push(~~(255*alpha)),"#"+jQuery.map(rgba,function(v){return v=(v||0).toString(16),1===v.length?"0"+v:v}).join("")},toString:function(){return 0===this._rgba[3]?"transparent":this.toRgbaString()}}),color.fn.parse.prototype=color.fn;function hue2rgb(p,q,h){return h=(h+1)%1,6*h<1?p+(q-p)*h*6:2*h<1?q:3*h<2?p+(q-p)*(2/3-h)*6:p}spaces.hsla.to=function(rgba){if(null==rgba[0]||null==rgba[1]||null==rgba[2])return[null,null,null,rgba[3]];var h,s,r=rgba[0]/255,g=rgba[1]/255,b=rgba[2]/255,a=rgba[3],max=Math.max(r,g,b),min=Math.min(r,g,b),diff=max-min,add=max+min,l=.5*add;return h=min===max?0:r===max?60*(g-b)/diff+360:g===max?60*(b-r)/diff+120:60*(r-g)/diff+240,s=0===diff?0:l<=.5?diff/add:diff/(2-add),[Math.round(h)%360,s,l,null==a?1:a]},spaces.hsla.from=function(hsla){if(null==hsla[0]||null==hsla[1]||null==hsla[2])return[null,null,null,hsla[3]];var h=hsla[0]/360,s=hsla[1],l=hsla[2],a=hsla[3],q=l<=.5?l*(1+s):l+s-l*s,p=2*l-q;return[Math.round(255*hue2rgb(p,q,h+1/3)),Math.round(255*hue2rgb(p,q,h)),Math.round(255*hue2rgb(p,q,h-1/3)),a]},each(spaces,function(spaceName,space){var props=space.props,cache=space.cache,to=space.to,from=space.from;color.fn[spaceName]=function(value){if(to&&!this[cache]&&(this[cache]=to(this._rgba)),void 0===value)return this[cache].slice();var ret,type=jQuery.type(value),arr="array"===type||"object"===type?value:arguments,local=this[cache].slice();return each(props,function(key,prop){var val=arr["object"===type?key:prop.idx];null==val&&(val=local[prop.idx]),local[prop.idx]=clamp(val,prop)}),from?(ret=color(from(local)),ret[cache]=local,ret):color(local)},each(props,function(key,prop){color.fn[key]||(color.fn[key]=function(value){var match,vtype=jQuery.type(value),fn="alpha"===key?this._hsla?"hsla":"rgba":spaceName,local=this[fn](),cur=local[prop.idx];return"undefined"===vtype?cur:("function"===vtype&&(value=value.call(this,cur),vtype=jQuery.type(value)),null==value&&prop.empty?this:("string"===vtype&&(match=rplusequals.exec(value))&&(value=cur+parseFloat(match[2])*("+"===match[1]?1:-1)),local[prop.idx]=value,this[fn](local)))})})}),color.hook=function(hook){var hooks=hook.split(" ");each(hooks,function(i,hook){jQuery.cssHooks[hook]={set:function(elem,value){var parsed,curElem,backgroundColor="";if("transparent"!==value&&("string"!==jQuery.type(value)||(parsed=stringParse(value)))){if(value=color(parsed||value),!support.rgba&&1!==value._rgba[3]){for(curElem="backgroundColor"===hook?elem.parentNode:elem;(""===backgroundColor||"transparent"===backgroundColor)&&curElem&&curElem.style;)try{backgroundColor=jQuery.css(curElem,"backgroundColor"),curElem=curElem.parentNode}catch(e){}value=value.blend(backgroundColor&&"transparent"!==backgroundColor?backgroundColor:"_default")}value=value.toRgbaString()}try{elem.style[hook]=value}catch(e){}}},jQuery.fx.step[hook]=function(fx){fx.colorInit||(fx.start=color(fx.elem,hook),fx.end=color(fx.end),fx.colorInit=!0),jQuery.cssHooks[hook].set(fx.elem,fx.start.transition(fx.end,fx.pos))}})},color.hook("backgroundColor borderBottomColor borderLeftColor borderRightColor borderTopColor color columnRuleColor outlineColor textDecorationColor textEmphasisColor"),jQuery.cssHooks.borderColor={expand:function(value){var expanded={};return each(["Top","Right","Bottom","Left"],function(i,part){expanded["border"+part+"Color"]=value}),expanded}},colors=jQuery.Color.names={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00",transparent:[null,null,null,0],_default:"#ffffff"}}(jQuery),function(){var classAnimationActions=["add","remove","toggle"],shorthandStyles={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};$.each(["borderLeftStyle","borderRightStyle","borderBottomStyle","borderTopStyle"],function(_,prop){$.fx.step[prop]=function(fx){("none"!==fx.end&&!fx.setAttr||1===fx.pos&&!fx.setAttr)&&(jQuery.style(fx.elem,prop,fx.end),fx.setAttr=!0)}});function getElementStyles(elem){var key,len,style=elem.ownerDocument.defaultView?elem.ownerDocument.defaultView.getComputedStyle(elem,null):elem.currentStyle,styles={};if(style&&style.length&&style[0]&&style[style[0]])for(len=style.length;len--;)key=style[len],"string"==typeof style[key]&&(styles[$.camelCase(key)]=style[key]);else for(key in style)"string"==typeof style[key]&&(styles[key]=style[key]);return styles}function styleDifference(oldStyle,newStyle){var name,value,diff={};for(name in newStyle)value=newStyle[name],oldStyle[name]!==value&&(shorthandStyles[name]||!$.fx.step[name]&&isNaN(parseFloat(value))||(diff[name]=value));return diff}$.fn.addBack||($.fn.addBack=function(selector){return this.add(null==selector?this.prevObject:this.prevObject.filter(selector))}),$.effects.animateClass=function(value,duration,easing,callback){var o=$.speed(duration,easing,callback);return this.queue(function(){var applyClassChange,animated=$(this),baseClass=animated.attr("class")||"",allAnimations=o.children?animated.find("*").addBack():animated;allAnimations=allAnimations.map(function(){return{el:$(this),start:getElementStyles(this)}}),applyClassChange=function(){$.each(classAnimationActions,function(i,action){value[action]&&animated[action+"Class"](value[action])})},applyClassChange(),allAnimations=allAnimations.map(function(){return this.end=getElementStyles(this.el[0]),this.diff=styleDifference(this.start,this.end),this}),animated.attr("class",baseClass),allAnimations=allAnimations.map(function(){var styleInfo=this,dfd=$.Deferred(),opts=$.extend({},o,{queue:!1,complete:function(){dfd.resolve(styleInfo)}});return this.el.animate(this.diff,opts),dfd.promise()}),$.when.apply($,allAnimations.get()).done(function(){applyClassChange(),$.each(arguments,function(){var el=this.el;$.each(this.diff,function(key){el.css(key,"")})}),o.complete.call(animated[0])})})},$.fn.extend({addClass:function(orig){return function(classNames,speed,easing,callback){return speed?$.effects.animateClass.call(this,{add:classNames},speed,easing,callback):orig.apply(this,arguments)}}($.fn.addClass),removeClass:function(orig){return function(classNames,speed,easing,callback){return arguments.length>1?$.effects.animateClass.call(this,{remove:classNames},speed,easing,callback):orig.apply(this,arguments)}}($.fn.removeClass),toggleClass:function(orig){return function(classNames,force,speed,easing,callback){return"boolean"==typeof force||void 0===force?speed?$.effects.animateClass.call(this,force?{add:classNames}:{remove:classNames},speed,easing,callback):orig.apply(this,arguments):$.effects.animateClass.call(this,{toggle:classNames},force,speed,easing)}}($.fn.toggleClass),switchClass:function(remove,add,speed,easing,callback){return $.effects.animateClass.call(this,{add:add,remove:remove},speed,easing,callback)}})}(),function(){$.extend($.effects,{version:"1.11.4",save:function(element,set){for(var i=0;i<set.length;i++)null!==set[i]&&element.data("ui-effects-"+set[i],element[0].style[set[i]])},restore:function(element,set){var val,i;for(i=0;i<set.length;i++)null!==set[i]&&(val=element.data("ui-effects-"+set[i]),void 0===val&&(val=""),element.css(set[i],val))},setMode:function(el,mode){return"toggle"===mode&&(mode=el.is(":hidden")?"show":"hide"),mode},getBaseline:function(origin,original){var y,x;switch(origin[0]){case"top":y=0;break;case"middle":y=.5;break;case"bottom":y=1;break;default:y=origin[0]/original.height}switch(origin[1]){case"left":x=0;break;case"center":x=.5;break;case"right":x=1;break;default:x=origin[1]/original.width}return{x:x,y:y}},createWrapper:function(element){if(element.parent().is(".ui-effects-wrapper"))return element.parent();var props={width:element.outerWidth(!0),height:element.outerHeight(!0),float:element.css("float")},wrapper=$("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0}),size={width:element.width(),height:element.height()},active=document.activeElement;try{active.id}catch(e){active=document.body}return element.wrap(wrapper),(element[0]===active||$.contains(element[0],active))&&$(active).focus(),wrapper=element.parent(),"static"===element.css("position")?(wrapper.css({position:"relative"}),element.css({position:"relative"})):($.extend(props,{position:element.css("position"),zIndex:element.css("z-index")}),$.each(["top","left","bottom","right"],function(i,pos){props[pos]=element.css(pos),isNaN(parseInt(props[pos],10))&&(props[pos]="auto")}),element.css({position:"relative",top:0,left:0,right:"auto",bottom:"auto"})),element.css(size),wrapper.css(props).show()},removeWrapper:function(element){var active=document.activeElement;return element.parent().is(".ui-effects-wrapper")&&(element.parent().replaceWith(element),(element[0]===active||$.contains(element[0],active))&&$(active).focus()),element},setTransition:function(element,list,factor,value){return value=value||{},$.each(list,function(i,x){var unit=element.cssUnit(x);unit[0]>0&&(value[x]=unit[0]*factor+unit[1])}),value}});function _normalizeArguments(effect,options,speed,callback){return $.isPlainObject(effect)&&(options=effect,effect=effect.effect),effect={effect:effect},null==options&&(options={}),$.isFunction(options)&&(callback=options,speed=null,options={}),("number"==typeof options||$.fx.speeds[options])&&(callback=speed,speed=options,options={}),$.isFunction(speed)&&(callback=speed,speed=null),options&&$.extend(effect,options),speed=speed||options.duration,effect.duration=$.fx.off?0:"number"==typeof speed?speed:speed in $.fx.speeds?$.fx.speeds[speed]:$.fx.speeds._default,effect.complete=callback||options.complete,effect}function standardAnimationOption(option){return!(option&&"number"!=typeof option&&!$.fx.speeds[option])||("string"==typeof option&&!$.effects.effect[option]||(!!$.isFunction(option)||"object"==typeof option&&!option.effect))}$.fn.extend({effect:function(){var args=_normalizeArguments.apply(this,arguments),mode=args.mode,queue=args.queue,effectMethod=$.effects.effect[args.effect];if($.fx.off||!effectMethod)return mode?this[mode](args.duration,args.complete):this.each(function(){args.complete&&args.complete.call(this)});function run(next){var elem=$(this),complete=args.complete,mode=args.mode;function done(){$.isFunction(complete)&&complete.call(elem[0]),$.isFunction(next)&&next()}(elem.is(":hidden")?"hide"===mode:"show"===mode)?(elem[mode](),done()):effectMethod.call(elem[0],args,done)}return!1===queue?this.each(run):this.queue(queue||"fx",run)},show:function(orig){return function(option){if(standardAnimationOption(option))return orig.apply(this,arguments);var args=_normalizeArguments.apply(this,arguments);return args.mode="show",this.effect.call(this,args)}}($.fn.show),hide:function(orig){return function(option){if(standardAnimationOption(option))return orig.apply(this,arguments);var args=_normalizeArguments.apply(this,arguments);return args.mode="hide",this.effect.call(this,args)}}($.fn.hide),toggle:function(orig){return function(option){if(standardAnimationOption(option)||"boolean"==typeof option)return orig.apply(this,arguments);var args=_normalizeArguments.apply(this,arguments);return args.mode="toggle",this.effect.call(this,args)}}($.fn.toggle),cssUnit:function(key){var style=this.css(key),val=[];return $.each(["em","px","%","pt"],function(i,unit){style.indexOf(unit)>0&&(val=[parseFloat(style),unit])}),val}})}(),function(){var baseEasings={};$.each(["Quad","Cubic","Quart","Quint","Expo"],function(i,name){baseEasings[name]=function(p){return Math.pow(p,i+2)}}),$.extend(baseEasings,{Sine:function(p){return 1-Math.cos(p*Math.PI/2)},Circ:function(p){return 1-Math.sqrt(1-p*p)},Elastic:function(p){return 0===p||1===p?p:-Math.pow(2,8*(p-1))*Math.sin((80*(p-1)-7.5)*Math.PI/15)},Back:function(p){return p*p*(3*p-2)},Bounce:function(p){for(var pow2,bounce=4;p<((pow2=Math.pow(2,--bounce))-1)/11;);return 1/Math.pow(4,3-bounce)-7.5625*Math.pow((3*pow2-2)/22-p,2)}}),$.each(baseEasings,function(name,easeIn){$.easing["easeIn"+name]=easeIn,$.easing["easeOut"+name]=function(p){return 1-easeIn(1-p)},$.easing["easeInOut"+name]=function(p){return p<.5?easeIn(2*p)/2:1-easeIn(-2*p+2)/2}})}();$.effects,$.effects.effect.blind=function(o,done){var wrapper,distance,margin,el=$(this),rvertical=/up|down|vertical/,rpositivemotion=/up|left|vertical|horizontal/,props=["position","top","bottom","left","right","height","width"],mode=$.effects.setMode(el,o.mode||"hide"),direction=o.direction||"up",vertical=rvertical.test(direction),ref=vertical?"height":"width",ref2=vertical?"top":"left",motion=rpositivemotion.test(direction),animation={},show="show"===mode;el.parent().is(".ui-effects-wrapper")?$.effects.save(el.parent(),props):$.effects.save(el,props),el.show(),wrapper=$.effects.createWrapper(el).css({overflow:"hidden"}),distance=wrapper[ref](),margin=parseFloat(wrapper.css(ref2))||0,animation[ref]=show?distance:0,motion||(el.css(vertical?"bottom":"right",0).css(vertical?"top":"left","auto").css({position:"absolute"}),animation[ref2]=show?margin:distance+margin),show&&(wrapper.css(ref,0),motion||wrapper.css(ref2,margin+distance)),wrapper.animate(animation,{duration:o.duration,easing:o.easing,queue:!1,complete:function(){"hide"===mode&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}})},$.effects.effect.bounce=function(o,done){var i,upAnim,downAnim,el=$(this),props=["position","top","bottom","left","right","height","width"],mode=$.effects.setMode(el,o.mode||"effect"),hide="hide"===mode,show="show"===mode,direction=o.direction||"up",distance=o.distance,times=o.times||5,anims=2*times+(show||hide?1:0),speed=o.duration/anims,easing=o.easing,ref="up"===direction||"down"===direction?"top":"left",motion="up"===direction||"left"===direction,queue=el.queue(),queuelen=queue.length;for((show||hide)&&props.push("opacity"),$.effects.save(el,props),el.show(),$.effects.createWrapper(el),distance||(distance=el["top"===ref?"outerHeight":"outerWidth"]()/3),show&&(downAnim={opacity:1},downAnim[ref]=0,el.css("opacity",0).css(ref,motion?2*-distance:2*distance).animate(downAnim,speed,easing)),hide&&(distance/=Math.pow(2,times-1)),downAnim={},downAnim[ref]=0,i=0;i<times;i++)upAnim={},upAnim[ref]=(motion?"-=":"+=")+distance,el.animate(upAnim,speed,easing).animate(downAnim,speed,easing),distance=hide?2*distance:distance/2;hide&&(upAnim={opacity:0},upAnim[ref]=(motion?"-=":"+=")+distance,el.animate(upAnim,speed,easing)),el.queue(function(){hide&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}),queuelen>1&&queue.splice.apply(queue,[1,0].concat(queue.splice(queuelen,anims+1))),el.dequeue()},$.effects.effect.clip=function(o,done){var wrapper,animate,distance,el=$(this),props=["position","top","bottom","left","right","height","width"],mode=$.effects.setMode(el,o.mode||"hide"),show="show"===mode,direction=o.direction||"vertical",vert="vertical"===direction,size=vert?"height":"width",position=vert?"top":"left",animation={};$.effects.save(el,props),el.show(),wrapper=$.effects.createWrapper(el).css({overflow:"hidden"}),animate="IMG"===el[0].tagName?wrapper:el,distance=animate[size](),show&&(animate.css(size,0),animate.css(position,distance/2)),animation[size]=show?distance:0,animation[position]=show?0:distance/2,animate.animate(animation,{queue:!1,duration:o.duration,easing:o.easing,complete:function(){show||el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}})},$.effects.effect.drop=function(o,done){var distance,el=$(this),props=["position","top","bottom","left","right","opacity","height","width"],mode=$.effects.setMode(el,o.mode||"hide"),show="show"===mode,direction=o.direction||"left",ref="up"===direction||"down"===direction?"top":"left",motion="up"===direction||"left"===direction?"pos":"neg",animation={opacity:show?1:0};$.effects.save(el,props),el.show(),$.effects.createWrapper(el),distance=o.distance||el["top"===ref?"outerHeight":"outerWidth"](!0)/2,show&&el.css("opacity",0).css(ref,"pos"===motion?-distance:distance),animation[ref]=(show?"pos"===motion?"+=":"-=":"pos"===motion?"-=":"+=")+distance,el.animate(animation,{queue:!1,duration:o.duration,easing:o.easing,complete:function(){"hide"===mode&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}})},$.effects.effect.explode=function(o,done){var i,j,left,top,mx,my,rows=o.pieces?Math.round(Math.sqrt(o.pieces)):3,cells=rows,el=$(this),mode=$.effects.setMode(el,o.mode||"hide"),show="show"===mode,offset=el.show().css("visibility","hidden").offset(),width=Math.ceil(el.outerWidth()/cells),height=Math.ceil(el.outerHeight()/rows),pieces=[];function childComplete(){pieces.push(this),pieces.length===rows*cells&&animComplete()}for(i=0;i<rows;i++)for(top=offset.top+i*height,my=i-(rows-1)/2,j=0;j<cells;j++)left=offset.left+j*width,mx=j-(cells-1)/2,el.clone().appendTo("body").wrap("<div></div>").css({position:"absolute",visibility:"visible",left:-j*width,top:-i*height}).parent().addClass("ui-effects-explode").css({position:"absolute",overflow:"hidden",width:width,height:height,left:left+(show?mx*width:0),top:top+(show?my*height:0),opacity:show?0:1}).animate({left:left+(show?0:mx*width),top:top+(show?0:my*height),opacity:show?1:0},o.duration||500,o.easing,childComplete);function animComplete(){el.css({visibility:"visible"}),$(pieces).remove(),show||el.hide(),done()}},$.effects.effect.fade=function(o,done){var el=$(this),mode=$.effects.setMode(el,o.mode||"toggle");el.animate({opacity:mode},{queue:!1,duration:o.duration,easing:o.easing,complete:done})},$.effects.effect.fold=function(o,done){var wrapper,distance,el=$(this),props=["position","top","bottom","left","right","height","width"],mode=$.effects.setMode(el,o.mode||"hide"),show="show"===mode,hide="hide"===mode,size=o.size||15,percent=/([0-9]+)%/.exec(size),horizFirst=!!o.horizFirst,widthFirst=show!==horizFirst,ref=widthFirst?["width","height"]:["height","width"],duration=o.duration/2,animation1={},animation2={};$.effects.save(el,props),el.show(),wrapper=$.effects.createWrapper(el).css({overflow:"hidden"}),distance=widthFirst?[wrapper.width(),wrapper.height()]:[wrapper.height(),wrapper.width()],percent&&(size=parseInt(percent[1],10)/100*distance[hide?0:1]),show&&wrapper.css(horizFirst?{height:0,width:size}:{height:size,width:0}),animation1[ref[0]]=show?distance[0]:size,animation2[ref[1]]=show?distance[1]:0,wrapper.animate(animation1,duration,o.easing).animate(animation2,duration,o.easing,function(){hide&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()})},$.effects.effect.highlight=function(o,done){var elem=$(this),props=["backgroundImage","backgroundColor","opacity"],mode=$.effects.setMode(elem,o.mode||"show"),animation={backgroundColor:elem.css("backgroundColor")};"hide"===mode&&(animation.opacity=0),$.effects.save(elem,props),elem.show().css({backgroundImage:"none",backgroundColor:o.color||"#ffff99"}).animate(animation,{queue:!1,duration:o.duration,easing:o.easing,complete:function(){"hide"===mode&&elem.hide(),$.effects.restore(elem,props),done()}})},$.effects.effect.size=function(o,done){var original,baseline,factor,el=$(this),props0=["position","top","bottom","left","right","width","height","overflow","opacity"],props1=["position","top","bottom","left","right","overflow","opacity"],props2=["width","height","overflow"],cProps=["fontSize"],vProps=["borderTopWidth","borderBottomWidth","paddingTop","paddingBottom"],hProps=["borderLeftWidth","borderRightWidth","paddingLeft","paddingRight"],mode=$.effects.setMode(el,o.mode||"effect"),restore=o.restore||"effect"!==mode,scale=o.scale||"both",origin=o.origin||["middle","center"],position=el.css("position"),props=restore?props0:props1,zero={height:0,width:0,outerHeight:0,outerWidth:0};"show"===mode&&el.show(),original={height:el.height(),width:el.width(),outerHeight:el.outerHeight(),outerWidth:el.outerWidth()},"toggle"===o.mode&&"show"===mode?(el.from=o.to||zero,el.to=o.from||original):(el.from=o.from||("show"===mode?zero:original),el.to=o.to||("hide"===mode?zero:original)),factor={from:{y:el.from.height/original.height,x:el.from.width/original.width},to:{y:el.to.height/original.height,x:el.to.width/original.width}},"box"!==scale&&"both"!==scale||(factor.from.y!==factor.to.y&&(props=props.concat(vProps),el.from=$.effects.setTransition(el,vProps,factor.from.y,el.from),el.to=$.effects.setTransition(el,vProps,factor.to.y,el.to)),factor.from.x!==factor.to.x&&(props=props.concat(hProps),el.from=$.effects.setTransition(el,hProps,factor.from.x,el.from),el.to=$.effects.setTransition(el,hProps,factor.to.x,el.to))),
"content"!==scale&&"both"!==scale||factor.from.y!==factor.to.y&&(props=props.concat(cProps).concat(props2),el.from=$.effects.setTransition(el,cProps,factor.from.y,el.from),el.to=$.effects.setTransition(el,cProps,factor.to.y,el.to)),$.effects.save(el,props),el.show(),$.effects.createWrapper(el),el.css("overflow","hidden").css(el.from),origin&&(baseline=$.effects.getBaseline(origin,original),el.from.top=(original.outerHeight-el.outerHeight())*baseline.y,el.from.left=(original.outerWidth-el.outerWidth())*baseline.x,el.to.top=(original.outerHeight-el.to.outerHeight)*baseline.y,el.to.left=(original.outerWidth-el.to.outerWidth)*baseline.x),el.css(el.from),"content"!==scale&&"both"!==scale||(vProps=vProps.concat(["marginTop","marginBottom"]).concat(cProps),hProps=hProps.concat(["marginLeft","marginRight"]),props2=props0.concat(vProps).concat(hProps),el.find("*[width]").each(function(){var child=$(this),c_original={height:child.height(),width:child.width(),outerHeight:child.outerHeight(),outerWidth:child.outerWidth()};restore&&$.effects.save(child,props2),child.from={height:c_original.height*factor.from.y,width:c_original.width*factor.from.x,outerHeight:c_original.outerHeight*factor.from.y,outerWidth:c_original.outerWidth*factor.from.x},child.to={height:c_original.height*factor.to.y,width:c_original.width*factor.to.x,outerHeight:c_original.height*factor.to.y,outerWidth:c_original.width*factor.to.x},factor.from.y!==factor.to.y&&(child.from=$.effects.setTransition(child,vProps,factor.from.y,child.from),child.to=$.effects.setTransition(child,vProps,factor.to.y,child.to)),factor.from.x!==factor.to.x&&(child.from=$.effects.setTransition(child,hProps,factor.from.x,child.from),child.to=$.effects.setTransition(child,hProps,factor.to.x,child.to)),child.css(child.from),child.animate(child.to,o.duration,o.easing,function(){restore&&$.effects.restore(child,props2)})})),el.animate(el.to,{queue:!1,duration:o.duration,easing:o.easing,complete:function(){0===el.to.opacity&&el.css("opacity",el.from.opacity),"hide"===mode&&el.hide(),$.effects.restore(el,props),restore||("static"===position?el.css({position:"relative",top:el.to.top,left:el.to.left}):$.each(["top","left"],function(idx,pos){el.css(pos,function(_,str){var val=parseInt(str,10),toRef=idx?el.to.left:el.to.top;return"auto"===str?toRef+"px":val+toRef+"px"})})),$.effects.removeWrapper(el),done()}})},$.effects.effect.scale=function(o,done){var el=$(this),options=$.extend(!0,{},o),mode=$.effects.setMode(el,o.mode||"effect"),percent=parseInt(o.percent,10)||(0===parseInt(o.percent,10)?0:"hide"===mode?0:100),direction=o.direction||"both",origin=o.origin,original={height:el.height(),width:el.width(),outerHeight:el.outerHeight(),outerWidth:el.outerWidth()},factor={y:"horizontal"!==direction?percent/100:1,x:"vertical"!==direction?percent/100:1};options.effect="size",options.queue=!1,options.complete=done,"effect"!==mode&&(options.origin=origin||["middle","center"],options.restore=!0),options.from=o.from||("show"===mode?{height:0,width:0,outerHeight:0,outerWidth:0}:original),options.to={height:original.height*factor.y,width:original.width*factor.x,outerHeight:original.outerHeight*factor.y,outerWidth:original.outerWidth*factor.x},options.fade&&("show"===mode&&(options.from.opacity=0,options.to.opacity=1),"hide"===mode&&(options.from.opacity=1,options.to.opacity=0)),el.effect(options)},$.effects.effect.puff=function(o,done){var elem=$(this),mode=$.effects.setMode(elem,o.mode||"hide"),hide="hide"===mode,percent=parseInt(o.percent,10)||150,factor=percent/100,original={height:elem.height(),width:elem.width(),outerHeight:elem.outerHeight(),outerWidth:elem.outerWidth()};$.extend(o,{effect:"scale",queue:!1,fade:!0,mode:mode,complete:done,percent:hide?percent:100,from:hide?original:{height:original.height*factor,width:original.width*factor,outerHeight:original.outerHeight*factor,outerWidth:original.outerWidth*factor}}),elem.effect(o)},$.effects.effect.pulsate=function(o,done){var i,elem=$(this),mode=$.effects.setMode(elem,o.mode||"show"),show="show"===mode,hide="hide"===mode,showhide=show||"hide"===mode,anims=2*(o.times||5)+(showhide?1:0),duration=o.duration/anims,animateTo=0,queue=elem.queue(),queuelen=queue.length;for(!show&&elem.is(":visible")||(elem.css("opacity",0).show(),animateTo=1),i=1;i<anims;i++)elem.animate({opacity:animateTo},duration,o.easing),animateTo=1-animateTo;elem.animate({opacity:animateTo},duration,o.easing),elem.queue(function(){hide&&elem.hide(),done()}),queuelen>1&&queue.splice.apply(queue,[1,0].concat(queue.splice(queuelen,anims+1))),elem.dequeue()},$.effects.effect.shake=function(o,done){var i,el=$(this),props=["position","top","bottom","left","right","height","width"],mode=$.effects.setMode(el,o.mode||"effect"),direction=o.direction||"left",distance=o.distance||20,times=o.times||3,anims=2*times+1,speed=Math.round(o.duration/anims),ref="up"===direction||"down"===direction?"top":"left",positiveMotion="up"===direction||"left"===direction,animation={},animation1={},animation2={},queue=el.queue(),queuelen=queue.length;for($.effects.save(el,props),el.show(),$.effects.createWrapper(el),animation[ref]=(positiveMotion?"-=":"+=")+distance,animation1[ref]=(positiveMotion?"+=":"-=")+2*distance,animation2[ref]=(positiveMotion?"-=":"+=")+2*distance,el.animate(animation,speed,o.easing),i=1;i<times;i++)el.animate(animation1,speed,o.easing).animate(animation2,speed,o.easing);el.animate(animation1,speed,o.easing).animate(animation,speed/2,o.easing).queue(function(){"hide"===mode&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}),queuelen>1&&queue.splice.apply(queue,[1,0].concat(queue.splice(queuelen,anims+1))),el.dequeue()},$.effects.effect.slide=function(o,done){var distance,el=$(this),props=["position","top","bottom","left","right","width","height"],mode=$.effects.setMode(el,o.mode||"show"),show="show"===mode,direction=o.direction||"left",ref="up"===direction||"down"===direction?"top":"left",positiveMotion="up"===direction||"left"===direction,animation={};$.effects.save(el,props),el.show(),distance=o.distance||el["top"===ref?"outerHeight":"outerWidth"](!0),$.effects.createWrapper(el).css({overflow:"hidden"}),show&&el.css(ref,positiveMotion?isNaN(distance)?"-"+distance:-distance:distance),animation[ref]=(show?positiveMotion?"+=":"-=":positiveMotion?"-=":"+=")+distance,el.animate(animation,{queue:!1,duration:o.duration,easing:o.easing,complete:function(){"hide"===mode&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}})},$.effects.effect.transfer=function(o,done){var elem=$(this),target=$(o.to),targetFixed="fixed"===target.css("position"),body=$("body"),fixTop=targetFixed?body.scrollTop():0,fixLeft=targetFixed?body.scrollLeft():0,endPosition=target.offset(),animation={top:endPosition.top-fixTop,left:endPosition.left-fixLeft,height:target.innerHeight(),width:target.innerWidth()},startPosition=elem.offset(),transfer=$("<div class='ui-effects-transfer'></div>").appendTo(document.body).addClass(o.className).css({top:startPosition.top-fixTop,left:startPosition.left-fixLeft,height:elem.innerHeight(),width:elem.innerWidth(),position:targetFixed?"fixed":"absolute"}).animate(animation,o.duration,o.easing,function(){transfer.remove(),done()})}}),function($){$.support.touch="ontouchend"in document||navigator.maxTouchPoints>0;function simulateMouseEvent(event,simulatedType){if(!(event.originalEvent.touches.length>1)){event.preventDefault();var touch=event.originalEvent.changedTouches[0],simulatedEvent=document.createEvent("MouseEvents");simulatedEvent.initMouseEvent(simulatedType,!0,!0,window,1,touch.screenX,touch.screenY,touch.clientX,touch.clientY,!1,!1,!1,!1,0,null),event.target.dispatchEvent(simulatedEvent)}}if($.support.touch){var touchHandled,mouseProto=$.ui.mouse.prototype,_mouseInit=mouseProto._mouseInit,_mouseDestroy=mouseProto._mouseDestroy;mouseProto._touchStart=function(event){var self=this;!touchHandled&&self._mouseCapture(event.originalEvent.changedTouches[0])&&(touchHandled=!0,self._touchMoved=!1,this._startedMove=event.timeStamp,simulateMouseEvent(event,"mouseover"),simulateMouseEvent(event,"mousemove"),simulateMouseEvent(event,"mousedown"))},mouseProto._touchMove=function(event){touchHandled&&(this._touchMoved=!0,simulateMouseEvent(event,"mousemove"))},mouseProto._touchEnd=function(event){if(touchHandled){simulateMouseEvent(event,"mouseup"),simulateMouseEvent(event,"mouseout");var timeMoving=event.timeStamp-this._startedMove;(!this._touchMoved||timeMoving<500)&&simulateMouseEvent(event,"click"),touchHandled=!1}},mouseProto._mouseInit=function(){var self=this;self.element.bind({touchstart:$.proxy(self,"_touchStart"),touchmove:$.proxy(self,"_touchMove"),touchend:$.proxy(self,"_touchEnd")}),_mouseInit.call(self)},mouseProto._mouseDestroy=function(){var self=this;self.element.unbind({touchstart:$.proxy(self,"_touchStart"),touchmove:$.proxy(self,"_touchMove"),touchend:$.proxy(self,"_touchEnd")}),_mouseDestroy.call(self)}}}(jQuery),window.Modernizr=function(a,b,c){function z(a){j.cssText=a}function B(a,b){return typeof a===b}function C(a,b){return!!~(""+a).indexOf(b)}function D(a,b){for(var d in a){var e=a[d];if(!C(e,"-")&&j[e]!==c)return"pfx"!=b||e}return!1}function E(a,b,d){for(var e in a){var f=b[a[e]];if(f!==c)return!1===d?a[e]:B(f,"function")?f.bind(d||b):f}return!1}function F(a,b,c){var d=a.charAt(0).toUpperCase()+a.slice(1),e=(a+" "+o.join(d+" ")+d).split(" ");return B(b,"string")||B(b,"undefined")?D(e,b):(e=(a+" "+p.join(d+" ")+d).split(" "),E(e,b,c))}var v,y,e={},g=b.documentElement,h="modernizr",i=b.createElement(h),j=i.style,m=" -webkit- -moz- -o- -ms- ".split(" "),n="Webkit Moz O ms",o=n.split(" "),p=n.toLowerCase().split(" "),q={},t=[],u=t.slice,w=function(a,c,d,e){var f,i,j,k,l=b.createElement("div"),m=b.body,n=m||b.createElement("body");if(parseInt(d,10))for(;d--;)j=b.createElement("div"),j.id=e?e[d]:h+(d+1),l.appendChild(j);return f=["&#173;",'<style id="s',h,'">',a,"</style>"].join(""),l.id=h,(m?l:n).innerHTML+=f,n.appendChild(l),m||(n.style.background="",n.style.overflow="hidden",k=g.style.overflow,g.style.overflow="hidden",g.appendChild(n)),i=c(l,a),m?l.parentNode.removeChild(l):(n.parentNode.removeChild(n),g.style.overflow=k),!!i},x={}.hasOwnProperty;y=B(x,"undefined")||B(x.call,"undefined")?function(a,b){return b in a&&B(a.constructor.prototype[b],"undefined")}:function(a,b){return x.call(a,b)},Function.prototype.bind||(Function.prototype.bind=function(b){var c=this;if("function"!=typeof c)throw new TypeError;var d=u.call(arguments,1),e=function(){if(this instanceof e){var a=function(){};a.prototype=c.prototype;var f=new a,g=c.apply(f,d.concat(u.call(arguments)));return Object(g)===g?g:f}return c.apply(b,d.concat(u.call(arguments)))};return e}),q.csstransforms3d=function(){var a=!!F("perspective");return a&&"webkitPerspective"in g.style&&w("@media (transform-3d),(-webkit-transform-3d){#modernizr{left:9px;position:absolute;height:3px;}}",function(b,c){a=9===b.offsetLeft&&3===b.offsetHeight}),a},q.csstransitions=function(){return F("transition")};for(var G in q)y(q,G)&&(v=G.toLowerCase(),e[v]=q[G](),t.push((e[v]?"":"no-")+v));return e.addTest=function(a,b){if("object"==typeof a)for(var d in a)y(a,d)&&e.addTest(d,a[d]);else{if(a=a.toLowerCase(),e[a]!==c)return e;b="function"==typeof b?b():b,g.className+=" "+(b?"":"no-")+a,e[a]=b}return e},z(""),i=null,function(a,b){function k(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"</style>",d.insertBefore(c.lastChild,d.firstChild)}function l(){var a=r.elements;return"string"==typeof a?a.split(" "):a}function m(a){var b=i[a[g]];return b||(b={},h++,a[g]=h,i[h]=b),b}function n(a,c,f){if(c||(c=b),j)return c.createElement(a);f||(f=m(c));var g;return g=f.cache[a]?f.cache[a].cloneNode():e.test(a)?(f.cache[a]=f.createElem(a)).cloneNode():f.createElem(a),g.canHaveChildren&&!d.test(a)?f.frag.appendChild(g):g}function o(a,c){if(a||(a=b),j)return a.createDocumentFragment();c=c||m(a);for(var d=c.frag.cloneNode(),e=0,f=l(),g=f.length;e<g;e++)d.createElement(f[e]);return d}function p(a,b){b.cache||(b.cache={},b.createElem=a.createElement,b.createFrag=a.createDocumentFragment,b.frag=b.createFrag()),a.createElement=function(c){return r.shivMethods?n(c,a,b):b.createElem(c)},a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+l().join().replace(/\w+/g,function(a){return b.createElem(a),b.frag.createElement(a),'c("'+a+'")'})+");return n}")(r,b.frag)}function q(a){a||(a=b);var c=m(a);return r.shivCSS&&!f&&!c.hasCSS&&(c.hasCSS=!!k(a,"article,aside,figcaption,figure,footer,header,hgroup,nav,section{display:block}mark{background:#FF0;color:#000}")),j||p(a,c),a}var f,j,c=a.html5||{},d=/^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i,e=/^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i,g="_html5shiv",h=0,i={};!function(){try{var a=b.createElement("a");a.innerHTML="<xyz></xyz>",f="hidden"in a,j=1==a.childNodes.length||function(){b.createElement("a");var a=b.createDocumentFragment();return void 0===a.cloneNode||void 0===a.createDocumentFragment||void 0===a.createElement}()}catch(c){f=!0,j=!0}}();var r={elements:c.elements||"abbr article aside audio bdi canvas data datalist details figcaption figure footer header hgroup mark meter nav output progress section summary time video",shivCSS:!1!==c.shivCSS,supportsUnknownElements:j,shivMethods:!1!==c.shivMethods,type:"default",shivDocument:q,createElement:n,createDocumentFragment:o};a.html5=r,q(b)}(this,b),e._version="2.6.2",e._prefixes=m,e._domPrefixes=p,e._cssomPrefixes=o,e.testProp=function(a){return D([a])},e.testAllProps=F,e.testStyles=w,e.prefixed=function(a,b,c){return b?F(a,b,c):F(a,"pfx")},g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+" js "+t.join(" "),e}(0,this.document),function(a,b,c){function d(a){return"[object Function]"==o.call(a)}function e(a){return"string"==typeof a}function f(){}function g(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function h(){var a=p.shift();q=1,a?a.t?m(function(){("c"==a.t?B.injectCss:B.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):q=0}function i(a,c,d,e,f,i,j){function k(b){if(!o&&g(l.readyState)&&(u.r=o=1,!q&&h(),l.onload=l.onreadystatechange=null,b)){"img"!=a&&m(function(){t.removeChild(l)},50);for(var d in y[c])y[c].hasOwnProperty(d)&&y[c][d].onload()}}var j=j||B.errorTimeout,l=b.createElement(a),o=0,r=0,u={t:d,s:c,e:f,a:i,x:j};1===y[c]&&(r=1,y[c]=[]),"object"==a?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,r)},p.splice(e,0,u),"img"!=a&&(r||2===y[c]?(t.insertBefore(l,s?null:n),m(k,j)):y[c].push(l))}function j(a,b,c,d,f){return q=0,b=b||"j",e(a)?i("c"==b?v:u,a,b,this.i++,c,d,f):(p.splice(this.i++,0,a),1==p.length&&h()),this}function k(){var a=B;return a.loader={load:j,i:0},a}var A,B,l=b.documentElement,m=a.setTimeout,n=b.getElementsByTagName("script")[0],o={}.toString,p=[],q=0,r="MozAppearance"in l.style,s=r&&!!b.createRange().compareNode,t=s?l:n.parentNode,l=a.opera&&"[object Opera]"==o.call(a.opera),l=!!b.attachEvent&&!l,u=r?"object":l?"script":"img",v=l?"script":u,w=Array.isArray||function(a){return"[object Array]"==o.call(a)},x=[],y={},z={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}};B=function(a){function b(a){var e,f,g,a=a.split("!"),b=x.length,c=a.pop(),d=a.length,c={url:c,origUrl:c,prefixes:a};for(f=0;f<d;f++)g=a[f].split("="),(e=z[g.shift()])&&(c=e(c,g));for(f=0;f<b;f++)c=x[f](c);return c}function g(a,e,f,g,h){var i=b(a),j=i.autoCallback;i.url.split(".").pop().split("?").shift(),i.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]),i.instead?i.instead(a,e,f,g,h):(y[i.url]?i.noexec=!0:y[i.url]=1,f.load(i.url,i.forceCSS||!i.forceJS&&"css"==i.url.split(".").pop().split("?").shift()?"c":c,i.noexec,i.attrs,i.timeout),(d(e)||d(j))&&f.load(function(){k(),e&&e(i.origUrl,h,g),j&&j(i.origUrl,h,g),y[i.url]=2})))}function h(a,b){function c(a,c){if(a){if(e(a))c||(j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}),g(a,j,b,0,h);else if(Object(a)===a)for(n in m=function(){var c,b=0;for(c in a)a.hasOwnProperty(c)&&b++;return b}(),a)a.hasOwnProperty(n)&&(!c&&!--m&&(d(j)?j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}:j[n]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),l()}}(k[n])),g(a[n],j,b,n,h))}else!c&&l()}var m,n,h=!!a.test,i=a.load||a.both,j=a.callback||f,k=j,l=a.complete||f;c(h?a.yep:a.nope,!!i),i&&c(i)}var i,j,l=this.yepnope.loader;if(e(a))g(a,0,l,0);else if(w(a))for(i=0;i<a.length;i++)j=a[i],e(j)?g(j,0,l,0):w(j)?B(j):Object(j)===j&&h(j,l);else Object(a)===a&&h(a,l)},B.addPrefix=function(a,b){z[a]=b},B.addFilter=function(a){x.push(a)},B.errorTimeout=1e4,null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",A=function(){b.removeEventListener("DOMContentLoaded",A,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var l,o,k=b.createElement("script"),e=e||B.errorTimeout;k.src=a;for(o in d)k.setAttribute(o,d[o]);c=j?h:c||f,k.onreadystatechange=k.onload=function(){!l&&g(k.readyState)&&(l=1,c(),k.onload=k.onreadystatechange=null)},m(function(){l||(l=1,c(1))},e),i?k.onload():n.parentNode.insertBefore(k,n)},a.yepnope.injectCss=function(a,c,d,e,g,i){var j,e=b.createElement("link"),c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(n.parentNode.insertBefore(e,n),m(c,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))},function($,window,undefined){"use strict";var $window=$(window),Modernizr=window.Modernizr;Modernizr.addTest("csstransformspreserve3d",function(){var computedStyle,prop=Modernizr.prefixed("transformStyle"),val="preserve-3d";return!!prop&&(prop=prop.replace(/([A-Z])/g,function(str,m1){return"-"+m1.toLowerCase()}).replace(/^ms-/,"-ms-"),Modernizr.testStyles("#modernizr{"+prop+":"+val+";}",function(el,rule){computedStyle=window.getComputedStyle?getComputedStyle(el,null).getPropertyValue(prop):""}),computedStyle===val)});var $special,resizeTimeout,$event=$.event;$special=$event.special.debouncedresize={setup:function(){$(this).on("resize",$special.handler)},teardown:function(){$(this).off("resize",$special.handler)},handler:function(event,execAsap){var context=this,args=arguments,dispatch=function(){event.type="debouncedresize",$event.dispatch.apply(context,args)};resizeTimeout&&clearTimeout(resizeTimeout),execAsap?dispatch():resizeTimeout=setTimeout(dispatch,$special.threshold)},threshold:150},$.BookBlock=function(options,element){this.$el=$(element),this._init(options)},$.BookBlock.defaults={startPage:1,orientation:"vertical",direction:"ltr",speed:1e3,easing:"ease-in-out",shadows:!0,shadowSides:.2,shadowFlip:.1,circular:!1,nextEl:"",prevEl:"",autoplay:!1,interval:3e3,onEndFlip:function(old,page,isLimit){return!1},onBeforeFlip:function(page){return!1}},$.BookBlock.prototype={_init:function(options){this.options=$.extend(!0,{},$.BookBlock.defaults,options),this.$el.addClass("bb-"+this.options.orientation),this.$items=this.$el.children(".bb-item").hide(),this.itemsCount=this.$items.length,this.options.startPage>0&&this.options.startPage<=this.itemsCount?this.current=this.options.startPage-1:(logError("startPage option is out of range"),this.current=0),this.previous=-1,this.$current=this.$items.eq(this.current).show(),this.elWidth=this.$el.width();var transEndEventNames={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"};this.transEndEventName=transEndEventNames[Modernizr.prefixed("transition")]+".bookblock",this.support=Modernizr.csstransitions&&Modernizr.csstransforms3d&&Modernizr.csstransformspreserve3d,this._initEvents(),this.options.autoplay&&(this.options.circular=!0,this._startSlideshow())},_initEvents:function(){var self=this;""!==this.options.nextEl&&$(this.options.nextEl).on("click.bookblock touchstart.bookblock",function(){return self._action("next"),!1}),""!==this.options.prevEl&&$(this.options.prevEl).on("click.bookblock touchstart.bookblock",function(){return self._action("prev"),!1}),$window.on("debouncedresize",function(){self.elWidth=self.$el.width()})},_action:function(dir,page){this._stopSlideshow(),this._navigate(dir,page)},_navigate:function(dir,page){return!this.isAnimating&&(!this.options.onBeforeFlip(this.current,dir)&&(this.isAnimating=!0,this.$current=this.$items.eq(this.current),void 0!==page?this.current=page:"next"===dir&&"ltr"===this.options.direction||"prev"===dir&&"rtl"===this.options.direction?this.options.circular||this.current!==this.itemsCount-1?(this.previous=this.current,this.current=this.current<this.itemsCount-1?this.current+1:0):this.end=!0:("prev"===dir&&"ltr"===this.options.direction||"next"===dir&&"rtl"===this.options.direction)&&(this.options.circular||0!==this.current?(this.previous=this.current,this.current=this.current>0?this.current-1:this.itemsCount-1):this.end=!0),this.$nextItem=!this.options.circular&&this.end?this.$current:this.$items.eq(this.current),void(this.support?this._layout(dir):this._layoutNoSupport(dir))))},_layoutNoSupport:function(dir){this.$items.hide(),this.$nextItem.show(),this.end=!1,this.isAnimating=!1;var isLimit="next"===dir&&this.current===this.itemsCount-1||"prev"===dir&&0===this.current;this.options.onEndFlip(this.previous,this.current,isLimit)},_layout:function(dir){var self=this,$s_left=this._addSide("left",dir),$s_middle=this._addSide("middle",dir),$s_right=this._addSide("right",dir),$o_left=$s_left.find("div.bb-overlay"),$o_middle_f=$s_middle.find("div.bb-flipoverlay:first"),$o_middle_b=$s_middle.find("div.bb-flipoverlay:last"),$o_right=$s_right.find("div.bb-overlay"),speed=this.end?400:this.options.speed;if(this.$items.hide(),this.$el.prepend($s_left,$s_middle,$s_right),$s_middle.css({transitionDuration:speed+"ms",transitionTimingFunction:this.options.easing}).on(this.transEndEventName,function(event){if($(event.target).hasClass("bb-page")){self.$el.children(".bb-page").remove(),self.$nextItem.show(),self.end=!1,self.isAnimating=!1;var isLimit="next"===dir&&self.current===self.itemsCount-1||"prev"===dir&&0===self.current;$s_middle.is(".bb-flip-next-end, .bb-flip-previous-end")||self.options.onEndFlip(self.previous,self.current,isLimit)}}),"prev"===dir&&$s_middle.addClass("bb-flip-initial"),this.options.shadows&&!this.end){var o_left_style="next"===dir?{transition:"opacity "+this.options.speed/2+"ms linear "+this.options.speed/2+"ms"}:{transition:"opacity "+this.options.speed/2+"ms linear",opacity:this.options.shadowSides},o_middle_f_style="next"===dir?{transition:"opacity "+this.options.speed/2+"ms linear"}:{transition:"opacity "+this.options.speed/2+"ms linear "+this.options.speed/2+"ms",opacity:this.options.shadowFlip},o_middle_b_style="next"===dir?{transition:"opacity "+this.options.speed/2+"ms linear "+this.options.speed/2+"ms",opacity:this.options.shadowFlip}:{transition:"opacity "+this.options.speed/2+"ms linear"},o_right_style="next"===dir?{transition:"opacity "+this.options.speed/2+"ms linear",opacity:this.options.shadowSides}:{transition:"opacity "+this.options.speed/2+"ms linear "+this.options.speed/2+"ms"};$o_middle_f.css(o_middle_f_style),$o_middle_b.css(o_middle_b_style),$o_left.css(o_left_style),$o_right.css(o_right_style)}setTimeout(function(){$s_middle.addClass(self.end?"bb-flip-"+dir+"-end":"bb-flip-"+dir),self.options.shadows&&!self.end&&($o_middle_f.css({opacity:"next"===dir?self.options.shadowFlip:0}),$o_middle_b.css({opacity:"next"===dir?0:self.options.shadowFlip}),$o_left.css({opacity:"next"===dir?self.options.shadowSides:0}),$o_right.css({opacity:"next"===dir?0:self.options.shadowSides}))},25)},_addSide:function(side,dir){var $side;switch(side){case"left":$side=$('<div class="bb-page"><div class="bb-back"><div class="bb-outer"><div class="bb-content"><div class="bb-inner">'+("next"===dir?this.$current.html():this.$nextItem.html())+'</div></div><div class="bb-overlay"></div></div></div></div>').css("z-index",102);break;case"middle":$side=$('<div class="bb-page"><div class="bb-front"><div class="bb-outer"><div class="bb-content"><div class="bb-inner">'+("next"===dir?this.$current.html():this.$nextItem.html())+'</div></div><div class="bb-flipoverlay"></div></div></div><div class="bb-back"><div class="bb-outer"><div class="bb-content" style="width:'+this.elWidth+'px"><div class="bb-inner">'+("next"===dir?this.$nextItem.html():this.$current.html())+'</div></div><div class="bb-flipoverlay"></div></div></div></div>').css("z-index",103);break;case"right":$side=$('<div class="bb-page"><div class="bb-front"><div class="bb-outer"><div class="bb-content"><div class="bb-inner">'+("next"===dir?this.$nextItem.html():this.$current.html())+'</div></div><div class="bb-overlay"></div></div></div></div>').css("z-index",101)}return $side},_startSlideshow:function(){var self=this;this.slideshow=setTimeout(function(){self._navigate("next"),self.options.autoplay&&self._startSlideshow()},this.options.interval)},_stopSlideshow:function(){this.options.autoplay&&(clearTimeout(this.slideshow),this.options.autoplay=!1)},next:function(){this._action("ltr"===this.options.direction?"next":"prev")},prev:function(){this._action("ltr"===this.options.direction?"prev":"next")},jump:function(page){if((page-=1)===this.current||page>=this.itemsCount||page<0)return!1;var dir;dir="ltr"===this.options.direction?page>this.current?"next":"prev":page>this.current?"prev":"next",this._action(dir,page)},last:function(){this.jump(this.itemsCount)},first:function(){this.jump(1)},isActive:function(){return this.isAnimating},update:function(){var $currentItem=this.$items.eq(this.current);this.$items=this.$el.children(".bb-item"),this.itemsCount=this.$items.length,this.current=$currentItem.index()},destroy:function(){this.options.autoplay&&this._stopSlideshow(),this.$el.removeClass("bb-"+this.options.orientation),this.$items.show(),""!==this.options.nextEl&&$(this.options.nextEl).off(".bookblock"),""!==this.options.prevEl&&$(this.options.prevEl).off(".bookblock"),$window.off("debouncedresize")}};var logError=function(message){window.console&&window.console.error(message)};$.fn.bookblock=function(options){if("string"==typeof options){var args=Array.prototype.slice.call(arguments,1);this.each(function(){var instance=$.data(this,"bookblock");return instance?$.isFunction(instance[options])&&"_"!==options.charAt(0)?void instance[options].apply(instance,args):void logError("no such method '"+options+"' for bookblock instance"):void logError("cannot call methods on bookblock prior to initialization; attempted to call method '"+options+"'")})}else this.each(function(){var instance=$.data(this,"bookblock");instance?instance._init(options):instance=$.data(this,"bookblock",new $.BookBlock(options,this))});return this}}(jQuery,window),function(root,factory){"object"==typeof exports&&"object"==typeof module?module.exports=factory():"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?exports.Handlebars=factory():root.Handlebars=factory()}(this,function(){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={exports:{},id:moduleId,loaded:!1};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.loaded=!0,module.exports}return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.p="",__webpack_require__(0)}([function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _handlebarsRuntime=__webpack_require__(2),_handlebarsRuntime2=_interopRequireDefault(_handlebarsRuntime),_handlebarsCompilerAst=__webpack_require__(21),_handlebarsCompilerAst2=_interopRequireDefault(_handlebarsCompilerAst),_handlebarsCompilerBase=__webpack_require__(22),_handlebarsCompilerCompiler=__webpack_require__(27),_handlebarsCompilerJavascriptCompiler=__webpack_require__(28),_handlebarsCompilerJavascriptCompiler2=_interopRequireDefault(_handlebarsCompilerJavascriptCompiler),_handlebarsCompilerVisitor=__webpack_require__(25),_handlebarsCompilerVisitor2=_interopRequireDefault(_handlebarsCompilerVisitor),_handlebarsNoConflict=__webpack_require__(20),_handlebarsNoConflict2=_interopRequireDefault(_handlebarsNoConflict),_create=_handlebarsRuntime2.default.create;function create(){var hb=_create();return hb.compile=function(input,options){return _handlebarsCompilerCompiler.compile(input,options,hb)},hb.precompile=function(input,options){return _handlebarsCompilerCompiler.precompile(input,options,hb)},hb.AST=_handlebarsCompilerAst2.default,hb.Compiler=_handlebarsCompilerCompiler.Compiler,hb.JavaScriptCompiler=_handlebarsCompilerJavascriptCompiler2.default,hb.Parser=_handlebarsCompilerBase.parser,hb.parse=_handlebarsCompilerBase.parse,hb}var inst=create();inst.create=create,_handlebarsNoConflict2.default(inst),inst.Visitor=_handlebarsCompilerVisitor2.default,inst.default=inst,exports.default=inst,module.exports=exports.default},function(module,exports){"use strict";exports.default=function(obj){return obj&&obj.__esModule?obj:{default:obj}},exports.__esModule=!0},function(module,exports,__webpack_require__){"use strict";var _interopRequireWildcard=__webpack_require__(3).default,_interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _handlebarsBase=__webpack_require__(4),base=_interopRequireWildcard(_handlebarsBase),_handlebarsSafeString=__webpack_require__(18),_handlebarsSafeString2=_interopRequireDefault(_handlebarsSafeString),_handlebarsException=__webpack_require__(6),_handlebarsException2=_interopRequireDefault(_handlebarsException),_handlebarsUtils=__webpack_require__(5),Utils=_interopRequireWildcard(_handlebarsUtils),_handlebarsRuntime=__webpack_require__(19),runtime=_interopRequireWildcard(_handlebarsRuntime),_handlebarsNoConflict=__webpack_require__(20),_handlebarsNoConflict2=_interopRequireDefault(_handlebarsNoConflict);function create(){var hb=new base.HandlebarsEnvironment;return Utils.extend(hb,base),hb.SafeString=_handlebarsSafeString2.default,hb.Exception=_handlebarsException2.default,hb.Utils=Utils,hb.escapeExpression=Utils.escapeExpression,hb.VM=runtime,hb.template=function(spec){return runtime.template(spec,hb)},hb}var inst=create();inst.create=create,_handlebarsNoConflict2.default(inst),inst.default=inst,exports.default=inst,module.exports=exports.default},function(module,exports){"use strict";exports.default=function(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj},exports.__esModule=!0},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.HandlebarsEnvironment=HandlebarsEnvironment;var _utils=__webpack_require__(5),_exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception),_helpers=__webpack_require__(7),_decorators=__webpack_require__(15),_logger=__webpack_require__(17),_logger2=_interopRequireDefault(_logger);exports.VERSION="4.0.5";exports.COMPILER_REVISION=7;var REVISION_CHANGES={1:"<= 1.0.rc.2",2:"== 1.0.0-rc.3",3:"== 1.0.0-rc.4",4:"== 1.x.x",5:"== 2.0.0-alpha.x",6:">= 2.0.0-beta.1",7:">= 4.0.0"};exports.REVISION_CHANGES=REVISION_CHANGES;function HandlebarsEnvironment(helpers,partials,decorators){this.helpers=helpers||{},this.partials=partials||{},this.decorators=decorators||{},_helpers.registerDefaultHelpers(this),_decorators.registerDefaultDecorators(this)}
HandlebarsEnvironment.prototype={constructor:HandlebarsEnvironment,logger:_logger2.default,log:_logger2.default.log,registerHelper:function(name,fn){if("[object Object]"===_utils.toString.call(name)){if(fn)throw new _exception2.default("Arg not supported with multiple helpers");_utils.extend(this.helpers,name)}else this.helpers[name]=fn},unregisterHelper:function(name){delete this.helpers[name]},registerPartial:function(name,partial){if("[object Object]"===_utils.toString.call(name))_utils.extend(this.partials,name);else{if(void 0===partial)throw new _exception2.default('Attempting to register a partial called "'+name+'" as undefined');this.partials[name]=partial}},unregisterPartial:function(name){delete this.partials[name]},registerDecorator:function(name,fn){if("[object Object]"===_utils.toString.call(name)){if(fn)throw new _exception2.default("Arg not supported with multiple decorators");_utils.extend(this.decorators,name)}else this.decorators[name]=fn},unregisterDecorator:function(name){delete this.decorators[name]}};var log=_logger2.default.log;exports.log=log,exports.createFrame=_utils.createFrame,exports.logger=_logger2.default},function(module,exports){"use strict";exports.__esModule=!0,exports.extend=extend,exports.indexOf=indexOf,exports.escapeExpression=escapeExpression,exports.isEmpty=isEmpty,exports.createFrame=createFrame,exports.blockParams=blockParams,exports.appendContextPath=appendContextPath;var escape={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;","=":"&#x3D;"},badChars=/[&<>"'`=]/g,possible=/[&<>"'`=]/;function escapeChar(chr){return escape[chr]}function extend(obj){for(var i=1;i<arguments.length;i++)for(var key in arguments[i])Object.prototype.hasOwnProperty.call(arguments[i],key)&&(obj[key]=arguments[i][key]);return obj}var toString=Object.prototype.toString;exports.toString=toString;var isFunction=function(value){return"function"==typeof value};isFunction(/x/)&&(exports.isFunction=isFunction=function(value){return"function"==typeof value&&"[object Function]"===toString.call(value)}),exports.isFunction=isFunction;var isArray=Array.isArray||function(value){return!(!value||"object"!=typeof value)&&"[object Array]"===toString.call(value)};exports.isArray=isArray;function indexOf(array,value){for(var i=0,len=array.length;i<len;i++)if(array[i]===value)return i;return-1}function escapeExpression(string){if("string"!=typeof string){if(string&&string.toHTML)return string.toHTML();if(null==string)return"";if(!string)return string+"";string=""+string}return possible.test(string)?string.replace(badChars,escapeChar):string}function isEmpty(value){return!value&&0!==value||!(!isArray(value)||0!==value.length)}function createFrame(object){var frame=extend({},object);return frame._parent=object,frame}function blockParams(params,ids){return params.path=ids,params}function appendContextPath(contextPath,id){return(contextPath?contextPath+".":"")+id}},function(module,exports){"use strict";exports.__esModule=!0;var errorProps=["description","fileName","lineNumber","message","name","number","stack"];function Exception(message,node){var loc=node&&node.loc,line=void 0,column=void 0;loc&&(line=loc.start.line,column=loc.start.column,message+=" - "+line+":"+column);for(var tmp=Error.prototype.constructor.call(this,message),idx=0;idx<errorProps.length;idx++)this[errorProps[idx]]=tmp[errorProps[idx]];Error.captureStackTrace&&Error.captureStackTrace(this,Exception),loc&&(this.lineNumber=line,this.column=column)}Exception.prototype=new Error,exports.default=Exception,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.registerDefaultHelpers=registerDefaultHelpers;var _helpersBlockHelperMissing=__webpack_require__(8),_helpersBlockHelperMissing2=_interopRequireDefault(_helpersBlockHelperMissing),_helpersEach=__webpack_require__(9),_helpersEach2=_interopRequireDefault(_helpersEach),_helpersHelperMissing=__webpack_require__(10),_helpersHelperMissing2=_interopRequireDefault(_helpersHelperMissing),_helpersIf=__webpack_require__(11),_helpersIf2=_interopRequireDefault(_helpersIf),_helpersLog=__webpack_require__(12),_helpersLog2=_interopRequireDefault(_helpersLog),_helpersLookup=__webpack_require__(13),_helpersLookup2=_interopRequireDefault(_helpersLookup),_helpersWith=__webpack_require__(14),_helpersWith2=_interopRequireDefault(_helpersWith);function registerDefaultHelpers(instance){_helpersBlockHelperMissing2.default(instance),_helpersEach2.default(instance),_helpersHelperMissing2.default(instance),_helpersIf2.default(instance),_helpersLog2.default(instance),_helpersLookup2.default(instance),_helpersWith2.default(instance)}},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5);exports.default=function(instance){instance.registerHelper("blockHelperMissing",function(context,options){var inverse=options.inverse,fn=options.fn;if(!0===context)return fn(this);if(!1===context||null==context)return inverse(this);if(_utils.isArray(context))return context.length>0?(options.ids&&(options.ids=[options.name]),instance.helpers.each(context,options)):inverse(this);if(options.data&&options.ids){var data=_utils.createFrame(options.data);data.contextPath=_utils.appendContextPath(options.data.contextPath,options.name),options={data:data}}return fn(context,options)})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _utils=__webpack_require__(5),_exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception);exports.default=function(instance){instance.registerHelper("each",function(context,options){if(!options)throw new _exception2.default("Must pass iterator to #each");var fn=options.fn,inverse=options.inverse,i=0,ret="",data=void 0,contextPath=void 0;options.data&&options.ids&&(contextPath=_utils.appendContextPath(options.data.contextPath,options.ids[0])+"."),_utils.isFunction(context)&&(context=context.call(this)),options.data&&(data=_utils.createFrame(options.data));function execIteration(field,index,last){data&&(data.key=field,data.index=index,data.first=0===index,data.last=!!last,contextPath&&(data.contextPath=contextPath+field)),ret+=fn(context[field],{data:data,blockParams:_utils.blockParams([context[field],field],[contextPath+field,null])})}if(context&&"object"==typeof context)if(_utils.isArray(context))for(var j=context.length;i<j;i++)i in context&&execIteration(i,i,i===context.length-1);else{var priorKey=void 0;for(var key in context)context.hasOwnProperty(key)&&(void 0!==priorKey&&execIteration(priorKey,i-1),priorKey=key,i++);void 0!==priorKey&&execIteration(priorKey,i-1,!0)}return 0===i&&(ret=inverse(this)),ret})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception);exports.default=function(instance){instance.registerHelper("helperMissing",function(){if(1!==arguments.length)throw new _exception2.default('Missing helper: "'+arguments[arguments.length-1].name+'"')})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5);exports.default=function(instance){instance.registerHelper("if",function(conditional,options){return _utils.isFunction(conditional)&&(conditional=conditional.call(this)),!options.hash.includeZero&&!conditional||_utils.isEmpty(conditional)?options.inverse(this):options.fn(this)}),instance.registerHelper("unless",function(conditional,options){return instance.helpers.if.call(this,conditional,{fn:options.inverse,inverse:options.fn,hash:options.hash})})},module.exports=exports.default},function(module,exports){"use strict";exports.__esModule=!0,exports.default=function(instance){instance.registerHelper("log",function(){for(var args=[void 0],options=arguments[arguments.length-1],i=0;i<arguments.length-1;i++)args.push(arguments[i]);var level=1;null!=options.hash.level?level=options.hash.level:options.data&&null!=options.data.level&&(level=options.data.level),args[0]=level,instance.log.apply(instance,args)})},module.exports=exports.default},function(module,exports){"use strict";exports.__esModule=!0,exports.default=function(instance){instance.registerHelper("lookup",function(obj,field){return obj&&obj[field]})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5);exports.default=function(instance){instance.registerHelper("with",function(context,options){_utils.isFunction(context)&&(context=context.call(this));var fn=options.fn;if(_utils.isEmpty(context))return options.inverse(this);var data=options.data;return options.data&&options.ids&&(data=_utils.createFrame(options.data),data.contextPath=_utils.appendContextPath(options.data.contextPath,options.ids[0])),fn(context,{data:data,blockParams:_utils.blockParams([context],[data&&data.contextPath])})})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.registerDefaultDecorators=registerDefaultDecorators;var _decoratorsInline=__webpack_require__(16),_decoratorsInline2=_interopRequireDefault(_decoratorsInline);function registerDefaultDecorators(instance){_decoratorsInline2.default(instance)}},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5);exports.default=function(instance){instance.registerDecorator("inline",function(fn,props,container,options){var ret=fn;return props.partials||(props.partials={},ret=function(context,options){var original=container.partials;container.partials=_utils.extend({},original,props.partials);var ret=fn(context,options);return container.partials=original,ret}),props.partials[options.args[0]]=options.fn,ret})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5),logger={methodMap:["debug","info","warn","error"],level:"info",lookupLevel:function(level){if("string"==typeof level){var levelMap=_utils.indexOf(logger.methodMap,level.toLowerCase());level=levelMap>=0?levelMap:parseInt(level,10)}return level},log:function(level){if(level=logger.lookupLevel(level),"undefined"!=typeof console&&logger.lookupLevel(logger.level)<=level){var method=logger.methodMap[level];console[method]||(method="log");for(var _len=arguments.length,message=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)message[_key-1]=arguments[_key];console[method].apply(console,message)}}};exports.default=logger,module.exports=exports.default},function(module,exports){"use strict";exports.__esModule=!0;function SafeString(string){this.string=string}SafeString.prototype.toString=SafeString.prototype.toHTML=function(){return""+this.string},exports.default=SafeString,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireWildcard=__webpack_require__(3).default,_interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.checkRevision=checkRevision,exports.template=template,exports.wrapProgram=wrapProgram,exports.resolvePartial=resolvePartial,exports.invokePartial=invokePartial,exports.noop=noop;var _utils=__webpack_require__(5),Utils=_interopRequireWildcard(_utils),_exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception),_base=__webpack_require__(4);function checkRevision(compilerInfo){var compilerRevision=compilerInfo&&compilerInfo[0]||1,currentRevision=_base.COMPILER_REVISION;if(compilerRevision!==currentRevision){if(compilerRevision<currentRevision){var runtimeVersions=_base.REVISION_CHANGES[currentRevision],compilerVersions=_base.REVISION_CHANGES[compilerRevision];throw new _exception2.default("Template was precompiled with an older version of Handlebars than the current runtime. Please update your precompiler to a newer version ("+runtimeVersions+") or downgrade your runtime to an older version ("+compilerVersions+").")}throw new _exception2.default("Template was precompiled with a newer version of Handlebars than the current runtime. Please update your runtime to a newer version ("+compilerInfo[1]+").")}}function template(templateSpec,env){if(!env)throw new _exception2.default("No environment passed to template");if(!templateSpec||!templateSpec.main)throw new _exception2.default("Unknown template object: "+typeof templateSpec);templateSpec.main.decorator=templateSpec.main_d,env.VM.checkRevision(templateSpec.compiler);function invokePartialWrapper(partial,context,options){options.hash&&(context=Utils.extend({},context,options.hash),options.ids&&(options.ids[0]=!0)),partial=env.VM.resolvePartial.call(this,partial,context,options);var result=env.VM.invokePartial.call(this,partial,context,options);if(null==result&&env.compile&&(options.partials[options.name]=env.compile(partial,templateSpec.compilerOptions,env),result=options.partials[options.name](context,options)),null!=result){if(options.indent){for(var lines=result.split("\n"),i=0,l=lines.length;i<l&&(lines[i]||i+1!==l);i++)lines[i]=options.indent+lines[i];result=lines.join("\n")}return result}throw new _exception2.default("The partial "+options.name+" could not be compiled when running in runtime-only mode")}var container={strict:function(obj,name){if(!(name in obj))throw new _exception2.default('"'+name+'" not defined in '+obj);return obj[name]},lookup:function(depths,name){for(var len=depths.length,i=0;i<len;i++)if(depths[i]&&null!=depths[i][name])return depths[i][name]},lambda:function(current,context){return"function"==typeof current?current.call(context):current},escapeExpression:Utils.escapeExpression,invokePartial:invokePartialWrapper,fn:function(i){var ret=templateSpec[i];return ret.decorator=templateSpec[i+"_d"],ret},programs:[],program:function(i,data,declaredBlockParams,blockParams,depths){var programWrapper=this.programs[i],fn=this.fn(i);return data||depths||blockParams||declaredBlockParams?programWrapper=wrapProgram(this,i,fn,data,declaredBlockParams,blockParams,depths):programWrapper||(programWrapper=this.programs[i]=wrapProgram(this,i,fn)),programWrapper},data:function(value,depth){for(;value&&depth--;)value=value._parent;return value},merge:function(param,common){var obj=param||common;return param&&common&&param!==common&&(obj=Utils.extend({},common,param)),obj},noop:env.VM.noop,compilerInfo:templateSpec.compiler};function ret(context){var options=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],data=options.data;ret._setup(options),!options.partial&&templateSpec.useData&&(data=initData(context,data));var depths=void 0,blockParams=templateSpec.useBlockParams?[]:void 0;templateSpec.useDepths&&(depths=options.depths?context!==options.depths[0]?[context].concat(options.depths):options.depths:[context]);function main(context){return""+templateSpec.main(container,context,container.helpers,container.partials,data,blockParams,depths)}return(main=executeDecorators(templateSpec.main,main,container,options.depths||[],data,blockParams))(context,options)}return ret.isTop=!0,ret._setup=function(options){options.partial?(container.helpers=options.helpers,container.partials=options.partials,container.decorators=options.decorators):(container.helpers=container.merge(options.helpers,env.helpers),templateSpec.usePartial&&(container.partials=container.merge(options.partials,env.partials)),(templateSpec.usePartial||templateSpec.useDecorators)&&(container.decorators=container.merge(options.decorators,env.decorators)))},ret._child=function(i,data,blockParams,depths){if(templateSpec.useBlockParams&&!blockParams)throw new _exception2.default("must pass block params");if(templateSpec.useDepths&&!depths)throw new _exception2.default("must pass parent depths");return wrapProgram(container,i,templateSpec[i],data,0,blockParams,depths)},ret}function wrapProgram(container,i,fn,data,declaredBlockParams,blockParams,depths){function prog(context){var options=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],currentDepths=depths;return depths&&context!==depths[0]&&(currentDepths=[context].concat(depths)),fn(container,context,container.helpers,container.partials,options.data||data,blockParams&&[options.blockParams].concat(blockParams),currentDepths)}return prog=executeDecorators(fn,prog,container,depths,data,blockParams),prog.program=i,prog.depth=depths?depths.length:0,prog.blockParams=declaredBlockParams||0,prog}function resolvePartial(partial,context,options){return partial?partial.call||options.name||(options.name=partial,partial=options.partials[partial]):partial="@partial-block"===options.name?options.data["partial-block"]:options.partials[options.name],partial}function invokePartial(partial,context,options){options.partial=!0,options.ids&&(options.data.contextPath=options.ids[0]||options.data.contextPath);var partialBlock=void 0;if(options.fn&&options.fn!==noop&&(options.data=_base.createFrame(options.data),partialBlock=options.data["partial-block"]=options.fn,partialBlock.partials&&(options.partials=Utils.extend({},options.partials,partialBlock.partials))),void 0===partial&&partialBlock&&(partial=partialBlock),void 0===partial)throw new _exception2.default("The partial "+options.name+" could not be found");if(partial instanceof Function)return partial(context,options)}function noop(){return""}function initData(context,data){return data&&"root"in data||(data=data?_base.createFrame(data):{},data.root=context),data}function executeDecorators(fn,prog,container,depths,data,blockParams){if(fn.decorator){var props={};prog=fn.decorator(prog,props,container,depths&&depths[0],data,blockParams,depths),Utils.extend(prog,props)}return prog}},function(module,exports){(function(global){"use strict";exports.__esModule=!0,exports.default=function(Handlebars){var root=void 0!==global?global:window,$Handlebars=root.Handlebars;Handlebars.noConflict=function(){return root.Handlebars===Handlebars&&(root.Handlebars=$Handlebars),Handlebars}},module.exports=exports.default}).call(exports,function(){return this}())},function(module,exports){"use strict";exports.__esModule=!0;var AST={helpers:{helperExpression:function(node){return"SubExpression"===node.type||("MustacheStatement"===node.type||"BlockStatement"===node.type)&&!!(node.params&&node.params.length||node.hash)},scopedId:function(path){return/^\.|this\b/.test(path.original)},simpleId:function(path){return 1===path.parts.length&&!AST.helpers.scopedId(path)&&!path.depth}}};exports.default=AST,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default,_interopRequireWildcard=__webpack_require__(3).default;exports.__esModule=!0,exports.parse=parse;var _parser=__webpack_require__(23),_parser2=_interopRequireDefault(_parser),_whitespaceControl=__webpack_require__(24),_whitespaceControl2=_interopRequireDefault(_whitespaceControl),_helpers=__webpack_require__(26),Helpers=_interopRequireWildcard(_helpers),_utils=__webpack_require__(5);exports.parser=_parser2.default;var yy={};_utils.extend(yy,Helpers);function parse(input,options){return"Program"===input.type?input:(_parser2.default.yy=yy,yy.locInfo=function(locInfo){return new yy.SourceLocation(options&&options.srcName,locInfo)},new _whitespaceControl2.default(options).accept(_parser2.default.parse(input)))}},function(module,exports){"use strict";var handlebars=function(){var parser={trace:function(){},yy:{},symbols_:{error:2,root:3,program:4,EOF:5,program_repetition0:6,statement:7,mustache:8,block:9,rawBlock:10,partial:11,partialBlock:12,content:13,COMMENT:14,CONTENT:15,openRawBlock:16,rawBlock_repetition_plus0:17,END_RAW_BLOCK:18,OPEN_RAW_BLOCK:19,helperName:20,openRawBlock_repetition0:21,openRawBlock_option0:22,CLOSE_RAW_BLOCK:23,openBlock:24,block_option0:25,closeBlock:26,openInverse:27,block_option1:28,OPEN_BLOCK:29,openBlock_repetition0:30,openBlock_option0:31,openBlock_option1:32,CLOSE:33,OPEN_INVERSE:34,openInverse_repetition0:35,openInverse_option0:36,openInverse_option1:37,openInverseChain:38,OPEN_INVERSE_CHAIN:39,openInverseChain_repetition0:40,openInverseChain_option0:41,openInverseChain_option1:42,inverseAndProgram:43,INVERSE:44,inverseChain:45,inverseChain_option0:46,OPEN_ENDBLOCK:47,OPEN:48,mustache_repetition0:49,mustache_option0:50,OPEN_UNESCAPED:51,mustache_repetition1:52,mustache_option1:53,CLOSE_UNESCAPED:54,OPEN_PARTIAL:55,partialName:56,partial_repetition0:57,partial_option0:58,openPartialBlock:59,OPEN_PARTIAL_BLOCK:60,openPartialBlock_repetition0:61,openPartialBlock_option0:62,param:63,sexpr:64,OPEN_SEXPR:65,sexpr_repetition0:66,sexpr_option0:67,CLOSE_SEXPR:68,hash:69,hash_repetition_plus0:70,hashSegment:71,ID:72,EQUALS:73,blockParams:74,OPEN_BLOCK_PARAMS:75,blockParams_repetition_plus0:76,CLOSE_BLOCK_PARAMS:77,path:78,dataName:79,STRING:80,NUMBER:81,BOOLEAN:82,UNDEFINED:83,NULL:84,DATA:85,pathSegments:86,SEP:87,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",14:"COMMENT",15:"CONTENT",18:"END_RAW_BLOCK",19:"OPEN_RAW_BLOCK",23:"CLOSE_RAW_BLOCK",29:"OPEN_BLOCK",33:"CLOSE",34:"OPEN_INVERSE",39:"OPEN_INVERSE_CHAIN",44:"INVERSE",47:"OPEN_ENDBLOCK",48:"OPEN",51:"OPEN_UNESCAPED",54:"CLOSE_UNESCAPED",55:"OPEN_PARTIAL",60:"OPEN_PARTIAL_BLOCK",65:"OPEN_SEXPR",68:"CLOSE_SEXPR",72:"ID",73:"EQUALS",75:"OPEN_BLOCK_PARAMS",77:"CLOSE_BLOCK_PARAMS",80:"STRING",81:"NUMBER",82:"BOOLEAN",83:"UNDEFINED",84:"NULL",85:"DATA",87:"SEP"},productions_:[0,[3,2],[4,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[13,1],[10,3],[16,5],[9,4],[9,4],[24,6],[27,6],[38,6],[43,2],[45,3],[45,1],[26,3],[8,5],[8,5],[11,5],[12,3],[59,5],[63,1],[63,1],[64,5],[69,1],[71,3],[74,3],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[56,1],[56,1],[79,2],[78,1],[86,3],[86,1],[6,0],[6,2],[17,1],[17,2],[21,0],[21,2],[22,0],[22,1],[25,0],[25,1],[28,0],[28,1],[30,0],[30,2],[31,0],[31,1],[32,0],[32,1],[35,0],[35,2],[36,0],[36,1],[37,0],[37,1],[40,0],[40,2],[41,0],[41,1],[42,0],[42,1],[46,0],[46,1],[49,0],[49,2],[50,0],[50,1],[52,0],[52,2],[53,0],[53,1],[57,0],[57,2],[58,0],[58,1],[61,0],[61,2],[62,0],[62,1],[66,0],[66,2],[67,0],[67,1],[70,1],[70,2],[76,1],[76,2]],performAction:function(yytext,yyleng,yylineno,yy,yystate,$$,_$){var $0=$$.length-1;switch(yystate){case 1:return $$[$0-1];case 2:this.$=yy.prepareProgram($$[$0]);break;case 3:case 4:case 5:case 6:case 7:case 8:this.$=$$[$0];break;case 9:this.$={type:"CommentStatement",value:yy.stripComment($$[$0]),strip:yy.stripFlags($$[$0],$$[$0]),loc:yy.locInfo(this._$)};break;case 10:this.$={type:"ContentStatement",original:$$[$0],value:$$[$0],loc:yy.locInfo(this._$)};break;case 11:this.$=yy.prepareRawBlock($$[$0-2],$$[$0-1],$$[$0],this._$);break;case 12:this.$={path:$$[$0-3],params:$$[$0-2],hash:$$[$0-1]};break;case 13:this.$=yy.prepareBlock($$[$0-3],$$[$0-2],$$[$0-1],$$[$0],!1,this._$);break;case 14:this.$=yy.prepareBlock($$[$0-3],$$[$0-2],$$[$0-1],$$[$0],!0,this._$);break;case 15:this.$={open:$$[$0-5],path:$$[$0-4],params:$$[$0-3],hash:$$[$0-2],blockParams:$$[$0-1],strip:yy.stripFlags($$[$0-5],$$[$0])};break;case 16:case 17:this.$={path:$$[$0-4],params:$$[$0-3],hash:$$[$0-2],blockParams:$$[$0-1],strip:yy.stripFlags($$[$0-5],$$[$0])};break;case 18:this.$={strip:yy.stripFlags($$[$0-1],$$[$0-1]),program:$$[$0]};break;case 19:var inverse=yy.prepareBlock($$[$0-2],$$[$0-1],$$[$0],$$[$0],!1,this._$),program=yy.prepareProgram([inverse],$$[$0-1].loc);program.chained=!0,this.$={strip:$$[$0-2].strip,program:program,chain:!0};break;case 20:this.$=$$[$0];break;case 21:this.$={path:$$[$0-1],strip:yy.stripFlags($$[$0-2],$$[$0])};break;case 22:case 23:this.$=yy.prepareMustache($$[$0-3],$$[$0-2],$$[$0-1],$$[$0-4],yy.stripFlags($$[$0-4],$$[$0]),this._$);break;case 24:this.$={type:"PartialStatement",name:$$[$0-3],params:$$[$0-2],hash:$$[$0-1],indent:"",strip:yy.stripFlags($$[$0-4],$$[$0]),loc:yy.locInfo(this._$)};break;case 25:this.$=yy.preparePartialBlock($$[$0-2],$$[$0-1],$$[$0],this._$);break;case 26:this.$={path:$$[$0-3],params:$$[$0-2],hash:$$[$0-1],strip:yy.stripFlags($$[$0-4],$$[$0])};break;case 27:case 28:this.$=$$[$0];break;case 29:this.$={type:"SubExpression",path:$$[$0-3],params:$$[$0-2],hash:$$[$0-1],loc:yy.locInfo(this._$)};break;case 30:this.$={type:"Hash",pairs:$$[$0],loc:yy.locInfo(this._$)};break;case 31:this.$={type:"HashPair",key:yy.id($$[$0-2]),value:$$[$0],loc:yy.locInfo(this._$)};break;case 32:this.$=yy.id($$[$0-1]);break;case 33:case 34:this.$=$$[$0];break;case 35:this.$={type:"StringLiteral",value:$$[$0],original:$$[$0],loc:yy.locInfo(this._$)};break;case 36:this.$={type:"NumberLiteral",value:Number($$[$0]),original:Number($$[$0]),loc:yy.locInfo(this._$)};break;case 37:this.$={type:"BooleanLiteral",value:"true"===$$[$0],original:"true"===$$[$0],loc:yy.locInfo(this._$)};break;case 38:this.$={type:"UndefinedLiteral",original:void 0,value:void 0,loc:yy.locInfo(this._$)};break;case 39:this.$={type:"NullLiteral",original:null,value:null,loc:yy.locInfo(this._$)};break;case 40:case 41:this.$=$$[$0];break;case 42:this.$=yy.preparePath(!0,$$[$0],this._$);break;case 43:this.$=yy.preparePath(!1,$$[$0],this._$);break;case 44:$$[$0-2].push({part:yy.id($$[$0]),original:$$[$0],separator:$$[$0-1]}),this.$=$$[$0-2];break;case 45:this.$=[{part:yy.id($$[$0]),original:$$[$0]}];break;case 46:this.$=[];break;case 47:$$[$0-1].push($$[$0]);break;case 48:this.$=[$$[$0]];break;case 49:$$[$0-1].push($$[$0]);break;case 50:this.$=[];break;case 51:$$[$0-1].push($$[$0]);break;case 58:this.$=[];break;case 59:$$[$0-1].push($$[$0]);break;case 64:this.$=[];break;case 65:$$[$0-1].push($$[$0]);break;case 70:this.$=[];break;case 71:$$[$0-1].push($$[$0]);break;case 78:this.$=[];break;case 79:$$[$0-1].push($$[$0]);break;case 82:this.$=[];break;case 83:$$[$0-1].push($$[$0]);break;case 86:this.$=[];break;case 87:$$[$0-1].push($$[$0]);break;case 90:this.$=[];break;case 91:$$[$0-1].push($$[$0]);break;case 94:this.$=[];break;case 95:$$[$0-1].push($$[$0]);break;case 98:this.$=[$$[$0]];break;case 99:$$[$0-1].push($$[$0]);break;case 100:this.$=[$$[$0]];break;case 101:$$[$0-1].push($$[$0])}},table:[{3:1,4:2,5:[2,46],6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{1:[3]},{5:[1,4]},{5:[2,2],7:5,8:6,9:7,10:8,11:9,12:10,13:11,14:[1,12],15:[1,20],16:17,19:[1,23],24:15,27:16,29:[1,21],34:[1,22],39:[2,2],44:[2,2],47:[2,2],48:[1,13],51:[1,14],55:[1,18],59:19,60:[1,24]},{1:[2,1]},{5:[2,47],14:[2,47],15:[2,47],19:[2,47],29:[2,47],34:[2,47],39:[2,47],44:[2,47],47:[2,47],48:[2,47],51:[2,47],55:[2,47],60:[2,47]},{5:[2,3],14:[2,3],15:[2,3],19:[2,3],29:[2,3],34:[2,3],39:[2,3],44:[2,3],47:[2,3],48:[2,3],51:[2,3],55:[2,3],60:[2,3]},{5:[2,4],14:[2,4],15:[2,4],19:[2,4],29:[2,4],34:[2,4],39:[2,4],44:[2,4],47:[2,4],48:[2,4],51:[2,4],55:[2,4],60:[2,4]},{5:[2,5],14:[2,5],15:[2,5],19:[2,5],29:[2,5],34:[2,5],39:[2,5],44:[2,5],47:[2,5],48:[2,5],51:[2,5],55:[2,5],60:[2,5]},{5:[2,6],14:[2,6],15:[2,6],19:[2,6],29:[2,6],34:[2,6],39:[2,6],44:[2,6],47:[2,6],48:[2,6],51:[2,6],55:[2,6],60:[2,6]},{5:[2,7],14:[2,7],15:[2,7],19:[2,7],29:[2,7],34:[2,7],39:[2,7],44:[2,7],47:[2,7],48:[2,7],51:[2,7],55:[2,7],60:[2,7]},{5:[2,8],14:[2,8],15:[2,8],19:[2,8],29:[2,8],34:[2,8],39:[2,8],44:[2,8],47:[2,8],48:[2,8],51:[2,8],55:[2,8],60:[2,8]},{5:[2,9],14:[2,9],15:[2,9],19:[2,9],29:[2,9],34:[2,9],39:[2,9],44:[2,9],47:[2,9],48:[2,9],51:[2,9],55:[2,9],60:[2,9]},{20:25,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:36,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:37,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{4:38,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{13:40,15:[1,20],17:39},{20:42,56:41,64:43,65:[1,44],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:45,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{5:[2,10],14:[2,10],15:[2,10],18:[2,10],19:[2,10],29:[2,10],34:[2,10],39:[2,10],44:[2,10],47:[2,10],48:[2,10],51:[2,10],55:[2,10],60:[2,10]},{20:46,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:47,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:48,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:42,56:49,64:43,65:[1,44],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[2,78],49:50,65:[2,78],72:[2,78],80:[2,78],81:[2,78],82:[2,78],83:[2,78],84:[2,78],85:[2,78]},{23:[2,33],33:[2,33],54:[2,33],65:[2,33],68:[2,33],72:[2,33],75:[2,33],80:[2,33],81:[2,33],82:[2,33],83:[2,33],84:[2,33],85:[2,33]},{23:[2,34],33:[2,34],54:[2,34],65:[2,34],68:[2,34],72:[2,34],75:[2,34],80:[2,34],81:[2,34],82:[2,34],83:[2,34],84:[2,34],85:[2,34]},{23:[2,35],33:[2,35],54:[2,35],65:[2,35],68:[2,35],72:[2,35],75:[2,35],80:[2,35],81:[2,35],82:[2,35],83:[2,35],84:[2,35],85:[2,35]},{23:[2,36],33:[2,36],54:[2,36],65:[2,36],68:[2,36],72:[2,36],75:[2,36],80:[2,36],81:[2,36],82:[2,36],83:[2,36],84:[2,36],85:[2,36]},{23:[2,37],33:[2,37],54:[2,37],65:[2,37],68:[2,37],72:[2,37],75:[2,37],80:[2,37],81:[2,37],82:[2,37],83:[2,37],84:[2,37],85:[2,37]},{23:[2,38],33:[2,38],54:[2,38],65:[2,38],68:[2,38],72:[2,38],75:[2,38],80:[2,38],81:[2,38],82:[2,38],83:[2,38],84:[2,38],85:[2,38]},{23:[2,39],33:[2,39],54:[2,39],65:[2,39],68:[2,39],72:[2,39],75:[2,39],80:[2,39],81:[2,39],82:[2,39],83:[2,39],84:[2,39],85:[2,39]},{23:[2,43],33:[2,43],54:[2,43],65:[2,43],68:[2,43],72:[2,43],75:[2,43],80:[2,43],81:[2,43],82:[2,43],83:[2,43],84:[2,43],85:[2,43],87:[1,51]},{72:[1,35],86:52},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{52:53,54:[2,82],65:[2,82],72:[2,82],80:[2,82],81:[2,82],82:[2,82],83:[2,82],84:[2,82],85:[2,82]},{25:54,38:56,39:[1,58],43:57,44:[1,59],45:55,47:[2,54]},{28:60,43:61,44:[1,59],47:[2,56]},{13:63,15:[1,20],18:[1,62]},{15:[2,48],18:[2,48]},{33:[2,86],57:64,65:[2,86],72:[2,86],80:[2,86],81:[2,86],82:[2,86],83:[2,86],84:[2,86],85:[2,86]},{33:[2,40],65:[2,40],72:[2,40],80:[2,40],81:[2,40],82:[2,40],83:[2,40],84:[2,40],85:[2,40]},{33:[2,41],65:[2,41],72:[2,41],80:[2,41],81:[2,41],82:[2,41],83:[2,41],84:[2,41],85:[2,41]},{20:65,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:66,47:[1,67]},{30:68,33:[2,58],65:[2,58],72:[2,58],75:[2,58],80:[2,58],81:[2,58],82:[2,58],83:[2,58],84:[2,58],85:[2,58]},{33:[2,64],35:69,65:[2,64],72:[2,64],75:[2,64],80:[2,64],81:[2,64],82:[2,64],83:[2,64],84:[2,64],85:[2,64]},{21:70,23:[2,50],65:[2,50],72:[2,50],80:[2,50],81:[2,50],82:[2,50],83:[2,50],84:[2,50],85:[2,50]},{33:[2,90],61:71,65:[2,90],72:[2,90],80:[2,90],81:[2,90],82:[2,90],83:[2,90],84:[2,90],85:[2,90]},{20:75,33:[2,80],50:72,63:73,64:76,65:[1,44],69:74,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{72:[1,80]},{23:[2,42],33:[2,42],54:[2,42],65:[2,42],68:[2,42],72:[2,42],75:[2,42],80:[2,42],81:[2,42],82:[2,42],83:[2,42],84:[2,42],85:[2,42],87:[1,51]},{20:75,53:81,54:[2,84],63:82,64:76,65:[1,44],69:83,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:84,47:[1,67]},{47:[2,55]},{4:85,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{47:[2,20]},{20:86,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],
82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:87,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{26:88,47:[1,67]},{47:[2,57]},{5:[2,11],14:[2,11],15:[2,11],19:[2,11],29:[2,11],34:[2,11],39:[2,11],44:[2,11],47:[2,11],48:[2,11],51:[2,11],55:[2,11],60:[2,11]},{15:[2,49],18:[2,49]},{20:75,33:[2,88],58:89,63:90,64:76,65:[1,44],69:91,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{65:[2,94],66:92,68:[2,94],72:[2,94],80:[2,94],81:[2,94],82:[2,94],83:[2,94],84:[2,94],85:[2,94]},{5:[2,25],14:[2,25],15:[2,25],19:[2,25],29:[2,25],34:[2,25],39:[2,25],44:[2,25],47:[2,25],48:[2,25],51:[2,25],55:[2,25],60:[2,25]},{20:93,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,31:94,33:[2,60],63:95,64:76,65:[1,44],69:96,70:77,71:78,72:[1,79],75:[2,60],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,33:[2,66],36:97,63:98,64:76,65:[1,44],69:99,70:77,71:78,72:[1,79],75:[2,66],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,22:100,23:[2,52],63:101,64:76,65:[1,44],69:102,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,33:[2,92],62:103,63:104,64:76,65:[1,44],69:105,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,106]},{33:[2,79],65:[2,79],72:[2,79],80:[2,79],81:[2,79],82:[2,79],83:[2,79],84:[2,79],85:[2,79]},{33:[2,81]},{23:[2,27],33:[2,27],54:[2,27],65:[2,27],68:[2,27],72:[2,27],75:[2,27],80:[2,27],81:[2,27],82:[2,27],83:[2,27],84:[2,27],85:[2,27]},{23:[2,28],33:[2,28],54:[2,28],65:[2,28],68:[2,28],72:[2,28],75:[2,28],80:[2,28],81:[2,28],82:[2,28],83:[2,28],84:[2,28],85:[2,28]},{23:[2,30],33:[2,30],54:[2,30],68:[2,30],71:107,72:[1,108],75:[2,30]},{23:[2,98],33:[2,98],54:[2,98],68:[2,98],72:[2,98],75:[2,98]},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],73:[1,109],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{23:[2,44],33:[2,44],54:[2,44],65:[2,44],68:[2,44],72:[2,44],75:[2,44],80:[2,44],81:[2,44],82:[2,44],83:[2,44],84:[2,44],85:[2,44],87:[2,44]},{54:[1,110]},{54:[2,83],65:[2,83],72:[2,83],80:[2,83],81:[2,83],82:[2,83],83:[2,83],84:[2,83],85:[2,83]},{54:[2,85]},{5:[2,13],14:[2,13],15:[2,13],19:[2,13],29:[2,13],34:[2,13],39:[2,13],44:[2,13],47:[2,13],48:[2,13],51:[2,13],55:[2,13],60:[2,13]},{38:56,39:[1,58],43:57,44:[1,59],45:112,46:111,47:[2,76]},{33:[2,70],40:113,65:[2,70],72:[2,70],75:[2,70],80:[2,70],81:[2,70],82:[2,70],83:[2,70],84:[2,70],85:[2,70]},{47:[2,18]},{5:[2,14],14:[2,14],15:[2,14],19:[2,14],29:[2,14],34:[2,14],39:[2,14],44:[2,14],47:[2,14],48:[2,14],51:[2,14],55:[2,14],60:[2,14]},{33:[1,114]},{33:[2,87],65:[2,87],72:[2,87],80:[2,87],81:[2,87],82:[2,87],83:[2,87],84:[2,87],85:[2,87]},{33:[2,89]},{20:75,63:116,64:76,65:[1,44],67:115,68:[2,96],69:117,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,118]},{32:119,33:[2,62],74:120,75:[1,121]},{33:[2,59],65:[2,59],72:[2,59],75:[2,59],80:[2,59],81:[2,59],82:[2,59],83:[2,59],84:[2,59],85:[2,59]},{33:[2,61],75:[2,61]},{33:[2,68],37:122,74:123,75:[1,121]},{33:[2,65],65:[2,65],72:[2,65],75:[2,65],80:[2,65],81:[2,65],82:[2,65],83:[2,65],84:[2,65],85:[2,65]},{33:[2,67],75:[2,67]},{23:[1,124]},{23:[2,51],65:[2,51],72:[2,51],80:[2,51],81:[2,51],82:[2,51],83:[2,51],84:[2,51],85:[2,51]},{23:[2,53]},{33:[1,125]},{33:[2,91],65:[2,91],72:[2,91],80:[2,91],81:[2,91],82:[2,91],83:[2,91],84:[2,91],85:[2,91]},{33:[2,93]},{5:[2,22],14:[2,22],15:[2,22],19:[2,22],29:[2,22],34:[2,22],39:[2,22],44:[2,22],47:[2,22],48:[2,22],51:[2,22],55:[2,22],60:[2,22]},{23:[2,99],33:[2,99],54:[2,99],68:[2,99],72:[2,99],75:[2,99]},{73:[1,109]},{20:75,63:126,64:76,65:[1,44],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,23],14:[2,23],15:[2,23],19:[2,23],29:[2,23],34:[2,23],39:[2,23],44:[2,23],47:[2,23],48:[2,23],51:[2,23],55:[2,23],60:[2,23]},{47:[2,19]},{47:[2,77]},{20:75,33:[2,72],41:127,63:128,64:76,65:[1,44],69:129,70:77,71:78,72:[1,79],75:[2,72],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,24],14:[2,24],15:[2,24],19:[2,24],29:[2,24],34:[2,24],39:[2,24],44:[2,24],47:[2,24],48:[2,24],51:[2,24],55:[2,24],60:[2,24]},{68:[1,130]},{65:[2,95],68:[2,95],72:[2,95],80:[2,95],81:[2,95],82:[2,95],83:[2,95],84:[2,95],85:[2,95]},{68:[2,97]},{5:[2,21],14:[2,21],15:[2,21],19:[2,21],29:[2,21],34:[2,21],39:[2,21],44:[2,21],47:[2,21],48:[2,21],51:[2,21],55:[2,21],60:[2,21]},{33:[1,131]},{33:[2,63]},{72:[1,133],76:132},{33:[1,134]},{33:[2,69]},{15:[2,12]},{14:[2,26],15:[2,26],19:[2,26],29:[2,26],34:[2,26],47:[2,26],48:[2,26],51:[2,26],55:[2,26],60:[2,26]},{23:[2,31],33:[2,31],54:[2,31],68:[2,31],72:[2,31],75:[2,31]},{33:[2,74],42:135,74:136,75:[1,121]},{33:[2,71],65:[2,71],72:[2,71],75:[2,71],80:[2,71],81:[2,71],82:[2,71],83:[2,71],84:[2,71],85:[2,71]},{33:[2,73],75:[2,73]},{23:[2,29],33:[2,29],54:[2,29],65:[2,29],68:[2,29],72:[2,29],75:[2,29],80:[2,29],81:[2,29],82:[2,29],83:[2,29],84:[2,29],85:[2,29]},{14:[2,15],15:[2,15],19:[2,15],29:[2,15],34:[2,15],39:[2,15],44:[2,15],47:[2,15],48:[2,15],51:[2,15],55:[2,15],60:[2,15]},{72:[1,138],77:[1,137]},{72:[2,100],77:[2,100]},{14:[2,16],15:[2,16],19:[2,16],29:[2,16],34:[2,16],44:[2,16],47:[2,16],48:[2,16],51:[2,16],55:[2,16],60:[2,16]},{33:[1,139]},{33:[2,75]},{33:[2,32]},{72:[2,101],77:[2,101]},{14:[2,17],15:[2,17],19:[2,17],29:[2,17],34:[2,17],39:[2,17],44:[2,17],47:[2,17],48:[2,17],51:[2,17],55:[2,17],60:[2,17]}],defaultActions:{4:[2,1],55:[2,55],57:[2,20],61:[2,57],74:[2,81],83:[2,85],87:[2,18],91:[2,89],102:[2,53],105:[2,93],111:[2,19],112:[2,77],117:[2,97],120:[2,63],123:[2,69],124:[2,12],136:[2,75],137:[2,32]},parseError:function(str,hash){throw new Error(str)},parse:function(input){var self=this,stack=[0],vstack=[null],lstack=[],table=this.table,yytext="",yylineno=0,yyleng=0,recovering=0;this.lexer.setInput(input),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,this.yy.parser=this,void 0===this.lexer.yylloc&&(this.lexer.yylloc={});var yyloc=this.lexer.yylloc;lstack.push(yyloc);var ranges=this.lexer.options&&this.lexer.options.ranges;"function"==typeof this.yy.parseError&&(this.parseError=this.yy.parseError);for(var symbol,preErrorSymbol,state,action,r,p,len,newState,expected,yyval={};;){if(state=stack[stack.length-1],this.defaultActions[state]?action=this.defaultActions[state]:(null!==symbol&&void 0!==symbol||(symbol=function(){var token;return token=self.lexer.lex()||1,"number"!=typeof token&&(token=self.symbols_[token]||token),token}()),action=table[state]&&table[state][symbol]),void 0===action||!action.length||!action[0]){var errStr="";if(!recovering){expected=[];for(p in table[state])this.terminals_[p]&&p>2&&expected.push("'"+this.terminals_[p]+"'");errStr=this.lexer.showPosition?"Parse error on line "+(yylineno+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+expected.join(", ")+", got '"+(this.terminals_[symbol]||symbol)+"'":"Parse error on line "+(yylineno+1)+": Unexpected "+(1==symbol?"end of input":"'"+(this.terminals_[symbol]||symbol)+"'"),this.parseError(errStr,{text:this.lexer.match,token:this.terminals_[symbol]||symbol,line:this.lexer.yylineno,loc:yyloc,expected:expected})}}if(action[0]instanceof Array&&action.length>1)throw new Error("Parse Error: multiple actions possible at state: "+state+", token: "+symbol);switch(action[0]){case 1:stack.push(symbol),vstack.push(this.lexer.yytext),lstack.push(this.lexer.yylloc),stack.push(action[1]),symbol=null,preErrorSymbol?(symbol=preErrorSymbol,preErrorSymbol=null):(yyleng=this.lexer.yyleng,yytext=this.lexer.yytext,yylineno=this.lexer.yylineno,yyloc=this.lexer.yylloc,recovering>0&&recovering--);break;case 2:if(len=this.productions_[action[1]][1],yyval.$=vstack[vstack.length-len],yyval._$={first_line:lstack[lstack.length-(len||1)].first_line,last_line:lstack[lstack.length-1].last_line,first_column:lstack[lstack.length-(len||1)].first_column,last_column:lstack[lstack.length-1].last_column},ranges&&(yyval._$.range=[lstack[lstack.length-(len||1)].range[0],lstack[lstack.length-1].range[1]]),void 0!==(r=this.performAction.call(yyval,yytext,yyleng,yylineno,this.yy,action[1],vstack,lstack)))return r;len&&(stack=stack.slice(0,-1*len*2),vstack=vstack.slice(0,-1*len),lstack=lstack.slice(0,-1*len)),stack.push(this.productions_[action[1]][0]),vstack.push(yyval.$),lstack.push(yyval._$),newState=table[stack[stack.length-2]][stack[stack.length-1]],stack.push(newState);break;case 3:return!0}}return!0}},lexer=function(){var lexer={EOF:1,parseError:function(str,hash){if(!this.yy.parser)throw new Error(str);this.yy.parser.parseError(str,hash)},setInput:function(input){return this._input=input,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var ch=this._input[0];return this.yytext+=ch,this.yyleng++,this.offset++,this.match+=ch,this.matched+=ch,ch.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),ch},unput:function(ch){var len=ch.length,lines=ch.split(/(?:\r\n?|\n)/g);this._input=ch+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-len-1),this.offset-=len;var oldLines=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),lines.length-1&&(this.yylineno-=lines.length-1);var r=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:lines?(lines.length===oldLines.length?this.yylloc.first_column:0)+oldLines[oldLines.length-lines.length].length-lines[0].length:this.yylloc.first_column-len},this.options.ranges&&(this.yylloc.range=[r[0],r[0]+this.yyleng-len]),this},more:function(){return this._more=!0,this},less:function(n){this.unput(this.match.slice(n))},pastInput:function(){var past=this.matched.substr(0,this.matched.length-this.match.length);return(past.length>20?"...":"")+past.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var next=this.match;return next.length<20&&(next+=this._input.substr(0,20-next.length)),(next.substr(0,20)+(next.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var pre=this.pastInput(),c=new Array(pre.length+1).join("-");return pre+this.upcomingInput()+"\n"+c+"^"},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var token,match,tempMatch,index,lines;this._more||(this.yytext="",this.match="");for(var rules=this._currentRules(),i=0;i<rules.length&&(!(tempMatch=this._input.match(this.rules[rules[i]]))||match&&!(tempMatch[0].length>match[0].length)||(match=tempMatch,index=i,this.options.flex));i++);return match?(lines=match[0].match(/(?:\r\n?|\n).*/g),lines&&(this.yylineno+=lines.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:lines?lines[lines.length-1].length-lines[lines.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+match[0].length},this.yytext+=match[0],this.match+=match[0],this.matches=match,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._input=this._input.slice(match[0].length),this.matched+=match[0],token=this.performAction.call(this,this.yy,this,rules[index],this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),token||void 0):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var r=this.next();return void 0!==r?r:this.lex()},begin:function(condition){this.conditionStack.push(condition)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules},topState:function(){return this.conditionStack[this.conditionStack.length-2]},pushState:function(condition){this.begin(condition)}};return lexer.options={},lexer.performAction=function(yy,yy_,$avoiding_name_collisions,YY_START){function strip(start,end){return yy_.yytext=yy_.yytext.substr(start,yy_.yyleng-end)}switch($avoiding_name_collisions){case 0:if("\\\\"===yy_.yytext.slice(-2)?(strip(0,1),this.begin("mu")):"\\"===yy_.yytext.slice(-1)?(strip(0,1),this.begin("emu")):this.begin("mu"),yy_.yytext)return 15;break;case 1:return 15;case 2:return this.popState(),15;case 3:return this.begin("raw"),15;case 4:return this.popState(),"raw"===this.conditionStack[this.conditionStack.length-1]?15:(yy_.yytext=yy_.yytext.substr(5,yy_.yyleng-9),"END_RAW_BLOCK");case 5:return 15;case 6:return this.popState(),14;case 7:return 65;case 8:return 68;case 9:return 19;case 10:return this.popState(),this.begin("raw"),23;case 11:return 55;case 12:return 60;case 13:return 29;case 14:return 47;case 15:case 16:return this.popState(),44;case 17:return 34;case 18:return 39;case 19:return 51;case 20:return 48;case 21:this.unput(yy_.yytext),this.popState(),this.begin("com");break;case 22:return this.popState(),14;case 23:return 48;case 24:return 73;case 25:case 26:return 72;case 27:return 87;case 28:break;case 29:return this.popState(),54;case 30:return this.popState(),33;case 31:return yy_.yytext=strip(1,2).replace(/\\"/g,'"'),80;case 32:return yy_.yytext=strip(1,2).replace(/\\'/g,"'"),80;case 33:return 85;case 34:case 35:return 82;case 36:return 83;case 37:return 84;case 38:return 81;case 39:return 75;case 40:return 77;case 41:return 72;case 42:return yy_.yytext=yy_.yytext.replace(/\\([\\\]])/g,"$1"),72;case 43:return"INVALID";case 44:return 5}},lexer.rules=[/^(?:[^\x00]*?(?=(\{\{)))/,/^(?:[^\x00]+)/,/^(?:[^\x00]{2,}?(?=(\{\{|\\\{\{|\\\\\{\{|$)))/,/^(?:\{\{\{\{(?=[^\/]))/,/^(?:\{\{\{\{\/[^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=[=}\s\/.])\}\}\}\})/,/^(?:[^\x00]*?(?=(\{\{\{\{)))/,/^(?:[\s\S]*?--(~)?\}\})/,/^(?:\()/,/^(?:\))/,/^(?:\{\{\{\{)/,/^(?:\}\}\}\})/,/^(?:\{\{(~)?>)/,/^(?:\{\{(~)?#>)/,/^(?:\{\{(~)?#\*?)/,/^(?:\{\{(~)?\/)/,/^(?:\{\{(~)?\^\s*(~)?\}\})/,/^(?:\{\{(~)?\s*else\s*(~)?\}\})/,/^(?:\{\{(~)?\^)/,/^(?:\{\{(~)?\s*else\b)/,/^(?:\{\{(~)?\{)/,/^(?:\{\{(~)?&)/,/^(?:\{\{(~)?!--)/,/^(?:\{\{(~)?![\s\S]*?\}\})/,/^(?:\{\{(~)?\*?)/,/^(?:=)/,/^(?:\.\.)/,/^(?:\.(?=([=~}\s\/.)|])))/,/^(?:[\/.])/,/^(?:\s+)/,/^(?:\}(~)?\}\})/,/^(?:(~)?\}\})/,/^(?:"(\\["]|[^"])*")/,/^(?:'(\\[']|[^'])*')/,/^(?:@)/,/^(?:true(?=([~}\s)])))/,/^(?:false(?=([~}\s)])))/,/^(?:undefined(?=([~}\s)])))/,/^(?:null(?=([~}\s)])))/,/^(?:-?[0-9]+(?:\.[0-9]+)?(?=([~}\s)])))/,/^(?:as\s+\|)/,/^(?:\|)/,/^(?:([^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=([=~}\s\/.)|]))))/,/^(?:\[(\\\]|[^\]])*\])/,/^(?:.)/,/^(?:$)/],lexer.conditions={mu:{rules:[7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44],inclusive:!1},emu:{rules:[2],inclusive:!1},com:{rules:[6],inclusive:!1},raw:{rules:[3,4,5],inclusive:!1},INITIAL:{rules:[0,1,44],inclusive:!0}},lexer}();parser.lexer=lexer;function Parser(){this.yy={}}return Parser.prototype=parser,parser.Parser=Parser,new Parser}();exports.__esModule=!0,exports.default=handlebars},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _visitor=__webpack_require__(25),_visitor2=_interopRequireDefault(_visitor);function WhitespaceControl(){var options=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.options=options}WhitespaceControl.prototype=new _visitor2.default,WhitespaceControl.prototype.Program=function(program){var doStandalone=!this.options.ignoreStandalone,isRoot=!this.isRootSeen;this.isRootSeen=!0;for(var body=program.body,i=0,l=body.length;i<l;i++){var current=body[i],strip=this.accept(current);if(strip){var _isPrevWhitespace=isPrevWhitespace(body,i,isRoot),_isNextWhitespace=isNextWhitespace(body,i,isRoot),openStandalone=strip.openStandalone&&_isPrevWhitespace,closeStandalone=strip.closeStandalone&&_isNextWhitespace,inlineStandalone=strip.inlineStandalone&&_isPrevWhitespace&&_isNextWhitespace;strip.close&&omitRight(body,i,!0),strip.open&&omitLeft(body,i,!0),doStandalone&&inlineStandalone&&(omitRight(body,i),omitLeft(body,i)&&"PartialStatement"===current.type&&(current.indent=/([ \t]+$)/.exec(body[i-1].original)[1])),doStandalone&&openStandalone&&(omitRight((current.program||current.inverse).body),omitLeft(body,i)),doStandalone&&closeStandalone&&(omitRight(body,i),omitLeft((current.inverse||current.program).body))}}return program},WhitespaceControl.prototype.BlockStatement=WhitespaceControl.prototype.DecoratorBlock=WhitespaceControl.prototype.PartialBlockStatement=function(block){this.accept(block.program),this.accept(block.inverse);var program=block.program||block.inverse,inverse=block.program&&block.inverse,firstInverse=inverse,lastInverse=inverse;if(inverse&&inverse.chained)for(firstInverse=inverse.body[0].program;lastInverse.chained;)lastInverse=lastInverse.body[lastInverse.body.length-1].program;var strip={open:block.openStrip.open,close:block.closeStrip.close,openStandalone:isNextWhitespace(program.body),closeStandalone:isPrevWhitespace((firstInverse||program).body)};if(block.openStrip.close&&omitRight(program.body,null,!0),inverse){var inverseStrip=block.inverseStrip;inverseStrip.open&&omitLeft(program.body,null,!0),inverseStrip.close&&omitRight(firstInverse.body,null,!0),block.closeStrip.open&&omitLeft(lastInverse.body,null,!0),!this.options.ignoreStandalone&&isPrevWhitespace(program.body)&&isNextWhitespace(firstInverse.body)&&(omitLeft(program.body),omitRight(firstInverse.body))}else block.closeStrip.open&&omitLeft(program.body,null,!0);return strip},WhitespaceControl.prototype.Decorator=WhitespaceControl.prototype.MustacheStatement=function(mustache){return mustache.strip},WhitespaceControl.prototype.PartialStatement=WhitespaceControl.prototype.CommentStatement=function(node){var strip=node.strip||{};return{inlineStandalone:!0,open:strip.open,close:strip.close}};function isPrevWhitespace(body,i,isRoot){void 0===i&&(i=body.length);var prev=body[i-1],sibling=body[i-2];return prev?"ContentStatement"===prev.type?(sibling||!isRoot?/\r?\n\s*?$/:/(^|\r?\n)\s*?$/).test(prev.original):void 0:isRoot}function isNextWhitespace(body,i,isRoot){void 0===i&&(i=-1);var next=body[i+1],sibling=body[i+2];return next?"ContentStatement"===next.type?(sibling||!isRoot?/^\s*?\r?\n/:/^\s*?(\r?\n|$)/).test(next.original):void 0:isRoot}function omitRight(body,i,multiple){var current=body[null==i?0:i+1];if(current&&"ContentStatement"===current.type&&(multiple||!current.rightStripped)){var original=current.value;current.value=current.value.replace(multiple?/^\s+/:/^[ \t]*\r?\n?/,""),current.rightStripped=current.value!==original}}function omitLeft(body,i,multiple){var current=body[null==i?body.length-1:i-1];if(current&&"ContentStatement"===current.type&&(multiple||!current.leftStripped)){var original=current.value;return current.value=current.value.replace(multiple?/\s+$/:/[ \t]+$/,""),current.leftStripped=current.value!==original,current.leftStripped}}exports.default=WhitespaceControl,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception);function Visitor(){this.parents=[]}Visitor.prototype={constructor:Visitor,mutating:!1,acceptKey:function(node,name){var value=this.accept(node[name]);if(this.mutating){if(value&&!Visitor.prototype[value.type])throw new _exception2.default('Unexpected node type "'+value.type+'" found when accepting '+name+" on "+node.type);node[name]=value}},acceptRequired:function(node,name){if(this.acceptKey(node,name),!node[name])throw new _exception2.default(node.type+" requires "+name)},acceptArray:function(array){for(var i=0,l=array.length;i<l;i++)this.acceptKey(array,i),array[i]||(array.splice(i,1),i--,l--)},accept:function(object){if(object){if(!this[object.type])throw new _exception2.default("Unknown type: "+object.type,object);this.current&&this.parents.unshift(this.current),this.current=object;var ret=this[object.type](object);return this.current=this.parents.shift(),!this.mutating||ret?ret:!1!==ret?object:void 0}},Program:function(program){this.acceptArray(program.body)},MustacheStatement:visitSubExpression,Decorator:visitSubExpression,BlockStatement:visitBlock,DecoratorBlock:visitBlock,PartialStatement:visitPartial,PartialBlockStatement:function(partial){visitPartial.call(this,partial),this.acceptKey(partial,"program")},ContentStatement:function(){},CommentStatement:function(){},SubExpression:visitSubExpression,PathExpression:function(){},StringLiteral:function(){},NumberLiteral:function(){},BooleanLiteral:function(){},UndefinedLiteral:function(){},NullLiteral:function(){},Hash:function(hash){this.acceptArray(hash.pairs)},HashPair:function(pair){this.acceptRequired(pair,"value")}};function visitSubExpression(mustache){this.acceptRequired(mustache,"path"),this.acceptArray(mustache.params),this.acceptKey(mustache,"hash")}function visitBlock(block){visitSubExpression.call(this,block),this.acceptKey(block,"program"),this.acceptKey(block,"inverse")}function visitPartial(partial){this.acceptRequired(partial,"name"),this.acceptArray(partial.params),this.acceptKey(partial,"hash")}exports.default=Visitor,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.SourceLocation=SourceLocation,exports.id=id,exports.stripFlags=stripFlags,exports.stripComment=stripComment,exports.preparePath=preparePath,exports.prepareMustache=prepareMustache,exports.prepareRawBlock=prepareRawBlock,exports.prepareBlock=prepareBlock,exports.prepareProgram=prepareProgram,exports.preparePartialBlock=preparePartialBlock;var _exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception);function validateClose(open,close){if(close=close.path?close.path.original:close,open.path.original!==close){var errorNode={loc:open.path.loc};throw new _exception2.default(open.path.original+" doesn't match "+close,errorNode)}}function SourceLocation(source,locInfo){this.source=source,this.start={line:locInfo.first_line,column:locInfo.first_column},this.end={line:locInfo.last_line,column:locInfo.last_column}}function id(token){return/^\[.*\]$/.test(token)?token.substr(1,token.length-2):token}function stripFlags(open,close){return{open:"~"===open.charAt(2),close:"~"===close.charAt(close.length-3)}}function stripComment(comment){return comment.replace(/^\{\{~?\!-?-?/,"").replace(/-?-?~?\}\}$/,"")}function preparePath(data,parts,loc){loc=this.locInfo(loc);for(var original=data?"@":"",dig=[],depth=0,depthString="",i=0,l=parts.length;i<l;i++){var part=parts[i].part,isLiteral=parts[i].original!==part;if(original+=(parts[i].separator||"")+part,isLiteral||".."!==part&&"."!==part&&"this"!==part)dig.push(part);else{if(dig.length>0)throw new _exception2.default("Invalid path: "+original,{loc:loc});".."===part&&(depth++,depthString+="../")}}return{type:"PathExpression",data:data,depth:depth,parts:dig,original:original,loc:loc}}function prepareMustache(path,params,hash,open,strip,locInfo){var escapeFlag=open.charAt(3)||open.charAt(2),escaped="{"!==escapeFlag&&"&"!==escapeFlag;return{type:/\*/.test(open)?"Decorator":"MustacheStatement",path:path,params:params,hash:hash,escaped:escaped,strip:strip,loc:this.locInfo(locInfo)}}function prepareRawBlock(openRawBlock,contents,close,locInfo){validateClose(openRawBlock,close),locInfo=this.locInfo(locInfo);var program={type:"Program",body:contents,strip:{},loc:locInfo};return{type:"BlockStatement",path:openRawBlock.path,params:openRawBlock.params,hash:openRawBlock.hash,program:program,openStrip:{},inverseStrip:{},closeStrip:{},loc:locInfo}}function prepareBlock(openBlock,program,inverseAndProgram,close,inverted,locInfo){close&&close.path&&validateClose(openBlock,close);var decorator=/\*/.test(openBlock.open);program.blockParams=openBlock.blockParams;var inverse=void 0,inverseStrip=void 0;if(inverseAndProgram){if(decorator)throw new _exception2.default("Unexpected inverse block on decorator",inverseAndProgram);inverseAndProgram.chain&&(inverseAndProgram.program.body[0].closeStrip=close.strip),inverseStrip=inverseAndProgram.strip,inverse=inverseAndProgram.program}return inverted&&(inverted=inverse,inverse=program,program=inverted),{type:decorator?"DecoratorBlock":"BlockStatement",path:openBlock.path,params:openBlock.params,hash:openBlock.hash,program:program,inverse:inverse,openStrip:openBlock.strip,inverseStrip:inverseStrip,closeStrip:close&&close.strip,loc:this.locInfo(locInfo)}}function prepareProgram(statements,loc){if(!loc&&statements.length){var firstLoc=statements[0].loc,lastLoc=statements[statements.length-1].loc;firstLoc&&lastLoc&&(loc={source:firstLoc.source,start:{line:firstLoc.start.line,column:firstLoc.start.column},end:{line:lastLoc.end.line,column:lastLoc.end.column}})}return{type:"Program",body:statements,strip:{},loc:loc}}function preparePartialBlock(open,program,close,locInfo){return validateClose(open,close),{type:"PartialBlockStatement",name:open.path,params:open.params,hash:open.hash,program:program,openStrip:open.strip,closeStrip:close&&close.strip,loc:this.locInfo(locInfo)}}},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.Compiler=Compiler,exports.precompile=precompile,exports.compile=compile;var _exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception),_utils=__webpack_require__(5),_ast=__webpack_require__(21),_ast2=_interopRequireDefault(_ast),slice=[].slice;function Compiler(){}Compiler.prototype={compiler:Compiler,equals:function(other){var len=this.opcodes.length;if(other.opcodes.length!==len)return!1;for(var i=0;i<len;i++){var opcode=this.opcodes[i],otherOpcode=other.opcodes[i];if(opcode.opcode!==otherOpcode.opcode||!argEquals(opcode.args,otherOpcode.args))return!1}len=this.children.length;for(var i=0;i<len;i++)if(!this.children[i].equals(other.children[i]))return!1;return!0},guid:0,compile:function(program,options){this.sourceNode=[],this.opcodes=[],this.children=[],this.options=options,this.stringParams=options.stringParams,this.trackIds=options.trackIds,options.blockParams=options.blockParams||[];var knownHelpers=options.knownHelpers;if(options.knownHelpers={helperMissing:!0,blockHelperMissing:!0,each:!0,if:!0,unless:!0,with:!0,log:!0,lookup:!0},knownHelpers)for(var _name in knownHelpers)_name in knownHelpers&&(options.knownHelpers[_name]=knownHelpers[_name]);return this.accept(program)},compileProgram:function(program){var childCompiler=new this.compiler,result=childCompiler.compile(program,this.options),guid=this.guid++;return this.usePartial=this.usePartial||result.usePartial,this.children[guid]=result,this.useDepths=this.useDepths||result.useDepths,guid},accept:function(node){if(!this[node.type])throw new _exception2.default("Unknown type: "+node.type,node);this.sourceNode.unshift(node);var ret=this[node.type](node);return this.sourceNode.shift(),ret},Program:function(program){this.options.blockParams.unshift(program.blockParams);for(var body=program.body,bodyLength=body.length,i=0;i<bodyLength;i++)this.accept(body[i]);return this.options.blockParams.shift(),this.isSimple=1===bodyLength,this.blockParams=program.blockParams?program.blockParams.length:0,this},BlockStatement:function(block){transformLiteralToPath(block);var program=block.program,inverse=block.inverse;program=program&&this.compileProgram(program),inverse=inverse&&this.compileProgram(inverse);var type=this.classifySexpr(block);"helper"===type?this.helperSexpr(block,program,inverse):"simple"===type?(this.simpleSexpr(block),this.opcode("pushProgram",program),this.opcode("pushProgram",inverse),this.opcode("emptyHash"),this.opcode("blockValue",block.path.original)):(this.ambiguousSexpr(block,program,inverse),this.opcode("pushProgram",program),this.opcode("pushProgram",inverse),this.opcode("emptyHash"),this.opcode("ambiguousBlockValue")),this.opcode("append")},DecoratorBlock:function(decorator){var program=decorator.program&&this.compileProgram(decorator.program),params=this.setupFullMustacheParams(decorator,program,void 0),path=decorator.path;this.useDecorators=!0,this.opcode("registerDecorator",params.length,path.original)},PartialStatement:function(partial){this.usePartial=!0;var program=partial.program;program&&(program=this.compileProgram(partial.program));var params=partial.params;if(params.length>1)throw new _exception2.default("Unsupported number of partial arguments: "+params.length,partial);params.length||(this.options.explicitPartialContext?this.opcode("pushLiteral","undefined"):params.push({type:"PathExpression",parts:[],depth:0}));var partialName=partial.name.original,isDynamic="SubExpression"===partial.name.type;isDynamic&&this.accept(partial.name),this.setupFullMustacheParams(partial,program,void 0,!0);var indent=partial.indent||"";this.options.preventIndent&&indent&&(this.opcode("appendContent",indent),indent=""),this.opcode("invokePartial",isDynamic,partialName,indent),this.opcode("append")},PartialBlockStatement:function(partialBlock){this.PartialStatement(partialBlock)},MustacheStatement:function(mustache){this.SubExpression(mustache),mustache.escaped&&!this.options.noEscape?this.opcode("appendEscaped"):this.opcode("append")},Decorator:function(decorator){this.DecoratorBlock(decorator)},ContentStatement:function(content){content.value&&this.opcode("appendContent",content.value)},CommentStatement:function(){},SubExpression:function(sexpr){transformLiteralToPath(sexpr);var type=this.classifySexpr(sexpr);"simple"===type?this.simpleSexpr(sexpr):"helper"===type?this.helperSexpr(sexpr):this.ambiguousSexpr(sexpr)},ambiguousSexpr:function(sexpr,program,inverse){var path=sexpr.path,name=path.parts[0],isBlock=null!=program||null!=inverse;this.opcode("getContext",path.depth),this.opcode("pushProgram",program),this.opcode("pushProgram",inverse),path.strict=!0,this.accept(path),this.opcode("invokeAmbiguous",name,isBlock)},simpleSexpr:function(sexpr){var path=sexpr.path;path.strict=!0,this.accept(path),this.opcode("resolvePossibleLambda")},helperSexpr:function(sexpr,program,inverse){var params=this.setupFullMustacheParams(sexpr,program,inverse),path=sexpr.path,name=path.parts[0];if(this.options.knownHelpers[name])this.opcode("invokeKnownHelper",params.length,name);else{if(this.options.knownHelpersOnly)throw new _exception2.default("You specified knownHelpersOnly, but used the unknown helper "+name,sexpr);path.strict=!0,path.falsy=!0,this.accept(path),this.opcode("invokeHelper",params.length,path.original,_ast2.default.helpers.simpleId(path))}},PathExpression:function(path){this.addDepth(path.depth),this.opcode("getContext",path.depth);var name=path.parts[0],scoped=_ast2.default.helpers.scopedId(path),blockParamId=!path.depth&&!scoped&&this.blockParamIndex(name);blockParamId?this.opcode("lookupBlockParam",blockParamId,path.parts):name?path.data?(this.options.data=!0,this.opcode("lookupData",path.depth,path.parts,path.strict)):this.opcode("lookupOnContext",path.parts,path.falsy,path.strict,scoped):this.opcode("pushContext")},StringLiteral:function(string){this.opcode("pushString",string.value)},NumberLiteral:function(number){this.opcode("pushLiteral",number.value)},BooleanLiteral:function(bool){this.opcode("pushLiteral",bool.value)},
UndefinedLiteral:function(){this.opcode("pushLiteral","undefined")},NullLiteral:function(){this.opcode("pushLiteral","null")},Hash:function(hash){var pairs=hash.pairs,i=0,l=pairs.length;for(this.opcode("pushHash");i<l;i++)this.pushParam(pairs[i].value);for(;i--;)this.opcode("assignToHash",pairs[i].key);this.opcode("popHash")},opcode:function(name){this.opcodes.push({opcode:name,args:slice.call(arguments,1),loc:this.sourceNode[0].loc})},addDepth:function(depth){depth&&(this.useDepths=!0)},classifySexpr:function(sexpr){var isSimple=_ast2.default.helpers.simpleId(sexpr.path),isBlockParam=isSimple&&!!this.blockParamIndex(sexpr.path.parts[0]),isHelper=!isBlockParam&&_ast2.default.helpers.helperExpression(sexpr),isEligible=!isBlockParam&&(isHelper||isSimple);if(isEligible&&!isHelper){var _name2=sexpr.path.parts[0],options=this.options;options.knownHelpers[_name2]?isHelper=!0:options.knownHelpersOnly&&(isEligible=!1)}return isHelper?"helper":isEligible?"ambiguous":"simple"},pushParams:function(params){for(var i=0,l=params.length;i<l;i++)this.pushParam(params[i])},pushParam:function(val){var value=null!=val.value?val.value:val.original||"";if(this.stringParams)value.replace&&(value=value.replace(/^(\.?\.\/)*/g,"").replace(/\//g,".")),val.depth&&this.addDepth(val.depth),this.opcode("getContext",val.depth||0),this.opcode("pushStringParam",value,val.type),"SubExpression"===val.type&&this.accept(val);else{if(this.trackIds){var blockParamIndex=void 0;if(!val.parts||_ast2.default.helpers.scopedId(val)||val.depth||(blockParamIndex=this.blockParamIndex(val.parts[0])),blockParamIndex){var blockParamChild=val.parts.slice(1).join(".");this.opcode("pushId","BlockParam",blockParamIndex,blockParamChild)}else value=val.original||value,value.replace&&(value=value.replace(/^this(?:\.|$)/,"").replace(/^\.\//,"").replace(/^\.$/,"")),this.opcode("pushId",val.type,value)}this.accept(val)}},setupFullMustacheParams:function(sexpr,program,inverse,omitEmpty){var params=sexpr.params;return this.pushParams(params),this.opcode("pushProgram",program),this.opcode("pushProgram",inverse),sexpr.hash?this.accept(sexpr.hash):this.opcode("emptyHash",omitEmpty),params},blockParamIndex:function(name){for(var depth=0,len=this.options.blockParams.length;depth<len;depth++){var blockParams=this.options.blockParams[depth],param=blockParams&&_utils.indexOf(blockParams,name);if(blockParams&&param>=0)return[depth,param]}}};function precompile(input,options,env){if(null==input||"string"!=typeof input&&"Program"!==input.type)throw new _exception2.default("You must pass a string or Handlebars AST to Handlebars.precompile. You passed "+input);options=options||{},"data"in options||(options.data=!0),options.compat&&(options.useDepths=!0);var ast=env.parse(input,options),environment=(new env.Compiler).compile(ast,options);return(new env.JavaScriptCompiler).compile(environment,options)}function compile(input,options,env){if(void 0===options&&(options={}),null==input||"string"!=typeof input&&"Program"!==input.type)throw new _exception2.default("You must pass a string or Handlebars AST to Handlebars.compile. You passed "+input);"data"in options||(options.data=!0),options.compat&&(options.useDepths=!0);var compiled=void 0;function compileInput(){var ast=env.parse(input,options),environment=(new env.Compiler).compile(ast,options),templateSpec=(new env.JavaScriptCompiler).compile(environment,options,void 0,!0);return env.template(templateSpec)}function ret(context,execOptions){return compiled||(compiled=compileInput()),compiled.call(this,context,execOptions)}return ret._setup=function(setupOptions){return compiled||(compiled=compileInput()),compiled._setup(setupOptions)},ret._child=function(i,data,blockParams,depths){return compiled||(compiled=compileInput()),compiled._child(i,data,blockParams,depths)},ret}function argEquals(a,b){if(a===b)return!0;if(_utils.isArray(a)&&_utils.isArray(b)&&a.length===b.length){for(var i=0;i<a.length;i++)if(!argEquals(a[i],b[i]))return!1;return!0}}function transformLiteralToPath(sexpr){if(!sexpr.path.parts){var literal=sexpr.path;sexpr.path={type:"PathExpression",data:!1,depth:0,parts:[literal.original+""],original:literal.original+"",loc:literal.loc}}}},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _base=__webpack_require__(4),_exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception),_utils=__webpack_require__(5),_codeGen=__webpack_require__(29),_codeGen2=_interopRequireDefault(_codeGen);function Literal(value){this.value=value}function JavaScriptCompiler(){}JavaScriptCompiler.prototype={nameLookup:function(parent,name){return JavaScriptCompiler.isValidJavaScriptVariableName(name)?[parent,".",name]:[parent,"[",JSON.stringify(name),"]"]},depthedLookup:function(name){return[this.aliasable("container.lookup"),'(depths, "',name,'")']},compilerInfo:function(){var revision=_base.COMPILER_REVISION;return[revision,_base.REVISION_CHANGES[revision]]},appendToBuffer:function(source,location,explicit){return _utils.isArray(source)||(source=[source]),source=this.source.wrap(source,location),this.environment.isSimple?["return ",source,";"]:explicit?["buffer += ",source,";"]:(source.appendToBuffer=!0,source)},initializeBuffer:function(){return this.quotedString("")},compile:function(environment,options,context,asObject){this.environment=environment,this.options=options,this.stringParams=this.options.stringParams,this.trackIds=this.options.trackIds,this.precompile=!asObject,this.name=this.environment.name,this.isChild=!!context,this.context=context||{decorators:[],programs:[],environments:[]},this.preamble(),this.stackSlot=0,this.stackVars=[],this.aliases={},this.registers={list:[]},this.hashes=[],this.compileStack=[],this.inlineStack=[],this.blockParams=[],this.compileChildren(environment,options),this.useDepths=this.useDepths||environment.useDepths||environment.useDecorators||this.options.compat,this.useBlockParams=this.useBlockParams||environment.useBlockParams;var opcodes=environment.opcodes,opcode=void 0,firstLoc=void 0,i=void 0,l=void 0;for(i=0,l=opcodes.length;i<l;i++)opcode=opcodes[i],this.source.currentLocation=opcode.loc,firstLoc=firstLoc||opcode.loc,this[opcode.opcode].apply(this,opcode.args);if(this.source.currentLocation=firstLoc,this.pushSource(""),this.stackSlot||this.inlineStack.length||this.compileStack.length)throw new _exception2.default("Compile completed with content left on stack");this.decorators.isEmpty()?this.decorators=void 0:(this.useDecorators=!0,this.decorators.prepend("var decorators = container.decorators;\n"),this.decorators.push("return fn;"),asObject?this.decorators=Function.apply(this,["fn","props","container","depth0","data","blockParams","depths",this.decorators.merge()]):(this.decorators.prepend("function(fn, props, container, depth0, data, blockParams, depths) {\n"),this.decorators.push("}\n"),this.decorators=this.decorators.merge()));var fn=this.createFunctionContext(asObject);if(this.isChild)return fn;var ret={compiler:this.compilerInfo(),main:fn};this.decorators&&(ret.main_d=this.decorators,ret.useDecorators=!0);var _context=this.context,programs=_context.programs,decorators=_context.decorators;for(i=0,l=programs.length;i<l;i++)programs[i]&&(ret[i]=programs[i],decorators[i]&&(ret[i+"_d"]=decorators[i],ret.useDecorators=!0));return this.environment.usePartial&&(ret.usePartial=!0),this.options.data&&(ret.useData=!0),this.useDepths&&(ret.useDepths=!0),this.useBlockParams&&(ret.useBlockParams=!0),this.options.compat&&(ret.compat=!0),asObject?ret.compilerOptions=this.options:(ret.compiler=JSON.stringify(ret.compiler),this.source.currentLocation={start:{line:1,column:0}},ret=this.objectLiteral(ret),options.srcName?(ret=ret.toStringWithSourceMap({file:options.destName}),ret.map=ret.map&&ret.map.toString()):ret=ret.toString()),ret},preamble:function(){this.lastContext=0,this.source=new _codeGen2.default(this.options.srcName),this.decorators=new _codeGen2.default(this.options.srcName)},createFunctionContext:function(asObject){var varDeclarations="",locals=this.stackVars.concat(this.registers.list);locals.length>0&&(varDeclarations+=", "+locals.join(", "));var aliasCount=0;for(var alias in this.aliases){var node=this.aliases[alias];this.aliases.hasOwnProperty(alias)&&node.children&&node.referenceCount>1&&(varDeclarations+=", alias"+ ++aliasCount+"="+alias,node.children[0]="alias"+aliasCount)}var params=["container","depth0","helpers","partials","data"];(this.useBlockParams||this.useDepths)&&params.push("blockParams"),this.useDepths&&params.push("depths");var source=this.mergeSource(varDeclarations);return asObject?(params.push(source),Function.apply(this,params)):this.source.wrap(["function(",params.join(","),") {\n  ",source,"}"])},mergeSource:function(varDeclarations){var isSimple=this.environment.isSimple,appendOnly=!this.forceBuffer,appendFirst=void 0,sourceSeen=void 0,bufferStart=void 0,bufferEnd=void 0;return this.source.each(function(line){line.appendToBuffer?(bufferStart?line.prepend("  + "):bufferStart=line,bufferEnd=line):(bufferStart&&(sourceSeen?bufferStart.prepend("buffer += "):appendFirst=!0,bufferEnd.add(";"),bufferStart=bufferEnd=void 0),sourceSeen=!0,isSimple||(appendOnly=!1))}),appendOnly?bufferStart?(bufferStart.prepend("return "),bufferEnd.add(";")):sourceSeen||this.source.push('return "";'):(varDeclarations+=", buffer = "+(appendFirst?"":this.initializeBuffer()),bufferStart?(bufferStart.prepend("return buffer + "),bufferEnd.add(";")):this.source.push("return buffer;")),varDeclarations&&this.source.prepend("var "+varDeclarations.substring(2)+(appendFirst?"":";\n")),this.source.merge()},blockValue:function(name){var blockHelperMissing=this.aliasable("helpers.blockHelperMissing"),params=[this.contextName(0)];this.setupHelperArgs(name,0,params);var blockName=this.popStack();params.splice(1,0,blockName),this.push(this.source.functionCall(blockHelperMissing,"call",params))},ambiguousBlockValue:function(){var blockHelperMissing=this.aliasable("helpers.blockHelperMissing"),params=[this.contextName(0)];this.setupHelperArgs("",0,params,!0),this.flushInline();var current=this.topStack();params.splice(1,0,current),this.pushSource(["if (!",this.lastHelper,") { ",current," = ",this.source.functionCall(blockHelperMissing,"call",params),"}"])},appendContent:function(content){this.pendingContent?content=this.pendingContent+content:this.pendingLocation=this.source.currentLocation,this.pendingContent=content},append:function(){if(this.isInline())this.replaceStack(function(current){return[" != null ? ",current,' : ""']}),this.pushSource(this.appendToBuffer(this.popStack()));else{var local=this.popStack();this.pushSource(["if (",local," != null) { ",this.appendToBuffer(local,void 0,!0)," }"]),this.environment.isSimple&&this.pushSource(["else { ",this.appendToBuffer("''",void 0,!0)," }"])}},appendEscaped:function(){this.pushSource(this.appendToBuffer([this.aliasable("container.escapeExpression"),"(",this.popStack(),")"]))},getContext:function(depth){this.lastContext=depth},pushContext:function(){this.pushStackLiteral(this.contextName(this.lastContext))},lookupOnContext:function(parts,falsy,strict,scoped){var i=0;scoped||!this.options.compat||this.lastContext?this.pushContext():this.push(this.depthedLookup(parts[i++])),this.resolvePath("context",parts,i,falsy,strict)},lookupBlockParam:function(blockParamId,parts){this.useBlockParams=!0,this.push(["blockParams[",blockParamId[0],"][",blockParamId[1],"]"]),this.resolvePath("context",parts,1)},lookupData:function(depth,parts,strict){depth?this.pushStackLiteral("container.data(data, "+depth+")"):this.pushStackLiteral("data"),this.resolvePath("data",parts,0,!0,strict)},resolvePath:function(type,parts,i,falsy,strict){var _this=this;if(this.options.strict||this.options.assumeObjects)return void this.push(strictLookup(this.options.strict&&strict,this,parts,type));for(var len=parts.length;i<len;i++)this.replaceStack(function(current){var lookup=_this.nameLookup(current,parts[i],type);return falsy?[" && ",lookup]:[" != null ? ",lookup," : ",current]})},resolvePossibleLambda:function(){this.push([this.aliasable("container.lambda"),"(",this.popStack(),", ",this.contextName(0),")"])},pushStringParam:function(string,type){this.pushContext(),this.pushString(type),"SubExpression"!==type&&("string"==typeof string?this.pushString(string):this.pushStackLiteral(string))},emptyHash:function(omitEmpty){this.trackIds&&this.push("{}"),this.stringParams&&(this.push("{}"),this.push("{}")),this.pushStackLiteral(omitEmpty?"undefined":"{}")},pushHash:function(){this.hash&&this.hashes.push(this.hash),this.hash={values:[],types:[],contexts:[],ids:[]}},popHash:function(){var hash=this.hash;this.hash=this.hashes.pop(),this.trackIds&&this.push(this.objectLiteral(hash.ids)),this.stringParams&&(this.push(this.objectLiteral(hash.contexts)),this.push(this.objectLiteral(hash.types))),this.push(this.objectLiteral(hash.values))},pushString:function(string){this.pushStackLiteral(this.quotedString(string))},pushLiteral:function(value){this.pushStackLiteral(value)},pushProgram:function(guid){null!=guid?this.pushStackLiteral(this.programExpression(guid)):this.pushStackLiteral(null)},registerDecorator:function(paramSize,name){var foundDecorator=this.nameLookup("decorators",name,"decorator"),options=this.setupHelperArgs(name,paramSize);this.decorators.push(["fn = ",this.decorators.functionCall(foundDecorator,"",["fn","props","container",options])," || fn;"])},invokeHelper:function(paramSize,name,isSimple){var nonHelper=this.popStack(),helper=this.setupHelper(paramSize,name),simple=isSimple?[helper.name," || "]:"",lookup=["("].concat(simple,nonHelper);this.options.strict||lookup.push(" || ",this.aliasable("helpers.helperMissing")),lookup.push(")"),this.push(this.source.functionCall(lookup,"call",helper.callParams))},invokeKnownHelper:function(paramSize,name){var helper=this.setupHelper(paramSize,name);this.push(this.source.functionCall(helper.name,"call",helper.callParams))},invokeAmbiguous:function(name,helperCall){this.useRegister("helper");var nonHelper=this.popStack();this.emptyHash();var helper=this.setupHelper(0,name,helperCall),helperName=this.lastHelper=this.nameLookup("helpers",name,"helper"),lookup=["(","(helper = ",helperName," || ",nonHelper,")"];this.options.strict||(lookup[0]="(helper = ",lookup.push(" != null ? helper : ",this.aliasable("helpers.helperMissing"))),this.push(["(",lookup,helper.paramsInit?["),(",helper.paramsInit]:[],"),","(typeof helper === ",this.aliasable('"function"')," ? ",this.source.functionCall("helper","call",helper.callParams)," : helper))"])},invokePartial:function(isDynamic,name,indent){var params=[],options=this.setupParams(name,1,params);isDynamic&&(name=this.popStack(),delete options.name),indent&&(options.indent=JSON.stringify(indent)),options.helpers="helpers",options.partials="partials",options.decorators="container.decorators",isDynamic?params.unshift(name):params.unshift(this.nameLookup("partials",name,"partial")),this.options.compat&&(options.depths="depths"),options=this.objectLiteral(options),params.push(options),this.push(this.source.functionCall("container.invokePartial","",params))},assignToHash:function(key){var value=this.popStack(),context=void 0,type=void 0,id=void 0;this.trackIds&&(id=this.popStack()),this.stringParams&&(type=this.popStack(),context=this.popStack());var hash=this.hash;context&&(hash.contexts[key]=context),type&&(hash.types[key]=type),id&&(hash.ids[key]=id),hash.values[key]=value},pushId:function(type,name,child){"BlockParam"===type?this.pushStackLiteral("blockParams["+name[0]+"].path["+name[1]+"]"+(child?" + "+JSON.stringify("."+child):"")):"PathExpression"===type?this.pushString(name):"SubExpression"===type?this.pushStackLiteral("true"):this.pushStackLiteral("null")},compiler:JavaScriptCompiler,compileChildren:function(environment,options){for(var children=environment.children,child=void 0,compiler=void 0,i=0,l=children.length;i<l;i++){child=children[i],compiler=new this.compiler;var index=this.matchExistingProgram(child);null==index?(this.context.programs.push(""),index=this.context.programs.length,child.index=index,child.name="program"+index,this.context.programs[index]=compiler.compile(child,options,this.context,!this.precompile),this.context.decorators[index]=compiler.decorators,this.context.environments[index]=child,this.useDepths=this.useDepths||compiler.useDepths,this.useBlockParams=this.useBlockParams||compiler.useBlockParams):(child.index=index,child.name="program"+index,this.useDepths=this.useDepths||child.useDepths,this.useBlockParams=this.useBlockParams||child.useBlockParams)}},matchExistingProgram:function(child){for(var i=0,len=this.context.environments.length;i<len;i++){var environment=this.context.environments[i];if(environment&&environment.equals(child))return i}},programExpression:function(guid){var child=this.environment.children[guid],programParams=[child.index,"data",child.blockParams];return(this.useBlockParams||this.useDepths)&&programParams.push("blockParams"),this.useDepths&&programParams.push("depths"),"container.program("+programParams.join(", ")+")"},useRegister:function(name){this.registers[name]||(this.registers[name]=!0,this.registers.list.push(name))},push:function(expr){return expr instanceof Literal||(expr=this.source.wrap(expr)),this.inlineStack.push(expr),expr},pushStackLiteral:function(item){this.push(new Literal(item))},pushSource:function(source){this.pendingContent&&(this.source.push(this.appendToBuffer(this.source.quotedString(this.pendingContent),this.pendingLocation)),this.pendingContent=void 0),source&&this.source.push(source)},replaceStack:function(callback){var prefix=["("],stack=void 0,createdStack=void 0,usedLiteral=void 0;if(!this.isInline())throw new _exception2.default("replaceStack on non-inline");var top=this.popStack(!0);if(top instanceof Literal)stack=[top.value],prefix=["(",stack],usedLiteral=!0;else{createdStack=!0;var _name=this.incrStack();prefix=["((",this.push(_name)," = ",top,")"],stack=this.topStack()}var item=callback.call(this,stack);usedLiteral||this.popStack(),createdStack&&this.stackSlot--,this.push(prefix.concat(item,")"))},incrStack:function(){return this.stackSlot++,this.stackSlot>this.stackVars.length&&this.stackVars.push("stack"+this.stackSlot),this.topStackName()},topStackName:function(){return"stack"+this.stackSlot},flushInline:function(){var inlineStack=this.inlineStack;this.inlineStack=[];for(var i=0,len=inlineStack.length;i<len;i++){var entry=inlineStack[i];if(entry instanceof Literal)this.compileStack.push(entry);else{var stack=this.incrStack();this.pushSource([stack," = ",entry,";"]),this.compileStack.push(stack)}}},isInline:function(){return this.inlineStack.length},popStack:function(wrapped){var inline=this.isInline(),item=(inline?this.inlineStack:this.compileStack).pop();if(!wrapped&&item instanceof Literal)return item.value;if(!inline){if(!this.stackSlot)throw new _exception2.default("Invalid stack pop");this.stackSlot--}return item},topStack:function(){var stack=this.isInline()?this.inlineStack:this.compileStack,item=stack[stack.length-1];return item instanceof Literal?item.value:item},contextName:function(context){return this.useDepths&&context?"depths["+context+"]":"depth"+context},quotedString:function(str){return this.source.quotedString(str)},objectLiteral:function(obj){return this.source.objectLiteral(obj)},aliasable:function(name){var ret=this.aliases[name];return ret?(ret.referenceCount++,ret):(ret=this.aliases[name]=this.source.wrap(name),ret.aliasable=!0,ret.referenceCount=1,ret)},setupHelper:function(paramSize,name,blockHelper){var params=[];return{params:params,paramsInit:this.setupHelperArgs(name,paramSize,params,blockHelper),name:this.nameLookup("helpers",name,"helper"),callParams:[this.aliasable(this.contextName(0)+" != null ? "+this.contextName(0)+" : {}")].concat(params)}},setupParams:function(helper,paramSize,params){var options={},contexts=[],types=[],ids=[],objectArgs=!params,param=void 0;objectArgs&&(params=[]),options.name=this.quotedString(helper),options.hash=this.popStack(),this.trackIds&&(options.hashIds=this.popStack()),this.stringParams&&(options.hashTypes=this.popStack(),options.hashContexts=this.popStack());var inverse=this.popStack(),program=this.popStack();(program||inverse)&&(options.fn=program||"container.noop",options.inverse=inverse||"container.noop");for(var i=paramSize;i--;)param=this.popStack(),params[i]=param,this.trackIds&&(ids[i]=this.popStack()),this.stringParams&&(types[i]=this.popStack(),contexts[i]=this.popStack());return objectArgs&&(options.args=this.source.generateArray(params)),this.trackIds&&(options.ids=this.source.generateArray(ids)),this.stringParams&&(options.types=this.source.generateArray(types),options.contexts=this.source.generateArray(contexts)),this.options.data&&(options.data="data"),this.useBlockParams&&(options.blockParams="blockParams"),options},setupHelperArgs:function(helper,paramSize,params,useRegister){var options=this.setupParams(helper,paramSize,params);return options=this.objectLiteral(options),useRegister?(this.useRegister("options"),params.push("options"),["options=",options]):params?(params.push(options),""):options}},function(){for(var reservedWords="break else new var case finally return void catch for switch while continue function this with default if throw delete in try do instanceof typeof abstract enum int short boolean export interface static byte extends long super char final native synchronized class float package throws const goto private transient debugger implements protected volatile double import public let yield await null true false".split(" "),compilerWords=JavaScriptCompiler.RESERVED_WORDS={},i=0,l=reservedWords.length;i<l;i++)compilerWords[reservedWords[i]]=!0}(),JavaScriptCompiler.isValidJavaScriptVariableName=function(name){return!JavaScriptCompiler.RESERVED_WORDS[name]&&/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(name)};function strictLookup(requireTerminal,compiler,parts,type){var stack=compiler.popStack(),i=0,len=parts.length;for(requireTerminal&&len--;i<len;i++)stack=compiler.nameLookup(stack,parts[i],type);return requireTerminal?[compiler.aliasable("container.strict"),"(",stack,", ",compiler.quotedString(parts[i]),")"]:stack}exports.default=JavaScriptCompiler,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5),SourceNode=void 0;try{}catch(err){}SourceNode||(SourceNode=function(line,column,srcFile,chunks){this.src="",chunks&&this.add(chunks)},SourceNode.prototype={add:function(chunks){_utils.isArray(chunks)&&(chunks=chunks.join("")),this.src+=chunks},prepend:function(chunks){_utils.isArray(chunks)&&(chunks=chunks.join("")),this.src=chunks+this.src},toStringWithSourceMap:function(){return{code:this.toString()}},toString:function(){return this.src}});function castChunk(chunk,codeGen,loc){if(_utils.isArray(chunk)){for(var ret=[],i=0,len=chunk.length;i<len;i++)ret.push(codeGen.wrap(chunk[i],loc));return ret}return"boolean"==typeof chunk||"number"==typeof chunk?chunk+"":chunk}function CodeGen(srcFile){this.srcFile=srcFile,this.source=[]}CodeGen.prototype={isEmpty:function(){return!this.source.length},prepend:function(source,loc){this.source.unshift(this.wrap(source,loc))},push:function(source,loc){this.source.push(this.wrap(source,loc))},merge:function(){var source=this.empty();return this.each(function(line){source.add(["  ",line,"\n"])}),source},each:function(iter){for(var i=0,len=this.source.length;i<len;i++)iter(this.source[i])},empty:function(){var loc=this.currentLocation||{start:{}};return new SourceNode(loc.start.line,loc.start.column,this.srcFile)},wrap:function(chunk){var loc=arguments.length<=1||void 0===arguments[1]?this.currentLocation||{start:{}}:arguments[1];return chunk instanceof SourceNode?chunk:(chunk=castChunk(chunk,this,loc),new SourceNode(loc.start.line,loc.start.column,this.srcFile,chunk))},functionCall:function(fn,type,params){return params=this.generateList(params),this.wrap([fn,type?"."+type+"(":"(",params,")"])},quotedString:function(str){return'"'+(str+"").replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")+'"'},objectLiteral:function(obj){var pairs=[];for(var key in obj)if(obj.hasOwnProperty(key)){var value=castChunk(obj[key],this);"undefined"!==value&&pairs.push([this.quotedString(key),":",value])}var ret=this.generateList(pairs);return ret.prepend("{"),ret.add("}"),ret},generateList:function(entries){for(var ret=this.empty(),i=0,len=entries.length;i<len;i++)i&&ret.add(","),ret.add(castChunk(entries[i],this));return ret},generateArray:function(entries){var ret=this.generateList(entries);return ret.prepend("["),ret.add("]"),ret}},exports.default=CodeGen,module.exports=exports.default}])}),function(){"use strict";var HowlerGlobal=function(){this.init()};HowlerGlobal.prototype={init:function(){var self=this||Howler;return self._counter=1e3,self._html5AudioPool=[],self.html5PoolSize=10,self._codecs={},self._howls=[],self._muted=!1,self._volume=1,self._canPlayEvent="canplaythrough",self._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,self.masterGain=null,self.noAudio=!1,self.usingWebAudio=!0,self.autoSuspend=!0,self.ctx=null,self.autoUnlock=!0,self._setup(),self},volume:function(vol){var self=this||Howler;if(vol=parseFloat(vol),self.ctx||setupAudioContext(),void 0!==vol&&vol>=0&&vol<=1){if(self._volume=vol,self._muted)return self;self.usingWebAudio&&self.masterGain.gain.setValueAtTime(vol,Howler.ctx.currentTime);for(var i=0;i<self._howls.length;i++)if(!self._howls[i]._webAudio)for(var ids=self._howls[i]._getSoundIds(),j=0;j<ids.length;j++){var sound=self._howls[i]._soundById(ids[j]);sound&&sound._node&&(sound._node.volume=sound._volume*vol)}return self}return self._volume},mute:function(muted){var self=this||Howler;self.ctx||setupAudioContext(),self._muted=muted,self.usingWebAudio&&self.masterGain.gain.setValueAtTime(muted?0:self._volume,Howler.ctx.currentTime);for(var i=0;i<self._howls.length;i++)if(!self._howls[i]._webAudio)for(var ids=self._howls[i]._getSoundIds(),j=0;j<ids.length;j++){var sound=self._howls[i]._soundById(ids[j]);sound&&sound._node&&(sound._node.muted=!!muted||sound._muted)}return self},unload:function(){for(var self=this||Howler,i=self._howls.length-1;i>=0;i--)self._howls[i].unload();return self.usingWebAudio&&self.ctx&&void 0!==self.ctx.close&&(self.ctx.close(),self.ctx=null,setupAudioContext()),self},codecs:function(ext){return(this||Howler)._codecs[ext.replace(/^x-/,"")]},_setup:function(){var self=this||Howler;if(self.state=self.ctx?self.ctx.state||"suspended":"suspended",self._autoSuspend(),!self.usingWebAudio)if("undefined"!=typeof Audio)try{var test=new Audio;void 0===test.oncanplaythrough&&(self._canPlayEvent="canplay")}catch(e){self.noAudio=!0}else self.noAudio=!0;try{var test=new Audio;test.muted&&(self.noAudio=!0)}catch(e){}return self.noAudio||self._setupCodecs(),self},_setupCodecs:function(){var self=this||Howler,audioTest=null;try{audioTest="undefined"!=typeof Audio?new Audio:null}catch(err){return self}if(!audioTest||"function"!=typeof audioTest.canPlayType)return self;var mpegTest=audioTest.canPlayType("audio/mpeg;").replace(/^no$/,""),checkOpera=self._navigator&&self._navigator.userAgent.match(/OPR\/([0-6].)/g),isOldOpera=checkOpera&&parseInt(checkOpera[0].split("/")[1],10)<33;return self._codecs={mp3:!(isOldOpera||!mpegTest&&!audioTest.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!mpegTest,opus:!!audioTest.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!audioTest.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!audioTest.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!audioTest.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!audioTest.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!audioTest.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(audioTest.canPlayType("audio/x-m4a;")||audioTest.canPlayType("audio/m4a;")||audioTest.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(audioTest.canPlayType("audio/x-mp4;")||audioTest.canPlayType("audio/mp4;")||audioTest.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!audioTest.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!audioTest.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),dolby:!!audioTest.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(audioTest.canPlayType("audio/x-flac;")||audioTest.canPlayType("audio/flac;")).replace(/^no$/,"")},self},_unlockAudio:function(){var self=this||Howler;if(!self._audioUnlocked&&self.ctx){self._audioUnlocked=!1,self.autoUnlock=!1,self._mobileUnloaded||44100===self.ctx.sampleRate||(self._mobileUnloaded=!0,self.unload()),self._scratchBuffer=self.ctx.createBuffer(1,1,22050);var unlock=function(e){for(var i=0;i<self.html5PoolSize;i++)try{var audioNode=new Audio;audioNode._unlocked=!0,self._releaseHtml5Audio(audioNode)}catch(e){self.noAudio=!0}for(var i=0;i<self._howls.length;i++)if(!self._howls[i]._webAudio)for(var ids=self._howls[i]._getSoundIds(),j=0;j<ids.length;j++){var sound=self._howls[i]._soundById(ids[j]);sound&&sound._node&&!sound._node._unlocked&&(sound._node._unlocked=!0,sound._node.load())}self._autoResume();var source=self.ctx.createBufferSource();source.buffer=self._scratchBuffer,source.connect(self.ctx.destination),void 0===source.start?source.noteOn(0):source.start(0),"function"==typeof self.ctx.resume&&self.ctx.resume(),source.onended=function(){source.disconnect(0),self._audioUnlocked=!0,document.removeEventListener("touchstart",unlock,!0),document.removeEventListener("touchend",unlock,!0),document.removeEventListener("click",unlock,!0);for(var i=0;i<self._howls.length;i++)self._howls[i]._emit("unlock")}};return document.addEventListener("touchstart",unlock,!0),document.addEventListener("touchend",unlock,!0),document.addEventListener("click",unlock,!0),self}},_obtainHtml5Audio:function(){var self=this||Howler;if(self._html5AudioPool.length)return self._html5AudioPool.pop();var testPlay=(new Audio).play();return testPlay&&"undefined"!=typeof Promise&&(testPlay instanceof Promise||"function"==typeof testPlay.then)&&testPlay.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(audio){var self=this||Howler;return audio._unlocked&&self._html5AudioPool.push(audio),self},_autoSuspend:function(){var self=this;if(self.autoSuspend&&self.ctx&&void 0!==self.ctx.suspend&&Howler.usingWebAudio){for(var i=0;i<self._howls.length;i++)if(self._howls[i]._webAudio)for(var j=0;j<self._howls[i]._sounds.length;j++)if(!self._howls[i]._sounds[j]._paused)return self;return self._suspendTimer&&clearTimeout(self._suspendTimer),self._suspendTimer=setTimeout(function(){self.autoSuspend&&(self._suspendTimer=null,self.state="suspending",self.ctx.suspend().then(function(){self.state="suspended",self._resumeAfterSuspend&&(delete self._resumeAfterSuspend,self._autoResume())}))},3e4),self}},_autoResume:function(){var self=this;if(self.ctx&&void 0!==self.ctx.resume&&Howler.usingWebAudio)return"running"===self.state&&self._suspendTimer?(clearTimeout(self._suspendTimer),self._suspendTimer=null):"suspended"===self.state?(self.ctx.resume().then(function(){self.state="running";for(var i=0;i<self._howls.length;i++)self._howls[i]._emit("resume")}),self._suspendTimer&&(clearTimeout(self._suspendTimer),self._suspendTimer=null)):"suspending"===self.state&&(self._resumeAfterSuspend=!0),self}};var Howler=new HowlerGlobal,Howl=function(o){var self=this;if(!o.src||0===o.src.length)return void console.error("An array of source files must be passed with any new Howl.");self.init(o)};Howl.prototype={init:function(o){var self=this;return Howler.ctx||setupAudioContext(),
self._autoplay=o.autoplay||!1,self._format="string"!=typeof o.format?o.format:[o.format],self._html5=o.html5||!1,self._muted=o.mute||!1,self._loop=o.loop||!1,self._pool=o.pool||5,self._preload="boolean"!=typeof o.preload||o.preload,self._rate=o.rate||1,self._sprite=o.sprite||{},self._src="string"!=typeof o.src?o.src:[o.src],self._volume=void 0!==o.volume?o.volume:1,self._xhrWithCredentials=o.xhrWithCredentials||!1,self._duration=0,self._state="unloaded",self._sounds=[],self._endTimers={},self._queue=[],self._playLock=!1,self._onend=o.onend?[{fn:o.onend}]:[],self._onfade=o.onfade?[{fn:o.onfade}]:[],self._onload=o.onload?[{fn:o.onload}]:[],self._onloaderror=o.onloaderror?[{fn:o.onloaderror}]:[],self._onplayerror=o.onplayerror?[{fn:o.onplayerror}]:[],self._onpause=o.onpause?[{fn:o.onpause}]:[],self._onplay=o.onplay?[{fn:o.onplay}]:[],self._onstop=o.onstop?[{fn:o.onstop}]:[],self._onmute=o.onmute?[{fn:o.onmute}]:[],self._onvolume=o.onvolume?[{fn:o.onvolume}]:[],self._onrate=o.onrate?[{fn:o.onrate}]:[],self._onseek=o.onseek?[{fn:o.onseek}]:[],self._onunlock=o.onunlock?[{fn:o.onunlock}]:[],self._onresume=[],self._webAudio=Howler.usingWebAudio&&!self._html5,void 0!==Howler.ctx&&Howler.ctx&&Howler.autoUnlock&&Howler._unlockAudio(),Howler._howls.push(self),self._autoplay&&self._queue.push({event:"play",action:function(){self.play()}}),self._preload&&self.load(),self},load:function(){var self=this,url=null;if(Howler.noAudio)return void self._emit("loaderror",null,"No audio support.");"string"==typeof self._src&&(self._src=[self._src]);for(var i=0;i<self._src.length;i++){var ext,str;if(self._format&&self._format[i])ext=self._format[i];else{if("string"!=typeof(str=self._src[i])){self._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}ext=/^data:audio\/([^;,]+);/i.exec(str),ext||(ext=/\.([^.]+)$/.exec(str.split("?",1)[0])),ext&&(ext=ext[1].toLowerCase())}if(ext||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),ext&&Howler.codecs(ext)){url=self._src[i];break}}return url?(self._src=url,self._state="loading","https:"===window.location.protocol&&"http:"===url.slice(0,5)&&(self._html5=!0,self._webAudio=!1),new Sound(self),self._webAudio&&loadBuffer(self),self):void self._emit("loaderror",null,"No codec support for selected audio sources.")},play:function(sprite,internal){var self=this,id=null;if("number"==typeof sprite)id=sprite,sprite=null;else{if("string"==typeof sprite&&"loaded"===self._state&&!self._sprite[sprite])return null;if(void 0===sprite&&(sprite="__default",!self._playLock)){for(var num=0,i=0;i<self._sounds.length;i++)self._sounds[i]._paused&&!self._sounds[i]._ended&&(num++,id=self._sounds[i]._id);1===num?sprite=null:id=null}}var sound=id?self._soundById(id):self._inactiveSound();if(!sound)return null;if(id&&!sprite&&(sprite=sound._sprite||"__default"),"loaded"!==self._state){sound._sprite=sprite,sound._ended=!1;var soundId=sound._id;return self._queue.push({event:"play",action:function(){self.play(soundId)}}),soundId}if(id&&!sound._paused)return internal||self._loadQueue("play"),sound._id;self._webAudio&&Howler._autoResume();var seek=Math.max(0,sound._seek>0?sound._seek:self._sprite[sprite][0]/1e3),duration=Math.max(0,(self._sprite[sprite][0]+self._sprite[sprite][1])/1e3-seek),timeout=1e3*duration/Math.abs(sound._rate),start=self._sprite[sprite][0]/1e3,stop=(self._sprite[sprite][0]+self._sprite[sprite][1])/1e3,loop=!(!sound._loop&&!self._sprite[sprite][2]);sound._sprite=sprite,sound._ended=!1,sound._paused=!1;var setParams=function(){sound._paused=!1,sound._seek=seek,sound._start=start,sound._stop=stop,sound._loop=loop};if(seek>=stop)return void self._ended(sound);var node=sound._node;if(self._webAudio){var playWebAudio=function(){self._playLock=!1,setParams(),self._refreshBuffer(sound);var vol=sound._muted||self._muted?0:sound._volume;node.gain.setValueAtTime(vol,Howler.ctx.currentTime),sound._playStart=Howler.ctx.currentTime,void 0===node.bufferSource.start?sound._loop?node.bufferSource.noteGrainOn(0,seek,86400):node.bufferSource.noteGrainOn(0,seek,duration):sound._loop?node.bufferSource.start(0,seek,86400):node.bufferSource.start(0,seek,duration),timeout!==1/0&&(self._endTimers[sound._id]=setTimeout(self._ended.bind(self,sound),timeout)),internal||setTimeout(function(){self._emit("play",sound._id),self._loadQueue()},0)};"running"===Howler.state?playWebAudio():(self._playLock=!0,self.once("resume",playWebAudio),self._clearTimer(sound._id))}else{var playHtml5=function(){node.currentTime=seek,node.muted=sound._muted||self._muted||Howler._muted||node.muted,node.volume=sound._volume*Howler.volume(),node.playbackRate=sound._rate;try{var play=node.play();if(play&&"undefined"!=typeof Promise&&(play instanceof Promise||"function"==typeof play.then)?(self._playLock=!0,setParams(),play.then(function(){self._playLock=!1,node._unlocked=!0,internal||(self._emit("play",sound._id),self._loadQueue())}).catch(function(){self._playLock=!1,self._emit("playerror",sound._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),sound._ended=!0,sound._paused=!0})):internal?self._playLock=!1:(self._playLock=!1,setParams(),self._emit("play",sound._id),self._loadQueue()),node.playbackRate=sound._rate,node.paused)return void self._emit("playerror",sound._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==sprite||sound._loop?self._endTimers[sound._id]=setTimeout(self._ended.bind(self,sound),timeout):(self._endTimers[sound._id]=function(){self._ended(sound),node.removeEventListener("ended",self._endTimers[sound._id],!1)},node.addEventListener("ended",self._endTimers[sound._id],!1))}catch(err){self._emit("playerror",sound._id,err)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===node.src&&(node.src=self._src,node.load());var loadedNoReadyState=window&&window.ejecta||!node.readyState&&Howler._navigator.isCocoonJS;if(node.readyState>=3||loadedNoReadyState)playHtml5();else{self._playLock=!0;var listener=function(){playHtml5(),node.removeEventListener(Howler._canPlayEvent,listener,!1)};node.addEventListener(Howler._canPlayEvent,listener,!1),self._clearTimer(sound._id)}}return sound._id},pause:function(id){var self=this;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"pause",action:function(){self.pause(id)}}),self;for(var ids=self._getSoundIds(id),i=0;i<ids.length;i++){self._clearTimer(ids[i]);var sound=self._soundById(ids[i]);if(sound&&!sound._paused&&(sound._seek=self.seek(ids[i]),sound._rateSeek=0,sound._paused=!0,self._stopFade(ids[i]),sound._node))if(self._webAudio){if(!sound._node.bufferSource)continue;void 0===sound._node.bufferSource.stop?sound._node.bufferSource.noteOff(0):sound._node.bufferSource.stop(0),self._cleanBuffer(sound._node)}else isNaN(sound._node.duration)&&sound._node.duration!==1/0||sound._node.pause();arguments[1]||self._emit("pause",sound?sound._id:null)}return self},stop:function(id,internal){var self=this;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"stop",action:function(){self.stop(id)}}),self;for(var ids=self._getSoundIds(id),i=0;i<ids.length;i++){self._clearTimer(ids[i]);var sound=self._soundById(ids[i]);sound&&(sound._seek=sound._start||0,sound._rateSeek=0,sound._paused=!0,sound._ended=!0,self._stopFade(ids[i]),sound._node&&(self._webAudio?sound._node.bufferSource&&(void 0===sound._node.bufferSource.stop?sound._node.bufferSource.noteOff(0):sound._node.bufferSource.stop(0),self._cleanBuffer(sound._node)):isNaN(sound._node.duration)&&sound._node.duration!==1/0||(sound._node.currentTime=sound._start||0,sound._node.pause(),sound._node.duration===1/0&&self._clearSound(sound._node))),internal||self._emit("stop",sound._id))}return self},mute:function(muted,id){var self=this;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"mute",action:function(){self.mute(muted,id)}}),self;if(void 0===id){if("boolean"!=typeof muted)return self._muted;self._muted=muted}for(var ids=self._getSoundIds(id),i=0;i<ids.length;i++){var sound=self._soundById(ids[i]);sound&&(sound._muted=muted,sound._interval&&self._stopFade(sound._id),self._webAudio&&sound._node?sound._node.gain.setValueAtTime(muted?0:sound._volume,Howler.ctx.currentTime):sound._node&&(sound._node.muted=!!Howler._muted||muted),self._emit("mute",sound._id))}return self},volume:function(){var vol,id,self=this,args=arguments;if(0===args.length)return self._volume;if(1===args.length||2===args.length&&void 0===args[1]){self._getSoundIds().indexOf(args[0])>=0?id=parseInt(args[0],10):vol=parseFloat(args[0])}else args.length>=2&&(vol=parseFloat(args[0]),id=parseInt(args[1],10));var sound;if(!(void 0!==vol&&vol>=0&&vol<=1))return sound=id?self._soundById(id):self._sounds[0],sound?sound._volume:0;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"volume",action:function(){self.volume.apply(self,args)}}),self;void 0===id&&(self._volume=vol),id=self._getSoundIds(id);for(var i=0;i<id.length;i++)(sound=self._soundById(id[i]))&&(sound._volume=vol,args[2]||self._stopFade(id[i]),self._webAudio&&sound._node&&!sound._muted?sound._node.gain.setValueAtTime(vol,Howler.ctx.currentTime):sound._node&&!sound._muted&&(sound._node.volume=vol*Howler.volume()),self._emit("volume",sound._id));return self},fade:function(from,to,len,id){var self=this;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"fade",action:function(){self.fade(from,to,len,id)}}),self;from=parseFloat(from),to=parseFloat(to),len=parseFloat(len),self.volume(from,id);for(var ids=self._getSoundIds(id),i=0;i<ids.length;i++){var sound=self._soundById(ids[i]);if(sound){if(id||self._stopFade(ids[i]),self._webAudio&&!sound._muted){var currentTime=Howler.ctx.currentTime,end=currentTime+len/1e3;sound._volume=from,sound._node.gain.setValueAtTime(from,currentTime),sound._node.gain.linearRampToValueAtTime(to,end)}self._startFadeInterval(sound,from,to,len,ids[i],void 0===id)}}return self},_startFadeInterval:function(sound,from,to,len,id,isGroup){var self=this,vol=from,diff=to-from,steps=Math.abs(diff/.01),stepLen=Math.max(4,steps>0?len/steps:len),lastTick=Date.now();sound._fadeTo=to,sound._interval=setInterval(function(){var tick=(Date.now()-lastTick)/len;lastTick=Date.now(),vol+=diff*tick,vol=Math.max(0,vol),vol=Math.min(1,vol),vol=Math.round(100*vol)/100,self._webAudio?sound._volume=vol:self.volume(vol,sound._id,!0),isGroup&&(self._volume=vol),(to<from&&vol<=to||to>from&&vol>=to)&&(clearInterval(sound._interval),sound._interval=null,sound._fadeTo=null,self.volume(to,sound._id),self._emit("fade",sound._id))},stepLen)},_stopFade:function(id){var self=this,sound=self._soundById(id);return sound&&sound._interval&&(self._webAudio&&sound._node.gain.cancelScheduledValues(Howler.ctx.currentTime),clearInterval(sound._interval),sound._interval=null,self.volume(sound._fadeTo,id),sound._fadeTo=null,self._emit("fade",id)),self},loop:function(){var loop,id,sound,self=this,args=arguments;if(0===args.length)return self._loop;if(1===args.length){if("boolean"!=typeof args[0])return!!(sound=self._soundById(parseInt(args[0],10)))&&sound._loop;loop=args[0],self._loop=loop}else 2===args.length&&(loop=args[0],id=parseInt(args[1],10));for(var ids=self._getSoundIds(id),i=0;i<ids.length;i++)(sound=self._soundById(ids[i]))&&(sound._loop=loop,self._webAudio&&sound._node&&sound._node.bufferSource&&(sound._node.bufferSource.loop=loop,loop&&(sound._node.bufferSource.loopStart=sound._start||0,sound._node.bufferSource.loopEnd=sound._stop)));return self},rate:function(){var rate,id,self=this,args=arguments;if(0===args.length)id=self._sounds[0]._id;else if(1===args.length){var ids=self._getSoundIds(),index=ids.indexOf(args[0]);index>=0?id=parseInt(args[0],10):rate=parseFloat(args[0])}else 2===args.length&&(rate=parseFloat(args[0]),id=parseInt(args[1],10));var sound;if("number"!=typeof rate)return sound=self._soundById(id),sound?sound._rate:self._rate;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"rate",action:function(){self.rate.apply(self,args)}}),self;void 0===id&&(self._rate=rate),id=self._getSoundIds(id);for(var i=0;i<id.length;i++)if(sound=self._soundById(id[i])){self.playing(id[i])&&(sound._rateSeek=self.seek(id[i]),sound._playStart=self._webAudio?Howler.ctx.currentTime:sound._playStart),sound._rate=rate,self._webAudio&&sound._node&&sound._node.bufferSource?sound._node.bufferSource.playbackRate.setValueAtTime(rate,Howler.ctx.currentTime):sound._node&&(sound._node.playbackRate=rate);var seek=self.seek(id[i]),duration=(self._sprite[sound._sprite][0]+self._sprite[sound._sprite][1])/1e3-seek,timeout=1e3*duration/Math.abs(sound._rate);!self._endTimers[id[i]]&&sound._paused||(self._clearTimer(id[i]),self._endTimers[id[i]]=setTimeout(self._ended.bind(self,sound),timeout)),self._emit("rate",sound._id)}return self},seek:function(){var seek,id,self=this,args=arguments;if(0===args.length)id=self._sounds[0]._id;else if(1===args.length){var ids=self._getSoundIds(),index=ids.indexOf(args[0]);index>=0?id=parseInt(args[0],10):self._sounds.length&&(id=self._sounds[0]._id,seek=parseFloat(args[0]))}else 2===args.length&&(seek=parseFloat(args[0]),id=parseInt(args[1],10));if(void 0===id)return self;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"seek",action:function(){self.seek.apply(self,args)}}),self;var sound=self._soundById(id);if(sound){if(!("number"==typeof seek&&seek>=0)){if(self._webAudio){var realTime=self.playing(id)?Howler.ctx.currentTime-sound._playStart:0,rateSeek=sound._rateSeek?sound._rateSeek-sound._seek:0;return sound._seek+(rateSeek+realTime*Math.abs(sound._rate))}return sound._node.currentTime}var playing=self.playing(id);playing&&self.pause(id,!0),sound._seek=seek,sound._ended=!1,self._clearTimer(id),self._webAudio||!sound._node||isNaN(sound._node.duration)||(sound._node.currentTime=seek);var seekAndEmit=function(){self._emit("seek",id),playing&&self.play(id,!0)};if(playing&&!self._webAudio){var emitSeek=function(){self._playLock?setTimeout(emitSeek,0):seekAndEmit()};setTimeout(emitSeek,0)}else seekAndEmit()}return self},playing:function(id){var self=this;if("number"==typeof id){var sound=self._soundById(id);return!!sound&&!sound._paused}for(var i=0;i<self._sounds.length;i++)if(!self._sounds[i]._paused)return!0;return!1},duration:function(id){var self=this,duration=self._duration,sound=self._soundById(id);return sound&&(duration=self._sprite[sound._sprite][1]/1e3),duration},state:function(){return this._state},unload:function(){for(var self=this,sounds=self._sounds,i=0;i<sounds.length;i++)sounds[i]._paused||self.stop(sounds[i]._id),self._webAudio||(self._clearSound(sounds[i]._node),sounds[i]._node.removeEventListener("error",sounds[i]._errorFn,!1),sounds[i]._node.removeEventListener(Howler._canPlayEvent,sounds[i]._loadFn,!1),Howler._releaseHtml5Audio(sounds[i]._node)),delete sounds[i]._node,self._clearTimer(sounds[i]._id);var index=Howler._howls.indexOf(self);index>=0&&Howler._howls.splice(index,1);var remCache=!0;for(i=0;i<Howler._howls.length;i++)if(Howler._howls[i]._src===self._src||self._src.indexOf(Howler._howls[i]._src)>=0){remCache=!1;break}return cache&&remCache&&delete cache[self._src],Howler.noAudio=!1,self._state="unloaded",self._sounds=[],self=null,null},on:function(event,fn,id,once){var self=this,events=self["_on"+event];return"function"==typeof fn&&events.push(once?{id:id,fn:fn,once:once}:{id:id,fn:fn}),self},off:function(event,fn,id){var self=this,events=self["_on"+event],i=0;if("number"==typeof fn&&(id=fn,fn=null),fn||id)for(i=0;i<events.length;i++){var isId=id===events[i].id;if(fn===events[i].fn&&isId||!fn&&isId){events.splice(i,1);break}}else if(event)self["_on"+event]=[];else{var keys=Object.keys(self);for(i=0;i<keys.length;i++)0===keys[i].indexOf("_on")&&Array.isArray(self[keys[i]])&&(self[keys[i]]=[])}return self},once:function(event,fn,id){var self=this;return self.on(event,fn,id,1),self},_emit:function(event,id,msg){for(var self=this,events=self["_on"+event],i=events.length-1;i>=0;i--)events[i].id&&events[i].id!==id&&"load"!==event||(setTimeout(function(fn){fn.call(this,id,msg)}.bind(self,events[i].fn),0),events[i].once&&self.off(event,events[i].fn,events[i].id));return self._loadQueue(event),self},_loadQueue:function(event){var self=this;if(self._queue.length>0){var task=self._queue[0];task.event===event&&(self._queue.shift(),self._loadQueue()),event||task.action()}return self},_ended:function(sound){var self=this,sprite=sound._sprite;if(!self._webAudio&&sound._node&&!sound._node.paused&&!sound._node.ended&&sound._node.currentTime<sound._stop)return setTimeout(self._ended.bind(self,sound),100),self;var loop=!(!sound._loop&&!self._sprite[sprite][2]);if(self._emit("end",sound._id),!self._webAudio&&loop&&self.stop(sound._id,!0).play(sound._id),self._webAudio&&loop){self._emit("play",sound._id),sound._seek=sound._start||0,sound._rateSeek=0,sound._playStart=Howler.ctx.currentTime;var timeout=1e3*(sound._stop-sound._start)/Math.abs(sound._rate);self._endTimers[sound._id]=setTimeout(self._ended.bind(self,sound),timeout)}return self._webAudio&&!loop&&(sound._paused=!0,sound._ended=!0,sound._seek=sound._start||0,sound._rateSeek=0,self._clearTimer(sound._id),self._cleanBuffer(sound._node),Howler._autoSuspend()),self._webAudio||loop||self.stop(sound._id,!0),self},_clearTimer:function(id){var self=this;if(self._endTimers[id]){if("function"!=typeof self._endTimers[id])clearTimeout(self._endTimers[id]);else{var sound=self._soundById(id);sound&&sound._node&&sound._node.removeEventListener("ended",self._endTimers[id],!1)}delete self._endTimers[id]}return self},_soundById:function(id){for(var self=this,i=0;i<self._sounds.length;i++)if(id===self._sounds[i]._id)return self._sounds[i];return null},_inactiveSound:function(){var self=this;self._drain();for(var i=0;i<self._sounds.length;i++)if(self._sounds[i]._ended)return self._sounds[i].reset();return new Sound(self)},_drain:function(){var self=this,limit=self._pool,cnt=0,i=0;if(!(self._sounds.length<limit)){for(i=0;i<self._sounds.length;i++)self._sounds[i]._ended&&cnt++;for(i=self._sounds.length-1;i>=0;i--){if(cnt<=limit)return;self._sounds[i]._ended&&(self._webAudio&&self._sounds[i]._node&&self._sounds[i]._node.disconnect(0),self._sounds.splice(i,1),cnt--)}}},_getSoundIds:function(id){var self=this;if(void 0===id){for(var ids=[],i=0;i<self._sounds.length;i++)ids.push(self._sounds[i]._id);return ids}return[id]},_refreshBuffer:function(sound){var self=this;return sound._node.bufferSource=Howler.ctx.createBufferSource(),sound._node.bufferSource.buffer=cache[self._src],sound._panner?sound._node.bufferSource.connect(sound._panner):sound._node.bufferSource.connect(sound._node),sound._node.bufferSource.loop=sound._loop,sound._loop&&(sound._node.bufferSource.loopStart=sound._start||0,sound._node.bufferSource.loopEnd=sound._stop||0),sound._node.bufferSource.playbackRate.setValueAtTime(sound._rate,Howler.ctx.currentTime),self},_cleanBuffer:function(node){var self=this,isIOS=Howler._navigator&&Howler._navigator.vendor.indexOf("Apple")>=0;if(Howler._scratchBuffer&&node.bufferSource&&(node.bufferSource.onended=null,node.bufferSource.disconnect(0),isIOS))try{node.bufferSource.buffer=Howler._scratchBuffer}catch(e){}return node.bufferSource=null,self},_clearSound:function(node){/MSIE |Trident\//.test(Howler._navigator&&Howler._navigator.userAgent)||(node.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var Sound=function(howl){this._parent=howl,this.init()};Sound.prototype={init:function(){var self=this,parent=self._parent;return self._muted=parent._muted,self._loop=parent._loop,self._volume=parent._volume,self._rate=parent._rate,self._seek=0,self._paused=!0,self._ended=!0,self._sprite="__default",self._id=++Howler._counter,parent._sounds.push(self),self.create(),self},create:function(){var self=this,parent=self._parent,volume=Howler._muted||self._muted||self._parent._muted?0:self._volume;return parent._webAudio?(self._node=void 0===Howler.ctx.createGain?Howler.ctx.createGainNode():Howler.ctx.createGain(),self._node.gain.setValueAtTime(volume,Howler.ctx.currentTime),self._node.paused=!0,self._node.connect(Howler.masterGain)):(self._node=Howler._obtainHtml5Audio(),self._errorFn=self._errorListener.bind(self),self._node.addEventListener("error",self._errorFn,!1),self._loadFn=self._loadListener.bind(self),self._node.addEventListener(Howler._canPlayEvent,self._loadFn,!1),self._node.src=parent._src,self._node.preload="auto",self._node.volume=volume*Howler.volume(),self._node.load()),self},reset:function(){var self=this,parent=self._parent;return self._muted=parent._muted,self._loop=parent._loop,self._volume=parent._volume,self._rate=parent._rate,self._seek=0,self._rateSeek=0,self._paused=!0,self._ended=!0,self._sprite="__default",self._id=++Howler._counter,self},_errorListener:function(){var self=this;self._parent._emit("loaderror",self._id,self._node.error?self._node.error.code:0),self._node.removeEventListener("error",self._errorFn,!1)},_loadListener:function(){var self=this,parent=self._parent;parent._duration=Math.ceil(10*self._node.duration)/10,0===Object.keys(parent._sprite).length&&(parent._sprite={__default:[0,1e3*parent._duration]}),"loaded"!==parent._state&&(parent._state="loaded",parent._emit("load"),parent._loadQueue()),self._node.removeEventListener(Howler._canPlayEvent,self._loadFn,!1)}};var cache={},loadBuffer=function(self){var url=self._src;if(cache[url])return self._duration=cache[url].duration,void loadSound(self);if(/^data:[^;]+;base64,/.test(url)){for(var data=atob(url.split(",")[1]),dataView=new Uint8Array(data.length),i=0;i<data.length;++i)dataView[i]=data.charCodeAt(i);decodeAudioData(dataView.buffer,self)}else{var xhr=new XMLHttpRequest;xhr.open("GET",url,!0),xhr.withCredentials=self._xhrWithCredentials,xhr.responseType="arraybuffer",xhr.onload=function(){var code=(xhr.status+"")[0];if("0"!==code&&"2"!==code&&"3"!==code)return void self._emit("loaderror",null,"Failed loading audio file with status: "+xhr.status+".");decodeAudioData(xhr.response,self)},xhr.onerror=function(){self._webAudio&&(self._html5=!0,self._webAudio=!1,self._sounds=[],delete cache[url],self.load())},safeXhrSend(xhr)}},safeXhrSend=function(xhr){try{xhr.send()}catch(e){xhr.onerror()}},decodeAudioData=function(arraybuffer,self){var error=function(){self._emit("loaderror",null,"Decoding audio data failed.")},success=function(buffer){buffer&&self._sounds.length>0?(cache[self._src]=buffer,loadSound(self,buffer)):error()};"undefined"!=typeof Promise&&1===Howler.ctx.decodeAudioData.length?Howler.ctx.decodeAudioData(arraybuffer).then(success).catch(error):Howler.ctx.decodeAudioData(arraybuffer,success,error)},loadSound=function(self,buffer){buffer&&!self._duration&&(self._duration=buffer.duration),0===Object.keys(self._sprite).length&&(self._sprite={__default:[0,1e3*self._duration]}),"loaded"!==self._state&&(self._state="loaded",self._emit("load"),self._loadQueue())},setupAudioContext=function(){if(Howler.usingWebAudio){try{"undefined"!=typeof AudioContext?Howler.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?Howler.ctx=new webkitAudioContext:Howler.usingWebAudio=!1}catch(e){Howler.usingWebAudio=!1}Howler.ctx||(Howler.usingWebAudio=!1);var iOS=/iP(hone|od|ad)/.test(Howler._navigator&&Howler._navigator.platform),appVersion=Howler._navigator&&Howler._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),version=appVersion?parseInt(appVersion[1],10):null;if(iOS&&version&&version<9){var safari=/safari/.test(Howler._navigator&&Howler._navigator.userAgent.toLowerCase());(Howler._navigator&&Howler._navigator.standalone&&!safari||Howler._navigator&&!Howler._navigator.standalone&&!safari)&&(Howler.usingWebAudio=!1)}Howler.usingWebAudio&&(Howler.masterGain=void 0===Howler.ctx.createGain?Howler.ctx.createGainNode():Howler.ctx.createGain(),Howler.masterGain.gain.setValueAtTime(Howler._muted?0:1,Howler.ctx.currentTime),Howler.masterGain.connect(Howler.ctx.destination)),Howler._setup()}};"function"==typeof define&&define.amd&&define([],function(){return{Howler:Howler,Howl:Howl}}),"undefined"!=typeof exports&&(exports.Howler=Howler,exports.Howl=Howl),"undefined"!=typeof window?(window.HowlerGlobal=HowlerGlobal,window.Howler=Howler,window.Howl=Howl,window.Sound=Sound):"undefined"!=typeof global&&(global.HowlerGlobal=HowlerGlobal,global.Howler=Howler,global.Howl=Howl,global.Sound=Sound)}(),document.createElement("video"),document.createElement("audio"),document.createElement("track");var vjs=function(id,options,ready){var tag;if("string"==typeof id){if(0===id.indexOf("#")&&(id=id.slice(1)),vjs.players[id])return vjs.players[id];tag=vjs.el(id)}else tag=id;if(!tag||!tag.nodeName)throw new TypeError("The element or ID supplied is not valid. (videojs)");return tag.player||new vjs.Player(tag,options,ready)},videojs=window.videojs=vjs;vjs.CDN_VERSION="4.11",vjs.ACCESS_PROTOCOL="https:"==document.location.protocol?"https://":"http://",vjs.options={techOrder:["html5","flash"],html5:{},flash:{},width:300,height:150,defaultVolume:0,playbackRates:[],inactivityTimeout:2e3,children:{mediaLoader:{},posterImage:{},textTrackDisplay:{},loadingSpinner:{},bigPlayButton:{},controlBar:{},errorDisplay:{}},language:document.getElementsByTagName("html")[0].getAttribute("lang")||navigator.languages&&navigator.languages[0]||navigator.userLanguage||navigator.language||"en",languages:{},notSupportedMessage:"No compatible source was found for this video."},"GENERATED_CDN_VSN"!==vjs.CDN_VERSION&&(videojs.options.flash.swf=vjs.ACCESS_PROTOCOL+"vjs.zencdn.net/"+vjs.CDN_VERSION+"/video-js.swf"),vjs.addLanguage=function(code,data){return void 0!==vjs.options.languages[code]?vjs.options.languages[code]=vjs.util.mergeOptions(vjs.options.languages[code],data):vjs.options.languages[code]=data,vjs.options.languages},vjs.players={},"function"==typeof define&&define.amd?define([],function(){return videojs}):"object"==typeof exports&&"object"==typeof module&&(module.exports=videojs),vjs.CoreObject=vjs.CoreObject=function(){},vjs.CoreObject.extend=function(props){var init,subObj;props=props||{},init=props.init||props.init||this.prototype.init||this.prototype.init||function(){},subObj=function(){init.apply(this,arguments)},subObj.prototype=vjs.obj.create(this.prototype),subObj.prototype.constructor=subObj,subObj.extend=vjs.CoreObject.extend,subObj.create=vjs.CoreObject.create;for(var name in props)props.hasOwnProperty(name)&&(subObj.prototype[name]=props[name]);return subObj},vjs.CoreObject.create=function(){var inst=vjs.obj.create(this.prototype);return this.apply(inst,arguments),inst},vjs.on=function(elem,type,fn){if(vjs.obj.isArray(type))return _handleMultipleEvents(vjs.on,elem,type,fn);var data=vjs.getData(elem);data.handlers||(data.handlers={}),data.handlers[type]||(data.handlers[type]=[]),fn.guid||(fn.guid=vjs.guid++),data.handlers[type].push(fn),data.dispatcher||(data.disabled=!1,data.dispatcher=function(event){if(!data.disabled){event=vjs.fixEvent(event);var handlers=data.handlers[event.type];if(handlers)for(var handlersCopy=handlers.slice(0),m=0,n=handlersCopy.length;m<n&&!event.isImmediatePropagationStopped();m++)handlersCopy[m].call(elem,event)}}),1==data.handlers[type].length&&(elem.addEventListener?elem.addEventListener(type,data.dispatcher,!1):elem.attachEvent&&elem.attachEvent("on"+type,data.dispatcher))},vjs.off=function(elem,type,fn){if(vjs.hasData(elem)){var data=vjs.getData(elem);if(data.handlers){if(vjs.obj.isArray(type))return _handleMultipleEvents(vjs.off,elem,type,fn);var removeType=function(t){data.handlers[t]=[],vjs.cleanUpEvents(elem,t)};if(type){var handlers=data.handlers[type];if(handlers){if(!fn)return void removeType(type);if(fn.guid)for(var n=0;n<handlers.length;n++)handlers[n].guid===fn.guid&&handlers.splice(n--,1);vjs.cleanUpEvents(elem,type)}}else for(var t in data.handlers)removeType(t)}}},vjs.cleanUpEvents=function(elem,type){var data=vjs.getData(elem);0===data.handlers[type].length&&(delete data.handlers[type],elem.removeEventListener?elem.removeEventListener(type,data.dispatcher,!1):elem.detachEvent&&elem.detachEvent("on"+type,data.dispatcher)),vjs.isEmpty(data.handlers)&&(delete data.handlers,delete data.dispatcher,delete data.disabled),vjs.isEmpty(data)&&vjs.removeData(elem)},vjs.fixEvent=function(event){function returnTrue(){return!0}function returnFalse(){return!1}if(!event||!event.isPropagationStopped){var old=event||window.event;event={};for(var key in old)"layerX"!==key&&"layerY"!==key&&"keyLocation"!==key&&("returnValue"==key&&old.preventDefault||(event[key]=old[key]));if(event.target||(event.target=event.srcElement||document),event.relatedTarget=event.fromElement===event.target?event.toElement:event.fromElement,event.preventDefault=function(){old.preventDefault&&old.preventDefault(),event.returnValue=!1,event.isDefaultPrevented=returnTrue,event.defaultPrevented=!0},event.isDefaultPrevented=returnFalse,event.defaultPrevented=!1,event.stopPropagation=function(){old.stopPropagation&&old.stopPropagation(),event.cancelBubble=!0,event.isPropagationStopped=returnTrue},event.isPropagationStopped=returnFalse,event.stopImmediatePropagation=function(){old.stopImmediatePropagation&&old.stopImmediatePropagation(),event.isImmediatePropagationStopped=returnTrue,event.stopPropagation()},event.isImmediatePropagationStopped=returnFalse,null!=event.clientX){var doc=document.documentElement,body=document.body;event.pageX=event.clientX+(doc&&doc.scrollLeft||body&&body.scrollLeft||0)-(doc&&doc.clientLeft||body&&body.clientLeft||0),event.pageY=event.clientY+(doc&&doc.scrollTop||body&&body.scrollTop||0)-(doc&&doc.clientTop||body&&body.clientTop||0)}event.which=event.charCode||event.keyCode,null!=event.button&&(event.button=1&event.button?0:4&event.button?1:2&event.button?2:0)}return event},vjs.trigger=function(elem,event){var elemData=vjs.hasData(elem)?vjs.getData(elem):{},parent=elem.parentNode||elem.ownerDocument;if("string"==typeof event&&(event={type:event,target:elem}),event=vjs.fixEvent(event),elemData.dispatcher&&elemData.dispatcher.call(elem,event),parent&&!event.isPropagationStopped()&&!0===event.bubbles)vjs.trigger(parent,event);else if(!parent&&!event.defaultPrevented){var targetData=vjs.getData(event.target);event.target[event.type]&&(targetData.disabled=!0,"function"==typeof event.target[event.type]&&event.target[event.type](),targetData.disabled=!1)}return!event.defaultPrevented},vjs.one=function(elem,type,fn){if(vjs.obj.isArray(type))return _handleMultipleEvents(vjs.one,elem,type,fn);var func=function(){vjs.off(elem,type,func),fn.apply(this,arguments)};func.guid=fn.guid=fn.guid||vjs.guid++,vjs.on(elem,type,func)};function _handleMultipleEvents(fn,elem,type,callback){vjs.arr.forEach(type,function(type){fn(elem,type,callback)})}var hasOwnProp=Object.prototype.hasOwnProperty;vjs.createEl=function(tagName,properties){var el;return tagName=tagName||"div",properties=properties||{},el=document.createElement(tagName),vjs.obj.each(properties,function(propName,val){-1!==propName.indexOf("aria-")||"role"==propName?el.setAttribute(propName,val):el[propName]=val}),el},vjs.capitalize=function(string){return string.charAt(0).toUpperCase()+string.slice(1)},vjs.obj={},vjs.obj.create=Object.create||function(obj){function F(){}return F.prototype=obj,new F},vjs.obj.each=function(obj,fn,context){for(var key in obj)hasOwnProp.call(obj,key)&&fn.call(context||this,key,obj[key])},vjs.obj.merge=function(obj1,obj2){if(!obj2)return obj1;for(var key in obj2)hasOwnProp.call(obj2,key)&&(obj1[key]=obj2[key]);return obj1},vjs.obj.deepMerge=function(obj1,obj2){var key,val1,val2;obj1=vjs.obj.copy(obj1);for(key in obj2)hasOwnProp.call(obj2,key)&&(val1=obj1[key],val2=obj2[key],
vjs.obj.isPlain(val1)&&vjs.obj.isPlain(val2)?obj1[key]=vjs.obj.deepMerge(val1,val2):obj1[key]=obj2[key]);return obj1},vjs.obj.copy=function(obj){return vjs.obj.merge({},obj)},vjs.obj.isPlain=function(obj){return!!obj&&"object"==typeof obj&&"[object Object]"===obj.toString()&&obj.constructor===Object},vjs.obj.isArray=Array.isArray||function(arr){return"[object Array]"===Object.prototype.toString.call(arr)},vjs.isNaN=function(num){return num!==num},vjs.bind=function(context,fn,uid){fn.guid||(fn.guid=vjs.guid++);var ret=function(){return fn.apply(context,arguments)};return ret.guid=uid?uid+"_"+fn.guid:fn.guid,ret},vjs.cache={},vjs.guid=1,vjs.expando="vdata"+(new Date).getTime(),vjs.getData=function(el){var id=el[vjs.expando];return id||(id=el[vjs.expando]=vjs.guid++,vjs.cache[id]={}),vjs.cache[id]},vjs.hasData=function(el){var id=el[vjs.expando];return!(!id||vjs.isEmpty(vjs.cache[id]))},vjs.removeData=function(el){var id=el[vjs.expando];if(id){delete vjs.cache[id];try{delete el[vjs.expando]}catch(e){el.removeAttribute?el.removeAttribute(vjs.expando):el[vjs.expando]=null}}},vjs.isEmpty=function(obj){for(var prop in obj)if(null!==obj[prop])return!1;return!0},vjs.hasClass=function(element,classToCheck){return-1!==(" "+element.className+" ").indexOf(" "+classToCheck+" ")},vjs.addClass=function(element,classToAdd){vjs.hasClass(element,classToAdd)||(element.className=""===element.className?classToAdd:element.className+" "+classToAdd)},vjs.removeClass=function(element,classToRemove){var classNames,i;if(vjs.hasClass(element,classToRemove)){for(classNames=element.className.split(" "),i=classNames.length-1;i>=0;i--)classNames[i]===classToRemove&&classNames.splice(i,1);element.className=classNames.join(" ")}},vjs.TEST_VID=vjs.createEl("video"),vjs.USER_AGENT=navigator.userAgent,vjs.IS_IPHONE=/iPhone/i.test(vjs.USER_AGENT),vjs.IS_IPAD=/iPad/i.test(vjs.USER_AGENT),vjs.IS_IPOD=/iPod/i.test(vjs.USER_AGENT),vjs.IS_IOS=vjs.IS_IPHONE||vjs.IS_IPAD||vjs.IS_IPOD,vjs.IOS_VERSION=function(){var match=vjs.USER_AGENT.match(/OS (\d+)_/i);if(match&&match[1])return match[1]}(),vjs.IS_ANDROID=/Android/i.test(vjs.USER_AGENT),vjs.ANDROID_VERSION=function(){var major,minor,match=vjs.USER_AGENT.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);return match?(major=match[1]&&parseFloat(match[1]),minor=match[2]&&parseFloat(match[2]),major&&minor?parseFloat(match[1]+"."+match[2]):major||null):null}(),vjs.IS_OLD_ANDROID=vjs.IS_ANDROID&&/webkit/i.test(vjs.USER_AGENT)&&vjs.ANDROID_VERSION<2.3,vjs.IS_FIREFOX=/Firefox/i.test(vjs.USER_AGENT),vjs.IS_CHROME=/Chrome/i.test(vjs.USER_AGENT),vjs.TOUCH_ENABLED=!!("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch),vjs.BACKGROUND_SIZE_SUPPORTED="backgroundSize"in vjs.TEST_VID.style,vjs.setElementAttributes=function(el,attributes){vjs.obj.each(attributes,function(attrName,attrValue){null===attrValue||void 0===attrValue||!1===attrValue?el.removeAttribute(attrName):el.setAttribute(attrName,!0===attrValue?"":attrValue)})},vjs.getElementAttributes=function(tag){var obj,knownBooleans,attrs,attrName,attrVal;if(obj={},knownBooleans=",autoplay,controls,loop,muted,default,",tag&&tag.attributes&&tag.attributes.length>0){attrs=tag.attributes;for(var i=attrs.length-1;i>=0;i--)attrName=attrs[i].name,attrVal=attrs[i].value,"boolean"!=typeof tag[attrName]&&-1===knownBooleans.indexOf(","+attrName+",")||(attrVal=null!==attrVal),obj[attrName]=attrVal}return obj},vjs.getComputedDimension=function(el,strCssRule){var strValue="";return document.defaultView&&document.defaultView.getComputedStyle?strValue=document.defaultView.getComputedStyle(el,"").getPropertyValue(strCssRule):el.currentStyle&&(strValue=el["client"+strCssRule.substr(0,1).toUpperCase()+strCssRule.substr(1)]+"px"),strValue},vjs.insertFirst=function(child,parent){parent.firstChild?parent.insertBefore(child,parent.firstChild):parent.appendChild(child)},vjs.browser={},vjs.el=function(id){return 0===id.indexOf("#")&&(id=id.slice(1)),document.getElementById(id)},vjs.formatTime=function(seconds,guide){guide=guide||seconds;var s=Math.floor(seconds%60),m=Math.floor(seconds/60%60),h=Math.floor(seconds/3600),gm=Math.floor(guide/60%60),gh=Math.floor(guide/3600);return(isNaN(seconds)||seconds===1/0)&&(h=m=s="-"),h=h>0||gh>0?h+":":"",m=((h||gm>=10)&&m<10?"0"+m:m)+":",s=s<10?"0"+s:s,h+m+s},vjs.blockTextSelection=function(){document.body.focus(),document.onselectstart=function(){return!1}},vjs.unblockTextSelection=function(){document.onselectstart=function(){return!0}},vjs.trim=function(str){return(str+"").replace(/^\s+|\s+$/g,"")},vjs.round=function(num,dec){return dec||(dec=0),Math.round(num*Math.pow(10,dec))/Math.pow(10,dec)},vjs.createTimeRange=function(start,end){return{length:1,start:function(){return start},end:function(){return end}}},vjs.setLocalStorage=function(key,value){try{var localStorage=window.localStorage||!1;if(!localStorage)return;localStorage[key]=value}catch(e){22==e.code||1014==e.code?vjs.log("LocalStorage Full (VideoJS)",e):18==e.code?vjs.log("LocalStorage not allowed (VideoJS)",e):vjs.log("LocalStorage Error (VideoJS)",e)}},vjs.getAbsoluteURL=function(url){return url.match(/^https?:\/\//)||(url=vjs.createEl("div",{innerHTML:'<a href="'+url+'">x</a>'}).firstChild.href),url},vjs.parseUrl=function(url){var div,a,addToBody,props,details;props=["protocol","hostname","port","pathname","search","hash","host"],a=vjs.createEl("a",{href:url}),addToBody=""===a.host&&"file:"!==a.protocol,addToBody&&(div=vjs.createEl("div"),div.innerHTML='<a href="'+url+'"></a>',a=div.firstChild,div.setAttribute("style","display:none; position:absolute;"),document.body.appendChild(div)),details={};for(var i=0;i<props.length;i++)details[props[i]]=a[props[i]];return addToBody&&document.body.removeChild(div),details};function _logType(type,args){var argsArray,noop,console;argsArray=Array.prototype.slice.call(args),noop=function(){},console=window.console||{log:noop,warn:noop,error:noop},type?argsArray.unshift(type.toUpperCase()+":"):type="log",vjs.log.history.push(argsArray),argsArray.unshift("VIDEOJS:"),console[type].apply?console[type].apply(console,argsArray):console[type](argsArray.join(" "))}vjs.log=function(){_logType(null,arguments)},vjs.log.history=[],vjs.log.error=function(){_logType("error",arguments)},vjs.log.warn=function(){_logType("warn",arguments)},vjs.findPosition=function(el){var box,docEl,body,clientLeft,scrollLeft,left,clientTop,scrollTop,top;return el.getBoundingClientRect&&el.parentNode&&(box=el.getBoundingClientRect()),box?(docEl=document.documentElement,body=document.body,clientLeft=docEl.clientLeft||body.clientLeft||0,scrollLeft=window.pageXOffset||body.scrollLeft,left=box.left+scrollLeft-clientLeft,clientTop=docEl.clientTop||body.clientTop||0,scrollTop=window.pageYOffset||body.scrollTop,top=box.top+scrollTop-clientTop,{left:vjs.round(left),top:vjs.round(top)}):{left:0,top:0}},vjs.arr={},vjs.arr.forEach=function(array,callback,thisArg){if(vjs.obj.isArray(array)&&callback instanceof Function)for(var i=0,len=array.length;i<len;++i)callback.call(thisArg||vjs,array[i],i,array);return array},vjs.xhr=function(options,callback){var XHR,request,urlInfo,winLoc,fileUrl,crossOrigin,abortTimeout,successHandler,errorHandler;"string"==typeof options&&(options={uri:options}),videojs.util.mergeOptions({method:"GET",timeout:45e3},options),callback=callback||function(){},successHandler=function(){window.clearTimeout(abortTimeout),callback(null,request,request.response||request.responseText)},errorHandler=function(err){window.clearTimeout(abortTimeout),err&&"string"!=typeof err||(err=new Error(err)),callback(err,request)},XHR=window.XMLHttpRequest,void 0===XHR&&(XHR=function(){try{return new window.ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e){}try{return new window.ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(f){}try{return new window.ActiveXObject("Msxml2.XMLHTTP")}catch(g){}throw new Error("This browser does not support XMLHttpRequest.")}),request=new XHR,request.uri=options.uri,urlInfo=vjs.parseUrl(options.uri),winLoc=window.location,crossOrigin=urlInfo.protocol+urlInfo.host!==winLoc.protocol+winLoc.host,!crossOrigin||!window.XDomainRequest||"withCredentials"in request?(fileUrl="file:"==urlInfo.protocol||"file:"==winLoc.protocol,request.onreadystatechange=function(){if(4===request.readyState){if(request.timedout)return errorHandler("timeout");200===request.status||fileUrl&&0===request.status?successHandler():errorHandler()}},options.timeout&&(abortTimeout=window.setTimeout(function(){4!==request.readyState&&(request.timedout=!0,request.abort())},options.timeout))):(request=new window.XDomainRequest,request.onload=successHandler,request.onerror=errorHandler,request.onprogress=function(){},request.ontimeout=function(){});try{request.open(options.method||"GET",options.uri,!0)}catch(err){return errorHandler(err)}options.withCredentials&&(request.withCredentials=!0),options.responseType&&(request.responseType=options.responseType);try{request.send()}catch(err){return errorHandler(err)}return request},vjs.util={},vjs.util.mergeOptions=function(obj1,obj2){var key,val1,val2;obj1=vjs.obj.copy(obj1);for(key in obj2)obj2.hasOwnProperty(key)&&(val1=obj1[key],val2=obj2[key],vjs.obj.isPlain(val1)&&vjs.obj.isPlain(val2)?obj1[key]=vjs.util.mergeOptions(val1,val2):obj1[key]=obj2[key]);return obj1},vjs.Component=vjs.CoreObject.extend({init:function(player,options,ready){this.player_=player,this.options_=vjs.obj.copy(this.options_),options=this.options(options),this.id_=options.id||options.el&&options.el.id,this.id_||(this.id_=(player.id&&player.id()||"no_player")+"_component_"+vjs.guid++),this.name_=options.name||null,this.el_=options.el||this.createEl(),this.children_=[],this.childIndex_={},this.childNameIndex_={},this.initChildren(),this.ready(ready),!1!==options.reportTouchActivity&&this.enableTouchActivity()}}),vjs.Component.prototype.dispose=function(){if(this.trigger({type:"dispose",bubbles:!1}),this.children_)for(var i=this.children_.length-1;i>=0;i--)this.children_[i].dispose&&this.children_[i].dispose();this.children_=null,this.childIndex_=null,this.childNameIndex_=null,this.off(),this.el_.parentNode&&this.el_.parentNode.removeChild(this.el_),vjs.removeData(this.el_),this.el_=null},vjs.Component.prototype.player_=!0,vjs.Component.prototype.player=function(){return this.player_},vjs.Component.prototype.options_,vjs.Component.prototype.options=function(obj){return void 0===obj?this.options_:this.options_=vjs.util.mergeOptions(this.options_,obj)},vjs.Component.prototype.el_,vjs.Component.prototype.createEl=function(tagName,attributes){return vjs.createEl(tagName,attributes)},vjs.Component.prototype.localize=function(string){var lang=this.player_.language(),languages=this.player_.languages();return languages&&languages[lang]&&languages[lang][string]?languages[lang][string]:string},vjs.Component.prototype.el=function(){return this.el_},vjs.Component.prototype.contentEl_,vjs.Component.prototype.contentEl=function(){return this.contentEl_||this.el_},vjs.Component.prototype.id_,vjs.Component.prototype.id=function(){return this.id_},vjs.Component.prototype.name_,vjs.Component.prototype.name=function(){return this.name_},vjs.Component.prototype.children_,vjs.Component.prototype.children=function(){return this.children_},vjs.Component.prototype.childIndex_,vjs.Component.prototype.getChildById=function(id){return this.childIndex_[id]},vjs.Component.prototype.childNameIndex_,vjs.Component.prototype.getChild=function(name){return this.childNameIndex_[name]},vjs.Component.prototype.addChild=function(child,options){var component,componentClass,componentName;return"string"==typeof child?(componentName=child,options=options||{},componentClass=options.componentClass||vjs.capitalize(componentName),options.name=componentName,component=new window.videojs[componentClass](this.player_||this,options)):component=child,this.children_.push(component),"function"==typeof component.id&&(this.childIndex_[component.id()]=component),componentName=componentName||component.name&&component.name(),componentName&&(this.childNameIndex_[componentName]=component),"function"==typeof component.el&&component.el()&&this.contentEl().appendChild(component.el()),component},vjs.Component.prototype.removeChild=function(component){if("string"==typeof component&&(component=this.getChild(component)),component&&this.children_){for(var childFound=!1,i=this.children_.length-1;i>=0;i--)if(this.children_[i]===component){childFound=!0,this.children_.splice(i,1);break}if(childFound){this.childIndex_[component.id]=null,this.childNameIndex_[component.name]=null;var compEl=component.el();compEl&&compEl.parentNode===this.contentEl()&&this.contentEl().removeChild(component.el())}}},vjs.Component.prototype.initChildren=function(){var parent,parentOptions,children,child,name,opts,handleAdd;if(parent=this,parentOptions=parent.options(),children=parentOptions.children)if(handleAdd=function(name,opts){void 0!==parentOptions[name]&&(opts=parentOptions[name]),!1!==opts&&(parent[name]=parent.addChild(name,opts))},vjs.obj.isArray(children))for(var i=0;i<children.length;i++)child=children[i],"string"==typeof child?(name=child,opts={}):(name=child.name,opts=child),handleAdd(name,opts);else vjs.obj.each(children,handleAdd)},vjs.Component.prototype.buildCSSClass=function(){return""},vjs.Component.prototype.on=function(first,second,third){var target,type,fn,removeOnDispose,cleanRemover,thisComponent;return"string"==typeof first||vjs.obj.isArray(first)?vjs.on(this.el_,first,vjs.bind(this,second)):(target=first,type=second,fn=vjs.bind(this,third),thisComponent=this,removeOnDispose=function(){thisComponent.off(target,type,fn)},removeOnDispose.guid=fn.guid,this.on("dispose",removeOnDispose),cleanRemover=function(){thisComponent.off("dispose",removeOnDispose)},cleanRemover.guid=fn.guid,first.nodeName?(vjs.on(target,type,fn),vjs.on(target,"dispose",cleanRemover)):"function"==typeof first.on&&(target.on(type,fn),target.on("dispose",cleanRemover))),this},vjs.Component.prototype.off=function(first,second,third){var target,type,fn;return!first||"string"==typeof first||vjs.obj.isArray(first)?vjs.off(this.el_,first,second):(target=first,type=second,fn=vjs.bind(this,third),this.off("dispose",fn),first.nodeName?(vjs.off(target,type,fn),vjs.off(target,"dispose",fn)):(target.off(type,fn),target.off("dispose",fn))),this},vjs.Component.prototype.one=function(first,second,third){var target,type,fn,thisComponent,newFunc;return"string"==typeof first||vjs.obj.isArray(first)?vjs.one(this.el_,first,vjs.bind(this,second)):(target=first,type=second,fn=vjs.bind(this,third),thisComponent=this,newFunc=function(){thisComponent.off(target,type,newFunc),fn.apply(this,arguments)},newFunc.guid=fn.guid,this.on(target,type,newFunc)),this},vjs.Component.prototype.trigger=function(event){return vjs.trigger(this.el_,event),this},vjs.Component.prototype.isReady_,vjs.Component.prototype.isReadyOnInitFinish_=!0,vjs.Component.prototype.readyQueue_,vjs.Component.prototype.ready=function(fn){return fn&&(this.isReady_?fn.call(this):(void 0===this.readyQueue_&&(this.readyQueue_=[]),this.readyQueue_.push(fn))),this},vjs.Component.prototype.triggerReady=function(){this.isReady_=!0;var readyQueue=this.readyQueue_;if(readyQueue&&readyQueue.length>0){for(var i=0,j=readyQueue.length;i<j;i++)readyQueue[i].call(this);this.readyQueue_=[],this.trigger("ready")}},vjs.Component.prototype.hasClass=function(classToCheck){return vjs.hasClass(this.el_,classToCheck)},vjs.Component.prototype.addClass=function(classToAdd){return vjs.addClass(this.el_,classToAdd),this},vjs.Component.prototype.removeClass=function(classToRemove){return vjs.removeClass(this.el_,classToRemove),this},vjs.Component.prototype.show=function(){return this.el_.style.display="block",this},vjs.Component.prototype.hide=function(){return this.el_.style.display="none",this},vjs.Component.prototype.lockShowing=function(){return this.addClass("vjs-lock-showing"),this},vjs.Component.prototype.unlockShowing=function(){return this.removeClass("vjs-lock-showing"),this},vjs.Component.prototype.disable=function(){this.hide(),this.show=function(){}},vjs.Component.prototype.width=function(num,skipListeners){return this.dimension("width",num,skipListeners)},vjs.Component.prototype.height=function(num,skipListeners){return this.dimension("height",num,skipListeners)},vjs.Component.prototype.dimensions=function(width,height){return this.width(width,!0).height(height)},vjs.Component.prototype.dimension=function(widthOrHeight,num,skipListeners){if(void 0!==num)return(null===num||vjs.isNaN(num))&&(num=0),-1!==(""+num).indexOf("%")||-1!==(""+num).indexOf("px")?this.el_.style[widthOrHeight]=num:this.el_.style[widthOrHeight]="auto"===num?"":num+"px",skipListeners||this.trigger("resize"),this;if(!this.el_)return 0;var val=this.el_.style[widthOrHeight],pxIndex=val.indexOf("px");return-1!==pxIndex?parseInt(val.slice(0,pxIndex),10):parseInt(this.el_["offset"+vjs.capitalize(widthOrHeight)],10)},vjs.Component.prototype.onResize,vjs.Component.prototype.emitTapEvents=function(){var touchStart,firstTouch,touchTime,couldBeTap,noTap,xdiff,ydiff,touchDistance,tapMovementThreshold;touchStart=0,firstTouch=null,tapMovementThreshold=22,this.on("touchstart",function(event){1===event.touches.length&&(firstTouch=event.touches[0],touchStart=(new Date).getTime(),couldBeTap=!0)}),this.on("touchmove",function(event){event.touches.length>1?couldBeTap=!1:firstTouch&&(xdiff=event.touches[0].pageX-firstTouch.pageX,ydiff=event.touches[0].pageY-firstTouch.pageY,(touchDistance=Math.sqrt(xdiff*xdiff+ydiff*ydiff))>tapMovementThreshold&&(couldBeTap=!1))}),noTap=function(){couldBeTap=!1},this.on("touchleave",noTap),this.on("touchcancel",noTap),this.on("touchend",function(event){firstTouch=null,!0===couldBeTap&&(touchTime=(new Date).getTime()-touchStart)<250&&(event.preventDefault(),this.trigger("tap"))})},vjs.Component.prototype.enableTouchActivity=function(){var report,touchHolding,touchEnd;this.player().reportUserActivity&&(report=vjs.bind(this.player(),this.player().reportUserActivity),this.on("touchstart",function(){report(),this.clearInterval(touchHolding),touchHolding=this.setInterval(report,250)}),touchEnd=function(event){report(),this.clearInterval(touchHolding)},this.on("touchmove",report),this.on("touchend",touchEnd),this.on("touchcancel",touchEnd))},vjs.Component.prototype.setTimeout=function(fn,timeout){fn=vjs.bind(this,fn);var timeoutId=setTimeout(fn,timeout),disposeFn=function(){this.clearTimeout(timeoutId)};return disposeFn.guid="vjs-timeout-"+timeoutId,this.on("dispose",disposeFn),timeoutId},vjs.Component.prototype.clearTimeout=function(timeoutId){clearTimeout(timeoutId);var disposeFn=function(){};return disposeFn.guid="vjs-timeout-"+timeoutId,this.off("dispose",disposeFn),timeoutId},vjs.Component.prototype.setInterval=function(fn,interval){fn=vjs.bind(this,fn);var intervalId=setInterval(fn,interval),disposeFn=function(){this.clearInterval(intervalId)};return disposeFn.guid="vjs-interval-"+intervalId,this.on("dispose",disposeFn),intervalId},vjs.Component.prototype.clearInterval=function(intervalId){clearInterval(intervalId);var disposeFn=function(){};return disposeFn.guid="vjs-interval-"+intervalId,this.off("dispose",disposeFn),intervalId},vjs.Button=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options),this.emitTapEvents(),this.on("tap",this.onClick),this.on("click",this.onClick),this.on("focus",this.onFocus),this.on("blur",this.onBlur)}}),vjs.Button.prototype.createEl=function(type,props){var el;return props=vjs.obj.merge({className:this.buildCSSClass(),role:"button","aria-live":"polite",tabIndex:0},props),el=vjs.Component.prototype.createEl.call(this,type,props),props.innerHTML||(this.contentEl_=vjs.createEl("div",{className:"vjs-control-content"}),this.controlText_=vjs.createEl("span",{className:"vjs-control-text",innerHTML:this.localize(this.buttonText)||"Need Text"}),this.contentEl_.appendChild(this.controlText_),el.appendChild(this.contentEl_)),el},vjs.Button.prototype.buildCSSClass=function(){return"vjs-control "+vjs.Component.prototype.buildCSSClass.call(this)},vjs.Button.prototype.onClick=function(){},vjs.Button.prototype.onFocus=function(){vjs.on(document,"keydown",vjs.bind(this,this.onKeyPress))},vjs.Button.prototype.onKeyPress=function(event){32!=event.which&&13!=event.which||(event.preventDefault(),this.onClick())},vjs.Button.prototype.onBlur=function(){vjs.off(document,"keydown",vjs.bind(this,this.onKeyPress))},vjs.Slider=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options),this.bar=this.getChild(this.options_.barName),this.handle=this.getChild(this.options_.handleName),this.on("mousedown",this.onMouseDown),this.on("touchstart",this.onMouseDown),this.on("focus",this.onFocus),this.on("blur",this.onBlur),this.on("click",this.onClick),this.on(player,"controlsvisible",this.update),this.on(player,this.playerEvent,this.update)}}),vjs.Slider.prototype.createEl=function(type,props){return props=props||{},props.className=props.className+" vjs-slider",props=vjs.obj.merge({role:"slider","aria-valuenow":0,"aria-valuemin":0,"aria-valuemax":100,tabIndex:0},props),vjs.Component.prototype.createEl.call(this,type,props)},vjs.Slider.prototype.onMouseDown=function(event){event.preventDefault(),vjs.blockTextSelection(),this.addClass("vjs-sliding"),this.on(document,"mousemove",this.onMouseMove),this.on(document,"mouseup",this.onMouseUp),this.on(document,"touchmove",this.onMouseMove),this.on(document,"touchend",this.onMouseUp),this.onMouseMove(event)},vjs.Slider.prototype.onMouseMove=function(){},vjs.Slider.prototype.onMouseUp=function(){vjs.unblockTextSelection(),this.removeClass("vjs-sliding"),this.off(document,"mousemove",this.onMouseMove),this.off(document,"mouseup",this.onMouseUp),this.off(document,"touchmove",this.onMouseMove),this.off(document,"touchend",this.onMouseUp),this.update()},vjs.Slider.prototype.update=function(){if(this.el_){var barProgress,progress=this.getPercent(),handle=this.handle,bar=this.bar;if(isNaN(progress)&&(progress=0),barProgress=progress,handle){var box=this.el_,boxWidth=box.offsetWidth,handleWidth=handle.el().offsetWidth,handlePercent=handleWidth?handleWidth/boxWidth:0,boxAdjustedPercent=1-handlePercent,adjustedProgress=progress*boxAdjustedPercent;barProgress=adjustedProgress+handlePercent/2,handle.el().style.left=vjs.round(100*adjustedProgress,2)+"%"}bar&&(bar.el().style.width=vjs.round(100*barProgress,2)+"%")}},vjs.Slider.prototype.calculateDistance=function(event){var el,box,boxX,boxY,boxW,boxH,handle,pageX,pageY;if(el=this.el_,box=vjs.findPosition(el),boxW=boxH=el.offsetWidth,handle=this.handle,this.options().vertical){if(boxY=box.top,pageY=event.changedTouches?event.changedTouches[0].pageY:event.pageY,handle){var handleH=handle.el().offsetHeight;boxY+=handleH/2,boxH-=handleH}return Math.max(0,Math.min(1,(boxY-pageY+boxH)/boxH))}if(boxX=box.left,pageX=event.changedTouches?event.changedTouches[0].pageX:event.pageX,handle){var handleW=handle.el().offsetWidth;boxX+=handleW/2,boxW-=handleW}return Math.max(0,Math.min(1,(pageX-boxX)/boxW))},vjs.Slider.prototype.onFocus=function(){this.on(document,"keydown",this.onKeyPress)},vjs.Slider.prototype.onKeyPress=function(event){37==event.which||40==event.which?(event.preventDefault(),this.stepBack()):38!=event.which&&39!=event.which||(event.preventDefault(),this.stepForward())},vjs.Slider.prototype.onBlur=function(){this.off(document,"keydown",this.onKeyPress)},vjs.Slider.prototype.onClick=function(event){event.stopImmediatePropagation(),event.preventDefault()},vjs.SliderHandle=vjs.Component.extend(),vjs.SliderHandle.prototype.defaultValue=0,vjs.SliderHandle.prototype.createEl=function(type,props){return props=props||{},props.className=props.className+" vjs-slider-handle",props=vjs.obj.merge({innerHTML:'<span class="vjs-control-text">'+this.defaultValue+"</span>"},props),vjs.Component.prototype.createEl.call(this,"div",props)},vjs.Menu=vjs.Component.extend(),vjs.Menu.prototype.addItem=function(component){this.addChild(component),component.on("click",vjs.bind(this,function(){this.unlockShowing()}))},vjs.Menu.prototype.createEl=function(){var contentElType=this.options().contentElType||"ul";this.contentEl_=vjs.createEl(contentElType,{className:"vjs-menu-content"});var el=vjs.Component.prototype.createEl.call(this,"div",{append:this.contentEl_,className:"vjs-menu"});return el.appendChild(this.contentEl_),vjs.on(el,"click",function(event){event.preventDefault(),event.stopImmediatePropagation()}),el},vjs.MenuItem=vjs.Button.extend({init:function(player,options){vjs.Button.call(this,player,options),this.selected(options.selected)}}),vjs.MenuItem.prototype.createEl=function(type,props){return vjs.Button.prototype.createEl.call(this,"li",vjs.obj.merge({className:"vjs-menu-item",innerHTML:this.localize(this.options_.label)},props))},vjs.MenuItem.prototype.onClick=function(){this.selected(!0)},vjs.MenuItem.prototype.selected=function(selected){selected?(this.addClass("vjs-selected"),this.el_.setAttribute("aria-selected",!0)):(this.removeClass("vjs-selected"),this.el_.setAttribute("aria-selected",!1))},vjs.MenuButton=vjs.Button.extend({init:function(player,options){vjs.Button.call(this,player,options),this.menu=this.createMenu(),this.addChild(this.menu),this.items&&0===this.items.length&&this.hide(),this.on("keydown",this.onKeyPress),this.el_.setAttribute("aria-haspopup",!0),this.el_.setAttribute("role","button")}}),vjs.MenuButton.prototype.buttonPressed_=!1,vjs.MenuButton.prototype.createMenu=function(){var menu=new vjs.Menu(this.player_);if(this.options().title&&menu.contentEl().appendChild(vjs.createEl("li",{className:"vjs-menu-title",innerHTML:vjs.capitalize(this.options().title),tabindex:-1})),this.items=this.createItems(),this.items)for(var i=0;i<this.items.length;i++)menu.addItem(this.items[i]);return menu},vjs.MenuButton.prototype.createItems=function(){},vjs.MenuButton.prototype.buildCSSClass=function(){return this.className+" vjs-menu-button "+vjs.Button.prototype.buildCSSClass.call(this)},vjs.MenuButton.prototype.onFocus=function(){},vjs.MenuButton.prototype.onBlur=function(){},vjs.MenuButton.prototype.onClick=function(){this.one("mouseout",vjs.bind(this,function(){this.menu.unlockShowing(),this.el_.blur()})),this.buttonPressed_?this.unpressButton():this.pressButton()},vjs.MenuButton.prototype.onKeyPress=function(event){event.preventDefault(),32==event.which||13==event.which?this.buttonPressed_?this.unpressButton():this.pressButton():27==event.which&&this.buttonPressed_&&this.unpressButton()},vjs.MenuButton.prototype.pressButton=function(){this.buttonPressed_=!0,this.menu.lockShowing(),this.el_.setAttribute("aria-pressed",!0),this.items&&this.items.length>0&&this.items[0].el().focus()},vjs.MenuButton.prototype.unpressButton=function(){this.buttonPressed_=!1,this.menu.unlockShowing(),this.el_.setAttribute("aria-pressed",!1)},vjs.MediaError=function(code){"number"==typeof code?this.code=code:"string"==typeof code?this.message=code:"object"==typeof code&&vjs.obj.merge(this,code),this.message||(this.message=vjs.MediaError.defaultMessages[this.code]||"")},vjs.MediaError.prototype.code=0,vjs.MediaError.prototype.message="",vjs.MediaError.prototype.status=null,vjs.MediaError.errorTypes=["MEDIA_ERR_CUSTOM","MEDIA_ERR_ABORTED","MEDIA_ERR_NETWORK","MEDIA_ERR_DECODE","MEDIA_ERR_SRC_NOT_SUPPORTED","MEDIA_ERR_ENCRYPTED"],vjs.MediaError.defaultMessages={1:"You aborted the video playback",2:"A network error caused the video download to fail part-way.",3:"The video playback was aborted due to a corruption problem or because the video used features your browser did not support.",4:"The video could not be loaded, either because the server or network failed or because the format is not supported.",5:"The video is encrypted and we do not have the keys to decrypt it."};for(var errNum=0;errNum<vjs.MediaError.errorTypes.length;errNum++)vjs.MediaError[vjs.MediaError.errorTypes[errNum]]=errNum,vjs.MediaError.prototype[vjs.MediaError.errorTypes[errNum]]=errNum;if(function(){var apiMap,specApi,browserApi,i;for(vjs.browser.fullscreenAPI,apiMap=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],specApi=apiMap[0],i=0;i<apiMap.length;i++)if(apiMap[i][1]in document){browserApi=apiMap[i];break}if(browserApi)for(vjs.browser.fullscreenAPI={},i=0;i<browserApi.length;i++)vjs.browser.fullscreenAPI[specApi[i]]=browserApi[i]}(),vjs.Player=vjs.Component.extend({init:function(tag,options,ready){this.tag=tag,tag.id=tag.id||"vjs_video_"+vjs.guid++,this.tagAttributes=tag&&vjs.getElementAttributes(tag),options=vjs.obj.merge(this.getTagSettings(tag),options),this.language_=options.language||vjs.options.language,this.languages_=options.languages||vjs.options.languages,this.cache_={},this.poster_=options.poster||"",this.controls_=!!options.controls,tag.controls=!1,options.reportTouchActivity=!1,this.isAudio("audio"===this.tag.nodeName.toLowerCase()),vjs.Component.call(this,this,options,ready),this.controls()?this.addClass("vjs-controls-enabled"):this.addClass("vjs-controls-disabled"),this.isAudio()&&this.addClass("vjs-audio"),vjs.players[this.id_]=this,options.plugins&&vjs.obj.each(options.plugins,function(key,val){this[key](val)},this),this.listenForUserActivity()}}),vjs.Player.prototype.language_,vjs.Player.prototype.language=function(languageCode){return void 0===languageCode?this.language_:(this.language_=languageCode,this)},vjs.Player.prototype.languages_,vjs.Player.prototype.languages=function(){return this.languages_},vjs.Player.prototype.options_=vjs.options,vjs.Player.prototype.dispose=function(){this.trigger("dispose"),this.off("dispose"),vjs.players[this.id_]=null,this.tag&&this.tag.player&&(this.tag.player=null),this.el_&&this.el_.player&&(this.el_.player=null),this.tech&&this.tech.dispose(),vjs.Component.prototype.dispose.call(this)},vjs.Player.prototype.getTagSettings=function(tag){var tagOptions,dataSetup,options={sources:[],tracks:[]};if(tagOptions=vjs.getElementAttributes(tag),dataSetup=tagOptions["data-setup"],null!==dataSetup&&vjs.obj.merge(tagOptions,vjs.JSON.parse(dataSetup||"{}")),vjs.obj.merge(options,tagOptions),tag.hasChildNodes()){var children,child,childName,i,j;for(children=tag.childNodes,i=0,j=children.length;i<j;i++)child=children[i],childName=child.nodeName.toLowerCase(),"source"===childName?options.sources.push(vjs.getElementAttributes(child)):"track"===childName&&options.tracks.push(vjs.getElementAttributes(child))}return options},vjs.Player.prototype.createEl=function(){var attrs,el=this.el_=vjs.Component.prototype.createEl.call(this,"div"),tag=this.tag;if(tag.removeAttribute("width"),tag.removeAttribute("height"),tag.hasChildNodes()){var nodes,nodesLength,i,node,removeNodes;for(nodes=tag.childNodes,nodesLength=nodes.length,removeNodes=[];nodesLength--;)node=nodes[nodesLength],"track"===node.nodeName.toLowerCase()&&removeNodes.push(node);for(i=0;i<removeNodes.length;i++)tag.removeChild(removeNodes[i])}return attrs=vjs.getElementAttributes(tag),vjs.obj.each(attrs,function(attr){"class"==attr?el.className=attrs[attr]:el.setAttribute(attr,attrs[attr])}),tag.id+="_html5_api",tag.className="vjs-tech",tag.player=el.player=this,this.addClass("vjs-paused"),this.width(this.options_.width,!0),this.height(this.options_.height,!0),tag.initNetworkState_=tag.networkState,
tag.parentNode&&tag.parentNode.insertBefore(el,tag),vjs.insertFirst(tag,el),this.el_=el,this.on("loadstart",this.onLoadStart),this.on("waiting",this.onWaiting),this.on(["canplay","canplaythrough","playing","ended"],this.onWaitEnd),this.on("seeking",this.onSeeking),this.on("seeked",this.onSeeked),this.on("ended",this.onEnded),this.on("play",this.onPlay),this.on("firstplay",this.onFirstPlay),this.on("pause",this.onPause),this.on("progress",this.onProgress),this.on("durationchange",this.onDurationChange),this.on("fullscreenchange",this.onFullscreenChange),el},vjs.Player.prototype.loadTech=function(techName,source){this.tech&&this.unloadTech(),"Html5"!==techName&&this.tag&&(vjs.Html5.disposeMediaElement(this.tag),this.tag=null),this.techName=techName,this.isReady_=!1;var techReady=function(){this.player_.triggerReady()},techOptions=vjs.obj.merge({source:source,parentEl:this.el_},this.options_[techName.toLowerCase()]);source&&(this.currentType_=source.type,source.src==this.cache_.src&&this.cache_.currentTime>0&&(techOptions.startTime=this.cache_.currentTime),this.cache_.src=source.src),this.tech=new window.videojs[techName](this,techOptions),this.tech.ready(techReady)},vjs.Player.prototype.unloadTech=function(){this.isReady_=!1,this.tech.dispose(),this.tech=!1},vjs.Player.prototype.onLoadStart=function(){this.error(null),this.paused()?(this.hasStarted(!1),this.one("play",function(){this.hasStarted(!0)})):this.trigger("firstplay")},vjs.Player.prototype.hasStarted_=!1,vjs.Player.prototype.hasStarted=function(hasStarted){return void 0!==hasStarted?(this.hasStarted_!==hasStarted&&(this.hasStarted_=hasStarted,hasStarted?(this.addClass("vjs-has-started"),this.trigger("firstplay")):this.removeClass("vjs-has-started")),this):this.hasStarted_},vjs.Player.prototype.onLoadedMetaData,vjs.Player.prototype.onLoadedData,vjs.Player.prototype.onLoadedAllData,vjs.Player.prototype.onPlay=function(){this.removeClass("vjs-paused"),this.addClass("vjs-playing")},vjs.Player.prototype.onWaiting=function(){this.addClass("vjs-waiting")},vjs.Player.prototype.onWaitEnd=function(){this.removeClass("vjs-waiting")},vjs.Player.prototype.onSeeking=function(){this.addClass("vjs-seeking")},vjs.Player.prototype.onSeeked=function(){this.removeClass("vjs-seeking")},vjs.Player.prototype.onFirstPlay=function(){this.options_.starttime&&this.currentTime(this.options_.starttime),this.addClass("vjs-has-started")},vjs.Player.prototype.onPause=function(){this.removeClass("vjs-playing"),this.addClass("vjs-paused")},vjs.Player.prototype.onTimeUpdate,vjs.Player.prototype.onProgress=function(){1==this.bufferedPercent()&&this.trigger("loadedalldata")},vjs.Player.prototype.onEnded=function(){this.options_.loop?(this.currentTime(0),this.play()):this.paused()||this.pause()},vjs.Player.prototype.onDurationChange=function(){var duration=this.techGet("duration");duration&&(duration<0&&(duration=1/0),this.duration(duration),duration===1/0?this.addClass("vjs-live"):this.removeClass("vjs-live"))},vjs.Player.prototype.onVolumeChange,vjs.Player.prototype.onFullscreenChange=function(){this.isFullscreen()?this.addClass("vjs-fullscreen"):this.removeClass("vjs-fullscreen")},vjs.Player.prototype.cache_,vjs.Player.prototype.getCache=function(){return this.cache_},vjs.Player.prototype.techCall=function(method,arg){if(this.tech&&!this.tech.isReady_)this.tech.ready(function(){this[method](arg)});else try{this.tech[method](arg)}catch(e){throw vjs.log(e),e}},vjs.Player.prototype.techGet=function(method){if(this.tech&&this.tech.isReady_)try{return this.tech[method]()}catch(e){throw void 0===this.tech[method]?vjs.log("Video.js: "+method+" method not defined for "+this.techName+" playback technology.",e):"TypeError"==e.name?(vjs.log("Video.js: "+method+" unavailable on "+this.techName+" playback technology element.",e),this.tech.isReady_=!1):vjs.log(e),e}},vjs.Player.prototype.play=function(){return this.techCall("play"),this},vjs.Player.prototype.pause=function(){return this.techCall("pause"),this},vjs.Player.prototype.paused=function(){return!1!==this.techGet("paused")},vjs.Player.prototype.currentTime=function(seconds){return void 0!==seconds?(this.techCall("setCurrentTime",seconds),this):this.cache_.currentTime=this.techGet("currentTime")||0},vjs.Player.prototype.duration=function(seconds){return void 0!==seconds?(this.cache_.duration=parseFloat(seconds),this):(void 0===this.cache_.duration&&this.onDurationChange(),this.cache_.duration||0)},vjs.Player.prototype.remainingTime=function(){return this.duration()-this.currentTime()},vjs.Player.prototype.buffered=function(){var buffered=this.techGet("buffered");return buffered&&buffered.length||(buffered=vjs.createTimeRange(0,0)),buffered},vjs.Player.prototype.bufferedPercent=function(){var start,end,duration=this.duration(),buffered=this.buffered(),bufferedDuration=0;if(!duration)return 0;for(var i=0;i<buffered.length;i++)start=buffered.start(i),end=buffered.end(i),end>duration&&(end=duration),bufferedDuration+=end-start;return bufferedDuration/duration},vjs.Player.prototype.bufferedEnd=function(){var buffered=this.buffered(),duration=this.duration(),end=buffered.end(buffered.length-1);return end>duration&&(end=duration),end},vjs.Player.prototype.volume=function(percentAsDecimal){var vol;return void 0!==percentAsDecimal?(vol=Math.max(0,Math.min(1,parseFloat(percentAsDecimal))),this.cache_.volume=vol,this.techCall("setVolume",vol),vjs.setLocalStorage("volume",vol),this):(vol=parseFloat(this.techGet("volume")),isNaN(vol)?1:vol)},vjs.Player.prototype.muted=function(muted){return void 0!==muted?(this.techCall("setMuted",muted),this):this.techGet("muted")||!1},vjs.Player.prototype.supportsFullScreen=function(){return this.techGet("supportsFullScreen")||!1},vjs.Player.prototype.isFullscreen_=!1,vjs.Player.prototype.isFullscreen=function(isFS){return void 0!==isFS?(this.isFullscreen_=!!isFS,this):this.isFullscreen_},vjs.Player.prototype.isFullScreen=function(isFS){return vjs.log.warn('player.isFullScreen() has been deprecated, use player.isFullscreen() with a lowercase "s")'),this.isFullscreen(isFS)},vjs.Player.prototype.requestFullscreen=function(){var fsApi=vjs.browser.fullscreenAPI;return this.isFullscreen(!0),fsApi?(vjs.on(document,fsApi.fullscreenchange,vjs.bind(this,function(e){this.isFullscreen(document[fsApi.fullscreenElement]),!1===this.isFullscreen()&&vjs.off(document,fsApi.fullscreenchange,arguments.callee),this.trigger("fullscreenchange")})),this.el_[fsApi.requestFullscreen]()):this.tech.supportsFullScreen()?this.techCall("enterFullScreen"):(this.enterFullWindow(),this.trigger("fullscreenchange")),this},vjs.Player.prototype.requestFullScreen=function(){return vjs.log.warn('player.requestFullScreen() has been deprecated, use player.requestFullscreen() with a lowercase "s")'),this.requestFullscreen()},vjs.Player.prototype.exitFullscreen=function(){var fsApi=vjs.browser.fullscreenAPI;return this.isFullscreen(!1),fsApi?document[fsApi.exitFullscreen]():this.tech.supportsFullScreen()?this.techCall("exitFullScreen"):(this.exitFullWindow(),this.trigger("fullscreenchange")),this},vjs.Player.prototype.cancelFullScreen=function(){return vjs.log.warn("player.cancelFullScreen() has been deprecated, use player.exitFullscreen()"),this.exitFullscreen()},vjs.Player.prototype.enterFullWindow=function(){this.isFullWindow=!0,this.docOrigOverflow=document.documentElement.style.overflow,vjs.on(document,"keydown",vjs.bind(this,this.fullWindowOnEscKey)),document.documentElement.style.overflow="hidden",vjs.addClass(document.body,"vjs-full-window"),this.trigger("enterFullWindow")},vjs.Player.prototype.fullWindowOnEscKey=function(event){27===event.keyCode&&(!0===this.isFullscreen()?this.exitFullscreen():this.exitFullWindow())},vjs.Player.prototype.exitFullWindow=function(){this.isFullWindow=!1,vjs.off(document,"keydown",this.fullWindowOnEscKey),document.documentElement.style.overflow=this.docOrigOverflow,vjs.removeClass(document.body,"vjs-full-window"),this.trigger("exitFullWindow")},vjs.Player.prototype.selectSource=function(sources){for(var i=0,j=this.options_.techOrder;i<j.length;i++){var techName=vjs.capitalize(j[i]),tech=window.videojs[techName];if(tech){if(tech.isSupported())for(var a=0,b=sources;a<b.length;a++){var source=b[a];if(tech.canPlaySource(source))return{source:source,tech:techName}}}else vjs.log.error('The "'+techName+'" tech is undefined. Skipped browser support check for that tech.')}return!1},vjs.Player.prototype.src=function(source){return void 0===source?this.techGet("src"):(vjs.obj.isArray(source)?this.sourceList_(source):"string"==typeof source?this.src({src:source}):source instanceof Object&&(source.type&&!window.videojs[this.techName].canPlaySource(source)?this.sourceList_([source]):(this.cache_.src=source.src,this.currentType_=source.type||"",this.ready(function(){this.tech.setSource?this.techCall("setSource",source):this.techCall("src",source.src),"auto"==this.options_.preload&&this.load(),this.options_.autoplay&&this.play()}))),this)},vjs.Player.prototype.sourceList_=function(sources){var sourceTech=this.selectSource(sources);sourceTech?sourceTech.tech===this.techName?this.src(sourceTech.source):this.loadTech(sourceTech.tech,sourceTech.source):(this.setTimeout(function(){this.error({code:4,message:this.localize(this.options().notSupportedMessage)})},0),this.triggerReady())},vjs.Player.prototype.load=function(){return this.techCall("load"),this},vjs.Player.prototype.currentSrc=function(){return this.techGet("currentSrc")||this.cache_.src||""},vjs.Player.prototype.currentType=function(){return this.currentType_||""},vjs.Player.prototype.preload=function(value){return void 0!==value?(this.techCall("setPreload",value),this.options_.preload=value,this):this.techGet("preload")},vjs.Player.prototype.autoplay=function(value){return void 0!==value?(this.techCall("setAutoplay",value),this.options_.autoplay=value,this):this.techGet("autoplay",value)},vjs.Player.prototype.loop=function(value){return void 0!==value?(this.techCall("setLoop",value),this.options_.loop=value,this):this.techGet("loop")},vjs.Player.prototype.poster_,vjs.Player.prototype.poster=function(src){return void 0===src?this.poster_:(src||(src=""),this.poster_=src,this.techCall("setPoster",src),this.trigger("posterchange"),this)},vjs.Player.prototype.controls_,vjs.Player.prototype.controls=function(bool){return void 0!==bool?(bool=!!bool,this.controls_!==bool&&(this.controls_=bool,bool?(this.removeClass("vjs-controls-disabled"),this.addClass("vjs-controls-enabled"),this.trigger("controlsenabled")):(this.removeClass("vjs-controls-enabled"),this.addClass("vjs-controls-disabled"),this.trigger("controlsdisabled"))),this):this.controls_},vjs.Player.prototype.usingNativeControls_,vjs.Player.prototype.usingNativeControls=function(bool){return void 0!==bool?(bool=!!bool,this.usingNativeControls_!==bool&&(this.usingNativeControls_=bool,bool?(this.addClass("vjs-using-native-controls"),this.trigger("usingnativecontrols")):(this.removeClass("vjs-using-native-controls"),this.trigger("usingcustomcontrols"))),this):this.usingNativeControls_},vjs.Player.prototype.error_=null,vjs.Player.prototype.error=function(err){return void 0===err?this.error_:null===err?(this.error_=err,this.removeClass("vjs-error"),this):(err instanceof vjs.MediaError?this.error_=err:this.error_=new vjs.MediaError(err),this.trigger("error"),this.addClass("vjs-error"),vjs.log.error("(CODE:"+this.error_.code+" "+vjs.MediaError.errorTypes[this.error_.code]+")",this.error_.message,this.error_),this)},vjs.Player.prototype.ended=function(){return this.techGet("ended")},vjs.Player.prototype.seeking=function(){return this.techGet("seeking")},vjs.Player.prototype.userActivity_=!0,vjs.Player.prototype.reportUserActivity=function(event){this.userActivity_=!0},vjs.Player.prototype.userActive_=!0,vjs.Player.prototype.userActive=function(bool){return void 0!==bool?(bool=!!bool,bool!==this.userActive_&&(this.userActive_=bool,bool?(this.userActivity_=!0,this.removeClass("vjs-user-inactive"),this.addClass("vjs-user-active"),this.trigger("useractive")):(this.userActivity_=!1,this.tech&&this.tech.one("mousemove",function(e){e.stopPropagation(),e.preventDefault()}),this.removeClass("vjs-user-active"),this.addClass("vjs-user-inactive"),this.trigger("userinactive"))),this):this.userActive_},vjs.Player.prototype.listenForUserActivity=function(){var onActivity,onMouseMove,onMouseDown,mouseInProgress,onMouseUp,inactivityTimeout,lastMoveX,lastMoveY;onActivity=vjs.bind(this,this.reportUserActivity),onMouseMove=function(e){e.screenX==lastMoveX&&e.screenY==lastMoveY||(lastMoveX=e.screenX,lastMoveY=e.screenY,onActivity())},onMouseDown=function(){onActivity(),this.clearInterval(mouseInProgress),mouseInProgress=this.setInterval(onActivity,250)},onMouseUp=function(event){onActivity(),this.clearInterval(mouseInProgress)},this.on("mousedown",onMouseDown),this.on("mousemove",onMouseMove),this.on("mouseup",onMouseUp),this.on("keydown",onActivity),this.on("keyup",onActivity),this.setInterval(function(){if(this.userActivity_){this.userActivity_=!1,this.userActive(!0),this.clearTimeout(inactivityTimeout);var timeout=this.options().inactivityTimeout;timeout>0&&(inactivityTimeout=this.setTimeout(function(){this.userActivity_||this.userActive(!1)},timeout))}},250)},vjs.Player.prototype.playbackRate=function(rate){return void 0!==rate?(this.techCall("setPlaybackRate",rate),this):this.tech&&this.tech.featuresPlaybackRate?this.techGet("playbackRate"):1},vjs.Player.prototype.isAudio_=!1,vjs.Player.prototype.isAudio=function(bool){return void 0!==bool?(this.isAudio_=!!bool,this):this.isAudio_},vjs.ControlBar=vjs.Component.extend(),vjs.ControlBar.prototype.options_={loadEvent:"play",children:{playToggle:{},currentTimeDisplay:{},timeDivider:{},durationDisplay:{},remainingTimeDisplay:{},liveDisplay:{},progressControl:{},fullscreenToggle:{},volumeControl:{},muteToggle:{},playbackRateMenuButton:{}}},vjs.ControlBar.prototype.createEl=function(){return vjs.createEl("div",{className:"vjs-control-bar"})},vjs.LiveDisplay=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options)}}),vjs.LiveDisplay.prototype.createEl=function(){var el=vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-live-controls vjs-control"});return this.contentEl_=vjs.createEl("div",{className:"vjs-live-display",innerHTML:'<span class="vjs-control-text">'+this.localize("Stream Type")+"</span>"+this.localize("LIVE"),"aria-live":"off"}),el.appendChild(this.contentEl_),el},vjs.PlayToggle=vjs.Button.extend({init:function(player,options){vjs.Button.call(this,player,options),this.on(player,"play",this.onPlay),this.on(player,"pause",this.onPause)}}),vjs.PlayToggle.prototype.buttonText="Play",vjs.PlayToggle.prototype.buildCSSClass=function(){return"vjs-play-control "+vjs.Button.prototype.buildCSSClass.call(this)},vjs.PlayToggle.prototype.onClick=function(){this.player_.paused()?this.player_.play():this.player_.pause()},vjs.PlayToggle.prototype.onPlay=function(){this.removeClass("vjs-paused"),this.addClass("vjs-playing"),this.el_.children[0].children[0].innerHTML=this.localize("Pause")},vjs.PlayToggle.prototype.onPause=function(){this.removeClass("vjs-playing"),this.addClass("vjs-paused"),this.el_.children[0].children[0].innerHTML=this.localize("Play")},vjs.CurrentTimeDisplay=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options),this.on(player,"timeupdate",this.updateContent)}}),vjs.CurrentTimeDisplay.prototype.createEl=function(){var el=vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-current-time vjs-time-controls vjs-control"});return this.contentEl_=vjs.createEl("div",{className:"vjs-current-time-display",innerHTML:'<span class="vjs-control-text">Current Time </span>0:00',"aria-live":"off"}),el.appendChild(this.contentEl_),el},vjs.CurrentTimeDisplay.prototype.updateContent=function(){var time=this.player_.scrubbing?this.player_.getCache().currentTime:this.player_.currentTime();this.contentEl_.innerHTML='<span class="vjs-control-text">'+this.localize("Current Time")+"</span> "+vjs.formatTime(time,this.player_.duration())},vjs.DurationDisplay=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options),this.on(player,"timeupdate",this.updateContent)}}),vjs.DurationDisplay.prototype.createEl=function(){var el=vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-duration vjs-time-controls vjs-control"});return this.contentEl_=vjs.createEl("div",{className:"vjs-duration-display",innerHTML:'<span class="vjs-control-text">'+this.localize("Duration Time")+"</span> 0:00","aria-live":"off"}),el.appendChild(this.contentEl_),el},vjs.DurationDisplay.prototype.updateContent=function(){var duration=this.player_.duration();duration&&(this.contentEl_.innerHTML='<span class="vjs-control-text">'+this.localize("Duration Time")+"</span> "+vjs.formatTime(duration))},vjs.TimeDivider=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options)}}),vjs.TimeDivider.prototype.createEl=function(){return vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-time-divider",innerHTML:"<div><span>/</span></div>"})},vjs.RemainingTimeDisplay=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options),this.on(player,"timeupdate",this.updateContent)}}),vjs.RemainingTimeDisplay.prototype.createEl=function(){var el=vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-remaining-time vjs-time-controls vjs-control"});return this.contentEl_=vjs.createEl("div",{className:"vjs-remaining-time-display",innerHTML:'<span class="vjs-control-text">'+this.localize("Remaining Time")+"</span> -0:00","aria-live":"off"}),el.appendChild(this.contentEl_),el},vjs.RemainingTimeDisplay.prototype.updateContent=function(){this.player_.duration()&&(this.contentEl_.innerHTML='<span class="vjs-control-text">'+this.localize("Remaining Time")+"</span> -"+vjs.formatTime(this.player_.remainingTime()))},vjs.FullscreenToggle=vjs.Button.extend({init:function(player,options){vjs.Button.call(this,player,options)}}),vjs.FullscreenToggle.prototype.buttonText="Fullscreen",vjs.FullscreenToggle.prototype.buildCSSClass=function(){return"vjs-fullscreen-control "+vjs.Button.prototype.buildCSSClass.call(this)},vjs.FullscreenToggle.prototype.onClick=function(){this.player_.isFullscreen()?(this.player_.exitFullscreen(),this.controlText_.innerHTML=this.localize("Fullscreen")):(this.player_.requestFullscreen(),this.controlText_.innerHTML=this.localize("Non-Fullscreen"))},vjs.ProgressControl=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options)}}),vjs.ProgressControl.prototype.options_={children:{seekBar:{}}},vjs.ProgressControl.prototype.createEl=function(){return vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-progress-control vjs-control"})},vjs.SeekBar=vjs.Slider.extend({init:function(player,options){vjs.Slider.call(this,player,options),this.on(player,"timeupdate",this.updateARIAAttributes),player.ready(vjs.bind(this,this.updateARIAAttributes))}}),vjs.SeekBar.prototype.options_={children:{loadProgressBar:{},playProgressBar:{},seekHandle:{}},barName:"playProgressBar",handleName:"seekHandle"},vjs.SeekBar.prototype.playerEvent="timeupdate",vjs.SeekBar.prototype.createEl=function(){return vjs.Slider.prototype.createEl.call(this,"div",{className:"vjs-progress-holder","aria-label":"video progress bar"})},vjs.SeekBar.prototype.updateARIAAttributes=function(){var time=this.player_.scrubbing?this.player_.getCache().currentTime:this.player_.currentTime();this.el_.setAttribute("aria-valuenow",vjs.round(100*this.getPercent(),2)),this.el_.setAttribute("aria-valuetext",vjs.formatTime(time,this.player_.duration()))},vjs.SeekBar.prototype.getPercent=function(){return this.player_.currentTime()/this.player_.duration()},vjs.SeekBar.prototype.onMouseDown=function(event){vjs.Slider.prototype.onMouseDown.call(this,event),this.player_.scrubbing=!0,this.videoWasPlaying=!this.player_.paused(),this.player_.pause()},vjs.SeekBar.prototype.onMouseMove=function(event){var newTime=this.calculateDistance(event)*this.player_.duration();newTime==this.player_.duration()&&(newTime-=.1),this.player_.currentTime(newTime)},vjs.SeekBar.prototype.onMouseUp=function(event){vjs.Slider.prototype.onMouseUp.call(this,event),this.player_.scrubbing=!1,this.videoWasPlaying&&this.player_.play()},vjs.SeekBar.prototype.stepForward=function(){this.player_.currentTime(this.player_.currentTime()+5)},vjs.SeekBar.prototype.stepBack=function(){this.player_.currentTime(this.player_.currentTime()-5)},vjs.LoadProgressBar=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options),this.on(player,"progress",this.update)}}),vjs.LoadProgressBar.prototype.createEl=function(){return vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-load-progress",innerHTML:'<span class="vjs-control-text"><span>'+this.localize("Loaded")+"</span>: 0%</span>"})},vjs.LoadProgressBar.prototype.update=function(){var i,start,end,part,buffered=this.player_.buffered(),duration=this.player_.duration(),bufferedEnd=this.player_.bufferedEnd(),children=this.el_.children,percentify=function(time,end){return 100*(time/end||0)+"%"};for(this.el_.style.width=percentify(bufferedEnd,duration),i=0;i<buffered.length;i++)start=buffered.start(i),end=buffered.end(i),part=children[i],part||(part=this.el_.appendChild(vjs.createEl())),part.style.left=percentify(start,bufferedEnd),part.style.width=percentify(end-start,bufferedEnd);for(i=children.length;i>buffered.length;i--)this.el_.removeChild(children[i-1])},vjs.PlayProgressBar=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options)}}),vjs.PlayProgressBar.prototype.createEl=function(){return vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-play-progress",innerHTML:'<span class="vjs-control-text"><span>'+this.localize("Progress")+"</span>: 0%</span>"})},vjs.SeekHandle=vjs.SliderHandle.extend({init:function(player,options){vjs.SliderHandle.call(this,player,options),this.on(player,"timeupdate",this.updateContent)}}),vjs.SeekHandle.prototype.defaultValue="00:00",vjs.SeekHandle.prototype.createEl=function(){return vjs.SliderHandle.prototype.createEl.call(this,"div",{className:"vjs-seek-handle","aria-live":"off"})},vjs.SeekHandle.prototype.updateContent=function(){var time=this.player_.scrubbing?this.player_.getCache().currentTime:this.player_.currentTime();this.el_.innerHTML='<span class="vjs-control-text">'+vjs.formatTime(time,this.player_.duration())+"</span>"},vjs.VolumeControl=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options),player.tech&&!1===player.tech.featuresVolumeControl&&this.addClass("vjs-hidden"),this.on(player,"loadstart",function(){!1===player.tech.featuresVolumeControl?this.addClass("vjs-hidden"):this.removeClass("vjs-hidden")})}}),vjs.VolumeControl.prototype.options_={children:{volumeBar:{}}},vjs.VolumeControl.prototype.createEl=function(){return vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-volume-control vjs-control"})},vjs.VolumeBar=vjs.Slider.extend({init:function(player,options){vjs.Slider.call(this,player,options),this.on(player,"volumechange",this.updateARIAAttributes),player.ready(vjs.bind(this,this.updateARIAAttributes))}}),vjs.VolumeBar.prototype.updateARIAAttributes=function(){this.el_.setAttribute("aria-valuenow",vjs.round(100*this.player_.volume(),2)),this.el_.setAttribute("aria-valuetext",vjs.round(100*this.player_.volume(),2)+"%")},vjs.VolumeBar.prototype.options_={children:{volumeLevel:{},volumeHandle:{}},barName:"volumeLevel",handleName:"volumeHandle"},vjs.VolumeBar.prototype.playerEvent="volumechange",vjs.VolumeBar.prototype.createEl=function(){return vjs.Slider.prototype.createEl.call(this,"div",{className:"vjs-volume-bar","aria-label":"volume level"})},vjs.VolumeBar.prototype.onMouseMove=function(event){this.player_.muted()&&this.player_.muted(!1),this.player_.volume(this.calculateDistance(event))},vjs.VolumeBar.prototype.getPercent=function(){return this.player_.muted()?0:this.player_.volume()},vjs.VolumeBar.prototype.stepForward=function(){this.player_.volume(this.player_.volume()+.1)},vjs.VolumeBar.prototype.stepBack=function(){this.player_.volume(this.player_.volume()-.1)},vjs.VolumeLevel=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options)}}),vjs.VolumeLevel.prototype.createEl=function(){return vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-volume-level",innerHTML:'<span class="vjs-control-text"></span>'})},vjs.VolumeHandle=vjs.SliderHandle.extend(),vjs.VolumeHandle.prototype.defaultValue="00:00",vjs.VolumeHandle.prototype.createEl=function(){return vjs.SliderHandle.prototype.createEl.call(this,"div",{className:"vjs-volume-handle"})},vjs.MuteToggle=vjs.Button.extend({init:function(player,options){vjs.Button.call(this,player,options),this.on(player,"volumechange",this.update),player.tech&&!1===player.tech.featuresVolumeControl&&this.addClass("vjs-hidden"),this.on(player,"loadstart",function(){!1===player.tech.featuresVolumeControl?this.addClass("vjs-hidden"):this.removeClass("vjs-hidden")})}}),vjs.MuteToggle.prototype.createEl=function(){return vjs.Button.prototype.createEl.call(this,"div",{className:"vjs-mute-control vjs-control",innerHTML:'<div><span class="vjs-control-text">'+this.localize("Mute")+"</span></div>"})},vjs.MuteToggle.prototype.onClick=function(){this.player_.muted(!this.player_.muted())},vjs.MuteToggle.prototype.update=function(){var vol=this.player_.volume(),level=3;0===vol||this.player_.muted()?level=0:vol<.33?level=1:vol<.67&&(level=2),this.player_.muted()?this.el_.children[0].children[0].innerHTML!=this.localize("Unmute")&&(this.el_.children[0].children[0].innerHTML=this.localize("Unmute")):this.el_.children[0].children[0].innerHTML!=this.localize("Mute")&&(this.el_.children[0].children[0].innerHTML=this.localize("Mute"));for(var i=0;i<4;i++)vjs.removeClass(this.el_,"vjs-vol-"+i);vjs.addClass(this.el_,"vjs-vol-"+level)},vjs.VolumeMenuButton=vjs.MenuButton.extend({init:function(player,options){vjs.MenuButton.call(this,player,options),this.on(player,"volumechange",this.update),player.tech&&!1===player.tech.featuresVolumeControl&&this.addClass("vjs-hidden"),this.on(player,"loadstart",function(){!1===player.tech.featuresVolumeControl?this.addClass("vjs-hidden"):this.removeClass("vjs-hidden")}),this.addClass("vjs-menu-button")}}),vjs.VolumeMenuButton.prototype.createMenu=function(){var menu=new vjs.Menu(this.player_,{contentElType:"div"}),vc=new vjs.VolumeBar(this.player_,this.options_.volumeBar);return vc.on("focus",function(){menu.lockShowing()}),vc.on("blur",function(){menu.unlockShowing()}),menu.addChild(vc),menu},vjs.VolumeMenuButton.prototype.onClick=function(){vjs.MuteToggle.prototype.onClick.call(this),vjs.MenuButton.prototype.onClick.call(this)},vjs.VolumeMenuButton.prototype.createEl=function(){return vjs.Button.prototype.createEl.call(this,"div",{className:"vjs-volume-menu-button vjs-menu-button vjs-control",innerHTML:'<div><span class="vjs-control-text">'+this.localize("Mute")+"</span></div>"})},vjs.VolumeMenuButton.prototype.update=vjs.MuteToggle.prototype.update,vjs.PlaybackRateMenuButton=vjs.MenuButton.extend({init:function(player,options){vjs.MenuButton.call(this,player,options),this.updateVisibility(),this.updateLabel(),this.on(player,"loadstart",this.updateVisibility),this.on(player,"ratechange",this.updateLabel)}}),vjs.PlaybackRateMenuButton.prototype.createEl=function(){var el=vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-playback-rate vjs-menu-button vjs-control",innerHTML:'<div class="vjs-control-content"><span class="vjs-control-text">'+this.localize("Playback Rate")+"</span></div>"});return this.labelEl_=vjs.createEl("div",{className:"vjs-playback-rate-value",innerHTML:1}),el.appendChild(this.labelEl_),el},vjs.PlaybackRateMenuButton.prototype.createMenu=function(){var menu=new vjs.Menu(this.player()),rates=this.player().options().playbackRates;if(rates)for(var i=rates.length-1;i>=0;i--)menu.addChild(new vjs.PlaybackRateMenuItem(this.player(),{rate:rates[i]+"x"}));return menu},vjs.PlaybackRateMenuButton.prototype.updateARIAAttributes=function(){this.el().setAttribute("aria-valuenow",this.player().playbackRate())},vjs.PlaybackRateMenuButton.prototype.onClick=function(){for(var currentRate=this.player().playbackRate(),rates=this.player().options().playbackRates,newRate=rates[0],i=0;i<rates.length;i++)if(rates[i]>currentRate){newRate=rates[i];break}this.player().playbackRate(newRate)},vjs.PlaybackRateMenuButton.prototype.playbackRateSupported=function(){return this.player().tech&&this.player().tech.featuresPlaybackRate&&this.player().options().playbackRates&&this.player().options().playbackRates.length>0},vjs.PlaybackRateMenuButton.prototype.updateVisibility=function(){this.playbackRateSupported()?this.removeClass("vjs-hidden"):this.addClass("vjs-hidden")},vjs.PlaybackRateMenuButton.prototype.updateLabel=function(){this.playbackRateSupported()&&(this.labelEl_.innerHTML=this.player().playbackRate()+"x")},vjs.PlaybackRateMenuItem=vjs.MenuItem.extend({contentElType:"button",init:function(player,options){var label=this.label=options.rate,rate=this.rate=parseFloat(label,10);options.label=label,options.selected=1===rate,vjs.MenuItem.call(this,player,options),this.on(player,"ratechange",this.update)}}),vjs.PlaybackRateMenuItem.prototype.onClick=function(){vjs.MenuItem.prototype.onClick.call(this),this.player().playbackRate(this.rate)},vjs.PlaybackRateMenuItem.prototype.update=function(){this.selected(this.player().playbackRate()==this.rate)},vjs.PosterImage=vjs.Button.extend({init:function(player,options){vjs.Button.call(this,player,options),this.update(),player.on("posterchange",vjs.bind(this,this.update))}}),vjs.PosterImage.prototype.dispose=function(){this.player().off("posterchange",this.update),vjs.Button.prototype.dispose.call(this)},vjs.PosterImage.prototype.createEl=function(){var el=vjs.createEl("div",{className:"vjs-poster",tabIndex:-1});return vjs.BACKGROUND_SIZE_SUPPORTED||(this.fallbackImg_=vjs.createEl("img"),el.appendChild(this.fallbackImg_)),el},vjs.PosterImage.prototype.update=function(){var url=this.player().poster();this.setSrc(url),url?this.el_.style.display="":this.hide()},vjs.PosterImage.prototype.setSrc=function(url){var backgroundImage;this.fallbackImg_?this.fallbackImg_.src=url:(backgroundImage="",url&&(backgroundImage='url("'+url+'")'),this.el_.style.backgroundImage=backgroundImage)},vjs.PosterImage.prototype.onClick=function(){this.player_.play()},vjs.LoadingSpinner=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options)}}),vjs.LoadingSpinner.prototype.createEl=function(){return vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-loading-spinner"})},vjs.BigPlayButton=vjs.Button.extend(),vjs.BigPlayButton.prototype.createEl=function(){return vjs.Button.prototype.createEl.call(this,"div",{className:"vjs-big-play-button",innerHTML:'<span aria-hidden="true"></span>',"aria-label":"play video"})},vjs.BigPlayButton.prototype.onClick=function(){this.player_.play()},vjs.ErrorDisplay=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options),this.update(),this.on(player,"error",this.update)}}),vjs.ErrorDisplay.prototype.createEl=function(){var el=vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-error-display"});return this.contentEl_=vjs.createEl("div"),el.appendChild(this.contentEl_),el},vjs.ErrorDisplay.prototype.update=function(){this.player().error()&&(this.contentEl_.innerHTML=this.localize(this.player().error().message))},vjs.MediaTechController=vjs.Component.extend({init:function(player,options,ready){options=options||{},options.reportTouchActivity=!1,vjs.Component.call(this,player,options,ready),
this.featuresProgressEvents||this.manualProgressOn(),this.featuresTimeupdateEvents||this.manualTimeUpdatesOn(),this.initControlsListeners()}}),vjs.MediaTechController.prototype.initControlsListeners=function(){var player,activateControls;player=this.player(),activateControls=function(){player.controls()&&!player.usingNativeControls()&&this.addControlsListeners()},this.ready(activateControls),this.on(player,"controlsenabled",activateControls),this.on(player,"controlsdisabled",this.removeControlsListeners),this.ready(function(){this.networkState&&this.networkState()>0&&this.player().trigger("loadstart")})},vjs.MediaTechController.prototype.addControlsListeners=function(){var userWasActive;this.on("mousedown",this.onClick),this.on("touchstart",function(event){userWasActive=this.player_.userActive()}),this.on("touchmove",function(event){userWasActive&&this.player().reportUserActivity()}),this.on("touchend",function(event){event.preventDefault()}),this.emitTapEvents(),this.on("tap",this.onTap)},vjs.MediaTechController.prototype.removeControlsListeners=function(){this.off("tap"),this.off("touchstart"),this.off("touchmove"),this.off("touchleave"),this.off("touchcancel"),this.off("touchend"),this.off("click"),this.off("mousedown")},vjs.MediaTechController.prototype.onClick=function(event){0===event.button&&this.player().controls()&&(this.player().paused()?this.player().play():this.player().pause())},vjs.MediaTechController.prototype.onTap=function(){this.player().userActive(!this.player().userActive())},vjs.MediaTechController.prototype.manualProgressOn=function(){this.manualProgress=!0,this.trackProgress()},vjs.MediaTechController.prototype.manualProgressOff=function(){this.manualProgress=!1,this.stopTrackingProgress()},vjs.MediaTechController.prototype.trackProgress=function(){this.progressInterval=this.setInterval(function(){var bufferedPercent=this.player().bufferedPercent();this.bufferedPercent_!=bufferedPercent&&this.player().trigger("progress"),this.bufferedPercent_=bufferedPercent,1===bufferedPercent&&this.stopTrackingProgress()},500)},vjs.MediaTechController.prototype.stopTrackingProgress=function(){this.clearInterval(this.progressInterval)},vjs.MediaTechController.prototype.manualTimeUpdatesOn=function(){var player=this.player_;this.manualTimeUpdates=!0,this.on(player,"play",this.trackCurrentTime),this.on(player,"pause",this.stopTrackingCurrentTime),this.one("timeupdate",function(){this.featuresTimeupdateEvents=!0,this.manualTimeUpdatesOff()})},vjs.MediaTechController.prototype.manualTimeUpdatesOff=function(){this.manualTimeUpdates=!1,this.stopTrackingCurrentTime(),this.off("play",this.trackCurrentTime),this.off("pause",this.stopTrackingCurrentTime)},vjs.MediaTechController.prototype.trackCurrentTime=function(){this.currentTimeInterval&&this.stopTrackingCurrentTime(),this.currentTimeInterval=this.setInterval(function(){this.player().trigger("timeupdate")},250)},vjs.MediaTechController.prototype.stopTrackingCurrentTime=function(){this.clearInterval(this.currentTimeInterval),this.player().trigger("timeupdate")},vjs.MediaTechController.prototype.dispose=function(){this.manualProgress&&this.manualProgressOff(),this.manualTimeUpdates&&this.manualTimeUpdatesOff(),vjs.Component.prototype.dispose.call(this)},vjs.MediaTechController.prototype.setCurrentTime=function(){this.manualTimeUpdates&&this.player().trigger("timeupdate")},vjs.MediaTechController.prototype.setPoster=function(){},vjs.MediaTechController.prototype.featuresVolumeControl=!0,vjs.MediaTechController.prototype.featuresFullscreenResize=!1,vjs.MediaTechController.prototype.featuresPlaybackRate=!1,vjs.MediaTechController.prototype.featuresProgressEvents=!1,vjs.MediaTechController.prototype.featuresTimeupdateEvents=!1,vjs.MediaTechController.withSourceHandlers=function(Tech){Tech.registerSourceHandler=function(handler,index){var handlers=Tech.sourceHandlers;handlers||(handlers=Tech.sourceHandlers=[]),void 0===index&&(index=handlers.length),handlers.splice(index,0,handler)},Tech.selectSourceHandler=function(source){for(var handlers=Tech.sourceHandlers||[],i=0;i<handlers.length;i++)if(handlers[i].canHandleSource(source))return handlers[i];return null},Tech.canPlaySource=function(srcObj){var sh=Tech.selectSourceHandler(srcObj);return sh?sh.canHandleSource(srcObj):""},Tech.prototype.setSource=function(source){var sh=Tech.selectSourceHandler(source);return this.disposeSourceHandler(),this.off("dispose",this.disposeSourceHandler),this.currentSource_=source,this.sourceHandler_=sh.handleSource(source,this),this.on("dispose",this.disposeSourceHandler),this},Tech.prototype.disposeSourceHandler=function(){this.sourceHandler_&&this.sourceHandler_.dispose&&this.sourceHandler_.dispose()}},vjs.Html5=vjs.MediaTechController.extend({init:function(player,options,ready){vjs.MediaTechController.call(this,player,options,ready),this.setupTriggers();var source=options.source;source&&(this.el_.currentSrc!==source.src||player.tag&&3===player.tag.initNetworkState_)&&this.setSource(source),vjs.TOUCH_ENABLED&&!0===player.options().nativeControlsForTouch&&this.useNativeControls(),player.ready(function(){this.tag&&this.options_.autoplay&&this.paused()&&(delete this.tag.poster,this.play())}),this.triggerReady()}}),vjs.Html5.prototype.dispose=function(){vjs.Html5.disposeMediaElement(this.el_),vjs.MediaTechController.prototype.dispose.call(this)},vjs.Html5.prototype.createEl=function(){var clone,player=this.player_,el=player.tag;el&&!1!==this.movingMediaElementInDOM||(el?(clone=el.cloneNode(!1),vjs.Html5.disposeMediaElement(el),el=clone,player.tag=null):(el=vjs.createEl("video"),vjs.setElementAttributes(el,vjs.obj.merge(player.tagAttributes||{},{id:player.id()+"_html5_api",class:"vjs-tech"}))),el.player=player,vjs.insertFirst(el,player.el()));for(var settingsAttrs=["autoplay","preload","loop","muted"],i=settingsAttrs.length-1;i>=0;i--){var attr=settingsAttrs[i],overwriteAttrs={};void 0!==player.options_[attr]&&(overwriteAttrs[attr]=player.options_[attr]),vjs.setElementAttributes(el,overwriteAttrs)}return el},vjs.Html5.prototype.setupTriggers=function(){for(var i=vjs.Html5.Events.length-1;i>=0;i--)this.on(vjs.Html5.Events[i],this.eventHandler)},vjs.Html5.prototype.eventHandler=function(evt){"error"==evt.type&&this.error()?this.player().error(this.error().code):(evt.bubbles=!1,this.player().trigger(evt))},vjs.Html5.prototype.useNativeControls=function(){var tech,player,controlsOn,controlsOff,cleanUp;tech=this,player=this.player(),tech.setControls(player.controls()),controlsOn=function(){tech.setControls(!0)},controlsOff=function(){tech.setControls(!1)},player.on("controlsenabled",controlsOn),player.on("controlsdisabled",controlsOff),cleanUp=function(){player.off("controlsenabled",controlsOn),player.off("controlsdisabled",controlsOff)},tech.on("dispose",cleanUp),player.on("usingcustomcontrols",cleanUp),player.usingNativeControls(!0)},vjs.Html5.prototype.play=function(){this.el_.play()},vjs.Html5.prototype.pause=function(){this.el_.pause()},vjs.Html5.prototype.paused=function(){return this.el_.paused},vjs.Html5.prototype.currentTime=function(){return this.el_.currentTime},vjs.Html5.prototype.setCurrentTime=function(seconds){try{this.el_.currentTime=seconds}catch(e){vjs.log(e,"Video is not ready. (Video.js)")}},vjs.Html5.prototype.duration=function(){return this.el_.duration||0},vjs.Html5.prototype.buffered=function(){return this.el_.buffered},vjs.Html5.prototype.volume=function(){return this.el_.volume},vjs.Html5.prototype.setVolume=function(percentAsDecimal){this.el_.volume=percentAsDecimal},vjs.Html5.prototype.muted=function(){return this.el_.muted},vjs.Html5.prototype.setMuted=function(muted){this.el_.muted=muted},vjs.Html5.prototype.width=function(){return this.el_.offsetWidth},vjs.Html5.prototype.height=function(){return this.el_.offsetHeight},vjs.Html5.prototype.supportsFullScreen=function(){return!("function"!=typeof this.el_.webkitEnterFullScreen||!/Android/.test(vjs.USER_AGENT)&&/Chrome|Mac OS X 10.5/.test(vjs.USER_AGENT))},vjs.Html5.prototype.enterFullScreen=function(){var video=this.el_;"webkitDisplayingFullscreen"in video&&this.one("webkitbeginfullscreen",function(){this.player_.isFullscreen(!0),this.one("webkitendfullscreen",function(){this.player_.isFullscreen(!1),this.player_.trigger("fullscreenchange")}),this.player_.trigger("fullscreenchange")}),video.paused&&video.networkState<=video.HAVE_METADATA?(this.el_.play(),this.setTimeout(function(){video.pause(),video.webkitEnterFullScreen()},0)):video.webkitEnterFullScreen()},vjs.Html5.prototype.exitFullScreen=function(){this.el_.webkitExitFullScreen()},vjs.Html5.prototype.src=function(src){if(void 0===src)return this.el_.src;this.setSrc(src)},vjs.Html5.prototype.setSrc=function(src){this.el_.src=src},vjs.Html5.prototype.load=function(){this.el_.load()},vjs.Html5.prototype.currentSrc=function(){return this.el_.currentSrc},vjs.Html5.prototype.poster=function(){return this.el_.poster},vjs.Html5.prototype.setPoster=function(val){this.el_.poster=val},vjs.Html5.prototype.preload=function(){return this.el_.preload},vjs.Html5.prototype.setPreload=function(val){this.el_.preload=val},vjs.Html5.prototype.autoplay=function(){return this.el_.autoplay},vjs.Html5.prototype.setAutoplay=function(val){this.el_.autoplay=val},vjs.Html5.prototype.controls=function(){return this.el_.controls},vjs.Html5.prototype.setControls=function(val){this.el_.controls=!!val},vjs.Html5.prototype.loop=function(){return this.el_.loop},vjs.Html5.prototype.setLoop=function(val){this.el_.loop=val},vjs.Html5.prototype.error=function(){return this.el_.error},vjs.Html5.prototype.seeking=function(){return this.el_.seeking},vjs.Html5.prototype.ended=function(){return this.el_.ended},vjs.Html5.prototype.defaultMuted=function(){return this.el_.defaultMuted},vjs.Html5.prototype.playbackRate=function(){return this.el_.playbackRate},vjs.Html5.prototype.setPlaybackRate=function(val){this.el_.playbackRate=val},vjs.Html5.prototype.networkState=function(){return this.el_.networkState},vjs.Html5.isSupported=function(){try{vjs.TEST_VID.volume=.5}catch(e){return!1}return!!vjs.TEST_VID.canPlayType},vjs.MediaTechController.withSourceHandlers(vjs.Html5),vjs.Html5.nativeSourceHandler={},vjs.Html5.nativeSourceHandler.canHandleSource=function(source){var ext;function canPlayType(type){try{return!!vjs.TEST_VID.canPlayType(type)}catch(e){return""}}return source.type?canPlayType(source.type):(ext=source.src.match(/\.([^\/\?]+)(\?[^\/]+)?$/i)[1],canPlayType("video/"+ext))},vjs.Html5.nativeSourceHandler.handleSource=function(source,tech){tech.setSrc(source.src)},vjs.Html5.nativeSourceHandler.dispose=function(){},vjs.Html5.registerSourceHandler(vjs.Html5.nativeSourceHandler),vjs.Html5.canControlVolume=function(){var volume=vjs.TEST_VID.volume;return vjs.TEST_VID.volume=volume/2+.1,volume!==vjs.TEST_VID.volume},vjs.Html5.canControlPlaybackRate=function(){var playbackRate=vjs.TEST_VID.playbackRate;return vjs.TEST_VID.playbackRate=playbackRate/2+.1,playbackRate!==vjs.TEST_VID.playbackRate},vjs.Html5.prototype.featuresVolumeControl=vjs.Html5.canControlVolume(),vjs.Html5.prototype.featuresPlaybackRate=vjs.Html5.canControlPlaybackRate(),vjs.Html5.prototype.movingMediaElementInDOM=!vjs.IS_IOS,vjs.Html5.prototype.featuresFullscreenResize=!0,vjs.Html5.prototype.featuresProgressEvents=!0,function(){var canPlayType,mpegurlRE=/^application\/(?:x-|vnd\.apple\.)mpegurl/i,mp4RE=/^video\/mp4/i;vjs.Html5.patchCanPlayType=function(){vjs.ANDROID_VERSION>=4&&(canPlayType||(canPlayType=vjs.TEST_VID.constructor.prototype.canPlayType),vjs.TEST_VID.constructor.prototype.canPlayType=function(type){return type&&mpegurlRE.test(type)?"maybe":canPlayType.call(this,type)}),vjs.IS_OLD_ANDROID&&(canPlayType||(canPlayType=vjs.TEST_VID.constructor.prototype.canPlayType),vjs.TEST_VID.constructor.prototype.canPlayType=function(type){return type&&mp4RE.test(type)?"maybe":canPlayType.call(this,type)})},vjs.Html5.unpatchCanPlayType=function(){var r=vjs.TEST_VID.constructor.prototype.canPlayType;return vjs.TEST_VID.constructor.prototype.canPlayType=canPlayType,canPlayType=null,r},vjs.Html5.patchCanPlayType()}(),vjs.Html5.Events="loadstart,suspend,abort,error,emptied,stalled,loadedmetadata,loadeddata,canplay,canplaythrough,playing,waiting,seeking,seeked,ended,durationchange,timeupdate,progress,play,pause,ratechange,volumechange".split(","),vjs.Html5.disposeMediaElement=function(el){if(el){for(el.player=null,el.parentNode&&el.parentNode.removeChild(el);el.hasChildNodes();)el.removeChild(el.firstChild);el.removeAttribute("src"),"function"==typeof el.load&&function(){try{el.load()}catch(e){}}()}},vjs.Flash=vjs.MediaTechController.extend({init:function(player,options,ready){vjs.MediaTechController.call(this,player,options,ready);var source=options.source,parentEl=options.parentEl,placeHolder=this.el_=vjs.createEl("div",{id:player.id()+"_temp_flash"}),objId=player.id()+"_flash_api",playerOptions=player.options_,flashVars=vjs.obj.merge({readyFunction:"videojs.Flash.onReady",eventProxyFunction:"videojs.Flash.onEvent",errorEventProxyFunction:"videojs.Flash.onError",autoplay:playerOptions.autoplay,preload:playerOptions.preload,loop:playerOptions.loop,muted:playerOptions.muted},options.flashVars),params=vjs.obj.merge({wmode:"opaque",bgcolor:"#000000"},options.params),attributes=vjs.obj.merge({id:objId,name:objId,class:"vjs-tech"},options.attributes);source&&this.ready(function(){this.setSource(source)}),vjs.insertFirst(placeHolder,parentEl),options.startTime&&this.ready(function(){this.load(),this.play(),this.currentTime(options.startTime)}),vjs.IS_FIREFOX&&this.ready(function(){this.on("mousemove",function(){this.player().trigger({type:"mousemove",bubbles:!1})})}),player.on("stageclick",player.reportUserActivity),this.el_=vjs.Flash.embed(options.swf,placeHolder,flashVars,params,attributes)}}),vjs.Flash.prototype.dispose=function(){vjs.MediaTechController.prototype.dispose.call(this)},vjs.Flash.prototype.play=function(){this.el_.vjs_play()},vjs.Flash.prototype.pause=function(){this.el_.vjs_pause()},vjs.Flash.prototype.src=function(src){return void 0===src?this.currentSrc():this.setSrc(src)},vjs.Flash.prototype.setSrc=function(src){if(src=vjs.getAbsoluteURL(src),this.el_.vjs_src(src),this.player_.autoplay()){var tech=this;this.setTimeout(function(){tech.play()},0)}},vjs.Flash.prototype.setCurrentTime=function(time){this.lastSeekTarget_=time,this.el_.vjs_setProperty("currentTime",time),vjs.MediaTechController.prototype.setCurrentTime.call(this)},vjs.Flash.prototype.currentTime=function(time){return this.seeking()?this.lastSeekTarget_||0:this.el_.vjs_getProperty("currentTime")},vjs.Flash.prototype.currentSrc=function(){return this.currentSource_?this.currentSource_.src:this.el_.vjs_getProperty("currentSrc")},vjs.Flash.prototype.load=function(){this.el_.vjs_load()},vjs.Flash.prototype.poster=function(){this.el_.vjs_getProperty("poster")},vjs.Flash.prototype.setPoster=function(){},vjs.Flash.prototype.buffered=function(){return vjs.createTimeRange(0,this.el_.vjs_getProperty("buffered"))},vjs.Flash.prototype.supportsFullScreen=function(){return!1},vjs.Flash.prototype.enterFullScreen=function(){return!1},function(){var i,api=vjs.Flash.prototype,readWrite="rtmpConnection,rtmpStream,preload,defaultPlaybackRate,playbackRate,autoplay,loop,mediaGroup,controller,controls,volume,muted,defaultMuted".split(","),readOnly="error,networkState,readyState,seeking,initialTime,duration,startOffsetTime,paused,played,seekable,ended,videoTracks,audioTracks,videoWidth,videoHeight,textTracks".split(",");function createGetter(attr){api[attr]=function(){return this.el_.vjs_getProperty(attr)}}for(i=0;i<readWrite.length;i++)createGetter(readWrite[i]),function(attr){var attrUpper=attr.charAt(0).toUpperCase()+attr.slice(1);api["set"+attrUpper]=function(val){return this.el_.vjs_setProperty(attr,val)}}(readWrite[i]);for(i=0;i<readOnly.length;i++)createGetter(readOnly[i])}(),vjs.Flash.isSupported=function(){return vjs.Flash.version()[0]>=10},vjs.MediaTechController.withSourceHandlers(vjs.Flash),vjs.Flash.nativeSourceHandler={},vjs.Flash.nativeSourceHandler.canHandleSource=function(source){var type;return source.type?(type=source.type.replace(/;.*/,"").toLowerCase(),type in vjs.Flash.formats?"maybe":""):""},vjs.Flash.nativeSourceHandler.handleSource=function(source,tech){tech.setSrc(source.src)},vjs.Flash.nativeSourceHandler.dispose=function(){},vjs.Flash.registerSourceHandler(vjs.Flash.nativeSourceHandler),vjs.Flash.formats={"video/flv":"FLV","video/x-flv":"FLV","video/mp4":"MP4","video/m4v":"MP4"},vjs.Flash.onReady=function(currSwf){var el,player;el=vjs.el(currSwf),(player=el&&el.parentNode&&el.parentNode.player)&&(el.player=player,vjs.Flash.checkReady(player.tech))},vjs.Flash.checkReady=function(tech){tech.el()&&(tech.el().vjs_getProperty?tech.triggerReady():this.setTimeout(function(){vjs.Flash.checkReady(tech)},50))},vjs.Flash.onEvent=function(swfID,eventName){vjs.el(swfID).player.trigger(eventName)},vjs.Flash.onError=function(swfID,err){var player=vjs.el(swfID).player,msg="FLASH: "+err;"srcnotfound"==err?player.error({code:4,message:msg}):player.error(msg)},vjs.Flash.version=function(){var version="0,0,0";try{version=new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version").replace(/\D+/g,",").match(/^,?(.+),?$/)[1]}catch(e){try{navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin&&(version=(navigator.plugins["Shockwave Flash 2.0"]||navigator.plugins["Shockwave Flash"]).description.replace(/\D+/g,",").match(/^,?(.+),?$/)[1])}catch(err){}}return version.split(",")},vjs.Flash.embed=function(swf,placeHolder,flashVars,params,attributes){var code=vjs.Flash.getEmbedCode(swf,flashVars,params,attributes),obj=vjs.createEl("div",{innerHTML:code}).childNodes[0],par=placeHolder.parentNode;placeHolder.parentNode.replaceChild(obj,placeHolder);var newObj=par.childNodes[0];return setTimeout(function(){newObj.style.display="block"},1e3),obj},vjs.Flash.getEmbedCode=function(swf,flashVars,params,attributes){var flashVarsString="",paramsString="",attrsString="";return flashVars&&vjs.obj.each(flashVars,function(key,val){flashVarsString+=key+"="+val+"&amp;"}),params=vjs.obj.merge({movie:swf,flashvars:flashVarsString,allowScriptAccess:"always",allowNetworking:"all"},params),vjs.obj.each(params,function(key,val){paramsString+='<param name="'+key+'" value="'+val+'" />'}),attributes=vjs.obj.merge({data:swf,width:"100%",height:"100%"},attributes),vjs.obj.each(attributes,function(key,val){attrsString+=key+'="'+val+'" '}),'<object type="application/x-shockwave-flash" '+attrsString+">"+paramsString+"</object>"},vjs.Flash.streamingFormats={"rtmp/mp4":"MP4","rtmp/flv":"FLV"},vjs.Flash.streamFromParts=function(connection,stream){return connection+"&"+stream},vjs.Flash.streamToParts=function(src){var parts={connection:"",stream:""};if(!src)return parts;var streamBegin,connEnd=src.indexOf("&");return-1!==connEnd?streamBegin=connEnd+1:0===(connEnd=streamBegin=src.lastIndexOf("/")+1)&&(connEnd=streamBegin=src.length),parts.connection=src.substring(0,connEnd),parts.stream=src.substring(streamBegin,src.length),parts},vjs.Flash.isStreamingType=function(srcType){return srcType in vjs.Flash.streamingFormats},vjs.Flash.RTMP_RE=/^rtmp[set]?:\/\//i,vjs.Flash.isStreamingSrc=function(src){return vjs.Flash.RTMP_RE.test(src)},vjs.Flash.rtmpSourceHandler={},vjs.Flash.rtmpSourceHandler.canHandleSource=function(source){return vjs.Flash.isStreamingType(source.type)||vjs.Flash.isStreamingSrc(source.src)?"maybe":""},vjs.Flash.rtmpSourceHandler.handleSource=function(source,tech){var srcParts=vjs.Flash.streamToParts(source.src);tech.setRtmpConnection(srcParts.connection),tech.setRtmpStream(srcParts.stream)},vjs.Flash.registerSourceHandler(vjs.Flash.rtmpSourceHandler),vjs.MediaLoader=vjs.Component.extend({init:function(player,options,ready){if(vjs.Component.call(this,player,options,ready),player.options_.sources&&0!==player.options_.sources.length)player.src(player.options_.sources);else for(var i=0,j=player.options_.techOrder;i<j.length;i++){var techName=vjs.capitalize(j[i]),tech=window.videojs[techName];if(tech&&tech.isSupported()){player.loadTech(techName);break}}}}),vjs.Player.prototype.textTracks_,vjs.Player.prototype.textTracks=function(){return this.textTracks_=this.textTracks_||[],this.textTracks_},vjs.Player.prototype.addTextTrack=function(kind,label,language,options){var tracks=this.textTracks_=this.textTracks_||[];options=options||{},options.kind=kind,options.label=label,options.language=language;var Kind=vjs.capitalize(kind||"subtitles"),track=new window.videojs[Kind+"Track"](this,options);return tracks.push(track),track.dflt()&&this.ready(function(){this.setTimeout(function(){track.player().showTextTrack(track.id())},0)}),track},vjs.Player.prototype.addTextTracks=function(trackList){for(var trackObj,i=0;i<trackList.length;i++)trackObj=trackList[i],this.addTextTrack(trackObj.kind,trackObj.label,trackObj.language,trackObj);return this},vjs.Player.prototype.showTextTrack=function(id,disableSameKind){for(var track,showTrack,kind,tracks=this.textTracks_,i=0,j=tracks.length;i<j;i++)track=tracks[i],track.id()===id?(track.show(),showTrack=track):disableSameKind&&track.kind()==disableSameKind&&track.mode()>0&&track.disable();return kind=showTrack?showTrack.kind():disableSameKind||!1,kind&&this.trigger(kind+"trackchange"),this},vjs.TextTrack=vjs.Component.extend({init:function(player,options){vjs.Component.call(this,player,options),this.id_=options.id||"vjs_"+options.kind+"_"+options.language+"_"+vjs.guid++,this.src_=options.src,this.dflt_=options.default||options.dflt,this.title_=options.title,this.language_=options.srclang,this.label_=options.label,this.cues_=[],this.activeCues_=[],this.readyState_=0,this.mode_=0,player.on("dispose",vjs.bind(this,this.deactivate,this.id_))}}),vjs.TextTrack.prototype.kind_,vjs.TextTrack.prototype.kind=function(){return this.kind_},vjs.TextTrack.prototype.src_,vjs.TextTrack.prototype.src=function(){return this.src_},vjs.TextTrack.prototype.dflt_,vjs.TextTrack.prototype.dflt=function(){return this.dflt_},vjs.TextTrack.prototype.title_,vjs.TextTrack.prototype.title=function(){return this.title_},vjs.TextTrack.prototype.language_,vjs.TextTrack.prototype.language=function(){return this.language_},vjs.TextTrack.prototype.label_,vjs.TextTrack.prototype.label=function(){return this.label_},vjs.TextTrack.prototype.cues_,vjs.TextTrack.prototype.cues=function(){return this.cues_},vjs.TextTrack.prototype.activeCues_,vjs.TextTrack.prototype.activeCues=function(){return this.activeCues_},vjs.TextTrack.prototype.readyState_,vjs.TextTrack.prototype.readyState=function(){return this.readyState_},vjs.TextTrack.prototype.mode_,vjs.TextTrack.prototype.mode=function(){return this.mode_},vjs.TextTrack.prototype.createEl=function(){return vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-"+this.kind_+" vjs-text-track"})},vjs.TextTrack.prototype.show=function(){this.activate(),this.mode_=2,vjs.Component.prototype.show.call(this)},vjs.TextTrack.prototype.hide=function(){this.activate(),this.mode_=1,vjs.Component.prototype.hide.call(this)},vjs.TextTrack.prototype.disable=function(){2==this.mode_&&this.hide(),this.deactivate(),this.mode_=0},vjs.TextTrack.prototype.activate=function(){0===this.readyState_&&this.load(),0===this.mode_&&(this.player_.on("timeupdate",vjs.bind(this,this.update,this.id_)),this.player_.on("ended",vjs.bind(this,this.reset,this.id_)),"captions"!==this.kind_&&"subtitles"!==this.kind_||this.player_.getChild("textTrackDisplay").addChild(this))},vjs.TextTrack.prototype.deactivate=function(){this.player_.off("timeupdate",vjs.bind(this,this.update,this.id_)),this.player_.off("ended",vjs.bind(this,this.reset,this.id_)),this.reset(),this.player_.getChild("textTrackDisplay").removeChild(this)},vjs.TextTrack.prototype.load=function(){0===this.readyState_&&(this.readyState_=1,vjs.xhr(this.src_,vjs.bind(this,function(err,response,responseBody){if(err)return this.onError(err);this.parseCues(responseBody)})))},vjs.TextTrack.prototype.onError=function(err){this.error=err,this.readyState_=3,this.trigger("error")},vjs.TextTrack.prototype.parseCues=function(srcContent){for(var cue,time,text,id,lines=srcContent.split("\n"),line="",i=1,j=lines.length;i<j;i++)if(line=vjs.trim(lines[i])){for(-1==line.indexOf("--\x3e")?(id=line,line=vjs.trim(lines[++i])):id=this.cues_.length,cue={id:id,index:this.cues_.length},time=line.split(/[\t ]+/),cue.startTime=this.parseCueTime(time[0]),cue.endTime=this.parseCueTime(time[2]),text=[];lines[++i]&&(line=vjs.trim(lines[i]));)text.push(line);cue.text=text.join("<br/>"),this.cues_.push(cue)}this.readyState_=2,this.trigger("loaded")},vjs.TextTrack.prototype.parseCueTime=function(timeText){var hours,minutes,other,seconds,ms,parts=timeText.split(":"),time=0;return 3==parts.length?(hours=parts[0],minutes=parts[1],other=parts[2]):(hours=0,minutes=parts[0],other=parts[1]),other=other.split(/\s+/),seconds=other.splice(0,1)[0],seconds=seconds.split(/\.|,/),ms=parseFloat(seconds[1]),seconds=seconds[0],time+=3600*parseFloat(hours),time+=60*parseFloat(minutes),time+=parseFloat(seconds),ms&&(time+=ms/1e3),time},vjs.TextTrack.prototype.update=function(){if(this.cues_.length>0){var offset=this.player_.options().trackTimeOffset||0,time=this.player_.currentTime()+offset;if(void 0===this.prevChange||time<this.prevChange||this.nextChange<=time){var firstActiveIndex,lastActiveIndex,cue,i,cues=this.cues_,newNextChange=this.player_.duration(),newPrevChange=0,reverse=!1,newCues=[];for(time>=this.nextChange||void 0===this.nextChange?i=void 0!==this.firstActiveIndex?this.firstActiveIndex:0:(reverse=!0,i=void 0!==this.lastActiveIndex?this.lastActiveIndex:cues.length-1);;){if(cue=cues[i],cue.endTime<=time)newPrevChange=Math.max(newPrevChange,cue.endTime),cue.active&&(cue.active=!1);else if(time<cue.startTime){if(newNextChange=Math.min(newNextChange,cue.startTime),cue.active&&(cue.active=!1),!reverse)break}else reverse?(newCues.splice(0,0,cue),void 0===lastActiveIndex&&(lastActiveIndex=i),firstActiveIndex=i):(newCues.push(cue),void 0===firstActiveIndex&&(firstActiveIndex=i),lastActiveIndex=i),newNextChange=Math.min(newNextChange,cue.endTime),newPrevChange=Math.max(newPrevChange,cue.startTime),cue.active=!0;if(reverse){if(0===i)break;i--}else{if(i===cues.length-1)break;i++}}this.activeCues_=newCues,this.nextChange=newNextChange,this.prevChange=newPrevChange,this.firstActiveIndex=firstActiveIndex,this.lastActiveIndex=lastActiveIndex,this.updateDisplay(),this.trigger("cuechange")}}},vjs.TextTrack.prototype.updateDisplay=function(){for(var cues=this.activeCues_,html="",i=0,j=cues.length;i<j;i++)html+='<span class="vjs-tt-cue">'+cues[i].text+"</span>";this.el_.innerHTML=html},vjs.TextTrack.prototype.reset=function(){this.nextChange=0,this.prevChange=this.player_.duration(),this.firstActiveIndex=0,this.lastActiveIndex=0},vjs.CaptionsTrack=vjs.TextTrack.extend(),vjs.CaptionsTrack.prototype.kind_="captions",vjs.SubtitlesTrack=vjs.TextTrack.extend(),vjs.SubtitlesTrack.prototype.kind_="subtitles",vjs.ChaptersTrack=vjs.TextTrack.extend(),vjs.ChaptersTrack.prototype.kind_="chapters",vjs.TextTrackDisplay=vjs.Component.extend({init:function(player,options,ready){vjs.Component.call(this,player,options,ready),player.options_.tracks&&player.options_.tracks.length>0&&this.player_.addTextTracks(player.options_.tracks)}}),vjs.TextTrackDisplay.prototype.createEl=function(){return vjs.Component.prototype.createEl.call(this,"div",{className:"vjs-text-track-display"})},vjs.TextTrackMenuItem=vjs.MenuItem.extend({init:function(player,options){var track=this.track=options.track;options.label=track.label(),options.selected=track.dflt(),vjs.MenuItem.call(this,player,options),this.on(player,track.kind()+"trackchange",this.update)}}),vjs.TextTrackMenuItem.prototype.onClick=function(){vjs.MenuItem.prototype.onClick.call(this),this.player_.showTextTrack(this.track.id_,this.track.kind())},vjs.TextTrackMenuItem.prototype.update=function(){this.selected(2==this.track.mode())},vjs.OffTextTrackMenuItem=vjs.TextTrackMenuItem.extend({init:function(player,options){options.track={kind:function(){return options.kind},player:player,label:function(){return options.kind+" off"},dflt:function(){return!1},mode:function(){return!1}},vjs.TextTrackMenuItem.call(this,player,options),this.selected(!0)}}),vjs.OffTextTrackMenuItem.prototype.onClick=function(){vjs.TextTrackMenuItem.prototype.onClick.call(this),this.player_.showTextTrack(this.track.id_,this.track.kind())},vjs.OffTextTrackMenuItem.prototype.update=function(){for(var track,tracks=this.player_.textTracks(),i=0,j=tracks.length,off=!0;i<j;i++)track=tracks[i],track.kind()==this.track.kind()&&2==track.mode()&&(off=!1);this.selected(off)},vjs.TextTrackButton=vjs.MenuButton.extend({init:function(player,options){vjs.MenuButton.call(this,player,options),this.items.length<=1&&this.hide()}}),vjs.TextTrackButton.prototype.createItems=function(){var track,items=[];items.push(new vjs.OffTextTrackMenuItem(this.player_,{kind:this.kind_}));for(var i=0;i<this.player_.textTracks().length;i++)track=this.player_.textTracks()[i],track.kind()===this.kind_&&items.push(new vjs.TextTrackMenuItem(this.player_,{track:track}));return items},vjs.CaptionsButton=vjs.TextTrackButton.extend({init:function(player,options,ready){vjs.TextTrackButton.call(this,player,options,ready),this.el_.setAttribute("aria-label","Captions Menu")}}),vjs.CaptionsButton.prototype.kind_="captions",vjs.CaptionsButton.prototype.buttonText="Captions",vjs.CaptionsButton.prototype.className="vjs-captions-button",vjs.SubtitlesButton=vjs.TextTrackButton.extend({init:function(player,options,ready){vjs.TextTrackButton.call(this,player,options,ready),this.el_.setAttribute("aria-label","Subtitles Menu")}}),vjs.SubtitlesButton.prototype.kind_="subtitles",vjs.SubtitlesButton.prototype.buttonText="Subtitles",vjs.SubtitlesButton.prototype.className="vjs-subtitles-button",vjs.ChaptersButton=vjs.TextTrackButton.extend({init:function(player,options,ready){vjs.TextTrackButton.call(this,player,options,ready),this.el_.setAttribute("aria-label","Chapters Menu")}}),vjs.ChaptersButton.prototype.kind_="chapters",vjs.ChaptersButton.prototype.buttonText="Chapters",vjs.ChaptersButton.prototype.className="vjs-chapters-button",vjs.ChaptersButton.prototype.createItems=function(){for(var track,items=[],i=0;i<this.player_.textTracks().length;i++)track=this.player_.textTracks()[i],track.kind()===this.kind_&&items.push(new vjs.TextTrackMenuItem(this.player_,{track:track}));return items},vjs.ChaptersButton.prototype.createMenu=function(){for(var track,chaptersTrack,tracks=this.player_.textTracks(),i=0,j=tracks.length,items=this.items=[];i<j;i++)if(track=tracks[i],track.kind()==this.kind_){if(0!==track.readyState()){chaptersTrack=track;break}track.load(),track.on("loaded",vjs.bind(this,this.createMenu))}var menu=this.menu;if(void 0===menu&&(menu=new vjs.Menu(this.player_),menu.contentEl().appendChild(vjs.createEl("li",{className:"vjs-menu-title",innerHTML:vjs.capitalize(this.kind_),tabindex:-1}))),chaptersTrack){var cue,mi,cues=chaptersTrack.cues_;for(i=0,j=cues.length;i<j;i++)cue=cues[i],mi=new vjs.ChaptersTrackMenuItem(this.player_,{track:chaptersTrack,cue:cue}),items.push(mi),menu.addChild(mi);this.addChild(menu)}return this.items.length>0&&this.show(),menu},vjs.ChaptersTrackMenuItem=vjs.MenuItem.extend({init:function(player,options){var track=this.track=options.track,cue=this.cue=options.cue,currentTime=player.currentTime();options.label=cue.text,options.selected=cue.startTime<=currentTime&&currentTime<cue.endTime,vjs.MenuItem.call(this,player,options),track.on("cuechange",vjs.bind(this,this.update))}}),vjs.ChaptersTrackMenuItem.prototype.onClick=function(){vjs.MenuItem.prototype.onClick.call(this),this.player_.currentTime(this.cue.startTime),this.update(this.cue.startTime)},vjs.ChaptersTrackMenuItem.prototype.update=function(){var cue=this.cue,currentTime=this.player_.currentTime()
;this.selected(cue.startTime<=currentTime&&currentTime<cue.endTime)},vjs.obj.merge(vjs.ControlBar.prototype.options_.children,{subtitlesButton:{},captionsButton:{},chaptersButton:{}}),vjs.JSON,void 0!==window.JSON&&"function"==typeof window.JSON.parse)vjs.JSON=window.JSON;else{vjs.JSON={};var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;vjs.JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&"object"==typeof value)for(k in value)Object.prototype.hasOwnProperty.call(value,k)&&(v=walk(value,k),void 0!==v?value[k]=v:delete value[k]);return reviver.call(holder,key,value)}if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse(): invalid or malformed JSON data")}}vjs.autoSetup=function(){var mediaEl,i,e,vids=document.getElementsByTagName("video"),audios=document.getElementsByTagName("audio"),mediaEls=[];if(vids&&vids.length>0)for(i=0,e=vids.length;i<e;i++)mediaEls.push(vids[i]);if(audios&&audios.length>0)for(i=0,e=audios.length;i<e;i++)mediaEls.push(audios[i]);if(mediaEls&&mediaEls.length>0)for(i=0,e=mediaEls.length;i<e;i++){if(!(mediaEl=mediaEls[i])||!mediaEl.getAttribute){vjs.autoSetupTimeout(1);break}void 0===mediaEl.player&&null!==mediaEl.getAttribute("data-setup")&&videojs(mediaEl)}else vjs.windowLoaded||vjs.autoSetupTimeout(1)},vjs.autoSetupTimeout=function(wait){setTimeout(vjs.autoSetup,wait)},"complete"===document.readyState?vjs.windowLoaded=!0:vjs.one(window,"load",function(){vjs.windowLoaded=!0}),vjs.autoSetupTimeout(1),vjs.plugin=function(name,init){vjs.Player.prototype[name]=init},function(global,factory){if("function"==typeof define&&define.amd)define(["module","exports"],factory);else if("undefined"!=typeof exports)factory(module,exports);else{var mod={exports:{}};factory(mod,mod.exports),global.autosize=mod.exports}}(this,function(module,exports){"use strict";var map="function"==typeof Map?new Map:function(){var keys=[],values=[];return{has:function(key){return keys.indexOf(key)>-1},get:function(key){return values[keys.indexOf(key)]},set:function(key,value){-1===keys.indexOf(key)&&(keys.push(key),values.push(value))},delete:function(key){var index=keys.indexOf(key);index>-1&&(keys.splice(index,1),values.splice(index,1))}}}(),createEvent=function(name){return new Event(name,{bubbles:!0})};try{new Event("test")}catch(e){createEvent=function(name){var evt=document.createEvent("Event");return evt.initEvent(name,!0,!1),evt}}function assign(ta){function changeOverflow(value){var width=ta.style.width;ta.style.width="0px",ta.offsetWidth,ta.style.width=width,ta.style.overflowY=value}function getParentOverflows(el){for(var arr=[];el&&el.parentNode&&el.parentNode instanceof Element;)el.parentNode.scrollTop&&arr.push({node:el.parentNode,scrollTop:el.parentNode.scrollTop}),el=el.parentNode;return arr}function resize(){if(0!==ta.scrollHeight){var overflows=getParentOverflows(ta),docTop=document.documentElement&&document.documentElement.scrollTop;ta.style.height="",ta.style.height=ta.scrollHeight+heightOffset+"px",clientWidth=ta.clientWidth,overflows.forEach(function(el){el.node.scrollTop=el.scrollTop}),docTop&&(document.documentElement.scrollTop=docTop)}}function update(){resize();var styleHeight=Math.round(parseFloat(ta.style.height)),computed=window.getComputedStyle(ta,null),actualHeight="content-box"===computed.boxSizing?Math.round(parseFloat(computed.height)):ta.offsetHeight;if(actualHeight<styleHeight?"hidden"===computed.overflowY&&(changeOverflow("scroll"),resize(),actualHeight="content-box"===computed.boxSizing?Math.round(parseFloat(window.getComputedStyle(ta,null).height)):ta.offsetHeight):"hidden"!==computed.overflowY&&(changeOverflow("hidden"),resize(),actualHeight="content-box"===computed.boxSizing?Math.round(parseFloat(window.getComputedStyle(ta,null).height)):ta.offsetHeight),cachedHeight!==actualHeight){cachedHeight=actualHeight;var evt=createEvent("autosize:resized");try{ta.dispatchEvent(evt)}catch(err){}}}if(ta&&ta.nodeName&&"TEXTAREA"===ta.nodeName&&!map.has(ta)){var heightOffset=null,clientWidth=null,cachedHeight=null,pageResize=function(){ta.clientWidth!==clientWidth&&update()},destroy=function(style){window.removeEventListener("resize",pageResize,!1),ta.removeEventListener("input",update,!1),ta.removeEventListener("keyup",update,!1),ta.removeEventListener("autosize:destroy",destroy,!1),ta.removeEventListener("autosize:update",update,!1),Object.keys(style).forEach(function(key){ta.style[key]=style[key]}),map.delete(ta)}.bind(ta,{height:ta.style.height,resize:ta.style.resize,overflowY:ta.style.overflowY,overflowX:ta.style.overflowX,wordWrap:ta.style.wordWrap});ta.addEventListener("autosize:destroy",destroy,!1),"onpropertychange"in ta&&"oninput"in ta&&ta.addEventListener("keyup",update,!1),window.addEventListener("resize",pageResize,!1),ta.addEventListener("input",update,!1),ta.addEventListener("autosize:update",update,!1),ta.style.overflowX="hidden",ta.style.wordWrap="break-word",map.set(ta,{destroy:destroy,update:update}),function(){var style=window.getComputedStyle(ta,null);"vertical"===style.resize?ta.style.resize="none":"both"===style.resize&&(ta.style.resize="horizontal"),heightOffset="content-box"===style.boxSizing?-(parseFloat(style.paddingTop)+parseFloat(style.paddingBottom)):parseFloat(style.borderTopWidth)+parseFloat(style.borderBottomWidth),isNaN(heightOffset)&&(heightOffset=0),update()}()}}function destroy(ta){var methods=map.get(ta);methods&&methods.destroy()}function update(ta){var methods=map.get(ta);methods&&methods.update()}var autosize=null;"undefined"==typeof window||"function"!=typeof window.getComputedStyle?(autosize=function(el){return el},autosize.destroy=function(el){return el},autosize.update=function(el){return el}):(autosize=function(el,options){return el&&Array.prototype.forEach.call(el.length?el:[el],function(x){return assign(x)}),el},autosize.destroy=function(el){return el&&Array.prototype.forEach.call(el.length?el:[el],destroy),el},autosize.update=function(el){return el&&Array.prototype.forEach.call(el.length?el:[el],update),el}),exports.default=autosize,module.exports=exports.default});function PointerEventsPolyfill(options){if(this.options={selector:"*",cancel:"",mouseEvents:["click","dblclick","mousedown","mouseup"],usePolyfillIf:function(){if("Microsoft Internet Explorer"==navigator.appName){if(null!=navigator.userAgent.match(/MSIE ([0-9]{1,}[\.0-9]{0,})/)){if(parseFloat(RegExp.$1)<11)return!0}}return!1}},options){var obj=this;$.each(options,function(k,v){obj.options[k]=v})}this.options.usePolyfillIf()&&this.register_mouse_events()}PointerEventsPolyfill.initialize=function(options){return null==PointerEventsPolyfill.singleton&&(PointerEventsPolyfill.singleton=new PointerEventsPolyfill(options)),PointerEventsPolyfill.singleton},PointerEventsPolyfill.prototype.register_mouse_events=function(){$(document).on(this.options.mouseEvents.join(" "),this.options.selector,{cancel:this.options.cancel},function(e){if(e.originalEvent&&$(e.originalEvent.srcElement).closest(e.data.cancel).length>0)return!0;if("none"==$(this).css("pointer-events")){var origDisplayAttribute=$(this).css("display");$(this).css("display","none");var underneathElem=document.elementFromPoint(e.clientX,e.clientY);return origDisplayAttribute?$(this).css("display",origDisplayAttribute):$(this).css("display",""),e.target=underneathElem,$(underneathElem).trigger(e),!1}return!0})},function(){if(void 0===window.performance&&(window.performance={}),!window.performance.now){var nowOffset=Date.now();performance.timing&&performance.timing.navigationStart&&(nowOffset=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-nowOffset}}}(),function(){Math.sign=Math.sign||function(x){return x=+x,0===x||isNaN(x)?x:x>0?1:-1}}(),function($){"use strict";var Modal=function(element,options){this.options=options,this.$element=$(element).delegate('[data-dismiss="modal"]',"click.dismiss.modal",$.proxy(this.hide,this)),this.options.remote&&this.$element.find(".modal-body").load(this.options.remote)};Modal.prototype={constructor:Modal,toggle:function(){return this[this.isShown?"hide":"show"]()},show:function(){var that=this,e=$.Event("show");this.$element.trigger(e),this.isShown||e.isDefaultPrevented()||(this.isShown=!0,this.escape(),this.backdrop(function(){var transition=$.support.transition&&that.$element.hasClass("fade");that.$element.parent().length||that.$element.appendTo(document.body),that.$element.show(),transition&&that.$element[0].offsetWidth,that.$element.addClass("in").attr("aria-hidden",!1),that.enforceFocus(),transition?that.$element.one($.support.transition.end,function(){that.$element.focus().trigger("shown")}):that.$element.focus().trigger("shown")}))},hide:function(e){e&&e.preventDefault();e=$.Event("hide"),this.$element.trigger(e),this.isShown&&!e.isDefaultPrevented()&&(this.isShown=!1,this.escape(),$(document).off("focusin.modal"),this.$element.removeClass("in").attr("aria-hidden",!0),$.support.transition&&this.$element.hasClass("fade")?this.hideWithTransition():this.hideModal())},enforceFocus:function(){var that=this;$(document).on("focusin.modal",function(e){that.$element[0]===e.target||that.$element.has(e.target).length||that.$element.focus()})},escape:function(){var that=this;this.isShown&&this.options.keyboard?this.$element.on("keyup.dismiss.modal",function(e){27==e.which&&that.hide()}):this.isShown||this.$element.off("keyup.dismiss.modal")},hideWithTransition:function(){var that=this,timeout=setTimeout(function(){that.$element.off($.support.transition.end),that.hideModal()},500);this.$element.one($.support.transition.end,function(){clearTimeout(timeout),that.hideModal()})},hideModal:function(){var that=this;this.$element.hide(),this.backdrop(function(){that.removeBackdrop(),that.$element.trigger("hidden")})},removeBackdrop:function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},backdrop:function(callback){var animate=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var doAnimate=$.support.transition&&animate;if(this.$backdrop=$('<div class="modal-backdrop '+animate+'" />').appendTo(document.body),this.$backdrop.click("static"==this.options.backdrop?$.proxy(this.$element[0].focus,this.$element[0]):$.proxy(this.hide,this)),doAnimate&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!callback)return;doAnimate?this.$backdrop.one($.support.transition.end,callback):callback()}else!this.isShown&&this.$backdrop?(this.$backdrop.removeClass("in"),$.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one($.support.transition.end,callback):callback()):callback&&callback()}};var old=$.fn.modal;$.fn.modal=function(option){return this.each(function(){var $this=$(this),data=$this.data("modal"),options=$.extend({},$.fn.modal.defaults,$this.data(),"object"==typeof option&&option);data||$this.data("modal",data=new Modal(this,options)),"string"==typeof option?data[option]():options.show&&data.show()})},$.fn.modal.defaults={backdrop:!0,keyboard:!0,show:!0},$.fn.modal.Constructor=Modal,$.fn.modal.noConflict=function(){return $.fn.modal=old,this},$(document).on("click.modal.data-api",'[data-toggle="modal"]',function(e){var $this=$(this),href=$this.attr("href"),$target=$($this.attr("data-target")||href&&href.replace(/.*(?=#[^\s]+$)/,"")),option=$target.data("modal")?"toggle":$.extend({remote:!/#/.test(href)&&href},$target.data(),$this.data());e.preventDefault(),$target.modal(option).one("hide",function(){$this.focus()})})}(window.jQuery),function(a,b,c,d){"use strict";function e(a,b,c){return setTimeout(j(a,c),b)}function f(a,b,c){return!!Array.isArray(a)&&(g(a,c[b],c),!0)}function g(a,b,c){var e;if(a)if(a.forEach)a.forEach(b,c);else if(a.length!==d)for(e=0;e<a.length;)b.call(c,a[e],e,a),e++;else for(e in a)a.hasOwnProperty(e)&&b.call(c,a[e],e,a)}function h(b,c,d){var e="DEPRECATED METHOD: "+c+"\n"+d+" AT \n";return function(){var c=new Error("get-stack-trace"),d=c&&c.stack?c.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",f=a.console&&(a.console.warn||a.console.log);return f&&f.call(a.console,e,d),b.apply(this,arguments)}}function i(a,b,c){var d,e=b.prototype;d=a.prototype=Object.create(e),d.constructor=a,d._super=e,c&&la(d,c)}function j(a,b){return function(){return a.apply(b,arguments)}}function k(a,b){return typeof a==oa?a.apply(b?b[0]||d:d,b):a}function l(a,b){return a===d?b:a}function m(a,b,c){g(q(b),function(b){a.addEventListener(b,c,!1)})}function n(a,b,c){g(q(b),function(b){a.removeEventListener(b,c,!1)})}function o(a,b){for(;a;){if(a==b)return!0;a=a.parentNode}return!1}function p(a,b){return a.indexOf(b)>-1}function q(a){return a.trim().split(/\s+/g)}function r(a,b,c){if(a.indexOf&&!c)return a.indexOf(b);for(var d=0;d<a.length;){if(c&&a[d][c]==b||!c&&a[d]===b)return d;d++}return-1}function s(a){return Array.prototype.slice.call(a,0)}function t(a,b,c){for(var d=[],e=[],f=0;f<a.length;){var g=b?a[f][b]:a[f];r(e,g)<0&&d.push(a[f]),e[f]=g,f++}return c&&(d=b?d.sort(function(a,c){return a[b]>c[b]}):d.sort()),d}function u(a,b){for(var c,e,f=b[0].toUpperCase()+b.slice(1),g=0;g<ma.length;){if(c=ma[g],(e=c?c+f:b)in a)return e;g++}return d}function v(){return ua++}function w(b){var c=b.ownerDocument||b;return c.defaultView||c.parentWindow||a}function x(a,b){var c=this;this.manager=a,this.callback=b,this.element=a.element,this.target=a.options.inputTarget,this.domHandler=function(b){k(a.options.enable,[a])&&c.handler(b)},this.init()}function y(a){var c=a.options.inputClass;return new(c||(xa?M:ya?P:wa?R:L))(a,z)}function z(a,b,c){var d=c.pointers.length,e=c.changedPointers.length,f=b&Ea&&d-e==0,g=b&(Ga|Ha)&&d-e==0;c.isFirst=!!f,c.isFinal=!!g,f&&(a.session={}),c.eventType=b,A(a,c),a.emit("hammer.input",c),a.recognize(c),a.session.prevInput=c}function A(a,b){var c=a.session,d=b.pointers,e=d.length;c.firstInput||(c.firstInput=D(b)),e>1&&!c.firstMultiple?c.firstMultiple=D(b):1===e&&(c.firstMultiple=!1);var f=c.firstInput,g=c.firstMultiple,h=g?g.center:f.center,i=b.center=E(d);b.timeStamp=ra(),b.deltaTime=b.timeStamp-f.timeStamp,b.angle=I(h,i),b.distance=H(h,i),B(c,b),b.offsetDirection=G(b.deltaX,b.deltaY);var j=F(b.deltaTime,b.deltaX,b.deltaY);b.overallVelocityX=j.x,b.overallVelocityY=j.y,b.overallVelocity=qa(j.x)>qa(j.y)?j.x:j.y,b.scale=g?K(g.pointers,d):1,b.rotation=g?J(g.pointers,d):0,b.maxPointers=c.prevInput?b.pointers.length>c.prevInput.maxPointers?b.pointers.length:c.prevInput.maxPointers:b.pointers.length,C(c,b);var k=a.element;o(b.srcEvent.target,k)&&(k=b.srcEvent.target),b.target=k}function B(a,b){var c=b.center,d=a.offsetDelta||{},e=a.prevDelta||{},f=a.prevInput||{};b.eventType!==Ea&&f.eventType!==Ga||(e=a.prevDelta={x:f.deltaX||0,y:f.deltaY||0},d=a.offsetDelta={x:c.x,y:c.y}),b.deltaX=e.x+(c.x-d.x),b.deltaY=e.y+(c.y-d.y)}function C(a,b){var c,e,f,g,h=a.lastInterval||b,i=b.timeStamp-h.timeStamp;if(b.eventType!=Ha&&(i>Da||h.velocity===d)){var j=b.deltaX-h.deltaX,k=b.deltaY-h.deltaY,l=F(i,j,k);e=l.x,f=l.y,c=qa(l.x)>qa(l.y)?l.x:l.y,g=G(j,k),a.lastInterval=b}else c=h.velocity,e=h.velocityX,f=h.velocityY,g=h.direction;b.velocity=c,b.velocityX=e,b.velocityY=f,b.direction=g}function D(a){for(var b=[],c=0;c<a.pointers.length;)b[c]={clientX:pa(a.pointers[c].clientX),clientY:pa(a.pointers[c].clientY)},c++;return{timeStamp:ra(),pointers:b,center:E(b),deltaX:a.deltaX,deltaY:a.deltaY}}function E(a){var b=a.length;if(1===b)return{x:pa(a[0].clientX),y:pa(a[0].clientY)};for(var c=0,d=0,e=0;b>e;)c+=a[e].clientX,d+=a[e].clientY,e++;return{x:pa(c/b),y:pa(d/b)}}function F(a,b,c){return{x:b/a||0,y:c/a||0}}function G(a,b){return a===b?Ia:qa(a)>=qa(b)?0>a?Ja:Ka:0>b?La:Ma}function H(a,b,c){c||(c=Qa);var d=b[c[0]]-a[c[0]],e=b[c[1]]-a[c[1]];return Math.sqrt(d*d+e*e)}function I(a,b,c){c||(c=Qa);var d=b[c[0]]-a[c[0]],e=b[c[1]]-a[c[1]];return 180*Math.atan2(e,d)/Math.PI}function J(a,b){return I(b[1],b[0],Ra)+I(a[1],a[0],Ra)}function K(a,b){return H(b[0],b[1],Ra)/H(a[0],a[1],Ra)}function L(){this.evEl=Ta,this.evWin=Ua,this.pressed=!1,x.apply(this,arguments)}function M(){this.evEl=Xa,this.evWin=Ya,x.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}function N(){this.evTarget=$a,this.evWin=_a,this.started=!1,x.apply(this,arguments)}function O(a,b){var c=s(a.touches),d=s(a.changedTouches);return b&(Ga|Ha)&&(c=t(c.concat(d),"identifier",!0)),[c,d]}function P(){this.evTarget=bb,this.targetIds={},x.apply(this,arguments)}function Q(a,b){var c=s(a.touches),d=this.targetIds;if(b&(Ea|Fa)&&1===c.length)return d[c[0].identifier]=!0,[c,c];var e,f,g=s(a.changedTouches),h=[],i=this.target;if(f=c.filter(function(a){return o(a.target,i)}),b===Ea)for(e=0;e<f.length;)d[f[e].identifier]=!0,e++;for(e=0;e<g.length;)d[g[e].identifier]&&h.push(g[e]),b&(Ga|Ha)&&delete d[g[e].identifier],e++;return h.length?[t(f.concat(h),"identifier",!0),h]:void 0}function R(){x.apply(this,arguments);var a=j(this.handler,this);this.touch=new P(this.manager,a),this.mouse=new L(this.manager,a),this.primaryTouch=null,this.lastTouches=[]}function S(a,b){a&Ea?(this.primaryTouch=b.changedPointers[0].identifier,T.call(this,b)):a&(Ga|Ha)&&T.call(this,b)}function T(a){var b=a.changedPointers[0];if(b.identifier===this.primaryTouch){var c={x:b.clientX,y:b.clientY};this.lastTouches.push(c);var d=this.lastTouches,e=function(){var a=d.indexOf(c);a>-1&&d.splice(a,1)};setTimeout(e,cb)}}function U(a){for(var b=a.srcEvent.clientX,c=a.srcEvent.clientY,d=0;d<this.lastTouches.length;d++){var e=this.lastTouches[d],f=Math.abs(b-e.x),g=Math.abs(c-e.y);if(db>=f&&db>=g)return!0}return!1}function V(a,b){this.manager=a,this.set(b)}function W(a){if(p(a,jb))return jb;var b=p(a,kb),c=p(a,lb);return b&&c?jb:b||c?b?kb:lb:p(a,ib)?ib:hb}function Y(a){this.options=la({},this.defaults,a||{}),this.id=v(),this.manager=null,this.options.enable=l(this.options.enable,!0),this.state=nb,this.simultaneous={},this.requireFail=[]}function Z(a){return a&sb?"cancel":a&qb?"end":a&pb?"move":a&ob?"start":""}function $(a){return a==Ma?"down":a==La?"up":a==Ja?"left":a==Ka?"right":""}function _(a,b){var c=b.manager;return c?c.get(a):a}function aa(){Y.apply(this,arguments)}function ba(){aa.apply(this,arguments),this.pX=null,this.pY=null}function ca(){aa.apply(this,arguments)}function da(){Y.apply(this,arguments),this._timer=null,this._input=null}function ea(){aa.apply(this,arguments)}function fa(){aa.apply(this,arguments)}function ga(){Y.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function ha(a,b){return b=b||{},b.recognizers=l(b.recognizers,ha.defaults.preset),new ia(a,b)}function ia(a,b){this.options=la({},ha.defaults,b||{}),this.options.inputTarget=this.options.inputTarget||a,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=a,this.input=y(this),this.touchAction=new V(this,this.options.touchAction),ja(this,!0),g(this.options.recognizers,function(a){var b=this.add(new a[0](a[1]));a[2]&&b.recognizeWith(a[2]),a[3]&&b.requireFailure(a[3])},this)}function ja(a,b){var c=a.element;if(c.style){var d;g(a.options.cssProps,function(e,f){d=u(c.style,f),b?(a.oldCssProps[d]=c.style[d],c.style[d]=e):c.style[d]=a.oldCssProps[d]||""}),b||(a.oldCssProps={})}}function ka(a,c){var d=b.createEvent("Event");d.initEvent(a,!0,!0),d.gesture=c,c.target.dispatchEvent(d)}var la,ma=["","webkit","Moz","MS","ms","o"],na=b.createElement("div"),oa="function",pa=Math.round,qa=Math.abs,ra=Date.now;la="function"!=typeof Object.assign?function(a){if(a===d||null===a)throw new TypeError("Cannot convert undefined or null to object");for(var b=Object(a),c=1;c<arguments.length;c++){var e=arguments[c];if(e!==d&&null!==e)for(var f in e)e.hasOwnProperty(f)&&(b[f]=e[f])}return b}:Object.assign;var sa=h(function(a,b,c){for(var e=Object.keys(b),f=0;f<e.length;)(!c||c&&a[e[f]]===d)&&(a[e[f]]=b[e[f]]),f++;return a},"extend","Use `assign`."),ta=h(function(a,b){return sa(a,b,!0)},"merge","Use `assign`."),ua=1,va=/mobile|tablet|ip(ad|hone|od)|android/i,wa="ontouchstart"in a,xa=u(a,"PointerEvent")!==d,ya=wa&&va.test(navigator.userAgent),za="touch",Ba="mouse",Da=25,Ea=1,Fa=2,Ga=4,Ha=8,Ia=1,Ja=2,Ka=4,La=8,Ma=16,Na=Ja|Ka,Oa=La|Ma,Pa=Na|Oa,Qa=["x","y"],Ra=["clientX","clientY"];x.prototype={handler:function(){},init:function(){this.evEl&&m(this.element,this.evEl,this.domHandler),this.evTarget&&m(this.target,this.evTarget,this.domHandler),this.evWin&&m(w(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&n(this.element,this.evEl,this.domHandler),this.evTarget&&n(this.target,this.evTarget,this.domHandler),this.evWin&&n(w(this.element),this.evWin,this.domHandler)}};var Sa={mousedown:Ea,mousemove:Fa,mouseup:Ga},Ta="mousedown",Ua="mousemove mouseup";i(L,x,{handler:function(a){var b=Sa[a.type];b&Ea&&0===a.button&&(this.pressed=!0),b&Fa&&1!==a.which&&(b=Ga),this.pressed&&(b&Ga&&(this.pressed=!1),this.callback(this.manager,b,{pointers:[a],changedPointers:[a],pointerType:Ba,srcEvent:a}))}});var Va={pointerdown:Ea,pointermove:Fa,pointerup:Ga,pointercancel:Ha,pointerout:Ha},Wa={2:za,3:"pen",4:Ba,5:"kinect"},Xa="pointerdown",Ya="pointermove pointerup pointercancel";a.MSPointerEvent&&!a.PointerEvent&&(Xa="MSPointerDown",Ya="MSPointerMove MSPointerUp MSPointerCancel"),i(M,x,{handler:function(a){var b=this.store,c=!1,d=a.type.toLowerCase().replace("ms",""),e=Va[d],f=Wa[a.pointerType]||a.pointerType,g=f==za,h=r(b,a.pointerId,"pointerId");e&Ea&&(0===a.button||g)?0>h&&(b.push(a),h=b.length-1):e&(Ga|Ha)&&(c=!0),0>h||(b[h]=a,this.callback(this.manager,e,{pointers:b,changedPointers:[a],pointerType:f,srcEvent:a}),c&&b.splice(h,1))}});var Za={touchstart:Ea,touchmove:Fa,touchend:Ga,touchcancel:Ha},$a="touchstart",_a="touchstart touchmove touchend touchcancel";i(N,x,{handler:function(a){var b=Za[a.type];if(b===Ea&&(this.started=!0),this.started){var c=O.call(this,a,b);b&(Ga|Ha)&&c[0].length-c[1].length==0&&(this.started=!1),this.callback(this.manager,b,{pointers:c[0],changedPointers:c[1],pointerType:za,srcEvent:a})}}});var ab={touchstart:Ea,touchmove:Fa,touchend:Ga,touchcancel:Ha},bb="touchstart touchmove touchend touchcancel";i(P,x,{handler:function(a){var b=ab[a.type],c=Q.call(this,a,b);c&&this.callback(this.manager,b,{pointers:c[0],changedPointers:c[1],pointerType:za,srcEvent:a})}});var cb=2500,db=25;i(R,x,{handler:function(a,b,c){var d=c.pointerType==za,e=c.pointerType==Ba;if(!(e&&c.sourceCapabilities&&c.sourceCapabilities.firesTouchEvents)){if(d)S.call(this,b,c);else if(e&&U.call(this,c))return;this.callback(a,b,c)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var eb=u(na.style,"touchAction"),fb=eb!==d,gb="compute",hb="auto",ib="manipulation",jb="none",kb="pan-x",lb="pan-y",mb=function(){if(!fb)return!1;var b={},c=a.CSS&&a.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(d){b[d]=!c||a.CSS.supports("touch-action",d)}),b}();V.prototype={set:function(a){a==gb&&(a=this.compute()),fb&&this.manager.element.style&&mb[a]&&(this.manager.element.style[eb]=a),this.actions=a.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var a=[];return g(this.manager.recognizers,function(b){k(b.options.enable,[b])&&(a=a.concat(b.getTouchAction()))}),W(a.join(" "))},preventDefaults:function(a){var b=a.srcEvent,c=a.offsetDirection;if(this.manager.session.prevented)return void b.preventDefault();var d=this.actions,e=p(d,jb)&&!mb[jb],f=p(d,lb)&&!mb[lb],g=p(d,kb)&&!mb[kb];if(e){var h=1===a.pointers.length,i=a.distance<2,j=a.deltaTime<250;if(h&&i&&j)return}return g&&f?void 0:e||f&&c&Na||g&&c&Oa?this.preventSrc(b):void 0},preventSrc:function(a){this.manager.session.prevented=!0,a.preventDefault()}};var nb=1,ob=2,pb=4,qb=8,rb=qb,sb=16;Y.prototype={defaults:{},set:function(a){return la(this.options,a),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(a){if(f(a,"recognizeWith",this))return this;var b=this.simultaneous;return a=_(a,this),b[a.id]||(b[a.id]=a,a.recognizeWith(this)),this},dropRecognizeWith:function(a){return f(a,"dropRecognizeWith",this)?this:(a=_(a,this),delete this.simultaneous[a.id],this)},requireFailure:function(a){if(f(a,"requireFailure",this))return this;var b=this.requireFail;return a=_(a,this),-1===r(b,a)&&(b.push(a),a.requireFailure(this)),this},dropRequireFailure:function(a){if(f(a,"dropRequireFailure",this))return this;a=_(a,this);var b=r(this.requireFail,a);return b>-1&&this.requireFail.splice(b,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(a){return!!this.simultaneous[a.id]},emit:function(a){function b(b){c.manager.emit(b,a)}var c=this,d=this.state;qb>d&&b(c.options.event+Z(d)),b(c.options.event),a.additionalEvent&&b(a.additionalEvent),d>=qb&&b(c.options.event+Z(d))},tryEmit:function(a){return this.canEmit()?this.emit(a):void(this.state=32)},canEmit:function(){for(var a=0;a<this.requireFail.length;){if(!(this.requireFail[a].state&(32|nb)))return!1;a++}return!0},recognize:function(a){var b=la({},a);return k(this.options.enable,[this,b])?(this.state&(rb|sb|32)&&(this.state=nb),this.state=this.process(b),void(this.state&(ob|pb|qb|sb)&&this.tryEmit(b))):(this.reset(),void(this.state=32))},process:function(a){},getTouchAction:function(){},reset:function(){}},i(aa,Y,{defaults:{pointers:1},attrTest:function(a){var b=this.options.pointers;return 0===b||a.pointers.length===b},process:function(a){var b=this.state,c=a.eventType,d=b&(ob|pb),e=this.attrTest(a);return d&&(c&Ha||!e)?b|sb:d||e?c&Ga?b|qb:b&ob?b|pb:ob:32}}),i(ba,aa,{defaults:{event:"pan",threshold:10,pointers:1,direction:Pa},getTouchAction:function(){var a=this.options.direction,b=[];return a&Na&&b.push(lb),a&Oa&&b.push(kb),b},directionTest:function(a){var b=this.options,c=!0,d=a.distance,e=a.direction,f=a.deltaX,g=a.deltaY;return e&b.direction||(b.direction&Na?(e=0===f?Ia:0>f?Ja:Ka,c=f!=this.pX,d=Math.abs(a.deltaX)):(e=0===g?Ia:0>g?La:Ma,c=g!=this.pY,d=Math.abs(a.deltaY))),a.direction=e,c&&d>b.threshold&&e&b.direction},attrTest:function(a){return aa.prototype.attrTest.call(this,a)&&(this.state&ob||!(this.state&ob)&&this.directionTest(a))},emit:function(a){this.pX=a.deltaX,this.pY=a.deltaY;var b=$(a.direction);b&&(a.additionalEvent=this.options.event+b),this._super.emit.call(this,a)}}),i(ca,aa,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[jb]},attrTest:function(a){return this._super.attrTest.call(this,a)&&(Math.abs(a.scale-1)>this.options.threshold||this.state&ob)},emit:function(a){if(1!==a.scale){var b=a.scale<1?"in":"out";a.additionalEvent=this.options.event+b}this._super.emit.call(this,a)}}),i(da,Y,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[hb]},process:function(a){var b=this.options,c=a.pointers.length===b.pointers,d=a.distance<b.threshold,f=a.deltaTime>b.time;if(this._input=a,!d||!c||a.eventType&(Ga|Ha)&&!f)this.reset();else if(a.eventType&Ea)this.reset(),this._timer=e(function(){this.state=rb,this.tryEmit()},b.time,this);else if(a.eventType&Ga)return rb;return 32},reset:function(){clearTimeout(this._timer)},emit:function(a){this.state===rb&&(a&&a.eventType&Ga?this.manager.emit(this.options.event+"up",a):(this._input.timeStamp=ra(),this.manager.emit(this.options.event,this._input)))}}),i(ea,aa,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[jb]},attrTest:function(a){return this._super.attrTest.call(this,a)&&(Math.abs(a.rotation)>this.options.threshold||this.state&ob)}}),i(fa,aa,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:Na|Oa,pointers:1},getTouchAction:function(){return ba.prototype.getTouchAction.call(this)},attrTest:function(a){var b,c=this.options.direction;return c&(Na|Oa)?b=a.overallVelocity:c&Na?b=a.overallVelocityX:c&Oa&&(b=a.overallVelocityY),this._super.attrTest.call(this,a)&&c&a.offsetDirection&&a.distance>this.options.threshold&&a.maxPointers==this.options.pointers&&qa(b)>this.options.velocity&&a.eventType&Ga},emit:function(a){var b=$(a.offsetDirection);b&&this.manager.emit(this.options.event+b,a),this.manager.emit(this.options.event,a)}}),i(ga,Y,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[ib]},process:function(a){var b=this.options,c=a.pointers.length===b.pointers,d=a.distance<b.threshold,f=a.deltaTime<b.time;if(this.reset(),a.eventType&Ea&&0===this.count)return this.failTimeout();if(d&&f&&c){if(a.eventType!=Ga)return this.failTimeout();var g=!this.pTime||a.timeStamp-this.pTime<b.interval,h=!this.pCenter||H(this.pCenter,a.center)<b.posThreshold;this.pTime=a.timeStamp,this.pCenter=a.center,h&&g?this.count+=1:this.count=1,this._input=a;if(0===this.count%b.taps)return this.hasRequireFailures()?(this._timer=e(function(){this.state=rb,this.tryEmit()},b.interval,this),ob):rb}return 32},failTimeout:function(){return this._timer=e(function(){this.state=32},this.options.interval,this),32},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==rb&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),ha.VERSION="2.0.8",ha.defaults={domEvents:!1,touchAction:gb,enable:!0,inputTarget:null,inputClass:null,preset:[[ea,{enable:!1}],[ca,{enable:!1},["rotate"]],[fa,{direction:Na}],[ba,{direction:Na},["swipe"]],[ga],[ga,{event:"doubletap",taps:2},["tap"]],[da]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};ia.prototype={set:function(a){return la(this.options,a),a.touchAction&&this.touchAction.update(),a.inputTarget&&(this.input.destroy(),this.input.target=a.inputTarget,this.input.init()),this},stop:function(a){this.session.stopped=a?2:1},recognize:function(a){var b=this.session;if(!b.stopped){this.touchAction.preventDefaults(a);var c,d=this.recognizers,e=b.curRecognizer;(!e||e&&e.state&rb)&&(e=b.curRecognizer=null);for(var f=0;f<d.length;)c=d[f],2===b.stopped||e&&c!=e&&!c.canRecognizeWith(e)?c.reset():c.recognize(a),!e&&c.state&(ob|pb|qb)&&(e=b.curRecognizer=c),f++}},get:function(a){if(a instanceof Y)return a;for(var b=this.recognizers,c=0;c<b.length;c++)if(b[c].options.event==a)return b[c];return null},add:function(a){if(f(a,"add",this))return this;var b=this.get(a.options.event);return b&&this.remove(b),this.recognizers.push(a),a.manager=this,this.touchAction.update(),a},remove:function(a){if(f(a,"remove",this))return this;if(a=this.get(a)){var b=this.recognizers,c=r(b,a);-1!==c&&(b.splice(c,1),this.touchAction.update())}return this},on:function(a,b){if(a!==d&&b!==d){var c=this.handlers;return g(q(a),function(a){c[a]=c[a]||[],c[a].push(b)}),this}},off:function(a,b){if(a!==d){var c=this.handlers;return g(q(a),function(a){b?c[a]&&c[a].splice(r(c[a],b),1):delete c[a]}),this}},emit:function(a,b){this.options.domEvents&&ka(a,b);var c=this.handlers[a]&&this.handlers[a].slice();if(c&&c.length){b.type=a,b.preventDefault=function(){b.srcEvent.preventDefault()};for(var d=0;d<c.length;)c[d](b),d++}},destroy:function(){this.element&&ja(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},la(ha,{INPUT_START:Ea,INPUT_MOVE:Fa,INPUT_END:Ga,INPUT_CANCEL:Ha,STATE_POSSIBLE:nb,STATE_BEGAN:ob,STATE_CHANGED:pb,STATE_ENDED:qb,STATE_RECOGNIZED:rb,STATE_CANCELLED:sb,STATE_FAILED:32,DIRECTION_NONE:Ia,DIRECTION_LEFT:Ja,DIRECTION_RIGHT:Ka,DIRECTION_UP:La,DIRECTION_DOWN:Ma,DIRECTION_HORIZONTAL:Na,DIRECTION_VERTICAL:Oa,DIRECTION_ALL:Pa,Manager:ia,Input:x,TouchAction:V,
TouchInput:P,MouseInput:L,PointerEventInput:M,TouchMouseInput:R,SingleTouchInput:N,Recognizer:Y,AttrRecognizer:aa,Tap:ga,Pan:ba,Swipe:fa,Pinch:ca,Rotate:ea,Press:da,on:m,off:n,each:g,merge:ta,extend:sa,assign:la,inherit:i,bindFn:j,prefixed:u}),(void 0!==a?a:"undefined"!=typeof self?self:{}).Hammer=ha,"function"==typeof define&&define.amd?define(function(){return ha}):"undefined"!=typeof module&&module.exports?module.exports=ha:a.Hammer=ha}(window,document),function(factory){"function"==typeof define&&define.amd?define(["jquery","hammerjs"],factory):"object"==typeof exports?factory(require("jquery"),require("hammerjs")):factory(jQuery,Hammer)}(function($,Hammer){function hammerify(el,options){var $el=$(el);$el.data("hammer")||$el.data("hammer",new Hammer($el[0],options))}$.fn.hammer=function(options){return this.each(function(){hammerify(this,options)})},Hammer.Manager.prototype.emit=function(originalEmit){return function(type,data){originalEmit.call(this,type,data),$(this.element).trigger({type:type,gesture:data})}}(Hammer.Manager.prototype.emit)}),function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):"object"==typeof exports?module.exports=factory:factory(jQuery)}(function($){var nullLowestDeltaTimeout,lowestDelta,toFix=["wheel","mousewheel","DOMMouseScroll","MozMousePixelScroll"],toBind="onwheel"in document||document.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"],slice=Array.prototype.slice;if($.event.fixHooks)for(var i=toFix.length;i;)$.event.fixHooks[toFix[--i]]=$.event.mouseHooks;var special=$.event.special.mousewheel={version:"3.1.12",setup:function(){if(this.addEventListener)for(var i=toBind.length;i;)this.addEventListener(toBind[--i],handler,!1);else this.onmousewheel=handler;$.data(this,"mousewheel-line-height",special.getLineHeight(this)),$.data(this,"mousewheel-page-height",special.getPageHeight(this))},teardown:function(){if(this.removeEventListener)for(var i=toBind.length;i;)this.removeEventListener(toBind[--i],handler,!1);else this.onmousewheel=null;$.removeData(this,"mousewheel-line-height"),$.removeData(this,"mousewheel-page-height")},getLineHeight:function(elem){var $elem=$(elem),$parent=$elem["offsetParent"in $.fn?"offsetParent":"parent"]();return $parent.length||($parent=$("body")),parseInt($parent.css("fontSize"),10)||parseInt($elem.css("fontSize"),10)||16},getPageHeight:function(elem){return $(elem).height()},settings:{adjustOldDeltas:!0,normalizeOffset:!0}};$.fn.extend({mousewheel:function(fn){return fn?this.bind("mousewheel",fn):this.trigger("mousewheel")},unmousewheel:function(fn){return this.unbind("mousewheel",fn)}});function handler(event){var orgEvent=event||window.event,args=slice.call(arguments,1),delta=0,deltaX=0,deltaY=0,absDelta=0,offsetX=0,offsetY=0;if(event=$.event.fix(orgEvent),event.type="mousewheel","detail"in orgEvent&&(deltaY=-1*orgEvent.detail),"wheelDelta"in orgEvent&&(deltaY=orgEvent.wheelDelta),"wheelDeltaY"in orgEvent&&(deltaY=orgEvent.wheelDeltaY),"wheelDeltaX"in orgEvent&&(deltaX=-1*orgEvent.wheelDeltaX),"axis"in orgEvent&&orgEvent.axis===orgEvent.HORIZONTAL_AXIS&&(deltaX=-1*deltaY,deltaY=0),delta=0===deltaY?deltaX:deltaY,"deltaY"in orgEvent&&(deltaY=-1*orgEvent.deltaY,delta=deltaY),"deltaX"in orgEvent&&(deltaX=orgEvent.deltaX,0===deltaY&&(delta=-1*deltaX)),0!==deltaY||0!==deltaX){if(1===orgEvent.deltaMode){var lineHeight=$.data(this,"mousewheel-line-height");delta*=lineHeight,deltaY*=lineHeight,deltaX*=lineHeight}else if(2===orgEvent.deltaMode){var pageHeight=$.data(this,"mousewheel-page-height");delta*=pageHeight,deltaY*=pageHeight,deltaX*=pageHeight}if(absDelta=Math.max(Math.abs(deltaY),Math.abs(deltaX)),(!lowestDelta||absDelta<lowestDelta)&&(lowestDelta=absDelta,shouldAdjustOldDeltas(orgEvent,absDelta)&&(lowestDelta/=40)),shouldAdjustOldDeltas(orgEvent,absDelta)&&(delta/=40,deltaX/=40,deltaY/=40),delta=Math[delta>=1?"floor":"ceil"](delta/lowestDelta),deltaX=Math[deltaX>=1?"floor":"ceil"](deltaX/lowestDelta),deltaY=Math[deltaY>=1?"floor":"ceil"](deltaY/lowestDelta),special.settings.normalizeOffset&&this.getBoundingClientRect){var boundingRect=this.getBoundingClientRect();offsetX=event.clientX-boundingRect.left,offsetY=event.clientY-boundingRect.top}return event.deltaX=deltaX,event.deltaY=deltaY,event.deltaFactor=lowestDelta,event.offsetX=offsetX,event.offsetY=offsetY,event.deltaMode=0,args.unshift(event,delta,deltaX,deltaY),nullLowestDeltaTimeout&&clearTimeout(nullLowestDeltaTimeout),nullLowestDeltaTimeout=setTimeout(nullLowestDelta,200),($.event.dispatch||$.event.handle).apply(this,args)}}function nullLowestDelta(){lowestDelta=null}function shouldAdjustOldDeltas(orgEvent,absDelta){return special.settings.adjustOldDeltas&&"mousewheel"===orgEvent.type&&absDelta%120==0}}),function(b){var x=/(^|["'(\s]|&lt;)(www\..+?\..+?)((?:[:?]|\.+)?(?:\s|$)|&gt;|[)"',])/g,y=/(^|["'(\s]|&lt;)((?:(?:https?|ftp):\/\/|mailto:).+?)((?:[:?]|\.+)?(?:\s|$)|&gt;|[)"',])/g,z=function(h){return h.replace(x,'$1<a href="<``>://$2">$2</a>$3').replace(y,'$1<a href="$2">$2</a>$3').replace(/"<``>/g,'"http')},s=b.fn.linkify=function(c){b.isPlainObject(c)||(c={use:"string"==typeof c?c:void 0,handleLinks:b.isFunction(c)?c:arguments[1]});var f,d=c.use,k=s.plugins||{},l=[z],m=[],n=c.handleLinks;if(void 0==d||"*"==d)for(var i in k)l.push(k[i]);else{d=b.isArray(d)?d:b.trim(d).split(/ *, */);for(var o,i,p=0,A=d.length;p<A;p++)i=d[p],(o=k[i])&&l.push(o)}return this.each(function(){for(var h=this.childNodes,t=h.length;t--;){var e=h[t];if(3==e.nodeType){var a=e.nodeValue;if(a.length>1&&/\S/.test(a)){var q,r;f=f||b("<div/>")[0],f.innerHTML="",f.appendChild(e.cloneNode(!1));for(var g,u=f.childNodes,v=0;g=l[v];v++)for(var j,w=u.length;w--;)j=u[w],3==j.nodeType&&(a=j.nodeValue,a.length>1&&/\S/.test(a)&&(r=a,a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),a=b.isFunction(g)?g(a):a.replace(g.re,g.tmpl),q=q||r!=a,r!=a&&b(j).after(a).remove()));a=f.innerHTML,n&&(a=b("<div/>").html(a),m=m.concat(a.find("a").toArray().reverse()),a=a.contents()),q&&b(e).after(a).remove()}}else 1!=e.nodeType||/^(a|button|textarea)$/i.test(e.tagName)||arguments.callee.call(e)}}),n&&n(b(m.reverse())),this};s.plugins={mailto:{re:/(^|["'(\s]|&lt;)([^"'(\s&]+?@.+\.[a-z]{2,7})(([:?]|\.+)?(\s|$)|&gt;|[)"',])/gi,tmpl:'$1<a href="mailto:$2">$2</a>$3'}}}(jQuery);function polyfill(){var w=window,d=document;function scrollElement(x,y){this.scrollLeft=x,this.scrollTop=y}function ease(k){return.5*(1-Math.cos(Math.PI*k))}function shouldBailOut(firstArg){if(null===firstArg||"object"!=typeof firstArg||void 0===firstArg.behavior||"auto"===firstArg.behavior||"instant"===firstArg.behavior)return!0;if("object"==typeof firstArg&&"smooth"===firstArg.behavior)return!1;throw new TypeError("behavior member of ScrollOptions "+firstArg.behavior+" is not a valid value for enumeration ScrollBehavior.")}function hasScrollableSpace(el,axis){return"Y"===axis?el.clientHeight+ROUNDING_TOLERANCE<el.scrollHeight:"X"===axis?el.clientWidth+ROUNDING_TOLERANCE<el.scrollWidth:void 0}function canOverflow(el,axis){var overflowValue=w.getComputedStyle(el,null)["overflow"+axis];return"auto"===overflowValue||"scroll"===overflowValue}function isScrollable(el){var isScrollableY=hasScrollableSpace(el,"Y")&&canOverflow(el,"Y"),isScrollableX=hasScrollableSpace(el,"X")&&canOverflow(el,"X");return isScrollableY||isScrollableX}function findScrollableParent(el){var isBody;do{el=el.parentNode,isBody=el===d.body}while(!1===isBody&&!1===isScrollable(el));return isBody=null,el}function step(context){var value,currentX,currentY,time=now(),elapsed=(time-context.startTime)/SCROLL_TIME;elapsed=elapsed>1?1:elapsed,value=ease(elapsed),currentX=context.startX+(context.x-context.startX)*value,currentY=context.startY+(context.y-context.startY)*value,context.method.call(context.scrollable,currentX,currentY),currentX===context.x&&currentY===context.y||w.requestAnimationFrame(step.bind(w,context))}function smoothScroll(el,x,y){var scrollable,startX,startY,method,startTime=now();el===d.body?(scrollable=w,startX=w.scrollX||w.pageXOffset,startY=w.scrollY||w.pageYOffset,method=original.scroll):(scrollable=el,startX=el.scrollLeft,startY=el.scrollTop,method=scrollElement),step({scrollable:scrollable,method:method,startTime:startTime,startX:startX,startY:startY,x:x,y:y})}if(!("scrollBehavior"in d.documentElement.style&&!0!==w.__forceSmoothScrollPolyfill__)){var Element=w.HTMLElement||w.Element,SCROLL_TIME=468,original={scroll:w.scroll||w.scrollTo,scrollBy:w.scrollBy,elementScroll:Element.prototype.scroll||scrollElement,scrollIntoView:Element.prototype.scrollIntoView},now=w.performance&&w.performance.now?w.performance.now.bind(w.performance):Date.now,ROUNDING_TOLERANCE=function(userAgent){var userAgentPatterns=["MSIE ","Trident/","Edge/"];return new RegExp(userAgentPatterns.join("|")).test(userAgent)}(w.navigator.userAgent)?1:0;w.scroll=w.scrollTo=function(){if(void 0!==arguments[0])return!0===shouldBailOut(arguments[0])?void original.scroll.call(w,void 0!==arguments[0].left?arguments[0].left:"object"!=typeof arguments[0]?arguments[0]:w.scrollX||w.pageXOffset,void 0!==arguments[0].top?arguments[0].top:void 0!==arguments[1]?arguments[1]:w.scrollY||w.pageYOffset):void smoothScroll.call(w,d.body,void 0!==arguments[0].left?~~arguments[0].left:w.scrollX||w.pageXOffset,void 0!==arguments[0].top?~~arguments[0].top:w.scrollY||w.pageYOffset)},w.scrollBy=function(){if(void 0!==arguments[0])return shouldBailOut(arguments[0])?void original.scrollBy.call(w,void 0!==arguments[0].left?arguments[0].left:"object"!=typeof arguments[0]?arguments[0]:0,void 0!==arguments[0].top?arguments[0].top:void 0!==arguments[1]?arguments[1]:0):void smoothScroll.call(w,d.body,~~arguments[0].left+(w.scrollX||w.pageXOffset),~~arguments[0].top+(w.scrollY||w.pageYOffset))},Element.prototype.scroll=Element.prototype.scrollTo=function(){if(void 0!==arguments[0]){if(!0===shouldBailOut(arguments[0])){if("number"==typeof arguments[0]&&void 0===arguments[1])throw new SyntaxError("Value could not be converted");return void original.elementScroll.call(this,void 0!==arguments[0].left?~~arguments[0].left:"object"!=typeof arguments[0]?~~arguments[0]:this.scrollLeft,void 0!==arguments[0].top?~~arguments[0].top:void 0!==arguments[1]?~~arguments[1]:this.scrollTop)}var left=arguments[0].left,top=arguments[0].top;smoothScroll.call(this,this,void 0===left?this.scrollLeft:~~left,void 0===top?this.scrollTop:~~top)}},Element.prototype.scrollBy=function(){if(void 0!==arguments[0])return!0===shouldBailOut(arguments[0])?void original.elementScroll.call(this,void 0!==arguments[0].left?~~arguments[0].left+this.scrollLeft:~~arguments[0]+this.scrollLeft,void 0!==arguments[0].top?~~arguments[0].top+this.scrollTop:~~arguments[1]+this.scrollTop):void this.scroll({left:~~arguments[0].left+this.scrollLeft,top:~~arguments[0].top+this.scrollTop,behavior:arguments[0].behavior})},Element.prototype.scrollIntoView=function(){if(!0===shouldBailOut(arguments[0]))return void original.scrollIntoView.call(this,void 0===arguments[0]||arguments[0]);var scrollableParent=findScrollableParent(this),parentRects=scrollableParent.getBoundingClientRect(),clientRects=this.getBoundingClientRect();scrollableParent!==d.body?(smoothScroll.call(this,scrollableParent,scrollableParent.scrollLeft+clientRects.left-parentRects.left,scrollableParent.scrollTop+clientRects.top-parentRects.top),"fixed"!==w.getComputedStyle(scrollableParent).position&&w.scrollBy({left:parentRects.left,top:parentRects.top,behavior:"smooth"})):w.scrollBy({left:clientRects.left,top:clientRects.top,behavior:"smooth"})}}}"object"==typeof exports&&"undefined"!=typeof module?module.exports={polyfill:polyfill}:polyfill(),a5.rootURL=location.pathname.substring(0,location.pathname.lastIndexOf("/")),a5.getURLParameter=function(sParam){return a5.getURLParameterObject()[sParam]},a5.getURLParameterObject=function(){var params=window.location.search.slice(1).split("&");return _.chain(params).compact().invoke("split","=").object().value()},a5.utils.getAbsoluteURL=function(){var a;return function(url){return a||(a=document.createElement("a")),a.href=url,a.href}}(),$(document).ready(function(){PointerEventsPolyfill.initialize({cancel:".sticky-note"})}),a5.sha1hex=function(text){var hashlib=new jsSHA("SHA-1","TEXT");return hashlib.update(text),hashlib.getHash("HEX")},a5.utils.getIdentifier=function(xmlString){var result=/<assessmentItem.*identifier="([\w\s]+:[\w\s]+:[\w\s]+)".*>/.exec(xmlString);return result?result[1]:void 0},a5.utils.hasTag=function(node,tag){return node.get(0).tagName&&node.get(0).tagName.toLowerCase()===tag.toLowerCase()},a5.utils.hasId=function(node,id){return $(node).attr("id")===id},a5.utils.hasClass=function(node,className){return!!$(node).attr("class")&&$(node).attr("class").split(/\s+/).indexOf(className)>-1},a5.utils.copyAttributes=function(target,source){for(var i=0;i<source.attributes.length;i++){var a=source.attributes[i];target.setAttribute(a.name,a.value)}},$.fn.copyAttributes=function($source){return a5.utils.copyAttributes(this[0],$source[0]),this},a5.getScript=function(src,callback,error_callback){var s=document.createElement("script");s.type="text/"+(src.type||"javascript"),s.src=src.src||src,s.async=!1,s.onload=function(){var state=s.readyState;callback.done||state&&!/loaded|complete/.test(state)||(callback.done=!0,callback())},s.onerror=function(){logger.warn("Error loading "+src),error_callback&&!error_callback.done&&(error_callback.done=!0,error_callback())},(document.body||document.head).appendChild(s)},function(){var parseMatrix=function(cssmatrix){var rmatrix=new RegExp("^matrix\\((\\-?[\\d\\.e\\-]+)\\,?\\s*(\\-?[\\d\\.e\\-]+)\\,?\\s*(\\-?[\\d\\.e\\-]+)\\,?\\s*(\\-?[\\d\\.e\\-]+)\\,?\\s*(\\-?[\\d\\.e\\-]+)\\,?\\s*(\\-?[\\d\\.e\\-]+)\\)$"),matrix=rmatrix.exec(cssmatrix);return matrix&&matrix.shift(),matrix||[1,0,0,1,0,0]},_round=function(number,decimals){return parseFloat(number.toFixed(decimals))},Matrix=function(a,b,c,d,e,f,g,h,i){"array"===$.type(a)?this.elements=[_round(+a[0],5),_round(+a[2],5),_round(+a[4],5),_round(+a[1],5),_round(+a[3],5),_round(+a[5],5),0,0,1]:this.elements=[_round(a,5),_round(b,5),_round(c,5),_round(d,5),_round(e,5),_round(f,5),_round(g,5)||0,_round(h,5)||0,_round(i,5)||1]};Matrix.prototype={x:function(matrix){var isVector=matrix instanceof Vector,a=this.elements,b=matrix.elements;return isVector&&3===b.length?new Vector(a[0]*b[0]+a[1]*b[1]+a[2]*b[2],a[3]*b[0]+a[4]*b[1]+a[5]*b[2],a[6]*b[0]+a[7]*b[1]+a[8]*b[2]):b.length===a.length&&new Matrix(a[0]*b[0]+a[1]*b[3]+a[2]*b[6],a[0]*b[1]+a[1]*b[4]+a[2]*b[7],a[0]*b[2]+a[1]*b[5]+a[2]*b[8],a[3]*b[0]+a[4]*b[3]+a[5]*b[6],a[3]*b[1]+a[4]*b[4]+a[5]*b[7],a[3]*b[2]+a[4]*b[5]+a[5]*b[8],a[6]*b[0]+a[7]*b[3]+a[8]*b[6],a[6]*b[1]+a[7]*b[4]+a[8]*b[7],a[6]*b[2]+a[7]*b[5]+a[8]*b[8])},inverse:function(){var d=1/this.determinant(),a=this.elements;return new Matrix(d*(a[8]*a[4]-a[7]*a[5]),d*-(a[8]*a[1]-a[7]*a[2]),d*(a[5]*a[1]-a[4]*a[2]),d*-(a[8]*a[3]-a[6]*a[5]),d*(a[8]*a[0]-a[6]*a[2]),d*-(a[5]*a[0]-a[3]*a[2]),d*(a[7]*a[3]-a[6]*a[4]),d*-(a[7]*a[0]-a[6]*a[1]),d*(a[4]*a[0]-a[3]*a[1]))},determinant:function(){var a=this.elements;return a[0]*(a[8]*a[4]-a[7]*a[5])-a[3]*(a[8]*a[1]-a[7]*a[2])+a[6]*(a[5]*a[1]-a[4]*a[2])},getScale:function(){return this.elements[0]||this.elements[1]},rotate:function(deg){var rad=parseFloat(deg)*(Math.PI/180),costheta=Math.cos(rad),sintheta=Math.sin(rad);return new Matrix(costheta,-sintheta,0,sintheta,costheta,0,0,0,1).x(this)},skew:function(dx,dy){var radX=parseFloat(dx)*(Math.PI/180),radY=parseFloat(dy)*(Math.PI/180),c=Math.tan(radX),b=Math.tan(radY);return new Matrix(1,c,0,b,1,0,0,0,1).x(this)},translate:function(x,y){return new Matrix(1,0,x||0,0,1,y||0,0,0,1).x(this)},scale:function(x,y){return new Matrix(x||0,0,0,0,y||0,0,0,0,1).x(this)},toString:function(){var s="matrix(";return s+=this.elements[0].toFixed(3)+", ",s+=this.elements[3].toFixed(3)+", ",s+=this.elements[1].toFixed(3)+", ",s+=this.elements[4].toFixed(3)+", ",s+=this.elements[2].toFixed(3)+", ",s+=this.elements[5].toFixed(3),s+=")"}};var Vector=function(x,y,z){this.elements=[_round(x,5),_round(y,5),_round(z,5)]};Vector.prototype.e=Matrix.prototype.e=function(i){return void 0!=this.elements[i]?this.elements[i]:this.elements},a5.utils.Matrix=Matrix,a5.utils.Vector=Vector,a5.utils.parseCSSMatrix=parseMatrix,$.fn.transformationMatrix=function(withParents){var matrices=[],$elements=withParents?$(this).parents().toArray():[];return $elements.unshift(this),_($elements).each(function(node){var csstransform=$(node).css("transform");if("none"!==csstransform){var matrix=new Matrix(parseMatrix(csstransform));matrices.unshift(matrix)}}),_(matrices).reduce(function(memo,m){return memo.x(m)},new Matrix([1,0,0,1,0,0]))},$.ui.ddmanager.prepareOffsets=function(t,event){var i,j,m=$.ui.ddmanager.droppables[t.options.scope]||[],type=event?event.type:null,list=(t.currentItem||t.element).find(":data(ui-droppable)").addBack();droppablesLoop:for(i=0;i<m.length;i++)if(!(m[i].options.disabled||t&&!m[i].accept.call(m[i].element[0],t.currentItem||t.element))){for(j=0;j<list.length;j++)if(list[j]===m[i].element[0]){m[i].proportions().height=0;continue droppablesLoop}if(m[i].visible="none"!==m[i].element.css("display"),m[i].visible){"mousedown"===type&&m[i]._activate.call(m[i],event);var scale=m[i].element.transformationMatrix(!0).getScale();m[i].offset=m[i].element.offset(),m[i].proportions({width:m[i].element[0].offsetWidth*scale,height:m[i].element[0].offsetHeight*scale})}}}}(),String.prototype.hashCode=function(){var hash=0;if(0==this.length)return hash;for(var i=0;i<this.length;i++){hash=(hash<<5)-hash+this.charCodeAt(i),hash&=hash}return hash};function inverseMap(map){var nmap={};return _.each(map,function(v,key){_.each(v,function(value){nmap[value]||(nmap[value]=[]),nmap[value].push(key)})}),nmap}Function.prototype.bindDD=function(context){var func=this;return function(param1,param2){func.apply(context,[param1,param2,this])}};function htmlEncode(str){return String(str).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/â/g,"&#8217;").replace(/'/g,"&apos;")}function htmlDecode(str){return String(str).replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#8217;/g,"â").replace(/&apos;/g,"'")}a5.utils.singleHtmlDecode=function(str){return String(str).replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#8217;/g,"â").replace(/&apos;/g,"'").replace(/&amp;/g,"&")},function(){if(!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){var dragMouseUp=$.ui.draggable.prototype._mouseUp,clickclickMouseUp=function(event){return void 0===this.click&&(this.click=0),1!=++this.click&&(!0===this.options.iframeFix&&$("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)}),2==this.click&&(this.click=-1),window.$.ui.mouse.prototype._mouseUp.call(this,event))};$.ui.draggable.prototype._mouseUp=function(event){a5.mainBuilder.curInteraction.options.useClickClickIsTrue()?clickclickMouseUp.apply(this,arguments):dragMouseUp.apply(this,arguments)}}}(),function(){function isOverAxis(x,reference,size){return x>reference&&x<reference+size}function isOverAxisWithRadius(x,reference,size,radius){return x>reference-radius&&x<reference+size+radius}logger.log("Using custom jquery-ui droppable with tolerance radius"),$.ui.intersect=function(draggable,droppable,toleranceMode){if(!droppable.offset)return!1;var draggableLeft,draggableTop,x1=(draggable.positionAbs||draggable.position.absolute).left,y1=(draggable.positionAbs||draggable.position.absolute).top,x2=x1+draggable.helperProportions.width,y2=y1+draggable.helperProportions.height,l=droppable.offset.left,t=droppable.offset.top,r=l+droppable.proportions().width,b=t+droppable.proportions().height;switch(toleranceMode){case"fit":return l<=x1&&x2<=r&&t<=y1&&y2<=b;case"intersect":return l<x1+draggable.helperProportions.width/2&&x2-draggable.helperProportions.width/2<r&&t<y1+draggable.helperProportions.height/2&&y2-draggable.helperProportions.height/2<b;case"pointer":return draggableLeft=(draggable.positionAbs||draggable.position.absolute).left+(draggable.clickOffset||draggable.offset.click).left,draggableTop=(draggable.positionAbs||draggable.position.absolute).top+(draggable.clickOffset||draggable.offset.click).top,isOverAxis(draggableTop,t,droppable.proportions().height)&&isOverAxis(draggableLeft,l,droppable.proportions().width);case"radius":return draggableLeft=(draggable.positionAbs||draggable.position.absolute).left+(draggable.clickOffset||draggable.offset.click).left,draggableTop=(draggable.positionAbs||draggable.position.absolute).top+(draggable.clickOffset||draggable.offset.click).top,isOverAxisWithRadius(draggableTop,t,droppable.proportions().height,droppable.options.toleranceRadius)&&isOverAxisWithRadius(draggableLeft,l,droppable.proportions().width,droppable.options.toleranceRadius);case"touch":return(y1>=t&&y1<=b||y2>=t&&y2<=b||y1<t&&y2>b)&&(x1>=l&&x1<=r||x2>=l&&x2<=r||x1<l&&x2>r);case"always":var droppables=$.ui.ddmanager.droppables[droppable.options.scope];return droppables=_.filter(droppables,function(d){return d.isover}),droppables.length<=1;default:return!1}};var cursorX,cursorY,defaultIntersect=$.ui.intersect;$(document).on("mousemove touchmove",function(e){var touch;e.originalEvent.touches?(touch=e.originalEvent.touches[0],cursorX=touch.pageX,cursorY=touch.pageY):(cursorX=e.pageX,cursorY=e.pageY)});function distance(point,rect){var dx,dy,x=point.x,y=point.y;return x<rect.left&&y<rect.top?(dx=rect.left-x,dy=rect.top-y):x<rect.left&&y>=rect.top&&y<=rect.bottom?(dx=rect.left-x,dy=0):x<rect.left&&y>rect.bottom?(dx=rect.left-x,dy=y-rect.bottom):x>=rect.left&&x<=rect.right&&y<rect.top?(dx=0,dy=rect.top-y):x>=rect.left&&x<=rect.right&&y>=rect.top&&y<=rect.bottom?(dx=0,dy=0):x>=rect.left&&x<=rect.right&&y>rect.bottom?(dx=0,dy=y-rect.top):x>rect.right&&y<rect.top?(dx=x-rect.right,dy=y-rect.top):x>rect.right&&y>=rect.top&&y<=rect.bottom?(dx=x-rect.right,dy=0):x>rect.right&&y>rect.bottom&&(dx=x-rect.right,dy=y-rect.bottom),Math.sqrt(dx*dx+dy*dy)}$.ui.intersect=function(draggable,droppable,toleranceMode){if("radius-closest-to-mouse"!==toleranceMode)return defaultIntersect(draggable,droppable,toleranceMode);if(!defaultIntersect(draggable,droppable,"radius"))return!1;var acceptable=_.filter($.ui.ddmanager.droppables[draggable.options.scope],function(d){return defaultIntersect(draggable,d,"radius")}),point={x:cursorX,y:cursorY};return droppable===_.min(acceptable,function(other){var rectangle={top:other.offset.top,left:other.offset.left,bottom:other.offset.top+other.proportions().height,right:other.offset.left+other.proportions().width};return distance(point,rectangle)})}}(),function(){a5.utils.Loader={init:function(){},cachedLoad:function(url){return getAjaxData(url)},ajaxLoad:function(url,dType){return $.ajax({type:"GET",url:a5.utils.noCache(url),dataType:dType})},load:function(url,dType){var deferred=$.Deferred();void 0===dType&&(dType="xml"),logger.info("LOADING\t"+url+"; DataType: "+dType);var cached=this.cachedLoad(url);return cached?(logger.info("CACHED\t"+url),deferred.resolve({xml:$.parseXML(cached),text:cached})):this.ajaxLoad(url,dType).done(function(data,code,response){deferred.resolve({xml:data,text:response.responseText})}).fail(function(data,e1,e2){logger.log(e1,e2,url),deferred.reject(e1+"\n"+e2+"\n"+url,data.readyState)}),deferred.promise()}},Obj.extend("a5.utils.Loader",a5.utils.Loader),a5.utils.buildModel=function(interaction,parent,nodes,forceBuild){var self=interaction;void 0===forceBuild&&(forceBuild=!1),nodes.each(function(index,node){var $node=$(node),found=!1;_.each(a5.model_builder.builders,function(e){e.isResponsible($node,self,forceBuild)&&(found?logger.log("found more than one builder for",$node,e):e.build(self,parent,$node,forceBuild),found=!0)}),found||(logger.log("nothing defined for node",$node),alert("nothing defined for node <"+node.tagName+">"))})},a5.utils.buildContents=function(node,interaction,appendTo){var cn=appendTo||$('<div class="content"></div>');return $(node).contents().each(function(i2,e2){interaction.buildModel(cn,$(e2))}),cn},a5.utils.noCache=function(aURL){return aURL=decodeURI(aURL),-1==aURL.indexOf("?")?aURL+="?no_cache="+Math.round(2e9*Math.random()):aURL+="&no_cache="+Math.round(2e9*Math.random()),aURL},a5.utils.array.Shuffle=function(arr){for(var a=[].concat(arr),newArray=[],aLength=a.length,i=0;i<aLength;i++){var l=Math.floor(Math.random()*a.length);newArray.push(a[l]),a.splice(l,1)}return newArray},a5.utils.array.swap=function(arr,pos1,pos2){var tmp=arr[pos1];arr[pos1]=arr[pos2],arr[pos2]=tmp},a5.utils.array.move=function(arr,pos1,pos2){var tmp=arr.splice(pos1,1)[0];arr.splice(pos2,0,tmp)},a5.utils.array.naturalSortComparator=function(a,b){var oFxNcL,oFyNcL,naturalSortComparator=a5.utils.array.naturalSortComparator,re=/(^([+-]?(?:\d*)(?:\.\d*)?(?:[eE][+-]?\d+)?)?$|^0x[\da-fA-F]+$|\d+)/g,sre=/^\s+|\s+$/g,snre=/\s+/g,dre=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/-]\d{1,4}[\/-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,hre=/^0x[0-9a-f]+$/i,ore=/^0/,i=function(s){return(naturalSortComparator.insensitive&&(""+s).toLowerCase()||""+s).replace(sre,"")},x=i(a)||"",y=i(b)||"",xN=x.replace(re,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),yN=y.replace(re,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),xD=parseInt(x.match(hre),16)||1!==xN.length&&Date.parse(x),yD=parseInt(y.match(hre),16)||xD&&y.match(dre)&&Date.parse(y)||null,normChunk=function(s,l){return(!s.match(ore)||1==l)&&parseFloat(s)||s.replace(snre," ").replace(sre,"")||0};if(yD){if(xD<yD)return-1;if(xD>yD)return 1}for(var cLoc=0,xNl=xN.length,yNl=yN.length,numS=Math.max(xNl,yNl);cLoc<numS;cLoc++){if(oFxNcL=normChunk(xN[cLoc]||"",xNl),oFyNcL=normChunk(yN[cLoc]||"",yNl),isNaN(oFxNcL)!==isNaN(oFyNcL))return isNaN(oFxNcL)?1:-1;if(typeof oFxNcL!=typeof oFyNcL&&(oFxNcL+="",oFyNcL+=""),oFxNcL<oFyNcL)return-1;if(oFxNcL>oFyNcL)return 1}return 0},a5.utils.array.naturalSort=function(arr,predicate,numerical,insensitive){a5.utils.array.naturalSortComparator.insensitive=insensitive;var newArray=_(arr).sortBy(predicate),numericalSort=function(a,b){return a=predicate?predicate(a):a,b=predicate?predicate(b):b,a5.utils.array.naturalSortComparator(a,b)};return numerical&&(newArray=newArray.sort(numericalSort)),newArray},a5.utils.array.sortBy=function(arr,predicate,numerical){var newArray=arr.slice(0),iteratee=_.iteratee(predicate);if(newArray.sort(function(a,b){var aVal=String(iteratee(a)),bVal=iteratee(b);return aVal.localeCompare(bVal)}),numerical){var index0=_(newArray).map(iteratee).indexOf("0"),index9=_(newArray).map(iteratee).indexOf("9");if(index0>=0&&index9>=0){var elem0=newArray[index0],elem9=newArray[index9];newArray.splice(index0,1),index9=_(newArray).indexOf(elem9),newArray.splice(index9,1,elem9,elem0)}var index10=_(newArray).map(iteratee).indexOf("10");if(index9=_(newArray).map(iteratee).indexOf("9"),index10>=0&&index9>=0){var elem10=newArray[index10];elem9=newArray[index9],newArray.splice(index10,1),index9=_(newArray).indexOf(elem9),newArray.splice(index9,1,elem9,elem10)}}return newArray},a5.utils.inRange=function(value,min,size){return value>=min&&value<=min+size},a5.utils.splitAndTrim=function(str,del){void 0===del&&(del="|");var arr=str.split(del),res=[];return arr.forEach(function(e){res.push($.trim(e))}),res},a5.utils.truncate=function(str,maxChars){return isNaN(maxChars)?str:(str.length>maxChars&&(str=$.trim(str).substring(0,maxChars).split(" ").slice(0,-1).join(" ")+"..."),str)},a5.utils.jquerySelectorEscape=function(str){return String(str).replace(/([ #;&,.+*~':"!^$[\]()=>|\/@])/g,"\\$1")},a5.utils.getPlainText=function(str){return str=$("<span>"+str+"</span>").text()},a5.utils.b64DecodeUnicode=function(str){return decodeURIComponent(Array.prototype.map.call(atob(str),function(c){return"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)}).join(""))},a5.utils.encodeHTMLSpecialChars=function(str){var lookupTable={};lookupTable["&"]="&#38;",lookupTable["'"]="&#39;",lookupTable['"']="&#34;",lookupTable["<"]="&#60;",lookupTable[">"]="&#62;",lookupTable["Â£"]="&#163;";for(var item in lookupTable){var re=new RegExp(item,"gi");str=str.replace(re,lookupTable[item])}return str},a5.utils.decodeHTMLSpecialChars=function(str){var lookupTable={};lookupTable["&#38;"]="&",lookupTable["&#39;"]="'",lookupTable["&#34;"]='"',lookupTable["&#60;"]="<",lookupTable["&#62;"]=">",lookupTable["&#163;"]="Â£";for(var item in lookupTable){var re=new RegExp(item,"gi");str=str.replace(re,lookupTable[item])}return str},a5.utils.validateUserInput=_.memoize(function(str){var lookupTable={};if(lookupTable[8217]="'",lookupTable[160]=" ",str&&str.length>0)for(var item in lookupTable){var re=new RegExp(String.fromCharCode(item),"gi");str=str.replace(re,lookupTable[item])}return $.trim(str)}),a5.utils.placeLayer=function(element,layer,shift,dir,container){void 0===shift&&(shift=4);var elementPos=($("#content").width(),$("#content").height(),$("#content").position(),$(element).position()),xPos=elementPos.left,yPos=elementPos.top;layer.find("img").css("max-width",container.width()/2+"px"),layer.find("img").css("max-height",container.height()/2+"px"),1==dir&&(yPos=elementPos.top+$(element).height(),yPos+$(layer).height()>container.height()?yPos=elementPos.top-$(layer).height()-shift:yPos+=shift),2==dir&&(xPos=elementPos.left+$(element).width(),xPos+$(layer).width()>container.width()?xPos=elementPos.left-$(layer).width()-shift:xPos+=shift),layer.css("left",xPos+"px"),layer.css("top",yPos+"px")},a5.utils.placeLayerAbsolute=function(element,layer,align,xShift,yShift){void 0===xShift&&(xShift=4),void 0===yShift&&(yShift=4);var contentWidth=$("#content").width(),contentHeight=$("#content").height(),contentPos=$("#content").offset(),elementPos=$(element).offset(),xPos=($(layer).offset(),elementPos.left),yPos=elementPos.top;switch(align){case"left":xPos=elementPos.left-$(layer).width(),xPos<contentPos.left?(xPos=elementPos.left+$(element).width(),xPos+=xShift):xPos-=xShift;break;case"right":xPos=elementPos.left+$(element).width(),xPos+$(layer).width()>contentWidth?(xPos=elementPos.left-$(layer).width(),xPos-=xShift):xPos+=xShift;break;case"bottom":yPos=elementPos.top+$(element).height(),yPos+$(layer).height()>contentHeight?(yPos=elementPos.top-$(layer).height(),yPos-=yShift):yPos+=yShift;break;case"top":default:yPos=elementPos.top-$(layer).height(),yPos<contentPos.top?(yPos=elementPos.top+$(element).height(),yPos+=yShift):yPos-=yShift}layer.css("left",xPos+"px"),layer.css("top",yPos+"px")},a5.utils.secondsToTime=function(secs,paddingZeros){secs=Number(secs);var h=Math.floor(secs/3600),m=Math.floor(secs%3600/60),s=Math.floor(secs%3600%60);return paddingZeros?(h<10?"0":"")+h+":"+(m<10?"0":"")+m+":"+(s<10?"0":"")+s:(h>0?h+":":"")+(m>0?(h>0&&m<10?"0":"")+m+":":"0:")+(s<10?"0":"")+s},a5.utils.timeToSeconds=function(hhmmss){var hours,minutes,seconds,parts=hhmmss.split(":"),time=0;return hours=parts[0],minutes=parts[1],seconds=parts[2],time+=3600*parseFloat(hours),time+=60*parseFloat(minutes),time+=parseFloat(seconds)},a5.utils.secondsToCMITime=function(inputSeconds){var hours,minutes,seconds,inputIsNegative="";inputSeconds<0&&(inputIsNegative="-",inputSeconds=-inputSeconds),hours=Math.floor(inputSeconds/3600)%24,minutes=Math.floor(inputSeconds/60)%60,seconds=Math.floor(inputSeconds%60);var rtnStr=inputIsNegative+"PT";return hours>0&&(rtnStr+=hours+"H"),minutes>0&&(rtnStr+=minutes+"M"),rtnStr+seconds+"S"},a5.utils.getInteractionsGroups=function(list){return _.chain(list).pluck("group").unique().compact().value()},a5.utils.getCurrentCKCount=function(editor,maxLengthType){var txt=$.parseHTML(editor.getData());return a5.utils._countWordsOrChars($(txt).text(),maxLengthType)},a5.utils._countWordsOrChars=function(txt,maxLengthType){return"words"==maxLengthType?txt.split(/\s+/).length:txt.length},
a5.utils._trimWordsOrChar=function(text,maxLengthType,maxLength){if("chars"!=maxLengthType){var words=text.split(/\s+/);return words=words.slice(0,maxLength),words.join(" ")}return text.substr(0,maxLength)},a5.utils.checkCKLength=function(evt){var maxLengthType=evt.editor.config.MaxLengthType,currentLength=a5.utils.getCurrentCKCount(evt.editor,maxLengthType),maximumLength=350;if(evt.editor.config.MaxLength&&(maximumLength=evt.editor.config.MaxLength),evt.editor.config.LockedInitialized||(evt.editor.config.LockedInitialized=1,evt.editor.config.Locked=0),"chars"!=maxLengthType&&(currentLength-=1),"paste"==evt.name){var html=$.parseHTML(evt.data.dataValue),text=$(html).text();if(currentLength+a5.utils._countWordsOrChars(text,maxLengthType)-1>=maximumLength){var trim_len=maximumLength-currentLength;evt.data.dataValue=a5.utils._trimWordsOrChar(text,maxLengthType,trim_len)}}var disallowed_keys=_.range(48,223);disallowed_keys=_.union([9,13,32],disallowed_keys),currentLength>=maximumLength&&disallowed_keys.indexOf(evt.data.keyCode)>-1&&evt.cancel(),a5.utils.showMaxCharsLabel(evt.editor.container.$,Math.max(0,maximumLength-currentLength))},a5.utils.showMaxCharsLabel=function(toNode,val){var node=$(".label-max-chars");node.length||(node=$("<div class='label-max-chars'></div>"),$("body").append(node));var pos=$(toNode).offset();node.css("left",+pos.left+"px"),node.css("top",+(pos.top-node.height())+"px"),node.text(val),node.show()},a5.utils.hideMaxCharsLabel=function(){$(".label-max-chars").hide()},a5.utils.setTextAreaMaxlength=function($node){var ignore=[8,9,13,33,34,35,36,37,38,39,40,46];$node=$node||$("body"),$node.find("textarea[maxchars], textarea[maxwords], input[maxchars], input[maxwords]").on("keypress input",function(event){var len,self=$(this),maxlength=self.attr("maxchars"),type="chars";void 0===maxlength&&(type="words",maxlength=self.attr("maxwords"));var code=$.data(this,"keycode");if(maxlength&&maxlength>0){if("chars"==type)return len=self.val().length,a5.utils.showMaxCharsLabel(this,Math.max(0,maxlength-len)),len<maxlength||-1!==$.inArray(code,ignore);return len=self.val().split(" ").length,a5.utils.showMaxCharsLabel(this,Math.max(0,maxlength-len)),len<=maxlength||-1!==$.inArray(code,ignore)}}).on("keydown",function(event){$.data(this,"keycode",event.keyCode||event.which)}),$("textarea[maxchars], textarea[maxwords], input[maxchars], input[maxwords]").focusout(function(){a5.utils.hideMaxCharsLabel()})};a5.utils.createUID=function(){var timestamp=+new Date;return parseInt(_.uniqueId(timestamp),10)},a5.utils.getParents=function(obj){var rightArrowParents=[];return obj.parents().not("html").each(function(){var entry=this.tagName.toLowerCase();this.className&&(entry+="."+this.className.replace(/ /g,".")),rightArrowParents.push(entry)}),rightArrowParents.reverse(),rightArrowParents},a5.utils.removePunctuation=function(text){return text=text.replace(/[(,)(.)(!)(?)(;)(:)'`â?]/gi,"")},a5.utils.removeSpaces=function(text){return text=text.replace(/\s+/g,"")},a5.utils.removeAccents=function(text){for(var result="",lettermap={"Ã":"A","Ã":"A","Ã":"A","Ã":"A","Ã ":"a","Ã¡":"a","Ã¢":"a","Ã¤":"a","Ã":"s","Ã":"C","Ã§":"c","Ã":"E","Ã":"E","Ã":"E","Ã":"E","Ã¨":"e","Ã©":"e","Ãª":"e","Ã«":"e","Ã":"I","Ã":"I","Ã":"I","Ã":"I","Ã¬":"i","Ã­":"i","Ã®":"i","Ã¯":"i","Ã":"N","Ã±":"n","Ã":"O","Ã":"O","Ã":"O","Ã":"O","Ã²":"o","Ã³":"o","Ã´":"o","Ã¶":"o","Ã":"U","Ã":"U","Ã":"U","Ã":"U","Ã¹":"u","Ãº":"u","Ã»":"u","Ã¼":"u"},i=0;i<text.length;i++)void 0!==lettermap[text[i]]?result+=lettermap[text[i]]:result+=text[i];return result},a5.utils.containsAnswer=function(userInput,correctAnswers,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces){return!!_.find(correctAnswers,function(correctAnswer){return a5.utils.checkUserInput(userInput,correctAnswer,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces)})},a5.utils.countAnswer=function(userInput,correctAnswers,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces){return _.filter(correctAnswers,function(correctAnswer){return a5.utils.checkUserInput(userInput,correctAnswer,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces)}).length},a5.utils.indexOf=function(userInput,correctAnswers,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces){var correctIndex=-1;return userInput&&_.each(correctAnswers,function(correctAnswer,index){correctIndex<0&&a5.utils.checkUserInput(userInput,correctAnswer,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces)&&(correctIndex=index)}),correctIndex},a5.utils.checkUserInput=function(userInput,correctAnswer,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces){return userInput=a5.utils.validateUserInput(userInput),correctAnswer=a5.utils.validateUserInput(correctAnswer),"%0"===correctAnswer&&(correctAnswer="",userInput=userInput.trim()),ignoreCase&&(correctAnswer=correctAnswer.toLowerCase(),userInput=userInput.toLowerCase()),ignorePunctuation&&(correctAnswer=window.a5.utils.removePunctuation(correctAnswer),userInput=window.a5.utils.removePunctuation(userInput)),ignoreAccents&&(correctAnswer=window.a5.utils.removeAccents(correctAnswer),userInput=window.a5.utils.removeAccents(userInput)),ignoreSpaces&&(correctAnswer=window.a5.utils.removeSpaces(correctAnswer),userInput=window.a5.utils.removeSpaces(userInput)),correctAnswer==userInput},a5.utils.scramble=function(src){var scrambled=src.match(/\*s\*([\w\s\b])+\*s\*/g);return null!=scrambled&&_.each(scrambled,function(s){var text=s.replace(/\*s\*/g,"");src=src.replace(s,a5.utils.scrambleText(text))}),src},a5.utils.scrambleText=function(text){var sep=" ";return-1===text.indexOf(" ")&&(sep=""),_.shuffle(text.split(sep)).join(sep)},a5.utils.seconds_to_text=function(s){var second=s%60,minute=Math.floor(s/60%60);return _.isNaN(second)&&(second=0),_.isNaN(minute)&&(minute=0),minute<10&&(minute="0"+minute),second<10&&(second="0"+second),minute+":"+second},a5.utils.getStyleValue=function(style,key){";"!==style[style.length-1]&&(style+=";");var pos_1=style.indexOf(key),styleVal="";if(pos_1>-1){var pos_2=style.indexOf(":",pos_1),pos_3=style.indexOf(";",pos_1);styleVal=$.trim(style.substring(pos_2+1,pos_3))}return styleVal},a5.utils.capitalize=function(text){return text.substring(0,1).toUpperCase()+text.substring(1)},a5.utils.firstCharToLowerCase=function(text){return text.substring(0,1).toLowerCase()+text.substring(1)},a5.utils.getCSSAttributeFromCSS=function(parent,className,attr,style){var id=_.uniqueId("tmp_"),ret=$("<div id='"+id+"'></div>").addClass(className).css(style||{});return $(parent).append(ret),ret=$(parent).find("#"+id).css(attr),$(parent).find("#"+id).remove(),ret},a5.utils.bindDoubleClick=function(node,callback){var hammer=new Hammer.Manager(node,{}),doubleTap=new Hammer.Tap({event:"doubletap",taps:2});hammer.add(doubleTap),hammer.on("doubletap",callback)}}(),a5.utils.elementOverlapArea=function(e1,e2){var d0=e1.offset(),d1=e2.offset(),d1x=d0.left,d1y=d0.top,d1xMax=d0.left+e1.width(),d1yMax=d0.top+e1.height(),d2x=d1.left,d2y=d1.top,d2xMax=d1.left+e2.width(),d2yMax=d1.top+e2.height();return Math.max(0,Math.min(d1xMax,d2xMax)-Math.max(d1x,d2x))*Math.max(0,Math.min(d1yMax,d2yMax)-Math.max(d1y,d2y))},a5.utils.elementOverlapAreaPercent=function(e1,e2){return a5.utils.elementOverlapArea(e1,e2)/Math.min(e1.width()*e1.height(),e2.width()*e2.height())},a5.utils.doElementsOverlap=function(e1,e2){return a5.utils.elementOverlapArea(e1,e2)>0},a5.utils.findIndex=function(obj,iterator,context){var result=null;return _.any(obj,function(value,index,list){if(iterator.call(context,value,index,list))return result=index,!0}),result},a5.utils.swap=function(arr,pos1,pos2){var tmp=arr[pos1];arr[pos1]=arr[pos2],arr[pos2]=tmp},$(function(){var dont_hide_td=function(interaction){interaction.$("td.opt-021-hidden").each(function(){var $td=$(this),$wrap=$("<div>",{class:"opt-021-hidden","data-opt-021-prio":$td.attr("data-opt-021-prio")});$td.wrapInner($wrap),$td.removeClass("opt-021-hidden"),$td.removeAttr("data-opt-021-prio")})};a5.hooks.interactionShowed.add(dont_hide_td)}),function($){$.fn.measure=function(attr,appendTo){var element=$(this).clone(!1);element.css("display","absolute"),element.css("visibility","hidden"),element.appendTo(appendTo||document.body);var result=element.css(attr);return element.remove(),result},$.fn.zoom=function(scale){var newCss={zoom:scale};"WebkitTransform"in document.body.style?newCss={"-webkit-transform":"scale("+scale+")","-webkit-transform-origin":"left top"}:"transform"in document.body.style&&(newCss={transform:"scale("+scale+")","transform-origin":"left top"}),$(this).css(newCss)}}(jQuery),a5.utils.startsWith=function(str,prefix){return 0==str.indexOf(prefix)},a5.utils.endsWith=function(str,suffix){return-1!==str.indexOf(suffix,str.length-suffix.length)},a5.utils.splitUnescaped=function(str,separator){var regex=new RegExp("\\"+separator+"(?!\\\\)","g");return _(_.str.reverse(str).split(regex).reverse()).map(function(m){return _.str.reverse(m)})},a5.utils.containsUnescaped=function(str,character){return str.replace("\\"+character,"").indexOf(character)>=0},a5.utils.unescapeReservedSyntaxSymbols=function(str){var reserved=["|","@","#","*","\\","{","}","[","]"];return _(reserved).each(function(c){str=str.replace("\\"+c,c)}),str},a5.utils.supportHTML5Download=function(){return _.has($("<a>")[0],"download")},a5.utils.mergeObjects=function(objects){return objects=[{}].concat(objects),_.extend.apply(_,objects)},a5.utils.asMap=function(items){var nmap={};return _.each(items,function(item){if(2==item.length){var key=item[0],value=item[1];nmap.hasOwnProperty(key)||(nmap[key]=[]),nmap[key].push(value)}}),nmap},a5.utils.asInverseMap=function(items){var nmap={};return _.each(items,function(item){if(2==item.length){var value=item[0],key=item[1];nmap.hasOwnProperty(key)||(nmap[key]=[]),nmap[key].push(value)}}),nmap},a5.utils.getRandomSubstring=function(string,delimeter){return string=string||"",delimeter=delimeter||"|",_.sample(string.split(delimeter))},a5.utils.requestAnimationFrame=function(callback){var f=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)};return _.bind(f,window)}(),a5.utils.postForm=function(url,data){var $form=$('<form method="post" target="_blank"></form>').attr("action",url);_.each(data,function(attr){$('<input type="hidden"/>').appendTo($form).prop("name",attr.name).val(attr.value)},this),$form.submit()},a5.utils.getDraggableOptions=function(interaction){return _.isFunction(a5.dp.config.draggableOptions)?a5.dp.config.draggableOptions(interaction):a5.dp.config.draggableOptions},a5.utils.isNumeric=function(n){return/^([1-9]\d*|0)([.,]\d+)?$/.test(n)},a5.utils.isInteger=function(n){return/^([1-9]\d*|0)$/.test(n)},a5.utils.Timer=function(){var Timer=function(){this._stamp=window.performance.now()};return _(Timer.prototype).extend({stamp:function(){var new_stamp=window.performance.now(),diff=new_stamp-this._stamp;return this._stamp=new_stamp,diff},getTime:function(){return window.performance.now()-this._stamp},getTimeString:function(time){var t=time||this.getTime();return a5.utils.secondsToTime(Math.round(t/1e3))},getCMITimeString:function(time){var t=time||this.getTime();return a5.utils.secondsToCMITime(Math.round(t/1e3))},stringStamp:function(){return a5.utils.secondsToTime(this.stamp()/1e3)},cmiStringStamp:function(){return a5.utils.secondsToCMITime(this.stamp()/1e3)}}),Timer}(),a5.utils.TimerOut=function(){var TimerOut=function(delay,callback,imediateStart){this.paused=null,this.callback=callback,this.delay=this.remaining=delay,void 0===imediateStart&&(imediateStart=!0),imediateStart&&this.initTimer(this.delay,this.callback)};return _(TimerOut.prototype).extend({initTimer:function(){this.countDownTimer=setTimeout(_.bind(function(){this.paused=this.start=null,this.remaining=0,this.callback.call()},this),this.remaining),this.start=new Date,this.paused=!1},stop:function(){clearTimeout(this.countDownTimer),this.paused=this.start=null},pause:function(){if(this.start&&!1===this.paused){clearTimeout(this.countDownTimer);var now=new Date;this.remaining=this.remaining-(now-this.start),this.paused=!0}},resume:function(){this.start&&!0===this.paused&&(clearTimeout(this.countDownTimer),this.initTimer())},reset:function(){this.remaining=this.delay,clearTimeout(this.countDownTimer),this.initTimer()},isRunning:function(){return!1===this.paused}}),TimerOut}(),a5.utils.TaskTimer=function(){var Timer=function(options){this.options=_.extend({delay:0,duration:0,onStart:_.noop,onEnd:_.noop},options),this.options.duration>0&&(this.options.onStart=_.wrap(this.options.onStart,_.bind(function(fn){fn(),this.timerDelayedEnd=_.delay(this.options.onEnd,this.options.duration)},this)))};return _(Timer.prototype).extend({start:function(){this.timerDelayedStart=_.delay(this.options.onStart,this.options.delay)},stop:function(){this.timerDelayedStart&&clearTimeout(this.timerDelayedStart),this.timerDelayedEnd&&clearTimeout(this.timerDelayedEnd),this.options.onEnd()}}),Timer}(),a5.utils.scrollParent=function(node){var $parent=node.scrollParent(),offset=$parent.offset();return $parent.get(0)===document?{top:$(window).scrollTop(),left:$(window).scrollLeft(),width:$(window).width(),height:$(window).height()}:{top:offset.top,left:offset.left,width:$parent.width(),height:$parent.height()}},a5.utils.isVisible=function(node){var rect=node[0].getBoundingClientRect(),scrollParent=node.scrollParent();if(scrollParent[0]===document)return rect.top>=0&&rect.left>=0&&rect.bottom<=(window.innerHeight||document.documentElement.clientHeight)-a5.dp.config.exclusionBottom&&rect.right<=(window.innerWidth||document.documentElement.clientWidth);var scrollRect=scrollParent[0].getBoundingClientRect();return rect.top>=scrollRect.top&&rect.left>=scrollRect.left&&rect.bottom<=scrollRect.bottom&&rect.right<=scrollRect.right},a5.utils.scrollIntoElementIfNeeded=function(node,options){a5.utils.isVisible(node)||node.get(0).scrollIntoView("object"!=typeof options||options)},a5.utils.setHideLLMKeyTable=function(hidden){try{hidden?sessionStorage.setItem("llm_hide_keys",!0):sessionStorage.removeItem("llm_hide_keys")}catch(e){logger.warn(e)}},a5.utils.getHideLLMKeyTable=function(){var ret=!1;try{ret="true"===sessionStorage.getItem("llm_hide_keys")}catch(e){logger.warn(e)}return ret},a5.utils.trignHelper={QUADRANTS:{TOPLEFT:0,TOPRIGHT:1,BOTTOMLEFT:3,BOTTOMRIGHT:2},RECT_ANG:90,QUAD_TO_NAME:function(quad){var whichQuad=_.filter(_.keys(this.QUADRANTS),function(quadName){return a5.utils.trignHelper.QUADRANTS[quadName]===quad});if(whichQuad.length>0)return whichQuad[0]},DEGR_TO_RAD:function(angle){return angle*Math.PI/180},RAD_TO_DEGR:function(radians){return 180*radians/Math.PI},DEGR_TO_QUAD:function(deg){var rad=this.DEGR_TO_RAD(deg);switch(!0){case Math.sin(rad)>=0&&Math.cos(rad)>=0:return this.QUADRANTS.TOPLEFT;case Math.sin(rad)>=0&&Math.cos(rad)<0:return this.QUADRANTS.TOPRIGHT;case Math.sin(rad)<0&&Math.cos(rad)>=0:return this.QUADRANTS.BOTTOMLEFT;case Math.sin(rad)<0&&Math.cos(rad)<0:return this.QUADRANTS.BOTTOMRIGHT}},DESTINATION_FROM_ANGLE:function(ang,speed,orig,dest){var dist,cos=Math.cos(ang),sin=Math.sin(ang),lengthToY=Math.abs(dest.y-orig.y)/Math.abs(sin),lengthToX=Math.abs(dest.x-orig.x)/Math.abs(cos),time=Math.min(lengthToY,lengthToX);if(lengthToY<lengthToX){dist=Math.abs(dest.y-orig.y)/Math.abs(sin),dest.x=orig.x+time*cos}else{dist=Math.abs(dest.x-orig.x)/Math.abs(cos),dest.y=orig.y+time*sin}return dest.time=dist/speed,dest.dist=dist,dest},BOUNCE_ANGLE:function(bounceRect,position,angle){var newAngle=angle,bouncedX=Math.ceil(position.x)>=Math.ceil(bounceRect.right)||Math.ceil(position.x)<=Math.ceil(bounceRect.left),bouncedY=Math.ceil(position.y)>=Math.ceil(bounceRect.bottom)||Math.ceil(position.y)<=Math.ceil(bounceRect.top);if(bouncedX&&bouncedY){var randomRange=5;randomRange=Math.random()*randomRange-randomRange/2,newAngle=(2*this.RECT_ANG+angle)%(4*this.RECT_ANG)+randomRange}else bouncedX?newAngle=2*this.RECT_ANG-angle:bouncedY&&(newAngle=4*this.RECT_ANG-angle);return newAngle},POINT_TO_ANGLE:function(cx,cy,ex,ey){var dy=ey-cy,dx=ex-cx,theta=Math.atan2(dy,dx);return theta*=180/Math.PI}},a5.utils.resizeText=function(nodes){var el,elements,_i,_len,_results;if(elements=$(nodes),!(elements.length<0)){for(_results=[],_i=0,_len=elements.length;_i<_len;_i++)el=elements[_i],_results.push(function(el){var resizeText,_results1;for(resizeText=function(){var elNewFontSize;return elNewFontSize=parseInt($(el).css("font-size").slice(0,-2),10)-1+"px",$(el).css({"font-size":elNewFontSize,"line-height":"normal"})},_results1=[];el.scrollHeight>el.offsetHeight;)_results1.push(resizeText());return _results1}(el));return _results}},a5.utils.getCrosswordCellWidth=function(){var size=window.a5.mainBuilder.layout.getTemplate("crossword-cell-size");size||(size=a5.utils.getCSSAttributeFromCSS(".ic-crossword .cell","cell","width"));var cellWidth=parseFloat(size),cellUnit=size.replace(cellWidth,"").toLowerCase()||"px";return"px"===cellUnit&&(cellWidth-=1),{width:cellWidth,unit:cellUnit}},a5.utils.applySVGGradientFix=function(html){var id=a5.utils.createUID(),matches=/<linearGradient id="([^"]+)"/gi.exec(html);matches&&matches.length>1&&(html=html.replace(new RegExp(matches[1],"gi"),id)),(matches=/<radialGradient id="([^"]+)"/gi.exec(html))&&matches.length>1&&(html=html.replace(new RegExp(matches[1],"gi"),id));for(var ids=[],re=/<use [^>]*href="#([^"]+)"/gi;matches=re.exec(html);)ids.push(matches[1]);return ids.forEach(function(current,i){html=html.replace(new RegExp(current,"gi"),id+"-"+i)}),html=html.replace(/svgc/g,"c"+id)},a5.utils.applySVGIE11Fix=function(){(window.ActiveXObject||"ActiveXObject"in window)&&$("use").each(function(){this.href.baseVal=this.href.baseVal})},a5.utils.isDocumentOverMobileBreakpoint=function(){return window.innerWidth>a5.dp.config.mobileBreakpoint},a5.utils.wrapFirstLetter=function($node,$wrap){var text=this.findFirstLetter($node),regex=/^\W*\w/;if(text){var match=text.textContent.match(regex);$(text).before($wrap||$('<span class="firstletter">').text(match[0])),text.textContent=text.textContent.replace(regex,"")}},a5.utils.benchmark=function(){var text="Event\tStartTime\tDuration\n",measures=performance.getEntriesByType("measure");return _.each(measures,function(measureItem){text+=measureItem.name+"\t"+measureItem.startTime+"\t"+measureItem.duration+"\n"}),text},a5.utils.benchmarkFile=function(){var benchmark=a5.utils.benchmark(),filename="EngineBenchmark_"+(new Date).getTime()+".csv";if(benchmark){var blob=new Blob([benchmark],{type:"text/csv;charset=utf-8"});blob&&window.saveAs(blob,filename)}},a5.utils.findFirstLetter=function($node){return _.find($node.contents().map(function(_,node){return node.nodeType===Node.TEXT_NODE&&/\w/.test(node.textContent)?node:node.nodeType!==Node.ELEMENT_NODE||"style"!==node.tagName?this.findFirstLetter($(node)):void 0}.bind(this)))},a5.utils.serializeXML=function(xml){return(new XMLSerializer).serializeToString(xml)},a5.utils.parseUserAgent=function(){function check(r){return r.test(navigator.userAgent.toLowerCase())}var userAgent={isStrict:"CSS1Compat"==document.compatMode,isOpera:check(/opera/),isChrome:check(/\bchrome\b/),isSafari:check(/safari/),isWebKit:check(/webkit/),isGecko:check(/gecko/),isFirefox:check(/firefox/),isWindows:check(/windows|win32/),isMac:check(/macintosh|mac os x/),isAir:check(/adobeair/),isIE11:check(/trident/)&&check(/rv:11/),isEdge:check(/edge/),isLinux:check(/linux/),isSecure:/^https/i.test(window.location.protocol),isPhantom:check(/phantomjs/),isIpad:check(/ipad/),isAndroid:check(/android/),isIOS:check(/ipad|iphone|ipod/),isQt:check(/qtwebengine/),isIpadOS:"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1};return userAgent.isIpad=userAgent.isIpad||userAgent.isIpadOS,userAgent.isMac=userAgent.isMac&&!userAgent.isIpad,userAgent.isSafari=userAgent.isSafari&&!userAgent.isChrome&&!userAgent.isEdge,userAgent.isChrome=userAgent.isChrome&&!userAgent.isEdge,userAgent.isGecko=userAgent.isGecko&&!userAgent.isWebKit&&!userAgent.isEdge,userAgent},a5.utils.deepClone=function(obj){return JSON.parse(JSON.stringify(obj)||null)},a5.utils.enumText=function(enumString){return $(enumString,{}).text()||enumString},a5.utils.knapsack=function(){return{resolve:function(capacity,items){var itemsFiltered,result=[],leftCap=capacity;if("number"!=typeof capacity)return!1;if(!(items&&items instanceof Array))return!1;var item,itemKey,itemVal,itemObj;itemsFiltered=items.filter(function(value){return itemVal="object"==typeof value?value[Object.keys(value)[0]]:null,!isNaN(itemVal)&&itemVal>0&&itemVal<=capacity}),itemsFiltered.sort(function(a,b){return a[Object.keys(a)[0]]<b[Object.keys(b)[0]]});for(item in itemsFiltered)if(itemsFiltered.hasOwnProperty(item)&&(itemKey=Object.keys(itemsFiltered[item])[0],itemVal=itemsFiltered[item][itemKey],leftCap-itemVal>=0&&(leftCap-=itemVal,itemObj=Object.create(null),itemObj[itemKey]=itemVal,result.push(itemObj),delete itemsFiltered[item],leftCap<=0)))break;return result}}}(),a5.utils.keyCodes={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},a5.utils.MathParser=function(){"use strict";function peg$SyntaxError(message,expected,found,location){this.message=message,this.expected=expected,this.found=found,this.location=location,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,peg$SyntaxError)}!function(child,parent){function ctor(){this.constructor=child}ctor.prototype=parent.prototype,child.prototype=new ctor}(peg$SyntaxError,Error),peg$SyntaxError.buildMessage=function(expected,found){var DESCRIBE_EXPECTATION_FNS={literal:function(expectation){return'"'+literalEscape(expectation.text)+'"'},class:function(expectation){var i,escapedParts="";for(i=0;i<expectation.parts.length;i++)escapedParts+=expectation.parts[i]instanceof Array?classEscape(expectation.parts[i][0])+"-"+classEscape(expectation.parts[i][1]):classEscape(expectation.parts[i]);return"["+(expectation.inverted?"^":"")+escapedParts+"]"},any:function(expectation){return"any character"},end:function(expectation){return"end of input"},other:function(expectation){return expectation.description}};function hex(ch){return ch.charCodeAt(0).toString(16).toUpperCase()}function literalEscape(s){return s.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(ch){return"\\x0"+hex(ch)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(ch){return"\\x"+hex(ch)})}function classEscape(s){return s.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(ch){return"\\x0"+hex(ch)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(ch){return"\\x"+hex(ch)})}function describeExpectation(expectation){return DESCRIBE_EXPECTATION_FNS[expectation.type](expectation)}return"Expected "+function(expected){var i,j,descriptions=new Array(expected.length);for(i=0;i<expected.length;i++)descriptions[i]=describeExpectation(expected[i]);if(descriptions.sort(),descriptions.length>0){for(i=1,j=1;i<descriptions.length;i++)descriptions[i-1]!==descriptions[i]&&(descriptions[j]=descriptions[i],j++);descriptions.length=j}switch(descriptions.length){case 1:return descriptions[0];case 2:return descriptions[0]+" or "+descriptions[1];default:return descriptions.slice(0,-1).join(", ")+", or "+descriptions[descriptions.length-1]}}(expected)+" but "+function(found){return found?'"'+literalEscape(found)+'"':"end of input"}(found)+" found."};function peg$parse(input,options){options=void 0!==options?options:{};var peg$result,peg$FAILED={},peg$startRuleFunctions={LogicComparisson:peg$parseLogicComparisson},peg$startRuleFunction=peg$parseLogicComparisson,peg$c0="&&",peg$c1=peg$literalExpectation("&&",!1),peg$c2="||",peg$c3=peg$literalExpectation("||",!1),peg$c4=function(head,tail){var i,result=head;for(i=0;i<tail.length;i++)"&&"===tail[i][1]&&(result=result&&tail[i][3]),"||"===tail[i][1]&&(result=result||tail[i][3]);return result},peg$c5="(",peg$c6=peg$literalExpectation("(",!1),peg$c7=")",peg$c8=peg$literalExpectation(")",!1),peg$c9=function(expr){return expr},peg$c10="<=",peg$c11=peg$literalExpectation("<=",!1),peg$c12=">=",peg$c13=peg$literalExpectation(">=",!1),peg$c14="==",peg$c15=peg$literalExpectation("==",!1),peg$c16="!=",peg$c17=peg$literalExpectation("!=",!1),peg$c18="<",peg$c19=peg$literalExpectation("<",!1),peg$c20=">",peg$c21=peg$literalExpectation(">",!1),peg$c22=function(head,tail){var i,result=head;for(i=0;i<tail.length;i++)"<="===tail[i][1]&&(result=result<=tail[i][3]),">="===tail[i][1]&&(result=result>=tail[i][3]),"=="===tail[i][1]&&(result=result==tail[i][3]),"!="===tail[i][1]&&(result=result!=tail[i][3]),">"===tail[i][1]&&(result=result>tail[i][3]),"<"===tail[i][1]&&(result=result<tail[i][3]);return result},peg$c23="+",peg$c24=peg$literalExpectation("+",!1),peg$c25="-",peg$c26=peg$literalExpectation("-",!1),peg$c27=function(head,tail){var i,result=head;for(i=0;i<tail.length;i++)"+"===tail[i][1]&&(result+=tail[i][3]),"-"===tail[i][1]&&(result-=tail[i][3]);return result},peg$c28="*",peg$c29=peg$literalExpectation("*",!1),peg$c30="/",peg$c31=peg$literalExpectation("/",!1),peg$c32=function(head,tail){var i,result=head;for(i=0;i<tail.length;i++)"*"===tail[i][1]&&(result*=tail[i][3]),"/"===tail[i][1]&&(result/=tail[i][3]);return result},peg$c33=peg$otherExpectation("float"),peg$c34=/^[0-9]/,peg$c35=peg$classExpectation([["0","9"]],!1,!1),peg$c36=".",peg$c37=peg$literalExpectation(".",!1),peg$c38="e",peg$c39=peg$literalExpectation("e",!1),peg$c40=function(){return parseFloat(text(),10)},peg$c41=peg$otherExpectation("NaN"),peg$c42="NaN",peg$c43=peg$literalExpectation("NaN",!1),peg$c44=function(){return NaN},peg$c45=peg$otherExpectation("whitespace"),peg$c46=/^[ \t\n\r]/,peg$c47=peg$classExpectation([" ","\t","\n","\r"],!1,!1),peg$currPos=0,peg$savedPos=0,peg$posDetailsCache=[{line:1,column:1}],peg$maxFailPos=0,peg$maxFailExpected=[],peg$silentFails=0;if("startRule"in options){if(!(options.startRule in peg$startRuleFunctions))throw new Error("Can't start parsing from rule \""+options.startRule+'".');peg$startRuleFunction=peg$startRuleFunctions[options.startRule]}function text(){return input.substring(peg$savedPos,peg$currPos)}function peg$literalExpectation(text,ignoreCase){return{type:"literal",text:text,ignoreCase:ignoreCase}}function peg$classExpectation(parts,inverted,ignoreCase){return{type:"class",parts:parts,inverted:inverted,ignoreCase:ignoreCase}}function peg$otherExpectation(description){return{type:"other",description:description}}function peg$computePosDetails(pos){var p,details=peg$posDetailsCache[pos];if(details)return details;for(p=pos-1;!peg$posDetailsCache[p];)p--;for(details=peg$posDetailsCache[p],details={line:details.line,column:details.column};p<pos;)10===input.charCodeAt(p)?(details.line++,details.column=1):details.column++,p++;return peg$posDetailsCache[pos]=details,details}function peg$computeLocation(startPos,endPos){var startPosDetails=peg$computePosDetails(startPos),endPosDetails=peg$computePosDetails(endPos);return{start:{offset:startPos,line:startPosDetails.line,column:startPosDetails.column},end:{offset:endPos,line:endPosDetails.line,column:endPosDetails.column}}}function peg$fail(expected){peg$currPos<peg$maxFailPos||(peg$currPos>peg$maxFailPos&&(peg$maxFailPos=peg$currPos,peg$maxFailExpected=[]),peg$maxFailExpected.push(expected))}function peg$buildStructuredError(expected,found,location){return new peg$SyntaxError(peg$SyntaxError.buildMessage(expected,found),expected,found,location)}function peg$parseLogicComparisson(){var s0,s1,s2,s3,s4,s5,s6,s7;if(s0=peg$currPos,(s1=peg$parseLogicComparator())!==peg$FAILED){for(s2=[],s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(input.substr(peg$currPos,2)===peg$c0?(s5=peg$c0,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c1)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c2?(s5=peg$c2,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c3))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseLogicComparator(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s3!==peg$FAILED;)s2.push(s3),s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(input.substr(peg$currPos,2)===peg$c0?(s5=peg$c0,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c1)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c2?(s5=peg$c2,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c3))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseLogicComparator(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c4(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseLogicComparator(){var s0,s1,s2,s3,s4,s5;return s0=peg$parseComparison(),s0===peg$FAILED&&(s0=peg$currPos,40===input.charCodeAt(peg$currPos)?(s1=peg$c5,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c6)),s1!==peg$FAILED?(s2=peg$parse_(),s2!==peg$FAILED?(s3=peg$parseLogicComparisson(),s3!==peg$FAILED?(s4=peg$parse_(),s4!==peg$FAILED?(41===input.charCodeAt(peg$currPos)?(s5=peg$c7,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c8)),s5!==peg$FAILED?(peg$savedPos=s0,s1=peg$c9(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)),s0}function peg$parseComparison(){var s0,s1,s2,s3,s4,s5,s6,s7;if(s0=peg$currPos,(s1=peg$parseComparator())!==peg$FAILED){for(s2=[],s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(input.substr(peg$currPos,2)===peg$c10?(s5=peg$c10,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c11)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c12?(s5=peg$c12,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c13)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c14?(s5=peg$c14,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c15)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c16?(s5=peg$c16,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c17)),s5===peg$FAILED&&(60===input.charCodeAt(peg$currPos)?(s5=peg$c18,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c19)),s5===peg$FAILED&&(62===input.charCodeAt(peg$currPos)?(s5=peg$c20,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c21))))))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseComparator(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s3!==peg$FAILED;)s2.push(s3),s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(input.substr(peg$currPos,2)===peg$c10?(s5=peg$c10,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c11)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c12?(s5=peg$c12,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c13)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c14?(s5=peg$c14,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c15)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c16?(s5=peg$c16,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c17)),s5===peg$FAILED&&(60===input.charCodeAt(peg$currPos)?(s5=peg$c18,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c19)),s5===peg$FAILED&&(62===input.charCodeAt(peg$currPos)?(s5=peg$c20,
peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c21))))))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseComparator(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c22(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseComparator(){var s0,s1,s2,s3,s4,s5;return s0=peg$parseExpression(),s0===peg$FAILED&&(s0=peg$currPos,40===input.charCodeAt(peg$currPos)?(s1=peg$c5,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c6)),s1!==peg$FAILED?(s2=peg$parse_(),s2!==peg$FAILED?(s3=peg$parseComparison(),s3!==peg$FAILED?(s4=peg$parse_(),s4!==peg$FAILED?(41===input.charCodeAt(peg$currPos)?(s5=peg$c7,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c8)),s5!==peg$FAILED?(peg$savedPos=s0,s1=peg$c9(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)),s0}function peg$parseExpression(){var s0,s1,s2,s3,s4,s5,s6,s7;if(s0=peg$currPos,(s1=peg$parseTerm())!==peg$FAILED){for(s2=[],s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(43===input.charCodeAt(peg$currPos)?(s5=peg$c23,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c24)),s5===peg$FAILED&&(45===input.charCodeAt(peg$currPos)?(s5=peg$c25,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c26))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseTerm(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s3!==peg$FAILED;)s2.push(s3),s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(43===input.charCodeAt(peg$currPos)?(s5=peg$c23,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c24)),s5===peg$FAILED&&(45===input.charCodeAt(peg$currPos)?(s5=peg$c25,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c26))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseTerm(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c27(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseTerm(){var s0,s1,s2,s3,s4,s5,s6,s7;if(s0=peg$currPos,(s1=peg$parseFactor())!==peg$FAILED){for(s2=[],s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(42===input.charCodeAt(peg$currPos)?(s5=peg$c28,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c29)),s5===peg$FAILED&&(47===input.charCodeAt(peg$currPos)?(s5=peg$c30,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c31))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseFactor(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s3!==peg$FAILED;)s2.push(s3),s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(42===input.charCodeAt(peg$currPos)?(s5=peg$c28,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c29)),s5===peg$FAILED&&(47===input.charCodeAt(peg$currPos)?(s5=peg$c30,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c31))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseFactor(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c32(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseFactor(){var s0,s1,s2,s3,s4,s5;return s0=peg$currPos,40===input.charCodeAt(peg$currPos)?(s1=peg$c5,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c6)),s1!==peg$FAILED?(s2=peg$parse_(),s2!==peg$FAILED?(s3=peg$parseExpression(),s3!==peg$FAILED?(s4=peg$parse_(),s4!==peg$FAILED?(41===input.charCodeAt(peg$currPos)?(s5=peg$c7,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c8)),s5!==peg$FAILED?(peg$savedPos=s0,s1=peg$c9(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0===peg$FAILED&&(s0=peg$parseFloat()),s0}function peg$parseFloat(){var s0,s1,s2,s3,s4,s5,s6,s7;for(peg$silentFails++,s0=peg$currPos,s1=[],43===input.charCodeAt(peg$currPos)?(s2=peg$c23,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c24)),s2===peg$FAILED&&(45===input.charCodeAt(peg$currPos)?(s2=peg$c25,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c26)));s2!==peg$FAILED;)s1.push(s2),43===input.charCodeAt(peg$currPos)?(s2=peg$c23,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c24)),s2===peg$FAILED&&(45===input.charCodeAt(peg$currPos)?(s2=peg$c25,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c26)));if(s1!==peg$FAILED){if(s2=[],peg$c34.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35)),s3!==peg$FAILED)for(;s3!==peg$FAILED;)s2.push(s3),peg$c34.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35));else s2=peg$FAILED;if(s2!==peg$FAILED){if(s3=[],s4=peg$currPos,46===input.charCodeAt(peg$currPos)?(s5=peg$c36,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c37)),s5!==peg$FAILED){if(s6=[],peg$c34.test(input.charAt(peg$currPos))?(s7=input.charAt(peg$currPos),peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35)),s7!==peg$FAILED)for(;s7!==peg$FAILED;)s6.push(s7),peg$c34.test(input.charAt(peg$currPos))?(s7=input.charAt(peg$currPos),peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35));else s6=peg$FAILED;s6!==peg$FAILED?(s5=[s5,s6],s4=s5):(peg$currPos=s4,s4=peg$FAILED)}else peg$currPos=s4,s4=peg$FAILED;for(;s4!==peg$FAILED;)if(s3.push(s4),s4=peg$currPos,46===input.charCodeAt(peg$currPos)?(s5=peg$c36,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c37)),s5!==peg$FAILED){if(s6=[],peg$c34.test(input.charAt(peg$currPos))?(s7=input.charAt(peg$currPos),peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35)),s7!==peg$FAILED)for(;s7!==peg$FAILED;)s6.push(s7),peg$c34.test(input.charAt(peg$currPos))?(s7=input.charAt(peg$currPos),peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35));else s6=peg$FAILED;s6!==peg$FAILED?(s5=[s5,s6],s4=s5):(peg$currPos=s4,s4=peg$FAILED)}else peg$currPos=s4,s4=peg$FAILED;if(s3===peg$FAILED)if(s3=peg$currPos,101===input.charCodeAt(peg$currPos)?(s4=peg$c38,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c39)),s4!==peg$FAILED){if(s5=[],peg$c34.test(input.charAt(peg$currPos))?(s6=input.charAt(peg$currPos),peg$currPos++):(s6=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35)),s6!==peg$FAILED)for(;s6!==peg$FAILED;)s5.push(s6),peg$c34.test(input.charAt(peg$currPos))?(s6=input.charAt(peg$currPos),peg$currPos++):(s6=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35));else s5=peg$FAILED;s5!==peg$FAILED?(s4=[s4,s5],s3=s4):(peg$currPos=s3,s3=peg$FAILED)}else peg$currPos=s3,s3=peg$FAILED;s3!==peg$FAILED?(peg$savedPos=s0,s1=peg$c40(),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED}else peg$currPos=s0,s0=peg$FAILED;return s0===peg$FAILED&&(s0=peg$parseNaN()),peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c33)),s0}function peg$parseNaN(){var s0,s1;return peg$silentFails++,s0=peg$currPos,input.substr(peg$currPos,3)===peg$c42?(s1=peg$c42,peg$currPos+=3):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c43)),s1!==peg$FAILED&&(peg$savedPos=s0,s1=peg$c44()),s0=s1,peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c41)),s0}function peg$parse_(){var s0,s1;for(peg$silentFails++,s0=[],peg$c46.test(input.charAt(peg$currPos))?(s1=input.charAt(peg$currPos),peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c47));s1!==peg$FAILED;)s0.push(s1),peg$c46.test(input.charAt(peg$currPos))?(s1=input.charAt(peg$currPos),peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c47));return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c45)),s0}if((peg$result=peg$startRuleFunction())!==peg$FAILED&&peg$currPos===input.length)return peg$result;throw peg$result!==peg$FAILED&&peg$currPos<input.length&&peg$fail(function(){return{type:"end"}}()),peg$buildStructuredError(peg$maxFailExpected,peg$maxFailPos<input.length?input.charAt(peg$maxFailPos):null,peg$maxFailPos<input.length?peg$computeLocation(peg$maxFailPos,peg$maxFailPos+1):peg$computeLocation(peg$maxFailPos,peg$maxFailPos))}return{SyntaxError:peg$SyntaxError,parse:peg$parse,memoParse:_.memoize(peg$parse)}}(),_.mixin({within:function(val,min,max){return val>=min&&val<=max}});var Point={init:function(left,top){this.left=left,this.top=top},within:function(box,options){return options=_.defaults(options||{},{horizontal:!0,vertical:!0}),(!options.vertical||_.within(this.top,box.top,box.bottom()))&&(!options.horizontal||_.within(this.left,box.left,box.right()))},move:function(dleft,dtop){this.left+=dleft,this.top+=dtop},moveWithin:function(box){this.move(this.rangeDiff(this.horizontalRange(),box.horizontalRange()),this.rangeDiff(this.verticalRange(),box.verticalRange()))},horizontalRange:function(){return{min:this.left,max:this.left}},verticalRange:function(){return{min:this.top,max:this.top}},rangeDiff:function(current,bounding){return current.min<bounding.min?bounding.min-current.min:current.max>bounding.max?bounding.max-current.max:0}};Obj.extend("Point");var Box={init:function(left,top,width,height){this._super(left,top),this.width=width,this.height=height},right:function(){return this.left+this.width},bottom:function(){return this.top+this.height},horizontalRange:function(){return{min:this.left,max:this.right()}},verticalRange:function(){return{min:this.top,max:this.bottom()}}};Point.extend("Box"),function($){$.fn.bBox=function(relative){var pos;return pos=relative?this.position():this.offset(),new Box(pos.left,pos.top,this.outerWidth(!0),this.outerHeight(!0))}}(jQuery);var Line={init:function(p1,p2){this.p1=p1,this.p2=p2}};Obj.extend("Line");var Bezier={init:function(p1,p4){this.p1=p1,this.p4=p4;var delta=(p4.left-p1.left)/2;this.p2=new Point(p1.left+delta,p1.top),this.p3=new Point(p4.left-delta,p4.top)},getCoord:function(t,coord){var values=_.pluck([this.p1,this.p2,this.p3,this.p4],coord);return Math.pow(1-t,3)*values[0]+3*Math.pow(1-t,2)*t*values[1]+3*(1-t)*t*t*values[2]+t*t*t*values[3]},getPoint:function(t){return new Point(this.getCoord(t,"left"),this.getCoord(t,"top"))},approximate:function(){for(var lastPoint=this.p1,lines=[],i=1;i<=8;i++){var point=this.getPoint(i/8);lines.push(new Line(lastPoint,point)),lastPoint=point}return lines}};Obj.extend("Bezier");var LinesBoxIntersection={sinside:0,sleft:1,sright:2,sbottom:4,stop:8,init:function(lines,box){this.lines=lines,this.box=box},intersectAny:function(){return _.any(this.lines,function(line){return 0==(this.section(line.p1)&this.section(line.p2))},this)},section:function(point){var code=this.sinside;return point.left<this.box.left&&(code|=this.sleft),point.left>this.box.right()&&(code|=this.sright),point.top<this.box.top&&(code|=this.stop),point.top>this.box.bottom()&&(code|=this.sbottom),code}};Obj.extend("LinesBoxIntersection"),Obj.extend("a5.InteractionGroup",{init:function(interactions,index){this.interactions=interactions,this.index=index||0},getResults:function(limit,scoreFetcher){var interactions=this.interactions;function newLimit(i){return!(!_.isUndefined(limit)&&!limit(i)||!_.include(interactions,i))}return a5.mainBuilder.getResults(newLimit,scoreFetcher)}}),a5.Hook={init:function(){this.callbacks=[]},add:function(callback){this.callbacks.push(callback)},remove:function(callback){this.callbacks.remove(callback)},call:function(){var urguments=arguments;_.each(this.callbacks,function(e){e.apply(window,urguments)})}},Obj.extend("a5.Hook"),a5.EngineHooks={init:function(){this.interactionLoaded=new a5.Hook,this.interactionRestored=new a5.Hook,this.interactionShowed=new a5.Hook,this.interactionStatusChanged=new a5.Hook,this.interactionFontUpdated=new a5.Hook,this.ppebookRendered=new a5.Hook,this.ppebookDialogShowed=new a5.Hook,this.ppebookDialogRendered=new a5.Hook,this.ppebookSidebarShowed=new a5.Hook,this.ppebookSidebarRendered=new a5.Hook,this.ppebookHotspotRendered=new a5.Hook,this.ppebookMaskRendered=new a5.Hook,this.ppebookMaskDragging=new a5.Hook,this.ppebookMaskClose=new a5.Hook,this.ppebookInverseMaskRendered=new a5.Hook,this.ppebookInverseMaskDragging=new a5.Hook,this.ppebookInverseMaskClose=new a5.Hook,this.ppebookHistoryUndo=new a5.Hook,this.ppebookHistoryRedo=new a5.Hook,this.layoutStylesLoaded=new a5.Hook,this.countdownSetupRendered=new a5.Hook,this.countdownRendered=new a5.Hook}},Obj.extend("a5.EngineHooks"),a5.hooks=new a5.EngineHooks,Obj.extend("a5.DynamicCallbacks",{init:function(){this.callbacks={}},get:function(key){return _.has(this.callbacks,key)||(this.callbacks[key]=new Obj),this.callbacks[key]}}),a5.callbacks={controls:{pagination:new Obj,bar:new Obj},interaction:new Obj,dialogs:new a5.DynamicCallbacks},a5.eventBus=new Obj,a5.PerformanceBenchmark={init:function(){this.bindGlobalPerformanceEvents()},bindGlobalPerformanceEvents:function(){this._bindPerformanceEvent("engine_overhead","EngineOverhead"),this._bindPerformanceEvent("engine_config_load","EngineConfig"),this._bindPerformanceEvent("engine_dp_load","DesignPackInit"),this._bindPerformanceEvent("engine_layout_load","DesignPackLayout"),this._bindPerformanceEvent("engine_init_load","EngineInit"),this._bindPerformanceEvent("engine_mainbuilder","EngineMainBuilder"),this._bindPerformanceEvent("engine_lmsdata","EngineLMSData"),this._bindPerformanceEvent("engine_load_interactions","LoadAllScreens",!0),this._bindPerformanceEvent("render_LO","RenderAllScreens",!0)},bindInteractionPerformanceEvents:function(interaction){this._bindPerformanceEvent("load_screen_"+interaction.url),this._bindPerformanceEvent("xml_options_"+interaction.url),this._bindPerformanceEvent("xml_preprocessor_"+interaction.url),this._bindPerformanceEvent("render_"+interaction.url)},_bindPerformanceEvent:function(event,name,defer_measure){name||(name=event),a5.eventBus.bind("performance:"+event+":start",function(){this.performanceMarkStart(event)},this),a5.eventBus.bind("performance:"+event+":end",function(){this.performanceMarkEnd(event),defer_measure?_.defer(_.bind(function(){this.performanceMeasure(name,event)},this)):this.performanceMeasure(name,event)},this)},performanceMarkStart:function(name){window.performance&&window.performance.mark&&name&&window.performance.mark(name+"_start")},performanceMarkEnd:function(name){window.performance&&window.performance.mark&&name&&window.performance.mark(name+"_end")},performanceMeasure:function(measurementName,markName){window.performance&&window.performance.measure&&measurementName&&markName&&window.performance.measure(measurementName,markName+"_start",markName+"_end")}},Obj.extend("a5.PerformanceBenchmark"),a5.registry={"book:has-resources":!1,"book:enable-solution-view":function(){return!0},"book:hotspots:filter-structure-nodes":function(list){return list},"init-lrs":function(params){if(window.FrontendLRS){var lrs=new window.FrontendLRS.LRS({host:params.endpoint}),env=new window.FrontendLRS.TincanJsShellEnv({lrs:lrs});return $.when(lrs.init(),env.init())}},"lo:has-next":function(){return!1},"lo:has-prev":function(){return!1},"open-attachment":function(html){return html},"open-link":function(getUrl,params){if(params=params||{},"iframe"!==params.target||/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())){var target="_blank";params.target&&"iframe"!==params.target&&(target=params.target);var w=window.open("",target,params.settings);$.when(getUrl).done(function(url){w.location=url,params.focus&&w.focus()}).fail(function(){w.close()})}else $.when(getUrl).done(function(url){var $iframe=params.$iframe||$("#iframe-open-link");$iframe.length>0?$iframe.attr("src",url):$("<iframe>",{id:"iframe-open-link",src:url}).hide().appendTo("body")})}},a5.models.options.BaseOptions={name_map:{"027":"Enumeration","028":"Enumeration-Answers","029":"Prefill","034":"Gaptext audio","038":"Speak learner input","052":"Audio support",111:"Pool-Alignment",113:"Gaps",122:"Multiple-Destinations",300:"Drag-Alignment",302:"Hide-Radiobuttons","025":"Previous","045":"Try-Again","050":"Progress-Bar","072":"Conserve-answers",147:"Card-Content",303:"Card-Back-Content",148:"Card-Back",149:"Card-Layout",150:"Card-Format",139:"Model-Text",362:"Show-In-Columns",107:"Add-Text-Object",142:"Question-As-Media",143:"Answers-As-Media","046":"Score Values","049":"Timer","047":"End Result Screen",378:"End Result Always",342:"Intro-Screen",361:"Spellcheck","051":"Automatic Next","013":"Email Bank","032":"Item Pool",128:"Drop Indicator",109:"Use Click Click",304:"Place The Objects",154:"Linking-Lines-Sets",158:"Size",160:"Case",118:"Error Correction",305:"Clue position",312:"See-Answers",313:"Reset","021":"Reveal Object","054":"Printable",120:"Max Length",119:"Signal Error",306:"Choice Alignment",323:"Case Insensitive",324:"Ignore Punctuation",311:"Check Answers",317:"Running score",162:"Stay in view","023":"Pin object",327:"Card Per Row","026":"Forward Button",336:"Show Forward",387:"Return to intro screen",388:"Send scores",390:"Design Pack Substyle",391:"End results return",315:"Submissions",334:"Show-Submit",335:"Finish-Submit","01":"Dictionary","06":"Notes area","040":"Feedback",322:"Delayed Feedback","056":"Image As Trigger",114:"Save",341:"Autosave","043":"Feedback Sound Effects","044":"Sound Effects",330:"Hide-Checkboxes","098":"Target Game","09":"Interactive Phonemic Chart",112:"Pair alignment",337:"Target zones",326:"Randomise answers",345:"Manual Marking",340:"Validation message",384:"Check max attempts",346:"Feedback-Band-1",347:"Feedback-Band-2",348:"Feedback-Band-3",349:"Feedback-Band-4",357:"Activity-Feedback-Thresholds",353:"Activity-Feedback-Band-1",354:"Activity-Feedback-Band-2",355:"Activity-Feedback-Band-3",356:"Activity-Feedback-Band-4",352:"Special characters - Student",368:"Annotation Tools",371:"Show info text",373:"Continuous Enumeration",379:"Exams Timer",462:"Feedback Correct",463:"Feedback Incorrect",318:"Show hints",319:"Hints",372:"Question pool",376:"Question display",382:"Enumeration internal",383:"Activity pool",375:"LO sections",394:"Score-Values-Per-Block",367:"Eraser",395:"Export File",396:"Textbox Autogrow",397:"Checkbox Selections",398:"Repeat Answers",399:"Free Drag Location",400:"Pool Stacks",401:"Audio in gap",402:"Order Dependency",403:"Gap Resize",404:"Score calculation",364:"Ignore Accents",406:"Pool order",407:"Automatic capitalisation",408:"Marking style",412:"Container Style",416:"Answer display",417:"Link behaviour",419:"Restore LO State",425:"Gap characters",427:"Team scoring",421:"Wiki Tool",422:"Operator",426:"Layers",428:"Reference Content",430:"Alternative Text",431:"Audio Playback",432:"LO title display",433:"Activity title display",435:"Number columns",437:"Automatic play",438:"Shuffle control",439:"Additional image control",441:"Audio icon behaviour",442:"User selection",443:"LO fullscreen button",445:"User Visibility",446:"Clues in columns",448:"Try Again Behaviour",455:"TTS General Rules",456:"TTS LO Rules",457:"TTS Activity Rules",449:"See all answers",450:"See next answer",459:"Activity help",452:"Navigation Menu",453:"Display Settings",454:"Resource Banks",479:"Solution Hint",480:"Ignore Spaces",465:"Target image",466:"Target Generator image",467:"Target Generator location",468:"Selector image",469:"Selected Target image",470:"Background image",471:"Scoreboard",472:"Countdown timer",473:"Maximum duration",474:"Maximum items",475:"Movement speed",476:"Generation speed",477:"Game Over message",484:"Copyright Information",483:"Number Input",485:"Target onscreen duration",487:"Online Check",492:"Signal targets",493:"Check answers instant",495:"Validate dependent gaps",497:"Play all",498:"Download audio",499:"Hide lines",501:"Gapfill behaviour",502:"Group headings",503:"Display as completed",504:"Origin of targets",505:"Translation Block",508:"Flash first answer",509:"Set User Role",510:"Score Rounding",511:"Next button text",512:"Check Answers Display",513:"Original Audio Playback",516:"Number of chances",517:"Keyboard display",518:"Reveal Solution",519:"Hangman Timer",520:"Instruction PopUp",521:"Reset Whole LO",522:"Show Next LO",523:"Show Previous LO",524:"LO Notes Area",525:"Audio speed",527:"SCORM2004 Absolute Values",529:"Highlight selection"},value_map:{"027":{"No enumeration":{key:"false",descr:"No enumeration"},"1.":{key:"number",descr:"1. 2. 3.  ..."},1:{key:"number_no_dot",descr:"1 2 3  ..."},"a)":{key:"letter",descr:"a) b) c) ..."},"A.":{key:"capitalletter",descr:"A. B. C. ..."},"Bullet points":{key:"bullet",descr:"Bullet points"},Custom:{key:"custom",descr:""}},"028":{False:{key:"false",descr:"No enumeration"},"1.":{key:"number",descr:"1. 2. 3.  ..."},1:{key:"number_no_dot",descr:"1 2 3  ..."},"a)":{key:"letter",descr:"a) b) c) ..."},"A.":{key:"capitalletter",descr:"A. B. C. ..."},"Bullet points":{key:"bullet",descr:"Bullet points"},Custom:{key:"custom",descr:""}},"029":{"No prefill":{key:"false",descr:"No answer items are displayed."},"First gap":{key:"firstitem",descr:"The first item is displayed."},"First paragraph":{key:"firstblock",descr:"The answers in the first paragraph are displayed."}},"034":{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},"038":{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},"052":{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},111:{"No pool":{key:"none",descr:"No pool displayed"},Top:{key:"top",descr:"Pool at the top"},Bottom:{key:"bottom",descr:"Pool at the bottom"},Left:{key:"left",descr:"Pool to the left"},Right:{key:"right",descr:"Pool to the right"},Free:{key:"free",descr:"Pool is user moveable"}},113:{Variable:{key:"variable",descr:"Gaps sized according to size of word"},"Same (longest answer)":{key:"samelongest",descr:"All gaps the same size, which equals the largest word"},Invisible:{key:"invisible",descr:"Gaps do not appear until user clicks in space between words"},Fixed:{key:"fixed",descr:"Fixed"}},122:{No:{key:"one",descr:"No"},Unlimited:{key:"unlimited",descr:"Unlimited"},Restricted:{key:"restricted",descr:"Restricted"}},300:{Vertical:{key:"vertical",descr:"Vertical!"},Horizontal:{key:"horizontal",descr:"Horizontal!"},"Horizontal (single word)":{key:"horizontal_single_word",descr:"Horizontal (single word)"}},302:{"Don't hide":{key:"false",descr:"off!"},Hide:{key:"true",descr:"on!"},Custom:{key:"custom",descr:"Custom"}},"025":{On:{key:"true",descr:"on!"},Off:{key:"false",descr:"off!"},"After submitted":{key:"afterSubmitted",descr:"After submitted"}},"045":{Off:{key:"false",descr:"off"},"Keep correct answers":{key:"lock",descr:"Keep correct answers"},"Freeze correct answers":{key:"frozen",descr:"Freeze correct answers"},"Clear all":{key:"clear",descr:"Clear all"},"Keep all":{key:"keepall",descr:"Keep all"}},"050":{On:{key:"true",descr:"on!"},Off:{key:"false",descr:"off!"},Auto:{key:"auto",descr:"auto"},"Screen Selection":{key:"screenSelection",descr:"Screen Selection"}},"072":{On:{key:"true",descr:"on!"},Off:{key:"false",descr:"off!"}},147:{Text:{key:"text",descr:"Text"},Phoneme:{key:"phoneme",descr:"Phoneme"},Media:{key:"media",descr:"Media"},"Media and Text":{key:"mediaandtext",descr:"Media and Text"}},303:{Text:{key:"text",descr:"Text"},Phoneme:{key:"phoneme",descr:"Phoneme"},Media:{key:"media",descr:"Media"},"Media and Text":{key:"mediaandtext",descr:"Media and Text"}},148:{Default:{key:"default",descr:"Default"},"Default sets":{key:"defaultsets",descr:"Default sets"},Image:{key:"image",descr:"Image"},"Image sets":{key:"imagesets",descr:"Image sets"}},149:{Default:{key:"default",descr:"Default"},Sets:{key:"sets",descr:"Sets"},Custom:{key:"custom",descr:"Custom"}},150:{Portrait:{key:"portrait",descr:"Portrait"},Landscape:{key:"landscape",descr:"Landscape"},Square:{key:"square",descr:"Square"}},139:{Off:{key:"false",descr:"off!"},On:{key:"true",descr:"on!"}},362:{No:{key:"false",descr:"No!"},Yes:{key:"true",descr:"Yes"}},107:{No:{key:"false",descr:"No!"},Yes:{key:"normal",descr:"Yes"}},142:{Off:{key:"false",descr:"off!"},On:{key:"true",descr:"on!"}},143:{Off:{key:"false",descr:"off!"},On:{key:"true",descr:"on!"}},"046":{"1 point per action":{key:"1_point_action",descr:""},"1 point per question":{key:"1_point_question",descr:""}},"049":{Off:{key:"false",descr:"off!"},On:{key:"true",descr:"on!"}},"047":{Off:{key:"false",descr:"off!"},On:{key:"true",descr:"on!"}},378:{Off:{key:"off",descr:"off!"},On:{key:"on",descr:"on!"}},342:{Off:{key:"off",descr:"off!"},On:{key:"on",descr:"on!"}},361:{"Don't spellcheck":{key:"off",descr:"Off"},"Enable spellcheck":{key:"on",descr:"On"}},"051":{Off:{key:"false",descr:"off!"},Questions:{key:"questions",descr:"Go to next page when all questions are answered"},Timer:{key:"timer",descr:"Go to next page after a specified time."}},"013":{Off:{key:"false",descr:"off!"},On:{key:"true",descr:"on!"}},"032":{Off:{key:"false",descr:"off!"},On:{key:"true",descr:"on!"}},128:{On:{key:"true",descr:"on!"},Off:{key:"false",descr:"off!"}},109:{Off:{key:"false",descr:"off!"},On:{key:"true",descr:"on!"}},304:{Off:{key:"false",descr:"off!"},On:{key:"true",descr:"on!"}},154:{Pairs:{key:"pairs",descr:"Two columns"},Triplets:{key:"triplets",descr:"Three columns"},Quadruples:{key:"quadruples",descr:"Four columns"},Quintuples:{key:"quintuples",descr:"Five columns"}},158:{dummy:{key:"dummy",descr:"dummy"}},160:{Upper:{key:"upper",descr:"Upper"},Lower:{key:"lower",descr:"Lower"}},118:{"Replace the word":{key:"replace",descr:"replace the word"},"End of line":{key:"line",descr:"end of line"},Sentence:{key:"sentence",descr:"sentence"}},305:{"Inside with mouseover":{key:"inside",descr:"inside"},"Outside the grid":{key:"outside",descr:"outside"}},312:{On:{key:"on",descr:"On"},Off:{key:"off",descr:"Off"},"Before Interaction":{key:"beforeInteraction",descr:"Before Interaction"}},313:{On:{key:"on",descr:"On"},Off:{key:"off",descr:"Off"},"Before submitted":{key:"beforeSubmitted",descr:"Before submitted"}},"021":{Off:{key:"false",descr:"Off"},All:{key:"all",descr:"All"},Progressive:{key:"progressive",descr:"Progressive"},"Progressive plus Hide":{key:"progressiveplushide",descr:"Progressive plus Hide"}},"054":{Off:{key:"false",descr:"off"},"Exercise only":{key:"exercise",descr:"Exercise only"},"My answers":{key:"answers",descr:"My answers"},"With feedback":{key:"feedback",descr:"With feedback"}},120:{None:{key:"false",descr:"none"},Words:{key:"words",descr:"Words"}," Characters":{key:"chars",descr:" Characters"}},119:{Off:{key:"off",descr:"Off"},Highlight:{key:"highlight",descr:"Highlight"},"Button after attempts":{key:"buttonAfterAttempts",descr:"Button after attempts"},"Button always on":{key:"button",descr:"Button always on"}},306:{Vertical:{key:"vertical",descr:"vertical"},Horizontal:{key:"horizontal",descr:"horizontal"},Inline:{key:"inline",descr:"inline"}},323:{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},324:{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},311:{Always:{key:"always",descr:"Always"},Off:{key:"false",descr:"off"},"After one answer":{key:"afterOne",descr:"After one answer"},"After all answers":{key:"afterAll",descr:"After all answers"},"Before submitted":{key:"beforeSubmitted",descr:"Before submitted"}},317:{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},162:{Off:{key:"false",descr:"No scroll"},On:{key:"true",descr:"Scroll with page"}},"023":{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},327:{Cards:{key:"cards",descr:"Cards"}},"026":{Next:{key:"next",descr:"Next"},Adaptive:{key:"adaptive",descr:""}},336:{Always:{key:"always",descr:"Always"},Off:{key:"off",descr:"Off"},"After one answer":{key:"afterOne",descr:"After one answer"},"After submitted":{key:"afterSubmitted",descr:"After submitted"},"After all answers":{key:"afterAll",descr:"After all answers"},"After Check Answers":{key:"afterCheckAnswers",descr:""},"After see answers":{key:"afterSeeAnswers",descr:"After see answers"}},387:{Enabled:{key:"true",descr:"Enabled"},Disabled:{key:"false",descr:"Disabled"}},388:{Off:{key:"off",descr:"Off"},Unlimited:{key:"unlimited",descr:"Unlimited"},"1 submission":{key:"1_submission",descr:"1 submission"},"Final Check answers":{key:"final_check_answers",descr:"Final Check answers"}},390:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},391:{"Last activity":{key:"last",descr:"Last activity"},"First activity":{key:"first",descr:"First activity"}},315:{1:{key:"1",descr:"1"},2:{key:"2",descr:"2"},3:{key:"3",descr:"3"},4:{key:"4",descr:"4"},5:{key:"5",descr:"5"},6:{key:"6",descr:"6"},7:{key:"7",descr:"7"},8:{key:"8",descr:"8"},9:{key:"9",descr:"9"},10:{key:"10",descr:"10"},11:{key:"11",descr:"11"},12:{key:"12",descr:"12"},13:{key:"13",descr:"13"},14:{key:"14",descr:"14"},15:{key:"15",descr:"15"},16:{key:"16",descr:"16"},17:{key:"17",descr:"17"},18:{key:"18",descr:"18"},19:{key:"19",descr:"19"},20:{key:"20",descr:"20"},Unlimited:{key:"unlimited",descr:"Unlimited"}},334:{Always:{key:"always",descr:"Always"},Off:{key:"off",descr:"Off"},"After one answer":{key:"afterOne",descr:"After one answer"},"After all answers":{key:"afterAll",descr:"After all answers"},"Displayed on each screen":{key:"eachScreen",descr:"Displayed on each screen"}},335:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},"01":{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},"06":{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},"040":{Normal:{key:"normal",descr:"Normal"},Instant:{key:"instant",descr:"Instant"}},322:{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"},Custom:{key:"custom",descr:"custom"}},"056":{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},114:{Off:{key:"off",descr:"Off"},"Skin Button":{key:"skinbutton",descr:"Skin Button"},"Button only":{key:"button_only",descr:"Button only"}},341:{On:{key:"on",descr:"On"},Off:{key:"off",descr:"Off"}},"043":{Off:{key:"off",descr:"off"},Custom:{key:"custom",descr:"custom"}},"044":{None:{key:"none",descr:"None"},"Sound effects":{key:"sound_effects",descr:"Sound effects"}},330:{"Dont't hide":{key:"false",descr:"off!"},Hide:{key:"true",descr:"on!"}},"098":{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},"09":{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},112:{"On top":{key:"ontop",descr:"On top"},Horizontal:{key:"horizontal",descr:"Horizontal"},Vertical:{key:"vertical",descr:"Vertical"}},337:{Off:{key:"false",descr:"off"},On:{key:"true",descr:"on"}},326:{On:{key:"true",descr:"on"},Off:{key:"false",descr:"off"}},345:{Off:{key:"off",descr:"off"},On:{key:"on",descr:"on"}},340:{None:{key:"false",descr:"None"},Custom:{key:"custom",descr:"Custom"}},384:{Custom:{key:"custom",descr:"Custom"}},346:{None:{key:"false",descr:"None"},Custom:{key:"custom",descr:"Custom"}},347:{None:{key:"false",descr:"None"},Custom:{key:"custom",descr:"Custom"}},348:{None:{key:"false",descr:"None"},Custom:{key:"custom",descr:"Custom"}},349:{None:{key:"false",descr:"None"},Custom:{key:"custom",descr:"Custom"}},357:{Custom:{key:"custom",descr:"Custom"}},353:{None:{key:"false",descr:"None"},Custom:{key:"custom",descr:"Custom"}},354:{None:{key:"false",descr:"None"},Custom:{key:"custom",descr:"Custom"}},355:{None:{key:"false",descr:"None"},Custom:{key:"custom",descr:"Custom"}},356:{None:{key:"false",descr:"None"},Custom:{key:"custom",
descr:"Custom"}},352:{"Scientific Characters":{key:"Scientific_Characters",descr:""},"Ancient Greek":{key:"Ancient_Greek",descr:""},Danish:{key:"Danish",descr:""},French:{key:"French",descr:""},German:{key:"German",descr:""},Polish:{key:"Polish",descr:""},Spanish:{key:"Spanish",descr:""},Swedish:{key:"Swedish",descr:""},Turkish:{key:"Turkish",descr:""},"Arithmetic Operators":{key:"Arithmetic_Operators",descr:""}},368:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"},"Only for Teachers":{key:"only_for_teachers",descr:"Only for Teachers"},"Only Supplements":{key:"only_supplements",descr:"Only Supplements"}},371:{Off:{key:"off",descr:"Off"},Tooltip:{key:"tooltip",descr:"Tooltip"}},373:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},379:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},462:{No:{key:"no",descr:"no"},Custom:{key:"custom",descr:"custom"}},463:{No:{key:"no",descr:"no"},Custom:{key:"custom",descr:"custom"}},318:{Off:{key:"off",descr:"off"},Always:{key:"always",descr:"Always"},"Check Score":{key:"checkScore",descr:"Check Score"}},319:{None:{key:"false",descr:"None"},Custom:{key:"custom",descr:"Custom"}},372:{No:{key:"no",descr:"No"},Yes:{key:"yes",descr:"Yes"}},376:{"Show all":{key:"all",descr:"Show all"},"Show active only":{key:"active",descr:"Show active only"},"Show next":{key:"show_next",descr:"Show next"},"Show next and hide current one on click":{key:"show_next_and_hide_previous",descr:"Show next and hide previous"}},382:{"Show all":{key:"all",descr:"Show all"},"Show active only":{key:"active",descr:"Show active only"},"Only Correct":{key:"correct",descr:"Only Correct"}},383:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"},"Randomise All":{key:"randomiseAll",descr:"Randomise All"}},375:{OFF:{key:"off",descr:"Off"},om:{key:"custom",descr:"1"}},394:{Off:{key:"off",descr:"Off"},Custom:{key:"Custom",descr:"Custom"}},367:{"Don't display eraser":{key:"off",descr:"Off"},"Display eraser":{key:"on",descr:"On"}},395:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},396:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},397:{"Total Correct":{key:"total_correct",descr:"Total Correct"},All:{key:"all",descr:"All"}},398:{Allow:{key:"allow",descr:"Allow"},Prevent:{key:"prevent",descr:"Prevent"}},399:{Off:{key:"off",descr:"Off"},"Between Words":{key:"between_words",descr:"Between Words"},"Between Letters":{key:"between_letters",descr:"Between Letters"}},400:{Off:{key:"off",descr:"Off"},1:{key:"1",descr:"1"},2:{key:"2",descr:"1"},3:{key:"3",descr:"3"},4:{key:"4",descr:"4"}},401:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},402:{Off:{key:"off",descr:"Off"},"From first answer":{key:"first_answer",descr:"From first answer"},"Longest combination":{key:"on",descr:"Longest combination"}},403:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},404:{"Only correct":{key:"onlyCorrect",descr:"Only correct"},"Subtract incorrect":{key:"subtractIncorrect",descr:"Subtract incorrect"}},364:{"Don't ignore accents":{key:"off",descr:"Off"},"Ignore accents":{key:"on",descr:"On"}},406:{Off:{key:"off",descr:"Off"},Alphabetical:{key:"alphabetical",descr:"Alphabetical"},Natural:{key:"natural",descr:"Natural"}},407:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},408:{Highlight:{key:"highlight",descr:"Highlight"},Circle:{key:"circle",descr:"Circle"},Underline:{key:"underline",descr:"Underline"}},412:{Normal:{key:"normal",descr:"Normal"},Custom:{key:"custom",descr:"Custom"}},416:{Columns:{key:"columns",descr:"Columns"},Rows:{key:"rows",descr:"Rows"}},417:{Drag:{key:"drag",descr:"Drag"},Touch:{key:"touch",descr:"Touch"}},419:{On:{key:"on",descr:"On"},Off:{key:"off",descr:"Off"}},425:{"Don't show":{key:"dontshow",descr:"Don't show"},Show:{key:"show",descr:"Show"}},427:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},421:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},422:{Addition:{key:"addition",descr:"Addition"},Multiplication:{key:"multiplication",descr:"Multiplication"}},426:{3:{key:"3",descr:"3"},4:{key:"4",descr:"4"},5:{key:"5",descr:"5"}},428:{Off:{key:"off",descr:"Off"},1:{key:"1",descr:"1"},2:{key:"2",descr:"2"}},430:{Off:{key:"off",descr:"Off"},Alt1:{key:"alt1",descr:"Alt1"},Alt2:{key:"alt2",descr:"Alt2"},Alt3:{key:"alt3",descr:"Alt3"}},431:{Auto:{key:"auto",descr:"Auto"},Manual:{key:"manual",descr:"Manual"},"Before Card Flip":{key:"before_card_flip",descr:"Before Card Flip"}},432:{On:{key:"on",descr:"On"},Off:{key:"off",descr:"Off"}},433:{On:{key:"on",descr:"On"},Off:{key:"off",descr:"Off"}},435:{3:{key:"3",descr:"3"},4:{key:"4",descr:"4"},5:{key:"5",descr:"5"}},437:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"},"On and magnify":{key:"on_magnify",descr:"On and magnify"}},438:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},439:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},441:{Stop:{key:"stop",descr:"Stop"},Pause:{key:"pause",descr:"Pause"}},442:{Off:{key:"off",descr:"Off"},"Select for correct":{key:"select_for_correct",descr:"Select for correct"},"Select for error":{key:"select_for_error",descr:"Select for error"}},443:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},445:{All:{key:"all",descr:"All"},Teacher:{key:"teacher",descr:"Teacher"},Student:{key:"student",descr:"Student"}},446:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},448:{Button:{key:"button",descr:"Button"},Automatic:{key:"automatic",descr:"Automatic"}},455:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},456:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},457:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},449:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},450:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},459:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},452:{Off:{key:"off",descr:"Off"},Auto:{key:"auto",descr:"Auto"},Custom:{key:"custom",descr:"Custom"}},453:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},454:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},479:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},480:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},465:{Custom:{key:"custom",descr:"Custom"}},466:{Custom:{key:"custom",descr:"Custom"}},467:{"Bottom Right":{key:"bottom_right",descr:"Bottom Right"},"Bottom Left":{key:"bottom_left",descr:"Bottom Left"},"Top Right":{key:"top_right",descr:"Top Right"},"Top Left":{key:"top_left",descr:"Top Left"}},468:{Custom:{key:"custom",descr:"Custom"}},469:{Custom:{key:"custom",descr:"Custom"}},470:{Custom:{key:"custom",descr:"Custom"}},471:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},472:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},473:{Off:{key:"off",descr:"off"},Custom:{key:"custom",descr:"Custom"}},474:{Off:{key:"off",descr:"off"},Custom:{key:"custom",descr:"Custom"}},475:{Slow:{key:"slow",descr:"Slow"},Medium:{key:"medium",descr:"Medium"},Fast:{key:"fast",descr:"Fast"}},476:{Slow:{key:"slow",descr:"Slow"},Medium:{key:"medium",descr:"Medium"},Fast:{key:"fast",descr:"Fast"}},477:{Custom:{key:"custom",descr:"Custom"}},484:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},483:{Any:{key:"any",descr:"Any"},Natural:{key:"natural",descr:"Natural"},Integer:{key:"integer",descr:"Integer"}},485:{Off:{key:"off",descr:"off"},Custom:{key:"custom",descr:"Custom"}},487:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},492:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},493:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},495:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},497:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},498:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},499:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},501:{Drag:{key:"drag",descr:"Drag"},"Tap item":{key:"tap_item",descr:"Tap item"},"Tap target":{key:"tap_target",descr:"Tap target"},"Tap swap":{key:"tap_swap",descr:"Tap swap"}},502:{Off:{key:"off",descr:"off"},Custom:{key:"custom",descr:"custom"}},503:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},504:{Default:{key:"default",descr:"Default"},Custom:{key:"custom",descr:"Custom"}},505:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},508:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},509:{Free:{key:"Free",descr:"Free"},"Role 1":{key:"role_1",descr:"Role 1"},"Role 2":{key:"role_2",descr:"Role 2"}},510:{Float:{key:"float",descr:"Float"},"Round up":{key:"roundup",descr:"Round up"},Round:{key:"round",descr:"Round"},"Round down":{key:"rounddown",descr:"Round down"}},511:{Default:{descr:"Default",key:"default"},Custom:{descr:"Custom",key:"custom"}},512:{"Marking and Feedback":{key:"marking_and_feedback",descr:"Marking and Feedback"},"Marking only":{key:"marking_only",descr:"Marking only"}},513:{"Both roles":{key:"both_roles",descr:"Both roles"},"Non-selected Role Only":{key:"non_selected_role_only",descr:"Non-selected Role Only"}},516:{1:{key:"1",descr:"1"},2:{key:"2",descr:"2"},3:{key:"3",descr:"3"},4:{key:"4",descr:"4"},5:{key:"5",descr:"5"}},517:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},518:{"After final chance":{key:"after_final_chance",descr:"After final chance"},"With button":{key:"with_button",descr:"With button"}},519:{Off:{key:"off",descr:"Off"},Custom:{key:"custom",descr:"Custom"}},520:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},521:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},522:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},523:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},524:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},525:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},527:{Off:{key:"off",descr:"Off"},On:{key:"on",descr:"On"}},529:{Words:{key:"words",descr:"Words"},Letters:{key:"letters",descr:"Letters"}}},getEnumeration:function(){return this.has("027")?this.hasValue("027")?this.getValue("027"):this.get("027"):"false"},enumerationIsFalse:function(){return!this.has("027")||"false"==this.get("027")},enumerationIsNumber:function(){return!!this.has("027")&&"number"==this.get("027")},enumerationIsNumber_no_dot:function(){return!!this.has("027")&&"number_no_dot"==this.get("027")},enumerationIsLetter:function(){return!!this.has("027")&&"letter"==this.get("027")},enumerationIsCapitalletter:function(){return!!this.has("027")&&"capitalletter"==this.get("027")},enumerationIsBullet:function(){return!!this.has("027")&&"bullet"==this.get("027")},enumerationIsCustom:function(){return!!this.has("027")&&"custom"==this.get("027")},getEnumerationAnswers:function(){return this.has("028")?this.hasValue("028")?this.getValue("028"):this.get("028"):"false"},enumerationAnswersIsFalse:function(){return!this.has("028")||"false"==this.get("028")},enumerationAnswersIsNumber:function(){return!!this.has("028")&&"number"==this.get("028")},enumerationAnswersIsNumber_no_dot:function(){return!!this.has("028")&&"number_no_dot"==this.get("028")},enumerationAnswersIsLetter:function(){return!!this.has("028")&&"letter"==this.get("028")},enumerationAnswersIsCapitalletter:function(){return!!this.has("028")&&"capitalletter"==this.get("028")},enumerationAnswersIsBullet:function(){return!!this.has("028")&&"bullet"==this.get("028")},enumerationAnswersIsCustom:function(){return!!this.has("028")&&"custom"==this.get("028")},getPrefill:function(){return this.has("029")?this.hasValue("029")?this.getValue("029"):this.get("029"):"false"},prefillIsFalse:function(){return!this.has("029")||"false"==this.get("029")},prefillIsFirstitem:function(){return!!this.has("029")&&"firstitem"==this.get("029")},prefillIsFirstblock:function(){return!!this.has("029")&&"firstblock"==this.get("029")},getGaptextaudio:function(){return this.has("034")?this.hasValue("034")?this.getValue("034"):this.get("034"):"false"},gaptextaudioIsFalse:function(){return!this.has("034")||"false"==this.get("034")},gaptextaudioIsTrue:function(){return!!this.has("034")&&"true"==this.get("034")},getSpeaklearnerinput:function(){return this.has("038")?this.hasValue("038")?this.getValue("038"):this.get("038"):"false"},speaklearnerinputIsFalse:function(){return!this.has("038")||"false"==this.get("038")},speaklearnerinputIsTrue:function(){return!!this.has("038")&&"true"==this.get("038")},getAudiosupport:function(){return this.has("052")?this.hasValue("052")?this.getValue("052"):this.get("052"):"false"},audiosupportIsFalse:function(){return!this.has("052")||"false"==this.get("052")},audiosupportIsTrue:function(){return!!this.has("052")&&"true"==this.get("052")},getPoolAlignment:function(){return this.has("111")?this.hasValue("111")?this.getValue("111"):this.get("111"):"none"},poolAlignmentIsNone:function(){return!this.has("111")||"none"==this.get("111")},poolAlignmentIsTop:function(){return!!this.has("111")&&"top"==this.get("111")},poolAlignmentIsBottom:function(){return!!this.has("111")&&"bottom"==this.get("111")},poolAlignmentIsLeft:function(){return!!this.has("111")&&"left"==this.get("111")},poolAlignmentIsRight:function(){return!!this.has("111")&&"right"==this.get("111")},poolAlignmentIsFree:function(){return!!this.has("111")&&"free"==this.get("111")},getGaps:function(){return this.has("113")?this.hasValue("113")?this.getValue("113"):this.get("113"):"variable"},gapsIsVariable:function(){return!this.has("113")||"variable"==this.get("113")},gapsIsSamelongest:function(){return!!this.has("113")&&"samelongest"==this.get("113")},gapsIsInvisible:function(){return!!this.has("113")&&"invisible"==this.get("113")},gapsIsFixed:function(){return!!this.has("113")&&"fixed"==this.get("113")},getMultipleDestinations:function(){return this.has("122")?this.hasValue("122")?this.getValue("122"):this.get("122"):"one"},multipleDestinationsIsOne:function(){return!this.has("122")||"one"==this.get("122")},multipleDestinationsIsUnlimited:function(){return!!this.has("122")&&"unlimited"==this.get("122")},multipleDestinationsIsRestricted:function(){return!!this.has("122")&&"restricted"==this.get("122")},getDragAlignment:function(){return this.has("300")?this.hasValue("300")?this.getValue("300"):this.get("300"):"vertical"},dragAlignmentIsVertical:function(){return!this.has("300")||"vertical"==this.get("300")},dragAlignmentIsHorizontal:function(){return!!this.has("300")&&"horizontal"==this.get("300")},dragAlignmentIsHorizontal_single_word:function(){return!!this.has("300")&&"horizontal_single_word"==this.get("300")},getHideRadiobuttons:function(){return this.has("302")?this.hasValue("302")?this.getValue("302"):this.get("302"):"false"},hideRadiobuttonsIsFalse:function(){return!this.has("302")||"false"==this.get("302")},hideRadiobuttonsIsTrue:function(){return!!this.has("302")&&"true"==this.get("302")},hideRadiobuttonsIsCustom:function(){return!!this.has("302")&&"custom"==this.get("302")},getPrevious:function(){return this.has("025")?this.hasValue("025")?this.getValue("025"):this.get("025"):"true"},previousIsTrue:function(){return!this.has("025")||"true"==this.get("025")},previousIsFalse:function(){return!!this.has("025")&&"false"==this.get("025")},previousIsAfterSubmitted:function(){return!!this.has("025")&&"afterSubmitted"==this.get("025")},getTryAgain:function(){return this.has("045")?this.hasValue("045")?this.getValue("045"):this.get("045"):"false"},tryAgainIsFalse:function(){return!this.has("045")||"false"==this.get("045")},tryAgainIsLock:function(){return!!this.has("045")&&"lock"==this.get("045")},tryAgainIsFrozen:function(){return!!this.has("045")&&"frozen"==this.get("045")},tryAgainIsClear:function(){return!!this.has("045")&&"clear"==this.get("045")},tryAgainIsKeepall:function(){return!!this.has("045")&&"keepall"==this.get("045")},getProgressBar:function(){return this.has("050")?this.hasValue("050")?this.getValue("050"):this.get("050"):"true"},progressBarIsTrue:function(){return!this.has("050")||"true"==this.get("050")},progressBarIsFalse:function(){return!!this.has("050")&&"false"==this.get("050")},progressBarIsAuto:function(){return!!this.has("050")&&"auto"==this.get("050")},progressBarIsScreenSelection:function(){return!!this.has("050")&&"screenSelection"==this.get("050")},getConserveanswers:function(){return this.has("072")?this.hasValue("072")?this.getValue("072"):this.get("072"):"true"},conserveanswersIsTrue:function(){return!this.has("072")||"true"==this.get("072")},conserveanswersIsFalse:function(){return!!this.has("072")&&"false"==this.get("072")},getCardContent:function(){return this.has("147")?this.hasValue("147")?this.getValue("147"):this.get("147"):"text"},cardContentIsText:function(){return!this.has("147")||"text"==this.get("147")},cardContentIsPhoneme:function(){return!!this.has("147")&&"phoneme"==this.get("147")},cardContentIsMedia:function(){return!!this.has("147")&&"media"==this.get("147")},cardContentIsMediaandtext:function(){return!!this.has("147")&&"mediaandtext"==this.get("147")},getCardBackContent:function(){return this.has("303")?this.hasValue("303")?this.getValue("303"):this.get("303"):"text"},cardBackContentIsText:function(){return!this.has("303")||"text"==this.get("303")},cardBackContentIsPhoneme:function(){return!!this.has("303")&&"phoneme"==this.get("303")},cardBackContentIsMedia:function(){return!!this.has("303")&&"media"==this.get("303")},cardBackContentIsMediaandtext:function(){return!!this.has("303")&&"mediaandtext"==this.get("303")},getCardBack:function(){return this.has("148")?this.hasValue("148")?this.getValue("148"):this.get("148"):"default"},cardBackIsDefault:function(){return!this.has("148")||"default"==this.get("148")},cardBackIsDefaultsets:function(){return!!this.has("148")&&"defaultsets"==this.get("148")},cardBackIsImage:function(){return!!this.has("148")&&"image"==this.get("148")},cardBackIsImagesets:function(){return!!this.has("148")&&"imagesets"==this.get("148")},getCardLayout:function(){return this.has("149")?this.hasValue("149")?this.getValue("149"):this.get("149"):"default"},cardLayoutIsDefault:function(){return!this.has("149")||"default"==this.get("149")},cardLayoutIsSets:function(){return!!this.has("149")&&"sets"==this.get("149")},cardLayoutIsCustom:function(){return!!this.has("149")&&"custom"==this.get("149")},getCardFormat:function(){return this.has("150")?this.hasValue("150")?this.getValue("150"):this.get("150"):"portrait"},cardFormatIsPortrait:function(){return!this.has("150")||"portrait"==this.get("150")},cardFormatIsLandscape:function(){return!!this.has("150")&&"landscape"==this.get("150")},cardFormatIsSquare:function(){return!!this.has("150")&&"square"==this.get("150")},getModelText:function(){return this.has("139")?this.hasValue("139")?this.getValue("139"):this.get("139"):"false"},modelTextIsFalse:function(){return!this.has("139")||"false"==this.get("139")},modelTextIsTrue:function(){return!!this.has("139")&&"true"==this.get("139")},getShowInColumns:function(){return this.has("362")?this.hasValue("362")?this.getValue("362"):this.get("362"):"false"},showInColumnsIsFalse:function(){return!this.has("362")||"false"==this.get("362")},showInColumnsIsTrue:function(){return!!this.has("362")&&"true"==this.get("362")},getAddTextObject:function(){return this.has("107")?this.hasValue("107")?this.getValue("107"):this.get("107"):"false"},addTextObjectIsFalse:function(){return!this.has("107")||"false"==this.get("107")},addTextObjectIsNormal:function(){return!!this.has("107")&&"normal"==this.get("107")},getQuestionAsMedia:function(){return this.has("142")?this.hasValue("142")?this.getValue("142"):this.get("142"):"false"},questionAsMediaIsFalse:function(){return!this.has("142")||"false"==this.get("142")},questionAsMediaIsTrue:function(){return!!this.has("142")&&"true"==this.get("142")},getAnswersAsMedia:function(){return this.has("143")?this.hasValue("143")?this.getValue("143"):this.get("143"):"false"},answersAsMediaIsFalse:function(){return!this.has("143")||"false"==this.get("143")},answersAsMediaIsTrue:function(){return!!this.has("143")&&"true"==this.get("143")},getScoreValues:function(){return this.has("046")?this.hasValue("046")?this.getValue("046"):this.get("046"):"1_point_action"},scoreValuesIs1_point_action:function(){return!this.has("046")||"1_point_action"==this.get("046")},scoreValuesIs1_point_question:function(){return!!this.has("046")&&"1_point_question"==this.get("046")},getTimer:function(){return this.has("049")?this.hasValue("049")?this.getValue("049"):this.get("049"):"false"},timerIsFalse:function(){return!this.has("049")||"false"==this.get("049")},timerIsTrue:function(){return!!this.has("049")&&"true"==this.get("049")},getEndResultScreen:function(){return this.has("047")?this.hasValue("047")?this.getValue("047"):this.get("047"):"false"},endResultScreenIsFalse:function(){return!this.has("047")||"false"==this.get("047")},endResultScreenIsTrue:function(){return!!this.has("047")&&"true"==this.get("047")},getEndResultAlways:function(){return this.has("378")?this.hasValue("378")?this.getValue("378"):this.get("378"):"off"},endResultAlwaysIsOff:function(){return!this.has("378")||"off"==this.get("378")},endResultAlwaysIsOn:function(){return!!this.has("378")&&"on"==this.get("378")},getIntroScreen:function(){return this.has("342")?this.hasValue("342")?this.getValue("342"):this.get("342"):"off"},introScreenIsOff:function(){return!this.has("342")||"off"==this.get("342")},introScreenIsOn:function(){return!!this.has("342")&&"on"==this.get("342")},getSpellcheck:function(){return this.has("361")?this.hasValue("361")?this.getValue("361"):this.get("361"):"off"},spellcheckIsOff:function(){return!this.has("361")||"off"==this.get("361")},spellcheckIsOn:function(){return!!this.has("361")&&"on"==this.get("361")},getAutomaticNext:function(){return this.has("051")?this.hasValue("051")?this.getValue("051"):this.get("051"):"false"},automaticNextIsFalse:function(){return!this.has("051")||"false"==this.get("051")},automaticNextIsQuestions:function(){return!!this.has("051")&&"questions"==this.get("051")},automaticNextIsTimer:function(){return!!this.has("051")&&"timer"==this.get("051")},getEmailBank:function(){return this.has("013")?this.hasValue("013")?this.getValue("013"):this.get("013"):"false"},emailBankIsFalse:function(){return!this.has("013")||"false"==this.get("013")},emailBankIsTrue:function(){return!!this.has("013")&&"true"==this.get("013")},getItemPool:function(){return this.has("032")?this.hasValue("032")?this.getValue("032"):this.get("032"):"false"},itemPoolIsFalse:function(){return!this.has("032")||"false"==this.get("032")},itemPoolIsTrue:function(){return!!this.has("032")&&"true"==this.get("032")},getDropIndicator:function(){return this.has("128")?this.hasValue("128")?this.getValue("128"):this.get("128"):"true"},dropIndicatorIsTrue:function(){return!this.has("128")||"true"==this.get("128")},dropIndicatorIsFalse:function(){return!!this.has("128")&&"false"==this.get("128")},getUseClickClick:function(){return this.has("109")?this.hasValue("109")?this.getValue("109"):this.get("109"):"false"},useClickClickIsFalse:function(){return!this.has("109")||"false"==this.get("109")},useClickClickIsTrue:function(){return!!this.has("109")&&"true"==this.get("109")},getPlaceTheObjects:function(){return this.has("304")?this.hasValue("304")?this.getValue("304"):this.get("304"):"false"},placeTheObjectsIsFalse:function(){return!this.has("304")||"false"==this.get("304")},placeTheObjectsIsTrue:function(){return!!this.has("304")&&"true"==this.get("304")},getLinkingLinesSets:function(){return this.has("154")?this.hasValue("154")?this.getValue("154"):this.get("154"):"pairs"},linkingLinesSetsIsPairs:function(){return!this.has("154")||"pairs"==this.get("154")},linkingLinesSetsIsTriplets:function(){return!!this.has("154")&&"triplets"==this.get("154")},linkingLinesSetsIsQuadruples:function(){return!!this.has("154")&&"quadruples"==this.get("154")},linkingLinesSetsIsQuintuples:function(){return!!this.has("154")&&"quintuples"==this.get("154")},getSize:function(){return this.has("158")?this.hasValue("158")?this.getValue("158"):this.get("158"):"dummy"},sizeIsDummy:function(){return!this.has("158")||"dummy"==this.get("158")},getCase:function(){return this.has("160")?this.hasValue("160")?this.getValue("160"):this.get("160"):"upper"},caseIsUpper:function(){return!this.has("160")||"upper"==this.get("160")},caseIsLower:function(){return!!this.has("160")&&"lower"==this.get("160")},getErrorCorrection:function(){return this.has("118")?this.hasValue("118")?this.getValue("118"):this.get("118"):"replace"},errorCorrectionIsReplace:function(){return!this.has("118")||"replace"==this.get("118")},errorCorrectionIsLine:function(){return!!this.has("118")&&"line"==this.get("118")},errorCorrectionIsSentence:function(){return!!this.has("118")&&"sentence"==this.get("118")},getClueposition:function(){return this.has("305")?this.hasValue("305")?this.getValue("305"):this.get("305"):"inside"},cluepositionIsInside:function(){return!this.has("305")||"inside"==this.get("305")},cluepositionIsOutside:function(){return!!this.has("305")&&"outside"==this.get("305")},getSeeAnswers:function(){return this.has("312")?this.hasValue("312")?this.getValue("312"):this.get("312"):"on"},seeAnswersIsOn:function(){return!this.has("312")||"on"==this.get("312")},seeAnswersIsOff:function(){return!!this.has("312")&&"off"==this.get("312")},seeAnswersIsBeforeInteraction:function(){return!!this.has("312")&&"beforeInteraction"==this.get("312")},getReset:function(){return this.has("313")?this.hasValue("313")?this.getValue("313"):this.get("313"):"on"},resetIsOn:function(){return!this.has("313")||"on"==this.get("313")},resetIsOff:function(){return!!this.has("313")&&"off"==this.get("313")},resetIsBeforeSubmitted:function(){return!!this.has("313")&&"beforeSubmitted"==this.get("313")},getRevealObject:function(){return this.has("021")?this.hasValue("021")?this.getValue("021"):this.get("021"):"false"},revealObjectIsFalse:function(){return!this.has("021")||"false"==this.get("021")},revealObjectIsAll:function(){return!!this.has("021")&&"all"==this.get("021")},revealObjectIsProgressive:function(){return!!this.has("021")&&"progressive"==this.get("021")},revealObjectIsProgressiveplushide:function(){return!!this.has("021")&&"progressiveplushide"==this.get("021")},getPrintable:function(){return this.has("054")?this.hasValue("054")?this.getValue("054"):this.get("054"):"false"},printableIsFalse:function(){return!this.has("054")||"false"==this.get("054")},printableIsExercise:function(){return!!this.has("054")&&"exercise"==this.get("054")},printableIsAnswers:function(){return!!this.has("054")&&"answers"==this.get("054")},printableIsFeedback:function(){return!!this.has("054")&&"feedback"==this.get("054")},getMaxLength:function(){return this.has("120")?this.hasValue("120")?this.getValue("120"):this.get("120"):"false"},maxLengthIsFalse:function(){return!this.has("120")||"false"==this.get("120")},maxLengthIsWords:function(){return!!this.has("120")&&"words"==this.get("120")},maxLengthIsChars:function(){return!!this.has("120")&&"chars"==this.get("120")},getSignalError:function(){return this.has("119")?this.hasValue("119")?this.getValue("119"):this.get("119"):"off"},signalErrorIsOff:function(){return!this.has("119")||"off"==this.get("119")},signalErrorIsHighlight:function(){return!!this.has("119")&&"highlight"==this.get("119")},signalErrorIsButtonAfterAttempts:function(){return!!this.has("119")&&"buttonAfterAttempts"==this.get("119")},signalErrorIsButton:function(){return!!this.has("119")&&"button"==this.get("119")},getChoiceAlignment:function(){return this.has("306")?this.hasValue("306")?this.getValue("306"):this.get("306"):"vertical"},choiceAlignmentIsVertical:function(){return!this.has("306")||"vertical"==this.get("306")},choiceAlignmentIsHorizontal:function(){return!!this.has("306")&&"horizontal"==this.get("306")},choiceAlignmentIsInline:function(){return!!this.has("306")&&"inline"==this.get("306")},getCaseInsensitive:function(){return this.has("323")?this.hasValue("323")?this.getValue("323"):this.get("323"):"false"},caseInsensitiveIsFalse:function(){return!this.has("323")||"false"==this.get("323")},caseInsensitiveIsTrue:function(){return!!this.has("323")&&"true"==this.get("323")},getIgnorePunctuation:function(){return this.has("324")?this.hasValue("324")?this.getValue("324"):this.get("324"):"false"},ignorePunctuationIsFalse:function(){return!this.has("324")||"false"==this.get("324")},ignorePunctuationIsTrue:function(){return!!this.has("324")&&"true"==this.get("324")},getCheckAnswers:function(){return this.has("311")?this.hasValue("311")?this.getValue("311"):this.get("311"):"always"},checkAnswersIsAlways:function(){return!this.has("311")||"always"==this.get("311")},checkAnswersIsFalse:function(){return!!this.has("311")&&"false"==this.get("311")},checkAnswersIsAfterOne:function(){return!!this.has("311")&&"afterOne"==this.get("311")},checkAnswersIsAfterAll:function(){return!!this.has("311")&&"afterAll"==this.get("311")},checkAnswersIsBeforeSubmitted:function(){return!!this.has("311")&&"beforeSubmitted"==this.get("311")},getRunningscore:function(){return this.has("317")?this.hasValue("317")?this.getValue("317"):this.get("317"):"false"},runningscoreIsFalse:function(){return!this.has("317")||"false"==this.get("317")},runningscoreIsTrue:function(){return!!this.has("317")&&"true"==this.get("317")},getStayinview:function(){return this.has("162")?this.hasValue("162")?this.getValue("162"):this.get("162"):"false"},stayinviewIsFalse:function(){return!this.has("162")||"false"==this.get("162")},stayinviewIsTrue:function(){return!!this.has("162")&&"true"==this.get("162")},getPinobject:function(){return this.has("023")?this.hasValue("023")?this.getValue("023"):this.get("023"):"false"},pinobjectIsFalse:function(){return!this.has("023")||"false"==this.get("023")},pinobjectIsTrue:function(){return!!this.has("023")&&"true"==this.get("023")},getCardPerRow:function(){return this.has("327")?this.hasValue("327")?this.getValue("327"):this.get("327"):"cards"},cardPerRowIsCards:function(){return!this.has("327")||"cards"==this.get("327")},getForwardButton:function(){return this.has("026")?this.hasValue("026")?this.getValue("026"):this.get("026"):"next"},forwardButtonIsNext:function(){return!this.has("026")||"next"==this.get("026")},forwardButtonIsAdaptive:function(){return!!this.has("026")&&"adaptive"==this.get("026")},getShowForward:function(){return this.has("336")?this.hasValue("336")?this.getValue("336"):this.get("336"):"always"},showForwardIsAlways:function(){return!this.has("336")||"always"==this.get("336")},showForwardIsOff:function(){return!!this.has("336")&&"off"==this.get("336")},showForwardIsAfterOne:function(){return!!this.has("336")&&"afterOne"==this.get("336")},showForwardIsAfterSubmitted:function(){return!!this.has("336")&&"afterSubmitted"==this.get("336")},showForwardIsAfterAll:function(){return!!this.has("336")&&"afterAll"==this.get("336")},showForwardIsAfterCheckAnswers:function(){return!!this.has("336")&&"afterCheckAnswers"==this.get("336")},showForwardIsAfterSeeAnswers:function(){return!!this.has("336")&&"afterSeeAnswers"==this.get("336")},getReturntointroscreen:function(){return this.has("387")?this.hasValue("387")?this.getValue("387"):this.get("387"):"true"},returntointroscreenIsTrue:function(){return!this.has("387")||"true"==this.get("387")},returntointroscreenIsFalse:function(){return!!this.has("387")&&"false"==this.get("387")},getSendscores:function(){return this.has("388")?this.hasValue("388")?this.getValue("388"):this.get("388"):"off"},sendscoresIsOff:function(){return!this.has("388")||"off"==this.get("388")},sendscoresIsUnlimited:function(){return!!this.has("388")&&"unlimited"==this.get("388")},sendscoresIs1_submission:function(){return!!this.has("388")&&"1_submission"==this.get("388")},sendscoresIsFinal_check_answers:function(){return!!this.has("388")&&"final_check_answers"==this.get("388")},getDesignPackSubstyle:function(){return this.has("390")?this.hasValue("390")?this.getValue("390"):this.get("390"):"off"},designPackSubstyleIsOff:function(){return!this.has("390")||"off"==this.get("390")},designPackSubstyleIsOn:function(){return!!this.has("390")&&"on"==this.get("390")},getEndresultsreturn:function(){
return this.has("391")?this.hasValue("391")?this.getValue("391"):this.get("391"):"last"},endresultsreturnIsLast:function(){return!this.has("391")||"last"==this.get("391")},endresultsreturnIsFirst:function(){return!!this.has("391")&&"first"==this.get("391")},getSubmissions:function(){return this.has("315")?this.hasValue("315")?this.getValue("315"):this.get("315"):"1"},submissionsIs1:function(){return!this.has("315")||"1"==this.get("315")},submissionsIs2:function(){return!!this.has("315")&&"2"==this.get("315")},submissionsIs3:function(){return!!this.has("315")&&"3"==this.get("315")},submissionsIs4:function(){return!!this.has("315")&&"4"==this.get("315")},submissionsIs5:function(){return!!this.has("315")&&"5"==this.get("315")},submissionsIs6:function(){return!!this.has("315")&&"6"==this.get("315")},submissionsIs7:function(){return!!this.has("315")&&"7"==this.get("315")},submissionsIs8:function(){return!!this.has("315")&&"8"==this.get("315")},submissionsIs9:function(){return!!this.has("315")&&"9"==this.get("315")},submissionsIs10:function(){return!!this.has("315")&&"10"==this.get("315")},submissionsIs11:function(){return!!this.has("315")&&"11"==this.get("315")},submissionsIs12:function(){return!!this.has("315")&&"12"==this.get("315")},submissionsIs13:function(){return!!this.has("315")&&"13"==this.get("315")},submissionsIs14:function(){return!!this.has("315")&&"14"==this.get("315")},submissionsIs15:function(){return!!this.has("315")&&"15"==this.get("315")},submissionsIs16:function(){return!!this.has("315")&&"16"==this.get("315")},submissionsIs17:function(){return!!this.has("315")&&"17"==this.get("315")},submissionsIs18:function(){return!!this.has("315")&&"18"==this.get("315")},submissionsIs19:function(){return!!this.has("315")&&"19"==this.get("315")},submissionsIs20:function(){return!!this.has("315")&&"20"==this.get("315")},submissionsIsUnlimited:function(){return!!this.has("315")&&"unlimited"==this.get("315")},getShowSubmit:function(){return this.has("334")?this.hasValue("334")?this.getValue("334"):this.get("334"):"always"},showSubmitIsAlways:function(){return!this.has("334")||"always"==this.get("334")},showSubmitIsOff:function(){return!!this.has("334")&&"off"==this.get("334")},showSubmitIsAfterOne:function(){return!!this.has("334")&&"afterOne"==this.get("334")},showSubmitIsAfterAll:function(){return!!this.has("334")&&"afterAll"==this.get("334")},showSubmitIsEachScreen:function(){return!!this.has("334")&&"eachScreen"==this.get("334")},getFinishSubmit:function(){return this.has("335")?this.hasValue("335")?this.getValue("335"):this.get("335"):"off"},finishSubmitIsOff:function(){return!this.has("335")||"off"==this.get("335")},finishSubmitIsOn:function(){return!!this.has("335")&&"on"==this.get("335")},getDictionary:function(){return this.has("01")?this.hasValue("01")?this.getValue("01"):this.get("01"):"false"},dictionaryIsFalse:function(){return!this.has("01")||"false"==this.get("01")},dictionaryIsTrue:function(){return!!this.has("01")&&"true"==this.get("01")},getNotesarea:function(){return this.has("06")?this.hasValue("06")?this.getValue("06"):this.get("06"):"false"},notesareaIsFalse:function(){return!this.has("06")||"false"==this.get("06")},notesareaIsTrue:function(){return!!this.has("06")&&"true"==this.get("06")},getFeedback:function(){return this.has("040")?this.hasValue("040")?this.getValue("040"):this.get("040"):"normal"},feedbackIsNormal:function(){return!this.has("040")||"normal"==this.get("040")},feedbackIsInstant:function(){return!!this.has("040")&&"instant"==this.get("040")},getDelayedFeedback:function(){return this.has("322")?this.hasValue("322")?this.getValue("322"):this.get("322"):"false"},delayedFeedbackIsFalse:function(){return!this.has("322")||"false"==this.get("322")},delayedFeedbackIsTrue:function(){return!!this.has("322")&&"true"==this.get("322")},delayedFeedbackIsCustom:function(){return!!this.has("322")&&"custom"==this.get("322")},getImageAsTrigger:function(){return this.has("056")?this.hasValue("056")?this.getValue("056"):this.get("056"):"false"},imageAsTriggerIsFalse:function(){return!this.has("056")||"false"==this.get("056")},imageAsTriggerIsTrue:function(){return!!this.has("056")&&"true"==this.get("056")},getSave:function(){return this.has("114")?this.hasValue("114")?this.getValue("114"):this.get("114"):"off"},saveIsOff:function(){return!this.has("114")||"off"==this.get("114")},saveIsSkinbutton:function(){return!!this.has("114")&&"skinbutton"==this.get("114")},saveIsButton_only:function(){return!!this.has("114")&&"button_only"==this.get("114")},getAutosave:function(){return this.has("341")?this.hasValue("341")?this.getValue("341"):this.get("341"):"on"},autosaveIsOn:function(){return!this.has("341")||"on"==this.get("341")},autosaveIsOff:function(){return!!this.has("341")&&"off"==this.get("341")},getFeedbackSoundEffects:function(){return this.has("043")?this.hasValue("043")?this.getValue("043"):this.get("043"):"off"},feedbackSoundEffectsIsOff:function(){return!this.has("043")||"off"==this.get("043")},feedbackSoundEffectsIsCustom:function(){return!!this.has("043")&&"custom"==this.get("043")},getSoundEffects:function(){return this.has("044")?this.hasValue("044")?this.getValue("044"):this.get("044"):"none"},soundEffectsIsNone:function(){return!this.has("044")||"none"==this.get("044")},soundEffectsIsSound_effects:function(){return!!this.has("044")&&"sound_effects"==this.get("044")},getHideCheckboxes:function(){return this.has("330")?this.hasValue("330")?this.getValue("330"):this.get("330"):"false"},hideCheckboxesIsFalse:function(){return!this.has("330")||"false"==this.get("330")},hideCheckboxesIsTrue:function(){return!!this.has("330")&&"true"==this.get("330")},getTargetGame:function(){return this.has("098")?this.hasValue("098")?this.getValue("098"):this.get("098"):"false"},targetGameIsFalse:function(){return!this.has("098")||"false"==this.get("098")},targetGameIsTrue:function(){return!!this.has("098")&&"true"==this.get("098")},getInteractivePhonemicChart:function(){return this.has("09")?this.hasValue("09")?this.getValue("09"):this.get("09"):"false"},interactivePhonemicChartIsFalse:function(){return!this.has("09")||"false"==this.get("09")},interactivePhonemicChartIsTrue:function(){return!!this.has("09")&&"true"==this.get("09")},getPairalignment:function(){return this.has("112")?this.hasValue("112")?this.getValue("112"):this.get("112"):"ontop"},pairalignmentIsOntop:function(){return!this.has("112")||"ontop"==this.get("112")},pairalignmentIsHorizontal:function(){return!!this.has("112")&&"horizontal"==this.get("112")},pairalignmentIsVertical:function(){return!!this.has("112")&&"vertical"==this.get("112")},getTargetzones:function(){return this.has("337")?this.hasValue("337")?this.getValue("337"):this.get("337"):"false"},targetzonesIsFalse:function(){return!this.has("337")||"false"==this.get("337")},targetzonesIsTrue:function(){return!!this.has("337")&&"true"==this.get("337")},getRandomiseanswers:function(){return this.has("326")?this.hasValue("326")?this.getValue("326"):this.get("326"):"true"},randomiseanswersIsTrue:function(){return!this.has("326")||"true"==this.get("326")},randomiseanswersIsFalse:function(){return!!this.has("326")&&"false"==this.get("326")},getManualMarking:function(){return this.has("345")?this.hasValue("345")?this.getValue("345"):this.get("345"):"off"},manualMarkingIsOff:function(){return!this.has("345")||"off"==this.get("345")},manualMarkingIsOn:function(){return!!this.has("345")&&"on"==this.get("345")},getValidationmessage:function(){return this.has("340")?this.hasValue("340")?this.getValue("340"):this.get("340"):"false"},validationmessageIsFalse:function(){return!this.has("340")||"false"==this.get("340")},validationmessageIsCustom:function(){return!!this.has("340")&&"custom"==this.get("340")},getCheckmaxattempts:function(){return this.has("384")?this.hasValue("384")?this.getValue("384"):this.get("384"):"custom"},checkmaxattemptsIsCustom:function(){return!this.has("384")||"custom"==this.get("384")},getFeedbackBand1:function(){return this.has("346")?this.hasValue("346")?this.getValue("346"):this.get("346"):"false"},feedbackBand1IsFalse:function(){return!this.has("346")||"false"==this.get("346")},feedbackBand1IsCustom:function(){return!!this.has("346")&&"custom"==this.get("346")},getFeedbackBand2:function(){return this.has("347")?this.hasValue("347")?this.getValue("347"):this.get("347"):"false"},feedbackBand2IsFalse:function(){return!this.has("347")||"false"==this.get("347")},feedbackBand2IsCustom:function(){return!!this.has("347")&&"custom"==this.get("347")},getFeedbackBand3:function(){return this.has("348")?this.hasValue("348")?this.getValue("348"):this.get("348"):"false"},feedbackBand3IsFalse:function(){return!this.has("348")||"false"==this.get("348")},feedbackBand3IsCustom:function(){return!!this.has("348")&&"custom"==this.get("348")},getFeedbackBand4:function(){return this.has("349")?this.hasValue("349")?this.getValue("349"):this.get("349"):"false"},feedbackBand4IsFalse:function(){return!this.has("349")||"false"==this.get("349")},feedbackBand4IsCustom:function(){return!!this.has("349")&&"custom"==this.get("349")},getActivityFeedbackThresholds:function(){return this.has("357")?this.hasValue("357")?this.getValue("357"):this.get("357"):"custom"},activityFeedbackThresholdsIsCustom:function(){return!this.has("357")||"custom"==this.get("357")},getActivityFeedbackBand1:function(){return this.has("353")?this.hasValue("353")?this.getValue("353"):this.get("353"):"false"},activityFeedbackBand1IsFalse:function(){return!this.has("353")||"false"==this.get("353")},activityFeedbackBand1IsCustom:function(){return!!this.has("353")&&"custom"==this.get("353")},getActivityFeedbackBand2:function(){return this.has("354")?this.hasValue("354")?this.getValue("354"):this.get("354"):"false"},activityFeedbackBand2IsFalse:function(){return!this.has("354")||"false"==this.get("354")},activityFeedbackBand2IsCustom:function(){return!!this.has("354")&&"custom"==this.get("354")},getActivityFeedbackBand3:function(){return this.has("355")?this.hasValue("355")?this.getValue("355"):this.get("355"):"false"},activityFeedbackBand3IsFalse:function(){return!this.has("355")||"false"==this.get("355")},activityFeedbackBand3IsCustom:function(){return!!this.has("355")&&"custom"==this.get("355")},getActivityFeedbackBand4:function(){return this.has("356")?this.hasValue("356")?this.getValue("356"):this.get("356"):"false"},activityFeedbackBand4IsFalse:function(){return!this.has("356")||"false"==this.get("356")},activityFeedbackBand4IsCustom:function(){return!!this.has("356")&&"custom"==this.get("356")},getSpecialcharactersStudent:function(){return this.has("352")?this.hasValue("352")?this.getValue("352"):this.get("352"):"Scientific_Characters"},specialcharactersStudentHas:function(val){return!!this.has("352")&&this.contains("352",val)},getSpecialcharactersStudent:function(val){return this.has("352")?this.getFromJSON("352"):[]},specialcharactersStudentHasScientific_Characters:function(){return!!this.has("352")&&this.contains("352","Scientific_Characters")},specialcharactersStudentHasAncient_Greek:function(){return!!this.has("352")&&this.contains("352","Ancient_Greek")},specialcharactersStudentHasDanish:function(){return!!this.has("352")&&this.contains("352","Danish")},specialcharactersStudentHasFrench:function(){return!!this.has("352")&&this.contains("352","French")},specialcharactersStudentHasGerman:function(){return!!this.has("352")&&this.contains("352","German")},specialcharactersStudentHasPolish:function(){return!!this.has("352")&&this.contains("352","Polish")},specialcharactersStudentHasSpanish:function(){return!!this.has("352")&&this.contains("352","Spanish")},specialcharactersStudentHasSwedish:function(){return!!this.has("352")&&this.contains("352","Swedish")},specialcharactersStudentHasTurkish:function(){return!!this.has("352")&&this.contains("352","Turkish")},specialcharactersStudentHasArithmetic_Operators:function(){return!!this.has("352")&&this.contains("352","Arithmetic_Operators")},getAnnotationTools:function(){return this.has("368")?this.hasValue("368")?this.getValue("368"):this.get("368"):"off"},annotationToolsIsOff:function(){return!this.has("368")||"off"==this.get("368")},annotationToolsIsOn:function(){return!!this.has("368")&&"on"==this.get("368")},annotationToolsIsOnly_for_teachers:function(){return!!this.has("368")&&"only_for_teachers"==this.get("368")},annotationToolsIsOnly_supplements:function(){return!!this.has("368")&&"only_supplements"==this.get("368")},getShowinfotext:function(){return this.has("371")?this.hasValue("371")?this.getValue("371"):this.get("371"):"off"},showinfotextIsOff:function(){return!this.has("371")||"off"==this.get("371")},showinfotextIsTooltip:function(){return!!this.has("371")&&"tooltip"==this.get("371")},getContinuousEnumeration:function(){return this.has("373")?this.hasValue("373")?this.getValue("373"):this.get("373"):"off"},continuousEnumerationIsOff:function(){return!this.has("373")||"off"==this.get("373")},continuousEnumerationIsOn:function(){return!!this.has("373")&&"on"==this.get("373")},getExamsTimer:function(){return this.has("379")?this.hasValue("379")?this.getValue("379"):this.get("379"):"off"},examsTimerIsOff:function(){return!this.has("379")||"off"==this.get("379")},examsTimerIsOn:function(){return!!this.has("379")&&"on"==this.get("379")},getFeedbackCorrect:function(){return this.has("462")?this.hasValue("462")?this.getValue("462"):this.get("462"):"no"},feedbackCorrectIsNo:function(){return!this.has("462")||"no"==this.get("462")},feedbackCorrectIsCustom:function(){return!!this.has("462")&&"custom"==this.get("462")},getFeedbackIncorrect:function(){return this.has("463")?this.hasValue("463")?this.getValue("463"):this.get("463"):"no"},feedbackIncorrectIsNo:function(){return!this.has("463")||"no"==this.get("463")},feedbackIncorrectIsCustom:function(){return!!this.has("463")&&"custom"==this.get("463")},getShowhints:function(){return this.has("318")?this.hasValue("318")?this.getValue("318"):this.get("318"):"off"},showhintsIsOff:function(){return!this.has("318")||"off"==this.get("318")},showhintsIsAlways:function(){return!!this.has("318")&&"always"==this.get("318")},showhintsIsCheckScore:function(){return!!this.has("318")&&"checkScore"==this.get("318")},getHints:function(){return this.has("319")?this.hasValue("319")?this.getValue("319"):this.get("319"):"false"},hintsIsFalse:function(){return!this.has("319")||"false"==this.get("319")},hintsIsCustom:function(){return!!this.has("319")&&"custom"==this.get("319")},getQuestionpool:function(){return this.has("372")?this.hasValue("372")?this.getValue("372"):this.get("372"):"no"},questionpoolIsNo:function(){return!this.has("372")||"no"==this.get("372")},questionpoolIsYes:function(){return!!this.has("372")&&"yes"==this.get("372")},getQuestiondisplay:function(){return this.has("376")?this.hasValue("376")?this.getValue("376"):this.get("376"):"all"},questiondisplayIsAll:function(){return!this.has("376")||"all"==this.get("376")},questiondisplayIsActive:function(){return!!this.has("376")&&"active"==this.get("376")},questiondisplayIsShow_next:function(){return!!this.has("376")&&"show_next"==this.get("376")},questiondisplayIsShow_next_and_hide_previous:function(){return!!this.has("376")&&"show_next_and_hide_previous"==this.get("376")},getEnumerationinternal:function(){return this.has("382")?this.hasValue("382")?this.getValue("382"):this.get("382"):"all"},enumerationinternalIsAll:function(){return!this.has("382")||"all"==this.get("382")},enumerationinternalIsActive:function(){return!!this.has("382")&&"active"==this.get("382")},enumerationinternalIsCorrect:function(){return!!this.has("382")&&"correct"==this.get("382")},getActivitypool:function(){return this.has("383")?this.hasValue("383")?this.getValue("383"):this.get("383"):"off"},activitypoolIsOff:function(){return!this.has("383")||"off"==this.get("383")},activitypoolIsOn:function(){return!!this.has("383")&&"on"==this.get("383")},activitypoolIsRandomiseAll:function(){return!!this.has("383")&&"randomiseAll"==this.get("383")},getLOsections:function(){return this.has("375")?this.hasValue("375")?this.getValue("375"):this.get("375"):"off"},getScoreValuesPerBlock:function(){return this.has("394")?this.hasValue("394")?this.getValue("394"):this.get("394"):"off"},scoreValuesPerBlockIsOff:function(){return!this.has("394")||"off"==this.get("394")},scoreValuesPerBlockIsCustom:function(){return!!this.has("394")&&"Custom"==this.get("394")},getEraser:function(){return this.has("367")?this.hasValue("367")?this.getValue("367"):this.get("367"):"off"},eraserIsOff:function(){return!this.has("367")||"off"==this.get("367")},eraserIsOn:function(){return!!this.has("367")&&"on"==this.get("367")},getExportFile:function(){return this.has("395")?this.hasValue("395")?this.getValue("395"):this.get("395"):"off"},exportFileIsOff:function(){return!this.has("395")||"off"==this.get("395")},exportFileIsOn:function(){return!!this.has("395")&&"on"==this.get("395")},getTextboxAutogrow:function(){return this.has("396")?this.hasValue("396")?this.getValue("396"):this.get("396"):"off"},textboxAutogrowIsOff:function(){return!this.has("396")||"off"==this.get("396")},textboxAutogrowIsOn:function(){return!!this.has("396")&&"on"==this.get("396")},getCheckboxSelections:function(){return this.has("397")?this.hasValue("397")?this.getValue("397"):this.get("397"):"total_correct"},checkboxSelectionsIsTotal_correct:function(){return!this.has("397")||"total_correct"==this.get("397")},checkboxSelectionsIsAll:function(){return!!this.has("397")&&"all"==this.get("397")},getRepeatAnswers:function(){return this.has("398")?this.hasValue("398")?this.getValue("398"):this.get("398"):"allow"},repeatAnswersIsAllow:function(){return!this.has("398")||"allow"==this.get("398")},repeatAnswersIsPrevent:function(){return!!this.has("398")&&"prevent"==this.get("398")},getFreeDragLocation:function(){return this.has("399")?this.hasValue("399")?this.getValue("399"):this.get("399"):"off"},freeDragLocationIsOff:function(){return!this.has("399")||"off"==this.get("399")},freeDragLocationIsBetween_words:function(){return!!this.has("399")&&"between_words"==this.get("399")},freeDragLocationIsBetween_letters:function(){return!!this.has("399")&&"between_letters"==this.get("399")},getPoolStacks:function(){return this.has("400")?this.hasValue("400")?this.getValue("400"):this.get("400"):"off"},poolStacksIsOff:function(){return!this.has("400")||"off"==this.get("400")},poolStacksIs1:function(){return!!this.has("400")&&"1"==this.get("400")},poolStacksIs2:function(){return!!this.has("400")&&"2"==this.get("400")},poolStacksIs3:function(){return!!this.has("400")&&"3"==this.get("400")},poolStacksIs4:function(){return!!this.has("400")&&"4"==this.get("400")},getAudioingap:function(){return this.has("401")?this.hasValue("401")?this.getValue("401"):this.get("401"):"off"},audioingapIsOff:function(){return!this.has("401")||"off"==this.get("401")},audioingapIsOn:function(){return!!this.has("401")&&"on"==this.get("401")},getOrderDependency:function(){return this.has("402")?this.hasValue("402")?this.getValue("402"):this.get("402"):"off"},orderDependencyIsOff:function(){return!this.has("402")||"off"==this.get("402")},orderDependencyIsFirst_answer:function(){return!!this.has("402")&&"first_answer"==this.get("402")},orderDependencyIsOn:function(){return!!this.has("402")&&"on"==this.get("402")},getGapResize:function(){return this.has("403")?this.hasValue("403")?this.getValue("403"):this.get("403"):"off"},gapResizeIsOff:function(){return!this.has("403")||"off"==this.get("403")},gapResizeIsOn:function(){return!!this.has("403")&&"on"==this.get("403")},getScorecalculation:function(){return this.has("404")?this.hasValue("404")?this.getValue("404"):this.get("404"):"onlyCorrect"},scorecalculationIsOnlyCorrect:function(){return!this.has("404")||"onlyCorrect"==this.get("404")},scorecalculationIsSubtractIncorrect:function(){return!!this.has("404")&&"subtractIncorrect"==this.get("404")},getIgnoreAccents:function(){return this.has("364")?this.hasValue("364")?this.getValue("364"):this.get("364"):"off"},ignoreAccentsIsOff:function(){return!this.has("364")||"off"==this.get("364")},ignoreAccentsIsOn:function(){return!!this.has("364")&&"on"==this.get("364")},getPoolorder:function(){return this.has("406")?this.hasValue("406")?this.getValue("406"):this.get("406"):"off"},poolorderIsOff:function(){return!this.has("406")||"off"==this.get("406")},poolorderIsAlphabetical:function(){return!!this.has("406")&&"alphabetical"==this.get("406")},poolorderIsNatural:function(){return!!this.has("406")&&"natural"==this.get("406")},getAutomaticcapitalisation:function(){return this.has("407")?this.hasValue("407")?this.getValue("407"):this.get("407"):"off"},automaticcapitalisationIsOff:function(){return!this.has("407")||"off"==this.get("407")},automaticcapitalisationIsOn:function(){return!!this.has("407")&&"on"==this.get("407")},getMarkingstyle:function(){return this.has("408")?this.hasValue("408")?this.getValue("408"):this.get("408"):"highlight"},markingstyleIsHighlight:function(){return!this.has("408")||"highlight"==this.get("408")},markingstyleIsCircle:function(){return!!this.has("408")&&"circle"==this.get("408")},markingstyleIsUnderline:function(){return!!this.has("408")&&"underline"==this.get("408")},getContainerStyle:function(){return this.has("412")?this.hasValue("412")?this.getValue("412"):this.get("412"):"normal"},containerStyleIsNormal:function(){return!this.has("412")||"normal"==this.get("412")},containerStyleIsCustom:function(){return!!this.has("412")&&"custom"==this.get("412")},getAnswerdisplay:function(){return this.has("416")?this.hasValue("416")?this.getValue("416"):this.get("416"):"columns"},answerdisplayIsColumns:function(){return!this.has("416")||"columns"==this.get("416")},answerdisplayIsRows:function(){return!!this.has("416")&&"rows"==this.get("416")},getLinkbehaviour:function(){return this.has("417")?this.hasValue("417")?this.getValue("417"):this.get("417"):"drag"},linkbehaviourIsDrag:function(){return!this.has("417")||"drag"==this.get("417")},linkbehaviourIsTouch:function(){return!!this.has("417")&&"touch"==this.get("417")},getRestoreLOState:function(){return this.has("419")?this.hasValue("419")?this.getValue("419"):this.get("419"):"on"},restoreLOStateIsOn:function(){return!this.has("419")||"on"==this.get("419")},restoreLOStateIsOff:function(){return!!this.has("419")&&"off"==this.get("419")},getGapcharacters:function(){return this.has("425")?this.hasValue("425")?this.getValue("425"):this.get("425"):"dontshow"},gapcharactersIsDontshow:function(){return!this.has("425")||"dontshow"==this.get("425")},gapcharactersIsShow:function(){return!!this.has("425")&&"show"==this.get("425")},getTeamscoring:function(){return this.has("427")?this.hasValue("427")?this.getValue("427"):this.get("427"):"off"},teamscoringIsOff:function(){return!this.has("427")||"off"==this.get("427")},teamscoringIsOn:function(){return!!this.has("427")&&"on"==this.get("427")},getWikiTool:function(){return this.has("421")?this.hasValue("421")?this.getValue("421"):this.get("421"):"off"},wikiToolIsOff:function(){return!this.has("421")||"off"==this.get("421")},wikiToolIsOn:function(){return!!this.has("421")&&"on"==this.get("421")},getOperator:function(){return this.has("422")?this.hasValue("422")?this.getValue("422"):this.get("422"):"addition"},operatorIsAddition:function(){return!this.has("422")||"addition"==this.get("422")},operatorIsMultiplication:function(){return!!this.has("422")&&"multiplication"==this.get("422")},getLayers:function(){return this.has("426")?this.hasValue("426")?this.getValue("426"):this.get("426"):"3"},layersIs3:function(){return!this.has("426")||"3"==this.get("426")},layersIs4:function(){return!!this.has("426")&&"4"==this.get("426")},layersIs5:function(){return!!this.has("426")&&"5"==this.get("426")},getReferenceContent:function(){return this.has("428")?this.hasValue("428")?this.getValue("428"):this.get("428"):"off"},referenceContentIsOff:function(){return!this.has("428")||"off"==this.get("428")},referenceContentIs1:function(){return!!this.has("428")&&"1"==this.get("428")},referenceContentIs2:function(){return!!this.has("428")&&"2"==this.get("428")},getAlternativeText:function(){return this.has("430")?this.hasValue("430")?this.getValue("430"):this.get("430"):"off"},alternativeTextIsOff:function(){return!this.has("430")||"off"==this.get("430")},alternativeTextIsAlt1:function(){return!!this.has("430")&&"alt1"==this.get("430")},alternativeTextIsAlt2:function(){return!!this.has("430")&&"alt2"==this.get("430")},alternativeTextIsAlt3:function(){return!!this.has("430")&&"alt3"==this.get("430")},getAudioPlayback:function(){return this.has("431")?this.hasValue("431")?this.getValue("431"):this.get("431"):"auto"},audioPlaybackIsAuto:function(){return!this.has("431")||"auto"==this.get("431")},audioPlaybackIsManual:function(){return!!this.has("431")&&"manual"==this.get("431")},audioPlaybackIsBefore_card_flip:function(){return!!this.has("431")&&"before_card_flip"==this.get("431")},getLOtitledisplay:function(){return this.has("432")?this.hasValue("432")?this.getValue("432"):this.get("432"):"on"},lOtitledisplayIsOn:function(){return!this.has("432")||"on"==this.get("432")},lOtitledisplayIsOff:function(){return!!this.has("432")&&"off"==this.get("432")},getActivitytitledisplay:function(){return this.has("433")?this.hasValue("433")?this.getValue("433"):this.get("433"):"on"},activitytitledisplayIsOn:function(){return!this.has("433")||"on"==this.get("433")},activitytitledisplayIsOff:function(){return!!this.has("433")&&"off"==this.get("433")},getNumbercolumns:function(){return this.has("435")?this.hasValue("435")?this.getValue("435"):this.get("435"):"3"},numbercolumnsIs3:function(){return!this.has("435")||"3"==this.get("435")},numbercolumnsIs4:function(){return!!this.has("435")&&"4"==this.get("435")},numbercolumnsIs5:function(){return!!this.has("435")&&"5"==this.get("435")},getAutomaticplay:function(){return this.has("437")?this.hasValue("437")?this.getValue("437"):this.get("437"):"off"},automaticplayIsOff:function(){return!this.has("437")||"off"==this.get("437")},automaticplayIsOn:function(){return!!this.has("437")&&"on"==this.get("437")},automaticplayIsOn_magnify:function(){return!!this.has("437")&&"on_magnify"==this.get("437")},getShufflecontrol:function(){return this.has("438")?this.hasValue("438")?this.getValue("438"):this.get("438"):"off"},shufflecontrolIsOff:function(){return!this.has("438")||"off"==this.get("438")},shufflecontrolIsOn:function(){return!!this.has("438")&&"on"==this.get("438")},getAdditionalimagecontrol:function(){return this.has("439")?this.hasValue("439")?this.getValue("439"):this.get("439"):"off"},additionalimagecontrolIsOff:function(){return!this.has("439")||"off"==this.get("439")},additionalimagecontrolIsOn:function(){return!!this.has("439")&&"on"==this.get("439")},getAudioiconbehaviour:function(){return this.has("441")?this.hasValue("441")?this.getValue("441"):this.get("441"):"stop"},audioiconbehaviourIsStop:function(){return!this.has("441")||"stop"==this.get("441")},audioiconbehaviourIsPause:function(){return!!this.has("441")&&"pause"==this.get("441")},getUserselection:function(){return this.has("442")?this.hasValue("442")?this.getValue("442"):this.get("442"):"off"},userselectionIsOff:function(){return!this.has("442")||"off"==this.get("442")},userselectionIsSelect_for_correct:function(){return!!this.has("442")&&"select_for_correct"==this.get("442")},userselectionIsSelect_for_error:function(){return!!this.has("442")&&"select_for_error"==this.get("442")},getLOfullscreenbutton:function(){return this.has("443")?this.hasValue("443")?this.getValue("443"):this.get("443"):"off"},lOfullscreenbuttonIsOff:function(){return!this.has("443")||"off"==this.get("443")},lOfullscreenbuttonIsOn:function(){return!!this.has("443")&&"on"==this.get("443")},getUserVisibility:function(){return this.has("445")?this.hasValue("445")?this.getValue("445"):this.get("445"):"all"},userVisibilityIsAll:function(){return!this.has("445")||"all"==this.get("445")},userVisibilityIsTeacher:function(){return!!this.has("445")&&"teacher"==this.get("445")},userVisibilityIsStudent:function(){return!!this.has("445")&&"student"==this.get("445")},getCluesincolumns:function(){return this.has("446")?this.hasValue("446")?this.getValue("446"):this.get("446"):"off"},cluesincolumnsIsOff:function(){return!this.has("446")||"off"==this.get("446")},cluesincolumnsIsOn:function(){return!!this.has("446")&&"on"==this.get("446")},getTryAgainBehaviour:function(){return this.has("448")?this.hasValue("448")?this.getValue("448"):this.get("448"):"button"},tryAgainBehaviourIsButton:function(){return!this.has("448")||"button"==this.get("448")},tryAgainBehaviourIsAutomatic:function(){return!!this.has("448")&&"automatic"==this.get("448")},getTTSGeneralRules:function(){return this.has("455")?this.hasValue("455")?this.getValue("455"):this.get("455"):"off"},tTSGeneralRulesIsOff:function(){return!this.has("455")||"off"==this.get("455")},tTSGeneralRulesIsOn:function(){return!!this.has("455")&&"on"==this.get("455")},getTTSLORules:function(){return this.has("456")?this.hasValue("456")?this.getValue("456"):this.get("456"):"off"},tTSLORulesIsOff:function(){return!this.has("456")||"off"==this.get("456")},tTSLORulesIsOn:function(){return!!this.has("456")&&"on"==this.get("456")},getTTSActivityRules:function(){return this.has("457")?this.hasValue("457")?this.getValue("457"):this.get("457"):"off"},tTSActivityRulesIsOff:function(){return!this.has("457")||"off"==this.get("457")},tTSActivityRulesIsOn:function(){return!!this.has("457")&&"on"==this.get("457")},getSeeallanswers:function(){return this.has("449")?this.hasValue("449")?this.getValue("449"):this.get("449"):"off"},seeallanswersIsOff:function(){return!this.has("449")||"off"==this.get("449")},seeallanswersIsOn:function(){return!!this.has("449")&&"on"==this.get("449")},getSeenextanswer:function(){return this.has("450")?this.hasValue("450")?this.getValue("450"):this.get("450"):"off"},seenextanswerIsOff:function(){return!this.has("450")||"off"==this.get("450")},seenextanswerIsOn:function(){return!!this.has("450")&&"on"==this.get("450")},getActivityhelp:function(){return this.has("459")?this.hasValue("459")?this.getValue("459"):this.get("459"):"off"},activityhelpIsOff:function(){return!this.has("459")||"off"==this.get("459")},activityhelpIsOn:function(){return!!this.has("459")&&"on"==this.get("459")},getNavigationMenu:function(){return this.has("452")?this.hasValue("452")?this.getValue("452"):this.get("452"):"off"},navigationMenuIsOff:function(){return!this.has("452")||"off"==this.get("452")},navigationMenuIsAuto:function(){return!!this.has("452")&&"auto"==this.get("452")},navigationMenuIsCustom:function(){return!!this.has("452")&&"custom"==this.get("452")},getDisplaySettings:function(){return this.has("453")?this.hasValue("453")?this.getValue("453"):this.get("453"):"off"},displaySettingsIsOff:function(){return!this.has("453")||"off"==this.get("453")},displaySettingsIsOn:function(){return!!this.has("453")&&"on"==this.get("453")},getResourceBanks:function(){return this.has("454")?this.hasValue("454")?this.getValue("454"):this.get("454"):"off"},resourceBanksIsOff:function(){return!this.has("454")||"off"==this.get("454")},resourceBanksIsOn:function(){return!!this.has("454")&&"on"==this.get("454")},getSolutionHint:function(){return this.has("479")?this.hasValue("479")?this.getValue("479"):this.get("479"):"off"},solutionHintIsOff:function(){return!this.has("479")||"off"==this.get("479")},solutionHintIsOn:function(){return!!this.has("479")&&"on"==this.get("479")},getIgnoreSpaces:function(){return this.has("480")?this.hasValue("480")?this.getValue("480"):this.get("480"):"off"},ignoreSpacesIsOff:function(){return!this.has("480")||"off"==this.get("480")},ignoreSpacesIsOn:function(){return!!this.has("480")&&"on"==this.get("480")},getTargetimage:function(){return this.has("465")?this.hasValue("465")?this.getValue("465"):this.get("465"):"custom"},
targetimageIsCustom:function(){return!this.has("465")||"custom"==this.get("465")},getTargetGeneratorimage:function(){return this.has("466")?this.hasValue("466")?this.getValue("466"):this.get("466"):"custom"},targetGeneratorimageIsCustom:function(){return!this.has("466")||"custom"==this.get("466")},getTargetGeneratorlocation:function(){return this.has("467")?this.hasValue("467")?this.getValue("467"):this.get("467"):"bottom_right"},targetGeneratorlocationIsBottom_right:function(){return!this.has("467")||"bottom_right"==this.get("467")},targetGeneratorlocationIsBottom_left:function(){return!!this.has("467")&&"bottom_left"==this.get("467")},targetGeneratorlocationIsTop_right:function(){return!!this.has("467")&&"top_right"==this.get("467")},targetGeneratorlocationIsTop_left:function(){return!!this.has("467")&&"top_left"==this.get("467")},getSelectorimage:function(){return this.has("468")?this.hasValue("468")?this.getValue("468"):this.get("468"):"custom"},selectorimageIsCustom:function(){return!this.has("468")||"custom"==this.get("468")},getSelectedTargetimage:function(){return this.has("469")?this.hasValue("469")?this.getValue("469"):this.get("469"):"custom"},selectedTargetimageIsCustom:function(){return!this.has("469")||"custom"==this.get("469")},getBackgroundimage:function(){return this.has("470")?this.hasValue("470")?this.getValue("470"):this.get("470"):"custom"},backgroundimageIsCustom:function(){return!this.has("470")||"custom"==this.get("470")},getScoreboard:function(){return this.has("471")?this.hasValue("471")?this.getValue("471"):this.get("471"):"off"},scoreboardIsOff:function(){return!this.has("471")||"off"==this.get("471")},scoreboardIsOn:function(){return!!this.has("471")&&"on"==this.get("471")},getCountdowntimer:function(){return this.has("472")?this.hasValue("472")?this.getValue("472"):this.get("472"):"off"},countdowntimerIsOff:function(){return!this.has("472")||"off"==this.get("472")},countdowntimerIsOn:function(){return!!this.has("472")&&"on"==this.get("472")},getMaximumduration:function(){return this.has("473")?this.hasValue("473")?this.getValue("473"):this.get("473"):"off"},maximumdurationIsOff:function(){return!this.has("473")||"off"==this.get("473")},maximumdurationIsCustom:function(){return!!this.has("473")&&"custom"==this.get("473")},getMaximumitems:function(){return this.has("474")?this.hasValue("474")?this.getValue("474"):this.get("474"):"off"},maximumitemsIsOff:function(){return!this.has("474")||"off"==this.get("474")},maximumitemsIsCustom:function(){return!!this.has("474")&&"custom"==this.get("474")},getMovementspeed:function(){return this.has("475")?this.hasValue("475")?this.getValue("475"):this.get("475"):"slow"},movementspeedIsSlow:function(){return!this.has("475")||"slow"==this.get("475")},movementspeedIsMedium:function(){return!!this.has("475")&&"medium"==this.get("475")},movementspeedIsFast:function(){return!!this.has("475")&&"fast"==this.get("475")},getGenerationspeed:function(){return this.has("476")?this.hasValue("476")?this.getValue("476"):this.get("476"):"slow"},generationspeedIsSlow:function(){return!this.has("476")||"slow"==this.get("476")},generationspeedIsMedium:function(){return!!this.has("476")&&"medium"==this.get("476")},generationspeedIsFast:function(){return!!this.has("476")&&"fast"==this.get("476")},getGameOvermessage:function(){return this.has("477")?this.hasValue("477")?this.getValue("477"):this.get("477"):"custom"},gameOvermessageIsCustom:function(){return!this.has("477")||"custom"==this.get("477")},getCopyrightInformation:function(){return this.has("484")?this.hasValue("484")?this.getValue("484"):this.get("484"):"off"},copyrightInformationIsOff:function(){return!this.has("484")||"off"==this.get("484")},copyrightInformationIsOn:function(){return!!this.has("484")&&"on"==this.get("484")},getNumberInput:function(){return this.has("483")?this.hasValue("483")?this.getValue("483"):this.get("483"):"any"},numberInputIsAny:function(){return!this.has("483")||"any"==this.get("483")},numberInputIsNatural:function(){return!!this.has("483")&&"natural"==this.get("483")},numberInputIsInteger:function(){return!!this.has("483")&&"integer"==this.get("483")},getTargetonscreenduration:function(){return this.has("485")?this.hasValue("485")?this.getValue("485"):this.get("485"):"off"},targetonscreendurationIsOff:function(){return!this.has("485")||"off"==this.get("485")},targetonscreendurationIsCustom:function(){return!!this.has("485")&&"custom"==this.get("485")},getOnlineCheck:function(){return this.has("487")?this.hasValue("487")?this.getValue("487"):this.get("487"):"off"},onlineCheckIsOff:function(){return!this.has("487")||"off"==this.get("487")},onlineCheckIsOn:function(){return!!this.has("487")&&"on"==this.get("487")},getSignaltargets:function(){return this.has("492")?this.hasValue("492")?this.getValue("492"):this.get("492"):"off"},signaltargetsIsOff:function(){return!this.has("492")||"off"==this.get("492")},signaltargetsIsOn:function(){return!!this.has("492")&&"on"==this.get("492")},getCheckanswersinstant:function(){return this.has("493")?this.hasValue("493")?this.getValue("493"):this.get("493"):"off"},checkanswersinstantIsOff:function(){return!this.has("493")||"off"==this.get("493")},checkanswersinstantIsOn:function(){return!!this.has("493")&&"on"==this.get("493")},getValidatedependentgaps:function(){return this.has("495")?this.hasValue("495")?this.getValue("495"):this.get("495"):"off"},validatedependentgapsIsOff:function(){return!this.has("495")||"off"==this.get("495")},validatedependentgapsIsOn:function(){return!!this.has("495")&&"on"==this.get("495")},getPlayall:function(){return this.has("497")?this.hasValue("497")?this.getValue("497"):this.get("497"):"off"},playallIsOff:function(){return!this.has("497")||"off"==this.get("497")},playallIsOn:function(){return!!this.has("497")&&"on"==this.get("497")},getDownloadaudio:function(){return this.has("498")?this.hasValue("498")?this.getValue("498"):this.get("498"):"off"},downloadaudioIsOff:function(){return!this.has("498")||"off"==this.get("498")},downloadaudioIsOn:function(){return!!this.has("498")&&"on"==this.get("498")},getHidelines:function(){return this.has("499")?this.hasValue("499")?this.getValue("499"):this.get("499"):"off"},hidelinesIsOff:function(){return!this.has("499")||"off"==this.get("499")},hidelinesIsOn:function(){return!!this.has("499")&&"on"==this.get("499")},getGapfillbehaviour:function(){return this.has("501")?this.hasValue("501")?this.getValue("501"):this.get("501"):"drag"},gapfillbehaviourIsDrag:function(){return!this.has("501")||"drag"==this.get("501")},gapfillbehaviourIsTap_item:function(){return!!this.has("501")&&"tap_item"==this.get("501")},gapfillbehaviourIsTap_target:function(){return!!this.has("501")&&"tap_target"==this.get("501")},gapfillbehaviourIsTap_swap:function(){return!!this.has("501")&&"tap_swap"==this.get("501")},getGroupheadings:function(){return this.has("502")?this.hasValue("502")?this.getValue("502"):this.get("502"):"off"},groupheadingsIsOff:function(){return!this.has("502")||"off"==this.get("502")},groupheadingsIsCustom:function(){return!!this.has("502")&&"custom"==this.get("502")},getDisplayascompleted:function(){return this.has("503")?this.hasValue("503")?this.getValue("503"):this.get("503"):"off"},displayascompletedIsOff:function(){return!this.has("503")||"off"==this.get("503")},displayascompletedIsOn:function(){return!!this.has("503")&&"on"==this.get("503")},getOriginoftargets:function(){return this.has("504")?this.hasValue("504")?this.getValue("504"):this.get("504"):"default"},originoftargetsIsDefault:function(){return!this.has("504")||"default"==this.get("504")},originoftargetsIsCustom:function(){return!!this.has("504")&&"custom"==this.get("504")},getTranslationBlock:function(){return this.has("505")?this.hasValue("505")?this.getValue("505"):this.get("505"):"off"},translationBlockIsOff:function(){return!this.has("505")||"off"==this.get("505")},translationBlockIsOn:function(){return!!this.has("505")&&"on"==this.get("505")},getFlashfirstanswer:function(){return this.has("508")?this.hasValue("508")?this.getValue("508"):this.get("508"):"off"},flashfirstanswerIsOff:function(){return!this.has("508")||"off"==this.get("508")},flashfirstanswerIsOn:function(){return!!this.has("508")&&"on"==this.get("508")},getSetUserRole:function(){return this.has("509")?this.hasValue("509")?this.getValue("509"):this.get("509"):"Free"},setUserRoleIsFree:function(){return!this.has("509")||"Free"==this.get("509")},setUserRoleIsRole_1:function(){return!!this.has("509")&&"role_1"==this.get("509")},setUserRoleIsRole_2:function(){return!!this.has("509")&&"role_2"==this.get("509")},getScoreRounding:function(){return this.has("510")?this.hasValue("510")?this.getValue("510"):this.get("510"):"float"},scoreRoundingIsFloat:function(){return!this.has("510")||"float"==this.get("510")},scoreRoundingIsRoundup:function(){return!!this.has("510")&&"roundup"==this.get("510")},scoreRoundingIsRound:function(){return!!this.has("510")&&"round"==this.get("510")},scoreRoundingIsRounddown:function(){return!!this.has("510")&&"rounddown"==this.get("510")},getNextbuttontext:function(){return this.has("511")?this.hasValue("511")?this.getValue("511"):this.get("511"):"default"},nextbuttontextIsDefault:function(){return!this.has("511")||"default"==this.get("511")},nextbuttontextIsCustom:function(){return!!this.has("511")&&"custom"==this.get("511")},getCheckAnswersDisplay:function(){return this.has("512")?this.hasValue("512")?this.getValue("512"):this.get("512"):"marking_and_feedback"},checkAnswersDisplayIsMarking_and_feedback:function(){return!this.has("512")||"marking_and_feedback"==this.get("512")},checkAnswersDisplayIsMarking_only:function(){return!!this.has("512")&&"marking_only"==this.get("512")},getOriginalAudioPlayback:function(){return this.has("513")?this.hasValue("513")?this.getValue("513"):this.get("513"):"both_roles"},originalAudioPlaybackIsBoth_roles:function(){return!this.has("513")||"both_roles"==this.get("513")},originalAudioPlaybackIsNon_selected_role_only:function(){return!!this.has("513")&&"non_selected_role_only"==this.get("513")},getNumberofchances:function(){return this.has("516")?this.hasValue("516")?this.getValue("516"):this.get("516"):"1"},numberofchancesIs1:function(){return!this.has("516")||"1"==this.get("516")},numberofchancesIs2:function(){return!!this.has("516")&&"2"==this.get("516")},numberofchancesIs3:function(){return!!this.has("516")&&"3"==this.get("516")},numberofchancesIs4:function(){return!!this.has("516")&&"4"==this.get("516")},numberofchancesIs5:function(){return!!this.has("516")&&"5"==this.get("516")},getKeyboarddisplay:function(){return this.has("517")?this.hasValue("517")?this.getValue("517"):this.get("517"):"off"},keyboarddisplayIsOff:function(){return!this.has("517")||"off"==this.get("517")},keyboarddisplayIsOn:function(){return!!this.has("517")&&"on"==this.get("517")},getRevealSolution:function(){return this.has("518")?this.hasValue("518")?this.getValue("518"):this.get("518"):"after_final_chance"},revealSolutionIsAfter_final_chance:function(){return!this.has("518")||"after_final_chance"==this.get("518")},revealSolutionIsWith_button:function(){return!!this.has("518")&&"with_button"==this.get("518")},getHangmanTimer:function(){return this.has("519")?this.hasValue("519")?this.getValue("519"):this.get("519"):"off"},hangmanTimerIsOff:function(){return!this.has("519")||"off"==this.get("519")},hangmanTimerIsCustom:function(){return!!this.has("519")&&"custom"==this.get("519")},getInstructionPopUp:function(){return this.has("520")?this.hasValue("520")?this.getValue("520"):this.get("520"):"off"},instructionPopUpIsOff:function(){return!this.has("520")||"off"==this.get("520")},instructionPopUpIsOn:function(){return!!this.has("520")&&"on"==this.get("520")},getResetWholeLO:function(){return this.has("521")?this.hasValue("521")?this.getValue("521"):this.get("521"):"off"},resetWholeLOIsOff:function(){return!this.has("521")||"off"==this.get("521")},resetWholeLOIsOn:function(){return!!this.has("521")&&"on"==this.get("521")},getShowNextLO:function(){return this.has("522")?this.hasValue("522")?this.getValue("522"):this.get("522"):"off"},showNextLOIsOff:function(){return!this.has("522")||"off"==this.get("522")},showNextLOIsOn:function(){return!!this.has("522")&&"on"==this.get("522")},getShowPreviousLO:function(){return this.has("523")?this.hasValue("523")?this.getValue("523"):this.get("523"):"off"},showPreviousLOIsOff:function(){return!this.has("523")||"off"==this.get("523")},showPreviousLOIsOn:function(){return!!this.has("523")&&"on"==this.get("523")},getLONotesArea:function(){return this.has("524")?this.hasValue("524")?this.getValue("524"):this.get("524"):"off"},lONotesAreaIsOff:function(){return!this.has("524")||"off"==this.get("524")},lONotesAreaIsOn:function(){return!!this.has("524")&&"on"==this.get("524")},getAudiospeed:function(){return this.has("525")?this.hasValue("525")?this.getValue("525"):this.get("525"):"off"},audiospeedIsOff:function(){return!this.has("525")||"off"==this.get("525")},audiospeedIsOn:function(){return!!this.has("525")&&"on"==this.get("525")},getSCORM2004AbsoluteValues:function(){return this.has("527")?this.hasValue("527")?this.getValue("527"):this.get("527"):"off"},sCORM2004AbsoluteValuesIsOff:function(){return!this.has("527")||"off"==this.get("527")},sCORM2004AbsoluteValuesIsOn:function(){return!!this.has("527")&&"on"==this.get("527")},getHighlightselection:function(){return this.has("529")?this.hasValue("529")?this.getValue("529"):this.get("529"):"words"},highlightselectionIsWords:function(){return!this.has("529")||"words"==this.get("529")},highlightselectionIsLetters:function(){return!!this.has("529")&&"letters"==this.get("529")},init:function(){}},Obj.extend("a5.models.options.BaseOptions",a5.models.options.BaseOptions),a5.models.interaction.Items={init:function(parameters){parameters=parameters||{},this.itemList=[],this.parent=parameters.parent},add:function(item){this.itemList.push(item)},meetsMinLength:function(){return _.every(this.itemList,function(item){return!item.meetsMinLength||item.meetsMinLength()})},isFilled:function(){return _.some(this.itemList,function(item){return _.isFunction(item.isFilled)&&item.isFilled()})},areAllFilled:function(){return _.every(this.itemList,function(item){return item.areAllFilled?item.areAllFilled():item.isFilled?item.isFilled():void 0})},getScores:function(){var score=new a5.Score;return score.minSolution=!0,_.each(this.itemList,function(questionItems){var qiScore=questionItems.getScores();_.isUndefined(qiScore.blockScore)?(score.total+=qiScore.total,score.correct+=qiScore.correct,score.filled+=qiScore.filled,score.revealed+=qiScore.revealed,score.totalBlocks+=qiScore.totalBlocks,score.correctBlocks+=qiScore.correctBlocks,score.minSolution=score.minSolution&&qiScore.minSolution):(score.total+=qiScore.blockScore,score.correct+=qiScore.correct*qiScore.blockScore/qiScore.total,score.filled+=qiScore.filled*qiScore.blockScore/qiScore.total,score.revealed+=qiScore.revealed*qiScore.blockScore/qiScore.total,score.totalBlocks+=qiScore.blockScore,score.correctBlocks+=qiScore.correctBlocks*qiScore.blockScore/qiScore.totalBlocks,score.minSolution=score.minSolution&&qiScore.minSolution)}),score},setAnswer:function(){_.each(this.itemList,function(item){"function"==typeof item.setAnswer?item.setAnswer():logger.warn("setAnswer not implemented for interaction "+window.a5.mainBuilder.curInteraction.identifier)},this)},setAnswerInput:function(){_.each(this.itemList,function(item){"function"==typeof item.setAnswerInput?item.setAnswerInput():logger.warn("setAnswerInput not implemented for interaction "+window.a5.mainBuilder.curInteraction.identifier)},this)},tryAgain:function(){_.each(this.itemList,function(item){"function"==typeof item.tryAgain?item.tryAgain():logger.warn("tryAgain not implemented for interaction "+window.a5.mainBuilder.curInteraction.identifier)},this)},showAnswer:function(){_.each(this.itemList,function(item){"function"==typeof item.showAnswer?item.showAnswer():logger.warn("showAnswer not implemented for interaction "+window.a5.mainBuilder.curInteraction.identifier)})},canShowSolutionHint:function(){return this.hasCandidatesForSolutionHint()},getCandidatesForSolutionHint:function(){return _.filter(this.itemList,function(item){return"answers"!==item.state&&_.isFunction(item.hasCandidatesForSolutionHint)&&item.hasCandidatesForSolutionHint()})},getCandidatesForShowNextAnswer:function(){return _.filter(this.itemList,function(item){return"answers"!==item.state&&_.isFunction(item.hasCandidatesForShowNextAnswer)&&item.hasCandidatesForShowNextAnswer()})},getCandidatesForValidation:function(){return _.filter(this.itemList,function(item){return"answers"!==item.state&&_.isFunction(item.hasCandidatesForValidation)&&item.hasCandidatesForValidation()})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},hasShownSolutionHint:function(){return this.parent&&this.parent.hasShownSolutionHint()},clearSolutionHint:function(){delete this.state,_.each(this.itemList,function(item){item.clearSolutionHint&&item.clearSolutionHint()})},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),block=items.shift();return block&&block.showSolutionHint(),this.hasCandidatesForValidation()||(this.state="answers"),block},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),block=items.shift();return block&&block.showNextAnswer(),this.hasCandidatesForShowNextAnswer()||(this.state="answers"),block},getAllAnswers:function(){return _.flatten(_.map(this.itemList,function(item){return item.getAllAnswers()}))},getItemsByClass:function(classes){var items=[],classnames=classes.split(" ");return _.each(this.itemList,function(item){_.contains(classnames,item._class_name)?items.push(item):item.getItemsByClass&&items.push(item.getItemsByClass(classes))}),_.flatten(items)},length:function(){return this.itemList.length},store:function(){return{items:_.map(this.itemList,function(item){return _.isFunction(item.store)?item.store():{}})}},restore:function(data){data&&data.items&&_.each(this.itemList,function(item,i){_.isFunction(item.restore)&&item.restore(data.items[i])})}},Obj.extend("a5.models.interaction.Items"),a5.models.interaction.BlockItems={init:function(parameters){this._super(parameters)},store:function(){var data=this._super();return _.some(data.items,function(block){return block&&!_.isEmpty(block.items)})&&data},sample:function(items){this.itemList=items.map(function(i){return this.itemList[i]},this)}},a5.models.interaction.Items.extend("a5.models.interaction.BlockItems"),a5.models.interaction.QuestionItems={init:function(parameters){parameters=parameters||{},this._super(parameters),this.blockScore=parameters.blockScore},getScores:function(){var score=this._super();return(score.total>0||this.blockScore>0)&&(score.totalBlocks=1,score.total>0&&score.correct===score.total-score.revealed&&(score.correctBlocks=1),0===score.total&&(score.total=this.blockScore),score.blockScore=this.blockScore),score},getAllAnswers:function(){var items=_.filter(this.itemList,function(item){return!item.prefill&&!item.prefilled&&_.isFunction(item.getAnswers)});return _.map(items,function(item){return item.getAnswers()})},getCandidatesForSolutionHint:function(){return _.filter(this.itemList,function(item){var hasCandidatesForSolutionHintFn=item.hasCandidatesForSolutionHint||function(){return!this.prefill&&!this.prefilled&&_.isFunction(this.isFilled)&&!this.isFilled()}.bind(item);return"answers"!==item.state&&hasCandidatesForSolutionHintFn.call(item)})},getCandidatesForShowNextAnswer:function(){return _.filter(this.itemList,function(item){var hasCandidatesForShowNextAnswerFn=item.hasCandidatesForShowNextAnswer||function(){return!this.prefill&&!this.prefilled&&!this.isCorrect()}.bind(item);return"answers"!==item.state&&hasCandidatesForShowNextAnswerFn.call(item)})},getCandidatesForValidation:function(){return _.filter(this.itemList,function(item){var hasCandidatesForValidationFn=item.hasCandidatesForValidation||function(){return!this.prefill&&!this.prefilled}.bind(item);return"answers"!==item.state&&hasCandidatesForValidationFn.call(item)})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),this.hasCandidatesForValidation()||(this.state="answers"),question}},a5.models.interaction.Items.extend("a5.models.interaction.QuestionItems"),a5.models.options.Options={init:function(parents){this.parents=parents,this.parents&&this.parents.reverse(),this.options={},this.customOptions={},this.version=0},getVersion:function(){var versions=_.pluck(this.parents,"version");return _.max(versions)},readAll:function(xml){xml=xml.replace(/(<key>|<value>)/g,"$1<![CDATA["),xml=xml.replace(/(<\/key>|<\/value>)/g,"]]>$1");var options=$($.parseXML(xml)).find("options");try{"options-v2"==options.attr("data-author")?this._readAll_v2(options):this._readAll_v1(options)}catch(e){logger.warn("invalid options xml")}},_readAll_v1:function(xml){this.version=1,xml.find("option").each(_.bind(function(index,option){var $option=$(option);"LO_setting"!=$option.attr("key")&&(this.options[$option.attr("id")]=$option.attr("key"),void 0!==$option.attr("value")&&(this.customOptions[$option.attr("id")]=$option.attr("value")))},this))},_readAll_v2:function(xml){this.version=2,xml.find("option").each(_.bind(function(index,option){var $option=$(option),id=$option.attr("id"),key=this._serialize($option.find("key").first()),value=this._serialize($option.find("value").first());"LO_setting"!=key&&(_.isUndefined(key)||(this.options[id]=htmlDecode(key).replace(/&#13;&#10;/g,"\n")),_.isUndefined(value)||(this.customOptions[id]=htmlDecode(value).replace(/&#13;&#10;/g,"\n")))},this))},_serialize:function($node){if($node[0]){var xml=(new XMLSerializer).serializeToString($node[0]);return xml=xml.replace(/^(<key><\/key>|<value><\/value>)$/,""),xml=xml.replace(/^(<key><!\[CDATA\[|<value><!\[CDATA\[)/,""),xml=xml.replace(/(]]><\/key>|]]><\/value>)$/,"")}},readAllFromObject:function(options){_(options).each(function(option,id){"LO_setting"!=option.key&&(this.options[id]=option.key,void 0!==option.value&&(this.customOptions[id]=option.value))},this)},get:function(id){if(this.parents){var found=void 0;return _.each(this.parents,function(e){_.isUndefined(found)&&(found=e.get(id))}),found}if(id in this.options)return this.options[id]},contains:function(id,value){var val=JSON.parse(this.get(id));return _.indexOf(val,value)>-1},exportOptions:function(){for(var result={},i=0;i<1e3;i++){var opt_id=String("000"+i).slice(-3),opt=this.get(opt_id);_.isUndefined(this.name_map[opt_id])||(result[opt_id]={name:this.name_map[opt_id],key:opt,val:this.getValue(opt_id)})}return result},getLOParts:function(){var parts=[],partsValue=this.get("375");return partsValue=$.parseJSON(partsValue),partsValue&&_.each(partsValue.items,function(item){var partNumbers=item.numbers.split("-");partNumbers.length<2&&(partNumbers[1]=partNumbers[0]),parts.push({from:parseInt(partNumbers[0],10),to:parseInt(partNumbers[1],10),label:item.label})},this),parts},getFromJSON:function(id){return JSON.parse(this.get(id))},getValue:function(id){if(this.parents){var found=void 0;return _.each(this.parents,function(e){_.isUndefined(found)&&(found=e.getValue(id))}),found}if(id in this.customOptions)return this.customOptions[id]},has:function(id){return!_.isUndefined(this.get(id))},hasValue:function(id){return!_.isUndefined(this.getValue(id))},hasHints:function(){try{return JSON.parse(_.unescape(this.getHints())).items.length>0}catch(e){return!1}},hasResourceBanks:function(){if(!this.resourceBanksIsOn())return!1;try{return!!JSON.parse(this.getResourceBanks()).items.length}catch(e){return!1}},getFeedbackCorrect:function(){return this.feedbackCorrectIsCustom()?this.getValue("462"):null},getFeedbackIncorrect:function(){return this.feedbackIncorrectIsCustom()?this.getValue("463"):null},getRevealObject:function(){var revealLabel,hideLabel,revealObject=this._super();if(!this.revealObjectIsFalse()){var value=this.getValue("021");if(value){var labels=value.split("|");revealLabel=labels[0]&&labels[0].trim(),hideLabel=labels[1]&&labels[1].trim(),revealObject=this.get("021")}}return{key:revealObject,revealLabel:revealLabel,hideLabel:hideLabel}},getShowSubmit:function(){var showSubmit=this._super(),result={};try{if(showSubmit=$.parseJSON(showSubmit),showSubmit.items&&2==showSubmit.items.length){var texts=showSubmit.items[0].label;if(texts){var matches=/^(#(.*)#)?(.*)$/gi.exec(texts);result.dialogHeadingText=matches[2],result.dialogContentText=matches[3]}var buttons=showSubmit.items[1].label;if(buttons){var labels=buttons.split("|");result.dialogSubmitText=labels[0]&&labels[0].trim(),result.dialogCancelText=labels[1]&&labels[1].trim()}}else{var entries=["submit","dialogHeading","dialogContent","dialogSubmit","dialogCancel"];_.each(showSubmit.items,function(item,i){var data=item.label.split("|");result[entries[i]+"Text"]=data[0],result[entries[i]+"Tooltip"]=data[1]})}}catch(e){}return result},getExamsTimer:function(){var value=this._super(),regex=/^(\d+)\|(\d+)\|(.*)\|(\d+)\|(.*)$/,result=regex.exec(value);if(result)result={time:60*parseInt(result[1],10),first_warning:60*parseInt(result[2],10),first_warning_text:result[3],second_warning:60*parseInt(result[4],10),second_warning_text:result[5],with_hours:parseInt(result[1],10)>=60,timeFormat:"time_left",countIntroScreen:"off",timeoutType:"force_submit"};else try{value=$.parseJSON(value);var entries=["value","timeFormat","countIntroScreen","timeoutType","dialogHeading","dialogContent","dialogSubmitLabel","dialogSubmitTooltip","dialogContinueLabel","dialogContinueTooltip"];result={},_.each(value.items,function(item,i){result[entries[i]]=item.label});var timerData=regex.exec(result.value);timerData?_.extend(result,{time:60*parseInt(timerData[1],10),first_warning:60*parseInt(timerData[2],10),first_warning_text:timerData[3],second_warning:60*parseInt(timerData[4],10),second_warning_text:timerData[5],with_hours:parseInt(timerData[1],10)>=60}):result=!1}catch(e){}return result},getReferenceContent:function(){var value=this._super();try{value=$.parseJSON(value);var result=[];return value.items&&value.items[0]&&value.items[0]&&result.push(value.items[0].label),value.items&&value.items[1]&&value.items[1]&&result.push(value.items[1].label),result}catch(e){return"off"===value?[]:[value]}}},a5.models.options.BaseOptions.extend("a5.models.options.Options",a5.models.options.Options),a5.models.options.Enumeration={init:function(val,wrapPattern){void 0===val|"false"==val&&(val=""),this.value=val,this.wrapPattern='<span class="enum">|</span>',void 0!==wrapPattern&&(this.wrapPattern=wrapPattern),this._ready=$.Deferred(),this._done=$.Deferred()},finish:function(){this._done.resolve()},ready:function(){return this._ready},done:function(){return this._done},start:function(offsetDeferred){$.when(offsetDeferred).then(function(offset){this.offset=offset||0,this.counter=offset||0,this._ready.resolve()}.bind(this))},getCounter:function(){return this.done().then(function(){return this.counter}.bind(this))},getOffset:function(){return this.ready().then(function(){return this.offset}.bind(this))},useEnum:function(){return this.value.length>0},increment:function(){this.counter>26&&("letter"===this.value||"capitalletter"===this.value)&&(this.counter=0),this.counter++},next:function(html){return this.ready().then(function(){this.increment();var res=this.getEnumSymbol(this.counter,html);return this.trigger("next",res),res}.bind(this))},getEnumSymbol:function(i,html,wrapPattern){void 0===html&&(html="");var res,val=this.value;switch(val){case"number":res=i+".";break;case"number_no_dot":res=i;break;case"letter":res=String.fromCharCode(96+i)+")",i>26&&(i=0);break;case"capitalletter":res=String.fromCharCode(64+i)+".",i>26&&(i=0);break;case"bullet":res="&#8226;";break;default:if(""==val)return html;var arr=val.split("|");res=void 0!==arr[i]?arr[i]:""}return res=this.wrap(res,wrapPattern)+html},reset:function(){this.counter=0},wrap:function(str,wrapPattern){return(wrapPattern||this.wrapPattern).replace("|",str)}},Obj.extend("a5.models.options.Enumeration",a5.models.options.Enumeration),a5.models.options.Prefill={init:function(interaction){this.interaction=interaction,this.prefillFirstgap=interaction.options.prefillIsFirstitem(),this.prefillFirstBlock=interaction.options.prefillIsFirstblock(),this.prefillDone=!1,this.blockPrefillDone=!1,this.firstPrefillDone=!1},isPrefill:function(dontResetFirstPrefillDone){var prefillFirstgap=this.prefillFirstgap&&1==this.interaction.items.length()&&!this.firstPrefillDone;dontResetFirstPrefillDone||(this.firstPrefillDone=!0);var prefillFirstBlock=this.prefillFirstBlock&&1==this.interaction.items.length();return(prefillFirstgap||prefillFirstBlock)&&!this.prefillDone},isPrefillFirstBlock:function(){return this.prefillFirstBlock&&1==this.interaction.items.length()&&!this.blockPrefillDone},blockDone:function(){this.blockPrefillDone=!0,this.done()},done:function(){this.prefillDone=!0}},Obj.extend("a5.models.options.Prefill",a5.models.options.Prefill),a5.models.Metadata={init:function(metadata){this.metadata=metadata||{}},load:function($lo){var $metadata=$lo.find("> metadata"),metadata=this._readMetadata($metadata);metadata.screens=[],$lo.find("screens > screen").each(_.bind(function(index,screenNode){var $screenNode=$(screenNode),$screenMetadata=$screenNode.find("metadata"),screenName=$screenNode.find("> name").text();screenName&&metadata.screens.push({name:screenName,metadata:this._readMetadata($screenMetadata)})},this)),this.metadata=metadata},_readMetadata:function($node){var metadata={};return $node.find("group item").each(_.bind(function(index,item){var $item=$(item),group=$item.parent().attr("name"),key=$item.attr("title").toLowerCase(),m={values:this._getValues($item),group:group};metadata[key]=m},this)),metadata},getScreenMetadata:function(name,index){var screens=this.get("screens")||[],screenMetadata=_(screens).find(function(s){return s.name===name});!screenMetadata&&index<screens.length&&(screenMetadata=screens[index]);var metadata=screenMetadata&&screenMetadata.metadata;return new a5.models.Metadata(metadata)},get:function(id){return this.metadata[id.toLowerCase()]},contains:function(id,value){var val=this.get(id);return _.indexOf(val.values,value)>-1},getValues:function(id){var values=[];return this.metadata[id.toLowerCase()]&&(values=this.metadata[id.toLowerCase()].values),values},has:function(id){return!_.isUndefined(this.get(id))},_getValues:function($item){var values=[];return $item.attr("value")?values=[this._getAttrValue($item)]:$item.find("value").length>0&&(values=this._getNestedValues($item)),values},_getNestedValues:function($item){var values=[];return $item.find("value").each(function(index,value){var $value=$(value);values.push({value:$value.attr("key"),description:$value.attr("description")})}),values},_getAttrValue:function($item){return{value:$item.attr("value"),description:$item.attr("title")}}},
Obj.extend("a5.models.Metadata",a5.models.Metadata),a5.model_builder.Base={init:function(engine){this.engine=engine,this.activities={}},methodToBuild:function(node){var name=$.isXMLDoc(node[0])?node[0].nodeName:node[0].nodeName.toLowerCase();return node[0].nodeType==Node.TEXT_NODE&&(name="textNode"),"build"+a5.utils.capitalize(name)},build:function(interaction,parentNode,node){var name=this.methodToBuild(node);name in this?this[name].call(this,interaction,parentNode,node):logger.warn("no builder method '"+name+"' for ",this)},buildContents:function(node,interaction,appendTo,except){var cn=appendTo||$('<div class="content"></div>');return $(node).contents().each(function(i2,e2){except&&$(e2).is(except)||interaction.buildModel(cn,$(e2))}),cn},fetchChoices:function(interaction,node,selector,shuffling){var choices=node.find(selector);return _.isUndefined(shuffling)?interaction.options.randomiseanswersIsTrue()&&"true"===node.attr("shuffle")&&(choices=_.shuffle(choices)):shuffling&&(choices=_.shuffle(choices)),choices},addWordClasses:function(node,wordSiblings,descendant){var beginning=!1,ending=!1,word='[^\\s.:?!,;"Â¿Â¡âââââââ¹âºÂ«Â»]',previous=$(node.get(0).previousSibling);previous.is("br")||previous.is("*")&&"block"==previous.css("display")||(ending=previous.is(wordSiblings)||RegExp(word+"$").test(previous.text()));var next=$(node.get(0).nextSibling);next.is("br")||next.is("*")&&"block"==next.css("display")||(beginning=next.is(wordSiblings)||RegExp("^"+word).test(next.text())),descendant&&(node=node.find(descendant)),beginning?ending?node.addClass("word-middle"):node.addClass("word-beginning"):ending&&node.addClass("word-ending")}},Obj.extend("a5.model_builder.Base"),a5.model_builder.Comment={isResponsible:function(node){if(void 0!==Node&&node[0].nodeType==Node.COMMENT_NODE)return!0},build:function(){}},a5.model_builder.Element={isResponsible:function(node,interaction){var nodes=["div","p","br","blockquote","span","strong","em","u","table","tbody","th","tr","td","hr","table","thead","prompt","ul","ol","li","b","del","i","h1","h2","h3","h4","h5","h6","s","sup","sub"],exclude=a5.utils.hasId(node,"contentblock")&&"Input:Completion:Text gap"==interaction.identifier&&interaction.options.gapsIsInvisible();return exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Input:Completion:Maths"==interaction.identifier&&interaction.options.gapsIsInvisible(),exclude=exclude||a5.utils.hasId(node,"buddy"),exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Identify:Mark:Marking"==interaction.identifier,exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Identify:Mark:Proofing"==interaction.identifier,exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Identify:Mark:Autocorrect"==interaction.identifier,exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Order:Match:Text gap"==interaction.identifier&&"Trainer"!==LOInfo.mode&&"Exam"!==LOInfo.mode,exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Input:Completion:Text correction"==interaction.identifier,exclude=exclude||(a5.utils.hasId(node,"contentblock")||a5.utils.hasClass(node,"triangle-display-number"))&&"Input:Completion:Number triangle"==interaction.identifier,exclude=exclude||(a5.utils.hasId(node,"contentblock")||a5.utils.hasClass(node,"pyramid-display-number"))&&"Input:Completion:Number pyramid"==interaction.identifier,exclude=exclude||(a5.utils.hasId(node,"contentblock")||a5.utils.hasClass(node,"pyramid-display-number"))&&"Order:Match:Number pyramid"==interaction.identifier,exclude=exclude||(a5.utils.hasId(node,"contentblock")||a5.utils.hasClass(node,"wall-display-number"))&&"Input:Completion:Number wall"==interaction.identifier,exclude=exclude||(a5.utils.hasId(node,"contentblock")||a5.utils.hasClass(node,"layers-display-number"))&&"Input:Completion:Number layers"==interaction.identifier,exclude=exclude||a5.utils.hasId(node,"content"),exclude=exclude||a5.utils.hasId(node,"headerAudio"),exclude=exclude||(a5.utils.hasId(node,"slides")||a5.utils.hasId(node,"slide"))&&"Present:Present:Slideshow"===interaction.identifier,exclude=exclude||node[0].tagName&&"br"==node[0].tagName.toLowerCase()&&"Order:Match:Text gap"==interaction.identifier&&"Trainer"!==LOInfo.mode&&"Exam"!==LOInfo.mode,exclude=exclude||node[0].tagName&&"p"==node[0].tagName.toLowerCase()&&"Order:Match:Text gap"==interaction.identifier&&"Trainer"!==LOInfo.mode&&"Exam"!==LOInfo.mode,exclude=exclude||node[0].tagName&&"br"==node[0].tagName.toLowerCase()&&"Order:Match:Number pyramid"==interaction.identifier,exclude=exclude||node.is("#contentblock")&&"Input:Creative:Dialogue recording"===interaction.identifier,!!node[0].tagName&&(!exclude&&_.include(nodes,node[0].tagName.toLowerCase()))},build:function(interaction,parent,node,forceBuild){if("Order:Sort:Sorting"!==interaction.identifier||!a5.utils.hasId(node,"contentblock")||0!==node.children().length||!_.isEmpty(node.text().trim())){for(var elementNode=$(document.createElement(node[0].tagName)),attributes=node[0].attributes,i=0;i<attributes.length;i++){var a=attributes[i];"id"==a.nodeName&&"contentblock"==a.nodeValue?elementNode.addClass("contentblock"):"dictionary-selected-entry"===a.nodeName?elementNode.addClass("dictionary-selected-entry"):elementNode.attr(a.nodeName,a.nodeValue)}if(interaction.isMediaRendering){var style=$(node).attr("style"),isFW2Col="Input:Creative:Free writing 2 col"===interaction.identifier;isFW2Col&&elementNode.css("position",""),(isFW2Col||"string"==typeof style&&"true"==a5.utils.getStyleValue(style,"optionexpand"))&&(interaction.hasMediaToExpand=!0,elementNode.addClass("optionexpand"),elementNode.css("height","auto"))}parent.append(elementNode),elementNode.is(".contentblock")&&interaction.enumBlock&&interaction.enumBlock.useEnum()&&(elementNode.append('<span class="enumblock-placeholder"></span>'),interaction.enumBlock.next().then(function(enumSymbol){elementNode.find(".enumblock-placeholder").replaceWith(enumSymbol),elementNode.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}),elementNode.attr("tabindex",-1)),this._buildContents(node,elementNode,interaction,forceBuild),this._fixEmptyParagraphs(interaction,elementNode),this._fixLinebreaks(node,elementNode)}},_buildContents:function(node,elementNode,interaction,forceBuild){node.contents().each(function(index,e){elementNode.is("table")&&e.nodeType===Node.TEXT_NODE||interaction.buildModel(elementNode,$(e),forceBuild)})},_fixEmptyParagraphs:function(interaction,elementNode){elementNode.is(".contentblock")&&(_.contains(["Identify:Mark:Wordsnake","Order:Sort:Sorting"],interaction.identifier)&&elementNode.find("p").each(function(index,p){(0===$(p).children().length&&_.isEmpty($(p).text().trim())||0===$(p).children(":not(span)").length&&_.isEmpty($(p).text().trim()))&&$(p).remove()}),0===elementNode.children().length&&_.isEmpty(elementNode.text().trim())&&elementNode.remove())},_fixLinebreaks:function(node,elementNode){"p"==node[0].tagName&&""==$(elementNode).html()&&$(elementNode).html("&nbsp")}},a5.model_builder.Anchor={init:function(engine){this.engine=engine},isResponsible:function(node,interaction){return node.prop("tagName")&&"A"===node.prop("tagName").toUpperCase()},build:function(interaction,parentNode,node){for(var link=document.createElement(node[0].tagName),$link=$(link),attributes=node[0].attributes,i=0;i<attributes.length;i++){var a=attributes[i];$link.attr(a.nodeName,a.nodeValue)}node.contents().each(function(index,e){interaction.buildModel($link,$(e))}),$link.on("click",function(ev){ev.preventDefault(),a5.utils.startsWith(node.attr("href"),"#")||this.engine.invoke("open-link",link.href)}.bind(this)),parentNode.append($link)}},a5.model_builder.Text={isResponsible:function(node,interaction,forceBuild){var isText=3==node[0].nodeType,isCDATA=4==node[0].nodeType;if(forceBuild&&(isText||isCDATA))return!0;if(isCDATA)return!0;var ignore=["Identify:Mark:Marking","Input:Completion:Text correction","Identify:Mark:Proofing","Identify:Mark:Autocorrect"];return!_.include(ignore,interaction.identifier)&&isText&&!("Order:Match:Text gap"===interaction.identifier)&&!("Order:Match:Number pyramid"===interaction.identifier)&&!(interaction.options.gapsIsInvisible()&&"Input:Completion:Text gap"==interaction.identifier)&&!(new a5.model_builder.TextWordSnake).isResponsible(node,interaction)},build:function(interaction,parent,node){var txt=node.text();if(interaction.skipNextCharacters>0){var toSkip=interaction.skipNextCharacters;txt.length<toSkip&&(toSkip=txt.length),txt=txt.substring(toSkip),interaction.skipNextCharacters-=toSkip}txt=a5.utils.encodeHTMLSpecialChars(txt),txt=a5.utils.scramble(txt),parent.append(txt)}},a5.model_builder.Img={isResponsible:function(node,interaction){return node.is("img")&&!this._hasOtherBuilder(node,interaction)},_hasOtherBuilder:function(node,interaction){var otherImageBuilders=["Geogebra","MathML"];return _.some(otherImageBuilders,function(builderName){return(new a5.model_builder[builderName]).isResponsible(node,interaction)})},build:function(interaction,parentNode,node){var attribs=[],hotspots=[],n=$(node);if("bgimg"==n.attr("class")){var src=A5.ASSET_URL_BUILDER(n.attr("src"));return void $("#content_wrap_"+interaction.index).css("background-image",'url("'+src+'")')}n.attr("data-hotspots")&&(hotspots=$.parseJSON(n.attr("data-hotspots")),hotspots=_(hotspots).map(function(hotspot){return this._buildHotspot(hotspot)},this));for(var val,url,validAttributes=["do-not-load-src","src","alt","style","title","class","id"],imageAsTrigger=interaction.options.imageAsTriggerIsTrue(),hasTriggerAudio=!1,triggerAudioId=null,hasFlash=!1,i=0;i<validAttributes.length;i++){var attr=validAttributes[i];if(void 0!==n.attr(attr)){if(val=n.attr(attr),"alt"===attr){var trigger=/^#audio:(.*)#(.*)$/.exec(val);trigger&&(imageAsTrigger&&(hasTriggerAudio=!0,triggerAudioId=trigger[1]),val=trigger[2])}if("src"===attr||"do-not-load-src"===attr){var splitVal=val.split("URL=");hasFlash=2===splitVal.length,hasFlash?(url=splitVal[1],val=""):val=A5.ASSET_URL_BUILDER(val),"do-not-load-src"===attr&&(attr="src")}attribs.push(attr+'="'+val+'"')}}var img=$("<img "+attribs.join(" ")+"/>");if(hasFlash){url=A5.ASSET_URL_BUILDER(url),url=url.split("&")[0];var w=img.css("width").replace("px",""),h=img.css("height").replace("px",""),id="flash_"+Math.round(2e7*Math.random()),$flash=$('<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+w+'" height="'+h+'" id="'+id+'" align="middle"><param name="allowScriptAccess" value="always" /><param name="wmode" value="opaque"><param name="allowFullScreen" value="false" /><param name="movie" value="'+url+'" /><param name="quality" value="high" /><param name="bgcolor" value="#ffffff" /><param name="scale" value="showall" /><embed src="'+url+'" salign="TL" scale="showall" quality="high" bgcolor="#ffffff" width="'+w+'" height="'+h+'" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" name="'+id+'" wmode="opaque"/></object>');return $flash.css("display","inline-block"),void parentNode.append($flash)}if(imageAsTrigger&&hasTriggerAudio){var imgDiv=$('<div class="image-as-trigger"></div>');imgDiv.css("left",img.css("left")),imgDiv.css("top",img.css("top")),imgDiv.css("width",img.css("width")),imgDiv.css("height",img.css("height")),img.css("left","0px"),img.css("top","0px"),imgDiv.append(img);var $playBtn=$('<div class="play-button stopped inactive"></div>'),UID=triggerAudioId+"_"+a5.utils.createUID();$playBtn.attr("data-audio-uid",UID),img[0].style.zIndex&&$playBtn.css("z-index",img[0].style.zIndex),imgDiv.append($playBtn),parentNode.append(imgDiv),a5.service.media.audio.bind("ready",function(){var viewUpdater=new a5.model_builder.ImageAsTriggerViewUpdater(triggerAudioId,UID,interaction.options.audioiconbehaviourIsPause(),interaction);$playBtn.data("view-updater",viewUpdater),$playBtn.attr("data-has-view-updater","true"),_.defer(_.bind(viewUpdater.ready,viewUpdater))})}else parentNode.append(img);_(hotspots).each(function($hotspot){parentNode.append($hotspot)})},_buildHotspot:function(hotspot){return new a5.views.ImageHotspot(hotspot).render()}},Obj.extend("a5.model_builder.ImageAsTriggerViewUpdater",{init:function(audioID,UID,hasPauseBehaviour,interaction){this.UID=UID,this.hasPauseBehaviour=hasPauseBehaviour,this.status="loading",this.audio=a5.service.media.audio.create(audioID,{preload:!a5.dp.config.audioPreloadDisabled}),a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(this.audio),this.audio.bind("stopped",function(){this.stop()},this),this.audio.bind("paused",function(){hasPauseBehaviour||this.audio.stop()},this)},update:function(){var players=$("[data-audio-uid='"+this.UID+"']");players.off("click"),players.removeClass("playing inactive"),players.addClass("stopped"),players.toggleClass("show-pause-on-playing",this.hasPauseBehaviour),"ready"===this.status?players.on("click",_.bind(this.play,this)):"playing"===this.status?players.on("click",_.bind(this.pause,this)):players.on("click",function(e){e.preventDefault(),e.stopPropagation()}),"playing"===this.status?(players.addClass("playing"),players.removeClass("stopped")):"loading"===this.status&&players.addClass("inactive")},ready:function(){this.status="ready",this.update()},play:function(evt){$(evt.target).is(".no-play")?$(evt.target).removeClass("no-play"):($(".play-button").removeClass("playing"),$(".play-button").addClass("stopped"),a5.service.media.pauseAllExcept(this.audio),this.audio.play(),this.status="playing",this.update(),evt.stopPropagation(),evt.preventDefault())},pause:function(evt){this.audio.pause(),this.status="ready",this.update(),evt.stopPropagation(),evt.preventDefault()},stop:function(){this.status="ready",this.update()}}),a5.model_builder.ObjectImage={isResponsible:function(node,interaction){return a5.utils.hasTag(node,"object")&&["image/jpeg","image/png"].contains(node.attr("type"))&&"Order:Match:Text gap (Label an object)"!==interaction.identifier&&"Input:Completion:Text gap (Label an object)"!==interaction.identifier},build:function(interaction,parentNode,node){var imgNode=$('<img src="'+A5.ASSET_URL_BUILDER(node.attr("data"))+'" style="'+node.attr("style")+'"></img>');parentNode.append(imgNode),node.attr("width")&&imgNode.attr("width",node.attr("width")),node.attr("height")&&imgNode.attr("height",node.attr("height"))}},Obj.extend("a5.model_builder.Element"),Obj.extend("a5.model_builder.Comment"),Obj.extend("a5.model_builder.Text"),Obj.extend("a5.model_builder.Img"),Obj.extend("a5.model_builder.ObjectImage"),Obj.extend("a5.model_builder.Anchor"),a5.model_builder.builders=[new a5.model_builder.Element,new a5.model_builder.Comment,new a5.model_builder.Text,new a5.model_builder.Img,new a5.model_builder.ObjectImage],a5.model_builder.Content={isResponsible:function(node,interaction){return a5.utils.hasId(node,"content")&&"Input:Creative:Free writing 2 col"!==interaction.identifier&&"Identify:Mark:Marking"!==interaction.identifier&&"Identify:Mark:Proofing"!==interaction.identifier&&"Identify:Mark:Autocorrect"!==interaction.identifier&&"Identify:Select:Hangman"!==interaction.identifier&&("Input:Completion:Text correction"!==interaction.identifier||!interaction.options.errorCorrectionIsReplace())},buildDiv:function(interaction,parentNode,node){this.eachContentBlock(interaction,parentNode,node,function(e){interaction.buildModel(parentNode,e),interaction.postBuildModel(parentNode)})},eachContentBlock:function(interaction,parentNode,node,callback){var contents=node.children();_.each(contents,function(e,i){var blockScore=interaction.options.getScoreValuesPerBlock().split(",");blockScore=parseInt(blockScore[i],10),_.isNaN(blockScore)&&(blockScore=void 0),interaction.blockItems=new a5.models.interaction.QuestionItems({blockScore:blockScore,parent:interaction.items}),interaction.items.add(interaction.blockItems),a5.mainBuilder.options(!0).continuousEnumerationIsOn()||interaction.enumAnswers.ready().then(function(){interaction.enumAnswers.reset()}),callback.call(this,$(e))},this)}},a5.model_builder.Base.extend("a5.model_builder.Content"),a5.model_builder.builders.push(new a5.model_builder.Content),a5.model_builder.Geogebra={isResponsible:function(node,interaction){return node.is("img")&&node.attr("data-geogebra")},buildImg:function(interaction,parentNode,node){var img=$("<span>");(new a5.model_builder.Img).build(interaction,img,node),parentNode.append(img),this._drawApplet(interaction,parentNode,node,img)},_drawApplet:function(interaction,parentNode,node,img){var html5CodeBase=A5.GEOGEBRA,parameters=JSON.parse(node.attr("data-author")).ggb,options={width:parameters.width,height:parameters.height,showAlgebraInput:parameters.showAlgebraInput,showResetIcon:parameters.showResetIcon,showToolBar:parameters.showToolBar,showMenuBar:parameters.showMenuBar,borderColor:null,allowStyleBar:!1,enableLabelDrags:!1,enableShiftDragZoom:!0,capturingThreshold:null,showToolBarHelp:!1,errorDialogsActive:!1,showTutorialLink:!1,showLogging:!1,useBrowserForJS:!1,perspective:"G",ggbBase64:node.attr("data-geogebra"),gridVisible:parameters.gridVisible},$parent=$('<div class="geogebra-wrapper"></div>');parentNode.append($parent),a5.service.Attachment.currentAttachment&&(_.extend(options,{scaleContainerClass:a5.service.Attachment.currentAttachment.getClass()}),a5.service.Attachment.currentAttachment.$.addClass("has-geogebra"));var ggbnode=$parent.get(0);parameters.geoGebraObject&&interaction.bind("show:deferred",function(){options.appletOnLoad=function(){img.remove(),options.showAlgebraInput&&applet.getAppletObject().showAlgebraInput(!0),options.showResetIcon&&applet.getAppletObject().showResetIcon(!0),applet.getAppletObject().setGridVisible(Boolean(options.gridVisible))};var applet=new GGBApplet(options,"5.0","applet_container_"+a5.utils.createUID(),!0);applet.setHTML5Codebase(html5CodeBase),applet.inject(ggbnode)})}},a5.model_builder.Base.extend("a5.model_builder.Geogebra"),a5.model_builder.builders.push(new a5.model_builder.Geogebra),jQuery.fn.addInteractionStyle=function(style){this.closest(".interaction").addClass(style)},jQuery.fn.naturalSize=function(css,container){var params=$.extend({width:"auto",height:"auto",display:"inline-block"},css),node=this.first(),clone=node.clone();clone.css(params);var wh=[0,0];if(container){var containerNode=$("<div></div>");node.parent().append(containerNode),containerNode.append(clone),containerNode.css(container),wh=[clone.outerWidth(),clone.outerHeight()],containerNode.remove()}else node.parent().append(clone),wh=[clone.outerWidth(),clone.outerHeight()],clone.remove();return wh},jQuery.fn.boundingBox=function(){var x=0,y=0;return this.children().each(function(i,e){var left=($(e).position(),parseInt($(e).css("left"),10)||0),top=parseInt($(e).css("top"),10)||0,xm=left+$(e).outerWidth(!0),ym=top+$(e).outerHeight(!0);xm>x&&(x=xm),ym>y&&(y=ym)}),"border-box"!=this.css("box-sizing")&&"border-box"!=this.css("-webkit-box-sizing")&&"border-box"!=this.css("-moz-box-sizing")||(x+=parseInt(this.css("borderLeftWidth"),10)+parseInt(this.css("borderRightWidth"),10),y+=parseInt(this.css("borderTopWidth"),10)+parseInt(this.css("borderBottomWidth"),10)),{width:x,height:y}},jQuery.fn.applyBoundingBox=function(){this.css(this.boundingBox())},jQuery.fn.applyBoundingHeight=function(){this.css({height:this.boundingBox().height})},jQuery.fn.inlineOffset=function(){var el=$("<i>a</i>").css("display","inline").insertBefore(this[0]),pos=el.offset();return el.remove(),pos},jQuery.fn.textWidth=function(text){var $input=this.first(),$fakeEl=$("<fake/>");$fakeEl.css({visibility:"hidden",position:"absolute",top:-9999,left:-9999,width:"auto",whiteSpace:"nowrap",fontSize:$input.css("fontSize"),fontFamily:$input.css("fontFamily"),fontWeight:$input.css("fontWeight"),fontVariant:$input.css("fontVariant"),fontStyle:$input.css("fontStyle"),letterSpacing:$input.css("letterSpacing"),paddingLeft:$input.css("paddingLeft"),paddingRight:$input.css("paddingRight"),borderLeftWidth:$input.css("borderLeftWidth"),borderLeftStyle:$input.css("borderLeftStyle"),borderRightWidth:$input.css("borderRightWidth"),borderRightStyle:$input.css("borderRightStyle")});var htmlText=text||$input.val()||$input.text();htmlText=htmlText.replace(/\s/g,"&nbsp;"),$fakeEl.html(htmlText),$fakeEl.insertAfter($input);var width=Math.ceil($fakeEl.width());return($("body.isIE11").length>0||$("body.isIE").length>0||$("body.isEdge").length>0||$("body.isIOS.isSafari").length>0)&&(width+=2),$("body.isEdge").length>0&&(width+=2),$fakeEl.remove(),width},jQuery.fn.delayedTooltip=function(options){this.each(function(index){var $node=$(this).is("input")?$(this).parent():$(this),$tooltip=$node.find(options.selector||".tooltip");if($tooltip.length){var opts={delay:options.delay,duration:options.duration,onStart:function(){$tooltip.addClass("active"),options.start&&options.start($tooltip)},onEnd:function(){$tooltip.removeClass("active"),options.end&&options.end($tooltip)}},tooltipTimer=new a5.utils.TaskTimer(opts);$(this).on("mouseover",function(ev){if(!(options.cancel&&$(this).find(options.cancel).length>0&&($(ev.target).closest(options.cancel).length>0||$(ev.target).is(options.cancel).length>0))){tooltipTimer.start(),$tooltip.removeClass("tooltip-left tooltip-top tooltip-right tooltip-bottom");var tooltipRect=$tooltip.get(0).getBoundingClientRect(),container=_.result(options,"container"),containerRect=container&&container.length&&container.get(0).getBoundingClientRect();(tooltipRect.left<0||containerRect&&tooltipRect.left<containerRect.left)&&$tooltip.addClass("tooltip-left"),(tooltipRect.top<0||containerRect&&tooltipRect.top<containerRect.top)&&$tooltip.addClass("tooltip-top"),(tooltipRect.right>window.innerWidth||containerRect&&tooltipRect.right>containerRect.right)&&$tooltip.addClass("tooltip-right"),(tooltipRect.bottom>window.innerHeight||containerRect&&tooltipRect.bottom>containerRect.bottom)&&$tooltip.addClass("tooltip-bottom"),$(this).one("mouseout click",function(ev){tooltipTimer.stop()})}})}})},function($){var pollingId,$backdrop,$wrap,lastHeight,lastWidth,closed=function(callbacks,e){var $iframe=$(this);if(!0!==$iframe.data("already-closed")){$iframe.data("already-closed",!0),callbacks&&callbacks.close&&callbacks.close.call($iframe),e.preventDefault(),$backdrop.remove(),$wrap.remove();var src=$iframe.attr("src");$iframe.attr("src","about:blank"),$iframe.closest(".neat-ios-fix").remove(),$iframe.attr("src",src),clearInterval(pollingId)}},pageRenderedWithFixedSize=function($iframe,callbacks){callbacks&&callbacks.open&&callbacks.open.call($iframe),_setVisible($iframe)},pageRendered=function($iframe,width,height,callbacks){_setIframeSizes($iframe,width,height),callbacks&&callbacks.open&&callbacks.open.call($iframe),_setVisible($iframe)},pageRendering=function($iframe,$wrap,callbacks){var height=$wrap.outerHeight(!0),width=$wrap.outerWidth(!0);lastHeight==height&&lastWidth==width&&(clearInterval(pollingId),pageRendered($iframe,width,height,callbacks)),lastHeight=height,lastWidth=width},checkIframeContentLoaded=function(callbacks){var $iframe=$(this),$wrap=$iframe.contents().find("#wrap");$wrap.length>0&&pageRendering($iframe,$wrap,callbacks)},_setPageCloseHook=function($iframe,callbacks){$iframe.contents().on("click","#page-close",$.proxy(closed,$iframe[0],callbacks));try{var iframeWindow=$iframe[0].contentWindow;iframeWindow.a5.hooks.layoutStylesLoaded.add(function(){iframeWindow.a5.dp.config.allowLOSelfClosing=!1})}catch(e){}},_setIframeSizes=function($iframe,width,height){var $wrap=$iframe.closest(".neat-ios-fix");$wrap.width(width+"px").css("margin-left",-$wrap.width()/2+"px"),$wrap.height(height+"px").css("margin-top",-$wrap.height()/2+"px")},_setVisible=function($iframe){$iframe.removeClass("invisible")};$.fn.iframeModal=function(callbacks){var $body=$("body"),$iframe=$(this).detach();return $iframe.removeData("already-closed"),$backdrop&&$backdrop.remove(),$backdrop=$('<div class="modal-backdrop fade in"><div class="loader"></div></div>').appendTo($body),$backdrop.on("click",$.proxy(closed,this,callbacks)),$wrap&&$wrap.remove(),$wrap=$('<div class="neat-ios-fix"></div>'),$iframe.addClass("modal-content invisible").appendTo($wrap),$wrap.appendTo($body),$($iframe[0].contentWindow).on("DOMContentLoaded",function(){var hooks=window.A5||{};if(_setPageCloseHook($iframe,callbacks),hooks.LO_IFRAME_SIZE_FIXED)return void pageRenderedWithFixedSize($iframe,callbacks);if(hooks.LO_IFRAME_SIZE){var size=_(hooks).result("LO_IFRAME_SIZE");return void pageRendered($iframe,size[0],size[1],callbacks)}$iframe[0].contentWindow.onbeforeunload=$.proxy(closed,$iframe[0],callbacks),pollingId=setInterval($.proxy(checkIframeContentLoaded,$iframe[0],callbacks),500)}),$(this)}}(jQuery),a5.AudioEvents={init:function(packageURL,interactionType,interaction){this.packageURL=packageURL,this.interaction=interaction,logger.info("LOADING\t",packageURL+"/audios/"+interactionType+".txt"),$.ajax({url:packageURL+"/audios/"+interactionType+".txt?time="+ +new Date,dataType:"text",success:function(data){this.loaded(data)}.bind(this),error:function(data,e1,e2){logger.log(e1,e2)}.bind(this)}),this.audios={}},loaded:function(data){_.each(data.split("\n"),function(line){if(line.trim().length>0){var parts=line.split(":"),filename=parts[2].trim(),ns=a5.service.media.audio.create("_"+filename,{url:this.packageURL+"audios/"+filename,preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())});this.audios[filename]=ns;$(parts[0].trim()).live(parts[1].trim(),function(e){this.audios[filename].play()}.bind(this))}},this)}},Obj.extend("a5.AudioEvents"),A5.AVATAR={STATIC:"static",RUBRIC:"rubric",HINT:"hint",FEEDBACK:"feedback",SLEEP:"sleep",IDLE:"idle"},a5.service.AvatarEvent=function(avatar,new_state,prev_state){this.avatar=avatar,this.interaction=avatar.interaction,this.new_state=new_state,this.prev_state=prev_state},a5.service.Avatar={WAKEUP_EVENTS:["mousedown","touchstart","mouseup","touchend","touchmove","keydown","keyup","mousemove"],SLEEP_TIMEOUT_MILLISECONDS:5e3,_sleep_disabled:!1,__rubricSkipped:!1,audios:{last_audio:void 0,sound_effect:void 0,rubric_audio:void 0,feedback_band_audio:void 0,feedback_checkmax_audio:void 0,hint_audio:[void 0,void 0,void 0]},init:function(interaction){this.interaction=interaction,this.audios=_.clone(this.audios),this.audios.hint_audio=[],this._audio_history=[],_.bindAll(this,"_triggerIdle"),this.bindEvents(),this._volume=a5.service.media.audio_manager.VOLUME_MAX,this._initialized=!1},bindEvents:function(){this.interaction.bind("show",_.bind(function(){if(0!=this.interaction.index||!a5.dp.config.avatarAutostartDisabled)return this.interaction.isEndResultScreen()&&a5.mainBuilder.getLastFeedbackBand()?(this._feedbackBandHandler(this.interaction.getResults()),void this.trigger("avatar:feedback_band",this.interaction.getResults())):this.interaction.options.showhintsIsOff()&&a5.dp.config.avatarHideWhenHintsOff?void this.trigger("avatar:hide",{dont_trigger_static:!0}):void this.trigger("initialize")},this)),this.interaction.bind("language:change",_.bind(function(lang){this.__getRubricAudio(),this.trigger("avatar:rubric")},this)),this.bind("initialize",_.bind(function(){this._interactionShowHandler(),this._initialized=!0},this)),this.bind("avatar:init",_.bind(function(){this.__getHintAudios(),this.__getRubricAudio(),this.setState(A5.AVATAR.STATIC)},this)),this.bind("avatar:idle",_.bind(function(){this.getState()!=A5.AVATAR.IDLE&&this.setState(A5.AVATAR.IDLE),clearTimeout(this._sleepTimer),this._setupSleepTimer()},this)),this.bind("avatar:sleep",_.bind(function(){this.setState(A5.AVATAR.SLEEP)},this)),this.bind("avatar:rubric",_.bind(this._rubricHandler,this)),this.interaction.bind("interaction:hint:close",this._triggerIdle,{once:!0}),this.interaction.bind("interaction:dialog:close",_.bind(function(){a5.service.media.audio.stopAll(),this._triggerIdle(),this.audios.last_audio=this.audios.rubric_audio,this._last_state=A5.AVATAR.RUBRIC},this)),this.interaction.bind("interaction:feedback_band",_.bind(function(interaction){this._feedbackBandHandler(this.interaction.getResults()),this.trigger("avatar:feedback_band",this.interaction.getResults())},this)),this.bind("avatar:hide",function(options){options&&options.dont_trigger_static||this.setState(A5.AVATAR.STATIC)}),this.interaction.bind("hide",_.bind(function(){var hintsoff=this.interaction.options.showhintsIsOff()&&a5.dp.config.avatarHideWhenHintsOff;this.trigger("avatar:hide",{dont_trigger_static:hintsoff})},this)),$("body").on(this.WAKEUP_EVENTS.join(" "),_.bind(this._wakeupEventHandler,this)),this.interaction.bind("interaction:hint",_.bind(this._interactionHintHandler,this))},__getFeedbackBand:function(){var band=$("<div>"),feedback=$("<span>"+a5.mainBuilder.getLastFeedbackBand()+"</span>");return this.interaction.buildModel(band,feedback),band},__getMaxAttemptsBand:function(feedback){var band=$("<div>");return this.interaction.buildModel(band,$(feedback)),band},__getHintAudios:function(){if(this.interaction.options.getHints()){var hint1,hint2,hint3,hints=this.interaction.options.getHints();try{JSON.parse(_.unescape(hints))}catch(e){hints=hints.replace(/"/g,'\\"')}try{this._hints=JSON.parse(_.unescape(hints)),hint1=this._hints.items[0],hint2=this._hints.items[1],hint3=this._hints.items[2]}catch(e){}if(hint1&&hint1.label.trim()){var hint1_node=$("<div>");this.interaction.buildModel(hint1_node,$(hint1.label)),this.audios.hint_audio[0]=this.__get_audio_object(hint1_node)}if(hint2&&hint2.label.trim()){var hint2_node=$("<div>");this.interaction.buildModel(hint2_node,$(hint2.label)),this.audios.hint_audio[1]=this.__get_audio_object(hint2_node)}if(hint3&&hint3.label.trim()){var hint3_node=$("<div>");this.interaction.buildModel(hint3_node,$(hint3.label)),this.audios.hint_audio[2]=this.__get_audio_object(hint3_node)}}},__getRubricAudio:function(){this.audios.rubric_audio=this.__get_audio_object(this.interaction.rubricZone)},__get_audio_object:function(node){var audio_node=node.find("*[data-playable-media]").not(".a5-avatar-ignore-audio").first();if(audio_node.length){var audio_id=audio_node.attr("data-playable-media"),audio_object=a5.service.media.by_id[audio_id];return audio_object.volume(this.getVolume()),audio_object}},_interactionShowHandler:function(){this._initialized||this.trigger("avatar:init"),_.defer(_.bind(function(){this.trigger("avatar:show"),this.audios.rubric_audio?this.trigger("avatar:rubric"):this.trigger("avatar:idle")},this))},_sleepHandler:function(){this.getState()==A5.AVATAR.IDLE&&this.trigger("avatar:sleep")},_setupSleepTimer:function(){this._sleep_disabled||(this._sleepTimer=setTimeout(_.bind(this._sleepHandler,this),this.SLEEP_TIMEOUT_MILLISECONDS))},_wakeupEventHandler:function(e){clearTimeout(this._sleepTimer),this._setupSleepTimer(),this.interaction===a5.mainBuilder.curInteraction&&this.getState()===A5.AVATAR.SLEEP&&this._triggerIdle()},_triggerIdle:function(){this.trigger("avatar:idle")},_interactionHintHandler:function(hint_id){this.trigger("avatar:hint",hint_id),_.defer(this._hintHandler.bind(this),hint_id)},_stopOnPauseAll:function(){var lastAudio=this.audios.last_audio;lastAudio.bind("paused",_.bind(function(){lastAudio.stop()},this))},_hintHandler:function(hint_id){this.setState(A5.AVATAR.HINT),this.audios.hint_audio[hint_id]&&(a5.service.media.audio.pauseAllExcept(this.audios.hint_audio[hint_id]),this._play(this.audios.hint_audio[hint_id]),this.audios.last_audio=this.audios.hint_audio[hint_id],this._stopOnPauseAll(),this._audio_history.push(this.audios.last_audio),this._idleOnStop(this.audios.hint_audio[hint_id]))},_rubricHandler:function(){this.setState(A5.AVATAR.RUBRIC),this.audios.rubric_audio&&(!a5.service.Avatar.__rubricSkipped&&a5.dp.config.avatarRubricDisabled?(a5.service.Avatar.__rubricSkipped=!0,this._triggerIdle()):(a5.service.media.audio.pauseAllExcept(this.audios.rubric_audio),this._play(this.audios.rubric_audio)),
this.audios.last_audio=this.audios.rubric_audio,this._stopOnPauseAll(),this._audio_history.push(this.audios.last_audio),this._idleOnStop(this.audios.rubric_audio))},_feedbackBandHandler:function(results){this.setState(A5.AVATAR.FEEDBACK),this.audios.feedback_band_audio=this.__get_audio_object(this.__getFeedbackBand()),this.audios.feedback_band_audio?(a5.service.media.audio.pauseAllExcept(this.audios.feedback_band_audio),this._play(this.audios.feedback_band_audio),this.audios.last_audio=this.audios.feedback_band_audio,this._stopOnPauseAll(),this._audio_history.push(this.audios.last_audio),this.audios.feedback_band_audio.bind("stopped",_.bind(this._checkAnswerHandler,this))):this._checkAnswerHandler()},_feedbackCheckMaxHandler:function(results){if(results.isPercent100(!0))return this._triggerIdle();a5.service.media.audio.pauseAllExcept(this.audios.feedback_checkmax_audio),this._play(this.audios.feedback_checkmax_audio),this.audios.last_audio=this.audios.feedback_checkmax_audio,this._stopOnPauseAll(),this._audio_history.push(this.audios.last_audio),this._idleOnStop(this.audios.feedback_checkmax_audio),this.trigger("avatar:feedback_checkmax",this.interaction.getResults())},_checkAnswerHandler:function(options){var feedback="<span>"+a5.mainBuilder.getLastCheckMaxFeedback()+"</span>";this.audios.feedback_checkmax_audio=this.__get_audio_object(this.__getMaxAttemptsBand(feedback)),this.audios.feedback_checkmax_audio?this._feedbackCheckMaxHandler(this.interaction.getResults()):this.trigger("avatar:idle")},_play:function(audio){this._idleOnStopAudio&&(this._idleOnStopAudio.unbind(this._triggerIdle),delete this._idleOnStopAudio),a5.service.media.audio.pauseAllExcept(audio),audio.play()},_idleOnStop:function(audio){this._idleOnStopAudio=audio,audio.bind("stopped",this._triggerIdle,this,{once:!0})},trigger:function(event_name,data_object){var av_event=new a5.service.AvatarEvent(this,this.getState(),this._last_state);data_object||(data_object=av_event),this._super(event_name,data_object,av_event)},setState:function(state){logger.info("(interaction #"+this.interaction.index+") AVATAR STATE: "+state),state!=A5.AVATAR.SLEEP&&clearTimeout(this.sleepTimer),this._state!=state&&(this._state!=A5.AVATAR.IDLE&&this._state!=A5.AVATAR.SLEEP&&(this._last_state=this._state),this._state=state,this.trigger("avatar:state_change"))},getLastAudio:function(){return{audio:this.audios.last_audio,state:this._last_state}},setLastAudio:function(audio_object,state){this.audios.last_audio=audio_object,this._last_state=state||this._last_state},playLastAudio:function(){var last=this.getLastAudio();last.state&&this.setState(last.state),last.audio&&!last.audio.isPlaying()&&(a5.service.media.audio.pauseAllExcept(last.audio),this._play(last.audio),this._stopOnPauseAll(),this._idleOnStop(last.audio))},playLastNAudios:function(n,options){this._last_state&&this.setState(this._last_state);var audios=_.last(this._audio_history,n);options&&options.reverse&&audios.reverse();function next(){audios.shift(),audios.length?(audios[0].position(0),audios[0].unbind(),a5.service.media.audio.pauseAllExcept(audios[0]),this._play(audios[0]),audios[0].bind("stopped",_.bind(next,this))):this._triggerIdle()}audios.length&&(audios[0].position(0),audios[0].unbind(),a5.service.media.audio.pauseAllExcept(audios[0]),this._play(audios[0]),audios[0].bind("stopped",_.bind(next,this)))},playEffect:function(path,params){var dp_path=a5.mainBuilder.layout.packageURL,buildUrl=a5.dp.config.avatarUrlBuilder||function(id,fmt){return dp_path+id+"."+fmt};return this.audios.sound_effect=a5.service.media.audio.create(path,{buildUrl:buildUrl,preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())}),this.audios.sound_effect.volume(this.getVolume()),this._play(this.audios.sound_effect),params&&params.add_to_history&&(this.audios.last_audio=this.audios.sound_effect),params&&params.loop?this.audios.sound_effect.bind("stopped",_.bind(function(){a5.service.media.audio.pauseAllExcept(this.audios.sound_effect),this._play(this.audios.sound_effect)},this)):this._idleOnStop(this.audios.sound_effect),this.audios.sound_effect},playHint:function(hint_id){this.audios.hint_audio[hint_id]&&this._interactionHintHandler(hint_id||0)},getHints:function(){return _.filter(_.keys(this.audios.hint_audio),function(key){return!!this.audios.hint_audio[key]},this)},pauseEffects:function(){this.audios.sound_effect&&this.audios.sound_effect.pause()},getState:function(state){return this._state},setVolume:function(volume){this._volume=volume;var audios=_.flatten(_.values(this.audios));_.each(audios,function(audio){audio&&audio.volume(volume)}),this.trigger("avatar:volume_change",this.getVolume())},disableSleep:function(){clearTimeout(this._sleepTimer),this._sleep_disabled=!0},enableSleep:function(){this._sleep_disabled=!1},setIdleState:function(){this._triggerIdle()},getVolume:function(volume){return this._volume}},Obj.extend("a5.service.Avatar",a5.service.Avatar),a5.service.Buddy={events:{animate:"buddyAnimate",hide:"buddyHide",removed:"buddyRemoved"},states:{animate:"animated",hide:"hidden",removed:"removed"},init:function(interaction,state,$node,audioID){this.interaction=interaction,this.uid=a5.utils.createUID(),this.$node=$node,this.$node.attr("id","buddy-"+this.uid),this.state=state,this.audioID=audioID,this.currentState,this._addListeners(),interaction.isVisibleAndLoaded()&&this._onInteractionShow()},_addListeners:function(){_.bindAll(this,"_onNodeRemoved","triggerBuddyAnimationEvent","_onInteractionShow","_onInteractionHide"),this.interaction.bind("show",this._onInteractionShow,this),this.interaction.bind("hide",this._onInteractionHide,this),this.$node.on("remove",this._onNodeRemoved)},_removeListenrs:function(){this.interaction.unbind("show",this._onInteractionShow),this.interaction.unbind("hide",this._onInteractionHide),this.$node.off("remove",this._onNodeRemoved)},_onInteractionShow:function(){_.defer(function(buddy){buddy.currentState!==buddy.states.removed&&(buddy.updateCurrentState(buddy.states.animate),buddy.triggerBuddyAnimationEvent(buddy.events.animate))},this)},_onInteractionHide:function(){this.updateCurrentState(this.states.hide),this.triggerBuddyAnimationEvent(this.events.hide)},_onNodeRemoved:function(){this._removeListenrs();var prevState=this.currentState;this.updateCurrentState(this.states.removed),prevState!==this.states.hide&&prevState!==this.states.animate||this.triggerBuddyAnimationEvent(this.events.removed)},updateCurrentState:function(state){this.currentState=state},triggerBuddyAnimationEvent:function(evt){logger.log("#buddy# event:"+evt+", uid: "+this.uid),a5.eventBus.trigger("lo:"+evt,{state:this.state,audio:this.audioID,id:this.uid,interactionIndex:this.interaction.index})},_addDPEmulatorEvents:function(){_.bindAll(this,"_onAudioStop","_onAudioPlay","_onBuddyAnimate","_onBuddyHide","_onBuddyRemove"),a5.eventBus.bind("lo:buddyAnimate",this._onBuddyAnimate,this),a5.eventBus.bind("lo:buddyHide",this._onBuddyHide,this),a5.eventBus.bind("lo:buddyRemoved",this._onBuddyRemove,this)},_onAudioStop:function(e){logger.log("audio has stopped/paused",this.uid,this.audioID)},_onAudioPlay:function(e){logger.log("audio has started",this.uid,this.audioID)},_onBuddyAnimate:function(e){if(e.id===this.uid&&e.audio){logger.log("lo:buddyAnimate",this.uid);var audio=a5.service.media.by_id[e.audio];audio.unbind("start",this._onAudioPlay),audio.unbind("paused",this._onAudioStop),audio.unbind("stopped",this._onAudioStop),audio.bind("start",this._onAudioPlay,this),audio.bind("paused",this._onAudioStop,this),audio.bind("stopped",this._onAudioStop,this),audio.play()}},_onBuddyHide:function(e){e.id===this.uid&&logger.log("lo:buddyHide",this.uid)},_onBuddyRemove:function(e){if(e.id===this.uid&&e.audio){logger.log("lo:buddyRemoved",this.uid);var audio=a5.service.media.by_id[e.audio];audio.unbind("start",this._onAudioPlay),audio.unbind("paused",this._onAudioStop),audio.unbind("stopped",this._onAudioStop),a5.eventBus.unbind("lo:buddyAnimate",this._onBuddyAnimate),a5.eventBus.unbind("lo:buddyHide",this._onBuddyHide),a5.eventBus.unbind("lo:buddyRemoved",this._onBuddyRemove)}}},Obj.extend("a5.service.Buddy",a5.service.Buddy),a5.service.lms.APIFacade={init:function(API,canStore,canRestore){this.API=API,this.canStore=canStore,this.canRestore=canRestore},start:function(){return this.API.start()},setScore:function(score){this.canStore&&this.API.setScore(score.correct(),score.total())},setDetailedScore:function(interactionScores){this.canStore&&this.API.setDetailedScore(interactionScores)},setBookmark:function(page){this.canStore&&this.API.setBookmark(page+"")},getBookmark:function(){var deferred=$.Deferred();return this.canRestore?this.API.getBookmark().always(function(num){num=parseInt(num,10),isNaN(num)?deferred.resolve(null):deferred.resolve(num)}):deferred.resolve(null),deferred.promise()},loadData:function(){var deferred=$.Deferred();return this.canRestore?this.API.getData().always(_.bind(function(data){data&&0!=data.length?(logger.log(data),this.data=_.isString(data)?JSON.parse(data):data):this.data={},deferred.resolve(this.data)},this)):(this.data={},deferred.resolve(this.data)),deferred.promise()},saveData:function(){if(this.canStore){var serializedData=JSON.stringify(this.data);this.lastSavedData&&serializedData===this.lastSavedData||(this.lastSavedData=serializedData,this.API.setData(serializedData,this.data))}},setData:function(name,data){_.isUndefined(this.data)||(this.data[name]=data,this.saveData())},getData:function(name){var deferred=$.Deferred();return this.data?deferred.resolve(_.isUndefined(name)?this.data:this.data[name]):this.loadData().done(function(data){var ret=_.isUndefined(name)?data:data[name];deferred.resolve(ret)}),deferred.promise()},isDataDirty:function(){return this.API.isDataDirty()},clearDataDirty:function(){this.API.clearDataDirty()},setDataDirty:function(){this.API.setDataDirty()},notify:function(interaction){_(this.API.notify).isFunction()&&this.API.notify(interaction)},setProgress:function(progress){if(!_(progress).isNumber()||progress<0||progress>1)throw new Error("progress parameter must be a number 0..1");_(this.API.setProgress).isFunction()&&this.API.setProgress(progress)},close:function(sync){var promise;return this.closed||(this.closed=!0,promise=this.API.close(sync)),$.when(promise)},clear:function(){this.canStore&&(this.data={},this.API.clear())},submit:function(score,duration){var promise;return this.canStore&&(promise=this.API.submit(score,duration)),$.when(promise)},getUserRole:function(){return this.API.getUserRole()},getLockedInteractions:function(){return this.API.getLockedInteractions()},getLOFontSize:function(){return this.API.getLOFontSize()},getRestrictedPages:function(){return this.API.getRestrictedPages()},isTTSDisabled:function(){return this.API.isTTSDisabled()},getUserPollAnswers:function(screenNo,callback){this.API.getUserPollAnswers(screenNo,callback)},setUserPollAnswers:function(screenNo,answers,labels){this.API.setUserPollAnswers(screenNo,answers,labels)},getPollResults:function(screenNo,callback){this.API.getPollResults(screenNo,callback)},getEbookResourcesUrl:function(page,offset,index){return this.API.getEbookResourcesUrl(page,offset,index)},isEbookShowResourcesEnabled:function(){return this.API.isEbookShowResourcesEnabled()},getInteractionIdFor:function(screenName){return this.API.getInteractionIdFor(screenName)},getTeacherAnnotations:function(interactionID,callback){this.API.getTeacherAnnotations(interactionID,callback)}},Obj.extend("a5.service.lms.APIFacade"),a5.service.lms.BaseAPI={init:function(){},start:function(){this.delegateEvents()},delegateEvents:function(){var events=_.result(this,"playerEvents");events&&_.each(events,function(v,k){var method=_.isFunction(v)?v:this[v];method&&a5.eventBus.bind(k,_.bind(method,this))},this)},getUserRole:function(){return"Student"},hasAPI:function(){return!1},getEbookResourcesUrl:function(page,offset,index){var match=/courses\/(\d+)/.exec(window.location.href);if(match)var course=match[1];if(match=/(\d+).html/.exec(window.location.href))var digital_book_id=match[1];var realPage=page-offset+1,pageNumber=realPage<0?0:realPage;return location.protocol+"//"+window.location.hostname+"/app/courses/"+course+"/digital_books/"+digital_book_id+"/page/"+pageNumber},isEbookShowResourcesEnabled:function(){var match=/courses\/(\d+)/.exec(window.location.href);if(match){var course=match[1];return $.get(window.location.protocol+"//"+window.location.hostname+"/api/courses/"+course+"/resources_panel_status")}return!1},setScore:function(score,maxScore){},setDetailedScore:function(interactionScores){},setBookmark:function(page){},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(null),deferred.promise()},setData:function(serializedData,data){},getData:function(){var deferred=$.Deferred();return deferred.resolve(""),deferred.promise()},isDataDirty:function(){return!1},clearDataDirty:function(){},setDataDirty:function(){},notify:function(interaction){},close:function(sync){},clear:function(){},submit:function(score,duration){return!1},getLockedInteractions:function(){return[]},getLOFontSize:function(){return"small"},getRestrictedPages:function(){return[]},isTTSDisabled:function(){return!1},getUserPollAnswers:function(screenNo,callback){callback(null)},setUserPollAnswers:function(screenNo,answers,labels){},getPollResults:function(screenNo,callback){callback({})},getInteractionIdFor:function(screenName){return"interaction_"+screenName.hashCode()},getTeacherAnnotations:function(interactionID,callback){callback([])}},Obj.extend("a5.service.lms.BaseAPI"),a5.service.lms.DummyAPI={init:function(){},hasAPI:function(){return!0},setScore:function(score,maxScore){},setDetailedScore:function(interactionScores){},setBookmark:function(page){},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(null),deferred.promise()},setData:function(serializedData,data){},getData:function(){var deferred=$.Deferred();return deferred.resolve(""),deferred.promise()},notify:function(interaction){},close:function(){},clear:function(){}},a5.service.lms.BaseAPI.extend("a5.service.lms.DummyAPI"),a5.service.lms.ScormAPI={SUSPEND_DATA_LIMIT:4096,init:function(){this.findAPI()},findAPI:function(){this.API=null;for(var current=window;"function"!=typeof current.GetStudentID&&current.parent!=current;)current=current.parent;"function"==typeof current.GetStudentID&&(this.API=current),this.sizeExceeded=!1},hasAPI:function(){return!!this.API},setScore:function(score,maxScore){this.API.SetScore(score,maxScore,0),this.API.SCORM_SetCompleted(),this.API.SetReachedEnd()},setDetailedScore:function(interactionScores){},setBookmark:function(page){this.API.SetBookmark(page)},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(this.API.GetBookmark()),deferred.promise()},setData:function(serializedData,data){serializedData.length>this.SUSPEND_DATA_LIMIT?this.sizeExceeded||(this.sizeExceeded=!0,alert("User input too big to store. Please remove some text.")):this.sizeExceeded&&(this.sizeExceeded=!1,alert("User input small enough to store again.")),this.API.SetDataChunk(serializedData)},getData:function(){var deferred=$.Deferred();return deferred.resolve(this.API.GetDataChunk()),deferred.promise()},notify:function(interaction){},close:function(){this.API.Unload()},clear:function(){}},a5.service.lms.BaseAPI.extend("a5.service.lms.ScormAPI"),a5.service.lms.Scorm2004API={SUSPEND_DATA_LIMIT:64e3,init:function(){this.findAPI()},findAPI:function(){this.API=null;for(var current=window;"function"!=typeof current.GetStudentID&&current.parent!=current;)current=current.parent;"function"==typeof current.GetStudentID&&(this.API=new a5.service.lms.Scorm2004Adapter(current)),this.sizeExceeded=!1},hasAPI:function(){return!!this.API},setScore:function(score,maxScore){a5.mainBuilder.options(!0).sCORM2004AbsoluteValuesIsOn()?this.API.setScore(score,maxScore):this.API.setScore(score/maxScore*100,100),this.API.setReachedEnd()},setDetailedScore:function(interactionScores){},setBookmark:function(page){this.API.setBookmark(page)},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(this.API.getBookmark()),deferred.promise()},setData:function(serializedData,data){serializedData.length>this.SUSPEND_DATA_LIMIT?this.sizeExceeded||(this.sizeExceeded=!0,alert("User input too big to store. Please remove some text.")):this.sizeExceeded&&(this.sizeExceeded=!1,alert("User input small enough to store again.")),this.API.setDataChunk(serializedData)},getData:function(){var deferred=$.Deferred();return deferred.resolve(this.API.getDataChunk()),deferred.promise()},notify:function(interaction){var klassName=this._extractNotifierKlassNameFromInteraction(interaction);new(a5.service.lms[klassName]||a5.service.lms.Scorm2004Null)(this.API).notify(interaction)},setProgress:function(progress){this.API.setProgress(progress)},close:function(){this.API.unload()},clear:function(){},_extractNotifierKlassNameFromInteraction:function(interaction){var interactionCamelizedName=_.str.camelize(_.str.underscored(interaction.cssIdentifier())),interactionClassName=interactionCamelizedName.substr(0,2).toUpperCase()+interactionCamelizedName.substr(2);return _.str.sprintf("Scorm2004%s",interactionClassName)}},a5.service.lms.BaseAPI.extend("a5.service.lms.Scorm2004API"),a5.service.lms.TinCanAPI={VERBS:{lo:["started","terminated","scored","attempted"],interaction:["launched","closed","resumed","suspended","mastered","answered","skipped","acknowledged"]},playerEvents:{"interaction:start":"onInteractionStart","interaction:end":"onInteractionEnd","interaction:reset":"onInteractionReset","interaction:check_answer":"onInteractionCheckAnswer","interaction:see_answer_before_interaction":"onInteractionSeeAnswerBeforeInteraction","interaction:try_again":"onInteractionTryAgain","lo:total_score":"onLOTotalScore","lo:start":"onLOStart","lo:end":"onLOEnd","lo:prev":"onLOPrevious","lo:next":"onLONext","lo:save":"onLOSave","book:show_restricted_page":"onShowRestrictedPage","book:open_external_hotspot":"onOpenExternalHotspot","book:open_structure_hotspot":"onOpenStructureHotspot"},init:function(engineAPI){this.dataDirty=!1,this.launcherAPI=this._findLauncherAPI(),this.launcherAPI&&this.launcherAPI.setEngine&&this.launcherAPI.setEngine(engineAPI),this.options=_.extend({canStore:!A5.LMS_NO_STORE,canRestore:!A5.LMS_NO_RESTORE,actor:A5.LRS_ACTOR,endpoint:A5.LRS_ENDPOINT,auth:A5.LRS_AUTH,activity_id:A5.LRS_ACTIVITY_ID,registration:A5.LRS_REGISTRATION,callbacks:this.launcherAPI},this._readNonStandardParamsFromURL(),this._readParamsFromURL(),this._readCustomParamsFromURL()),"function"==typeof window.TinCan&&(this.API=new a5.service.lms.TinCanAdapter(this.options))},_readParamsFromURL:function(){var params=a5.service.lms.TinCanUtils.getUrlParamObject(),ret={};return params.actor&&(ret.actor=JSON.parse(decodeURIComponent(params.actor))),params.endpoint&&(ret.endpoint=decodeURIComponent(params.endpoint)),params.auth&&(ret.auth=decodeURIComponent(params.auth)),params.activity_id&&(ret.activity_id=decodeURIComponent(params.activity_id)),params.registration&&(ret.registration=decodeURIComponent(params.registration)),ret},_readCustomParamsFromURL:function(){var params=a5.service.lms.TinCanUtils.getUrlParamObject(),ret={};if(params.context&&(ret.context=JSON.parse(decodeURIComponent(params.context))),params.prefix&&(ret.prefix=decodeURIComponent(params.prefix)),params.LOCloseRedirect&&(ret.on_close_redirect_url=decodeURIComponent(params.LOCloseRedirect)),params.LOFinishRedirect&&(ret.on_finish_redirect_url=decodeURIComponent(params.LOFinishRedirect)),params.ErrorRedirect&&(ret.on_error_redirect_url=decodeURIComponent(params.ErrorRedirect)),params.TimeoutRedirect&&(ret.on_timeout_redirect_url=decodeURIComponent(params.TimeoutRedirect)),ret.filter=this.VERBS.lo.concat(this.VERBS.interaction),params.statements){var filter=decodeURIComponent(params.statements);ret.filter="lo-level"===filter?this.VERBS.lo:filter.split(",")}return ret},_readNonStandardParamsFromURL:function(){var params=a5.service.lms.TinCanUtils.getUrlParamObject(),ret={};if(params.agents){var agents=JSON.parse(decodeURIComponent(params.agents));ret.actor=agents.user}if(params.stores){var stores=JSON.parse(decodeURIComponent(params.stores));ret.endpoint=stores[0].endpoint,ret.auth=stores[0].auth}return params.activityID&&(ret.activity_id=decodeURIComponent(params.activityID)),params.reg&&(ret.registration=decodeURIComponent(params.reg)),ret},_findLauncherAPI:function(){var api=null;try{for(var current=window;"object"!=typeof current.authorAPI&&current.parent!==current;)current=current.parent;"object"==typeof current.authorAPI&&(api=current.authorAPI)}catch(e){logger.warn(e)}return api},hasAPI:function(){return!!this.API},onLOStart:function(e){this.API.onLOStart(e.uid,e.id,e.lo)},onLOEnd:function(e){this.API.onLOEnd(e.lo)},onLONext:function(){this.API.onLONext(),this.options.callbacks&&this.options.callbacks.onLONext&&this.options.callbacks.onLONext()},onLOPrevious:function(){this.API.onLOPrevious(),this.options.callbacks&&this.options.callbacks.onLOPrevious&&this.options.callbacks.onLOPrevious()},onInteractionStart:function(e){this.API.onInteractionStart(e.id,e.interaction)},onInteractionEnd:function(){this.API.onInteractionEnd()},onInteractionCheckAnswer:function(){this.API.onInteractionCheckAnswer()},onInteractionSeeAnswerBeforeInteraction:function(){this.API.onInteractionSeeAnswerBeforeInteraction()},onInteractionReset:function(){this.API.onInteractionReset()},onInteractionTryAgain:function(){this.API.onInteractionTryAgain()},onLOTotalScore:function(e){this.API.onLOTotalScore(e.score)},setScore:function(score,maxScore){},setDetailedScore:function(interactionScores){},setBookmark:function(page){this.API.setBookmark(page)},getBookmark:function(){return this.API.getBookmark()},setData:function(serializedData,data){this.API.setData(serializedData,data).done(function(){this.dataDirty=!1}.bind(this))},getData:function(){return this.API.getData()},isDataDirty:function(){return this.dataDirty},clearDataDirty:function(){this.dataDirty=!1},setDataDirty:function(){this.dataDirty=!0},notify:function(interaction){},setProgress:function(progress){},close:function(sync){return this.API.onLOClose(sync).then(function(){this.options.on_close_redirect_url?(a5.dp.config.allowLOSelfClosing=!1,a5.service.lms.TinCanUtils.redirectTo(this.options.on_close_redirect_url)):this.options.callbacks&&this.options.callbacks.onLOClose&&this.options.callbacks.onLOClose()}.bind(this))},clear:function(){},submit:function(score,duration){return this.API.onLOSubmit(score,duration).then(function(){var finished=!1;return this.options.on_finish_redirect_url?(finished=!0,a5.dp.config.allowLOSelfClosing=!1,a5.service.lms.TinCanUtils.redirectTo(this.options.on_finish_redirect_url)):this.options.callbacks&&this.options.callbacks.onLOFinish&&(finished=this.options.callbacks.onLOFinish()),finished}.bind(this))},getUserRole:function(){return _.result(this.launcherAPI,"userRole","Student")},getLockedInteractions:function(){return _.result(this.launcherAPI,"disabledScreenList",[])},getLOFontSize:function(){return _.result(this.launcherAPI,"fontSize","small")},getRestrictedPages:function(){return _.result(this.launcherAPI,"restrictedPageList",[])},isTTSDisabled:function(){return _.result(this.launcherAPI,"isTTSDisabled",!1)},onShowRestrictedPage:function(context){this.launcherAPI&&this.launcherAPI.onShowRestrictedPage&&this.launcherAPI.onShowRestrictedPage(context)},onOpenExternalHotspot:function(ref){this.launcherAPI&&this.launcherAPI.onOpenExternalHotspot&&this.launcherAPI.onOpenExternalHotspot(ref)},onOpenStructureHotspot:function(ref){this.launcherAPI&&this.launcherAPI.onOpenStructureHotspot&&this.launcherAPI.onOpenStructureHotspot(ref)},getEbookResourcesUrl:function(page,offset,index){return this.launcherAPI&&this.launcherAPI.resourcesUrl&&this.launcherAPI.resourcesUrl({page:page,offset:offset,index:index})||this._super(page,offset,index)},getUserPollAnswers:function(screenNo,callback){this.launcherAPI&&this.launcherAPI.getUserPollAnswers?this.launcherAPI.getUserPollAnswers(screenNo,callback):callback(null)},setUserPollAnswers:function(screenNo,answers,labels){this.launcherAPI&&this.launcherAPI.setUserPollAnswers&&this.launcherAPI.setUserPollAnswers(screenNo,answers,labels)},getPollResults:function(screenNo,callback){this.launcherAPI&&this.launcherAPI.getPollResults?this.launcherAPI.getPollResults(screenNo,callback):callback({})},isEbookShowResourcesEnabled:function(){return this.launcherAPI&&this.launcherAPI.isResourcesPanelEnabled?this.launcherAPI.isResourcesPanelEnabled():this._super()},getTeacherAnnotations:function(interactionID,callback){this.launcherAPI&&this.launcherAPI.getTeacherAnnotations?this.launcherAPI.getTeacherAnnotations(interactionID,callback):callback([])},onLOSave:function(){this.launcherAPI&&this.launcherAPI.onLOSave&&this.launcherAPI.onLOSave()}},a5.service.lms.BaseAPI.extend("a5.service.lms.TinCanAPI"),a5.service.lms.AuthorAPI={playerEvents:{"book:show_restricted_page":"onShowRestrictedPage","book:open_external_hotspot":"onOpenExternalHotspot","book:open_structure_hotspot":"onOpenStructureHotspot","lo:save":"onLOSave"},init:function(engineAPI){this.API=this.findAPI(),this.API&&this.API.setEngine&&this.API.setEngine(engineAPI)},findAPI:function(){for(var API=null,current=window;"object"!=typeof current.authorAPI&&current.parent!=current;)current=current.parent;return"object"==typeof current.authorAPI&&(API=current.authorAPI),API},hasAPI:function(){return!!this.API},setScore:function(score,maxScore){this.API.set("score",[score,maxScore])},setDetailedScore:function(interactionScores){this.API.set("detailedScore",interactionScores)},setBookmark:function(page){this.API.set("bookmark",page)},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(this.API.get("bookmark")),deferred.promise()},setAnnotations:function(serializedAnnotations){this.lastSavedAnnotations&&serializedAnnotations===this.lastSavedAnnotations||(this.lastSavedAnnotations=serializedAnnotations,this.API.set("annotations",serializedAnnotations))},getAnnotations:function(){var annotations=this.API.get("annotations");return annotations=_.isString(annotations)?JSON.parse(annotations):annotations},setData:function(serializedData,data){data.annotations&&(this.setAnnotations(JSON.stringify(data.annotations)),serializedData=JSON.stringify(_.omit(data,"annotations"))),this.lastSavedData&&serializedData===this.lastSavedData||(this.lastSavedData=serializedData,this.API.set("data",serializedData))},getData:function(){var deferred=$.Deferred(),data=this.API.get("data");return data&&(data=_.isString(data)?JSON.parse(data):data,data.annotations=this.getAnnotations()),deferred.resolve(data),deferred.promise()},isDataDirty:function(){return this.API.get("data_dirty")},clearDataDirty:function(){this.API.set("data_dirty",!1)},setDataDirty:function(){this.API.set("data_dirty",!0)},notify:function(interaction){},close:function(sync){this.API.finish(sync)},clear:function(){},getUserRole:function(){return _.result(this.API,"userRole","Student")},getLockedInteractions:function(){return _.result(this.API,"disabledScreenList",[])},getLOFontSize:function(){return _.result(this.API,"fontSize","small")},getRestrictedPages:function(){return _.result(this.API,"restrictedPageList",[])},isTTSDisabled:function(){return _.result(this.API,"isTTSDisabled",!1)},onShowRestrictedPage:function(context){this.API&&this.API.onShowRestrictedPage&&this.API.onShowRestrictedPage(context)},onOpenExternalHotspot:function(ref){this.API&&this.API.onOpenExternalHotspot&&this.API.onOpenExternalHotspot(ref)},onOpenStructureHotspot:function(ref){this.API&&this.API.onOpenStructureHotspot&&this.API.onOpenStructureHotspot(ref)},getInteractionIdFor:function(screenName){return this.API&&this.API.getScreenIdFor&&this.API.getScreenIdFor(screenName)||this._super(screenName)},getUserPollAnswers:function(screenNo,callback){this.API&&this.API.getUserPollAnswers?this.API.getUserPollAnswers(screenNo,callback):callback(null)},getEbookResourcesUrl:function(page,offset,index){return this.API&&this.API.resourcesUrl&&this.API.resourcesUrl({page:page,offset:offset,index:index})||this._super(page,offset,index)},isEbookShowResourcesEnabled:function(){return this.API&&this.API.isResourcesPanelEnabled?this.API.isResourcesPanelEnabled():this._super()},setUserPollAnswers:function(screenNo,answers,labels){this.API&&this.API.setUserPollAnswers&&this.API.setUserPollAnswers(screenNo,answers,labels)},getPollResults:function(screenNo,callback){this.API&&this.API.getPollResults?this.API.getPollResults(screenNo,callback):callback({})},getTeacherAnnotations:function(interactionID,callback){this.API&&this.API.getTeacherAnnotations?this.API.getTeacherAnnotations(interactionID,callback):callback([])},onLOSave:function(){this.API&&this.API.onLOSave&&this.API.onLOSave()}},a5.service.lms.BaseAPI.extend("a5.service.lms.AuthorAPI"),a5.service.lms.LocalStorageAPI={init:function(){this.findAPI()},findAPI:function(){this.API=null;try{"undefined"!=typeof Storage&&(this.API=localStorage)}catch(e){logger.warn(e)}},hasAPI:function(){return!!this.API},id:function(param){return"lo"+a5.mainBuilder.xmlList.join("").hashCode()+"_"+LOInfo.ID+"_"+param},setScore:function(score,maxScore){this.API[this.id("a5_lms_score")]=score,this.API[this.id("a5_lms_maxScore")]=maxScore},setDetailedScore:function(interactionScores){},setBookmark:function(page){this.API[this.id("a5_lms_bookmark")]=page},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(this.API[this.id("a5_lms_bookmark")]),deferred.promise()},setData:function(serializedData,data){this.API[this.id("a5_lms_data")]=serializedData},getData:function(){var deferred=$.Deferred();return deferred.resolve(this.API[this.id("a5_lms_data")]),deferred.promise()},notify:function(interaction){},close:function(){},clear:function(){this.API.removeItem(this.id("a5_lms_data"))}},a5.service.lms.BaseAPI.extend("a5.service.lms.LocalStorageAPI"),a5.service.lms.ConsoleAPI={playerEvents:{"interaction:reset":"onInteractionReset","interaction:ready":"onInteractionReady","lo:ready":"onLOReady","lo:start":"onLOStart","lo:end":"onLOEnd","lo:next":"onLONext","lo:prev":"onLOPrevious","book:show_restricted_page":"onShowRestrictedPage","book:open_external_hotspot":"onOpenExternalHotspot","book:open_structure_hotspot":"onOpenStructureHotspot"},init:function(){this.findAPI()},findAPI:function(){this.API=null,window.console&&(this.API=console)},hasAPI:function(){return!!this.API},setScore:function(score,maxScore){this.API.info("API","setScore",score+"/"+maxScore)},setDetailedScore:function(interactionScores){this.API.info("API","setDetailedScore",interactionScores)},setBookmark:function(page){this.API.info("API","setBookmark",page)},getBookmark:function(){var deferred=$.Deferred();return this.API.info("API","getBookmark"),deferred.resolve(null),deferred.promise()},setData:function(serializedData,data){this.API.info("API","setData",serializedData)},getData:function(){var deferred=$.Deferred();return this.API.info("API","getData"),deferred.resolve(""),deferred.promise()},notify:function(interaction){this.API.info("API","notify",interaction.getID())},setProgress:function(progress){this.API.info("API","progress",100*progress+"%")},close:function(){this.API.info("API","close")},clear:function(){this.API.info("API","clear")},onInteractionReset:function(interaction){this.API.info("EVENT","interaction:reset")},onInteractionReady:function(){this.API.info("EVENT","interaction:ready")},onLOStart:function(){this.API.info("EVENT","lo:start")},onLOEnd:function(){this.API.info("EVENT","lo:end")},onLONext:function(){this.API.info("EVENT","lo:next")},onLOPrevious:function(){this.API.info("EVENT","lo:prev")},onLOReady:function(){this.API.info("EVENT","lo:ready")},onShowRestrictedPage:function(context){
this.API.info("EVENT","book:show_restricted_page")},onOpenExternalHotspot:function(ref){this.API.info("EVENT","book:open_external_hotspot",ref)},onOpenStructureHotspot:function(ref){this.API.info("EVENT","book:open_structure_hotspot",ref)}},a5.service.lms.BaseAPI.extend("a5.service.lms.ConsoleAPI"),a5.service.lms.ChannelAPI={playerEvents:{"lo:start":"onLOStart","lo:end":"onLOEnd","lo:controls:change":"onLOControlsChange","lo:size":"onLOSize","lo:ready":"onLOReady","lo:total_score":"onLOTotalScore","interaction:start":"onInteractionStart"},init:function(engine){this.API=engine.channel(),this.engine=engine,this.state=engine.config.get("lms_state")||{},_.bindAll(this,"onReceiveMessageFromContainer")},hasAPI:function(){return!!this.API},start:function(){this.API.bind("receiveMessageFromContainer",this.onReceiveMessageFromContainer),this.delegateEvents()},sendMessageToContainer:function(params){this.API.notify({method:"sendMessageToContainer",params:params})},sendStatements:function(statements){_.isArray(statements)||(statements=[statements]),this.sendMessageToContainer({type:"newStatements",data:statements})},getState:function(){return this.state},setState:function(state){var newState=_.extend(this.getState(),state);this.sendMessageToContainer({type:"newState",data:newState})},getData:function(){return $.when(this.getState().suspend_data)},getBookmark:function(){return $.when(this.getState().bookmark)},setData:function(serializedData,data){this.setState({suspend_data:data})},setBookmark:function(page){this.setState({bookmark:page})},onReceiveMessageFromContainer:function(trans,params){trans.delayReturn(!0);var methodFn=function(method){var fn=_.noop;if(this.engine.isLO()){var lo=this.engine.getLO();lo[method]&&(fn=lo[method].bind(lo,params.args))}return fn}.call(this,params.type);$.when().then(methodFn).then(trans.complete,trans.error)},onLOStart:function(data){var statement=this._loStartedStatement(data.uid);this.sendStatements(statement)},onLOEnd:function(){this.sendMessageToContainer({type:"terminated"})},onLOSize:function(size){this.sendMessageToContainer({type:"size",data:{size:size}})},onLOControlsChange:function(state){var actionsMap={check:{control:"checkAnswers"},forward:{control:"goNext"},previous:{control:"goPrev"},sendscores:{control:"sendScores"},exercises:{control:"reviewAnswers"},results:{control:"showResults"}},action=actionsMap[state.action];action&&this.sendMessageToContainer({type:"controlsChange",data:{control:action.control,meta:{buttonText:state.label,type:"button"},visible:state.visible,active:state.active}})},onLOReady:function(){this.sendMessageToContainer({type:"ready"})},onLOTotalScore:function(data){var statement=this._loScoredStatement(data.score);this.sendStatements(statement)},onInteractionStart:function(data){var screen=data.interaction.visibleIndex+(a5.mainBuilder.hasIntroScreen()?1:0);this.firstScreenReadySent||(this.firstScreenReadySent=!0,this.sendMessageToContainer({type:"firstScreenReady",data:{screen:screen}}));var statement=this._interactionLaunchedStatement(screen);this.sendStatements(statement)},_loStartedStatement:function(){return{verb:{id:"http://activitystrea.ms/schema/1.0/start",display:{und:"started"}},object:{id:A5.LRS_ACTIVITY_ID}}},_interactionLaunchedStatement:function(screen){return{verb:{id:"http://adlnet.gov/expapi/verbs/launched",display:{und:"launched"}},object:{id:A5.LRS_ACTIVITY_ID+"/"+screen}}},_loScoredStatement:function(scores){return{verb:{id:"http://adlnet.gov/expapi/verbs/scored",display:{und:"scored"}},object:{id:A5.LRS_ACTIVITY_ID},result:{score:{scaled:scores.correct()/scores.total(),max:scores.total(),min:0,raw:scores.correct()}}}}},a5.service.lms.BaseAPI.extend("a5.service.lms.ChannelAPI"),a5.service.lms.MultiAPI={init:function(APIs){this.APIs=APIs},start:function(){return $.when.apply($,_.invoke(this.APIs,"start"))},hasAPI:function(){return!0},setScore:function(score,maxScore){_.each(this.APIs,function(API){API.setScore(score,maxScore)})},setDetailedScore:function(interactionScores){_.each(this.APIs,function(API){API.setDetailedScore(interactionScores)})},setBookmark:function(page){_.each(this.APIs,function(API){API.setBookmark(page)})},getBookmark:function(){var ret=_.first(this.APIs).getBookmark();return _.each(_.rest(this.APIs),function(API){API.getBookmark()}),ret},setData:function(serializedData,data){_.each(this.APIs,function(API){API.setData(serializedData,data)})},getData:function(){var ret=_.first(this.APIs).getData();return _.each(_.rest(this.APIs),function(API){API.getData()}),ret},isDataDirty:function(){return _.first(this.APIs).isDataDirty()},clearDataDirty:function(){_.each(this.APIs,function(API){API.clearDataDirty()})},setDataDirty:function(){_.each(this.APIs,function(API){API.setDataDirty()})},notify:function(interaction){_.each(this.APIs,function(API){API.notify(interaction)})},setProgress:function(progress){_.each(this.APIs,function(API){_.isFunction(API.setProgress)&&API.setProgress(progress)})},close:function(sync){var ret=_.first(this.APIs).close(sync);return _.each(this.APIs,function(API){API.close(sync)}),ret},clear:function(){_.each(this.APIs,function(API){API.clear()})},submit:function(score,duration){var ret=_.first(this.APIs).submit(score,duration);return _.each(_.rest(this.APIs),function(API){API.submit(score,duration)}),ret},getUserRole:function(){var ret=_.first(this.APIs).getUserRole();return _.each(_.rest(this.APIs),function(API){API.getUserRole()}),ret},getLockedInteractions:function(){var ret=_.first(this.APIs).getLockedInteractions();return _.each(_.rest(this.APIs),function(API){API.getLockedInteractions()}),ret},getLOFontSize:function(){var ret=_.first(this.APIs).getLOFontSize();return _.each(_.rest(this.APIs),function(API){API.getLOFontSize()}),ret},getRestrictedPages:function(){var ret=_.first(this.APIs).getRestrictedPages();return _.each(_.rest(this.APIs),function(API){API.getRestrictedPages()}),ret},isTTSDisabled:function(){var ret=_.first(this.APIs).isTTSDisabled();return _.each(_.rest(this.APIs),function(API){API.isTTSDisabled()}),ret},getUserPollAnswers:function(screenNo,callback){_.each(this.APIs,function(API){API.getUserPollAnswers(screenNo,callback)})},getEbookResourcesUrl:function(page,offset,index){var ret=_.first(this.APIs).getEbookResourcesUrl(page,offset,index);return _.each(this.APIs,function(API){API.getEbookResourcesUrl(page,offset,index)}),ret},isEbookShowResourcesEnabled:function(){return _.first(this.APIs).isEbookShowResourcesEnabled()},setUserPollAnswers:function(screenNo,answers,labels){_.each(this.APIs,function(API){API.setUserPollAnswers(screenNo,answers,labels)})},getPollResults:function(screenNo,callback){_.each(this.APIs,function(API){API.getPollResults(screenNo,callback)})},getInteractionIdFor:function(screenName){var ret=_.first(this.APIs).getInteractionIdFor(screenName);return _.each(_.rest(this.APIs),function(API){API.getInteractionIdFor(screenName)}),ret},getTeacherAnnotations:function(interactionID,callback){_.each(this.APIs,function(API){API.getTeacherAnnotations(interactionID,callback)})}},Obj.extend("a5.service.lms.MultiAPI"),a5.service.lms.Scorm2004Adapter={init:function(driver){this.driver=driver},setBookmark:function(page){this.driver.SetBookmark(page)},getBookmark:function(){return this.driver.GetBookmark()},setScore:function(score,maxScore){this.driver.SetPointBasedScore(score,maxScore,0)},setCompleted:function(){this.driver.SetCompleted()},setReachedEnd:function(){this.driver.SetReachedEnd()},setProgress:function(progress){this.driver.SCORM2004_CallSetValue("cmi.progress_measure",progress)},setDataChunk:function(data){this.driver.SetDataChunk(data)},getDataChunk:function(){return this.driver.GetDataChunk()},commit:function(){this.driver.CommitData()},finish:function(){this.driver.Finish()},unload:function(){this.driver.Unload()},suspend:function(){this.driver.Suspend()},recordMultipleChoiceInteraction:function(id,isCorrect,currentResults,correctResults,type){this._recordInteraction(id,isCorrect,this._convertToCommaSeparated(currentResults),this._convertToCommaSeparated(correctResults),type)},recordFillInInteraction:function(id,isCorrect,currentResults,correctResults,type){this._recordInteraction(id,isCorrect,this._convertToCommaSeparated(currentResults),_(correctResults).map(this._convertToCommaSeparated),type)},recordMatchingInteraction:function(id,isCorrect,currentResults,correctResults,type){this._recordInteraction(id,isCorrect,this._convertToCommaSeparated(_(currentResults).map(this._convertToDotSeparated)),_(correctResults).map(function(results){return this._convertToCommaSeparated(_(results).map(this._convertToDotSeparated))},this),type)},_recordInteraction:function(id,isCorrect,currentResults,correctResults,type){var count;this.driver.ClearErrorInfo(),this._checkLoaded()&&(count=this.driver.SCORM2004_CallGetValue("cmi.interactions._count")||0,this._setInteractionId(count,id),this._setInteractionType(count,type),this._setInteractionLearnerResponse(count,currentResults),this._setInteractionResult(count,isCorrect),this._setInteractionCorrectResults(count,correctResults),this._setInteractionTimestamp(count))},_checkLoaded:function(){return!!this.driver.IsLoaded()||(this.driver.SetErrorInfo(this.driver.ERROR_NOT_LOADED,"Cannot make calls to the LMS before calling Start"),!1)},_setInteractionId:function(count,id){this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.id",count),id)},_setInteractionType:function(count,type){this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.type",count),type)},_setInteractionLearnerResponse:function(count,results){this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.learner_response",count),results)},_setInteractionResult:function(count,isCorrect){_(isCorrect).isBoolean()&&this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.result",count),this._extractInteractionResult(isCorrect))},_setInteractionCorrectResults:function(count,correctResults){correctResults=[].concat(correctResults),_(correctResults).each(function(correctResult,index){this._setInteractionCorrectResult(count,index,correctResult)},this)},_setInteractionCorrectResult:function(count,index,results){this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.correct_responses.%d.pattern",count,index),results)},_setInteractionTimestamp:function(count){this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.timestamp",count),this.driver.ConvertDateToIso8601TimeStamp(new Date))},_convertToCommaSeparated:function(list){return list.join("[,]")},_convertToDotSeparated:function(pair){return _.str.sprintf("%s.%s",pair.source,pair.target)},_extractInteractionResult:function(isCorrect){var resultStr="";return _(isCorrect).isBoolean()&&(resultStr=isCorrect?this.driver.SCORM2004_RESULT_CORRECT:this.driver.SCORM2004_RESULT_WRONG),resultStr}},Obj.extend("a5.service.lms.Scorm2004Adapter"),a5.service.lms.Scorm2004Base={init:function(adapter){this.adapter=adapter},notify:function(interaction){},eachModel:function(interaction,fn,scope){_(interaction.items.itemList).each(function(questionItem,index1){_(questionItem.itemList).each(function(model,index2){fn.call(scope||this,model,index1,index2)},this)},this)},createId:function(interaction,index1,index2){return _.str.sprintf("%s_%d_%d",interaction.getID(),index1,index2)}},Obj.extend("a5.service.lms.Scorm2004Base"),a5.service.lms.Scorm2004Null={notify:function(interaction){logger.warn(interaction.identifier+" not supported for SCORM 2004")}},a5.service.lms.Scorm2004Base.extend("a5.service.lms.Scorm2004Null"),a5.service.lms.Scorm2004ISCheckbox={type:"choice",notify:function(interaction){this.eachModel(interaction,function(model,index1,index2){this.adapter.recordMultipleChoiceInteraction(this.createId(interaction,index1,index2),this._isCorrect(model),this._getCurrentResultsFromModel(model),this._getCorrectResultsFromModel(model),this.type)})},_getCorrectResultsFromModel:function(model){return _(model.choices).reduce(function(result,choice){return!choice.prefill&&choice.correct&&result.push(choice.value),result},[])},_getCurrentResultsFromModel:function(model){return _(model.choices).reduce(function(result,choice){return!choice.prefill&&choice.selected&&result.push(choice.value),result},[])},_isCorrect:function(model){return model.isCorrect()}},a5.service.lms.Scorm2004Base.extend("a5.service.lms.Scorm2004ISCheckbox"),a5.service.lms.Scorm2004ICCrossword={ALIGNMENT:Object.freeze({vertical:"d",horizontal:"a"}),type:"other",notify:function(interaction){this.eachModel(interaction,function(model,index1,index2){this.adapter.recordMatchingInteraction(this.createId(interaction,index1,index2),this._isCorrect(model),this._getCurrentResultsFromModel(model),this._getCorrectResultsFromModel(model),this.type)})},_getCurrentResultsFromModel:function(model){return this._getResultsFromModel(model,function(word){return word.getUserWord()})},_getCorrectResultsFromModel:function(model){return[this._getResultsFromModel(model,function(word){return word.correctText()})]},_isCorrect:function(model){return _(model.words).chain().reject(function(word){return word.prefilled}).every(function(word){return word.isCorrect()}).value()},_getResultsFromModel:function(model,targetFn){return _(model.words).chain().map(function(word){return{source:this._extractSourceLabelFromWord(word),target:targetFn(word)}},this).reject(function(item){return _.isEmpty(item.target)}).value()},_extractSourceLabelFromWord:function(word){return _.str.sprintf("%s%s",word.label,this._mapAlignToIdentifier(word.align))},_mapAlignToIdentifier:function(alignment){return this.ALIGNMENT[alignment]}},a5.service.lms.Scorm2004Base.extend("a5.service.lms.Scorm2004ICCrossword"),a5.service.lms.Scorm2004ICTextGap={type:"fill-in",notify:function(interaction){interaction.options.gapsIsInvisible()||this.eachModel(interaction,function(model,index1,index2){model instanceof a5.models.interaction.ICTextGap&&this.adapter.recordFillInInteraction(this.createId(interaction,index1,index2),this._isCorrect(model),this._getCurrentResultsFromModel(model),this._getCorrectResultsFromModel(model),this.type)},this)},_getCurrentResultsFromModel:function(model){return model.prefill?[]:[model.value]},_getCorrectResultsFromModel:function(model){return model.prefill?[]:_(model.correct).map(function(result){return[result]})},_isCorrect:function(model){return model.isCorrect()}},a5.service.lms.Scorm2004Base.extend("a5.service.lms.Scorm2004ICTextGap"),a5.service.lms.Scorm2004PPPresent={},a5.service.lms.Scorm2004Base.extend("a5.service.lms.Scorm2004PPPresent"),function(lms,_){lms.TinCanUtils={sluggify:function(text){return text.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")},getUrlParamObject:function(){return a5.getURLParameterObject()},redirectTo:function(url){window.location.assign(url)}}}(a5.service.lms,_),function(lms,_){lms.SendQueue=function(){var _queue,_tincan,_callback,_send_timeout=null,SendQueue=function(tincan,callback){_queue=[],_tincan=tincan,_callback=callback||function(){},_perform_send(!0)},_perform_send=function(asynch){var ret;return _queue.length>0&&(ret=_tincan.sendStatements(_queue,asynch?_callback:null),_queue=[]),asynch&&(_send_timeout=setTimeout(_perform_send,500,!0)),ret},_last=function(asynch){var deferred=$.Deferred();return _queue.length>0&&(_tincan.sendStatements(_queue,asynch?function(result){deferred.resolve()}:null),_queue=[]),asynch||deferred.resolve(),deferred.promise()};return _(SendQueue.prototype).extend({add:function(statement,priority){_queue.push(statement)},finish:function(asynch,callback){return clearTimeout(_send_timeout),_last(asynch)},start:function(){_perform_send(!0)}}),SendQueue}(),lms.SendStateQueue=function(){var Queue=function(tincan){this.queue=[],this.tincan=tincan,this.current=null};Queue.prototype={add:function(key,val,cfg){this.queue.push({key:key,val:val,cfg:cfg}),this.current||this.send(!0)},hasPending:function(){return!!this.current},last:function(asynch){this.deferred=$.Deferred();var promise=this.deferred.promise();return this.send(asynch),promise},send:function(asynch){this.current=this.queue.shift();var _this=this;if(this.current){var ret=this.tincan.setState(this.current.key,this.current.val,_.extend(this.current.cfg,{contentType:"application/json",callback:asynch?function(err,result){400===err?_this.retryForLegacyContent(!0):_this.send(!0)}:null}));asynch||(400===ret.err?this.retryForLegacyContent(!1):this.send(!1))}else this.deferred&&(this.deferred.resolve(),this.deferred=null)},retryForLegacyContent:function(asynch){var _this=this;this.current&&(this.current.cfg=_.omit(this.current.cfg,"contentType"),this.tincan.setState(this.current.key,this.current.val,_.extend(this.current.cfg,{callback:asynch?function(err,result){_this.send(!0)}:null})),asynch||this.send(!1))}};var SendQueue=function(tincan){this.queues={},this.tincan=tincan,this.send_timeout=null,_.bindAll(this,"send")};return _(SendQueue.prototype).extend({add:function(key,data,cfg){(this.queues[key]||(this.queues[key]=new Queue(this.tincan))).add(key,data,cfg)},hasPending:function(){for(var key in this.queues)if(this.queues.hasOwnProperty(key)&&this.queues[key].hasPending())return!0;return!1},finish:function(asynch){return clearTimeout(this.send_timeout),this.last(asynch)},start:function(){this.send(!0)},last:function(asynch){var promises=[];for(var key in this.queues)this.queues.hasOwnProperty(key)&&this.queues[key].hasPending()&&promises.push(this.queues[key].last(asynch));return this.queues={},$.when.apply(this,promises)},send:function(asynch){for(var key in this.queues)this.queues.hasOwnProperty(key)&&this.queues[key].hasPending()&&this.queues[key].send(asynch);this.queues={},asynch&&(this.send_timeout=setTimeout(this.send,500,!0))}}),SendQueue}()}(a5.service.lms,_),function(lms,_){lms.TCInteractionCodes={SOLVING:1,ANSWERED:2,SUSPENDED:3},lms.StateMachine=function(){var _head=null,_tail=null,_tincan=null,_states=null,StateMachine=function(tincan){_states=[],_tincan=tincan};return _(StateMachine.prototype).extend({tincan:function(){return _tincan},push:function(new_state){_tail&&(_tail._next_state=new_state),new_state._prev_state=_tail,_tail=new_state,null===_head&&(_head=_tail),_.isFunction(new_state.onEnter)&&new_state.onEnter(this)},pop:function(){var old_state;return!!_tail&&(old_state=_tail,_tail=_tail._prev_state,_tail&&(_tail._next_state=null),_.isFunction(old_state.onFinish)&&old_state.onFinish(this),!0)},currentState:function(){return _tail},invoke:function(func_name){var args,cs=this.currentState();if(cs&&_.isFunction(cs[func_name]))return args=[].splice.call(arguments,1),args.unshift(this),cs[func_name].apply(cs,args)},propagate:function(ev,params){for(var state=this.currentState();state;){if(_.isFunction(state[ev])&&!1===state[ev](this,params))return;state=state._prev_state}},clear:function(){for(;this.pop(););}}),StateMachine}()}(a5.service.lms,_),function(lms,_){lms.InteractionPreviewState=function(){var InteractionPreviewState=function(interaction_id,interaction){this._interaction_id=interaction_id||0,this._interaction=interaction,this._timer=new a5.utils.Timer};return InteractionPreviewState.prototype.onEnter=function(sm){var tincan=sm.tincan();tincan.setInteractionId(this._interaction_id),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("launched"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}}}),this._interaction.isSolvable()&&(_.isUndefined(this._interaction.tc_code)||this._interaction.tc_code===lms.TCInteractionCodes.SOLVING?(this._interaction.tc_code=lms.TCInteractionCodes.SOLVING,sm.push(new lms.SolvingState(this._interaction))):this._interaction.tc_code===lms.TCInteractionCodes.SUSPENDED&&sm.push(new lms.ResumedState(this._interaction))),this._timer.stamp()},InteractionPreviewState.prototype.onFinish=function(sm){var tincan=sm.tincan();tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("closed"),object:tincan.activity(),result:tincan.result({duration:this._timer.getCMITimeString()})}),tincan.setInteractionId(null)},InteractionPreviewState.prototype.onInteractionEnd=function(sm){var tincan=sm.tincan();if(this._interaction.getItemsByClass("a5.models.RadioButton a5.models.Checkbox").length>0){this._interaction.tc_code=lms.TCInteractionCodes.ANSWERED,this._interaction.store(),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("acknowledged"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}}});lms.API.getData(this._interaction.getID()).done(_.bind(function(response_data){var resultData={response:JSON.stringify(response_data)};this._addPurposeMetadata(resultData),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("answered"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}},result:tincan.result(resultData)})},this))}sm.pop()},InteractionPreviewState.prototype.onLOSubmit=function(sm){this._interaction.tc_code!==lms.TCInteractionCodes.ANSWERED&&this.onInteractionCheckAnswer(sm),sm.pop()},InteractionPreviewState.prototype.onInteractionStart=function(sm){return!1},InteractionPreviewState.prototype.onInteractionTryAgain=function(sm){sm.push(new lms.SolvingState(this._interaction))},InteractionPreviewState.prototype.onInteractionSeeAnswerBeforeInteraction=function(sm){var tincan=sm.tincan(),scores=this._interaction.getScores();tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("skipped"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}},result:tincan.result({duration:this._timer.getCMITimeString(),score:{scaled:0,max:scores.total,min:0,raw:0}})}),this._interaction.tc_code=lms.TCInteractionCodes.ANSWERED},InteractionPreviewState.prototype.onInteractionReset=InteractionPreviewState.prototype.onInteractionTryAgain,InteractionPreviewState.prototype.onInteractionCheckAnswer=function(sm){var tincan=sm.tincan();if(!this._interaction.isSolvable()&&(this._interaction.tc_code=lms.TCInteractionCodes.ANSWERED,this._interaction.store(),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("acknowledged"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}}}),this._interaction.getItemsByClass("a5.models.RadioButton a5.models.Checkbox").length>0)){lms.API.getData(this._interaction.getID()).done(_.bind(function(response_data){var resultData={response:JSON.stringify(response_data)};this._addPurposeMetadata(resultData),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("answered"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}},result:tincan.result(resultData)})},this))}},InteractionPreviewState.prototype._addPurposeMetadata=function(resultData){var purpose=_.first(this._interaction.activityMetadata.getValues("Purpose"));(purpose=!_.isUndefined(purpose)&&(purpose.value||purpose.description))&&_.extend(resultData,{extensions:{"http://id.tincanapi.com/extension/purpose":purpose}})},InteractionPreviewState}()}(a5.service.lms,_),function(lms,_){lms.LOPreviewState=function(){var LOPreviewState=function(lo_id,lo){this.lo_id=lo_id,this.lo_title=lo.LOInfo.title,this.lo=lo,this.timer=lo.loTimer||new a5.utils.Timer};return LOPreviewState.prototype.onEnter=function(sm){var tincan=sm.tincan();tincan.setLearningObjectId(this.lo_id,this.lo_title),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("started"),object:tincan.activity("lo")}),this.timer.stamp()},LOPreviewState.prototype.getBookmark=function(sm){var tincan=sm.tincan(),deferred=$.Deferred(),stateCfg={agent:tincan.agent(),activity:tincan.activity("lo")};return tincan.registration()&&(stateCfg.registration=tincan.registration()),tincan.getState("bookmark",stateCfg).done(function(result){var bookmark;result&&"bookmark"===result.id&&(bookmark=result.contents&&result.contents.page),deferred.resolve(bookmark)}).fail(function(){deferred.resolve(null)}),deferred.promise()},LOPreviewState.prototype.setBookmark=function(sm,page){var tincan=sm.tincan(),stateCfg={agent:tincan.agent(),activity:tincan.activity("lo")};return tincan.registration()&&(stateCfg.registration=tincan.registration()),tincan.setState("bookmark",JSON.stringify({page:page}),stateCfg),!1},LOPreviewState.prototype.getData=function(sm){var tincan=sm.tincan(),deferred=$.Deferred(),stateCfg={agent:tincan.agent(),activity:tincan.activity("lo")};return tincan.registration()&&(stateCfg.registration=tincan.registration()),tincan.getState("suspend_data",stateCfg).done(function(result){var data;result&&"suspend_data"===result.id&&(data=result.contents),deferred.resolve(data)}).fail(function(){deferred.resolve(null)}),deferred.promise()},LOPreviewState.prototype.setData=function(sm,serializedData,data){var tincan=sm.tincan(),stateCfg={agent:tincan.agent(),activity:tincan.activity("lo")};return tincan.registration()&&(stateCfg.registration=tincan.registration()),tincan.setState("suspend_data",serializedData,stateCfg),!1},LOPreviewState.prototype.onLOSubmit=function(sm,params){var tincan=sm.tincan(),scores=params.score,duration=params.duration;return _.each(this.lo.intList,function(interaction,id){interaction.tc_code===lms.TCInteractionCodes.SUSPENDED&&(this.onInteractionStart(sm,{interaction:interaction,interaction_id:interaction.index}),sm.propagate("onInteractionCheckAnswer"),sm.propagate("onInteractionEnd"))},this),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("scored"),object:tincan.activity("lo"),result:tincan.result({score:{scaled:scores.correct()/scores.total(),max:scores.total(),min:0,raw:scores.correct()}})}),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("attempted"),object:tincan.activity("lo"),result:tincan.result({duration:this.timer.getCMITimeString(duration),score:{max:this.lo.maxAttempts,min:0,raw:this.lo.submitAttempts}})}),!1},LOPreviewState.prototype.onLOTotalScore=function(sm,params){var tincan=sm.tincan(),scores=params.total_score;tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("scored"),object:tincan.activity("lo"),result:tincan.result({score:{scaled:scores.correct()/scores.total(),max:scores.total(),min:0,raw:scores.correct()}})})},LOPreviewState.prototype.onFinish=function(sm){var tincan=sm.tincan();tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("terminated"),object:tincan.activity("lo"),result:tincan.result({duration:this.timer.getCMITimeString(this.lo.sessionLODuration)})}),tincan.setLearningObjectId(null)},LOPreviewState.prototype.onInteractionStart=function(sm,params){sm.push(new lms.InteractionPreviewState(params.interaction_id||0,params.interaction))},LOPreviewState}()}(a5.service.lms,_),function(lms,_){lms.SolvingState=function(){var SolvingState=function(interaction){this._interaction=interaction,this.timer=new a5.utils.Timer};return SolvingState.prototype.onInteractionReset=function(sm){return!1},SolvingState.prototype.onInteractionTryAgain=function(sm){return!1},SolvingState.prototype.onEnter=function(sm){this._interaction.tc_code=lms.TCInteractionCodes.SOLVING,this.timer.stamp()},SolvingState.prototype.onInteractionCheckAnswer=function(sm){this._interaction.tc_code=lms.TCInteractionCodes.ANSWERED,this._interaction.store();var tincan=sm.tincan(),scores=this._interaction.getResults();lms.API.getData(this._interaction.getID()).done(_.bind(function(response_data){tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("answered"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}},result:tincan.result({response:JSON.stringify(response_data),duration:this.timer.getCMITimeString(),score:{scaled:scores.correct()/scores.total(),max:scores.total(),min:0,raw:scores.correct()}})});var competencies=this._interaction.activityMetadata.getValues("Competencies");competencies=_(competencies).map(function(c){return c.value||c.description}),competencies.length>0&&tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("mastered"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}},result:tincan.result({response:competencies.join(",")})})},this)),sm.pop()},SolvingState.prototype.onInteractionEnd=function(sm){var tincan=sm.tincan();this._interaction.tc_code=lms.TCInteractionCodes.SUSPENDED,this._interaction.store(),lms.API.getData(this._interaction.getID()).done(_.bind(function(response_data){response_data.status="input",tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("suspended"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}},result:tincan.result({response:JSON.stringify(response_data),duration:this.timer.getCMITimeString()})})},this)),sm.pop()},SolvingState.prototype.onLOClose=SolvingState.prototype.onInteractionEnd,SolvingState.prototype.onLOSubmit=function(sm){this._interaction.tc_code!==lms.TCInteractionCodes.ANSWERED?this.onInteractionCheckAnswer(sm):sm.pop()},SolvingState.prototype.onLOTotalScore=SolvingState.prototype.onInteractionCheckAnswer,SolvingState.prototype.onInteractionSeeAnswerBeforeInteraction=function(sm){sm.pop()},SolvingState}()}(a5.service.lms,_),function(lms,_){lms.ResumedState=function(){var ResumedState=function(interaction){this._interaction=interaction,this.timer=new a5.utils.Timer};return _(ResumedState.prototype).extend(new lms.SolvingState,{onEnter:function(sm){this._interaction.tc_code=lms.TCInteractionCodes.SOLVING;var tincan=sm.tincan();tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("resumed"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}}}),this.timer.stamp()}}),ResumedState}()}(a5.service.lms,_),function(lms,_){lms.DefaultState=function(){var DefaultState=function(){};return _(DefaultState.prototype).extend({onLOStart:function(sm,params){sm.push(new lms.LOPreviewState(params.lo_id,params.lo))}}),DefaultState}()}(a5.service.lms,_),function(lms,$,_){lms.TinCanWrapper=function(){var _driver,_lo_name,_interaction_name,_send_queue,_send_state_queue,_filter,_activity_prefix="",_actor={},_verbs={},_context={},_tincan=null,_activity_id=null,_lo_id=null,_interaction_id=null,_registration=null,_can_store=!0,_can_restore=!0,process_statement=function(statement){if(_registration)if(statement.context)statement.context.registration=_registration;else{var context=_.extend(_context||{},{registration:_registration});statement.context=new _driver.TinCan.Context(context)}},create_verbs=function(){return{answered:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/answered",display:{und:"answered"}}),attempted:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/attempted",display:{und:"attempted"}}),closed:new _driver.TinCan.Verb({id:"http://activitystrea.ms/schema/1.0/close",display:{und:"closed"}}),launched:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/launched",display:{und:"launched"}}),resumed:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/resumed",display:{und:"resumed"}}),started:new _driver.TinCan.Verb({id:"http://activitystrea.ms/schema/1.0/start",display:{und:"started"}}),suspended:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/suspended",display:{und:"suspended"}}),terminated:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/terminated",display:{und:"terminated"}}),scored:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/scored",display:{und:"scored"}}),mastered:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/mastered",display:{und:"mastered"}}),skipped:new _driver.TinCan.Verb({id:"http://id.tincanapi.com/verb/skipped",display:{und:"skipped"}}),acknowledged:new _driver.TinCan.Verb({id:"http://activitystrea.ms/schema/1.0/acknowledge",display:{und:"acknowledged"}})}},TinCanWrapper=function(driver,parameters,callback){_driver=driver||window,_tincan=new _driver.TinCan({recordStores:[{endpoint:parameters.endpoint,auth:parameters.auth}]}),
_activity_prefix=parameters.prefix,_actor=parameters.actor,_context=parameters.context,_verbs=create_verbs(),_send_queue=new lms.SendQueue(_tincan,callback),_send_state_queue=new lms.SendStateQueue(_tincan),_registration=parameters.registration,_activity_id=parameters.activity_id,_filter=_(parameters.filter).map(function(verb){return _verbs[verb]}),_can_store=parameters.canStore,_can_restore=parameters.canRestore};return _(TinCanWrapper.prototype).extend({registration:function(){return _registration},setLearningObjectId:function(lo_id,name){_lo_name=void 0!==name?name:"Learning Object "+lo_id,_lo_id=lo_id},setInteractionId:function(int_id,name){_interaction_name=void 0!==name?name:"Interaction page "+(int_id+1),_interaction_id=int_id},getLearningObjectName:function(){return _lo_name},getInteractionName:function(){return _interaction_name},activityLearningObjectId:function(lo_id){return lo_id=void 0!==lo_id?lo_id:_lo_id,lo_id=_activity_id||(_activity_prefix?_activity_prefix+"/"+lo_id:lo_id)},activityInteractionId:function(interaction_id,lo_id){return interaction_id=void 0!==interaction_id?interaction_id:_interaction_id,this.activityLearningObjectId(lo_id)+"/"+interaction_id},activity:function(type){var id,name=this.getLearningObjectName();return"lo"===type?id=this.activityLearningObjectId():(id=this.activityInteractionId(),name+=", "+this.getInteractionName()),new _driver.TinCan.Activity({id:id,definition:{name:{und:name}}})},result:function(cfg){return new _driver.TinCan.Result(cfg)},agent:function(){return new _driver.TinCan.Agent(_actor)},verb:function(name){return _verbs[name]},sendStatementC:function(statement){_.contains(_filter,statement.verb)&&(process_statement(statement),_can_store&&_send_queue.add(statement))},sendStatement:function(statement,callback){if(_.contains(_filter,statement.verb))return process_statement(statement),_can_store&&_tincan.sendStatement(statement,callback)},getStatements:function(cfg){var deferred=$.Deferred();return _can_restore?_tincan.getStatements(_.extend(cfg,{callback:function(err,result){null==err?deferred.resolve(result):deferred.reject(err)}})):deferred.reject(),deferred.promise()},setState:function(key,val,cfg){_can_store&&_send_state_queue.add(key,val,cfg)},getState:function(key,cfg){var deferred=$.Deferred();return _can_restore?_tincan.getState(key,_.extend(cfg,{callback:function(err,result){null==err?deferred.resolve(result):deferred.reject(err)}})):deferred.reject(),deferred.promise()},finish:function(asynch){return $.when(_send_queue.finish(asynch),_send_state_queue.finish(asynch))},start:function(){_send_queue.start(),_send_state_queue.start()}}),_(TinCanWrapper).extend({getInteractionId:function(activity_id,lo_id){var result=activity_id.match(new RegExp(lo_id+"/(.*)"));return result&&result.length>0?result[1]:null}}),TinCanWrapper}()}(a5.service.lms,jQuery,_),function(lms,_){lms.TinCanAdapter=function(){var _sm=null,_tincan=null,_options=null,TinCanAdapter=function(options){_options=options,(options.canStore||options.canRestore)&&(_tincan=new lms.TinCanWrapper(window,options,this.onEndPointResponse),_sm=new lms.StateMachine(_tincan),_sm.push(new lms.DefaultState))};return _(TinCanAdapter.prototype).extend({onLOStart:function(lo_uid,lo_id,lo){_tincan&&_sm.propagate("onLOStart",{lo_id:lo_uid||lo_id,lo:lo})},onLOEnd:function(lo){_tincan&&_sm.propagate("onLOEnd",{lo:lo})},onLONext:function(){},onLOPrevious:function(){},onInteractionStart:function(interaction_id,interaction){_tincan&&_sm.propagate("onInteractionStart",{interaction_id:interaction_id,interaction:interaction})},onInteractionEnd:function(){_tincan&&_sm.propagate("onInteractionEnd")},onInteractionCheckAnswer:function(){_tincan&&_sm.propagate("onInteractionCheckAnswer")},onInteractionSeeAnswerBeforeInteraction:function(){_tincan&&_sm.propagate("onInteractionSeeAnswerBeforeInteraction")},onInteractionReset:function(){_tincan&&_sm.propagate("onInteractionReset")},onInteractionTryAgain:function(){_tincan&&_sm.propagate("onInteractionTryAgain")},onLOTotalScore:function(score){_tincan&&_sm.propagate("onLOTotalScore",{total_score:score})},onLOSubmit:function(score,duration){if(_tincan)return _sm.propagate("onLOSubmit",{score:score,duration:duration}),_tincan.finish(!0)},setBookmark:function(page){var deferred=$.Deferred();if(!_tincan)return deferred.resolve(),deferred.promise();var promise=_sm.propagate("setBookmark",page);return promise||(deferred.resolve(),deferred.promise())},getBookmark:function(){var deferred=$.Deferred();if(!_tincan)return deferred.resolve(null),deferred.promise();var promise=_sm.invoke("getBookmark");return promise||(deferred.resolve(null),deferred.promise())},getData:function(){var deferred=$.Deferred();if(!_tincan)return deferred.resolve(""),deferred.promise();var promise=_sm.invoke("getData");return promise||(deferred.resolve(""),deferred.promise())},setData:function(serializedData,data){var deferred=$.Deferred();if(!_tincan)return deferred.resolve(),deferred.promise();var promise=_sm.propagate("setData",serializedData,data);return promise||(deferred.resolve(),deferred.promise())},onLOClose:function(sync){if(_tincan)return _sm.propagate("onLOClose"),_sm.clear(),_tincan.finish(sync)},onEndPointResponse:function(result){_(result).each(function(r){return 401===r.err?void(_options.callbacks&&_options.callbacks.onEndpointUnauthorized?_options.callbacks.onEndpointUnauthorized():_options.on_timeout_redirect_url&&lms.TinCanUtils.redirectTo(_options.on_timeout_redirect_url)):500===r.err?void(_options.callbacks&&_options.callbacks.onEndpointError?_options.callbacks.onEndpointError():_options.on_error_redirect_url&&lms.TinCanUtils.redirectTo(_options.on_error_redirect_url)):void 0})}}),TinCanAdapter}()}(a5.service.lms,_),a5.service.InteractionsLoader={init:function(){this.queue=[],this.libraryLoader=a5.service.libraryLoader,this.itemBankManager=new a5.service.ItemBanksManager,this.reactEngineInterface=a5.service.reactEngineInterface,this.needsReact=!1,_.bindAll(this,"onAllInteractionsLoaded")},push:function(interaction){interaction.setLiveCycle("loading"),this.queue.push(interaction),interaction.reset()},start:function(){var promises=_.map(this.queue,function(interaction){return this.load(interaction)},this);return $.when.apply($,promises).then(this.onAllInteractionsLoaded)},onAllInteractionsLoaded:function(){var selected=this.selectInteractions();this.needReact||this.reactEngineInterface.noInteractionWithReact(),this.reactEngineInterface.addToState(a5.service.React.actions.screens.ADD_SCREENS,selected.list),this.trigger("finished",selected.list,selected.userSelectScreen)},reload:function(interaction){return interaction.setLiveCycle("loading"),interaction.reset(),this.load(interaction)},load:function(interaction){return a5.performance.bindInteractionPerformanceEvents(interaction),a5.eventBus.trigger("performance:load_screen_"+interaction.url+":start"),$.when(interaction).then(function(interaction){return $.when(interaction,this._loadInteractionXML(interaction))}.bind(this)).then(function(interaction,response){return $.when(interaction,response,this._loadItemBanks(interaction,response.xml))}.bind(this)).then(function(interaction,response){return $.when(interaction,response,this._loadReactBuild(interaction,response.xml,response.xmlText),this._loadCKEDITOR(interaction,response.xml,response.xmlText),this._loadWiris(interaction,response.xml,response.xmlText))}.bind(this)).then(function(interaction,response){this.onInteractionLoaded(interaction,response.xml),a5.eventBus.trigger("performance:load_screen_"+interaction.url+":end")}.bind(this))},onInteractionLoaded:function(interaction,xml){this._initializeInteraction(interaction,xml)},_sanitizeInteraction:function($xml){$xml.find("itemBody").find("#attachments #custom > div").each(function(){var that=$(this),items=that.text().split(/(\]\])(?=>)/);that.empty();for(var text;void 0!==(text=items.shift());)that.append($xml.get(0).createCDATASection(text))})},_initializeInteraction:function(interaction,xml){var $xml=$(xml);this._sanitizeInteraction($xml),interaction.xml=xml,interaction.setTitleAndGroup($xml.find("assessmentItem").attr("title")),interaction.identifier=$xml.find("assessmentItem").attr("identifier"),a5.eventBus.trigger("performance:xml_options_"+interaction.url+":start"),interaction.parseActivityOptions(),a5.eventBus.trigger("performance:xml_options_"+interaction.url+":end"),a5.eventBus.trigger("performance:xml_preprocessor_"+interaction.url+":start"),interaction.xml=a5.preprocessor.applyToXMLNode(xml,interaction,"attachments"),a5.eventBus.trigger("performance:xml_preprocessor_"+interaction.url+":end"),interaction.parseActivityOptions(),interaction.bind("reset",interaction.parseActivityOptions,interaction),interaction.init_enumerations()},_loadInteractionXML:function(interaction){return(new a5.utils.Loader).load(interaction.url).then(function(response){return interaction.source="xml",this.onInteractionXMLLoaded(interaction,response),{xml:response.xml,xmlText:response.text}}.bind(this)).fail(_.partial(this.onInteractionXMLFailed,interaction))},onInteractionXMLLoaded:function(interaction,response){logger.log(interaction.url+" loaded.")},onInteractionXMLFailed:function(interaction,reason,readyState){4===readyState&&(logger.error("Error loading "+interaction.url+": "+reason),alert(reason))},_loadItemBanks:function(interaction,xml){if(this.itemBankManager.hasItemBanks(xml)){var def=$.Deferred(),promise=def.promise();return this.itemBankManager.loadBanks(xml,interaction).done(function(newXml){interaction.source="item-bank",this.onItemBanksLoaded(),def.resolveWith(this,[newXml])}.bind(this)).fail(function(errors){errors&&errors.type&&errors.type===a5.ItemBankErrors.IDS?(this.onItemBanksWarn(errors),interaction.reset(),this._loadItemBanks(interaction,xml).done(function(data){def.resolveWith(this,[data])}).fail(function(data){def.rejectWith(this,[data])})):(this.onItemBanksFailed(errors),def.rejectWith(this,[errors]))}.bind(this)),promise}},onItemBanksLoaded:function(){logger.log("Item banks loaded.")},onItemBanksFailed:function(reason){logger.error("Error loading bank items: "+reason.msg),alert("Error loading bank items")},onItemBanksWarn:function(reason){logger.warn("WARNING loading bank items: "+reason.msg)},_loadReactBuild:function(interaction,xml,xmlText){var interactionNeedReact=this.reactEngineInterface.needReact({interaction:interaction,xml:xml,xmlText:xmlText});if(this.needReact=this.needReact||interactionNeedReact,interactionNeedReact)return $.when(this.reactEngineInterface.loadReactAssets()).then(this.onReactLoaded).fail(this.onReactFailed)},onReactLoaded:function(){logger.log("react assets loaded.")},onReactFailed:function(){logger.error("react assets NOT LOADED. ")},_loadCKEDITOR:function(interaction,xml,xmlText){var dependencies={interaction:interaction,xml:xml,xmlText:xmlText};if(this.libraryLoader.needLibrary(this.libraryLoader.LIBRARY_FILES.CKEDITOR,dependencies)){var ckeditorLibs=[this.libraryLoader.LIBRARY_FILES.CKEDITOR];return $.when(this.libraryLoader.load(ckeditorLibs)).then(_.partial(this.onCKEDITORLoaded,ckeditorLibs)).fail(_.partial(this.onCKEDITORFailed,ckeditorLibs))}},onCKEDITORLoaded:function(ckeditorLibs){logger.log(ckeditorLibs.join(",")+" loaded.")},onCKEDITORFailed:function(ckeditorLibs){logger.error("couldn't load: "+ckeditorLibs.join(","))},_loadWiris:function(interaction,xml,xmlText){var dependencies={interaction:interaction,xml:xml,xmlText:xmlText};if(this.libraryLoader.needLibrary(this.libraryLoader.LIBRARY_FILES.WIRIS_QUIZ,dependencies)){var wirisLibs=[this.libraryLoader.LIBRARY_FILES.WIRIS_QUIZ];return $.when(this.libraryLoader.load(wirisLibs)).then(this.onWirisLoaded.bind(this,wirisLibs)).fail(this.onWirisFailed.bind(this,wirisLibs))}},onWirisLoaded:function(wirisLibs){logger.log(wirisLibs.join(",")+" loaded."),this._initializeWiris()},onWirisFailed:function(wirisLibs){logger.error("couldn't load: "+wirisLibs.join(","))},_initializeWiris:function(){var config=com.wiris.quizzes.api.QuizzesBuilder.getInstance().getConfiguration();config.set(com.wiris.quizzes.api.ConfigurationKeys.RESOURCES_URL,A5.WIRIS_QUIZ_LIBRARY_RESOURCES_URL),_.isEmpty(A5.WIRIS_QUIZ_VALIDATION_SERVICE_URL)||config.set(com.wiris.quizzes.api.ConfigurationKeys.SERVICE_URL,A5.WIRIS_QUIZ_VALIDATION_SERVICE_URL)},selectInteractions:function(){var userSelectScreen=null,intList=this.queue,groups=a5.utils.getInteractionsGroups(intList);return a5.mainBuilder.options().activitypoolIsOn()&&groups.length&&$(intList[0].xml).find("userselection").length&&(userSelectScreen=this.poolIntro(intList),intList=_.difference(intList,userSelectScreen)),{userSelectScreen:userSelectScreen,list:intList}},poolIntro:function(intList){var introScreen=intList[0],$controls=$("#micro_controls, #macro_controls, #page_controls");return introScreen.bind("show",function(){$controls.hide()}),introScreen.bind("hide",function(){$controls.show()}),[introScreen]}},Obj.extend("a5.service.InteractionsLoader"),a5.service.ItemBanksManager={init:function(){},hasItemBanks:function(xml){return $(xml).find("itembank").length},loadBanks:function(xml,interaction){var $xml=$(xml),deferred=$.Deferred(),itemBankNodes=$xml.find("itembank"),activityType=$xml.find("assessmentItem").attr("identifier"),itbLoader=this.itemBankLoader=new a5.service.ItemBankLoader;return $.when(a5.service.lms.API.getData(interaction.getID())).then(_.bind(function(data){var storedData=data||{};return _.each(itemBankNodes,function(node){itbLoader.push(this.itemBankFromNode(node,activityType,storedData.itemBanks))},this),$.when.apply($,[storedData].concat(this.itemBankLoader.start()))},this)).done(_.bind(function(data){this.replaceItemBankData($xml,data,interaction,Array.prototype.slice.call(arguments,1)),deferred.resolveWith(this,[xml])},this)).fail(function(data){deferred.rejectWith(this,[data])}),deferred.promise()},itemBankFromNode:function(node,aType,storedItems){var $node=$(node),config={node:node,sets:_.compact(($node.attr("sets")||"").split("|")),tags:_.compact(($node.attr("tags")||"").split("|")),amount:parseInt($node.attr("amount"),10),itembankId:$node.attr("id"),activityType:aType};if(storedItems){var storedIds=this.getItemIds(config.itembankId,storedItems);storedIds&&(config.itemIds=storedIds)}return new a5.ItemBank(config,null)},replaceItemBankData:function($xml,storedData,interaction,itembanks){var itemsIds=[];_.each(itembanks,function(itb){this.addItemBankAnswers($xml,itb),this.addItemBankQuestions($xml,itb),itemsIds.push({id:itb.itembankId,itemIds:itb.itemIds});var escapedId=a5.utils.jquerySelectorEscape(itb.itembankId);$xml.find("itembank#"+escapedId).closest("#contentblock").remove()},this),this.updateItembankStoredData(itemsIds,storedData,interaction)},addItemBankAnswers:function($xml,itb){var answersXML=itb.getAnswersResponsesXML(),lastResponseDeclaration=this.getLastResponseDeclaration($xml);lastResponseDeclaration?lastResponseDeclaration.after(answersXML):this.getAssessmentItem($xml).prepend(answersXML)},getLastResponseDeclaration:function($xml){if($xml.find("responseDeclaration").length)return $xml.find("responseDeclaration:last")},getAssessmentItem:function($xml){return $xml.find("assessmentItem")},addItemBankQuestions:function($xml,itb){var questionsXML=itb.getQuestionsXML(),escapedId=a5.utils.jquerySelectorEscape(itb.itembankId);$xml.find("itembank#"+escapedId).closest("#contentblock").after(questionsXML)},getItemIds:function(id,items){var storedItem=_.findWhere(items,{id:id});return storedItem&&storedItem.itemIds},updateItembankStoredData:function(items,storedData,interaction){var storedBanks=storedData.itemBanks||[];if((items||[]).some(function(newItem){var storedItem=_.findWhere(storedBanks,{id:newItem.id});return!storedItem||_.difference(storedItem.itemIds,newItem.itemIds).length>0||_.difference(newItem.itemIds,storedItem.itemIds).length>0})){var ob=_.extend({},storedData,{itemBanks:items});a5.service.lms.API.setData(interaction.getID(),ob),interaction.itemBanks=items}}},Obj.extend("a5.service.ItemBanksManager"),a5.service.ItemBankLoader={init:function(){this.queue=[]},push:function(itemBank){this.queue.push(itemBank),this.queue=_.flatten(this.queue)},start:function(){return _.map(this.queue,function(itembank){var def=$.Deferred();return $.ajax({type:"GET",url:itembank.getUrl(),dataType:"json",data:itembank.getUrlParams()}).done(_.bind(function(data,code,response){var errors=itembank.setData(data);null===errors?def.resolveWith(this,[itembank]):def.rejectWith(this,errors)},this)).fail(function(data,code,response){var responseErrors=[itembank.itembankId,data.status,response].join("|");def.rejectWith(this,[{type:a5.ItemBankErrors.SERVER,msg:responseErrors}])}),def.promise()},this)}},Obj.extend("a5.service.ItemBankLoader"),a5.service.InteractionExporter={init:function(interaction){this.interaction=interaction},exportAsPDF:function(filename){this.exportTo("pdf",A5.SKIN_URL+"exportTemplates/a5.default.tex",filename)},exportAsRTF:function(filename){this.exportTo("rtf",A5.SKIN_URL+"exportTemplates/a5.default.rtf",filename)},exportTo:function(format,template,filename){var $html=this.getInteractionHTMLToConvert();a5.service.toolbelt.exportTo({formats:format,template:template,output:filename,input:$html.html(),args:["--latex-engine=xelatex","--variable=mainfont:DejaVu Serif"]})},_convertTextAreasToText:function($original,$html){var texts=[];$original.find("textarea").each(function(index,textarea){texts.push($(textarea).val().split("\n").join("<br>"))}),$html.find("textarea").each(function(index,textarea){texts[index]&&$(textarea).after('<div class="user-input-export"><p>'+texts[index]+"</p></div>"),$(textarea).remove()})},_convertInputsToText:function($original,$html){var texts=[];$original.find("input:text").each(function(index,input){texts.push($(input).val())}),$html.find("input:text").each(function(index,input){var $input=$(input);if(texts[index])if($input.is(".text-area-content.inline input:text")){var $wrapper=$input.closest(".text-area-content.inline");$wrapper.contents().unwrap(),$input.after('<span class="user-input-export">'+texts[index]+"</span>")}else $input.after('<div class="user-input-export">'+texts[index]+"</div>");$input.remove()})},_convertCKEditorsToText:function($original,$html){window.CKEDITOR&&_.each(window.CKEDITOR.instances,function(ck,id){var sId=_.str.sprintf("[id='cke_%s']",id),$ckeditor=$html.find(sId);ck.getData()&&($ckeditor.after('<div class="user-input-export">'+ck.getData()+"</div>"),$ckeditor.prev(".user-input-export").remove()),$ckeditor.remove()})},_addProtocolToExternalImages:function($original,$html){$html.find("img").each(function(index,image){$(image).attr("src",image.src)})},_removeAudioVideo:function($original,$html){$html.find(".v_a_media").remove()},_removeEmptySpan:function($original,$html){$html.find("span:empty").remove()},getInteractionHTMLToConvert:function(){var $original=this.interaction.contentWrap,$html=$original.clone();return this._convertTextAreasToText($original,$html),this._convertCKEditorsToText($original,$html),this._convertInputsToText($original,$html),this._addProtocolToExternalImages($original,$html),this._removeAudioVideo($original,$html),this._removeEmptySpan($original,$html),"Input:Creative:Extended writing"===this.interaction.identifier?$html=this.getInteractionHTMLForExtendedWriting($html):"Input:Creative:Free writing"===this.interaction.identifier&&($html=this.getInteractionHTMLForFreeWriting($html)),$html},getInteractionHTMLForFreeWriting:function($source){var $rubric=$source.find("[data-zone-type='rubric']"),$content=$source.find("[data-zone-type='content']"),$media=$source.find("[data-zone-type='media']"),$rubricClone=$rubric.clone(),$contentClone=$content.clone(),$mediaClone=$media.clone();return $(_.template('<div class="content-wrap"><h2 class="rubric"><%= rubric %></h2><div class="content"><%= content %></div><div class="media"><%= media %></div></div>')({rubric:$rubricClone.html(),content:$contentClone.html(),media:$mediaClone.html()}))},getInteractionHTMLForExtendedWriting:function($source){var courseTitle=_.first(this.interaction.activityMetadata.getValues("Course name")),$rubric=this.interaction.rubricZone,$rubricClone=$rubric.clone();this._addProtocolToExternalImages($rubric,$rubricClone);for(var $userInput,$html=$(_.template('<div class="content"><h1 class="course-title"><%= courseTitle %></h1><h2 class="student-label">Name: </h2><h2 class="class-label">Class: </h2><hr><h2 class="rubric"><%= rubric %></h2><h2 class="title-label">Title: </h2></div>')({courseTitle:courseTitle?courseTitle.value||courseTitle.description:"",rubric:$rubricClone.html()})),index=1,$section=$source.find(".sect-"+index);$section.length>0;)$userInput=$section.find(".user-input-export"),$html.append($userInput.html()),$section=$source.find(".sect-"+ ++index);return $html}},Obj.extend("a5.service.InteractionExporter"),a5.service.PostMessager={listeners:[],init:function(){window.addEventListener("message",_.bind(this.onPostMessageReceived,this),!1)},sendMessage:function(message,args){var messObj={actionCode:message};args&&(messObj=$.extend(args,messObj)),window.parent.postMessage(messObj,"*")},addListener:function(event,cbackFunc){var eventOb=_.findWhere(this.listeners,{event:event});eventOb?eventOb.callbacks=eventOb.callbacks?eventOb.callbacks.concat([cbackFunc]):[cbackFunc]:this.listeners.push({event:event,callbacks:[cbackFunc]})},removeListener:function(event,cbackFunc){var eventOb=_.findWhere(this.listeners,{event:event});eventOb&&(eventOb.callbacks=_.without(eventOb.callbacks,cbackFunc))},onPostMessageReceived:function(evt){if(evt.data.actionCode){logger.log("a5.service.PostMessager:recieve message from: "+evt.origin+" message: "+JSON.stringify(evt.data));var eventOb=_.findWhere(this.listeners,{event:evt.data.actionCode});eventOb&&_.each(eventOb.callbacks,function(cbk){cbk.call()})}}},Obj.extend("a5.service.PostMessager"),a5.service.ExternalLibraryLoader={STATES:{NOT_LOADED:0,LOADING:1,LOADED:2,ERROR:3},libraries:{},LIBRARY_FILES:{CKEDITOR:"ckeditor.bundle.js",WIRIS_QUIZ:"quizzes.js"},load:function(libs){var promise=$.Deferred();return $.when.apply($,_.map(libs,_.bind(function(lib){return this.loadLib(this.prepareLibrary(lib))},this))).done(function(response){promise.resolveWith(this,[response])}).fail(function(response){promise.rejectWith(this,[response])}),promise.promise()},needLibrary:function(lib,parameters){var needed=!1,xml=parameters.xml,xmlText=parameters.xmlText,interaction=parameters.interaction,$xml=$(xml);return lib===this.LIBRARY_FILES.CKEDITOR?needed=xmlText.match(/#(inlineeditor|richtextinput).*#/i)||$xml.find('assessmentItem[identifier="Input:Creative:Extended writing"], assessmentItem[identifier="Present:Present:Ebook"]').length||interaction.options.wikiToolIsOn()&&A5.WIKI&&$xml.find("div#wiki").length||interaction.options.lONotesAreaIsOn():lib===this.LIBRARY_FILES.WIRIS_QUIZ&&(needed=$xml.find('assessmentItem[identifier="Input:Completion:MathsQuizzes"]').length),needed},prepareLibrary:function(lib){if(lib===this.LIBRARY_FILES.CKEDITOR){var ckeditor_basepath=A5.ENGINE_ROOT+A5.CKEDITOR_FOLDER_PATH;return A5.CKEDITOR_RELATIVE?window.CKEDITOR_BASEPATH=ckeditor_basepath:window.CKEDITOR_BASEPATH=window.location.protocol+ckeditor_basepath,window.CKEDITOR_BASEPATH+this.LIBRARY_FILES.CKEDITOR}return lib===this.LIBRARY_FILES.WIRIS_QUIZ?($("<link/>",{rel:"stylesheet",type:"text/css",href:A5.WIRIS_QUIZ_LIBRARY_RESOURCES_URL+"/wirisquizzes.css"}).appendTo("head"),A5.WIRIS_QUIZ_LIBRARY_RESOURCES_URL+"/"+this.LIBRARY_FILES.WIRIS_QUIZ):lib},loadLib:function(lib){var promise;return!lib||this.libraries[lib]&&this.libraries[lib].state===this.STATES.ERROR?(promise=$.Deferred(),promise.rejectWith(this,"error")):this.libraries[lib]&&this.libraries[lib].state!==this.STATES.NOT_LOADED?this.libraries[lib].state===this.STATES.LOADING?promise=this.libraries[lib].promise:this.libraries[lib].state===this.STATES.LOADED&&(promise=$.Deferred(),promise.resolveWith(this,["loaded"])):promise=this.loadLibrary(lib).promise,promise.promise()},loadLibrary:function(lib){var promise=$.Deferred();this.libraries[lib]={state:this.STATES.LOADING,promise:promise};var doneCallback=_.bind(function(data,code,response){this.libraries[lib].state=this.STATES.LOADED,promise.resolveWith(this,["loaded"])},this),errorCallback=_.bind(function(data,code,response){logger.error("error loading script: "+lib),this.libraries[lib].state=this.STATES.ERROR,promise.rejectWith(this,["error"])},this);return a5.getScript(lib,doneCallback,errorCallback),this.libraries[lib]}},Obj.extend("a5.service.ExternalLibraryLoader"),a5.models.interaction.ReactItem={init:function(index,data,solData,userData,interactionId,activityType,verificationService){this.interactionId=interactionId,this.activityId=interactionId+"_"+index,this.verificationService=verificationService||"local",this.activityData=data,this.solutionData="local"===this.verificationService?solData:null,this.activityType=activityType,this.userData=userData,this.setStates()},setStates:function(){var activity={id:this.activityId,screenId:this.interactionId,data:this.activityData,userData:this.userData,validationData:[]};this.solutionData&&(activity.solutionData=this.solutionData),a5.service.reactEngineInterface.addToState(a5.service.React.actions.activities.getActivityAddAction(this.activityType),activity)},meetsMinLength:function(){return!0},isFilled:function(){},getScores:function(){var methodName=a5.service.React.selectors.getActivityScoreDataMethod(this.activityType),data={activityType:this.activityType+"s",activityId:this.activityId,normalized:!0},scoreData=a5.service.reactEngineInterface.getState(methodName,data),score=new a5.Score;return score.incTotal(scoreData.total),score.incCorrect(scoreData.correct),score.incFilled(scoreData.filled),score},setAnswer:function(){},setAnswerInput:function(){},tryAgain:function(){},showAnswer:function(){},clearSolutionHint:function(){},showSolutionHint:function(){},showNextAnswer:function(){},hasItemsForReveal:function(){},getAllAnswers:function(){},store:function(){var methodName=a5.service.React.selectors.getActivityUserDataMethod(this.activityType),data={activityType:this.activityType+"s",activityId:this.activityId,normalized:!0};return a5.service.reactEngineInterface.getState(methodName,data)},restore:function(stored){var data={activityId:this.activityId,data:stored};a5.service.reactEngineInterface.addToState(a5.service.React.actions.activities.getActivityRestoreAction(this.activityType),data)}},Obj.extend("a5.models.interaction.ReactItem"),a5.service.React=a5.service.React||{},a5.service.React.EngineInterface={reactActivities:["Input:Completion:Crossword"],init:function(){this.actionsQueue=[],this.utils=new a5.service.React.Utils,this.libLoader=a5.service.libraryLoader,this.reactAssetsStates={NOT_LOADED:0,LOADING:1,LOADED:2,ERROR:3,NOT_NEEDED:4},this.reactAssetsState=this.reactAssetsStates.NOT_LOADED,this.config={react_bundle:A5.REACT_BUNDLE_FOLDER_PATH+"react-lib.bundle.js"}},getState:function(method,data){if(this.reactAssetsState===this.reactAssetsStates.ERROR||this.reactAssetsState===this.reactAssetsStates.NOT_NEEDED)return!1;var params={method:method,data:data};return this.reactAssetsState===this.reactAssetsStates.LOADED?ReactComponents.getState(params):void 0},addToState:function(action,data){if(this.reactAssetsState===this.reactAssetsStates.ERROR||this.reactAssetsState===this.reactAssetsStates.NOT_NEEDED)return!1;var actions=a5.service.React.actions;switch(action){case actions.lo.SET_LO_OPTIONS:data=this.utils.optionsToState(data);break;case actions.screens.ADD_SCREENS:data=this.utils.interactionToState(data)}var params={action:action,data:data};return this.reactAssetsState===this.reactAssetsStates.LOADED?ReactComponents.updateState(params):this.actionsQueue.push({type:"setState",params:params}),!0},renderElement:function(componentName,props,destination){if(this.reactAssetsState===this.reactAssetsStates.ERROR||this.reactAssetsState===this.reactAssetsStates.NOT_NEEDED)return!1;var params={componentName:componentName,props:props,destination:destination};return this.reactAssetsState===this.reactAssetsStates.LOADED?ReactComponents.renderElement(params):this.actionsQueue.push({type:"render",params:params}),!0},needReact:function(params){var $xml=$(params.xml);return this.isActivityReact($xml.find("assessmentItem").attr("identifier"))},isActivityReact:function(activityType){if(a5.dp.config.reactActivitiesEnabled){var reactActivities=a5.dp.config.reactActivities.filter(function(at){return _.contains(this.reactActivities,at)}.bind(this));return _.contains(reactActivities,activityType)}return!1},noInteractionWithReact:function(){this.reactAssetsState=this.reactAssetsStates.NOT_NEEDED,this.flushActions()},loadReactAssets:function(){var promise=$.Deferred();switch(this.reactAssetsState){case this.reactAssetsStates.NOT_LOADED:this.reactAssetsState=this.reactAssetsStates.LOADING;var reactAssets=[this.config.react_bundle];return $.when(this.libLoader.load(reactAssets)).done(function(loaded){this.reactAssetsState=this.reactAssetsStates.LOADED,this.flushActions(!0),promise.resolveWith(this,[loaded])}.bind(this)).fail(function(err){this.reactAssetsState=this.reactAssetsStates.ERROR,this.flushActions(!1),promise.rejectWith(this,[err])}.bind(this)),promise.promise();case this.reactAssetsStates.LOADING:case this.reactAssetsStates.LOADED:case this.reactAssetsStates.ERROR:return this.libLoader.load(reactAssets);case this.reactAssetsStates.NOT_NEEDED:return promise.rejectWith(this,["not needed"]),promise.promise()}},flushActions:function(shouldRunElements){shouldRunElements&&this.actionsQueue.forEach(function(action){"render"===action.type?ReactComponents.renderElement(action.params):"setState"===action.type&&ReactComponents.updateState(action.params)}.bind(this)),this.actionsQueue=[]}},Obj.extend("a5.service.React.EngineInterface"),a5.service.React.Utils={interactionToState:function(interactions){return _.map(interactions,function(interaction){return{id:interaction.id,identifier:interaction.identifier,xml:interaction.xml,source:interaction.source,activities:[],options:this.optionsToState(interaction.options)}}.bind(this))},optionsToState:function(options){var optionsHash=this.__mergeOptionsToPriority(options,"options"),customOptionsHash=this.__mergeOptionsToPriority(options,"customOptions");return Object.keys(optionsHash).forEach(function(key){optionsHash[key]={key:optionsHash[key]}}),Object.keys(customOptionsHash).forEach(function(customKey){_.contains(Object.keys(optionsHash),customKey)||(optionsHash[customKey]={}),optionsHash[customKey].value=customOptionsHash[customKey]}),optionsHash=this.__clearOptionsHash(optionsHash)},__mergeOptionsToPriority:function(options,field){var optionsHashList=options.parents.map(function(o){return o[field]});return optionsHashList.push(options[field]),optionsHashList.reverse(),optionsHashList.reduce(function(acumulator,current){return _.extend(acumulator,current)})},__clearOptionsHash:function(optionsHash){for(var ob=_.extend({},optionsHash),hashKeys=Object.keys(ob),i=0;i<hashKeys.length;i++){var curKey=hashKeys[i],clearNumberString=Number(curKey).toString();clearNumberString!==curKey&&(ob[clearNumberString]=ob[curKey],delete ob[curKey])}return ob}},Obj.extend("a5.service.React.Utils"),a5.service.React=a5.service.React||{},a5.service.React.actions={lo:{SET_LO_OPTIONS:"LO.SET_LO_OPTIONS"},options:{SET_OPTIONS_LIST:"OPTIONS.SET_OPTIONS_LIST"},screens:{ADD_SCREENS:"SCREENS.ADD_SCREENS"},activities:{getActivityAddAction:function(activityType){return"ACTIVITIES."+activityType.toUpperCase()+".ADD_"+activityType.toUpperCase()},getActivityRestoreAction:function(activityType){return"ACTIVITIES."+activityType.toUpperCase()+".RESTORE_USER_DATA"},getAllActivityActionConstants:function(activityType){var retOb={};return retOb[activityType]={},retOb["ADD_"+activityType.toUpperCase()]=a5.service.React.actions.activities.getActivityAddAction(activityType),
retOb.RESTORE_USER_DATA=a5.service.React.actions.activities.getActivityRestoreAction(activityType),retOb}}},a5.service.React.components={activities:{iccrossword:{ICCrossword:"activities.iccrossword.ICCrossword"}}},a5.service.React.selectors={getActivityUserDataMethod:function(activityType){return"activities."+activityType+".getUserDataForStorage"},getActivityScoreDataMethod:function(activityType){return"activities."+activityType+".getScore"}},a5.Tasks={init:function(){this.tasks=[],this.runningTask=null,this.continuuu()},push:function(task,immediately){immediately?(task!==this.runningTask&&(this.interruptedTask=this.runningTask),this.tasks.unshift(task),this.runningTask=null,cancelAnimationFrame(this.requestId),this.run()):this.tasks.push(task)},findNextTask:function(){return this.tasks.shift()},continuuu:function(){this.requestId=requestAnimationFrame(_.bind(this.run,this))},run:function(){if(null==this.runningTask&&(this.runningTask=this.findNextTask(),this.runningTask&&this.runningTask.trigger("start")),null!=this.runningTask){this.runningTask.trigger("run");this.runningTask.run()&&(this.runningTask.trigger("stop"),this.runningTask=this.interruptedTask,this.interruptedTask=null)}this.continuuu()},current:function(){return this.runningTask},clear:function(){this.tasks=[]},clearBy:function(predicate){this.tasks=_.filter(this.tasks,predicate)}},Obj.extend("a5.Tasks"),a5.Task={init:function(){this.events={start:[],stop:[],run:[]},a5.logger.tasks&&(this.bind("start",function(){logger.info("tasks",this.group,"start")},this),this.bind("stop",function(){logger.info("tasks",this.group,"stop")},this))},run:function(){return!0}},Obj.extend("a5.Task"),a5.FunctionTask={init:function(func,context){this._super(),this.func=func,this.context=context||this},run:function(){return this.func.apply(this.context)}},a5.Task.extend("a5.FunctionTask"),a5.TaskGroups={init:function(){this.groups={}},push:function(task,group,immediately){group=group||"default",this.groups[group]=this.groups[group]||new a5.Tasks,task.group=group,this.groups[group].push(task,immediately)},current:function(group){if(group=group||"default",this.groups[group])return this.groups[group].current()},clear:function(group){if(group=group||"default",this.groups[group])return this.groups[group].clear()},clearBy:function(predicate,group){if(group=group||"default",this.groups[group])return this.groups[group].clearBy(predicate)}},Obj.extend("a5.TaskGroups"),a5.tasks=new a5.TaskGroups,Obj.extend("a5.service.Templates",{init:function(parameters){this.dp=parameters.dp,this.contentElementTemplates=[],this.onlyCached=!1,Handlebars.registerHelper("ifsingular",this._ifsingular),Handlebars.registerHelper("ifplural",this._ifplural),Handlebars.registerHelper("ifzero",this._ifzero),Handlebars.registerHelper("loOption",this._loOption),Handlebars.registerHelper("ifEq",this._ifEq),Handlebars.templates={}},enableOnlyCachedMode:function(){this.onlyCached=!0},disableOnlyCachedMode:function(){this.onlyCached=!1},loadLayoutTemplate:function(name,success,stringTemplate){stringTemplate&&_.isString(stringTemplate)?success(this.dp.loadLayoutTemplateFromString(_.unescape(stringTemplate))):this.dp.loadLayoutTemplate(name).then(function($template){success($template)})},loadSkinTemplate:function(name,context,success,defaultTemplate){$.when(this._loadSkinTemplate(name,defaultTemplate)).then(function(template){success(template&&template(context||{})||"")})},render:function(name,context,defaultTemplate){return this.loadSkinTemplateSync(name,context,defaultTemplate)},loadSkinTemplateSync:function(name,context,defaultTemplate){var template=this._loadSkinTemplateSync(name,defaultTemplate);return template&&template(context||{})||""},loadContentElementTemplate:function(name,context){if(!name)return"";var template=this._loadContentElementTemplate(name);return _(context).each(function(key,value){this._replaceSubpart(template,key,value)},this),template},_loadSkinTemplateSync:function(name,defaultTemplate){var template;if(name)if(Handlebars.templates&&Handlebars.templates[name])template=Handlebars.templates[name];else{var precompiled=!1;template=this.dp.loadSkinTemplateSync(name,this.onlyCached),template||(template=this._loadPrecompiledEngineTemplate(name),precompiled=!!template),template||(template=defaultTemplate||""),precompiled||(template=Handlebars.compile(template)),Handlebars.templates[name]=template}else template=Handlebars.compile(defaultTemplate||"");return template},_loadSkinTemplate:function(name,defaultTemplate){return name?Handlebars.templates&&Handlebars.templates[name]?Handlebars.templates[name]:this.dp.loadSkinTemplate(name,this.onlyCached).then(function(template){var compiledTemplate=Handlebars.compile(template);return Handlebars.templates[name]=compiledTemplate,compiledTemplate},function(){var compiledTemplate=this._loadPrecompiledEngineTemplate(name);return compiledTemplate||(defaultTemplate=defaultTemplate||"",compiledTemplate=Handlebars.compile(defaultTemplate)),Handlebars.templates[name]=compiledTemplate,compiledTemplate}):Handlebars.compile(defaultTemplate||"")},_loadPrecompiledEngineTemplate:function(name){return A5.ENGINE_TEMPLATES&&A5.ENGINE_TEMPLATES[name]},_loadContentElementTemplate:function(tName){var mName="##"+tName+"##";if(void 0!==this.contentElementTemplates[mName])return this.contentElementTemplates[mName];var str=this._getSubpart(this.dp.contentElements,tName);return this.contentElementTemplates[tName]=str,str},_getSubpart:function(tmpl,tName){tName="##"+tName+"##";var pos_1=tmpl.indexOf(tName);if(-1==pos_1)return"";var pos_2=tmpl.indexOf("--\x3e",pos_1);if(-1==pos_2)return"";var pos_3=tmpl.indexOf(tName,pos_2);if(-1==pos_3)return"";var pos_4=tmpl.indexOf("--\x3e",pos_3);if(-1==pos_4)return"";var str=tmpl.substring(pos_2+3,pos_4);return pos_1=str.lastIndexOf("\x3c!--"),str=str.substring(0,pos_1)},_replaceSubpart:function(tmpl,sMarker,html){sMarker="##"+sMarker+"##";var re=new RegExp("\x3c!--[\\s\\w#]*"+sMarker+"[\\s\\w#]*--\x3e([\\w\\W]*)\x3c!--[\\s\\w#]*"+sMarker+"[\\s\\w#]*--\x3e","gi");return tmpl.replace(re,html)},_ifsingular:function(value,options){if(arguments.length<2)throw new Error("Handlebars Helper ifsingular needs 1 parameter");if(1==value)return options.fn(this)},_ifplural:function(value,options){if(arguments.length<2)throw new Error("Handlebars Helper ifplural needs 1 parameter");if(value>1)return options.fn(this)},_ifzero:function(value,options){if(arguments.length<2)throw new Error("Handlebars Helper ifzero needs 1 parameter");if(0==value)return options.fn(this)},_loOption:function(value,block){if(arguments.length<2)throw new Error("Handlebars Helper loOption needs 1 parameter");return a5.mainBuilder.options(!0)[value]()?block.fn(this):block.inverse(this)},_ifEq:function(v1,v2,block){return v1===v2?block.fn(this):block.inverse(this)}});function getAjaxData(param){var param2=param;if(A5&&A5.SKIN_ROOT&&param.substr(0,A5.SKIN_ROOT.length)==A5.SKIN_ROOT&&(param2=param.substr(A5.SKIN_ROOT.length)),A5.TEMPLATES&&A5.TEMPLATES[param])return A5.TEMPLATES[param];if(window.ajaxData&&(ajaxData[param]||ajaxData[param2])){return ajaxData[param]||ajaxData[param2]}}a5.service.Attachment={init:function(label,html,options,interaction,data){data=data||{},this.label=label,this.html=a5.preprocessor.applyToXMLText(html,interaction),this.options=options||{},this.interaction=interaction,this.customType=data.customType||"",this.modes=data.modes||[],this.userVisibility=data.userVisibility||"all",this.pinned=data.pinned||!1,this.showInHeader=data.showInHeader,this.type=this.getType(),this.pinnedInteractions=[],this.onAttachmentOpenListeners=new Listeners(this),this.$=$("<div>",{class:"attachment-wrapper"}),_.bindAll(this,"onClick","onInteractionReady"),this.render=_.once(this.render),this.onInteractionShowed=this.onInteractionShowed.bind(this)},pinTo:function(interaction){_.contains(this.pinnedInteractions,interaction)||this.pinnedInteractions.push(interaction),_.isEmpty(this.label)||interaction.$("a[href='#"+this.label+"']").on("click",this.onClick),interaction.bind("reset",this.onInteractionReset,this,{once:!0})},onClick:function(e){e.preventDefault(),$(e.currentTarget).addClass("visited"),e.stopPropagation(),this.open()},onInteractionShowed:function(interaction){this.pinned&&_.contains(this.pinnedInteractions,interaction)||this.close()},onInteractionReady:function(){a5.dp.config.responsiveAttachments&&this._setMediaResponsive()},onInteractionReset:function(interaction){this.close(),this.pinnedInteractions=_.without(this.pinnedInteractions,interaction),_.isEmpty(this.pinnedInteractions)&&(this.remove(),a5.callbacks.interaction.unbind("showed",this.onInteractionShowed))},getClass:function(){var classes=[this._getAttachmentClass(),this._getMediaClass()];return"dialog"===this.type&&classes.push(this._getDialogClass()),$.trim(classes.join(" "))},getType:function(){var type="dialog";return this.options.url?type="url":_.isUndefined(this.options.target)||"_blank"!==this.options.target?"platform"===this.options.target?type="platform":!1!==a5.dp.config.appendAttachmentTo&&(type="node"):type="window",type},render:function(){var $html=$("<div>").append(this.html);a5.service.Attachment.currentAttachment=this,this.interaction.buildModels(this.$,$html.contents()),delete a5.service.Attachment.currentAttachment,this.$.find(":first-child").attr("tabindex",0),this.$.addClass(this.getClass());var fn=this["_render"+_.str.capitalize(this.type)];_.isFunction(fn)&&fn.call(this),this.interaction.onInteractionReadyListeners.register(this.onInteractionReady),a5.callbacks.interaction.bind("showed",this.onInteractionShowed)},open:function(){var fn=this["_open"+_.str.capitalize(this.type)];_.isFunction(fn)&&fn.call(this),this.onAttachmentOpenListeners.callEach({})},close:function(){var fn=this["_close"+_.str.capitalize(this.type)];_.isFunction(fn)&&fn.call(this)},remove:function(){var fn=this["_remove"+_.str.capitalize(this.type)];_.isFunction(fn)&&fn.call(this)},_renderDialog:function(){var $dom=this.$,options={dialogClass:this.getClass(),title:this.label,autoOpen:!1,width:602,height:506,close:function(){a5.service.media.pause($dom)}},width=/.*width=(\d+).*/.exec(this.options.popup);width&&(options.width=parseInt(width[1],10));var height=/.*height=(\d+).*/.exec(this.options.popup);height&&(options.height=parseInt(height[1],10)),this.$.dialog(options),"Transcript"===this.label&&this.$.addClass("dialog_transcript"),this.$.find(".full_screen").on("click",function(){this.$.parent().find("button.ui-dialog-titlebar-close")[0].style.cssText="z-index: 1000 !important"}.bind(this))},_renderNode:function(){var $appendTo=$(a5.dp.config.appendAttachmentTo);this.$.hide(),$appendTo.append(this.$)},_openUrl:function(){a5.mainBuilder.engine.invoke("open-link",this.options.url,this.options.target)},_openWindow:function(){var url=A5.SKIN_URL+"popup.html",html=this.$.html(),label=this.label;window.a5_getPopupContent=function(win){var $body=$($(win.document).find("body")[0]);$body.html(html),$body.html($body.text()),$($(win.document).find("title")[0]).html(label)},a5.mainBuilder.engine.invoke("open-link",url,{target:"popupWin",settings:this.options.popup,focus:!0})},_openPlatform:function(){a5.mainBuilder.engine.invoke("open-attachment",this.$.html())},_openDialog:function(){this.$.dialog("open"),this.options.top&&this.options.left&&this.$.dialog("widget").css({top:this.options.top+"px",left:this.options.left+"px"}),a5.mainBuilder.curInteraction.trigger("interaction:dialog:display")},_openNode:function(){this.$.show()},_closeDialog:function(){this.$.dialog("close")},_closeNode:function(){a5.service.media.pause(this.$),this.$.hide()},_removeDialog:function(){this.$.dialog("destroy"),this.$.remove()},_removeNode:function(){this.$.remove()},_isAudioOnly:function(){var $audio=this.$.find(".audio");return 1===$audio.length&&$audio.text().trim()===this.$.text().trim()},_isVideoOnly:function(){var $video=this.$.find(".video");return 1===$video.length&&$video.text().trim()===this.$.text().trim()},_getMediaClass:function(){var mediaClass="";return this._isAudioOnly()?mediaClass="attachment-audio-only":this._isVideoOnly()&&(mediaClass="attachment-video-only"),mediaClass},_getDialogClass:function(){return"attachment-popup"},_getAttachmentClass:function(){return this.options.klass||""},_setMediaResponsive:function(){this.$.find("img, .v_a_media, .the_video, [poster], .image-as-trigger").css("width","").css("height","")}},Obj.extend("a5.service.Attachment"),a5.service.media.by_id={},function(a5,_,$){function findAudiosAndCall(verb){return function($dom){$dom&&(_.each($dom.find("*[data-playable-media]"),function(node){a5.service.media.by_id[$(node).attr("data-playable-media")][verb]()}),_.each($dom.find("*[data-audio-uid]"),function(node){var playable=$(node).data("view-updater");playable&&playable.audio&&playable.audio[verb]()}))}}function findFirstAudio($dom){var $node=$dom.find("*[data-playable-media], *[data-audio-uid]");return a5.service.media.by_id[$node.attr("data-playable-media")]}a5.service.media.stop=findAudiosAndCall("stop"),a5.service.media.play=findAudiosAndCall("play"),a5.service.media.pause=findAudiosAndCall("pause"),a5.service.media.find=findFirstAudio}(a5,_,jQuery),a5.service.media.pauseAll=function(){a5.service.media.audio.pauseAll(),a5.service.media.tts_audio.pauseAll(),_.each(a5.speaking_recording.LNRInstances,function(lnr){lnr.stopAll()}),_.each(a5.speaking_recording.playAllInstances,function(playAll){playAll.stopAll()}),a5.service.media.video.pauseAll()},a5.service.media.pauseAllExcept=function(except){a5.service.media.audio.pauseAllExcept(except),a5.service.media.tts_audio.pauseAllExcept(except),_.each(a5.speaking_recording.LNRInstances,function(lnr){lnr.stopAllExcept(except)}),_.each(a5.speaking_recording.playAllInstances,function(playAll){playAll.stopAllExcept(except)}),a5.service.media.video.pauseAllExcept(except)},a5.service.media.supportsGetUserMedia=function(){return"https:"===window.location.protocol&&!!navigator.mediaDevices&&!!navigator.mediaDevices.getUserMedia},a5.service.media.audio_manager={VOLUME_MAX:1,VOLUME_MIN:0},a5.service.media.audio_manager.Creator={init:function(initParams){if(this.__ready=!1,this._readyDfd=$.Deferred(),this.buildUrl=initParams.urlBuilder||function(x){return x},this.preferOga=initParams.preferOga,this.formats=initParams.formats,$.browser.msie){var _buildUrl=this.buildUrl;this.buildUrl=function(a,b){return _buildUrl.apply(this,arguments)+"?ts="+Number(new Date)}}this._ready()},ready:function(){return this._readyDfd.promise()},_ready:function(){this.__ready=!0,this._readyDfd.resolve(),this.trigger("ready")},create:function(id,params){return params=_.extend({preferOga:this.preferOga,formats:this.formats,preferHtml5:!0,persistVolume:!1},params),params.nativeAudio?new a5.service.media.audio_manager.NativeAudio(id,this,params):new a5.service.media.audio_manager.Audio(id,this,params)},bind:function(name,callback,context,options){_.each(name.split(" "),function(event){"ready"==event&&this.__ready&&callback.apply(context)},this),this._super(name,callback,context,options)},pauseAll:function(){this.trigger("dopause")},pauseAllExcept:function(except){this.trigger("dopause",except)},stopAll:function(){this.trigger("dostop")},stopAllPlaying:function(){this.trigger("dostopplaying")}},Obj.extend("a5.service.media.audio_manager.Creator"),a5.service.media.audio_manager.Audio={init:function(id,creator,params){this.uid="ID_"+id+"_"+Math.floor(1e5*Math.random()),this.creator=creator,params=params||{},params.dontStop&&(this.dontStop=!0),params.type&&(this.type=params.type),this.persistVolume=params.persistVolume;var urls;if(params.url)urls="string"!=typeof params.url?params.url:[params.url];else{urls=[];var formats=params.formats;params.preferOga&&formats.indexOf("oga")>0&&a5.utils.array.move(formats,formats.indexOf("oga"),0),_.each(formats,function(format){params.buildUrl?urls.push(params.buildUrl(id,format)):urls.push(this.creator.buildUrl(id,format))},this)}urls=_(urls).map(function(url){return url.replace(/\.s3-website-[^.]*./i,".s3.")});var soundOptions={src:urls,html5:!!params.preferHtml5,onpause:_.bind(this._paused,this),onplay:_.bind(this._start,this),onplayerror:_.bind(this._onPlayError,this),onload:_.bind(this._loaded,this),onloaderror:_.bind(this._onLoadError,this),onstop:_.bind(this._stopped,this),onend:_.bind(this._ended,this),volume:this._initVolume(),preload:params.preload,format:this.type};this.audioObject=new Howl(soundOptions),this.isLoaded=!(!1===params.preload),this.dontStop||(creator.bind("dopause",_.bind(this.doPause,this)),creator.bind("dostop",_.bind(this.doStop,this)),creator.bind("dostopplaying",_.bind(this.doStopPlaying,this))),a5.service.media.by_id[this.uid]=this},doPause:function(except){except!==this&&this.isLoaded&&this.pause()},doStop:function(){this.isLoaded&&(this.pause(),this.position(0),this._stopped())},doStopPlaying:function(){this.isLoaded&&this.isPlaying()&&(this.pause(),this.position(0),this._stopped())},_start:function(){this.isStopped=!1,this.isPaused=!1,this._error=!1,this.trigger("start"),requestAnimationFrame(this._progress.bind(this))},_stopped:function(){this.isStopped||(this.isStopped=!0,this.trigger("stopped"))},_ended:function(){this.isStopped||(this.isStopped=!0,this.trigger("stopped"),this.trigger("seeked",0))},_loaded:function(){this.trigger("loadprogress")},_onLoadError:function(){this.audioObject.stop(),this._error=!0,this.trigger("error")},_onPlayError:function(){this.audioObject.stop(),this._error=!0,this.trigger("error")},_progress:function(){if(!this.isStopped){var playLock=this.audioObject._playLock;this.audioObject._playLock=!1;var seek=1e3*this.audioObject.seek()||0;this.audioObject._playLock=playLock,this.trigger("progress",Math.round(seek)),this.isPlaying()&&this.trigger("playing"),this.isPaused||requestAnimationFrame(this._progress.bind(this))}},_paused:function(){this.isPaused=!0,this.trigger("paused")},_initVolume:function(){var volume=a5.service.media.audio_manager.VOLUME_MAX;if(this.persistVolume)try{localStorage&&localStorage.volume&&parseFloat(localStorage.volume)<a5.service.media.audio_manager.VOLUME_MAX&&(volume=parseFloat(localStorage.volume))}catch(e){logger.warn(e)}return volume},load:function(){this.isLoaded||(this.audioObject.load(),this.isLoaded=!0)},play:function(){this.audioObject.play()},rate:function(rate){this.audioObject.rate(rate)},pause:function(){this.audioObject.pause()},position:function(milliseconds){if(_.isUndefined(milliseconds)){var playLock=this.audioObject._playLock;this.audioObject._playLock=!1;var seek=1e3*this.audioObject.seek();return this.audioObject._playLock=playLock,seek}return this.duration()>milliseconds&&(this.audioObject.seek(milliseconds/1e3),this.trigger("seeked",Math.max(milliseconds,0)),!0)},stop:function(){this.audioObject.stop()},volume:function(value){if(!_.isUndefined(value)){if(this.audioObject.volume(value),this.persistVolume)try{localStorage.setItem("volume",value)}catch(e){logger.warn(e)}this.trigger("volume",this.audioObject.volume())}return this.audioObject.volume()},duration:function(){return 1e3*(this.audioObject._sounds[0]._node.duration||this.audioObject.duration())},append:function($html){},isPlaying:function(){return this.audioObject.playing()},isPaused:function(){return!this.audioObject.playing()&&this.audioObject.seek()>0},hasError:function(){return this._error}},Obj.extend("a5.service.media.audio_manager.Audio"),a5.service.media.audio_manager.NativeAudio={init:function(id,creator,params){this.uid="ID_"+id+"_"+Math.floor(1e5*Math.random()),this.creator=creator,params=params||{},params.dontStop&&(this.dontStop=!0),params.type&&(this.type=params.type);var urls;if(params.url)urls="string"!=typeof params.url?params.url:[params.url];else{urls=[];var formats=params.formats;params.preferOga&&formats.indexOf("oga")>0&&a5.utils.array.move(formats,formats.indexOf("oga"),0),_.each(formats,function(format){params.buildUrl?urls.push(params.buildUrl(id,format)):urls.push(this.creator.buildUrl(id,format))},this)}urls=_(urls).map(function(url){return url.replace(/\.s3-website-[^.]*./i,".s3.")}),this.audioObject=$("<audio controls>"),_.each(urls,function(url){this.audioObject.append("<source src='"+url+"'></source>")},this),this.audioObject.on("play",_.bind(function(){this.trigger("start")},this)),this.audioObject.on("pause",_.bind(function(){this.trigger("stopped")},this)),this.dontStop||(creator.bind("dopause",_.bind(this.doPause,this)),creator.bind("dostop",_.bind(this.doStop,this)),creator.bind("dostopplaying",_.bind(this.doStopPlaying,this))),a5.service.media.by_id[this.uid]=this},pause:function(){this.audioObject.get(0).pause()},doPause:function(except){except!==this&&this.audioObject.get(0).pause()},doStop:function(){this.audioObject.get(0).pause(),this.audioObject.get(0).currentTime=0},isPlaying:function(){return!this.audioObject.get(0).paused},doStopPlaying:function(){this.isLoaded&&this.isPlaying()&&this.doStop()},load:function(){this.audioObject.get(0).load()},play:function(){this.audioObject.get(0).play()}},Obj.extend("a5.service.media.audio_manager.NativeAudio"),a5.service.media.tts_audio_manager={},a5.service.media.tts_audio_manager.Creator={init:function(options){this.buildURL=options.urlBuilder},trim:function(text){return text=$("<span>"+text+"</span>").text().replace(/[\n\s]+/gm," "),text=text.replace(/^[\W]+$/g," "),text.trim()},create:function(text){return""!=(text=this.trim(text))&&(text=this.runTTSMapping(text),logger.info("TTS Create audio:",text),this.url=this.buildURL(text),new a5.service.media.tts_audio_manager.Audio(this.url,this))},runTTSMapping:function(text){var map=this.getTTSMap(),result=text;return _.each(map,function(rule){var type=rule[0],search=rule[1],replacement=rule[2];try{"regex"==type&&(result=result.replace(new RegExp(search,"g"),replacement)),"word"==type&&(result=result.replace(new RegExp("\\b"+search+"\\b","g"),replacement)),"string"==type&&(result=result.replace(new RegExp(search,"g"),replacement))}catch(e){logger.info("Skipped invalid tts rule: "+rule.join("**"))}},this),result},getTTSMap:function(){var options=["455","456","457"],list=[];return _.each(options,function(option){var rules=null;if(rules=a5.mainBuilder.curInteraction.options.getValue(option),"on"==a5.mainBuilder.curInteraction.options.get(option))try{rules&&rules.trim()&&(rules=a5.utils.b64DecodeUnicode(rules).split("\n")),list.push(_.filter(_.map(rules,this.__parseTTSValue)))}catch(e){logger.warn("Error parsing TTS Map from Option: "+option)}},this),list.length&&(list=_.flatten(list,!0),list.reverse(),list=_.uniq(list,function(rule){return rule[1]}),list.reverse()),list},__parseTTSValue:function(ttsRule){var match=ttsRule.match(/(regex|word|string)\*\*(.+)\*\*(.+)/);if(match)return[match[1],match[2],match[3]]},pauseAll:function(){this.trigger("pause")},pauseAllExcept:function(except){this.trigger("pause",except)},stopAll:function(){this.trigger("stop")},stopAllExcept:function(except){this.trigger("stop",except)}},Obj.extend("a5.service.media.tts_audio_manager.Creator"),a5.service.media.tts_audio_manager.Audio={init:function(url,creator){this.url=url,this.creator=creator},_create_element:function(){this.audio_node=document.createElement("audio"),this.audio_node.preload=!1,this.audio_node.src=this.url,this._bind_events()},_bind_events:function(){$(this.audio_node).on("ended",_.bind(function(){this.trigger("playback-end")},this)),$(this.audio_node).on("play",_.bind(function(){this.trigger("playback-start")},this)),$(this.audio_node).on("pause",_.bind(function(){this.trigger("playback-pause")},this)),this.creator.bind("pause",_.bind(function(except){except!==this&&(this.pause(),this.trigger("playback-end"))},this)),this.creator.bind("stop",_.bind(function(except){except!==this&&(this.stop(),this.trigger("playback-end"))},this))},play:function(){_.isUndefined(this.audio_node)&&this._create_element(),this.creator.stopAllExcept(this),this.audio_node.play()},pause:function(){this.audio_node.pause()},stop:function(){this.audio_node.pause(),_.isNaN(this.audio_node.duration)||(this.audio_node.currentTime=0)},position:function(){this.audio_node.played.end()},volume:function(value){this.audio_node.volume=value},duration:function(){return this.audio_node.seekable.end()},append:function($html){}},Obj.extend("a5.service.media.tts_audio_manager.Audio"),a5.service.media.video_manager={},a5.service.media.video_manager.Creator={init:function(initParams){this.buildUrl=initParams.urlBuilder||function(x){return x},videojs.options.flash.swf=initParams.url,this.preferWebm=initParams.preferWebm,this.formats=initParams.formats},create:function(id,$target,params){return new a5.service.media.video_manager.Video(id,$target,this,params)},bind:function(name,callback,context,options){_.each(name.split(" "),function(event){"ready"==event&&callback.apply(context)},this),this._super(name,callback,context,options)},pauseAll:function(){this.trigger("dopause")},pauseAllExcept:function(except){this.trigger("dopause",except)}},Obj.extend("a5.service.media.video_manager.Creator"),a5.service.media.video_manager.Video={init:function(id,$target,creator,params){if(this.id=id,this.tagId="element_"+id+"_"+Math.round(999999*Math.random()),this.creator=creator,this.$target=$target,this._onKeyupInFullscreen=this._onKeyupInFullscreen.bind(this),params&&params.url)this.$video=$('<video id="'+this.tagId+'" class="video-js vjs-default-skin" playsinline><source src="'+params.url+'" /></video>');else{var formats=this.creator.formats;this.creator.preferWebm&&formats.indexOf("webm")>0&&a5.utils.array.move(formats,formats.indexOf("webm"),0);var sources=_.map(formats,function(format){return _.str.sprintf('<source src="%s" type="video/%s" />',this.creator.buildUrl(this.id,format),format)},this);sources=_(sources).map(function(source){return source.replace(/\.s3-website-[^.]*./i,".s3.")}),this.$video=$('<video id="'+this.tagId+'" class="video-js vjs-default-skin" playsinline>'+sources.join("")+"</video>")}params&&params.poster&&this.$video.attr("poster",this.creator.buildUrl(params.poster,"thumb.jpeg")),this.$target.append(this.$video),this.video=videojs(this.$video.get(0),{controls:!1,preload:$("body").is(".isChrome")?"metadata":"auto",width:this.$target.width(),height:this.$target.height(),techOrder:["html5","flash"],html5:{el:this.$video.get(0)}},_.bind(function(){_.defer(_.bind(function(){this.trigger("ready")},this))},this)),this.video.on("play",_.bind(this._start,this)),this.video.on("pause",_.bind(this._paused,this)),this.video.on("ended",_.bind(this._ended,this)),this.video.on("durationchange",_.bind(this._durationchange,this)),this.video.on("canplaythrough",_.bind(this._canplaythrough,this)),this.video.on("canplay",_.bind(this._canplay,this)),this._bindStartingTime(),this.video.on("progress",_.bind(this._loadprogress,this)),this.video.on("volumechange",_.bind(this._volume,this)),this.video.on("fullscreenchange",_.bind(this._fullscreen,this));var lastMoveX,lastMoveY;this.video.on("mousemove",function(e){e.clientX===lastMoveX&&e.clientY===lastMoveY||(lastMoveX=e.clientX,lastMoveY=e.clientY,this.video.reportUserActivity())}.bind(this)),creator.bind("dopause",_.bind(this.doPause,this)),a5.service.media.by_id[this.tagId]=this,this.$target.attr("data-playable-media",this.tagId)},doPause:function(except){except!==this&&this.pause()},_bindStartingTime:function(){var ua=a5.utils.parseUserAgent();ua.isIOS||ua.isIpadOS||ua.isSafari?this.bind("canplay",this._cansetstartingtime,this):this.bind("durationchange",this._cansetstartingtime,this)},_onKeydownInFullscreen:function(e){27===e.keyCode&&e.stopPropagation()},_onKeyupInFullscreen:function(e){27===e.keyCode&&(e.stopPropagation(),this.cancelFullscreen())},_fullscreen:function(event){if(!event.composed){var isFullscreen=this.video.isFullscreen();isFullscreen?(document.addEventListener("keydown",this._onKeydownInFullscreen,!0),document.addEventListener("keyup",this._onKeyupInFullscreen,!0)):(document.removeEventListener("keydown",this._onKeydownInFullscreen,!0),document.removeEventListener("keyup",this._onKeyupInFullscreen,!0)),this.trigger("fullscreenchange",isFullscreen)}},_volume:function(){this.trigger("volume",this.video.volume())},_start:function(){this.trigger("start"),requestAnimationFrame(this._progress.bind(this))},_ended:function(){this.stop(),logger.log("video ended")},_loadprogress:function(){this.trigger("loadprogress")},_progress:function(){if(this.isPlaying()){var seek=1e3*this.video.currentTime()||0;this.trigger("progress",Math.round(seek)),this.trigger("playing"),requestAnimationFrame(this._progress.bind(this))}},_paused:function(){this.trigger("paused")},_durationchange:function(){this.trigger("durationchange")},_canplaythrough:function(){this.trigger("canplaythrough")},_canplay:function(){this.trigger("canplay")},_cansetstartingtime:function(){this.trigger("cansetstartingtime")},load:function(){this.video.load()},play:function(){this.video.play()},pause:function(){this.video.isReady_&&this.video.pause()},position:function(milliseconds){return _.isUndefined(milliseconds)?1e3*this.video.currentTime():this.duration()>milliseconds?(this.video.currentTime(milliseconds/1e3),this.trigger("seeked",Math.max(milliseconds,0)),!0):void 0},stop:function(){this.position(0),this.pause()},volume:function(value){return this.video.volume(value)},duration:function(){return 1e3*this.video.duration()},fullscreen:function(){this.video.requestFullscreen()},cancelFullscreen:function(){this.video.exitFullscreen()},append:function($html){$(this.video.el()).append($html)},isFullscreen:function(){return this.video.isFullscreen()},isPlaying:function(){return!this.video.paused()},adjustSize:function(){this.video.dimensions(this.$target.width(),this.$target.height())}},Obj.extend("a5.service.media.video_manager.Video"),a5.service.media.recorder_manager={},a5.service.media.recorder_manager.AudioRecorder={init:function(){},instance:function(){return this.recorder},ready:function(){return this._ready||(this._ready=$.Deferred(),this._initAudioRecorder()),this._ready.promise()},_initAudioRecorder:function(){window.recordingAPI?this.recorder=new ExternalAudioRecorder:a5.service.media.supportsGetUserMedia()?this.recorder=new HTML5AudioRecorder:/android|ipad|iphone|ipod|qtwebengine/.test(navigator.userAgent.toLowerCase())?this.recorder=new DummyAudioRecorder:this.recorder=new FlashAudioRecorder,this._ready.resolve()}},Obj.extend("a5.service.media.recorder_manager.AudioRecorder"),Obj.extend("ExternalAudioRecorder",{init:function(){this.audios={},this.urls={},_.bindAll(this,"buildUrlForSource")},record:function(id){return this.currentRecording=new a5.service.recorder.ExternalRecording(this,id),this.currentRecording},_convertToBlob:function(url){var deferred=$.Deferred(),xhr=new XMLHttpRequest;return xhr.addEventListener("load",function(){200==xhr.status||0==xhr.status?deferred.resolve(xhr.response):deferred.reject()}),xhr.open("GET",url),xhr.responseType="blob",xhr.send(null),deferred.promise()},recordingDone:function(filename,encode,url){encode?this._convertToBlob(url).done(_.bind(function(blob){this.audios[filename]={url:url,blob:blob},this.currentRecording.recordingDone()},this)):this.currentRecording.recordingDone()},upload:function(filename){var data=new FormData;data.append("recording",this.audios[filename].blob);var deferred=$.Deferred();return $.ajax({type:"POST",data:data,contentType:!1,processData:!1,url:A5.TOOLBELT_URL+"/audio-manipulator/upload",success:_.bind(function(data){this.urls[filename]=data.filename,this.audios[filename].blob=null,deferred.resolve()},this)}),deferred.promise()},createSource:function(filename){return a5.service.media.audio.create(filename,{buildUrl:this.buildUrlForSource,type:"wav",preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())})},buildUrlForSource:function(filename){return this.audios[filename].url},buildUrl:function(filename){return this.urls[filename]},checkSupport:function(){},checkMic:function(){return!0}}),
Obj.extend("a5.service.recorder.ExternalRecording",{init:function(recorder,id){this.id=id,this.recorder=recorder,this.filename=null,this.beep=new Howl({src:A5.ENGINE_ROOT+"audios/beep.wav",html5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())})},start:function(){window.recordingAPI.start(this.id,_.bind(function(url){this.url=url,this.connected(url),this.beep.on("end",_.bind(function(){setTimeout(_.bind(function(){window.recordingAPI.record(this.id),this.recording=!0},this),300)},this)),this.beep.play()},this))},stop:function(){window.recordingAPI.stop(_.bind(function(){this.recorder.recordingDone(this.filename,this.recording,this.url),this.recording=!1},this))},connected:function(filename){this.filename=filename||a5.utils.createUID(),this.trigger("start",this.filename)},recordingDone:function(){this.trigger("recorded")}}),Obj.extend("FlashAudioRecorder",{errorTemplate:"a5.view.dialog.RecordingError",flashRequiredTemplate:"a5.view.dialog.FlashRequired",init:function(){if("undefined"==typeof portableApp){this.micEnabled=!1,this.uploadURL=this._buildUploadURL();var flashParams="flash_serv_rtmp=rtmp://{DOMAIN}/oflaDemo/&amp;flash_serv_rtmpt=rtmpt://{DOMAIN}:80/oflaDemo/&amp;fileGateway==http://{DOMAIN}/deleteAudio.jsp?action=delete&file=&beep=1";flashParams=flashParams.replace(/{DOMAIN}/g,A5.RECORDING_RTMP_SERVER),$("body").append('<div id="js_recorder_div" style="position:absolute; bottom: 0; z-index: 0; overflow:hidden; width:0px; height:0px;"><object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="220" height="140" id="js_recorder" align="middle"><param name="allowScriptAccess" value="always" /><param name="wmode" value="window"></param><param name="allowFullScreen" value="false" /><param name="movie" value="'+A5.ENGINE_ROOT+'lib/third-party/lnr-recorder/js_recorder.swf" /><param name="quality" value="high" /><param name="bgcolor" value="#ffffff" /><param name="scale" value="noscale" /><param name="salign" value="TL" /><param name="flashvars" value="'+flashParams+'" /><embed flashvars="'+flashParams+'" scale="noscale" salign="TL" src="'+A5.ENGINE_ROOT+'lib/third-party/lnr-recorder/js_recorder.swf" quality="high" bgcolor="#ffffff" width="220" height="140" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" name="js_recorder" wmode="window"/></object></div>'),this.recorder=document.js_recorder}},_buildUploadURL:function(){return window.location.protocol+"//"+A5.RECORDING_RTMP_SERVER+"/oflaDemo/tos3?file={FILE}&downloadable=true"},isFlashSupported:function(){if($("body").is(".isChrome"))return!0;var version="0,0,0";try{version=new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version").replace(/\D+/g,",").match(/^,?(.+),?$/)[1]}catch(e){try{navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin&&(version=(navigator.plugins.namedItem("Shockwave Flash 2.0")||navigator.plugins.namedItem("Shockwave Flash")).description.replace(/\D+/g,",").match(/^,?(.+),?$/)[1])}catch(err){logger.error(err)}}return version.split(",")[0]>9},showWarning:function(){if(!this.warningDisplayed){var html=a5.service.templates.render(this.flashRequiredTemplate);$(html).dialog({modal:!0,close:_.bind(function(){this.warningDisplayed=!1},this)}),this.warningDisplayed=!0}},showError:function(){if(!this.warningDisplayed){var html=a5.service.templates.render(this.errorTemplate);$(html).dialog({modal:!0,dialogClass:"recording-error",close:_.bind(function(){this.warningDisplayed=!1},this)}),this.warningDisplayed=!0}},showSettings:function(){var pos=$("#activity").offset(),left=parseInt($("#activity").css("width"),10)/2+pos.left-110;$("#js_recorder_div").css("z-Index",1e3),$("#js_recorder_div").css("width","220px"),$("#js_recorder_div").css("height","140px"),$("#js_recorder_div").css("left",left+"px"),$("#js_recorder_div").css("top","200px")},showMicSettings:function(){try{this.recorder.recAction("show_mic_settings"),this.showSettings()}catch(e){this.showWarning()}},showFlashSettings:function(){try{this.recorder.recAction("show_settings"),this.showSettings()}catch(e){this.showWarning()}},checkMic:function(){return!!this.micEnabled||(this.showFlashSettings(),!1)},hideFlash:function(){$("#js_recorder_div").css("z-Index",0),$("#js_recorder_div").css("width","0px"),$("#js_recorder_div").css("height","0px"),$("#js_recorder_div").css("top","0px")},record:function(){return this.currentRecording=new a5.service.recorder.FlashRecording(this),this.currentRecording},playerReady:function(micEnabled){this.micEnabled=micEnabled},micStatus:function(micEnabled){this.micEnabled=micEnabled,this.hideFlash()},connected:function(filename){this.currentRecording.connected(filename)},recordingDone:function(){this.currentRecording.recordingDone()},error:function(){this.showError()},upload:function(filename){return this.uploadToS3Delayed(filename)},uploadToS3Delayed:function(filename){var deferred=$.Deferred();return _.delay(this.uploadToS3.bindTo(this),700,filename,deferred),deferred.promise()},uploadToS3:function(filename,deferred){var image=new Image;image.onerror=_.bind(function(){deferred.resolve()},this),image.src=this.uploadURL.replace(/{FILE}/g,filename)},createSource:function(filename){var audio=a5.service.media.audio.create("r5_"+filename,{preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())});return audio.bind("error",function(){this.showError()},this),audio},buildUrl:function(filename){return a5.service.media.audio.buildUrl("r5_"+filename,"mp3")},checkSupport:function(){this.isFlashSupported()||this.showWarning()}});function connected(val,filename){_.defer(function(){a5.service.media.audio_recorder.instance().connected(filename)})}function micStatus(micEnabled){_.defer(function(){a5.service.media.audio_recorder.instance().micStatus(micEnabled)})}function closeFlash(){_.defer(function(){a5.service.media.audio_recorder.instance().hideFlash()})}function player_ready(micEnabled){_.defer(_.bind(function(){a5.service.media.audio_recorder.instance().playerReady(micEnabled)}))}function recording_done(){a5.service.media.audio_recorder.instance().recordingDone()}function error(val){_.defer(function(){a5.service.media.audio_recorder.instance().error()})}Obj.extend("a5.service.recorder.FlashRecording",{init:function(recorder){this.recorder=recorder,this.filename=null},start:function(){try{_.delay(_.bind(function(){this.recorder.recorder.recAction("start_recording",1)},this),1e3)}catch(e){this.recorder.showWarning()}},stop:function(){try{_.delay(_.bind(function(){this.recorder.recorder.recAction("stop_recording",1)},this),700)}catch(e){this.recorder.showWarning()}},connected:function(filename){this.filename=filename,this.trigger("start",filename)},recordingDone:function(){this.trigger("recorded")}}),Obj.extend("HTML5AudioRecorder",{micTemplate:"a5.view.dialog.MicNotFound",errorTemplate:"a5.view.dialog.RecordingError",init:function(){this.audios={};try{window.AudioContext=window.AudioContext||window.webkitAudioContext,window.URL=window.URL||window.webkitURL,logger.log("navigator.mediaDevices.getUserMedia "+(navigator.mediaDevices.getUserMedia?"available.":"not present!"))}catch(e){logger.warn("No web audio support in this browser!")}},record:function(){return new a5.service.recorder.HTML5Recording(this)},upload:function(filename){var data=new FormData;data.append("recording",this.audios[filename]);var deferred=$.Deferred();return this.audios[filename]?$.ajax({type:"POST",data:data,contentType:!1,processData:!1,url:A5.TOOLBELT_URL+"/audio-manipulator/upload",success:_.bind(function(data){this.audios[filename]=null,deferred.resolve(data.filename)},this),error:_.bind(function(xhr,ajaxOptions,thrownError){this.showError(),deferred.reject()},this)}):(this.showError(),deferred.reject()),deferred.promise()},createSource:function(filename){var audio=a5.service.media.audio.create("r5_"+filename,{preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())});return audio.bind("error",function(){this.showError()},this),audio},buildUrl:function(filename){return a5.service.media.audio.buildUrl("r5_"+filename,"mp3")},showWarning:function(){if(!this.warningDisplayed){var html=a5.service.templates.render(this.micTemplate);$(html).dialog({modal:!0,dialogClass:"mic-notfound",close:_.bind(function(){this.warningDisplayed=!1},this)}),this.warningDisplayed=!0}},showError:function(){if(!this.warningDisplayed){var html=a5.service.templates.render(this.errorTemplate);$(html).dialog({modal:!0,dialogClass:"recording-error",close:_.bind(function(){this.warningDisplayed=!1},this)}),this.warningDisplayed=!0}},checkSupport:function(){},checkMic:function(){return navigator.mediaDevices.getUserMedia({audio:!0}).then(function(stream){logger.log("Mic present.")}).catch(function(err){logger.warn("No live audio input: "+err),this.showWarning()}.bind(this))}}),Obj.extend("a5.service.recorder.HTML5Recording",{init:function(parent){this.parent=parent,this.filename=null,this.audioContext=new AudioContext,logger.log("Audio context set up.");var config={bufferLen:4096,numChannels:2,mimeType:"audio/wav",context:this.audioContext};config.processor=(this.audioContext.createScriptProcessor||this.audioContext.createJavaScriptNode).call(this.audioContext,config.bufferLen,config.numChannels,config.numChannels),this.recorder=new Recorder(config),logger.log("Recorder initialised."),this.beep=new Howl({src:A5.ENGINE_ROOT+"audios/beep.wav",html5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())})},gotMicStream:function(stream){this.audioContext.createMediaStreamSource(stream).connect(this.recorder.node),logger.log("Media stream created.")},requestMic:function(){navigator.mediaDevices.getUserMedia({audio:!0}).then(function(stream){this.gotMicStream(stream),this.record()}.bind(this)).catch(function(err){logger.warn("No live audio input: "+err),this.parent.showWarning()}.bind(this))},encode:function(callback){this.recorder.exportWAV(callback)},start:function(){this.filename=a5.utils.createUID(),this.requestMic(),this.trigger("start",this.filename)},record:function(){this.beep.on("end",_.bind(function(){setTimeout(_.bind(function(){this.recorder.record(),this.recording=!0},this),200)},this)),this.beep.play()},stop:function(){this.recorder.stop(),this.recording?this.encode(function(blob){URL.createObjectURL(blob);this.parent.audios[this.filename]=blob,this.end()}.bind(this)):this.end(),this.recording=!1},end:function(){this.recorder.clear(),"closed"!==this.audioContext.state?this.audioContext.close().then(function(){logger.log("Audio context closed"),this.trigger("recorded")}.bind(this)):this.trigger("recorded")}}),Obj.extend("DummyAudioRecorder",{unsupportedTemplate:"a5.view.dialog.UnsupportedDevice",showWarning:function(){if(!this.warningDisplayed){var html=a5.service.templates.render(this.unsupportedTemplate);$(html).dialog({modal:!0,close:_.bind(function(){this.warningDisplayed=!1},this)}),this.warningDisplayed=!0}},checkSupport:function(){this.showWarning()},checkMic:function(){this.showWarning()},record:function(){this.showWarning()}}),a5.service.media.SpeechToText={init:function(){_.bindAll(this,"_request","_parseResult")},convert:function(inputs,clips){return this._request(inputs,clips).then(this._parseResult)},_request:function(inputs,clips){var data={input:inputs.map(function(input){return a5.utils.startsWith(input,"//")?"http:"+input:input}),clips:clips};return $.ajax({type:"POST",data:JSON.stringify(data),url:A5.TOOLBELT_URL+"/audio-manipulator/speech-to-text",contentType:"application/json"})},_parseResult:function(data){var ret={text:"",confidence:0},results=data.results||[];return results.length>0&&(ret.text=results[0].alternatives[0].transcript,ret.confidence=results[0].alternatives[0].confidence),ret}},Obj.extend("a5.service.media.SpeechToText"),function(a5,Obj,$){a5.service.scroll.API={init:function(){this.findAPI()},findAPI:function(){try{var current=window;do{if(current=current.parent,"object"==typeof current.scrollAPI){this.API=current.scrollAPI;break}}while(current.parent!==window.top)}catch(e){}},hasAPI:function(){return!!this.API},getVisibleTop:function(){return this.API.getVisibleTop()},getVisibleLeft:function(){return this.API.getVisibleLeft()},getVisibleBottom:function(){return this.API.getVisibleBottom()},getVisibleRight:function(){return this.API.getVisibleRight()},scrollTopBy:function(top){this.API.scrollTopBy(top)},scrollLeftBy:function(left){this.API.scrollLeftBy(left)}},Obj.extend("a5.service.scroll.API"),a5.service.scroll.APIClient=new a5.service.scroll.API,$.ui.plugin.add("draggable","scroll",{drag:function(event){if(a5.service.scroll.APIClient.hasAPI()){var i=$(this).data("ui-draggable"),o=i.options;if(i.scrollParent[0]!==document&&i.scrollParent[0]!==document.body&&"HTML"!==i.scrollParent[0].tagName)return;o.axis&&"x"===o.axis||(event.pageY-a5.service.scroll.APIClient.getVisibleTop()<o.scrollSensitivity?a5.service.scroll.APIClient.scrollTopBy(-o.scrollSpeed):a5.service.scroll.APIClient.getVisibleBottom()-event.pageY<o.scrollSensitivity&&a5.service.scroll.APIClient.scrollTopBy(o.scrollSpeed)),o.axis&&"y"===o.axis||(event.pageX-a5.service.scroll.APIClient.getVisibleLeft()<o.scrollSensitivity?a5.service.scroll.APIClient.scrollLeftBy(-o.scrollSpeed):a5.service.scroll.APIClient.getVisibleRight()-event.pageX<o.scrollSensitivity&&a5.service.scroll.APIClient.scrollLeftBy(o.scrollSpeed))}}})}(a5,Obj,jQuery),a5.model_builder.Syllabify={isResponsible:function(node,interaction){return node.is("textEntryInteraction")&&"Identify:Mark:Syllabify"==interaction.identifier},buildTextEntryInteraction:function(interaction,parentNode,node){var response=node.attr("responseIdentifier"),syllables=interaction.getAllResponseDeclaration();syllables&&syllables[response]&&(syllables=syllables[response]);var model=new a5.models.interaction.SyllabifyWord({correctResponse:syllables,tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainLock:interaction.options.tryAgainIsLock(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),tts_audio:interaction.options.gaptextaudioIsTrue()});model.assignAnswerFeedback(node),interaction.blockItems.add(model);var view=new a5.view.interaction.Syllabify(model);$(parentNode).append(view.render())}},a5.model_builder.Base.extend("a5.model_builder.Syllabify"),a5.model_builder.builders.push(new a5.model_builder.Syllabify),a5.model_builder.DragDropUtils={isResponsible:function(node,interaction){var isObj=node.is("object[type*=audio]"),omGapText="Order:Match:Text gap"==interaction.identifier&&node.parent().is("gapText"),omPairs="Order:Match:Pairs"==interaction.identifier&&node.parent().is("simpleAssociableChoice"),osSorting="Order:Sort:Sorting"==interaction.identifier&&node.parent().is("simpleAssociableChoice"),osSequence="Order:Sequence:Sequence"==interaction.identifier&&node.parent().is("simpleChoice"),omTextGapLAO="Order:Match:Text gap (Label an object)"==interaction.identifier&&node.parent().is("gapText");return isObj&&(omGapText||omPairs||osSorting||osSequence||omTextGapLAO)},buildObject:function(interaction,parentNode,node){var ID=node.attr("data"),UID=ID+"_"+a5.utils.createUID(),playButton=$('<div class="drag_audio_player inactive" data-audio-uid="'+UID+'"></div>');parentNode.addClass("has_audio_attached"),parentNode.append(playButton);var gapfillBehavior=this.getGapfillBehavior(interaction);a5.service.media.audio.bind("ready",function(){var viewUpdater=new a5.model_builder.dragDropUtils.ViewUpdater(ID,UID,interaction.options.audioiconbehaviourIsPause(),gapfillBehavior,interaction);playButton.data("view-updater",viewUpdater),playButton.attr("data-has-view-updater","true"),_.defer(_.bind(viewUpdater.ready,viewUpdater))},this)},getGapfillBehavior:function(interaction){var behavior=interaction.options.getGapfillbehaviour();return"tap_item"===behavior?behavior="drag":"tap_target"===behavior&&"mobile"===a5.dp.config.gapfillBehaviourApplicable&&a5.utils.isDocumentOverMobileBreakpoint()&&(behavior="drag"),behavior.split("_")[0]}},a5.model_builder.Base.extend("a5.model_builder.DragDropUtils"),a5.model_builder.builders.push(new a5.model_builder.DragDropUtils),Obj.extend("a5.model_builder.dragDropUtils.ViewUpdater",{init:function(ID,UID,hasPauseBehaviour,gapfillBehavior,interaction){this.UID=UID,this.hasPauseBehaviour=hasPauseBehaviour,this.interactionBehavior=gapfillBehavior,this.status="loading",this.audio=a5.service.media.audio.create(ID,{preload:!a5.dp.config.audioPreloadDisabled}),a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(this.audio),this.audio.bind("stopped",function(){this.stop()},this),this.audio.bind("paused",function(){hasPauseBehaviour||this.audio.stop()},this)},update:function(){var players=$("[data-audio-uid='"+this.UID+"']");players.off("click"),players.removeClass("playing inactive"),players.toggleClass("show-pause-on-playing",this.hasPauseBehaviour),"ready"===this.status?players.on("click",_.bind(this.play,this)):"playing"===this.status?players.on("click",_.bind(this.pause,this)):players.on("click",_.bind(function(e){this.stopPropagation(e)},this)),"playing"===this.status?players.addClass("playing"):"loading"===this.status&&players.addClass("inactive")},ready:function(){this.status="ready",this.update()},play:function(evt){$(evt.target).is(".no-play")?$(evt.target).removeClass("no-play"):($(".playbutton").removeClass("playing"),$(".drag_audio_player").removeClass("playing"),a5.service.media.pauseAllExcept(this.audio),this.audio.play(),this.status="playing",this.update()),this.stopPropagation(evt)},pause:function(evt){this.audio.pause(),this.status="ready",this.update(),this.stopPropagation(evt)},stop:function(){this.status="ready",this.update()},stopPropagation:function(evt){"drag"===this.interactionBehavior&&(evt.preventDefault(),evt.stopPropagation())}}),a5.model_builder.OMTextGapBuilder={isResponsible:function(node,interaction){return"Order:Match:Text gap"==interaction.identifier&&"Trainer"!==LOInfo.mode&&"Exam"!==LOInfo.mode&&(node.is("gapMatchInteraction")||node.is("#contentblock")||node.is("gap")&&this.isBuildingGapMatchInteraction||node[0].nodeType==Node.TEXT_NODE||node[0].tagName&&("br"==node[0].tagName.toLowerCase()||"p"==node[0].tagName.toLowerCase()))},buildGapMatchInteraction:function(interaction,parentNode,node){if(this.isBuildingGapMatchInteraction)throw"cannot nest gapMatchInteractions";this.isBuildingGapMatchInteraction=!0,this.contentblockCount=0,this.gapCount=0;var choiceNodes=this.fetchChoices(interaction,node,"> gapText, > gapImg"),gapsToGroup={};_(choiceNodes).each(function(choiceNode){var $choiceNode=$(choiceNode),text=$choiceNode.text(),choiceId=$choiceNode.attr("id"),group=$choiceNode.attr("group")||!1;gapsToGroup[choiceId]=group,!group&&_.str.contains(text,"##")&&(group=text.split("##").pop(),gapsToGroup[choiceId]=group,_(choiceNodes).each(function(choice){$(choice).attr("id")===choiceId&&$(choice).attr("group",group)}),$choiceNode.text(function(){return $(this).text().replace("##"+group,"")}))}),this.choices=_(choiceNodes).map(function(choiceNode){var $choiceNode=$(choiceNode),text=$choiceNode.text();return text=_.first(text.split("##")),text=text||$choiceNode.find("img[data-mathml]").data("mathml")||$choiceNode.find("img[src]").attr("src")||$choiceNode.find('object[type="audio/audio"]').attr("data"),[$choiceNode.attr("identifier"),text]});var gapMatchInteractionModel=new a5.models.interaction.GapMatchInteraction({parent:interaction,responses:interaction.getCorrectResponse(node.attr("responseIdentifier")),answers:this.choices,stacks:parseInt(interaction.options.getPoolStacks(),10),poolAlphabeticalOrder:interaction.options.poolorderIsAlphabetical(),poolAlignment:interaction.options.getPoolAlignment(),freeDragLocation:interaction.options.getFreeDragLocation(),subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),allowRepeat:interaction.options.repeatAnswersIsAllow(),groupsMap:gapsToGroup,gapsOption:interaction.options.getGaps(),multiDest:interaction.options.getMultipleDestinations(),hasOrderedResponses:!interaction.options.orderDependencyIsOff()}),classNames="";this.gapMatchInteractionModel=gapMatchInteractionModel,interaction.options.hasResourceBanks()?classNames=this.buildResourceDragElements(interaction):(_(choiceNodes).each(function(choiceNode,index){this.buildGapTextImage(interaction,choiceNode,gapMatchInteractionModel,gapMatchInteractionModel.getStackFor(index))},this),interaction.options.poolorderIsAlphabetical()&&gapMatchInteractionModel.sortPoolByText(),interaction.options.poolorderIsNatural()&&gapMatchInteractionModel.naturalsortPoolByText(),interaction.options.randomiseanswersIsTrue()&&gapMatchInteractionModel.randomizePool());var gapMatchInteractionView,classes=this._getClasses(interaction,gapMatchInteractionModel);gapMatchInteractionView=new a5.views.interaction[classes.viewClass](gapMatchInteractionModel,null,{interaction:interaction,gapsOption:interaction.options.getGaps(),wordpoolElementClass:classes.wordpoolElementClass,elementClass:this.getElementClass(),classNames:classNames});var $gapMatchInteractionNode=gapMatchInteractionView.render();gapMatchInteractionView.hide(),parentNode.append($gapMatchInteractionNode),parentNode.addInteractionStyle("drag-drop"),interaction.options.displayascompletedIsOn()&&parentNode.addInteractionStyle("display-as-completed"),interaction.options.multipleDestinationsIsOne()||parentNode.addInteractionStyle("multiple-destinations"),this.buildContents(node,interaction,gapMatchInteractionView.wordpool.block,"gapText, gapImg"),gapMatchInteractionModel.targetDropAreas.forEach(function(t){if(t.prefilled){var correct=t.getCorrect(),dragArea=null;_.some(gapMatchInteractionModel.poolDropAreas,function(d){if(d.drag===correct)return dragArea=d,!0}),t.drop(dragArea.drag),dragArea.copyOnDrag||(gapMatchInteractionModel.setPrefilled(dragArea),dragArea.prefilled&&dragArea.undrop())}}),interaction.items.getScores=gapMatchInteractionModel.getScores.bind(gapMatchInteractionModel),interaction.blockItems.add(gapMatchInteractionModel);var adjustAndShow=function(){gapMatchInteractionView.adjustGapSizes(),gapMatchInteractionView.show()};interaction.bind("show:deferred",adjustAndShow,this);var onWindowResize=_.throttle(function(){gapMatchInteractionView.adjustGapSizes()},300);$(window).on("resize",onWindowResize),interaction.bind("reset",function(){interaction.unbind("show:deferred",adjustAndShow),$(window).off("resize",onWindowResize)},this),this.isBuildingGapMatchInteraction=!1,this.gapMatchInteractionModel=null},_getClasses:function(interaction,gapMatchInteractionModel){var wordpoolClassSufix=this._isInteractionDragAndDrop(interaction)?"":"NoDrop";return interaction.options.hasResourceBanks()?{viewClass:"GapMatchResourcesView",wordpoolElementClass:"GapMatchGapTextNoDropView"}:gapMatchInteractionModel.hasStacks()?{viewClass:"GapMatchWithStacksView",wordpoolElementClass:"GapMatchStack"+wordpoolClassSufix+"View"}:{viewClass:"GapMatchView",wordpoolElementClass:"GapMatchGapText"+wordpoolClassSufix+"View"}},getElementClass:function(){return"om-textgap-element"},buildGapTextImage:function(interaction,node,gapMatchInteractionModel,stackAreaModel){var $choiceNode=$(node),gaptextaudio=interaction.options.gaptextaudioIsTrue()&&!$choiceNode.is("gapImg"),answer=this.buildContents($choiceNode,interaction),dragElementModel=new a5.models.interaction.DragElement({content:answer,identifier:$choiceNode.attr("identifier"),clickclick:interaction.options.useClickClickIsTrue(),gaptextaudio:gaptextaudio,behavior:this._getGapfillBehavior(interaction),overflowOnDrag:interaction.options.freeDragLocationIsBetween_letters()||interaction.options.freeDragLocationIsBetween_words()});if(dragElementModel.assignAnswerFeedback($choiceNode),gapMatchInteractionModel.addDragElement(dragElementModel),interaction.options.multipleDestinationsIsOne()||_.contains(this.gapMatchInteractionModel.getUniqueAnswers(),dragElementModel.identifier)){var dropAreaModel=new a5.models.interaction.DropArea({copyOnDrag:!interaction.options.multipleDestinationsIsOne(),drag:dragElementModel,resident:dragElementModel,dropIndicator:interaction.options.dropIndicatorIsTrue()});interaction.options.multipleDestinationsIsOne()||(dropAreaModel.allowed=[dragElementModel]),dragElementModel.home=dropAreaModel,stackAreaModel&&(dragElementModel.home=stackAreaModel,stackAreaModel.drags.push(dragElementModel)),gapMatchInteractionModel.addPoolDropArea(dropAreaModel)}},buildResourceDragElements:function(interaction){var banks=this._getBanks(interaction).getPreselectedBanks();return _.each(banks,function(bank){this._buildResourceBank(bank,interaction)},this),banks.map(function(bank){return"resource-bank-"+bank.id}).join(" ")},_getBanks:function(interaction){var allBanks=_(a5.dp.resourceBanks).map(function(bank){return new a5.model.ResourceBank(bank,this)},this);return new a5.model.ResourceBankList({availableBanks:this._getAvailableBanks(interaction),allBanks:allBanks})},_getAvailableBanks:function(interaction){var availableBanks=[];try{availableBanks=$.parseJSON(interaction.options.getResourceBanks()).items}catch(e){}return availableBanks},_buildResourceBank:function(bank,interaction){_.each(bank.items,function(item){item instanceof a5.model.ResourceBankGroup?this._buildResourceBankGroup(item,interaction):this._buildResourceBankItem(item,interaction,this._buildResourceDragElement)},this)},_buildResourceBankGroup:function(group,interaction){_.each(group.items,function(item){this._buildResourceBankItem(item,interaction,this._buildResourceDragElement)},this)},_buildResourceBankItem:function(item,interaction,onRender){if(item instanceof a5.model.ResourceComposedBankItem)return this._buildResourceComposedBankItem(item);var resourceBankItem=new a5.view.ResourceBankItem({item:item,interaction:interaction});resourceBankItem.bind("render",onRender.bind(this,resourceBankItem)),resourceBankItem.render()},_buildResourceDragElement:function(resource){var dropAudio=resource.item.audio&&this._buildAudio(resource.item.id,resource.item.audio),dragElementModel=new a5.models.interaction.DragElement({content:$('<div class="content">').append(resource.$el),identifier:this._getIdentifierFor(resource.item.name),behavior:"tap_item",dropAudio:dropAudio}),dropAreaModel=new a5.models.interaction.DropArea({copyOnDrag:!0,drag:dragElementModel,resident:dragElementModel});dragElementModel.home=dropAreaModel,this.gapMatchInteractionModel.addDragElement(dragElementModel),this.gapMatchInteractionModel.addPoolDropArea(dropAreaModel)},_buildResourceComposedBankItem:function(item,interaction){var resourceComposedBankItem=new a5.view.ResourceComposedBankItem({item:item,interaction:interaction});resourceComposedBankItem.bind("render",function(){_.each(item.composite,function(child){this._buildResourceBankItem(child,resourceComposedBankItem,function(resource){resourceComposedBankItem.$el.append(resource.$el)})},this),this._buildResourceDragElement(resourceComposedBankItem)},this),resourceComposedBankItem.render()},_getIdentifierFor:function(name){var found=_.find(this.choices,function(choice){return a5.utils.checkUserInput(name,choice[1])});return found?found[0]:name},_buildAudio:function(id,audio){var src;return src="string"==typeof audio?A5.SKIN_URL+audio:_.map(audio,function(src){return A5.SKIN_URL+src}),a5.service.media.audio.create(id,{url:src})},buildGap:function(interaction,parentNode,node){var insertBetweenWords=interaction.options.freeDragLocationIsBetween_words(),gapModel=new a5.models.interaction.Gap({identifier:node.attr("identifier"),enumeration:interaction.enumAnswers.next(),globalEnumeration:a5.mainBuilder.options(!0).continuousEnumerationIsOn(),prefilled:interaction.options.prefillIsFirstitem()&&0==this.gapCount||interaction.options.prefillIsFirstblock()&&0==this.contentblockCount,existing:"home",dropIndicator:interaction.options.dropIndicatorIsTrue(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),allowRepeat:interaction.options.repeatAnswersIsAllow(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),blockNumber:this.contentblockCount,capitalize:interaction.options.automaticcapitalisationIsOn(),hasOrderedResponses:!interaction.options.orderDependencyIsOff(),hasOrderedResponsesFirstAnswer:interaction.options.orderDependencyIsFirst_answer(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),inputStyle:node.attr("style")});this.gapMatchInteractionModel.addTargetDropArea(gapModel);var insertGapAtEnd=!1;this.prevIsGap||this.prevChar&&(this._isPunctuationChar(this.prevChar)||this._isSpaceChar(this.prevChar)?this.glueNode=this._createAndAppendGlueNodeTo(parentNode):insertGapAtEnd=insertBetweenWords&&(!node[0].nextSibling||!$(node[0].nextSibling).is("gap")&&node[0].nextSibling.nodeType!==Node.TEXT_NODE));var viewClass=this._isInteractionDragAndDrop(interaction)?"GapMatchGapView":"GapMatchGapNoDropView",gapView=new a5.views.interaction[viewClass](gapModel,null,{capitalizeGap:this.capitalize,elementClass:this.getElementClass()});this.capitalize=!1,parentNode.find(this.glueNode).length||(this.glueNode=this._createAndAppendGlueNodeTo(parentNode)),this.glueNode.append(gapView.render()),insertGapAtEnd&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode)),this.gapCount+=1,this.prevIsGap=!0,a5.callbacks.interaction.bind("loaded",function(i){i===interaction&&this.addWordClasses(gapView.node,".drop_area")},this)},buildBr:function(interaction,parentNode,node){this._buildBRBr(interaction,parentNode,node)},buildBR:function(interaction,parentNode,node){this._buildBRBr(interaction,parentNode,node)},_buildBRBr:function(interaction,parentNode,node){parentNode.append($("<br>")),this.prevIsGap=!1,this.prevChar=null,this.glueNode=null},buildDiv:function(interaction,parentNode,node){var $contentblock=$('<div class="contentblock"></div>');$contentblock.addClass(node.attr("class")),this._buildEnumBlock(interaction,$contentblock),parentNode.append($contentblock),this.prevIsGap=!1,this.prevChar=null,this.capitalize=!0,this.contentblockCount&&!a5.mainBuilder.options(!0).continuousEnumerationIsOn()&&interaction.enumAnswers.ready().then(function(){interaction.enumAnswers.reset()}),this.buildContents(node,interaction,$contentblock),this.contentblockCount++},buildP:function(interaction,parentNode,node){this.capitalize=!0,(new a5.model_builder.Element).build(interaction,parentNode,node)},_buildEnumBlock:function(interaction,parentNode,node){interaction.enumBlock&&interaction.enumBlock.useEnum()&&(parentNode.append('<span class="enumblock-placeholder"></span>'),parentNode.attr("tabindex",-1),interaction.enumBlock.next().then(function(enumSymbol){parentNode.find(".enumblock-placeholder").replaceWith(enumSymbol),parentNode.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}))},buildTextNode:function(interaction,parentNode,node){var text=node[0].textContent;if(text.replace(/\s+/g," ").trim().length>0&&this.isBuildingGapMatchInteraction&&!node.parents("gapText").length){var chars=_.str.chars(text),initialBlanks=!0;_(chars).each(function(c,index){initialBlanks=initialBlanks&&this._isSpaceChar(c),0===index&&this._buildFirstChar(c,interaction,parentNode),index>0&&(this._buildChar(chars[index-1],c,interaction,parentNode,index),index!==chars.length-1||node[0].nextSibling&&($(node[0].nextSibling).is("gap")||node[0].nextSibling.nodeType===Node.TEXT_NODE)||this._buildLastChar(c,interaction,parentNode)),this.prevChar=c,initialBlanks||(this.prevIsGap=!1)},this)}else parentNode.is("table")||(this.isBuildingGapMatchInteraction&&!node.parents("gapText").length&&(this.prevIsGap=!1,this.prevChar=" ",this.glueNode=null),parentNode.append(text))},_createAndAppendGapTo:function(interaction,parentNode){var gapModel=new a5.models.interaction.OMTextGapSpaceGap({
existing:"home",dropIndicator:interaction.options.dropIndicatorIsTrue(),capitalize:interaction.options.automaticcapitalisationIsOn()});this.gapMatchInteractionModel.addTargetDropArea(gapModel);var viewClass=this._isInteractionDragAndDrop(interaction)?"GapMatchGapView":"GapMatchGapNoDropView";parentNode.append(new a5.views.interaction[viewClass](gapModel,null,{capitalizeGap:this.capitalize,elementClass:this.getElementClass()}).render()),this.capitalize=!1},_buildChar:function(prev,cur,interaction,parentNode,index){var glueNode,insertBetweenWords=interaction.options.freeDragLocationIsBetween_words(),insertBetweenLetters=interaction.options.freeDragLocationIsBetween_letters();switch(!0){case this._isSpaceChar(prev)&&this._isSpaceChar(cur):this.glueNode=null;break;case this._isSpaceChar(prev)&&this._isPunctuationChar(cur):insertBetweenWords&&!this.prevIsGap&&(glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,glueNode)),this.glueNode=this._createAndAppendGlueNodeTo(parentNode);break;case this._isSpaceChar(prev)&&this._isWordChar(cur):insertBetweenWords&&(this.prevIsGap||(glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,glueNode)),parentNode.append(" ")),this.glueNode=this._createAndAppendGlueNodeTo(parentNode),insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode);break;case this._isWordChar(prev)&&this._isSpaceChar(cur):insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode),this.glueNode=null;break;case this._isWordChar(prev)&&this._isPunctuationChar(cur):insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode),insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode));break;case this._isWordChar(prev)&&this._isWordChar(cur):insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode);break;case this._isPunctuationChar(prev)&&this._isSpaceChar(cur):this.glueNode=null;break;case this._isPunctuationChar(prev)&&this._isPunctuationChar(cur):this.glueNode=null,insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode));break;case this._isPunctuationChar(prev)&&this._isWordChar(cur):insertBetweenWords&&(glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,glueNode)),this.glueNode=this._createAndAppendGlueNodeTo(parentNode),insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode)}this.glueNode?this.glueNode.append(cur):parentNode.append(cur),this._isPunctuationChar(cur)&&!this.capitalize?this.capitalize=this._isEndOfSentence(cur):this._isSpaceChar(cur)||this._isPunctuationChar(cur)||(this.capitalize=!1)},_createGlueNode:function(){return $('<span class="glue-wrap"></span>')},_createAndAppendGlueNodeTo:function(parentNode){var glueNode=this._createGlueNode();return parentNode.append(glueNode),glueNode},_createAndPrependGlueNodeTo:function(parentNode){var glueNode=this._createGlueNode();return parentNode.prepend(glueNode),glueNode},_isPunctuationChar:function(c){return/[.,:;?!()"'ââ]/.test(c)},_isSpecialChar:function(c){return/\W/.test(c)&&!this._isSpaceChar(c)&&!this._isPunctuationChar(c)},_isWordChar:function(c){return/\w/.test(c)||this._isSpecialChar(c)},_isSpaceChar:function(c){return/\s/.test(c)},_isEndOfSentence:function(c){return _.contains([".","!","?"],c)},_isStartOfSentence:function(c){return this.capitalize&&_.contains(['"',"'","â","â"],c)},_buildFirstChar:function(cur,interaction,parentNode){var glueNode,insertBetweenWords=interaction.options.freeDragLocationIsBetween_words(),insertBetweenLetters=interaction.options.freeDragLocationIsBetween_letters();switch(!0){case this._isSpaceChar(cur):parentNode.append(cur);break;case this._isPunctuationChar(cur):this.prevIsGap?(this.prevChar&&this._isWordChar(this.prevChar)&&insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode)),parentNode.find(this.glueNode).length||(this.glueNode=this._createAndAppendGlueNodeTo(parentNode)),this.glueNode.append(cur)):(insertBetweenWords&&(!this.prevChar||this._isPunctuationChar(this.prevChar)||this._isWordChar(this.prevChar))&&(glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,glueNode)),parentNode.append(cur));break;case this._isWordChar(cur):this.prevIsGap||(!insertBetweenWords||this.prevChar&&!this._isPunctuationChar(this.prevChar)||(glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,glueNode)),this.glueNode=this._createAndAppendGlueNodeTo(parentNode),insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode)),parentNode.find(this.glueNode).length||(this.glueNode=this._createAndAppendGlueNodeTo(parentNode)),this.glueNode.append(cur)}this._isSpaceChar(cur)||(this.capitalize=this._isEndOfSentence(cur)||this._isStartOfSentence(cur))},_buildLastChar:function(cur,interaction,parentNode){var insertBetweenWords=interaction.options.freeDragLocationIsBetween_words(),insertBetweenLetters=interaction.options.freeDragLocationIsBetween_letters();switch(!0){case this._isSpaceChar(cur):insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode));break;case this._isPunctuationChar(cur):this.capitalize||(this.capitalize=this._isEndOfSentence(cur)),insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode));break;case this._isWordChar(cur):insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode),insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode))}},_isInteractionDragAndDrop:function(interaction){return"drag"===this._getGapfillBehavior(interaction)},_getGapfillBehavior:function(interaction){if(interaction.options.hasResourceBanks())return"tap_item";var behavior=interaction.options.getGapfillbehaviour();return"tap_item"!==behavior&&"tap_target"!==behavior||"mobile"===a5.dp.config.gapfillBehaviourApplicable&&a5.utils.isDocumentOverMobileBreakpoint()&&(behavior="drag"),behavior}},a5.model_builder.Base.extend("a5.model_builder.OMTextGapBuilder"),a5.model_builder.builders.push(new a5.model_builder.OMTextGapBuilder),a5.model_builder.OMNumberPyramid={isResponsible:function(node,interaction){return"Order:Match:Number pyramid"===interaction.identifier&&(node.is("gapMatchInteraction")||node.is("#contentblock")||node.is("gap")&&this.isBuildingGapMatchInteraction||node.is(".pyramid-display-number")||node[0].nodeType==Node.TEXT_NODE||node[0].tagName&&"br"==node[0].tagName.toLowerCase())},buildDiv:function(interaction,parentNode,node){node.is("#contentblock")?(this.index=0,this._super(interaction,parentNode,node)):this._buildDisplayNumber(interaction,parentNode,node)},_buildDisplayNumber:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-pyramid"));var $display=this.buildContents(node,interaction,$("<span>"));$display.addClass("pyramid-display-number"),$display.addClass(this._indexToPyramidClass(this.index)),parentNode.find(".number-pyramid").append($display),this.index++},_buildGap:function(interaction,parentNode,node){var gapModel=new a5.models.interaction.Gap({identifier:node.attr("identifier"),enumeration:interaction.enumAnswers.next(),globalEnumeration:a5.mainBuilder.options(!0).continuousEnumerationIsOn(),prefilled:interaction.options.prefillIsFirstitem()&&0==this.gapCount||interaction.options.prefillIsFirstblock()&&0==this.contentblockCount,existing:"home",dropIndicator:interaction.options.dropIndicatorIsTrue(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),allowRepeat:interaction.options.repeatAnswersIsAllow(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),blockNumber:this.contentblockCount,capitalize:interaction.options.automaticcapitalisationIsOn(),hasOrderedResponses:interaction.options.orderDependencyIsOn()});this.gapMatchInteractionModel.addTargetDropArea(gapModel);var gapView=new a5.views.interaction.GapMatchGapView(gapModel,null,{elementClass:this.getElementClass()});parentNode.append(gapView.render()),this.gapCount+=1,a5.callbacks.interaction.bind("loaded",function(i){i===interaction&&this.addWordClasses(gapView.node,".drop_area")},this)},buildGap:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-pyramid")),this._buildGap(interaction,parentNode.find(".number-pyramid"),node),parentNode.find(".gap_match_gap_view, .prefilled").last().addClass(this._indexToPyramidClass(this.index)),this.index++},getElementClass:function(){return"om-number-pyramid-element"},_indexToPyramidClass:function(index){return"pyramid-"+["top","left","right","center","bottom-left","bottom","bottom-right"][index]},_createAndAppendGlueNodeTo:function(parentNode){return parentNode}},a5.model_builder.OMTextGapBuilder.extend("a5.model_builder.OMNumberPyramid"),a5.model_builder.builders.push(new a5.model_builder.OMNumberPyramid),a5.model_builder.OMTextGapExamsBuilder={isResponsible:function(node,interaction){return"Order:Match:Text gap"==interaction.identifier&&("Trainer"==LOInfo.mode||"Exam"==LOInfo.mode)&&(node.is("gapMatchInteraction")||node.is("gap")&&this.isBuildingGapMatchInteraction)},buildGap:function(interaction,parentNode,node){var gapModel=new a5.models.interaction.Gap({identifier:node.attr("identifier"),enumeration:interaction.enumAnswers.next(),globalEnumeration:a5.mainBuilder.options(!0).continuousEnumerationIsOn(),prefilled:interaction.options.prefillIsFirstitem()&&0==this.gapCount||interaction.options.prefillIsFirstblock()&&0==this.contentblockCount,existing:"home",dropIndicator:interaction.options.dropIndicatorIsTrue(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect()});this.gapMatchInteractionModel.addTargetDropArea(gapModel);var gapView=new a5.views.interaction.GapMatchGapExamsView(gapModel),$gapViewNode=gapView.render();parentNode.append($gapViewNode),0==interaction.blockItems.itemList.length&&interaction.bind("show:deferred",function(){$gapViewNode.focus()}),interaction.bind("update-status-to-input",function(){gapView.updateToInput()}),this.gapCount+=1},buildGapMatchInteraction:function(interaction,parentNode,node){if(this.isBuildingGapMatchInteraction)throw"cannot nest gapMatchInteractions";this.isBuildingGapMatchInteraction=!0,this.gapCount=0;var choiceNodes=this.fetchChoices(interaction,node,"> gapText, > gapImg"),choices=_(choiceNodes).map(function(choiceNode){var $choiceNode=$(choiceNode),text=$choiceNode.text()||$choiceNode.find("img[data-mathml]").data("mathml")||$choiceNode.find("img[src]").attr("src")||$choiceNode.find('object[type="audio/audio"]').attr("data");return[$choiceNode.attr("identifier"),text]}),gapMatchInteractionModel=new a5.models.interaction.GapMatchInteraction({parent:interaction,responses:interaction.getCorrectResponse(node.attr("responseIdentifier")),answers:choices,poolAlignment:interaction.options.getPoolAlignment()});_(choiceNodes).each(function(choiceNode,index){this.buildGapTextImage(interaction,choiceNode,gapMatchInteractionModel)},this);var gapMatchInteractionView=new a5.views.interaction.GapMatchExamsView(gapMatchInteractionModel,null,interaction.options.getGaps(),interaction.options.gaptextaudioIsTrue()),$gapMatchInteractionNode=gapMatchInteractionView.render();parentNode.append($gapMatchInteractionNode),parentNode.addInteractionStyle("drag-drop"),this.gapMatchInteractionModel=gapMatchInteractionModel,this.buildContents(node,interaction,gapMatchInteractionView.wordpool.block,"gapText, gapImg"),interaction.blockItems.add(gapMatchInteractionModel),interaction.bind("show:deferred",gapMatchInteractionView.adjustGapSizes,gapMatchInteractionView,{once:!0}),this.isBuildingGapMatchInteraction=!1,this.gapMatchInteractionModel=null},buildGapTextImage:function(interaction,node,gapMatchInteractionModel){var $choiceNode=$(node),gaptextaudio=interaction.options.gaptextaudioIsTrue()&&!$choiceNode.is("gapImg"),answer=this.buildContents($choiceNode,interaction),dragElementModel=new a5.models.interaction.DragElement({content:answer,identifier:$choiceNode.attr("identifier"),clickclick:interaction.options.useClickClickIsTrue(),gaptextaudio:gaptextaudio});dragElementModel.assignAnswerFeedback($choiceNode);var dropAreaModel=new a5.models.interaction.DropArea({copyOnDrag:!interaction.options.multipleDestinationsIsOne(),drag:dragElementModel,resident:dragElementModel,dropIndicator:interaction.options.dropIndicatorIsTrue()});dropAreaModel.allowed=[dragElementModel],dragElementModel.home=dropAreaModel,gapMatchInteractionModel.addDragElement(dragElementModel),gapMatchInteractionModel.addPoolDropArea(dropAreaModel)}},a5.model_builder.Base.extend("a5.model_builder.OMTextGapExamsBuilder"),a5.model_builder.builders.push(new a5.model_builder.OMTextGapExamsBuilder),a5.model_builder.GraphicGapMatchInteraction={isResponsible:function(node,interaction){return"Order:Match:Text gap (Label an object)"===interaction.identifier&&(a5.utils.hasTag(node,"graphicGapMatchInteraction")||this.isBuildingGraphicGapMatchInteraction&&a5.utils.hasTag(node,"object")&&["image/jpeg","image/png"].contains(node.attr("type")))},buildGraphicGapMatchInteraction:function(interaction,parentNode,node){if(this.isBuildingGraphicGapMatchInteraction)throw"cannot nest gapMatchInteractions";this.isBuildingGraphicGapMatchInteraction=!0,_.isUndefined(this.activities[interaction.identifier])&&(this.activities[interaction.identifier]={}),_.isUndefined(this.activities[interaction.identifier][interaction.index])&&(this.activities[interaction.identifier][interaction.index]={}),this.gapCount=0;var choiceNodes=this.fetchChoices(interaction,node,"> gapText, > gapImg"),choices=[],choiceNodesWithDistractors=[];_.each(choiceNodes,function(choiceNode,index){var $choiceNode=$(choiceNode).clone(),answer_and_distractors=this._findAnswerAndDistractors($choiceNode);_.each(answer_and_distractors,function($answer,index){index>0&&$answer.attr("identifier",identifier+"-DISTRACTOR-"+index);var identifier=$answer.attr("identifier"),text=$answer.text()||$answer.find("img[data-mathml]").data("mathml")||$answer.find("img[src]").attr("src")||$answer.find('object[type="audio/audio"]').attr("data");choices.push([identifier,text]),choiceNodesWithDistractors.push($answer)})},this),choiceNodes=choiceNodesWithDistractors;var model=new a5.models.interaction.GraphicGapMatchInteraction({parent:interaction,responses:interaction.getCorrectResponse(node.attr("responseIdentifier")),answers:choices,stacks:parseInt(interaction.options.getPoolStacks(),10),poolAlphabeticalOrder:interaction.options.poolorderIsAlphabetical(),poolAlignment:interaction.options.getPoolAlignment(),poolRandomized:interaction.options.randomiseanswersIsTrue()});_.each(node.children("associableHotspot"),function(associableHotspot){var delimeter,$associableHotspot=$(associableHotspot);$associableHotspot.attr("coords").indexOf(",")>=0&&(delimeter=","),$associableHotspot.attr("coords").indexOf(":")>=0&&(delimeter=":");var gapModel=new a5.models.interaction.Gap({identifier:$associableHotspot.attr("identifier"),enumeration:interaction.enumAnswers.next(),prefilled:interaction.options.prefillIsFirstitem()&&0===this.gapCount,position:$associableHotspot.attr("coords").split(delimeter),existing:"home",dropIndicator:interaction.options.dropIndicatorIsTrue(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),inputStyle:$associableHotspot.attr("style"),arrow:$associableHotspot.attr("arrow")});model.addTargetDropArea(gapModel),this.gapCount+=1},this),interaction.options.multipleDestinationsIsOne()||(choiceNodes=_.filter(choiceNodes,function(choiceNode){var answers=model.getUniqueAnswers();return _.contains(answers,$(choiceNode).attr("identifier"))})),_.each(choiceNodes,function(choiceNode,index){this.buildGapTextImage(interaction,choiceNode,model,model.getStackFor(index))},this),interaction.options.poolorderIsAlphabetical()&&model.sortPoolByText(),interaction.options.poolorderIsNatural()&&model.naturalsortPoolByText(),interaction.options.randomiseanswersIsTrue()&&model.randomizePool();var viewClass,wordpoolElementClass,wordpoolClassSufix=this._isInteractionDragAndDrop(interaction)?"":"NoDrop";model.hasStacks()?(viewClass="GraphicGapMatchWithStacksView",wordpoolElementClass="GapMatchStack"+wordpoolClassSufix+"View"):(viewClass="GraphicGapMatchView",wordpoolElementClass="GapMatchGapText"+wordpoolClassSufix+"View");var blockElementClass="GraphicGapMatchGap"+wordpoolClassSufix+"View",view=new a5.views.interaction[viewClass](model,null,{wordpoolElementClass:wordpoolElementClass,blockElementClass:blockElementClass,elementClass:this.getElementClass(),gapsOption:interaction.options.getGaps()});parentNode.append(view.node),view.render(),parentNode.addInteractionStyle("drag-drop"),interaction.options.multipleDestinationsIsOne()||parentNode.addInteractionStyle("multiple-destinations"),this.activities[interaction.identifier][interaction.index]={model:model,view:view},this.buildContents(node,interaction,view.wordpool.block,"gapText, gapImg, associableHotspot"),model.targetDropAreas.forEach(function(t){if(t.prefilled){var correct=t.getCorrect(),dragArea=null;_.some(model.poolDropAreas,function(d){if(d.drag===correct)return dragArea=d,!0}),t.drop(dragArea.drag),dragArea.copyOnDrag||dragArea.drag.copyOnDrag||(dragArea.undrop(),dragArea.setPrefilled())}}),interaction.blockItems.add(model),this.isBuildingGraphicGapMatchInteraction=!1},buildObject:function(interaction,parentNode,node){var activity=this.activities[interaction.identifier][interaction.index],styles=node.attr("style")||"",size={width:parseFloat(a5.utils.getStyleValue(styles,"width")),height:parseFloat(a5.utils.getStyleValue(styles,"height"))};(new a5.model_builder.ObjectImage).build(interaction,parentNode,node),activity.model.setImageSize(size),activity.view.setImage()},getElementClass:function(){return"om-textgap-label-an-object-element"},buildGapTextImage:function(interaction,node,graphicGapMatchInteractionModel,stackAreaModel){var $choiceNode=$(node),answer=this.buildContents($choiceNode,interaction),gaptextaudio=interaction.options.gaptextaudioIsTrue()&&!$choiceNode.is("gapImg"),dragElementModel=new a5.models.interaction.DragElement({content:answer,gaptextaudio:gaptextaudio,behavior:this._getGapfillBehavior(interaction),identifier:$choiceNode.attr("identifier"),clickclick:interaction.options.useClickClickIsTrue()});dragElementModel.assignAnswerFeedback($choiceNode);var dropAreaModel=new a5.models.interaction.DropArea({copyOnDrag:!interaction.options.multipleDestinationsIsOne(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),drag:dragElementModel,resident:dragElementModel,dropIndicator:interaction.options.dropIndicatorIsTrue()});interaction.options.multipleDestinationsIsOne()||(dropAreaModel.allowed=[dragElementModel]),dragElementModel.home=dropAreaModel,stackAreaModel&&(dragElementModel.home=stackAreaModel,stackAreaModel.drags.push(dragElementModel)),graphicGapMatchInteractionModel.addDragElement(dragElementModel),graphicGapMatchInteractionModel.addPoolDropArea(dropAreaModel)},_findAnswerAndDistractors:function($node){if(!$node.text().match(/.*\*\*.*/))return[$node];var ret=[],$answer=$node.clone().empty(),$distractor=$node.clone().empty(),found=!1;return $node.contents().each(function(){if(this.nodeType===Node.TEXT_NODE&&this.textContent.indexOf("**")>=0){var first=_.first(this.textContent.split("**")),rest=_(this.textContent.split("**")).chain().rest().compact().value();found?($distractor.append(first),ret.push($distractor),$distractor=$node.clone().empty()):($answer.append(first),ret.push($answer)),_(rest).each(function(distractor){$distractor.append(distractor),ret.push($distractor),$distractor=$node.clone().empty()}),found=!0}else found?$distractor.append($(this)):$answer.append($(this))}),$distractor.contents().length>0&&ret.push($distractor),ret},_isInteractionDragAndDrop:function(interaction){return"drag"===this._getGapfillBehavior(interaction)},_getGapfillBehavior:function(interaction){var behavior=interaction.options.getGapfillbehaviour();return"tap_item"!==behavior&&"tap_target"!==behavior||"mobile"===a5.dp.config.gapfillBehaviourApplicable&&a5.utils.isDocumentOverMobileBreakpoint()&&(behavior="drag"),behavior}},a5.model_builder.Base.extend("a5.model_builder.GraphicGapMatchInteraction"),a5.model_builder.builders.push(new a5.model_builder.GraphicGapMatchInteraction),a5.model_builder.OMPairsInteraction={isResponsible:function(node,interaction){return a5.dp.config.ompairsNew&&"Order:Match:Pairs"==interaction.identifier&&node.is("matchInteraction")},_hasGaptextAudio:function(interaction,$content){return interaction.options.gaptextaudioIsTrue()&&$content.text().trim().length>0&&!$content.hasClass("has_audio_attached")},buildMatchInteraction:function(interaction,parentNode,node){var ompairsInteraction=new a5.models.interaction.OMPairsInteraction({interactionIndex:interaction.index,behaviour:this._getGapfillBehaviour(interaction),poolAlignment:interaction.options.getPoolAlignment(),pairAlignment:interaction.options.getPairalignment()}),responses=interaction.getCorrectResponse(node.attr("responseIdentifier")),gaps=node.find("#contentblock simpleAssociableChoice"),gapsModels=_.map(gaps,function(gap){var content=this.buildContents($(gap),interaction);return new a5.models.interaction.OMPairsGap({identifier:$(gap).attr("identifier"),correctResponse:$(gap).attr("identifier"),content:content,parent:ompairsInteraction,enumeration:interaction.enumAnswers.next(),tryAgainBehaviour:this.getTryAgainBehaviour(interaction),gaptextaudio:this._hasGaptextAudio(interaction,$(content)),dropIndicator:interaction.options.dropIndicatorIsTrue()})},this),answers=this.fetchChoices(interaction,node,"> simpleMatchSet > simpleAssociableChoice"),answerModels=_.map(answers,function(answer){var content=this.buildContents($(answer),interaction);return new a5.models.interaction.OMPairsResponse({identifier:$(answer).attr("identifier"),correctGap:_.first(responses.asMap([$(answer).attr("identifier")])),content:content,parent:ompairsInteraction,gaptextaudio:this._hasGaptextAudio(interaction,$(content))})},this);if(interaction.options.prefillIsFirstitem()){var prefilledGap=_.first(gapsModels),prefilledResponse=_.findWhere(answerModels,{identifier:prefilledGap.correctResponse});prefilledGap.prefilled=prefilledResponse.prefilled=!0}ompairsInteraction.addResponses(answerModels),ompairsInteraction.addGaps(gapsModels),interaction.blockItems.add(ompairsInteraction);var view=new a5.views.OMPairsInteraction(ompairsInteraction,null,interaction);parentNode.append(view.render()),parentNode.addInteractionStyle("drag-drop");var otherContent=node.find("#contentblock").children().filter(":not(:has(simpleAssociableChoice))");this.buildContents(otherContent,interaction,parentNode)},_getGapfillBehaviour:function(interaction){var behaviour=interaction.options.getGapfillbehaviour();return"tap_item"!==behaviour&&"tap_target"!==behaviour||"mobile"===a5.dp.config.gapfillBehaviourApplicable&&a5.utils.isDocumentOverMobileBreakpoint()&&(behaviour="drag"),behaviour},getTryAgainBehaviour:function(interaction){var tryAgainBehaviour={keep:"none",lock:!1};return interaction.options.tryAgainIsLock()||interaction.options.tryAgainIsFrozen()?(tryAgainBehaviour.keep="correct",tryAgainBehaviour.lock=interaction.options.tryAgainIsFrozen()):interaction.options.tryAgainIsKeepall()&&(tryAgainBehaviour.keep="all"),tryAgainBehaviour}},a5.model_builder.Base.extend("a5.model_builder.OMPairsInteraction"),a5.model_builder.builders.push(new a5.model_builder.OMPairsInteraction),a5.model_builder.OMPairsInteractionLegacy={isResponsible:function(node,interaction){return!a5.dp.config.ompairsNew&&"Order:Match:Pairs"==interaction.identifier&&node.is("matchInteraction, simpleAssociableChoice")},buildSimpleAssociableChoice:function(interaction,parentNode,node){this.buildContents(node,interaction,parentNode)},buildMatchInteraction:function(interaction,parentNode,node){parentNode.closest(".interaction").addClass("drag-drop"),this.responses=interaction.getCorrectResponse(node.attr("responseIdentifier")).asMap();var targetIds=_.uniq(_.map(this.responses,function(r){return _.first(r)})),poolIds=_.map(this.responses,function(v,k){return k}),enumAnswers=interaction.enumAnswers,distractors=_.map(node.find("simpleAssociableChoice"),function(m){var container=$("<div>");return this.buildContents(m,interaction,container),[$(m).attr("identifier"),container.html()]},this),targetPools={};_.each(this.responses,function(v,k){_.isUndefined(targetPools[_.first(v)])&&(targetPools[_.first(v)]=[]),targetPools[_.first(v)].push(k)});var poolTarget={};_.each(this.responses,function(v,k){poolTarget[k]=_.first(v)});var mode="false"!=interaction.options.getEnumerationAnswers()?"single":"multiple";interaction.options.targetzonesIsTrue()&&(mode="single");var model=new a5.models.interaction.OMPairsModel({},{targetIds:targetIds,poolIds:poolIds,targetPools:targetPools,poolTarget:poolTarget,mode:mode,correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()},interaction),gaptextaudio=interaction.options.gaptextaudioIsTrue(),viewpool=new a5.views.OMPairsViewPool(model,node,parentNode,poolIds,distractors,targetIds,gaptextaudio),viewtarget=new a5.views.OMPairsViewTarget(model,node,parentNode,targetIds,""!=enumAnswers.values,interaction.options.getPairalignment(),gaptextaudio);interaction.blockItems.add(model),interaction.model=model,parentNode.append(viewpool.render()),parentNode.append(viewtarget.render()),interaction.onInteractionReadyListeners.register(viewtarget.events.bindTo(viewtarget)),interaction.onInteractionRestoreListeners.register(viewtarget.events.bindTo(viewtarget)),new a5.views.OMPairsViewOptions(model,interaction.options,interaction.targetPools,targetIds);var otherContent=node.find("#contentblock").children().filter(":not(:has(simpleAssociableChoice))");this.buildContents(otherContent,interaction,parentNode)}},a5.model_builder.Base.extend("a5.model_builder.OMPairsInteractionLegacy"),a5.model_builder.builders.push(new a5.model_builder.OMPairsInteractionLegacy),a5.model_builder.ICTextGapLabelAnObject={isResponsible:function(node,interaction){return"Input:Completion:Text gap (Label an object)"===interaction.identifier&&(a5.utils.hasTag(node,"graphicGapMatchInteraction")||this.isBuildingGraphicGapMatchInteraction&&(a5.utils.hasTag(node,"associableHotspot")||a5.utils.hasTag(node,"object")&&["image/jpeg","image/png"].contains(node.attr("type"))))},buildGraphicGapMatchInteraction:function(interaction,parentNode,node){if(this.isBuildingGraphicGapMatchInteraction)throw"cannot nest gapMatchInteractions";this.isBuildingGraphicGapMatchInteraction=!0,_.isUndefined(this.activities[interaction.identifier])&&(this.activities[interaction.identifier]={}),_.isUndefined(this.activities[interaction.identifier][interaction.index])&&(this.activities[interaction.identifier][interaction.index]={}),this.gapCount=0;var model=new a5.models.interaction.ICTextGapLabelAnObjectBlock({poolAlignment:interaction.options.getPoolAlignment(),poolWords:this._extractPoolWords(interaction,node),tts_audio:interaction.options.gaptextaudioIsTrue(),parent:interaction}),view=new a5.views.interaction.ICTextGapLabelAnObjectBlock(model);parentNode.append(view.node),this.activities[interaction.identifier][interaction.index]={model:model,view:view,correctResponse:interaction.getCorrectResponse(node.attr("responseIdentifier")).asMap()},this.buildContents(node,interaction,view.wordpool.block,"gapText"),view.render(),this.isBuildingGraphicGapMatchInteraction=!1},buildAssociableHotspot:function(interaction,parentNode,node){var delimeter,activity=this.activities[interaction.identifier][interaction.index],response=this._processResponses(activity.correctResponse[node.attr("identifier")],node);node.attr("coords").indexOf(",")>=0&&(delimeter=","),node.attr("coords").indexOf(":")>=0&&(delimeter=":");var model=new a5.models.interaction.ICTextGapLabelAnObject({position:node.attr("coords").split(delimeter),display_words:response.display_words,distractors:response.distractors,parent:activity.model,prefilled:interaction.options.prefillIsFirstitem()&&0===this.gapCount,correct:response.correct,tryAgainKeep:interaction.options.tryAgainIsKeepall(),enumeration:interaction.enumAnswers.next(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),resizeGaps:interaction.options.gapResizeIsOn(),charactersNumber:interaction.options.gapcharactersIsShow(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),inputStyle:node.attr("style")});activity.model.add(model);var view=new a5.views.interaction.ICTextGapLabelAnObject(model,activity.view);activity.view.add(view),parentNode.append(view.node),view.render(),interaction.blockItems.add(model),this.gapCount+=1},buildObject:function(interaction,parentNode,node){var activity=this.activities[interaction.identifier][interaction.index],styles=node.attr("style"),size={width:parseFloat(a5.utils.getStyleValue(styles,"width")),height:parseFloat(a5.utils.getStyleValue(styles,"height"))};(new a5.model_builder.ObjectImage).build(interaction,parentNode,node),activity.model.setImageSize(size),activity.view.setImage()},_processResponses:function(responses,node){var correct=[],distractors=[],display_words=[];return _.each(responses,function(cident){var correct_and_distractors=node.parent().find("gapText[identifier='"+cident+"']").text().split("**");correct_and_distractors.length>1&&distractors.push(correct_and_distractors[1]),correct.push(a5.utils.splitUnescaped(correct_and_distractors[0],"*"))}),correct=_.chain(correct).compact().flatten().value(),display_words=_.filter(correct,function(answer){return a5.utils.containsUnescaped(answer,"|")}).map(function(answer){return a5.utils.splitUnescaped(answer,"|").pop()}),correct=_.map(correct,function(word){return _.first(a5.utils.splitUnescaped(word,"|"))}),correct=_.map(correct,function(word){return a5.utils.unescapeReservedSyntaxSymbols(word)}),display_words=_.map(display_words,function(word){return a5.utils.unescapeReservedSyntaxSymbols(word)}),{correct:correct,display_words:display_words,distractors:distractors}},_extractPoolWords:function(interaction,node){var poolWords=[];if(!interaction.options.poolAlignmentIsNone()){_.each(node.children("gapText"),function(e){poolWords=_.union(poolWords,$(e).text().split("**")),poolWords=_.union(poolWords,_.tail($(e).text().split("**")))}),poolWords=_(poolWords).uniq();var displayWords=_.filter(poolWords,function(word){return a5.utils.containsUnescaped(word,"|")}),restWords=_.difference(poolWords,displayWords);displayWords=_.map(displayWords,function(word){return a5.utils.splitUnescaped(word,"|").pop()}),displayWords=_.map(displayWords,function(word){return a5.utils.splitUnescaped(word,"*").shift()}),restWords=_.flatten(_.map(restWords,function(word){return a5.utils.splitUnescaped(word,"*")})),poolWords=_.union(displayWords,restWords)}return poolWords=_(poolWords).filter(function(word){return"%0"!==word}),poolWords=_(poolWords).map(function(word){return a5.utils.unescapeReservedSyntaxSymbols(word)}),
interaction.options.randomiseanswersIsTrue()?poolWords=_.shuffle(poolWords):interaction.options.poolorderIsAlphabetical()?poolWords=a5.utils.array.sortBy(poolWords,null,!0):interaction.options.poolorderIsNatural()&&(poolWords=a5.utils.array.naturalSort(poolWords,null,!0,!0)),poolWords}},a5.model_builder.Base.extend("a5.model_builder.ICTextGapLabelAnObject"),a5.model_builder.builders.push(new a5.model_builder.ICTextGapLabelAnObject),a5.model_builder.interaction.IMWordsearch={isResponsible:function(node,interaction){return"Identify:Mark:Wordsearch"==interaction.identifier&&node.is('graphicOrderInteraction, hotspotChoice, object[type="none/none"]')},buildHotspotChoice:function(interaction,parentNode,node){var id=node.attr("identifier"),word=void 0===this.responses[id]?this.responsesReverse[id][0]:this.responses[id][0],params=node.attr("coords").split(",");this.model.addWord({word:word,start:new Vec2(parseInt(params[0],10),parseInt(params[1],10)),direction:parseInt(params[2],10)})},buildGraphicOrderInteraction:function(interaction,parentNode,node){var gridSize=parseInt(interaction.options.getSize(),10)||10;this.model=new a5.model.interaction.IMWordsearch({parent:interaction,width:gridSize,height:gridSize,tryAgainKeep:interaction.options.tryAgainIsKeepall(),hasPrefill:interaction.options.prefillIsFirstitem()}),this.responses=interaction.getCorrectResponse(node.attr("responseIdentifier")).asMap(),this.responsesReverse=interaction.getCorrectResponse(node.attr("responseIdentifier")).asInverseMap(),this.buildContents(node,interaction),this.model.initState();var view=new a5.view.interaction.IMWordsearch(this.model,null,interaction.options.caseIsUpper());parentNode.append(view.node),view.render(),interaction.blockItems.add(this.model),this.model=null,a5.service.templates.enableOnlyCachedMode();var template=a5.service.templates.render("a5.view.toolbar.erase");a5.service.templates.disableOnlyCachedMode(),_.defer(function(){interaction.toolbar.addToggleButton({label:$(template).text()||"Erase",title:$(template).attr("title"),classes:["erase"],on:function(){view.enableDelete()},off:function(){view.disableDelete()}})})},buildObject:function(){}},a5.model_builder.Base.extend("a5.model_builder.interaction.IMWordsearch"),a5.model_builder.builders.push(new a5.model_builder.interaction.IMWordsearch),a5.model_builder.LLInteraction={isResponsible:function(node,interaction){return"Identify:Select:Linking lines"==interaction.identifier&&node.is("associateInteraction")},buildSimpleAssociableChoice:function(interaction,node){var cn,cnt=this.buildContents(node,interaction),sets=this.model.sets,pos=this.totalElements/sets;pos=Math.floor(this.model.elements.length/pos),_.isUndefined(interaction.enumSets[pos])||(_.isEmpty(this.model.enumSets[pos])&&(this.model.enumSets[pos]=[]),this.model.enumSets[pos].push(interaction.enumSets[pos].next())),a5.dp.config.linkingLinesTouchDirection[interaction.options.answerdisplayIsRows()?1:0]?(cn=1,pos==sets-1?cn=-1:pos>0&&(cn=0)):(cn=-1,pos==sets-1?cn=1:pos>0&&(cn=0));var model=new a5.models.interaction.LLElementModel({content:cnt,position:cn,identifier:node.attr("identifier"),parent:this.model,tts_audio:interaction.options.gaptextaudioIsTrue(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()});model.assignAnswerFeedback(node),this.model.elements.push(model)},buildAssociateInteraction:function(interaction,parentNode,node){var interactionIndex=interaction.items.length()-1,self=this,answers=interaction.getCorrectResponse(node.attr("responseIdentifier")).values,answerMap={};if(_.each(answers,function(e){var s=e.split(" ");answerMap[s[0]]=_.tail(s)}),interaction.enumSets={},interaction.options.enumerationAnswersIsCustom()){var enumArray=interaction.options.getEnumerationAnswers().split(",");_(enumArray).each(function(enumeration){var syntax=enumeration.split("*"),k=parseInt(syntax[0],10)-1,v=syntax[1];interaction.enumSets[k]=new a5.models.options.Enumeration(v,'<span class="enum-answers">|</span>'),interaction.enumSets[k].start(-1)},this)}else interaction.options.enumerationAnswersIsFalse()||(interaction.enumSets[0]=interaction.enumAnswers);this.model=new a5.models.interaction.LLModel({sets:interaction.options.linkingLinesSetsIsPairs()?2:interaction.options.linkingLinesSetsIsTriplets()?3:interaction.options.linkingLinesSetsIsQuadruples()?4:5,displayInRows:interaction.options.answerdisplayIsRows(),answers:answerMap,tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),parent:interaction,behaviourIsTouch:interaction.options.linkbehaviourIsTouch(),headings:this._extractGroupHeadings(interaction)}),this.totalElements=node.children("simpleAssociableChoice").length,_.each(this.flip(node.children("simpleAssociableChoice"),this.model.sets),function(e){self.buildSimpleAssociableChoice(interaction,$(e))}),interaction.options.prefillIsFirstitem()&&0==interactionIndex&&this.model.setPrefill(),interaction.options.multipleDestinationsIsOne()||parentNode.addInteractionStyle("multiple-destinations"),interaction.options.randomiseanswersIsTrue()?this.model.shuffleAll():this.model.shuffleRest();var view=new a5.views.interaction.LLView(this.model);interaction.bind("show:deferred",view.createCanvas,view),parentNode.append(view.render()),interaction.blockItems.add(this.model),this.model=null},flip:function(list,width){for(var result=[],height=list.length/width,x=0;x<width;x++)for(var y=0;y<height;y++)result.push(list[y*width+x]);return result},_extractGroupHeadings:function(interaction){var headings=[];return interaction.options.groupheadingsIsOff()||(headings=a5.utils.splitAndTrim(interaction.options.getGroupheadings(),"*")),headings}},a5.model_builder.Base.extend("a5.model_builder.LLInteraction"),a5.model_builder.builders.push(new a5.model_builder.LLInteraction),a5.model_builder.ISCatchBuilder={catchGames:[],isResponsible:function(node,interaction){return"Identify:Select:Catch"===interaction.identifier&&node.is("choiceInteraction")},buildChoiceInteraction:function(interaction,parentNode,node){_.isUndefined(this.catchGames[interaction.index])&&(this.catchGames[interaction.index]={questions:[],view:void 0});var thisGame=this.catchGames[interaction.index];interaction.bind("reset",function(){this.catchGames[interaction.index].questions=[],this.catchGames[interaction.index].view=void 0},this),parentNode.addClass("is-catch-game-view-container");var targets=node.find("simpleChoice"),responseId=node.attr("responseIdentifier"),correctTargets=interaction.getAllResponseDeclaration()[responseId].values;targets=_.map(targets,_.bind(function(target){return{id:target.getAttribute("identifier"),value:$((new XMLSerializer).serializeToString(target)).html(),isCorrect:correctTargets.indexOf(target.getAttribute("identifier"))>=0}},this)),"true"===interaction.options.getRandomiseanswers().toLowerCase()&&(targets=_.shuffle(targets));var model=new a5.models.interaction.ISCatchQuestionModel({targets:targets,question:node.find("p")[0],substractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()},void 0,interaction);if(thisGame.questions.push(model),thisGame.questions.length>=_.keys(interaction.getAllResponseDeclaration()).length){var game=new a5.models.interaction.ISCatchGameModel({models:thisGame.questions,stageConfiguration:this.getStageConfiguration(interaction),targetsConfiguration:this.getTargetsConfiguration(interaction)},void 0,interaction);interaction.visibleQuestion=0,thisGame.view=new a5.views.interaction.ISCatchView(game,null,interaction),thisGame.view.bind("question_finished",_.bind(function(){interaction.visibleQuestion<game.models.length-1&&(interaction.visibleQuestion++,this.appendToContentBlockDiv(interaction,interaction.visibleQuestion,thisGame.view.node))},this)),this.appendToContentBlockDiv(interaction,interaction.visibleQuestion,thisGame.view.render()),interaction.blockItems.add(game)}},appendToContentBlockDiv:function(interaction,index,node){interaction.$(".contentblock").length>index&&(interaction.$(".contentblock").hide(),$(interaction.$(".contentblock")[index]).show().find(".is-catch-game-view-container").append(node))},getTargetsConfiguration:function(interaction){var maxItems=parseInt(interaction.options.getMaximumitems(),10);(interaction.options.maximumitemsIsOff()||isNaN(maxItems)||maxItems<=0)&&(maxItems=null);var targetDuration=parseInt(interaction.options.getTargetonscreenduration(),10);(interaction.options.targetonscreendurationIsOff()||isNaN(targetDuration)||targetDuration<=0)&&(targetDuration=null);var targetImage=interaction.options.getTargetimage();(interaction.options.targetimageIsCustom()||_.isEmpty(targetImage))&&(targetImage=null);var selectedTargetImage=interaction.options.getSelectedTargetimage();(interaction.options.selectedTargetimageIsCustom()||_.isEmpty(selectedTargetImage))&&(selectedTargetImage=null);var bkgimage=interaction.options.getBackgroundimage();(interaction.options.backgroundimageIsCustom()||_.isEmpty(bkgimage))&&(bkgimage=null);var targetGeneratorImage=interaction.options.getTargetGeneratorimage();(interaction.options.targetGeneratorimageIsCustom()||_.isEmpty(targetGeneratorImage))&&(targetGeneratorImage=null);var targetGeneratorLocation=interaction.options.getTargetGeneratorlocation(),targetGeneratorOrigin=interaction.options.getOriginoftargets();return(interaction.options.originoftargetsIsDefault()||_.isEmpty(targetGeneratorOrigin))&&(targetGeneratorOrigin=null),{maxItems:maxItems,targetDuration:targetDuration,movementSpeed:interaction.options.getMovementspeed(),targetImage:targetImage,selectedTargetImage:selectedTargetImage,generationSpeed:interaction.options.getGenerationspeed(),targetGeneratorY:targetGeneratorLocation.toLowerCase().indexOf("top")>=0?"top":"bottom",targetGeneratorX:targetGeneratorLocation.toLowerCase().indexOf("left")>=0?"left":"right",targetGeneratorOrigin:targetGeneratorOrigin,targetGeneratorImage:targetGeneratorImage,backgroundImage:bkgimage}},getStageConfiguration:function(interaction){var maxDuration=parseInt(interaction.options.getMaximumduration(),10);return(isNaN(maxDuration)||maxDuration<=0||interaction.options.maximumdurationIsOff())&&(maxDuration=null),{maxDuration:maxDuration,countdownTimer:interaction.options.countdowntimerIsOn()&&null!==maxDuration,scoreboard:interaction.options.scoreboardIsOn(),gameOverMessage:interaction.options.gameOvermessageIsCustom()?null:interaction.options.getGameOvermessage()}}},a5.model_builder.Base.extend("a5.model_builder.ISCatchBuilder"),a5.model_builder.builders.push(new a5.model_builder.ISCatchBuilder),a5.model_builder.LLInteraction={isResponsible:function(node,interaction){return"Identify:Select:Linking multiple lines"==interaction.identifier&&node.is("associateInteraction")},buildAssociateInteraction:function(interaction,parentNode,node){var answers=interaction.getCorrectResponse(node.attr("responseIdentifier")).values;answers=_.map(answers,function(answer){return answer.split(" ")});var model=new a5.models.interaction.LinkingMultipleLines({answers:answers,parent:interaction,tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),behaviourIsTouch:interaction.options.linkbehaviourIsTouch(),displayInRows:interaction.options.answerdisplayIsRows()}),view=new a5.views.interaction.LinkingMultipleLines(model);_.each(node.children("simpleAssociableChoice"),function(e){var $e=$(e),content=this.buildContents($e,interaction);view.append($e.attr("matchGroup"),$e.attr("identifier"),!1,content)},this),interaction.options.prefillIsFirstitem()?model.prefillFirstLine():interaction.options.prefillIsFirstblock()&&(model.prefillFirstItem(),view.children[0].children[0].prefilled=!0),view.appendHandles(),"true"==node.attr("shuffle")?view.shuffle():view.shuffleRest(),interaction.bind("show:deferred",view.createCanvas,view),parentNode.append(view.render()),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.LLInteraction"),a5.model_builder.builders.push(new a5.model_builder.LLInteraction),a5.model_builder.ShuffleBuilder={isResponsible:function(node,interaction){return node.is("orderInteraction")&&"Order:Sequence:Sequence"==interaction.identifier},buildOrderInteraction:function(interaction,parentNode,node){var firstBlock=interaction.items.length()-1==0,self=this,horizontal=interaction.options.dragAlignmentIsHorizontal()||interaction.options.dragAlignmentIsHorizontal_single_word(),clickclick=interaction.options.useClickClickIsTrue(),dropIndicator=interaction.options.dropIndicatorIsTrue(),responses=interaction.getCorrectResponse(node.attr("responseIdentifier")).values;responses=_.map(responses,function(e){return e.split(" ")});var model=new a5.models.interaction.ShuffleModel({correct:responses,alignment:interaction.options.getDragAlignment(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),interaction:interaction});_.each(node.children("simpleChoice"),function(e,index){var $e=$(e),$contents=self.buildContents($e,interaction),text=$contents.html();a5.utils.wrapFirstLetter($contents);var element=new a5.models.interaction.ShuffleElement({parent:model,text:text,content:$contents,identifier:$e.attr("identifier"),fixed:"true"==$e.attr("fixed"),alignment:interaction.options.getDragAlignment(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()});element.assignAnswerFeedback($e),firstBlock&&(interaction.options.prefillIsFirstblock()||interaction.options.prefillIsFirstitem()&&0==index)&&(element.fixed=!0,element.prefilled=!0),model.elements.push(element)}),model.shuffle();var view,gaptextaudio=interaction.options.gaptextaudioIsTrue(),capitalize=interaction.options.automaticcapitalisationIsOn();view=interaction.options.gapfillbehaviourIsTap_swap()?new a5.views.interaction.OSSequenceViewSwap(model,horizontal,clickclick,dropIndicator,gaptextaudio,capitalize):new a5.views.interaction.OSSequenceView(model,horizontal,clickclick,dropIndicator,gaptextaudio,capitalize),parentNode.addInteractionStyle("drag-drop"),parentNode.replaceWith($("<p></p>").append(view.render())),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.ShuffleBuilder"),a5.model_builder.builders.push(new a5.model_builder.ShuffleBuilder),a5.model_builder.OSBoxDropBuilder={isResponsible:function(node,interaction){return"Order:Sort:Box drop"===interaction.identifier&&node.is("matchInteraction")},buildMatchInteraction:function(interaction,parentNode,node){var targets=_.filter(node.find("simpleAssociableChoice"),function(choice){return a5.utils.startsWith($(choice).attr("identifier"),"T")}),choices=_.filter(node.find("simpleAssociableChoice"),function(choice){return a5.utils.startsWith($(choice).attr("identifier"),"C")});choices=_.shuffle(choices);var responses=_.flatten(_.map(interaction.getAllResponseDeclaration(),function(rD){return rD.values}));responses=_.object(_.map(responses,function(response){return response.split(" ").reverse()}));var model=new a5.models.interaction.OSBoxDropModel({targets:targets,choices:choices,response:responses},void 0,interaction);interaction.bind("boxdrop",function(){model.dropChoice()}),interaction.bind("pause-boxdrop",function(){model.stopped?model.startCategoriesMovement():model.stopCategoriesMovement()});var view=new a5.views.interaction.OSBoxDropView(model);parentNode.append(view.render()),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.OSBoxDropBuilder"),a5.model_builder.builders.push(new a5.model_builder.OSBoxDropBuilder),a5.model_builder.ICCrossword={isResponsible:function(node,interaction){return!a5.service.reactEngineInterface.isActivityReact(interaction.identifier)&&"Input:Completion:Crossword"===interaction.identifier&&(node.is("orderInteraction")||node.is("simpleChoice"))},buildOrderInteraction:function(interaction,parentNode,node){var model=new a5.model.interaction.ICCrossword({parent:interaction,tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),cluesInColumns:interaction.options.cluesincolumnsIsOn()}),XML=$.parseXML(node.find("prompt").text());_.each($(XML).find("hint"),function(hint,index){var wordModel=new a5.model.interaction.ICCrosswordWord({x:$(hint).parent().prevAll().length,y:$(hint).parent().parent().prevAll().length,word:$(hint).attr("word"),align:"2"==$(hint).attr("align")?"vertical":"horizontal",parent:model,prefilled:!interaction.options.prefillIsFalse()&&0==index,correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn()});model.addWord(wordModel)}),model.initializeWords(),this.model=model,this.buildContents(node,interaction);var view=new a5.view.interaction.ICCrossword(model,null,interaction.options.caseIsUpper(),interaction.options.getClueposition());parentNode.append(view.node),view.render(),interaction.blockItems.add(model),this.model=null},buildSimpleChoice:function(interaction,parentNode,node){var word=this.model.findWord(node.attr("identifier"));word&&(word.content=this.buildContents(node,interaction))}},a5.model_builder.Base.extend("a5.model_builder.ICCrossword"),a5.model_builder.builders.push(new a5.model_builder.ICCrossword),a5.model_builder.ICCrosswordReact={isResponsible:function(node,interaction){return a5.service.reactEngineInterface.isActivityReact(interaction.identifier)&&"Input:Completion:Crossword"===interaction.identifier&&node.is("orderInteraction")},buildOrderInteraction:function(interaction,parentNode,node){var XML=$.parseXML(node.find("prompt").text()),clueNodes=node.find("simpleChoice"),wordsObject=this._xmlToWords($(XML).find("hint"),clueNodes,interaction),blockItem=new a5.models.interaction.ReactItem(interaction.blockItems.length(),{words:wordsObject.words,rowSize:wordsObject.maxX,colSize:wordsObject.maxY},wordsObject.solution,[],interaction.id,"iccrossword");interaction.blockItems.add(blockItem);var reactViewParent=$("<div />");parentNode.append(reactViewParent),a5.service.reactEngineInterface.renderElement(a5.service.React.components.activities.iccrossword.ICCrossword,{activityId:blockItem.activityId},reactViewParent[0])},buildSimpleChoice:function(interaction,parentNode,node){},_xmlToWords:function(nodes,clueNodes,interaction){var minX=null,minY=null,maxX=0,maxY=0,cells=[],solutionCells=[],words=_.chain(nodes).map(function(hint,index){var word=$(hint).attr("word");return{x:$(hint).parent().prevAll().length,y:$(hint).parent().parent().prevAll().length,word:word,align:"2"==$(hint).attr("align")?"v":"h",clue:clueNodes.filter("[identifier="+word+"]").text()}}).each(function(w){minY=null!==minY?Math.min(minY,w.y):w.y,minX=null!==minX?Math.min(minX,w.x):w.x,maxX=Math.max(maxX,"h"===w.align?w.x+w.word.length:w.x+1),maxY=Math.max(maxY,"v"===w.align?w.y+w.word.length:w.y+1)}).map(function(w){return w.x-=minX,w.y-=minY,w}).value();return maxX-=minX,maxY-=minY,_.each(words,function(w,windex){var chars=Array.from(w.word);w.cells=_.map(chars,function(char,index){var x="h"===w.align?w.x+index:w.x,y="v"===w.align?w.y+index:w.y,cell=_.findWhere(cells,{x:x,y:y});if(cell)return cell;cell={x:x,y:y,value:char},solutionCells.push(cell);var cellOb=_.extend({},cell);return cellOb.letter=0!==windex||interaction.options.prefillIsFalse()?null:cell.value,delete cellOb.value,cells.push(cellOb),cellOb}),delete w.word}),{solution:solutionCells,words:words,maxX:maxX,maxY:maxY}}},a5.model_builder.Base.extend("a5.model_builder.ICCrosswordReact"),a5.model_builder.builders.push(new a5.model_builder.ICCrosswordReact),a5.model_builder.TextWordSnake={isResponsible:function(node,interaction){return"Identify:Mark:Wordsnake"==interaction.identifier&&3==node[0].nodeType&&node.closest("#content").length>0},build:function(interaction,parent,node){void 0===interaction.t&&(interaction.t=""),interaction.t+=$.trim(node.text())}},a5.model_builder.WordSnake={isResponsible:function(node,interaction){var isResponsible=node.is("textEntryInteraction")&&"Identify:Mark:Wordsnake"==interaction.identifier;return isResponsible&&1==interaction.clean&&(interaction.t="",interaction.selections=[],interaction.answers={},interaction.clean=!1),isResponsible},build:function(interaction,parentNode,node){var model=new a5.models.item.interaction.WordSnake({interaction:interaction,responseIdentifier:node.attr("responseIdentifier")});_.isUndefined(interaction.t)&&(interaction.t="");var correctResponse=interaction.getCorrectResponse(model.responseIdentifier);if(interaction.t+=$.trim(correctResponse.values[0]),void 0===interaction.answers&&(interaction.answers={}),void 0===interaction.selections&&(interaction.selections=[]),interaction.answers[model.responseIdentifier]=$.trim(correctResponse.values[0]),!interaction.firstCall){var view=new a5.views.interaction.Wordsnake(model);parentNode.parent().prepend(view.render()),interaction.blockItems.add(model),interaction.firstCall=!0}}},Obj.extend("a5.model_builder.TextWordSnake",a5.model_builder.TextWordSnake),Obj.extend("a5.model_builder.WordSnake",a5.model_builder.WordSnake),a5.model_builder.builders.push(new a5.model_builder.TextWordSnake),a5.model_builder.builders.push(new a5.model_builder.WordSnake),a5.model_builder.Colouring={isResponsible:function(node,interaction){return"Identify:Mark:Colouring"==interaction.identifier&&(node.is("gapMatchInteraction")||node.is("gap"))},buildGap:function(interaction,parentNode,node){},buildGapMatchInteraction:function(interaction,parentNode,node){var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")),answers={};_.each(correctResponse.values,function(response){var responseArray=response.split(" ");_.each(responseArray.slice(1),function(item){answers[item]=responseArray[0]})});var model=this.gapModel=new a5.models.item.interaction.Colouring({interaction:interaction,tryAgainKeep:interaction.options.tryAgainIsKeepall(),answers:answers,maxOpacity:a5.dp.config.colouringOpacity,poolAlign:interaction.options.getPoolAlignment()});interaction.blockItems.add(model);var colouringView=new a5.views.interaction.ColouringView(model);node.find("gap").each(function(j,gap){gap=$(gap);var colourModel=new a5.models.item.interaction.ColouringInteractionColour({identifier:gap.attr("identifier"),label:gap.attr("label"),idAttr:gap.attr("id"),color:$("<div/>").css("background-color",gap.attr("style")).css("background-color")});a5.utils.startsWith(colourModel.idAttr,"dis")&&model.addDistractorColour(colourModel)}),node.contents().each(function(i,el){if($(el).is("gapText")){var gapText=$(el);if(!_.find(correctResponse.values,function(item){return item.indexOf(gapText.attr("identifier"))>-1})){var child=new a5.models.item.interaction.ColouringInteractionGapText({identifier:gapText.attr("identifier"),label:"",areas:gapText.text(),correctColor:null,parent:model,distractor:!0});model.addItem(child.identifier,child)}else node.find("gap").each(function(j,gap){gap=$(gap);var ident=gapText.attr("identifier")+" "+gap.attr("identifier");if(_.include(correctResponse.values,ident)){var child=new a5.models.item.interaction.ColouringInteractionGapText({identifier:gap.attr("identifier"),label:gap.attr("label"),areas:gapText.text(),correctColor:$("<div/>").css("background-color",gapText.attr("style")).css("background-color"),prefilled:0==j&&interaction.options.prefillIsFirstitem(),parent:model});model.addItem(child.identifier,child)}})}else $(el).is("gap")||interaction.buildModel(colouringView.contentBlock,$(el))}),parentNode.append(colouringView.node),colouringView.render(),parentNode.addClass("toolbar")}},a5.model_builder.Base.extend("a5.model_builder.Colouring"),a5.model_builder.builders.push(new a5.model_builder.Colouring),a5.model_builder.ISRadiobuttonBuilder={views:[],isResponsible:function(node,interaction){return node.is("choiceInteraction")&&"Identify:Select:Radiobutton"==interaction.identifier},buildChoiceInteraction:function(interaction,parentNode,node){var shuffle,view,label="",answers=[],showInColumns=interaction.options.showInColumnsIsTrue(),response=$(node).attr("responseIdentifier").replace("RESPONSE",""),isFirstChoiceInteraction=0==parseInt(response,10),randomizeAnswers=interaction.options.randomiseanswersIsTrue(),correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")).values,isFirstBlock=1===interaction.items.length(),isFirstItem=isFirstBlock&&0===interaction.blockItems.length(),hasItemsRef=interaction.options.orderDependencyIsFirst_answer()||!interaction.options.questiondisplayIsAll(),prefilled=isFirstBlock&&interaction.options.prefillIsFirstblock()||isFirstItem&&interaction.options.prefillIsFirstitem(),isFirstInteractive=!prefilled&&(!this.views.length||_.last(this.views).model.prefilled),isOpened=interaction.options.questiondisplayIsAll()||prefilled||isFirstInteractive||isFirstBlock,model=new a5.models.interaction.ISRadiobuttonModel({alignment:interaction.options.getChoiceAlignment(),prefilled:prefilled,tryAgainKeep:interaction.options.tryAgainIsKeepall(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),gaptextaudio:interaction.options.gaptextaudioIsTrue(),orderDependency:interaction.options.orderDependencyIsFirst_answer(),display:interaction.options.getQuestiondisplay(),blockId:interaction.items.length()-1,attempts:interaction.checkAttempts,tryAgainIsClear:interaction.options.tryAgainIsClear()});interaction.blockItems.add(model),showInColumns&&(shuffle=!1,correctResponse=_.filter(correctResponse,function(e){return!a5.utils.endsWith(e,"_0")})),_.each(this.fetchChoices(interaction,node,"simpleChoice",shuffle),function(e,index){var enumeration,$content=this.buildContents(e,interaction);if(showInColumns&&a5.utils.endsWith($(e).attr("identifier"),"_0"))label=$content.prepend('<span class="enum-placeholder"></span>'),interaction.enumAnswers.next().then(function(enumSymbol){$content.find(".enum-placeholder").replaceWith(enumSymbol)});else{showInColumns||interaction.options.enumerationinternalIsCorrect()||(enumeration=interaction.enumAnswers.next());var choiceModel=new a5.models.interaction.ISRadiobuttonChoiceModel({content:$content,parent:model,hasRadiobutton:!interaction.options.hideRadiobuttonsIsTrue(),enumeration:enumeration,tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),correct:_.contains(correctResponse,$(e).attr("identifier")),value:$(e).attr("identifier"),label:label});choiceModel.assignAnswerFeedback($(e)),model.add(choiceModel),answers.push($content),_.contains(correctResponse,choiceModel.value)&&(model.correct=choiceModel)}},this),showInColumns&&isFirstChoiceInteraction&&(this.header_node=new a5.views.interaction.ISRadiobuttonHeader(answers).render());var autoOpenFeedback=a5.dp.config.specificFeedbackAuto;if(view=interaction.options.questiondisplayIsActive()?new a5.views.interaction.ISRadiobuttonViewDisplayActive(model,parentNode,isFirstInteractive,isFirstChoiceInteraction,autoOpenFeedback,interaction.options.hideCheckboxesIsTrue(),showInColumns,label,interaction):interaction.options.questiondisplayIsAll()?new a5.views.interaction.ISRadiobuttonViewDisplayAll(model,parentNode,isFirstInteractive,isOpened,autoOpenFeedback,interaction.options.hideCheckboxesIsTrue(),showInColumns,label,interaction):new a5.views.interaction.ISRadiobuttonViewDefault(model,parentNode,isFirstInteractive,isOpened,autoOpenFeedback,interaction.options.hideCheckboxesIsTrue(),showInColumns,label,interaction),this.views.push(view),node.is(_.last(interaction.xml.querySelectorAll("choiceInteraction")))){if(hasItemsRef){var filteredViews=_.reject(this.views,function(view){return view.model.prefilled}),models=_.pluck(filteredViews,"model");_.each(filteredViews,function(view,index){view.model.blockItems=models,view.model.questionIndex=index,view.addSiblingsListeners()})}this.views=[]}interaction.bind("reset",function(){this.views=[]},this,{once:!0}),this._appendToDOM(view.render(),parentNode,randomizeAnswers&&showInColumns),showInColumns&&parentNode.prepend(this.header_node),"Exam"!==LOInfo.mode&&"Trainer"!==LOInfo.mode||interaction.bind("show update-status-to-answers update-status-to-corrected",_.bind(function(){("Exam"===LOInfo.mode&&"corrected"===interaction.getStatus()||"answers"===interaction.getStatus())&&view.showFirstAnswerFeedback()},this))},_appendToDOM:function($node,parentNode,random){var len=parentNode.find(".choice_interaction").length;random&&len?this._insertRandom($node,parentNode,len):parentNode.append($node)},_insertRandom:function($node,parentNode,len){if(len){var index=Math.floor(Math.random()*len);Boolean(Math.floor(2*Math.random()))?$node.insertBefore(parentNode.find(".choice_interaction:eq("+index+")")):$node.insertAfter(parentNode.find(".choice_interaction:eq("+index+")"))}}},a5.model_builder.Base.extend("a5.model_builder.ISRadiobuttonBuilder"),a5.model_builder.builders.push(new a5.model_builder.ISRadiobuttonBuilder),a5.model_builder.ISRadiobuttonColumnsBuilder={isResponsible:function(node,interaction){return node.is("choiceInteraction")&&"Identify:Select:Radiobutton columns"==interaction.identifier},buildChoiceInteraction:function(interaction,parentNode,node){var enumeration,self=this,label="",answers=[],model=new a5.models.interaction.ISRadiobuttonModel({alignment:interaction.options.getChoiceAlignment(),prefilled:(interaction.options.prefillIsFirstblock()||interaction.options.prefillIsFirstitem())&&0==interaction.blockItems.length(),correctFeedback:interaction.options.getFeedbackCorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),incorrectFeedback:interaction.options.getFeedbackIncorrect()}),correctResponse=_.filter(interaction.getCorrectResponse(node.attr("responseIdentifier")).values,function(e){return!a5.utils.endsWith(e,"_0")});_.each(this.fetchChoices(interaction,node,"simpleChoice",!1),function(e,index){if(a5.utils.endsWith($(e).attr("identifier"),"_0"))enumeration=interaction.enumAnswers.next(),label=enumeration.then(function(enumSymbol){return(interaction.enumAnswers.useEnum()?'<span class="enum">'+enumSymbol+"</span>":"")+$(e).text()});else{var choiceModel=new a5.models.interaction.ISRadiobuttonChoiceModel({content:self.buildContents(e,interaction),parent:model,hasRadiobutton:!interaction.options.hideRadiobuttonsIsTrue(),radiobuttonIsCustom:interaction.options.hideRadiobuttonsIsCustom(),correct:_.contains(correctResponse,$(e).attr("identifier")),value:$(e).attr("identifier"),label:label});choiceModel.assignAnswerFeedback($(e)),model.add(choiceModel),answers.push($(e).text()),_.contains(correctResponse,choiceModel.value)&&(model.correct=choiceModel)}});var responses=node.parent().find("choiceInteraction").length;parseInt($(node).attr("responseIdentifier").replace("RESPONSE",""),10)%responses==0&&parentNode.append(new a5.views.interaction.ISRadiobuttonColumnsHeader(answers).render());var view=new a5.views.interaction.ISRadiobuttonColumnsView(model,model.prefilled,interaction.options.hideCheckboxesIsTrue(),label,enumeration),rendered=view.render();parentNode.append(rendered),0==interaction.blockItems.itemList.length&&interaction.bind("show:deferred",function(){rendered.focus()}),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.ISRadiobuttonColumnsBuilder"),a5.model_builder.builders.push(new a5.model_builder.ISRadiobuttonColumnsBuilder),a5.model_builder.ISRadioDynamic={isResponsible:function(node,interaction){return node.is("dynamicRadio")},build:function(interaction,parentNode,node){var answersWithModel={items:[]};interaction.bind("show",_.bind(function(){parentNode.empty(),interaction.blockItems.itemList=[],this._build(interaction,parentNode,node,answersWithModel)},this))},_build:function(interaction,parentNode,node,answersWithModel){
var screenNum=parseInt(node.attr("screen"),10)-1,answerNum=parseInt(node.attr("id"),10)-1,columns=node.attr("columns").split(",");this.header_node=new a5.views.interaction.ISRadiobuttonHeader(columns).render();var parent_interaction=a5.mainBuilder.intList[screenNum],answers=_.filter(parent_interaction.blockItems.itemList,function(item){return item.selected&&item.selected.value==item.choices[answerNum].value});answersWithModel.items=_(answersWithModel.items).filter(function(item){return _(answers).contains(item.answer)}),parentNode.append(this.header_node);var tempAnswersWithModel=[];_.each(answers,function(answer){var model,last=_(answersWithModel.items).find(function(item){return item.answer==answer}),label=answer.correct.label.clone();last?model=last.model:(model=new a5.models.interaction.ISRadiobuttonModel({alignment:parent_interaction.options.getChoiceAlignment(),prefilled:(parent_interaction.options.prefillIsFirstblock()||parent_interaction.options.prefillIsFirstitem())&&1==parent_interaction.items.length()}),_.each(columns,function(column,i){var choiceModel=new a5.models.interaction.ISRadiobuttonChoiceModel({content:$("<div>"),parent:model,hasRadiobutton:!parent_interaction.options.hideRadiobuttonsIsTrue(),enumeration:interaction.enumAnswers.next(),value:i.toString(),label:label});model.add(choiceModel)})),tempAnswersWithModel.push({answer:answer,model:model});var view=new a5.views.interaction.ISRadiobuttonView(model,answer.prefilled,parent_interaction.options.hideCheckboxesIsTrue(),parent_interaction.options.showInColumnsIsTrue(),label);parentNode.append(view.render()),interaction.blockItems.add(model)},this),answersWithModel.items=tempAnswersWithModel}},a5.model_builder.Base.extend("a5.model_builder.ISRadioDynamic"),a5.model_builder.builders.push(new a5.model_builder.ISRadioDynamic),a5.model_builder.ISCheckboxDynamic={isResponsible:function(node,interaction){return node.is("dynamicCheckbox")},build:function(interaction,parentNode,node){var answersWithModel={items:[]};interaction.bind("show",_.bind(function(){parentNode.empty(),interaction.blockItems.itemList=[],this._build(interaction,parentNode,node,answersWithModel)},this))},_build:function(interaction,parentNode,node,answersWithModel){var screenNum=parseInt(node.attr("screen"),10)-1,answerNum=parseInt(node.attr("id"),10)-1,columns=node.attr("columns").split(",");1==interaction.items.length()&&interaction.options.prefillIsFirstblock();this.header_node=new a5.views.interaction.ISCheckboxHeader(columns).render();var parent_interaction=a5.mainBuilder.intList[screenNum],answers=_.filter(parent_interaction.blockItems.itemList,function(item){return item.choices[answerNum]&&item.choices[answerNum].selected});answersWithModel.items=_(answersWithModel.items).filter(function(item){return _(answers).contains(item.answer)}),parentNode.append(this.header_node);var tempAnswersWithModel=[];_.each(answers,function(answer){var model,last=_(answersWithModel.items).find(function(item){return item.answer==answer}),label=answer.choices[answerNum].label.clone();last?model=last.model:(model=new a5.models.interaction.ISCheckboxModel({alignment:parent_interaction.options.getChoiceAlignment()}),_.each(columns,function(column,i){var choiceModel=new a5.models.interaction.ISCheckboxChoiceModel({content:$("<div>"),parent:model,hasCheckbox:!parent_interaction.options.hideCheckboxesIsTrue(),enumeration:interaction.enumAnswers.next(),value:i.toString(),correct:!0,label:label});model.add(choiceModel)})),tempAnswersWithModel.push({answer:answer,model:model});var view=new a5.views.interaction.ISCheckboxView(model,!1,parent_interaction.options.hideCheckboxesIsTrue(),parent_interaction.options.showInColumnsIsTrue(),label);parentNode.append(view.render()),interaction.blockItems.add(model)},this),answersWithModel.items=tempAnswersWithModel}},a5.model_builder.Base.extend("a5.model_builder.ISCheckboxDynamic"),a5.model_builder.builders.push(new a5.model_builder.ISCheckboxDynamic),a5.model_builder.TargetGame={isResponsible:function(node,interaction){return node.is("choiceInteraction")&&"Identify:Select:Target game"==interaction.identifier},build:function(interaction,parentNode,node){var self=this;void 0===interaction.steps&&(interaction.steps=-1),interaction.steps++,interaction.curstep=0,this.interaction=interaction,parentNode.parent().addClass("tgm"),parentNode.parent().addClass("tgm_"+interaction.steps),this.correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")),_.each(_.shuffle($(node).find("simpleChoice")),function(n,index){var card=new a5.models.item.interaction.TargetGame(node),view=new a5.views.interaction.TargetGameView(n,index,self,interaction);card.isCorrect=view.isCorrect(),card.dom=$(view.render()),parentNode.append(view.render()),interaction.blockItems.add(card)}),setTimeout(function(){$(".tgm").hide(),$(".tgm_0").show(),$(".tgm").css("padding-left","10px")},100),interaction.firstCall||(interaction.firstCall=!0,interaction.onInteractionReadyListeners.register(this.attachEvents.bindTo(this)))},attachEvents:function(){var self=this;$(".tgm .click").on("click",function(){window.a5.mainBuilder.curInteraction.interactionDone||($(this).hasClass("click_correct")?$(this).addClass("clicked_correct tada").delay(1500).queue(function(next){self.interaction.curstep<self.interaction.steps&&$(".tgm_"+self.interaction.curstep).addClass("animated fadeOutDownBig").delay(500).queue(function(){$(".tgm").hide(),self.interaction.curstep++,$(".tgm_"+self.interaction.curstep).show(),$(".tgm_"+self.interaction.curstep).addClass("animated fadeIn"),next()})}):$(this).addClass("clicked_incorrect flap"))})}},Obj.extend("a5.model_builder.TargetGame",a5.model_builder.TargetGame),a5.model_builder.builders.push(new a5.model_builder.TargetGame),Obj.extend("a5.components.header_audio.HeaderAudioBuilder",{isResponsible:function(node,interaction){return node.is("div#headerAudio")},build:function(interaction,parentNode,node){var $headerAudioContainer=$('<div class="headerAudio headerAudio_'+interaction.index+'"></div>'),playing=null,playedFully=!1;parentNode.append($headerAudioContainer);var data=$.parseJSON(node.attr("data-author")),$html=$(window.a5.mainBuilder.layout.getTemplate("audio_widget")),$inlineTranscript=$(window.a5.mainBuilder.layout.getTemplate("media_transcript"));$html.attr("style",node.attr("style")),$html.css("height","48px"),$html.find(".transcript_button").data("isAudio",!0),$html.find(".the_audio").hide(),$headerAudioContainer.append($inlineTranscript.length?$('<div class="transcript-wrap audio">').append($html).append($inlineTranscript):$html),$headerAudioContainer.hide(),a5.service.media.audio.bind("ready",function(){playing=a5.service.media.audio.create(data.mediaID,{dontStop:!0,preload:!a5.dp.config.audioPreloadDisabled,persistVolume:a5.dp.config.audioVolumeStore}),a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(playing),playing.bind("stopped",function(){playedFully=!0}),a5.model_builder.audioVideoUtils.addInterfaceEvents($html,playing),playing.bind("progress seeked",function(pos){$html.find(".current_time").html(a5.utils.seconds_to_text(Math.floor(pos/1e3)));var length=parseInt($html.find(".progress_area").width(),10)/playing.duration()*pos;$html.find(".progress_played").css("width",length+"px")}),playing.bind("loadprogress",function(pos){$html.find(".duration").html(a5.utils.seconds_to_text(Math.floor(playing.duration()/1e3)))}),playing.bind("stopped paused",function(){$html.find(".pause").removeClass("pause").addClass("play")}),playing.bind("playing",function(){$html.find(".play").removeClass("play").addClass("pause")}),playing.bind("volume",function(){var vol=playing.volume(),vi=10-Math.round(10*vol);$html.find(".volume li").removeClass("volume-bar-active"),$html.find(".volume li").addClass(function(index){if(index>=vi)return"volume-bar-active"}),0==vol?$html.find(".volume .mute_button").removeClass("volume_button"):$html.find(".volume .mute_button").addClass("volume_button")}),playing.trigger("volume"),a5.model_builder.audioVideoUtils.linkSubtitles(data.mediaID,interaction,$html,playing),a5.model_builder.audioVideoUtils.linkTranscript(data.mediaID,interaction,$html,playing,$inlineTranscript),a5.model_builder.audioVideoUtils.linkKaraoke(data.mediaID,interaction,$html,playing)});function updateAudioWhenReady(currentInteraction){playing?updateAudio(currentInteraction):_.delay(_.bind(updateAudioWhenReady,this,currentInteraction),10)}function updateRubricWithAudioWhenReady(currentInteraction){playing?updateRubricWithAudio(currentInteraction):_.delay(_.bind(updateRubricWithAudioWhenReady,this,currentInteraction),10)}function updateAudio(currentInteraction){currentInteraction.index>=interaction.index&&currentInteraction.index<interaction.index+data.pages?("Exam"==LOInfo.mode&&"input"==currentInteraction.getStatus()&&(playedFully||playing.isPlaying()||playing.play()),$headerAudioContainer.show()):(playing.isPlaying()&&playing.pause(),$headerAudioContainer.hide())}function updateRubricWithAudio(currentInteraction){currentInteraction.index>=interaction.index&&currentInteraction.index<interaction.index+data.pages&&!currentInteraction.rubricZone.hasClass("withHeaderAudio")&&currentInteraction.rubricZone.addClass("withHeaderAudio"),currentInteraction!==interaction&&a5.model_builder.audioVideoUtils.linkKaraoke(data.mediaID,currentInteraction,$html,playing)}a5.callbacks.interaction.bind("loaded",updateRubricWithAudioWhenReady),a5.callbacks.interaction.bind("showed",updateAudioWhenReady),updateAudioWhenReady(a5.mainBuilder.curInteraction)}}),a5.model_builder.builders.push(new a5.components.header_audio.HeaderAudioBuilder),a5.model_builder.audioVideoUtils={},a5.model_builder.audioVideoUtils.closeTranscripts=function(transcripts){_.each(transcripts,function($transcript){$transcript.dialog("instance")?$transcript.dialog("close"):$transcript.find(".close").trigger("click")})},a5.model_builder.audioVideoUtils.linkTranscript=function(id_or_$node,interaction,$html,player,$inlineTranscript){var $node="string"==typeof id_or_$node?$(interaction.xml).find("#transcript #"+a5.utils.jquerySelectorEscape(id_or_$node)):id_or_$node,transcriptHTML=$node.text();interaction.transcriptDialogs||(interaction.transcriptDialogs=[],a5.eventBus.bind("transcript:close",function(){this.closeTranscripts(interaction.transcriptDialogs)},this));var transcriptString=transcriptHTML.replace(/&#62;/g,">").replace(/<\/p>/g,"").replace(/<p>/g,"").replace(/&#xd;/g,""),testRegexp=/\s?1\s?\n\s?\d\d:\d\d:\d\d(,\d\d\d)?\s*-->\s*\d\d:\d\d:\d\d(,\d\d\d)?/,$transcript=$inlineTranscript.length?$inlineTranscript.find(".transcript"):$html.find(".transcript"),$container=$html.closest(".is-content-zone");transcriptString.match(testRegexp)?a5.model_builder.audioVideoUtils.linkSrtTranscript($node,$transcript,interaction,$html,player):a5.model_builder.audioVideoUtils.linkRteTranscript($node,$transcript,interaction,$html,player),$html.find(".transcript_button").removeClass("inactive transcript_button_clicked"),$inlineTranscript.length?a5.model_builder.audioVideoUtils.setupTranscriptInline($inlineTranscript,$html):a5.model_builder.audioVideoUtils.setupTranscriptDialog($transcript,$container,interaction,$html,player)},a5.model_builder.audioVideoUtils.setupTranscriptInline=function($inlineTranscript,$html){$html.find(".transcript_button").on("click",function(e){var $button=$(this);$button.hasClass("transcript_button_clicked")?($inlineTranscript.removeClass("active"),$button.removeClass("transcript_button_clicked")):($inlineTranscript.addClass("active"),a5.utils.scrollIntoElementIfNeeded($inlineTranscript,{behavior:"smooth",block:"start",inline:"nearest"}),$button.addClass("transcript_button_clicked"))}),$inlineTranscript.find(".close").on("click",function(e){$inlineTranscript.removeClass("active"),$html.find(".transcript_button").removeClass("transcript_button_clicked")})},a5.model_builder.audioVideoUtils.setupTranscriptDialog=function($transcript,$container,interaction,$html,player){$transcript.dialog({autoOpen:!1,dialogClass:"transcript-dialog",height:300,close:function(e,ui){$html.find(".transcript_button").removeClass("inactive transcript_button_clicked")},open:function(e,ui){$html.find(".transcript_button").addClass("inactive transcript_button_clicked")}});var _transcriptPosition=function(){var position={};if($container.length>0){var playerHeight=$html.outerHeight(),containerHeight=$container.height(),playerTop=$html.offset().top,containerTop=$container.offset().top,containerBottom=containerTop+containerHeight,playerBottom=playerTop+playerHeight,overflowBottom=playerBottom+300>containerBottom;position=overflowBottom?{my:"right bottom",at:"right top",of:$html.find(".media-footer")}:{my:"right top",at:"right bottom",of:$html.find(".media-footer")}}else position={my:"right top",at:"right bottom",of:$html.find(".media-footer")};return position};interaction.bind("show hide",function(){$transcript.dialog("close")}),$html.find(".transcript_button").on("click",function(e){$transcript.dialog("isOpen")?$transcript.dialog("close"):(this.closeTranscripts(interaction.transcriptDialogs),a5.dp.config.positionedTranscript&&$transcript.dialog("option","position",_transcriptPosition()),$transcript.dialog("open")),e.stopPropagation()}.bind(this));var $transcriptParent;player.bind("fullscreenchange",function(isFullscreen){_.delay(function(){var $transcriptDialog=$transcript.dialog("widget");isFullscreen?($transcriptParent=$transcriptDialog.parent(),player.append($transcriptDialog)):$transcriptParent.append($transcriptDialog),a5.dp.config.positionedTranscript?$transcript.dialog("option","position",_transcriptPosition()):$transcript.dialog("option","position",_.extend({collision:"fit"},$transcript.dialog("option","position")))},100)})},a5.model_builder.audioVideoUtils.linkSrtTranscript=function($node,$transcript,interaction,$html,player){var transcript=new a5.models.SubtitlesModel;transcript.loadSRT($node.text()),transcript.empty()?$html.find(".transcript_button").hide():($html.addClass("with-transcript"),interaction.transcriptDialogs.push($transcript),_.each(transcript.all(),function(t){var $p=$('<p class="transcript-segment">'+t.text+"</p>");$transcript.append($p),$p.on("click",function(){player.position(1e3*t.from),player.isPlaying()||(a5.service.media.pauseAllExcept(player),player.play())})}),player.bind("progress seeked",function(pos){if($transcript.length>0){var previous=$transcript.children(".selected").removeClass("selected").index(),current=transcript.getCurrentIndex(pos/1e3);if(-1!==current){var $current=$transcript.children(".transcript-segment").eq(current);$current.addClass("selected"),current!==previous&&a5.utils.scrollIntoElementIfNeeded($current,{behavior:"smooth",block:"start",inline:"nearest"})}}}))},a5.model_builder.audioVideoUtils.linkRteTranscript=function($node,$transcript,interaction,$html,player){var transcriptHTML=$node.text();transcriptHTML&&0!=transcriptHTML.trim().length?($html.addClass("with-transcript"),interaction.transcriptDialogs.push($transcript),$transcript.append(transcriptHTML)):$html.find(".transcript_button").hide()},a5.model_builder.audioVideoUtils.linkSubtitles=function(id_or_$node,interaction,$html,player){var subtitles=new a5.models.SubtitlesModel,subtitlesEnabled=!1;id_or_$node.length>0&&subtitles.loadSRT("string"==typeof id_or_$node?$(interaction.xml).find("#subtitle #"+a5.utils.jquerySelectorEscape(id_or_$node)).text():id_or_$node.text());var $subtitles=$html.find(".subtitles");player.append($subtitles),$subtitles.hide(),subtitles.empty()?$html.find(".subtitles_button").hide():($html.addClass("with-subtitles"),$html.find(".subtitles_button").on("click",function(e){subtitlesEnabled?(subtitlesEnabled=!1,$(this).removeClass("inactive subtitles_button_clicked"),$subtitles.hide()):(subtitlesEnabled=!0,$(this).addClass("inactive subtitles_button_clicked"),$subtitles.show()),e.stopPropagation()}),player.bind("progress seeked",function(pos){var current=subtitles.getCurrent(pos/1e3),srt="";!_.isUndefined(current)&&current.text&&(srt=current.text.trim()),$subtitles.html(srt.split("\n").join("<br>"))}),$("body").is(".isIOS")&&this.linkSubtitlesForIOS(subtitles,player))},a5.model_builder.audioVideoUtils.linkSubtitlesForIOS=function(subtitles,player){var track=player.video.tag.addTextTrack("subtitles","English","en"),cues=subtitles.getVTTCues();_(cues).each(function(cue){track.addCue(cue)}),player.$video.attr("playsinline","playsinline"),player.bind("fullscreenchange",function(fullscreen){fullscreen||(track.mode="hidden")}.bind(this))},a5.model_builder.audioVideoUtils.linkKaraoke=function(id,interaction,$html,player){$(interaction.xml).find('karaoke[audio="'+id+'"]').length&&(player.bind("stopped",function(){interaction.$(".karaoke-playing").removeClass("karaoke-playing")}),player.bind("progress seeked",function(pos){if(interaction.karaoke){var karaoke=interaction.karaoke[id],current=karaoke&&karaoke.getCurrent(pos/1e3);!_.isUndefined(current)&&current.node.length>0?current.node.hasClass("karaoke-playing")||(interaction.$(".karaoke-playing").removeClass("karaoke-playing"),current.node.addClass("karaoke-playing"),a5.utils.scrollIntoElementIfNeeded(current.node,{behavior:"smooth",block:"start",inline:"nearest"})):interaction.$(".karaoke-playing").removeClass("karaoke-playing")}}))},a5.model_builder.audioVideoUtils.addInterfaceEvents=function($html,player){var doVol=!1;player.bind("progress seeked",function(pos){$html.trigger("progress",[pos,player.duration()])}),player.bind("volume",function(){$html.trigger("volume",player.volume())}),this.addProgressBarEvents($html,player);function adjustVolume(event){if(doVol){var x=event.clientX||event.originalEvent.touches&&event.originalEvent.touches[0].clientX,rect=this.getBoundingClientRect(),pos=x-rect.left,size=rect.width,level=Math.max(Math.min(pos/size,1),0);$html.find(".volume_level").css("width",100*level+"%"),player.volume(level)}}$html.find(".volume_area").on("touchstart mousedown",function(e){doVol=!0,$html.addClass("media-adjusting-volume")}).on("touchmove mousemove",function(e){e.preventDefault(),adjustVolume.call(this,e)}),$("body").on("touchend mouseup",function(e){adjustVolume.call($html.find(".volume_area").get(0),e),doVol=!1,$html.removeClass("media-adjusting-volume")}),$html.find("[data-speed]").click(function(e){player.rate(parseFloat($(e.currentTarget).data("speed")))}),$html.on("click",".play",function(e){player.isPlaying()||(a5.service.media.pauseAllExcept(player),player.play()),e.stopPropagation()}),$html.on("click",".pause",function(e){player.pause(),e.stopPropagation()}),$html.find(".volume .mute_button").on("click",function(e){0==player.volume()?player.volume(a5.service.media.savedVolume||.5):(a5.service.media.savedVolume=player.volume(),player.volume(0)),e.stopPropagation()}),$html.find(".volume li").on("click",function(e){var vol=Math.round(10-$(this).index())/10;player.volume(vol),e.stopPropagation()}),$html.find(".back").on("click",function(e){player.position(0)}),$html.find(".stop").on("click",function(e){player.stop()});function addToggle(toggle,node){var $toggle=$html.find(toggle),$node=$html.find(node);$html.find(toggle).on("click",function(e){$node.is(":visible")?($node.hide(),$toggle.removeClass("active")):($node.show(),$toggle.addClass("active"))})}addToggle(".progress_toggle",".progress_wrap"),addToggle(".volume_toggle",".volume_wrap")},a5.model_builder.audioVideoUtils.removeInterfaceEvents=function($html){$html.off(),$html.find(".volume_area").off(),$html.find("[data-speed]").off(),$html.find(".volume .mute_button").off(),$html.find(".volume li").off(),$html.find(".back").off(),$html.find(".stop").off(),$html.find(".progress_toggle").off(),$html.find(".volume_toggle").off()},a5.model_builder.audioVideoUtils.addAudioPlayerEvents=function(audio,$html){audio.bind("progress seeked",function(pos){$html.find(".current_time").html(a5.utils.seconds_to_text(Math.floor(pos/1e3)));var progress=Math.round(pos/audio.duration()*1e4)/100;$html.find(".progress_played").css("width",progress+"%")}),audio.bind("loadprogress",function(pos){$html.find(".duration").html(a5.utils.seconds_to_text(Math.floor(audio.duration()/1e3)))}),audio.bind("stopped paused",function(){$html.find(".pause").removeClass("pause").addClass("play")}),audio.bind("playing",function(){$html.find(".play").removeClass("play").addClass("pause")}),audio.bind("volume",function(){var vol=audio.volume(),vi=10-Math.round(10*vol);$html.find(".volume li").removeClass("volume-bar-active"),$html.find(".volume li").addClass(function(index){if(index>=vi)return"volume-bar-active"}),0==vol?$html.find(".volume .mute_button").removeClass("volume_button"):$html.find(".volume .mute_button").addClass("volume_button")}),audio.trigger("volume"),a5.model_builder.audioVideoUtils.addInterfaceEvents($html,audio)},a5.model_builder.audioVideoUtils.addVideoPlayerEvents=function(video,$html){video.append($html.find("#close-fullscreen-video")),video.bind("ready",function(){video.trigger("volume"),a5.model_builder.audioVideoUtils.addInterfaceEvents($html,video),$html.addClass("with-fullscreen"),$html.find(".full_screen").on("click",function(){video.isFullscreen()?video.cancelFullscreen():video.fullscreen()}),$html.find("#close-fullscreen-video").on("click",function(){video.cancelFullscreen()})}),video.bind("progress seeked",function(pos){$html.find(".current_time").html(a5.utils.seconds_to_text(Math.floor(pos/1e3)));var progress=Math.round(pos/video.duration()*1e4)/100;$html.find(".progress_played").css("width",progress+"%")}),video.bind("loadprogress durationchange",function(){$html.find(".duration").html(a5.utils.seconds_to_text(Math.floor(video.duration()/1e3)))}),video.bind("stopped paused",function(){$html.find(".pause").removeClass("pause").addClass("play"),$html.removeClass("playing")}),video.bind("playing",function(){$html.find(".play").removeClass("play").addClass("pause"),$html.addClass("playing")}),video.bind("volume",function(){var vol=video.volume(),vi=10-Math.round(10*vol);$html.find(".volume li").removeClass("volume-bar-active"),$html.find(".volume li").addClass(function(index){if(index>=vi)return"volume-bar-active"}),$html.find(".volume .mute_button").toggleClass("volume_button",!!vol)});var $footer=$html.find(".video_footer");video.bind("fullscreenchange",function(fullscreen){fullscreen?(video.append($footer),$("body").addClass("isFullScreen"),$html.find(".video_wrapper").addClass("full_screen")):($html.find(".the_video").after($footer),$html.find(".video_wrapper").removeClass("full_screen"),$("body").removeClass("isFullScreen"))})},a5.model_builder.audioVideoUtils.addProgressBarEvents=function($html,player){var seekBar=new a5.model_builder.audioVideoUtils.AudioVideoSlider({$el:$html.find(".progress_area"),$current:$html.find(".current_time"),player:player});seekBar.bind("start",function(){$html.addClass("media-seeking")}),seekBar.bind("end",function(){$html.removeClass("media-seeking")}),seekBar.render()},a5.model_builder.audioVideoUtils.AudioVideoSlider={TEMPLATE:'<div class="progress_area"><div class="progress_downloaded" style="width: 100%;"></div><div class="progress_played" style="width: 0%;"></div></div>',init:function(parameters){this.$el=parameters.$el||$(this.TEMPLATE),this.$played=this.$el.find(".progress_played"),this.$downloaded=this.$el.find(".progress_downloaded"),this.$current=parameters.$current,this.player=parameters.player,_.bindAll(this,"onStart","onMove","onEnd","onClick","calculateOffset"),this.calculateOffsetOnce=_.once(this.calculateOffset),this.unbindEvents(),this.bindEvents()},bindEvents:function(){this.$el.on("mousedown touchstart",this.onStart),this.$el.on("click",this.onClick),this.player.bind("progress seeked",this.onPlayerProgress,this)},unbindEvents:function(){this.$el.off("mousedown touchstart",this.onStart),this.$el.off("click",this.onClick),this.player.unbind("progress seeked",this.onPlayerProgress)},onStart:function(e){e.preventDefault(),this.blockTextSelection(),$(document).on("mousemove touchmove",this.onMove),$(document).on("mouseup touchend",this.onEnd),this.onMove(e),this.trigger("start")},onMove:function(e){var newTime=this.calculateDistance(e)*this.player.duration();newTime===this.player.duration()&&(newTime-=.1),this.$current.html(a5.utils.seconds_to_text(Math.floor(newTime/1e3))),this.player.position(newTime)},onEnd:function(e){this.unblockTextSelection(),$(document).off("mousemove touchmove",this.onMove),$(document).off("mouseup touchend",this.onEnd),this.update(),this.resetOffset(),this.trigger("end")},onClick:function(e){e.stopImmediatePropagation(),e.preventDefault()},onPlayerProgress:function(pos){this.update()},render:function(){return this.$el},update:function(){var progress=this.percent();isNaN(progress)&&(progress=0),this.$played.css("width",progress+"%")},calculateDistance:function(event){var pageX,total=this.$el.get(0).getBoundingClientRect(),played=this.$played.get(0).getBoundingClientRect(),handleW=parseInt(window.getComputedStyle(this.$played.get(0),":after").getPropertyValue("width"),10),handleX=played.right-handleW/2;return pageX=event.originalEvent.changedTouches?event.originalEvent.changedTouches[0].pageX:event.pageX,pageX-=this.calculateOffsetOnce(pageX,handleX,handleW),Math.max(0,Math.min(1,(pageX-total.left)/total.width))},calculateOffset:function(pageX,handleX,handleW){var offset=0;return pageX>handleX&&pageX<handleX+handleW&&(offset=pageX-handleX-handleW/2),offset},resetOffset:function(){this.calculateOffsetOnce=_.once(this.calculateOffset)},percent:function(){return Math.round(this.player.position()/this.player.duration()*1e4)/100},blockTextSelection:function(){document.body.focus(),document.onselectstart=function(){return!1}},unblockTextSelection:function(){document.onselectstart=function(){return!0}}},Obj.extend("a5.model_builder.audioVideoUtils.AudioVideoSlider"),a5.model_builder.Audio={isResponsible:function(node,interaction){var responsible=node.is("object[type='audio/audio']");return responsible=responsible&&!(new a5.model_builder.DragDropUtils).isResponsible(node,interaction)},build:function(interaction,parentNode,node){var tinyplayer=parentNode.closest(".contentblock").length>0||node.closest("#contentblock").length>0;0==(node.attr("alt")||"").indexOf("player:")&&(tinyplayer=!1),0==(node.attr("alt")||"").indexOf("icon:")&&(tinyplayer=!0);var $rendered;$rendered=tinyplayer?this.buildTinyPlayer(interaction,parentNode,node):a5.dp.config.audioUseNativeControls?this.buildNativePlayer(interaction,parentNode,node):this.buildFullPlayer(interaction,parentNode,node),interaction.options.audioingapIsOn()&&(node.next().find("textEntryInteraction").andSelf().is("textEntryInteraction")||node.next().find("inlineChoiceInteraction").andSelf().is("inlineChoiceInteraction"))&&($rendered=$('<span class="audio-gap">').append($rendered)),parentNode.append($rendered)},buildNativePlayer:function(interaction,parentNode,node){var $html=$("<div class='mediaPlayer mediaPlayer--audio mediaPlayer--native'></div>");a5.service.media.audio.bind("ready",function(){var playing=a5.service.media.audio.create(node.attr("data"),{preload:!a5.dp.config.audioPreloadDisabled,persistVolume:a5.dp.config.audioVolumeStore,nativeAudio:!0});$html.attr("data-playable-media",playing.uid);var $audio=$(playing.audioObject);playing.bind("start",function(){a5.service.media.pauseAllExcept(playing)}),$html.append($audio)}),parentNode.append($html)},buildFullPlayer:function(interaction,parentNode,node){var $html=$(window.a5.mainBuilder.layout.getTemplate("audio_widget")),$inlineTranscript=$(window.a5.mainBuilder.layout.getTemplate("media_transcript"));return $html.attr("style",node.attr("style")),$html.css("height",""),$html.find(".transcript_button").data("isAudio",!0),$html.find(".the_audio").hide(),$html.toggleClass("with-speed",interaction.options.audiospeedIsOn()),a5.service.media.audio.bind("ready",function(){var playing=a5.service.media.audio.create(node.attr("data"),{preload:!a5.dp.config.audioPreloadDisabled,persistVolume:a5.dp.config.audioVolumeStore});$html.attr("data-playable-media",playing.uid),a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(playing),a5.model_builder.audioVideoUtils.addInterfaceEvents($html,playing),playing.bind("progress seeked",function(pos){$html.find(".current_time").html(a5.utils.seconds_to_text(Math.floor(pos/1e3)));var progress=Math.round(pos/playing.duration()*1e4)/100;$html.find(".progress_played").css("width",progress+"%")}),playing.bind("loadprogress",function(pos){$html.find(".duration").html(a5.utils.seconds_to_text(Math.floor(playing.duration()/1e3)))}),playing.bind("stopped paused",function(){$html.find(".pause").removeClass("pause").addClass("play")}),playing.bind("playing",function(){$html.find(".play").removeClass("play").addClass("pause")}),playing.bind("volume",function(){var vol=playing.volume(),vi=10-Math.round(10*vol);$html.find(".volume li").removeClass("volume-bar-active"),$html.find(".volume li").addClass(function(index){if(index>=vi)return"volume-bar-active"}),0==vol?$html.find(".volume .mute_button").removeClass("volume_button"):$html.find(".volume .mute_button").addClass("volume_button")}),playing.trigger("volume"),a5.model_builder.audioVideoUtils.linkSubtitles(node.attr("data"),interaction,$html,playing),a5.model_builder.audioVideoUtils.linkTranscript(node.attr("data"),interaction,$html,playing,$inlineTranscript),a5.model_builder.audioVideoUtils.linkKaraoke(node.attr("data"),interaction,$html,playing)}),node.attr("style")&&node.attr("style").match(/option023/i)&&$html.attr("data-option023",!0),$inlineTranscript.length?$('<div class="transcript-wrap audio">').append($html).append($inlineTranscript):$html},buildTinyPlayer:function(interaction,parentNode,node){var hasPauseBehaviour=interaction.options.audioiconbehaviourIsPause(),$tp=$("<span role='button' tabindex='0' class='playbutton inactive'></span>");$tp.toggleClass("show-pause-on-playing",hasPauseBehaviour);var $playspeed;interaction.options.audiospeedIsOn()&&($playspeed=$("<span role='button' tabindex='0' class='playbutton playspeed'></span>")),a5.service.media.audio.bind("ready",function(){var playing=!1,tinyAudio=a5.service.media.audio.create(node.attr("data"),{preload:!a5.dp.config.audioPreloadDisabled});$tp.attr("data-playable-media",tinyAudio.uid),a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(tinyAudio),tinyAudio.bind("paused stopped",function(){$tp.removeClass("playing"),playing=!1}),tinyAudio.bind("playing",function(){$tp.addClass("playing"),playing=!0});var togglePlay=function(){playing?hasPauseBehaviour?tinyAudio.pause():tinyAudio.stop():(a5.service.media.pauseAllExcept(tinyAudio),tinyAudio.play())};if($tp.on("click",function(e){togglePlay(),$tp.trigger("tp:click"),e.stopPropagation()}),$tp.on("keydown",function(e){var KEYS=(e.currentTarget,a5.utils.keyCodes);switch(e.keyCode){case KEYS.SPACE:case KEYS.ENTER:togglePlay();break;default:return}e.stopPropagation(),e.preventDefault()}),$playspeed){var togglePlaySpeed=function(){$playspeed.is(".active")?($playspeed.removeClass("active"),tinyAudio.rate(1)):($playspeed.addClass("active"),tinyAudio.rate(a5.dp.config.audioTinyPlayerPlayspeedButton))};$playspeed.on("click",function(e){togglePlaySpeed(),e.stopPropagation()}),$playspeed.on("keydown",function(e){var KEYS=(e.currentTarget,a5.utils.keyCodes);switch(e.keyCode){case KEYS.SPACE:case KEYS.ENTER:togglePlaySpeed();break;default:return}e.stopPropagation(),e.preventDefault()})}$tp.removeClass("inactive"),a5.model_builder.audioVideoUtils.linkKaraoke(node.attr("data"),interaction,$tp,tinyAudio)});var $node,width=parseInt($tp.measure("width")||0,10)+parseInt($tp.measure("border-width")||0,10),height=parseInt($tp.measure("height")||0,10)+parseInt($tp.measure("border-width")||0,10),style=node.attr("style");return $playspeed?($node=$("<span class='playbutton-wrap'>"),$node.attr("style",style),$node.css("width",""),$node.css("height",""),$node.append($tp),$node.append($playspeed)):($tp.attr("style",style),
$node=$tp),width>0&&$tp.css("width",width),height>0&&$tp.css("height",height),style&&style.match(/option023/i)&&$node.attr("data-option023",!0),$node}},Obj.extend("a5.model_builder.Audio",a5.model_builder.Audio),a5.model_builder.builders.push(new a5.model_builder.Audio),a5.model_builder.Video={isResponsible:function(node,interaction){return node.is("object[type='video/video']")||node.is("video")},build:function(interaction,parentNode,node){this.original_node=node,node.is("object")?a5.dp.config.videoUseNativeControls?this.buildNative(interaction,parentNode,node):this.buildObject(interaction,parentNode,node):node.is("video")&&this.buildVideo(interaction,parentNode,node)},buildVideo:function(interaction,parentNode,node){var object=$("<object>");object.attr("type","video/video"),object.attr("id",node.attr("id")),object.attr("startingtime",node.attr("startingtime")),node.attr("autoplay")&&"false"!=node.attr("autoplay")?object.attr("autoplay",node.attr("autoplay")):node.data("autoplay")&&"false"!=node.data("autoplay")&&object.attr("autoplay",node.data("autoplay")),object.attr("style",node.attr("style")),object.css("width",node.attr("width")),object.css("height",node.attr("height"));var data=node.attr("poster").match(/S3_.+?\./);data&&data[0]?object.attr("poster",data[0].replace(".","")):object.attr("poster",node.attr("poster")),data=node.find("source").attr("src"),(data=data.match(/S3_.+?\./))&&data[0]&&(data=data[0].replace(".",""),object.attr("data",data),a5.dp.config.videoUseNativeControls?this.buildNative(interaction,parentNode,$(object)):this.buildObject(interaction,parentNode,$(object)))},getDimensions:function(node){var tempNode=$("<div></div>").attr("style",node.attr("style"));return{width:parseInt(tempNode.css("width"),10),height:parseInt(tempNode.css("height"),10)}},getAutoplay:function(node){return node.attr("autoplay")&&"false"!=node.attr("autoplay")},getSetupAutoplay:function(interaction,node){var setupAutoplay=_.noop;if(this.getAutoplay(node))if(a5.service.Attachment.currentAttachment){var attachment=a5.service.Attachment.currentAttachment;setupAutoplay=function(video){attachment.onAttachmentOpenListeners.register(function(){video.play()})}}else setupAutoplay=function(video){interaction.bind("show:deferred",function(){_.defer(function(){video.play()})})};return setupAutoplay},getVideoTemplate:function(node){var $html=$(window.a5.mainBuilder.layout.getTemplate("video_widget"));$html.attr("style",node.attr("style")),$html.attr("class","video v_a_media"),_.isUndefined(node.attr("class"))||$html.addClass(node.attr("class")),navigator.userAgent.match(/(iPad|iPod|iPhone)/)&&$html.find(".volume").hide();var aspectRatio=this._extractAspectRatio(node);return aspectRatio&&$html.attr("data-aspect-ratio",aspectRatio),$html},getInlineTranscript:function(){return $(window.a5.mainBuilder.layout.getTemplate("media_transcript"))},buildNative:function(interaction,parentNode,node){var $target=$('<div class="mediaPlayer mediaPlayer--video mediaPlayer--native"></div>'),videoSize=this.getDimensions(node);$target.css({width:videoSize.width,height:videoSize.height});var video=a5.service.media.video.create(node.attr("data"),$target,{poster:node.attr("poster")});this.getSetupAutoplay(interaction,node)(video),this.setupStartingTime(video,parseInt(node.attr("startingtime"),10)),video.$video.attr("controls",!0),parentNode.append($target)},setupStartingTime:function(video,startingtime){if(startingtime){video.bind("cansetstartingtime",function(){video.position(1e3*startingtime)});var ua=a5.utils.parseUserAgent();(ua.isIOS||ua.isIpadOS)&&video.bind("ready",function(){video.load()},this,{once:!0})}},buildObject:function(interaction,parentNode,node){var videoSize=this.getDimensions(node),$html=this.getVideoTemplate(node),$inlineTranscript=this.getInlineTranscript();parentNode.append($inlineTranscript.length?$('<div class="transcript-wrap video">').append($html).append($inlineTranscript):$html);var $target=$html.find(".the_video");node.attr("style")&&node.attr("style").match(/option023/i)&&$target.attr("data-option023",!0),this.original_node.is("object")?($target.css({width:videoSize.width,height:videoSize.height-107}),$html.height($html.find(".video_wrapper").height())):$target.css({width:videoSize.width,height:videoSize.height});var setupAutoplay=this.getSetupAutoplay(interaction,node),setupStartingTime=this.setupStartingTime;interaction.onInteractionReadyListeners.register(function(options){if(!options.tryAgain){var video=a5.service.media.video.create(node.attr("data"),$target,{poster:node.attr("poster")});setupAutoplay(video),setupStartingTime(video,parseInt(node.attr("startingtime"),10)),a5.model_builder.audioVideoUtils.addVideoPlayerEvents(video,$html),a5.model_builder.audioVideoUtils.linkSubtitles(node.attr("data"),interaction,$html,video),a5.model_builder.audioVideoUtils.linkTranscript(node.attr("data"),interaction,$html,video,$inlineTranscript)}})},_extractAspectRatio:function(node){var w=parseFloat(a5.utils.getStyleValue(node.attr("style"),"width")),h=parseFloat(a5.utils.getStyleValue(node.attr("style"),"height"));return Math.round(1e3*w/h)/1e3}},Obj.extend("a5.model_builder.Video",a5.model_builder.Video),a5.model_builder.builders.push(new a5.model_builder.Video),a5.model_builder.ExamTimer={WARNING_DURATION:10,init:function(args){_.extend(this,args),this.elapsed=0,this.elapsedExtra=0,this._onExtraTime=!1,this._lastTick,this._lastElapsedTriggered,this.view=new a5.view.ExamTimer(this),a5.callbacks.controls.bar.bind("added",this.onControlsAdded,this)},render:function(){$("#timer").append(this.view.render())},getElapsedTime:function(){return this.elapsed+this.elapsedExtra},isOnExtraTime:function(){return this._onExtraTime},startOnShow:function(interactions){_.isUndefined(this.lo.examTimeOnExtraTime)||(this._onExtraTime=this.lo.examTimeOnExtraTime),_.isUndefined(this.lo.examTimeElapsed)||(this.elapsed=Math.min(this.time,this.lo.examTimeElapsed),this.elapsedExtra=this.lo.examTimeElapsed-this.elapsed),_.each(interactions,function(interaction){interaction.bind("show:deferred",function(){!this.lo.canSubmit||!this.lo.hasMoreSubmitAttempts()||"on"!==this.countIntroScreen&&interaction.isIntroScreen()||this.start()},this,{once:!0})},this)},start:function(){this._lastTick||(this.trigger("start"),this._lastTick=Math.floor(+new Date/1e3),this._checkTimeout()||(this.tick(),this.interval=setInterval(_.bind(function(){this.tick()},this),1e3)))},startExtraTime:function(){this._lastTick=null,this._onExtraTime=!0,clearInterval(this.interval),this.start()},tick:function(elapsed){var newTick=Math.floor(+new Date/1e3);this._onExtraTime?this.elapsedExtra+=newTick-this._lastTick:this.elapsed+=newTick-this._lastTick,this._lastTick=newTick,this._checkFirstWarning(),this._checkSecondWarning(),this._checkTimeout(),this._lastElapsedTriggered!==this.elapsed&&(this.trigger("update",this.elapsed),this._lastElapsedTriggered=this.elapsed)},stop:function(){this.interval&&clearInterval(this.interval),this.view.remove()},getTime:function(){return _.max([this.time-this.elapsed,0])},getTimeString:function(seconds){return"H:MM:SS"===this.timeFormat?this._hmmssFormat(seconds):this._floorTimeStringFormat(seconds)},getTimeoutString:function(seconds){return"H:MM:SS"===this.timeFormat?this._hmmssFormat(seconds):this._ceilTimeStringFormat(seconds)},onControlsAdded:function(){this.render()},_checkTimeout:function(){if(this.time-this.elapsed<=0&&!this._onExtraTime)return this.interval&&clearInterval(this.interval),this.elapsed=this.time,this.trigger("timeout"),!0},_checkFirstWarning:function(){!this._onExtraTime&&this.first_warning&&(this.time-this.elapsed===this.first_warning?this.trigger("first_warning",this.first_warning_text):this.time-this.elapsed==this.first_warning-this.WARNING_DURATION&&this.trigger("first_warning_end"))},_checkSecondWarning:function(){!this._onExtraTime&&this.second_warning&&(this.time-this.elapsed===this.second_warning?this.trigger("second_warning",this.second_warning_text):this.time-this.elapsed==this.second_warning-this.WARNING_DURATION&&this.trigger("second_warning_end"))},_floorTimeStringFormat:function(seconds){var minutes=Math.floor(seconds/60),sec=seconds-60*minutes;return sec<10&&(sec="0"+sec),minutes>0?"<span class='number'>"+minutes+"</span>&nbsp;minutes":"<span class='number'>"+sec+"</span>&nbsp;seconds"},_ceilTimeStringFormat:function(seconds){var minutes=Math.floor(seconds/60),sec=seconds-60*minutes;return sec<10&&(sec="0"+sec),minutes>0?"<span class='number'>"+("00"===sec?minutes:minutes+1)+"</span>&nbsp;minutes left":"<span class='number'>"+sec+"</span>&nbsp;seconds left"},_hmmssFormat:function(seconds){var h=Math.floor(seconds/3600),m=Math.floor(seconds%3600/60),s=Math.floor(seconds%3600%60),t="";return this.with_hours&&(t+=h+":"),t+=("00"+m).slice(-2)+":"+("00"+s).slice(-2)}},Obj.extend("a5.model_builder.ExamTimer"),a5.view.ExamTimer={TIMER_TEMPLATE:"<div class='exam-timer'><div class='timer-message'></div><div class='time'></div></div>",init:function(parent){this.node=$(this.TIMER_TEMPLATE),this.node.hide(),this.node.find(".time").html(" "),this.parent=parent,this.parent.bind("start",_.bind(this.onStart,this)),this.parent.bind("first_warning",_.bind(this.warning,this)),this.parent.bind("second_warning",_.bind(this.warning,this)),this.parent.bind("first_warning_end",_.bind(this.warningEnd,this)),this.parent.bind("second_warning_end",_.bind(this.warningEnd,this)),this.parent.bind("update",_.bind(this.update,this)),this.parent.bind("timeout",_.bind(this.timeout,this)),_.bindAll(this,"submit","onContinue")},onStart:function(){this.node.show()},timeout:function(){this.dialog=new a5.view.Dialog;var beforeCloseFn;"force_submit"===this.parent.timeoutType?beforeCloseFn=this.submit:"allow_to_continue"===this.parent.timeoutType&&(beforeCloseFn=this.onContinue);this.dialog.display("a5.view.dialog.TimeOut",{dialogClass:"timer-finished",heading:this.parent.dialogHeading,text:this.parent.dialogContent,submitLabel:this.parent.dialogSubmitLabel,continueLabel:this.parent.dialogContinueLabel,submitTooltip:this.parent.dialogSubmitTooltip,continueTooltip:this.parent.dialogContinueTooltip,allowContinue:"allow_to_continue"===this.parent.timeoutType},{submit:this.submit,cancel:this.onContinue},beforeCloseFn);$("body").addClass("dialog-no-overlay")},submit:function(){this.submitted||(this.submitted=!0,$("body").removeClass("dialog-no-overlay"),this.parent.lo.hasMoreSubmitAttempts()&&this.parent.lo.submit(!0))},onContinue:function(){this.parent.startExtraTime()},warning:function(warning_text){if(this.node.addClass("warning"),warning_text&&""!==warning_text.trim()){var text=warning_text.replace(/(\d+)/,"<span class='number'>$1</span>");this.node.find(".timer-message").html(text)}},warningEnd:function(){this.node.removeClass("warning")},update:function(elapsed){var html=this.humanize_seconds(this.parent.time-elapsed);this.node.find(".time").html(html)},render:function(){return this.node},remove:function(){this.node.remove()},humanize_seconds:function(seconds){return this.parent.getTimeoutString(seconds)}},Obj.extend("a5.view.ExamTimer"),a5.model_builder.Clock={isResponsible:function(node,interaction){return node.is("clock")},buildClock:function(interaction,parentNode,node){var model=new a5.model.Clock({startTime:node.text(),className:node.attr("class"),locked:(node.attr("options")||"").match(/\block\b/)});parentNode.append(new a5.view.Clock(model).render())}},a5.model_builder.Base.extend("a5.model_builder.Clock"),a5.model_builder.builders.push(new a5.model_builder.Clock),a5.model_builder.ISDropdownBuilder={isResponsible:function(node,interaction){return node.is("inlineChoiceInteraction")&&"Identify:Select:Dropdown"==interaction.identifier},buildInlineChoiceInteraction:function(interaction,parentNode,node){var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")).values,model=new a5.models.interaction.ISDropdownModel({prefill:interaction.prefill.isPrefill(),placeholder:node.attr("data-author"),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),parent:interaction.blockItems,allowRepeat:interaction.options.repeatAnswersIsAllow(),hasOrderedResponses:interaction.options.orderDependencyIsOn(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),labelStyle:node.attr("style")}),hasImages=!!node.find("inlineChoice img").length;_.each(this.fetchChoices(interaction,node,"inlineChoice"),function(e,index){var $contentNode=$(e),$content=null;if(0==$contentNode.children().length){var text=$contentNode.text();text.indexOf(">")>-1&&text.indexOf("<")>-1&&($content=$(text))}null==$content&&($content=$("<div></div>"),interaction.buildModels($content,$contentNode.contents()),$content=$content.contents());var choiceModel=new a5.models.interaction.ISDropdownChoiceModel({content:$content,key:$(e).attr("identifier"),parent:model,correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect()});choiceModel.assignAnswerFeedback($(e)),model.add(choiceModel),_(correctResponse).contains($(e).attr("identifier"))&&(model.setCorrect(choiceModel),choiceModel.setCorrectIndex(_(correctResponse).indexOf($(e).attr("identifier"))))});var view;interaction.options.choiceAlignmentIsHorizontal()?view=new a5.views.interaction.ISHorizontalSelect(model):(view=a5.dp.config.dropdownNativeSelect&&!hasImages?new a5.views.interaction.ISNativeDropdownView(model):new a5.views.interaction.ISRichDropdownView(model),a5.callbacks.interaction.bind("loaded",function(i){i===interaction&&this.addWordClasses(view.node,".wrapper-dropdown")},this));var rendered=view.render();interaction.bind("show:deferred",function(){interaction.options.gapsIsSamelongest()&&view.adjustSameLongestWidth(),view.show()}),view.hide(),interaction.options.audioingapIsOn()?parentNode.is(".element-wrap")&&node.closest(".element-wrap").prev().is("object[type='audio/audio']")?(parentNode.append(rendered),parentNode.siblings(".audio-gap").last().append(parentNode)):node.prev().is("object[type='audio/audio']")?parentNode.find(".audio-gap").last().append(rendered):parentNode.append(rendered):parentNode.append(rendered);var enumeration=interaction.enumAnswers.next();enumeration&&enumeration.then(function(enumSymbol){rendered.before(enumSymbol),rendered.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}),"Exam"!==LOInfo.mode&&"Trainer"!==LOInfo.mode||0==interaction.blockItems.itemList.length&&interaction.bind("show:deferred",function(){rendered.focus()}),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.ISDropdownBuilder"),a5.model_builder.builders.push(new a5.model_builder.ISDropdownBuilder),a5.model_builder.ICTextGap={isResponsible:function(node,interaction){return node.is("textEntryInteraction")&&"Input:Completion:Text gap"==interaction.identifier&&!interaction.options.gapsIsInvisible()},_buildWordpool:function(interaction,node){if(node.find(".pool").length)return{pool:node.find(".pool").first(),block:node.find(".block").first()};var wordpool=new a5.views.WordPool(interaction.options.getPoolAlignment(),!1,interaction),words=_.map(interaction.getAllResponseDeclaration(),function(rD){return rD.values});return words=_.map(words,function(answers){return a5.utils.containsUnescaped(answers.join(""),"|")?_.filter(answers,function(answer){return a5.utils.containsUnescaped(answer,"|")||a5.utils.startsWith(answer,"**")}):answers}),words=_.map(_.flatten(words),function(word){return a5.utils.startsWith(word,"**")&&(word=word.replace("**","")),word=word.split("##").shift()}),words=_(words).uniq(),words=_.map(words,function(word){return a5.utils.splitUnescaped(word,"|").pop()}),words=_(words).filter(function(word){return"%0"!==word}),words=_(words).map(function(word){return a5.utils.unescapeReservedSyntaxSymbols(word)}),interaction.options.randomiseanswersIsTrue()?words=_.shuffle(words):interaction.options.poolorderIsAlphabetical()?words=a5.utils.array.sortBy(words,null,!0):interaction.options.poolorderIsNatural()&&(words=a5.utils.array.naturalSort(words,null,!0,!0)),_.each(words,function(word){wordpool.append(word,interaction.options.gaptextaudioIsTrue())},this),node.append(wordpool.render()),{pool:node.find(".pool").first(),block:node.find(".block").first()}},buildTextEntryInteraction:function(interaction,parentNode,node){var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")),answers=_.map(correctResponse.values,function(val){return htmlDecode(val)}),wordpool=this._buildWordpool(interaction,interaction.$(".interaction")),areaSize=null;"free"!==interaction.options.getPoolAlignment()?interaction.$(".contentblock").appendTo(wordpool.block):wordpool.pool.parent().prependTo(interaction.$(".interaction")),node.attr("height")&&node.attr("width")&&(areaSize=[node.attr("width"),node.attr("height")]);var display_words=_.chain(answers).filter(function(answer){return a5.utils.containsUnescaped(answer,"|")}).map(function(answer){return a5.utils.splitUnescaped(answer,"|").pop()}).value();answers=_.map(answers,function(answer){return _.first(a5.utils.splitUnescaped(answer,"|"))});var distractors=[];answers=_(answers).reject(function(answer){return!!_.str.startsWith(answer,"**")&&(distractors.push(answer.replace("**","")),!0)});var answerWithGroup=_(answers).find(function(answer){return _.str.contains(answer,"##")}),group=answerWithGroup&&answerWithGroup.split("##").pop();answers=_(answers).map(function(answer){return _.first(answer.split("##"))}),answers=_(answers).map(function(answer){return a5.utils.unescapeReservedSyntaxSymbols(answer)}),display_words=_(display_words).map(function(answer){return a5.utils.unescapeReservedSyntaxSymbols(answer)});var enumeration=interaction.enumAnswers.next();if(!interaction.blockItems.gapCollectionModel&&(interaction.blockItems.gapCollectionModel=new a5.models.interaction.ICTextGapCollection({parent:interaction.blockItems,ignoreCase:interaction.options.caseInsensitiveIsTrue(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),hasOrderedResponsesFirstAnswer:interaction.options.orderDependencyIsFirst_answer()}),!interaction.options.orderDependencyIsOff())){var interactionBlock=interaction.blockItems,oldFn=interactionBlock.getScores;interactionBlock.getScores=_.bind(function(){return group?interactionBlock.gapCollectionModel.updateOrderDependencyGroups():interactionBlock.gapCollectionModel.updateOrderDependency(),oldFn.apply(interactionBlock)},this)}var model=new a5.models.interaction.ICTextGap({enumeration:enumeration,global_enumeration:a5.mainBuilder.options(!0).continuousEnumerationIsOn(),prefill:!_.isEmpty(answers)&&interaction.prefill.isPrefill(),correct:answers,distractors:distractors,display_words:display_words,wordpool:wordpool,area:areaSize,tryAgainKeep:interaction.options.tryAgainIsKeepall(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreSpaces:interaction.options.ignoreSpacesIsOn(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),spellcheck:interaction.options.spellcheckIsOn(),parent:interaction.blockItems.gapCollectionModel,allowRepeat:interaction.options.repeatAnswersIsAllow(),hasOrderedResponses:!interaction.options.orderDependencyIsOff(),resizeGaps:interaction.options.gapResizeIsOn(),charactersNumber:interaction.options.gapcharactersIsShow(),group:group,blockNumber:interaction.items.length,tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),inputStyle:node.attr("style")});model.assignAnswerFeedback(node);var view=new a5.views.interaction.ICTextGap(model),rendered=view.render();if(interaction.options.audioingapIsOn()?parentNode.is(".element-wrap")&&node.closest(".element-wrap").prev().is("object[type='audio/audio']")?(parentNode.append(rendered),parentNode.siblings(".audio-gap").last().append(parentNode)):node.prev().is("object[type='audio/audio']")?parentNode.find(".audio-gap").last().append(rendered):parentNode.append(rendered):parentNode.append(rendered),interaction.bind("show:deferred",function(){view.onInteractionShow()}),interaction.blockItems.add(model),1==interaction.items.itemList.length&&1==interaction.blockItems.itemList.length&&a5.dp.config.ICTextgapActive&&interaction.bind("show:deferred",function(){rendered.children().focus()}),!areaSize&&!model.prefill){var adjustGapSize=function(){a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.removeBodySubstyle(),interaction.addBodySubstyle();var firstInput=interaction.$(".input-text input").first();interaction.options.gapsIsSamelongest()?view.adjustGapSizeToLongestResponse(interaction.viewData.getLongestAllResponses(interaction.index,firstInput)):view.adjustGapSizeToLongestCorrect(interaction.viewData.getLongestResponse(node.attr("responseIdentifier"),firstInput)),interaction.removeBodySubstyle(),a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.addBodySubstyle()};interaction.bind("rendered",function(){adjustGapSize()},this,{once:!0}),a5.hooks.interactionFontUpdated.add(function(){interaction.visible||(interaction.disableVisibility(),interaction.contentWrap.show()),adjustGapSize(),interaction.visible||(interaction.contentWrap.hide(),interaction.enableVisibility())}),a5.hooks.layoutStylesLoaded.add(function(){adjustGapSize()})}a5.callbacks.interaction.bind("loaded",function(i){if(i===interaction&&"Input:Completion:Text gap"==interaction.identifier){this.addWordClasses(view.node,".input-text");var textBeforeGap=view.node.get(0).previousSibling;textBeforeGap&&view.node.find(".enum-answers:last").after(textBeforeGap)}},this)}},a5.model_builder.Base.extend("a5.model_builder.ICTextGap"),a5.model_builder.builders.push(new a5.model_builder.ICTextGap),a5.model_builder.ICNumberTriangle={isResponsible:function(node,interaction){return"Input:Completion:Number triangle"===interaction.identifier&&(node.is("#contentblock")||node.is("textEntryInteraction")||node.is(".triangle-display-number"))},buildDiv:function(interaction,parentNode,node){node.is("#contentblock")?this._buildContentBlock(interaction,parentNode,node):this._buildDisplayNumber(interaction,parentNode,node)},_buildContentBlock:function(interaction,parentNode,node){this.index=0,(new a5.model_builder.Element).build(interaction,parentNode,node)},_buildDisplayNumber:function(interaction,parentNode,node){this._buildMainNode(interaction,parentNode);var $display=this.buildContents(node,interaction,$("<span>"));$display.addClass("triangle-display-number"),$display.addClass(this._indexToTriangleClass(this.index)),parentNode.find(".number-triangle").append($display),this.index++},buildTextEntryInteraction:function(interaction,parentNode,node){this._buildMainNode(interaction,parentNode),this._super(interaction,parentNode.find(".number-triangle"),node),parentNode.find(".input-text:last, .prefill:last").addClass(this._indexToTriangleClass(this.index)),this.index++},_buildMainNode:function(interaction,parentNode){0===this.index&&parentNode.append($("<div>").addClass("number-triangle").toggleClass("multiplication",interaction.options.operatorIsMultiplication()))},_indexToTriangleClass:function(index){return"triangle-"+["top-left","top","top-right","left","right","bottom"][index]}},a5.model_builder.ICTextGap.extend("a5.model_builder.ICNumberTriangle"),a5.model_builder.builders.push(new a5.model_builder.ICNumberTriangle),a5.model_builder.ICNumberPyramid={isResponsible:function(node,interaction){return"Input:Completion:Number pyramid"===interaction.identifier&&(node.is("#contentblock")||node.is("textEntryInteraction")||node.is(".pyramid-display-number"))},buildDiv:function(interaction,parentNode,node){node.is("#contentblock")?this._buildContentBlock(interaction,parentNode,node):this._buildDisplayNumber(interaction,parentNode,node)},_buildContentBlock:function(interaction,parentNode,node){this.index=0,(new a5.model_builder.Element).build(interaction,parentNode,node)},_buildDisplayNumber:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-pyramid"));var $display=this.buildContents(node,interaction,$("<span>"));$display.addClass("pyramid-display-number"),$display.addClass(this._indexToPyramidClass(this.index)),parentNode.find(".number-pyramid").append($display),this.index++},buildTextEntryInteraction:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-pyramid")),this._super(interaction,parentNode.find(".number-pyramid"),node),parentNode.find(".input-text:last, .prefill:last").addClass(this._indexToPyramidClass(this.index)),this.index++},_indexToPyramidClass:function(index){return"pyramid-"+["top","left","right","center","bottom-left","bottom","bottom-right"][index]}},a5.model_builder.ICTextGap.extend("a5.model_builder.ICNumberPyramid"),a5.model_builder.builders.push(new a5.model_builder.ICNumberPyramid),a5.model_builder.ICNumberWall={isResponsible:function(node,interaction){return"Input:Completion:Number wall"===interaction.identifier&&(node.is("#contentblock")||node.is("textEntryInteraction")||node.is(".wall-display-number"))},buildDiv:function(interaction,parentNode,node){node.is("#contentblock")?this._buildContentBlock(interaction,parentNode,node):this._buildDisplayNumber(interaction,parentNode,node)},_buildContentBlock:function(interaction,parentNode,node){this.index=0,(new a5.model_builder.Element).build(interaction,parentNode,node)},_buildDisplayNumber:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-wall"));var $display=this.buildContents(node,interaction,$("<span>"));$display.addClass("wall-display-number"),$display.appendTo(this._getLevelContainer(parentNode)),this.index++},buildTextEntryInteraction:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-wall")),this._super(interaction,$('<div class="wall-input-text">').appendTo(this._getLevelContainer(parentNode)),node),this.index++},_indexToWallClass:function(index){return"wall-level-"+(Math.floor(-.5+Math.sqrt(.25+2*index))+1)},_getLevelContainer:function(parentNode){var className=this._indexToWallClass(this.index),$wall=parentNode.find(".number-wall"),$found=$wall.children("."+className);return $found.length?$found:$("<div>").addClass("wall-level "+className).appendTo($wall)}},a5.model_builder.ICTextGap.extend("a5.model_builder.ICNumberWall"),a5.model_builder.builders.push(new a5.model_builder.ICNumberWall),a5.model_builder.ICNumberLayers={isResponsible:function(node,interaction){return"Input:Completion:Number layers"===interaction.identifier&&(node.is("#contentblock")||node.is("textEntryInteraction")||node.is(".layers-display-number"))},buildDiv:function(interaction,parentNode,node){node.is("#contentblock")?this._buildContentBlock(interaction,parentNode,node):this._buildDisplayNumber(interaction,parentNode,node)},_buildContentBlock:function(interaction,parentNode,node){this.index=0,this.numberColumns=interaction.options.getNumbercolumns(),(new a5.model_builder.Element).build(interaction,parentNode,node)},_buildDisplayNumber:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-layers"));var $display=this.buildContents(node,interaction,$("<span>"));$display.addClass("layers-display-number"),$display.appendTo(this._getLevelContainer(parentNode)),this.index++},buildTextEntryInteraction:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-layers")),this._super(interaction,$('<div class="layers-input-text">').appendTo(this._getLevelContainer(parentNode)),node),this.index++},_indexToLayersClass:function(index){for(var level=0;index>0;level++)index-=Math.pow(2,level)*this.numberColumns;return"layer-"+level},_getLevelContainer:function(parentNode){var className=this._indexToLayersClass(this.index),$layers=parentNode.find(".number-layers"),$found=$layers.children("."+className);return $found.length?$found:$("<div>").addClass("layer "+className).appendTo($layers)}},a5.model_builder.ICTextGap.extend("a5.model_builder.ICNumberLayers"),a5.model_builder.builders.push(new a5.model_builder.ICNumberLayers),a5.model_builder.ICMath={isResponsible:function(node,interaction){return node.is("textEntryInteraction")&&"Input:Completion:Maths"===interaction.identifier&&!interaction.options.gapsIsInvisible()},buildTextEntryInteraction:function(interaction,parentNode,node){var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")),answers=htmlDecode(correctResponse.values.join("*")),answerIsFormula=!1;0===answers.indexOf("=")?(answers=answers.slice(1),answerIsFormula=!0):answers=this.transformValToExpression(answers);var defaultValue=correctResponse.defaultValue||!answerIsFormula&&correctResponse.values[0],enumeration=interaction.enumAnswers.next(),expression=answers,defaultAnswer=defaultValue||null;interaction.items.gapCollectionModel||(interaction.items.gapCollectionModel=new a5.models.interaction.ICMathCollection({parent:interaction.items,showAnswerBehaviour:!a5.mainBuilder.options().seeAnswersIsOff()}));var model=new a5.models.interaction.ICMath({enumeration:enumeration,global_enumeration:a5.mainBuilder.options(!0).continuousEnumerationIsOn(),prefill:!_.isEmpty(answers)&&interaction.prefill.isPrefill(),formula:expression,defaultValue:defaultAnswer,tryAgainKeep:interaction.options.tryAgainIsKeepall(),ignoreSpaces:interaction.options.ignoreSpacesIsOn(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),parent:interaction.items.gapCollectionModel,preventRepeat:interaction.options.repeatAnswersIsPrevent(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),numberInput:interaction.options.getNumberInput(),referenceDependency:interaction.options.validatedependentgapsIsOn(),inputStyle:node.attr("style")});model.assignAnswerFeedback(node);var view=new a5.views.interaction.ICMath(model,null,interaction,{resize:interaction.options.gapResizeIsOn(),defaultSize:this.getDefaultSize(defaultValue),index:interaction.blockItems.itemList.length});interaction.items.gapViews||(interaction.items.gapViews=[]),interaction.items.gapViews.push(view);var rendered=view.render();parentNode.append(rendered),interaction.blockItems.add(model),interaction.items.gapCollectionModel.itemList().length===_.keys(interaction.getAllResponseDeclaration()).length&&(interaction.items.gapCollectionModel.updateDependency(),this.updateViewsSizes(interaction))},updateViewsSizes:function(interaction){if(interaction.options.gapsIsSamelongest()){var maxWidth,defaultAnswers=_.chain(interaction.items.gapViews).map(function(view){return view.options.defaultSize}).where({measure:"answer"}).value();if(defaultAnswers&&defaultAnswers.length){var input=interaction.$(".input-text input").first();maxWidth=_.chain(defaultAnswers).map(function(da){return input.textWidth(da.value)}).max().value()}else maxWidth=a5.dp.config.mathsGapDefaultWidth;_.each(interaction.items.gapViews,function(view){view.options.defaultSize={value:maxWidth,measure:"px"},/[\s;]*width:/gi.test(view.model.inputStyle)&&(view.options.defaultSize.value=view.input.width())})}_.invoke(interaction.items.gapViews,"adjustGapSizeToDefault"),interaction.items.gapViews=null},getDefaultSize:function(defaultValue){return defaultValue?{value:defaultValue,measure:"answer"}:{value:a5.dp.config.mathsGapDefaultWidth,measure:"px"}},transformValToExpression:function(val){return val.split("*").map(function(item){return"x=="+item}).join("||")}},a5.model_builder.Base.extend("a5.model_builder.ICMath"),a5.model_builder.builders.push(new a5.model_builder.ICMath),a5.model_builder.ICMathQuizz={isResponsible:function(node,interaction){
return node.is("textEntryInteraction, responseConfiguration")&&"Input:Completion:MathsQuizzes"==interaction.identifier},buildTextEntryInteraction:function(interaction,parentNode,node){var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier"));if(correctResponse.values.length>0){var html=(new DOMParser).parseFromString(correctResponse.values[0],"text/html"),xml=html.body.firstChild.getAttribute("data-wirisquiz"),model=new a5.models.interaction.ICMathQuizz({xml:xml}),view=new a5.views.interaction.ICMathQuizz({model:model});parentNode.append(view.node),view.render(),interaction.blockItems.add(model)}}},a5.model_builder.Base.extend("a5.model_builder.ICMathQuizz"),a5.model_builder.builders.push(new a5.model_builder.ICMathQuizz),a5.model_builder.ICTextGapInvisible={isResponsible:function(node,interaction){return"Input:Completion:Text gap"==interaction.identifier&&interaction.options.gapsIsInvisible()&&(node.is("#contentblock, textEntryInteraction")||node[0].nodeType==Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){if(this.model=new a5.models.interaction.ICTextGapInvisible({}),this.buildContents(node,interaction),1==interaction.items.length())if(interaction.options.prefillIsFirstblock())_.each(this.model.nodes,function(child){child.prefill=!0});else if(interaction.options.prefillIsFirstitem()&&this.model.nodes.length>0){var prefilled=_.find(this.model.nodes,function(e){return e.isInput()&&e.hasAnswer()});prefilled.prefill=!0}interaction.blockItems.add(this.model);var view=new a5.views.interaction.ICTextGapInvisible(this.model,interaction.enumBlock.next());parentNode.append(view.render()),this.model=null},buildTextNode:function(interaction,parentNode,node){var text=node[0].textContent,self=this;if(this.model){var words=text.replace(/\s+/g," ").trim().split(" ");_.each(words,function(e){(self.model.peek()._instance_of("Obj")||self.model.peek()._instance_of("a5.models.interaction.ICTextGapInvisibleText"))&&self.model.push(new a5.models.interaction.ICTextGapInvisibleGap({parent:self.model})),self.model.push(new a5.models.interaction.ICTextGapInvisibleText({parent:self.model,word:e}))})}else parentNode.append(text)},buildTextEntryInteraction:function(interaction,parentNode,node){var answers=interaction.getCorrectResponse(node.attr("responseIdentifier")).values;this.model.push(new a5.models.interaction.ICTextGapInvisibleGap({parent:this.model,answers:answers}))}},a5.model_builder.Base.extend("a5.model_builder.ICTextGapInvisible"),a5.model_builder.builders.push(new a5.model_builder.ICTextGapInvisible),a5.model_builder.ICTextCorrectionReplace={isResponsible:function(node,interaction){return"Input:Completion:Text correction"==interaction.identifier&&interaction.options.errorCorrectionIsReplace()&&(node.is("#content, #contentblock, inlineChoiceInteraction")||node[0].nodeType==Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){node.is("#content")?(this.sharedObject={},this._super(interaction,parentNode,node)):this.buildContentblock(interaction,parentNode,node)},buildContentblock:function(interaction,parentNode,node){var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next()),this.model=new a5.model.interaction.ICTextCorrectionReplace({blockEnumeration:blockEnumeration,signalErrorsAlways:interaction.options.signalErrorIsHighlight(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),sharedObject:this.sharedObject,userSelection:interaction.options.getUserselection(),parent:interaction.blockItems}),this.view=new a5.view.interaction.ICTextCorrectionReplace(this.model,interaction,node.attr("class")),this.buildContents(node,interaction,this.view.node),parentNode.append(this.view.render()),interaction.blockItems.add(this.model),this.model=null,this.view=null},buildTextNode:function(interaction,parentNode,node){var model,view;this.model?_.each($(node).text().match(/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$|\S+(?=[.,:;]+$)|\S+(?=[.,:;]+\s)|\S+/g),function(str){/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$/.test(str)||interaction.options.prefillIsFirstblock()&&1==interaction.items.length()?(model=new a5.model.interaction.ICTextCorrectionReplacePlain({text:str}),this.model.push(model),view=new a5.view.interaction.ICTextCorrectionReplacePlain(model,this.view),this.view.push(view)):(model=new a5.model.interaction.ICTextCorrectionReplaceText({text:str,parent:this.model,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()}),this.model.push(model),view=new a5.view.interaction.ICTextCorrectionReplaceText(model,this.view),this.view.push(view)),parentNode.append(view.render())},this):parentNode.append($(node).text())},buildInlineChoiceInteraction:function(interaction,parentNode,node){var values=_.map(node.children(),function(n){return htmlDecode($(n).text())}),wrong=values.shift(),prefill=interaction.options.prefillIsFirstitem()&&1==interaction.items.length()&&0==this.model.countWrongWords();prefill=prefill||interaction.options.prefillIsFirstblock()&&1==interaction.items.length();var model=new a5.model.interaction.ICTextCorrectionReplaceText({parent:this.model,text:wrong,answers:values,prefill:prefill,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()});model.assignAnswerFeedback(node.children("[answerfeedback]")),this.model.push(model);var view=new a5.view.interaction.ICTextCorrectionReplaceText(model,this.view);this.view.push(view),parentNode.append(view.render()),a5.callbacks.interaction.bind("loaded",function(i){i===interaction&&this.addWordClasses(view.node,".input-text")},this)}},a5.model_builder.Content.extend("a5.model_builder.ICTextCorrectionReplace"),a5.model_builder.builders.push(new a5.model_builder.ICTextCorrectionReplace),a5.model_builder.ICTextCorrectionLine={isResponsible:function(node,interaction){return"Input:Completion:Text correction"==interaction.identifier&&interaction.options.errorCorrectionIsLine()&&(node.is("#contentblock, inlineChoiceInteraction")||node[0].nodeType==Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next()),this.model=new a5.models.interaction.ICTextCorrectionLine({blockEnumeration:blockEnumeration,prefilled:(interaction.options.prefillIsFirstitem()||interaction.options.prefillIsFirstblock())&&1==interaction.items.length(),signalErrorsAlways:interaction.options.signalErrorIsHighlight(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),userSelection:interaction.options.getUserselection()}),this.buildContents(node,interaction);var view=new a5.views.interaction.ICTextCorrectionLine(this.model);parentNode.append(view.render()),interaction.blockItems.add(this.model);var oldFn=interaction.getScores;interaction.getScores=function(){var scores=oldFn.apply(interaction);return scores.filled>scores.total&&(scores.filled=scores.total),scores.correct<0&&(scores.correct=0),scores},this.model=null},buildTextNode:function(interaction,parentNode,node){var text=node[0].textContent,self=this;this.model?self.model.push(new a5.models.interaction.ICTextCorrectionLineText({parent:self.model,text:text})):parentNode.append(text)},buildInlineChoiceInteraction:function(interaction,parentNode,node){var values=_.map(node.children(),function(n){return htmlDecode($(n).text())}),wrong=values.shift(),model=new a5.models.interaction.ICTextCorrectionLineText({parent:this.model,text:wrong,wrong:!0});model.assignAnswerFeedback(node.children("[answerfeedback]")),this.model.push(model),this.model.answers=values}},a5.model_builder.Base.extend("a5.model_builder.ICTextCorrectionLine"),a5.model_builder.builders.push(new a5.model_builder.ICTextCorrectionLine),a5.model_builder.ICTextCorrectionSentence={isResponsible:function(node,interaction){return"Input:Completion:Text correction"==interaction.identifier&&interaction.options.errorCorrectionIsSentence()&&(node.is("#contentblock, inlineChoiceInteraction")||node[0].nodeType==Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next()),this.model=new a5.models.interaction.ICTextCorrectionSentence({blockEnumeration:blockEnumeration,prefilled:(interaction.options.prefillIsFirstitem()||interaction.options.prefillIsFirstblock())&&1==interaction.items.length(),signalErrorsAlways:interaction.options.signalErrorIsHighlight(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),userSelection:interaction.options.getUserselection()}),this.buildContents(node,interaction);var view=new a5.views.interaction.ICTextCorrectionSentence(this.model);parentNode.append(view.render()),interaction.blockItems.add(this.model),this.model.setInitialValue(),this.model=null},buildTextNode:function(interaction,parentNode,node){var text=node[0].textContent,self=this;this.model?self.model.push(new a5.models.interaction.ICTextCorrectionSentenceText({parent:self.model,text:text})):parentNode.append(text)},buildInlineChoiceInteraction:function(interaction,parentNode,node){var values=_.map(node.children(),function(n){return htmlDecode($(n).text())}),wrong=values.shift(),model=new a5.models.interaction.ICTextCorrectionSentenceText({parent:this.model,text:wrong,answers:values});model.assignAnswerFeedback(node.children("[answerfeedback]")),this.model.push(model)}},a5.model_builder.Base.extend("a5.model_builder.ICTextCorrectionSentence"),a5.model_builder.builders.push(new a5.model_builder.ICTextCorrectionSentence),a5.model_builder.IMVoice={isResponsible:function(node,interaction){return node.is("recorder")&&"Input:Match:Voice"===interaction.identifier},buildRecorder:function(interaction,parentNode,node){var model=new a5.models.interaction.IMVoice({parent:interaction,text:node.text()}),view=new a5.views.interaction.IMVoice(model);parentNode.append(view.render()),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.IMVoice"),a5.model_builder.builders.push(new a5.model_builder.IMVoice),a5.model_builder.FreeWriting={isResponsible:function(node,interaction){return node.is("textinput, richtextinput")&&"Input:Creative:Extended writing"===interaction.identifier},buildTextinput:function(interaction,parentNode,node){var width=node.attr("width"),height=node.attr("height"),max=node.attr("max")||"",size=_([width,height,max]).compact(),txt=_.str.sprintf("[**@%s@%s]",size.join(":"),this._toPlainText(node));parentNode.append(txt)},buildRichtextinput:function(interaction,parentNode,node){var width=node.attr("width"),height=node.attr("height"),max=node.attr("max")||"",size=_([width,height,max]).compact(),txt=_.str.sprintf("[***@%s@%s]",size.join(":"),this._toPlainText(node));parentNode.append(txt)},_toPlainText:function(node){var str="";return _(node.contents()).each(function(c){c.tagName&&"br"===c.tagName.toLowerCase()?str+="\n":str+=$(c).text().replace(/\t/g,"").replace(/\n/g,"")}),str}},a5.model_builder.Base.extend("a5.model_builder.FreeWriting"),a5.model_builder.builders.push(new a5.model_builder.FreeWriting),a5.model_postBuilder.FreeWriting={isResponsible:function(node,interaction){return"Input:Creative:Extended writing"==interaction.identifier},init:function(){},build:function(interaction,parent){var model=new a5.models.interaction.ICExtendedWriting({$node:parent});interaction.blockItems.add(model),new a5.view.interaction.ICExtendedWriting(model,null,parent,interaction)}},Obj.extend("a5.model_postBuilder.FreeWriting"),a5.model_postBuilder.builders=[new a5.model_postBuilder.FreeWriting],a5.model_builder.IMMarkingBuilder={markingForWordsRegex:/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$|\S+(?=[.,:;]+$)|\S+(?=[.,:;]+\s)|\S+/g,markingForLettersRegex:/\s+|\S+/g,whitespaceRegex:/\s+/,punctuationRegex:/[.,:;]+(?=[\s]+)|[.,:;]+$/,isResponsible:function(node,interaction){return"Identify:Mark:Marking"==interaction.identifier&&(node.is("gapMatchInteraction")||node.is("#content")||node.is("#contentblock")||node.is("gapText")||node.is("gap")&&null!=this.model||3==node[0].nodeType)},buildDiv:function(interaction,parentNode,node){node.is("#content")?this.buildContents(node,interaction,parentNode):this._buildContentblock(interaction,parentNode,node)},_buildContentblock:function(interaction,parentNode,node){var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next()),this.model=new a5.model.interaction.IMMarking({blockEnumeration:blockEnumeration,prefilled:interaction.options.prefillIsFirstblock()&&0==this.blockCounter,tryAgainKeep:interaction.options.tryAgainIsKeepall(),markingStyle:interaction.options.getMarkingstyle(),scoreValueIs1PerQuestion:interaction.options.scoreValuesIs1_point_question(),interaction:interaction});var blockScore=interaction.options.getScoreValuesPerBlock().split(",");blockScore=parseInt(blockScore[this.blockCounter],10),_.isNaN(blockScore)&&(blockScore=void 0),interaction.blockItems=new a5.models.interaction.QuestionItems({blockScore:blockScore,parent:interaction.items}),interaction.items.add(interaction.blockItems),interaction.blockItems.add(this.model);var $generated=this.buildContents(node,interaction),view=new a5.view.interaction.IMMarking(this.model,interaction,node.attr("class"));view.appendDOM($generated),parentNode.append(view.render()),this.model=null,this.blockCounter++},_buildMarkingElementForWords:function(interaction,parentNode,node){var views=[];_.each(node.text().match(this.markingForWordsRegex),function(str){var n=null;this.whitespaceRegex.test(str)||this.punctuationRegex.test(str)?(n=new a5.model.interaction.IMMarkingText({text:str}),views.push(new a5.view.interaction.IMMarkingText(n,null)),this.model.push(n)):(n=new a5.model.interaction.IMMarkingElement({text:str,parent:this.model,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()}),views.push(new a5.view.interaction.IMMarkingElement(n,null)),this.model.push(n))},this),parentNode.append(_.invoke(views,"render"))},_buildMarkingElementForLetters:function(interaction,parentNode,node){var views=[];_.each(node.text().match(this.markingForLettersRegex),function(str){var n=null;this.whitespaceRegex.test(str)?(n=new a5.model.interaction.IMMarkingText({text:str}),views.push(new a5.view.interaction.IMMarkingText(n,null)),this.model.push(n)):_.each(str,function(letter){n=new a5.model.interaction.IMMarkingElement({text:letter,parent:this.model,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()}),views.push(new a5.view.interaction.IMMarkingElement(n,null)),this.model.push(n)},this)},this),parentNode.append(_.invoke(views,"render"))},buildTextNode:function(interaction,parentNode,node){this.model?interaction.options.highlightselectionIsLetters()?this._buildMarkingElementForLetters(interaction,parentNode,node):this._buildMarkingElementForWords(interaction,parentNode,node):parentNode.append(node.text())},buildGap:function(interaction,parentNode,node){var correct=inverseMap(interaction.getCorrectResponse(node.closest("gapMatchInteraction").attr("responseIdentifier")).asMapMulti()),model=new a5.model.interaction.IMMarkingElement({correct:correct[node.attr("identifier")],text:node.attr("label"),parent:this.model,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()});model.assignAnswerFeedback(node),model.isDistractor()||((interaction.options.prefillIsFirstitem()&&0==this.gapCounter||interaction.options.prefillIsFirstblock()&&0==this.blockCounter)&&model.setPrefilled(),this.gapCounter++);var view=new a5.view.interaction.IMMarkingElement(model,null);parentNode.append(view.render()),this.model.push(model),interaction.model=this.model},buildGapMatchInteraction:function(interaction,parentNode,node){interaction.iMMarkingCursor=!1,interaction.iMMarkingColors=[],interaction.iMMarkingColorsDefault=void 0,this.blockCounter=0,this.gapCounter=0,this.buildContents(node,interaction,parentNode),interaction.options.randomiseanswersIsTrue()&&interaction.toolbar.shuffleButtons(),this.setFirstColorActive(interaction),this.addEraseFunctionality(interaction)},buildGapText:function(interaction,parentNode,node){var markStyle,colors;if(_.isUndefined(interaction.iMMarkingColorsDefault)&&(interaction.iMMarkingColorsDefault=a5.utils.deepClone(a5.dp.config.markingDefaultColors)),node.attr("style")?markStyle=node.attr("style").toLowerCase():(colors=interaction.iMMarkingColorsDefault,markStyle=colors[node.text().trim()],_.isUndefined(markStyle)&&(markStyle=colors.$default.length>1?colors.$default.shift():colors.$default[0])),interaction.iMMarkingColors[node.attr("identifier")]=markStyle,!a5.dp.config.hideSingleColorMarkButtons||interaction.getAllResponseDeclaration().RESPONSE.values.length>1){var colValue=markStyle.replace(/#/g,"");interaction.toolbar.addToggleButton({label:node.text(),group:"colors",classes:["color","color-"+colValue],on:function(){interaction.iMMarkingCursor=node.attr("identifier")},tts_audio:interaction.options.gaptextaudioIsTrue()});var style="<style type='text/css'> .button.color-"+colValue+":before{  background-color:"+markStyle+";}</style>";$(style).appendTo($("head"))}},setFirstColorActive:function(interaction){interaction.toolbar.buttons.length?interaction.toolbar.buttons[0].setPressed(!0):interaction.iMMarkingCursor=_.chain(interaction.iMMarkingColors).keys().first().value()},addEraseFunctionality:function(interaction){if(!a5.dp.config.hideSingleColorMarkButtons||interaction.getAllResponseDeclaration().RESPONSE.values.length>1){a5.service.templates.enableOnlyCachedMode();var template=a5.service.templates.render("a5.view.toolbar.erase");a5.service.templates.disableOnlyCachedMode(),interaction.toolbar.addToggleButton({label:$(template).text()||"Erase",title:$(template).attr("title"),group:"colors",classes:["erase"],on:function(){interaction.iMMarkingCursor=!1,$("body").addClass("erasing")},off:function(){$("body").removeClass("erasing")}}),interaction.bind("hide",function(){$("body").removeClass("erasing")}),interaction.bind("show",function(){$("body").toggleClass("erasing",this.$(".toolbar .erase").is(".activated"))},interaction)}}},a5.model_builder.Base.extend("a5.model_builder.IMMarkingBuilder"),a5.model_builder.builders.push(new a5.model_builder.IMMarkingBuilder),a5.model_builder.IMProofingBuilder={NO_MARKABLE_REGEX:/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$/,TOKEN_REGEX:/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$|\S+(?=[.,:;]+$)|\S+(?=[.,:;]+\s)|\S+/g,isResponsible:function(node,interaction){return"Identify:Mark:Proofing"===interaction.identifier&&(node.is("#content, #contentblock, inlineChoiceInteraction")||node[0].nodeType===Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){if(node.is("#content")){this.blockCounter=0,this.vent=new Obj;var view=new a5.view.IMProofing({vent:this.vent,interaction:interaction});interaction.controller=view,this._super(interaction,view.$el,node),view.render()}else this.buildContentblock(interaction,parentNode,node)},buildContentblock:function(interaction,parentNode,node){this.isBuildingContentblock=!0;var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next()),this.model=new a5.model.interaction.IMProofingBlock({blockEnumeration:blockEnumeration,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()});var blockScore=interaction.options.getScoreValuesPerBlock().split(",");blockScore=parseInt(blockScore[this.blockCounter],10),_.isNaN(blockScore)&&(blockScore=void 0),interaction.blockItems=new a5.models.interaction.QuestionItems({blockScore:blockScore,parent:interaction.items}),interaction.items.add(interaction.blockItems),interaction.blockItems.add(this.model),this.view=new a5.view.interaction.IMProofingBlock(this.model,interaction),parentNode.append(this.view.node),this.buildContents(node,interaction,this.view.node),this.view.render(),this.isBuildingContentblock=!1,this.blockCounter++},buildTextNode:function(interaction,parentNode,node){var model,view;this.isBuildingContentblock?_.each($(node).text().match(this.TOKEN_REGEX),function(str){this.NO_MARKABLE_REGEX.test(str)||interaction.options.prefillIsFirstblock()&&1==interaction.items.length()?(model=new a5.model.interaction.IMProofingText({text:str,parent:this.model}),view=new a5.view.interaction.IMProofingText(model,this.view)):(model=new a5.model.interaction.IMProofingElement({text:str,parent:this.model,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall()}),this.model.add(model),view=new a5.view.interaction.IMProofingElement(model,this.view,this.vent),this.view.add(view)),parentNode.append(view.node),view.render()},this):parentNode.append($(node).text())},buildInlineChoiceInteraction:function(interaction,parentNode,node){var inlineChoices=_.map(node.children(),function(inlineChoice){return htmlDecode($(inlineChoice).text())}),firstChoice=inlineChoices.shift(),markerAndText=firstChoice.split("|"),marker=markerAndText[0],text=markerAndText[1],correct={marker:marker,answers:inlineChoices},prefill=interaction.options.prefillIsFirstitem()&&1===interaction.items.length()&&0===this.model.countWrongWords();prefill=prefill||interaction.options.prefillIsFirstblock()&&1===interaction.items.length();var model=new a5.model.interaction.IMProofingElement({text:text,correct:correct,parent:this.model,prefill:prefill,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn()});this.model.add(model);var view=new a5.view.interaction.IMProofingElement(model,this.view,this.vent);this.view.add(view),parentNode.append(view.node),view.render(),interaction.controller.add(view)}},a5.model_builder.Content.extend("a5.model_builder.IMProofingBuilder"),a5.model_builder.builders.push(new a5.model_builder.IMProofingBuilder),a5.model_builder.IMAutocorrectBuilder={NO_MARKABLE_REGEX:/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$/,TOKEN_REGEX:/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$|\S+(?=[.,:;]+$)|\S+(?=[.,:;]+\s)|\S+/g,isResponsible:function(node,interaction){return"Identify:Mark:Autocorrect"===interaction.identifier&&(node.is("#content, #contentblock, inlineChoiceInteraction")||node[0].nodeType===Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){if(node.is("#content")){this.blockCounter=0;var view=new a5.view.IMAutocorrect({interaction:interaction});interaction.controller=view,this._super(interaction,view.$el,node),view.render()}else this.buildContentblock(interaction,parentNode,node)},buildContentblock:function(interaction,parentNode,node){this.isBuildingContentblock=!0;var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next()),this.model=new a5.model.interaction.IMAutocorrectBlock({blockEnumeration:blockEnumeration,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()});var blockScore=interaction.options.getScoreValuesPerBlock().split(",");blockScore=parseInt(blockScore[this.blockCounter],10),_.isNaN(blockScore)&&(blockScore=void 0),interaction.blockItems=new a5.models.interaction.QuestionItems({blockScore:blockScore,parent:interaction.items}),interaction.items.add(interaction.blockItems),interaction.blockItems.add(this.model),this.view=new a5.view.interaction.IMAutocorrectBlock(this.model,interaction),parentNode.append(this.view.node),this.buildContents(node,interaction,this.view.node),this.view.render(),this.isBuildingContentblock=!1,this.blockCounter++},buildTextNode:function(interaction,parentNode,node){var model,view;this.isBuildingContentblock?_.each($(node).text().match(this.TOKEN_REGEX),function(str){this.NO_MARKABLE_REGEX.test(str)||interaction.options.prefillIsFirstblock()&&1===interaction.items.length()?(model=new a5.model.interaction.IMAutocorrectText({text:str,parent:this.model}),view=new a5.view.interaction.IMAutocorrectText(model,this.view)):(model=new a5.model.interaction.IMAutocorrectElement({text:str,parent:this.model,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall()}),this.model.add(model),view=new a5.view.interaction.IMAutocorrectElement(model,this.view),this.view.add(view),interaction.controller.add(view)),parentNode.append(view.node),view.render()},this):parentNode.append($(node).text())},buildInlineChoiceInteraction:function(interaction,parentNode,node){var inlineChoices=_.map(node.children(),function(inlineChoice){return htmlDecode($(inlineChoice).text())}),text=inlineChoices.shift(),correct=inlineChoices,prefill=interaction.options.prefillIsFirstitem()&&1===interaction.items.length()&&0===this.model.countWrongWords();prefill=prefill||interaction.options.prefillIsFirstblock()&&1===interaction.items.length();var model=new a5.model.interaction.IMAutocorrectElement({text:text,correct:correct,parent:this.model,prefill:prefill,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall()});this.model.add(model);var view=new a5.view.interaction.IMAutocorrectElement(model,this.view);parentNode.append(view.node),view.render(),interaction.controller.add(view)}},a5.model_builder.Content.extend("a5.model_builder.IMAutocorrectBuilder"),a5.model_builder.builders.push(new a5.model_builder.IMAutocorrectBuilder),a5.model_builder.ISCheckboxBuilder={isResponsible:function(node,interaction){return node.is("choiceInteraction")&&"Identify:Select:Checkbox"==interaction.identifier},buildChoiceInteraction:function(interaction,parentNode,node){var self=this,correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")).values,prefillBlock=1==interaction.items.length()&&interaction.options.prefillIsFirstblock(),model=new a5.models.interaction.ISCheckboxModel({alignment:interaction.options.getChoiceAlignment(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),allowSelectAll:interaction.options.checkboxSelectionsIsAll(),gaptextaudio:interaction.options.gaptextaudioIsTrue(),display:interaction.options.getQuestiondisplay(),attempts:interaction.checkAttempts}),shuffle=void 0,label="",answers=[];interaction.options.showInColumnsIsTrue()&&(shuffle=!1,correctResponse=_.filter(correctResponse,function(e){return!a5.utils.endsWith(e,"_0")}));var last_enum=void 0;if(_.each(this.fetchChoices(interaction,node,"simpleChoice",shuffle),function(e,index){var enumeration,$content=self.buildContents(e,interaction);if(interaction.options.showInColumnsIsTrue()&&a5.utils.endsWith($(e).attr("identifier"),"_0"))enumeration=interaction.enumAnswers.next(),label=$content.prepend('<span class="enum-placeholder"></span>'),enumeration.then(function(enumSymbol){$content.find(".enum-placeholder").replaceWith(enumSymbol)});else{interaction.options.showInColumnsIsTrue()||interaction.options.enumerationinternalIsCorrect()||(enumeration=interaction.enumAnswers.next());var correct=_.contains(correctResponse,$(e).attr("identifier"));correct&&interaction.options.enumerationinternalIsCorrect()&&interaction.enumAnswers.next().then(function(enumSymbol){var node=$("<span class='enum enum-per-question'>"+enumSymbol+"</span>");last_enum?node.insertAfter(last_enum):(parentNode.parents(".contentblock").attr("id","enumeration-"+a5.utils.enumText(enumSymbol)),parentNode.parents(".contentblock").attr("tabindex",-1),parentNode.parents(".contentblock").append(node)),last_enum=node,model.addEnumeration(parseInt(last_enum.text(),10))}.bind(this));var choiceModel=new a5.models.interaction.ISCheckboxChoiceModel({content:$content,parent:model,enumeration:enumeration,hasCheckbox:!interaction.options.hideCheckboxesIsTrue(),correct:correct,prefill:prefillBlock,value:$(e).attr("identifier"),label:label,tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()});choiceModel.assignAnswerFeedback($(e)),model.add(choiceModel),answers.push($content)}}),interaction.options.prefillIsFirstitem()){0===_.chain(interaction.items.itemList).pluck("itemList").flatten().value().length&&model.makeOnePrefilled()}var response=$(node).attr("responseIdentifier").replace("RESPONSE","");interaction.options.showInColumnsIsTrue()&&0==parseInt(response,10)&&(this.header_node=new a5.views.interaction.ISCheckboxHeader(answers).render(),parentNode.addClass("checkbox-wrapper-show-in-columns"),parentNode.prepend(this.header_node));var isVisible=1===interaction.items.length()&&0===interaction.blockItems.length(),cblock=parentNode.is(".contentblock")?parentNode:parentNode.parents(".contentblock"),view=new a5.views.interaction.ISCheckboxView(model,prefillBlock,interaction.options.hideCheckboxesIsTrue(),interaction.options.showInColumnsIsTrue(),label,isVisible,cblock,interaction),random=interaction.options.randomiseanswersIsTrue()&&interaction.options.showInColumnsIsTrue();this._appendToDOM(view.render(),parentNode,random),interaction.blockItems.add(model)},_appendToDOM:function($node,parentNode,random){var len=parentNode.find(".choice_interaction").length;random&&len?this._insertRandom($node,parentNode,len):parentNode.append($node)},_insertRandom:function($node,parentNode,len){if(len){var index=Math.floor(Math.random()*len);Boolean(Math.floor(2*Math.random()))?$node.insertBefore(parentNode.find(".choice_interaction:eq("+index+")")):$node.insertAfter(parentNode.find(".choice_interaction:eq("+index+")"))}}},a5.model_builder.Base.extend("a5.model_builder.ISCheckboxBuilder"),a5.model_builder.builders.push(new a5.model_builder.ISCheckboxBuilder),a5.model_builder.PPFlashcards={isResponsible:function(node,interaction){return node.is("matchInteraction")&&"Present:Present:Flashcards"==interaction.identifier},_serializeXML:function(node){return(new XMLSerializer).serializeToString(node)},_processPipeSyntax:function(node){var contents=node.contents().map(function(i,e){return this._serializeXML(e)}.bind(this)).get().join(""),fields=contents.split("|");return fields.length>1&&(fields=_.map(fields,function(field,index){return'<div class="card-content-'+index+'">'+field+"</div>"})),$($.parseXML("<root><div>"+fields.join("")+"</div></root>")).children("root").contents().get(0)},buildMatchInteraction:function(interaction,parentNode,node){var correct=interaction.getCorrectResponse(node.attr("responseIdentifier")).asInverseMap(),model=new a5.model.interaction.PPFlashcards({autoAudioPlayback:interaction.options.audioPlaybackIsAuto(),beforeFlipAudioPlayback:interaction.options.audioPlaybackIsBefore_card_flip()})
;_.each(node.find("simpleMatchSet:nth-child(2) > simpleAssociableChoice"),function(frontNode){frontNode=$(frontNode);var identifier=frontNode.attr("identifier"),backIdentifier=correct[identifier][0],backNode=node.find("simpleAssociableChoice[identifier="+backIdentifier+"]");model.addCard({front:this.buildContents(this._processPipeSyntax(frontNode),interaction),back:this.buildContents(this._processPipeSyntax(backNode),interaction)})},this);var cardsPerRow=parseInt(interaction.options.getCardPerRow(),10);isNaN(cardsPerRow)&&(cardsPerRow=0);var view=new a5.view.interaction.PPFlashcards(model,parent,interaction.options.getCardFormat(),cardsPerRow);interaction.blockItems.add(model),parentNode.append(view.render());var contentblock=node.find("#contentblock");contentblock.length&&parentNode.append(this._serializeXML(contentblock[0]))}},a5.model_builder.Base.extend("a5.model_builder.PPFlashcards"),a5.model_builder.builders.push(new a5.model_builder.PPFlashcards),a5.model_builder.PPSlideshow={isResponsible:function(node,interaction){return node.is("#slides")&&"Present:Present:Slideshow"==interaction.identifier},buildDiv:function(interaction,parentNode,node){var model=new a5.model.interaction.PPSlideshow({parent:interaction,shuffle:interaction.options.randomiseanswersIsTrue(),automaticControl:!interaction.options.automaticplayIsOff(),magnifySlides:interaction.options.automaticplayIsOn_magnify(),shuffleControl:interaction.options.shufflecontrolIsOn(),additionalImageControl:interaction.options.additionalimagecontrolIsOn(),step:a5.dp.config.ppslideshowStep,delay:a5.dp.config.ppslideshowDelay,magnifyStart:a5.dp.config.ppslideshowMagnifyStart,magnifyEnd:a5.dp.config.ppslideshowMagnifyEnd,minTime:a5.dp.config.ppslideshowMinTime,maxTime:a5.dp.config.ppslideshowMaxTime,endingTime:a5.dp.config.ppslideshowEndingTime});_(node.find("#slide")).each(function(slideNode){var slide={},$slide=this.buildContents(slideNode,interaction,null,"#decodeimage");slide.content=$slide.contents();var decodeNode=$(slideNode).find("#decodeimage");if(decodeNode.length>0){var $decode=this.buildContents(decodeNode,interaction);slide.decode=$decode.contents()}model.addSlide(slide)},this);var view=new a5.view.interaction.PPSlideshow(model);parentNode.append(view.render())}},a5.model_builder.Base.extend("a5.model_builder.PPSlideshow"),a5.model_builder.builders.push(new a5.model_builder.PPSlideshow),a5.model_builder.IdentifySelectMaze={isResponsible:function(node,interaction){return node.is("choiceInteraction")&&"Identify:Select:Maze"==interaction.identifier},build:function(interaction,parentNode,node){this.interaction=interaction,interaction.hasReadyListener||interaction.interactionDone||(interaction.hasReadyListener=!0,interaction.onInteractionRestoreListeners.register(this.attachEvents.bindTo(this))),interaction.started=!1,parentNode.prepend().prepend("<div class='padding'></div>"),parentNode.addClass("dir2_view notdone"),parentNode.css("clear","none");var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")),str=window.a5.mainBuilder.layout.getTemplate("maze");_.each($(node).find("simpleChoice"),function(n){var node=$("<span></span>");if(interaction.buildModelExludeNode(node,n,!0),"audio"==_.first($(n).attr("identifier"),5).join(""))parentNode.append("<span class='audio'>"+$(n).find("object:first").attr("data")+"</span> ");else{var s_1=($(node.html()),window.a5.mainBuilder.layout.replaceSubpart(str,"maze_front",node.html())),obj=$(window.a5.mainBuilder.layout.replaceSubpart(s_1,"maze_back","<img src='images/maze-icon.jpg'>")),identifier=$(n).attr("identifier");_.include(correctResponse.values,identifier)&&obj.attr("id",identifier),parentNode.append(obj)}parentNode.parent().css("border","none")}),interaction.firstCall||(parentNode.parent().prepend("<div class='dir2_view'><div class='padding'></div><div class='button'><a href='#' class='start'>Start</a></div></div>"),interaction.ism=new a5.models.interaction.IdentifySelectMaze({node:parentNode.parent().parent()}),interaction.blockItems.add(interaction.ism),interaction.firstCall=!0,interaction.bind("show",_.bind(this.attachEvents,this)),interaction.bind("rendered",this.attachEvents,this),interaction.onInteractionReadyListeners.register(this.onInteractionReady.bindTo(this))),setTimeout(function(){_.each($("#content-"+interaction.index+" .contentblock"),function(cb){0==$(cb).find("p").children().length&&$(cb).remove()}),_.each($("#content-"+interaction.index+" .is-maze .contentblock"),function(cb){$(cb).find("br").remove()})},100),$("#content-"+interaction.index+" p.dir2_view").css("margin","0"),$("#content-"+interaction.index+" .is-maze .contentblock").css("float","left")},onInteractionReady:function(){var interaction=window.a5.mainBuilder.curInteraction;$("#content-"+interaction.index+" .contentblock p").length},updateState:function(){},attachEvents:function(){var self=this,interaction=window.a5.mainBuilder.curInteraction,audio=$("#content-"+interaction.index+" .dir2_view.active:first > span.audio:first").html(),audioPlayer=a5.service.media.audio.create(audio,{preload:!a5.dp.config.audioPreloadDisabled});a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(audioPlayer);var prefill=interaction.options.prefillIsFirstblock()||interaction.options.prefillIsFirstitem();$("#content-"+interaction.index+" a.start").die("click"),$("#content-"+interaction.index+" a.start").live("click",function(){$("#content-"+interaction.index+" .dir2_view.notdone:first").addClass("active").removeClass("notdone"),interaction.ism.step++,self.interaction.started=!0,a5.service.media.pauseAllExcept(audioPlayer),audioPlayer.play()}),$("#content-"+interaction.index+" .dir2_view.active > .panel").die("click"),$("#content-"+interaction.index+" .dir2_view.active > .panel").live("click",function(){if(!self.interaction.interactionDone)if($(this).addClass("checked"),$(this).attr("id"))$(this).addClass("flip"),$(this).parent().removeClass("active").addClass("done"),$("#content-"+interaction.index+" .dir2_view.notdone:first").removeClass("notdone").addClass("active"),interaction.ism.step++,audioPlayer.stop();else{var t=$(this);$(this).addClass("flip"),setTimeout(function(){t.removeClass("flip")},1e3)}a5.mainBuilder.updateScoresAsync()});var t=setInterval(function(){var h=$("#content-"+interaction.index+" .dir2_view:last").css("height");if("0px"!=h){clearInterval(t),prefill&&0==$("#content-"+interaction.index+" .dir2_view.active").length&&($("#content-"+interaction.index+" .dir2_view.notdone:first").removeClass("notdone").addClass("done"),interaction.ism.step++,$("#content-"+interaction.index+" .dir2_view.done:first > .image-choice").each(function(e,el){var $el=$(el);$el.attr("id")&&setTimeout(function(){$el.addClass("flip")},2e3)})),$("#content-"+interaction.index+" .dir2_view").css("height",parseInt(h,10)+30+"px"),$("#content-"+interaction.index+" .dir2_view").css("margin-bottom","20px");var pos=0;$("#content-"+interaction.index+" .dir2_view").each(function(e,div){var innerHeight=0;$(div).find(".image-choice").each(function(s,span){innerHeight+=parseInt($(span).css("height"),10)}),$(div).find(".padding").css("padding-top",(parseInt(h,10)-innerHeight)/2-20+"px");var $choices=$(div).find(".image-choice");if($choices.length>0){var target=$choices.filter("[id]").get(0);$choices=_.shuffle($choices);var newpos=_.indexOf($choices,target);pos+=Math.round(Math.random()),a5.utils.array.swap($choices,pos,newpos),$(div).find(".image-choice").remove(),$(div).append($choices)}$("#content-"+interaction.index+" .dir2_view").show()})}},0)}},a5.model_builder.Base.extend("a5.model_builder.IdentifySelectMaze"),a5.model_builder.builders.push(new a5.model_builder.IdentifySelectMaze),a5.model_builder.Pelmanism={isResponsible:function(node,interaction){return node.is("matchInteraction")&&"Identify:Select:Pelmanism"==interaction.identifier},build:function(interaction,parentNode,node){var answers={},correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier"));_.each(correctResponse.values,function(v){v=v.split(" "),answers[v[0]]=v[1],answers[v[1]]=v[0]});var container,model=new a5.model.interaction.ISPelmanismBoard({cardsPerRow:parseInt(interaction.options.getCardPerRow(),10),cardFormat:interaction.options.getCardFormat(),cardLayout:interaction.options.getCardLayout(),cardBack:interaction.options.getCardBack(),hasPrefill:interaction.options.prefillIsFirstitem(),scorable:!!interaction.blockItems.blockScore,autoAudioPlayback:interaction.options.audioPlaybackIsAuto(),beforeFlipAudioPlayback:interaction.options.audioPlaybackIsBefore_card_flip(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()}),modeImg=interaction.options.cardBackIsImage(),modeImgSet=interaction.options.cardBackIsImagesets(),backimg_1="",backimg_2="",images=[];_.each(node.children("simpleMatchSet"),function(n){_.each($(n).find("simpleAssociableChoice"),function(s){if("OPTION148"===$(s).attr("identifier"))return void(images=$(s).find("img"))})}),(modeImg||modeImgSet)&&images.length>0&&(container=$("<div></div>"),interaction.buildModel(container,$(images[0]),!0),backimg_1=$(container).html(),backimg_2=backimg_1),modeImgSet&&images.length>1&&(container=$("<div></div>"),interaction.buildModel(container,$(images[1]),!0),backimg_2=$(container).html());var num=0;_.each(node.children("simpleMatchSet"),function(n){num++,_.each($(n).find("simpleAssociableChoice"),function(s){var identifier=$(s).attr("identifier");if("OPTION148"!==identifier){container=$("<span></span>"),interaction.buildModelExludeNode(container,s,!0);var backCard="";modeImg&&(backCard=backimg_1),modeImgSet&&(backCard=1===num?backimg_1:backimg_2),model.addCard({identifier:identifier,html:container,pair:answers[identifier],back:backCard,setNum:num})}},this)},this),interaction.blockItems.add(model);var view=new a5.views.interaction.ISPelmanism(model);parentNode.append(view.node),view.render(),container=$("<div></div>"),_.each(node.find(".contentblock"),function(s){var classes=$(s).attr("class").split(/\s+/).filter(function(klass){return"contentblock"!==klass}).join(" ");view.node.addClass(classes),interaction.buildModelExludeNode(container,s,!0)}),parentNode.append(container),parentNode.addClass("pmn_view");var otherContent=node.children(":not(simplematchset)");this.buildContents(otherContent,interaction,parentNode)}},a5.model_builder.Base.extend("a5.model_builder.Pelmanism"),a5.model_builder.builders.push(new a5.model_builder.Pelmanism),a5.model_builder.RadioAccordion={isResponsible:function(node,interaction){return node.is("#content")&&"Input:Creative:Free writing 2 col"==interaction.identifier},buildDiv:function(interaction,parentNode,node){var model=new a5.models.interaction.RadioAccordion,view=new a5.views.interaction.RadioAccordion(model);interaction.mediaZone.prepend('<div class="radio-accordion-open-alert"></div>'),this.eachContentBlock(interaction,parentNode,node,function(childNode){var childView=this.buildChildView(interaction,$(childNode));model.append(childView.model),view.append(childView)}),interaction.items.add(model),parentNode.append(view.render())},buildChildView:function(interaction,node){var model=new a5.models.interaction.RadioAccordionElement({content:this.buildContents(node,interaction).html(),enumeration:interaction.enumBlock.next(),alertNode:interaction.mediaZone.children(".radio-accordion-open-alert")});return new a5.views.interaction.RadioAccordionElement(model,node.attr("class"))}},a5.model_builder.Content.extend("a5.model_builder.RadioAccordion"),a5.model_builder.builders.push(new a5.model_builder.RadioAccordion),a5.model_builder.ClueLink={isResponsible:function(node,interaction){return node.is("clueLink, clueTarget, clueLabel")},buildClueLink:function(interaction,parentNode,node){var clueLink=$('<span class="clue-link"></span>');this.buildContents(node,interaction,clueLink),clueLink.find(":first").show();var index=0,lIndex=0,cids=node.attr("cid").split("*");clueLink.on("click",_.bind(function(e){var labels=interaction.$(".clue-label[data-clue-id='"+node.attr("cid")+"']");lIndex%2==0?(this._toggleHighlight(interaction,e.target,[cids[index]],!0),index=(index+1)%cids.length):(this._toggleHighlight(interaction,e.target,cids,!1),index=0),0===index&&(lIndex=(lIndex+1)%(labels.length||2),labels.hide(),$(labels[lIndex]).show())},this)),parentNode.append(clueLink)},_toggleHighlight:function(interaction,clueLink,clueTargetIds,highlight){$(clueLink).toggleClass("highlighted",highlight),_(clueTargetIds).each(function(cid){var targets=interaction.$(".clue-area[data-clue-id='"+cid+"']");_.each(targets,function(target){$(target).toggleClass("highlighted",highlight),$(target).css(highlight?{backgroundColor:"#"+$(target).attr("data-clue-color")}:{backgroundColor:""})})})},buildClueTarget:function(interaction,parentNode,node){var clueArea=$('<span class="clue-area" data-clue-id="'+node.attr("cid")+'" data-clue-color="'+node.attr("color")+'"></span>');this.buildContents(node,interaction,clueArea),parentNode.append(clueArea)},buildClueLabel:function(interaction,parentNode,node){var clueLabel=$('<span class="clue-label" data-clue-id="'+node.attr("cid")+'" style="display:none;"></span>');this.buildContents(node,interaction,clueLabel),parentNode.append(clueLabel)}},a5.model_builder.Base.extend("a5.model_builder.ClueLink"),a5.model_builder.builders.push(new a5.model_builder.ClueLink),a5.model_builder.Hidden={isResponsible:function(node,interaction){return node.is("hidden")},build:function(interaction,parentNode,node){interaction.options.revealObjectIsFalse()||(parentNode.addClass("opt-021-hidden"),parentNode.attr("data-opt-021-prio",node.attr("prio")))}},a5.model_builder.Base.extend("a5.model_builder.Hidden"),a5.model_builder.builders.push(new a5.model_builder.Hidden),a5.model_builder.TextToggle={isResponsible:function(node,interaction){return node.is("toggletext")||node.is("togglingtext")},buildToggletext:function(interaction,parentNode,node){var $node=$('<div class="toggle-text">'+node.text()+"</div>");$node.click(function(){0==$(this).next().find("span.tT").length?$(this).next().toggle():$(this).next().find("span.tT").toggle()}),$node.disableSelection(),parentNode.before($node)},buildTogglingtext:function(interaction,parentNode,node){parentNode.append($('<span class="tT">'+node.text()+"</span>"))}},a5.model_builder.Base.extend("a5.model_builder.TextToggle"),a5.model_builder.builders.push(new a5.model_builder.TextToggle),a5.model_builder.TextToggle={isResponsible:function(node,interaction){return node.is("triggerWord")||node.is("triggerText")},_initTriggerWords:function(){this.triggerWords={};var intList=_([a5.mainBuilder.introScreen,a5.mainBuilder.intList]).chain().flatten().compact().value();_.each(intList,function(interaction){this.triggerWords[interaction.index]={}},this)},_serializeXML:function(node){return(new XMLSerializer).serializeToString(node)},_sanitizeImages:function(node){var imgs=node.find("[src]");$.each(imgs,function(index,img){var src=A5.ASSET_URL_BUILDER($(img).attr("src"));$(img).attr("src",src)})},buildTriggerWord:function(interaction,parentNode,node){this._sanitizeImages(node);var model=new a5.models.TriggerWord({identifier:node.attr("id"),content:this._serializeXML(node[0]),showonce:node.attr("once"),simultaneous:node.attr("simultaneous"),displayword:"display"==node.attr("display")}),view=new a5.views.TriggerWord(model,null,interaction),id=node.attr("id").toLowerCase();_.isUndefined(this.triggerWords)&&this._initTriggerWords();var word=this.triggerWords[interaction.index][id];word instanceof Array&&_(word).each(function(w){view.addTrigText(w)}),this.triggerWords[interaction.index][id]=view,parentNode.append(view.render())},buildTriggerText:function(interaction,parentNode,node){var $node=$('<div class="trigger-text"></div>');$node.attr("id",node.attr("id")),this.buildContents(node,interaction,$node),$node.find(".trigtext-paragraph-placeholder").remove(),$node.hide();var id=node.attr("id").toLowerCase();_.isUndefined(this.triggerWords)&&this._initTriggerWords();var word=this.triggerWords[interaction.index][id];word?word instanceof a5.views.TriggerWord?word.addTrigText($node):this.triggerWords[interaction.index][id].push($node):this.triggerWords[interaction.index][id]=[$node],parentNode.append($node)}},a5.model_builder.Base.extend("a5.model_builder.TextToggle"),a5.model_builder.builders.push(new a5.model_builder.TextToggle),a5.model_builder.FeedbackText={isResponsible:function(node,interaction){return node.is("feedbackText")},_serializeToString:function(node){return(new XMLSerializer).serializeToString(node).replace(/<feedbackText[^>]*>/gi,"").replace(/<\/feedbackText>/gi,"")},buildFeedbackText:function(interaction,parentNode,node){interaction.feedbackText[node.attr("id")]=this._serializeToString(node[0])}};a5.model_builder.Base.extend("a5.model_builder.FeedbackText"),a5.model_builder.builders.push(new a5.model_builder.FeedbackText),a5.model_builder.BuddyBuilder={isResponsible:function(node,interaction){return a5.utils.hasId(node,"buddy")},buildDiv:function(interaction,parentNode,node){var $appendTo=$('<div class="buddy"></div>');parentNode.append(a5.utils.buildContents(node,interaction,$appendTo));var state,audioID;if($appendTo.find(".buddyAudioContainer").length>0){audioID=$appendTo.find(".buddyAudioContainer").first().find("[data-playable-media]").first().attr("data-playable-media")}node.attr("data-state")&&(state=node.attr("data-state")),new a5.service.Buddy(interaction,state,$appendTo,audioID)}},a5.model_builder.Base.extend("a5.model_builder.BuddyBuilder"),a5.model_builder.builders.push(new a5.model_builder.BuddyBuilder),a5.model_builder.InlineEditor={isResponsible:function(node,interaction){return node.is("inlineEditor")},_serializeXML:function(node){return(new XMLSerializer).serializeToString(node)},buildInlineEditor:function(interaction,parentNode,node){var prefill=(a5.model_builder.InlineEditor.GUID(),this._serializeXML(node[0])),$node=$("<div class='a5-inlineeditor' contenteditable=true>"+prefill+"</div>");try{var ck=$node.ckeditor({toolbar:[["Bold","Italic","Underline","Superscript","Subscript","-","NumberedList","BulletedList"]],customConfig:"",styleSet:!1});if(_.isUndefined(ck.editor))throw TypeError;var model=new a5.models.InlineEditor({editor:ck.editor,prefill:prefill});interaction.blockItems.add(model),ck.editor.on("instanceReady",function(){ck.editor.setReadOnly(!1)}),model.bind("update",function(data){$node.editor.setData(data.text)})}catch(e){model.bind("update",function(data){$node.html(data.text)})}parentNode.append($node)}},a5.model_builder.Base.extend("a5.model_builder.InlineEditor"),a5.model_builder.builders.push(new a5.model_builder.InlineEditor),a5.model_builder.InlineEditor.GUID=function(){var guid=0;return function(){return guid++}}(),a5.model_builder.TextToSpeechPlayer={isResponsible:function(node,interaction){return node.is("texttospeechplayer")},build:function(interaction,parentNode,node){if(interaction.options.audiosupportIsTrue()&&(!interaction.options.choiceAlignmentIsHorizontal()||!parentNode.children(".choice_interaction").length)&&(!interaction.options.choiceAlignmentIsVertical()||!parentNode.children(".choice_interaction").length)&&!parentNode.children(".ll_view").length&&!parentNode.children(".syllabify-word").length&&!parentNode.children(".gap_match_view").length&&(parentNode.children(".trigger-text").length&&(parentNode=parentNode.find(".trigger-text")),interaction.options.audiosupportIsTrue()&&this._hasTextContent(parentNode)&&!this._hasTTSPlayer(parentNode))){var text=this._nodeToText(parentNode,interaction);if(parentNode.is("tr")&&parentNode.find("td").length&&(parentNode=parentNode.find("td, th").first(),parentNode.children("table").length||parentNode.children("p").length))return;if(parentNode.is("tr")&&parentNode.find("th").length&&(parentNode=parentNode.find("th, td").first(),parentNode.children("table").length||parentNode.children("p").length))return;parentNode.prepend(this.createTTSAudio(text).render()),parentNode.addClass("a5_tts_enabled")}},_hasTextContent:function(node){var hasImgAlt=node.find("img[alt][alt!='']").length>0,hasText=""!==node.text().trim()&&!node.text().trim().match(/^\s*\.+\s*$/);return hasImgAlt||hasText},_hasTTSPlayer:function(node){return node.parents(".a5_tts_audio_element").length>0},createTTSAudio:function(text){return new a5.views.TTS_Player(text)},_nodeToText:function(node,interaction){var clone=$(node).clone(!0);return clone.find(".a5_tts_enabled").remove(),$(clone).find("*").each(function(i){$(this).is("input")||$(this).is("textarea")?interaction.options.speaklearnerinputIsTrue()?$(this).replaceWith("<span>"+$(this).val()+"</span>"):$(this).replaceWith("<span> ... </span>"):$(this).is(".enum-answers")?$(this).replaceWith(""):$(this).is(".drag_holder")?interaction.options.speaklearnerinputIsTrue()?$(this).replaceWith("<span>"+$(this).val()+"</span>"):$(this).replaceWith("<span> ... </span>"):$(this).is("td")||$(this).is("th")?$(this).append("<span>; </span>"):$(this).is(".wrapper-dropdown")?$(this).replaceWith("<span> ... </span>"):$(this).is("img")&&$(this).attr("alt")&&$(this).replaceWith("<span>"+$(this).attr("alt")+"</span>")}),clone.text()}},a5.model_builder.Base.extend("a5.model_builder.TextToSpeechPlayer"),a5.model_builder.builders.push(new a5.model_builder.TextToSpeechPlayer),a5.model_builder.ShowAnswer={isResponsible:function(node,interaction){return node.is("answer")},build:function(interaction,parentNode,node){var answerNum=parseInt(node.attr("id"),10)-1,screenNum=parseInt(node.attr("screen"),10)-1;interaction.bind("show",_.bind(function(){var selected_interaction=a5.mainBuilder.intList[screenNum],answers=[];switch(selected_interaction.identifier){case"Identify:Select:Radiobutton":selected_interaction.options.showInColumnsIsTrue()&&(answers=this.buildRadioColumnMode(selected_interaction,parentNode,screenNum,answerNum));break;case"Identify:Select:Checkbox":selected_interaction.options.showInColumnsIsTrue()&&(answers=this.buildCheckboxColumnMode(selected_interaction,parentNode,screenNum,answerNum));break;case"Present:Present:Present":if(0==selected_interaction.blockItems.itemList.length)break;selected_interaction.blockItems.itemList[0]._class_name.indexOf("ISRadiobuttonModel")>=0&&(answers=this.buildRadioColumnMode(selected_interaction,parentNode,screenNum,answerNum));break;default:logger.warn("ShowAnswer not implemented for "+selected_interaction.identifier)}_.each(answers,function(answer){parentNode.append(answer)}),interaction.bind("hide",function(){$(".show-answer").remove()})},this))},buildRadioColumnMode:function(interaction,parentNode,screenNum,answerNum){var results=[],answers=[],items=interaction.blockItems.itemList;return _.each(items,function(item){item.selected&&item.selected.value==item.choices[answerNum].value&&results.push(item.selected.label)}),_.each(results,function(answer,i){answer.addClass("show-answer"),answer.addClass("show-answer-"+screenNum+"-"+answerNum),answer.addClass("answer-column-"+answerNum+"-"+i),answers.push(answer)}),answers},buildCheckboxColumnMode:function(interaction,parentNode,screenNum,answerNum){var results=[],answers=[],items=interaction.blockItems.itemList;return _.each(items,function(item,i){item.choices[answerNum]&&item.choices[answerNum].selected&&results.push(item.choices[answerNum].label)}),_.each(results,function(answer,i){answer.addClass("show-answer"),answer.addClass("show-answer-"+screenNum+"-"+answerNum),answer.addClass("answer-column-"+answerNum),answers.push(answer)}),answers}},a5.model_builder.Base.extend("a5.model_builder.ShowAnswer"),a5.model_builder.builders.push(new a5.model_builder.ShowAnswer),a5.model_builder.EndResult={SCORE_DEBOUNCE_TIMER:50,isResponsible:function(node,interaction){return this.methodToBuild(node)in this},build:function(interaction,parentNode,node){interaction.isEndResultScreen()&&!this.resultsGenerator&&(this.resultsGenerator=new a5.model_builder.EndResultsGenerator(interaction),interaction.blockItems.add(this.resultsGenerator.model)),this[this.methodToBuild(node)].call(this,interaction,parentNode,node)},buildBandFeedback:function(interaction,parentNode,node){var self=this,bands=_.map(node.attr("values").split("*"),function(x){return parseFloat(x)});this.addDeferredContent(parentNode,interaction,function(){return self.resultsGenerator.getBandFeedback(interaction,bands)},"feedbackBand")},buildIndex:function(interaction,parentNode,node){this.currentInteraction&&parentNode.append('<span class="index">'+this.currentInteractionLabel+"</span>")},buildManuallyMarked:function(interaction,parentNode,node){this.currentInteraction?this.currentInteraction.options.manualMarkingIsOn()&&this.buildContents(node,interaction,parentNode):a5.mainBuilder.someManuallyMarked()&&this.buildContents(node,interaction,parentNode)},buildAutomaticMarked:function(interaction,parentNode,node){this.currentInteraction?this.currentInteraction.options.manualMarkingIsOff()&&this.buildContents(node,interaction,parentNode):a5.mainBuilder.someManuallyMarked()||this.buildContents(node,interaction,parentNode)},buildLOMode:function(interaction,parentNode,node){node.attr("mode")==LOInfo.mode&&this.buildContents(node,interaction,parentNode)},buildForEachSection:function(interaction,parentNode,node){var options=a5.mainBuilder.options(!0).getLOParts();_.each(options,function(part,index){var interactions=[];_.each(_.range(part.from-1,part.to),function(index){interactions.push(a5.mainBuilder.intList[index])},this),this.currentInteraction=new a5.InteractionGroup(interactions,index),this.currentInteractionLabel=part.label,this.buildContents(node,interaction,parentNode),this.currentInteraction=null},this)},buildForEachInteraction:function(interaction,parentNode,node){_.each(_.initial(a5.mainBuilder.intList),function(i){this.currentInteraction=i,this.currentInteractionLabel=""+(this.currentInteraction.index+1),this.buildContents(node,interaction,parentNode),this.currentInteraction=null},this)},buildScore:function(interaction,parentNode){var self=this;this.addDeferredText(parentNode,interaction,function(currentInteraction){return self.resultsGenerator.getScore(currentInteraction)},"score")},buildTotalquestions:function(interaction,parentNode){var self=this;this.addDeferredText(parentNode,interaction,function(currentInteraction){return self.resultsGenerator.getTotalquestions(currentInteraction)})},buildCorrectanswers:function(interaction,parentNode){var self=this;this.addDeferredText(parentNode,interaction,function(currentInteraction){return self.resultsGenerator.getCorrectanswers(currentInteraction)})},buildIncorrectanswers:function(interaction,parentNode){var self=this;this.addDeferredText(parentNode,interaction,function(currentInteraction){return self.resultsGenerator.getIncorrectanswers(currentInteraction)})},buildTimetaken:function(interaction,parentNode){var self=this;this.addDeferredText(parentNode,interaction,function(currentInteraction){return self.resultsGenerator.getTimetaken(currentInteraction)})},buildTimeout:function(interaction,parentNode){var self=this;this.addDeferredText(parentNode,interaction,function(){return self.resultsGenerator.getTimeout()})},buildDate:function(interaction,parentNode){var self=this;this.addDeferredText(parentNode,interaction,function(){return self.resultsGenerator.getDateString()})},buildAttempts:function(interaction,parentNode){var self=this;this.addDeferredText(parentNode,interaction,function(){return self.resultsGenerator.getAttempts()})},buildAllCorrectAttempt:function(interaction,parentNode,node){var self=this,attempt=parseInt($(node).attr("attempt"),10);this.addDeferredText(parentNode,interaction,function(){return self.resultsGenerator.getAllCorrectAttempt(attempt)})},buildUnsolved:function(interaction,parentNode,node){var self=this,threshold=parseInt($(node).attr("threshold"),10);this.addDeferredText(parentNode,interaction,function(){return self.resultsGenerator.getUnsolved(threshold)})},buildSolved:function(interaction,parentNode,node){var self=this,threshold=parseInt($(node).attr("threshold"),10);this.addDeferredText(parentNode,interaction,function(){return self.resultsGenerator.getSolved(threshold)})},buildNotAttempted:function(interaction,parentNode){var self=this;this.addDeferredText(parentNode,interaction,function(){return self.resultsGenerator.getNotAttempted()})},addDeferredText:function(parentNode,interaction,callback,classes){var $node=$("<span></span>").addClass(classes);callback=_.partial(callback,this.currentInteraction),window.a5.mainBuilder.bind("score_update",function(){this.setNodeContent(callback,$node)},this),interaction.bind("show",function(){this.setNodeContent(callback,$node)},this),parentNode.append($node)},addDeferredContent:function(parentNode,interaction,callback,classes){var $node=$("<span></span>").addClass(classes);callback=_.partial(callback,this.currentInteraction),interaction.bind("show",function(){if(window.a5.mainBuilder.restoring){var restoredListener=function(){a5.eventBus.unbind("lo:restored",restoredListener),this.setNodeContent(callback,$node)};a5.eventBus.bind("lo:restored",restoredListener,this)}else this.setNodeContent(callback,$node)},this),parentNode.append($node)},setNodeContent:function(callback,$node){var $content=callback.apply(window.a5.mainBuilder);$node.empty().append($content)}},a5.model_builder.Base.extend("a5.model_builder.EndResult"),a5.model_builder.builders.push(new a5.model_builder.EndResult),a5.model_postBuilder.EndResult={isResponsible:function(node,interaction){return"Present:Present:Present"==interaction.identifier},build:function(interaction,parentNode){new a5.views.LONavigation(a5.mainBuilder,parentNode.find(".lo-navigation")).render()}},Obj.extend("a5.model_postBuilder.EndResult"),a5.model_postBuilder.builders.push(new a5.model_postBuilder.EndResult),a5.model_builder.EndResultsGenerator={init:function(interaction){this.interaction=interaction,this.model=new a5.models.EndResult},scoreFetcher:function(interaction){var score=interaction.getScores();return"input"==interaction.status&&(score.correct=0,score.correctBlocks=0),score},getScore:function(interaction){if(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored){var results=(interaction||a5.mainBuilder).getResults(this.scoreFetcher);this.model.set(interaction,"score",results.human().percent())}return this.model.get(interaction,"score")},getTotalquestions:function(interaction){if(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored){var results=(interaction||a5.mainBuilder).getResults(this.scoreFetcher);this.model.set(interaction,"total",results.human().total())}return this.model.get(interaction,"total")},getCorrectanswers:function(interaction){if(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored){var results=(interaction||a5.mainBuilder).getResults(this.scoreFetcher);this.model.set(interaction,"correct",results.human().correct())}return interaction&&"input"===interaction.status?"-":this.model.get(interaction,"correct")},getIncorrectanswers:function(interaction){if(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored){var results=(interaction||a5.mainBuilder).getResults(this.scoreFetcher);this.model.set(interaction,"incorrect",results.human().incorrect())}return this.model.get(interaction,"incorrect")},getTimetaken:function(interaction){var timetaken="-";return interaction&&interaction.activityDuration?timetaken=interaction.activityTimer.getTimeString(interaction.activityDuration):a5.mainBuilder.timer?timetaken=a5.mainBuilder.timer.getTimeString(a5.mainBuilder.timer.getElapsedTime()):a5.mainBuilder.aggregatedLODuration&&(timetaken=a5.mainBuilder.loTimer.getTimeString(a5.mainBuilder.aggregatedLODuration)),timetaken},getTimeout:function(){var timeout="-";return a5.mainBuilder.timer&&(timeout=a5.mainBuilder.timer.getTimeString(a5.mainBuilder.timer.originalTime)),timeout},getDateString:function(){
return(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored)&&this.model.set(null,"date",(new Date).toLocaleDateString()),this.model.get(null,"date")},getAttempts:function(){var ret=0;return a5.mainBuilder.canSubmit?ret=a5.mainBuilder.submitAttempts:a5.mainBuilder.canSendScores&&(ret=a5.mainBuilder.sendScoreAttempts),ret},getAllCorrectAttempt:function(attempt){return(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored)&&(this.model.allcorrectbyattempt[attempt]=a5.mainBuilder.getAllCorrectAttemptInteractions(attempt).length),this.model.allcorrectbyattempt[attempt]},getUnsolved:function(threshold){return(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored)&&(this.model.unsolved=a5.mainBuilder.getUnsolvedInteractions(threshold).length),this.model.unsolved},getSolved:function(threshold){return(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored)&&(this.model.solved=a5.mainBuilder.getSolvedInteractions(threshold).length),this.model.solved},getNotAttempted:function(){return(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored)&&(this.model.notattempted=a5.mainBuilder.getNotAttemptedInteractions().length),this.model.notattempted},getBandFeedback:function(interaction,bands){for(;bands.length<3;)bands.unshift(0);var percent=a5.mainBuilder.getResults().percent(),band=3;percent<bands[2]&&(band=2),percent<bands[1]&&(band=1),percent<bands[0]&&(band=0);var bandID=["349","348","347","346"][band],feedback="";if(interaction.options.has(bandID)&&"false"!=interaction.options.get(bandID)){feedback=_.unescape(interaction.options.getValue(bandID)),feedback=a5.preprocessor.apply(feedback,interaction),a5.mainBuilder.setLastFeedbackBand(feedback);feedback=a5.utils.buildContents($("<span>"+feedback+"</span>"),interaction,$("<div>"))}return feedback},getBandFeedbackString:function(interaction,bands){var band=this.getBandFeedback(interaction,bands);return band?band.html():""}},Obj.extend("a5.model_builder.EndResultsGenerator"),a5.model_builder.Scramble={isResponsible:function(node,interaction){return node.is("scramble")},build:function(interaction,parentNode,node){parentNode.append(a5.utils.scrambleText(node.text()))}},a5.model_builder.Base.extend("a5.model_builder.Scramble"),a5.model_builder.builders.push(new a5.model_builder.Scramble),a5.model_builder.RadioCheck={isResponsible:function(node,interaction){return node.is("radio")||node.is("checkbox")},buildRadio:function(interaction,parentNode,node){var model=this.createModel(node,interaction,a5.models.RadioButton,a5.models.RadioButtonChoice,{enableToggle:!1});this.createView(parentNode,model,a5.views.NoValidateRadiobuttonChoiceView)},buildCheckbox:function(interaction,parentNode,node){var model=this.createModel(node,interaction,a5.models.Checkbox,a5.models.CheckboxChoice);this.createView(parentNode,model,a5.views.NoValidateCheckboxChoiceView)},createModel:function(node,interaction,groupClass,modelClass,extraOptions){var groupName=node.attr("group"),selected=!!node.attr("selected"),group=_.find(interaction.blockItems.itemList,function(group){return group.name===groupName});group||(group=new groupClass({name:groupName}),interaction.blockItems.add(group));var radio=new modelClass(_.extend(extraOptions||{},{value:node.attr("value"),parent:group,selected:selected}));return group.add(radio),radio},createView:function(parentNode,model,viewClass){var view=new viewClass(model);parentNode.is("p")&&parentNode.addClass("selectable-syntax-group"),parentNode.append(view.addInput().updateSelected().node)}},a5.model_builder.Base.extend("a5.model_builder.RadioCheck"),a5.model_builder.builders.push(new a5.model_builder.RadioCheck),a5.model_builder.Save={isResponsible:function(node,interaction){return node.is("save")},build:function(interaction,parentNode,node){var button=new a5.views.SaveButton(interaction,node.attr("image"));parentNode.append(button.render().$node)}},a5.model_builder.Base.extend("a5.model_builder.Save"),a5.model_builder.builders.push(new a5.model_builder.Save),a5.model_builder.TextArea={isResponsible:function(node,interaction){return node.is("textinput, richtextinput, inlinetextinput")&&"Input:Creative:Extended writing"!==interaction.identifier},buildTextinput:function(interaction,parentNode,node){this.buildView(interaction,parentNode,node,!node.attr("width")||node.attr("height")?a5.views.TextArea:a5.views.TextInput)},buildRichtextinput:function(interaction,parentNode,node){this.buildView(interaction,parentNode,node,a5.views.RichTextArea).initCK()},buildInlinetextinput:function(interaction,parentNode,node){this.buildView(interaction,parentNode,node,a5.views.TextInput)},buildView:function(interaction,parentNode,node,viewClass){var max,scorable=!!interaction.blockItems.blockScore,options={width:node.attr("width"),height:node.attr("height"),maxLength:interaction.options.getMaxLength(),maxType:interaction.options.get("120"),autogrow:interaction.options.textboxAutogrowIsOn(),inline:node.is("inlinetextinput")};node.attr("max")&&(max=node.attr("max").split(" "),options.maxLength=parseInt(max[0],10),options.maxType=max[1],node.attr("hidemax")&&(options.hidemax=!0)),node.attr("min")&&(max=node.attr("min").split(" "),options.minLength=parseInt(max[0],10),options.minType=max[1],node.attr("hidemin")&&(options.hidemin=!0));var model=new a5.models.TextArea({content:this._toPlainText(node),scorable:scorable,interaction:interaction,maxLength:options.maxLength,minLength:options.minLength,maxType:options.maxType,minType:options.minType});interaction.blockItems.add(model),options.spellcheck=interaction.options.spellcheckIsOn();var view=new viewClass(model,options),$node=view.render();return parentNode.append($node),view},_toPlainText:function(node){var str="";return _(node.contents()).each(function(c){c.tagName&&"br"===c.tagName.toLowerCase()?str+="\n":str+=$(c).text().replace(/\t/g,"").replace(/\n/g,"")}),str}},a5.model_builder.Base.extend("a5.model_builder.TextArea"),a5.model_builder.builders.push(new a5.model_builder.TextArea),a5.model_builder.TextArea={isResponsible:function(node,interaction){return node.is("showtext")},buildShowtext:function(interaction,parentNode,node){var inputIndex,interactionIndex=0;a5.utils.isInteger(node.attr("screen"))&&(interactionIndex=parseInt(node.attr("screen"),10)-1),a5.utils.isInteger(node.attr("input"))&&(inputIndex=parseInt(node.attr("input"),10)-1);var parentInt=a5.mainBuilder.getInteractionFromIndex(interactionIndex),views=[],createModels=function(){var models=[],textAreaCount=0;return _.each(parentInt.items.itemList,function(items){_.each(items.itemList,function(item){"a5.models.TextArea"===item._class_name&&(textAreaCount++,(_.isUndefined(inputIndex)||inputIndex===textAreaCount-1)&&models.push(item))})}),models},createViews=function(){views=_.map(createModels(),function(model){var view=new a5.views.ShowText(model);return parentNode.append(view.render()),view})};parentInt.isLiveCycle("loaded")?createViews():parentInt.bind("rendered",createViews,this),a5.mainBuilder.bind("reset",function(){interaction.bind("show",_.once(function(){var models=createModels();_.each(views,function(view,i){view.updateModel(models[i]),view.updateContent()})}))}),interaction.bind("show",function(){_.each(views,function(view){view.updateContent()})},this)}},a5.model_builder.Base.extend("a5.model_builder.TextArea"),a5.model_builder.builders.push(new a5.model_builder.TextArea),a5.model_builder.Confidence={isResponsible:function(node,interaction){return this.methodToBuild(node)in this},buildConfidenceSelector:function(interaction,parentNode,node){var data={text:node.text()};_.each(node[0].attributes,function(x){data[x.name]=x.value,data[x.name+"_selected"]=x.name==a5.mainBuilder.confidenceLevel[0]});var $node=$(a5.service.templates.render("a5.view.ConfidenceSelector",data));parentNode.append($node),a5.mainBuilder.confidenceLevel[1]=a5.mainBuilder.confidenceLevel[1]||"Nothing selected",$node.on("click","div > div",_.bind(function(n){$node.find("div > div").removeClass("selected"),$(n.target).addClass("selected");var id=$(n.target).attr("data-level");a5.mainBuilder.confidenceLevel=[id,data[id]],a5.service.lms.API.setData("confidenceLevel",a5.mainBuilder.confidenceLevel),a5.mainBuilder.updateScores()},this)),interaction.bind("show",function(){a5.mainBuilder.canSubmit&&!a5.mainBuilder.hasMoreSubmitAttempts()&&$node.off("click","div > div")})},buildConfidenceDisplay:function(interaction,parentNode,node){var $node=$(a5.service.templates.render("a5.view.ConfidenceDisplay",{}));parentNode.append($node),a5.mainBuilder.bind("score_update",function(){var cn=$node.find("[data-confidence]");cn.text(a5.mainBuilder.confidenceLevel[1]),cn.removeClass("level-v0 level-v1 level-v2"),cn.addClass("level-"+a5.mainBuilder.confidenceLevel[0])})}},a5.model_builder.Base.extend("a5.model_builder.Confidence"),a5.model_builder.builders.push(new a5.model_builder.Confidence),a5.model_builder.MathML={mathMLList:[],mathMLLoadStates:{NOT_LOADED:0,LOADING:1,LOADED:2},mathMLState:0,isResponsible:function(node,interaction){return node.is("img[data-mathml][data-author]")&&this._mathMLDisplay(node.attr("data-author"))},_mathMLDisplay:function(jsonStr){if(_.isEmpty(jsonStr))return!1;try{return JSON.parse(htmlDecode(jsonStr)).mathMLDisplay}catch(e){return logger.warn("MathML Builder: data-author wrongly formatted: "+jsonStr),!1}},build:function(interaction,parentNode,node){var spanEl=this._appendMathMLNode(node);parentNode.append(spanEl),this.mathMLState===this.mathMLLoadStates.LOADED?this._formatMathML(spanEl):(this.mathMLList.push(spanEl),this.mathMLState===this.mathMLLoadStates.NOT_LOADED&&(this.mathMLState=this.mathMLLoadStates.LOADING,window.MathJax={root:A5.MATHJAX},$.getScript(A5.MATHJAX+"/MathJax.js?config=TeX-MML-AM_CHTML").done(_.bind(this._mathMLLoaded,this))))},_mathMLLoaded:function(script,status){this.mathMLState=this.mathMLLoadStates.LOADED,_.each(this.mathMLList,this._formatMathML,this),this.mathMLList=[],MathJax.Hub.Register.MessageHook("Math Processing Error",function(message){logger.error(message[2])})},_appendMathMLNode:function(node){var mathMLContent=htmlDecode(node.attr("data-mathml")),$span=$('<div class="has-mathml"></div>'),spanEl=$span[0];return spanEl.style.visibility="hidden",spanEl.innerHTML=mathMLContent,spanEl},_formatMathML:function(spanEl){MathJax.Hub.Queue(["Typeset",MathJax.Hub,spanEl],["_mathMLRendered",this,spanEl])},_mathMLRendered:function(spanEl){spanEl.style.visibility=""}},a5.model_builder.Base.extend("a5.model_builder.MathML"),a5.model_builder.builders.push(new a5.model_builder.MathML),a5.model_builder.Alert={isResponsible:function(node,interaction){return node.is("alert")},build:function(interaction,parentNode,node){var $alert=$('<span class="alert alert-'+node.attr("type")+'"></span>');parentNode.append($alert)}},a5.model_builder.Base.extend("a5.model_builder.Alert"),a5.model_builder.builders.push(new a5.model_builder.Alert),a5.model_builder.Navbutton={isResponsible:function(node,interaction){return node.is("navbutton")},build:function(interaction,parentNode,node){var screen=parseInt(node.attr("screen"),10)-1,$button=$('<a href="#" class="nav-button"></span>');$button.text(node.text()),$button.attr("data-screen",screen),$button.click(function(e){e.preventDefault(),a5.mainBuilder.goTo(screen)}),a5.hooks.interactionShowed.add(function(interaction){var history=_.pluck(a5.mainBuilder.navigationHistory.getHistory(),"index");$button.toggleClass("visited",_.contains(history,screen)),$button.toggleClass("current",_.last(history)==screen)}),parentNode.append($button)}},a5.model_builder.Base.extend("a5.model_builder.Navbutton"),a5.model_builder.builders.push(new a5.model_builder.Navbutton),a5.model_builder.InfoText={isResponsible:function(node,interaction){return node.is("infotext")},buildInfotext:function(interaction,parentNode,node){if(!interaction.options.showinfotextIsOff()){var dictionary=interaction.options.referenceContentIsOff()?"":interaction.options.getReferenceContent(),xml=a5.utils.serializeXML(node[0]);xml=this._wrapIntoCDATA(xml);var $xml=$($.parseXML(xml)).find("infotext"),view=new a5.views.InfoText($xml.attr("icon"),$xml.text(),$xml.attr("class"),dictionary);parentNode.append(view.render())}},_wrapIntoCDATA:function(xml){var ret=xml;return ret=ret.replace(/(<infotext [^>]*>)/gi,"$1<![CDATA["),ret=ret.replace(/(<\/infotext>)/gi,"]]>$1")}},a5.model_builder.Base.extend("a5.model_builder.InfoText"),a5.model_builder.builders.push(new a5.model_builder.InfoText),a5.model_builder.UserSelection={isResponsible:function(node,interaction){return node.is("userselection")},buildUserselection:function(interaction,parentNode,node){var multiple="true"===(node.attr("multiple")||"").toLowerCase(),view=new a5.views.UserSelection(a5.mainBuilder,parseInt(node.attr("step"),10),parseInt(node.attr("max"),10),multiple);parentNode.append(view.render())}},a5.model_builder.Base.extend("a5.model_builder.UserSelection"),a5.model_builder.builders.push(new a5.model_builder.UserSelection),a5.model_builder.AlternativeText={isResponsible:function(node,interaction){return node.is("alternativeText")},build:function(interaction,parentNode,node){if(!interaction.options.alternativeTextIsOff()){var altNode=node.find("#"+interaction.options.getAlternativeText());this.buildContents(altNode,interaction,parentNode)}}},a5.model_builder.Base.extend("a5.model_builder.AlternativeText"),a5.model_builder.builders.push(new a5.model_builder.AlternativeText),a5.model_builder.TranslationBlock={isResponsible:function(node,interaction){return node.is("translationBlock")||node.is("language")},buildTranslationBlock:function(interaction,parentNode,node){var $node=$("<div class='translation-block'>");$node.append(node.clone(!0).contents()),a5.utils.buildModel(interaction,parentNode,$node)},buildTranslationblock:function(interaction,parentNode,node){this.buildTranslationBlock(interaction,parentNode,node)},buildLanguage:function(interaction,parentNode,node){var $node=$("<div class='language-block'>"),langcode=interaction.registerLanguage(node.attr("lang"));$node.attr("data-lang",langcode),$node.append(node.clone(!0).contents()),interaction.getLanguage()==langcode?$node.show():$node.hide(),a5.utils.buildModel(interaction,parentNode,$node),interaction.bind("language:change",function(lang){var blocks=parentNode.find("div[data-lang]");_.each(blocks,function(block){$(block).attr("data-lang")===lang?($(block).show(),$(block).find("*[data-playable-media]").removeClass("a5-avatar-ignore-audio")):($(block).hide(),$(block).find("*[data-playable-media]").addClass("a5-avatar-ignore-audio"))})})}},a5.model_builder.Base.extend("a5.model_builder.TranslationBlock"),a5.model_builder.builders.push(new a5.model_builder.TranslationBlock),a5.model_builder.Karaoke={isResponsible:function(node,interaction){return node.is("karaoke")},buildKaraoke:function(interaction,parentNode,node){var $karaoke=$(_.str.sprintf('<span class="karaoke" data-from="%1$s" data-to="%2$s"></span>',node.attr("from"),node.attr("to")));interaction.karaoke=interaction.karaoke||{},interaction.karaoke[node.attr("audio")]=interaction.karaoke[node.attr("audio")]||new a5.models.Karaoke,interaction.karaoke[node.attr("audio")].add($karaoke),this.buildContents(node,interaction,$karaoke),parentNode.append($karaoke)}},a5.model_builder.Base.extend("a5.model_builder.Karaoke"),a5.model_builder.builders.push(new a5.model_builder.Karaoke),a5.model_builder.Poll={isResponsible:function(node,interaction){return node.is("poll")},buildPoll:function(interaction,parentNode,node){var options=node.children("option"),choiceIds=_.pluck(options,"id"),choiceTexts=_.pluck(options,"innerHTML"),sets=node.children("set"),setIds=_.pluck(sets,"id"),setNames=_.pluck(sets,"textContent"),type=node.attr("type"),className=a5.utils.capitalize(type)+"Poll",modelClass=a5.models[className],viewClass=a5.views[className],model=new modelClass({ids:choiceIds,options:choiceTexts,setIds:setIds,sets:setNames,screenNo:interaction.index,interaction:interaction}),view=new viewClass(model);parentNode.append(view.render())}},a5.model_builder.Base.extend("a5.model_builder.Poll"),a5.model_builder.builders.push(new a5.model_builder.Poll),a5.model_builder.PollResults={NODE_HTML:'<table class="poll-results"><tbody><tr><th class="choice"></th><th class="count"></th></tbody></table>',CHOICE_HTML:'<tr><td class="choice"></td><td class="count"></td></tr>',isResponsible:function(node,interaction){return node.is("pollresults")},buildPollresults:function(interaction,parentNode,node){var screenNo=parseInt(node.attr("screen"),10),pollInteraction=a5.mainBuilder.intList[screenNo-1],poll=$("poll",pollInteraction.xml),choiceIds=_.pluck(poll.children(),"id"),choiceTexts=_.pluck(poll.children(),"innerHTML"),html=$(this.NODE_HTML),body=html.find("tbody");parentNode.append(html),interaction.bind("show",function(){this._updatePollresults(pollInteraction,body,choiceIds,choiceTexts)},this)},_updatePollresults:function(pollInteraction,parentNode,choiceIds,choiceTexts){a5.service.lms.API.getPollResults(pollInteraction.index,function(results){this._clean(parentNode),_.each(choiceIds,function(id,i){parentNode.append($(this.CHOICE_HTML).find(".choice").text(choiceTexts[i]).end().find(".count").text(results[id]||0).end())},this)}.bindTo(this))},_clean:function(parentNode){parentNode.children().slice(1).remove()}},a5.model_builder.Base.extend("a5.model_builder.PollResults"),a5.model_builder.builders.push(new a5.model_builder.PollResults),a5.model_builder.ContentMessage={isResponsible:function(node,interaction){return node.is("contentmessage")},buildContentmessage:function(interaction,parentNode,node){var message=[],rawMessage=node.attr("message");rawMessage&&(message=rawMessage.split("|"));var view=new a5.views.ContentMessage(message,rawMessage);parentNode.append(view.$el),this.buildContents(node,interaction,view.$el),view.render()}},a5.model_builder.Base.extend("a5.model_builder.ContentMessage"),a5.model_builder.builders.push(new a5.model_builder.ContentMessage),a5.ViewData={init:function(){},setXML:function(dom){var self=this;this.variables={},_.each($(dom).find("assessmentItem > responseDeclaration"),function(e){self.variables[$(e).attr("identifier")]=new a5.models.item.response.declaration.ResponseDeclaration($(e))})},getVariable:function(id){return void 0===this.variables[id]?null:this.variables[id]},getLongestResponse:function(id,$node){var maxAnswer,maxWidth=0,answers=_.map(this.variables[id].values,function(val){return htmlDecode(val)});answers=_(answers).reject(function(answer){return _.str.startsWith(answer,"**")||a5.utils.containsUnescaped(answer,"@")}),answers=_(answers).map(function(answer){return _.first(a5.utils.splitUnescaped(answer,"|"))}),answers=_(answers).map(function(answer){return answer.split("##").shift()}),answers=_(answers).map(function(answer){return a5.utils.unescapeReservedSyntaxSymbols(answer)});var answer=_.first(answers),width=$node.textWidth(answer);return width>maxWidth&&(maxWidth=width,maxAnswer=answer),{answer:maxAnswer,width:maxWidth}},getLongestAllResponses:_.memoize(function(key,$node){var maxAnswer,maxWidth=0;return _.each(this.variables,function(rD,variable){var longest=this.getLongestResponse(variable,$node);longest.width>maxWidth&&(maxWidth=longest.width,maxAnswer=longest.answer)},this),{answer:maxAnswer,width:maxWidth}})},Obj.extend("a5.ViewData",a5.ViewData),a5.models.item.response.declaration.ResponseDeclaration={correctResponse:null,init:function(node){this.values=_.map(node.find("correctResponse > value"),function(val){return $(val).text()});var defaultValues=_.map(node.find("defaultValue > value"),function(val){return $(val).text()});this.defaultValue=defaultValues.length?defaultValues[0]:null},asMap:function(){var map={};return this.values.forEach(function(e){e=e.split(" "),2==e.length&&(e[1]in map||(map[e[1]]=[]),map[e[1]].push(e[0]))}),map},asMapMulti:function(){var map={};return _.each(this.values,function(e){var vals=e.split(" ");map[vals[0]]=_.rest(vals)}),map},asInverseMap:function(){var map={};return this.values.forEach(function(e){e=e.split(" "),2==e.length&&(e[0]in map||(map[e[0]]=[]),map[e[0]].push(e[1]))}),map}},Obj.extend("a5.models.item.response.declaration.ResponseDeclaration"),a5.models.interaction.BaseModel={init:function(parameters,defaults){defaults=defaults||{},defaults=$.extend({parent:null,engine:null,correctFeedback:null,incorrectFeedback:null},defaults),parameters=parameters||{},parameters=$.extend({},defaults,parameters);for(var newProp in parameters)newProp in defaults||logger.raise("Parameter",newProp,"not supported for",this);$.extend(this,parameters),this.id=a5.utils.createUID(),this.state="input"},views:function(){var views=[];return $("*[data-model-id='"+this.id+"']").each(function(i,e){views.push($(e).data("mvc-view"))}),views},callViews:function(name,params){params=params||[],this.views().forEach(function(e){name in e?e[name].apply(e,params):logger.warn("no method "+name+" for view ",e._class_name)})},acceptedStates:function(){return["input","feedback","answers"]},setState:function(newState){_.contains(this.acceptedStates(),newState)||logger.log("error,",this,".setState has invalid parameter",newState),this.state=newState,this.trigger("state_update:"+newState),this.trigger("state_update")},setAnswer:function(){this.setState("feedback")},setAnswerInput:function(){this.trigger("input_update:setAnswer")},showAnswer:function(){this.setState("answers")},tryAgain:function(){this.setState("input")},assignAnswerFeedback:function(node){var answerFeedback=node.attr("answerfeedback");if(answerFeedback){answerFeedback=answerFeedback.replace(/src=(['"])http(s)*:/gi,"src=$1");var match=answerFeedback.match(/#view:(\w+)#/);match?this.answerFeedbackId=match[1]:this.answerFeedback=answerFeedback}},getAnswerFeedback:function(){return this.isCorrect()?this.processFeedback(this.correctFeedback)||this.answerFeedback:this.processFeedback(this.incorrectFeedback)||this.answerFeedback},processFeedback:function(feedback){return feedback?(feedback=feedback.replace("#correct_answer#",_.bind(function(){return this.correctText()},this)),feedback=feedback.replace("#wrong_answer#",_.bind(function(){return this.wrongText()},this))):null},getScores:function(){return new a5.Score},store:function(){return{}},restore:function(data){}},Obj.extend("a5.models.interaction.BaseModel"),a5.models.interaction.DragElement={init:function(parameters,defaults){this._super(parameters,$.extend({identifier:"",copyOnDrag:!1,content:null,home:null,existing:null,correct:[],prefilled:!1,clickclick:!1,gaptextaudio:!1,overflowOnDrag:!1,selected:!1,behavior:"drop",dropAudio:null},defaults))},disable:function(){this.callViews("disable")},enable:function(){this.callViews("enable")},isDrag:function(){return"drag"===this.behavior},isTapItem:function(){return"tap_item"===this.behavior},isTapTarget:function(){return"tap_target"===this.behavior}},a5.models.interaction.BaseModel.extend("a5.models.interaction.DragElement"),a5.models.interaction.DropArea={init:function(parameters,defaults){this._super(parameters,$.extend({allowed:null,identifier:"",drag:null,copyOnDrag:!1,enumeration:null,globalEnumeration:!1,content:null,position:null,arrow:null,prefilled:!1,resident:null,existing:null,dropIndicator:!1,allowRepeat:!0,dependOn:null,tryAgainKeep:!1,blockNumber:0,capitalize:!1},defaults))},canDrop:function(model){var existing=this.existing||model.existing||"no";return(!this.drag||"swap"==existing||"home"==existing||this.copyOnDrag)&&(null==this.allowed||this.allowed.contains(model))&&!this.prefilled},drop:function(drag){this.drag=drag,this.callViews("updateDrag"),this.trigger("drop"),drag.trigger("drop"),a5.mainBuilder.updateScoresAsync()},undrop:function(drag){this.drag=null,this.callViews("updateDrag"),this.trigger("undrop"),a5.mainBuilder.updateScoresAsync()},isFilled:function(){return!!this.drag},isCorrect:function(){return!1},isCorrectable:function(){return!1},isScorable:function(){return!1},isDistractor:function(){return!1},wrongDrag:function(){return!1},setPrefilled:function(){this.prefilled=!0,this.callViews("updateDrag")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.DropArea"),a5.models.interaction.StackDropArea={init:function(parameters,defaults){this._super(parameters,$.extend({},defaults)),this.drags=[]},canDrop:function(model){return null==this.allowed||this.allowed.contains(model)},drop:function(drag){if(!drag)throw"null not allowed for dropping into stack drop areas";this.drags.push(drag),this.callViews("updateDrags"),drag.trigger("drop")},undrop:function(drag){this.drags.remove(drag),this.callViews("updateDrags")},isHead:function(drag){return drag&&drag===_.last(this.drags)},isCorrectable:function(){return!1},isCorrect:function(){return!1},wrongDrag:function(){return!1}},a5.models.interaction.DropArea.extend("a5.models.interaction.StackDropArea"),a5.model.InteractionToolbar={init:function(parameters,defaults){this._super(parameters,$.extend({},defaults)),this.buttons=[]},addToggleButton:function(parameters){var button=new a5.model.InteractionToolbarToggleButton($.extend(parameters,{parent:this}));return this.buttons.push(button),this.callViews("update"),button},resetToggleGroup:function(group){_.each(this.buttons,function(button){button.group==group&&button.setPressed(!1)})},isEnable:function(){return _.all(this.buttons,function(button){return button.isEnable()})},setEnableButtonsStatus:function(status){_.each(this.buttons,function(button){button.setStatus(status)})},shuffleButtons:function(){this.buttons=_.shuffle(this.buttons),this.trigger("reorder")}},a5.models.interaction.BaseModel.extend("a5.model.InteractionToolbar"),a5.model.InteractionToolbarToggleButton={init:function(parameters,defaults){this._super(parameters,$.extend({label:"label",title:"",css:{},classes:[],on:function(){},off:function(){},enable:!0,tts_audio:!1,pressed:!1,group:!1},defaults))},isPressed:function(){return this.pressed},getCss:function(){return this.css},setStatus:function(status){this.enable=status,this.callViews("update")},isEnable:function(){return this.enable},getClasses:function(){return this.classes},click:function(){this.enable&&(this.group?this.setPressed(!0):this.setPressed(!this.isPressed()))},setPressed:function(pressed){this.pressed!=pressed&&(pressed&&this.group&&this.parent.resetToggleGroup(this.group),this.pressed=pressed,this.callViews("update"),this.pressed?this.on():this.off())}},a5.models.interaction.BaseModel.extend("a5.model.InteractionToolbarToggleButton"),a5.model.NavigationHistory={init:function(){this._stack=[]},addNavigationAction:function(interaction){this._stack.push(interaction),logger.info("Showing interaction #"+interaction.index)},getHistory:function(){return _.clone(this._stack)},clearHistory:function(){this._stack=[]}},Obj.extend("a5.model.NavigationHistory"),a5.models.PollBase={init:function(parameters,defaults){this._super(parameters,$.extend({ids:[],options:[],setIds:[],sets:[],screenNo:0,interaction:null},defaults)),this.selected=[],this.interaction.bind("show",this._getSelected,this,{once:!0}),a5.eventBus.bind("lo:submit",this._setSelected,this)},_getSelected:function(){a5.service.lms.API.getUserPollAnswers(this.screenNo,function(answers){_.each(answers,function(answer){this.select(answer)},this),this.trigger("update")}.bindTo(this))},_setSelected:function(){this.selected.length&&a5.service.lms.API.setUserPollAnswers(this.screenNo,this.selected,this.options)}},a5.models.interaction.BaseModel.extend("a5.models.PollBase"),a5.models.RadioPoll={select:function(id){this.selected=[id]},deselect:function(id){this.selected[0]===id&&(this.selected=[])}},a5.models.PollBase.extend("a5.models.RadioPoll"),a5.models.CheckboxPoll={select:function(id){_.contains(this.selected,id)||this.selected.push(id)},deselect:function(id){this.selected=_.without(this.selected,id)}},a5.models.PollBase.extend("a5.models.CheckboxPoll"),a5.models.RadiosetPoll={select:function(id){var alt=id.slice(id.indexOf("-"));this.selected=_.reject(this.selected,function(id){return a5.utils.endsWith(id,alt)}),this._super(id)}},a5.models.CheckboxPoll.extend("a5.models.RadiosetPoll"),a5.models.CheckboxsetPoll={},a5.models.CheckboxPoll.extend("a5.models.CheckboxsetPoll"),a5.models.Selectable={init:function(parameters,defaults){this._super(parameters,$.extend(defaults,{name:null,gaptextaudio:!1})),this.choices=[],this.state="input"},getAnswers:function(){var choices=_.filter(this.choices,function(choice){return choice.correct&&!choice.prefill&&!choice.prefilled});return _.map(choices,function(choice){return choice.text})},add:function(choiceModel){this.choices.push(choiceModel)},getScores:function(){return new a5.Score},setAnswer:function(){this.setState("feedback")},showAnswer:function(){this.setState("answers")},showNextAnswer:function(){this.showAnswer(),this.trigger("next_answer")},tryAgain:function(){this.unselect(),this.setState("input")},setState:function(newState){_.invoke(this.choices,"setState",newState),this._super(newState)}},a5.models.interaction.BaseModel.extend("a5.models.Selectable"),a5.models.RadioButton={init:function(parameters,defaults){this._super(parameters,$.extend(defaults,{selected:null}))},setSelected:function(choice){choice!=this.selected&&(this.selected=choice,this.trigger("change"),a5.mainBuilder.updateScoresAsync())},isFilled:function(){return!!this.selected},isCorrect:function(){return!0},unselect:function(){this.setSelected(null)},store:function(){var data={};return this.selected?data.selected=this.selected.value:data.selected=null,data},restore:function(data){var selected=_.find(this.choices,function(choice){return choice.value==data.selected});this.setSelected(selected)}},a5.models.Selectable.extend("a5.models.RadioButton"),a5.models.RadioButtonChoice={init:function(parameters,defaults){this._super(parameters,$.extend(defaults,{value:null,selected:!1,enableToggle:!0})),this.selected&&this.select()},isCorrectAnswer:function(){return!0},isSelectedAnswer:function(){return this.parent.selected==this},clicked:function(){this.enableToggle?this.toggle():this.select()},select:function(){this.isSelectedAnswer()||this.parent.setSelected(this)},unselect:function(){this.isSelectedAnswer()&&this.parent.setSelected(null)},toggle:function(){this.isSelectedAnswer()?this.unselect():this.select()}},a5.models.interaction.BaseModel.extend("a5.models.RadioButtonChoice"),a5.models.Checkbox={unselect:function(){_.invoke(this.choices,"unselect")},store:function(){var choices={};return _.map(this.choices,function(choice){choices[choice.value]=choice.store()}),{choices:choices}},restore:function(data){_.each(this.choices,function(choice,i){choice.restore(data.choices[choice.value])})}},a5.models.Selectable.extend("a5.models.Checkbox"),a5.models.CheckboxChoice={init:function(parameters,defaults){this._super(parameters,$.extend({value:null,selected:!1},defaults))},isCorrect:function(){return!0},isSelectedAnswer:function(){return this.selected},clicked:function(){this.toggle()},select:function(){this.selected||(this.selected=!0,this.trigger("change"),a5.mainBuilder.updateScoresAsync())},unselect:function(){this.selected&&(this.selected=!1,this.trigger("change"),a5.mainBuilder.updateScoresAsync())},toggle:function(){this.isSelectedAnswer()?this.unselect():this.select()},store:function(){return{selected:this.selected}},restore:function(data){this.selected!==Boolean(data.selected)&&this.toggle()}},a5.models.interaction.BaseModel.extend("a5.models.CheckboxChoice"),a5.models.TextArea={init:function(attributes){this._super(attributes,{content:null,scorable:!1,interaction:null,maxLength:!1,minLength:!1,maxType:!1,minType:!1}),this.data=this.content},store:function(){return this.cke?this.cke.getData():this.data},getScores:function(){var score=new a5.Score;return this.isScorable()&&score.incTotal(),score},wordCount:function(){if(!this.data)return 0
;var match=this.data.match(/[a-zA-Z0-9][a-zA-Z0-9\-']*/g);return match?match.length:0},meetsMinLength:function(){return"chars"===this.minType&&this.minLength>0?this.data.length>=this.minLength:!("words"===this.minType&&this.minLength>0)||this.wordCount()>=this.minLength},restore:function(data){this.data=data,this.trigger("change")},isScorable:function(){return this.scorable}},a5.models.interaction.BaseModel.extend("a5.models.TextArea"),a5.models.TriggerWord={init:function(attributes){this._super(attributes,{identifier:"",content:null,displayword:!1,showonce:!1,simultaneous:!1})}},a5.models.interaction.BaseModel.extend("a5.models.TriggerWord"),a5.models.InlineEditor={init:function(parameters,defaults){this._super(parameters,$.extend(defaults,{editor:null,prefill:""}))},store:function(){return{text:this.editor.getData()}},restore:function(data){this.text=data.text,this.trigger("update",data)},getScores:function(){var score=new a5.Score;return score.incTotal(),score}},a5.models.interaction.BaseModel.extend("a5.models.InlineEditor"),a5.model.Clock={init:function(parameters,defaults){if(this._super(parameters,$.extend({className:"",startTime:null,locked:!1,running:!1},defaults)),this.startTime){var match=this.startTime.match(/(\d?\d):(\d?\d)/);if(match){var hour=match[1],minute=match[2];this.startTime=new Date,this.startTime.setHours(hour),this.startTime.setMinutes(minute),this.startTime.setSeconds(0),this.startTime.setMilliseconds(0)}else logger.error("Wrong time format: "+this.startTime)}_.isObject(this.startTime)||(this.startTime=new Date,this.startTime.setHours(12),this.startTime.setMinutes(0),this.startTime.setSeconds(0),this.startTime.setMilliseconds(0)),this.running?(this.timeGap=this.startTime-new Date,setInterval(_.bind(this._eachMinute,this),6e4)):this.timeGap=0},getTime:function(){return this.running?new Date(Date.now()+this.timeGap):new Date(this.startTime.getTime()+this.timeGap)},addTime:function(gap){this.timeGap=this.timeGap+gap},_eachMinute:function(){this.callViews("update")}},a5.models.interaction.BaseModel.extend("a5.model.Clock"),a5.models.Countdown={init:function(options){this.totalTime=options.total,this.elapsedTime=0,_.bindAll(this,"onTick")},start:function(){this.startTime=this._current(),this.timer=setInterval(this.onTick,100),this.trigger("start")},pause:function(){clearInterval(this.timer),this.elapsedTime+=this._current()-this.startTime,this.trigger("pause")},stop:function(){clearInterval(this.timer),this.trigger("stop")},end:function(){this.stop(),this.trigger("end")},reset:function(){clearInterval(this.timer),this.elapsedTime=0,this.trigger("reset",this.totalTime)},_current:function(){return window.performance.now()/1e3},onTick:function(){var seconds=Math.ceil(this.totalTime-this.elapsedTime+this.startTime-this._current());seconds<0&&(seconds=0),this.trigger("progress",seconds,Math.round(100*(1-seconds/this.totalTime))),0===seconds&&this.end()}},Obj.extend("a5.models.Countdown"),a5.models.EndResult={init:function(parameters,defaults){this._super(parameters,$.extend({allcorrectbyattempt:{},unsolved:0,solved:0,notattempted:0,sections:[],interactions:[]},defaults)),this.loData=new a5.models.EndResultData},get:function(interaction,key){var collection=interaction instanceof a5.InteractionGroup?"sections":"interactions";return collection=this[collection],interaction?collection[interaction.index][key]:this.loData[key]},set:function(interaction,key,value){if(interaction){var collection=interaction instanceof a5.InteractionGroup?"sections":"interactions";collection=this[collection],collection[interaction.index]||(collection[interaction.index]=new a5.models.EndResultData),collection[interaction.index][key]=value}else this.loData[key]=value},store:function(){var data={allcorrectbyattempt:this.allcorrectbyattempt,unsolved:this.unsolved,solved:this.solved,notattempted:this.notattempted};return data.loData=this.loData.store(),_(this.interactions).each(function(interaction){data.interactions||(data.interactions=[]),data.interactions.push(interaction&&interaction.store())}),_(this.sections).each(function(section){data.sections||(data.sections=[]),data.sections.push(section&&section.store())}),data},restore:function(data){_.isEmpty(data)||(this.allcorrectbyattempt=data.allcorrectbyattempt,this.unsolved=data.unsolved,this.solved=data.solved,this.notattempted=data.notattempted,this.loData=new a5.models.EndResultData(data.loData),this.interactions=[],_(data.interactions).each(function(interaction){this.interactions.push(interaction&&new a5.models.EndResultData(interaction))},this),this.sections=[],_(data.sections).each(function(section){this.sections.push(section&&new a5.models.EndResultData(section))},this),this.isRestored=!0)}},a5.models.interaction.BaseModel.extend("a5.models.EndResult"),a5.models.EndResultData={init:function(parameters,defaults){this._super(parameters,$.extend({score:0,total:0,correct:0,incorrect:0,date:""},defaults))},store:function(){return{score:this.score,total:this.total,correct:this.correct,incorrect:this.incorrect,date:this.date}},restore:function(data){this.score=data.score,this.total=data.total,this.correct=data.correct,this.incorrect=data.incorrect,this.date=data.date}},a5.models.interaction.BaseModel.extend("a5.models.EndResultData"),a5.models.interaction.GapMatchInteraction={init:function(parameters,defaults){this._super(parameters,$.extend({answers:[],responses:[],stacks:0,poolAlignment:null,poolRandomized:!1,poolAlphabeticalOrder:!1,freeDragLocation:null,subtractIncorrect:!1,allowRepeat:!0,groupsMap:{},tts_audio:!1,gapsOption:null,multiDest:"one",hasOrderedResponses:!1},defaults)),this.hasStacks()&&(this.stackAreas=this._createStacks()),this.mapAnswerToGap=this.responses.asInverseMap(),this.mapGapToAnswer=this.responses.asMap(),this.mapAnswerToText=_(a5.utils.asMap(this.answers)).mapObject(_.first),this.mapTextToAnswer=a5.utils.asInverseMap(this.answers),this.dragElements=[],this.poolDropAreas=[],this.targetDropAreas=[],this.nextCorrectIndex={},this.interaction=this.parent,"restricted"===this.multiDest&&this.interaction.bind("show",function(){this.updatePoolDropAreasMultidest()},this)},getAnswers:function(){var targets=_.filter(this.targetDropAreas,function(target){return target.isCorrectable()});return _.map(targets,function(target){return target.getCorrect().content.html()})},getUniqueAnswers:function(){return _(this.mapTextToAnswer).chain().values().map(_.first).value()},getStackFor:function(index){return this.stackAreas&&this.stackAreas[index%this.stacks]},sortPoolByText:function(){this.poolDropAreas=a5.utils.array.sortBy(this.poolDropAreas,function(dropArea){return dropArea.drag?dropArea.drag.content.text():""},!0)},naturalsortPoolByText:function(){this.poolDropAreas=a5.utils.array.naturalSort(this.poolDropAreas,function(dt){return dt.drag?dt.drag.content.text():""},!0,!0)},getAvailablePoolAreas:function(){return this.hasStacks()?this.stackAreas:_.filter(this.poolDropAreas,function(pa){return!pa.isFilled()&&!pa.prefilled})},getAvailableFillAreas:function(){return _.filter(this.targetDropAreas,function(tda){return!tda.isFilled()})},randomizePool:function(){this.poolDropAreas=_.shuffle(this.poolDropAreas)},hasStacks:function(){return _.isNumber(this.stacks)&&!_.isNaN(this.stacks)&&this.stacks>0},addDragElement:function(dragElement){dragElement.parent=this,this.dragElements.push(dragElement),dragElement.bind("drop",this._onChange,this)},addPoolDropArea:function(dropArea){dropArea.parent=this,this.poolDropAreas.push(dropArea)},addTargetDropArea:function(dropArea){dropArea.parent=this,dropArea.group=this.groupsMap[dropArea.identifier],this.targetDropAreas.push(dropArea)},_onChange:function(){"restricted"===this.multiDest&&this.updatePoolDropAreasMultidest()},setPrefilled:function(dropArea){"restricted"===this.multiDest?0===this.dragElementsCount[dropArea.drag.identifier]&&dropArea.setPrefilled():dropArea.setPrefilled()},updatePoolDropAreasMultidest:function(){this.hasOrderedResponses&&!this.mapTextToCount&&(this.mapTextToCount=_.chain(this.targetDropAreas).map(function(target){return target.correct()}).unzip().map(function(correct){return _.countBy(correct)}).value()),this.dragElementsCount={},_.each(this.dragElements,function(drag){this.isDistractor(drag)||(this.dragElementsCount[drag.identifier]=this.getNumberOfCorrectRepetitions(drag))},this),_.each(this.targetDropAreas,function(target){if(target.drag&&!this.isDistractor(target.drag)){var count=this.dragElementsCount[target.drag.identifier];this.dragElementsCount[target.drag.identifier]=_.max([count-1,0])}},this),_.each(this.poolDropAreas,function(pool){pool.drag&&!this.isDistractor(pool.drag)&&(pool.copyOnDrag=this.dragElementsCount[pool.drag.identifier]>1)},this)},getNumberOfCorrectRepetitions:function(drag){if(this.hasOrderedResponses&&"restricted"===this.multiDest){var text=this.mapAnswerToText[drag.identifier];return _.max(this.mapTextToCount,function(count){return count[text]})[text]}return this.mapAnswerToGap[drag.identifier].length},_createStacks:function(){var stackAreas=[];return _.each(_.range(0,this.stacks),function(){var stack=new a5.models.interaction.StackDropArea({parent:this,dropIndicator:this.parent.options.dropIndicatorIsTrue(),copyOnDrag:!1});stackAreas.push(stack)},this),stackAreas},isFreeDragLocation:function(){return"between_letters"===this.freeDragLocation||"between_words"===this.freeDragLocation},getScores:function(){var groups=_.groupBy(this.targetDropAreas,function(target){return target.blockNumber}),groupScores=_.map(groups,function(targets,group){var blockScore=this.interaction.options.getScoreValuesPerBlock().split(",");blockScore=parseInt(blockScore[group],10),_.isNaN(blockScore)&&(blockScore=void 0);var score=new a5.Score;return _.each(targets,function(target){target.isCorrectable()&&(target.isScorable()&&score.incTotal(),null!=target.drag&&(score.incFilled(),target.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect()))},this),score.filled>score.total&&(score.filled=score.total),score.correct<0&&(score.correct=0),(score.total>0||blockScore>0)&&(score.totalBlocks=1,score.total>0&&score.correct==score.total?score.correctBlocks=1:this.subtractIncorrect&&score.total>0&&score.filled>0&&score.correct<score.total&&(score.correctBlocks=-1),0===score.total&&(score.total=blockScore),score.blockScore=blockScore),score},this),score=new a5.Score;return _.each(groupScores,function(qiScore){_.isUndefined(qiScore.blockScore)?(score.total+=qiScore.total,score.correct+=qiScore.correct,score.filled+=qiScore.filled,score.totalBlocks+=qiScore.totalBlocks,score.correctBlocks+=qiScore.correctBlocks):(score.total+=qiScore.blockScore,score.correct+=qiScore.correct*qiScore.blockScore/qiScore.total,score.filled+=qiScore.filled*qiScore.blockScore/qiScore.total,score.totalBlocks+=qiScore.blockScore,score.correctBlocks+=qiScore.correctBlocks*qiScore.blockScore/qiScore.totalBlocks)},this),score},isCorrect:function(){return _.every(this.targetDropAreas,function(target){return target.isCorrect()})},isFilled:function(){return _.some(this.targetDropAreas,function(target){return target.isFilled()})},getCandidatesForSolutionHint:function(){return _.filter(this.targetDropAreas,function(item){return"answers"!==item.state&&item.isCorrectable()&&!item.isFilled()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.targetDropAreas,function(item){return"answers"!==item.state&&item.isCorrectable()&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForValidation:function(){return _.filter(this.targetDropAreas,function(item){return"answers"!==item.state&&item.isCorrectable()&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();if(question){question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer();var correct=question.getCurrentCorrectDrag().identifier,pool=_.find(this.poolDropAreas,function(poolItem){return!!poolItem.drag&&poolItem.drag.identifier==correct});pool&&!pool.copyOnDrag&&pool.drag.home.callViews("updateToThisDrag",[null])}return 0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();if(question){question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer();var correct=question.getCurrentCorrectDrag().identifier,pool=_.find(this.poolDropAreas,function(poolItem){return!!poolItem.drag&&poolItem.drag.identifier==correct});pool&&!pool.copyOnDrag&&pool.drag.home.callViews("updateToThisDrag",[null])}return this.hasCandidatesForValidation()||(this.state="answers"),question},disableDrags:function(){_.each(this.dragElements,function(dragItem){dragItem.disable()})},enableDrags:function(){_.each(this.dragElements,function(dragItem){dragItem.enable()})},setAnswer:function(){_.each(this.targetDropAreas,function(targetItem,index){!targetItem.isCorrectable()||this.isFreeDragLocation()&&!targetItem.drag||targetItem.setAnswer()},this),this.disableDrags()},setAnswerInput:function(){_.each(this.targetDropAreas,function(targetItem){!targetItem.isCorrectable()||this.isFreeDragLocation()&&!targetItem.drag||targetItem.setAnswerInput()},this)},showAnswer:function(){_.each(this.targetDropAreas,function(targetItem,index){if(targetItem.isCorrectable()){targetItem.showAnswer();var drag=targetItem.drag;if(drag&&drag.home.callViews("updateToThisDrag",[null]),!targetItem.isCorrect()){this.isDistractor(drag)&&drag.home.callViews("updateToThisDrag",[drag]);var correct=targetItem.getCorrect();correct&&targetItem.callViews("updateToThisDrag",[correct])}}},this),_.each(this.poolDropAreas,function(targetItem,index){var drag=targetItem.drag;!this.isDistractor(drag)&&drag?drag.home.callViews("updateToThisDrag",[null]):this.isDistractor(drag)&&drag.home.callViews("updateToThisDrag",[drag])},this),this.disableDrags()},tryAgain:function(){var poolDrags=[];if(this.hasStacks()){var drags=_.flatten(_(this.stackAreas).pluck("drags"));_(drags).each(function(drag){poolDrags.push(drag),drag.home.undrop(drag)})}else _(this.poolDropAreas).each(function(targetItem){targetItem.drag&&(poolDrags.push(targetItem.drag),targetItem.undrop())});_.each(poolDrags,function(drag,index){drag.home.drop(drag)}),_.each(this.targetDropAreas,function(targetItem,index){targetItem.isCorrectable()&&targetItem.tryAgain()}),this.enableDrags()},isDistractor:function(drag){return drag&&!this.mapAnswerToGap[drag.identifier]},getSelectedDragElement:function(){return _.filter(this.dragElements,function(drag){return drag.selected})},getDragByIdentifier:function(identifier){return _.find(this.dragElements,function(drag){return drag.identifier==identifier})},getDragByText:function(text){return _.find(this.dragElements,function(drag){return drag.identifier in this.mapAnswerToText&&this.mapAnswerToText[drag.identifier]===text},this)},getDragByID:function(id){return _.find(this.dragElements,function(drag){return drag.id===id})},store:function(){var targets=[];_.each(this.targetDropAreas,function(target,indx){targets.push(target.drag?target.drag.identifier:"")});var sources=_.map(this.poolDropAreas,function(target,indx){return target.resident.identifier}),stacks=_.map(this.stackAreas,function(stack){return _.map(stack.drags,function(drag){return drag.identifier})});return{targets:targets,sources:sources,stacks:stacks}},restore:function(params){this.poolDropAreas=_.sortBy(this.poolDropAreas,function(source){return _.indexOf(params.sources,source.resident.identifier)},this),_.each(params.stacks,function(stack,position){_.each(stack,function(dragID){var drag=this.getDragByIdentifier(dragID)||this.getDragByText(this.mapAnswerToText[dragID]);drag&&(drag.home.undrop(drag),this.stackAreas[position].drop(drag))},this)},this),_.each(params.targets,function(dragID,position){var drag=this.getDragByIdentifier(dragID)||this.getDragByText(this.mapAnswerToText[dragID]);drag&&(drag.copyOnDrag||drag.home.copyOnDrag||drag.home.undrop(drag),this.targetDropAreas[position].drop(drag))},this)}},a5.models.interaction.BaseModel.extend("a5.models.interaction.GapMatchInteraction"),a5.models.interaction.Gap={init:function(parameters,defaults){this._super(parameters,$.extend({group:!1,identifier:"",allowRepeat:!0,tryAgainKeep:!1,blockNumber:0,hasOrderedResponses:!1,hasOrderedResponsesFirstAnswer:!1,tryAgainIsFrozen:!1,inputStyle:null},defaults))},correct:function(){var correct=this.parent.mapGapToAnswer[this.identifier]||[];return correct=_(correct).filter(function(choice){return choice==="GT"+this.identifier||0===choice.indexOf("GT"+this.identifier+"_")},this),correct=_(correct).map(function(choice){return this.parent.mapAnswerToText[choice]},this)},value:function(){var value="";return this.drag&&(value=this.parent.mapAnswerToText[this.drag.identifier]),value},nextDrag:function(text){var drags=_.filter(this.parent.dragElements,function(drag){return!this.parent.isDistractor(drag)&&this._isValidNextDrag(drag,text)},this);_.isUndefined(this.parent.nextCorrectIndex[text])&&(this.parent.nextCorrectIndex[text]=0);var rt=drags[this.parent.nextCorrectIndex[text]];return this.parent.nextCorrectIndex[text]=(this.parent.nextCorrectIndex[text]+1)%drags.length,this.currentCorrectDrag=rt,rt},_isValidNextDrag:function(drag,text){var ret=!1;if(a5.utils.containsAnswer(this.parent.mapAnswerToText[drag.identifier],[text]))if(!drag.home||drag.home.copyOnDrag)ret=!0;else{var correctCount=this.parent.getNumberOfCorrectRepetitions(drag),alreadyUsedCount=_.filter(this.parent.targetDropAreas,function(dropArea){return dropArea.isCorrect()&&dropArea.drag.identifier===drag.identifier}).length;ret=alreadyUsedCount<correctCount}return ret},getCurrentCorrectDrag:function(){return this.currentCorrectDrag},isCorrect:function(){var items;return this.group&&this.hasOrderedResponses?this._isCorrectWithOrderDependencyGroups(this.parent.targetDropAreas):this.group&&!this.allowRepeat?(items=_(this.parent.targetDropAreas).filter(function(dropArea){return dropArea.blockNumber===this.blockNumber&&dropArea.group===this.group},this),this._isCorrectWithRepeatPrevent(items)):this.hasOrderedResponses?(items=_(this.parent.targetDropAreas).filter(function(dropArea){return dropArea.blockNumber===this.blockNumber},this),this._isCorrectWithOrderDependency(items)):this.allowRepeat?this._isCorrect():(items=_(this.parent.targetDropAreas).filter(function(dropArea){return dropArea.blockNumber===this.blockNumber},this),this._isCorrectWithRepeatPrevent(items))},_isCorrect:function(){return this.isFilled()&&a5.utils.containsAnswer(this.value(),this.correct(),this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},_isCorrectWithOrderDependency:function(items){return this.hasOrderedResponsesFirstAnswer?this._isCorrectWithOrderDependencyFirstAnswer(items):this._isCorrectWithOrderDependencyLongestCombination(items)},_isCorrectWithOrderDependencyLongestCombination:function(items){var possibleChoices=_(items).map(function(item){return item.correct()}),choices=_(items).map(function(item){return item.value()}),flipedChoices=_.unzip(possibleChoices);flipedChoices=_(flipedChoices).map(function(c){return _(c).chain().zip(choices).filter(function(d){return a5.utils.checkUserInput(d[1],d[0],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)}).value()},this);var elements=_(flipedChoices).max(_.size),position=_(flipedChoices).indexOf(elements);return a5.utils.checkUserInput(this.value(),this.correct()[position],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},_isCorrectWithOrderDependencyFirstAnswer:function(items){var firstAnswer=_(items).first(),position=firstAnswer.correct().indexOf(firstAnswer.value());return position>=0&&a5.utils.checkUserInput(this.value(),this.correct()[position],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},_isCorrectWithRepeatPrevent:function(items){var totalCorrectInAnswer=a5.utils.countAnswer(this.value(),this.correct(),this.ignoreCase,this.ignorePunctuation,this.ignoreAccents),totalCorrect=this.correct().length,checkUntilIndex=_(items).indexOf(this),correctAnswers=_(items).chain().first(checkUntilIndex+1).filter(function(item){return item._isCorrect()&&a5.utils.containsAnswer(this.value(),[item.value()],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},this).value();return this._isCorrect()&&(totalCorrectInAnswer===totalCorrect||correctAnswers.length<=totalCorrectInAnswer)},_isCorrectWithOrderDependencyGroups:function(items){var groups=_.chain(items).groupBy("group").omit(!1).value(),groupItems=groups[this.group],groupIsCorrect=_(groupItems).all(function(item){return item._isCorrectWithOrderDependency(groupItems,this.hasOrderedResponsesFirstAnswer)});groups=_(groups).omit(function(group,key){return _(group).some(function(item){return!item._isCorrectWithOrderDependency(group,this.hasOrderedResponsesFirstAnswer)})},this);var groupCorrectIndexes=_(groups).mapObject(function(group){var first=_(group).first();return a5.utils.indexOf(first.value(),first.correct(),this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},this),groupCorrectIndexesPairs=_(groupCorrectIndexes).pairs(),checkUntilIndex=_(groupCorrectIndexesPairs).findIndex(function(g){return _.first(g)===this.group},this),groupIsRepeat=_(groupCorrectIndexesPairs).chain().first(checkUntilIndex+1).some(function(g){return _.first(g)!==this.group&&_.last(g)===groupCorrectIndexes[this.group]},this).value();return groupIsCorrect&&!groupIsRepeat},getCorrect:function(){return this.isCorrect()?this.drag:this.nextDrag(this._findCorrect())},_findCorrect:function(){var items;return this.group&&this.hasOrderedResponses?this._getCorrectWithOrderDependencyGroups(this.parent.targetDropAreas):this.group&&!this.allowRepeat?(items=_(this.parent.targetDropAreas).filter(function(dropArea){return dropArea.blockNumber===this.blockNumber&&dropArea.group===this.group},this),this._getCorrectWithRepeatPrevent(items)):this.hasOrderedResponses?(items=_(this.parent.targetDropAreas).filter(function(dropArea){return dropArea.blockNumber===this.blockNumber},this),this._getCorrectWithOrderDependency(items,this.hasOrderedResponsesFirstAnswer)):this.allowRepeat?this._getCorrect():(items=_(this.parent.targetDropAreas).filter(function(item){return item.blockNumber===this.blockNumber},this),this._getCorrectWithRepeatPrevent(items))},_getCorrect:function(index){return this.correct().length>0&&this.correct()[index||0]||""},_getCorrectWithOrderDependency:function(items,firstAnswerMode){return firstAnswerMode?this._getCorrectWithOrderDependencyFirstAnswer(items):this._getCorrectWithOrderDependencyLongestCombination(items)},_getCorrectWithOrderDependencyLongestCombination:function(items){var possibleChoices=_(items).map(function(item){return item.correct()}),choices=_(items).map(function(item){return item.value()}),flipedChoices=_.unzip(possibleChoices);flipedChoices=_(flipedChoices).map(function(c){return _(c).chain().zip(choices).filter(function(d){return a5.utils.checkUserInput(d[1],d[0],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},this).value()},this);var elements=_(flipedChoices).max(_.size),position=_(flipedChoices).indexOf(elements);return this._getCorrect(position)},_getCorrectWithOrderDependencyFirstAnswer:function(items){var firstAnswer=_(items).first(),position=_.max([firstAnswer.correct().indexOf(firstAnswer.value()),0]);return this._getCorrect(position)},_getCorrectWithRepeatPrevent:function(items){var correct=this.correct().slice(0);return correct.length>1&&(items=_(items).without(this),_(items).each(function(item){var answer=item.isCorrect()?item.value():item.correctAnswer,correctIndex=a5.utils.indexOf(answer,correct,!0,item.ignorePunctuation,item.ignoreAccents);correctIndex>=0&&correct.splice(correctIndex,1)},this)),this.correctAnswer=_(correct).first()||_(this.correct()).first(),this.correctAnswer},_getCorrectWithOrderDependencyGroups:function(items){var groups=_(items).groupBy(function(g){return g.group}),correct=this.correct().slice(0);correct.length>1&&(items=_(groups).chain().mapObject(function(group){return _.first(group)}).values().value(),_(items).each(function(item){if(item.group!==this.group){var answer=item.isCorrect()?item.value():item.correctAnswer,itemCorrectIndex=a5.utils.indexOf(answer,item.correct(),!0,item.ignorePunctuation,item.ignoreAccents),correctIndex=a5.utils.indexOf(this.correct()[itemCorrectIndex],correct,!0,this.ignorePunctuation,this.ignoreAccents);correctIndex>=0&&correct.splice(correctIndex,1)}},this)),this.correctAnswer=this.correctAnswer||_(correct).first()||_(this.correct()).first();var index=a5.utils.indexOf(this.correctAnswer,this.correct(),this.ignoreCase,this.ignorePunctuation,this.ignoreAccents);return _(groups[this.group]).each(function(item){item.correctAnswer=item._getCorrect(index)}),this.correctAnswer},correctText:function(){return this.correct().join(", ")},wrongText:function(){return this.value()},getAnswerFeedback:function(model){return this.isCorrect()?this.processFeedback(this.correctFeedback)||model&&model.answerFeedback:this.processFeedback(this.incorrectFeedback)||model&&model.answerFeedback},wrongDrag:function(){return this.drag&&!this.isCorrect()&&this.isCorrectable()},setAnswer:function(){this._super(),this.isCorrectable()&&this.callViews("setAnswer")},showAnswer:function(){this._super(),this.isCorrectable()&&this.callViews("showAnswer")},showNextAnswer:function(){this.showAnswer(),this.isCorrectable()&&this.callViews("showNextAnswer")},tryAgain:function(){if(this._super(),this.isCorrectable())if(this.callViews("tryAgain"),this.isCorrect()||this.tryAgainKeep)this.callViews("updateToThisDrag",[this.drag]);else{var drag=this.drag;this.undrop(),drag&&drag.home.drop(drag)}},getScores:function(){var score=new a5.Score;return this.isCorrectable()&&(score.incTotal(),this.isCorrect()&&score.incCorrect(),null!=this.drag&&score.incFilled()),score},isCorrectable:function(){return!this.isDistractor()&&!this.prefilled},isScorable:function(){return this.isCorrectable()},isDistractor:function(){return _.isEmpty(this.correct())}},a5.models.interaction.DropArea.extend("a5.models.interaction.Gap"),a5.models.interaction.OMTextGapSpaceGap={isCorrect:function(){return!1},getCorrect:function(){return null},isCorrectable:function(){return!!this.drag},isScorable:function(){return!1},isDistractor:function(){return!1}},a5.models.interaction.Gap.extend("a5.models.interaction.OMTextGapSpaceGap"),a5.models.interaction.GraphicGapMatchInteraction={setImageSize:function(size){size&&size.width&&size.height&&(this.originalSize=size)}},a5.models.interaction.GapMatchInteraction.extend("a5.models.interaction.GraphicGapMatchInteraction"),a5.models.interaction.OMPairsInteraction={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({behaviour:"drop",interactionIndex:null,responses:[],gaps:[],poolAlignment:"",pairAlignment:""},defaults))},isDrag:function(){return"drag"===this.behaviour},isTapItem:function(){return"tap_item"===this.behaviour},isTapTarget:function(){return"tap_target"===this.behaviour},addGaps:function(gaps){this.gaps=this.gaps.concat(gaps)},addResponses:function(responses){this.responses=this.responses.concat(responses)},isFilled:function(){return _.some(this.gaps,function(gap){return gap.isFilled()})},getScores:function(){var score=new a5.Score;return _.each(this.gaps,function(gap){gap.isPrefilled()||(score.incTotal(),gap.isCorrect()&&score.incCorrect(),gap.isFilled()&&score.incFilled())}),score},store:function(){return _.pluck(this.gaps,"value")},restore:function(data){_.each(this.gaps,function(gap,index){gap.updateValue({identifier:data[index]}),gap.setState("input")},this)},setAnswer:function(){this._super(),_.invoke(this.responses,"setAnswer"),_.invoke(this.gaps,"setAnswer")},tryAgain:function(){this._super(),_.invoke(this.responses,"tryAgain"),_.invoke(this.gaps,"tryAgain")},showAnswer:function(){this._super(),_.invoke(this.responses,"showAnswer"),_.invoke(this.gaps,"showAnswer")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OMPairsInteraction"),a5.models.interaction.OMPairsGap={init:function(parameters,defaults){this._super(parameters,$.extend({identifier:"",correctResponse:null,content:"",value:null,prefilled:!1,enumeration:"",tryAgainBehaviour:{},dropIndicator:!1,gaptextaudio:!1},defaults))},updateValue:function(response){this.value=response?response.identifier:null,a5.mainBuilder.updateScoresAsync()},isCorrect:function(){return this.value===this.correctResponse},isFilled:function(){return Boolean(this.value)},isPrefilled:function(){return this.prefilled},tryAgain:function(){this.keepAnswer()||(this.value=null),this._super()},keepAnswer:function(){return"correct"===this.tryAgainBehaviour.keep?this.isCorrect():"all"===this.tryAgainBehaviour.keep},lockAnswer:function(){return this.tryAgainBehaviour.lock}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OMPairsGap"),a5.models.interaction.OMPairsResponse={init:function(parameters,defaults){this._super(parameters,$.extend({identifier:"",correctGap:null,content:"",isCorrect:!1,prefilled:!1,gaptextaudio:!1},defaults))},isDistractor:function(){return Boolean(this.correctGap)},isPrefilled:function(){return this.prefilled},isInPool:function(){return!_.contains(_.pluck(this.parent.gaps,"value"),this.identifier)},isInGap:function(){return!this.isInPool()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OMPairsResponse"),a5.models.interaction.OMPairsModel={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({},defaults)),this.interaction=interaction,this.items={},this.badAnswers={},this.goodAnswers={},this.prefilled=[]},draggedItem:function(drag,target){var self=this;_.each(this.items,function(v,k){_.include(v,drag)&&(self.items[k]=_.without(self.items[k],drag))}),_.isUndefined(target)||(_.isUndefined(self.items[target])&&(self.items[target]=[]),this.items[target].push(drag)),a5.mainBuilder.updateScoresAsync()},removeItem:function(item){var self=this;_.each(this.items,function(v,k){self.items[k]=_.without(self.items[k],item)}),a5.mainBuilder.updateScoresAsync()},addPrefill:function(id){this.prefilled.push(id)},isFilled:function(){_.some(this.items,function(v,k){return v.length>0})},getScores:function(){var score=new a5.Score,self=this;return _.each(self.targetPools,function(v,k){_.each(v,function(item){_.include(self.prefilled,item)||(score.incTotal(),self.items[k]&&_.include(self.items[k],item)&&score.incCorrect())})}),_.each(self.items,function(v,k){_.each(v,function(item){_.include(self.prefilled,item)||score.incFilled()})}),score.numberOfCorrectItems<0&&(score.numberOfCorrectItems=0),score},setAnswer:function(){this._updateAnswers(),this.callViews("setAnswer")},tryAgain:function(){this.callViews("tryAgain")},showAnswer:function(){this._updateAnswers(),this.callViews("showAnswer")},_updateAnswers:function(){this.goodAnswers={},this.badAnswers={},_.each(this.targetPools,function(v,k){_.each(v,function(item){this.items[k]&&_.include(this.items[k],item)?this.goodAnswers[item]=k:this.badAnswers[item]=k},this)},this);try{var expected_items=_.flatten(_.values(this.targetPools));_.each(this.items,function(v,k){_.each(v,function(item){_.include(expected_items,item)||(this.badAnswers[item]=k)},this)},this)}catch(e){}},store:function(){return{items:this.items,badAnswers:this.badAnswers,goodAnswers:this.goodAnswers,prefilled:this.prefilled}},restore:function(hash){hash.items&&(this.items=hash.items),hash.badAnswers&&(this.badAnswers=hash.badAnswers),hash.goodAnswers&&(this.goodAnswers=hash.goodAnswers),
hash.prefilled&&(this.prefilled=hash.prefilled),this.callViews("updateState")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OMPairsModel"),a5.models.interaction.ICTextGapLabelAnObjectBlock={init:function(parameters,defaults){this._super(parameters,$.extend({poolAlignment:"none",poolWords:[],tts_audio:!1},defaults)),this.gaps=[]},add:function(gap){this.gaps.push(gap)},setImageSize:function(size){this.originalSize=size}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapLabelAnObjectBlock"),a5.models.interaction.ICTextGapLabelAnObject={init:function(parameters,defaults){this._super(parameters,$.extend({correct:[],display_words:[],distractors:[],position:null,prefilled:!1,enumeration:"",identifier:null,ignorePunctuation:!1,tryAgainKeep:!1,ignoreCase:!1,ignoreAccents:!1,resizeGaps:!1,charactersNumber:!1,tryAgainIsFrozen:!1,inputStyle:null},defaults)),this.value=this.prefilled?this.correct[0]:""},setValue:function(value){value!=this.value&&(this.value=value,this.trigger("update-value"),a5.mainBuilder.updateScoresAsync())},_replaceSyntax:function(correct){return correct.replace("%0"," ")},getFirstCorrect:function(){var correct;return correct=this.isCorrect()?this.value:this._findCorrect(),this._replaceSyntax(correct)},_findCorrect:function(){return this.correct[0]},getCorrectCharactersLength:function(){return this.getFirstCorrect().replace(/\s/g,"").length},getMaskPattern:function(){var correct=this.getFirstCorrect();return correct?correct.replace(/\S/g,"*"):"*"},isCorrect:function(){return a5.utils.containsAnswer(this.value,this.correct,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},isFilled:function(){return this.value.trim().length>0},getScores:function(){var score=new a5.Score;return this.prefilled?score:(score.incTotal(),this.isCorrect()&&score.incCorrect(),this.isFilled()&&score.incFilled(),score)},setAnswer:function(){this._super(),this.prefilled||this.callViews("setAnswer")},showAnswer:function(){this._super(),this.prefilled||this.callViews("showAnswer")},showNextAnswer:function(){this.showAnswer(),this.prefilled||this.callViews("showNextAnswer")},tryAgain:function(){this._super(),this.prefilled||(this.tryAgainKeep||this.isCorrect()||(this.value=""),this.callViews("tryAgain"))},store:function(){return this.value},restore:function(params){this.setValue(params)}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapLabelAnObject"),a5.model.interaction.IMWordsearch={directions:[new Vec2(0,-1),new Vec2(1,-1),new Vec2(1,0),new Vec2(1,1),new Vec2(0,1),new Vec2(-1,1),new Vec2(-1,0),new Vec2(-1,-1)],init:function(parameters,defaults){this._super(parameters,$.extend({width:10,height:10,hasPrefill:!1,tryAgainKeep:!1},defaults)),this.cells=new Array(this.width*this.height),this.words=[],this.markings=[]},addWord:function(params){this.words.push(new a5.model.interaction.IMWordsearchWord($.extend({parent:this},params)))},addMarking:function(marking){this.markings.push(new a5.model.interaction.IMWordsearchMarking({start:marking[0],end:marking[1],parent:this})),a5.mainBuilder.updateScoresAsync()},removeMarkingsAt:function(position){this.markings=_.filter(this.markings,function(marking){return!marking.contains(position)}),a5.mainBuilder.updateScoresAsync()},getMarkingsAt:function(position){return _.filter(this.markings,function(marking){return marking.contains(position)})},initState:function(){var self=this;_.each(this.words,function(word,index){for(var start=word.start,c=0;c<word.word.length;c++){var cell=self.getCell(start);cell||(cell=new a5.model.interaction.IMWordsearchCell({position:start,letter:word.word.substr(c,1)}),cell.id=[self.id,start.y*self.width+start.x].join(""),self.setCell(start,cell)),self.hasPrefill&&0==index&&(cell.prefilled=!0),start=start.addV(a5.model.interaction.IMWordsearch.prototype.directions[word.direction])}});for(var y=0;y<this.height;y++)for(var x=0;x<this.width;x++){var pos=new Vec2(x,y),cell=this.getCell(pos);cell||(cell=new a5.model.interaction.IMWordsearchCell({position:pos,letter:String.fromCharCode(97+Math.floor(26*Math.random()))}),cell.id=[this.id,pos.y*this.width+pos.x].join(""),this.setCell(pos,cell))}this.hasPrefill&&(this.words=_.rest(this.words))},getCell:function(position){return this.cells[position.y*this.width+position.x]},setCell:function(position,cell){this.cells[position.y*this.width+position.x]=cell},store:function(){var data=[];return _.each(this.markings,function(marking){data.push(marking.asList())}),data},restore:function(data){var scope=this;_.each(data,function(marking){var mark=_.map(marking,function(mark){return new Vec2(mark.x,mark.y)});scope.addMarking(mark)}),this.setState("input")},isCorrect:function(){return _.every(this.words,function(word){return word.isCorrect()})},isFilled:function(){return this.markings.length>0},getCandidatesForSolutionHint:function(){return _.filter(this.words,function(item){return"answers"!==item.state&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.words,function(item){return"answers"!==item.state&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForValidation:function(){return _.filter(this.words,function(item){return"answers"!==item.state&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),this.hasCandidatesForValidation()||(this.state="answers"),question},getScores:function(){var score=new a5.Score;return _.each(this.words,function(word){word.isPrefilled()||(score.incTotal(),score.incCorrect(word.isCorrect()))}),score.filled=this.markings.length,score.filled>score.total&&(score.filled=score.total),score},tryAgain:function(){this.tryAgainKeep||(this.markings=_.filter(this.markings,function(marking){return marking.isCorrect()})),this._super()}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMWordsearch"),a5.model.interaction.IMWordsearchWord={init:function(parameters,defaults){this._super(parameters,$.extend({word:"empty",start:new Vec2(0,0),direction:0},defaults)),this.word=this.word.toLowerCase();var diff=a5.model.interaction.IMWordsearch.prototype.directions[this.direction].mulS(this.word.length-1);this.end=this.start.addV(diff)},isPrefilled:function(){return!1},asList:function(){return[this.start,this.end]},isCorrect:function(){return _.any(this.parent.markings,function(m){return this.matches(m)},this)},matches:function(marking){return this.start.equals(marking.start)&&this.end.equals(marking.end)||this.start.equals(marking.end)&&this.end.equals(marking.start)},showNextAnswer:function(){this.state="answers",this.parent.trigger("show-next",this)}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMWordsearchWord"),a5.model.interaction.IMWordsearchCell={init:function(parameters,defaults){this._super(parameters,$.extend({letter:"x",position:new Vec2(0,0),prefilled:!1},defaults))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMWordsearchCell"),a5.model.interaction.IMWordsearchMarking={init:function(parameters,defaults){this._super(parameters,$.extend({start:null,end:null},defaults))},asList:function(){return[this.start,this.end]},isCorrect:function(){var self=this;return _.any(this.parent.words,function(word){return word.matches(self)})},contains:function(position){var start=this.start,step=this.end.subV(this.start),length=Math.max(Math.abs(step.x),Math.abs(step.y));step.normalize();for(var cnt=0;cnt<=length;cnt++){if(start.equals(position))return!0;start=start.addV(step),start.round()}},matches:function(marking){return this.start.equals(marking.start)&&this.end.equals(marking.end)||this.start.equals(marking.end)&&this.end.equals(marking.start)}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMWordsearchMarking"),a5.models.interaction.LLModel={init:function(parameters,defaults){this._super(parameters,$.extend({sets:2,displayInRows:!1,tryAgainKeep:!1,tryAgainIsFrozen:!1,answers:{},behaviourIsTouch:!1,headings:[]},defaults)),this.elements=[],this.lines=[],this.prevAnswers=[],this.prefilledLines=[],this.enumSets={},this.state="input",this.wrongHighlighted=null},setWrongHighlighted:function(wh){this.wrongHighlighted=wh,this.callViews("repaintCanvas")},getWrongAsLines:function(){for(var first=this.getFirst(this.wrongHighlighted),lines=[];this.getLinked(first);){var next=this.getLinked(first);lines.push([first,next]),first=next}return lines},correctModels:function(){var lines=[],self=this;return _.each(this.answers,function(vals,key){var start=self.getById(key);_.each(vals,function(v){var end=self.getById(v);lines.push([start,end]),start=end})}),lines},setPrefill:function(){var self=this,current=this.elements[0],correct=this.answers[current.identifier];current.prefilled=!0,_.each(correct,function(e2){self.prefilledLines.push([current,self.getById(e2)]),current=self.getById(e2),current.prefilled=!0})},getById:function(id){for(var cnt=0;cnt<this.elements.length;cnt++)if(this.elements[cnt].identifier==id)return this.elements[cnt]},clear:function(element,isEnd){this.lines=_.filter(this.lines,function(e){return isEnd?(e[0]==element&&this.callViews("removeLinkClasses",[e[0],e[1]]),e[0]!=element):(e[1]==element&&this.callViews("removeLinkClasses",[e[0],e[1]]),e[1]!=element)},this),a5.mainBuilder.updateScoresAsync()},lineIsValid:function(input,output){var from=input[0],to=input[1];if(null===from||null===to)return!1;if(to.prefilled)return!1;var fi=this.elements.indexOf(from),ti=this.elements.indexOf(to);if(fi>ti){var t=fi;fi=ti,ti=t,from=input[1],to=input[0]}var fu=Math.floor(fi/(this.elements.length/this.sets));return Math.floor(ti/(this.elements.length/this.sets))-fu==1&&(output.push(from,to),!0)},addLine:function(from,to){var line=[];return!!this.lineIsValid([from,to],line)&&(this.filterLines(line[0],line[1]),this.lines.push(line),this.callViews("repaintCanvas"),a5.mainBuilder.updateScoresAsync(),!0)},filterLines:function(from,to){this.lines=_.filter(this.lines,function(e){return e[0]!=from&&e[1]!=to||this.callViews("removeLinkClasses",[e[0],e[1]]),!(e[0]==from||e[1]==to)},this),a5.mainBuilder.updateScoresAsync()},shuffleAll:function(){this.elements=_.chain(this.sets).range().map(function(set,index){return this.getElementsBySet(set,!0)},this).flatten().value()},shuffleRest:function(){this.elements=_.chain(this.sets).range().map(function(set,index){return this.getElementsBySet(set,index>0)},this).flatten().value()},getElementsBySet:function(set,shuffle){var ipc=this.elements.length/this.sets,elements=this.elements.slice(set*ipc,(set+1)*ipc);return shuffle&&(elements=_.shuffle(elements)),elements},getLinked:function(current,lines){lines=lines||this.lines;for(var cnt=0;cnt<lines.length;cnt++){var e=lines[cnt];if(e[0]===current)return e[1]}},getPrevLinked:function(current){for(var cnt=0;cnt<this.lines.length;cnt++){var e=this.lines[cnt];if(e[1]===current)return e[0]}},getFirst:function(element){for(;this.getPrevLinked(element);)element=this.getPrevLinked(element);return element},isCorrect:function(element){if(_.isUndefined(element))return this.isAllCorrect();element=this.getFirst(element);var self=this,correct=this.answers[element.identifier],isCorrect=!0;if(void 0===correct)return!1;var current=element;return _.each(correct,function(e2){(current=self.getLinked(current))&&current.identifier==e2||(isCorrect=!1)}),isCorrect},isAllCorrect:function(){var elements=_.filter(this.elements,function(el){return!el.prefilled});return _.every(elements,function(element){return this.isCorrect(element)},this)},isFilled:function(){return _.some(this.elements,function(element){return this.isLinked(element)},this)},isLinked:function(element){element=this.getFirst(element);for(var c=element,number=0;c;)c=this.getLinked(c),number+=1;return number==this.sets},getScores:function(){for(var score=new a5.Score,cnt=0;cnt<this.elements.length/this.sets;cnt++)if(!this.elements[cnt].prefilled){score.incTotal();var correct=this.isCorrect(this.elements[cnt]);correct&&score.incCorrect(),this.isLinked(this.elements[cnt])&&score.incFilled()}return score},store:function(){var self=this,data=[];return _.each(this.elements,function(element){var left=self.getPrevLinked(element);left&&(left=left.identifier);var right=self.getLinked(element);right&&(right=right.identifier),(left||right)&&data.push({id:element.identifier,left:left,right:right})}),data},restore:function(data){var self=this;_.each(data,function(element){var el=self.getById(element.id);element.left&&self.addLine(el,self.getById(element.left)),element.right&&self.addLine(el,self.getById(element.right))})},setAnswer:function(){_.invoke(this.elements,"setAnswer"),this.tryAgainIsFrozen&&a5.dp.config.linkingLinesPreserveColorAfterCorrect&&_.each(this.lines,function(line){this._setLineChecked(line)},this);for(var cnt=0;cnt<this.elements.length;cnt++){!(this.elements.length-cnt<=this.elements.length/this.sets)||a5.dp.config.linkingSelectionAreaEnabled&&!this.elements[cnt].isFilled()?this.elements[cnt].callViews("setFeedbackState"):this.elements[cnt].callViews("setAnswer")}this.setState("feedback")},showAnswer:function(){_.invoke(this.elements,"showAnswer");for(var cnt=0;cnt<this.elements.length;cnt++){!(this.elements.length-cnt<=this.elements.length/this.sets)||a5.dp.config.linkingSelectionAreaEnabled&&!this.elements[cnt].isFilled()?this.elements[cnt].callViews("setFeedbackState"):(this.elements[cnt].callViews("removeAnswer"),this.elements[cnt].callViews("showAnswer"))}this.setState("answers")},getCandidatesForSolutionHint:function(){return _.filter(this.elements,function(item){return"answers"!==item.state&&-1===item.position&&!item.isFilled()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.elements,function(item){return"answers"!==item.state&&-1===item.position&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForValidation:function(){return _.filter(this.elements,function(item){return"answers"!==item.state&&-1===item.position&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();if(question){question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer();for(var correct=this.correctModels(),element=question;element;){var path=_.find(correct,function(model){return!_.contains(this.lines,model)&&!_.contains(this.prevAnswers,model)&&_.contains(_.pluck(model,"identifier"),element.identifier)},this);path&&(this.filterLines(path[0],path[1]),this.prevAnswers.push(path));var linked=this.getLinked(element,this.prevAnswers);linked&&(linked.showNextAnswer?linked.showNextAnswer():linked.showAnswer&&linked.showAnswer()),element=linked}this.trigger("show_next")}return 0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();if(question){question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer();for(var correct=this.correctModels(),element=question;element;){var path=_.find(correct,function(model){return!_.contains(this.lines,model)&&!_.contains(this.prevAnswers,model)&&_.contains(_.pluck(model,"identifier"),element.identifier)},this);path&&(this.filterLines(path[0],path[1]),this.prevAnswers.push(path));var linked=this.getLinked(element,this.prevAnswers);linked&&(linked.showSolutionHint?linked.showSolutionHint():linked.showNextAnswer?linked.showNextAnswer():linked.showAnswer&&linked.showAnswer()),element=linked}this.trigger("show_next")}return this.hasCandidatesForValidation()||(this.state="answers"),question},tryAgain:function(){_.invoke(this.elements,"tryAgain");var self=this;this.tryAgainKeep||(this.lines=_.filter(this.lines,function(line){return self.isCorrect(line[0])}));for(var cnt=0;cnt<this.elements.length;cnt++){this.elements.length-cnt<=this.elements.length/this.sets?this.elements[cnt].callViews("removeAnswer"):this.elements[cnt].callViews("setFeedbackState")}this.setState("input")},_setLineChecked:function(line){line.checked=!0}},a5.models.interaction.BaseModel.extend("a5.models.interaction.LLModel"),a5.models.interaction.LLElementModel={init:function(parameters,defaults){this._super(parameters,$.extend({content:null,position:0,identifier:null,prefilled:!1,tts_audio:!1,tryAgainIsFrozen:!1},defaults))},isCorrect:function(){return this.parent.isCorrect(this)},isFilled:function(){return this.parent.isLinked(this)},showNextAnswer:function(){this.showAnswer(),this.callViews("removeAnswer"),this.callViews("showAnswer")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.LLElementModel"),a5.models.interaction.LinkingMultipleLines={init:function(parameters,defaults){this._super(parameters,$.extend({answers:[],tryAgainKeep:!1,tryAgainIsFrozen:!1,behaviourIsTouch:!1,displayInRows:!1},defaults)),this._prevAnswers=[],this.answers=new a5.models.interaction.LinkingMultipleLinesCollection(this.answers),this.lines=new a5.models.interaction.LinkingMultipleLinesCollection,this.prefilledLines=new a5.models.interaction.LinkingMultipleLinesCollection,this.state="input"},prefillFirstLine:function(){this.prefilledLines.append(this.answers.children[0])},prefillFirstItem:function(){var from=this.answers.children[0].from;this.answers.each(function(line){from==line.from&&this.prefilledLines.append(line)},this)},addLine:function(from,to){var line=new a5.models.interaction.LinkingMultipleLinesLine(from,to),allLines=this.prefilledLines.concat(this.lines);allLines.include(line)||allLines.countFrom(from)>=this.answers.countFrom(from)||this.lines.append(line)},getScores:function(){var score=new a5.Score;return score.total=this.answers.size()-this.prefilledLines.size(),score.filled=this.lines.size(),this.lines.each(function(line){this.answers.include(line)&&score.incCorrect()},this),score},isCorrect:function(){return _.filter(this.lines,function(line){return this.answers.include(line)},this).length==this.answers.size()},isFilled:function(){return this.lines.size()>0},getCandidatesForSolutionHint:function(){var items=_.difference(this.answers.children,this._prevAnswers);return _.filter(items,function(item){return"answers"!==item.state&&!this.lines.include(item)&&!this.prefilledLines.include(item)},this)},getCandidatesForShowNextAnswer:function(){var items=_.difference(this.answers.children,this._prevAnswers);return _.filter(items,function(item){return"answers"!==item.state&&!this.lines.include(item)&&!this.prefilledLines.include(item)},this)},getCandidatesForValidation:function(){var items=_.difference(this.answers.children,this._prevAnswers);return _.filter(items,function(item){return"answers"!==item.state&&!this.prefilledLines.include(item)},this)},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer(),this._prevAnswers.push(question),this.trigger("next_answer")),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer(),this._prevAnswers.push(question),question.revealedBySolutionHint=!0,this.trigger("next_answer")),this.hasCandidatesForValidation()||(this.state="answers"),question},clearSolutionHint:function(){this._prevAnswers=_.reject(this._prevAnswers,function(question){return question.revealedBySolutionHint},this)},store:function(){var data=[];return this.lines.each(function(line){data.push([line.from,line.to])},this),data},restore:function(data){_.each(data,function(line){this.addLine(line[0],line[1])},this)},setAnswer:function(){this.tryAgainIsFrozen&&a5.dp.config.linkingMultipleLinesPreserveColorAfterCorrect&&this.lines.setChecked(),this._super()},tryAgain:function(){this.tryAgainKeep||(this.lines.children=_.select(this.lines.children,function(line){return this.answers.include(line)},this)),this._super()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.LinkingMultipleLines"),a5.models.interaction.LinkingMultipleLinesCollection={init:function(children){this.children=[],_.each(children,function(line){this.add(line[0],line[1])},this)},add:function(from,to){return this.append(new a5.models.interaction.LinkingMultipleLinesLine(from,to))},append:function(line){this.children.push(line),a5.mainBuilder.updateScoresAsync()},size:function(){return this.children.length},countFrom:function(id){return _.select(this.children,function(line){return id==line.from}).length},setChecked:function(){this.each(function(line){line.setChecked()})},include:function(line){return!!_.find(this.children,function(child){return child.eql(line)})},remove:function(line){this.children=_.without(this.children,line),a5.mainBuilder.updateScoresAsync()},clear:function(fromto){this.children=_.reject(this.children,function(line){return fromto===line.from||fromto===line.to}),a5.mainBuilder.updateScoresAsync()},each:function(callback,context){_.each(this.children,callback,context)},concat:function(lines){var result=new a5.models.interaction.LinkingMultipleLinesCollection;return this.each(function(child){result.append(child)}),lines.each(function(child){result.append(child)}),result},union:function(lines){var result=new a5.models.interaction.LinkingMultipleLinesCollection;return this.each(function(child){result.append(child)}),lines.each(function(child){result.include(child)||result.append(child)}),result}},Obj.extend("a5.models.interaction.LinkingMultipleLinesCollection"),a5.models.interaction.LinkingMultipleLinesLine={init:function(from,to){this.from=from,this.to=to},eql:function(other){return this.from==other.from&&this.to==other.to},setChecked:function(){this.checked=!0}},Obj.extend("a5.models.interaction.LinkingMultipleLinesLine"),a5.models.interaction.ShuffleModel={init:function(parameters,defaults){this._super(parameters,$.extend({correct:[],alignment:"horizontal",tryAgainIsFrozen:!1,interaction:null},defaults)),this.elements=[],this.actionsDone=0},push:function(element){this.elements.push(element)},shuffle:function(iter){var indexes=[];_.each(this.elements,function(e,index){e.fixed||indexes.push(index)},this),this.elements=_.map(this.elements,function(e){if(e.fixed)return e;var i=Math.floor(Math.random()*indexes.length);return this.elements[indexes.splice(i,1)[0]]},this),this.isCorrect()&&(_.isUndefined(iter)&&(iter=0),iter<10&&this.shuffle(++iter))},isCorrect:function(){var self=this,correct=!0;return _.each(this.elements,function(e,index){_.include(self.correct[index],e.identifier)||(correct=!1)}),correct},isCorrectable:function(){return _.some(this.elements,function(e){return!e.fixed})},isFilled:function(){return this.actionsDone>0},store:function(){return _.map(this.elements,function(e){return e.identifier})},restore:function(data){if(data){var self=this;_.each(data,function(id,i){var needle=_.find(self.elements,function(el){return el.identifier==id}),from=_.indexOf(self.elements,needle);self.moveTo(from,i)})}},getScores:function(){var score=new a5.Score;return _.each(this.elements,function(e,i){e.fixed||(score.incTotal(),_.include(this.correct[i],e.identifier)&&score.incCorrect(),this.actionsDone>0&&score.incFilled())},this),score},useSwap:function(){var i,fixedPositions=[];for(_.each(this.elements,function(e,i){e.fixed&&fixedPositions.push(i)}),i=0;i<this.elements.length&&fixedPositions[0]==i;i++)fixedPositions.shift();for(i=this.elements.length-1;i>=0&&fixedPositions[fixedPositions.length-1]==i;i--)fixedPositions.pop();return fixedPositions.length>0},moveTo:function(oldPos,newPos){a5.utils.array.move(this.elements,oldPos,newPos),this.registerAction()},swap:function(oldPos,newPos){a5.utils.array.swap(this.elements,oldPos,newPos),this.trigger("swapped",{from:this.elements[oldPos],to:this.elements[newPos]}),this.registerAction(!0)},getCandidatesForSolutionHint:function(){return _.filter(this.availableElements||this.elements.slice(0),function(item){return!("answers"===item.state||item.fixed||item.isFilled()||item.prefill||item.prefilled)})},getCandidatesForShowNextAnswer:function(){return _.filter(this.availableElements||this.elements.slice(0),function(item){return!("answers"===item.state||item.fixed||item.isCorrect()||item.prefill||item.prefilled)})},getCandidatesForValidation:function(){return _.filter(this.availableElements||this.elements.slice(0),function(item){return"answers"!==item.state&&!item.fixed&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){this.availableElements=this.elements.slice(0);var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),items.length<=1&&(!this.hasCandidatesForShowNextAnswer()||this._isOrderedCorrectly())&&(this.state="answers"),this.trigger("next_answer"),question},showSolutionHint:function(){this.availableElements=this.elements.slice(0);var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),items.length<=1&&(!this.hasCandidatesForValidation()||this._isOrderedCorrectly())&&(this.state="answers"),this.trigger("next_answer"),question},_isOrderedCorrectly:function(){var current=_.map(this.elements,function(e){return e.getCurrentIdentifier()});return _.isEqual(current,_.flatten(this.correct))},insert:function(elem,to,movableElements){movableElements.splice(to,0,elem),this.elements=_.map(this.elements,function(e){var view=_.find(e.views());return e.fixed||this.tryAgainIsFrozen&&view.node.hasClass("checked-correct-locked")?e:movableElements.shift()},this),this.registerAction()},registerAction:function(isSwap){this.trigger("update-element-order",isSwap),this.actionsDone+=1,a5.mainBuilder.updateScoresAsync()},setAnswer:function(){this._super(),_.invoke(this.elements,"setAnswer")},setAnswerInput:function(){this._super(),_.invoke(this.elements,"setAnswerInput")},showAnswer:function(){this._super(),this.availableElements=this.elements.slice(0),_.invoke(this.elements,"showAnswer")},tryAgain:function(){this._super(),_.invoke(this.elements,"tryAgain")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ShuffleModel"),a5.models.interaction.ShuffleElement={init:function(parameters,defaults){this._super(parameters,$.extend({text:"text",identifier:null,fixed:!1,alignment:"horizontal",content:null,tryAgainIsFrozen:!1},defaults))},index:function(){return _.indexOf(this.parent.elements,this)},getCorrect:function(){var correct=this.parent.correct[this.index()],element=_.find(this.parent.availableElements,function(e){return!e.fixed&&!e.isCorrect()&&_.include(correct,e.identifier)});return this.parent.availableElements=_.without(this.parent.availableElements,element),element},isCorrect:function(){return _.include(this.parent.correct[this.index()],this.identifier)},wrongText:function(){return this.text},correctText:function(){return this.getCorrect().text},setCurrentIdentifier:function(identifier){this._currentIdentifier=identifier},getCurrentIdentifier:function(){return this._currentIdentifier||this.identifier}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ShuffleElement"),a5.models.interaction.OSBoxDropModel={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({choices:!1,targets:!1,response:!1,current_choice:null,current_category:null,stopped:!1,current_category_index:0,category_move_timeout:2500,direction:1},defaults)),this.tryAgainIsFrozen=interaction.options.tryAgainIsFrozen(),this.interaction=interaction,this.choices=_.map(this.choices,function(choice){var $choice=$(choice);return new a5.models.interaction.OSBoxDropModelChoice({choice_id:$choice.attr("id"),identifier:$choice.attr("identifier"),correctTargetIdentifier:this.response[$choice.attr("identifier")],matchMax:$choice.attr("matchMax"),contents:this._serializeToString($choice),parent:this})},this),this.targets=_.map(this.targets,function(target,index){var $target=$(target);return new a5.models.interaction.OSBoxDropModelTarget({target_id:$target.attr("id"),identifier:$target.attr("identifier"),matchMax:$target.attr("matchMax"),contents:this._serializeToString($target),index:index,parent:this})},this),this.all_choices=_.clone(this.choices),_.each(this.all_choices,function(choice){var correct=_.find(this.targets,function(target){var match=target.identifier==choice.correctTargetIdentifier;return match&&target.correctChoices.push(choice),match});choice.correctTargetModel=correct},this),interaction.bind("show",_.bind(function(){this.setCurrentCategory(0),this.startCategoriesMovement()},this)),interaction.bind("hide",_.bind(function(){this.stopCategoriesMovement()},this))},_serializeToString:function(node){var xml=a5.utils.serializeXML(node[0]);return xml=this._wrapIntoCDATA(xml),$($.parseXML(xml)).find("simpleAssociableChoice").text()},_wrapIntoCDATA:function(xml){var ret=xml;return ret=ret.replace(/(<simpleAssociableChoice [^>]*>)/gi,"$1<![CDATA["),ret=ret.replace(/(<\/simpleAssociableChoice>)/gi,"]]>$1")},setState:function(newState){_.invoke(this.targets,"setState",newState),this._super(newState)},showAnswer:function(){this._super(),this.stopCategoriesMovement();var pos=a5.dp.config.boxdropAnswersPosition;_.isNumber(pos)&&this.setCurrentCategory(pos)},setAnswer:function(){this._super(),this.stopCategoriesMovement();var pos=a5.dp.config.boxdropAnswersPosition;_.isNumber(pos)&&this.setCurrentCategory(pos)},tryAgain:function(){this.interaction.options.tryAgainIsClear()?this._clearAll():this._clearWrong(),this.startCategoriesMovement(),this._super()},setCurrentCategory:function(index){this.targets[index]&&(this.current_category=this.targets[index],this.current_category_index=index,this.trigger("change:category",index))},startCategoriesMovement:function(){this.stopped=!1,_.isUndefined(this._first_time)&&(this._first_time=!0),this._movement=setInterval(_.bind(this._movementTick,this),this.category_move_timeout)},
_movementTick:function(){var category_max=this.targets.length-1,current=this.current_category_index;(current==category_max||0==current&&!this._first_time)&&(this._first_time=!1,this.direction=-this.direction),this.setCurrentCategory(this.current_category_index+this.direction)},stopCategoriesMovement:function(){this.stopped=!0,clearInterval(this._movement)},dropChoice:function(){if("input"==this.state){var choice=this.choices.shift();choice&&this.current_category.appendChoice(choice)}},getScores:function(){var score=new a5.Score;return _.each(this.all_choices,function(choice){score.incTotal(),choice.isCorrect()&&score.incCorrect(),choice.current_target&&score.incFilled()}),score},isFilled:function(){return _.some(this.targets,function(target){return target.isFilled()})},_clearAll:function(){_.invoke(this.targets,"clearAll")},_clearWrong:function(){_.invoke(this.targets,"clearWrong")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSBoxDropModel"),a5.models.interaction.OSBoxDropModelChoice={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({contents:"",choice_id:"",identifier:"",correctTargetIdentifier:"",matchMax:""},defaults)),this.tryAgainIsFrozen=this.parent.tryAgainIsFrozen,this.current_target=null},dropTo:function(target){this.current_target=target,this.trigger("dropped",target)},undrop:function(){this.current_target=null,this.trigger("undropped",this.parent)},isCorrect:function(){return!!this.current_target&&this.correctTargetIdentifier===this.current_target.getIdentifier()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSBoxDropModelChoice"),a5.models.interaction.OSBoxDropModelTarget={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({contents:"",target_id:!1,identifier:!1,matchMax:"",index:NaN},defaults)),this.tryAgainIsFrozen=this.parent.tryAgainIsFrozen,this.choices=[],this.correctChoices=[]},appendChoice:function(choice){this.choices.push(choice),choice.dropTo(this),a5.mainBuilder.updateScoresAsync()},getIdentifier:function(){return this.identifier},setState:function(newState){_.invoke(this.choices,"setState",newState),this._super(newState)},clearAll:function(){_.each(this.choices,function(choice){choice.undrop(),this.parent.choices.push(choice)},this),this.choices=[],a5.mainBuilder.updateScoresAsync()},clearWrong:function(){_.each(this.choices,function(choice){choice.isCorrect()||(choice.undrop(),this.parent.choices.push(choice))},this),this.choices=_.intersection(this.choices,this.correctChoices),a5.mainBuilder.updateScoresAsync()},isFilled:function(){return this.choices.length>0}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSBoxDropModelTarget"),a5.model.interaction.ICCrossword={init:function(parameters,defaults){this._super(parameters,$.extend({tryAgainKeep:!1,tryAgainIsFrozen:!1,cluesInColumns:!1},defaults)),this.words=[],this.cells=[],this.width=0,this.height=0},setState:function(state){_.invoke(this.cells,"setState",state),this._super(state)},store:function(){var data=[];return _.each(this.cells,function(cell){cell.value&&data.push({v:cell.value,p:cell.x+":"+cell.y})}),data},restore:function(data){var self=this;_.each(data,function(obj){var coords=obj.p.split(":"),cell=self.getCellAt(coords[0],coords[1]);!1!==cell&&cell.setValue(obj.v,!0)}),this.setState("input")},indexOf:function(element){return _.indexOf(this.words,element)},getScores:function(){var score=new a5.Score;return _.each(this.words,function(word){word.prefilled||(score.incTotal(),score.incCorrect(word.isCorrect()),score.incFilled(word.isFilled()))}),score},isCorrect:function(){return _.every(this.words,function(word){return word.prefilled||word.isCorrect()})},isFilled:function(){return _.some(this.words,function(word){return word.isFilled()})},getCandidatesForSolutionHint:function(){return _.filter(this.words,function(item){return item.isRevealedBySolutionHint()?item:"answers"!==item.state&&!item.isFilled()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.words,function(item){return"answers"!==item.state&&!item.prefill&&!item.prefilled&&!item.isCorrect()})},getCandidatesForValidation:function(){return _.filter(this.words,function(item){return"answers"!==item.state&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),this.hasCandidatesForValidation()||(this.state="answers"),question},tryAgain:function(){_.each(this.cells,function(cell){cell.isCorrect()||this.tryAgainKeep||cell.setValue("",!0)},this),this._super()},addWord:function(word){this.words.push(word)},findWord:function(id){for(var c=0;c<this.words.length;c++)if(this.words[c].word==id.toLowerCase())return this.words[c]},filterWords:function(params,sort){params=params||{},sort=sort||"id";var dummy=new a5.model.interaction.ICCrosswordWord,props=_.pick(params,function(value,key){return void 0!==dummy[key]});return sort=dummy.hasOwnProperty(sort)?sort:"id",_.chain(this.words).filter(function(word){return _.every(props,function(prop,key){return _.result(word,key)===prop})}).sortBy(sort).value()},getCellAt:function(x,y){for(var c=0;c<this.cells.length;c++)if(x==this.cells[c].x&&y==this.cells[c].y)return this.cells[c];return!1},initializeWords:function(){this.pack(),this.createCells()},createCells:function(){var tag,index=0,self=this;this.size=[0,0],_.each(this.words,function(word){for(var sx=word.x,sy=word.y,c=0;c<word.word.length;c++){var cell=self.getCellAt(sx,sy);cell||(cell=new a5.model.interaction.ICCrosswordCell({x:sx,y:sy,letter:word.word[c],tryAgainIsFrozen:self.tryAgainIsFrozen,parent:self}),self.cells.push(cell)),0===c&&(cell.label||(index++,cell.label=""+index),tag=(word.isHorizontal()?"a":"d")+index,word.label=cell.label,cell.words.push(word)),cell.tags.push(tag),word.tag=tag,cell.allWords.push(word),word.cells[c]=cell,sx+=word.isHorizontal()?1:0,sy+=word.isVertical()?1:0,this.size[0]=Math.max(this.size[0],sx),this.size[1]=Math.max(this.size[1],sy)}},this)},pack:function(){var minX=1e4,minY=1e4,maxX=0,maxY=0;_.each(this.words,function(word){minX=Math.min(minX,word.x),minY=Math.min(minY,word.y),word.isHorizontal()?(maxX=Math.max(maxX,word.x+word.word.length),maxY=Math.max(maxY,word.y+1)):(maxY=Math.max(maxY,word.y+word.word.length),maxX=Math.max(maxX,word.x+1))}),_.each(this.words,function(word){word.x-=minX,word.y-=minY}),this.width=maxX-minX,this.height=maxY-minY}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICCrossword"),a5.model.interaction.ICCrosswordWord={init:function(parameters,defaults){this._super(parameters,$.extend({align:"vertical",word:"word",x:0,y:0,label:!1,prefilled:!1,ignoreCase:!1,ignorePunctuation:!1,ignoreAccents:!1},defaults)),this.word=this.word.toLowerCase(),this.cells=new Array(this.word.length)},getUserWord:function(){return _.map(this.cells,function(cell){return cell.isPrefilled()?cell.letter:cell.value}).join("")},showSolutionHint:function(){this.state="answers",_.invoke(this.cells,"showSolutionHintFor",this)},showNextAnswer:function(){this.state="answers",_.invoke(this.cells,"showNextAnswerFor",this)},isPrefilled:function(){return this.prefilled},isRevealedBySolutionHint:function(){return _.all(this.cells,function(cell){return cell.isRevealedBySolutionHint()})},isFrozen:function(){return _.all(this.cells,function(cell){return cell.isFrozen()})},isEditable:function(){return!this.isPrefilled()&&!this.isFrozen()},isCorrect:function(){return a5.utils.checkUserInput(this.getUserWord(),this.word,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},isFilled:function(){return!_.some(this.cells,function(cell){return 0===cell.value.length&&!cell.isPrefilled()})},isVertical:function(){return"vertical"==this.align},isHorizontal:function(){return"horizontal"==this.align},wrongText:function(){return this.getUserWord()},correctText:function(){return this.word}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICCrosswordWord"),a5.model.interaction.ICCrosswordCell={init:function(parameters,defaults){this._super(parameters,$.extend({letter:"x",x:0,y:0,label:!1,words:[],allWords:[],tryAgainIsFrozen:!1,frozen:!1},defaults)),this.value="",this.tags=[]},isEditable:function(){return!this.isPrefilled()&&!this.isFrozen()},isPrefilled:function(){return _.any(this.allWords,function(w){return w.isPrefilled()})},isEmpty:function(){return!this.value&&!this.isPrefilled()},isFrozen:function(){return this.frozen},isRevealedBySolutionHint:function(){return this.revealedBySolutionHint},showSolutionHintFor:function(word){this.revealedBySolutionHint=!0,this.state="answers",this.trigger("next_answer",word)},showNextAnswerFor:function(word){this.state="answers",this.trigger("next_answer",word)},isCorrect:function(){return this.letter==this.value},updateFreeze:function(){this.isCorrect()&&this.tryAgainIsFrozen&&(this.frozen=!0)},setValue:function(val,silent){this.value=val.toLowerCase(),silent||this.callViews("updateValue",[this.value]),a5.mainBuilder.updateScoresAsync()},focus:function(){this.callViews("focus")}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICCrosswordCell"),a5.models.interaction.ICExtendedWriting={init:function(parameters,defaults){this._super(parameters,$.extend({$node:null},defaults)),this.ckes=[]},registerCKEditor:function(cke_instance){this.ckes.push(cke_instance)},store:function(){var data={ckes:{},textareas:{}};return _.each(this.ckes,function(cke){data.ckes[cke.name]=cke.getData()}),_.each(this.$node.find("textarea"),function(ta){var $ta=$(ta);$ta.val()&&(data.textareas[$ta.prop("id")]=$ta.val())}),(!_.isEmpty(data.ckes)||!_.isEmpty(data.textareas))&&data},restore:function(data){_.each(data.ckes,function(value,name){window.CKEDITOR.instances[name].setData(value)},this),_.each(data.textareas,function(value,name){this.$node.find("#"+name).val(value)},this)},getScores:function(){var score=new a5.Score;return score.incTotal(),score},isFilled:function(){return _.some(this.ckes,function(cke){return cke.getData().length>0})}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICExtendedWriting"),a5.models.interaction.ISRadiobuttonModel={init:function(parameters,defaults){this._super(parameters,$.extend({alignment:"horizontal",prefilled:!1,tryAgainKeep:!1,tryAgainIsFrozen:!1,correct:null,blockItems:[],questionIndex:null,orderDependency:!1,affectedBy:null,affects:null,result:!1,display:"",blockId:null,attempts:0,tryAgainIsClear:!1},defaults)),this.bind("state_update:input",function(){},this),this.bind("change:result",function(){this.updateResultOfAffected()},this)},unselect:function(){this.tryAgainKeep||this.isCorrect()||this._super()},setSelected:function(choice){this._super(choice),this.updateResult()},getAffects:function(){return this.affects||(this.orderDependency?this.affects=_.filter(this.blockItems,function(el){return el.questionIndex>this.questionIndex},this):this.affects=[]),this.affects},getAffectedBy:function(){return this.affectedBy||(this.orderDependency?this.affectedBy=_.filter(this.blockItems,function(el){return el.questionIndex<this.questionIndex},this):this.affectedBy=[]),this.affectedBy},correctText:function(){return this.correct.text},wrongText:function(){return this.selected?this.selected.text:""},isSelectionCorrect:function(){return this.selected===this.correct},isCorrect:function(){return this.result},updateResult:function(){var result=!1,prevResult=this.result;if(this.selected===this.correct){var list=this.getAffectedBy();result=_.every(list,function(el){return el.isCorrect()})}this.result=result,prevResult!==result&&this.trigger("change:result")},updateResultOfAffected:function(){_.invoke(this.getAffects(),"updateResult")},isFilled:function(){return this.selected},getScores:function(){var score=new a5.Score;return this.prefilled||(score.incTotal(),score.incCorrect(this.isCorrect()),score.incFilled(this.isFilled())),score},isDisplayShowNext:function(){return"show_next"===this.display},isDisplayShowNextHidePrev:function(){return"show_next_and_hide_previous"===this.display},isDisplayActive:function(){return"active"===this.display}},a5.models.RadioButton.extend("a5.models.interaction.ISRadiobuttonModel"),a5.models.interaction.ISRadiobuttonChoiceModel={init:function(parameters,defaults){this._super(parameters,$.extend({label:"text",content:"text",correct:!1,hasRadiobutton:!1,radiobuttonIsCustom:!1,enumeration:"",tryAgainIsFrozen:!1},defaults)),this.text=this.content.text(),this.content.find("img").length&&(this.text=this.content.find("img")[0].outerHTML)},isCorrectAnswer:function(){return this.parent.correct===this}},a5.models.RadioButtonChoice.extend("a5.models.interaction.ISRadiobuttonChoiceModel"),a5.models.item.interaction.WordSnake={CHECK_LEFT_OFFSET:0,CHECK_TOP_OFFSET:-20,init:function(parameters,defaults){this._super(parameters,$.extend({responseIdentifier:"",interaction:null},defaults)),this.__index=0},getScores:function(){var interaction=this.interaction,score=new a5.Score,answers=_.values(interaction.answers),letters=interaction.letters;if(interaction.options.prefillIsFirstitem()){var firstAnswer=_.first(answers);answers=_.rest(answers),letters=_.rest(letters,firstAnswer.length)}return _.each(answers,function(val){score.incTotal(),this.isAnswerSelected(val,interaction.selections)&&score.incCorrect()},this),_.each(interaction.selections,function(sel){score.incFilled()}),score.filled>score.total&&(score.filled=score.total),letters&&letters.length==_.map(interaction.selections,function(s){return s[0]}).join("").length&&(score.filled=score.total),score},isAnswerSelected:function(answer,selections){return _.some(selections,function(selection){return selection[0]===answer})},isSelectionCorrect:function(selection,answers){return _.include(answers,selection[0])},isCorrect:function(){var answers=_.values(this.interaction.answers);return this.interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),_.all(answers,function(answer){return this.isAnswerSelected(answer,this.interaction.selections)},this)},isFilled:function(){return this.interaction.selections&&!_.isEmpty(this.interaction.selections)},getCandidatesForSolutionHint:function(){var answers=_.values(this.interaction.answers);return this.interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),answers[this.__index]?[answers[this.__index]]:[]},getCandidatesForShowNextAnswer:function(){var answers=_.values(this.interaction.answers);return this.interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),answers[this.__index]?[answers[this.__index]]:[]},getCandidatesForValidation:function(){var answers=_.values(this.interaction.answers);return this.interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),answers},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer?question.showNextAnswer():question.showAnswer?question.showAnswer():this.isCorrect()||(this.showOneAnswer(question,this.__index),this.__index++)),!this.isCorrect()&&this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer?question.showAnswer():this.isCorrect()||(this.showOneAnswer(question,this.__index),this.__index++)),!this.isCorrect()&&this.hasCandidatesForValidation()||(this.state="answers"),question},setAnswer:function(){this._super();var interaction=this.interaction;$("#IWT-"+interaction.index).find(".check").remove();var answers=_.values(interaction.answers);interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),_.each(answers,function(val,index){if(!_.include(_.map(interaction.selections,function(e){return e[0]}),val)){var lastLetter=interaction.letters[interaction.t.indexOf(val)+val.length-1];this._addCheck(lastLetter.attrs.x+this.CHECK_LEFT_OFFSET,lastLetter.attrs.y+this.CHECK_TOP_OFFSET,"wrong",$("#IWT-"+interaction.index),val)}},this),_.each(interaction.selections,function(sel){_.include(_.values(answers),sel[0])?this._addCheck(interaction.letters[sel[1]+sel[0].length-1].attrs.x+this.CHECK_LEFT_OFFSET,interaction.letters[sel[1]+sel[0].length-1].attrs.y+this.CHECK_TOP_OFFSET,"correct",$("#IWT-"+interaction.index)):this._addCheck(interaction.letters[sel[1]+sel[0].length-1].attrs.x+this.CHECK_LEFT_OFFSET,interaction.letters[sel[1]+sel[0].length-1].attrs.y+this.CHECK_TOP_OFFSET,"wrong",$("#IWT-"+interaction.index),sel[0])},this)},showAnswer:function(){this._super();var interaction=this.interaction;interaction.paper.forEach(function(el){"image"==el.type&&el.hide()}),$("#IWT-"+interaction.index).find(".check").remove();var answers=_.values(interaction.answers);interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),_.each(answers,this.showOneAnswer,this)},showOneAnswer:function(val,index){var interaction=this.interaction,startAnswer=interaction.t.indexOf(val),endAnswer=startAnswer+val.length-1,lastLetter=interaction.letters[endAnswer];_(interaction.letters.slice(startAnswer,endAnswer+1)).some(_.property("selected"))?_(interaction.letters.slice(startAnswer,endAnswer+1)).every(_.property("selected"))?this._addCheck(lastLetter.attrs.x+this.CHECK_LEFT_OFFSET,lastLetter.attrs.y+this.CHECK_TOP_OFFSET,"correct",$("#IWT-"+interaction.index)):this._addCheck(lastLetter.attrs.x+this.CHECK_LEFT_OFFSET,lastLetter.attrs.y+this.CHECK_TOP_OFFSET,"wrong",$("#IWT-"+interaction.index)):this._addCheck(lastLetter.attrs.x+this.CHECK_LEFT_OFFSET,lastLetter.attrs.y+this.CHECK_TOP_OFFSET,"wrong_2",$("#IWT-"+interaction.index));for(var i=0;i<val.length;i++)interaction.letters[startAnswer+i].attr({fill:interaction.colors[index%interaction.colors.length]}),interaction.letters[startAnswer+i].node.setAttribute("class",interaction.colorClasses[index%interaction.colors.length])},tryAgain:function(){this._super();var interaction=this.interaction;$("#IWT-"+interaction.index).find(".check").remove(),_.each(interaction.selections,function(val){_.include(_.values(interaction.answers),val[0])||(interaction.selections=_.filter(interaction.selections,function(item){return item[0]!=val[0]}))}),this.interaction.paper=void 0,this.callViews("drawSVG",[this.interaction.index,this.interaction,!1])},store:function(){return this.interaction.selections},restore:function(selections){_.isArray(selections)&&(this.interaction.selections=selections),this.interaction.paper=void 0,this.callViews("drawSVG",[this.interaction.index,this.interaction,!0])},_addCheck:function(x,y,klass,parentNode,title){var $check=$('<div class="check"></div>');$check.addClass(klass),$check.attr("title",title),$check.css("position","absolute"),$check.css("left",x),$check.css("top",y),parentNode.append($check)}},a5.models.interaction.BaseModel.extend("a5.models.item.interaction.WordSnake"),a5.models.interaction.SyllabifyWord={init:function(parameters,defaults){this._super(parameters,$.extend({correctResponse:null,tryAgainKeep:!1,tryAgainLock:!1,tryAgainIsFrozen:!1,tts_audio:!1},defaults)),this.choices=[]},store:function(){return{choices:this.getChoices()}},restore:function(data){this.setChoices(data.choices),this.setState("input")},getScores:function(){var score=new a5.Score,correct=this.getCorrectResponse(),response=this.getChoices();return _.each(correct,function(syllable){score.incTotal()}),_.each(response,function(syllable){score.total>score.filled&&score.incFilled(),_.contains(correct,syllable)&&(score.incCorrect(),correct.splice(correct.indexOf(syllable),1))}),score},setChoices:function(choice){this.choices=choice,a5.mainBuilder.updateScoresAsync()},getChoices:function(){return this.choices.slice(0)},getCorrectResponse:function(){return this.correctResponse.values.slice(0)},getFeedbackAt:function(i){try{var feedback=jQuery.parseJSON(this.answerFeedback)}catch(e){}if(feedback)return feedback[i]},clear:function(){this.choices=[]},clearWrong:function(){var tmp="";this.choices=_.reduce(this.getCorrectResponse(),function(memo,syllable,i,correct){return _.contains(this.choices,syllable)?(tmp&&(memo.push(tmp),tmp=""),memo.push(syllable)):(tmp+=syllable,i===correct.length-1&&memo.length&&memo.push(tmp)),memo},[],this)},isFilled:function(){return!!this.choices.length},isCorrect:function(){return this.choices.join("$")==this.getCorrectResponse().join("$")},tryAgain:function(){this.isCorrect()||(this.tryAgainLock?this.clearWrong():this.tryAgainKeepall||this.clear()),this._super()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.SyllabifyWord"),a5.models.item.interaction.Colouring={init:function(parameters,defaults){this._super(parameters,$.extend({items:{},answers:{},interaction:null,tryAgainKeep:!1,poolAlign:"",maxOpacity:1},defaults)),this.color="white",this.OPACITY_FILL=this.maxOpacity,this.OPACITY_EMPTY=0,this.opacity=this.OPACITY_FILL,this.distractorColors=[]},addDistractorColour:function(item){item.distractor=!0,this.distractorColors.push(item)},addItem:function(name,item){this.items[name]=item},store:function(){var data=[];return _.each(this.items,function(item,name){item.prefilled||data.push({name:name,color:item.color,opacity:item.opacity})}),data},restore:function(data){_.each(data,function(chunk){this.items[chunk.name].color=chunk.color,this.items[chunk.name].opacity=chunk.opacity},this),this.callViews("updateState")},isCorrect:function(){return _.every(this.items,function(item){return item.isCorrect()})},isFilled:function(){return _.some(this.items,function(item){return item.isFilled()})},getCandidatesForSolutionHint:function(){return _.filter(this.items,function(item){return"answers"!==item.state&&!item.isFilled()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.items,function(item){return"answers"!==item.state&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForValidation:function(){return _.filter(this.items,function(item){return"answers"!==item.state&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),this.hasCandidatesForValidation()||(this.state="answers"),question},getScores:function(){var score=new a5.Score;return _.each(this.items,function(item){item.prefilled||item.distractor||(score.incTotal(),item.isCorrect()&&score.incCorrect(),item.isFilled()&&score.incFilled())}),score}},a5.models.interaction.BaseModel.extend("a5.models.item.interaction.Colouring",a5.models.item.interaction.Colouring),a5.models.item.interaction.ColouringInteractionGapText={init:function(parameters,defaults){this._super(parameters,$.extend({identifier:"",label:"",color:"white",opacity:0,areas:"",correctColor:"",prefilled:!1,distractor:!1},defaults)),this.prefilled?(this.color=this.correctColor,this.opacity=this.parent.OPACITY_FILL):this.opacity=this.parent.OPACITY_EMPTY},isCorrect:function(){return this.opacity==this.parent.OPACITY_FILL&&this.color==this.correctColor||this.distractor&&this.opacity!=this.parent.OPACITY_FILL},isFilled:function(){return this.opacity==this.parent.OPACITY_FILL},showNextAnswer:function(){this.state="answers",this.parent.trigger("show-next",this)}},a5.models.interaction.BaseModel.extend("a5.models.item.interaction.ColouringInteractionGapText"),a5.models.item.interaction.ColouringInteractionColour={init:function(parameters,defaults){this._super(parameters,$.extend({identifier:"",idAttr:"",label:"",color:"distractor",opacity:0,areas:"",distractor:!1},defaults))}},a5.models.interaction.BaseModel.extend("a5.models.item.interaction.ColouringInteractionColour"),a5.models.interaction.ISCatchGameModel={init:function(parameters,defaults){this._super(parameters,$.extend({models:[],stageConfiguration:{},targetsConfiguration:{}},defaults)),_.bindAll(this,"_bindQuestionScore","_scoreIncrease","_scoreDecrease"),_.each(this.models,this._bindQuestionScore),this._initScore()},_initScore:function(){var score=new a5.Score;_.chain(this.models).invoke("correct").each(function(totalCorrect){score.incTotal(totalCorrect.length)}),this.score=score},_bindQuestionScore:function(question){question.unbind("scoreIncrease",this._scoreIncrease),question.bind("scoreIncrease",this._scoreIncrease),question.unbind("scoreDecrease",this._scoreDecrease),question.bind("scoreDecrease",this._scoreDecrease)},_scoreIncrease:function(){this.score.incCorrect()},_scoreDecrease:function(){this.score.correct>0&&this.score.decCorrect()},tryAgain:function(){this._super(),_.invoke(this.models,"initState"),this._initScore()},allTargets:function(){return _.chain(this.models).map(function(question){return question.targets}).flatten().value()},unstagedQuestions:function(){return _.filter(this.models,function(question){return"init"===question.state})},getScores:function(){return this.score}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISCatchGameModel"),a5.models.interaction.ISCatchQuestionModel={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({targets:!1,question:"",substractIncorrect:!1},defaults)),_.bindAll(this,"getTarget","onTargetResponded"),this.targets=_.map(this.targets,this.getTarget),this.state="init"},getTarget:function(targetObj){var target=new a5.models.interaction.ISCatchTargetModel(targetObj);return target.bind("state_update:feedback",function(evt){this.onTargetResponded(target)},this),target},onTargetResponded:function(target){target.isCorrect?this.trigger("scoreIncrease"):this.substractIncorrect&&this.trigger("scoreDecrease")},initState:function(){this.state="init",_.invoke(this.targets,"initState"),this.trigger("state_update:init")},inputState:function(){this.tryAgain()},setAnswer:function(){this._super()},showAnswer:function(){this._super(),_.invoke(this.targets,"showAnswer")},tryAgain:function(){this._super(),_.invoke(this.targets,"initState")},correct:function(){return this._filteredElements({isCorrect:!0})},tobeDisplayedCorrect:function(){return this._filteredElements({isCorrect:!0,state:"init"})},tobeDisplayed:function(){return this._filteredElements({state:"init"})},displayingCorrect:function(){return this._filteredElements({state:"input",isCorrect:!0})},_filteredElements:function(params,sort){params=params||{};var dummy=new a5.models.interaction.ISCatchTargetModel,props=_.pick(params,function(value,key){return void 0!==dummy[key]}),response=_.filter(this.targets,function(target){return _.every(props,function(prop,key){return _.result(target,key)===prop})});return dummy.hasOwnProperty(sort)&&(response=_.sortBy(response,sort)),response}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISCatchQuestionModel");a5.models.interaction.ISCatchTargetModel={init:function(parameters,defaults){this._super(parameters,$.extend({id:null,value:"",isCorrect:!1},defaults)),this.state="init"},display:function(){this.tryAgain()},acceptedStates:function(){var states=this._super();return states.push("init","expired"),states},initState:function(){this.setState("init")},expire:function(){this.setState("expired")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISCatchTargetModel"),a5.models.item.interaction.TargetGame={init:function(node){this.node=node,this.responseIdentifier=node.attr("responseIdentifier")},getScores:function(){var score=new a5.Score;return this.isCorrect?(score.incTotal(),this.dom.find(".clicked_correct").length>0&&score.incCorrect()):this.dom.find(".clicked_incorrect").length>0&&score.decCorrect(),score},setAnswer:function(){$(".tgm").show(),this.isCorrect?this.dom.find(".click").addClass("clicked_correct"):this.dom.find(".click").addClass("clicked_incorrect")}},Obj.extend("a5.models.item.interaction.TargetGame",a5.models.item.interaction.TargetGame),a5.models.interaction.ISDropdownModel={init:function(parameters,defaults){this._super(parameters,$.extend({prefill:!1,selected:null,correct:[],allowRepeat:!0,tryAgainKeep:!1,hasOrderedResponses:!1,tryAgainIsFrozen:!1,labelStyle:null,placeholder:null},defaults)),this.choices=[],this.setState("input")},add:function(choiceModel){this.choices.push(choiceModel)},store:function(){return this.selected?this.selected.key:null},restore:function(selectedKey){var selected=_.find(this.choices,function(choice){return choice.key===selectedKey});this.setSelected(selected)},setCorrect:function(correct){this.correct.push(correct)},getDependentModel:function(){return _.first(this.parent.itemList)},setSelected:function(selected){"number"==typeof selected&&(selected=this.choices[selected]),selected&&this.selected==selected||(this.selected=selected,this.trigger("update-selected"),a5.mainBuilder.updateScoresAsync())},resetSelected:function(){this.setSelected(null)},isCorrect:function(){return this.hasOrderedResponses?this.isCorrectOrdered():_.indexOf(this.correct,this.selected)>-1&&(this.allowRepeat||!this.isRepeated())},isCorrectOrdered:function(){if(this.getDependentModel().selected){var correctIndex=this.getDependentModel().selected.correctIndex;return this.selected&&_.indexOf(this.correct,this.selected)>-1&&this.selected.correctIndex===correctIndex}return!1},isFilled:function(){return Boolean(this.selected)},getCorrect:function(){var correctIndex=0;return this.hasOrderedResponses&&this.getDependentModel().selected&&(correctIndex=this.getDependentModel().selected.correctIndex||0),_(this.correct).find(function(c){return c.correctIndex===correctIndex})},markRepeatedDropdowns:function(){var repeated=[];_.each(this.parent.itemList,function(dropdown){if(dropdown.repeated=!1,dropdown.selected&&_(dropdown.correct).contains(dropdown.selected)){_(repeated).filter(function(text){return text===dropdown.selected.content.text()}).length<_(dropdown.correct).filter(function(choice){return choice.content.text()===dropdown.selected.content.text()}).length?repeated.push(dropdown.selected.content.text()):dropdown.repeated=dropdown.correct.length>1}})},getAnswers:function(){return this.prefill?[]:_.map(this.correct,function(item){return _.map(item.content,function(node){return node.outerHTML||node.textContent}).join("")})},findNextCorrect:function(){if(this.isCorrect())return this.selected
;var correct=this.correct.slice(0);if(correct.length>1){var dropdowns=_(this.parent.itemList).without(this);_(dropdowns).each(function(d){var choice=d.isCorrect()?d.selected:d.correctChoice,correctIndex=correct.indexOf(_(correct).find(function(c){return choice&&c.content.text()===choice.content.text()}));correctIndex>=0&&correct.splice(correctIndex,1)},this)}return this.correctChoice=_(correct).first()||_(this.correct).first(),this.correctChoice},isRepeated:function(){return this.markRepeatedDropdowns(),this.repeated},correctText:function(){return this.correct[0].content},wrongText:function(){return this.selected?this.selected.content:""},getScores:function(){var score=new a5.Score;return this.prefill||(score.incTotal(),null!=this.selected&&score.incFilled(),this.isCorrect()&&score.incCorrect(!0)),score},setAnswer:function(){this.setState("feedback")},tryAgain:function(){this.tryAgainKeep||this.isCorrect()||this.resetSelected(),this.setState("input")},showAnswer:function(){this.setState("answers")},showNextAnswer:function(){this.showAnswer(),this.trigger("next_answer")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISDropdownModel"),a5.models.interaction.ISDropdownChoiceModel={init:function(parameters,defaults){this._super(parameters,$.extend({content:"text",key:null},defaults))},setCorrectIndex:function(index){this.correctIndex=index},isCorrect:function(){return this.parent.isCorrect()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISDropdownChoiceModel"),a5.model.interaction.IMMarking={init:function(parameters,defaults){this._super(parameters,$.extend({blockEnumeration:null,prefilled:!1,tryAgainKeep:!1,markingStyle:"",scoreValueIs1PerQuestion:!1,interaction:null},defaults)),this.nodes=[]},setState:function(newState){this._super(newState),this.interaction.toolbar.setEnableButtonsStatus("input"===newState),_.invoke(this.nodes,"setState",newState)},push:function(node){this.nodes.push(node)},isPrefilled:function(){return this.prefilled},peek:function(peek){return 0==this.nodes.length?new Obj:this.nodes[this.nodes.length-1]},getScores:function(){var score=new a5.Score;return _.each(this.nodes,function(node){node.getScores(score)}),this.scoreValueIs1PerQuestion&&(this.prefilled||(score.totalBlocks=1,score.correctBlocks=score.total?score.correct/score.total:1),score.filled>score.total&&(score.filled=score.total),score.correct<0&&(score.correct=0),score.correctBlocks<0&&(score.correctBlocks=0)),score},isCorrect:function(){var targets=_.filter(this.nodes,function(node){return"text"!=node.type&&node.hasCorrectAnswer()});return _.every(targets,function(node){return node.isCorrect()||node.prefilled})},isFilled:function(){return _.some(this.nodes,function(n){return _.isFunction(n.isFilled)&&n.isFilled()})},getCandidatesForSolutionHint:function(){return _.filter(this.nodes,function(item){return"answers"!==item.state&&"text"!==item.type&&item.hasCorrectAnswer()&&!item.isFilled()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.nodes,function(item){return"answers"!==item.state&&"text"!==item.type&&item.hasCorrectAnswer()&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForValidation:function(){return _.filter(this.nodes,function(item){return"answers"!==item.state&&"text"!==item.type&&item.hasCorrectAnswer()&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers",_.defer(function(){"answers"===this.interaction.items.state&&this.interaction.toolbar.setEnableButtonsStatus(!1)}.bind(this))),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),this.hasCandidatesForValidation()||(this.state="answers",_.defer(function(){"answers"===this.interaction.items.state&&this.interaction.toolbar.setEnableButtonsStatus(!1)}.bind(this))),question},setAnswerInput:function(){this._super(),_.invoke(this.nodes,"setAnswerInput")},tryAgain:function(){this._super(),_.each(this.nodes,function(node){node.tryAgain()})},store:function(){var nodes=[];return _.map(this.nodes,function(node,i){node.store()&&"element"==node.type?nodes[i]=node.store():nodes[i]=0}),nodes=_.filter(nodes,function(n){return!_.isNull(n)})},restore:function(nodes){_.isUndefined(nodes)||_.map(this.nodes,function(node,i){try{node.restore(nodes[i])}catch(e){}node.callViews("updateStatus")})}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMMarking"),a5.model.interaction.IMMarkingElement={init:function(parameters,defaults){this._super(parameters,$.extend({correct:[],text:"word",prefilled:!1,subtractIncorrect:!1,tryAgainIsFrozen:!1},defaults)),this.marked=!1,this.type="element"},setMarked:function(color){this.marked=color,this.callViews("updateStatus"),a5.mainBuilder.updateScoresAsync()},setPrefilled:function(){this.prefilled=!0},isMarked:function(){return!!this.marked},getColor:function(){return this.parent.interaction.iMMarkingColors[this.marked]},getCorrectColor:function(){return this.parent.interaction.iMMarkingColors[this.correct[0]]},isFilled:function(){return!!this.marked},isPrefilled:function(){return this.prefilled},isDistractor:function(){return!this.correct.length},hasCorrectAnswer:function(){return!this.isDistractor()&&!this.isPrefilled()},isCorrect:function(){return _.include(this.correct,this.marked)},getScores:function(score){score.incFilled(this.isFilled()),this.hasCorrectAnswer()&&(score.incCorrect(this.isCorrect()),score.incTotal()),this.subtractIncorrect&&this.isFilled()&&!this.isCorrect()&&(score.correct-=1)},tryAgain:function(){this.parent.tryAgainKeep||this.isCorrect()||this.setMarked(!1)},showNextAnswer:function(){this.showAnswer(),this.trigger("next_answer")},store:function(){if(this.marked){return{type:"element",params:{marked:this.marked}}}},restore:function(data){if(0==data)return!1;if(data&&data.params){var params=data.params;this.marked=params.marked}return this}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMMarkingElement"),a5.model.interaction.IMMarkingText={init:function(parameters,defaults){this._super(parameters,$.extend({text:"word"},defaults)),this.type="text"},getScores:function(score){},tryAgain:function(){},store:function(){return{type:"text",params:{text:this.text}}},restore:function(params){return this}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMMarkingText"),a5.model.interaction.IMProofingBlock={init:function(parameters,defaults){this._super(parameters,$.extend({blockEnumeration:null,state:"input",subtractIncorrect:!1},defaults)),this.nodes=[]},isPrefilled:function(){return _.any(this.nodes,function(node){return node.isPrefilled()})},countWrongWords:function(){return _.filter(this.nodes,function(n){return n.needsAnswer()}).length},add:function(node){this.nodes.push(node)},store:function(){var data=[];return _.each(this.nodes,function(node,index){node.isFilled()&&data.push(_.extend(node.store(),{index:index}))}),data},restore:function(data){_.each(data,function(item){_.find(this.nodes,function(node,index){return item.index===index}).restore(item)},this)},getScores:function(){var score=new a5.Score;return _.each(this.nodes,function(node){node.getScores(score)}),score},isCorrect:function(){var nodes=_.filter(this.nodes,function(n){return _.isFunction(n.isCorrect)});return _.every(nodes,function(n){return n.isCorrect()})},isFilled:function(){var nodes=_.filter(this.nodes,function(n){return _.isFunction(n.isFilled)});return _.some(nodes,function(n){return n.isFilled()})},tryAgain:function(){_.each(this.nodes,function(node){node.tryAgain()}),this._super()},setAnswer:function(){_.each(this.nodes,function(node){node.setAnswer()}),this._super()},showAnswer:function(){_.each(this.nodes,function(node){node.showAnswer()}),this._super()}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMProofingBlock"),a5.model.interaction.IMProofingElement={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",marker:null,prefill:!1,correct:null,subtractIncorrect:!1,tryAgainKeep:!1,ignoreAccents:!1,ignorePunctuation:!1,ignoreCase:!1},defaults))},setMarker:function(marker){this.marker=marker,a5.mainBuilder.updateScoresAsync()},getMarker:function(){return this.marker},getText:function(){return this.text},setText:function(text){this.text=text},getCorrect:function(){var correct;if(this.needsAnswer()){var text;this.correct.answers.length>0&&(text=this.correct.answers[0]),correct={marker:this.correct.marker,text:text}}return correct},needsAnswer:function(){return!!this.correct&&!this.isPrefilled()},isFilled:function(){return!!this.marker},isPrefilled:function(){return this.prefill},isCorrect:function(){return this.needsAnswer()&&this.isFilled()&&this.hasCorrectMarker()},hasCorrectMarker:function(){return this.marker.marker===this.correct.marker&&(!this.correct.answers.length||a5.utils.containsAnswer(this.marker.text,this.correct.answers,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents))},getScores:function(score){this.isFilled()&&score.incFilled(),this.needsAnswer()&&score.incTotal(),this.isCorrect()&&score.incCorrect(),this.subtractIncorrect&&this.isFilled()&&!this.isCorrect()&&score.decCorrect()},store:function(){return this.marker},restore:function(data){data&&(this.marker={marker:data.marker,text:data.text},this.trigger("restore"))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMProofingElement"),a5.model.interaction.IMProofingText={init:function(parameters,defaults){this._super(parameters,$.extend({text:""},defaults))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMProofingText"),a5.model.interaction.IMAutocorrectBlock={init:function(parameters,defaults){this._super(parameters,$.extend({blockEnumeration:null,state:"input",subtractIncorrect:!1},defaults)),this.nodes=[]},isPrefilled:function(){return _.any(this.nodes,function(node){return node.isPrefilled()})},countWrongWords:function(){return _.filter(this.nodes,function(n){return n.needsAnswer()}).length},add:function(node){this.nodes.push(node)},store:function(){var data=[];return _.each(this.nodes,function(node,index){node.isFilled()&&data.push(index)}),data},restore:function(data){_.each(data,function(item){_.find(this.nodes,function(node,index){return item===index}).restore()},this)},getScores:function(){var score=new a5.Score;return _.each(this.nodes,function(node){node.getScores(score)}),score},isCorrect:function(){var nodes=_.filter(this.nodes,function(n){return _.isFunction(n.isCorrect)});return _.every(nodes,function(n){return n.isCorrect()})},isFilled:function(){var nodes=_.filter(this.nodes,function(n){return _.isFunction(n.isFilled)});return _.some(nodes,function(n){return n.isFilled()})},tryAgain:function(){_.each(this.nodes,function(node){node.tryAgain()}),this._super()},setAnswer:function(){_.each(this.nodes,function(node){node.setAnswer()}),this._super()},showAnswer:function(){_.each(this.nodes,function(node){node.showAnswer()}),this._super()}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMAutocorrectBlock"),a5.model.interaction.IMAutocorrectElement={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",marked:!1,prefill:!1,correct:null,subtractIncorrect:!1,tryAgainKeep:!1},defaults)),this.correctText=this.getCorrect()||""},setMarked:function(){this.marked||(this.marked=!0,a5.mainBuilder.updateScoresAsync())},unsetMarked:function(){this.marked&&(this.marked=!1,a5.mainBuilder.updateScoresAsync())},getCorrect:function(){if(this.needsAnswer())return this.correct[0]},needsAnswer:function(){return!_.isEmpty(this.correct)&&!this.isPrefilled()},isFilled:function(){return!!this.marked},isPrefilled:function(){return this.prefill},isCorrect:function(){return this.needsAnswer()&&this.isFilled()},getScores:function(score){this.isFilled()&&score.incFilled(),this.needsAnswer()&&score.incTotal(),this.isCorrect()&&score.incCorrect(),this.subtractIncorrect&&this.isFilled()&&!this.isCorrect()&&score.decCorrect()},store:function(){},restore:function(){this.marked=!0,this.trigger("restore")}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMAutocorrectElement"),a5.model.interaction.IMAutocorrectText={init:function(parameters,defaults){this._super(parameters,$.extend({text:""},defaults))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMAutocorrectText"),a5.models.interaction.ISCheckboxModel={init:function(parameters,defaults){this._super(parameters,$.extend({alignment:"horizontal",enumeration_internal:[],tryAgainKeep:!1,allowSelectAll:!1,attempts:0,display:""},defaults))},restore:function(data){this._super(data),this.checkMaxSelections(!0)},totalSelected:function(){return _.reduce(this.choices,function(i,e){return i+(!e.prefill&&"answers"!==e.state&&e.selected?1:0)},0)},totalCorrect:function(){return _.reduce(this.choices,function(i,e){return i+(!e.prefill&&"answers"!==e.state&&e.correct?1:0)},0)},addEnumeration:function(num){this.enumeration_internal.push(num)},makeOnePrefilled:function(){_.some(this.choices,function(e){if(e.correct)return e.prefill=!0,!0})},getScores:function(){var score=new a5.Score;return _.each(this.choices,function(e){e.prefill||(score.incTotal(e.correct),e.selected&&(score.incFilled(),score.setAllFilled()),score.incCorrect(e.isCorrect()),this.allowSelectAll&&score.decCorrect(!e.correct&&e.selected))},this),score.correct<0&&(score.correct=0),score.filled>score.total&&(score.filled=score.total),score},unselect:function(){this.tryAgainKeep||_.each(this.choices,function(choice){choice.isCorrect()||choice.unselect()})},correctText:function(){return this.choicesText(function(choice){return choice.correct})},wrongText:function(){return this.choicesText(function(choice){return!choice.correct})},choicesText:function(iterator){return _.pluck(_.select(this.choices,iterator),"text").join(", ")},isCorrect:function(){return _.all(this.choices,function(choice){return choice.correct==choice.selected})},isFilled:function(){return _.some(this.choices,function(choice){return choice.isFilled()})},checkMaxSelections:function(lastSelected){var shit=this.totalCorrect()-this.totalSelected();lastSelected&&shit<=0?this.trigger("max-selections",!0):lastSelected||1!=shit||this.trigger("max-selections",!1)},isDisplayShowNext:function(){return"show_next"===this.display},isDisplayShowNextHidePrev:function(){return"show_next_and_hide_previous"===this.display},isDisplayActive:function(){return"active"===this.display},isDisplayAll:function(){return"all"===this.display},getCandidatesForSolutionHint:function(){if(!this.allowSelectAll&&this.totalSelected()>=this.totalCorrect())return[];var candidates=_.filter(this.choices,function(item){return"answers"!==item.state&&item.hasCorrectAnswer()&&!item.isFilled()&&!item.prefill&&!item.prefilled});return 0===candidates.length&&(candidates=_.filter(this.choices,function(item){return"answers"!==item.state&&item.hasCorrectAnswer()&&!item.prefill&&!item.prefilled})),candidates},getCandidatesForShowNextAnswer:function(){return _.filter(this.choices,function(item){return"answers"!==item.state&&item.hasCorrectAnswer()&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForValidation:function(){return _.filter(this.choices,function(item){return"answers"!==item.state&&item.hasCorrectAnswer()&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),this.checkMaxSelections(!0),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),this.hasCandidatesForValidation()||(this.state="answers"),this.checkMaxSelections(!0),question}},a5.models.Checkbox.extend("a5.models.interaction.ISCheckboxModel"),a5.models.interaction.ISCheckboxChoiceModel={init:function(parameters,defaults){this._super(parameters,$.extend({label:"text",content:"text",correct:!1,hasCheckbox:!1,enumeration:"",prefill:!1,tryAgainIsFrozen:!1},defaults)),this.text=this.content.text(),this.content.find("img").length&&(this.text=this.content.find("img")[0].outerHTML)},isCorrect:function(){if(!this.prefill)return this.correct&&this.selected},isFilled:function(){return this.selected},hasCorrectAnswer:function(){return this.correct},select:function(){if(!this.parent.allowSelectAll&&this.parent.totalSelected()>=this.parent.totalCorrect())return void this.trigger("change");this._super(),this.parent.checkMaxSelections(!0)},unselect:function(){this._super(),this.parent.checkMaxSelections(!1)},showNextAnswer:function(){this.showAnswer(),this.parent.trigger("next_answer")}},a5.models.CheckboxChoice.extend("a5.models.interaction.ISCheckboxChoiceModel"),a5.models.interaction.ICTextGapCollection={init:function(parameters,defaults){this._super(parameters,$.extend({ignorePunctuation:!1,ignoreCase:!1,ignoreAccents:!1,ignoreSpaces:!1,hasOrderedResponsesFirstAnswer:!1},defaults)),this.itemList=this.parent.itemList,this.position=0,this.groups={}},_getFlipedChoices:function(possibleChoices,choices,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces){return _.chain(possibleChoices).unzip().map(function(c){return _.chain(c).zip(choices).filter(function(d){return a5.utils.checkUserInput(d[1],d[0],ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces)}).value()}).value()},updateOrderDependency:function(items){this.hasOrderedResponsesFirstAnswer?this.updateOrderDependencyFirstAnswer(items):this.updateOrderDependencyLongestCombination(items)},updateOrderDependencyFirstAnswer:function(items){items=items||this.parent.itemList;var firstAnswer=_(items).first();this.position=_.max([firstAnswer.correct.indexOf(firstAnswer.value),0])},updateOrderDependencyLongestCombination:function(items){items=items||this.parent.itemList;var possibleChoices=_(items).map(function(item){return item.correct}),choices=_(items).map(function(item){return item.value}),flipedChoices=this._getFlipedChoices(possibleChoices,choices,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces),elements=_(flipedChoices).max(_.size);this.position=_(flipedChoices).indexOf(elements)},updateOrderDependencyGroups:function(){var groups=_.chain(this.parent.itemList).groupBy("group").omit(!1).value(),correctGroups=_(groups).omit(function(group,key){return this.updateOrderDependency(group),_(group).some(function(item){return!item._isCorrectWithOrderDependency()})},this),groupCorrectIndexes=_(correctGroups).mapObject(function(group){var first=_(group).first();return a5.utils.indexOf(first.value,first.correct,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces)},this),groupCorrectIndexesPairs=_(groupCorrectIndexes).pairs();_(groups).each(function(groupItems,groupName){this.updateOrderDependency(groupItems);var groupIsCorrect=_(groupItems).all(function(item){return item._isCorrectWithOrderDependency()},this),checkUntilIndex=_(groupCorrectIndexesPairs).findIndex(function(g){return _.first(g)===groupName},this),groupIsRepeat=_(groupCorrectIndexesPairs).chain().first(checkUntilIndex+1).some(function(g){return _.first(g)!==groupName&&_.last(g)===groupCorrectIndexes[groupName]},this).value();this.groups[groupName]=groupIsCorrect&&!groupIsRepeat},this)}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapCollection"),a5.models.interaction.ICTextGap={init:function(parameters,defaults){this._super(parameters,$.extend({prefill:!1,value:"",correct:[],ignorePunctuation:!1,ignoreCase:!1,ignoreSpaces:!1,ignoreAccents:!1,allowRepeat:!0,hasOrderedResponses:!1,group:!1,blockNumber:0,enumeration:null,display_words:[],distractors:[],wordpool:{},global_enumeration:!1,length:10,tryAgainKeep:!1,area:null,spellcheck:!1,resizeGaps:!1,charactersNumber:!1,tryAgainIsFrozen:!1,inputStyle:null},defaults)),this.state="input"},isCorrect:function(){var items;return this.group&&this.hasOrderedResponses?this._isCorrectWithOrderDependencyGroups():this.group&&!this.allowRepeat?(items=_(this.parent.itemList).filter(function(item){return item.blockNumber===this.blockNumber&&item.group===this.group},this),this._isCorrectWithRepeatPrevent(items)):this.hasOrderedResponses?this._isCorrectWithOrderDependency():this.allowRepeat?this._isCorrect():(items=_(this.parent.itemList).filter(function(item){return item.blockNumber===this.blockNumber},this),this._isCorrectWithRepeatPrevent(items))},_isCorrect:function(){return a5.utils.containsAnswer(this.value,this.correct,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces)},_isCorrectWithOrderDependency:function(){return this.parent.position>=0&&a5.utils.checkUserInput(this.value,this.correct[this.parent.position],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces)},_isCorrectWithRepeatPrevent:function(items){var totalCorrectInAnswer=a5.utils.countAnswer(this.value,this.correct,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces),totalCorrect=this.correct.length,checkUntilIndex=_(items).indexOf(this),correctAnswers=_(items).chain().first(checkUntilIndex+1).filter(function(item){return item._isCorrect()&&a5.utils.containsAnswer(this.value,[item.value],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces)},this).value();return this._isCorrect()&&(totalCorrectInAnswer===totalCorrect||correctAnswers.length<=totalCorrectInAnswer)},_isCorrectWithOrderDependencyGroups:function(){return this.parent.groups[this.group]},getCorrect:function(){var correct;return correct=this.value&&this.isCorrect()?this.value:this._findCorrect(),this._replaceSyntax(correct)},getAnswers:function(){return this.getCorrect()},_replaceSyntax:function(correct){return correct.replace("%0"," ")},_findCorrect:function(){var items;return this.group&&this.hasOrderedResponses?this._getCorrectWithOrderDependencyGroups(this.parent.itemList):this.group&&!this.allowRepeat?(items=_(this.parent.itemList).filter(function(item){return item.blockNumber===this.blockNumber&&item.group===this.group},this),this._getCorrectWithRepeatPrevent(items)):this.hasOrderedResponses?this._getCorrectWithOrderDependency():this.allowRepeat?this._getCorrect():(items=_(this.parent.itemList).filter(function(item){return item.blockNumber===this.blockNumber},this),this._getCorrectWithRepeatPrevent(items))},_getCorrect:function(index){return this.correct.length>0&&this.correct[index||0]||""},getCorrectWithoutEmpty:function(){var correct;return correct=this.value&&this.isCorrect()?this.value:this._findCorrect(),this._replaceSyntax(correct)},getMaskPattern:function(){var correct=this.getCorrectWithoutEmpty();return correct?correct.replace(/\S/g,"*"):"*"},_getCorrectWithOrderDependency:function(){return this._getCorrect(this.parent.position)},_getCorrectWithRepeatPrevent:function(items){var correct=this.correct.slice(0);return correct.length>1&&(items=_(items).without(this),_(items).each(function(item){var answer=item.isCorrect()?item.value:item.correctAnswer,correctIndex=a5.utils.indexOf(answer,correct,!0,item.ignorePunctuation,item.ignoreAccents,item.ignoreSpaces);correctIndex>=0&&correct.splice(correctIndex,1)},this)),this.correctAnswer=_(correct).first()||_(this.correct).first(),this.correctAnswer},_getCorrectWithOrderDependencyGroups:function(items){var groups=_(items).groupBy(function(g){return g.group}),correct=this.correct.slice(0);correct.length>1&&(items=_(groups).chain().mapObject(function(group){return _.first(group)}).values().value(),_(items).each(function(item){if(item.group!==this.group){var answer=item.isCorrect()?item.value:item.correctAnswer,itemCorrectIndex=a5.utils.indexOf(answer,item.correct,!0,item.ignorePunctuation,item.ignoreAccents,item.ignoreSpaces),correctIndex=a5.utils.indexOf(this.correct[itemCorrectIndex],correct,!0,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces);correctIndex>=0&&correct.splice(correctIndex,1)}},this)),this.correctAnswer=this.correctAnswer||_(correct).first()||_(this.correct).first();var index=a5.utils.indexOf(this.correctAnswer,this.correct,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces);return _(groups[this.group]).each(function(item){item.correctAnswer=item._getCorrect(index)}),this.correctAnswer},correctText:function(){return this.correct.join(", ")},wrongText:function(){return this.value},setValue:function(value){this.value=value,a5.mainBuilder.updateScoresAsync()},isFilled:function(){return!_.isUndefined(this.value)&&this.value.trim().length>0},isCorrectable:function(){return!this.isDistractor()&&!this.prefill},isDistractor:function(){return _.isEmpty(this.correct)},store:function(){return this.value},restore:function(data){this.value="",_.isString(data)&&(this.value=data),this.setState("input")},getScores:function(){var score=new a5.Score;return this.isCorrectable()&&(score.incTotal(),this.isFilled()&&score.incFilled(),this.isCorrect()&&score.incCorrect()),score},tryAgain:function(){this.isCorrect()||this.tryAgainKeep||(this.value=""),this._super()},setAnswer:function(){this.hasOrderedResponses&&(this.group?this.parent.updateOrderDependencyGroups():this.parent.updateOrderDependency()),this._super()},showNextAnswer:function(){this.showAnswer(),this.trigger("next_answer")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGap"),a5.models.interaction.ICMathCollection={init:function(parameters,defaults){this._super(parameters,$.extend({showAnswerBehaviour:!1},defaults)),this.items=this.parent.itemList,this.position=0,_.bindAll(this,"getItemFromIndex")},showAnswers:function(){return this.showAnswerBehaviour&&_.every(this.itemList(),function(item){return null!==item.defaultValue})},itemList:function(){return _.chain(this.items).pluck("itemList").flatten().value()},getItemFromIndex:function(index){return this.itemList()[index]},getItemsFromBlockIndex:function(index){return this.items[index].itemList},currentBlockIndex:function(index){return this.items.length-1},checkForCrossReference:function(index,indexes){var item=this.getItemFromIndex(index);if(_.intersection(item.directlyAffectedBy,indexes).length){var refs=_.chain([indexes,index]).flatten().without(void 0,null).value();throw Error("circular dependency on between "+refs.join(", "))}return!1},updateDependency:function(){_.chain(this.itemList()).each(function(item){item.updateDirectlyAffectedBy()}).each(function(item){item.updateAffectedBy()}).each(function(item){item.affectedBy=_.unique(item.affectedBy.reverse())}).each(function(item){item.updateAffects()})}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICMathCollection"),a5.models.interaction.ICMath={CELL_REGEXPS:{ANY:/^[-]?([0-9]*(\.|,)[0-9]+|[0-9]+)$/g,INTEGER:/^[-]?[0-9]*$/g,NATURAL:/^[0-9]*$/g},init:function(parameters,defaults){this._super(parameters,$.extend({prefill:!1,value:"",formula:"",ignoreSpaces:!1,preventRepeat:!0,enumeration:null,global_enumeration:!1,defaultValue:null,numberInput:null,tryAgainKeep:!1,tryAgainIsFrozen:!1,result:!1,affectedBy:null,affects:[],referenceDependency:!1,inputStyle:null},defaults)),_.bindAll(this,"_isAffectedByMe","_dependencySorting"),this.index=this.parent.itemList().length,this.blockIndex=this.parent.currentBlockIndex(),this.state="input",this.regexp=this._correctRegExp(this.numberInput)},updateDirectlyAffectedBy:function(){for(var group,regexp=/(x)(\d+)/g,list=[];null!==(group=regexp.exec(this.formula));)list.push(parseInt(group[2],10)-1);this.preventRepeat&&(list=list.concat(_.pluck(this.previousItemsInMyBlock(),"index"))),this.directlyAffectedBy=_.unique(list)},previousItemsInMyBlock:function(){return _.filter(this.parent.getItemsFromBlockIndex(this.blockIndex),function(el){return el.index<this.index},this)},updateAffectedBy:function(origin){var affectedBy=this.directlyAffectedBy;return this.referenceDependency?this.affectedBy=_.chain(affectedBy).map(_.bind(function(index){if(!this.parent.checkForCrossReference(index,[this.item,origin])){var item=this.parent.getItemFromIndex(index);return[index].concat(item.affectedBy||item.updateAffectedBy(origin||this.index))}},this)).flatten().without(void 0,null).value():this.affectedBy=affectedBy},updateAffects:function(){this.affects=_.chain(this.parent.itemList()).filter(this._isAffectedByMe).pluck("index").value().sort(this._dependencySorting)},_isAffectedByMe:function(item){return _.contains(item.affectedBy,this.index)},_dependencySorting:function(index1,index2){var item1=this.parent.getItemFromIndex(index1),item2=this.parent.getItemFromIndex(index2),dist1=item1.affectedBy.length-item1.affectedBy.indexOf(this.index)-1,dist2=item2.affectedBy.length-item2.affectedBy.indexOf(this.index)-1;return dist1<dist2?-1:dist2<dist1?1:0},isCorrect:function(){return this.result},_correctRegExp:function(inputType){var upperCase=inputType.toUpperCase(),type=_.chain(this.CELL_REGEXPS).keys().contains(upperCase).value()?upperCase:"NATURAL";return this.CELL_REGEXPS[type]},getCorrect:function(){return this.isCorrect()?this.value:this.defaultValue||""},setValue:function(value){this.value!==value&&(this.value=value,this.updateResult(),this.updateResultOfAffected(),a5.mainBuilder.updateScoresAsync())},updateResult:function(){var result=!1;if(this.value){var rightFormat=0!==_.compact(this.value.match(this.regexp)).length,repeated=this.preventRepeat&&this.isRepeated();if(rightFormat&&!repeated){var expression=this.formula.replace(/x(?!\d+)/g,"x"+(this.index+1)),itemsToReplace=_.uniq(expression.match(/x\d+/g))||[];_.each(itemsToReplace,_.bind(function(variab){var varIndex=parseInt(variab.replace("x",""),10),item=this.parent.getItemFromIndex(varIndex-1),value=item.value?item.getValue().replace(",","."):NaN.toString();(value&&item===this||!this.referenceDependency||item.result)&&(expression=expression.replace(new RegExp("x"+varIndex+"(?!\\d)","g"),value))},this)),-1===expression.indexOf("x")&&(result=this.runMathExpression(expression))}}this.result=result},runMathExpression:function(expression){try{return a5.utils.MathParser.memoParse(expression.trim())}catch(e){logger.warn("Syntax error in expression: ",expression)}},isRepeated:function(){return _.chain(this.previousItemsInMyBlock()).pluck("value").compact().contains(this.value).value()},updateResultOfAffected:function(){_.chain(this.affects).map(this.parent.getItemFromIndex).invoke("updateResult")},getValue:function(){return this.ignoreSpaces?a5.utils.removeSpaces(this.value):this.value},isFilled:function(){return!_.isUndefined(this.value)&&this.value.trim().length>0},store:function(){return this.value},getScores:function(){var score=new a5.Score;return this.prefill||(score.incTotal(),this.isFilled()&&score.incFilled(),this.isCorrect()&&score.incCorrect()),score},tryAgain:function(){this.isCorrect()||this.tryAgainKeep||(this.value=""),
this._super()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICMath"),a5.models.interaction.ICMathQuizz={init:function(parameters,defaults){this._super(parameters,$.extend({xml:"",questionObject:{},questionInstance:{},answerObject:{}},defaults)),this.wirisBuilder=com.wiris.quizzes.api.QuizzesBuilder.getInstance(),this.questionObject=this.wirisBuilder.readQuestion(this.xml),this.questionInstance=this.wirisBuilder.newQuestionInstance(this.questionObject)},setValue:function(value){this.value=value,a5.mainBuilder.updateScoresAsync()},isCorrectable:function(){return!_.isEmpty(this.questionObject)},isFilled:function(){if(!_.isEmpty(this.value))try{var xml=$($.parseXML(this.value)).text();return!(_.isEmpty(xml)||"[]"===xml)}catch(e){return!0}return!1},isCorrect:function(){return this.isFilled()&&this._isCorrect(this.value,this.getCorrect())},_isCorrect:_.memoize(function(studentAnswer,correctAnswer){var request=this.wirisBuilder.newEvalRequest(correctAnswer,studentAnswer,this.questionObject,this.questionInstance),service=this.wirisBuilder.getQuizzesService(),response=service.execute(request);return this.questionInstance.update(response),1===this.questionInstance.getAnswerGrade(0,0,this.questionObject)},function(studentAnswer,correctAnswer){return JSON.stringify([studentAnswer,correctAnswer])}),getScores:function(){var score=new a5.Score;return this.isCorrectable()&&(score.incTotal(),this.isFilled()&&score.incFilled(),this.isCorrect()&&score.incCorrect()),score},getCorrect:function(){return this.questionObject.getCorrectAnswer(0)},store:function(){return this.value},restore:function(data){_.isString(data)&&this.setValue(data),this.setState("input")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICMathQuizz"),a5.models.interaction.ICTextGapInvisible={init:function(parameters,defaults){this._super(parameters,$.extend({},defaults)),this.state="input",this.nodes=[]},push:function(node){this.nodes.push(node)},peek:function(peek){return 0==this.nodes.length?new Obj:this.nodes[this.nodes.length-1]},setState:function(state){this.state=state,_.each(this.nodes,function(node){node.callViews("updateState")})},getScores:function(){var score=new a5.Score;return _.each(this.nodes,function(node){node.getScores(score)}),score},setAnswer:function(){this.setState("feedback")},showAnswer:function(){this.setState("answers")},tryAgain:function(){_.each(this.nodes,function(node){node.isInput()&&!node.isCorrect()&&node.setValue("")}),this.setState("input")},store:function(){var items=[];return _.each(this.nodes,function(node,i){node._instance_of("a5.models.interaction.ICTextGapInvisibleGap")&&""!=node.value&&(items[i]=node.value)}),items},restore:function(data){_.each(this.nodes,function(node,i){node._instance_of("a5.models.interaction.ICTextGapInvisibleGap")&&data[i]&&node.setValue(data[i])})}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapInvisible"),a5.models.interaction.ICTextGapInvisibleText={init:function(parameters,defaults){this._super(parameters,$.extend({word:"word"},defaults))},getScores:function(){},isInput:function(){return!1}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapInvisibleText"),a5.models.interaction.ICTextGapInvisibleGap={init:function(parameters,defaults){this._super(parameters,$.extend({value:"",answers:[]},defaults))},isInput:function(){return!0},setValue:function(value){this.value=value,this.callViews("updateValue"),a5.mainBuilder.updateScoresAsync()},isCorrect:function(){return a5.utils.containsAnswer(this.value,this.answers)},isFilled:function(){return this.value.length>0},hasAnswer:function(){return this.answers.length>0},getScores:function(score){this.prefill||(this.hasAnswer()&&(score.incTotal(),this.isCorrect()&&score.incCorrect()),this.isFilled()&&score.incFilled())}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapInvisibleGap"),a5.models.interaction.ICTextCorrectionLine={init:function(parameters,defaults){this._super(parameters,$.extend({answers:[],blockEnumeration:null,prefilled:!1,signalErrorsEnabled:!1,signalErrorsAlways:!1,tryAgainKeep:!1,ignoreCase:!1,ignorePunctuation:!1,ignoreAccents:!1,subtractIncorrect:!1,userSelection:!1,checkboxUserAction:!1,inputUserAction:!1},defaults)),this.state="input",this.nodes=[],this.checked=!1,this.value="",this.gotSignaled=!1,this.userSelection&&"off"!=this.userSelection||(this.userSelection="select_for_error")},signalErrors:function(validate){validate&&(this.isCheckCorrect()||(this.gotSignaled=!0)),this.signalErrorsEnabled=!0,_.each(this.nodes,function(node){node.callViews("updateState")}),this.callViews("updateState")},hideSignalErrors:function(validate){validate&&(this.isCheckCorrect()||(this.gotSignaled=!1)),this.signalErrorsEnabled=!1,_.each(this.nodes,function(node){node.callViews("updateState")}),this.callViews("updateState")},push:function(node){this.nodes.push(node)},peek:function(peek){return 0==this.nodes.length?new Obj:this.nodes[this.nodes.length-1]},setChecked:function(checked){this.checked=checked,this.checkboxUserAction=!0,a5.mainBuilder.updateScoresAsync()},setValue:function(value){this.value=value,a5.mainBuilder.updateScoresAsync()},setState:function(state){this._super(state),_.each(this.nodes,function(node){node.setState(state)}),this.callViews("updateState")},isCheckCorrect:function(){return"select_for_error"==this.userSelection?this.hasAnswer()&&this.checked||!this.hasAnswer()&&!this.checked:"select_for_correct"==this.userSelection?!this.hasAnswer()&&this.checked||this.hasAnswer()&&!this.checked:void 0},isCorrect:function(){var containsAnswer=a5.utils.containsAnswer(this.value,this.answers,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents);return"select_for_error"==this.userSelection?this.isCheckCorrect()&&(containsAnswer||!this.hasAnswer()&&!this.isFilled()):"select_for_correct"==this.userSelection?this.hasAnswer()&&this.isCheckCorrect()&&containsAnswer||!this.hasAnswer()&&!this.isFilled()&&this.isCheckCorrect():void 0},isFilled:function(){return this.checked&&this.value.length>0},hasAnswer:function(){return this.answers.length>0&&!this.prefilled},getScores:function(){var score=new a5.Score;return"select_for_error"==this.userSelection&&this.hasAnswer()&&(this.signalErrorsAlways?(score.incTotal(),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect()):(score.incTotal(2),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect(),this.isCheckCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect())),"select_for_correct"==this.userSelection&&(score.incTotal(),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect(),this.value.length&&!this.prefilled&&score.incFilled(),!this.hasAnswer()&&this.signalErrorsAlways&&score.decTotal(),!this.hasAnswer()&&this.signalErrorsAlways&&score.decCorrect()),this.isFilled()&&score.incFilled(),this.checked&&!this.signalErrorsAlways&&score.incFilled(),this.prefilled&&score.decTotal(),score},setAnswer:function(){this.setState("feedback")},showAnswer:function(){this.setState("answers")},showNextAnswer:function(){this.showAnswer(),this.trigger("next-answer")},tryAgain:function(){this.tryAgainKeep||this.isCorrect()||(this.setValue(""),this.inputUserAction=!1),this.tryAgainKeep||this.isCheckCorrect()||(this.setChecked(!1),this.checkboxUserAction=!1),this.setState("input")},store:function(){return{value:this.value,checked:this.checked,checkboxUserAction:this.checkboxUserAction,inputUserAction:this.inputUserAction}},restore:function(data){this.value=data.value,this.checked=data.checked,this.checkboxUserAction=data.checkboxUserAction,this.inputUserAction=data.inputUserAction,this.callViews("updateState")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextCorrectionLine"),a5.models.interaction.ICTextCorrectionLineText={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",highlighted:!1,wrong:!1,subtractIncorrect:!1},defaults))},setState:function(state){this._super(state),this.callViews("updateState")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextCorrectionLineText"),a5.models.interaction.ICTextCorrectionSentence={init:function(parameters,defaults){this._super(parameters,$.extend({},defaults))},hasAnswer:function(){return _.any(this.nodes,function(n){return n.hasAnswer()&&!this.prefilled})},isFilled:function(){return this.value!==this.getInitialValue()},setInitialValue:function(){this.value=this.getInitialValue()},getInitialValue:function(){return _.chain(this.nodes).map(function(n){return n.text.trim()}).filter().value().join(" ")},getPermutations:function(start,position){start=start||"",position=position||0;var self=this;if(position<this.nodes.length){var node=this.nodes[position],ret=[];return node.hasAnswer()?_.each(node.answers,function(e){ret=_.union(ret,self.getPermutations(start+e,position+1))}):ret=this.getPermutations(start+node.text,position+1),ret}return[start.replace(/\s+/g," ").trim()]},getScores:function(){var score=new a5.Score;return"select_for_error"==this.userSelection&&this.hasAnswer()&&(this.signalErrorsAlways?(score.incTotal(),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect()):(score.incTotal(2),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect(),this.isCheckCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect())),"select_for_correct"==this.userSelection&&(score.incTotal(),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect(),!this.hasAnswer()&&this.signalErrorsAlways&&score.decTotal(),!this.hasAnswer()&&this.signalErrorsAlways&&score.decCorrect()),this.isFilled()&&score.incFilled(),this.checked&&!this.signalErrorsAlways&&score.incFilled(),this.prefilled&&score.decTotal(),score},getMaxTextRows:function(){return _.max(this.getPermutations().concat(this.getInitialValue()).map(function(text){return text.trim().split("\n").length}))},tryAgain:function(){this.tryAgainKeep||this.isCorrect()||this.setInitialValue(),this.tryAgainKeep||this.isCheckCorrect()||this.setChecked(!1),this.setState("input")},isCorrect:function(){var permutations=this.getPermutations("",0),isCorrectSentence=a5.utils.containsAnswer(this.value,permutations,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents);return this.isCheckCorrect()&&(isCorrectSentence||!this.hasAnswer()&&!this.isFilled())}},a5.models.interaction.ICTextCorrectionLine.extend("a5.models.interaction.ICTextCorrectionSentence"),a5.models.interaction.ICTextCorrectionSentenceText={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",answers:[]},defaults))},hasAnswer:function(){return this.answers.length>0},setState:function(state){this._super(state),this.callViews("updateState")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextCorrectionSentenceText"),a5.model.interaction.ICTextCorrectionReplace={init:function(parameters,defaults){this._super(parameters,$.extend({blockEnumeration:null,signalErrorsEnabled:!1,signalErrorsAlways:!1,ignoreCase:!1,ignorePunctuation:!1,tryAgainKeep:!1,ignoreAccents:!1,state:"input",subtractIncorrect:!1,sharedObject:{},userSelection:!1,checkboxChanged:!1,prefilled:!1},defaults)),this.nodes=[],this.checked=!1},isPrefilled:function(){return _.any(this.nodes,function(node){return node.prefill})},countWrongWords:function(){return _.filter(this.nodes,function(n){return n.needsAnswer()}).length},signalErrors:function(validate){validate&&_.each(this.nodes,function(node){node.answers&&node.needsAnswer()&&!node.isFilled()&&(node.markedBySignal=!0)}),this.signalErrorsEnabled=!0,_.each(this.nodes,function(node){node.callViews("updateState")}),this.callViews("updateState")},hideSignalErrors:function(validate){validate&&_.each(this.nodes,function(node){node.answers&&node.needsAnswer()&&!node.isFilled()&&(node.markedBySignal=!1)}),this.signalErrorsEnabled=!1,_.each(this.nodes,function(node){node.callViews("updateState")}),this.callViews("updateState")},push:function(node){this.nodes.push(node),this.prefilled=this.prefilled||node.prefill},peek:function(peek){return 0==this.nodes.length?new Obj:this.nodes[this.nodes.length-1]},store:function(){var data=[];return _.each(this.nodes,function(node,index){"a5.model.interaction.ICTextCorrectionReplaceText"==node._class_name&&node.isFilled()&&data.push({text:node.text,value:node.value,index:index})}),data},restore:function(data){var self=this;_.each(data,function(data_item){_.find(self.nodes,function(node,index){return node.text==data_item.text&&data_item.index===index}).setValue(data_item.value)}),this.setState("input")},setChecked:function(checked){this.checked=checked,this.checkboxChanged=!0,a5.mainBuilder.updateScoresAsync()},setState:function(state){this._super(state),this.callViews("updateState"),this.trigger("state_update"),this.trigger("state_update:"+state),_.each(this.nodes,function(node){node.setState(state)}),a5.mainBuilder.updateScoresAsync()},hasAnswer:function(){return!_.all(this.nodes,function(node){return _.isUndefined(node.answers)||_.isEmpty(node.answers)})},isCheckCorrect:function(){return!("select_for_error"!=this.userSelection||!this.checked||!this.hasAnswer())||("select_for_error"==this.userSelection&&!this.checked&&!this.hasAnswer()||(!("select_for_correct"!=this.userSelection||!this.checked||this.hasAnswer())||(!("select_for_correct"!=this.userSelection||this.checked||!this.hasAnswer())||void 0)))},getScores:function(){var score=new a5.Score;return _.each(this.nodes,function(node){node.prefill||(node.isFilled&&score.incFilled(node.isFilled()),node.answers&&(score.incTotal(node.needsAnswer()),"select_for_error"==this.userSelection?score.incCorrect(node.isCorrect()&&node.needsAnswer()):"select_for_correct"==this.userSelection?score.incCorrect(node.isCorrect()&&node.needsAnswer()):(score.incTotal(node.needsAnswer()&&!this.signalErrorsAlways),score.incCorrect(node.isCorrect()),score.incCorrect(node.isFilled()&&node.needsAnswer()&&!(node.markedBySignal||this.signalErrorsAlways))),score.decCorrect(this.subtractIncorrect&&node.isFilled()&&!node.isCorrect())))},this),this.isPrefilled()||this.signalErrorsAlways||this.signalErrorsEnabled||("select_for_correct"==this.userSelection&&(this.hasAnswer()||(score.incTotal(),this.checkboxChanged&&score.incFilled()),this.isCheckCorrect()&&!this.hasAnswer()&&score.incCorrect(),this.isCheckCorrect()||this.hasAnswer()||!this.subtractIncorrect||score.decCorrect()),"select_for_error"==this.userSelection&&(this.hasAnswer()&&score.incTotal(),this.checkboxChanged&&score.incFilled(),this.isCheckCorrect()&&this.hasAnswer()&&score.incCorrect(),!this.isCheckCorrect()&&this.hasAnswer()&&this.subtractIncorrect&&score.decCorrect())),this.hasShownSolutionHint()&&score.incRevealed(),"select_for_error"==this.userSelection||"select_for_correct"==this.userSelection||this.signalErrorsAlways||this.signalErrorsEnabled||(score.filled=2*score.filled,score.revealed=2*score.revealed),score.correct<0&&(score.correct=0),score},isCorrect:function(){var nodes=_.filter(this.nodes,function(n){return _.isFunction(n.isCorrect)}),answerable=_.filter(nodes,function(n){return n.needsAnswer()}),correct_answer=_.every(answerable,function(n){return n.isCorrect()})||!this.hasAnswer();return"select_for_correct"==this.userSelection||"select_for_error"==this.userSelection?correct_answer&&this.isCheckCorrect():correct_answer},isFilled:function(){var isFilled=_.some(this.nodes,function(node){return node.isFilled()});return this.isPrefilled()||this.signalErrorsAlways||this.signalErrorsEnabled||("select_for_correct"===this.userSelection&&(this.hasAnswer()||(isFilled=isFilled||this.checkboxChanged)),"select_for_error"===this.userSelection&&(isFilled=isFilled||this.checkboxChanged)),isFilled},setAnswer:function(){this.setState("feedback")},showAnswer:function(){this.setState("answers")},getCandidatesForSolutionHint:function(){return _.filter(this.nodes,function(item){return"answers"!==item.state&&item.needsAnswer()&&!item.isFilled()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.nodes,function(item){return"answers"!==item.state&&item.needsAnswer()&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForValidation:function(){return _.filter(this.nodes,function(item){return"answers"!==item.state&&item.needsAnswer()&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!(_.isEmpty(this.getCandidatesForSolutionHint())&&(this.isFilled()||this.prefilled||this.signalErrorsAlways||this.signalErrorsEnabled||"select_for_correct"!==this.userSelection&&"select_for_error"!==this.userSelection))},hasCandidatesForShowNextAnswer:function(){return!(_.isEmpty(this.getCandidatesForShowNextAnswer())&&(this.prefilled||this.isCheckCorrect()||this.signalErrorsAlways||this.signalErrorsEnabled||"select_for_correct"!==this.userSelection&&"select_for_error"!==this.userSelection))},hasCandidatesForValidation:function(){return!(_.isEmpty(this.getCandidatesForValidation())&&(this.prefilled||this.signalErrorsAlways||this.signalErrorsEnabled||"select_for_correct"!==this.userSelection&&"select_for_error"!==this.userSelection))},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();if(question)question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer();else if(this.hasCandidatesForShowNextAnswer())return this.showAnswer(),void this.trigger("next-answer");this.hasCandidatesForShowNextAnswer()||(this.state="answers",this.trigger("next-answer"))},hasShownSolutionHint:function(){return this.__showingSolutionHint},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();question?(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer(),this.__showingSolutionHint=!0):this.hasCandidatesForSolutionHint()&&(this.showAnswer(),this.trigger("next-answer"),this.__showingSolutionHint=!0),this.hasCandidatesForValidation()||(this.state="answers",this.trigger("next-answer"))},tryAgain:function(){this.tryAgainKeep||_.each(this.nodes,function(node){node.isCorrect&&!node.isCorrect()&&(node.value=node.text)}),this.setState("input")}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICTextCorrectionReplace"),a5.model.interaction.ICTextCorrectionReplaceText={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",prefill:!1,answers:[],markedBySignal:!1,subtractIncorrect:!1},defaults)),this.value=this.text},setValue:function(value){this.value=value,this.callViews("updateValue"),a5.mainBuilder.updateScoresAsync()},needsAnswer:function(){return this.answers.length>0},isFilled:function(){return this.value.trim()!=this.text.trim()},isCorrect:function(){return a5.utils.containsAnswer(this.value,this.answers,this.parent.ignoreCase,this.parent.ignorePunctuation,this.parent.ignoreAccents)},isMarkedCorrect:function(){return this.isFilled()&&this.needsAnswer()},setState:function(state){this._super(state),this.callViews("updateState"),a5.mainBuilder.updateScoresAsync()},showNextAnswer:function(){this.showAnswer(),this.trigger("next_answer")}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICTextCorrectionReplaceText"),a5.model.interaction.ICTextCorrectionReplacePlain={init:function(parameters,defaults){this._super(parameters,$.extend({text:""},defaults))},needsAnswer:function(){return!1},isFilled:function(){return!1}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICTextCorrectionReplacePlain"),a5.model.interaction.ISPelmanismBoard={init:function(parameters){this._super(parameters,{cards:[],found:[],current:[],cardsPerRow:0,cardFormat:"portrait",cardLayout:"default",cardBack:"default",hasPrefill:!1,scorable:!1,autoAudioPlayback:!1,beforeFlipAudioPlayback:!1,tryAgainIsFrozen:!1})},shuffle:function(){this.cards=_(this.cards).shuffle()},addCard:function(parameters){var card=new a5.model.interaction.ISPelmanismCard({content:parameters.html,identifier:parameters.identifier,pair:parameters.pair,back:parameters.back,setNum:parameters.setNum,board:this,autoAudioPlayback:this.autoAudioPlayback,beforeFlipAudioPlayback:this.beforeFlipAudioPlayback,tryAgainIsFrozen:this.tryAgainIsFrozen});card.bind("position:change",this.onChangeCard,this),this.cards.push(card)},onChangeCard:function(position,card,silent){if(a5.mainBuilder.updateScoresAsync(),card.isFaceUp()){if(this.current.push(card),2===this.current.length){var pair=new a5.model.interaction.ISPelmanismPair({card1:this.current[0],card2:this.current[1]});pair.isCorrect()?(this.found.push(pair),this.current=[],this.scorable&&(a5.mainBuilder.updateScoresAsync(),!silent&&this.isCorrect()&&a5.mainBuilder.checkAnswerWithFeedbackAllCorrect())):this.scorable&&!silent&&a5.mainBuilder.updateScoresAsync(),pair.setAnswer(),this.trigger("pair:match",{correct:pair.isCorrect(),card1:pair.card1.identifier,card2:pair.card2.identifier})}}else this.current=[]},canFlip:function(){return"input"!==this.state||this.current.length<2},setVisualOrder:function(cards){this._visualOrderCards=cards},getCandidatesForSolutionHint:function(){return _.filter(this.findMissingPairs(),function(item){return!("answers"===item.card1.state||item.card1.prefill||item.card1.prefilled||"answers"===item.card2.state||item.card2.prefill||item.card2.prefilled)})},getCandidatesForShowNextAnswer:function(){return _.filter(this.findMissingPairs(),function(item){return!("answers"===item.card1.state||item.card1.prefill||item.card1.prefilled||"answers"===item.card2.state||item.card2.prefill||item.card2.prefilled)})},getCandidatesForValidation:function(){return _.filter(this.findMissingPairs(),function(item){return!("answers"===item.card1.state||item.card1.prefill||item.card1.prefilled||"answers"===item.card2.state||item.card2.prefill||item.card2.prefilled)})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){if(!this.canFlip())return _.isUndefined(this.__showNext)||clearTimeout(this.__showNext),void(this.__showNext=setTimeout(_.bind(this.showNextAnswer,this),100));var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer(),this.current[0]!==question.card1&&this.current[0]!==question.card2||(this.current=[])),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){if(!this.canFlip())return _.isUndefined(this.__showNext)||clearTimeout(this.__showNext),void(this.__showNext=setTimeout(_.bind(this.showNextAnswer,this),100));var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer(),this.current[0]!==question.card1&&this.current[0]!==question.card2||(this.current=[])),this.hasCandidatesForValidation()||(this.state="answers"),question},showAnswer:function(){this._super();var missingPairs=this.findMissingPairs();_(missingPairs).each(function(pair,index){setTimeout(function(){pair.showAnswer()},a5.dp.config.pelmanismShowAnswerDelay*index)});var missingCards=_(missingPairs).chain().map(function(p){return[p.card1,p.card2]}).flatten().value(),correctCards=_(this.cards).difference(missingCards);_(correctCards).invoke("showAnswer"),a5.mainBuilder.updateScoresAsync()},findMissingPairs:function(){var pairs={},cards=_(this._visualOrderCards||this.cards).reject(function(card){return _(this.found).some(function(pair){return pair.contains(card)})},this);return _(cards).each(function(card1){var card2Identifier=card1.pair,card2=this.getCardByIdentifier(card2Identifier),id=_([card2Identifier,card1.identifier]).sortBy(function(id){return id}).join("-");_.isEmpty(pairs[id])&&card1&&card2&&(pairs[id]=new a5.model.interaction.ISPelmanismPair({card1:card1,card2:card2})),pairs[id].setMissing()},this),_(pairs).values()},getScores:function(){var score=new a5.Score;if(this.scorable){var totalPairs=this.cards.length/2;_(totalPairs).times(function(){score.incTotal()});var totalFound=this.found.length;if(_(totalFound).times(function(){score.incCorrect(),score.incFilled()}),2===this.current.length){var lastFound=_.last(this.found);lastFound&&lastFound.card1===this.current[0]&&lastFound.card2===this.current[1]||score.incFilled()}}return score},isCorrect:function(){return this.found.length>=this.cards.length/2},isFilled:function(){return this.found.length>0},store:function(){return{found:_.map(this.found,function(pair,i){return pair.card1.identifier})}},restore:function(data){this.found=[];var found=data.found;_.each(found,function(identifier){var card1=this.getCardByIdentifier(identifier),card2=card1.findPair();new a5.model.interaction.ISPelmanismPair({card1:card1,card2:card2}).flip(!0)},this)},getCardByIdentifier:function(identifier){return _(this.cards).find(function(card){return card.identifier===identifier})},isMissing:function(card){return _(this.found).some(function(pair){return pair.contains(card)})},setPrefill:function(){if(this.hasPrefill){var card1=_(this.cards).first(),card2=card1.findPair();card1.setPrefill(),card2.setPrefill()}}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ISPelmanismBoard"),a5.model.interaction.ISPelmanismPair={card1:null,card2:null,init:function(parameters){_.extend(this,parameters||{}),this.card1.setPair(this),this.card2.setPair(this)},flip:function(silent){this.card1.flip(silent),this.card2.flip(silent)},flop:function(){this.card1.flop(),this.card2.flop()},isPaired:function(){return this.card1.identifier===this.card2.pair},isFaceUp:function(){return this.card1.isFaceUp()&&this.card2.isFaceUp()},isCorrect:function(){return this.isFaceUp()&&this.isPaired()},isFilled:function(){return this.isFaceUp()},addFirst:function(card){this.card1=card},addSecond:function(card){this.card2=card},contains:function(card){return _.isEqual(this.card1,card)||_.isEqual(this.card2,card)},setAnswer:function(){this.card1.setAnswer(),this.card2.setAnswer()},showAnswer:function(){this.card1.showAnswer(),this.card2.showAnswer()},setMissing:function(){this.card1.setMissing(),this.card2.setMissing()}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ISPelmanismPair"),a5.model.interaction.ISPelmanismCard={init:function(parameters){this._super(parameters,{position:"facedown",content:null,identifier:null,pair:null,currentPair:null,board:null,setNum:0,back:null,prefill:!1,autoAudioPlayback:!1,beforeFlipAudioPlayback:!1,tryAgainIsFrozen:!1})},flip:function(silent){this.board.canFlip()&&this._setPosition("faceup",silent)},flop:function(){this.currentPair=null,this._setPosition("facedown")},isFaceDown:function(){return"facedown"===this.position},isFaceUp:function(){return"faceup"===this.position},findPair:function(){return this.board.getCardByIdentifier(this.pair)},setPair:function(pair){this.currentPair=pair},setMissing:function(){this.currentPair=null},isCorrect:function(){return this.currentPair&&this.currentPair.isCorrect()},isFilled:function(){return this.currentPair&&this.currentPair.isFilled()},setAnwer:function(){this.position="faceup",this._super()},tryAgain:function(){this.position="facedown",this.currentPair=null,this.board.current=[],this._super()},showAnswer:function(){this.position="faceup",this._super()},setPrefill:function(){this.prefill=!0},_setPosition:function(position,silent){this.position!==position&&(this.position=position,this.trigger("position:change",position,this,silent))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ISPelmanismCard"),a5.model.interaction.PPFlashcards={init:function(parameters,defaults){this._super(parameters,$.extend({autoAudioPlayback:!1,beforeFlipAudioPlayback:!1},defaults)),this.cards=[]},addCard:function(params){this.cards.push(new a5.model.interaction.PPFlashcardsCard($.extend(params,{parent:this,autoAudioPlayback:this.autoAudioPlayback,beforeFlipAudioPlayback:this.beforeFlipAudioPlayback})))},getScores:function(){var score=new a5.Score,finished=this.areAllFilled();return score.incTotal(),score.incCorrect(finished),score.incFilled(finished),score},store:function(){return _.map(this.cards,function(card){return card.store()})},restore:function(params){_.each(this.cards,function(card,index){params[index]&&card.restore(params[index])},this)},isFilled:function(){return _.some(this.cards,function(card){return card.isFilled()})},areAllFilled:function(){return _.every(this.cards,function(card){return card.isFilled()})}},a5.models.interaction.BaseModel.extend("a5.model.interaction.PPFlashcards"),a5.model.interaction.PPFlashcardsCard={init:function(parameters,defaults){this._super(parameters,$.extend({front:$("front"),back:$("back"),flipped:!1,autoAudioPlayback:!1,beforeFlipAudioPlayback:!1},defaults)),this.flipCount=0},flip:function(){this.flipped=!this.flipped,this.flipCount++,this.trigger("flipped"),a5.mainBuilder.updateScoresAsync()},setFlipped:function(flipped){this.flipped=flipped,this.trigger("update_flipped")},store:function(){return{count:this.flipCount,flipped:this.flipped}},restore:function(param){this.flipCount=param.count,this.setFlipped(param.flipped),a5.mainBuilder.updateScoresAsync()},isFilled:function(){return this.flipCount>0}},a5.models.interaction.BaseModel.extend("a5.model.interaction.PPFlashcardsCard"),a5.model.interaction.PPSlideshow={init:function(parameters,defaults){this._super(parameters,$.extend({step:1,magnifyStart:"70%",magnifyEnd:"90%",delay:2,minTime:2,maxTime:10,shuffle:!1,automaticControl:!1,magnifySlides:!1,shuffleControl:!1,additionalImageControl:!1,endingTime:.4},defaults)),this.slides=[],this.delay=_.min([this.delay,this.maxTime]),this.delay=_.max([this.delay,this.minTime])},addSlide:function(params){this.slides.push(new a5.model.interaction.PPSlideshowSlide($.extend(params,{parent:this})))},goFirst:function(){this.goTo(0)},goLast:function(){this.goTo(this.slides.length-1)},goNext:function(){this.goTo(this.curSlide+1)},goPrev:function(){this.goTo(this.curSlide-1)},goTo:function(index){if(index>=0&&index<this.slides.length){var oldSlide=this.slides[this.curSlide];this.curSlide=index,this.trigger("change:slide",oldSlide,this.slides[index])}},play:function(silent){this.playing=!0,this.magnifySlides&&(this.stopMagnifyAll(),this.startMagnify()),this.timer=setInterval(_.bind(function(){this.trigger("slide:ending",this.slides[this.curSlide]),_.delay(_.bind(function(){this.curSlide===this.slides.length-1?(this.goFirst(),this.pause()):(this.goNext(),this.magnifySlides&&this.startMagnify())},this),1e3*this.endingTime)},this),1e3*(this.delay-this.endingTime)),silent||this.trigger("slide:playing")},pause:function(silent){this.playing=!1,clearInterval(this.timer),silent||this.trigger("slide:paused")},interrupt:function(){this.pause(!0),this.play(!0)},incDelay:function(){this.setDelay(_.min([this.delay+this.step,this.maxTime]))},decDelay:function(){this.setDelay(_.max([this.delay-this.step,this.minTime]))},setDelay:function(delay){delay>0&&(this.delay=delay,this.trigger("change:delay",this.delay))},shuffleOrder:function(){this.originalSlides=this.slides,this.slides=_(this.slides).shuffle(),this.goTo(this.curSlide)},defaultOrder:function(){this.slides=this.originalSlides||this.slides,this.goTo(this.curSlide)},startMagnify:function(){var magnifyStart=this._parseTime(this.magnifyStart,this.delay);_.delay(_.bind(this.magnify,this),1e3*magnifyStart)},stopMagnify:function(){this.playing&&this.trigger("slide:magnify:stop",this.slides[this.curSlide])},stopMagnifyAll:function(){_(this.slides).each(function(slide){
this.trigger("slide:magnify:stop",slide)},this)},magnify:function(){if(this.playing){this.trigger("slide:magnify:start",this.slides[this.curSlide]);var magnifyStart=this._parseTime(this.magnifyStart,this.delay),magnifyEnd=this._parseTime(this.magnifyEnd,this.delay);_.delay(_.bind(this.stopMagnify,this),1e3*(magnifyEnd-magnifyStart))}},_parseTime:function(time,ref){return/^\d+%$/.test(time)?ref*parseInt(time,10)/100:time}},a5.models.interaction.BaseModel.extend("a5.model.interaction.PPSlideshow"),a5.model.interaction.PPSlideshowSlide={init:function(parameters,defaults){this._super(parameters,$.extend({content:"",decode:""},defaults))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.PPSlideshowSlide"),a5.models.interaction.RadioAccordion={init:function(parameters,defaults){this._super(parameters,$.extend({alignment:"horizontal"},defaults)),this.children=[]},append:function(child){this.children.push(child)},getScores:function(){return new a5.Score},store:function(){var data={children:[]};return _.each(this.children,function(child){data.children.push(child.store())},this),data},restore:function(data){data&&data.children&&_.each(this.children,function(child,i){child.restore(data.children[i])},this)}},a5.models.interaction.BaseModel.extend("a5.models.interaction.RadioAccordion"),a5.models.interaction.RadioAccordionElement={init:function(parameters,defaults){this._super(parameters,$.extend({selected:!1,content:null,alertNode:null,enumeration:null},defaults))},activate:function(){this.trigger("before_activate"),this.active=!0,this.trigger("change:active")},deactivate:function(){this.active=!1,this.trigger("change:active")},store:function(){return{active:this.active}},restore:function(data){data&&data.active&&this.activate()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.RadioAccordionElement"),a5.models.interaction.IMVoice={init:function(parameters,defaults){this._super(parameters,$.extend({text:""},defaults)),this.recording=new a5.models.interaction.SpeakingRecording({parent:this.parent}),_.bindAll(this,"_getSTT","_onSuccess","_onFail")},store:function(){},restore:function(){},speechToText:function(){var inputs=[],clips=[];_(this.recording.records[0]).each(function(snippet){inputs.push(a5.service.media.audio_recorder.instance().buildUrl(snippet)),clips.push({input:inputs.length-1})}),$.when(inputs,clips).then(this._getSTT).then(this._onSuccess,this._onFail)},isFilled:function(){return this.recording.isFilled()},_getSTT:function(inputs,clips){return a5.service.media.stt.convert(inputs,clips)},_onSuccess:function(data){this.trigger("speech:result",data)},_onFail:function(){this.trigger("speech:error")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.IMVoice"),a5.models.NotesModel={init:function(){this.notes=[],this.nextNoteNumber=1},store:function(){var data=[];return _.each(this.notes,function(n){data.push([n.title,n.text,n.date])}),data},restore:function(data){data&&_.each(data,function(e){this.addNote(e[0],e[1])},this)},addNote:function(title,text){title=title||"Untitled note "+this.nextNoteNumber++;var note=new a5.models.NoteModel(this);this.notes.push(note),this.trigger("add",this.notes.length-1),note.setTitle(title),note.setText(text)},removeAll:function(){for(;this.notes.length>0;)this.notes[this.notes.length-1].remove()}},a5.models.interaction.BaseModel.extend("a5.models.NotesModel"),a5.models.NoteModel={init:function(notes){this.notes=notes,this.title="",this.text="",this.date=+new Date},setTitle:function(title,silent){this.title=title,silent||this.notes.trigger("update",_.indexOf(this.notes.notes,this))},setText:function(text){this.text=text||"",this.notes.trigger("update",_.indexOf(this.notes.notes,this))},remove:function(){var index=_.indexOf(this.notes.notes,this);this.notes.notes.splice(index,1),this.notes.trigger("remove",index)}},a5.models.interaction.BaseModel.extend("a5.models.NoteModel"),a5.models.SubtitlesModel={init:function(){this.subtitles=[]},loadSRT:function(string){string=string.replace(/&#62;/g,">"),string=string.replace(/<\/p>/g,""),string=string.replace(/<p>/g,""),string=string.replace(/&#xd;/g,"");var item={};_.each(string.split("\n"),function(line){""==line.trim()?_.isEmpty(item)||(this.subtitles.push(item),item={}):_.isUndefined(item.nb)?item.nb=parseInt(line.trim(),10):_.isUndefined(item.from)?line.indexOf("--\x3e")>=0&&(item.from=this.stringToSeconds(line.split("--\x3e")[0].trim()),item.to=this.stringToSeconds(line.split("--\x3e")[1].trim())):(_.isUndefined(item.text)&&(item.text=""),item.text+=line+"\n")},this),_.isEmpty(item)||4!=_.size(item)||this.subtitles.push(item)},empty:function(){return 0==this.subtitles.length},all:function(){return this.subtitles},stringToSeconds:function(string){var date=_.map(string.split(":"),function(e){return parseFloat(e.replace(",","."))});return 60*date[0]*60+60*date[1]+date[2]},getCurrent:function(time){return _.first(_.compact(_.map(this.subtitles,function(e){if(e.from<=time&&e.to>=time)return e})))},getCurrentIndex:function(time){return _.indexOf(this.subtitles,this.getCurrent(time))},getVTTCues:function(){return _(this.subtitles).map(function(subtitle){return new VTTCue(subtitle.from,subtitle.to,subtitle.text||"")})}},a5.models.interaction.BaseModel.extend("a5.models.SubtitlesModel"),a5.models.Karaoke={init:function(){this.items=[]},add:function($karaoke){this.items.push({from:parseFloat($karaoke.attr("data-from")),to:parseFloat($karaoke.attr("data-to")),node:$karaoke})},empty:function(){return 0===this.items.length},all:function(){return this.items},getCurrent:function(time){return _.first(_.compact(_.map(this.items,function(e){if(e.from<=time&&e.to>=time)return e})))},getCurrentIndex:function(time){return _.indexOf(this.items,this.getCurrent(time))}},a5.models.interaction.BaseModel.extend("a5.models.Karaoke"),a5.models.interaction.IdentifySelectMaze={init:function(parameters,defaults){this._super(parameters,_.defaults(defaults||{},{node:null,step:-1}))},getScores:function(){var score=new a5.Score;score.incTotal();var filter=_.filter($(".image-choice"),function(i){return!_.isUndefined($(i).attr("id"))&&!_.isEmpty($(i).attr("id"))&&$(i).hasClass("checked")});return $(".dir2_view").length-1==filter.length&&(score.incCorrect(),score.incFilled()),score},setAnswer:function(){var node;$(".image-choice").each(function(e,el){void 0!==$(el).attr("id")?$(el).hasClass("checked")?(node=$('<span class="check correct"></span>'),$(el).append(node)):(node=$('<span class="check wrong_2"></span>'),$(el).append(node)):$(el).hasClass("checked")&&(node=$('<span class="check wrong"></span>'),$(el).append(node))})},showAnswer:function(){},tryAgain:function(){},store:function(){return this.step},restore:function(step){this.step=step;var $steps=this.node.find(".dir2_view.notdone");_.each($steps,function(e,index){if(index<=step){var $e=$(e);$e.removeClass("notdone"),index<step?($e.addClass("done"),$e.find(".panel[id]").addClass("flip")):$e.addClass("active")}})}},a5.models.interaction.BaseModel.extend("a5.models.interaction.IdentifySelectMaze"),a5.model.TeamScoring={init:function(team){this.team=team,this.points=0,this.active=!1},inc:function(){this.points++},setActive:function(active){this.active=active}},Obj.extend("a5.model.TeamScoring"),a5.model.Moderator={init:function(teams,observedModel){this.observedModel=observedModel,this.teamScores=_(teams).map(function(team){return new a5.model.TeamScoring(team)}),this.turn=0,this.current().setActive(!0),this.lastFilled=0,this.lastCorrect=0,_.bindAll(this,"onScoreUpdate"),a5.mainBuilder.bind("frequent_score_update",this.onScoreUpdate),a5.mainBuilder.bind("reset",this.onReset,this,{once:!0})},unbindEvents:function(){a5.mainBuilder.unbind("frequent_score_update",this.onScoreUpdate),a5.mainBuilder.unbind("reset",this.onReset)},onReset:function(){this.unbindEvents()},onScoreUpdate:function(){var score=this.observedModel.getScores();score.filled>this.lastFilled&&(score.correct>this.lastCorrect&&this.current().inc(),score.filled===score.total?this.trigger("interaction:teams:finalscore",this.teamScores):this.trigger("interaction:teams:score",this.current()),this.next()),this.lastCorrect=score.correct,this.lastFilled=score.filled},next:function(){var last=this.current();this.turn=(this.turn+1)%this.teamScores.length;var current=this.current();this.trigger("interaction:teams:turn:change",last,current)},current:function(){return this.teamScores[this.turn]},winners:function(){if(!this.teamScores.length)return[];var winnerPoints=_(this.teamScores).max(function(t){return t.points}).points,winners=_(this.teamScores).filter(function(t){return t.points===winnerPoints});return winners.length===this.teamScores.length&&(winners=[]),winners}},Obj.extend("a5.model.Moderator"),a5.CombinedUndoRedoManager={init:function(parameters){this.undoHistory=[],this.redoHistory=[],this.maxLevels=parameters.maxLevels||1,this.annotations=parameters.annotations,this.stage=parameters.stage,this.annotations.bind("change:history",this._onAnnotationsChangeHistory,this),this.stage.bind("change:history",this._onStageChangeHistory,this)},undo:function(){this.canUndo()&&(this.redoHistory.push(this.getState()),this.setState(this.undoHistory.pop()),this.trigger("change:history"))},redo:function(){this.canRedo()&&(this.undoHistory.push(this.getState()),this.setState(this.redoHistory.pop()),this.trigger("change:history"))},setState:function(state){this.fromObject(state),this.trigger("change:state")},getState:function(){return this.serialize()},savePoint:function(){this.undoHistory.push(this.getState()),this.redoHistory=[],this.undoHistory.length>this.maxLevels&&this.undoHistory.splice(0,1),this.trigger("change:history")},canUndo:function(){return this.undoHistory.length>0},canRedo:function(){return this.redoHistory.length>0},serialize:function(){return{annotations:this.annotations.children.slice(0),stage:this.stage.serialize()}},fromObject:function(object){object.stage&&this.stage.setState(object.stage),object.annotations&&this.annotations.setChildren(object.annotations)},_onAnnotationsChangeHistory:function(){this.savePoint()},_onStageChangeHistory:function(){this.savePoint()}},Obj.extend("a5.CombinedUndoRedoManager"),a5.model.ResourcesStage={init:function(parameters){parameters=parameters||{},this.undoHistory=[],this.redoHistory=[],this.maxLevels=parameters.maxLevels||1,this.items=parameters.items||[],this.banks=parameters.banks},add:function(item){this.items.push(item),this.trigger("change")},remove:function(item){var index=this.items.indexOf(item);index>=0&&(this.items.splice(index,1),this.trigger("change"))},empty:function(){this.items=[],this.trigger("change")},getItems:function(){return this.items},getItemById:function(id){return _(this.items).find(function(item){return item.id===id})},getItemsByType:function(type){return _(this.items).filter(function(item){return item.type===type})},getItemsByBankItemId:function(bankItemId){return _(this.items).filter(function(item){return item.bankItemId===bankItemId})},setGrids:function(grids){this.clickToAddGrid=grids.clickToAdd,this.generalGrid=grids.general},resetGrids:function(){this.clickToAddGrid&&this.clickToAddGrid.reset()},undo:function(){this.canUndo()&&(this.redoHistory.push(this.getState()),this.setState(this.undoHistory.pop()),this.trigger("change:history"))},redo:function(){this.canRedo()&&(this.undoHistory.push(this.getState()),this.setState(this.redoHistory.pop()),this.trigger("change:history"))},setState:function(state){this.fromObject(state),this.trigger("change:state")},getState:function(){return this.serialize()},savePoint:function(){this.undoHistory.push(this.getState()),this.redoHistory=[],this.undoHistory.length>this.maxLevels&&this.undoHistory.splice(0,1),this.trigger("change:history")},canUndo:function(){return this.undoHistory.length>0},canRedo:function(){return this.redoHistory.length>0},fromObject:function(object){this.empty(),_(object.items).each(function(item){var bankItem=this.banks.findItemById(item.bankItemId);bankItem&&"keypad"!==item.type&&(item.inline=bankItem.inline);var stageItem;stageItem="numeral-cards"===item.type?new a5.model.CardStageItem(item):new a5.model.ResourceStageItem(item),this.add(stageItem)},this),this.clickToAddGrid.fromObject(object.clickToAddGrid)},serialize:function(){return{items:_(this.items).invoke("serialize"),clickToAddGrid:this.clickToAddGrid.serialize()}}},Obj.extend("a5.model.ResourcesStage"),a5.model.ResourceStageItem={init:function(parameters){var defaults={x:0,y:0,transform:"matrix(1, 0, 0, 1, 0, 0)",path:null,inline:null,type:null,value:0,bankItemId:null};this.id=a5.utils.createUID(),this.fromObject(_.extend(defaults,parameters))},flipHorizontal:function(origin,size){if(origin){var x1=this.x-origin.x,y1=this.y-origin.y,x2=-x1,y2=y1;this.x+=x2-x1-size.width,this.y+=y2-y1}this.matrix=this.matrix.scale(-1,1),this._adjustSubpixel()},flipVertical:function(origin,size){if(origin){var x1=this.x-origin.x,y1=this.y-origin.y,x2=x1,y2=-y1;this.x+=x2-x1,this.y+=y2-y1-size.height}this.matrix=this.matrix.scale(1,-1),this._adjustSubpixel()},rotate:function(origin,size,anticlockwise){var coef=anticlockwise?-1:1;if(origin){var x1=this.x-origin.x,y1=this.y-origin.y,x2=-y1*coef,y2=x1*coef;this.x+=Math.round(10*(x2-x1-(size.height*coef+size.width)/2))/10,this.y+=Math.round(10*(y2-y1-(size.height-size.width*coef)/2))/10}this.matrix=this.matrix.rotate(90*coef),this._adjustSubpixel()},moveTo:function(x,y){this.x=x,this.y=y,this._adjustSubpixel()},fromObject:function(object){_.extend(this,object),this.matrix=new a5.utils.Matrix(a5.utils.parseCSSMatrix(this.transform))},serialize:function(){var data={x:this.x,y:this.y,transform:this.matrix.toString(),path:this.path,type:this.type,bankItemId:this.bankItemId,value:this.value};return"keypad"===this.type&&(data.inline=$("[data-item-id="+this.id+"]").html()),data},getTransformMatrix:function(){return this.matrix.x(this.cssmatrix)},getValue:function(){return this.value},_adjustSubpixel:function(){var translateX=0,translateY=0;Math.floor(this.x)!==Math.round(this.x)&&(translateX=-.5),Math.floor(this.y)!==Math.round(this.y)&&(translateY=-.5),this.x-=translateX,this.y-=translateY,this.matrix=this.matrix.translate(translateX,translateY)}},Obj.extend("a5.model.ResourceStageItem"),a5.model.CardStageItem={faceUp:function(){this.face="up"},faceDown:function(){this.face="down"},isFaceUp:function(){return"up"===this.face},isFaceDown:function(){return"down"===this.face},serialize:function(){return _.extend(this._super(),{face:this.face})}},a5.model.ResourceStageItem.extend("a5.model.CardStageItem"),a5.model.ResourceBankList={init:function(parameters){var availableBanks=parameters.availableBanks,allBanks=parameters.allBanks;this._initBanks(availableBanks,allBanks)},getPreselectedBanks:function(){return _(this.banks).filter(function(bank){return bank.preselected})},getLastPreselectedBank:function(){var banks=this.getPreselectedBanks();return _(banks).last()},getIndexOfSelectedBank:function(banks){banks=banks||this.banks;var index=_(banks).findIndex(function(bank){return bank.selected});return _.max([0,index])},getBankByName:function(name){return _(this.banks).find(function(bank){return bank.name===name})},getBankById:function(id){return _(this.banks).find(function(bank){return bank.id===id})},getBankByIndex:function(index){return this.banks[index]},findItemById:function(itemId){var found;return _(this.banks).each(function(bank){found||(found=bank.findItemById(itemId))}),found},getBanks:function(){return this.banks},updateSelection:function(selection){_(selection).each(function(bank){var b=this.getBankById(bank.id);b.preselected=bank.active,b.selected=!1},this);var bank=this.getLastPreselectedBank();bank&&(bank.selected=!0)},_initBanks:function(availableBanks,allBanks){this.banks=[],_(availableBanks).each(function(availableBank){var bank=_(allBanks).find(function(bank){return bank.name.toLowerCase()===availableBank.name.toLowerCase()});bank&&(bank.selected=availableBank.default_,bank.preselected=availableBank.preSelected,this.banks.push(bank))},this)}},Obj.extend("a5.model.ResourceBankList"),a5.model.ResourceBank={init:function(bank,parent){this.id=_.str.slugify(bank.name),this.name=bank.name,this.parent=parent,this.selected=!1,this.preselected=!1,this._initItems(bank.items)},findItemByName:function(name){var found;return _(this.items).each(function(item){found||(item instanceof a5.model.ResourceBankGroup?found=item.findItemByName(name):item.name===name&&(found=item))}),found},findItemById:function(id){var found;return _(this.items).each(function(item){found||(item instanceof a5.model.ResourceBankGroup?found=item.findItemById(id):item.id===id&&(found=item))}),found},getItems:function(){var items=[];return _(this.items).each(function(item){item instanceof a5.model.ResourceBankGroup?items=items.concat(item.getItems()):items.push(item)},this),items},_initItems:function(items){this.items=[],_(items).each(function(item){"group"===item.type?this.items.push(new a5.model.ResourceBankGroup(item,this,this)):"composite-item"===item.type?this.items.push(new a5.model.ResourceComposedBankItem(item,this,this)):this.items.push(new a5.model.ResourceBankItem(item,this,this))},this)}},Obj.extend("a5.model.ResourceBank"),a5.model.ResourceBankItem={init:function(item,parent,bank){_.extend(this,item),this.id=parent.id+"-"+_.str.slugify(item.name),this.parent=parent,this.bank=bank}},Obj.extend("a5.model.ResourceBankItem"),a5.model.ResourceComposedBankItem={init:function(item,parent,bank){this.id=parent.id+"-"+_.str.slugify(item.name),this.name=item.name,this.value=item.value,this.parent=parent,this.composite=this._initItems(item.composite,bank),this.bank=bank},_initItems:function(names,bank){return _(names).map(function(name){return bank.findItemByName(name)})}},Obj.extend("a5.model.ResourceComposedBankItem"),a5.model.ResourceBankGroup={init:function(group,parent,bank){this.id=parent.id+"-"+_.str.slugify(group.name),this.name=group.name,this.parent=parent,this.bank=bank,this._initItems(group.items)},findItemByName:function(name){return _(this.items).find(function(item){return item.name===name})},findItemById:function(id){return _(this.items).find(function(item){return item.id===id})},getItems:function(){return this.items},_initItems:function(items){this.items=[],_(items).map(function(item){"composite-item"===item.type?this.items.push(new a5.model.ResourceComposedBankItem(item,this,this.bank)):this.items.push(new a5.model.ResourceBankItem(item,this,this.bank))},this)}},Obj.extend("a5.model.ResourceBankGroup"),a5.ResourcesStageGrid={cellSize:7,snap:function(box,center){var offset={x:Math.floor(box.x/this.cellSize)*this.cellSize,y:Math.floor(box.y/this.cellSize)*this.cellSize},dx=(box.x-offset.x)/this.cellSize,dy=(box.y-offset.y)/this.cellSize;return.5===dx&&center&&(dx=box.x<center.x?1:0),.5===dy&&center&&(dy=box.y<center.y?1:0),{x:Math.round(dx)*this.cellSize+offset.x,y:Math.round(dy)*this.cellSize+offset.y,fit:!0}},serialize:function(){},fromObject:function(object){}},Obj.extend("a5.ResourcesStageGrid"),a5.ResourcesStageClickToAddGrid={init:function(parameters){var defaults={cellSize:7,$grid:null,rowHeight:0};_.extend(this,defaults,parameters),this.bounds=this._getBoundingBox(),this.cursor={x:this.bounds.left,y:this.bounds.bottom}},snap:function(box){var current={};return this.cursor.x+box.width>this.bounds.right&&(this.cursor.x=this.bounds.left,this.cursor.y=this.cursor.y-this.rowHeight,this.rowHeight=0),this.cursor.y-box.height<=this.bounds.top&&(this.cursor.y=this.bounds.bottom,this.cursor.x=this.bounds.left,this.rowHeight=0),current.x=this.cursor.x,current.y=this.cursor.y-box.height,current.fit=current.y>=this.bounds.top,current.fit&&(this.cursor.x=current.x+box.width,box.height>this.rowHeight&&(this.rowHeight=box.height)),current},serialize:function(){return{x:this.cursor.x,y:this.cursor.y,rowHeight:this.rowHeight}},fromObject:function(object){this.cursor={x:object.x,y:object.y},this.rowHeight=object.rowHeight},refreshDimensions:function(){this.bounds=this._getBoundingBox()},reset:function(){this.cursor={x:this.bounds.left,y:this.bounds.bottom},this.rowHeight=0},relativeTo:function($parent){var box=this.$grid[0].getBoundingClientRect(),parent=$parent[0].getBoundingClientRect();return{left:box.left-parent.left,top:box.top-parent.top}},_getBoundingBox:function(){return{left:0,top:0,bottom:this.$grid.height(),right:this.$grid.width()}}},Obj.extend("a5.ResourcesStageClickToAddGrid"),a5.views.interaction.BaseView={init:function(model,parent,node){this.model=model,this.parent=parent,this.node=node,this.model&&(this.node.attr("data-model-id",this.model.id),this.model.bind&&this.model.bind("state_update:input",this.unbindAnswerFeedback,this)),this.node.data("mvc-view",this)},$:function(selector){return _.isUndefined(selector)?this.node:this.node.find(selector)},render:function(){return this.node},detachChildren:function(children){_(children||this.children).each(function(child){child.node&&child.node.detach()})},renderChildren:function($target){$target=$target||this.node,_.isString($target)&&($target=this.$($target));var fragment=document.createDocumentFragment();_.each(this.children,function(child){var $node=child.render&&child.render()||child.node;$node&&fragment.appendChild($node[0])}),$target.append(fragment)},addCheck:function(params){var correct=params.correct||!1,width=params.width||200,node=params.parent||this.node,empty=params.empty||!1,tooltip=params.tooltip||!1,interaction=this.getInteractionObject(node)||a5.mainBuilder.curInteraction,hasFeedbackSyntax=!!tooltip&&!!this._getFeedbackTextTooltip(tooltip,correct,interaction),correctTooltip=params.correctTooltip||hasFeedbackSyntax,over=params.over||!1,out=params.out||!1,classes=params.classes||[],check=$('<div class="check"></div>');return check.addClass(classes.join(" ")),node.append(check),correct?check.addClass("correct"):empty?check.addClass("wrong_2"):(check.addClass("wrong"),over&&check.mouseover(over),out&&check.mouseout(out)),!correct||correctTooltip?this.appendTooltip(tooltip,check,width):a5.dp.config.displayFeedbackAfterSeeAnswer&&this._isStateAnswers()&&this.appendTooltip(tooltip,check,width),check},_isStateAnswers:function(){return"answers"===this.model.state||!!$(this.node).attr("class").match(/solution/)},_getFeedbackTextTooltip:function(tooltip,correct,interaction){var tootltipStr=_.isString(tooltip)?tooltip:tooltip.text(),regex=/(#feedback:)(.+)(#)/gm,tooltipIds=tootltipStr.replace(regex,"$2");if(tooltipIds!==tootltipStr){var feedbackId=this._getCorrectFeedbackId(tooltipIds,correct,interaction);return interaction.feedbackText[feedbackId]}},_getCorrectFeedbackId:function(ids,correct,interaction){var allIdentifiers,correctFeedbackIds,incorrectFeedbackIds,seeAnswerFeedbackId;if(allIdentifiers=ids.split("|"),correct?correctFeedbackIds=allIdentifiers[0]:allIdentifiers.length>1?(correctFeedbackIds=allIdentifiers[0],incorrectFeedbackIds=allIdentifiers[1]):incorrectFeedbackIds=allIdentifiers[0],this._isStateAnswers()){var correctSeeAnswerFeedback=this._getSeeAnswerFeedbackId(correctFeedbackIds),incorrectSeeAnswerFeedback=this._getSeeAnswerFeedbackId(incorrectFeedbackIds);if(seeAnswerFeedbackId=correct?correctSeeAnswerFeedback:incorrectSeeAnswerFeedback||correctSeeAnswerFeedback)return seeAnswerFeedbackId}var index=this._isStateAnswers()?Math.max(0,interaction.checkAttempts-1):interaction.checkAttempts;return this._processIdentifierList(correct?correctFeedbackIds:incorrectFeedbackIds,index)},_getSeeAnswerFeedbackId:function(ids){if(ids&&_.isString(ids)){var listofIds=ids.split(",");return listofIds.length>1?listofIds[1]:void 0}},_processIdentifierList:function(idList,index){var identifierList=idList.split(",")[0].split("*");return index=Math.min(identifierList.length-1,index),identifierList[index]},getInteractionObject:function(parentnode){var wrap=(parentnode||this.node,this.node.parents(".content-wrap"));if(wrap.length)return _.find(a5.mainBuilder.intList,function(interaction){return interaction.contentWrap.is(wrap)})},appendTooltip:function(tooltip,$check,width){if(tooltip){width=width||200;var interaction=this.getInteractionObject(this.node)||a5.mainBuilder.curInteraction,feedbackText=this._getFeedbackTextTooltip(tooltip,$check.hasClass("correct"),interaction);if(feedbackText)$check.addClass("has-feedback"),$check.on("click",function(e){e.stopPropagation(),e.preventDefault();var $node=$("<div>");a5.utils.buildModel(interaction,$node,$(feedbackText),!0),this._renderFeedbackText($node,$check,interaction)}.bind(this));else{var toti=$('<div class="tooltip"></div>');$check.append(toti),toti.append(tooltip);var adjustTooltipSize=_.bind(function(){if($check.is(":visible")){var size=toti.naturalSize({position:"relative"},{width:width}),scrollParent=a5.utils.scrollParent(toti);toti.removeClass("left-tooltip right-tooltip above-tooltip below-tooltip"),$check.offset().top+size[1]<scrollParent.top+scrollParent.height?toti.addClass("below-tooltip"):$check.offset().top-size[1]>scrollParent.top?toti.addClass("above-tooltip"):toti.addClass("below-tooltip"),$check.offset().left+size[0]<scrollParent.left+scrollParent.width?toti.addClass("right-tooltip"):$check.offset().left-size[0]>scrollParent.left?toti.addClass("left-tooltip"):toti.addClass("right-tooltip"),a5.callbacks.interaction.unbind("showed",adjustTooltipSize)}},this);a5.callbacks.interaction.bind("showed",adjustTooltipSize,this),_.defer(adjustTooltipSize)}}},_getCheckStateClass:function($check,blockClass){var ret=blockClass;return $check.hasClass("correct")?ret+="--correct":$check.hasClass("wrong")?ret+="--incorrect":ret+="--empty",ret},_renderFeedbackText:function($node,$check,interaction){this._clearFeedbackText(!1),a5.dp.config.specificFeedbackDiv?this._renderFeedbackTextDiv($node,$check):this._renderFeedbackTextDialog($node,$check),interaction.bind("reset",this._onInteractionReset,this),interaction.bind("hide",this._onInteractionHide,this),interaction.displaySpecificFeedback(!0)},_renderFeedbackTextDialog:function($node,$check){$node.dialog({modal:!0,dialogClass:"no-title feedback-text-popup "+this._getCheckStateClass($check,"feedback-text-popup")}).on("dialogclose",this.onFeedbackDialogClose.bind(this))},_renderFeedbackTextDiv:function($node,$check){$node.addClass("feedback-text").addClass(this._getCheckStateClass($check,"feedback-text")),$(a5.dp.config.specificFeedbackDiv).append($node)},_clearFeedbackText:function(dispatch){var interaction=this.getInteractionObject(this.node)||a5.mainBuilder.curInteraction;a5.dp.config.specificFeedbackDiv?this._clearFeedbackTextDiv($(a5.dp.config.specificFeedbackDiv)):this._clearFeedbackTextDialog($("body")),interaction.unbind("reset",this._onInteractionReset,this),interaction.unbind("hide",this._onInteractionHide,this),dispatch&&interaction.displaySpecificFeedback(!1)},_clearFeedbackTextDiv:function($parent){$parent.length>0&&(a5.service.media.pause($parent),$parent.empty())},_clearFeedbackTextDialog:function($parent){var $dialog=$parent.find(".feedback-text-popup");$dialog.length>0&&(a5.service.media.pause($dialog),$dialog.dialog("instance")&&$dialog.dialog("destroy"),$dialog.remove())},_onInteractionReset:function(ev){this._clearFeedbackText(!0)},_onInteractionHide:function(ev){this._clearFeedbackText(!0)},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},onFeedbackDialogClose:function(ev){this._clearFeedbackText(!0)},removeCheck:function(clear){this.node.find(".check").remove(),clear&&this._clearFeedbackText(!0)},bindAnswerFeedback:function(model,opts){opts=opts||{},model=model||{},(model.answerFeedbackId||model.answerFeedback)&&(this.node.addClass("with-view-text"),this.node.find(".check").addClass("has-feedback"),this.showAnswerFeedback=_.bind(function(){$(".view-text").hide(),$(".view-text-active").removeClass("view-text-active"),opts.showWhenCorrect||!opts.correct||this._isStateAnswers()&&a5.dp.config.displayFeedbackAfterSeeAnswer?(model.answerFeedbackId&&$("#view-text-"+model.answerFeedbackId).show().focus(),this.node.addClass("view-text-active"),$("#answer-feedback").html(model.answerFeedback||"").trigger("update")):$("#answer-feedback").empty().trigger("update")},this),this.node.on("click",this.showAnswerFeedback))},hideAnswerFeedback:function(){$(".view-text").hide(),$(".view-text-active").removeClass("view-text-active")},unbindAnswerFeedback:function(){this.showAnswerFeedback&&($(".view-text").hide(),$(".view-text-active").removeClass("view-text-active"),this.node.off("click",this.showAnswerFeedback),this.showAnswerFeedback=null)},updateFeedbackState:function(nodes){this.checkLocked(nodes),nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct");var type;if("feedback"==this.model.state)type="checked";else{if("answers"!=this.model.state)return;type="solution"}this.model.isCorrect()?nodes.addClass([type,"correct"].join("-")):!this.model.isFilled||this.model.isFilled()?nodes.addClass([type,"incorrect"].join("-")):nodes.addClass([type,"empty"].join("-"))},checkLocked:function(node){(this.model.tryAgainBehaviour?this.model.tryAgainBehaviour.lock:this.model.tryAgainIsFrozen)&&((node||this.node).filter(".checked-correct").addClass("checked-correct-locked"),(node||this.node).filter(":not(.checked-correct)").removeClass("checked-correct-locked"))},isLocked:function(node){return(node||this.node).hasClass("checked-correct-locked")},delegateEvents:function(){var events=_.result(this,"domEvents"),eventSplitter=/^(\S+)\s*(.*)$/;events&&_.each(events,function(v,k){var method=_.isFunction(v)?v:this[v];if(method){var match=k.match(eventSplitter),eventName=match[1],selector=match[2];method=_.bind(method,this),_.isEmpty(selector)?this.$().on(eventName,method):this.$().on(eventName,selector,method)}},this)},util:{maxViewSizeOfModel:function(model,minWidthHeight){var self=this,min=[];return minWidthHeight.length>1?min.push(minWidthHeight[0],minWidthHeight[1]):min.push(0,0),$.isArray(model)?_.each(model,function(m){min=self.maxViewSizeOfModel(m,min)}):_.each(model.views(),function(v){var wh=v.contentSize();wh[0]>min[0]&&(min[0]=wh[0]),wh[1]>min[1]&&(min[1]=wh[1])}),min}}},Obj.extend("a5.views.interaction.BaseView"),a5.view.Dialog={display:function(template,model,callbacks,beforeClose,buildModels,appendTo){return this.$node&&!this.$node.is(":empty")&&this.close(),this.removeOnClose=!1,this.callbacks=callbacks||{},this._skipDialog(template,model,callbacks)?$(appendTo):(this.$content=$(a5.service.templates.render(template,model)),0!=this.$content.length?(this.$node=$(appendTo),this.$node.length?this.displayAsNode(buildModels):(this.$node=$("<div>"),this.removeOnClose=!0,this.displayAsDialog(buildModels,model.dialogClass,beforeClose,this._isModal(template))),a5.mainBuilder.curInteraction.bind("hide",this.close,this,{once:!0}),a5.mainBuilder.curInteraction.bind("reset",this.close,this,{once:!0}),a5.callbacks.dialogs.get(template).trigger("showed",this.$node,model),a5.mainBuilder.curInteraction.trigger("interaction:dialog:display"),this.$node):void 0)},_skipDialog:function(template,model,callbacks){if(_.contains(a5.dp.config.skipDialogs,template)||!0===a5.dp.config.skipDialogs)return callbacks&&callbacks.ok?callbacks.ok():callbacks&&callbacks.close?callbacks.close():callbacks&&callbacks.cancel&&callbacks.cancel(),!0},_isModal:function(template){return!_.contains(a5.dp.config.nonModalDialogs,template)},_appendContent:function(buildModels){this.$node.empty(),buildModels?a5.utils.buildModel(a5.mainBuilder.curInteraction,this.$node,this.$content,!0):this.$node.append(this.$content)},_createButtons:function(){_.each(this.$node.find("a[data-button]"),function(button){$(button).button(),$(button).on("click",_.bind(function(e){e.preventDefault();var event=$(button).attr("data-button");this.okClicked="ok"===event,this.close(),event in this.callbacks&&"close"!==event&&this.callbacks[event]()},this))},this)},_createDialog:function(dialogClass,beforeCloseFn,closeFn,modal){
this.$node.find("img[class*=bgimg]").length>0&&(dialogClass+=" dialog-with-background-image"),_.isFunction(beforeCloseFn)||(beforeCloseFn=function(){return!0}),this.$node.dialog({modal:modal,dialogClass:dialogClass,beforeClose:beforeCloseFn,close:closeFn,resize:function(){var $dialog=$(this).closest(".ui-dialog"),$titlebar=$dialog.find(".ui-dialog-titlebar"),$content=$(this),height=$titlebar.outerHeight()+$content.outerHeight();$dialog.height(height);var width=$content.outerWidth();$dialog.width(width)}})},displayAsDialog:function(buildModels,dialogClass,beforeCloseFn,modal){this.$node.attr("title",this.$content.attr("title")),this.$content.removeAttr("title"),$("body").append(this.$node),this._appendContent(buildModels),this._createButtons();var onCloseDialogFn=_.bind(function(event,ui){a5.mainBuilder.curInteraction.trigger("interaction:dialog:close"),"beforeclose"in this.callbacks&&this.callbacks.beforeclose(),this._clear(),"close"in this.callbacks&&(this.callbacks.close(this.okClicked),this.okClicked=!1)},this);this._createDialog(dialogClass,beforeCloseFn,onCloseDialogFn,modal)},displayAsNode:function(buildModels){this._appendContent(buildModels),this._createButtons()},close:function(){this.$node&&this.$node.is(":ui-dialog")?this.$node.dialog("close"):("beforeclose"in this.callbacks&&this.callbacks.beforeclose(),this._clear(),"close"in this.callbacks&&(this.callbacks.close(this.okClicked),this.okClicked=!1))},_clear:function(){a5.mainBuilder.curInteraction.unbind("hide",this.close),a5.mainBuilder.curInteraction.unbind("reset",this.close),this.removeOnClose?(this.$node&&this.$node.remove(),delete this.$node):this.$node.empty()}},Obj.extend("a5.view.Dialog"),a5.view.dialog=new a5.view.Dialog,a5.view.feedback=a5.view.dialog,a5.view.Alert={init:function(parameters){_.extend(this,parameters||{}),this.$el=$("<div>",{class:"a5-alert"}),_.bindAll(this,"onClickClose"),this.$el.on("click",".close",this.onClickClose)},render:function(){var html=a5.service.templates.render(this.template,this.data),$html=$(html);this.$el.html($html.html());var duration=parseInt($html.attr("data-duration"),10);duration&&(this.duration=duration),this.$el.addClass(this.alertClass)},show:function(){this.$root.append(this.$el),this.render(),this.duration&&setTimeout(function(){this.close()}.bind(this),1e3*this.duration)},close:function(){this.$el.remove()},onClickClose:function(e){e.preventDefault(),this.close()}},Obj.extend("a5.view.Alert"),a5.views.interaction.ModelTextView={init:function(modelText,interaction){this.modelText=modelText,this.interaction=interaction},render:function(){var self=this;if(0!=this.modelText.length){var button=new a5.views.Toolbar.ModelTextButton("Model-Text");this.modelText.each(function(index,e){var div=$(e).find("div")[0],label=a5.utils.truncate($(div).attr("label"),24);label=$(div).attr("label");var mtNode=$("<div>"+$(div).text()+"</div>"),node=$("<div></div>");self.interaction.buildModelExludeNode(node,mtNode,!0),button.addItem(label,node.html())}),self.interaction.referenceToolbar.addButton(button)}}},Obj.extend("a5.views.interaction.ModelTextView"),a5.views.interaction.CustomTextView={init:function(customAttachments,interaction){this.customAttachments=customAttachments,this.interaction=interaction,this.attachments=this._createAttachments()},render:function(){this.btnList={},this._renderAttachments()},find:function(attachment){return _.find(this.attachments,function(at){return at.pinned&&at.label===attachment.label&&at.html===attachment.html},this)},_findPinnedAttachment:function(attachment){var found,interactions=a5.mainBuilder.getInteractionsWithAttachments();return _.each(interactions,function(interaction){found||(found=interaction!==this.interaction&&interaction.attachments.find(attachment))},this),found},_sanitizeAttachment:function(node){var nodeText=node.text().replace(/src=(['"])http(s)*:/gi,"src=$1");return nodeText=nodeText.replace(/<img[^>]+src=([^>]*flashIcon\.png[^>]*URL=)/gi,"<img do-not-load-src=$1"),logger.log("Sanitized attachment assets to avoid mixed content warnings."),nodeText=nodeText.replace(/(<video[^>]+)(autoplay=['"][^'"]*['"])/gi,"$1data-$2")},_parseAttachment:function(node){var $attachment=node.find("div"),sanitizedContent=this._sanitizeAttachment($attachment),$sanitizedContent=$(sanitizedContent),modes=_.map($sanitizedContent.find("loModes > string"),function(loMode){return $(loMode).text()}),userVisibility=$sanitizedContent.find("userVisibility").text()||"all";return{html:$sanitizedContent.find("text").text(),label:$attachment.attr("label"),customType:$sanitizedContent.find("customtype").text(),showInHeader:$sanitizedContent.find("attachmentLink").text(),userVisibility:userVisibility,modes:modes,pinned:this._isPinned(node),options:{klass:$attachment.attr("class"),target:$.trim($sanitizedContent.find("target").text()),popup:$.trim($sanitizedContent.find("windowopen").text()),url:$.trim($sanitizedContent.find("URL").text()),top:$.trim($sanitizedContent.find("windowTop").text()),left:$.trim($sanitizedContent.find("windowLeft").text())}}},_createAttachments:function(){return this.customAttachments.map(function(index,node){var $node=$(node);return this._createAttachment($node)}.bind(this)).get()},_createAttachment:function(node){var attachmentData=this._parseAttachment(node),attachment=new a5.service.Attachment(attachmentData.label,attachmentData.html,attachmentData.options,this.interaction,attachmentData);if(attachment.pinned){var pinned=this._findPinnedAttachment(attachment);pinned&&(attachment=pinned)}return attachment},_renderAttachments:function(){_.each(this.attachments,function(attachment){this._renderAttachment(attachment)},this)},_renderAttachment:function(attachment){attachment.render(),attachment.pinTo(this.interaction),"hide"!==attachment.showInHeader&&this._renderAttachmentInHeader(attachment)},_createHeaderButton:function(attachment){var button;""===attachment.customType?(button=new a5.views.Toolbar.DropDownItem(attachment.label,attachment),button.main=!0,this.interaction.referenceToolbar.addButton(button)):(button=this.btnList[attachment.customType],button||(button=new a5.views.Toolbar.DropDownButton(attachment.customType),this.interaction.referenceToolbar.addButton(button),this.btnList[attachment.customType]=button),button&&button.addItem(attachment.label,attachment))},_renderAttachmentInHeader:function(attachment){"Normal"!==LOInfo.mode&&attachment.modes.length>0&&!_.contains(attachment.modes,LOInfo.mode)||"all"!==attachment.userVisibility.toLowerCase()&&attachment.userVisibility.toLowerCase()!==a5.service.lms.API.getUserRole().toLowerCase()||this._createHeaderButton(attachment)},_isPinned:function(node){return node.attr("style")&&node.attr("style").match(/option023/i)}},Obj.extend("a5.views.interaction.CustomTextView"),a5.views.WordPool={init:function(alignment,forcePool,interaction,droppable){if(this.children=[],this.interaction=interaction,"none"===alignment&&forcePool&&(alignment="top"),this.$wordpool=$('<div class="wordpool"></div>'),this.pool=$('<div class="pool"></div>'),this.block=$('<div class="block"></div>'),"none"!==alignment&&this.$wordpool.append(this.pool),this.$wordpool.append(this.block),this.$wordpool.addClass("alignment_"+alignment),"top"!==alignment&&"bottom"!==alignment||this.$wordpool.addClass("alignment_horizontal"),"left"!==alignment&&"right"!==alignment||this.$wordpool.addClass("alignment_vertical"),"bottom"===alignment&&this.$wordpool.append(this.pool),"free"===alignment){var $free=$('<h2 class="drag-handle">:: drag to move wordpool :: <span class="reset_position" style="display: none; ">dock</span></h2>');this.pool.append($free),this.$resetPosition=$free.find(".reset_position"),this.$resetPosition.on("click",this.onResetPosition.bindTo(this)),this.pool.draggable({start:this.onStart.bindTo(this),stop:this.onStop.bindTo(this),drag:this.onDrag.bindTo(this),handle:"h2",cancel:".reset_position"})}droppable&&this.pool.droppable({accept:".drag_element",drop:this.onDrop.bindTo(this),tolerance:"pointer",scope:"screen-"+this.interaction.index}),this.interaction.bind("show:deferred",_.bind(this.onShowInteraction,this),{once:!0})},addChild:function(child){this.children.push(child),this._bindChildEvents(child)},_bindChildEvents:function(child){child.model.bind("undrop",function(){this.interaction.trigger("pool:changed",child.node)},this),child.model.bind("drop",function(){this.interaction.trigger("pool:changed",child.node)},this)},render:function(){return _.each(this.children,function(child){this.pool.append(child.render())},this),this.$wordpool},onResetPosition:function(){this.$resetPosition.hide(),this.pool.css("position","relative").css("top","0").css("left","0")},onDrag:function(event,ui){var newScrollSensitivity,currentScrollSensitivity=this.pool.draggable("option","scrollSensitivity");this.prevY&&event.pageY>this.prevY?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&this.pool.draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&this.pool.draggable("option","scrollSensitivity",newScrollSensitivity)),this.prevY=event.pageY,ui.helper.css("zIndex",2701)},onStop:function(event,ui){ui.helper.css("zIndex",2699)},onStart:function(event,ui){this.$resetPosition.show(),this.$wordpool.closest(".interaction").css({"margin-top":"0"})},clear:function(){this.pool.children(".static_word").remove()},append:function(text,gaptextaudio){if(text&&text.trim()){var word=$('<div class="static_word"></div>').append(text);gaptextaudio&&word.prepend(this.createTTSAudio(text).render()),this.pool.append(word)}},createTTSAudio:function(text){return new a5.views.TTS_Player(text)},onShowInteraction:function(){this.pool.is(".ui-draggable")&&this.pool.draggable("option","containment",this.interaction.contentWrap),this.$wordpool.closest(".interaction").addClass("wordpool")},onDrop:function(event,ui){var drag,dropView=_(this.children).find(function(child){return drag=drag||child.model.parent.getDragByID(parseInt(ui.draggable.attr("data-model-id"),10)),child.model.drag===drag});_.isUndefined(dropView)&&(dropView=_(this.children).find(function(child){return drag=drag||child.model.parent.getDragByID(parseInt(ui.draggable.attr("data-model-id"),10)),child.model.resident===drag&&!child.model.isFilled()})),_.isUndefined(dropView)&&(dropView=_(this.children).find(function(child){return drag=drag||child.model.parent.getDragByID(parseInt(ui.draggable.attr("data-model-id"),10)),!child.model.isFilled()})),_.isUndefined(drag)||(drag.lastTarget.undrop(drag),dropView&&(drag.lastTarget=dropView.model)),_.isUndefined(dropView)?ui.helper.remove():dropView.model.drop(drag)}},Obj.extend("a5.views.WordPool"),a5.views.interaction.DropArea={preserveSize:!1,init:function(model,parent){this._super(model,parent,$(a5.mainBuilder.layout.getTemplate("drop_area"))),this.node.addClass("drop_area"),this.interaction=model.parent.parent,this.dragHolder=this.$(".drag_holder"),this.placeholderContent="&#160;",this.model.content&&this.node.prepend(this.model.content),this.contentHolder=this.$(".content"),this.model.enumeration&&(this.model.globalEnumeration&&a5.dp.config.continuousEnumerationInsideGaps?this.placeholderContent='<span class="enum-placeholder"></span>':this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.model.globalEnumeration&&a5.dp.config.continuousEnumerationInsideGaps&&(this.placeholderContent=enumSymbol),this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),this.model.arrow&&this.node.addClass("arrow_"+this.model.arrow),this.updateDrag(),this.model.prefilled?this.node.addClass("prefilled"):this.dragHolder.droppable({accept:_.bind(function(draggable){var drag=this.model.parent.getDragByID(parseInt(draggable.attr("data-model-id"),10));return drag&&draggable.is(".drag_element")&&this.model.canDrop(drag)},this),over:this.onOver.bindTo(this),out:this.onOut.bindTo(this),drop:this.onDrop.bindTo(this),tolerance:"radius-closest-to-mouse",toleranceRadius:a5.dp.config.droppableToleranceRadius,greedy:!0,scope:"screen-"+this.interaction.index}),this.model.isDistractor()&&this.node.addClass("distractor-gap")},onOver:function(event,ui){this.model.dropIndicator&&(this.node.addClass("is-active-target"),this.node.addClass("drop-indicator"),ui.helper.addClass("is-active-target-source"))},onOut:function(event,ui){this.node.removeClass("is-active-target"),this.node.removeClass("drop-indicator"),ui.helper.removeClass("is-active-target-source")},onDrop:function(event,ui){var drag=this.model.parent.getDragByID(parseInt(ui.draggable.attr("data-model-id"),10));if(drag.lastTarget.copyOnDrag||drag.lastTarget.undrop(drag),this.model.drag!==drag){if("home"==(drag.existing||this.model.existing||"no")&&this.model.drag&&this.model.drag.home){var toBeDropped;this.model.drag.home.drag&&"one"===this.model.parent.multiDest&&(toBeDropped=_.first(this.model.parent.getAvailablePoolAreas())),toBeDropped=toBeDropped||this.model.drag.home,toBeDropped.drop(this.model.drag)}this.model.drop(drag)}else ui.helper.remove();this.node.removeClass("is-active-target"),this.node.removeClass("drop-indicator"),ui.helper.removeClass("is-active-target-source")},createViewFor:function(model){logger.error("please override me")},updateDrag:function(){this.updateToThisDrag(this.model.drag)},updateToThisDrag:function(drag){if(this.dragHolder.empty(),null!=drag){this.node.addClass("has_drag");var view=this.createViewFor(drag);this.dragHolder.append(view.render())}else this.node.removeClass("has_drag"),this.dragHolder.append($('<div class="place_holder">'+this.placeholderContent+"</div>")),this.model.prefilled&&this.node.addClass("prefilled");this.updateSize()},contentSize:function(){return this.contentHolder.naturalSize()},setNodeSize:function(w,h){var padx=this.node.outerWidth()-this.node.width(),pady=this.node.outerHeight()-this.node.height();this.node.css({minWidth:w-padx,minHeight:h-pady})},setHolderSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.dragHolder.outerWidth()-this.dragHolder.width(),pady=this.dragHolder.outerHeight()-this.dragHolder.height()),this.dragHolder.css({minWidth:w-padx,minHeight:h-pady}),this.minWidth=w-padx,this.minHeight=h-pady,this.updateSize()},setContentSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.contentHolder.outerWidth()-this.contentHolder.width(),pady=this.contentHolder.outerHeight()-this.contentHolder.height()),this.contentHolder.css({minWidth:w-padx,minHeight:h-pady})},updateSize:function(){!this.preserveSize&&this.node.hasClass("has_drag")?(this.dragHolder.css("minHeight",""),this.dragHolder.css("minWidth","")):(this.dragHolder.css("minHeight",this.minHeight),this.dragHolder.css("minWidth",this.minWidth))}},a5.views.interaction.BaseView.extend("a5.views.interaction.DropArea"),a5.views.interaction.StackDropArea={init:function(model,parent){this._super(model,parent,$('<div class="drop_area stack_drop_area"><div class="width-measure"></div></div>')),this.interaction=model.parent.parent,this.model.content&&this.node.append(this.model.content),this.dragHolder=$('<div class="drag_holder"></div>'),this.node.append(this.dragHolder),this.model.enumeration&&(this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),this.updateDrags(),this.dragHolder.droppable({accept:".drag_element",over:this.onOver.bindTo(this),out:this.onOut.bindTo(this),drop:this.onDrop.bindTo(this),tolerance:"pointer",greedy:!0,scope:"screen-"+this.interaction.index})},setHolderSize:function(w,h){this.dragHolder.css({width:w,height:h})},onOver:a5.views.interaction.DropArea.prototype.onOver,onOut:a5.views.interaction.DropArea.prototype.onOut,onDrop:a5.views.interaction.DropArea.prototype.onDrop,createViewFor:function(model){logger.error("please override me")},updateDrags:function(){this.dragHolder.empty(),this.node.toggleClass("has_drag",this.model.drags.length>0),_(this.model.drags).each(function(drag){var view=this.createViewFor(drag);this.dragHolder.append(view.render())},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.StackDropArea"),a5.views.interaction.DragElement={init:function(model,parent){if(this._super(model,parent,$('<div class="drag_element"></div>')),this.interaction=model.parent.parent,this.model.content){this.node.append(this.model.content.clone(!0));var updateContent=this.model.content;_.defer(function(){var viewUpdaters=updateContent.find("[data-has-view-updater]");_.each(viewUpdaters,function(e){$(e).data("view-updater").update()})})}this.draggableOptions=a5.utils.getDraggableOptions(this.interaction),parent.model.prefilled?this.node.addClass("prefilled"):(this.node.draggable($.extend({start:this.onStart.bindTo(this),stop:this.onStop.bindTo(this),drag:this.onDrag.bindTo(this),revert:"invalid",revertDuration:350,disabled:!0,helper:this.createHelper.bind(this),scope:"screen-"+this.interaction.index,cancel:".checked-correct-locked",containment:"document"},this.draggableOptions)),this.enable()),this.interaction.isLiveCycle("loaded")&&this.interaction.index===a5.mainBuilder.curInteraction.index?this.applyContainment():this.interaction.bind("show:deferred",_.bind(this.applyContainment,this),{once:!0}),model.bind("drop",function(){this.node.trigger("dragstop")},this)},render:function(){if(this.model.gaptextaudio){var text=this.node.text();this.$(".content").prepend(this.createTTSAudio(text).render())}return this.node.find(".has_audio_attached").toggleClass("no-label",!this.node.text()),this.interaction.trigger("drag:render",this.node),this.node},onStart:function(event,ui){this.model.lastTarget=this.parent.model,this.interaction.$(".drop_area").css("zIndex",""),this.interaction.$(".drag_element").css("zIndex",""),ui.helper.css("zIndex",2700),ui.helper.closest(".drop_area").css("zIndex",2700),this.parent.model.copyOnDrag||this.node.css("visibility","hidden")},onStop:function(event,ui){this.interaction.$(".drop_area").css("zIndex",""),this.interaction.$(".drag_element").css("zIndex",""),this.parent.model.copyOnDrag||this.node.css("visibility","visible")},onDrag:function(event,ui){var newScrollSensitivity,currentScrollSensitivity=this.node.draggable("option","scrollSensitivity");this.prevY&&event.pageY>this.prevY?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&this.node.draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&this.node.draggable("option","scrollSensitivity",newScrollSensitivity)),this.prevY=event.pageY},createHelper:function(){var $clone=this.node.clone().removeAttr("id");return $clone.css("width",Math.ceil(this.node.get(0).getBoundingClientRect().width)),$clone},disable:function(){if(this.node.is(".ui-draggable")){try{this.node.draggable("disable")}catch(e){}this.node.addClass("ui-disabled")}},enable:function(){if(this.node.is(".ui-draggable")){this.node.removeClass("ui-disabled");try{this.node.draggable("enable")}catch(e){}}},createTTSAudio:function(text){return new a5.views.TTS_Player(text)},contentSize:function(){return this.node.naturalSize()},setSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.node.outerWidth()-this.node.width(),pady=this.node.outerHeight()-this.node.height()),this.node.css({minWidth:w-padx,minHeight:h-pady})},applyContainment:function(){if(!("containment"in this.draggableOptions)&&this.node.is(".ui-draggable")&&a5.dp.config.keepDragElementInsideContentZone){var $container=this.interaction.contentZone,x1=$container.offset().left-this.node.width(),x2=$container.offset().left+$container.width(),y2=$(document).height();this.node.draggable("option","containment",[x1,0,x2,y2])}}},a5.views.interaction.BaseView.extend("a5.views.interaction.DragElement"),a5.views.WordPoolSimple={POOL_HANDLE_TEMPLATE:'<h2 class="drag-handle">:: drag to move wordpool :: <span class="reset_position" style="display: none; ">dock</span></h2>',init:function(alignment,parent,forcePool,model,droppable){this.parent=parent,this.children=[],"none"===alignment&&forcePool&&(alignment="top"),this.$wordpool=$('<div class="wordpool"></div>'),this.pool=$('<div class="pool"></div>'),this.block=$('<div class="block"></div>'),this._setPoolAlignment(alignment,model),"none"!==alignment&&this.$wordpool.append(this.pool),this.$wordpool.append(this.block),this.$wordpool.addClass(alignment),droppable&&this.pool.droppable({accept:".drag_element",drop:this.onDrop.bindTo(this),tolerance:"pointer",scope:"screen-"+model.index})},_setPoolAlignment:function(alignment,model){if("none"!==alignment&&this.$wordpool.append(this.pool),"free"===alignment){var $free=$(this.POOL_HANDLE_TEMPLATE);this.pool.append($free),this.$resetPosition=$free.find(".reset_position"),this.$resetPosition.on("click",this.onResetPosition.bindTo(this)),model.bind("show:deferred",_.bind(function(){this.pool.draggable({start:this.onStart.bindTo(this),stop:this.onStop.bindTo(this),drag:this.onDrag.bindTo(this),containment:model.contentWrap,handle:"h2",cancel:".reset_position"})},this),{once:!0})}},addChild:function(child){this.children.push(child)},render:function(){return _.each(this.children,function(child){this.pool.append(child.render())},this),this.$wordpool},onResetPosition:function(){this.$resetPosition.hide(),this.pool.css("position","relative").css("top","0").css("left","0")},getDragViewById:function(id){return this.parent.getDragViewById(id)},getAvailablePoolAreas:function(){return _.filter(this.children,function(dropArea){return null===dropArea.drag})},onDrag:function(event,ui){var newScrollSensitivity,currentScrollSensitivity=this.pool.draggable("option","scrollSensitivity");this.prevY&&event.pageY>this.prevY?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&this.pool.draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&this.pool.draggable("option","scrollSensitivity",newScrollSensitivity)),this.prevY=event.pageY,ui.helper.css("zIndex",2701)},onStop:function(event,ui){ui.helper.css("zIndex",2699)},onStart:function(event,ui){this.$resetPosition.show(),this.$wordpool.closest(".interaction").css({"margin-top":"0"})},clear:function(){this.pool.children(".static_word").remove()},onDrop:function(event,ui){var drag=this.getDragViewById(ui.draggable.attr("data-model-id"));if(drag&&!drag.parent.isPoolArea()){var availableDropView=_.first(this.getAvailablePoolAreas());availableDropView&&availableDropView.drop(drag)}},moveDragViewToPool:function(drag){var destination;(destination=drag.lastPoolArea&&!drag.lastPoolArea.drag?drag.lastPoolArea:_.first(this.getAvailablePoolAreas()))&&destination.drop(drag)}},Obj.extend("a5.views.WordPoolSimple"),a5.views.interaction.SimpleDropArea={PLACEHOLDER_TEMPLATE:'<div class="place_holder">&nbsp;</div>',preserveSize:!1,isPoolArea:function(){return this.parent instanceof a5.views.WordPoolSimple},init:function(model,parent,interaction){this._super(model,parent,$('<div class="drop_area"/>')),this.interaction=interaction,this.dragHolder=$("<div/>").addClass("drag_holder"),this.node.append(this.dragHolder),this.placeholderContent="&nbsp;",this.model&&this.model.content&&this.node.prepend(this.model.content),this.drag&&this.drag.model.prefilled?this.node.addClass("prefilled"):this._setDroppable(interaction),this.updateAudio(),this.drag&&this.drag.model.isDistractor()&&this.node.addClass("distractor-gap")},_setDroppable:function(interaction){this.dragHolder.droppable({accept:_.bind(function(draggable){var canDrop=!this.drag||!this.isPoolArea();return draggable.is(".drag_element")&&canDrop},this),over:this.onOver.bindTo(this),out:this.onOut.bindTo(this),drop:this.onDrop.bindTo(this),tolerance:"radius-closest-to-mouse",toleranceRadius:a5.dp.config.droppableToleranceRadius,greedy:!0,scope:"screen-"+interaction.index})},disable:function(){this.dragHolder.droppable("option","disabled",!0)},enable:function(){this.dragHolder.droppable("option","disabled",!1)},onOver:function(event,ui){this.node.addClass("hovered")},onOut:function(event,ui){this.node.removeClass("hovered")},updateAudio:function(){var text=this.node.text();if(this.model&&this.model.gaptextaudio){var tts=new a5.views.TTS_Player(text);this.node.find(".content").prepend(tts.render())}this.node.find(".has_audio_attached").toggleClass("no-label",text)},onDrop:function(event,ui){this.node.removeClass("hovered");var drag=this.parent.getDragViewById(ui.draggable.attr("data-model-id"));drag&&this.drag!==drag&&(this.drag&&this.drag!==drag&&!this.isPoolArea()?this.parent.moveDragViewToPool(this.drag):ui.helper.remove(),this.drop(drag))},drop:function(drag){drag.parent.undrop(),this.setDrag(drag),this.trigger("drop"),this.isPoolArea()&&this.interaction.trigger("pool:changed",this.node)},undrop:function(){this.drag&&(this.drag.detach(),this.drag.updateParent(null)),this.setDrag(null),this.trigger("undrop"),this.isPoolArea()&&this.interaction.trigger("pool:changed",this.node)},updateDrag:function(){this.updateToThisDrag(this.model.drag)},setDrag:function(drag){this.drag=drag,this.dragHolder.empty(),null!==this.drag?(this.node.addClass("has_drag"),this.node.removeAttr("tabindex"),this.dragHolder.append(this.drag.render()),this.drag.updateParent(this),this.drag.model.prefilled&&this.node.addClass("prefilled")):(this.node.removeClass("has_drag"),this.node.attr("tabindex",0),this.dragHolder.append(this.PLACEHOLDER_TEMPLATE))}},a5.views.interaction.BaseView.extend("a5.views.interaction.SimpleDropArea"),a5.views.interaction.SimpleDragElement={init:function(model,parent,interaction){this._super(model,parent,$('<div class="drag_element"/>')),this.model.content&&this.node.append(this.model.content.clone(!0)),this.draggableOptions=a5.utils.getDraggableOptions(interaction),this.model.isPrefilled()?this.node.addClass("prefilled"):this.setDraggable(interaction.index),this.updateAudio()},setDraggable:function(index){this.node.draggable($.extend({start:this.onStart.bindTo(this),stop:this.onStop.bindTo(this),drag:this.onDrag.bindTo(this),revert:"invalid",revertDuration:350,helper:"clone",scope:"screen-"+index,cancel:".checked-correct-locked"},this.draggableOptions))},detach:function(){this.node.detach()},updateParent:function(drop){drop&&drop.isPoolArea()&&(this.lastPoolArea=drop),this.parent=drop},updateAudio:function(){var text=this.node.text();if(this.model&&this.model.gaptextaudio){var tts=new a5.views.TTS_Player(text);this.node.find(".content").prepend(tts.render())}this.node.find(".has_audio_attached").toggleClass("no-label",text)},onStart:function(event,ui){ui.helper.css("width",this.node[0].getBoundingClientRect().width),this.model.copyOnDrag||this.node.css("visibility","hidden")},onStop:function(event,ui){this.model.copyOnDrag||this.node.css("visibility","visible")},onDrag:function(event,ui){var newScrollSensitivity,currentScrollSensitivity=this.node.draggable("option","scrollSensitivity");this.prevY&&event.pageY>this.prevY?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&this.node.draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&this.node.draggable("option","scrollSensitivity",newScrollSensitivity)),this.prevY=event.pageY},disableDraggable:function(){try{this.node.draggable("disable")}catch(e){}},enableDraggable:function(){try{this.node.draggable("enable")}catch(e){}},disable:function(){this.node.is(".ui-draggable")&&(this.disableDraggable(),this.node.addClass("ui-disabled"))},enable:function(){this.node.is(".ui-draggable")&&(this.enableDraggable(),this.node.removeClass("ui-disabled"))}},a5.views.interaction.BaseView.extend("a5.views.interaction.SimpleDragElement"),a5.views.interaction.FillArea={preserveSize:!1,init:function(model,parent){this._super(model,parent,$(a5.mainBuilder.layout.getTemplate("drop_area"))),this.node.addClass("drop_area"),_.bindAll(this,"onClick","onKeydown"),this.interaction=model.parent.parent,this.dragHolder=this.$(".drag_holder"),this.placeholderContent="&#160;",this.model.content&&this.node.prepend(this.model.content),this.contentHolder=this.$(".content"),this.model.enumeration&&(this.model.globalEnumeration&&a5.dp.config.continuousEnumerationInsideGaps?this.placeholderContent='<span class="enum-placeholder"></span>':this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.model.globalEnumeration&&a5.dp.config.continuousEnumerationInsideGaps&&(this.placeholderContent=enumSymbol),this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),this.model.arrow&&this.node.addClass("arrow_"+this.model.arrow),this.updateDrag(),this.model.prefilled?this.node.addClass("prefilled"):(this.node.on("click",this.onClick),this.node.on("keydown",this.onKeydown)),this.model.isDistractor()&&this.node.addClass("distractor-gap")},onClick:function(){this.fillGap()},onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.fillGap()},fillGap:function(){var selectedElements=this.model.parent.getSelectedDragElement(),drag=selectedElements.length&&selectedElements[0];!this.model.isFilled()&&drag&&(drag.lastTarget.copyOnDrag||drag.lastTarget.undrop(drag),this.model.drop(drag))},createViewFor:function(model){logger.error("please override me")},updateDrag:function(){this.updateToThisDrag(this.model.drag)},updateToThisDrag:function(drag){if(this.dragHolder.empty(),null!=drag){this.node.addClass("has_drag"),this.node.removeAttr("tabindex");var view=this.createViewFor(drag);this.dragHolder.append(view.render())}else this.node.removeClass("has_drag"),this.dragHolder.append($('<div class="place_holder">'+this.placeholderContent+"</div>")),this.model.prefilled?(this.node.addClass("prefilled"),this.node.removeAttr("tabindex")):this.node.attr("tabindex",0);this.updateSize()},contentSize:function(){return this.contentHolder.naturalSize()},setNodeSize:function(w,h){var padx=this.node.outerWidth()-this.node.width(),pady=this.node.outerHeight()-this.node.height();this.node.css({minWidth:w-padx,minHeight:h-pady})},setHolderSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.dragHolder.outerWidth()-this.dragHolder.width(),pady=this.dragHolder.outerHeight()-this.dragHolder.height()),this.dragHolder.css({minWidth:w-padx,minHeight:h-pady}),this.minWidth=w-padx,this.minHeight=h-pady,this.updateSize()},setContentSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.contentHolder.outerWidth()-this.contentHolder.width(),pady=this.contentHolder.outerHeight()-this.contentHolder.height()),this.contentHolder.css({minWidth:w-padx,minHeight:h-pady})},updateSize:function(){!this.preserveSize&&this.node.hasClass("has_drag")?(this.dragHolder.css("minHeight",""),this.dragHolder.css("minWidth","")):(this.dragHolder.css("minHeight",this.minHeight),this.dragHolder.css("minWidth",this.minWidth))}},a5.views.interaction.BaseView.extend("a5.views.interaction.FillArea"),a5.views.interaction.StackFillArea={isPoolArea:!0,init:function(model,parent){this._super(model,parent,$('<div class="drop_area stack_drop_area"><div class="width-measure"></div></div>')),_.bindAll(this,"onClick"),this.interaction=model.parent.parent,this.model.content&&this.node.append(this.model.content),this.dragHolder=$('<div class="drag_holder"></div>'),this.node.append(this.dragHolder),this.model.enumeration&&(this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),
this.updateDrags(),this.node.on("click",this.onClick),this.node.attr("tabindex",0)},onClick:function(){this.fillGap()},fillGap:function(ev){var allSelectedDrags=this.model.parent.getSelectedDragElement(),mySelectedDrags=_.intersection(allSelectedDrags,this.model.drags),externalSelectedDrags=_.difference(allSelectedDrags,mySelectedDrags),drag=externalSelectedDrags.length&&externalSelectedDrags[0];drag&&(mySelectedDrags.length&&_.invoke(this.getTileViewsByModels(mySelectedDrags),"select",!1),drag.lastTarget.copyOnDrag||drag.lastTarget.undrop(drag),this.model.drop(drag))},getTileViewsByModels:function(tiles){return _.filter(this.tileViews,function(tView){return _.contains(tiles,tView.model)})},setHolderSize:function(w,h){this.dragHolder.css({width:w,height:h})},createViewFor:function(model){logger.error("please override me")},updateDrags:function(){this.dragHolder.empty(),this.tileViews=[],_(this.model.drags).each(function(drag){this.tileViews.push(this.createViewFor(drag)),this.dragHolder.append(_.last(this.tileViews).render())},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.StackFillArea"),a5.views.interaction.TileElement={init:function(model,parent){if(this._super(model,parent,$('<div class="drag_element"></div>')),this.interaction=model.parent.parent,_.bindAll(this,"onClick","onDoubleTap","onDocumentClick","onKeydown","onDocumentKeydown"),this.model.content){this.node.append(this.model.content.clone(!0));var updateContent=this.model.content;_.defer(function(){var viewUpdaters=updateContent.find("[data-has-view-updater]");_.each(viewUpdaters,function(e){$(e).data("view-updater").update()})})}this.enable()},setSelected:function(ev){this.model.lastTarget=this.parent.model,this.select(!0)},moveToEmptyGap:function(ev){var emptyTargetAreas=this.parent.model.parent.getAvailableFillAreas();if(emptyTargetAreas.length){var emptyTarget=_.first(emptyTargetAreas);this.model.lastTarget=this.parent.model,emptyTarget.drop(this.model),this.parent.model.copyOnDrag||this.parent.model.undrop(this.model)}this.select(!1)},onDocumentClick:function(ev){this.node.find(ev.target).length||this.select(!1)},onDocumentKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.ESCAPE&&(this.node[0]===ev.target||key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER)||this.select(!1)},select:function(select){if(select!==this.model.selected){this.model.selected=select,this.node.toggleClass("selected",this.model.selected);var method=select?"addEventListener":"removeEventListener";document[method]("click",this.onDocumentClick),document[method]("keydown",this.onDocumentKeydown)}},moveToEmptyPool:function(evt){var emptyPoolAreas=this.parent.model.parent.getAvailablePoolAreas();if(emptyPoolAreas.length){var emptyPool=_.first(emptyPoolAreas);this.model.lastTarget=this.parent.model,emptyPool.drop(this.model)}this.parent.model.copyOnDrag||this.parent.model.undrop(this.model),this.select(!1)},render:function(){if(this.model.gaptextaudio){var text=this.node.text();this.$(".content").prepend(this.createTTSAudio(text).render())}return this.node.find(".has_audio_attached").toggleClass("no-label",!this.node.text()),this.interaction.trigger("drag:render",this.node),this.node},disable:function(){this.removeListeners(),this.node.toggleClass("ui-disabled",!0).removeAttr("tabindex")},enable:function(){this.parent.model.prefilled?this.node.addClass("prefilled"):(this.addListeners(),this.node.toggleClass("ui-disabled",!1).attr("tabindex",0))},removeListeners:function(){this.node.off("click",this.onClick),this.node.off("keydown",this.onKeydown),this.node.off("doubletap",this.onDoubleTap)},addListeners:function(){this.removeListeners();var hammer=new Hammer.Manager(this.node[0],{}),doubleTap=new Hammer.Tap({event:"doubletap",taps:2});hammer.add(doubleTap),this.node.on("click",this.onClick),this.node.on("keydown",this.onKeydown),!this.parent.isPoolArea&&this.model.isTapTarget()&&this.node.on("doubletap",this.onDoubleTap)},onClick:function(){this.activate()},onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.activate()},activate:function(){this.parent.isPoolArea?this.model.isTapTarget()?this.setSelected():(this.moveToEmptyGap(),this.model.dropAudio&&(a5.service.media.pauseAllExcept(this.model.dropAudio),this.model.dropAudio.play())):this.model.isTapTarget()?this.setSelected():this.moveToEmptyPool()},onDoubleTap:function(){this.moveToEmptyPool()},createTTSAudio:function(text){return new a5.views.TTS_Player(text)},contentSize:function(){return this.node.naturalSize()},setSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.node.outerWidth()-this.node.width(),pady=this.node.outerHeight()-this.node.height()),this.node.css({minWidth:w-padx,minHeight:h-pady})}},a5.views.interaction.BaseView.extend("a5.views.interaction.TileElement"),a5.view.Video={videoTemplate:"video_widget",inlineTranscriptTemplate:"media_transcript",init:function(parameters){parameters=parameters||{},this.layout=parameters.layout,this.$subtitles=$("<div subtitles-wrapper></div>").html(parameters.subtitles),this.$transcript=$("<div transcript-wrapper></div>").html(parameters.transcript),this.ref=parameters.ref,this.$video=$(this.layout.getTemplate(this.videoTemplate)),this.$inlineTranscript=$(this.layout.getTemplate(this.inlineTranscriptTemplate)),this.$inlineTranscript.length?this.$el=this.$video.wrap('<div class="transcript-wrap video"></div>').append(this.$inlineTranscript):this.$el=this.$video},render:function(){var $target=this.$el.find(".the_video"),video=a5.service.media.video.create(this.ref,$target),dummyInteraction=new Obj;return a5.model_builder.audioVideoUtils.addVideoPlayerEvents(video,this.$el),a5.model_builder.audioVideoUtils.linkSubtitles(this.$subtitles||$(),dummyInteraction,this.$el,video),a5.model_builder.audioVideoUtils.linkTranscript(this.$transcript||$(),dummyInteraction,this.$el,video,this.$inlineTranscript),this.trigger("ready"),this.$el}},Obj.extend("a5.view.Video"),a5.view.Audio={audioTemplate:"audio_widget",inlineTranscriptTemplate:"media_transcript",init:function(parameters){parameters=parameters||{},this.layout=parameters.layout,this.$subtitles=$("<div subtitles-wrapper></div>").append(parameters.subtitles),this.$transcript=$("<div transcript-wrapper></div>").append(parameters.transcript),this.ref=parameters.ref,this.$audio=$(this.layout.getTemplate(this.audioTemplate)),this.$inlineTranscript=$(this.layout.getTemplate(this.inlineTranscriptTemplate)),this.$inlineTranscript.length?this.$el=this.$audio.wrap('<div class="transcript-wrap audio"></div>').append(this.$inlineTranscript):this.$el=this.$audio},render:function(){return this.$el.find(".the_audio").hide(),a5.service.media.audio.bind("ready",function(){var audio=a5.service.media.audio.create(this.ref),dummyInteraction=new Obj;this.$el.attr("data-playable-media",audio.uid),a5.model_builder.audioVideoUtils.addAudioPlayerEvents(audio,this.$el),a5.model_builder.audioVideoUtils.linkSubtitles(this.$subtitles||$(),dummyInteraction,this.$el,audio),a5.model_builder.audioVideoUtils.linkTranscript(this.$transcript||$(),dummyInteraction,this.$el,audio,this.$inlineTranscript),this.trigger("ready")}.bind(this)),this.$el}},Obj.extend("a5.view.Audio"),a5.view.BSModal={init:function(options){this.$el=$("<div>",{class:"modal hide fade",tabindex:"-1",role:"dialog"}),this.options=_.extend({backdrop:!0},options),_.bindAll(this,"_onClickClose","onHidden","onShown","onHide","onShow"),this.$el.on("click",".close",this._onClickClose),this.$el.on("hidden.bs.modal",this.onHidden),this.$el.on("shown.bs.modal",this.onShown),this.$el.on("hide.bs.modal",this.onHide),this.$el.on("show.bs.modal",this.onShow)},render:function(){return this.$el.html(a5.mainBuilder.layout.getTemplate(_.result(this,"template"))),this.renderContent(),this.trigger("render"),this.$el},renderContent:function(){},close:function(){this.$el.data("modal")&&this.$el.modal("hide")},open:function(){var backdrop=this.options.backdrop;this.$el.modal({backdrop:backdrop}),backdrop&&$(".modal-backdrop").insertAfter(this.$el)},toggle:function(){this.$el.hasClass("opened")?this.close():this.open()},_onClickClose:function(ev){ev.preventDefault(),this.close()},onHidden:function(){this.$el.removeClass("opened"),this.$el.addClass("closed"),this.trigger("close")},onShown:function(){this.$el.removeClass("closed"),this.$el.addClass("opened"),this.trigger("open")},onHide:function(){},onShow:function(){this.$el.removeClass("hide")}},Obj.extend("a5.view.BSModal"),$.fn.modal.Constructor.prototype.enforceFocus=function(){},a5.view.JQDialog={init:function(options){this.$el=$("<div>"),this.options=_.extend({modal:!0},options),_.bindAll(this,"_onClickClose","onHidden","onShown"),this.$el.on("click",".close",this._onClickClose),this.$el.on("dialogclose",this.onHidden),this.$el.on("dialogopen",this.onShown)},render:function(){var html=a5.service.templates.render(this.template),$html=$(html);return this.$el.attr("title",$html.attr("title")),this.$el.html($html.html()),this.renderContent(),this.$el.find("a[data-button]").button(),this.$el.dialog({autoOpen:!1,modal:this.options.modal,dialogClass:this.options.dialogClass}),this.trigger("render"),this.$el},renderContent:function(){},close:function(){this.onHide(),this.$el.dialog("close")},open:function(){this.onShow(),this.$el.dialog("open")},toggle:function(){this.$el.dialog("isOpen")?this.close():this.open()},_onClickClose:function(ev){ev.preventDefault(),this.close()},onHidden:function(ev){this.$el.removeClass("opened"),this.$el.addClass("closed"),this.trigger("close")},onShown:function(ev){this.$el.removeClass("closed"),this.$el.addClass("opened"),this.trigger("open")},onShow:function(){},onHide:function(){}},Obj.extend("a5.view.JQDialog"),a5.view.Sidebar={init:function(options){this.$el=$("<div>",{class:"sidebar-panel closed"}),this.options=_.extend({},options),_.bindAll(this,"_onClickClose"),this.$el.on("click",".close",this._onClickClose)},render:function(){return this.$el.html(a5.mainBuilder.layout.getTemplate(_.result(this,"template"))),this.renderContent(),this.trigger("render"),this.$el},renderContent:function(){},close:function(){this.$el.removeClass("opened"),this.$el.addClass("closed"),this.trigger("close")},open:function(){this.$el.removeClass("closed"),this.$el.addClass("opened"),this.trigger("open")},toggle:function(){this.$el.hasClass("opened")?this.close():this.open()},_onClickClose:function(ev){ev.preventDefault(),this.close()}},Obj.extend("a5.view.Sidebar"),a5.view.Notebook={template:"a5.view.Notebook",exportTemplate:"a5.view.NotebookExport",defaultExportTemplate:"<h1>Notes</h1>{{#each pages as |page|}}<h2>Page {{page.number}}</h2><p>{{{page.note}}}</p>{{/each}}",init:function(model,options){this.model=model,this.vent=new Obj,this.notes=[],this.options=_.extend({offset:0,editorSettings:{}},options),this.$el=$("<div>",{class:"notebook-wrapper"}),_.bindAll(this,"_onClickPrev","_onClickNext"),this.$el.on("click",".btn-prev",this._onClickPrev),this.$el.on("click",".btn-next",this._onClickNext),this.vent.bind("page-number:click",this._onClickPageNumber,this),this.vent.bind("notebook-page:change",this._onNotebookPageChange,this),this.vent.bind("notebook-tab:click",this._onNotebookTabClick,this),this.vent.bind("notebook-tab:submit",this._onNotebookTabSubmit,this),this.vent.bind("note:change",this._onNoteChange,this),this.vent.bind("note:reset",this._onNoteReset,this)},render:function(){var html=a5.service.templates.render(this.template,{title:this.getTitle()});return this.$el.html(html),this.exportFormatSelect=new a5.view.ExportFormatSelect({$button:this.$el.find(".btn-export")}),this.exportFormatSelect.bind("submit",this._onExport,this),this.$tabs=this.$el.find(".notebook-tabs"),this.$notes=this.$el.find(".notebook-notes"),this.$pagination=this.$el.find(".notebook-pagination"),this.trigger("render"),this.$el},refresh:function(){this.render()},append:function(note){this.notes.push(note)},updateNotes:function(){var pages=this.getCurrentPages();_.each(pages,function(page,index){var note=new a5.view.NotebookNote({vent:this.vent,page:page,editorSettings:this.options.editorSettings}),tab=new a5.view.NotebookTab({vent:this.vent,page:page,note:note});0===index&&(tab.activate(),note.activate()),this.append({note:note,tab:tab}),this.$tabs.append(tab.$el),this.$notes.append(note.$el),tab.render(),note.render()},this),this.$pagination.find(".current-page").html(this.getCurrentPageText()),this.flag()},flag:function(){this.$el.toggleClass("no-prev",!this.hasPrev()).toggleClass("no-next",!this.hasNext())},reportChange:function(hasChanges){this.hasChanges=!!hasChanges,this.$el.toggleClass("hasChanges",this.hasChanges),this.hasChanges&&this.save()},checkChanges:function(){this.hasChanges?this.save():this.reset()},save:function(){this._eachNote("save"),this.reportChange(!1)},reset:function(){this._eachNote("reset")},setup:function(){this._eachNote("editable")},teardown:function(){this._eachNote("cleanup"),this.$tabs.empty(),this.$notes.empty(),this.exportFormatSelect.close(),this.notes=[],this.reportChange(!1)},exportTo:function(formats){var html=a5.service.templates.render(this.exportTemplate,{pages:this.getPagesWithNotes(),title:this.getTitle()},this.defaultExportTemplate);a5.service.toolbelt.exportTo({formats:formats,input:html,output:"notes"})},goPrev:function(){this.goTo(this.page-this.getPagesPerScreen())},goNext:function(){this.goTo(this.page+this.getPagesPerScreen())},goFirst:function(){this.goTo(0)},goLast:function(){this.goTo(this.getTotalPages()-1)},goTo:function(pageIndex,silent){this.page=this.getCurrent(pageIndex),silent||this.vent.trigger("notebook-page:change")},hasNext:function(){return this.page<this.getTotalPages()-this.getPagesPerScreen()},hasPrev:function(){return this.page>0},getCurrentPages:function(){return this.getPages().slice(this.page,Math.min(this.page+this.getPagesPerScreen(),this.getTotalPages()))},getPagesWithNotes:function(){return _.filter(this.getPages(),function(page){return _.result(page,"hasNotes")})},getPages:function(){return[]},getTotalPages:function(){return 0},getPagesPerScreen:function(){return 1},getTitle:function(){return"Notes"},getCurrentPageText:function(){return""},getCurrent:function(pageIndex){var pagesPerScreen=this.getPagesPerScreen(),offset=this.options.offset,pageFrom=Math.floor((pageIndex+offset)/pagesPerScreen)*pagesPerScreen-offset;return pageFrom=Math.min(Math.max(pageFrom,0),this.getTotalPages()-1)},printedPageToPageIndex:function(pageNumber){return pageNumber+this.options.offset-1},_onExport:function(formats){this.exportTo(formats)},_onNotebookPageChange:function(){this.checkChanges(),this.teardown(),this.updateNotes(),this.setup()},_onNotebookTabClick:function(tab){this.$tabs.find(".note-tab.active").removeClass("active"),this._eachNote("deactivate"),tab.activate(),tab.note.activate()},_onNotebookTabSubmit:function(pageNumber){var page=this.printedPageToPageIndex(pageNumber);this.goTo(page)},_onClickPrev:function(e){e.preventDefault(),this.goPrev()},_onClickNext:function(e){e.preventDefault(),this.goNext()},_onClickPageNumber:function(pageNumber){this.trigger("page-number:click",pageNumber)},_onNoteChange:function(){this.reportChange(!0)},_onNoteReset:function(){this.reportChange(!1)},_eachNote:function(handler,notes){notes=notes||_.pluck(this.notes,"note"),_.each(notes,function(note){return"string"==typeof handler?note[handler].apply(note):handler(note)})}},Obj.extend("a5.view.Notebook"),a5.view.NotebookTab={template:"a5.view.NotebookTab",init:function(parameters){this.vent=parameters.vent,this.page=parameters.page,this.note=parameters.note,this.$el=$("<li>",{class:"note-tab"}),_.bindAll(this,"_onClick","_onSubmit","_onKeydown"),this.$el.on("click",this._onClick),this.$el.on("submit",".go-note-page",this._onSubmit),this.$el.on("keydown",".current-note-page",this._onKeydown)},render:function(){this.$el.addClass("note-tab-"+this.page.index);var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html(html),this.$el},serializeData:function(){var page=this.page.number;return page<0&&(page=""),{page:page}},activate:function(){this.$el.addClass("active")},deactivate:function(){this.$el.removeClass("active")},_onClick:function(e){e.preventDefault(),this.vent.trigger("notebook-tab:click",this)},_onSubmit:function(e){e.preventDefault();var $currentPage=this.$el.find(".current-note-page"),page=_.isNaN(parseInt($currentPage.val(),10))?0:parseInt($currentPage.val(),10);this.vent.trigger("notebook-tab:submit",page)},_onKeydown:function(e){9===e.keyCode&&(this.$el.find(".go-note-page").submit(),e.preventDefault()),e.stopPropagation()}},Obj.extend("a5.view.NotebookTab"),a5.view.NotebookNote={init:function(parameters){this.page=parameters.page,this.vent=parameters.vent,this.editorSettings=parameters.editorSettings,this.$el=$("<div>",{class:"notebook-note"}),this.$el.addClass("note-"+this.page.index),this.$el.toggleClass("cover",this.page.cover),this.noteText=new a5.view.NotebookNoteText({text:this.page.note,vent:this.vent,parent:this,editorSettings:this.editorSettings}),this.pageNumber=new a5.view.NotebookNotePageNumber({number:this.page.number,vent:this.vent})},render:function(){return this.$el.empty(),this.$el.append(this.noteText.$el),this.$el.append(this.pageNumber.$el),this.noteText.render(),this.pageNumber.render(),this.$el},activate:function(){this.$el.addClass("active")},deactivate:function(){this.$el.removeClass("active")},editable:function(){this.noteText.editable()},cleanup:function(){this.noteText.cleanup()},reset:function(){this.noteText.reset()},save:function(){this.page.note=this.noteText.save()}},Obj.extend("a5.view.NotebookNote"),a5.view.NotebookNoteText={init:function(parameters){this.text=parameters.text,this.parent=parameters.parent,this.vent=parameters.vent,this.editorSettings=parameters.editorSettings,this.$el=$("<div>",{class:"note-text"}),_.bindAll(this,"compare","destroy","_onClick"),this.$el.on("click",this._onClick)},render:function(){return this.$el.html(this.text),this.$el},editable:function(){this.$el.attr("contenteditable",!0),this.editor=CKEDITOR.inline(this.$el[0],_.extend({toolbar:[["Bold","Italic","BulletedList"]],extraPlugins:"sharedspace",sharedSpaces:{top:this.parent.$el[0]}},this.editorSettings)),this.editor.on("key",this._onEditorKey,this),this.editor.on("change",this._onEditorChange,this)},cleanup:function(){_.defer(this.destroy)},destroy:function(){this.editor&&(this.editor.destroy(),this.editor=null)},reset:function(){this.cleanup(),this.$el.html(this.text),this.vent.trigger("note:reset")},compare:function(){this.text!==this.editor.getData()&&this.vent.trigger("note:change")},save:function(){return this.editor.getData()},_onEditorChange:function(e){_.defer(this.compare)},_onEditorKey:function(e){_.defer(this.compare),e.stop(),e.data.domEvent.stopPropagation()},_onClick:function(e){var href=$(e.target).attr("href");href&&(e.preventDefault(),a5.mainBuilder.engine.invoke("open-link",href))}},Obj.extend("a5.view.NotebookNoteText"),a5.view.NotebookNotePageNumber={init:function(parameters){this.vent=parameters.vent,this.number=parameters.number,this.$el=$("<div>",{class:"page-number"}),_.bindAll(this,"_onClick"),this.$el.on("click",this._onClick)},render:function(){return this.number>0&&this.$el.html(this.number),this.$el},_onClick:function(e){e.preventDefault(),this.vent.trigger("page-number:click",this.number)}},Obj.extend("a5.view.NotebookNotePageNumber"),a5.view.LONotesDialog={template:"a5.view.dialog.Notebook",init:function(lo){this._super({dialogClass:"notes-popup"}),this.notes=new a5.view.LONotebook(lo),this.lo=lo,this.notes.bind("page-number:click",this._onClickPageNumber,this)},renderContent:function(){var $notes=this.notes.render();this.$el.html($notes)},onShown:function(){this.notes.setup(),this._super()},onHidden:function(){this.notes.checkChanges(),this._super()},onShow:function(){this.notes.teardown(),this.notes.goTo(0,!0),this.notes.updateNotes(),this._super()},onHide:function(){this.notes.teardown(),this._super()},_onClickPageNumber:function(){this.close()}},a5.view.JQDialog.extend("a5.view.LONotesDialog"),a5.view.LONotebook={init:function(model,options){this._super(model,options),this.options.editorSettings=_.result(a5.dp.config,"loNotesEditor")},getTitle:function(){return this.model.LOInfo.title},getPages:function(){return this.pages||(this.pages=[{note:this.model.note,index:0,number:1,cover:!1,hasNotes:!0}]),this.pages},getTotalPages:function(){return 1},getPagesPerScreen:function(){return 1},getCurrentPageText:function(){return"1"},save:function(){this._super(),this.model.updateNotes(this.pages[0].note),this.model.saveNotes()}},a5.view.Notebook.extend("a5.view.LONotebook"),a5.view.InteractionToolbar={init:function(model,parent){this._super(model,parent,$('<div class="toolbar"></div>')),this.views=[],model.bind("reorder",_.bind(this.updateOrder,this))},updateOrder:function(){this.views=[],this.node.empty(),_.each(this.model.buttons,function(button){this._addButton(button)},this)},update:function(){_.each(this.model.buttons,function(button){_.includes(_.pluck(this.views,"model"),button)?button.callViews("update"):this._addButton(button)},this)},_addButton:function(button){var view=new a5.view.InteractionToolbarToggleButton(button);this.views.push(view),this.node.append(view.render()),view.update()}},a5.views.interaction.BaseView.extend("a5.view.InteractionToolbar"),a5.view.InteractionToolbarToggleButton={init:function(model,parent){this._super(model,parent,$('<div class="button toggle"></div>')),this.update()},update:function(){this.node.unbind(),this.model.isPressed()?this.node.addClass("activated"):this.node.removeClass("activated"),this.node.text(this.model.label),this.node.css(this.model.getCss()),this.node.addClass(this.model.getClasses().join(" ")),this.model.title&&this.node.attr("title",this.model.title),this.model.tts_audio&&(this.tts_player=new a5.views.TTS_Player(this.model.label),this.tts_player.render().prependTo(this.node));var model=this.model;this.node.click(function(e){model.click()}),this.node.on("keydown",function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||model.click()}),this.model.isEnable()?this.node.removeClass("disabled"):(this.node.removeClass("activated"),this.node.addClass("disabled"))}},a5.views.interaction.BaseView.extend("a5.view.InteractionToolbarToggleButton"),a5.views.MultiselectCheck={template:"a5.view.multiselectCheck",listElementSelector:".multiselectCheckList",init:function(choices){_.bindAll(this,"onSelectionChange"),this.choices=choices,this.$node=$(a5.service.templates.render(this.template,{})),this.choicesViews=_.map(this.choices,function(choice){return new a5.views.MultiselectCheckChoice(choice)}),this.bindEvents()},bindEvents:function(){_.each(this.choicesViews,function(choiceView){choiceView.bind("changed",this.onSelectionChange)},this)},onSelectionChange:function(data,selected){this.trigger("change",this.value())},render:function(){return this.$node.find(this.listElementSelector).empty(),this.$node.append(_.invoke(this.choicesViews,"render")),this.$node},value:function(){return _.chain(this.choicesViews).where({selected:!0}).pluck("data").value()}},Obj.extend("a5.views.MultiselectCheck"),a5.views.MultiselectCheckChoice={template:"a5.view.multiselectCheckChoice",checkboxElementName:'input[type="checkbox"].formCheck__input',init:function(data){this.data=data,this.$node=$(a5.service.templates.render(this.template,{data:this.data})),_.bindAll(this,"onToggleSelect"),this.bindEvents()},getCheckboxElement:function(){return this.$node.find(this.checkboxElementName)},render:function(){return this.$node},bindEvents:function(){this.getCheckboxElement().on("click",this.onToggleSelect)},onToggleSelect:function(el){this.selected=el.currentTarget.checked,this.trigger("changed",this.data,this.selected)}},Obj.extend("a5.views.MultiselectCheckChoice"),a5.views.PollBaseView={CHOICE_HTML:'<div class="choice"></div>',init:function(model,parent){this._super(model,parent,$(this.NODE_HTML)),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("update",this.onUpdate,this),_.bindAll(this,"onClick")},render:function(){return this._super(),_.each(this.model.ids,function(id,i){this.node.append($(this.CHOICE_HTML).attr("id",id).text(this.model.options[i]))},this),this.bindEvents(),this.node},bindEvents:function(){this.node.children().on("click",this.onClick)},unbindEvents:function(){this.node.children().off("click",this.onClick)},onStateUpdate:function(){this.unbindEvents(),"input"===this.model.state&&this.bindEvents()},onClick:function(ev){var $target=$(ev.target),id=$target.attr("id");$target.is(".selected")?(this.model.deselect(id),this.deselect(id)):(this.model.select(id),this.select(id))},onUpdate:function(){this.node.children().removeClass("selected"),_.each(this.model.selected,function(id){this.select(id)},this)},select:function(id){this.node.find("#"+id).addClass("selected")},deselect:function(id){this.node.find("#"+id).removeClass("selected")}},a5.views.interaction.BaseView.extend("a5.views.PollBaseView"),a5.views.RadioPoll={NODE_HTML:'<div class="poll single"></div>',select:function(id){this.node.children().removeClass("selected"),this._super(id)}},a5.views.PollBaseView.extend("a5.views.RadioPoll"),a5.views.CheckboxPoll={NODE_HTML:'<div class="poll multiple"></div>'},a5.views.PollBaseView.extend("a5.views.CheckboxPoll"),a5.views.PollsetBaseView={render:function(){var head=_.reduce(this.model.sets,function(memo,set){return memo.add($("<th></th>",{text:set}))},$("<th></th>")).wrapAll("<thead><tr></tr></thead>").eq(0).parent().parent(),body=_.reduce(this.model.ids,function(memo,id,i){return memo.add(_.reduce(this.model.setIds,function(memo,setId){return memo.add($(this.CHOICE_HTML).attr("id",setId+"-"+id).wrap("<td></td>").parent())},$("<th></th>",{text:this.model.options[i]}),this).wrapAll("<tr></tr>").eq(0).parent())},$([]),this).wrapAll("<tbody></tbody>").eq(0).parent();return this.node.append(head,body),this.bindEvents(),this.node},bindEvents:function(){this.node.find(".choice").on("click",this.onClick)},unbindEvents:function(){this.node.find(".choice").off("click",this.onClick)}},a5.views.PollBaseView.extend("a5.views.PollsetBaseView"),a5.views.RadiosetPoll={NODE_HTML:'<table class="pollset single"></table>',select:function(id){this.node.find("#"+id).parent().parent().find(".choice").removeClass("selected"),this._super(id)}},a5.views.PollsetBaseView.extend("a5.views.RadiosetPoll"),a5.views.CheckboxsetPoll={NODE_HTML:'<table class="pollset multiple"></table>'},a5.views.PollsetBaseView.extend("a5.views.CheckboxsetPoll"),a5.views.Toolbar={DEFAULT_TEMPLATE:'<div class="buttons"></div>',init:function($node){this.$node=$node,this.buttons=[],this.buttonTemplate=a5.mainBuilder.layout.getTemplate("toolbar_buttons")||this.DEFAULT_TEMPLATE},reset:function(){_.each(this.buttons,function(button){button.reset&&button.reset()},this)},clear:function(){this.$node.empty().html(this.buttonTemplate)},addButton:function(button){this.buttons.push(button)},render:function(){this.clear();var parent,container=this.$node.children(".buttons");_.each(this.buttons,function(button){button.parentSelector&&(parent=container.children(button.parentSelector)).length||(parent=container),button.render(parent)},this)}},Obj.extend("a5.views.Toolbar"),a5.views.Toolbar.Button={init:function(){this.$node=$(window.a5.mainBuilder.layout.getTemplate(this.template))},reset:function(){}},Obj.extend("a5.views.Toolbar.Button"),a5.views.Toolbar.TrayButton={init:function(){this.$content=$(window.a5.mainBuilder.layout.getTemplate(this.contentTemplate)),this._super()},render:function($parent){var $node=this.$node,$content=this.$content;$node.off("click").on("click",_.bind(function(){var show=!$node.hasClass("tray_open");$parent.children(".tray_open").removeClass("tray_open"),$parent.siblings(".toolbar_tray").not(".no-slide").not($content).slideUp(),$parent.siblings(".toolbar_tray.no-slide").not($content).hide();var duration=$content.hasClass("no-slide")?{duration:0}:{};show?($node.addClass("tray_open"),$content.slideDown($.extend({complete:_.bind(this.onShow,this)},duration))):$content.slideUp($.extend({complete:_.bind(this.onHide,this)},duration))},this)),$node.removeClass("tray_open"),this.$content.hide(),$parent.append($node),$parent.after($content)}},a5.views.Toolbar.Button.extend("a5.views.Toolbar.TrayButton"),a5.views.Toolbar.DictionaryButton={parentSelector:"#dictionary",template:"dictionary_searchbar",render:function($parent){var $node=this.$node;$node.click(function(){$node.hasClass("dictionary_searchbar_active")||($node.find(".hideonload").show($node.is(".no-slide")?void 0:"slide"),$node.addClass("dictionary_searchbar_active"))}),$node.delegate("a","click",function(e){e.preventDefault(),e.stopPropagation(),$node.find(".hideonload").hide($node.is(".no-slide")?void 0:"slide"),$node.removeClass("dictionary_searchbar_active")}),$parent.append($node)}};a5.views.Toolbar.Button.extend("a5.views.Toolbar.DictionaryButton"),a5.views.Toolbar.NotesButton={parentSelector:"#notes",template:"notes_area",contentTemplate:"notes_box",init:function(notes){this._super(),this.noteView=new a5.views.Toolbar.Notes(notes,a5.mainBuilder,this.$content)},render:function($parent){this._super($parent),this.noteView.render()},reset:function(){this.noteView.unbindEvents()},onShow:function(){this.trigger("notes:show")},onHide:function(){this.trigger("notes:hide")}},a5.views.Toolbar.TrayButton.extend("a5.views.Toolbar.NotesButton"),a5.views.Toolbar.LanguageSwitcher={template:"language_switcher",lang_label:'<span class="label language_label"></span>',init:function(interaction){this._super(),this.interaction=interaction,interaction.bind("language:change",this.onLangChange,this),this._original_language_label=this.$node.find(".label").text()},bindEvents:function(){this.$node.on("click",_.bind(this.onClick,this)),this.dropdown&&this.dropdown.node.remove(),this.dropdown=new a5.views.Toolbar.LanguageSwitcherDropdown(this.interaction),this.dropdown.hide(),this.$node.append(this.dropdown.render())},onLangChange:function(lang){var label=this.interaction.getLanguageLabel(lang);label?this.$node.find(".label").html(label):this.$node.find(".label").html(this._original_language_label)},onClick:function(){this.dropdown.toggle()},render:function($parent){this.$node.appendTo($parent),this.bindEvents()},reset:function(){}},a5.views.Toolbar.Button.extend("a5.views.Toolbar.LanguageSwitcher"),a5.views.Toolbar.LanguageSwitcherDropdown={NODE_TEMPLATE:"<div class='dropdown-slider'></div>",ELEMENT_TEMPLATE:"<a href='#' class='ddm' tabindex='-1'></a>",init:function(interaction){this._super({},null,$(this.NODE_TEMPLATE)),this.interaction=interaction,_.each(interaction.getRegisteredLanguages(),function(lang){var $element=$(this.ELEMENT_TEMPLATE);$element.html(lang),$element.attr("data-lang",lang),lang===interaction.getLanguage()&&$element.addClass("active"),$element.click(_.bind(this.setLanguage,this)),this.node.append($element)},this),interaction.bind("language:change",_.bind(this.onLangChange,this))},onLangChange:function(lang){this.node.find(".active").removeClass("active"),this.node.find("a[data-lang="+lang+"]").addClass("active")},toggle:function(){this.node.slideToggle()},hide:function(){this.node.hide()},show:function(){this.node.show(!0)},setLanguage:function(e){this.interaction.setLanguage($(e.target).attr("data-lang"))}},a5.views.interaction.BaseView.extend("a5.views.Toolbar.LanguageSwitcherDropdown"),a5.views.Toolbar.Notes={init:function(model,builder,$root){this.noteModel=model,this.builder=builder,this.$root=$root,this.interaction=builder.curInteraction,_.isUndefined(builder.curInteraction.xml)?this.loTitle="Notes":this.loTitle=builder.curInteraction.xml.title,this._hideAllNotesControls(),this.bindEvents()},reset:function(){this.unbindEvents()},bindEvents:function(){this.noteModel.bind("add",this.add,this),
this.noteModel.bind("update",this.update,this),this.noteModel.bind("remove",this.remove,this)},unbindEvents:function(){this.noteModel.unbind("add",this.add),this.noteModel.unbind("update",this.update),this.noteModel.unbind("remove",this.remove)},render:function(){this._uiEvents(),this._removeAllQuick(),_.each(this.noteModel.notes,function(n,index){this.add(index),this.update(index)},this),this.noteModel.notes.length>0&&this.$root.removeClass("no-notes")},_uiEvents:function(){this.find(".add_new_note").off("click").on("click",_.bind(function(){this.noteModel.addNote()},this)),this.find(".send_all_notes").off("click").on("click",_.bind(this._sendAllNotes,this)),this.find(".erase_all_notes").off("click").on("click",_.bind(function(){this.find(".erase_all_notes").addClass("erase_all_notes_selected"),this.find(".erase_all_check").show()},this)),this.find(".erase_all_yes").off("click").on("click",_.bind(function(){$(".erase_all_notes").removeClass("erase_all_notes_selected"),$(".erase_all_check").hide(),this.noteModel.removeAll()},this)),this.find(".erase_all_no").off("click").on("click",_.bind(function(){$(".erase_all_notes").removeClass("erase_all_notes_selected"),$(".erase_all_check").hide()},this)),this.find(".print_all_notes").off("click").on("click",_.bind(function(){var printPopup=window.open("","Print Notes Listing","menubar=0,location=0,height=400,width=500");try{printPopup.history.pushState(null,null,window.location.href)}catch(e){logger.error(e)}var html="<h1>"+this.loTitle+"</h1><h2>Notes List</h2><hr/><dl>";_.each(this.noteModel.notes,function(n,index){var date=new Date(n.date);html+="<dt>"+n.title+"</dt>",html+="<dd>"+n.text.replace(/\r\n|\r|\n/gm,"<br/>")+"<br/><i>"+date+"</i></dd>"}),html+="</dl>",printPopup.document.body.innerHTML=html,printPopup.print()},this))},_addAllNotesControls:function(){this.find(".send_all_notes").show(),this.find(".print_all_notes").show(),this.find(".erase_all_notes").show(),this.find(".no_notes_message").hide()},_hideAllNotesControls:function(){this.find(".send_all_notes").hide(),this.find(".print_all_notes").hide(),this.find(".erase_all_notes").hide(),this.find(".no_notes_message").show()},_sendAllNotes:function(){var body="Notes listing%0D%0A%0D%0A";_.each(this.noteModel.notes,function(n,index){var date=new Date(n.date);body+=date+" : "+n.title+"%0D%0A---------------------------------------------------------------------------------------------%0D%0A",body+=n.text.replace(/\r\n|\r|\n/gm,"%0D%0A")+"%0D%0A---------------------------------------------------------------------------------------------%0D%0A%0D%0A"},this);var title="Notes from "+self.loTitle;window.location.href="mailto:?body="+body+"&subject="+title},_indexOf:function($note){return this.find(".the_notes").children(".a_note").length-1-$note.index()},_removeAllQuick:function(){this.find(".the_notes").children(".a_note").remove()},find:function(selector){return this.$root.find(selector)},add:function(index){var $note=$(this.builder.layout.getTemplate("one_note")),$textarea=$note.find(".note_text_edit"),$heading=$note.find(".note_heading_input"),$options=$note.find(".note_options"),$menu=$note.find(".a_note_menu"),$erase=$note.find(".erase_note"),$print=$note.find(".print_note"),$send=$note.find(".send_note");this.find(".the_notes").prepend($note),$textarea.off("keyup").on("keyup",_.bind(function(){var caretPosition={selectionStart:$textarea.prop("selectionStart"),selectionEnd:$textarea.prop("selectionEnd")};this.noteModel.notes[this._indexOf($note)].setText($textarea.val()),$textarea.prop(caretPosition)},this)),$heading.off("keyup").on("keyup",_.bind(function(){this.noteModel.notes[this._indexOf($note)].setTitle($heading.val(),!0)},this)),$options.off("click").on("click",_.bind(function(){$options.toggleClass("note_options_selected").hasClass("note_options_selected")?$menu.slideDown():$menu.slideUp()},this)),$erase.off("click").on("click",_.bind(function(){this.noteModel.notes[this._indexOf($note)].remove()},this)),$print.off("click").on("click",_.bind(function(){var note=this.noteModel.notes[this._indexOf($note)],printPopup=window.open("","Print Note "+(index+1),"menubar=0,location=0,height=200,width=500");try{printPopup.history.pushState(null,null,window.location.href)}catch(e){logger.error(e)}var html="<h1>"+this.loTitle+"</h1><h2>"+note.title+"</h2><hr/>",date=new Date(note.date);html+="<p>"+note.text.replace(/\r\n|\r|\n/gm,"<br/>")+"<br/><i>"+date+"</i></p>",printPopup.document.body.innerHTML=html,printPopup.print()},this)),$send.off("click").on("click",_.bind(function(){var note=this.noteModel.notes[this._indexOf($note)];window.location.href="mailto:?body="+note.text.replace(/\r\n|\r|\n/gm,"%0D%0A")+"&subject="+note.title},this)),0==index&&this._addAllNotesControls()},update:function(index){var note=this.noteModel.notes[index],$notes=this.find(".the_notes").children(".a_note"),$note=$($notes[$notes.length-index-1]);$note.find(".note_heading").text(note.title),$note.find(".note_heading_input").val(note.title);var date=new Date(note.date);$note.find(".note_text_edit").val(note.text),$note.find(".saveDate").text(""+date)},remove:function(index){var notes=this.find(".the_notes").children(".a_note");$(notes[notes.length-index-1]).remove(),0==this.noteModel.notes.length&&(this._hideAllNotesControls(),this.$root.addClass("no-notes"))}},a5.views.interaction.BaseView.extend("a5.views.Toolbar.Notes"),a5.views.Toolbar.SoundButton={parentSelector:"#soundchart",template:"phoneme_button",contentTemplate:"phoneme_button_box",render:function($parent){this.$content.delegate(".tile","click",function(){var $tile=$(this),str=$tile.prop("class"),pos_1=str.indexOf("tile_"),pos_2=str.indexOf(" ",pos_1);str.substring(pos_1+5,pos_2)}),this._super($parent)}},a5.views.Toolbar.TrayButton.extend("a5.views.Toolbar.SoundButton"),a5.views.Toolbar.DropDownItem={parentSelector:"#attachments",init:function(label,attachment){this.label=label,this.attachment=attachment,this.main=!1},render:function($parent){this.main?this.$node=$('<a href="#" class="act_head_button tooltipz">'+this.label+"</a>"):this.$node=$('<a href="#" class="ddm" tabindex="-1"><span class="label">'+this.label+"</span></a>"),this.bindEvents(),$parent.append(this.$node)},bindEvents:function(){this.$node.on("click",_.bind(this._onClick,this))},_onClick:function(event){event.preventDefault(),this.attachment.open()}},Obj.extend("a5.views.Toolbar.DropDownItem"),a5.views.Toolbar.DropDownButton={parentSelector:"#attachments",init:function(label){this.label=label,this.items=[]},addItem:function(label,attachment){this.items.push(new a5.views.Toolbar.DropDownItem(label,attachment))},render:function($parent){this.$node=$("<div></div>");var $container=$('<div class="dropdown"></div>'),$toggle=$('<span class="toggle"></span>'),$button=$('<a href="#" class="act_head_button" tabindex="0"><span class="label">'+this.label+"</span></a>");$button.append($toggle);var lastClick=!1;$button.on("mousedown touchstart",function(e){lastClick=!0}),$button.on("click",function(e){e.preventDefault(),e.stopPropagation(),$toggle.hasClass("active")?($dropdown.delay(100).slideUp(function(){$button.removeClass("active")}),$toggle.removeClass("active")):($dropdown.slideDown("fast"),$toggle.addClass("active"),$button.addClass("active"))}),$button.focus(function(e){e.stopPropagation(),lastClick||$toggle.hasClass("active")||($dropdown.slideDown("fast"),$toggle.addClass("active"),$button.addClass("active")),lastClick=!1}),$button.blur(function(e){e.stopPropagation(),$toggle.hasClass("active")&&($dropdown.delay(100).slideUp(function(){$button.removeClass("active")}),$toggle.removeClass("active"))});var $dropdown=$('<div class="dropdown-slider">');_.each(this.items,function(item){item.render($dropdown)},this),$dropdown.css("minwidth","130px"),_.defer(function(){$dropdown.hide()}),$container.append($button),$container.append($dropdown),this.$node.append($container),$parent.append(this.$node)}},Obj.extend("a5.views.Toolbar.DropDownButton"),a5.views.Toolbar.ModelTextButton={parentSelector:"#attachments",render:function($parent){if(1==this.items.length){var item=this.items[0];item.label=this.label,item.main=!0,item.render($parent)}else this._super($parent)}},a5.views.Toolbar.DropDownButton.extend("a5.views.Toolbar.ModelTextButton"),a5.views.Toolbar.PrintButton={parentSelector:"#print",init:function(){if(window.matchMedia){window.matchMedia("print").addListener(_.bind(function(mql){mql.matches&&$(window).resize()},this))}$(window).on("beforeprint",function(ev){$(window).resize()})},render:function($parent){this.$node=$('<a href="#" class="act_head_button"><span class="label">Print</span></a>'),this.$node.click(function(){window.print()}),$parent.append(this.$node)}},Obj.extend("a5.views.Toolbar.PrintButton"),a5.views.Selectable={init:function(model,prefill,hideCheckboxes){this._super(model,null,$('<div class="choice_interaction"></div>')),this.prefill=prefill,this.hideCheckboxes=hideCheckboxes,this.children=[],_.each(this.model.choices,function(choice){var view=this.createViewFor(choice);this.append(view)},this)},append:function(child){this.children.push(child)},createViewFor:function(model){},render:function(){a5.service.templates.enableOnlyCachedMode();var html=a5.service.templates.render(this.template),$html=$(html);return this.node.html($html.html()),this.node.copyAttributes($html),a5.service.templates.disableOnlyCachedMode(),this.node.append(_.invoke(this.children,"render")),this.node.addClass("algn-"+this.model.alignment.substr(0,3)),this.prefill&&this.node.addClass("prefill"),this.hideCheckboxes?this.node.addClass("no-input"):this.node.addClass("has-input"),this.node}},a5.views.interaction.BaseView.extend("a5.views.Selectable"),a5.views.SelectableChoiceView={DEFAULT_TEMPLATE:'<span class="item"></span>',init:function(model,parent){this._super(model,parent,$('<div class="input-'+this.type+' no-input"></div>')),a5.service.templates.enableOnlyCachedMode();var html=a5.service.templates.render(this.template,{},"<div></div>"),$html=$(html);this.node.html($html.html()),this.node.copyAttributes($html),this.contentNode=$(a5.service.templates.render(this.contentTemplate,{showInColumns:this.showInColumns},this.DEFAULT_TEMPLATE)),a5.service.templates.disableOnlyCachedMode(),this.node.append(this.contentNode),this.node.addClass("input-"+this.type+"-"+_.str.slugify(this.model.value)),this.model.bind("change",this.updateSelected,this),this.model.parent.bind("change",this.updateSelected,this),this.model.parent.bind("state_update",this.updateFeedbackState,this),this.model.parent.bind("state_update",this.updateSelected,this),this.model.parent.gaptextaudio&&this.addTTSPlayer()},render:function(){this._super(),this.node.toggleClass("has-image",!!this.node.find("img").length),this.node.toggleClass("no-label",!this.node.text())},addInput:function(){return this.input=$('<input aria-hidden="true" type="'+this.type+'" />'),this.node.prepend(this.input).removeClass("no-input").addClass("has-input"),this},addTTSPlayer:function(){this.tts_player=new a5.views.TTS_Player($(this.model.content).text()),$(this.node).prepend(this.tts_player.render())},updateSelected:function(){var checkedClass="input-"+this.type+"-checked",hoverClass="input-"+this.type+"-hover";this.input&&this.input.attr("checked",this.model.isSelectedAnswer()),this.model.isSelectedAnswer()?(this.node.addClass(checkedClass),this.input||this.node.addClass("clickedanswer"),this.node.attr("aria-checked",!0)):(this.node.removeClass("clickedanswer"),this.node.removeClass(checkedClass),this.node.attr("aria-checked",!1)),this.node.unbind();var self=this;return"input"===this.model.parent.state&&"answers"!==this.model.state?this.model.tryAgainIsFrozen&&this.isLocked()||(this.node.click(function(){self.model.clicked()}),this.node.on("keydown",function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||self.model.clicked()}),this.node.mouseover(function(){self.node.addClass(hoverClass),self.input||self.node.addClass("input-noradio-hover")}),this.node.mouseout(function(){self.node.removeClass(hoverClass),self.node.removeClass("input-noradio-hover")})):"answers"!==this.model.parent.state&&"answers"!==this.model.state||this.model.correct&&(_.isUndefined(this.input)||this.input.attr("checked",!0)),this.input&&this.input.attr("disabled","input"!==this.model.parent.state||"answers"===this.model.state),this},updateFeedbackState:function(){this.node.removeClass("checked-empty checked-incorrect checked-correct"),this.node.removeClass("solution-empty solution-incorrect solution-correct");var type;if("feedback"==this.model.parent.state)type="checked";else{if("answers"!=this.model.parent.state)return;type="solution"}this.model.parent.isCorrect()?this.model.isSelectedAnswer()&&this.node.addClass([type,"correct"].join("-")):!this.model.correct&&this.model.isSelectedAnswer()?this.node.addClass([type,"incorrect"].join("-")):this.model.isSelectedAnswer()||("checked"===type?this.node.addClass("checked-empty"):"solution"===type&&this.model.correct&&this.node.addClass("solution-empty"))}},a5.views.interaction.BaseView.extend("a5.views.SelectableChoiceView"),a5.views.Radiobutton={init:function(model,prefill,hideRadios){this._super(model,prefill,hideRadios),this.node.attr("role","radiogroup"),this.firstRadioButton=_.first(this.children),this.lastRadioButton=_.last(this.children),this.firstRadioButton.node.attr("tabindex",0),_.bindAll(this,"onChoiceBlur"),this.node.on("focusout",this.onChoiceBlur)},selectChoice:function(choice){_.chain(this.children).without(choice).invoke("unselect"),choice.model.enableToggle?choice.toggle():choice.select()},selectPreviousChoice:function(current){var index,prev;current===this.firstRadioButton?prev=this.lastRadioButton:(index=this.children.indexOf(current),prev=this.children[index-1]),current.unselect(),prev.select(),prev.node.focus()},selectNextChoice:function(current){var index,next;current===this.lastRadioButton?next=this.firstRadioButton:(index=this.children.indexOf(current),next=this.children[index+1]),current.unselect(),next.select(),next.node.focus()},onChoiceBlur:function(){0===this.node.find("[tabindex=0]").length&&this.firstRadioButton.node.attr("tabindex",0)}},a5.views.Selectable.extend("a5.views.Radiobutton"),a5.views.RadiobuttonChoiceView={type:"radio",init:function(model,parent){this._super(model,parent),this.radioGroup=parent,_.bindAll(this,"onFocus","onBlur","onKeydown","onClick","onMouseOver","onMouseOut"),this.node.attr("role","radio"),this.unselect()},toggle:function(){this.selected?this.unselect():this.select()},select:function(){this.node.attr("tabindex",0),this.node.attr("aria-checked",!0),this.selected=!0},unselect:function(){this.node.attr("tabindex",-1),this.node.attr("aria-checked",!1),this.selected=!1},enable:function(){this.unbindEvents(),this.bindEvents()},disable:function(){this.unbindEvents()},unbindEvents:function(){this.node.off("focus",this.onFocus),this.node.off("blur",this.onBlur),this.node.off("keydown",this.onKeydown),this.node.off("click",this.onClick),this.node.off("mouseover",this.onMouseOver),this.node.off("mouseout",this.onMouseOut)},bindEvents:function(){this.node.on("focus",this.onFocus),this.node.on("blur",this.onBlur),this.node.on("keydown",this.onKeydown),this.node.on("click",this.onClick),this.node.on("mouseover",this.onMouseOver),this.node.on("mouseout",this.onMouseOut)},onFocus:function(e){},onBlur:function(e){},onKeydown:function(e){var KEYS=(e.currentTarget,a5.utils.keyCodes);switch(e.keyCode){case KEYS.SPACE:case KEYS.ENTER:this.radioGroup.selectChoice(this),this.node.focus();break;case KEYS.UP:this.radioGroup.selectPreviousChoice(this);break;case KEYS.DOWN:this.radioGroup.selectNextChoice(this);break;case KEYS.LEFT:this.radioGroup.selectPreviousChoice(this);break;case KEYS.RIGHT:this.radioGroup.selectNextChoice(this);break;default:return}e.stopPropagation(),e.preventDefault()},onClick:function(e){this.radioGroup.selectChoice(this),this.node.focus()},onMouseOver:function(e){},onMouseOut:function(e){}},a5.views.SelectableChoiceView.extend("a5.views.RadiobuttonChoiceView"),a5.views.NoValidateRadiobuttonChoiceView={type:"radio",addInput:function(){return this._super(),this.node.attr("tabindex","0"),this},updateFeedbackState:function(){}},a5.views.SelectableChoiceView.extend("a5.views.NoValidateRadiobuttonChoiceView"),a5.views.Checkbox={init:function(model,prefill,hideCheckboxes){this._super(model,prefill,hideCheckboxes),this.node.attr("role","group")}},a5.views.Selectable.extend("a5.views.Checkbox"),a5.views.CheckboxChoiceView={type:"checkbox",init:function(model,parent){this._super(model,parent),_.bindAll(this,"onFocus","onBlur","onKeydown","onClick","onMouseOver","onMouseOut"),this.node.attr("role","checkbox"),this.node.attr("tabindex",0),this.unselect()},toggle:function(){this.selected?this.unselect():this.select()},select:function(){this.node.attr("aria-checked",!0),this.selected=!0},unselect:function(){this.node.attr("aria-checked",!1),this.selected=!1},enable:function(){this.unbindEvents(),this.bindEvents()},disable:function(){this.unbindEvents()},unbindEvents:function(){this.node.off("focus",this.onFocus),this.node.off("blur",this.onBlur),this.node.off("keydown",this.onKeydown),this.node.off("click",this.onClick),this.node.off("mouseover",this.onMouseOver),this.node.off("mouseout",this.onMouseOut)},bindEvents:function(){this.node.on("focus",this.onFocus),this.node.on("blur",this.onBlur),this.node.on("keydown",this.onKeydown),this.node.on("click",this.onClick),this.node.on("mouseover",this.onMouseOver),this.node.on("mouseout",this.onMouseOut)},onFocus:function(e){},onBlur:function(e){},onKeydown:function(e){var KEYS=(e.currentTarget,a5.utils.keyCodes);switch(e.keyCode){case KEYS.SPACE:case KEYS.ENTER:this.toggle(),this.node.focus();break;default:return}e.stopPropagation(),e.preventDefault()},onClick:function(e){this.toggle(),this.node.focus()},onMouseOver:function(e){},onMouseOut:function(e){}},a5.views.SelectableChoiceView.extend("a5.views.CheckboxChoiceView"),a5.views.NoValidateCheckboxChoiceView={type:"checkbox",updateFeedbackState:function(){}},a5.views.SelectableChoiceView.extend("a5.views.NoValidateCheckboxChoiceView"),a5.views.SaveButton={init:function(interaction,imageId){this.interaction=interaction,this.imageId=imageId},render:function(){return this.$node=$('<a href="#"></a>'),this.imageId?(this.$node.addClass("save-interaction-image"),this.$node.html('<img src="'+a5_makeMediaURL(this.imageId)+'"/>')):(this.$node.addClass("save-interaction"),this.$node.text("Save")),this.$node.click(function(e){e.preventDefault(),this.interaction.store(!0)}.bindTo(this)),this}},Obj.extend("a5.views.SaveButton"),a5.views.TinyPlayer={NODE_TEMPLATE:"<span class='playbutton'></span>",init:function(){this.$node=$(this.NODE_TEMPLATE)},render:function(){return this.bindEvents(),this.$node},bindEvents:function(){this.$node.on("mousedown",this.onMouseDown.bindTo(this)),this.$node.on("click",this.onClick.bindTo(this))},onMouseDown:function(e){return this.playing?this.pause():this.play(),!1},onClick:function(e){return!1},pause:function(){this.playing=!1,this.trigger("pause"),this.$node.removeClass("playing")},play:function(){this.playing=!0,this.trigger("play"),this.$node.addClass("playing")}},Obj.extend("a5.views.TinyPlayer"),a5.views.TriggerWord={init:function(model,parent,interaction){this._super(model,parent,$('<span class="trigger-word">')),this.node.html(model.content),this.triggerTexts=[],this.visible=this.model.displayword,this.interaction=interaction},addTrigText:function(node){this.visible&&node.show(),this.triggerTexts.push(node)},bindEvents:function(){this.node.click(_.bind(function(e){e.preventDefault(),this.toggleTexts(),this.interaction.trigger("interaction:trigword:clicked",this)},this)),this.interaction.bind("interaction:trigword:clicked",_.bind(function(view){this!=view&&this.hideTexts(!0)},this))},_hide:function(){this.visible=!1,this.node.removeClass("current")},_show:function(){this.visible=!0,this.node.addClass("current")},toggleTexts:function(){this.visible&&!this.model.showonce?this.hideTexts():this.showTexts()},hideTexts:function(from_event){_.each(this.triggerTexts,function(text){this.model.simultaneous&&from_event||($(text).hide(),this._hide(),a5.service.media.pause($(text)))},this)},showTexts:function(){_.each(this.triggerTexts,function(text){$(text).show(),this._show()},this)},render:function(){var node=this._super();return this.visible&&this.node.addClass("current"),this.model.showonce&&this.node.addClass("trigger-once"),this.bindEvents(),node}},a5.views.interaction.BaseView.extend("a5.views.TriggerWord"),a5.views.TTS_Player={init:function(text){this._super(),this.$node.addClass("tts_audio"),this.text=text,a5.service.media.tts_audio.trim(this.text)||this.$node.hide()},bindEvents:function(){this._super(),this.bind("play",this.onPlay.bindTo(this)),this.bind("pause",this.onPause.bindTo(this)),this.$node.on("click",function(e){e.preventDefault(),e.stopPropagation()})},onPlay:function(){_.isUndefined(this.audio)&&(this.audio=a5.service.media.tts_audio.create(this.text)),this.audio&&(this.audio.play(),this.audio.bind("playback-end",this.onPlaybackEnd.bindTo(this)))},onPause:function(){this.audio&&this.audio.pause()},onPlaybackEnd:function(){this.pause()}},a5.views.TinyPlayer.extend("a5.views.TTS_Player"),a5.views.TextArea={ignoredKeys:[0,8,13,33,34,35,36,37,38,39,40,45,46],width:"100%",height:"40px",maxLength:350,spellcheck:!1,inline:!1,init:function(model,options){this._super(model,null,$('<div class="text-area-content"></div>')),_.each(options,function(value,key){value&&(this[key]=value)},this),this.model.bind("change",this.updateContent,this),this.model.bind("state_update",this.updateState,this),this.updateScores=_.throttle(function(){a5.mainBuilder.controls.update()},100)},buildInput:function(){return $("<textarea></textarea>")},render:function(){return this._super(),this.$input=this.buildInput().val(this.model.content),this.width&&this.$input.css("width",this.width),this.height&&this.$input.css({height:this.height,minHeight:a5.utils.endsWith(this.height,"%")?this.height:this.height+"px"}),this.$input.on("blur keyup",_.bind(this.updateModel,this)),this.addMaxLength(),this.node.append(this.$input),this.node.addClass("a5-textinput"),this.$input.attr("spellcheck",this.spellcheck),this.$input.on("paste",_.bind(function(e){this.checkMaxLength(e),this._trimMaxLength()},this)),this.$input.on("input",_.bind(function(e){this._trimMaxLength()},this)),this.autogrow&&autosize(this.$input),this.updateState(),this.node},updateModel:function(){this.model.data=this.$input.val(),this.updateScores()},updateContent:function(){this.$input.val(this.model.data)},updateState:function(){this.$input.attr("readonly","readonly"),"input"==this.model.state&&this.$input.removeAttr("readonly")},_trimMaxLength:function(){var text;"chars"==this.maxType&&this.maxLength?text=this.$input.val().substr(0,this.maxLength):"words"==this.maxType&&this.maxLength&&(text=this.$input.val(),text=text.replace(/(\s+)/g,"$1|&del!m&|"),text=text.split("|&del!m&|"),text=text.splice(0,this.maxLength).join("")),text&&text.length>=this.maxLength&&(this.$input.val(text),this.updateModel())},addMaxLength:function(){this.$input.keypress(_.bind(this.checkMaxLength,this)),this.hidemax||this.$input.keyup(_.bind(this.showMaxLabel,this)).blur(_.bind(this.hideMaxLabel,this)),this.hidemin||this.$input.keyup(_.bind(this.showMinLabel,this)).blur(_.bind(this.hideMinLabel,this))},wordCount:function(text){if(!text)return 0;var match=text.match(/[a-zA-Z0-9][a-zA-Z0-9\-']*/g);return match?match.length:0},getContent:function(){return this.$input.val()},currentLength:function(){var text=this.getContent();return"chars"==this.maxType?text.length:this.wordCount(text)},currentMinLength:function(){var text=this.getContent();return"chars"==this.minType?text.length:this.wordCount(text)},checkMaxLength:function(e){var currentLength=this.currentLength();"chars"!=this.maxType?currentLength>=this.maxLength&&!_.include(this.ignoredKeys,e.which)&&this.checkWordCount(e.which)&&e.preventDefault():currentLength>=this.maxLength&&!_.include(this.ignoredKeys,e.which)&&e.preventDefault()},caret:function(){return this.$input.caret()},checkWordCount:function(charCode){var val=this.getContent(),caret=this.caret(),text=val.slice(0,caret.begin)+String.fromCharCode(charCode)+val.slice(caret.end);return this.wordCount(text)>this.maxLength},showMaxLabel:function(){this.maxType&&this.createOrSetLabel("label-max-chars",Math.max(0,this.maxLength-this.currentLength())),this.createOrSetLabel("label-word-count",this.wordCount(this.getContent()))},showMinLabel:function(){var charLength=Math.max(0,this.minLength-this.currentMinLength());"chars"==this.minType?this.createOrSetLabel("label-min-chars",charLength):"words"==this.minType&&this.createOrSetLabel("label-min-word-count",charLength)},createOrSetLabel:function(cls,text){var template=this._renderTemplate();template||this._$skintemplate?this._createOrSetLabel_template(cls,text,template):this._createOrSetLabel_legacy(cls,text)},_renderTemplate:_.once(function(){return a5.service.templates.render("a5.view.TextInput.count")}),_createOrSetLabel_template:function(cls,text,template){this._$skintemplate||(this._$skintemplate=$(template),this._$skintemplate.prependTo(this.node)),this.$("."+cls).text(text)},_createOrSetLabel_legacy:function(cls,text){var $label=this.$("."+cls);0==$label.length&&($label=$('<div class="'+cls+'"></div>"').prependTo(this.node)),$label.text(text)},hideMaxLabel:function(){this.$(".label-max-chars, .label-word-count").remove(),this._$skintemplate&&(this._$skintemplate.remove(),delete this._$skintemplate)},hideMinLabel:function(){this.$(".label-min-chars, .label-min-word-count").remove(),this._$skintemplate&&(this._$skintemplate.remove(),delete this._$skintemplate)}},a5.views.interaction.BaseView.extend("a5.views.TextArea"),a5.views.TextInput={ignoredKeys:[0,8,13,33,34,35,36,37,38,39,40,45,46],height:null,inline:!1,buildInput:function(){return $('<input type="text" />')},render:function(){return this._super(),this.node.toggleClass("inline",this.inline),this.node.addClass("a5-textinput"),this.node.find("input").css("resize","none"),this.node}},a5.views.TextArea.extend("a5.views.TextInput"),a5.views.ShowText={init:function(model){this._super(model,null,$('<span class="show-text"></span>')),this.model.bind("change",this.updateContent,this)},render:function(){return this._super(),this.updateContent(),this.node},updateModel:function(model){this.model=model,this.model.bind("change",this.updateContent,this)},updateContent:function(){this.model.cke?this.node.html(this.model.cke.getData()):this.node.html(_.escape(this.model.data).replace(/\n/g,"<br />"))}},a5.views.interaction.BaseView.extend("a5.views.ShowText"),a5.views.RichTextArea={initCK:function(){this.node.removeClass("a5-textinput"),this.node.addClass("a5-richtextinput"),this.richtext=!0;var toolbar=[["Bold","Italic","Underline","Superscript","Subscript","-","NumberedList","BulletedList"]],opts=a5.mainBuilder.options(),all=[["French","French"],["Spanish","Spanish"],["German","German"],["Danish","Danish"],["Polish","Polish"],["Swedish","Swedish"],["Turkish","Turkish"],["Ancient Greek","Ancient_Greek"],["Scientific Characters","Scientific_Characters"]],csconfig=[];_.each(all,function(k){opts.specialcharactersStudentHas(k[1])&&csconfig.push(k)}),csconfig.length>0&&toolbar[0].push("SpecialCharsButton");var config={width:this.width,height:this.height,toolbar:toolbar,customConfig:"",stylesSet:[],contentsCss:[CKEDITOR.getUrl("contents.css"),A5.SKIN_URL+"css/ckeditor.css"]};config.specialCharSetsNames=csconfig,config.extraPlugins="avaspecialchar,resize,focusfix",opts.textboxAutogrowIsOn()?(config.autoGrow_minHeight=50|this.height,config.extraPlugins+=",autogrow"):(config.removePlugins="autogrow",config.resize_enabled=!0,config.resize_dir="both",$(this.node,this.model.interaction.contentZone).length&&(this.model.interaction.onInteractionShowedListeners.register(_.partial(_.defer,this.updateResizeConfig.bindTo(this))),$(window).resize(this.updateResizeConfig.bindTo(this)))),this.$input.ckeditor(_.bind(this.ckeInitialized,this),config),this.model.cke=this.cke=this.$input.ckeditorGet()},onFontChange:function(){this.updateFont()},updateResizeConfig:function(){if(this.model.interaction===a5.mainBuilder.curInteraction){var editor=this.$input.ckeditorGet(),maxWidth=this.model.interaction.contentZone.width()+this.model.interaction.contentZone.offset().left-this.node.offset().left,dom=editor.getResizable();dom&&dom.$.offsetWidth>maxWidth&&editor.resize(maxWidth),editor.config.resize_maxWidth=maxWidth}},ckeInitialized:function(){this.addMaxLength(),this.model.bind("state_update",this.updateState,this),this.updateState(),a5.hooks.interactionFontUpdated.add(this.onFontChange.bind(this)),this.updateFont()},updateState:function(){this.cke&&"ready"==this.cke.status&&("input"==this.model.state&&this.cke.readOnly?this.cke.setReadOnly(!1):"input"==this.model.state||this.cke.readOnly||this.cke.setReadOnly(!0),this.cke.on("change",_.bind(function(){this.cke.updateElement(),this.updateModel()},this)))},updateContent:function(){this.cke.setData(this.model.data)},updateFont:function(){var editor=this.$input.ckeditorGet(),fontClasses=a5.mainBuilder.getCurrentFontClasses(),regex=a5.mainBuilder.getFontClassesRegex(),ckeDocument=editor.document,ckeHtml=ckeDocument.getDocumentElement(),$ckeHtml=$(ckeHtml.$,ckeDocument.$);$ckeHtml.removeClass(function(index,className){return className.split(/\s+/).filter(function(c){return c.match(regex)}).join(" ")}),$ckeHtml.addClass(fontClasses.join(" "))},getContent:function(){return this.cke.document.getBody().getText()},addMaxLength:function(){this.cke&&(this.cke.on("key",_.bind(this.checkMaxLength,this)),this.hidemax||(this.cke.on("blur",_.bind(this.hideMaxLabel,this)),this.cke.document.on("keyup",_.bind(this.showMaxLabel,this))),this.hidemin||(this.cke.on("blur",_.bind(this.hideMinLabel,this)),this.cke.document.on("keyup",_.bind(this.showMinLabel,this))))},checkMaxLength:function(e){var nativeEvent={which:e.data.keyCode,preventDefault:function(){e.cancel()}};this._super(nativeEvent)},caret:function(){var ranges=this.cke.getSelection().getRanges();return ranges.length?{begin:ranges[0].startOffset,end:ranges[0].endOffset}:{begin:0,end:0}}},a5.views.TextArea.extend("a5.views.RichTextArea"),a5.views.InfoText={init:function(icon,content,klass,reference){this._super(null,null,$('<div class="info-text"></div>')),this.icon=icon||"",this.$content=$("<div/>").html(content),this.contentText=this.$content.text(),this.klass=klass,this.reference=reference,_.bindAll(this,"_onHoverIn","_onHoverOut","_onTouchEnd","_onBodyTouchEnd","_onClick")},render:function(){this._super();var $handle=$('<div class="handle"></div>').appendTo(this.node);if("/"==this.icon.substr(0,1)){$("<img/>").appendTo($handle).attr("src",A5.SKIN_URL+"images/icons"+this.icon)}else $handle.text(this.icon);return this._hasDictionaryAttached()?this._renderDictionary():this._hasReferenceAttached()?this._renderReference():this._renderTooltip(),this.node.addClass(this.klass),this.node},_renderTooltip:function(){this.$tooltip=$('<div class="tooltip"></div>').appendTo(this.node),this.$tooltip.html(this.$content),this.node.hover(this._onHoverIn,this._onHoverOut),this.node.on("touchend",this._onTouchEnd),$("body").on("touchend",this._onBodyTouchEnd)},_renderDictionary:function(){var ref=this.contentText.replace(/^dict:/gi,"");this.url=this._buildDictionaryUrl(ref),this.$iframe=$('<iframe frameborder="0" allowfullscreen="true" class="dictionary">').attr("src",this.url),this.node.addClass("info-text-dictionary"),this.node.on("click",_.partial(this._onClick,"dictionary"))},_renderReference:function(){var text=this.contentText,match=this._matchReference(text),index=parseInt(match&&match[1],10)-1,page=match&&match[2];this.url=this._buildReferenceUrl(index,page),
this.$iframe=$('<iframe frameborder="0" allowfullscreen="true" class="reference">').attr("src",this.url),this.node.addClass("info-text-reference"),this.node.on("click",_.partial(this._onClick,"reference"))},_hasDictionaryAttached:function(){return!!this.reference&&!!this.contentText.match(/^dict:/gi)},_hasReferenceAttached:function(){return!!this.reference&&!!this._matchReference(this.contentText)},_matchReference:function(text){return/^ref\s*(\d+)(?::(?:page)?\s*(\d+))?/i.exec(text)},_onHoverIn:function(e){if(!this.$tooltip.is(".active")){this.$tooltip.css("visibility","hidden"),this.$tooltip.removeClass("from-right from-below overflows-left overflows-right"),this.$tooltip.addClass("active");var scrollParent=a5.utils.scrollParent(this.$tooltip),wh=this.$tooltip.naturalSize({padding:0},{width:"2000px"});this.$tooltip.width(wh[0]+1);var fromRight=this.node.offset().left>scrollParent.left+scrollParent.width/2,fromBelow=this.$tooltip.offset().top+this.$tooltip.outerHeight()>scrollParent.top+scrollParent.height-a5.dp.config.exclusionBottom,overflowsLeft=this.$tooltip.offset().left<scrollParent.left,overflowsRight=this.$tooltip.offset().left+this.$tooltip.outerWidth()>scrollParent.left+scrollParent.width;this.$tooltip.toggleClass("from-right",fromRight),this.$tooltip.toggleClass("from-below",fromBelow),this.$tooltip.toggleClass("overflows-left",overflowsLeft),this.$tooltip.toggleClass("overflows-right",overflowsRight),this.$tooltip.css("visibility","")}},_onTouchEnd:function(e){this._onHoverIn(e)},_onHoverOut:function(e){this.$tooltip.removeClass("active")},_onBodyTouchEnd:function(e){$.contains(this.node[0],e.target)||this._onHoverOut(e)},_onClick:function(eventPrefix){_.result(a5.dp.config,"referenceOpenInTab")?window.open(this.url,"reference"):this.$iframe.iframeModal({open:function(){a5.eventBus.trigger(eventPrefix+":open",this)},close:function(){a5.eventBus.trigger(eventPrefix+":close",this)}})},_buildDictionaryUrl:function(ref){return this._addQueryStringSeparator(this.reference[0])+"a5_dictionary_ref="+encodeURIComponent(ref)+"&a5_store=false&a5_restore=false&a5_lms_close=false"},_buildReferenceUrl:function(index,page){return this._addQueryStringSeparator(this.reference[index])+"page="+encodeURIComponent(page)+"&a5_store=false&a5_restore=false&a5_lms_close=false&a5_book_pages_per_screen=1"},_addQueryStringSeparator:function(url){return url.indexOf("?")>=0?url+"&":a5.utils.endsWith(url,"/")?url+"?":url+"/?"}},a5.views.interaction.BaseView.extend("a5.views.InfoText"),a5.views.UserSelection={init:function(model,step,max,multiple){this._super(model,null,$('<div class="user-selection interaction is-dropdown"></div>')),this.step=step,this.max=max,this.multiple=multiple,this.choices=this.createTemplateModel(),this.displayCategories=this.choices.groups.length>1,this.multiple?this.initMultipleCategory(this.choices.groups):this.initSingleCategory(this.choices.groups),this.range_model=new a5.models.interaction.ISDropdownModel({prefill:!1,correctFeedback:!1,incorrectFeedback:!1}),_.each(this.choices.ranges,_.bind(function(choice,i){var choiceModel=new a5.models.interaction.ISDropdownChoiceModel({content:$("<span>").html(choice),key:i});this.range_model.add(choiceModel)},this))},initMultipleCategory:function(groups){this.group_model=groups},initSingleCategory:function(groups){this.group_model=new a5.models.interaction.ISDropdownModel({prefill:!1,correctFeedback:!1,incorrectFeedback:!1}),_.each(groups,_.bind(function(choice,i){var choiceModel=new a5.models.interaction.ISDropdownChoiceModel({content:$("<span>").html(choice),key:i});this.group_model.add(choiceModel)},this))},createTemplateModel:function(){for(var model={groups:this.model.getAllInteractionsGroups(),ranges:[]},i=this.step;i<=this.max;i+=this.step)model.ranges.push(i);return model},render:function(){return this._super(),this.node.html(a5.service.templates.render("a5.view.UserSelection",{hideGroups:!this.displayCategories})),this.groupSelectView=this.initGroupSelectView(),this.dropdownRangeView=new a5.views.interaction.ISRichDropdownView(this.range_model),this.node.find(".user-selection-range").html(this.dropdownRangeView.render()).removeClass("user-selection-range"),this.displayCategories&&this.node.find(".user-selection-group").html(this.groupSelectView.render()).removeClass("user-selection-group"),this.node.on("click",".user-selection-confirm",_.bind(this.onClick,this)),this.node},onClick:function(){if(this.model.options().activitypoolIsOn()){var groups=this.getSelectedGroups(),count=this.getCount();groups.length&&!_.isNaN(count)&&(this.model.initIntList({allowIntroScreen:!1,shuffle:!0,groups:groups,count:count}),this.model.loadScreensOnDemand?this.model.goTo(0):this.model.openIntList(this.model.intList,0))}},getSelectedGroups:function(){if(this.displayCategories){if(this.multiple)return this.groupSelectView.value();var selected=this.group_model.selected&&this.group_model.selected.content.text();return _.compact([selected])}return this.choices.groups},getCount:function(){var count=this.range_model.selected&&this.range_model.selected.content.text();return parseInt(count,10)},initGroupSelectView:function(){return this.multiple?new a5.views.MultiselectCheck(this.group_model):new a5.views.interaction.ISRichDropdownView(this.group_model)}},a5.views.interaction.BaseView.extend("a5.views.UserSelection"),a5.view.Clock={init:function(model,parent){this._super(model,parent,$('<div class="clock"><div class="minutes hand" /><div class="hours hand" /></div>')),this.node.addClass(model.className)},render:function(){return this._super(),this.update(),this.model.locked?this.node.addClass("locked"):this._bindEvents(),this.node},update:function(){var time=this.model.getTime(),mins=time.getMinutes();_.each({".hours":30*time.getHours()+mins/2,".minutes":6*mins},function(angle,hand){this.$(hand).css("transform","rotate("+angle+"deg)")},this)},_bindEvents:function(){var isHourDrag,dragCenter,dragAngle,self=this,dragging=!1;this.$(".hand").on("mousedown touchstart",function(e){if("touchstart"==e.type||1==e.which){dragging=!0,self.node.addClass("clock-dragging"),isHourDrag=$(this).is(".hours");var increment=isHourDrag?30:6,bBox=self.node.bBox();dragCenter=[bBox.left+bBox.width/2,bBox.top+bBox.height/2],dragAngle=Math.round(self._angle(dragCenter,self._getEventPoint(e))/increment)*increment}}).on("dragstart",function(e){e.preventDefault()}),$(document).on("mousemove touchmove",function(e){dragging&&(dragAngle=self._moveHand(dragCenter,dragAngle,isHourDrag,self._getEventPoint(e)),e.preventDefault())}).on("mouseup touchend",function(e){dragging=!1,self.node.removeClass("clock-dragging")})},_getEventPoint:function(e){return[e.pageX||e.originalEvent.touches&&e.originalEvent.touches[0].pageX,e.pageY||e.originalEvent.touches&&e.originalEvent.touches[0].pageY]},_moveHand:function(center,oldAngle,isHourDrag,point){var increment=isHourDrag?30:6,angle=Math.round(this._angle(center,point)/increment)*increment;if(oldAngle===angle||_.isNaN(angle))return oldAngle;var multiplier=isHourDrag?12e4:1e4,diff=(angle-oldAngle)%360;return Math.abs(diff)>180&&(diff+=-360*Math.sign(diff)),this.model.addTime(multiplier*diff),this.update(),angle},_angle:function(center,point){var vfrom=[100,0],vto=[point[0]-center[0],point[1]-center[1]],dot=vfrom[0]*vto[0]+vfrom[1]*vto[1],cross=vfrom[0]*vto[1]-vfrom[1]*vto[0];return 180*Math.atan2(cross,dot)/Math.PI}},a5.views.interaction.BaseView.extend("a5.view.Clock"),a5.views.ContentMessage={init:function(message,rawMessage){this.message=message,this.$el=$("<div>",{class:"content-message-link","data-message":rawMessage}),_.bindAll(this,"_onClick"),this.$el.on("click",this._onClick)},render:function(){return this.$el},send:function(){a5.service.postMessager.sendMessage("contentmessage",{arguments:this.message})},_onClick:function(e){e.preventDefault(),this.send()}},Obj.extend("a5.views.ContentMessage"),a5.views.ImageHotspot={NODE_TEMPLATE:'<div class="hotspot image-hotspot"><div class="hotspot-content"></div></div>',width:0,height:0,top:0,left:0,visited:!1,visible:!1,init:function(model){this._super(model,null,$(this.NODE_TEMPLATE))},render:function(){var styles=_(this.model.style.split(";")).compact(),ignoredStyles=["background-color","opacity"];return styles=_(styles).reject(function(style){var rule=style.split(":");return _(ignoredStyles).contains(rule[0].trim())}),this.node.attr("style",styles.join(";")),this.node.on("click",this.toggle.bindTo(this)),this.$content=this.node.find(".hotspot-content"),this.$content.append(this.model.text),this.$content.hide(),this.node},toggle:function(){this.visited=!0,this.visible=!this.visible,this.node.toggleClass("visited",this.visited),this.node.toggleClass("active",this.visible),this.visible?this.$content.show():this.$content.hide()}},a5.views.interaction.BaseView.extend("a5.views.ImageHotspot"),a5.view.TeamScoring={TEMPLATE:'<div class="team-score"><div class="team"></div><div class="score"></div></div>',init:function(model){this.model=model,this.$el=$(window.a5.mainBuilder.layout.getTemplate("team_score")||this.TEMPLATE)},render:function(){return this.$team=this.$el.find(".team"),this.$score=this.$el.find(".score"),this.$team.empty().append(this.model.team),this.$score.empty().append(this.model.points),this.$el.toggleClass("active",this.model.active),this.$el}},Obj.extend("a5.view.TeamScoring"),a5.view.Moderator={DELAY:2e3,TEMPLATE:'<div class="teams-scoring"></div>',init:function(model){this.model=model,this.children=_(model.teamScores).map(function(teamScore){return new a5.view.TeamScoring(teamScore)},this),_.bindAll(this,"onTurnChange","onScore","onFinalScore","showScoreboard","showFinalScoreboard","onCloseScoreboard"),this.model.bind("interaction:teams:turn:change",this.onTurnChange),this.model.bind("interaction:teams:finalscore",this.onFinalScore),this.model.bind("interaction:teams:score",this.onScore),this.$el=$(this.TEMPLATE),this.scoreBoardVisible=!1,this.DELAY=a5.dp.config.teamScoringDelay||this.DELAY},onTurnChange:function(last,current){last.setActive(!1),current.setActive(!0)},onFinalScore:function(teamScores){_.delay(this.showFinalScoreboard,this.DELAY)},onScore:function(teamScore){_.delay(this.showScoreboard,this.DELAY,teamScore)},showScoreboard:function(current){this.scoreBoardVisible||(this.scoreBoardVisible=!0,a5.view.dialog.display("a5.view.dialog.TeamsScoreboard",{dialogClass:"dialog-teams-scoreboard",teams:_(this.model.teamScores).map(function(t){return{team:t.team,points:t.points,active:current==t?"active":""}})},{close:this.onCloseScoreboard},void 0,void 0,a5.dp.config.appendTeamScoreTo))},showFinalScoreboard:function(){var result,winners=this.model.winners();0===winners.length&&(result="draw"),a5.view.dialog.display("a5.view.dialog.TeamsFinalScoreboard",{dialogClass:"dialog-teams-finalscoreboard",teams:_(this.model.teamScores).map(function(t){return{team:t.team,points:t.points,result:result||(_(this.model.winners()).contains(t)?"winner":"")}},this)},{})},onCloseScoreboard:function(){this.scoreBoardVisible=!1,this.render()},render:function(){return this.$el.empty(),_(this.children).each(function(child){this.$el.append(child.render())},this),this.$el}},Obj.extend("a5.view.Moderator"),function(a5,$,_){a5.views.LONavigation={TEMPLATE:'<div class="lo-navigation-toolbar"><a class="lo-navigation-btn previous">Prev</a><a class="lo-navigation-btn next">Next</a><a class="lo-navigation-btn toc">TOC</a></div>',init:function(model,$el){_.bindAll(this,"onClickNext","onClickPrev","onClickTOC"),this.$el=$el,this.model=model},render:function(){return this.$el.show(),this.$el.on("click","a.lo-navigation-btn.previous",this.onClickPrev),this.$el.on("click","a.lo-navigation-btn.next",this.onClickNext),this.$el.on("click","a.lo-navigation-btn.toc",this.onClickTOC),this.$el},onClickPrev:function(e){e.preventDefault(),this.model.goToPrevLO()},onClickNext:function(e){e.preventDefault(),this.model.goToNextLO()},onClickTOC:function(e){e.preventDefault(),this.model.close()}},Obj.extend("a5.views.LONavigation")}(a5,jQuery,_),a5.views.LinkingLinesInputHandler={init:function($node,childrenSelector){this.$node=$node,this.childrenSelector=childrenSelector,this.erasing=!1,this.linking=!1},setErasing:function(erasing){this.erasing=erasing},isErasing:function(){return this.erasing}},Obj.extend("a5.views.LinkingLinesInputHandler"),a5.views.LinkingLinesDragHandler={init:function($node,childrenSelector,$container){this._super($node,childrenSelector),_.bindAll(this,"onMove","onFinish","onChildSelect"),this.$container=$container||$(document.body)},bindEvents:function(){this.unbindEvents(),this.$container.on("mousemove touchmove",this.onMove).on("mouseup touchend",this.onFinish),this.$node.find(this.childrenSelector).on("mousedown touchstart",this.onChildSelect)},unbindEvents:function(){this.$container.off("mousemove touchmove",this.onMove).off("mouseup touchend",this.onFinish),this.$node.find(this.childrenSelector).off("mousedown touchstart",this.onChildSelect)},onMove:function(ev){if(this.linking){var myEv=ev.originalEvent.touches?ev.originalEvent.touches[0]:ev,pos=_.pick(myEv,"pageX","pageY","clientX","clientY");this.trigger("linking",pos,this.$container),ev.preventDefault()}},onFinish:function(ev){if(this.linking){var myEv=ev.originalEvent.changedTouches?ev.originalEvent.changedTouches[0]:ev,pos=_.pick(myEv,"pageX","pageY","clientX","clientY"),children=this.$node.find(this.childrenSelector),element=document.elementFromPoint(pos.clientX,pos.clientY),$element=children.is(element)?element:children.has(element).get(0);this.linking=!1,this.trigger("finish",pos,$element,this.$container)}},onChildSelect:function(ev){var myEv=ev.originalEvent.touches?ev.originalEvent.touches[0]:ev,pos=_.pick(myEv,"pageX","pageY","clientX","clientY");this.erasing?this.trigger("erase",pos,ev.currentTarget):(this.linking=!0,this.trigger("start",pos,ev.currentTarget)),$(ev.target).is(".playbutton, .play-button")||ev.preventDefault()}},a5.views.LinkingLinesInputHandler.extend("a5.views.LinkingLinesDragHandler"),a5.views.LinkingLinesTouchHandler={init:function($node,childrenSelector,$container){this._super($node,childrenSelector),_.bindAll(this,"onMove","onChildSelect"),this.$container=$container||$(document.body)},bindEvents:function(){this.unbindEvents(),this.$container.on("mousemove",this.onMove),this.$node.find(this.childrenSelector).on("click",this.onChildSelect)},unbindEvents:function(){this.$container.off("mousemove",this.onMove),this.$node.find(this.childrenSelector).off("click",this.onChildSelect)},onMove:function(ev){if(this.linking){var pos=_.pick(ev,"pageX","pageY","clientX","clientY");this.trigger("linking",pos,this.$container)}},onChildSelect:function(ev){ev.preventDefault();var myEv=ev.originalEvent.touches?ev.originalEvent.touches[0]:ev,pos=_.pick(myEv,"pageX","pageY","clientX","clientY");this.erasing?this.trigger("erase",pos,ev.currentTarget):this.linking?(this.linking=!1,this.trigger("finish",pos,ev.currentTarget)):(this.linking=!0,this.trigger("start",pos,ev.currentTarget))}},a5.views.LinkingLinesInputHandler.extend("a5.views.LinkingLinesTouchHandler"),a5.views.Countdown={template:"a5.view.dialog.Countdown",init:function(model,parent,options){a5.service.templates.enableOnlyCachedMode(),this._super(model,parent,$(a5.service.templates.render(this.template))),a5.service.templates.disableOnlyCachedMode(),this.options=options||{},this.model.bind("progress",this.onProgress,this),this.model.bind("start",this.onStart,this),this.model.bind("stop",this.onStop,this),this.model.bind("end",this.onEnd,this),this.model.bind("reset",this.onReset,this),_.bindAll(this,"onClickPlay","onClickPause","onClickClose","onClickReset","onClickAlarm"),this.options.alarm&&(this.alarmAudio=a5.service.media.audio.create("_"+this.options.alarm,{url:this.options.alarm}))},render:function(){return this.node.off(),this.$(".pause").hide(),this._setDisplayTime(a5.utils.secondsToTime(this.model.totalTime,"paddingZeros")),this.node.on("click",".close",this.onClickClose),this.node.on("click",".play",this.onClickPlay),this.node.on("click",".reset",this.onClickReset),this.node.on("click",".pause",this.onClickPause),this.node.draggable({containment:"window"}),this.parent.$(".countdown").addClass("disabled"),this.options.alarm&&(this.node.addClass("alarm-on"),this.node.on("click",".alarm",this.onClickAlarm)),a5.hooks.countdownRendered.call(this),this.node},onClickPlay:function(e){this.model.start(),e.preventDefault(),e.stopPropagation()},onClickPause:function(e){this.model.pause(),this.$(".pause").hide(),this.$(".play").show(),e.preventDefault(),e.stopPropagation()},onClickReset:function(e){this.model.reset(),this.$(".play").show(),this.$(".pause").hide(),e.preventDefault(),e.stopPropagation()},onClickAlarm:function(e){this.node.toggleClass("alarm-on"),e.preventDefault(),e.stopPropagation()},onClickClose:function(e){this.model.stop(),this.node.remove(),this.alarmAudio&&this.alarmAudio.stop(),e.preventDefault(),e.stopPropagation(),this.parent.$(".countdown").removeClass("disabled")},onProgress:function(seconds,percentage){this._setDisplayTime(a5.utils.secondsToTime(seconds,"paddingZeros")),this.$(".progress").data("progress",percentage),this.$(".progress").trigger("countdown:tick",[percentage,seconds])},onStop:function(){this.$(".play").hide(),this.$(".pause").hide()},onStart:function(){this.$(".play").hide(),this.$(".pause").show()},onEnd:function(){this.alarmAudio&&this.node.hasClass("alarm-on")&&(this.alarmAudio.play(),logger.log("Playing alarm: ",this.options.alarm))},onReset:function(seconds){this._setDisplayTime(a5.utils.secondsToTime(seconds,"paddingZeros")),this.$(".progress").data("progress",0),this.$(".progress").trigger("countdown:reset")},_setDisplayTime:function(hhmmss){var parts=hhmmss.split(":");this.$(".hours").html(parts[0]),this.$(".minutes").html(parts[1]),this.$(".seconds").html(parts[2])}},a5.views.interaction.BaseView.extend("a5.views.Countdown"),a5.views.CountdownSetup={template:"a5.view.dialog.CountdownSetup",init:function(model,parent,options){a5.service.templates.enableOnlyCachedMode(),this._super(model,parent,$(a5.service.templates.render(this.template))),a5.service.templates.disableOnlyCachedMode(),this.defaultTime=this._isValidTime(a5.dp.config.bookCountdownTime)&&a5.dp.config.bookCountdownTime||"00:00:00",this.options=options||{},this.countdownSetupAlarm=new a5.view.CountdownSetupAlarm,this.countdownSetupAlarm.bind("alarm:off",this.onAlarmOff,this),this.countdownSetupAlarm.bind("alarm:on",this.onAlarmOn,this),_.bindAll(this,"onClickStart","onClickClose","onClickReset","onClickAlarm","onInputFocus","onInputBlur","onInputKeydown","onInputKeyup","onInputChanged")},render:function(){return this.node.off(),this.$hours=this.$(".hours input"),this.$minutes=this.$(".minutes input"),this.$seconds=this.$(".seconds input"),this._setDisplayTime(this.defaultTime),this.refreshStartButton(),this.node.on("click",".close",this.onClickClose),this.node.on("click",".start",this.onClickStart),this.node.on("click",".reset",this.onClickReset),this.node.on("click",".alarm",this.onClickAlarm),this.$("input").on("focus",this.onInputFocus),this.$("input").on("blur",this.onInputBlur),this.$("input").on("keydown",this.onInputKeydown),this.$("input").on("keyup",this.onInputKeyup),this.$("input").on("change",this.onInputChanged),this.node.find(".alarm-options").append(this.countdownSetupAlarm.$el),this.countdownSetupAlarm.render(),this.node.show(),a5.hooks.countdownSetupRendered.call(this),this.node},close:function(){_.isFunction(this.options.onClose)&&this.options.onClose(),this.node.hide()},start:function(hhmmss){var model=new a5.models.Countdown({total:a5.utils.timeToSeconds(hhmmss)}),view=new a5.views.Countdown(model,this.parent,{alarm:this.countdownSetupAlarm.getCurrentSoundUrl()});view.node.appendTo(a5.dp.config.appendCountdownTo||this.parent.node),view.render(),model.start()},onClickClose:function(e){this.close(),e.preventDefault(),e.stopPropagation()},onClickReset:function(e){this._setDisplayTime(this.defaultTime),e.preventDefault(),e.stopPropagation()},onClickStart:function(e){this._sanitizeInput();var hhmmss=this._getDisplayTime();this.close(),this.start(hhmmss),e.preventDefault(),e.stopPropagation()},onClickAlarm:function(e){this.countdownSetupAlarm.show()},onInputFocus:function(e){e.target.select()},onInputBlur:function(e){var $input=$(e.target);1===$input.val().length&&$input.val("0"+$input.val()),0===$input.val().length&&$input.val("00")},onInputKeydown:function(e){var key=e.which;_.includes([46,8,9,27,13,110,190],key)||65==key&&!0===e.ctrlKey||key>=35&&key<=40||(e.shiftKey||key<48||key>57)&&(key<96||key>105)&&e.preventDefault()},onInputKeyup:function(e){this._sanitizeInput(),this.onInputChanged()},onInputChanged:function(){this.refreshStartButton()},onAlarmOn:function(){this.node.addClass("alarm-on")},onAlarmOff:function(){this.node.removeClass("alarm-on")},refreshStartButton:function(){!this._isValidTime(this._getDisplayTime())||0===parseInt(this.$hours.val(),10)&&0===parseInt(this.$minutes.val(),10)&&0===parseInt(this.$seconds.val(),10)?this.$(".start").attr("disabled",!0):this.$(".start").attr("disabled",!1)},_sanitizeInput:function(){var hours=this.$hours.val(),minutes=this.$minutes.val(),seconds=this.$seconds.val();hours>23&&this.$hours.val("00"),minutes>59&&this.$minutes.val("00"),seconds>59&&this.$seconds.val("00")},_setDisplayTime:function(hhmmss){var parts=hhmmss.split(":");this.$hours.val(parts[0]).trigger("change"),this.$minutes.val(parts[1]).trigger("change"),this.$seconds.val(parts[2]).trigger("change")},_getDisplayTime:function(){var hours=this.$hours.val(),mins=this.$minutes.val(),secs=this.$seconds.val();return hours.length<2&&(hours=("00"+hours).slice(-2)),mins.length<2&&(mins=("00"+mins).slice(-2)),secs.length<2&&(secs=("00"+secs).slice(-2)),[hours,mins,secs].join(":")},_isValidTime:function(hhmmss){return/^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(hhmmss)}},a5.views.interaction.BaseView.extend("a5.views.CountdownSetup"),a5.view.CountdownSetupAlarm={template:"a5.view.dialog.CountdownSetupAlarm",DEFAULT_SOUND:"audios/beep.wav",init:function(){this.currentSound=null,this.$el=$("<div>",{class:"countdown-setup-alarm"}),_.bindAll(this,"onClickNone","onClickSound","onClickClose"),this.$el.on("click",".no-sound-item",this.onClickNone),this.$el.on("click",".sound-item",this.onClickSound),this.$el.on("click",".close",this.onClickClose)},show:function(){this.$el.html().trim()||(this.currentSound=null,this.alarm=!0,this.trigger("alarm:on")),this.$el.show()},close:function(){this.$el.html().trim()||(this.currentSound=null,this.alarm=!1,this.trigger("alarm:off")),this.$el.hide()},render:function(){var html=a5.service.templates.render(this.template),$html=$(html);return this.$el.html($html.html()),this.$el.find(".no-sound-item").addClass("active"),this.currentSound&&(this.$el.find(".sound-item").removeClass("active"),this.$el.find(".no-sound-item").removeClass("active"),this.$el.find("[data-sound="+a5.utils.jquerySelectorEscape(this.currentSound)+"]").addClass("active"),this.alarm=!0,this.trigger("alarm:on")),this.trigger("render"),this.$el},onClickSound:function(e){e.preventDefault(),this.$el.find(".sound-item").removeClass("active"),this.$el.find(".no-sound-item").removeClass("active"),$(e.currentTarget).addClass("active"),this.currentSound=$(e.currentTarget).attr("data-sound"),this.alarm=!0,this.trigger("alarm:on")},onClickNone:function(e){e.preventDefault(),this.$el.find(".sound-item").removeClass("active"),$(e.currentTarget).addClass("active"),this.alarm=!1,this.currentSound=null,this.trigger("alarm:off")},onClickClose:function(e){e.preventDefault(),e.stopPropagation(),this.close()},getSoundUrl:function(audio){return A5.SKIN_URL+audio},getDefaultSoundUrl:function(){return A5.ENGINE_ROOT+this.DEFAULT_SOUND},getCurrentSoundUrl:function(){if(this.alarm)return this.currentSound?this.getSoundUrl(this.currentSound):this.getDefaultSoundUrl()}},Obj.extend("a5.view.CountdownSetupAlarm"),a5.view.Toc={template:"a5.view.dialog.TableOfContents",init:function(parameters){this.lo=parameters.lo,this.options=this.lo.options(!0),this.toc=this._getTocEntries(),this.$el=$("<div>",{title:"Table of contents"}),_.bindAll(this,"onClickEntry","onClickOk","onClickCancel","onClose"),this.$el.on("click",".toc-entry",this.onClickEntry),this.$el.on("click",".btn-ok",this.onClickOk),this.$el.on("click",".btn-cancel",this.onClickCancel)},show:function(){this.$dialog=this.render().dialog({modal:!0,dialogClass:"toc-dialog"}),this.$dialog.on("dialogclose",this.onClose)},close:function(){this.$dialog.dialog("close")},render:function(){var html=a5.service.templates.render(this.template,this.serializeData()),$html=$(html);return this.$el.attr("title",$html.attr("title")),this.$el.html($html.html()),a5.callbacks.dialogs.get(this.template).trigger("showed",this.$el),this.$el},serializeData:function(){return _(this.toc).each(function(entry){"section"!==entry.type?entry.selected=entry.page===this.lo.curTask+1:_(entry.tocEntries).each(function(subentry){subentry.selected=subentry.page===this.lo.curTask+1,subentry.selected&&(entry.selected=!0)},this)},this),{entries:this.toc}},onClickEntry:function(e){e.preventDefault(),this.$el.find(".toc-entry").removeClass("selected"),$(e.currentTarget).addClass("selected")},onClose:function(e){e.preventDefault(),this.$dialog.dialog("destroy")},onClickCancel:function(e){e.preventDefault(),this.close()},onClickOk:function(e){e.preventDefault();var page=parseInt(this.$el.find(".toc-entry.selected").attr("data-page"),10)-1||0;this.lo.goTo(page),this.close()},_getTocEntries:function(){return this.toc||(this.toc=this.options.navigationMenuIsCustom()?this._getCustomEntries():this._getAutoEntries()),this.toc},_getCustomEntries:function(){var parser=new a5.parsers.TocParser,entries=parser.parse(this.options.getNavigationMenu());return _(entries).each(function(entry){var interaction=this.lo.getInteractionFromIndex(entry.page-1);entry.thumbnail=interaction&&interaction.preview},this),entries},_getAutoEntries:function(){var interactions=_([this.lo.introScreen,this.lo.intList]).chain().flatten().compact().value();return _(interactions).map(function(interaction){return{page:interaction.visibleIndex,title:interaction.title,thumbnail:interaction.preview}})}},a5.views.interaction.BaseView.extend("a5.view.Toc"),a5.view.DisplaySettings={template:"a5.view.dialog.DisplaySettings",init:function(parameters){this.lo=parameters.lo,this.$el=$("<div>",{title:"Options"}),_.bindAll(this,"onClickPattern","onClickBackground","onClose","onClickOk","onClickCancel"),this.$el.on("click",".pattern",this.onClickPattern),this.$el.on("click",".background",this.onClickBackground),this.$el.on("click",".btn-ok",this.onClickOk),this.$el.on("click",".btn-cancel",this.onClickCancel)},show:function(){this.$dialog=this.render().dialog({modal:!0,dialogClass:"opt-dialog"}),this.$dialog.on("dialogclose",this.onClose)},close:function(){this.$dialog.dialog("close")},render:function(){var html=a5.service.templates.render(this.template),$html=$(html);return this.$el.attr("title",$html.attr("title")),this.$el.html($html.html()),this.lo.currentDisplayPattern&&(this.$el.find(".pattern").removeClass("active"),this.$el.find("[data-pattern="+this.lo.currentDisplayPattern+"]").addClass("active")),this.lo.currentDisplayBackground&&(this.$el.find(".background").removeClass("active"),this.$el.find("[data-background="+this.lo.currentDisplayBackground+"]").addClass("active")),this.trigger("render"),this.$el},onClickPattern:function(e){e.preventDefault(),this.$el.find(".pattern").removeClass("active"),$(e.currentTarget).addClass("active")},onClickBackground:function(e){e.preventDefault(),this.$el.find(".background").removeClass("active"),$(e.currentTarget).addClass("active")},onClose:function(e){e.preventDefault(),this.$dialog.dialog("destroy")},onClickOk:function(e){e.preventDefault(),$("body").removeClass(this.lo.currentDisplayPattern),this.lo.currentDisplayPattern=this.$el.find(".pattern.active").attr("data-pattern"),$("body").addClass(this.lo.currentDisplayPattern),$("body").removeClass(this.lo.currentDisplayBackground),this.lo.currentDisplayBackground=this.$el.find(".background.active").attr("data-background"),$("body").addClass(this.lo.currentDisplayBackground),this.close()},onClickCancel:function(e){e.preventDefault(),this.close()}},Obj.extend("a5.view.DisplaySettings"),a5.view.dialog.DeleteAll={template:"a5.view.dialog.DeleteAll",init:function(parameters){this.$el=$("<div>",{title:"Delete all"}),_.bindAll(this,"onClose","onClickOk","onClickCancel"),this.$el.on("click",".btn-ok",this.onClickOk),this.$el.on("click",".btn-cancel",this.onClickCancel)},show:function(){this.$dialog=this.render().dialog({modal:!0,dialogClass:"delete-all-dialog"}),this.$dialog.on("dialogclose",this.onClose)},close:function(){this.$dialog.dialog("close")},render:function(){var html=a5.service.templates.render(this.template),$html=$(html);return this.$el.attr("title",$html.attr("title")),this.$el.html($html.html()),this.trigger("render"),this.$el},onClose:function(e){e.preventDefault(),this.$dialog.dialog("destroy")},onClickOk:function(e){e.preventDefault(),this.trigger("submit"),this.close()},onClickCancel:function(e){e.preventDefault(),this.close()}},Obj.extend("a5.view.dialog.DeleteAll"),a5.view.dialog.ResourceBanksSelect={template:"a5.view.dialog.ResourceBanksSelect",init:function(parameters){this.banks=parameters.banks,this.$el=$("<div>",{title:"Select resource banks"}),_.bindAll(this,"onClickEntry","onClickOk","onClickCancel","onClose"),this.$el.on("click",".resource-bank",this.onClickEntry),this.$el.on("click",".btn-ok",this.onClickOk),this.$el.on("click",".btn-cancel",this.onClickCancel)},show:function(){this.$dialog=this.render().dialog({modal:!0,dialogClass:"resource-banks-dialog"}),this.$dialog.on("dialogclose",this.onClose)},close:function(){this.$dialog.dialog("close")},render:function(){var html=a5.service.templates.render(this.template,this.serializeData()),$html=$(html);return this.$el.attr("title",$html.attr("title")),this.$el.html($html.html()),this.trigger("render"),this.$el},serializeData:function(){return{banks:_(this.banks.getBanks()).map(function(bank){return{id:bank.id,name:bank.name,active:bank.preselected}})}},onClickEntry:function(e){e.preventDefault(),$(e.currentTarget).toggleClass("active"),this.$el.off("click",".btn-ok"),this.$el.find(".resource-bank.active").length>0?(this.$el.on("click",".btn-ok",this.onClickOk),this.$el.find(".btn-ok").removeClass("inactive")):this.$el.find(".btn-ok").addClass("inactive")},onClose:function(e){e.preventDefault(),this.$dialog.dialog("destroy")},onClickCancel:function(e){e.preventDefault(),this.close()},onClickOk:function(e){e.preventDefault(),this.trigger("submit",this._getCurrentSelection()),this.close()},_getCurrentSelection:function(){var selection=[];return this.$el.find("[data-bank]").each(function(index,bank){selection.push({id:$(bank).attr("data-bank"),active:$(bank).is(".active")})}),selection}},Obj.extend("a5.view.dialog.ResourceBanksSelect"),a5.view.ResourcesStage={init:function(parameters){this.interaction=parameters.interaction,this.model=parameters.model,this.$el=parameters.$el,this.$el.attr("id","resources-stage-"+this.interaction.index),this.$el.addClass("resources-stage"),_.bindAll(this,"onDrop","onItemDragStart","onItemDrag","onItemDragStop","onItemClick","onItemSelectedStart","onItemUnselected","onItemUnselecting"),this.$el.on("drop",this.onDrop),this.$el.on("dragstart","> .resource-stage-item",this.onItemDragStart),this.$el.on("drag","> .resource-stage-item",this.onItemDrag),this.$el.on("dragstop","> .resource-stage-item",this.onItemDragStop),this.$el.on("click","> .resource-stage-item",this.onItemClick),this.$el.on("selectablestart",this.onItemSelectedStart),this.$el.on("selectableunselected",this.onItemUnselected),this.$el.on("selectableunselecting",this.onItemUnselecting),this.model.bind("change:state",this.onStateChange,this),
this.model.bind("change",this.onChange,this),this.children=[]},render:function(){return this.makeDroppable(),this.makeSelectable(),_.each(this.model.getItems(),function(item){this.addItem(item)},this),this._createGrids(),this.trigger("render"),this.$el},refresh:function(){_.invoke(this.children,"remove"),this.children=[],_.each(this.model.getItems(),function(item){this.addItem(item)},this),this.trigger("refresh")},region:function(){return this.$el},makeDroppable:function(){this.$el.droppable({scope:"resources-"+this.interaction.index,accept:".resource-item, .pan-balance .resource-stage-item",tolerance:"touch"})},makeSelectable:function(){this.$el.selectable({filter:"> .resource-stage-item",cancel:".resource-stage-item"}),this.originalSelectableRefreshFn=this.$el.data("uiSelectable").refresh},addItem:function(item){var resourceStageItem;return resourceStageItem=item instanceof a5.model.CardStageItem?new a5.view.CardStageItem({item:item,interaction:this.interaction,generalGrid:this.model.generalGrid}):new a5.view.ResourceStageItem({item:item,interaction:this.interaction,generalGrid:this.model.generalGrid}),this.region().append(resourceStageItem.$el),item.cssmatrix=resourceStageItem.$el.transformationMatrix(),resourceStageItem.render(),this.children.push(resourceStageItem),resourceStageItem},removeItem:function(itemView){itemView.remove();var index=this.children.indexOf(itemView);index>=0&&this.children.splice(index,1),this.model.remove(itemView.item)},removeItemById:function(id){var itemView=this._getItemById(id);itemView&&this.removeItem(itemView)},flipSelectedItemsOnlyCards:function(){var flippedCards=[],selectedCards=this._getSelectedCardItems();_.each(selectedCards,function(card){card.bind("commit:action",function(){flippedCards.push(card),flippedCards.length===selectedCards.length&&this.trigger("action:end")},this),card.flip()},this)},flipHorizontalSelectedItems:function(){var items,selectedCards=this._getSelectedCardItems(),selectedItems=this._getSelectedItems();items=_.difference(selectedItems,selectedCards);var selection=new a5.view.SelectedResourceStageItems({children:items});this.region().append(selection.$el),selection.render();var flippedItems=[];items=_.flatten([selectedCards,selection]),_.each(items,function(item){item.bind("commit:action",function(){flippedItems.push(item),flippedItems.length===items.length&&this.trigger("action:end")},this),item.flipHorizontal()},this)},flipVerticalSelectedItems:function(){var items,selectedCards=this._getSelectedCardItems(),selectedItems=this._getSelectedItems();items=_.difference(selectedItems,selectedCards);var selection=new a5.view.SelectedResourceStageItems({children:items});this.region().append(selection.$el),selection.render();var flippedItems=[];items=_.flatten([selectedCards,selection]),_.each(items,function(item){item.bind("commit:action",function(){flippedItems.push(item),flippedItems.length===items.length&&this.trigger("action:end")},this),item.flipVertical()},this)},rotateSelectedItems:function(anticlockwise){var selectedItems=this._getSelectedItems(),selection=new a5.view.SelectedResourceStageItems({children:selectedItems});selection.bind("commit:action",function(){this._repositionOffScreenItems(selectedItems).done(function(){this.trigger("action:end")}.bind(this))},this),this.region().append(selection.$el),selection.render(),selection.rotate(anticlockwise)},deleteSelectedItems:function(){_(this._getSelectedItems()).each(function(itemView){this.model.remove(itemView.item),itemView.remove();var index=this.children.indexOf(itemView);index>=0&&this.children.splice(index,1)},this)},deleteAllItems:function(){this.model.empty(),this.model.resetGrids(),_.invoke(this.children,"remove"),this.children=[]},selectItem:function(item){item.$el.addClass("ui-selecting"),this.$el.selectable("refresh"),this.$el.data("uiSelectable")._mouseStop(null)},deselectAll:function(){this.$el.find(".ui-selected").removeClass("ui-selected").addClass("ui-unselecting"),this.$el.selectable("refresh"),this.$el.data("uiSelectable")._mouseStop(null)},onStateChange:function(){this.refresh()},onChange:function(){this.trigger("resources-stage:change")},onDrop:function(e,ui){this.trigger("resource-item:drop",ui.helper)},onItemSelectedStart:function(e,ui){var self=this;this.$el.data("uiSelectable").refresh=function(){self.originalSelectableRefreshFn.apply(this,arguments),this.selectees.each(function(){var $this=$(this),pos=$this.offset(),data=$.data(this,"selectable-item");data&&(data.right=pos.left+$this[0].getBoundingClientRect().width,data.bottom=pos.top+$this[0].getBoundingClientRect().height)})}},onItemUnselecting:function(e,ui){var $transitionNode=$(ui.unselecting).find(".transition-running");$transitionNode.length>0?$transitionNode.one("transitionend",function(){this.region().append($(ui.unselecting)),a5.utils.applySVGIE11Fix()}.bind(this)):(this.region().append($(ui.unselecting)),a5.utils.applySVGIE11Fix())},onItemUnselected:function(e,ui){var $transitionNode=$(ui.unselected).find(".transition-running");$transitionNode.length>0?$transitionNode.one("transitionend",function(){this.region().append($(ui.unselected)),a5.utils.applySVGIE11Fix()}.bind(this)):(this.region().append($(ui.unselected)),a5.utils.applySVGIE11Fix());var resourceStageItem=this._getItemById($(ui.unselected).attr("data-item-id")),box=resourceStageItem.getBoundingBox(),snap=this.model.generalGrid.snap({x:box.left,y:box.top}),dx=snap.x-box.left,dy=snap.y-box.top;resourceStageItem.moveEnd({x:dx,y:dy})},onItemClick:function(e){var $item=$(e.currentTarget);$item.hasClass("ui-selected")?$item.removeClass("ui-selected").addClass("ui-unselecting"):$item.addClass("ui-selecting"),e.metaKey||e.ctrlKey||this.$el.find(".ui-selected").removeClass("ui-selected").addClass("ui-unselecting"),this.$el.selectable("refresh"),this.$el.data("uiSelectable")._mouseStop(null)},onItemDragStart:function(e,ui){this.matrix=this.$el.transformationMatrix(!0),this.scale=this.matrix.getScale(),this.origin={sx:ui.position.left,sy:ui.position.top,x:ui.position.left/this.scale,y:ui.position.top/this.scale},this.origin.ox=(parseFloat(ui.helper.css("left"))||0)-this.origin.x,this.origin.oy=(parseFloat(ui.helper.css("top"))||0)-this.origin.y,this.origin.sox=this.origin.ox*this.scale,this.origin.soy=this.origin.oy*this.scale,ui.helper.hasClass("ui-selected")||this.$el.find(".ui-selected").removeClass("ui-selected").addClass("ui-unselecting"),ui.helper.addClass("ui-selecting"),this.$el.selectable("refresh"),this.$el.data("uiSelectable")._mouseStop(null),this.trigger("resource-stage-item:drag");var selectedItems=this._getSelectedItems();_.each(selectedItems,function(itemView){itemView.$el.addClass("ui-draggable-dragging")},this),this.group=this._getContainmentOfSelectedItems(selectedItems)},onItemDrag:function(e,ui){this.dx=ui.position.left/this.scale-this.origin.x,this.dy=ui.position.top/this.scale-this.origin.y;var group=this.group,bounds=this._getBoundingBox();group.left+this.dx<bounds.left&&(this.dx=bounds.left-group.left),group.right+this.dx>bounds.right&&(this.dx=bounds.right-group.right),group.top+this.dy<bounds.top&&(this.dy=bounds.top-group.top),group.bottom+this.dy>bounds.bottom&&(this.dy=bounds.bottom-group.bottom),ui.position.left=this.origin.x+this.dx+this.origin.ox,ui.position.top=this.origin.y+this.dy+this.origin.oy,_(this._getSelectedItems()).invoke("move",{x:this.dx,y:this.dy})},onItemDragStop:function(e,ui){var snap=this.model.generalGrid.snap({x:this.dx,y:this.dy}),selectedItems=this._getSelectedItems();_.each(selectedItems,function(itemView){itemView.$el.removeClass("ui-draggable-dragging"),itemView.moveEnd(snap)},this)},_getItemById:function(id){return _(this.children).find(function(child){return child.hasId(id)})},_getSelectedItems:function(){return _(this.children).filter(function(child){return child.isSelected()})},_repositionOffScreenItems:function(items){items=items||this._getSelectedItems();var promise,bounds=this._getBoundingBox(),selectionBounds=this._getContainmentOfSelectedItems(items);return selectionBounds.width>bounds.width?promise=this._fitX(items,bounds.width/selectionBounds.width,selectionBounds):selectionBounds.left<bounds.left?promise=this._pushX(items,bounds.left-selectionBounds.left):selectionBounds.right>bounds.right&&(promise=this._pushX(items,bounds.right-selectionBounds.right)),selectionBounds.height>bounds.height?promise=this._fitY(items,bounds.height/selectionBounds.height,selectionBounds):selectionBounds.top<bounds.top?promise=this._pushY(items,bounds.top-selectionBounds.top):selectionBounds.bottom>bounds.bottom&&(promise=this._pushY(items,bounds.bottom-selectionBounds.bottom)),promise||(promise=$.Deferred().resolve().promise()),promise},_pushX:function(items,dx){var promises=[];return _(items).each(function(item){var snap=this.model.generalGrid.snap({x:dx,y:0});snap.x&&(item.$el.addClass("fitX"),promises.push(item.moveWithTransition(snap,"fitX")))},this),$.when.apply(this,promises)},_pushY:function(items,dy){var promises=[];return _(items).each(function(item){var snap=this.model.generalGrid.snap({x:0,y:dy});snap.y&&(item.$el.addClass("fitY"),promises.push(item.moveWithTransition(snap,"fitY")))},this),$.when.apply(this,promises)},_fitX:function(items,scale,bounds){var promises=[];return _(items).each(function(item){var dx,box=item.getBoundingBox();dx=box.left-bounds.left<bounds.width/2?(box.left-bounds.left)*scale-box.left:box.right-bounds.left>bounds.width/2?(box.right-bounds.left)*scale-box.left-box.width:(box.left-bounds.left)*scale-box.left-box.width/2;var snap=this.model.generalGrid.snap({x:dx,y:0});item.$el.addClass("fitX"),promises.push(item.moveWithTransition(snap,"fitX"))},this),$.when.apply(this,promises)},_fitY:function(items,scale,bounds){var promises=[];return _(items).each(function(item){var dy,box=item.getBoundingBox();dy=box.top-bounds.top<bounds.height/2?(box.top-bounds.top)*scale-box.top:box.bottom-bounds.top>bounds.height/2?(box.bottom-bounds.top)*scale-box.top-box.height:(box.top-bounds.top)*scale-box.top-box.height/2;var snap=this.model.generalGrid.snap({x:0,y:dy});item.$el.addClass("fitY"),promises.push(item.moveWithTransition(snap,"fitY"))},this),$.when.apply(this,promises)},_getSelectedCardItems:function(){return _.filter(this.children,function(child){return child instanceof a5.view.CardStageItem&&child.isSelected()})},_getBoundingBox:function(){var box=this.$el[0].getBoundingClientRect();return{left:0,top:0,bottom:this.$el.height(),right:this.$el.width(),width:this.$el.width(),height:this.$el.height(),tleft:0,ttop:0,tbottom:box.height,tright:box.width,twidth:box.width,theight:box.height}},_getContainmentOfSelectedItems:function(items){items=items||this._getSelectedItems();var boxes=_(items).map(function(itemView){return itemView.getBoundingBox()}),maxRight=_(boxes).max(function(box){return box.tright}),minLeft=_(boxes).min(function(box){return box.tleft}),maxBottom=_(boxes).max(function(box){return box.tbottom}),minTop=_(boxes).min(function(box){return box.ttop});return{csstop:minTop.csstop,cssleft:minLeft.cssleft,cssright:maxRight.cssright,cssbottom:maxBottom.cssbottom,top:minTop.top,left:minLeft.left,right:maxRight.right,bottom:maxBottom.bottom,ttop:minTop.ttop,tleft:minLeft.tleft,tright:maxRight.tright,tbottom:maxBottom.tbottom,width:maxRight.right-minLeft.left,height:maxBottom.bottom-minTop.top,twidth:maxRight.tright-minLeft.tleft,theight:maxBottom.tbottom-minTop.ttop}},_createGrids:function(){var resourcesStageGrid=new a5.ResourcesStageGrid({$grid:this.interaction.$(".general-grid")}),resourcesStageClickToAddGrid=new a5.ResourcesStageClickToAddGrid({$grid:this.interaction.$(".click-to-add-grid")});this.model.setGrids({general:resourcesStageGrid,clickToAdd:resourcesStageClickToAddGrid})}},Obj.extend("a5.view.ResourcesStage"),a5.view.SelectedResourceStageItems={init:function(parameters){this.$el=$("<div>",{class:"selected-resource-stage-items"}),this.children=this._initSelectedChildren(parameters.children),this.children=_.sortBy(this.children,function(child){return child.item.$el.index()})},render:function(){var box=this._getBoundingBox();return this.$el.css({left:box.left,top:box.top,width:box.right-box.left,height:box.bottom-box.top}),this._renderChildren(),this.trigger("render"),this.$el},center:function(){var box=this._getBoundingBox();return{x:(box.left+box.right)/2,y:(box.top+box.bottom)/2}},rotate:function(anticlockwise){var klass=anticlockwise?"anticlockwise-rotated":"rotated";this._hasTransition()?(this.$el.one("transitionend",function(){this._commitAction("rotate",{anticlockwise:anticlockwise})}.bind(this)),this.$el.addClass(klass)):(this.$el.addClass(klass),this._commitAction("rotate",{anticlockwise:anticlockwise}))},flipHorizontal:function(){this._hasTransition()?(this.$el.one("transitionend",function(){this._commitAction("flipHorizontal")}.bind(this)),this.$el.addClass("flipped-hor")):(this.$el.addClass("flipped-hor"),this._commitAction("flipHorizontal"))},flipVertical:function(){this._hasTransition()?(this.$el.one("transitionend",function(){this._commitAction("flipVertical")}.bind(this)),this.$el.addClass("flipped-ver")):(this.$el.addClass("flipped-ver"),this._commitAction("flipVertical"))},_hasTransition:function(){return"0s"!==this.$el.css("transitionDuration")},_commitAction:function(action,params){this._removeChildren(),_(this.children).each(function(item){item.item[action](this.center(),params)},this),this.$el.remove(),this.trigger("commit:action")},_renderChildren:function(){_(this.children).each(function(child){child.item.$el.css({left:child.original.cssleft-parseFloat(this.$el.css("left")),top:child.original.csstop-parseFloat(this.$el.css("top"))}),this.$el.append(child.item.$el)},this),a5.utils.applySVGIE11Fix()},_removeChildren:function(){_(this.children).each(function(child){child.item.$el.css({left:child.original.cssleft,top:child.original.csstop}),this.$el.parent().append(child.item.$el)},this)},_initSelectedChildren:function(items){return _(items).chain().filter(function(item){return item.isSelected()}).map(function(item){return{item:item,original:item.getBoundingBox()}}).value()},_getBoundingBox:function(){var boxes=_(this.children).map(function(item){return item.original}),maxRight=_(boxes).max(function(box){return box.tright}),minLeft=_(boxes).min(function(box){return box.tleft}),maxBottom=_(boxes).max(function(box){return box.tbottom}),minTop=_(boxes).min(function(box){return box.ttop});return{top:minTop.top,left:minLeft.left,right:maxRight.right,bottom:maxBottom.bottom,ttop:minTop.ttop,tleft:minLeft.tleft,tright:maxRight.tright,tbottom:maxBottom.tbottom,width:maxRight.right-minLeft.left,height:maxBottom.bottom-minTop.top,twidth:maxRight.tright-minLeft.tleft,theight:maxBottom.tbottom-minTop.ttop}}},Obj.extend("a5.view.SelectedResourceStageItems"),a5.view.ResourceStageItem={template:"a5.view.ResourceStageItem",init:function(parameters){this.item=parameters.item,this.interaction=parameters.interaction,this.generalGrid=parameters.generalGrid,this.$el=$("<div>",{class:"resource-stage-item"}),this.$el.addClass(this.item.type),this.$el.attr("data-item-id",this.item.id),this.$el.attr("data-bank-item-id",this.item.bankItemId)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());this.$el.html(html),this.$el.toggleClass("inline-svg",!!this.item.inline);var matrix=this.item.getTransformMatrix();return this.translateX=0,this.translateY=0,Math.floor(this.item.x)===this.item.x-.5&&(this.translateX=-.5),Math.floor(this.item.y)===this.item.y-.5&&(this.translateY=-.5),matrix=matrix.translate(this.translateX,this.translateY),this.$el.css({left:this.item.x,top:this.item.y,transform:matrix.toString()}),this.makeDraggable(),this.trigger("render"),this.$el},refresh:function(){var matrix=this.item.getTransformMatrix();Math.floor(this.item.x)===this.item.x-.5+this.translateX&&(this.translateX=-.5),Math.floor(this.item.y)===this.item.y-.5+this.translateY&&(this.translateY=-.5),matrix=matrix.translate(this.translateX,this.translateY),this.$el.css({left:this.item.x,top:this.item.y,transform:matrix.toString()}),this.trigger("refresh")},makeDraggable:function(){this.$el.draggable({scope:"resources-"+this.interaction.index})},flipHorizontal:function(origin){this.item.flipHorizontal(origin,{width:this.$el.outerWidth(),height:this.$el.outerHeight()}),this.refresh(),a5.utils.applySVGIE11Fix()},flipVertical:function(origin){this.item.flipVertical(origin,{width:this.$el.outerWidth(),height:this.$el.outerHeight()}),this.refresh(),a5.utils.applySVGIE11Fix()},rotate:function(origin,params){this.item.rotate(origin,{width:this.$el.outerWidth(),height:this.$el.outerHeight()},params.anticlockwise),this.refresh(),a5.utils.applySVGIE11Fix()},move:function(delta){this.$el.css({left:this.item.x+delta.x,top:this.item.y+delta.y})},moveEnd:function(delta){this.item.moveTo(this.item.x+delta.x,this.item.y+delta.y),this.refresh(),a5.utils.applySVGIE11Fix()},moveWithTransition:function(delta,transition){var deferred=$.Deferred();return this._hasTransition()?(this.$el[0].offsetWidth,this.$el.one("transitionend",function(){this.$el.removeClass(transition),this.moveEnd(delta),deferred.resolve()}.bind(this)),this.move(delta)):(this.$el.removeClass(transition),this.moveEnd(delta),deferred.resolve()),deferred.promise()},moveTo:function(x,y){this.item.moveTo(x,y),this.refresh()},remove:function(){this.$el.remove()},getBoundingBox:function(){var bounds=this.$el.parent()[0].getBoundingClientRect(),box=this.$el[0].getBoundingClientRect(),scale=this.$el.parent().transformationMatrix(!0).getScale(),tleft=box.left-bounds.left,ttop=box.top-bounds.top,tbottom=box.bottom-bounds.top,tright=box.right-bounds.left,left=Math.round(10*tleft/scale)/10,top=Math.round(10*ttop/scale)/10,bottom=Math.round(10*tbottom/scale)/10,right=Math.round(10*tright/scale)/10;return{cssleft:this.item.x,csstop:this.item.y,cssbottom:this.item.y+this.$el.outerHeight(),cssright:this.item.x+this.$el.outerWidth(),left:left,top:top,bottom:bottom,right:right,tleft:tleft,ttop:ttop,tbottom:tbottom,tright:tright,width:right-left,height:bottom-top,twidth:tright-tleft,theight:tbottom-ttop}},getSize:function(){return{width:this.$el.outerWidth(),height:this.$el.outerHeight()}},serializeData:function(){var item={path:A5.SKIN_URL+this.item.path,inline:this.item.inline};return item.inline&&(item.inline=a5.utils.applySVGGradientFix(item.inline)),{item:item}},isSelected:function(){return this.$el.is(".ui-selected")},hasId:function(id){return this.$el.attr("data-item-id")==id},_hasTransition:function(){return"0s"!==this.$el.css("transitionDuration")}},Obj.extend("a5.view.ResourceStageItem"),a5.view.CardStageItem={template:"a5.view.CardStageItem",init:function(parameters){this._super(parameters),_.bindAll(this,"_onClickFlip"),this.$el.on("click",".btn-flip",this._onClickFlip)},render:function(){return this.$el.toggleClass("face-down",this.item.isFaceDown()),this.$el.toggleClass("face-up",this.item.isFaceUp()),this._super(),this.trigger("render"),this.$el},faceUp:function(){this.item.faceUp(),this.$el.removeClass("face-down").addClass("face-up")},faceDown:function(){this.item.faceDown(),this.$el.removeClass("face-up").addClass("face-down")},flip:function(){this._hasTransition()?(this.$el.one("transitionend",function(){this.trigger("commit:action")}.bind(this)),this.item.isFaceUp()?this.faceDown():this.faceUp()):(this.item.isFaceUp()?this.faceDown():this.faceUp(),this.trigger("commit:action"))},flipHorizontal:function(){this.flip()},flipVertical:function(){this.flip()},_onClickFlip:function(e){e.preventDefault(),e.stopPropagation(),this.flip()},_hasTransition:function(){return"0s"!==this.$el.css("transitionDuration")}},a5.view.ResourceStageItem.extend("a5.view.CardStageItem"),a5.view.ResourcesTabPanel={template:"a5.view.ResourcesTabPanel",init:function(parameters){this.banks=parameters.banks,this.addBy=1,this.maxAddBy=parameters.maxAddBy,this.addByEnabled=!0,this.interaction=parameters.interaction,this.children=[],this.$el=$("<div>",{class:"resources-wrapper"}),_.bindAll(this,"onClickMoreResources","onClickTogglePanel","onClickResourceBankItem","onClickRotate","onClickFlipHorizontal","onClickDeleteSelected","onClickDeleteAll","onClickUndo","onClickMinus","onClickAdd","onClickFullscreen","onClickAnticlockwiseRotate","onClickAddAll","onClickAddRandom","onClickAddRandomSelection","onClickReset","onTabActivate","onClickSave","onClickFlipVertical"),this.$el.on("click",".add-resource-button",this.onClickMoreResources),this.$el.on("click",".toggle-button",this.onClickTogglePanel),this.$el.on("click",".items > .resource-item, .resource-group > .resource-item",this.onClickResourceBankItem),this.$el.on("click",".btn-rotate",this.onClickRotate),this.$el.on("click",".btn-anticlockwise-rotate",this.onClickAnticlockwiseRotate),this.$el.on("click",".btn-flip-hor",this.onClickFlipHorizontal),this.$el.on("click",".btn-flip-ver",this.onClickFlipVertical),this.$el.on("click",".btn-delete-selected",this.onClickDeleteSelected),this.$el.on("click",".btn-delete-all",this.onClickDeleteAll),this.$el.on("click",".btn-undo",this.onClickUndo),this.$el.on("click",".btn-minus",this.onClickMinus),this.$el.on("click",".btn-add",this.onClickAdd),this.$el.on("click",".btn-fullscreen",this.onClickFullscreen),this.$el.on("click",".btn-save",this.onClickSave),this.$el.on("click",".btn-add-all",this.onClickAddAll),this.$el.on("click",".btn-add-random",this.onClickAddRandom),this.$el.on("click",".btn-add-random-selection",this.onClickAddRandomSelection),this.$el.on("click",".btn-reset",this.onClickReset)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData()),$root=$("<div>");$root.html(html);var $toolbar=this.$el.find(".resources-toolbar");$toolbar.length>0&&($root.find(".resources-toolbar").remove(),$root.append($toolbar)),this.$el.html($root.html());var banks=this.banks.getPreselectedBanks();_.each(banks,function(bank){var resourceBank=this._renderResourceBank(bank);this.addBank(resourceBank)},this);var indexSelectedBank=this.banks.getIndexOfSelectedBank(banks),bank=banks[indexSelectedBank];return this.$el.find(".resource-tabs").tabs({activate:this.onTabActivate,active:indexSelectedBank}),this.trigger("resource-bank:activate",bank),this.trigger("render"),this.$el},serializeData:function(){return{banks:_(this.banks.getPreselectedBanks()).map(function(bank){return{id:bank.id,name:bank.name,selected:bank.selected}}),addBy:this.addBy}},refresh:function(){this.children=[],this.render()},regionResourceBanks:function(){return this.$el.find(".resource-banks")},addBank:function(bank){this.children.push(bank)},getCurrentResourceBank:function(){return _(this.children).find(function(bankView){return bankView.$el.is(":visible")},this)},getBankById:function(id){return _(this.children).find(function(bankView){return bankView.bank.id===id},this)},resetAddBy:function(){this.addBy=1,this.$el.find(".adder .number").text(this.addBy)},disableAddBy:function(){this.addByEnabled=!1,this.resetAddBy(),this.$el.find(".adder").addClass("disabled")},enableAddBy:function(){this.addByEnabled=!0,this.$el.find(".adder").removeClass("disabled")},isStageEnabled:function(){return!this.regionResourceBanks().hasClass("stage-disabled")},onClickMoreResources:function(e){e.preventDefault(),this.trigger("more-resources:show")},onClickTogglePanel:function(e){e.preventDefault(),this.$el.find(".resources-panel").toggleClass("closed")},onClickResourceBankItem:function(e){e.preventDefault(),this.trigger("resource-bank-item:click",$(e.currentTarget))},onClickFlipHorizontal:function(e){e.preventDefault(),this.trigger("resources-toolbar:flip-horizontal")},onClickFlipVertical:function(e){e.preventDefault(),this.trigger("resources-toolbar:flip-vertical")},onClickRotate:function(e){e.preventDefault(),this.trigger("resources-toolbar:rotate")},onClickAnticlockwiseRotate:function(e){e.preventDefault(),this.trigger("resources-toolbar:rotate",!0)},onClickDeleteSelected:function(e){e.preventDefault(),this.trigger("resources-toolbar:delete-selected")},onClickDeleteAll:function(e){e.preventDefault(),this.trigger("resources-toolbar:delete-all")},onClickUndo:function(e){e.preventDefault(),this.trigger("resources-toolbar:undo")},onClickMinus:function(e){e.preventDefault(),this.addByEnabled&&(this.addBy=_.max([1,this.addBy-1]),this.$el.find(".adder .number").text(this.addBy))},onClickAdd:function(e){e.preventDefault(),this.addByEnabled&&(this.addBy=_.min([this.maxAddBy,this.addBy+1]),this.$el.find(".adder .number").text(this.addBy))},onClickFullscreen:function(e){e.preventDefault()},onClickSave:function(e){e.preventDefault(),this.trigger("resources-toolbar:save")},onClickAddAll:function(e){e.preventDefault(),this.trigger("resources-toolbar:add-all")},onClickAddRandom:function(e){e.preventDefault(),this.trigger("resources-toolbar:add-random")},onClickAddRandomSelection:function(e){e.preventDefault(),this.trigger("resources-toolbar:add-random-selection")},onClickReset:function(e){e.preventDefault(),this.trigger("resources-toolbar:reset")},onTabActivate:function(e,ui){var bankId=ui.newPanel.attr("id"),bank=this.banks.getBankById(bankId);this.trigger("resource-bank:activate",bank)},_renderResourceBank:function(bank){var resourceBank=new a5.view.ResourceBank({bank:bank});return this.regionResourceBanks().append(resourceBank.$el),resourceBank.bind("render",function(){_.each(bank.items,function(item){if(item instanceof a5.model.ResourceBankGroup)this._renderResourceBankGroup(item,resourceBank);else{var resourceBankItem=this._renderResourceBankItem(item,resourceBank);resourceBank.addItem(resourceBankItem)}},this),resourceBank.makeItemsDraggables(this._resourceBankItemHelperFn())},this),resourceBank.render(),resourceBank},_resourceBankItemHelperFn:function(){var self=this;return function(e){for(var $container=$('<div class="resource-item">'),i=0;i<self.addBy;i++){var $svg=$(this).clone(!0).removeAttr("id");$svg.html(a5.utils.applySVGGradientFix($svg.html())),$svg.appendTo($container),0===i&&$container.data("ui-draggable",$(this).data("ui-draggable"))}return $container}},_renderResourceBankGroup:function(group,parent){var resourceBankGroup=new a5.view.ResourceBankGroup({group:group});return parent.regionItems().append(resourceBankGroup.$el),resourceBankGroup.bind("render",function(){_.each(group.items,function(item){var resourceBankItem=this._renderResourceBankItem(item,resourceBankGroup);parent.addItem(resourceBankItem)},this)},this),resourceBankGroup.render(),resourceBankGroup},_renderResourceComposedBankItem:function(item,parent){var resourceComposedBankItem=new a5.view.ResourceComposedBankItem({item:item,interaction:this.interaction});return parent.regionItems().append(resourceComposedBankItem.$el),resourceComposedBankItem.bind("render",function(){_.each(item.composite,function(child){this._renderResourceBankItem(child,resourceComposedBankItem)},this)},this),resourceComposedBankItem.render(),resourceComposedBankItem},_renderResourceBankItem:function(item,parent){if(item instanceof a5.model.ResourceComposedBankItem)return this._renderResourceComposedBankItem(item,parent);var resourceBankItem=new a5.view.ResourceBankItem({item:item,interaction:this.interaction});return parent.regionItems().append(resourceBankItem.$el),resourceBankItem.bind("render",function(){},this),resourceBankItem.render(),resourceBankItem}},Obj.extend("a5.view.ResourcesTabPanel"),a5.view.ResourceBankItem={template:"a5.view.ResourceBankItem",init:function(parameters){this.item=parameters.item,this.interaction=parameters.interaction,this.$el=$("<div>",{class:"resource-item"}),this.$el.attr("data-item-id",this.item.id),this.$el.attr("data-bank-item-id",this.item.id)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html(html),this.trigger("render"),this.$el},makeDraggable:function(helper,appendTo){this.$el.draggable({appendTo:appendTo,helper:helper,revert:"invalid",scope:"resources-"+this.interaction.index,distance:20})},serializeData:function(){return{item:{path:A5.SKIN_URL+this.item.path,inline:this.item.inline}}}},Obj.extend("a5.view.ResourceBankItem"),a5.view.ResourceComposedBankItem={init:function(parameters){this.interaction=parameters.interaction,this.item=parameters.item,this.$el=$("<div>",{class:"resource-item resource-item-composed"}),this.$el.attr("data-item-id",this.item.id)},render:function(){return this.$el.empty(),this.trigger("render"),this.$el},regionItems:function(){return this.$el},makeDraggable:function(helper,appendTo){this.$el.draggable({appendTo:appendTo,helper:helper,revert:"invalid",scope:"resources-"+this.interaction.index,distance:20})}},Obj.extend("a5.view.ResourceComposedBankItem"),a5.view.ResourceBankGroup={init:function(parameters){this.group=parameters.group,this.$el=$("<div>",{class:"resource-group"}),this.$el.addClass("resource-group-"+this.group.id)},render:function(){return this.$el.empty(),this.trigger("render"),this.$el},regionItems:function(){return this.$el}},Obj.extend("a5.view.ResourceBankGroup"),a5.view.ResourceBank={template:"a5.view.ResourceBank",init:function(parameters){this.bank=parameters.bank,this.addFaceMode="down",this.$el=$("<div>",{class:"resource-bank",id:this.bank.id}),this.$el.addClass("resource-bank-"+this.bank.id),_.bindAll(this,"onItemDragStart","onItemDrag","onItemDragStop","onClickFaceUpMode","onClickFaceDownMode"),this.$el.on("dragstart",".resource-item",this.onItemDragStart),this.$el.on("drag",".resource-item",this.onItemDrag),this.$el.on("dragstop",".resource-item",this.onItemDragStop),this.$el.on("click",".btn-face-up-mode",this.onClickFaceUpMode),this.$el.on("click",".btn-face-down-mode",this.onClickFaceDownMode),this.children=[]},render:function(){var template=this.template+_.str.classify(this.bank.name);a5.service.templates.enableOnlyCachedMode();var html=a5.service.templates.render(template,this.serializeData());return a5.service.templates.disableOnlyCachedMode(),""===html&&(html=a5.service.templates.render(this.template,this.serializeData())),this.$el.html(html),this.trigger("render"),this.$el},regionItems:function(){return this.$el.find(".items")},addItem:function(item){this.children.push(item)},getItems:function(){return this.children},getItemsBySelector:function(selector){return _(this.children).filter(function(child){return child.$el.is(selector)})},makeItemsDraggables:function(helper){_(this.children).invoke("makeDraggable",helper,this.$el)},serializeData:function(){return{bank:{name:this.bank.name,items:this.bank.items}}},onItemDragStart:function(e,ui){this.matrix=this.$el.transformationMatrix(!0),this.scale=this.matrix.getScale(),this.origin={sx:ui.offset.left,sy:ui.offset.top},"numeral-cards"===this.bank.id&&ui.helper.addClass("face-"+this.addFaceMode);var pX=100*e.offsetX/ui.helper.width(),pY=100*e.offsetY/ui.helper.height();ui.helper.css("transform-origin",pX+"% "+pY+"%")},onItemDrag:function(e,ui){var bounds=$("#activity")[0].getBoundingClientRect(),elem=ui.helper[0].getBoundingClientRect(),sdx=ui.offset.left-this.origin.sx,sdy=ui.offset.top-this.origin.sy;ui.offset.left<bounds.left?sdx=sdx+bounds.left-ui.offset.left:ui.offset.left>bounds.right-elem.width&&(sdx+=bounds.right-elem.width-ui.offset.left),ui.offset.top<bounds.top?sdy=sdy+bounds.top-ui.offset.top:ui.offset.top>bounds.bottom-elem.height&&(sdy=sdy+bounds.bottom-elem.height-ui.offset.top),ui.position.left=(this.origin.sx+sdx-this.$el.parents(".resources-panel").offset().left)/this.scale,ui.position.top=(this.origin.sy+sdy-this.$el.parents(".resources-panel").offset().top)/this.scale},onItemDragStop:function(e,ui){},onClickFaceDownMode:function(e){this.addFaceMode="down"},onClickFaceUpMode:function(e){this.addFaceMode="up"}},Obj.extend("a5.view.ResourceBank"),a5.view.RightsView={template:"a5.view.dialog.Rights",init:function(params){this.resources=params.resources,this.$el=$("<div>",{title:"Rights"})},show:function(){a5.view.dialog.display("a5.view.dialog.Rights",this._serializeData())},
_serializeData:function(){return{dialogClass:"rights-dialog",resources:_.filter(this.resources,function(res){return!!res.rights})}}},Obj.extend("a5.view.RightsView"),a5.view.ExportFormatSelect={template:"a5.view.dialog.ExportFormatSelect",init:function(parameters){this.$button=parameters.$button,this.formats=this._getFormats(),this.$el=$("<div>",{class:"export-format-select"}),_.bindAll(this,"onClickDownload","onClickItem","onClickButton"),this.$el.on("click",".btn-download",this.onClickDownload),this.$el.on("click",".export-format",this.onClickItem),this.$button.on("click",this.onClickButton)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html(html),this.trigger("render"),this.$el},open:function(){0===this.$el.parent().length&&(this.$button.after(this.$el),this.render()),this.$el.show(),this.visible=!0},close:function(){this.$el.hide(),this.visible=!1},serializeData:function(){return{formats:this.formats}},onClickDownload:function(e){e.stopPropagation(),e.preventDefault();var formats=this._getSelectedFormats();formats.length>0&&(this.trigger("submit",formats),this.close())},onClickButton:function(e){e.preventDefault(),this.formats.length>1?this.visible?this.close():this.open():this.trigger("submit",this.formats)},onClickItem:function(e){e.stopPropagation(),e.preventDefault(),this.$el.find(".active").removeClass("active"),$(e.currentTarget).addClass("active")},_getFormats:function(){var formats=a5.dp.config.bookNotesExportFormats;return formats=formats.split(","),formats=_(formats).invoke("trim")},_getSelectedFormats:function(){return this.$el.find(".export-format.active").map(function(){return $(this).attr("data-format")}).toArray()}},Obj.extend("a5.view.ExportFormatSelect"),a5.view.AutoEndResults={init:function(){this.model=new a5.model_builder.EndResultsGenerator(a5.mainBuilder.curInteraction),this.globalHandlebars=window.Handlebars,this.handlebars=Handlebars.create(),this.handlebars.registerHelper(this._getHelpers())},display:function(){window.Handlebars=this.handlebars,a5.view.dialog.display("a5.view.AutoEndResults",{dialogClass:"autoendresults-dialog"}),window.Handlebars=this.globalHandlebars},_getHelpers:function(){var self=this;return{score:function(options){return self.model.getScore.call(self.model,options.data.currentInteraction)},totalquestions:function(options){return self.model.getTotalquestions.call(self.model,options.data.currentInteraction)},correctanswers:function(options){return self.model.getCorrectanswers.call(self.model,options.data.currentInteraction)},incorrectanswers:function(options){return self.model.getIncorrectanswers.call(self.model,options.data.currentInteraction)},timetaken:function(){return self.model.getTimetaken.call(self.model)},timeout:function(){return self.model.getTimeout.call(self.model)},date:function(){return self.model.getDateString.call(self.model)},attempts:function(){return self.model.getAttempts.call(self.model)},allcorrectattempt:function(attempt){return self.model.getAllCorrectAttempt.call(self.model,parseInt(attempt,10))},unsolved:function(threshold){return self.model.getUnsolved.call(self.model,parseInt(threshold,10))},solved:function(threshold){return self.model.getSolved.call(self.model,parseInt(threshold,10))},notattempted:function(){return self.model.getNotAttempted.call(self.model)},bandfeedback:function(){_.last(arguments);return self.model.getBandFeedbackString.call(self.model,self.model.interaction,_.map([].slice.call(arguments,0,arguments.length-1),function(arg){return parseInt(arg,10)}))},foreachinteraction:function(options){return options.data&&(options.data=Handlebars.createFrame(options.data)),_.map(a5.mainBuilder.intList,function(i){return options.data.currentInteraction=i,options.data.currentInteractionLabel=""+(i.index+1),options.data.index=i.index+1,options.fn(this,{data:options.data})},this).join("")},automaticmarked:function(options){if(options.data.currentInteraction){if(options.data.currentInteraction.options.manualMarkingIsOff())return options.fn(this,{data:options.data})}else if(!a5.mainBuilder.someManuallyMarked())return options.fn(this,{data:options.data});return""}}}},Obj.extend("a5.view.AutoEndResults"),a5.views.interaction.GapMatchView={init:function(model,parent,options){options=options||{},this._super(model,parent,options.node||$('<div class="gap_match_view"></div>')),this.gapsOption=options.gapsOption,this.wordpoolElementClass=options.wordpoolElementClass,this.elementClass=options.elementClass,this.renderWordpool()},renderWordpool:function(){this.wordpool=new a5.views.WordPool(this.model.poolAlignment,!0,this.model.parent,!0),_.each(this.model.poolDropAreas,function(dropArea){this.wordpool.addChild(new a5.views.interaction[this.wordpoolElementClass](dropArea,null,{elementClass:this.elementClass}))},this),this.node.append(this.wordpool.render())},show:function(){this.node.css("visibility","")},hide:function(){this.node.css("visibility","hidden")},adjustGapSize:function(e,size){size&&size.length>=2&&_.each(e.views(),function(v){v.setHolderSize?v.setHolderSize(size[0],size[1]):v.setSize(size[0],size[1])})},adjustGapSizes:function(){_.isUndefined(this.gapsOption)&&(this.gapsOption="samelongest"),this.node.closest(".interaction").addClass(this.gapsOption+"-gaps");var sizes={};if(_.each(this.model.poolDropAreas,function(dropArea){var size,dropAreaView=dropArea.views()[0],$wm=dropAreaView.$(".width-measure");if($wm.length>0){var removeClass=!1,addPrefilled=!1;dropAreaView.node.hasClass("has_drag")||(dropAreaView.node.addClass("has_drag"),removeClass=!0),dropAreaView.node.hasClass("prefilled")&&(dropAreaView.node.removeClass("prefilled"),addPrefilled=!0),$wm.show(),dropAreaView.$wmContent=$wm.find(".content"),size=[dropAreaView.$wmContent.outerWidth(),dropAreaView.$wmContent.outerHeight()],dropAreaView.$wmContent=dropAreaView.$wmContent.clone(),$wm.hide(),removeClass&&dropAreaView.node.removeClass("has_drag"),addPrefilled&&dropAreaView.node.addClass("prefilled")}sizes[dropArea.resident.identifier]=size}),"fixed"!==this.gapsOption){if("samelongest"==this.gapsOption||"invisible"==this.gapsOption){var size=[0,0];_.each(sizes,function(e){e[0]>size[0]&&(size[0]=e[0]),e[1]>size[1]&&(size[1]=e[1])}),"samelongest"==this.gapsOption&&_.each(this.model.targetDropAreas,function(dropArea,i){this.adjustGapSize(dropArea,size)},this),_.each(this.model.poolDropAreas,function(dropArea,i){this.adjustGapSize(dropArea,size),dropArea.drag&&this.adjustGapSize(dropArea.drag,size)},this)}if("variable"==this.gapsOption&&(_.each(this.model.poolDropAreas,function(dropArea){this.adjustGapSize(dropArea,sizes[dropArea.resident.identifier])},this),_.each(this.model.targetDropAreas,function(dropArea){var size=null;_.each(this.model.mapGapToAnswer[dropArea.identifier],function(cid){cid in sizes&&(size=sizes[cid])}),this.adjustGapSize(dropArea,size)},this)),"invisible"==this.gapsOption){this.node.closest(".interaction").addClass("invisible");window.a5.mainBuilder.curInteraction;_.each(this.node.find(".contentblock > p"),function(cb){var elements=$("<div></div>");_.each($(cb).contents(),function(el){if($(el)[0].nodeType==Node.TEXT_NODE){elements.append($(el).text().trim().split(" ").join(' <div class="drop_area gap_match_gap_view" data-model-id=""><div class="width-measure"></div><div class="drag_holder"><div class="place_holder">&nbsp;</div></div></div> '))}else elements.append(" "),elements.append(el),elements.append(" ")}),$(cb).html(elements)})}"between_words"===this.model.freeDragLocation&&(this.node.closest(".interaction").addClass("gaps_between_words"),_.each(this.model.targetDropAreas,function(dropArea){this.adjustGapSize(dropArea,[0,0])},this)),"between_letters"===this.model.freeDragLocation&&(this.node.closest(".interaction").addClass("gaps_between_letters"),_.each(this.model.targetDropAreas,function(dropArea){this.adjustGapSize(dropArea,[0,0])},this))}}},a5.views.interaction.BaseView.extend("a5.views.interaction.GapMatchView"),a5.views.interaction.GapMatchWithStacksView={renderWordpool:function(){this.wordpool=new a5.views.WordPool(this.model.poolAlignment,!0,this.model.parent),_.each(this.model.stackAreas,function(stackArea){this.wordpool.addChild(new a5.views.interaction[this.wordpoolElementClass](stackArea,null,{elementClass:this.elementClass}))},this),this.node.append(this.wordpool.render())},adjustGapSizes:function(){_.isUndefined(this.gapsOption)&&(this.gapsOption="samelongest"),this.node.closest(".interaction").addClass(this.gapsOption+"-gaps");var sizes={};if(_.each(this.model.stackAreas,function(stackArea){var size,stackAreaView=stackArea.views()[0],$wm=stackAreaView.$(".width-measure");if($wm.length>0){var removeClass=!1;stackAreaView.node.hasClass("has_drag")||(stackAreaView.node.addClass("has_drag"),removeClass=!0),$wm.show(),stackAreaView.$wmContent=$wm.find(".content"),size=[stackAreaView.$wmContent.outerWidth(),stackAreaView.$wmContent.outerHeight()],stackAreaView.$wmContent=stackAreaView.$wmContent.clone(),$wm.hide(),removeClass&&stackAreaView.node.removeClass("has_drag")}_.each(stackArea.drags,function(drag){sizes[drag.identifier]=size},this)},this),"fixed"!==this.gapsOption){if("samelongest"==this.gapsOption||"invisible"==this.gapsOption){var size=[0,0];_.each(sizes,function(e){e[0]>size[0]&&(size[0]=e[0]),e[1]>size[1]&&(size[1]=e[1])}),"samelongest"==this.gapsOption&&_.each(this.model.targetDropAreas,function(dropArea,i){this.adjustGapSize(dropArea,size)},this),_.each(this.model.poolDropAreas,function(dropArea,i){this.adjustGapSize(dropArea,size),dropArea.drag&&this.adjustGapSize(dropArea.drag,size)},this)}if("variable"==this.gapsOption&&(_.each(this.model.poolDropAreas,function(dropArea){this.adjustGapSize(dropArea,sizes[dropArea.resident.identifier])},this),_.each(this.model.targetDropAreas,function(dropArea){var size=null;_.each(this.model.mapGapToAnswer[dropArea.identifier],function(cid){cid in sizes&&(size=sizes[cid])}),this.adjustGapSize(dropArea,size)},this)),"invisible"==this.gapsOption){this.node.closest(".interaction").addClass("invisible");window.a5.mainBuilder.curInteraction;_.each(this.node.find(".contentblock > p"),function(cb){var elements=$("<div></div>");_.each($(cb).contents(),function(el){if($(el)[0].nodeType==Node.TEXT_NODE){elements.append($(el).text().trim().split(" ").join(' <div class="drop_area gap_match_gap_view" data-model-id=""><div class="width-measure"></div><div class="drag_holder"><div class="place_holder">&nbsp;</div></div></div> '))}else elements.append(" "),elements.append(el),elements.append(" ")}),$(cb).html(elements)})}"between_words"===this.model.freeDragLocation&&(this.node.closest(".interaction").addClass("gaps_between_words"),_.each(this.model.targetDropAreas,function(dropArea){this.adjustGapSize(dropArea,[0,0])},this)),"between_letters"===this.model.freeDragLocation&&(this.node.closest(".interaction").addClass("gaps_between_letters"),_.each(this.model.targetDropAreas,function(dropArea){this.adjustGapSize(dropArea,[0,0])},this))}}},a5.views.interaction.GapMatchView.extend("a5.views.interaction.GapMatchWithStacksView"),a5.views.interaction.GapMatchResourcesView={init:function(model,parent,options){var node=$('<div class="gap_match_view with-resources"></div>').addClass(options.classNames),optionsWithNode=_.extend({},options,{node:node});this._super(model,parent,optionsWithNode)}},a5.views.interaction.GapMatchView.extend("a5.views.interaction.GapMatchResourcesView"),a5.views.interaction.GapMatchGapView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_gap_view"),this.node.toggleClass("text-capitalize",model.capitalize&&options.capitalizeGap),!$.support.touch||"between_words"!==this.model.parent.freeDragLocation&&"between_letters"!==this.model.parent.freeDragLocation||this.dragHolder.addClass("touch_drag_holder"),this.model.bind("input_update:setAnswer",this.setAnswerInput,this)},updateToThisDrag:function(drag){this._super(drag);var $contentblock=this.node.closest(".contentblock");$contentblock.find(".gap_match_gap_view.has_drag").length===$contentblock.find(".gap_match_gap_view").length?$contentblock.addClass("all-filled"):$contentblock.removeClass("all-filled")},createViewFor:function(model){return new a5.views.interaction.GapMatchDragView(model,this,{elementClass:this.elementClass})},onDrop:function(event,ui){this._super(event,ui),this.interaction.$(".is-active-target").removeClass("is-active-target")},setAnswer:function(){var setCheck=this.model.isCorrectable();this.setAnswerCheck(setCheck)},setAnswerInput:function(){var setCheck=this.model.isCorrectable()&&this.model.isFilled();this.setAnswerCheck(setCheck),this.updateAnswerInputState(setCheck)},setAnswerCheck:function(check){this.$(".check").remove(),check&&(this.updateFeedbackState(this.dragHolder),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(this.model.getCorrect())}),this.bindAnswerFeedback(this.model.getCorrect(),{correct:this.model.isCorrect()}))},showAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.updateToThisDrag(this.model.getCorrect()),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.drag,tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getAnswerFeedback(this.model.getCorrect()):this.model.drag&&this.model.drag.content.clone(!0)}))},showNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},tryAgain:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.dragHolder.droppable("option","disabled",this.isLocked(this.dragHolder)))},updateFeedbackState:function(nodes){nodes.removeClass("input-checked-correct input-checked-incorrect input-checked-empty"),this._super(nodes)},updateAnswerInputState:function(check){check&&(this.model.isCorrect()?this.dragHolder.addClass("input-checked-correct"):!this.model.isFilled||this.model.isFilled()?this.dragHolder.addClass("input-checked-incorrect"):this.dragHolder.addClass("input-checked-empty"))}},a5.views.interaction.DropArea.extend("a5.views.interaction.GapMatchGapView"),a5.views.interaction.GapMatchGapTextView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_gap_text_view"),this.preserveSize=!0},createViewFor:function(model){var child=new a5.views.interaction.GapMatchDragView(model,this,{elementClass:this.elementClass});return this.$(".width-measure").empty().append(child.node.clone(!0)),child}},a5.views.interaction.DropArea.extend("a5.views.interaction.GapMatchGapTextView"),a5.views.interaction.GapMatchStackView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_stack_view"),this.preserveSize=!0},createViewFor:function(model){var child=new a5.views.interaction.GapMatchDragView(model,this,{elementClass:this.elementClass});return this.$(".width-measure").empty().append(child.node.clone(!0)),this.model.isHead(model)?(child.enable(),child.node.addClass("gap_match_drag_stack_head")):(child.disable(),child.node.removeClass("gap_match_drag_stack_head")),child}},a5.views.interaction.StackDropArea.extend("a5.views.interaction.GapMatchStackView"),a5.views.interaction.GapMatchDragView={init:function(model,parent,options){this._super(model,parent),this.node.addClass("gap_match_drag"),options.elementClass&&this.node.addClass(options.elementClass),a5.utils.wrapFirstLetter(this.$(".content")),this.node.find("div:not(.image-as-trigger) > img").parent().addClass("image-div"),this.node.find("div > .image-as-trigger").parent().addClass("image-div"),this.model.parent.tts_audio&&this.addTTSPlayer(),this.parent&&this.parent.model.inputStyle&&this.node.attr("style",this.parent.model.inputStyle)},addTTSPlayer:function(){this.tts_player=new a5.views.TTS_Player($(this.model.content).text()),$(this.node.find(".content")).prepend(this.tts_player.render())},onDrag:function(event,ui){this._super(event,ui)}},a5.views.interaction.DragElement.extend("a5.views.interaction.GapMatchDragView"),a5.views.interaction.GapMatchGapNoDropView={init:function(model,parent,options){this._super(model,parent),this.node.addClass("gap_match_gap_view"),this.node.toggleClass("text-capitalize",model.capitalize&&options.capitalizeGap),!$.support.touch||"between_words"!==this.model.parent.freeDragLocation&&"between_letters"!==this.model.parent.freeDragLocation||this.dragHolder.addClass("touch_drag_holder"),this.model.bind("input_update:setAnswer",this.setAnswerInput,this)},updateToThisDrag:function(drag){this._super(drag);var $contentblock=this.node.closest(".contentblock");$contentblock.find(".gap_match_gap_view.has_drag").length===$contentblock.find(".gap_match_gap_view").length?$contentblock.addClass("all-filled"):$contentblock.removeClass("all-filled")},createViewFor:function(model){return new a5.views.interaction.GapMatchTileView(model,this)},setAnswer:function(){var setCheck=this.model.isCorrectable();this.setAnswerCheck(setCheck)},setAnswerInput:function(){var setCheck=this.model.isCorrectable()&&this.model.isFilled();this.setAnswerCheck(setCheck),this.updateAnswerInputState(setCheck)},setAnswerCheck:function(check){this.$(".check").remove(),check&&(this.updateFeedbackState(this.dragHolder),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(this.model.getCorrect())}),this.bindAnswerFeedback(this.model.getCorrect(),{correct:this.model.isCorrect()}))},showAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.updateToThisDrag(this.model.getCorrect()),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.drag,tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getAnswerFeedback(this.model.getCorrect()):this.model.drag&&this.model.drag.content.clone(!0)}))},showNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},tryAgain:function(){this.$(".check").remove(),this.model.isCorrectable()&&this.updateFeedbackState(this.dragHolder)},updateFeedbackState:function(nodes){nodes.removeClass("input-checked-correct input-checked-incorrect input-checked-empty"),this._super(nodes)},updateAnswerInputState:function(check){check&&(this.model.isCorrect()?this.dragHolder.addClass("input-checked-correct"):!this.model.isFilled||this.model.isFilled()?this.dragHolder.addClass("input-checked-incorrect"):this.dragHolder.addClass("input-checked-empty"))}},a5.views.interaction.FillArea.extend("a5.views.interaction.GapMatchGapNoDropView"),a5.views.interaction.GapMatchGapTextNoDropView={isPoolArea:!0,init:function(model,parent){this._super(model,parent),this.node.addClass("gap_match_gap_text_view"),this.preserveSize=!0},createViewFor:function(model){var child=new a5.views.interaction.GapMatchTileView(model,this);return this.$(".width-measure").empty().append(child.node.clone(!0)),child}},a5.views.interaction.FillArea.extend("a5.views.interaction.GapMatchGapTextNoDropView"),a5.views.interaction.GapMatchStackNoDropView={isPoolArea:!0,init:function(model,parent){this._super(model,parent),this.node.addClass("gap_match_stack_view"),this.preserveSize=!0},createViewFor:function(model){var child=new a5.views.interaction.GapMatchTileView(model,this);return this.$(".width-measure").empty().append(child.node.clone(!0)),this.model.isHead(model)?(child.enable(),child.node.addClass("gap_match_drag_stack_head")):(child.disable(),child.node.removeClass("gap_match_drag_stack_head")),child}},a5.views.interaction.StackFillArea.extend("a5.views.interaction.GapMatchStackNoDropView"),a5.views.interaction.GapMatchTileView={init:function(model,parent){this._super(model,parent),this.isPoolArea=!1,this.node.addClass("gap_match_drag"),a5.utils.wrapFirstLetter(this.$(".content")),this.node.find("div:not(.image-as-trigger) > img").parent().addClass("image-div"),this.node.find("div > .image-as-trigger").parent().addClass("image-div"),this.model.parent.tts_audio&&this.addTTSPlayer()},addTTSPlayer:function(){this.tts_player=new a5.views.TTS_Player($(this.model.content).text()),$(this.node.find(".content")).prepend(this.tts_player.render())}},a5.views.interaction.TileElement.extend("a5.views.interaction.GapMatchTileView"),a5.views.interaction.GapMatchExamsView={init:function(model,parent,gapsOption){this._super(model,parent,$('<div class="gap_match_view"></div>')),this.gapsOption=gapsOption,this.wordpool=new a5.views.WordPool(this.model.poolAlignment,!0,this.model.parent,!0),_.each(this.model.poolDropAreas,function(dropArea){this.wordpool.addChild(new a5.views.interaction.GapMatchGapTextExamsView(dropArea))},this),this.node.append(this.wordpool.render())},adjustGapSize:function(e,size){_.each(e.views(),function(v){v.setHolderSize?v.setHolderSize(size[0],size[1]):v.setSize(size[0],size[1])})},adjustGapSizes:function(){var sizes={};_.each(this.model.poolDropAreas,function(dropArea){var $wm=dropArea.views()[0].$(".width-measure"),$wmContent=$wm.find(".content"),size=[$wmContent.outerWidth(),$wmContent.outerHeight()];$wm.remove(),sizes[dropArea.resident.identifier]=size});var size=[0,0];_.each(sizes,function(e){e[0]>size[0]&&(size[0]=e[0]),e[1]>size[1]&&(size[1]=e[1])}),_.each(this.model.poolDropAreas,function(dropArea,i){var height=sizes[dropArea.resident.identifier][1];this.adjustGapSize(dropArea,[size[0],height])},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.GapMatchExamsView"),a5.views.interaction.GapMatchGapExamsView={init:function(model,parent){this._super(model,parent),this.node.addClass("gap_match_gap_view"),this.model.enumeration&&this.model.enumeration.then(function(enumSymbol){this.node.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}.bind(this)),this.node.attr("tabindex","-1")},updateToInput:function(){this.hideAnswerFeedback()},createViewFor:function(model){return new a5.views.interaction.GapMatchDragExamsView(model,this)},setAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(this.model.getCorrect())}),this.bindAnswerFeedback(this.model.getCorrect(),{correct:this.model.isCorrect()})),this.updateToThisDrag(this.model.drag)},showAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.updateToThisDrag(this.model.getCorrect()),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.drag,tooltip:this.model.drag&&this.model.drag.content.clone(!0)}))},tryAgain:function(){this.$(".check").remove(),this.model.isCorrectable()&&this.updateFeedbackState(this.dragHolder)}},a5.views.interaction.DropArea.extend("a5.views.interaction.GapMatchGapExamsView"),a5.views.interaction.GapMatchGapTextExamsView={init:function(model,parent){this._super(model,parent),this.node.addClass("gap_match_gap_text_view"),this.preserveSize=!0},createViewFor:function(model){var child=new a5.views.interaction.GapMatchDragExamsView(model,this);return this.$(".width-measure").empty().append(child.node.clone(!0)),child}},a5.views.interaction.DropArea.extend("a5.views.interaction.GapMatchGapTextExamsView"),a5.views.interaction.GapMatchDragExamsView={init:function(model,parent){this._super(model,parent),this.node.addClass("gap_match_drag gap_match_drag_exams")}},a5.views.interaction.DragElement.extend("a5.views.interaction.GapMatchDragExamsView"),a5.views.interaction.GraphicGapMatchView={init:function(model,parent,options){this._super(model,parent,options),this.node.addClass("graphic_gap_match_view"),this.targetViews=_.map(this.model.targetDropAreas,function(dropArea){return new a5.views.interaction[options.blockElementClass](dropArea,this,{elementClass:options.elementClass})},this),this.interaction=this.model.parent,this.onWindowResizeThrottleFn=_.throttle(this.onWindowResize,300),_.bindAll(this,"onFontUpdated","onStylesLoaded","onWindowResize","onWindowResizeThrottleFn","onImageLoaded"),this.interaction.bind("rendered",this.onInteractionRendered,this),this.interaction.bind("reset",this.onInteractionReset,this),a5.hooks.interactionFontUpdated.add(this.onFontUpdated),a5.hooks.layoutStylesLoaded.add(this.onStylesLoaded),$(window).on("resize",this.onWindowResizeThrottleFn)},render:function(){return this.wordpool.block.append(_.invoke(this.targetViews,"render")),this.node},onInteractionReset:function(){$(window).off("resize",this.onWindowResizeThrottleFn),a5.hooks.interactionFontUpdated.remove(this.onFontUpdated),a5.hooks.layoutStylesLoaded.remove(this.onStylesLoaded),this.interaction.unbind("rendered",this.onInteractionRendered),this.interaction.unbind("reset",this.onInteractionReset)},onImageLoaded:function(){this.adjustGapSizes()},onInteractionRendered:function(){this.adjustGapSizes()},onFontUpdated:function(){this.adjustGapSizes()},onStylesLoaded:function(){this.adjustGapSizes()},onWindowResize:function(){this.adjustGapSizes()},setImage:function(){this.$image=this.node.find(".block > img").first(),this.$image.on("load",this.onImageLoaded)},adjustGapSizes:function(){this.interaction.visible||(this.interaction.disableVisibility(),this.interaction.contentWrap.show()),a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.removeBodySubstyle(),this.interaction.addBodySubstyle(),this._super(),this.adjustBlock(),this.interaction.removeBodySubstyle(),a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.addBodySubstyle(),this.interaction.visible||(this.interaction.contentWrap.hide(),this.interaction.enableVisibility())},adjustBlock:function(){var prevSize=this.curSize;this.curSize=this.currentSize(),this.curSize&&prevSize&&this.curSize.width===prevSize.width&&this.curSize.height===prevSize.height||(this.adjustGapPositions(),this.adjustBlockSize())},adjustBlockSize:function(){_.defer(_.bind(this.wordpool.block.applyBoundingHeight,this.wordpool.block))},adjustGapPositions:function(){_.invoke(this.targetViews,"adjustPosition")},currentSize:function(){return{width:this.$image.width(),height:this.$image.height()}},originalSize:function(){return this.model.originalSize||{width:this.$image[0].naturalWidth,height:this.$image[0].naturalHeight}}},a5.views.interaction.GapMatchView.extend("a5.views.interaction.GraphicGapMatchView"),a5.views.interaction.GraphicGapMatchWithStacksView={init:function(model,parent,options){this._super(model,parent,options),this.node.addClass("graphic_gap_match_view"),this.targetViews=_.map(this.model.targetDropAreas,function(dropArea){return new a5.views.interaction[options.blockElementClass](dropArea,this,{elementClass:options.elementClass})},this),this.interaction=this.model.parent,this.onWindowResizeThrottleFn=_.throttle(this.onWindowResize,300),_.bindAll(this,"onFontUpdated","onStylesLoaded","onWindowResize","onWindowResizeThrottleFn","onImageLoaded"),this.interaction.bind("rendered",this.onInteractionRendered,this),this.interaction.bind("reset",this.onInteractionReset,this),a5.hooks.interactionFontUpdated.add(this.onFontUpdated),a5.hooks.layoutStylesLoaded.add(this.onStylesLoaded),$(window).on("resize",this.onWindowResizeThrottleFn)},render:function(){return this.wordpool.block.append(_.invoke(this.targetViews,"render")),this.node},onInteractionReset:function(){$(window).off("resize",this.onWindowResizeThrottleFn),a5.hooks.interactionFontUpdated.remove(this.onFontUpdated),a5.hooks.layoutStylesLoaded.remove(this.onStylesLoaded),this.interaction.unbind("rendered",this.onInteractionRendered),this.interaction.unbind("reset",this.onInteractionReset)},onImageLoaded:function(){this.adjustGapSizes()},onInteractionRendered:function(){this.adjustGapSizes()},onFontUpdated:function(){this.adjustGapSizes()},onStylesLoaded:function(){this.adjustGapSizes()},onWindowResize:function(){this.adjustGapSizes()},setImage:function(){this.$image=this.node.find("img").first(),this.$image.on("load",this.onImageLoaded)},adjustGapSizes:function(){this.interaction.visible||(this.interaction.disableVisibility(),this.interaction.contentWrap.show()),a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.removeBodySubstyle(),this.interaction.addBodySubstyle(),this._super(),this.adjustBlock(),this.interaction.removeBodySubstyle(),a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.addBodySubstyle(),this.interaction.visible||(this.interaction.contentWrap.hide(),this.interaction.enableVisibility())},adjustBlock:function(){var prevSize=this.curSize;this.curSize=this.currentSize(),this.curSize&&prevSize&&this.curSize.width===prevSize.width&&this.curSize.height===prevSize.height||(this.adjustGapPositions(),this.adjustBlockSize())},adjustBlockSize:function(){_.defer(_.bind(this.wordpool.block.applyBoundingHeight,this.wordpool.block))},adjustGapPositions:function(){_.invoke(this.targetViews,"adjustPosition")},currentSize:function(){return{width:this.$image.width(),height:this.$image.height()}},originalSize:function(){return this.model.originalSize||{width:this.$image[0].naturalWidth,height:this.$image[0].naturalHeight}}},a5.views.interaction.GapMatchWithStacksView.extend("a5.views.interaction.GraphicGapMatchWithStacksView"),a5.views.interaction.GraphicGapMatchGapView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_gap_view"),this.preserveSize=!0,this.model.bind("input_update:setAnswer",this.setAnswerInput,this)},adjustPosition:function(){var oLeft=this.model.position[0],oTop=this.model.position[1],oSize=this.parent.originalSize(),cSize=this.parent.currentSize(),newTop=oTop*cSize.height/oSize.height,newLeft=oLeft*cSize.width/oSize.width;this.node.css({left:newLeft+"px",top:newTop+"px"})},createViewFor:function(model){return new a5.views.interaction.GapMatchDragView(model,this,{elementClass:this.elementClass})},setAnswer:function(){var setCheck=this.model.isCorrectable();this.setAnswerCheck(setCheck)},setAnswerInput:function(){var setCheck=this.model.isCorrectable()&&this.model.isFilled();this.setAnswerCheck(setCheck)},setAnswerCheck:function(check){this.$(".check").remove(),check&&(this.updateFeedbackState(this.dragHolder),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(this.model.getCorrect())}),this.bindAnswerFeedback(this.model.getCorrect(),{correct:this.model.isCorrect()}))},showAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.updateToThisDrag(this.model.getCorrect()),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.drag,tooltip:this.model.drag&&this.model.drag.content.clone(!0)}))},showNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},tryAgain:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.dragHolder.droppable("option","disabled",this.isLocked(this.dragHolder)))}},a5.views.interaction.DropArea.extend("a5.views.interaction.GraphicGapMatchGapView"),a5.views.interaction.GraphicGapMatchStackView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_stack_view"),this.preserveSize=!0},createViewFor:function(model){return new a5.views.interaction.GapMatchDragView(model,this,{elementClass:this.elementClass})}},a5.views.interaction.StackDropArea.extend("a5.views.interaction.GraphicGapMatchStackView"),a5.views.interaction.GraphicGapMatchGapNoDropView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_gap_view"),this.preserveSize=!0,this.model.bind("input_update:setAnswer",this.setAnswerInput,this)},adjustPosition:function(){
var oLeft=this.model.position[0],oTop=this.model.position[1],oSize=this.parent.originalSize(),cSize=this.parent.currentSize(),newTop=oTop*cSize.height/oSize.height,newLeft=oLeft*cSize.width/oSize.width;this.node.css({left:newLeft+"px",top:newTop+"px"})},createViewFor:function(model){return new a5.views.interaction.GapMatchTileView(model,this,{elementClass:this.elementClass})},onOver:function(event,ui){0==this.node.closest(".pool").length&&this._super(event,ui)},setAnswer:function(){var setCheck=this.model.isCorrectable();this.setAnswerCheck(setCheck)},setAnswerInput:function(){var setCheck=this.model.isCorrectable()&&this.model.isFilled();this.setAnswerCheck(setCheck)},setAnswerCheck:function(check){this.$(".check").remove(),check&&(this.updateFeedbackState(this.dragHolder),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(this.model.getCorrect())}),this.bindAnswerFeedback(this.model.getCorrect(),{correct:this.model.isCorrect()}))},showAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.updateToThisDrag(this.model.getCorrect()),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.drag,tooltip:this.model.drag&&this.model.drag.content.clone(!0)}))},showNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},tryAgain:function(){this.$(".check").remove(),this.model.isCorrectable()&&this.updateFeedbackState(this.dragHolder)}},a5.views.interaction.FillArea.extend("a5.views.interaction.GraphicGapMatchGapNoDropView"),a5.views.OMPairsInteraction={NODE_TEMPLATE:'<div class="pairs_view"></div>',init:function(model,parent,interaction){this._super(model,parent,$(this.NODE_TEMPLATE)),this.createWordPoolAndDrags(this.model.responses,interaction),"bottom"===this.model.poolAlignment?(this.node.append(this.createGaps(interaction)),this.node.append(this.wordpool.render())):(this.node.append(this.wordpool.render()),this.node.append(this.createGaps(interaction))),this.model.isTapTarget()&&$(document).on("touchend",_.bind(this.onBodyClick,this))},onBodyClick:function(e){0===$(e.target).parents(".drag_holder").length&&0===$(e.target).parents(".drag_element").length&&this.selected&&this.setSelected(!1)},createWordPoolAndDrags:function(responses,interaction){var wordpool=new a5.views.WordPoolSimple(this.model.poolAlignment,this,!0,interaction,!0),drags=[];_.each(responses,function(response){var dragElement=new a5.views.OMPairsDragElement(response,null,interaction,this);if(drags.push(dragElement),!response.isPrefilled()){var dropPoolElement=new a5.views.interaction.SimpleDropArea(null,wordpool,interaction);dropPoolElement.setDrag(dragElement),this.model.isTapTarget()&&this._bindPoolTapTargetDropEvent(dropPoolElement),wordpool.addChild(dropPoolElement)}},this),this.wordpool=wordpool,this.drags=drags},_bindPoolTapTargetDropEvent:function(dropPoolElement){var mainView=this;dropPoolElement.node.click(_.bind(function(){mainView.selected&&!this.drag&&(this.drop(mainView.selected),mainView.setSelected(!1))},dropPoolElement))},createGaps:function(interaction){var gapsContainer=$("<div/>");gapsContainer.addClass("gaps_container "+this.model.pairAlignment);var views=_.map(this.model.gaps,function(gap){var view=new a5.views.OMPairsTextgap(gap,this,interaction),drag=gap.isPrefilled()?this.getDragViewByIdentifier(gap.correctResponse):null;return view.setDrag(drag),gapsContainer.append(view.render()),view},this);return this.views=views,gapsContainer},getDragViewById:function(id){return _.find(this.drags,function(el){return el.node.attr("data-model-id")===id})},getDragViewByIdentifier:function(id){return _.find(this.drags,function(el){return el.model.identifier===id})},getAvailablePoolAreas:function(){return this.wordpool.getAvailablePoolAreas()},getAvailableViews:function(){return _.filter(this.views,function(area){return null===area.drag})},setSelected:function(view){(this.selected||this.selected===view)&&this.selected.deselect(),view&&this.selected!==view?(this.selected=view,this.selected.select()):this.selected=void 0},moveDragViewToPool:function(drag){this.wordpool.moveDragViewToPool(drag)}},a5.views.interaction.BaseView.extend("a5.views.OMPairsInteraction"),a5.views.OMPairsTextgap={init:function(model,parent,interaction){this._super(model,parent,interaction),this.node.addClass("ompairs_gap"),this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this)),this.node.toggleClass("drop-indicator",this.model.dropIndicator),_.bindAll(this,"onShowAnswers","onFeedback","onInput","onClick","onKeydown"),this.model.bind("state_update:answers",this.onShowAnswers),this.model.bind("state_update:feedback",this.onFeedback),this.model.bind("state_update:input",this.onInput),this.enable()},onClick:function(){this.tapTarget()},onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.tapTarget()},tapTarget:function(){this.parent.selected&&!this.model.value&&(this.drop(this.parent.selected),this.parent.setSelected(!1))},drop:function(drag){this._super(drag),"input"===this.model.state&&this.model.updateValue(drag.model)},undrop:function(){this._super(),"input"===this.model.state&&this.model.updateValue(null)},onInput:function(){if(!this.model.isPrefilled()){this.$(".check").remove(),this.updateFeedbackState(this.node);var value=this.model.value;if(this.drag&&this.parent.moveDragViewToPool(this.drag),this.enable(),value){var drag=this.parent.getDragViewByIdentifier(value);this.drop(drag),this.model.lockAnswer()&&(this.disable(),this.drag.disable())}}},onFeedback:function(){this.model.isPrefilled()||(this.$(".check").remove(),this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect()}),this.disable())},onShowAnswers:function(){if(!this.model.isPrefilled()){this.$(".check").remove(),this.drag&&this.parent.moveDragViewToPool(this.drag);var drag=this.parent.getDragViewByIdentifier(this.model.correctResponse);this.drop(drag),this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.isFilled()}),this.disable()}},disable:function(){this._super(),this.model.parent.isTapTarget()&&!this.model.isPrefilled()&&(this.node.off("click",this.onClick),this.node.off("keydown",this.onKeydown))},enable:function(){this._super(),this.model.parent.isTapTarget()&&!this.model.isPrefilled()&&(this.node.on("click",this.onClick),this.node.on("keydown",this.onKeydown))}},a5.views.interaction.SimpleDropArea.extend("a5.views.OMPairsTextgap"),a5.views.OMPairsDragElement={init:function(model,parent,interaction,mainView){this._super(model,parent,interaction),this.node.addClass("om-pairs-element"),_.bindAll(this,"disable","onInput","onClick","onDoubleTap","onKeydown"),this.model.bind("state_update:answers",this.disable),this.model.bind("state_update:feedback",this.disable),this.model.bind("state_update:input",this.onInput),this.enable(),this.mainView=mainView},_bindDoubleTap:function(){this.hammer=new Hammer.Manager(this.node[0],{});var doubleTap=new Hammer.Tap({event:"doubletap",taps:2});this.hammer.add(doubleTap),this.hammer.on("doubletap",this.onDoubleTap)},_unbindDoubleTap:function(){this.hammer&&this.hammer.off("doubletap",this.onDoubleTap)},activate:function(moveToPool){this.model.parent.isTapItem()?this.model.isInPool()?this.tapItem():moveToPool&&this.moveDragToPool():this.model.parent.isTapTarget()&&this.selectTarget()},select:function(){this.node.addClass("selected")},deselect:function(){this.node.removeClass("selected")},selectTarget:function(e){this.mainView.selected!==this&&this.mainView.setSelected(this)},tapItem:function(e){if(this.model.isInPool()&&"input"===this.model.state){var view=_.first(this.mainView.getAvailableViews());view&&view.drop(this)}},onClick:function(){this.activate(!1)},onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.activate(!0)},onDoubleTap:function(e){this.moveDragToPool()},moveDragToPool:function(){this.model.isInGap()&&"input"===this.model.state&&(this.parent.parent.moveDragViewToPool(this),this.mainView.selected==this&&this.mainView.setSelected(!1))},onInput:function(){this.model.isPrefilled()||this.enable()},enable:function(){this._super(),this.model.isPrefilled()||!this.model.parent.isTapItem()&&!this.model.parent.isTapTarget()||(this.disableDraggable(),this.node.on("click",this.onClick),this.node.on("keydown",this.onKeydown),this.node.attr("tabindex",0),this._bindDoubleTap())},disable:function(){this._super(),this.model.isPrefilled()||!this.model.parent.isTapItem()&&!this.model.parent.isTapTarget()||(this.node.off("click",this.onClick),this.node.off("keydown",this.onKeydown),this._unbindDoubleTap(),this.mainView.setSelected(!1))}},a5.views.interaction.SimpleDragElement.extend("a5.views.OMPairsDragElement"),a5.views.OMPairsViewDD={init:function(model,parent,node){this._super(model,parent,node)},reUp:function(event,ui){var interaction=window.a5.mainBuilder.curInteraction;$("#content-"+interaction.index+" .wordpool .drop_item_zone").droppable("disable"),_.each($("#content-"+interaction.index+" .wordpool .drop_item_zone"),function(w){0==$(w).children().length&&$(w).droppable("enable")}),$(this).parent().removeClass("hovered hwb"),$("#content-"+interaction.index).removeClass("drop_indicator");var evtTarget=event.srcElement||event.originalEvent.target;($(evtTarget).is(".drag_audio_player")||$(evtTarget).is(".image-as-trigger .play-button"))&&$(evtTarget).addClass("no-play"),ui.helper.draggable("option","scroll",!1)},fixBorder:function(event,ui){var interaction=window.a5.mainBuilder.curInteraction;$("#content-"+interaction.index+" .ui-draggable-dragging").removeClass("dragging_over");var evtTarget=event.srcElement||event.originalEvent.target;($(evtTarget).is(".drag_audio_player")||$(evtTarget).is(".image-as-trigger .play-button"))&&$(evtTarget).removeClass("no-play")},showOver:function(event,ui){var interaction=window.a5.mainBuilder.curInteraction,self=this;$("#content-"+interaction.index+".ui-draggable-dragging").addClass("dragging_over"),self.model.interaction.options.dropIndicatorIsTrue()?($("#content-"+interaction.index).addClass("drop_indicator"),$(this).addClass("hovered")):$(this).addClass("hwb")},removeOver:function(event,ui){var interaction=window.a5.mainBuilder.curInteraction;$("#content-"+interaction.index+".ui-draggable-dragging").removeClass("dragging_over"),$("#content-"+interaction.index).removeClass("drop_indicator"),$(this).removeClass("hovered hwb")},handleCardDropOnWordpool:function(event,ui,c){var interaction=window.a5.mainBuilder.curInteraction,free=_.first(_.filter($(c).find("> .drop_item_zone"),function(el){return 0==el.children.length}));interaction.model.removeItem(ui.draggable.attr("id").split("-")[1]),this.resize(ui.draggable.parent(),ui.draggable),$("#content-"+interaction.index+" .ui-draggable-dragging").removeClass("dragging_over"),$("#content-"+interaction.index).removeClass("drop_indicator"),ui.draggable.parent().removeClass("has_drag_item"),ui.draggable.parents(".drop_zone").removeClass("hovered hwb"),ui.draggable.appendTo($(free)),this.resize($(free),ui.draggable),ui.draggable.css({position:"relative",top:"0px",left:"0px"}),$(free).parent().removeClass("hovered hwb"),$("#content-"+interaction.index+" .drop_item_zone").droppable("enable")},handleCardDrop:function(event,ui,c){var interaction=window.a5.mainBuilder.curInteraction,id=_.isUndefined($(c).attr("id"))?$(c).parent().attr("id"):$(c).attr("id");_.each(interaction.model.items[id.split("-")[1]],function(item){interaction.model.removeItem(item),$(c).find(".drag_item").appendTo($("#content-"+interaction.index).find(".drop_item_zone:empty:first"))},this),"OR"==id.split("-")[0]?interaction.model.removeItem(ui.draggable.attr("id").split("-")[1]):interaction.model.draggedItem(ui.draggable.attr("id").split("-")[1],id.split("-")[1]),this.resize(ui.draggable.parent(),ui.draggable),$("#content-"+interaction.index+".ui-draggable-dragging").removeClass("dragging_over"),$("#content-"+interaction.index).removeClass("drop_indicator"),ui.draggable.parent().removeClass("has_drag_item"),ui.draggable.parents(".drop_zone").removeClass("hovered hwb"),ui.draggable.appendTo(c),this.resize($(c),ui.draggable),ui.draggable.css({position:"relative",top:"0px",left:"0px"}),$(c).parent().removeClass("hovered hwb"),$(c).addClass("has_drag_item"),$("#content-"+interaction.index+".drop_item_zone").droppable("enable"),this.applyContainment(ui.draggable)},wordpoolMove:function(event,ui){var interaction=window.a5.mainBuilder.curInteraction;$("#content-"+interaction.index).css({"margin-top":"0"}),$("#content-"+interaction.index+" .reset_position").show()},resize:function($zone,$item){if($zone.hasClass("drop_item_zone")){$zone.css({width:"auto",height:"auto"});var width=$item.width(),height=$item.height();$zone.css({width:width+12,height:height})}},applyContainment:function($drag){if(!("containment"in this.draggableOptions)){var interaction=window.a5.mainBuilder.curInteraction,$container=$("#content-"+interaction.index),x1=$container.offset().left-$drag.width(),x2=$container.offset().left+$container.width(),y2=$(document).height();$drag.draggable("option","containment",[x1,0,x2,y2])}},applyAllContainments:function(){if(!("containment"in this.draggableOptions)){var interaction=window.a5.mainBuilder.curInteraction,dragItems=$("#content-"+interaction.index+" .drag_item");_(dragItems).each(function(dragItem){this.applyContainment($(dragItem))},this)}}},a5.views.interaction.BaseView.extend("a5.views.OMPairsViewDD"),a5.views.OMPairsViewPool={init:function(model,node,parentNode,poolIds,distractors,targetIds,gaptextaudio){this.gaptextaudio=gaptextaudio,this.node=$('<div class="ddm_wordpool_view"></div>'),this.model=model;var wordpool=$("<div class='wordpool'></div>");wordpool.append('<h2 style="display:none;">:: drag to move wordpool ::<span class="reset_position" style="display: none; ">dock</span></h2>');var pools=[];_.each(poolIds,function(id){var contentNode=$(node).find("simpleAssociableChoice[identifier='"+id+"']").first(),cn=$("<div></div>");model.interaction.buildModel(cn,$(contentNode));var html=$('<div class="drop_item_zone has_drag_item orig_'+id+'" id="OR-'+id+'"><div class="drag_item om-pairs-element" id="DI-'+id+'"></div></div>');html.find(".drag_item").append(cn),pools.push(html)}),_.each(distractors,function(d,index){var id=d[0],label=d[1];_.include(poolIds,id)||_.include(targetIds,id)||pools.push('<div class="drop_item_zone has_drag_item orig_D'+index+'" id="OR-D'+index+'"><div class="drag_item om-pairs-element" id="DI-D'+index+'"><div>'+label+"</div></div></div>")}),this.render_tts_to_wordpool(pools),_.each(_.shuffle(pools),function(drag){wordpool.append(drag)}),this.node.append(wordpool)},render_tts_to_wordpool:function(wordpool){if(this.gaptextaudio)for(var i=0;i<wordpool.length;i++){wordpool[i]=$(wordpool[i]);var text=wordpool[i].find(".drag_item").not(".hidden").text(),player=new a5.views.TTS_Player(text);wordpool[i].find(".drag_item div").prepend(player.render())}},events:function(){},render:function(){return this.node}},a5.views.OMPairsViewDD.extend("a5.views.OMPairsViewPool"),a5.views.OMPairsViewTarget={init:function(model,node,parentNode,targetIds,enumAnswer,pairAlignment,gaptextaudio){this.gaptextaudio=gaptextaudio,this._super(model,parentNode,$('<div class="ddm_target_view '+pairAlignment+'" data-index="'+model.interaction.index+'"></div>')),this.model=model,this.nodeObj=node,this.enumAnswer=enumAnswer,this.pairAlignment=pairAlignment,this.loadUI()},loadUI:function(){var self=this;this.node.find(".content_sub").remove();var target=$('<div class="content_sub"></div');_.each(self.model.targetIds,function(id){var label=_.select($(self.nodeObj).find("#contentblock simpleAssociableChoice"),function(s){return $(s).attr("identifier")==id}),cn=$("<div></div>");$(_.first(label)).children();self.model.interaction.buildModel(cn,$(label));for(var enumAnswers=self.model.interaction.enumAnswers,html='<div class="drop_zone" id="DZ'+self.model.interaction.index+"-"+id+'">',i=0;i<self.model.targetPools[id].length;i++)self.enumAnswer&&(html+='<div class="enumanswer"></div>');html+="<h1></h1></div>",html=$(html),enumAnswers.next().then(function(enum_str){html.find(".enumanswer").html(enum_str)}),self.render_tts_player(cn),html.find("h1").append(cn),target.append(html)}),this.node.append(target)},render_tts_player:function(target){if(this.gaptextaudio){var text=$(target).text(),player=new a5.views.TTS_Player(text);target.prepend(player.render())}},events:function(){var prevY,self=this;this.draggableOptions=a5.utils.getDraggableOptions(this.model.interaction),$("#content-"+self.model.interaction.index+" .drag_item").draggable($.extend({start:this.reUp.bindDD(this),stop:this.fixBorder.bindDD(this),drag:function(e,ui){var newScrollSensitivity,currentScrollSensitivity=$(this).draggable("option","scrollSensitivity");prevY&&e.pageY>prevY&&e.clientY>20+a5.dp.config.exclusionBottom?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&$(this).draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&$(this).draggable("option","scrollSensitivity",newScrollSensitivity)),prevY=e.pageY,e.clientY>20+a5.dp.config.exclusionTop&&e.clientY<$(window).height()-20-a5.dp.config.exclusionBottom&&$(this).draggable("option","scroll",!0)},snap:!1,stack:".drag_item",revert:"invalid",revertDuration:350,zIndex:2700,cancel:".checked-correct-locked"},this.draggableOptions)),self.model.interaction.bind("show:deferred",_.bind(self.applyAllContainments,self),{once:!0}),self.model.interaction.bind("screen_transition:end",_.bind(this.applyAllContainments,this),{once:!0}),$("#content-"+self.model.interaction.index+" .drag_item").draggable("enable");var hc=self.model.interaction.options.dropIndicatorIsTrue()?"hovered":"hwb";$("#content-"+self.model.interaction.index+" .drop_zone").droppable({accept:".drag_item",hoverClass:hc,over:this.showOver.bindDD(this),out:this.removeOver.bindDD(this),drop:this.handleCardDrop.bindDD(this),tolerance:"pointer"}),$("#content-"+self.model.interaction.index+" .wordpool .drop_item_zone").droppable({accept:".drag_item",hoverClass:hc,over:this.showOver.bindDD(this),out:this.removeOver.bindDD(this),drop:this.handleCardDrop.bindDD(this),tolerance:"pointer",greedy:!0}),$("#content-"+self.model.interaction.index+" .wordpool").droppable({accept:".drag_item",hoverClass:hc,drop:this.handleCardDropOnWordpool.bindDD(this),tolerance:"pointer"}),self.model.interaction.options.poolAlignmentIsFree()&&($("#content-"+self.model.interaction.index+" .wordpool").draggable({start:this.wordpoolMove.bindDD(this),drag:function(e,ui){var newScrollSensitivity,currentScrollSensitivity=$(this).draggable("option","scrollSensitivity");prevY&&e.pageY>prevY?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&$(this).draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&$(this).draggable("option","scrollSensitivity",newScrollSensitivity)),prevY=e.pageY},handle:"h2",stack:".drag_item",containment:self.model.interaction.contentWrap,cancel:".reset_position"}),$("#content-"+self.model.interaction.index+" .reset_position").click(function(){$("#content-"+self.model.interaction.index+" .reset_position").hide(),$("#content-"+self.model.interaction.index+" .wordpool").css("position","relative"),$("#content-"+self.model.interaction.index+" .wordpool").css("top","0"),$("#content-"+self.model.interaction.index+" .wordpool").css("left","0")})),$("#content-"+self.model.interaction.index+" .drag_item.prefilled").draggable("disable")},updateState:function(){this.initPool(),_.each(this.model.items,function(v,k){if(1==v.length){var item=$("#content-"+this.model.interaction.index+" #DI-"+v[0])[0].outerHTML,$dragitem=$("#content-"+this.model.interaction.index+" #DI-"+v[0]);$dragitem.parent().removeClass("has_drag_item"),$dragitem.remove();var filled=!1;_.each($("#content-"+this.model.interaction.index+" #DZ"+this.model.interaction.index+"-"+k),function(diz){0!=$(diz).find(".drag_item").length||filled||($(diz).append(item).addClass("has_drag_item"),filled=!0)})}},this),this.events()},initPool:function(){var self=this;_.each(this.model.badAnswers,function(v,k){if($("#content-"+self.model.interaction.index+" .drop_zone #DI-"+k).length>0){var item=$("#content-"+self.model.interaction.index+" #DI-"+k)[0].outerHTML;$("#content-"+self.model.interaction.index+" #DI-"+k).remove();var filled=!1;_.each($("#content-"+self.model.interaction.index+" .wordpool .drop_item_zone"),function(diz){0!=$(diz).children().length||filled||($(diz).append(item),filled=!0)})}})},setAnswer:function(){var self=this;$("#content-"+self.model.interaction.index+" .check").remove(),$("#content-"+self.model.interaction.index+" .drag_item").draggable("disable"),this.checkLocked($("#content-"+this.model.interaction.index+" .drop_zone")),$("#content-"+self.model.interaction.index+" .drop_zone").droppable("disable").removeClass("checked-empty checked-incorrect checked-correct").removeClass("solution-empty solution-incorrect solution-correct"),_.each(this.model.badAnswers,function(v,k){if(!$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v+" .drag_item").hasClass("prefilled")){var $dz=$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v);_.isUndefined(self.model.items[k])||_.isEmpty(self.model.items[k])?$dz.addClass("checked-empty"):$dz.addClass("checked-incorrect"),this.addCheck({tooltip:this.model.incorrectFeedback,parent:$dz})}},this),_.each(this.model.goodAnswers,function(v,k){if(!$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v+" .drag_item").hasClass("prefilled")){var $dz=$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v);$dz.addClass("checked-correct"),this.addCheck({correct:!0,tooltip:this.model.correctFeedback,correctTooltip:!0,parent:$dz})}},this)},tryAgain:function(){$("#content-"+this.model.interaction.index+" .drop_zone").droppable("enable"),this.checkLocked($("#content-"+this.model.interaction.index+" .drop_zone")),$("#content-"+this.model.interaction.index+" .drop_zone").removeClass("checked-empty checked-incorrect checked-correct").removeClass("solution-empty solution-incorrect solution-correct"),this.model.interaction.options.tryAgainIsKeepall()||(_(this.model.badAnswers).chain().pairs().shuffle().object().each(function(v,k){if($("#content-"+this.model.interaction.index+" .drop_zone #DI-"+k).length>0){var audioViewUpdater=$("#content-"+this.model.interaction.index+" #DI-"+k+" [data-has-view-updater=true]").data("view-updater"),item=$("#content-"+this.model.interaction.index+" #DI-"+k)[0].outerHTML;$("#content-"+this.model.interaction.index+" #DI-"+k).parent().removeClass("has_drag_item"),$("#content-"+this.model.interaction.index+" #DI-"+k).remove(),this.model.removeItem(k);var filled=!1;_.each($("#content-"+this.model.interaction.index+" .wordpool .drop_item_zone"),function(diz){0!=$(diz).children().length||filled||($(diz).append(item),$(diz).find("[data-has-view-updater=true]").data("view-updater",audioViewUpdater),audioViewUpdater&&audioViewUpdater.update(),filled=!0,this.resize($(diz),$(diz).children()))},this)}},this),this.model.tryAgainIsFrozen&&_(this.model.goodAnswers).chain().pairs().shuffle().object().each(function(v,k){$("#content-"+this.model.interaction.index+" #DZ"+this.model.interaction.index+"-"+v).droppable("option","disabled",!0)},this)),$("#content-"+this.model.interaction.index+" .check").remove(),this.events()},showAnswer:function(){var self=this;$("#content-"+self.model.interaction.index+" .drag_item").draggable("disable"),$("#content-"+self.model.interaction.index+" .drop_zone").droppable("disable").removeClass("checked-empty checked-incorrect checked-correct").removeClass("solution-empty solution-incorrect solution-correct"),$("#content-"+self.model.interaction.index+" .check").remove(),_.each(this.model.badAnswers,function(v,k){if($("#content-"+self.model.interaction.index+" .drop_zone #DI-"+k).length>0){var item=$("#content-"+self.model.interaction.index+" #DI-"+k)[0].outerHTML,audioViewUpdater=$("#content-"+self.model.interaction.index+" #DI-"+k+" [data-has-view-updater=true]").data("view-updater"),draggableData=$("#content-"+self.model.interaction.index+" #DI-"+k).data("ui-draggable");$("#content-"+self.model.interaction.index+" #DI-"+k).remove();var filled=!1;_.each($("#content-"+self.model.interaction.index+" .wordpool .drop_item_zone"),function(diz){0!=$(diz).children().length||filled||($(diz).append(item).addClass("has_drag_item"),filled=!0)}),$("#content-"+self.model.interaction.index+" #DI-"+k).find("[data-has-view-updater=true]").data("view-updater",audioViewUpdater),audioViewUpdater&&audioViewUpdater.update(),$("#content-"+self.model.interaction.index+" #DI-"+k).data("ui-draggable",draggableData)}});var expected_items=_.flatten(_.values(this.model.targetPools));_.each(this.model.badAnswers,function(v,k){if(_.include(expected_items,k)){var item=$("#content-"+self.model.interaction.index+" #DI-"+k)[0].outerHTML,zIndex=$("#content-"+self.model.interaction.index+" #DI-"+k).css("z-index"),audioViewUpdater=$("#content-"+self.model.interaction.index+" #DI-"+k+" [data-has-view-updater=true]").data("view-updater"),draggableData=$("#content-"+self.model.interaction.index+" #DI-"+k).data("ui-draggable");$("#content-"+self.model.interaction.index+" #DI-"+k).remove();var filled=!1;_.each($("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+self.model.poolTarget[k]),function(diz){if(0===$(diz).find(".drag_item").length&&!filled){var $item=$(item);$item.css("z-index",zIndex),$(diz).addClass("has_drag_item"),$(diz).append($item),filled=!0}(_.isUndefined(self.model.items[k])||_.isEmpty(self.model.items[k]))&&(this.addCheck({empty:!0,parent:$(diz)}),$(diz).addClass("solution-empty")),_.isUndefined(self.model.items[k])||_.isEmpty(self.model.items[k])||(this.addCheck({parent:$(diz)}),$(diz).addClass("solution-incorrect"))},this),$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+self.model.poolTarget[k]+" #DI-"+k).parents(".drop_zone, .drop_item_zone").find("[data-has-view-updater=true]").data("view-updater",audioViewUpdater),audioViewUpdater&&audioViewUpdater.update(),$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+self.model.poolTarget[k]+" #DI-"+k).parents(".drop_zone, .drop_item_zone").find(".ui-draggable").data("ui-draggable",draggableData)}},this),_.each(this.model.goodAnswers,function(v,k){if(!$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v+" .drag_item").hasClass("prefilled")){var $dz=$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v);$dz.addClass("solution-correct"),this.addCheck({correct:!0,tooltip:this.model.correctFeedback,correctTooltip:!0,parent:$dz})}},this)},render:function(){return this.node},adjustHeights:function(){var self=this;$("#content-"+self.model.interaction.index+" .drop_zone").css("height",""),$("#content-"+self.model.interaction.index+" .drop_zone").height(_.max(_.map($("#content-"+self.model.interaction.index+" .drop_zone"),function(dz){return $(dz).height()})))}},a5.views.OMPairsViewDD.extend("a5.views.OMPairsViewTarget"),a5.views.OMPairsViewOptions={init:function(model,options,targetPools,targetIds){if(options.poolAlignmentIsRight()&&$("#content-"+model.interaction.index+" .wordpool").addClass("right"),options.poolAlignmentIsLeft()&&$("#content-"+model.interaction.index+" .wordpool").addClass("left"),options.poolAlignmentIsBottom()&&($("#content-"+model.interaction.index+" .ddm_wordpool_view").next().after($("#content-"+model.interaction.index+" .ddm_wordpool_view")),$("#content-"+model.interaction.index+" .ddm_wordpool_view").addClass("bottom"),$("#content-"+model.interaction.index+" .ddm_wordpool_view").css("clear","both")),options.poolAlignmentIsFree()&&$("#content-"+model.interaction.index+" .wordpool > h2").show(),options.prefillIsFirstitem()){var target=_.first(targetIds),id=_.first(model.targetPools[target]),$content=$("#content-"+model.interaction.index+" #DI-"+id),$target=$("#content-"+model.interaction.index+" #DZ"+model.interaction.index+"-"+target);$content.detach(),$target.append($content),$content.addClass("prefilled"),$target.addClass("has-prefill"),model.draggedItem(id,target),model.addPrefill(id)}options.prefillIsFirstblock()&&_.each(model.targetPools[_.first(targetIds)],function(id,index){var $content=$("#content-"+model.interaction.index+" #DI-"+id),$dzone=$($("#content-"+model.interaction.index+" #DZ"+model.interaction.index+"-"+_.first(targetIds)).find(".drop_item_zone")[index]);$dzone.append($content),$dzone.droppable("disable"),$content.addClass("prefilled"),$dzone.addClass("has-prefill"),model.draggedItem(id,target),model.addPrefill(id)}),_.each($("#content-"+model.interaction.index+" .wordpool .drop_item_zone"),function(diz){0==$(diz).find(".drag_item:not(.hidden)").length&&$(diz).remove()})}},a5.views.interaction.BaseView.extend("a5.views.OMPairsViewOptions"),a5.views.interaction.ICTextGapLabelAnObjectBlock={init:function(model,parent){this._super(model,parent,$('<div class="tehs_block"></div>')),this.wordpool=new a5.views.WordPool(this.model.poolAlignment,!1,this.model.parent),_.each(this.model.poolWords,function(word){this.wordpool.append(word,this.model.tts_audio)},this),this.node.append(this.wordpool.render()),this.children=[],this.interaction=this.model.parent,this.onWindowResizeThrottleFn=_.throttle(this.onWindowResize,300),_.bindAll(this,"onFontUpdated","onStylesLoaded","onWindowResize","onWindowResizeThrottleFn","onImageLoaded"),this.interaction.bind("rendered",this.onInteractionRendered,this),this.interaction.bind("reset",this.onInteractionReset,this),a5.hooks.interactionFontUpdated.add(this.onFontUpdated),a5.hooks.layoutStylesLoaded.add(this.onStylesLoaded),$(window).on("resize",this.onWindowResizeThrottleFn)},onInteractionReset:function(){$(window).off("resize",this.onWindowResizeThrottleFn),a5.hooks.interactionFontUpdated.remove(this.onFontUpdated),a5.hooks.layoutStylesLoaded.remove(this.onStylesLoaded),this.interaction.unbind("rendered",this.onInteractionRendered),this.interaction.unbind("reset",this.onInteractionReset)},onImageLoaded:function(){this.adjustGapSizes()},onInteractionRendered:function(){this.adjustGapSizes()},onFontUpdated:function(){this.adjustGapSizes()},onStylesLoaded:function(){this.adjustGapSizes()},onWindowResize:function(){this.adjustGapSizes()},setImage:function(){this.$image=this.node.find("img").first(),this.$image.on("load",this.onImageLoaded)},adjustGapSizes:function(){this.interaction.visible||(this.interaction.disableVisibility(),this.interaction.contentWrap.show()),a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.removeBodySubstyle(),this.interaction.addBodySubstyle(),this.interaction.options.gapsIsSamelongest()?this.adjustGapSizeToLongestResponse():this.adjustGapSizeToLongestCorrect(),this.adjustBlock(),this.interaction.removeBodySubstyle(),a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.addBodySubstyle(),this.interaction.visible||(this.interaction.contentWrap.hide(),this.interaction.enableVisibility())},adjustBlock:function(){var prevSize=this.curSize;this.curSize=this.currentSize(),this.curSize&&prevSize&&this.curSize.width===prevSize.width&&this.curSize.height===prevSize.height||(this.adjustGapPositions(),this.adjustBlockSize())},adjustBlockSize:function(){this.node.closest(".interaction").addClass("wordpool"),
_.defer(_.bind(this.wordpool.block.applyBoundingHeight,this.wordpool.block))},adjustGapPositions:function(){_.invoke(this.children,"adjustPosition")},adjustGapSizeToLongestResponse:function(){var responses=_.flatten(_.map(this.model.gaps,function(e){return e.correct}));_.each(this.children,function(child){child.adjustGapSizeToLongestResponse(responses)})},adjustGapSizeToLongestCorrect:function(){_.each(this.children,function(child){child.adjustGapSizeToLongestCorrect(child.model.correct)})},add:function(child){this.children.push(child)},currentSize:function(){return{width:this.$image.width(),height:this.$image.height()}},originalSize:function(){return this.model.originalSize}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGapLabelAnObjectBlock"),a5.views.interaction.ICTextGapLabelAnObject={TEXT_PLACEHOLDER:"_",init:function(model,parent){this._super(model,parent,$('<div class="tehs_view"></div>'));var correct_and_distractors=_(this.model.correct).without("%0").concat(this.model.distractors);this.model.charactersNumber||_.isEmpty(correct_and_distractors)||!_.all(correct_and_distractors,a5.utils.isInteger)?this.input=$('<input type="text" />'):this.input=$('<input type="number" />'),this.input.val(this.model.value),this.model.prefilled&&(this.node.addClass("prefilled"),this.input.attr("disabled",!0)),this.input.attr("autocapitalize","off"),this.input.attr("autocorrect","off"),this.input.attr("autocomplete",$("body").is(".isChrome")?"none":"off"),this.input.attr("aria-label","Blank input"),this.input.attr("style",this.model.inputStyle),this.model.enumeration&&(this.node.append('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),this.node.append(this.input),this.model.bind("update-value",this.updateValue,this),this.bindEvents(),this.pool_word=this._getPoolWord(),!this.model.prefilled&&this.model.charactersNumber&&(this.node.addClass("characters-in-gap"),$.mask.definitions["*"]=new RegExp("[^\\s"+this.TEXT_PLACEHOLDER+"]"),this.input.mask(this.model.getMaskPattern(),{autoclear:!1,allowpartial:!0}),this.input.attr("placeholder",this.model.getMaskPattern().replace(/\*/g,this.TEXT_PLACEHOLDER)))},adjustPosition:function(){var oLeft=this.model.position[0],oTop=this.model.position[1],oSize=this.parent.originalSize(),cSize=this.parent.currentSize(),newTop=oTop*cSize.height/oSize.height,newLeft=oLeft*cSize.width/oSize.width;this.node.css({left:newLeft+"px",top:newTop+"px"})},_getPoolWord:function(){var result;if(this.model.display_words&&this.parent.wordpool){var pool_words=this.parent.wordpool.pool.find(".static_word").not(".display-word");result=_.find(pool_words,function(word){return _.contains(this.model.display_words,$(word).text())},this),$(result).addClass("display-word")}return result},bindEvents:function(){this.input.on("change",this.onChange.bindTo(this)),this.input.on("input",this.onInput.bindTo(this)),this.input.on("blur",_.bind(function(e){this.node.removeClass("focused"),this.node.removeClass("mouseover"),this.model.resizeGaps&&(this.inputValue()?this.adjustGapSize(!0):this.adjustGapSizeToOriginal())},this)),this.input.on("focus",_.bind(function(e){this.node.addClass("focused"),this.model.charactersNumber&&this.adjustGapSizeToOriginal()},this)),this.input.on("mouseover",_.bind(function(e){this.node.addClass("mouseover")},this)),this.input.on("mouseout",_.bind(function(e){this.node.removeClass("mouseover")},this))},updateValue:function(){this.model.value!==this.input.val()&&this.input.val(this.model.value),this.model.value.trim()?(this.node.addClass("filled"),this.pool_word?$(this.pool_word).addClass("gap-filled"):$(this.pool_word).removeClass("gap-filled")):($(this.pool_word).removeClass("gap-filled"),this.node.removeClass("filled")),this.model.resizeGaps&&(this.inputValue()?this.adjustGapSize():this.adjustGapSizeToOriginal()),this.model.charactersNumber&&(this.inputValue()?this.adjustGapSize(!0):this.adjustGapSizeToOriginal())},onChange:function(e){this.model.setValue(this.inputValue())},onInput:function(e){this.model.setValue(this.inputValue())},inputValue:function(){return this.model.charactersNumber&&""===this.input.val().replace(new RegExp(this.TEXT_PLACEHOLDER,"g"),"").trim()?"":this.input.val()},updateState:function(){this.model.resizeGaps&&(this.inputValue()?this.adjustGapSize():this.adjustGapSizeToOriginal())},setAnswer:function(){this.node.find(".check").remove(),this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect()}),this.input.attr("disabled",!0),this.updateState()},showAnswer:function(){this.node.find(".check").remove(),this.updateFeedbackState(this.node),this.input.val(this.model.getFirstCorrect()),this.model.isCorrect()?this.addCheck({correct:!0}):this.model.isFilled()?this.addCheck({tooltip:this.model.value}):this.addCheck({empty:!0}),this.model.resizeGaps&&this.adjustGapSize(!0),this.input.attr("disabled",!0),this.updateState()},showNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},tryAgain:function(){this.node.find(".check").remove(),this.updateFeedbackState(this.node),this.input.attr("disabled",this.isLocked()),this.input.val(this.model.value),this.model.value.trim()||this.node.removeClass("filled"),this.updateState()},adjustGapSizeToLongestResponse:function(responses){var response=this.getLongestResponse(responses);if(this.originalInput={answer:response.answer,width:response.width},/[\s;]*width:/gi.test(this.model.inputStyle))return void _.extend(this.originalInput,{width:this.input.width()});var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)},adjustGapSizeToLongestCorrect:function(responses){var response=this.getLongestResponse(responses);if(this.originalInput={answer:response.answer,width:response.width},/[\s;]*width:/gi.test(this.model.inputStyle))return void _.extend(this.originalInput,{width:this.input.width()});var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)},adjustGapSize:function(force){var width=this.input.textWidth(),lastWidth=this.input.width();(force||width>lastWidth)&&this.input.width(width)},adjustGapSizeToOriginal:function(){if(this.originalInput){var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)}},getLongestResponse:function(responses){var maxAnswer,maxWidth=0;return _.each(responses,function(response){var width=this._inputWidthWithText(response);width>maxWidth&&(maxWidth=width,maxAnswer=response)},this),{answer:maxAnswer,width:maxWidth}},_inputWidthWithText:function(text){return this.model.charactersNumber&&!text&&(text=this.TEXT_PLACEHOLDER),this.input.textWidth(text)},_getMaxWidthFor:function(response){if(/[\s;]*width:/gi.test(this.model.inputStyle))return response.width;var width=response.width;if(this.model.charactersNumber)if(0===response.width)width=this.input.textWidth(this.TEXT_PLACEHOLDER);else{var placeholderText=(this.input.val(),response.answer.replace(/\S/g,this.TEXT_PLACEHOLDER));width=_.max([width,this.input.textWidth(placeholderText)])}return width}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGapLabelAnObject"),a5.view.interaction.IMWordsearch={DEFAULT_TEMPLATE:'<div class="wordsearch_view"><div class="grid"></div><canvas></canvas></div>',init:function(model,parent,uppercase){this._super(model,parent,$(this.DEFAULT_TEMPLATE)),this.uppercase=uppercase,this.deleteEnabled=!1,this.currentLine=!1,this.cellSize=0,this.interaction=this.model.parent,this.cell_views=[],this.canvas=this.node.find("canvas"),this.$grid=this.node.find(".grid"),_.each(this.model.cells,function(cell){var view=new a5.view.interaction.IMWordsearchCell(cell,this);this.cell_views.push(view)},this),this.model.bind("state_update",this.updateState,this),this.model.bind("show-next",this.onShowNext,this),_.bindAll(this,"onFontChange"),this.interaction.bind("reset",this.onReset,this),a5.hooks.interactionFontUpdated.add(this.onFontChange),this.updateState()},render:function(){return _.each(this.cell_views,function(view){this.$grid.append(view.node),view.render()},this),this.adjustSize(),this.node},adjustSize:function(){_.each(this.cell_views,function(view,index){view.adjustPosition(),0===index&&(this.cellSize=view.width)},this),this.node.css({width:this.model.width*this.cellSize,height:this.model.height*this.cellSize}),this.canvas.attr("height",this.node.height()),this.canvas.attr("width",this.node.width()),this.redrawCanvas()},enableDelete:function(){this.deleteEnabled=!0,this.currentLine=!1,this.updateState()},disableDelete:function(){this.deleteEnabled=!1,this.highlighted=!1,this.updateState()},onShowNext:function(word){this.updateState();var element=this.model.getCell(word.start).views()[0].node;a5.utils.scrollIntoElementIfNeeded(element)},onFontChange:function(){this.interaction.visible||(this.interaction.disableVisibility(),this.interaction.contentWrap.show()),this.adjustSize(),this.interaction.visible||(this.interaction.contentWrap.hide(),this.interaction.enableVisibility())},onReset:function(){a5.hooks.interactionFontUpdated.remove(this.onFontChange),this.interaction.unbind("reset",this.onReset)},updateState:function(){this.updateFeedbackState(this.node);var self=this;this.node.unbind(),this.deleteEnabled?this.node.addClass("erase"):this.node.removeClass("erase"),"input"==this.model.state&&(this.deleteEnabled?(this.node.click(function(e){var offset=self.node.offset(),position=self.toGridCoordinates(new Vec2(e.pageX-offset.left,e.pageY-offset.top));self.model.removeMarkingsAt(position),self.redrawCanvas()}),this.node.mousemove(function(e){var offset=self.node.offset(),position=self.toGridCoordinates(new Vec2(e.pageX-offset.left,e.pageY-offset.top));self.highlighted=self.model.getMarkingsAt(position),self.redrawCanvas()}),this.node.on("touchstart",function(e){e.preventDefault();var pageX=e.originalEvent.touches[0].pageX,pageY=e.originalEvent.touches[0].pageY,offset=self.node.offset(),position=self.toGridCoordinates(new Vec2(pageX-offset.left,pageY-offset.top));self.model.removeMarkingsAt(position),self.highlighted=self.model.getMarkingsAt(position),self.redrawCanvas()}),this.node.on("touchmove",function(e){e.preventDefault();var offset=self.node.offset(),pageX=e.originalEvent.touches[0].pageX,pageY=e.originalEvent.touches[0].pageY,position=self.toGridCoordinates(new Vec2(pageX-offset.left,pageY-offset.top));self.highlighted=self.model.getMarkingsAt(position),self.redrawCanvas()})):(this.node.click(function(e){var offset=self.node.offset();if(self.currentLine)self.isLineValid(self.currentLine)&&self.model.addMarking(self.currentLine),self.currentLine=!1;else{var position=self.toGridCoordinates(new Vec2(e.pageX-offset.left,e.pageY-offset.top));self.currentLine=[position,position]}self.redrawCanvas()}),this.node.mousemove(function(e){if(self.currentLine){var offset=self.node.offset();self.currentLine[1]=self.toGridCoordinates(new Vec2(e.pageX-offset.left,e.pageY-offset.top)),self.redrawCanvas()}}),this.node.on("touchstart",function(e){e.preventDefault();var offset=self.node.offset();if(e.originalEvent.touches[0]){var pageX=e.originalEvent.touches[0].pageX,pageY=e.originalEvent.touches[0].pageY;if(self.currentLine)self.isLineValid(self.currentLine)&&self.model.addMarking(self.currentLine),self.currentLine=!1;else{var position=self.toGridCoordinates(new Vec2(pageX-offset.left,pageY-offset.top));self.currentLine=[position,position]}self.redrawCanvas()}}),this.node.on("touchend",function(e){e.preventDefault(),self.currentLine&&(self.isLineValid(self.currentLine)&&self.model.addMarking(self.currentLine),self.currentLine=!1),self.redrawCanvas()}),this.node.on("touchmove",function(e){if(e.preventDefault(),e.originalEvent.touches[0]){var pageX=e.originalEvent.touches[0].pageX,pageY=e.originalEvent.touches[0].pageY;if(self.currentLine){var offset=self.node.offset(),pos=self.toGridCoordinates(new Vec2(pageX-offset.left,pageY-offset.top));pos.x<0&&(pos.x=0),pos.y<0&&(pos.y=0),pos.x>=self.model.width&&(pos.x=self.model.width-1),pos.y>=self.model.height&&(pos.y=self.model.height-1),self.currentLine[1]=pos,self.redrawCanvas()}}}))),self.redrawCanvas()},updateFeedbackState:function(){this.$(".cell").removeClass("checked-empty checked-incorrect checked-correct"),this.$(".cell").removeClass("solution-empty solution-incorrect solution-correct"),this.$(".cell .check").remove();var type;if("feedback"==this.model.state)type="checked";else{if("answers"!=this.model.state)return;type="solution"}_.each(this.model.markings,function(marking){var classname=[type,marking.isCorrect()?"correct":"incorrect"].join("-"),direction=this.getDirection(marking);if(a5.dp.config.wordsearchCheckmarks&&!marking.isCorrect()){var cell=2===a5.dp.config.wordsearchCheckmarks?marking.end:marking.start,check=this.addCheck({parent:this.model.getCell(cell).views()[0].node});this.addCheckDirectionClasses(check,direction)}for(var i=marking.start;this.model.getCell(i).views()[0].node.addClass(classname),!i.equals(marking.end);i=i.addV(direction));},this),_.each(this.model.words,function(word){var classname=[type,word.isCorrect()?"correct":"empty"].join("-"),direction=this.getDirection(word);if(a5.dp.config.wordsearchCheckmarks&&(word.isCorrect()||"answers"===this.model.state)){var cell=2===a5.dp.config.wordsearchCheckmarks?word.end:word.start,check=this.addCheck({parent:this.model.getCell(cell).views()[0].node,correct:word.isCorrect(),empty:!word.isCorrect()});this.addCheckDirectionClasses(check,direction)}for(var i=word.start;this.model.getCell(i).views()[0].node.addClass(classname),!i.equals(word.end);i=i.addV(direction));},this)},addCheckDirectionClasses:function(node,direction){var classname="direction";1===direction.x?classname+="-right":-1===direction.x&&(classname+="-left"),1===direction.y?classname+="-bottom":-1===direction.y&&(classname+="-top"),node.addClass(classname)},getDirection:function(word){return new Vec2(Math.sign(word.end.x-word.start.x),Math.sign(word.end.y-word.start.y))},toGridCoordinates:function(position){return new Vec2(Math.floor(position.x/this.cellSize),Math.floor(position.y/this.cellSize))},toScreenCoordinates:function(position){return new Vec2((position.x+.5)*this.cellSize,(position.y+.5)*this.cellSize)},toScreenLine:function(line){return[this.toScreenCoordinates(line[0]),this.toScreenCoordinates(line[1])]},isLineValid:function(line){var diff=line[0].subV(line[1]).abs(),directionIsValid=0==diff.x||0==diff.y||diff.x==diff.y,notAlreadyMarked=_.every(this.model.markings,function(marking){return!(marking.start.equals(line[0])&&marking.end.equals(line[1])||marking.start.equals(line[1])&&marking.end.equals(line[0]))});return directionIsValid&&notAlreadyMarked},redrawCanvas:function(){var self=this,ctx=this.canvas[0].getContext("2d");ctx.clearRect(0,0,this.canvas[0].width,this.canvas[0].height);var c1=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","color1","color"),c2=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","color2","color"),wa=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","wrong-answer","color"),ca=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","correct-answer","color");this.currentLine&&this.isLineValid(this.currentLine)&&this.drawMarker(ctx,this.toScreenLine(this.currentLine),!0,self.cellSize/2-1,2,c1),_.each(this.model.markings,function(marker){"input"==self.model.state?self.highlighted&&_.any(self.highlighted,function(w){return w.matches(marker)})?self.drawMarker(ctx,self.toScreenLine(marker.asList()),!1,self.cellSize/2-1,2,c2):self.drawMarker(ctx,self.toScreenLine(marker.asList()),!1,self.cellSize/2-1,2,c1):"feedback"==self.model.state?self.drawMarker(ctx,self.toScreenLine(marker.asList()),!1,self.cellSize/2-1,2,marker.isCorrect()?ca:wa):"answers"==self.model.state&&self.drawMarker(ctx,self.toScreenLine(marker.asList()),!1,self.cellSize/2-1,2,marker.isCorrect()?ca:wa)}),"answers"==self.model.state?_.each(this.model.words,function(word){word.isCorrect()||self.drawMarker(ctx,self.toScreenLine(word.asList()),!1,self.cellSize/2-1,2,c1)}):_.each(this.model.words,function(word){"answers"==word.state&&self.drawMarker(ctx,self.toScreenLine(word.asList()),!1,self.cellSize/2-1,2,c1)})},drawMarker:function(ctx,list,circles,radius,width,color){var diff=list[1].subV(list[0]),ortho=new Vec2(-diff.y,diff.x);ortho.normalize(),ortho=ortho.mulS(radius),ctx.beginPath(),ctx.strokeStyle=color,ctx.lineWidth=width,circles||list[0].equals(list[1])?(this.drawCircle(ctx,list[0],radius),this.drawCircle(ctx,list[1],radius)):(this.drawArc(ctx,list[0],radius,ortho),this.drawArc(ctx,list[1],radius,ortho.mulS(-1))),this.drawLines(ctx,list,ortho),ctx.stroke()},drawArc:function(ctx,pos,radius,ortho){var startPos=pos.addV(ortho),angle=ortho.angle();ctx.moveTo(startPos.x,startPos.y),ctx.arc(pos.x,pos.y,radius,angle,angle+Math.PI,!1)},drawCircle:function(ctx,pos,radius){ctx.moveTo(pos.x+radius,pos.y),ctx.arc(pos.x,pos.y,radius,0,2*Math.PI,!1)},drawLines:function(ctx,list,translation,width,color){var start=list[0],end=list[1],translation2=translation.mulS(-1);this.drawLine(ctx,start.addV(translation),end.addV(translation)),this.drawLine(ctx,start.addV(translation2),end.addV(translation2))},drawLine:function(ctx,p1,p2){ctx.moveTo(p1.x,p1.y),ctx.lineTo(p2.x,p2.y)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMWordsearch"),a5.view.interaction.IMWordsearchCell={DEFAULT_TEMPLATE:'<div class="cell"></div>',init:function(model,parent){this._super(model,parent,$(this.DEFAULT_TEMPLATE)),this.width=0},render:function(){this.model.prefilled&&this.node.addClass("prefilled");var letter=this.model.letter;return this.parent.uppercase&&(letter=this.model.letter.toUpperCase()),this.node.append(letter),this.adjustPosition(),this.node},adjustPosition:function(){var size=a5.dp.config.wordsearchCellSize;size&&this.node.css({width:size,height:size}),this.width=this.node.width(),this.node.css({left:this.width*this.model.position.x,top:this.width*this.model.position.y})}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMWordsearchCell"),a5.views.interaction.LLView={SCROLL_SENSITIVITY:10,SCROLL_SPEED:20,NODE_HTML:'<div class="ll_view"></div>',ERASER_TEMPLATE:'<span title="Eraser">Erase</span>',init:function(model,parent){this._super(model,parent,$(this.NODE_HTML).addClass(model.displayInRows?"rows":"columns").addClass(model.behaviourIsTouch?"touch":"drag")),this.interaction=model.parent,this.modelViewMapping=[],this.children=[],this.interaction.options.eraserIsOn()&&this.createEraser(),this.getLinkConfig(),this.appendTable(),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("input_update:setAnswer",this.onSetAnswerInput,this),this.model.bind("show_next",this.repaintCanvas,this),this.interaction.bind("hide",this.onInteractionHide,this),this.interaction.bind("show",this.onInteractionShow,this),a5.dp.config.linkingLinesContainedEvents&&(this.dragContainer=this.interaction.$(".interaction")),this.inputHandler=this.model.behaviourIsTouch?new a5.views.LinkingLinesTouchHandler(this.node,".ll_element_view:not(.checked-correct-locked)"):new a5.views.LinkingLinesDragHandler(this.node,".ll_element_view:not(.checked-correct-locked)",this.dragContainer),this.inputHandler.bind("erase",this.onErase,this),this.inputHandler.bind("start",this.onStart,this),this.inputHandler.bind("linking",this.onLinking,this),this.inputHandler.bind("finish",this.onFinish,this)},onSetAnswerInput:function(){_.invoke(this.children,"setAnswerInput")},onInteractionHide:function(){this.inputHandler.unbindEvents(),$("body").removeClass("erasing")},onInteractionShow:function(){this.updateInputHandlerState(),this.getLinkConfig(),$("body").toggleClass("erasing",this.inputHandler.isErasing())},onStateUpdate:function(){this.render(),a5.mainBuilder.curInteraction===this.model.parent&&this.updateInputHandlerState()},setAnswer:function(){this.eraserButton&&this.eraserButton.setPressed(!1)},updateInputHandlerState:function(){"input"===this.model.state?(this.node.find(".check").remove(),this.inputHandler.bindEvents()):this.inputHandler.unbindEvents()},render:function(){return this._super(),this.repaintCanvas(),this.node},getLinkConfig:function(){this.prefillColor=a5.dp.config.linkingLinesPrefillColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","prefill-answer","background-color"),this.prefillStyle=a5.dp.config.linkingLinesPrefillStyle,this.answersWrongColor=a5.dp.config.linkingLinesAnswersWrongColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","wrong-answer","background-color"),this.answersWrongStyle=a5.dp.config.linkingLinesAnswersWrongStyle,this.answersCorrectColor=a5.dp.config.linkingLinesAnswersCorrectColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","correct-answer","background-color"),this.answersCorrectStyle=a5.dp.config.linkingLinesAnswersCorrectStyle,this.feedbackWrongColor=a5.dp.config.linkingLinesFeedbackWrongColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","wrong-answer","background-color"),this.feedbackWrongStyle=a5.dp.config.linkingLinesFeedbackWrongStyle,this.feedbackCorrectColor=a5.dp.config.linkingLinesFeedbackCorrectColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","correct-answer","background-color"),this.feedbackCorrectStyle=a5.dp.config.linkingLinesFeedbackCorrectStyle,this.defaultColor=a5.dp.config.linkingLinesDefaultColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","fill-color","background-color"),this.unattemptedColor=a5.dp.config.linkingLinesUnattemptedColor||this.answersCorrectColor,this.unattemptedStyle=a5.dp.config.linkingLinesUnattemptedStyle,this.lineWidth=a5.dp.config.linkingLinesLineWidth||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","line-width","max-width"),this.lineWidth=parseInt(this.lineWidth,10),_.isNaN(this.lineWidth)&&(this.lineWidth=4)},appendTable:function(){this.model.displayInRows?this.appendRowsTable():this.appendColumnsTable()},appendColumnsTable:function(){var $row,ccnt,$table=$("<table></table>");this.node.append($table);for(var rows=this.model.elements.length/this.model.sets,cnt=0;cnt<rows;cnt++)for($row=$('<tr class="element-row"></tr>'),$table.append($row),ccnt=0;ccnt<this.model.sets;ccnt++){this.model.enumSets[ccnt]&&this.model.enumSets[ccnt][cnt]&&ccnt<this.model.sets-1&&($row.append('<td class="ll-enum ll-enum-set-'+(ccnt+1)+'"><span class="enum-placeholder"></span></td>'),this.model.enumSets[ccnt][cnt].then(function(enumSymbol){$row.find(".enum-placeholder").replaceWith(enumSymbol)}));var $td=$('<td class="element"></td>');$row.append($td);var model=this.model.elements[(a5.dp.config.linkingLinesTouchDirection[0]?this.model.sets-ccnt-1:ccnt)*rows+cnt],view=this.createElementView(model);this.children.push(view),$td.append(view.render()),this.modelViewMapping[model.id]=view,this.model.enumSets[ccnt]&&this.model.enumSets[ccnt][cnt]&&ccnt==this.model.sets-1&&($row.append('<td class="ll-enum ll-enum-set-'+(ccnt+1)+'"><span class="enum-placeholder"></span></td>'),this.model.enumSets[ccnt][cnt].then(function(enumSymbol){$row.find(".enum-placeholder").replaceWith(enumSymbol)}))}if(!_.isEmpty(this.model.headings))for($row=$('<tr class="element-row"></tr>'),$table.prepend($row),ccnt=0;ccnt<this.model.sets;ccnt++){this.model.enumSets[ccnt]&&this.model.enumSets[ccnt].length>0&&ccnt<this.model.sets-1&&$row.append("<th></th>");var $th=$('<th class="element-heading"></th>');$th.html(this.model.headings[ccnt]),$row.append($th)}},appendRowsTable:function(){var $row,rowIt,colIt,$table=$("<table></table>");this.node.append($table);var columns=this.model.elements.length/this.model.sets;for(rowIt=0;rowIt<this.model.sets;rowIt++){if(this.model.enumSets[rowIt]&&this.model.enumSets[rowIt][0]&&rowIt<this.model.sets-1){for($row=$("<tr></tr>").appendTo($table),colIt=0;colIt<columns;colIt++)$row.append('<td class="ll-enum ll-enum-set-'+(rowIt+1)+'"><span class="enum-placeholder"></span></td>'),this.model.enumSets[rowIt][colIt].then(function(enumSymbol){$row.find(".enum-placeholder").replaceWith(enumSymbol)});_.isEmpty(this.model.headings)||$row.prepend("<th></th>")}for($row=$('<tr class="element-row"></tr>').appendTo($table),colIt=0;colIt<columns;colIt++){var $td=$('<td class="element"></td>');$row.append($td);var model=this.model.elements[(a5.dp.config.linkingLinesTouchDirection[1]?this.model.sets-rowIt-1:rowIt)*columns+colIt],view=this.createElementView(model);this.children.push(view),$td.append(view.render()),this.modelViewMapping[model.id]=view}if(!_.isEmpty(this.model.headings)){var $th=$('<th class="element-heading"></th>');$th.html(this.model.headings[rowIt]),$row.prepend($th)}if(this.model.enumSets[rowIt]&&this.model.enumSets[rowIt][0]&&rowIt==this.model.sets-1){for($row=$("<tr></tr>").appendTo($table),colIt=0;colIt<columns;colIt++)$row.append('<td class="ll-enum ll-enum-set-'+(rowIt+1)+'"><span class="enum-placeholder"></span></td>'),this.model.enumSets[rowIt][colIt].then(function(enumSymbol){$row.find(".enum-placeholder").replaceWith(enumSymbol)});_.isEmpty(this.model.headings)||$row.prepend("<th></th>")}}},createElementView:function(model,parent){return new a5.views.interaction.LLElementView(model,this)},createEraser:function(){a5.service.templates.enableOnlyCachedMode();var template=a5.service.templates.render("a5.view.toolbar.erase")||this.ERASER_TEMPLATE;a5.service.templates.disableOnlyCachedMode(),this.eraserButton=this.interaction.toolbar.addToggleButton({label:$(template).text()||"Erase",title:$(template).attr("title"),classes:["erase"],on:_.bind(function(){$("body").addClass("erasing"),this.inputHandler.setErasing(!0)},this),off:_.bind(function(){$("body").removeClass("erasing"),this.inputHandler.setErasing(!1)},this)})},onErase:function(pos,node){var element=$(node).data("mvc-view");this.clear(element.model,element.isEnd(pos))},onStart:function(pos,node){var element=$(node).data("mvc-view"),isEnd=element.isEnd(pos);element.node.find(isEnd?".right_handle, .bottom_handle":".left_handle, .top_handle").addClass("handle-hover"),element.model.prefilled||this.start(element.model,element.getLineEndpoint(isEnd))},onLinking:function(pos,$container){if(!this.model.behaviourIsTouch||!a5.dp.config.drawRectLinkLines){var tl=this.node.offset();tl.left=pos.pageX-tl.left,tl.top=pos.pageY-tl.top,this.current(tl)}this.startModel&&(this.dragContainer&&this.dragContainer.length>0?this.dragContainer.trigger("linking-lines-dragging",[pos.pageX,pos.pageY,this.SCROLL_SENSITIVITY,this.SCROLL_SPEED]):this.updateScrollY(pos.pageY,this.SCROLL_SENSITIVITY,this.SCROLL_SPEED))},onFinish:function(pos,node,$container){var element=$(node).data("mvc-view");this.end(element&&element.model),this.repaintCanvas(),this.$(".handle-hover").removeClass("handle-hover"),this.dragContainer&&this.dragContainer.length>0&&this.dragContainer.trigger("linking-lines-dragged",[pos.pageX,pos.pageY,this.SCROLL_SENSITIVITY,this.SCROLL_SPEED])},updateScrollY:function(y,scrollSensitivity,scrollSpeed){var scrollParent=this.node.scrollParent();scrollParent[0]===document?y-$(document).scrollTop()<scrollSensitivity+a5.dp.config.exclusionTop?$(document).scrollTop($(document).scrollTop()-scrollSpeed):$(window).height()-(y-$(document).scrollTop())<scrollSensitivity+a5.dp.config.exclusionBottom&&$(document).scrollTop($(document).scrollTop()+scrollSpeed):y-scrollParent.offset().top<scrollSensitivity?scrollParent.scrollTop(scrollParent.scrollTop()-scrollSpeed):scrollParent.offset().top+scrollParent.outerHeight()-y<scrollSensitivity&&scrollParent.scrollTop(scrollParent.scrollTop()+scrollSpeed)},bindEvents:function(){$("body").on("mousemove",this.onMouseMove),$("body").on("mouseup",this.onMouseUp),this.node[0].addEventListener("touchmove",this.onTouchMove),this.node[0].addEventListener("touchend",this.onTouchEnd)},unbindEvents:function(){$("body").off("mousemove",this.onMouseMove),$("body").off("mouseup",this.onMouseUp),this.node.parents(".content-wrap").off("touchmove"),this.node[0].removeEventListener("touchmove",this.onTouchMove),this.node[0].removeEventListener("touchend",this.onTouchEnd)},createCanvas:function(){this.canvas?this.canvas.$.remove():$(window).on("resize",_.throttle(this.resizeCanvas.bindTo(this),500));var w=this.node.width(),h=this.node.height();document.createElement("canvas");this.canvas=this.model.behaviourIsTouch?new a5.views.interaction.LLTouchCanvas(w,h,this.model.displayInRows):new a5.views.interaction.LLCanvas(w,h,this.model.displayInRows),this.node.prepend(this.canvas.render()),this.node.find("img").on("load",function(){this.resizeCanvas()}.bindTo(this)),this.repaintCanvas()},resizeCanvas:function(){this.node.find("canvas, svg").attr({width:this.node.width(),height:this.node.height()}),this.repaintCanvas()},clear:function(element,isEnd){var reverse=a5.dp.config.linkingLinesTouchDirection[this.model.displayInRows?1:0];this.model.clear(element,reverse?!isEnd:isEnd),this.repaintCanvas()},removeLinkClasses:function(m1,m2){var v1=this.modelViewMapping[m1.id],v2=this.modelViewMapping[m2.id];v1.$(".right_handle, .bottom_handle").removeClass(function(){return _.filter($(this).attr("class").split(/\s+/),function(c){return"linked"==c||0===c.indexOf("color")}).join(" ")}),v2.$(".left_handle, .top_handle").removeClass(function(){return _.filter($(this).attr("class").split(/\s+/),function(c){return"linked"==c||0===c.indexOf("color")}).join(" ")})},start:function(model,position){this.startModel=model,this.startPosition=position,this.currentPosition=position,this.repaintCanvas()},end:function(model){this.model.behaviourIsTouch?this.createTouchLine(this.startModel,model):this.model.addLine(this.startModel,model)&&(this.modelViewMapping[this.startModel.id].$(".handle").addClass("linked"),this.modelViewMapping[model.id].$(".handle").addClass("linked")),this.startModel=null},createTouchLine:function(from,to){var line=[];if(this.model.lineIsValid([from,to],line)){var i,color,self=this,v1=this.modelViewMapping[line[0].id],v2=this.modelViewMapping[line[1].id],isEnd=!a5.dp.config.linkingLinesTouchDirection[this.model.displayInRows?1:0],p1=v1.getLineEndpoint(isEnd),p2=v2.getLineEndpoint(!isEnd);i=this.model.displayInRows?(a5.dp.config.linkingLinesTouchDirection[1]?v2:v1).node.closest("td").index():(a5.dp.config.linkingLinesTouchDirection[0]?v2:v1).node.closest("tr").index(),color=(a5.dp.config.linkingLinesColors||[])[i]||this.defaultColor,this.model.filterLines(line[0],line[1]),this.canvas.animateLine(p1,p2,i+1,color,"white",this.lineWidth,Date.now(),_.bind(this.repaintCanvas,this),function(){self.model.addLine(from,to),v1.$(".right_handle, .bottom_handle").addClass("linked color"+(i+1)),v2.$(".left_handle, .top_handle").addClass("linked color"+(i+1))})}},current:function(position){this.currentPosition=position,this.repaintCanvas()},repaintCanvas:function(){this.canvas&&(this.canvas.clear(),this.$(".handle").removeClass("linked"),_.each(this.model.prefilledLines,function(line){this.drawLine(line,this.prefillColor,"white",this.lineWidth,this.prefillStyle)},this),this.drawNextAnswer(),"feedback"==this.model.state?this.drawFeedbackLines():"answers"==this.model.state?this.drawAnswersLines():this.drawInputLines(),this.startModel&&"a5.views.interaction.LLView"==this._class_name&&this.canvas.drawLine(this.startPosition,this.currentPosition,this.defaultColor,"white",this.lineWidth))},drawFeedbackLines:function(){_.each(this.model.lines,function(line){line[0].isCorrect()?this.drawLine(line,this.feedbackCorrectColor,"white",this.lineWidth,this.feedbackCorrectStyle):this.drawLine(line,this.feedbackWrongColor,"white",this.lineWidth,this.feedbackWrongStyle)},this)},drawAnswersLines:function(){_.each(this.model.correctModels(),function(line){line[0].isCorrect()?this.drawLine(line,this.answersCorrectColor,"white",this.lineWidth,this.answersCorrectStyle):this.drawLine(line,this.unattemptedColor,"white",this.lineWidth,this.unattemptedStyle)},this),_.each(this.model.getWrongAsLines(),function(line){this.drawLine(line,this.answersWrongColor,"white",this.lineWidth,this.answersWrongStyle)
},this)},drawNextAnswer:function(){_.each(this.model.prevAnswers,function(line){this.drawLine(line,this.defaultColor,"white",this.lineWidth)},this)},drawInputLines:function(){_.each(this.model.lines,function(line){this.model.tryAgainIsFrozen&&line.checked?this.drawLine(line,this.feedbackCorrectColor,"white",this.lineWidth,this.feedbackCorrectStyle):this.drawLine(line,this.defaultColor,"white",this.lineWidth)},this)},drawLine:function(line,color,sColor,lineWidth,lineStyle){var m1=this.modelViewMapping[line[0].id],m2=this.modelViewMapping[line[1].id],isEnd=!a5.dp.config.linkingLinesTouchDirection[this.model.displayInRows?1:0],p1=m1.getLineEndpoint(isEnd),p2=m2.getLineEndpoint(!isEnd);if(this.model.behaviourIsTouch){var i;i=this.model.displayInRows?(a5.dp.config.linkingLinesTouchDirection[1]?m2:m1).node.closest("td").index():(a5.dp.config.linkingLinesTouchDirection[0]?m2:m1).node.closest("tr").index(),this.removeLinkClasses(line[0],line[1]),m1.$(".handle").addClass("linked color"+(i+1)),m2.$(".handle").addClass("linked color"+(i+1)),color=(a5.dp.config.linkingLinesColors||[])[i]||color}else m1.$(".handle").addClass("linked"),m2.$(".handle").addClass("linked");this.canvas.drawLine(p1,p2,color,sColor,lineWidth,lineStyle)}},a5.views.interaction.BaseView.extend("a5.views.interaction.LLView"),a5.views.interaction.LLElementView={NODE_HTML:'<div class="ll_element_view"></div>',TOP_HANDLE_HTML:'<div class="handle top_handle"></div>',LEFT_HANDLE_HTML:'<div class="handle left_handle"></div>',BOTTOM_HANDLE_HTML:'<div class="handle bottom_handle"></div>',RIGHT_HANDLE_HTML:'<div class="handle right_handle"></div>',SELECTION_AREA_HTML:'<span class="selection_area"></span>',init:function(model,parent){this._super(model,parent,$(this.NODE_HTML)),this.node.addClass(this.getClassName()),-1!==this.model.position&&this.node.append(this.getBeginningHandle()),1!==this.model.position&&this.node.append(this.getEndHandle()),this.model.prefilled&&(this.node.addClass("prefill"),this.$(".handle").addClass("linked")),this.model.content&&this.node.append(this.model.content),this.model.tts_audio&&this.addTTSPlayer(),a5.dp.config.linkingSelectionAreaEnabled&&("right"===this.getClassName()?this.node.find(".content").prepend(this.SELECTION_AREA_HTML):this.node.find(".content").append(this.SELECTION_AREA_HTML))},addTTSPlayer:function(){this.tts_player=new a5.views.TTS_Player($(this.model.content).text()),$(this.node).prepend(this.tts_player.render())},getClassName:function(position){switch(this.model.position){case-1:return this.model.parent.displayInRows?"top":"left";case 1:return this.model.parent.displayInRows?"bottom":"right";default:return"center"}},getBeginningHandle:function(){return this.model.parent.displayInRows?this.TOP_HANDLE_HTML:this.LEFT_HANDLE_HTML},getEndHandle:function(){return this.model.parent.displayInRows?this.BOTTOM_HANDLE_HTML:this.RIGHT_HANDLE_HTML},isEnd:function(pos){return-1===this.model.position||1!==this.model.position&&(this.model.parent.displayInRows?pos.pageY>this.node.offset().top+this.node.outerHeight()/2:pos.pageX>this.node.offset().left+this.node.outerWidth()/2)},getLineEndpoint:function(isEnd){var rh=this.node.find(isEnd?".right_handle, .bottom_handle":".left_handle, .top_handle");rh.length||(rh=this.node.find(".handle"));var p=rh.offset(),tl=this.parent.node.offset();return p.left-=tl.left-rh.outerWidth()/2,p.top-=tl.top-rh.outerHeight()/2,p},setAnswer:function(){var setCheck=!this.model.prefilled&&this.model.isFilled();this.setAnswerCheck(setCheck)},setAnswerInput:function(){var setCheck=!this.model.prefilled&&this.model.isFilled();this.setAnswerCheck(setCheck)},addCheck:function(params){if(a5.dp.config.linkingSelectionAreaEnabled){this.node.find(".check").remove();var area=this.node.find(".selection_area");this.model.isFilled()&&area.addClass("selected"),area.removeClass("correct wrong"),area.addClass(this.model.isCorrect()?"correct":"wrong"),params.parent=area}this._super(params)},setAnswerCheck:function(check){this.node.find(".check").remove(),check&&(this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})),this.setFeedbackState()},showAnswer:function(){this.node.find(".check").remove();var self=this;this.model.prefilled||(this.model.isCorrect()?(this.addCheck({correct:!0,tooltip:this.model.getAnswerFeedback()}),this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})):(this.addCheck({empty:!this.model.isFilled(),over:function(e){self.model.parent.setWrongHighlighted(self.model)},out:function(e){self.model.parent.setWrongHighlighted(null)},tooltip:this.model.getAnswerFeedback()}),this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))),this.setFeedbackState()},removeAnswer:function(){this.node.find(".check").remove(),this.setFeedbackState()},setFeedbackState:function(){this.updateFeedbackState(this.node.find(".handle").addBack())}},a5.views.interaction.BaseView.extend("a5.views.interaction.LLElementView"),Obj.extend("a5.views.interaction.LLCanvas",{init:function(w,h,displayInRows){this.$=$('<canvas width="'+w+'" height="'+h+'"></canvas>'),this.displayInRows=displayInRows},clear:function(){this.$[0].getContext("2d").clearRect(0,0,this.$[0].width,this.$[0].height)},drawLine:function(p1,p2,color,sColor,lineWidth,lineStyle){var delta,co=this.$[0].getContext("2d");co.shadowBlur=3,co.shadowColor=sColor,co.lineWidth=lineWidth,co.lineJoin="round",co.strokeStyle=color,co.beginPath(),co.setLineDash(this.getLineDash(lineStyle,lineWidth)),co.moveTo(p1.left,p1.top),this.displayInRows?(delta=(p2.top-p1.top)/2,co.bezierCurveTo(p1.left,p1.top+delta,p2.left,p2.top-delta,p2.left,p2.top)):(delta=(p2.left-p1.left)/2,co.bezierCurveTo(p1.left+delta,p1.top,p2.left-delta,p2.top,p2.left,p2.top)),co.stroke()},getLineDash:function(style,lineWidth){var dash=[];return"dotted"===style?dash=[lineWidth,lineWidth]:"dashed"===style&&(dash=[3*lineWidth,lineWidth]),dash},render:function(){return this.$}}),a5.views.interaction.LLTouchCanvas={CONNECTOR_HTML:'<div class="connector">',getIntermediatePosition:function(x1,x2){var gap,p1,p2;if(this.displayInRows){x1.top>x2.top?(p1=x2,p2=x1):(p1=x1,p2=x2),gap=p2.top-p1.top;var width=this.$.width(),center=width/2,adjustedLeft=p1.left+(center-p1.left)/2;return p1.top+gap*adjustedLeft/width}x1.left>x2.left?(p1=x2,p2=x1):(p1=x1,p2=x2),gap=p2.left-p1.left;var height=this.$.height(),middle=height/2,adjustedTop=p1.top+(middle-p1.top)/2;return p1.left+gap*adjustedTop/height},drawLine:function(p1,p2,color,sColor,lineWidth,lineStyle){a5.dp.config.drawRectLinkLines?this.drawRectLine(p1,p2,color,sColor,lineWidth,lineStyle):this._super(p1,p2,color,sColor,lineWidth,lineStyle)},drawRectLine:function(p1,p2,color,sColor,lineWidth,lineStyle){var co=this.$[0].getContext("2d");if(co.shadowBlur=3,co.shadowColor=sColor,co.lineWidth=lineWidth,co.lineJoin="round",co.strokeStyle=color,co.beginPath(),co.setLineDash(this.getLineDash(lineStyle,lineWidth)),this.displayInRows){var intermediateTop=this.getIntermediatePosition(p1,p2);co.moveTo(p1.left,p1.top),co.lineTo(p1.left,intermediateTop),co.lineTo(p2.left,intermediateTop),co.lineTo(p2.left,p2.top),co.stroke()}else{var intermediateLeft=this.getIntermediatePosition(p1,p2);co.moveTo(p1.left,p1.top),co.lineTo(intermediateLeft,p1.top),co.lineTo(intermediateLeft,p2.top),co.lineTo(p2.left,p2.top),co.stroke()}},animateLine:function(p1,p2,index,color,sColor,lineWidth,startTime,repaintCanvas,callback){var angle,time=Date.now()-startTime,length=Math.abs(p2.left-p1.left)+Math.abs(p2.top-p1.top),paintedDistance=length*time/a5.dp.config.linkingLinesTouchDuration,points=[],distance=0,finished=!1;if(this.displayInRows){angle=a5.dp.config.linkingLinesTouchDirection[1]?-90:90;var intermediateTop=this.getIntermediatePosition(p1,p2);Math.abs(p1.top-intermediateTop)>=paintedDistance?points.push([p1.left,-90===angle?p1.top-paintedDistance:p1.top+paintedDistance]):(points.push([p1.left,intermediateTop]),distance+=Math.abs(p1.top-intermediateTop),distance+Math.abs(p2.left-p1.left)>=paintedDistance?p2.left>p1.left?(points.push([p1.left+paintedDistance-distance,intermediateTop]),angle=0):(points.push([p1.left-paintedDistance+distance,intermediateTop]),angle=180):(points.push([p2.left,intermediateTop]),distance+=Math.abs(p2.left-p1.left),distance+Math.abs(intermediateTop-p2.top)>=paintedDistance?points.push([p2.left,-90===angle?intermediateTop-paintedDistance+distance:intermediateTop+paintedDistance-distance]):(points.push([p2.left,p2.top]),finished=!0)))}else{angle=a5.dp.config.linkingLinesTouchDirection[0]?180:0;var intermediateLeft=this.getIntermediatePosition(p1,p2);Math.abs(intermediateLeft-p1.left)>=paintedDistance?points.push([0===angle?p1.left+paintedDistance:p1.left-paintedDistance,p1.top]):(points.push([intermediateLeft,p1.top]),distance+=Math.abs(intermediateLeft-p1.left),distance+Math.abs(p2.top-p1.top)>=paintedDistance?p2.top>p1.top?(points.push([intermediateLeft,p1.top+paintedDistance-distance]),angle=90):(points.push([intermediateLeft,p1.top-paintedDistance+distance]),angle=-90):(points.push([intermediateLeft,p2.top]),distance+=Math.abs(p2.top-p1.top),distance+Math.abs(p2.left-intermediateLeft)>=paintedDistance?points.push([0===angle?intermediateLeft+paintedDistance-distance:intermediateLeft-paintedDistance+distance,p2.top]):(points.push([p2.left,p2.top]),finished=!0)))}if(finished)this.$.siblings(".connector").remove(),callback.call();else{repaintCanvas();var co=this.$[0].getContext("2d");co.shadowBlur=3,co.shadowColor=sColor,co.lineWidth=lineWidth,co.lineJoin="round",co.strokeStyle=color,co.beginPath(),co.moveTo(p1.left,p1.top),_.each(points,function(p){co.lineTo(p[0],p[1])}),co.stroke();var connector=this.$.siblings(".connector");connector.length||(connector=$(this.CONNECTOR_HTML).addClass("color"+index).appendTo(this.$.parent())),connector.css({position:"absolute",transform:"rotate("+angle+"deg)",left:_.last(points)[0]-connector.outerWidth()/2,top:_.last(points)[1]-connector.outerHeight()/2});var self=this;a5.utils.requestAnimationFrame(function(){self.animateLine(p1,p2,index,color,sColor,lineWidth,startTime,repaintCanvas,callback)})}}},a5.views.interaction.LLCanvas.extend("a5.views.interaction.LLTouchCanvas"),a5.views.interaction.LinkingMultipleLines={SCROLL_SENSITIVITY:10,SCROLL_SPEED:20,eraserRect:null,collidingLine:null,NODE_TEMPLATE:'<div class="ll_view multiple"></div>',ERASER_TEMPLATE:'<span title="Eraser">Erase</span>',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE).addClass(model.displayInRows?"display-in-rows":"display-in-columns").addClass(model.behaviourIsTouch?"touch":"drag")),this.interaction=model.parent,this.toolbarNode=this.interaction.toolbar.views()[0].node,this._renderEnumOnce=_.once(this.renderEnum,this),this.children=[],this.columns={},this.elements={},this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("state_update:feedback",this.setAnswer,this),this.interaction.options.eraserIsOn()&&this.createEraser(),this.getLinkConfig(),this.interaction.bind("hide",this.onInteractionHide,this),this.interaction.bind("show",this.onInteractionShow,this),this.inputHandler=this.model.behaviourIsTouch?new a5.views.LinkingLinesTouchHandler(this.node,".ll_element_view"):new a5.views.LinkingLinesDragHandler(this.node,".ll_element_view"),this.inputHandler.bind("erase",this.onErase,this),this.inputHandler.bind("start",this.onStart,this),this.inputHandler.bind("linking",this.onLinking,this),this.inputHandler.bind("finish",this.onFinish,this),this.startSide=this.model.displayInRows?"bottom":"right",this.endSide=this.model.displayInRows?"top":"left",this.tableKeyForSeeAnswers=new a5.views.interaction.LinkingMultipleLinesKeyTable,this.tableKeyForSeeAnswers.addEntry(this.lineWidth,this.prefillColor,this.prefillStyle,"prefill"),this.tableKeyForSeeAnswers.addEntry(this.lineWidth,this.answersCorrectColor,this.answersCorrectStyle,"correct"),this.tableKeyForSeeAnswers.addEntry(this.lineWidth,this.answersWrongColor,this.answersWrongStyle,"wrong"),this.tableKeyForSeeAnswers.addEntry(this.lineWidth,this.unattemptedColor,this.unattemptedStyle,"missing"),this.tableKeyForCheckAnswers=new a5.views.interaction.LinkingMultipleLinesKeyTable,this.tableKeyForCheckAnswers.addEntry(this.lineWidth,this.prefillColor,this.prefillStyle,"prefill"),this.tableKeyForCheckAnswers.addEntry(this.lineWidth,this.feedbackCorrectColor,this.feedbackCorrectStyle,"correct"),this.tableKeyForCheckAnswers.addEntry(this.lineWidth,this.feedbackWrongColor,this.feedbackWrongStyle,"wrong"),this.model.bind("next_answer",this.onNextAnswer,this),_.bindAll(this,"onMove")},_getColor:function(classname,type,attribute){var color=a5.utils.getCSSAttributeFromCSS(classname,type,attribute),default_color=a5.utils.getCSSAttributeFromCSS(".is-linking-multiple-lines","fill-color","background-color");return color==a5.utils.getCSSAttributeFromCSS(".is-linking-multiple-lines",null,"background-color",{background:"none"})&&(color=default_color),color},append:function(columnId,id,prefilled,content){var column=this.columns[columnId];column||(column=new a5.views.interaction.LinkingMultipleLinesColumn,this.columns[columnId]=column,this.children.push(column));var element=new a5.views.interaction.LinkingMultipleLinesElement(this.model,id,prefilled,content,this);column.children.push(element),this.elements[element.id]=element},prependEnumColumn:function(enumerator,rows){var $column=$('<div class="ll_enum_column"></div>');_(rows).times(function(){var $element=$('<div class="ll_element_view"><span class="enum-placeholder"></span></div>');enumerator.next().then(function(enumSymbol){$element.find(".enum-placeholder").replaceWith(enumSymbol)}),$column.append($element)},this),this.node.prepend($column)},prependEnumRow:function(enumerator,columns){this.node.find(".ll_column:first .ll_element_view").each(function(index,elem){$(elem).prepend('<span class="enum-placeholder"></span>'),enumerator.next().then(function(enumSymbol){$(elem).find(".enum-placeholder").replaceWith(enumSymbol)})})},renderEnum:function(){this.model.displayInRows?this.prependEnumRow(this.interaction.enumAnswers,this.model.answers.size()):this.prependEnumColumn(this.interaction.enumAnswers,this.model.answers.size())},render:function(){return this._super(),this.node.off(),this.node.on("mousemove touchmove",this.onMove),this.renderChildren(),this.interaction.options.enumerationAnswersIsFalse()||this._renderEnumOnce(),this.repaintCanvas(),this.renderKeyTable(),this.node},renderKeyTable:function(){this.toolbarNode.siblings(".llm-key-table").remove(),a5.utils.getHideLLMKeyTable()||("feedback"==this.model.state?this.toolbarNode.after(this.tableKeyForCheckAnswers.render()):"answers"===this.model.state&&this.toolbarNode.after(this.tableKeyForSeeAnswers.render()))},getLinkConfig:function(){this.prefillColor=a5.dp.config.linkingMultipleLinesPrefillColor||this._getColor(".is-linking-multiple-lines","prefill-answer","background-color"),this.prefillStyle=a5.dp.config.linkingMultipleLinesPrefillStyle,this.answersWrongColor=a5.dp.config.linkingMultipleLinesAnswersWrongColor||this._getColor(".is-linking-multiple-lines","wrong-answer","background-color"),this.answersWrongStyle=a5.dp.config.linkingMultipleLinesAnswersWrongStyle,this.answersCorrectColor=a5.dp.config.linkingMultipleLinesAnswersCorrectColor||this._getColor(".is-linking-multiple-lines","correct-answer","background-color"),this.answersCorrectStyle=a5.dp.config.linkingMultipleLinesAnswersCorrectStyle,this.feedbackWrongColor=a5.dp.config.linkingMultipleLinesFeedbackWrongColor||this._getColor(".is-linking-multiple-lines","wrong-answer","background-color"),this.feedbackWrongStyle=a5.dp.config.linkingMultipleLinesFeedbackWrongStyle,this.feedbackCorrectColor=a5.dp.config.linkingMultipleLinesFeedbackCorrectColor||this._getColor(".is-linking-multiple-lines","correct-answer","background-color"),this.feedbackCorrectStyle=a5.dp.config.linkingMultipleLinesFeedbackCorrectStyle,this.hoverColor=a5.dp.config.linkingMultipleLinesHoverColor||this._getColor(".is-linking-multiple-lines","hover-color","background-color"),this.seeNextAnswerColor=a5.dp.config.linkingMultipleLinesSeeNextAnswerColor||this._getColor(".is-linking-multiple-lines","next-answer","background-color")||this.hoverColor,this.seeNextAnswerStyle=this.seeNextAnswerStyle||a5.dp.config.linkingMultipleLinesSeeNextAnswerStyle||"dashed",this.defaultColor=a5.dp.config.linkingMultipleLinesDefaultColor||this._getColor(".is-linking-multiple-lines","fill-color","background-color"),this.unattemptedColor=a5.dp.config.linkingMultipleLinesUnattemptedColor||this.defaultColor,this.unattemptedStyle=a5.dp.config.linkingMultipleLinesUnattemptedStyle,this.lineWidth=a5.dp.config.linkingMultipleLinesLineWidth||a5.utils.getCSSAttributeFromCSS(".is-linking-multiple-lines","line-width","max-width"),this.lineWidth=parseInt(this.lineWidth,10),_.isNaN(this.lineWidth)&&(this.lineWidth=4)},onInteractionHide:function(){this.inputHandler.unbindEvents(),$("body").removeClass("erasing")},onInteractionShow:function(){this.updateInputHandlerState(),this.getLinkConfig(),$("body").toggleClass("erasing",this.inputHandler.isErasing())},onStateUpdate:function(){var handles=this.node.find(".handle"),nodes=handles.add(handles.parent());this.checkLocked(nodes),nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct"),this.renderKeyTable(),this.repaintCanvas(),a5.mainBuilder.curInteraction===this.model.parent&&this.updateInputHandlerState()},setAnswer:function(){this.eraserButton&&this.eraserButton.setPressed(!1)},updateInputHandlerState:function(){"input"===this.model.state?this.inputHandler.bindEvents():this.inputHandler.unbindEvents()},createEraser:function(){a5.service.templates.enableOnlyCachedMode();var template=a5.service.templates.render("a5.view.toolbar.erase")||this.ERASER_TEMPLATE;a5.service.templates.disableOnlyCachedMode(),this.eraserButton=this.interaction.toolbar.addToggleButton({label:$(template).text()||"Erase",title:$(template).attr("title"),classes:["erase"],on:_.bind(function(){this.eraserRect||this.createEraserRect(),$("body").addClass("erasing"),this.inputHandler.setErasing(!0)},this),off:_.bind(function(){this.eraserRect||this.createEraserRect(),$("body").removeClass("erasing"),this.inputHandler.setErasing(!1)},this)})},createEraserRect:function(){this.eraserRect={width:parseInt(a5.utils.getCSSAttributeFromCSS(".is-linking-multiple-lines","eraser","width"),10),height:parseInt(a5.utils.getCSSAttributeFromCSS(".is-linking-multiple-lines","eraser","height"),10)}},onErase:function(pos,node){var element=$(node).data("mvc-view");this.model.lines.clear(element.id),this.repaintCanvas()},onStart:function(pos,node){var element=$(node).data("mvc-view");if(element){var center=element.getCenter(pos.pageX-this.node.offset().left,pos.pageY-this.node.offset().top,this.model.displayInRows,this.startSide,this.endSide),position=this.toRelative(center.left,center.top);element.$(".handle").addClass("handle-hover"),this.startElement=element,this.startPosition=position,this.currentPosition=position,this.repaintCanvas()}},onLinking:function(pos){var coords=this.toRelative(pos.pageX,pos.pageY);this.current(coords),this.startElement&&this.updateScrollY(pos.pageY,this.SCROLL_SENSITIVITY,this.SCROLL_SPEED)},onMove:function(ev){if(!this.inputHandler.linking&&!this.inputHandler.erasing){var myEv=ev.originalEvent.touches?ev.originalEvent.touches[0]:ev,pos=_.pick(myEv,"pageX","pageY","clientX","clientY"),coords=this.toRelative(pos.pageX,pos.pageY);this.collidingLine=this.findCollidingLine(coords),this.repaintCanvas()}},onFinish:function(pos,node){this.end($(node).data("mvc-view"))},onNextAnswer:function(){this.repaintCanvas();var line=_.last(this.model._prevAnswers);a5.utils.scrollIntoElementIfNeeded(this.elements[line.from].node)},findCollidingLine:function(cursor){var lines=this.model.lines.union(this.model.prefilledLines);"answers"===this.model.state&&(lines=lines.union(this.model.answers)),lines=lines.children;for(var i=lines.length-1;i>=0;i--){var approx=this.lineToBezier(lines[i]).approximate(),selectBox=new Box(cursor.left-this.lineWidth/2,cursor.top-this.lineWidth/2,this.lineWidth,this.lineWidth);if(new LinesBoxIntersection(approx,selectBox).intersectAny())return lines[i]}return null},toRelative:function(left,top){var offset=this.node.offset();return left-=offset.left,top-=offset.top,new Point(left,top)},updateScrollY:function(y,scrollSensitivity,scrollSpeed){var scrollParent=this.node.scrollParent();scrollParent[0]===document?y-$(document).scrollTop()<scrollSensitivity+a5.dp.config.exclusionTop?$(document).scrollTop($(document).scrollTop()-scrollSpeed):$(window).height()-(y-$(document).scrollTop())<scrollSensitivity+a5.dp.config.exclusionBottom&&$(document).scrollTop($(document).scrollTop()+scrollSpeed):y-scrollParent.offset().top<scrollSensitivity?scrollParent.scrollTop(scrollParent.scrollTop()-scrollSpeed):scrollParent.offset().top+scrollParent.outerHeight()-y<scrollSensitivity&&scrollParent.scrollTop(scrollParent.scrollTop()+scrollSpeed)},createCanvas:function(){if(!this.canvas){var w=this.node.width(),h=this.node.height();this.canvas=new a5.views.interaction.LinkingMultipleLinesCanvas(w,h),this.node.prepend(this.canvas.render()),$(window).on("resize",_.throttle(this.resizeCanvas.bindTo(this),500)),this.node.find("img").on("load",function(){this.resizeCanvas()}.bindTo(this))}this.repaintCanvas()},resizeCanvas:function(){this.node.find("canvas").attr({width:this.node.width(),height:this.node.height()}),this.repaintCanvas()},appendHandles:function(){_.each(this.children,function(column,i){0!==i&&column.appendHandles(this.endSide),i!==this.children.length-1&&column.appendHandles(this.startSide)},this)},findColumn:function(element){return _.find(this.children,function(child){return _.include(child.children,element)})},shuffle:function(){_.each(this.columns,function(column){column.children=_.shuffle(column.children)},this)},shuffleRest:function(){_(this.columns).chain().values().rest().each(function(column){column.children=_.shuffle(column.children)},this)},current:function(position){this.currentPosition=position,this.repaintCanvas()},end:function(element){element&&this.startElement&&this.addLine(this.startElement,element),this.startElement=null,this.repaintCanvas(),this.$(".handle-hover").removeClass("handle-hover")},addLine:function(from,to){var column1=this.findColumn(from),column2=this.findColumn(to);if(column1!==column2){if(_.indexOf(this.children,column1)>_.indexOf(this.children,column2)){var tmp=from;from=to,to=tmp}this.model.addLine(from.id,to.id)}},repaintCanvas:function(){this.canvas&&(this.$(".handle").removeClass("linked"),this.canvas.clear(),this.model.prefilledLines.each(function(line){this.drawLine(line,this.prefillColor,this.lineWidth)},this),this.drawNextAnswer(),"feedback"==this.model.state?this.drawFeedbackLines():"answers"==this.model.state?this.drawAnswersLines():this.drawInputLines(),this.startElement&&this.canvas.drawLine(new Bezier(this.startPosition,this.currentPosition),this.defaultColor,this.lineWidth))},drawFeedbackLines:function(){this.model.answers.each(function(line){this.model.prefilledLines.include(line)||this.model.lines.include(line)||(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("checked-empty"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("checked-empty"))},this),this.model.lines.each(function(line){this.model.answers.include(line)?(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("checked-correct"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("checked-correct"),this.drawLine(line,this.feedbackCorrectColor,this.lineWidth,this.feedbackCorrectStyle)):(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("checked-incorrect"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("checked-incorrect"),this.drawLine(line,this.feedbackWrongColor,this.lineWidth,this.feedbackWrongStyle))},this)},drawAnswersLines:function(){this.model.answers.each(function(line){this.model.prefilledLines.include(line)||this.model.lines.include(line)||(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("solution-empty"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("solution-empty"),this.drawLine(line,this.unattemptedColor,this.lineWidth,this.unattemptedStyle))},this),this.model.lines.each(function(line){this._isRevealedBySeeNext(line)||(this.model.answers.include(line)?(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("solution-correct"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("solution-correct"),this.drawLine(line,this.answersCorrectColor,this.lineWidth,this.answersCorrectStyle)):(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("solution-incorrect"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("solution-incorrect"),this.drawLine(line,this.answersWrongColor,this.lineWidth,this.answersWrongStyle)))},this)},drawNextAnswer:function(){_.each(this.model._prevAnswers,function(line){this.drawLine(line,this.seeNextAnswerColor,this.lineWidth,this.seeNextAnswerStyle)},this)},drawInputLines:function(){this.model.lines.each(function(line){this._isRevealedBySeeNext(line)||this.drawLine(line,line.checked?this.feedbackCorrectColor:this.defaultColor,this.lineWidth)},this)},_isRevealedBySeeNext:function(line){return _.contains(this.model._prevAnswers,line)},lineToBezier:function(line){var p1=this.elements[line.from].getCenterByHandle(this.startSide),p2=this.elements[line.to].getCenterByHandle(this.endSide);return new Bezier(this.toRelative(p1.left,p1.top),this.toRelative(p2.left,p2.top))},drawLine:function(line,color,lineWidth,lineStyle){var lineMuted;this.collidingLine==line?lineMuted=!1:this.collidingLine&&(lineMuted=!0),this.canvas.drawLine(this.lineToBezier(line),color,lineWidth,lineStyle,lineMuted),this.setHandlesLinked(line)},setHandlesLinked:function(line){this.elements[line.from].setHandleLinked(this.startSide),this.elements[line.to].setHandleLinked(this.endSide)}},a5.views.interaction.BaseView.extend("a5.views.interaction.LinkingMultipleLines"),a5.views.interaction.LinkingMultipleLinesColumn={init:function(){this._super(null,null,$('<div class="ll_column"></div>')),this.children=[]},render:function(){return this._super(),this.renderChildren(),this.node},appendHandles:function(side){_.each(this.children,function(child){child.handles.push(side)},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.LinkingMultipleLinesColumn"),a5.views.interaction.LinkingMultipleLinesElement={init:function(model,id,prefilled,content,parent){this._super(model,parent,$('<div class="ll_element_view"></div>')),this.id=id,this.prefilled=prefilled,this.content=content,this.handles=[]},render:function(){return this._super(),this.node.off(),this.node.html(this.content.detach()),_.each(this.handles,function(side){var handle='<div class="handle '+side+'_handle"></div>';"top"===side?this.node.prepend(handle):this.node.append(handle)},this),this.prefilled&&this.node.addClass("prefill"),this.node},getCenter:function(x,y,displayInRows,startSide,endSide){var handle,ref=displayInRows?x:y,dimension=displayInRows?"width":"height";return handle=this.handles.length>1?ref>this.node[dimension]()/2?startSide:endSide:this.handles[0],this.getCenterByHandle(handle)},getCenterByHandle:function(handle){var $handle=this.getHandle(handle),center=$handle.offset();return center.left+=$handle.outerWidth()/2,center.top+=$handle.outerHeight()/2,center},getHandle:function(handle){return this.$("."+handle+"_handle")},setHandleLinked:function(handle){this.getHandle(handle).addClass("linked")}},a5.views.interaction.BaseView.extend("a5.views.interaction.LinkingMultipleLinesElement"),a5.views.interaction.LinkingMultipleLinesCanvas={init:function(width,height){this._super(null,null,$('<canvas width="'+width+'" height="'+height+'"></canvas>'))},drawLine:function(bezier,color,lineWidth,lineStyle,lineMuted){var co=this.getContext();co.shadowBlur=3,co.shadowColor="white",co.lineWidth=lineWidth,co.lineJoin="round",co.strokeStyle=color,co.globalAlpha=1,lineMuted?co.globalAlpha=.2:_.isUndefined(lineMuted)||(co.lineWidth=1.5*lineWidth),co.beginPath(),co.setLineDash(this._getLineDash(lineStyle,lineWidth)),co.moveTo(bezier.p1.left,bezier.p1.top),co.bezierCurveTo(bezier.p2.left,bezier.p2.top,bezier.p3.left,bezier.p3.top,bezier.p4.left,bezier.p4.top),co.stroke()},clear:function(){this.getContext().clearRect(0,0,this.node[0].width,this.node[0].height)},getContext:function(){return this.node[0].getContext("2d")},_getLineDash:function(style,lineWidth){var dash=[];return"dotted"===style?dash=[lineWidth,lineWidth]:"dashed"===style&&(dash=[3*lineWidth,lineWidth]),dash}},a5.views.interaction.BaseView.extend("a5.views.interaction.LinkingMultipleLinesCanvas"),a5.views.interaction.LinkingMultipleLinesKeyTable={TEMPLATE:'<button type="button" class="close" /><table><tr class="llm-key llm-key-prefill"><td><canvas width="80"></canvas></td><td><span>Prefilled</span></td></tr><tr class="llm-key llm-key-correct"><td><canvas width="80"></canvas></td><td><span>Correct</span></td></tr><tr class="llm-key llm-key-wrong"><td><canvas width="80"></canvas></td><td><span>Wrong</span></td></tr><tr class="llm-key llm-key-missing"><td><canvas width="80"></canvas></td><td><span>Missing</span></td></tr></table><div class="last-time"><input type="checkbox" /><span>Do not display again</span></div>',init:function(){this._super(null,null,$('<div class="llm-key-table"></div>')),this.entries=[],_.bindAll(this,"onClickClose","onClickLastTime")},render:function(){var template=a5.service.templates.render("a5.view.LinkingMultipleLinesKeyTable")||this.TEMPLATE,$template=$(template);return this.node.empty(),this.node.append($template),this.node.draggable(),this.node.find(".last-time").on("click",this.onClickLastTime),this.node.find(".close").on("click",this.onClickClose),$template.find(".llm-key").hide(),_(this.entries).each(function(entry){this.renderEntry(entry).show()},this),this.node},onClickLastTime:function(ev){var $input=this.node.find(".last-time input");$(ev.target).is("input")||$input.prop("checked",!$input.prop("checked")),$input.is(":checked")?a5.utils.setHideLLMKeyTable(!0):a5.utils.setHideLLMKeyTable(!1)},onClickClose:function(ev){this.node.remove()},addEntry:function(lineWidth,lineColor,lineStyle,lineType){this.entries.push({lineWidth:lineWidth,lineColor:lineColor,lineStyle:lineStyle,lineType:lineType})},renderEntry:function(entry){var $entry=this.node.find(".llm-key-"+entry.lineType),$canvas=$entry.find("canvas");$canvas.attr("height",entry.lineWidth);var co=$canvas.get(0).getContext("2d");return co.beginPath(),co.lineWidth=entry.lineWidth,co.strokeStyle=entry.lineColor,co.setLineDash(this._getLineDash(entry.lineStyle,entry.lineWidth)),co.moveTo(0,0),co.lineTo(80,0),co.stroke(),$entry},_getLineDash:function(style,lineWidth){var dash=[0];return"dotted"===style?dash=[lineWidth,lineWidth]:"dashed"===style&&(dash=[3*lineWidth,lineWidth]),dash}},a5.views.interaction.BaseView.extend("a5.views.interaction.LinkingMultipleLinesKeyTable"),a5.views.interaction.OSSequenceView={NODE_TEMPLATE:"<div class='shuffle_interaction'></div>",LINE_TEMPLATE:"<div class='line ui-helper-clearfix'></div>",DROP_PLACEHOLDER_TEMPLATE:"<div class='drop drop-placeholder'>&nbsp;</div>",DRAG_OVERLAP_PERCENT:.3,init:function(model,horizontal,clickclick,dropIndicator,gaptextaudio,capitalize){this.gaptextaudio=gaptextaudio,this._super(model,null,$(this.NODE_TEMPLATE)),this.isHorizontal=horizontal,this.clickclick=clickclick,this.dropIndicator=dropIndicator,this.capitalize=capitalize,this.elements=[],this.lastcursor=!1},render:function(){
return this.$node=this._super(),this.$node.addClass(this.isHorizontal?"horizontal":"vertical"),"horizontal_single_word"===this.model.alignment&&this.$node.addClass("single-word"),this.$line=$(this.LINE_TEMPLATE),_.each(this.model.elements,function(e,index){this.appendElement(e).$node.toggleClass("text-capitalize",this.capitalize&&0===index)},this),this.$node.append(this.$line),this.bindEvents(),this.$node},bindEvents:function(){this.model.bind("update-element-order",this.updateElementOrder,this)},appendElement:function(model){var view=new a5.views.interaction.OSSequenceElement(model,null,this.clickclick,this.$line,this.isHorizontal,this.gaptextaudio,this.dropIndicator);return view.bind("dragend",this.dragEndEvent,this),view.bind("drag",this.dragEvent,this),this.$line.append(view.render()),this.elements.push(view),view},updateElementOrder:function(skipReattach){this.elements=_.map(this.model.elements,function(model){return _.find(this.elements,function(v){return v.model==model})},this),_.each(this.elements,function(v,index){v.$node.toggleClass("text-capitalize",this.capitalize&&0===index),skipReattach||v.$node.detach().appendTo(this.$line)},this)},dragEndEvent:function(child){this.target&&this.target.$node.removeClass("dragged")},_updateModel:function(child,before){var elementViews=this.allMovablesExcept(child),dest=_.indexOf(elementViews,this.target)+(before?0:1),elements=_(elementViews).map(function(view){return view.model});this.model.insert(child.model,dest,elements)},allMovablesExcept:function(child){return _.select(this.elements,function(e){return!(e===child||e.model.fixed||this.model.tryAgainIsFrozen&&$(e.node).hasClass("checked-correct-locked"))},this)},allMovables:function(){return _.select(this.elements,function(e){return!(e.model.fixed||this.model.tryAgainIsFrozen&&$(e.node).hasClass("checked-correct-locked"))},this)},dragEvent:function(child,cursor){this.target&&this.target.$node.removeClass("dragged");var elements=this.allMovablesExcept(child),all_elements=this.allMovables();this.target=_.detect(elements,function(e){return a5.utils.elementOverlapAreaPercent(e.$node,child.$helper)>=this.DRAG_OVERLAP_PERCENT},this);var target_i=all_elements.indexOf(this.target),child_i=all_elements.indexOf(child);this.target&&this.lasttarget!=this.target&&(target_i-child_i<0?(child.$node.detach().insertBefore(this.target.$node),this._updateModel(child,!0)):(child.$node.detach().insertAfter(this.target.$node),this._updateModel(child))),this.lasttarget=this.target}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSequenceView"),a5.views.interaction.OSSequenceElement={NODE_TEMPLATE:"<div></div>",init:function(model,parent,clickclick,$line,isHorizontal,gaptextaudio,dropindicator){this._super(model,parent,$(this.NODE_TEMPLATE)),this.gaptextaudio=gaptextaudio,this.$line=$line,this.clickclick=clickclick,this.isHorizontal=isHorizontal,this.dropIndicator=dropindicator},_setDraggable:function(){this.$node.draggable($.extend({start:this.dragStartEvent.bindDD(this),stop:this.dragStopEvent.bindDD(this),drag:this.dragEvent.bindDD(this),addClasses:!1,disabled:!0,containment:"parent",revert:!1,helper:"clone",cancel:".checked-correct-locked"},a5.utils.getDraggableOptions(this.model.parent.interaction)))},render:function(){this.$node=this._super(),this.$node.attr("data-id",this.model.identifier);var $content=this.model.content;return $content.text()||$content.addClass("no-label"),this.$node.append($content),this.$helper=$(this.NODE_TEMPLATE),this.gaptextaudio&&(this.tts_audio=new a5.views.TTS_Player(this.model.text),$content.prepend(this.tts_audio.render())),this._setDraggable(),this.$node.addClass("os-sequence-element"),this.model.fixed?(this.$node.addClass("oss-fixed"),this.$node.removeClass("element")):(this.$node.addClass("element"),this.enable()),this.isHorizontal?this.$node.addClass("horizontal").css("display","inline-block"):this.$node.css("display","block"),this.model.prefilled&&this.$node.addClass("prefill"),this.bindEvents(),this.$node},bindEvents:function(){this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.tryAgain,this),this.model.bind("input_update:setAnswer",this.setAnswerInput,this)},setAnswer:function(){this.updateFeedbackState(this.$node),this.disable(),this.setAnswerCheck(!this.model.fixed)},setAnswerInput:function(){this.updateFeedbackState(this.$node),this.setAnswerCheck(!this.model.fixed&&this.model.parent.actionsDone>0)},setAnswerCheck:function(check){check&&(this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))},showAnswer:function(){if(this.updateFeedbackState(this.$node),this.disable(),!this.model.fixed){if(this.$node.find(".check").remove(),this.model.isCorrect())this.$node.append(this.model.content),this.addCheck({correct:!0,tooltip:this.model.text,width:1e3});else{var correct=this.model.getCorrect(),parent=correct.content.parent();parent&&this.$node.find(".content").appendTo(parent),this.$node.append(correct.content),this.model.setCurrentIdentifier(correct.identifier),this.addCheck({correct:!1,tooltip:this.model.text,width:1e3})}var ol=this.$node.offset();ol.top+=this.$node.height();var oc=this.$node.find(".check").offset(),diff={left:ol.left-oc.left,top:ol.top-oc.top};this.$node.find(".tooltip").css(diff)}},tryAgain:function(){this.updateFeedbackState(this.$node),this.removeAnswer(),this.$node.append(this.model.content),this.enable()},removeAnswer:function(){this.$node.find(".check").remove(),this.model.content.closest(this.$node).length>0&&(this.model.content=this.model.content.detach()),this.$node.empty()},disable:function(){this.model.fixed||this.$node.draggable("disable")},dragStartEvent:function(e,data){this.startPosition=this.$node.position(),data.helper.addClass("dragged"),this.$helper=data.helper,this.$helper.width(this.$node.width()+1),this.$node.addClass("drop drop-placeholder").css("color","transparent"),this.$node.toggleClass("drop-indicator",this.dropIndicator),this.trigger("dragstart",this)},dragStopEvent:function(e,data){this.$node.removeClass("dragged").css({left:"",top:"",position:""}),this.trigger("dragend",this),this.$node.removeClass("drop drop-placeholder drop-indicator").width("auto").css("color","inherit")},dragEvent:function(e,data){var cursor=new Point(data.offset.left,data.offset.top);this.trigger("drag",this,cursor,this.$node)},enable:function(){this.model.fixed||this.$node.draggable("enable")},boundaries:function(n,min,max){return n<min?min:n>max?max:n}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSequenceElement"),a5.views.interaction.OSSequenceViewSwap={bindEvents:function(){this.model.bind("next_answer",this.deselect,this),this.model.bind("swapped",this.swap,this),this.model.bind("state_update",this.deselect,this),this.model.bind("update-element-order",this.updateElementOrder,this),$(document).data("hammer")||$(document).hammer(),$(document).on("tap",_.bind(function(e){this.$node.find(".element *").is(e.gesture.target)||this.deselect()},this)),$(document).on("keydown",_.bind(function(e){e.which===a5.utils.keyCodes.ESCAPE&&this.deselect()},this))},updateElementOrder:function(isSwap){this._super(isSwap),isSwap||_.each(this.elements,function(v,index){v.updateButtons()},this)},appendElement:function(model){var view=new a5.views.interaction.OSSequenceElementSwap(model,this,this.clickclick,this.$line,this.isHorizontal,this.gaptextaudio,this.dropIndicator);return this.$line.append(view.render()),this.elements.push(view),view},deselect:function(){this.selected&&(this.selected.deselect(),this.selected=void 0)},setSelected:function(element){this.selected&&this.selected.deselect(),this.selected=element,this.selected.select()},swap:function(data){var from=_.findWhere(this.elements,{model:data.from}),to=_.findWhere(this.elements,{model:data.to}),fromPlaceholder=$(this.DROP_PLACEHOLDER_TEMPLATE),toPlaceholder=$(this.DROP_PLACEHOLDER_TEMPLATE);from.$node.before(fromPlaceholder),to.$node.before(toPlaceholder),from.$node.removeClass("transition-in"),to.$node.removeClass("transition-in"),from.$node.addClass("transition-out"),to.$node.addClass("transition-out"),from.enabled=!1,to.enabled=!1,this._runDelayedTransition(from,to,fromPlaceholder,toPlaceholder)},_runDelayedTransition:function(from,to,fromPlaceholder,toPlaceholder){_.delay(function(){var $focused=$(":focus");from.$node.removeClass("transition-out"),to.$node.removeClass("transition-out"),from.$node.detach(),to.$node.detach(),toPlaceholder.after(from.$node),fromPlaceholder.after(to.$node),($focused.closest(from.$node).length||$focused.closest(to.$node).length)&&$focused.focus(),fromPlaceholder.remove(),toPlaceholder.remove(),from.trigger("swapped"),to.trigger("swapped"),from.$node.addClass("transition-in"),to.$node.addClass("transition-in"),from.enabled=!0,to.enabled=!0},a5.dp.config.ossequenceTransitionDelay)}},a5.views.interaction.OSSequenceView.extend("a5.views.interaction.OSSequenceViewSwap"),a5.views.interaction.OSSequenceElementSwap={SWAP_NEXT_TEMPLATE:"<div class='btn swap-next' tabindex='0'></div>",SWAP_PREV_TEMPLATE:"<div class='btn swap-prev' tabindex='0'></div>",_setDraggable:function(){},bindEvents:function(){this._super(),this.bind("swapped",this.updateButtons,this)},updateButtons:function(){this.$swap_next.removeClass("btn-disable"),this.$swap_prev.removeClass("btn-disable");var i=this.model.parent.elements.indexOf(this.model),next=this._getNextNonFixedElementIndex(i),prev=this._getPrevNonFixedElementIndex(i);i>next&&this.$swap_next.addClass("btn-disable"),i<prev&&this.$swap_prev.addClass("btn-disable")},render:function(){return this.$node=this._super(),this.$node.addClass("tap-to-swap"),this.$node.attr("data-id",this.model.identifier),this.$node.attr("tabindex",0),this.$node.find(".content").click(_.bind(this.setSelected,this)),this.$node.on("keydown",_.bind(this.onKeydown,this)),this.$node},tryAgain:function(){this._super(),this.$swap_next.remove(),this.$swap_prev.remove(),this.addButtons()},addButtons:function(){this.$swap_next=$(this.SWAP_NEXT_TEMPLATE),this.$swap_prev=$(this.SWAP_PREV_TEMPLATE),this.$swap_next.click(_.bind(this.swapNext,this)),this.$swap_next.on("keydown",_.bind(this.onKeydownNext,this)),this.$swap_prev.click(_.bind(this.swapPrev,this)),this.$swap_prev.on("keydown",_.bind(this.onKeydownPrev,this)),this.$node.append(this.$swap_next),this.$node.prepend(this.$swap_prev),this.updateButtons()},removeButtons:function(){this.$swap_next&&(this.$swap_next.remove(),this.$swap_next=null),this.$swap_prev&&(this.$swap_prev.remove(),this.$swap_prev=null)},onKeydown:function(e){if(this.enabled){var key=e.which;key===a5.utils.keyCodes.SPACE||key===a5.utils.keyCodes.ENTER?this.parent.selected===this?this.parent.deselect():this.parent.setSelected(this):key===a5.utils.keyCodes.DOWN||key===a5.utils.keyCodes.RIGHT?this.swapNext():key!==a5.utils.keyCodes.UP&&key!==a5.utils.keyCodes.LEFT||this.swapPrev()}},onKeydownNext:function(e){var key=e.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.swapNext()},onKeydownPrev:function(e){var key=e.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.swapPrev()},setSelected:function(){this.enabled&&this.parent.setSelected(this)},select:function(){this.$node.addClass("os-sequence-selected"),_.defer(_.bind(function(){this.$node.addClass("button-transition")},this))},deselect:function(){this.$node.removeClass("os-sequence-selected"),this.$node.removeClass("button-transition")},swapNext:function(){if(this.enabled){var i=this.model.parent.elements.indexOf(this.model),next=this._getNextNonFixedElementIndex(i);this.model.parent.swap(i,next)}},_getNextNonFixedElementIndex:function(curIndex){for(var len=this.model.parent.elements.length,i=curIndex+1;i%len!==curIndex;i+=1){if(!this.model.parent.elements[i%len].fixed)return i%len}},_getPrevNonFixedElementIndex:function(curIndex){for(var len=this.model.parent.elements.length,i=curIndex-1;i!==curIndex;i-=1){i<0&&(i=len-1);if(!this.model.parent.elements[i].fixed)return i}},swapPrev:function(){if(this.enabled){var i=this.model.parent.elements.indexOf(this.model),prev=this._getPrevNonFixedElementIndex(i);this.model.parent.swap(i,prev)}},enable:function(){this.enabled=!0,this.addButtons()},disable:function(){this.enabled=!1,this.removeButtons()}},a5.views.interaction.OSSequenceElement.extend("a5.views.interaction.OSSequenceElementSwap"),a5.views.interaction.OSBoxDropView={NODE_TEMPLATE:"<div class='os-boxdrop-wrapper'></div>",CONTROLS_TEMPLATE:"<div class='os-boxdrop-controls'></div>",BUTTON_TEMPLATE:"<button class='boxdrop-button'></button>",init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.crane=new a5.views.interaction.OSBoxDropCrane(this.model,this),this.contGroup=new a5.views.interaction.OSBoxDropContainerGroup(this.model,this),this.node.append(this.crane.render()),this.node.append(this.contGroup.render())}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSBoxDropView"),a5.views.interaction.OSBoxDropCrane={NODE_TEMPLATE:"<div class='crane-wrapper'><ol class='crane-items'></ol></div>",init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.parent=parent,this.choices=_.map(model.choices,function(choice){var choice_view=new a5.views.interaction.OSBoxDropChoice(choice,this);return this.appendChoice(choice_view),choice_view},this)},appendChoice:function(choice){this.node.find(".crane-items").append(choice.render())}};a5.views.interaction.BaseView.extend("a5.views.interaction.OSBoxDropCrane"),a5.views.interaction.OSBoxDropChoice={NODE_TEMPLATE:"<li class='boxdrop-item'></div>",ANIMATION_EVENT:"animationstart MSAnimationStart webkitAnimationStart",init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE));var content=$($.parseHTML(model.contents));content.is("object[type='audio/audio']")?this.renderAudioPlayer(content):content.is("img")?(this.node.addClass("has-img"),a5.utils.buildModel(a5.mainBuilder.curInteraction,this.node,content,!0)):this.node.html(model.contents),this.parent=parent,this.interaction=this.model.interaction,this.model.bind("dropped",_.bind(this.dropHandler,this)),this.bottom=0},renderAudioPlayer:function(audionode){a5.service.media.audio.bind("ready",_.bind(function(){this.audio=a5.service.media.audio.create($(audionode).attr("data"),{preload:!a5.dp.config.audioPreloadDisabled}),a5.dp.config.audioPreloadDisabled&&this.interaction.preloadAudio(this.audio),this.tinyplayer=new a5.views.TinyPlayer,this.node.addClass("has-audio"),this.node.append(this.tinyplayer.render()),this.tinyplayer.bind("play",_.bind(function(){this.audio.play()},this)),this.tinyplayer.bind("pause",_.bind(function(){this.audio.pause()},this)),this.audio.bind("stopped",_.bind(function(){this.tinyplayer.pause()},this))},this))},checkLocked:function(node){this.model.tryAgainIsFrozen&&((node||this.node).filter(".checked-correct, .solution-correct").addClass("checked-correct-locked"),(node||this.node).filter(":not(.checked-correct, .solution-correct)").removeClass("checked-correct-locked"))},updateFeedbackState:function(nodes){this.checkLocked(nodes),nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct");var type;type="answers"==this.model.state?"solution":"checked",this.model.isCorrect()?nodes.addClass([type,"correct"].join("-")):!this.model.isFilled||this.model.isFilled()?nodes.addClass([type,"incorrect"].join("-")):nodes.addClass([type,"empty"].join("-"))},showAnswer:function(stack_after){this.node.addClass("dropped"),this.bottom=0,this.stackAfter(stack_after?stack_after.model:void 0),this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect()})},tryAgain:function(stack_after){this.bottom=0,this.updateFeedbackState(this.node),this.model.current_target?(this.node.addClass("dropped"),this.stackAfter(stack_after?stack_after.model:void 0)):(this.node.find(".check").remove(),this.node.removeAttr("style"),this.node.removeClass("dropped"),this.parent.appendChoice(this))},stackAfter:function(after){if(!after)return this.node.css("bottom",0);var view=_.find(this.parent.choices,function(choice){return choice.model.id==after.id});view.bottom;return this.bottom=view.node.outerHeight(!0)+view.bottom,this.node.css("bottom",this.bottom)},dropHandler:function(target){this.clone=this.node.clone(),this.clone.insertBefore(this.node),this.getCategoryView(target).appendChoice(this.node),this.node.on(this.ANIMATION_EVENT,_.bind(this.dropTransition,this));this.clone.on("transitionend webkitTransitionEnd",_.bind(function(e){this.clone.remove()},this))},dropTransition:function(e){this.clone.addClass("dropped"),this.node.addClass("dropped");var choices=_.reject(this.model.current_target.choices,_.bind(function(choice){return choice.id==this.model.id},this));this.stackAfter(_.last(choices)),this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect()}),this.node.off(this.ANIMATION_EVENT),a5.eventBus.trigger("os-boxdrop:item:dropped",this.node)},getCategoryView:function(target){var base_view=this.parent.parent;return _.find(base_view.contGroup.containers,function(view){return view.model.id==target.id})}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSBoxDropChoice"),a5.views.interaction.OSBoxDropContainerGroup={NODE_TEMPLATE:"<div class='boxdrop-container-group'></div>",init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.containers=_.map(model.targets,function(target){var target_view=new a5.views.interaction.OSBoxDropContainer(target,this);return this.node.append(target_view.render()),target_view},this),this.model.bind("change:category",_.bind(function(index){this._updatePosition(model.targets.length-1-index)},this))},_updatePosition:function(position){this.node.removeClass(function(index,className){return(className.match(/(^|\s)position-\d+/g)||[]).join(" ")}),this.node.addClass("position-"+position)}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSBoxDropContainerGroup"),a5.views.interaction.OSBoxDropContainer={NODE_TEMPLATE:"<div class='boxdrop-container'><ol class='dropped-items'></ol><h1 class='boxdrop-label'></h1></div>",init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.node.find(".boxdrop-label").html(model.contents),model.parent.bind("change:category",_.bind(function(index){this.model=model,this.node.toggleClass("current",this.model.index==index)},this)),this.model.parent.bind("state_update:answers",_.bind(this.showAnswer,this)),this.model.parent.bind("state_update:input",_.bind(this.tryAgain,this))},appendChoice:function(choice){this.node.find(".dropped-items").append(choice)},showAnswer:function(){_.each(this.model.correctChoices,function(choice,index){var current_view=this.getChoiceView(choice),prev_view=this.getChoiceView(this.model.correctChoices[index-1]);this.appendChoice(current_view.node),current_view.showAnswer(prev_view)},this)},tryAgain:function(){this.node.find(".dropped-items .boxdrop-item").detach(),_.each(this.model.choices,function(choice,index){var current_view=this.getChoiceView(choice),prev_view=this.getChoiceView(this.model.choices[index-1]);this.appendChoice(current_view.node),current_view.tryAgain(prev_view)},this),_.each(this.model.parent.choices,function(choice){this.getChoiceView(choice).tryAgain()},this)},getChoiceView:function(needle){if(needle)return _.find(this.parent.parent.crane.choices,function(choice){return choice.model.id==needle.id})}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSBoxDropContainer"),a5.view.interaction.ICCrossword={DEFAULT_TEMPLATE:'<div class="crossword_view"><div class="grid"></div></div>',init:function(model,parent,uppercase,cluePosition){this._super(model,parent,$(this.DEFAULT_TEMPLATE)),this.uppercase=uppercase,this.cluePosition=cluePosition,this.interaction=this.model.parent,this.cell_views=[],this.clue_cells=[],_.each(this.model.cells,function(cell){var view=new a5.view.interaction.ICCrosswordCell(cell,this);this.cell_views.push(view)},this),"inside"===this.cluePosition&&_.each(this.model.words,function(word){var view=new a5.view.interaction.ICCrosswordWordClue(word,this);this.clue_cells.push(view)},this),a5.hooks.interactionFontUpdated.add(function(){this.interaction.visible||(this.interaction.disableVisibility(),this.interaction.contentWrap.show()),this.adjustSize(),this.interaction.visible||(this.interaction.contentWrap.hide(),this.interaction.enableVisibility())}.bind(this))},render:function(){if(this.$grid=this.node.find(".grid"),_.each(this.cell_views,function(view){this.$grid.append(view.node),view.render()},this),"outside"===this.cluePosition){this.node.addClass("clues-outside");var clues=new a5.view.interaction.ICCrosswordClues(this.model,this);this.node.append(clues.node),clues.render()}else this.node.addClass("clues-inside"),_.each(this.clue_cells,function(view){this.$grid.append(view.node),view.render()},this);return this.adjustSize(),this.node},adjustSize:function(){var width=0,height=0;"inside"===this.cluePosition&&_.each(this.clue_cells,function(view){view.adjustPosition()},this),_.each(this.cell_views,function(view){view.adjustPosition(),width=Math.max(width,view.left),height=Math.max(height,view.top)},this);var cellWidth=a5.utils.getCrosswordCellWidth();width+=cellWidth.width+("px"===cellWidth.unit?2:0),height+=cellWidth.width+("px"===cellWidth.unit?2:0),this.$grid.width(width+cellWidth.unit).height(height+cellWidth.unit)}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICCrossword"),a5.view.interaction.ICCrosswordClues={template:"a5.view.ic_crosswords",DEFAULT_TEMPLATE:'<div class="clues"><div class="clue-list-hor"><h2>Across</h2></div><div class="clue-list-ver"><h2>Down</h2></div></div>',init:function(model,parent){this._super(model,parent,$('<div class="clue-list"></div>'))},render:function(){var html=a5.service.templates.render(this.template,{},this.DEFAULT_TEMPLATE),$html=$(html),$horizontalClues=$html.find(".clue-list-hor"),$verticalClues=$html.find(".clue-list-ver"),horizontalWords=_.filter(this.model.words,function(word){return"horizontal"===word.align}),verticalWords=_.filter(this.model.words,function(word){return"vertical"===word.align});return _.each(horizontalWords,function(word){var view=new a5.view.interaction.ICCrosswordClue(word,this);$horizontalClues.append(view.node),view.render()},this),_.each(verticalWords,function(word){var view=new a5.view.interaction.ICCrosswordClue(word,this);$verticalClues.append(view.node),view.render()},this),this.node.append($horizontalClues),this.node.append($verticalClues),this.node.toggleClass("clues-in-columns",this.model.cluesInColumns),this.node}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICCrosswordClues"),a5.view.interaction.ICCrosswordClue={DEFAULT_TEMPLATE:'<div><div class="clue-enum"></div><div class="clue-content"></div></div>',init:function(model,parent){this._super(model,parent,$(this.DEFAULT_TEMPLATE)),this.crossword=this.parent.parent,_.bindAll(this,"_onMouseOver","_onMouseOut"),this.node.on("mouseover",this._onMouseOver),this.node.on("mouseout",this._onMouseOut)},render:function(){return this.node.find(".clue-enum").append(this.model.label),this.node.find(".clue-content").append(this.model.content.contents()),this.node},_onMouseOver:function(e){this.crossword.$('.cell[data-label ~= "'+this.model.tag+'"]').addClass("highlighted")},_onMouseOut:function(e){this.crossword.$('.cell[data-label ~= "'+this.model.tag+'"]').removeClass("highlighted")}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICCrosswordClue"),a5.view.interaction.ICCrosswordWordClue={DEFAULT_TEMPLATE:'<div class="cell chint"></div>',init:function(model,parent){this._super(model,parent,$(this.DEFAULT_TEMPLATE)),this.interaction=this.model.parent.parent,this.crossword=this.parent,_.bindAll(this,"_onMouseOver","_onMouseOut"),this.node.on("mouseover",this._onMouseOver),this.node.on("mouseout",this._onMouseOut),this.tooltip=$('<div class="clue"></div>'),this.interaction.bind("show:defered rendered:defered",function(){var size=this.tooltip.naturalSize({},{width:200});this.tooltip.css({width:size[0]})},this)},render:function(){return this.node.addClass("hint-"+this.model.align.substring(0,3)),this.node.append(this.tooltip),this.tooltip.append(this.model.content.contents()),this.adjustPosition(),this.node},adjustPosition:function(){var cellWidth=a5.utils.getCrosswordCellWidth(),borderOffset="px"===cellWidth.unit?1:0;this.node.css("width",_.values(cellWidth).join("")),this.node.css("height",_.values(cellWidth).join("")),this.node.css({left:(this.model.x+(this.model.isVertical()?1:0))*(cellWidth.width+borderOffset)+cellWidth.unit,top:(this.model.y+(this.model.isHorizontal()?1:0))*(cellWidth.width+borderOffset)+cellWidth.unit})},_onMouseOver:function(e){this.crossword.$('.cell[data-label ~= "'+this.model.tag+'"]').addClass("highlighted")},_onMouseOut:function(e){this.crossword.$('.cell[data-label ~= "'+this.model.tag+'"]').removeClass("highlighted")}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICCrosswordWordClue"),a5.view.interaction.ICCrosswordCell={template:"a5.view.interaction.ICCrosswordCell",init:function(model,parent){this._super(model,parent,$("<div>",{class:"cell","data-label":model.tags.join(" ")})),_.bindAll(this,"_onInputSpecialCharInserted","_onInputChanged","_onInputKeyPressed","_onInputKeyDown","_onInputKeyUp","_onInputClick"),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.setInput,this),this.model.bind("next_answer",this.showNextAnswer,this)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.node.html($(html).html()),this.node.toggleClass("prefilled",this.model.isPrefilled()),this.input=this.node.find("input"),this.setInput(),this.adjustPosition(),this.node},adjustPosition:function(){var cellWidth=a5.utils.getCrosswordCellWidth(),borderOffset="px"===cellWidth.unit?1:0;this.node.css("width",_.values(cellWidth).join("")),this.node.css("height",_.values(cellWidth).join("")),this.left=(this.model.x+("inside"===this.parent.cluePosition?1:0))*(cellWidth.width+borderOffset),this.top=(this.model.y+("inside"===this.parent.cluePosition?1:0))*(cellWidth.width+borderOffset),this.node.css({left:this.left+cellWidth.unit,top:this.top+cellWidth.unit})},serializeData:function(){var word1=this.model.allWords[0],word2=this.model.allWords[1];word1&&(word1={cell:word1.cells.indexOf(this.model)+1,index:word1.label,isVertical:word1.isVertical()}),word2&&(word2={cell:word2.cells.indexOf(this.model)+1,index:word2.label,isVertical:word2.isVertical()});var data={word1:word1,word2:word2,tabIndex:this._tabIndexForTags(this.model.tags)};return this.model.label&&"outside"===this.parent.cluePosition&&(data.enumLabel=this.model.label),data},setInput:function(){this.input.attr("disabled",!0),this.input.unbind(),this.node.find(".check").remove(),this.checkLocked(),this.model.isPrefilled()&&this.updateValue(this.model.letter),this.model.isEditable()&&(this.updateValue(this.model.value),this.bindEvents()),this._wordStateChange()},checkLocked:function(){this._super(),this.model.updateFreeze()},setAnswer:function(){this.input.attr("disabled",!0),this.input.unbind(),this.node.find(".check").remove(),_.each(this.model.words,_.bind(function(word){word.prefilled||this.addCheck({correct:word.isCorrect(),classes:[word.align],tooltip:word.getAnswerFeedback(),correctTooltip:!0})},this)),this._wordStateChange()},showAnswer:function(){this.input.attr("disabled",!0),this.input.unbind(),this.node.find(".check").remove(),_.each(this.model.words,function(word){word.isCorrect()||word.prefilled?word.isCorrect()&&!word.prefilled&&this.addCheck({correct:word.isCorrect(),classes:[word.align],tooltip:word.getAnswerFeedback(),correctTooltip:!0}):this.addCheck({empty:!word.isFilled(),classes:[word.align],tooltip:this.parent.uppercase?word.getUserWord().toUpperCase():word.getUserWord()})},this),this.updateValue(this.model.letter),this._wordStateChange()},showNextAnswer:function(word){this.input.attr("disabled",!0),this.input.unbind(),_.contains(this.model.words,word)&&this.addCheck({correct:!1,empty:!0,classes:[word.align],tooltip:word.getAnswerFeedback(),correctTooltip:!0}),this.updateValue(this.model.letter),_.first(word.cells)===this.model&&a5.utils.scrollIntoElementIfNeeded(this.node)},_tabIndexForTags:function(tags){var downTag=_.find(tags,{0:"d"});return downTag?parseInt(downTag.slice(1),10):1},_onInputSpecialCharInserted:function(e){this.goToNextField(1)},_onInputChanged:function(e){this.model.setValue($(e.target).val())},_onInputKeyPressed:function(e){e.preventDefault();var code=e.which;(45===code||code>=48&&code<=57||code>=65&&code<=90||code>=97&&code<=122||code>=128&&code<=1273)&&(this.model.setValue(String.fromCharCode(code)),this.goToNextField(1))},_onInputKeyDown:function(e){9===e.keyCode&&this.goToNextField(e.shiftKey?-1:1)&&e.preventDefault()},_onInputKeyUp:function(e){e.preventDefault();var code=e.keyCode,backSpace=8==code,arrKeys=code>=37&&code<=40;if(backSpace&&this.model.setValue(""),229==code&&(1==this.input.val().length?this.model.setValue(this.input.val()):this.model.setValue(_.last(this.input.val())),this.goToNextField(1)),arrKeys){var xpos=this.model.x,ypos=this.model.y;do{xpos+=[0,-1,0,1][e.keyCode%4],ypos+=[1,0,-1,0][e.keyCode%4];var targetCell=this.model.parent.getCellAt(xpos,ypos);if(targetCell&&!$("div[data-model-id="+targetCell.id+"] input").is(":disabled")){targetCell.focus();break}}while(xpos>=0&&xpos<=this.model.parent.size[0]&&ypos>=0&&ypos<=this.model.parent.size[1]);this.parent.oldDirection=["vertical","horizontal"][e.keyCode%2]}else backSpace&&this.goToNextField(-1)},_onInputClick:function(e){this.parent.oldDirection=null},bindEvents:function(){this.input.attr("disabled",!1),this.input.on("specialchar:inserted",this._onInputSpecialCharInserted),this.input.on("change",this._onInputChanged),this.input.on("keypress",this._onInputKeyPressed),this.input.on("keydown",this._onInputKeyDown),this.input.on("keyup",this._onInputKeyUp),this.input.on("click",this._onInputClick)},_wordStateChange:function(){this.node.removeClass("checked-incorrect checked-correct checked-empty"),this.node.removeClass("solution-incorrect solution-correct solution-empty");var mode="";if("feedback"===this.model.parent.state)mode="checked";else{if("answers"!==this.model.parent.state)return;mode="solution"}this.model.isEmpty()?this.node.addClass(mode+"-empty"):this.model.isPrefilled()||_.each(this.model.allWords,function(word){var state=word.isCorrect()?"correct":"incorrect";this.node.addClass(mode+"-"+state)},this)},goToNextField:function(pos){function getCell(model,x,y){var cell=model.parent.getCellAt(model.x+x,model.y+y);return cell&&!cell.isEditable()&&(cell=model.parent.getCellAt(model.x+2*x,model.y+2*y)),cell}var direction=this.parent.oldDirection,cellRight=getCell(this.model,pos,0),cellBottom=getCell(this.model,0,pos);getCell(this.model,-pos,0),getCell(this.model,0,-pos);direction||(direction=!cellRight&&cellBottom?"vertical":"horizontal");var found=!1;return"horizontal"===direction&&cellRight?(cellRight.focus(),found=!0):"vertical"===direction&&cellBottom?(cellBottom.focus(),found=!0):(direction=this._focusNextWordCell(this.model,direction,pos),direction?found=!0:direction="horizontal"),this.parent.oldDirection=direction,found},_getNextCell:function(direction,words,currentTag,pos){var orderedWords=_.sortBy(words,function(word){return[word.tag[0],parseInt(word.label,10)]}),currentWord=_.findWhere(orderedWords,{tag:currentTag}),nextIndex=_.indexOf(orderedWords,currentWord)+1,nextWord=orderedWords[nextIndex],cell=nextWord&&nextWord.cells[pos>0?0:nextWord.cells.length-1]
;return direction=nextWord&&nextWord.align,[cell,direction]},_focusNextWordCell:function(model,direction,pos){var tag=_(model.tags).find(function(tag){return a5.utils.startsWith(tag,"vertical"===direction?"d":"a")})||model.tags[0],editableWords=model.parent.filterWords({isEditable:!0}),cellAndDirection=this._getNextCell("a"===tag[0]?"horizontal":"vertical",editableWords,tag,pos),cell=cellAndDirection[0];return direction=cellAndDirection[1],cell&&cell.focus(),direction},focus:function(){this.input.focus()},updateValue:function(letter){letter=this.parent.uppercase&&1===letter.toUpperCase().length?letter.toUpperCase():letter,this.input.val(letter),letter.length>0?this.input.addClass("input-filled"):this.input.removeClass("input-filled")}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICCrosswordCell"),a5.views.interaction.ISRadiobuttonView={template:"a5.view.interaction.ISRadioButton",init:function(model,prefill,hideRadios,showInColumns,label){this.showInColumns=showInColumns,this._super(model,prefill,hideRadios),showInColumns&&(this.label=new a5.views.interaction.ISRadiobuttonLabel(label)),this.model.bind("state_update:feedback",this.setAnswer,this)},createViewFor:function(model){return new a5.views.interaction.ISRadiobuttonChoiceView(model,this.showInColumns,this)},setAnswer:function(){this.bindAnswerFeedback(this.model.selected||this.model.correct)},render:function(){return this._super(),this.showInColumns&&(_.first(this.children).node.before(this.label.$node),this.label.render(),this.node.addClass("radiobutton-show-in-columns")),this.node}},a5.views.Radiobutton.extend("a5.views.interaction.ISRadiobuttonView"),a5.views.interaction.ISRadiobuttonChoiceView={contentTemplate:"a5.view.interaction.ISRadioButtonChoice",template:"a5.view.interaction.ISRadioButtonChoiceWrapper",init:function(model,showInColumns,parent){this.showInColumns=showInColumns,this._super(model,parent),this.parent=parent,showInColumns||this.contentNode.find(".is-radiobutton-choice-text").append(model.content.contents()),model.enumeration&&(this.contentNode.prepend('<span class="enum-placeholder"></span>'),model.enumeration.then(function(enumSymbol){this.contentNode.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),model.hasRadiobutton?this.addInput():this.node.addClass("input-noradio"),this.model.parent.prefilled&&(this.disable(),this.model.isCorrectAnswer()&&this.select(!0)),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.tryAgain,this),this.model.parent.bind("input_update:setAnswer",this.setAnswerInput,this),this.updateSelected()},render:function(){return this._super(),this.showInColumns&&this.node.wrapInner("<div class='input-wrapper'></div>"),this.node},updateSelected:function(){if(!this.model.parent.prefilled)return this.model.isSelectedAnswer()?this.select(!0):this.unselect(!0),this.disable(),"input"===this.model.parent.state&&"answers"!==this.model.state&&(this.model.tryAgainIsFrozen&&this.isLocked()||this.enable()),"answers"!==this.model.parent.state&&"answers"!==this.model.state||this.model.isCorrectAnswer()&&this.select(!0),this},select:function(silent){this._super(),this.input?this.input.attr("checked",!0):this.node.addClass("clickedanswer"),this.node.addClass("input-radio-checked"),silent||this.model.select()},unselect:function(silent){this._super(),this.input&&this.input.attr("checked",!1),this.node.removeClass("clickedanswer"),this.node.removeClass("input-radio-checked"),silent||this.model.unselect()},disable:function(){this._super(),this.input&&this.input.attr("disabled",!0)},enable:function(){this._super(),this.input&&this.input.attr("disabled",!1)},onMouseOver:function(e){this._super(),this.node.addClass("input-radio-hover"),this.input||this.node.addClass("input-noradio-hover")},onMouseOut:function(e){this._super(),this.node.removeClass("input-radio-hover"),this.node.removeClass("input-noradio-hover")},addCheck:function(options){var node=this.node;this.node.find(".input-wrapper").length&&(this.node=this.node.find(".input-wrapper"));var check=(options.tooltip,this._super(options));if(this.node=node,options.autoOpen){var interaction=this.getInteractionObject(this.node)||a5.mainBuilder.curInteraction;_.defer(function(inter){inter.isVisibleAndLoaded()&&check.click()},interaction)}},setAnswer:function(){var setCheck=!this.model.parent.prefilled;this.setAnswerCheck(setCheck)},setAnswerInput:function(){this.removeCheck(!this.parent.autoOpenFeedback);var setCheck=!this.model.parent.prefilled&&this.model.parent.isFilled();this.setAnswerCheck(setCheck)},setAnswerCheck:function(check){if(check){var tooltip=this._getFeedbackForTooltip();this.node.toggleClass("has-feedback",!!tooltip),this.parent.node.addClass("active"),this.model.isSelectedAnswer()&&this.addCheck({correct:this.model.parent.isSelectionCorrect(),tooltip:tooltip,correctTooltip:!0,autoOpen:this.parent.isFirstInteractive&&this.parent.autoOpenFeedback})}},showAnswer:function(){if(!this.model.parent.prefilled){var tooltip=this._getFeedbackForTooltip();this.node.toggleClass("has-feedback",!!tooltip),this.parent.node.addClass("active"),this.removeCheck(!this.parent.autoOpenFeedback),this.model.parent.isSelectionCorrect()?this.model==this.model.parent.selected&&this.addCheck({correct:!0,tooltip:tooltip,correctTooltip:!0,state:"answers",autoOpen:this.parent.isFirstInteractive&&this.parent.autoOpenFeedback}):this.model.isCorrectAnswer()?this.addCheck({empty:!0,tooltip:tooltip,state:"answers",autoOpen:this.parent.isFirstInteractive&&this.parent.autoOpenFeedback}):this.model.isSelectedAnswer()&&this.addCheck({correct:!1,tooltip:tooltip,state:"answers",autoOpen:!1})}},tryAgain:function(){this.checkLocked(),this.parent.node.removeClass("active"),this.node.removeClass("has-feedback"),this.removeCheck(!0)},isLocked:function(node){return(node||this.node).siblings().andSelf().filter(".checked-correct-locked").length>0},_getFeedbackForTooltip:function(){return this.model.answerFeedback||this.model.parent.getAnswerFeedback()}},a5.views.RadiobuttonChoiceView.extend("a5.views.interaction.ISRadiobuttonChoiceView"),a5.views.interaction.ISRadiobuttonViewDefault={init:function(model,$radio,isFirstInteractive,isFirst,autoOpenSF,hideRadios,showInColumns,label,interaction){this.$radio=$radio,this.model=model,this.isFirst=isFirst,this.hideRadios=hideRadios,this.showInColumns=showInColumns,this.label=label,this.isFirstInteractive=isFirstInteractive,this.autoOpenFeedback=autoOpenSF,this._addModelEvents(),this._addInteractionEvents(interaction)},_addInteractionEvents:function(interaction){interaction.bind("attemptsChanged",_.bind(this._onAttemptsChanged,this)),interaction.bind("restored",_.bind(this._onInteractionRestored,this))},_onAttemptsChanged:function(attempts){this.model.attempts=attempts.checkAttempts},_onInteractionRestored:function(interaction){this.model.attempts>0&&this._onDisplayAnswer()},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.$radio,{behavior:"smooth",block:"start"})},_addModelEvents:function(){this.model.bind("state_update:feedback",_.bind(this._onDisplayAnswer,this)),this.model.bind("state_update:answers",_.bind(this._onDisplayAnswer,this)),this.model.bind("state_update:input",_.bind(this._onDisplayAnswer,this)),this.model.bind("next_answer",this.onNextAnswer,this)},_onDisplayAnswer:function(){this.$contentblock.show()},addSiblingsListeners:function(){var prevModel=this.isFirst?null:this.model.blockItems[this.model.questionIndex-1],nextModel=this.model.questionIndex<this.model.blockItems.length-1?this.model.blockItems[this.model.questionIndex+1]:null;prevModel&&prevModel.blockId<this.model.blockId&&prevModel.bind("change next_answer",_.bind(this.onPreviousModelChanged,this)),this.model.isDisplayShowNextHidePrev()&&nextModel&&nextModel.blockId>this.model.blockId&&this.model.bind("change next_answer",_.bind(this.onModelChanged,this))},_displayShowHideBehavior:function(){return(this.model.isDisplayShowNext()||this.model.isDisplayShowNextHidePrev())&&0===this.model.attempts},onPreviousModelChanged:function(){this._displayShowHideBehavior()&&!this.$contentblock.is(":visible")&&(this.$contentblock.show(),a5.utils.scrollIntoElementIfNeeded(this.$radio,{behavior:"smooth"}))},onModelChanged:function(){this._displayShowHideBehavior()&&this.$contentblock.hide()},render:function(){return this.$contentblock=this.$radio.is(".contentblock")?this.$radio:this.$radio.parents(".contentblock"),this.$question=this.$contentblock.find("p").first(),this.setActiveRadio(),this._createRadiobuttonView(),this.bindEvents(),this.radioView.render()},bindEvents:function(){},setActiveRadio:function(){this.isFirst&&this.$question.addClass("active");var displayNode=this.isFirst||!this.model.isDisplayShowNext()&&!this.model.isDisplayShowNextHidePrev();this.$contentblock.toggle(displayNode)},showFirstAnswerFeedback:function(){this.isFirst&&this.radioView.showAnswerFeedback&&this.radioView.showAnswerFeedback()},_createRadiobuttonView:function(){this.radioView=new a5.views.interaction.ISRadiobuttonView(this.model,this.model.prefilled,this.hideRadios,this.showInColumns,this.label),this.radioView.isFirstInteractive=this.isFirstInteractive,this.radioView.autoOpenFeedback=this.autoOpenFeedback}},Obj.extend("a5.views.interaction.ISRadiobuttonViewDefault"),a5.views.interaction.ISRadiobuttonViewDisplayAll={bindEvents:function(){this.$contentblock.on("click",_.bind(this._onClick,this))},_onClick:function(){this.$contentblock.siblings().children(".active").removeClass("active"),this.$question.addClass("active")}},a5.views.interaction.ISRadiobuttonViewDefault.extend("a5.views.interaction.ISRadiobuttonViewDisplayAll"),a5.views.interaction.ISRadiobuttonViewDisplayActive={render:function(){var node=this._super();return this.$question.addClass("expandable-question"),node},setActiveRadio:function(){this._super(),this.isFirst||this.$radio.hide()},bindEvents:function(){this.$contentblock.on("click",".expandable-question",_.bind(this._onClickQuestion,this)),this.$contentblock.on("expandable-hide",_.bind(this._onCollapse,this))},showFirstAnswerFeedback:function(){this.isFirst&&this.radioView.showAnswerFeedback&&(this.$contentblock.hasClass("active")||this._show(),this.radioView.showAnswerFeedback())},setAnswer:function(){this.radioView.setAnswer();var $check=this.$radio.find(".check:first").clone();$check.off("click").on("click",_.bind(function(){this.$contentblock.hasClass("active")||this._show(),this.radioView.showAnswerFeedback()},this)),this.$contentblock.append($check)},setInput:function(){this.$contentblock.find(".check").remove()},_onClickQuestion:function(e){this.$question.hasClass("active")?this._hide():this._show()},_onCollapse:function(){this._hide()},_hide:function(){this.$question.removeClass("active"),this.$contentblock.find(".view-text-active").removeClass("view-text-active"),this.$contentblock.find(".view-text").hide(),this.$radio.hide()},_show:function(){this._hideSiblings(),this.$question.addClass("active"),this.$radio.show()},_hideSiblings:function(){this.$contentblock.siblings(":has(.active)").trigger("expandable-hide")}},a5.views.interaction.ISRadiobuttonViewDefault.extend("a5.views.interaction.ISRadiobuttonViewDisplayActive"),a5.views.interaction.ISRadiobuttonLabel={init:function(label){this.$node=$("<div class='radiobutton-column-label'></div>").append(label)},render:function(){return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRadiobuttonLabel"),a5.views.interaction.ISRadiobuttonHeader={init:function(answers){this.$node=$("<div class='radiobutton-column-header'><div class='header-spacer'></div></div>"),this.answers=answers},render:function(){for(var i=0;i<this.answers.length;i++){var $answerCell=$("<div class='answer-cell'></div>").append(this.answers[i]);this.$node.append($answerCell)}return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRadiobuttonHeader"),a5.views.interaction.ISRadiobuttonColumnsLabel={init:function(label){this.$node=$("<div class='radiobutton-column-header'><div class='header-spacer'></div><div class='label-placeholder'></div></div>"),label.then(function(label){this.$node.find(".label-placeholder").replaceWith(label)}.bind(this))},render:function(){return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRadiobuttonColumnsLabel"),a5.views.interaction.ISRadiobuttonColumnsHeader={init:function(answers){this.$node=$("<div class='radiobutton-column-label'><div class='answer-label'>&nbsp;</div></div>"),this.answers=answers},render:function(){for(var i=0;i<this.answers.length;i++)this.$node.append("<div class='answer-cell'>"+this.answers[i]+"</div>");return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRadiobuttonColumnsHeader"),a5.views.interaction.ISRadiobuttonColumnsView={template:"a5.view.interaction.ISRadioButtonColumns",init:function(model,prefill,hideRadios,label,enumeration){this._super(model,prefill,hideRadios),this.enumeration=enumeration,this.children.unshift(new a5.views.interaction.ISRadiobuttonColumnsLabel(label)),a5.callbacks.interaction.bind("showed",this.adjustSize,this),this.bindEvents()},render:function(){return this._super(),this.enumeration&&this.enumeration.then(function(enumSymbol){this.node.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}.bind(this)),this.node},bindEvents:function(){this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:input",this.setInput,this),this.node.on("click focus",_.bind(this._onClick,this))},adjustSize:function(){var labels=this.node.siblings(".radiobutton-column-label").find(".answer-cell"),cells=this.node.find(".input-radio");_.each(cells,function(cell,index){$(cell).height($(labels[index]).height())})},createViewFor:function(model){return new a5.views.interaction.ISRadiobuttonColumnsChoiceView(model,this)},setInput:function(){this.node.find(".check").remove()},setAnswer:function(){this.model.selected||this.model.prefilled||this.addCheck({correct:!1}),this.bindAnswerFeedback(this.model.selected||this.model.correct)},_onClick:function(e){$(".clicked-question").removeClass("clicked-question"),this.node.addClass("clicked-question")}},a5.views.Selectable.extend("a5.views.interaction.ISRadiobuttonColumnsView"),a5.views.interaction.ISRadiobuttonColumnsChoiceView={contentTemplate:"a5.view.interaction.ISRadioButtonColumnsChoice",template:"a5.view.interaction.ISRadioButtonColumnsChoiceWrapper",init:function(model,parent){this._super(model,parent),this.parent=parent,model.hasRadiobutton?(this.addInput(),this.model.parent.prefilled&&(this.input.attr("disabled",!0),this.model.isCorrectAnswer()&&(this.input.attr("checked",!0),this.node.attr("aria-checked",!0)))):(this.node.addClass("input-noradio"),this.model.parent.prefilled&&this.model.isCorrectAnswer()&&this.node.addClass("clickedanswer")),model.radiobuttonIsCustom&&this.node.addClass("input-radio-custom"),this.model.parent.bind("state_update:feedback",this.setAnswer,this),this.model.parent.bind("state_update:answers",this.showAnswer,this),this.model.parent.bind("state_update:input",this.tryAgain,this),this.updateSelected()},render:function(){return this._super(),this.node.wrapInner("<div class='input-wrapper'></div>"),this.node},updateSelected:function(){this.model.parent.prefilled||this._super()},addFeedbackCheck:function(){this.addCheck({correct:this.model.parent.isCorrect(),tooltip:this.model.parent.getAnswerFeedback(),correctTooltip:!0})},setAnswer:function(){this.model.parent.prefilled||(this.parent.node.addClass("active"),this.model.isCorrectAnswer()&&this.model.parent.isCorrect()&&this.addFeedbackCheck(),this.model.isSelectedAnswer()&&!this.model.parent.isCorrect()&&this.addFeedbackCheck())},showAnswer:function(){this.model.parent.prefilled||(this.parent.node.addClass("active"),this.node.find(".check").remove(),this.model.parent.isCorrect()?this.model.isSelectedAnswer()&&this.model.parent.isCorrect()&&this.addCheck({correct:!0}):this.model.isCorrectAnswer()?this.addCheck({empty:!0}):this.model.isSelectedAnswer()&&this.addCheck({correct:!1}))},tryAgain:function(){this.parent.node.removeClass("active"),this.node.find(".check").remove()}},a5.views.RadiobuttonChoiceView.extend("a5.views.interaction.ISRadiobuttonColumnsChoiceView"),a5.views.interaction.ColouringView={init:function(model,parent){this._super(model,parent,$('<div class="iwt"/>'));var container=$('<div class="colouring_view" id="colouring_view'+model.interaction.index+'"/>').appendTo(this.node);this.contentBlock=$('<div class="block"/>').appendTo(container),this._bindEvents()},render:function(){return this.paper||this._drawSVG(),this.toolbar=new a5.views.interaction.ColouringToolbar(this.model,this),"bottom"==this.model.poolAlign?this.node.children(".colouring_view").append(this.toolbar.render()):this.node.prepend(this.toolbar.render()),this.node.addClass(this.toolbar.getAlignmentClass()),this.contentBlock.width(this.node.find("img").first().width()),this.node.css("visibility","hidden"),this.node.find("img").load(_.bind(function(){this.node.css("visibility","")},this)),this.node},updateState:function(){this.paper?_.each(this.model.items,function(item,name){this._fill(item.set,item.color,item.opacity)},this):this._drawSVG()},setAnswer:function(){this.node.find(".eraser.highlighter_selected").length&&this.node.find(".highlighter:eq(0)").click(),_.each(this.model.items,function(item){if(!item.prefilled){var bb=item.set.getBBox(),x=(bb.x+bb.x2)/2,y=(bb.y+bb.y2)/2;item.distractor?this.addCheck({parent:this.canvas,correct:!item.isFilled(),classes:["dst"]}):this.addCheck({parent:this.canvas,correct:item.isCorrect(),classes:["ans"]});var check=this.canvas.find(".check:last");item.isFilled()||check.hide(),check.is(".correct.dst")&&check.hide(),check.css({left:x-check.outerWidth()/2,top:y-check.outerHeight()/2})}},this)},showAnswer:function(){_.each(this.model.items,function(item){this._addChecksForItem(item),this._showAnswerForItem(item)},this)},showNext:function(item){this._addChecksForItem(item),this._showAnswerForItem(item);var bb=item.set.getBBox();window.scrollTo(0,bb.y)},_addChecksForItem:function(item){if(!item.prefilled){var bb=item.set.getBBox(),x=(bb.x+bb.x2)/2,y=(bb.y+bb.y2)/2;item.distractor?this.addCheck({parent:this.canvas,correct:!item.isFilled(),classes:["dst"]}):this.addCheck({parent:this.canvas,correct:item.isCorrect(),empty:!item.isFilled(),classes:["ans"]});var check=this.canvas.find(".check:last");check.is(".correct.dst")&&check.hide(),check.css({left:x-check.outerWidth()/2,top:y-check.outerHeight()/2})}},_showAnswerForItem:function(item){item.distractor?this._fill(item.set,"white",this.model.OPACITY_EMPTY):this._fill(item.set,item.correctColor,1)},tryAgain:function(){_.each(this.model.items,function(item){this.model.tryAgainKeep||item.isCorrect()||(item.color="white",item.opacity=this.model.OPACITY_EMPTY,this._fill(item.set,"white",this.model.OPACITY_EMPTY))},this),this.canvas.find(".check").remove()},_bindEvents:function(){this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.tryAgain,this),this.model.bind("show-next",this.showNext,this)},_drawSVG:function(){this._addSVG(),_.each(this.model.items,function(item){var set=this.paper.set(),shapes=$(a5.utils.decodeHTMLSpecialChars(item.areas)),self=this;item.set=set,shapes.each(function(i,shape){set.push(self._setupShape(shape,item.prefilled,item.identifier))}),item.color&&item.opacity==item.parent.OPACITY_FILL&&this._fill(set,item.color,item.opacity),item.prefilled||set.click(function(){"answers"!==item.state&&self._colorizeGroup(item.identifier)})},this)},_addSVG:function(){var img=this.$("img:first"),id="colouring"+this.model.interaction.index;this.canvas=$('<div class="canvas" id="'+id+'"/>').insertBefore(img);var x=parseInt(img.css("width"),10),y=parseInt(img.css("height"),10);0==x&&(x=600),0==y&&(y=600),this.paper=Raphael(id,x,y),this.canvas.on("keydown",function(ev){var key=ev.which;if(key===a5.utils.keyCodes.SPACE||key===a5.utils.keyCodes.ENTER){var identifier=$(ev.target).data("identifier"),item=_.find(this.model.items,{identifier:identifier});item&&"answers"!==item.state&&this._colorizeGroup(identifier)}}.bind(this))},_setupShape:function(shape,prefilled,identifier){var method,params,res,coords=$(shape).attr("coords").split(",");switch($(shape).attr("shape")){case"rect":params=this._coordRect(coords[0],coords[1],coords[2],coords[3]),method=this.paper.rect;break;case"circle":params=coords,method=this.paper.circle;break;case"poly":var pathString="M";_.each(coords,function(v,index){index%2==0&&index>0&&(pathString+="L"),pathString+=v+" "}),pathString+="L"+coords[0]+" "+coords[1],params=[pathString],method=this.paper.path}return res=method.apply(this.paper,params).attr({stroke:"none",fill:"white",opacity:this.model.OPACITY_EMPTY,cursor:prefilled?"":"pointer"}),$(res[0]).data("identifier",identifier),prefilled&&res.node.setAttribute("class","prefilled"),res},_fill:function(set,color,opacity){set.attr({fill:color,opacity:opacity})},_colorizeGroup:function(code){this.model.interaction.interactionDone||(this._fill(this.model.items[code].set,this.model.color,this.model.opacity),this.model.items[code].opacity=this.model.opacity,this.model.items[code].color=this.model.color,a5.mainBuilder.updateScoresAsync())},_coordRect:function(x,y,x2,y2){return[x,y,x2-x,y2-y]}},a5.views.interaction.BaseView.extend("a5.views.interaction.ColouringView"),a5.views.interaction.ColouringToolbar={init:function(model,parent){var toolbarTmpl=window.a5.mainBuilder.layout.getTemplate("highlighter_toolbar");this._super(model,parent,$(a5.mainBuilder.layout.replaceSubpart(toolbarTmpl,"highlighter_toolbar_item",'<div id="itemWrapper"></div>'))),this.buttons=[],this._bindEvents(),this.node.addClass(this.getAlignmentClass())},render:function(){var colors=[],items=_.filter(this.model.items,function(item){return!item.distractor});return items=_.values(items).concat(this.model.distractorColors),items=_.sortBy(items,"identifier"),_.each(items,function(item){_.include(colors,item.correctColor)||item.distractor||(colors.push(item.correctColor),this.buttons.push(new a5.views.interaction.ColouringToolbarItem(item,this,item.correctColor).render())),item.distractor&&this.buttons.push(new a5.views.interaction.ColouringToolbarItem(item,this,item.color).render())},this),this.buttons.push(new a5.views.interaction.ColouringToolbarItem(null,this,"").render()),this.$("#itemWrapper").append(this.buttons).children().unwrap(),this.$(".highlighter:first").click(),this.node},getAlignmentClass:function(){return"align-"+this.model.poolAlign},updateState:function(){},_bindEvents:function(){var self=this;this.node.on("click",".highlighter",function(){self.model.interaction.interactionDone||(self.$(".highlighter").removeClass("highlighter_selected"),$(this).addClass("highlighter_selected"),self.model.color=$(this).data("color"),$(this).is(".eraser")?(self.model.opacity=self.model.OPACITY_EMPTY,$("body").addClass("erasing")):(self.model.opacity=self.model.OPACITY_FILL,$("body").removeClass("erasing")))}),this.node.on("keydown",".highlighter",function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||$(this).click()}),this.model.interaction.bind("hide",function(){$("body").removeClass("erasing")}),this.model.interaction.bind("show",function(){$("body").toggleClass("erasing",this.$(".toolbar .eraser").is(".highlighter_selected"))},this.model.interaction)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ColouringToolbar"),a5.views.interaction.ColouringToolbarItem={init:function(model,parent,color){var toolbarTmpl=a5.mainBuilder.layout.getTemplate("highlighter_toolbar"),itemTmpl=a5.mainBuilder.layout.getSubpart(toolbarTmpl,"highlighter_toolbar_item");a5.service.templates.enableOnlyCachedMode();var eraserTmpl=a5.service.templates.render("a5.view.toolbar.erase");a5.service.templates.disableOnlyCachedMode(),null!=model?(this.model=model,this._super(model,parent,$(a5.mainBuilder.layout.replaceSubpart(itemTmpl,"highlighter_toolbar_item_caption",model.label))),this.node.data("color",color).find("span").css({backgroundColor:color})):(this._super(model,parent,$(a5.mainBuilder.layout.replaceSubpart(itemTmpl,"highlighter_toolbar_item_caption",$(eraserTmpl).text()||"Erase"))),this.node.data("color","white").addClass("eraser").find("span").css({backgroundColor:"white"}),this.node.attr("title",$(eraserTmpl).attr("title")))}},a5.views.interaction.BaseView.extend("a5.views.interaction.ColouringToolbarItem"),a5.views.interaction.TargetGameView={init:function(obj,index,builder,interaction){this.identifier=$(obj).attr("identifier"),this.correctResponse=builder.correctResponse.values[0];var str=window.a5.mainBuilder.layout.getTemplate("tgm_panel");this.model=obj,this.step=builder.step,this.node=$("<div/>"),this.node.append(str),this.node.addClass("card"),this.node.addClass("card_"+index),this.node.find(".front td p").html($(obj).text()),builder.correctResponse.values[0]==$(obj).attr("identifier")&&this.node.find(".click").addClass("click_correct")},render:function(){return this.node},isCorrect:function(){return this.correctResponse==this.identifier}},Obj.extend("a5.views.interaction.TargetGameView"),a5.views.interaction.ISCatchView={NODE_TEMPLATE:"<div class='is-catch-wrapper custom-image'><div class='is-catch-target-wrapper'><div class='is-catch-gameover'/><div class='is-catch-board'/><div class='is-catch-target-generator custom-image'/></div></div>",THROTTLE_WAIT:300,activeModel:null,init:function(model,parent,interaction){this.activeModelIndex=0,this._super(model,parent,$(this.NODE_TEMPLATE)),interaction.bind("show:deferred",this.onStart,this,{once:!0}),interaction.bind("show:deferred interaction:dialog:close",this.resume,this),interaction.bind("hide interaction:dialog:display",this.pause,this),interaction.bind("reset",this.onReset,this),this.interaction=interaction},bindMethods:function(){_.bindAll(this,"onFinishQuestion","onEndGameByTimer","onAnimationFrame","resume","onFeedback","pause","onStageResized"),this.model.bind("state_update:feedback",this.onFeedback),this._animation=a5.utils.requestAnimationFrame(this.onAnimationFrame)},onAnimationFrame:function(time){a5.utils.requestAnimationFrame(this.onAnimationFrame),TWEEN.update(time)},renderStage:function(){this.renderBackground(),this.renderTargetGenerator(),this.renderBoard()},renderBackground:function(){this.model.targetsConfiguration.backgroundImage?this.node.css("background-image","url("+A5.ASSET_URL_BUILDER(this.model.targetsConfiguration.backgroundImage)+")"):this.node.removeClass("custom-image")},renderTargetGenerator:function(){var generator=this.node.find(".is-catch-target-generator");if(this.model.targetsConfiguration.targetGeneratorImage){var css={};css["background-image"]="url("+A5.ASSET_URL_BUILDER(this.model.targetsConfiguration.targetGeneratorImage)+")",generator.css(css)}else generator.removeClass("custom-image");var className="generator-"+this.model.targetsConfiguration.targetGeneratorX+"-"+this.model.targetsConfiguration.targetGeneratorY;this.node.addClass(className);var offsetX=0,offsetY=0;if(this.model.targetsConfiguration.targetGeneratorOrigin){var offset=a5.utils.splitAndTrim(this.model.targetsConfiguration.targetGeneratorOrigin,",");offsetX=parseFloat(offset[0]),offsetY=parseFloat(offset[1])}this.model.targetsConfiguration.origin={offsetX:offsetX,offsetY:offsetY},this.setOriginPositionSize(),$(window).on("resize",_.throttle(this.onStageResized,this.THROTTLE_WAIT))},setOriginPositionSize:function(){var origin=this.model.targetsConfiguration.origin,$node=this.node.find(".is-catch-target-generator");origin.left=$node.position().left,origin.top=$node.position().top,origin.width=$node.width(),origin.height=$node.height()},renderBoard:function(){if(this.model.stageConfiguration.countdownTimer||this.model.stageConfiguration.scoreboard){var boardTemplate=a5.service.templates.render("a5.view.is_catch_ScoreBoard",{score:this.model.stageConfiguration.scoreboard,timer:this.model.stageConfiguration.countdownTimer});this.node.find(".is-catch-board").append(boardTemplate).show()}else this.node.find(".is-catch-board").hide()},renderGameOver:function(reason){var messageText,template,dialogClass;switch(reason){case"time":template="a5.view.is_catch_TimeUp",dialogClass="time-up-dialog";break;default:template="a5.view.is_catch_GameOver",messageText=this.model.stageConfiguration.gameOverMessage,dialogClass="game-over-dialog"}a5.view.dialog.display(template,{text:messageText,dialogClass:dialogClass})},initQuestion:function(){this.renderTargetManager(),this.targetsManager.initTargets()},renderTargetManager:function(){this.targetsManager=new a5.views.interaction.ISCatchTargetManager(this.getActiveModel(),this,this.model.targetsConfiguration),this.node.find(".is-catch-target-wrapper").prepend(this.targetsManager.render()),this.getActiveModel().inputState(),this.getActiveModel().bind("state_update:feedback",this.onFinishQuestion)},initCountdown:function(){if(this.model.stageConfiguration.maxDuration){if(this.countdownTimer=new a5.views.interaction.ISCatchTimerManager(this.model,this),this.countdownTimer.bind("timer:end",this.onEndGameByTimer),this.model.stageConfiguration.countdownTimer){var node=this.node.find(".is-catch-board").find(".is_catch_board_timer")[0]||this.node.find(".is-catch-board");$(node).append(this.countdownTimer.render())}this.countdownTimer.initCountdown()}},initScore:function(){if(this.model.stageConfiguration.scoreboard){this.scoreManager=new a5.views.interaction.ISCatchScoreManager(this.model,this);var node=this.node.find(".is-catch-board").find(".is_catch_board_score")[0]||this.node.find(".is-catch-board");$(node).append(this.scoreManager.render()),this.scoreManager.initScore()}},onStart:function(){this.bindMethods(),this.renderStage(),this.initQuestion(),this.initCountdown(),this.initScore(),this.interaction.activityTimer.stamp(),this._updateActivityDurationOnce=_.once(_.bind(this.interaction.updateActivityDuration,this.interaction))},onFinishQuestion:function(){this.trigger("question_finished"),this.setNextActiveModel()?this.initQuestion():this.finishInteraction("answers")},onFeedback:function(evt){this.finishInteraction()},onReset:function(){this.finishInteraction()},onEndGameByTimer:function(){_.each(this.model.unstagedQuestions(),function(model){model.setAnswer()}),this.finishInteraction("time")},onStageResized:function(){this.paused||this.setOriginPositionSize()},finishInteraction:function(reason){this.killAll(),reason&&(this.renderGameOver(reason),this.model.setAnswer())},killAll:function(){this.getActiveModel().unbind("state_update:feedback",this.onFinishQuestion),this.targetsManager.finishQuestion(),this.countdownTimer&&this.countdownTimer.stop(),this.scoreManager&&this.scoreManager.stopScore(),this._updateActivityDurationOnce()},pause:function(){this.paused||(this.paused=!0,this.targetsManager&&this.targetsManager.pause(),this.countdownTimer&&this.countdownTimer.pause())},resume:function(){this.paused&&(this.paused=!1,this.onStageResized(),this.targetsManager&&this.targetsManager.resume(),this.countdownTimer&&this.countdownTimer.resume())},getActiveModel:function(){return this.model.models[this.activeModelIndex]},setNextActiveModel:function(){return this.getActiveModel().unbind("state_update:feedback"),!!(this.activeModelIndex<this.model.models.length-1&&this.model.unstagedQuestions().length)&&(this.activeModelIndex++,!0)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchView"),a5.views.interaction.ISCatchMessage={NODE_TEMPLATE:"a5.view.iscatchMessage",init:function(model,parent,message){this._super(model,parent)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchMessage"),a5.views.interaction.ISCatchTimerManager={
NODE_TEMPLATE:'<div class="is-catch-timer"/>',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.bindMethods()},bindMethods:function(){_.bindAll(this,"onSecondChanged","onTimerEnd")},initCountdown:function(){var timerCallback,remaining;this.model.stageConfiguration.countdownTimer?(this.currentSecond=this.model.stageConfiguration.maxDuration,timerCallback=this.onSecondChanged,remaining=1e3,this.renderTime()):(timerCallback=this.onTimerEnd,remaining=1e3*this.model.stageConfiguration.maxDuration),this.timer=new a5.utils.TimerOut(remaining,timerCallback)},renderTime:function(){this.node.html(a5.utils.secondsToTime(this.currentSecond,!0))},onSecondChanged:function(){this.currentSecond--,this.renderTime(),0===this.currentSecond?this.onTimerEnd():this.timer.reset()},onTimerEnd:function(){this.start=null,this.trigger("timer:end")},stop:function(){this.timer.stop()},pause:function(){this.timer.pause()},resume:function(){this.timer.resume()}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchTimerManager"),a5.views.interaction.ISCatchScoreManager={NODE_TEMPLATE:'<div class="is-catch-score"/>',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.updateScore(),this.bindMethods()},bindMethods:function(){_.bindAll(this,"updateScore","setTargetListener","removeTargetListener")},initScore:function(){_.each(this.model.allTargets(),this.setTargetListener)},setTargetListener:function(target){target.bind("state_update:feedback",this.updateScore)},updateScore:function(){var currScore=this.model.getScores();this.node.html(currScore.correct+"/"+currScore.total)},stopScore:function(){_.each(this.model.allTargets(),this.removeTargetListener)},removeTargetListener:function(target){target.unbind("state_update:feedback",this.updateScore)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchScoreManager"),a5.views.interaction.ISCatchTargetManager={THROTTLE_WAIT:a5.views.interaction.ISCatchView.prototype.THROTTLE_WAIT,init:function(model,parent,options){this._super(model,parent,$('<div class="is-catch-target-container"></div>')),this.parent=parent,this.config=this.prepareOptions(options),this.bindMethods(),this.model.bind("state_update:input",this.onInput),this.timer=new a5.utils.TimerOut(this.generationSpeed(!0),this.initTargets,!1)},bindMethods:function(){_.bindAll(this,"onInput","initTargets","onViewExploded","onStageResized")},prepareOptions:function(options){return options.maxItems=options.maxItems||this.model.targets.length,options.maxItems=Math.min(options.maxItems,this.model.targets.length),options},render:function(){return $(window).on("resize",_.throttle(this.onStageResized,this.THROTTLE_WAIT)),this._super()},initTargets:function(){if(!this.timer.isRunning()){var nextTarget=this.getNextViableTarget();nextTarget&&(this.createTarget(nextTarget),nextTarget.display(),this.timer.reset())}},createTarget:function(target){0===this.node.width()||0===this.node.height()?_.defer(_.bind(function(){this.createTarget(target)},this)):this.renderTarget(target)},renderTarget:function(target){var origin=this.config.targetGeneratorY+this.config.targetGeneratorX,config={stageWidth:this.node.width(),stageHeight:this.node.height(),speed:this.config.movementSpeed,targetImage:this.config.targetImage,selectedTargetImage:this.config.selectedTargetImage,targetDuration:this.config.targetDuration,origin:this.config.origin},targetView=new a5.views.interaction.ISCatchTargetView(target,this,config,origin),node=targetView.render();targetView.bind("exploded",this.onViewExploded),this.node.append(node),targetView.initTween(),this.targetViews.push(targetView),a5.eventBus.trigger("is-catch:target:rendered",node)},getNextViableTarget:function(){var tobeDisplayed=this.model.tobeDisplayed(),leftToDisplayAmount=this.config.maxItems-this.targetViews.length,displayingCorrect=this.model.displayingCorrect(),tobeDisplayedCorrect=this.model.tobeDisplayedCorrect(),displayingAmount=this.targetViews.length;if(this.config.maxItems>displayingAmount){if(1===leftToDisplayAmount&&0===displayingCorrect.length&&tobeDisplayedCorrect.length)return tobeDisplayedCorrect[0];if(tobeDisplayed.length)return tobeDisplayed[0]}else;},generationSpeed:function(miliseconds){var offset=4;switch(this.config.generationSpeed){case"slow":offset=7;break;case"medium":offset=4;break;case"fast":offset=1}var seconds=2*Math.random()+offset;return miliseconds&&(seconds*=1e3),seconds},onStageResized:function(evt){if(!this.parent.paused){var width=this.node.width(),height=this.node.height();_.each(this.targetViews,function(targetView){targetView.onStageResized(width,height)})}},onInput:function(){_.invoke(this.targetViews,"resetView"),this.targetViews=[]},onViewExploded:function(targetView){var index=this.targetViews.indexOf(targetView);index<0||(this.targetViews.splice(index,1),targetView.unbind("exploded"),this.model.tobeDisplayedCorrect().length+this.model.displayingCorrect().length===0?this.finishQuestion():(this.targetViews.length||this.timer.stop(),this.initTargets()))},pause:function(){_.invoke(this.targetViews,"pause"),this.timer.pause()},resume:function(){this.onStageResized(),_.invoke(this.targetViews,"resume"),this.timer.resume()},finishQuestion:function(){_.invoke(this.targetViews,"unbind"),_.invoke(this.targetViews,"onFeedback"),this.model.setAnswer(),this.node.remove(),this.timer.stop()}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchTargetManager"),a5.views.interaction.ISCatchTargetView={init:function(model,parent,config,origin){this._super(model,parent,$('<div class="is-catch-target"><div class="is-catch-target-content"/></div>')),this.parent=parent,this.config=config,this.setRandomAngle(origin),this.setRandomSpeed(),this.renderBackground(),this.renderContent(),this.bindMethods(),this.createTimer(),this.node.unbind("click"),this.node.on("click",this.onClick),this.model.bind("state_update:feedback",this.onFeedback),this.model.bind("state_update:expired",this.onExpired)},bindMethods:function(){_.bindAll(this,"onFeedback","onExpired","expire","onBounce","onClick")},createTimer:function(){this.config.targetDuration&&(this.timer=new a5.utils.TimerOut(1e3*this.config.targetDuration,this.expire))},renderBackground:function(){this.config.targetImage&&(this.node.css("background-image","url("+A5.ASSET_URL_BUILDER(this.config.targetImage)+")"),this.node.addClass("custom-image"))},renderSelectedBackground:function(){this.config.selectedTargetImage&&(this.node.css("background-image","url("+A5.ASSET_URL_BUILDER(this.config.selectedTargetImage)+")"),this.node.addClass("custom-image"))},renderContent:function(){var $content=$($.parseHTML(this.model.value));$content.is("img")?(this.node.addClass("has-img"),a5.utils.buildModel(a5.mainBuilder.curInteraction,this.node.find(".is-catch-target-content"),$content,!0)):this.node.find(".is-catch-target-content").text(this.model.value),_.defer(_.bind(function(){this.node.addClass("spawn"),this.resizeTextAndCenter(this.node.find(".is-catch-target-content"))},this))},resizeTextAndCenter:function(node){var parentW=node.parent().width(),parentH=node.parent().height(),scale=Math.min(parentH/node.height(),parentW/node.width());scale<1?node.zoom(scale):scale=1;var left=(parentW-scale*node.width())/2,top=(parentH-scale*node.height())/2;node.css({top:top,left:left})},initTween:function(){0===this.node.width()||0===this.node.height()?_.defer(_.bind(function(){this.initTween()},this)):this.positionAndTween()},positionAndTween:function(){this.setBounceRectangle();var top=(this.config.origin.height-this.node.height())/2+this.config.origin.offsetY,left=(this.config.origin.width-this.node.width())/2+this.config.origin.offsetX;top+=this.config.origin.top,left+=this.config.origin.left,this.node.css({top:top,left:left}),this.createMovementTween({y:top,x:left})},createMovementTween:function(from){if(!_.isUndefined(this.angle)){var dest={x:this.directionQuad("left")?this.bounceRectangle.right:this.bounceRectangle.left,y:this.directionQuad("top")?this.bounceRectangle.bottom:this.bounceRectangle.top};this.position={x:from&&from.x||this.node.position().left,y:from&&from.y||this.node.position().top};var speed;speed=a5.dp.config.catchGameMovementSpeed?1e3*a5.dp.config.catchGameMovementSpeed/Math.pow(2,this.speed):this.getBounceArea()/(100*Math.pow(2,this.speed)),dest=a5.utils.trignHelper.DESTINATION_FROM_ANGLE(this.radAngle(),speed,this.position,dest);var node=this.node;this._tween=new TWEEN.Tween(this.position).to(dest,1e3*dest.time).onUpdate(function(){$(node).css({left:this.x,top:this.y})}).onComplete(this.onBounce).start()}},onBounce:function(){this.angle=a5.utils.trignHelper.BOUNCE_ANGLE(this.bounceRectangle,this.position,this.angle),this.createMovementTween()},onClick:function(){this.model.setAnswer(),this._triggerEventBus()},expire:function(){this.model.expire()},killTweens:function(){this._tween&&this._tween.stop()},onFeedback:function(){var classToAdd=this.model.isCorrect?"correct":"wrong";this.node.addClass(classToAdd),this.die()},_triggerEventBus:function(){this.model.isCorrect?a5.eventBus.trigger("is-catch:success"):a5.eventBus.trigger("is-catch:failure")},onExpired:function(){this.node.addClass("expired"),this.die()},die:function(){this.node.addClass("popped"),this.renderSelectedBackground(),this.killTweens(),this.trigger("exploded",this),this.node.off("click",this.onClick),this.timer&&this.timer.stop(),this.node.bind("webkitTransitionEnd transitionend",function(evt){$(evt.currentTarget).remove()})},onStageResized:function(stW,stH){this.config.stageWidth=stW,this.config.stageHeight=stH,this.setBounceRectangle(),this.killTweens(),this.position.x=Math.min(this.position.x,stW-this.node.width()),this.position.y=Math.min(this.position.y,stH-this.node.height()),this.createMovementTween({x:this.position.x,y:this.position.y})},resetView:function(){this.model.initState(),this.node.remove()},pause:function(){this.killTweens(),this.timer&&this.timer.pause()},resume:function(){this._tween?(this.killTweens(),this.createMovementTween()):this.initTween(),this.timer&&this.timer.resume()},setRandomAngle:function(origin){var offset=(a5.utils.trignHelper.RECT_ANG-70)/2,quad=a5.utils.trignHelper.QUADRANTS[origin.toUpperCase()];this.angle=Math.round(70*Math.random())+offset+quad*a5.utils.trignHelper.RECT_ANG},setRandomSpeed:function(){var offset,range;switch(this.config.speed){case"slow":offset=5,range=.5;break;case"medium":offset=4.5,range=.3;break;case"fast":offset=4,range=.1}this.speed=Math.ceil(Math.random()*range)+offset+range/2},setBounceRectangle:function(){var w=this.node.width(),h=this.node.height();this.bounceRectangle={top:0,left:0,bottom:this.config.stageHeight-h,right:this.config.stageWidth-w}},radAngle:function(){return a5.utils.trignHelper.DEGR_TO_RAD(this.angle)},quad:function(){return a5.utils.trignHelper.DEGR_TO_QUAD(this.angle)},directionQuad:function(type){var quadName=a5.utils.trignHelper.QUAD_TO_NAME(this.quad());if(quadName)return quadName.toLowerCase().indexOf(type.toLowerCase())>=0},getBounceArea:function(){return this.config.stageWidth*this.config.stageHeight}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchTargetView"),a5.views.interaction.BaseDropdownView={PREFILL_TEMPLATE:'<span class="prefill drop-label"></span>',init:function(model,parent){this._super(model,parent,$('<div class="wrapper-dropdown"></div>')),this.model.bind("update-selected",_.bind(this.updateSelection,this))},render:function(){return this.model.prefill?(this.$dropdown=$(this.PREFILL_TEMPLATE),this.$dropdown.append(this._getPrefill())):(this.$dropdown=$(this.DROPDOWN_TEMPLATE),this.$label=this.$dropdown.find("span:first"),this.$popup=this.$dropdown.find(".popup"),this.$close=this.$popup.find("span.popup-close"),this.$label.attr("style",this.model.labelStyle),this.model.placeholder&&this.$label.html(this.model.placeholder),this.bindEvents()),this.node.append(this.$dropdown),this.node},adjustSameLongestWidth:function(){},bindEvents:function(){this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswers,this),this.model.bind("state_update:input",this.setInput,this),this.model.bind("input_update:setAnswer",this.setAnswerInput,this),this.model.bind("next_answer",this.onNextAnswer,this)},updateSelection:function(){this.model.prefill||(this.$label.empty(),this.model.selected?(this.$label.append(this.model.selected.content.clone()),this.node.addClass("filled")):(this.model.placeholder?this.$label.html(this.model.placeholder):this.$label.html("&nbsp;"),this.node.removeClass("filled")))},hide:function(){this.node.css("visibility","hidden")},show:function(){this.node.css("visibility","")},setAnswer:function(){var setCheck=!this.model.prefill;this.setAnswerCheck(setCheck)},setAnswerInput:function(){var setCheck=!this.model.prefill&&this.model.selected;this.setAnswerCheck(setCheck)},setAnswerCheck:function(check){this.node.find(".check").remove(),this.updateFeedbackState(this.$dropdown),check&&(this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.selected?this.model.selected.getAnswerFeedback():this.model.getAnswerFeedback(),correctTooltip:!0}),this.bindAnswerFeedback(this.model.selected))},showAnswers:function(){if(this.node.find(".check").remove(),this.updateFeedbackState(this.$dropdown),!this.model.prefill){var correct=this.model.allowRepeat?this.model.getCorrect():this.model.findNextCorrect();this.model.selected?this.model.isCorrect()?this.model.isCorrect()&&(this.addCheck({correct:!0,tooltip:!!a5.dp.config.displayFeedbackAfterSeeAnswer&&this.model.getCorrect().getAnswerFeedback()}),correct=this.model.selected):this.addCheck({wrong:!0,tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getCorrect().getAnswerFeedback():this.model.selected.content}):this.addCheck({empty:!0,tooltip:!!a5.dp.config.displayFeedbackAfterSeeAnswer&&this.model.getCorrect().getAnswerFeedback()}),this.$label.html(correct.content.clone()),this.bindAnswerFeedback(correct)}},setInput:function(){this.node.find(".check").remove(),this.updateFeedbackState(this.$dropdown)},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},_getPrefill:function(){return this.model.getCorrect().content}},a5.views.interaction.BaseView.extend("a5.views.interaction.BaseDropdownView"),a5.views.interaction.ISNativeDropdownView={DROPDOWN_TEMPLATE:'<div class="rich-dropdown" tabindex="0"><select class="mobile-native-select"><option value="" hidden selected disabled></option><optgroup label=""></optgroup></select><span class="label drop-label">&nbsp;</span></div>',render:function(){return this._super(),this.model.prefill||(this.$select=this.$dropdown.find(".mobile-native-select"),_.each(this.model.choices,function(choice){var $option=$("<option>"+choice.content.text()+"</option>");$option.attr("value",choice.id),this.$select.append($option)},this),this.bindNativeEvents()),this.node},bindNativeEvents:function(){this.$select.on("input",_.bind(this.onNativeChange,this))},onNativeChange:function(e){var id=this.$select.val(),choice=_.find(this.model.choices,function(model){return model.id==id});this.model.setSelected(choice)},setAnswer:function(){this._super(),this.$select.hide()},showAnswers:function(){this._super(),this.$select.hide()},setInput:function(){this._super(),this.$select.show(),this.model.selected||this.$select.val("")}},a5.views.interaction.BaseDropdownView.extend("a5.views.interaction.ISNativeDropdownView"),a5.views.interaction.ISRichDropdownView={DROPDOWN_TEMPLATE:'<div class="rich-dropdown" tabindex="0"><span class="label drop-label">&nbsp;</span><div class="popup"><span class="popup-close">x</span><ul></ul></div></div>',init:function(model,parent){this._super(model,parent),a5.callbacks.interaction.bind("showed",this.adjustLayout,this),$(window).on("resize",_.throttle(this.onWindowResize.bind(this),300)),a5.hooks.interactionFontUpdated.add(this.adjustLayout.bind(this)),this.choices=this._initChoices(),_.bindAll(this,"onClick","onSelect","onClose","onKeydown")},adjustLayout:function(){var $popup=this.node.find(".popup");$popup.show(),this._adjustWidth(),$popup.hide()},_adjustWidth:function(){var size,maxWidth=0,$label=this.node.find(".label");_.each(this.node.find("li"),function(li){size=$(li).naturalSize({padding:0},{width:"2000px"}),size[0]>maxWidth&&(maxWidth=size[0])}),/[\s;]*width:/gi.test(this.model.labelStyle)||$label.css("width",maxWidth+1)},_adjustPopupPosition:function(){var $popup=this.node.find(".popup"),$footer=$("#activity_controls"),$content=this.node.closest(".content-wrap"),viewport={bottom:$(window).height()};$footer.offset().top>this.node.offset().top&&(viewport.bottom=$footer.offset().top),$popup.css("max-height",""),$popup.css("overflow",""),this.$popup.offset().top<this.node.offset().top&&this.$popup.css("top","");var availableSpaceDown=viewport.bottom-this.node.offset().top-this.node.outerHeight();if($popup.outerHeight()>=availableSpaceDown){if(this.node.addClass("popup-above"),$content.length>0){var availableSpaceUp=this.node.offset().top-$content.offset().top;$popup.outerHeight()>availableSpaceUp&&(this.node.removeClass("popup-above").addClass("popup-below"),$popup.css("top",""),$popup.css("max-height",availableSpaceDown-10),$popup.css("overflow","scroll"))}}else this.node.addClass("popup-below")},render:function(){this._super(),this.model.prefill||(this.$list=this.$popup.find("ul"),_.each(this.choices,function(choiceView){this.$list.append(choiceView.render())},this),this.close());var promises=[];return this.$("img").each(function(index,img){var deferred=$.Deferred();img.onload=img.onerror=function(){deferred.resolve()},promises.push(deferred.promise())}),$.when.apply(this,promises).done(_.bind(function(){this.adjustLayout()},this)),this.node},bindEvents:function(){this._super(),this.$dropdown.on("click",this.onClick),this.$dropdown.on("select",this.onSelect),this.$dropdown.on("keydown",this.onKeydown),this.$close.on("click",this.onClose)},onKeydown:function(e){var key=e.which;key===a5.utils.keyCodes.SPACE||key===a5.utils.keyCodes.ENTER?(e.stopPropagation(),e.preventDefault(),this.hoveredChoice?this.hoveredChoice.select():this.toggle()):key===a5.utils.keyCodes.DOWN?(e.stopPropagation(),e.preventDefault(),this.next(),this.visible||this.hoveredChoice.select()):key===a5.utils.keyCodes.UP?(e.stopPropagation(),e.preventDefault(),this.prev(),this.visible||this.hoveredChoice.select()):key===a5.utils.keyCodes.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.close())},onClick:function(e){"input"!=this.model.state||this.model.tryAgainIsFrozen&&this.$dropdown.hasClass("checked-correct-locked")||this.toggle()},onClose:function(e){e.stopPropagation(),this.close()},onSelect:function(e,choice){e.stopPropagation(),this.model.setSelected(choice),this.close(),this.$dropdown.trigger("change")},onBlur:function(e){0===$(e.srcElement).closest(this.$dropdown).length&&this.close()},onWindowResize:function(e){this.adjustLayout(),this.visible&&requestAnimationFrame(function(){this.close(),this.open()}.bind(this))},close:function(){_.invoke(this.choices,"unhover"),this.hoveredChoice=null,this.$dropdown.removeClass("opened"),this.node.removeClass("popup-above popup-below"),this.$popup.hide(),this.onClickDocumentFn&&$(document).off("click",this.onClickDocumentFn),this.visible=!1},open:function(){this.$dropdown.addClass("opened"),this.$popup.show(),this.node.removeClass("popup-above popup-below"),this._adjustPopupPosition(),this.onClickDocumentFn=_.bind(this.onBlur,this),$(document).on("click",this.onClickDocumentFn),this.visible=!0},toggle:function(){this.visible?this.close():_.defer(_.bind(this.open,this))},next:function(){if(this.hoveredChoice||this.model.selected){this.hoveredChoice||(this.hoveredChoice=_.find(this.choices,{model:this.model.selected}));var currentIndex=this.choices.indexOf(this.hoveredChoice),nextIndex=(currentIndex+1)%this.choices.length;this.hoveredChoice=this.choices[nextIndex]}else this.hoveredChoice=_.first(this.choices);this.hoveredChoice.hover()},prev:function(){if(this.hoveredChoice||this.model.selected){this.hoveredChoice||(this.hoveredChoice=_.find(this.choices,{model:this.model.selected}));var currentIndex=this.choices.indexOf(this.hoveredChoice),prevIndex=currentIndex?currentIndex-1:this.choices.length-1;this.hoveredChoice=this.choices[prevIndex]}else this.hoveredChoice=_.last(this.choices);this.hoveredChoice.hover()},setInput:function(){this._super(),this.model.selected||this.$list.children().removeClass("active")},_initChoices:function(){return _.map(this.model.choices,function(choice){return new a5.views.interaction.ISRichDropdownChoiceView(choice,this)},this)}},a5.views.interaction.BaseDropdownView.extend("a5.views.interaction.ISRichDropdownView"),a5.views.interaction.ISRichDropdownChoiceView={HOVER_CLASS:"hovered",init:function(model,parent){this._super(model,parent,$("<li></li>")),_.bindAll(this,"onClick")},render:function(){return this.node.empty(),this.node.append(this.model.content.clone()),this.bindEvents(),this.node},bindEvents:function(){this.node.on("click",this.onClick)},onClick:function(e){e.stopPropagation(),this.select()},select:function(){this.node.trigger("select",this.model),this.node.siblings("li").removeClass("active"),this.node.addClass("active")},hover:function(){this.node.siblings("li").removeClass(this.HOVER_CLASS),this.node.addClass(this.HOVER_CLASS)},unhover:function(){this.node.removeClass(this.HOVER_CLASS)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRichDropdownChoiceView"),a5.views.interaction.ISHorizontalSelect={NODE_TEMPLATE:'<span tabindex=0 class="input-select-horizontal"><span class="content"></span></span>',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.popup=new a5.views.interaction.ISHorizontalSelectPopup(model.choices,this),model.prefill&&this.model.setSelected(this.model.correct[0]),_.bindAll(this,"_onBlur","_onClick","_onKeydown"),this.update(),this.bindEvents()},bindEvents:function(){this.model.bind("update-selected",_.bind(this.update,this)),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswers,this),this.model.bind("state_update:input",this.setInput,this),this.model.bind("input_update:setAnswer",this.setAnswerInput,this),this.model.bind("next_answer",this.onNextAnswer,this),this.node.on("click",this._onClick),this.node.on("keydown",this._onKeydown),this.node.on("blur",this._onBlur)},showAnswers:function(){this.node.find(".check").remove(),this.model.prefill||(this.model.selected?this.model.isCorrect()?this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(),correctTooltip:!0}):this.addCheck({wrong:!0,tooltip:this.model.selected.content}):this.addCheck({empty:!0}),this.node.find(".content").html(this.model.correct[0].content.clone()),this.bindAnswerFeedback(this.model.selected||this.model.correct[0]))},setAnswer:function(){var setCheck=!this.model.prefill;this.setAnswerCheck(setCheck)},setAnswerInput:function(){var setCheck=!this.model.prefill&&this.model.selected;this.setAnswerCheck(setCheck)},setAnswerCheck:function(check){this.node.find(".check").remove(),check&&this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.selected?this.model.selected.getAnswerFeedback():this.model.getAnswerFeedback(),correctTooltip:!0}),this.bindAnswerFeedback(this.model.selected||this.model.correct[0])},setInput:function(){this.node.find(".check").remove(),this.update()},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},update:function(){var selected="";this.model.selected?(selected=this.model.selected.content.clone(),this.node.addClass("filled")):this.node.removeClass("filled"),this.node.find(".content").html(selected)},adjustSameLongestWidth:function(){var interaction=this.node.parents(".interaction"),choices=interaction.find(".input-select-horizontal .popup-choice"),gaps=interaction.find(".input-select-horizontal span.content"),longest=_.max(choices,function(el){return $(el).text().length}),offdom=interaction.find(".input-select-horizontal").first().clone();offdom.text($(longest).text()),gaps.css("width",offdom.measure("width")).css("display","inline-block")},render:function(){return this._super(),this.node.append(this.popup.render()),this.node},checkOpen:function(){this.model.prefill||"input"!=this.model.state||this.popup.show()},hide:function(){this.node.css("visibility","hidden")},show:function(){this.node.css("visibility","")},_onClick:function(){this.checkOpen()},_onBlur:function(){this.popup.hide()},_onKeydown:function(ev){var key=ev.which;key===a5.utils.keyCodes.SPACE||key===a5.utils.keyCodes.ENTER?this.popup.hoveredChoice?this.popup.selectHovered():this.checkOpen():key===a5.utils.keyCodes.ESCAPE?this.popup.hide():key===a5.utils.keyCodes.LEFT||key===a5.utils.keyCodes.UP?(this.popup.prev(),this.popup.isVisible()||this.popup.selectHovered()):key!==a5.utils.keyCodes.RIGHT&&key!==a5.utils.keyCodes.DOWN||(this.popup.next(),this.popup.isVisible()||this.popup.selectHovered())}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISHorizontalSelect"),a5.views.interaction.ISHorizontalSelectPopup={NODE_TEMPLATE:'<div style="position: absolute" class="popup"></div>',CLOSE_TEMPLATE:'<span class="popup-close"></span>',init:function(choices,parent){this._super(choices,parent,$(this.NODE_TEMPLATE)),this.close=$(this.CLOSE_TEMPLATE),this.node.append(this.close),this.hide(),this.choices=[],_.each(choices,this.add_choice,this)},bindEvents:function(){this.close.on("mousedown touchstart",_.bind(function(e){e.stopPropagation(),e.preventDefault(),this.node.hide()},this))},render:function(){return this._super(),this.bindEvents(),this.node},add_choice:function(choice){var $choice=new a5.views.interaction.ISHorizontalSelectChoice(choice,this);this.choices.push($choice),this.node.append($choice.render())},prev:function(){if(this.hoveredChoice||this.parent.model.selected){this.hoveredChoice||(this.hoveredChoice=_.find(this.choices,{model:this.parent.model.selected}));var currentIndex=this.choices.indexOf(this.hoveredChoice),prevIndex=currentIndex?currentIndex-1:this.choices.length-1;this.hoveredChoice=this.choices[prevIndex]}else this.hoveredChoice=_.last(this.choices);this.hoveredChoice.hover()},next:function(){if(this.hoveredChoice||this.parent.model.selected){this.hoveredChoice||(this.hoveredChoice=_.find(this.choices,{model:this.parent.model.selected}));var currentIndex=this.choices.indexOf(this.hoveredChoice),nextIndex=(currentIndex+1)%this.choices.length;this.hoveredChoice=this.choices[nextIndex]}else this.hoveredChoice=_.first(this.choices);this.hoveredChoice.hover()},selectHovered:function(){this.hoveredChoice.select(),delete this.hoveredChoice},reposition:function(){var activity=this.node.closest(".interaction"),gap=this.parent.node,popup=this.node,gapCenter=gap.offset().left+gap.width()/2-activity.offset().left,overflowLeft=popup.outerWidth()/2-gapCenter,overflowRight=gapCenter+popup.outerWidth()/2-activity.width(),left=gap.width()/2-popup.outerWidth()/2;overflowLeft>0?left+=overflowLeft:overflowRight>0&&(left-=overflowRight),popup.css("top",-gap.height()),popup.css("left",left),_.defer(_.bind(function(){try{this.node.parents(".mCustomScrollbar").mCustomScrollbar("scrollTo",this.node.parent().position().top)}catch(e){}},this))},show:function(){this.reposition(),this.node.show()},hide:function(){this.node.hide()},isVisible:function(){return this.node.is(":visible")}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISHorizontalSelectPopup"),a5.views.interaction.ISHorizontalSelectChoice={NODE_TEMPLATE:'<span class="popup-choice"></span>',HOVER_CLASS:"hovered",init:function(choice,parent){this._super(choice,parent,$(this.NODE_TEMPLATE)),this.node.empty(),this.node.append(choice.content.clone()),this.node.on("mousedown touchstart",_.bind(function(e){e.stopPropagation(),e.preventDefault(),this.select()},this))},hover:function(){this.node.siblings().removeClass(this.HOVER_CLASS),this.node.addClass(this.HOVER_CLASS)},select:function(){this.parent.parent.model.setSelected(this.model),this.node.siblings().removeClass("active"),this.node.addClass("active"),this.parent.hide(),this.parent.parent.update()}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISHorizontalSelectChoice"),a5.view.interaction.IMMarking={init:function(model,parent,classes){this._super(model,parent,$('<div class="contentblock"></div>')),this.node.addClass(classes),model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),this.model.isPrefilled()&&this.node.addClass("prefilled"),this.bindEvents()},bindEvents:function(){this.model.bind("state_update:feedback",this.setAnswer,this)},appendDOM:function($dom){this.node.addClass("style-"+this.model.markingStyle),this.node.append($dom)},setAnswer:function(){$("body").is(".erasing")&&this.setFirstColorActive()},setFirstColorActive:function(){var toolbar=this.model.interaction.toolbar;toolbar.buttons.length&&toolbar.buttons[0].setPressed(!0)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMMarking"),a5.view.interaction.IMMarkingElement={init:function(model,parent){this._super(model,parent,$('<span class="markable"></span>')),this.node.html(model.text),this.model.isPrefilled()&&this.node.addClass("prefilled"),_.bindAll(this,"_onClick","_onKeydown"),this.updateStatus()},render:function(){return this.bindEvents(),this.node},bindEvents:function(){this.model.bind("state_update",this.removeChecks,this),this.model.bind("state_update",this.updateStatus,this),this.model.bind("input_update:setAnswer",this.checkAnswerInput,this),this.model.bind("next_answer",this.onNextAnswer,this)},mark:function(color,isMarked){var property="highlight"===this.model.parent.markingStyle?"backgroundColor":"borderColor";this.node.css(property,color||""),_.isUndefined(isMarked)||this.node.toggleClass("marked",isMarked)},checkAnswerInput:function(){this.removeChecks(),this.model.isFilled()&&(this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))},removeChecks:function(){this.node.find(".check").remove()},updateStatus:function(){this.node.unbind(),this.updateFeedbackState(this.node),this.node.removeClass("has-solution"),this.model.isPrefilled()?this.mark(this.model.getCorrectColor()):"input"!==this.model.state||this.model.parent.isPrefilled()?"feedback"===this.model.state?this.model.isFilled()&&(this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})):"answers"===this.model.state&&(this.node.toggleClass("has-solution",this.model.hasCorrectAnswer()),this.mark(this.model.getCorrectColor()),!this.model.isCorrect()&&this.model.hasCorrectAnswer()?this.addCheck({empty:!this.model.isFilled(),tooltip:!!a5.dp.config.displayFeedbackAfterSeeAnswer&&this.model.getAnswerFeedback()}):this.model.isCorrect()&&this.addCheck({correct:!0,tooltip:!!a5.dp.config.displayFeedbackAfterSeeAnswer&&this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})):(this.mark(this.model.getColor(),this.model.isMarked()),this.node.on("click",this._onClick),this.node.on("keydown",this._onKeydown))},addCheck:function(params){if(this.checkParent)return this._super($.extend(params,{parent:this.checkParent}));var check=this._super(params);if("static"==check.css("position")){var next,lastLeaf=this.node.contents();for(lastLeaf=lastLeaf.eq(lastLeaf.length-2);next=lastLeaf.contents().last(),next.length;lastLeaf=next);if(lastLeaf[0].nodeType===Node.TEXT_NODE){var match=lastLeaf[0].textContent.match(/(.*?)(\S*\s*$)/);lastLeaf[0].textContent=match[1],
lastLeaf.after($('<span class="element-wrap">').text(match[2])),match[1]||lastLeaf.remove()}else lastLeaf.wrap('<span class="element-wrap">')}return this.checkParent=this.node.find(".element-wrap"),check.appendTo(this.checkParent)},updateFeedbackState:function(nodes){if(!this.model.isPrefilled()){this.checkLocked(nodes),nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct");var type;if("feedback"==this.model.state)type="checked";else{if("answers"!=this.model.state)return;type="solution"}this.model.isCorrect()?nodes.addClass([type,"correct"].join("-")):this.model.isFilled()?nodes.addClass([type,"incorrect"].join("-")):this.model.hasCorrectAnswer()&&nodes.addClass([type,"empty"].join("-"))}},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},_onClick:function(){this._mark()},_onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this._mark()},_mark:function(){a5.mainBuilder.curInteraction.toolbar.isEnable()&&(a5.dp.config.markableActsAsToggle&&this.model.marked&&this.model.marked==a5.mainBuilder.curInteraction.iMMarkingCursor?this.model.setMarked(!1):this.model.setMarked(a5.mainBuilder.curInteraction.iMMarkingCursor))}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMMarkingElement"),a5.view.interaction.IMMarkingText={init:function(model,parent){this._super(model,parent,$('<span class="not-markable"></span>')),this.node.text(model.text)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMMarkingText"),a5.view.IMProofing={init:function(parameters){this.vent=parameters.vent,this.interaction=parameters.interaction,this.currentMarker=!1,this.$el=this.interaction.$(".interaction"),this.errorCounter=new a5.view.IMProofingErrorCounter({vent:this.vent}),this.toolbar=new a5.view.IMProofingToolbar({vent:this.vent,interaction:this.interaction}),this.children=[],this.vent.bind("click:marker",this._onClickMarker,this),this.vent.bind("click:erase",this._onClickErase,this),this.vent.bind("click:element",this._onClickElement,this),this.interaction.bind("im-proofing-hint",this._onClickHint,this),a5.mainBuilder.bind("frequent_score_update",this._onScoreUpdate,this),a5.mainBuilder.bind("reset",this._onReset,this,{once:!0})},unbindEvents:function(){a5.mainBuilder.unbind("frequent_score_update",this._onScoreUpdate),a5.mainBuilder.unbind("reset",this._onReset),this.interaction.unbind("im-proofing-hint",this._onClickHint)},render:function(){return this.$el.prepend(this.toolbar.$el),this.toolbar.render(),this.toolbar.$el.append(this.errorCounter.$el),this.errorCounter.render(),this.$el},add:function(view){this.children.push(view)},_onReset:function(){this.unbindEvents()},_onScoreUpdate:function(score){this.vent.trigger("score:update",score)},_onClickHint:function(){var elementView=this._getRandomElementView(),element=elementView.model;_.each(this.children,function(childView){childView.node.removeClass("highlight")}),elementView.node.addClass("highlight"),setTimeout(function(){elementView.node.removeClass("highlight")},a5.dp.config.IMProofingSignalDuration),this.vent.trigger("element:signal",{marker:element.correct.marker})},_onClickMarker:function(marker){this.$el.removeClass("erase"),this.$el.removeClass("marker-"+this.currentMarker),this.$el.addClass("marker-"+marker),this.currentMarker=marker},_onClickErase:function(){this.$el.removeClass("marker-"+this.currentMarker),this.$el.addClass("erase"),this.currentMarker=!1},_onClickElement:function(elementView){var element=elementView.model,oldMarker=element.getMarker(),newMarker=this.currentMarker;oldMarker&&oldMarker.marker===newMarker?elementView.resetMarker():newMarker?(elementView.resetMarker(),this.editingMarker&&this.editingMarker.reset(),elementView.setMarker(newMarker,this).always(function(){this.editingMarker=null}.bind(this))):elementView.resetMarker()},_getRandomElementView:function(){this.highlightCandidates&&!_.isEmpty(this.highlightCandidates)||(this.highlightCandidates=this.children.filter(function(child){return!child.model.isPrefilled()}));var selected=_.sample(this.highlightCandidates);return this.highlightCandidates=_.without(this.highlightCandidates,selected),selected}},Obj.extend("a5.view.IMProofing"),a5.view.interaction.IMProofingBlock={init:function(model,parent){this._super(model,parent,$('<div class="contentblock"></div>')),this.model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),this.model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),this.model.isPrefilled()&&this.node.addClass("prefilled"),this.nodes=[]},add:function(child){this.nodes.push(child)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMProofingBlock"),a5.view.IMProofingToolbar={template:"a5.view.IMProofingToolbar",init:function(parameters){this.vent=parameters.vent,this.interaction=parameters.interaction,this.$el=$('<div class="toolbar"></div>'),_.bindAll(this,"_onClickCapital","_onClickSmall","_onClickAdd","_onClickDelete","_onClickSpelling","_onClickGrammar","_onClickFullstop","_onClickPara","_onClickIndent","_onClickErase"),this.$el.on("click",".btn-capital",this._onClickCapital),this.$el.on("click",".btn-small",this._onClickSmall),this.$el.on("click",".btn-add",this._onClickAdd),this.$el.on("click",".btn-delete",this._onClickDelete),this.$el.on("click",".btn-spelling",this._onClickSpelling),this.$el.on("click",".btn-grammar",this._onClickGrammar),this.$el.on("click",".btn-fullstop",this._onClickFullstop),this.$el.on("click",".btn-para",this._onClickPara),this.$el.on("click",".btn-indent",this._onClickIndent),this.$el.on("click",".btn-erase",this._onClickErase),this.vent.bind("element:signal",this._onElementSignal,this)},render:function(){var html=a5.service.templates.render(this.template);return this.$el.html(html),this.$el},_onElementSignal:function(element){this.$el.find(".highlight").removeClass("highlight");var $btn=this.$el.find(".btn-"+element.marker);$btn.addClass("highlight"),setTimeout(function(){$btn.removeClass("highlight")},a5.dp.config.IMProofingSignalDuration)},_onClickCapital:function(e){e.preventDefault(),this.vent.trigger("click:marker","capital")},_onClickSmall:function(e){e.preventDefault(),this.vent.trigger("click:marker","small")},_onClickAdd:function(e){e.preventDefault(),this.vent.trigger("click:marker","add")},_onClickDelete:function(e){e.preventDefault(),this.vent.trigger("click:marker","delete")},_onClickSpelling:function(e){e.preventDefault(),this.vent.trigger("click:marker","spelling")},_onClickGrammar:function(e){e.preventDefault(),this.vent.trigger("click:marker","grammar")},_onClickFullstop:function(e){e.preventDefault(),this.vent.trigger("click:marker","fullstop")},_onClickPara:function(e){e.preventDefault(),this.vent.trigger("click:marker","para")},_onClickIndent:function(e){e.preventDefault(),this.vent.trigger("click:marker","indent")},_onClickErase:function(e){e.preventDefault(),this.vent.trigger("click:erase")}},Obj.extend("a5.view.IMProofingToolbar"),a5.view.IMProofingErrorCounter={template:"a5.view.IMProofingErrorCounter",init:function(parameters){this.vent=parameters.vent,this.total=0,this.correct=0,this.$el=$('<div class="error-counter"></div>'),this.vent.bind("score:update",this._onScoreUpdate,this)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html(html),this.$el},refresh:function(){this.render()},serializeData:function(){return{total:this.total,correct:this.correct}},_onScoreUpdate:function(score){this.total=score.results.total(),this.correct=score.results.correct(),this.refresh()}},Obj.extend("a5.view.IMProofingErrorCounter"),a5.view.interaction.IMProofingElement={init:function(model,parent,vent){this.vent=vent,this._super(model,parent,$('<span class="markable"><span class="text"></span></span>')),_.bindAll(this,"_onClick"),this.model.bind("state_update:input",this.setInput,this),this.model.bind("state_update:feedback",this.setFeedback,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("change",this._onChange,this),this.model.bind("restore",this._onRestore,this),this.setInput()},render:function(){return this.node.find(".text").text(this.model.text),this.node},refresh:function(){this.render()},append:function($marker){this.node.append($marker)},getText:function(){return this.model.getText()},setText:function(text){this.node.find(".text").text(text)},setInput:function(){if(this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.model.isPrefilled()){var correct=this.model.getCorrect();return void(correct&&this.presetMarker(correct))}this.node.on("click",this._onClick),this.model.tryAgainKeep||this.model.isCorrect()?(this.resetMarker(!0),this.presetMarker(this.model.marker)):this.resetMarker()},setFeedback:function(){this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.model.isFilled()&&this.addCheck({correct:this.model.isCorrect()})},showAnswer:function(){this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.resetMarker(!0);var correct=this.model.getCorrect();correct&&this.presetMarker(correct),!this.model.isCorrect()&&this.model.needsAnswer()?this.addCheck({empty:!this.model.isFilled()}):this.model.isCorrect()&&this.addCheck({correct:!0})},updateFeedbackState:function(nodes){if(!this.model.isPrefilled()){nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct");var type;if("feedback"===this.model.state)type="checked";else{if("answers"!==this.model.state)return;type="solution"}this.model.isCorrect()?nodes.addClass([type,"correct"].join("-")):this.model.isFilled()?nodes.addClass([type,"incorrect"].join("-")):this.model.needsAnswer()&&nodes.addClass([type,"empty"].join("-"))}},getMarker:function(){return this.marker},resetMarker:function(silent){this.marker&&(this.marker.reset(),this.marker=null,silent||this.model.setMarker(!1))},setMarker:function(marker,parent){var klass="IMProofingPlacementMarker";return _.contains(["grammar","spelling","add"],marker)&&(klass="IMProofingCorrectionMarker"),this.marker=new a5.view.interaction[klass](this,marker),parent.editingMarker=this.marker,$.when(this.marker.set()).then(function(text){this.model.setMarker({marker:marker,text:text})}.bind(this),function(){this.marker.reset()}.bind(this))},presetMarker:function(marker){if(marker){var klass="IMProofingPlacementMarker";_.contains(["grammar","spelling","add"],marker.marker)&&(klass="IMProofingCorrectionMarker"),this.marker=new a5.view.interaction[klass](this,marker.marker),this.marker.preset(marker.text)}},_onChange:function(){this.refresh()},_onRestore:function(){this.presetMarker(this.model.marker)},_onClick:function(e){e.preventDefault(),this.vent.trigger("click:element",this)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMProofingElement"),a5.view.interaction.IMProofingText={init:function(model,parent){this._super(model,parent,$('<span class="not-markable"></span>')),this.node.text(model.text)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMProofingText"),a5.view.interaction.IMProofingCorrectionMarker={POPUP_TEMPLATE:'<div class="editing-popup"><a href="#" class="btn-close">CLOSE</a><div class="dialog-title"><h1></h1></div><div class="dialog-content"><input type="text" autocapitalize="off" autocorrect="off" autocomplete="off"/><div class="dialog-buttons"><a class="btn-submit" href="#">OK</a></div></div></div>',init:function(target,type){this.target=target,this.type=type,this.$el=$('<div class="marker"></div>');var html=a5.service.templates.render("a5.view.im_proofing.CorrectionPopup",this.serializeData(),this.POPUP_TEMPLATE);this.$popup=$(html),this.$popup.addClass(type+"-marker-popup"),_.bindAll(this,"_onClickClose","_onClickSubmit","_onKeypress"),this.$popup.on("click",".btn-close",this._onClickClose),this.$popup.on("click",".btn-submit",this._onClickSubmit),this.$popup.on("keypress","input",this._onKeypress)},serializeData:function(){return{word:this.target.getText(),marker:this.type}},preset:function(text){this.$el.text(text),this.target.append(this.$el),this.target.node.addClass("mark-"+this.type)},set:function(){return this.deferred=$.Deferred(),this.target.parent.node.append(this.$popup),this.$popup.css(this._getPosition()),this.target.append(this.$el),this.target.node.addClass("editing"),this.target.node.addClass("mark-"+this.type),this.$popup.find("input").focus(),this.deferred.promise()},reset:function(){this.$popup.remove(),this.$el.remove(),this.target.node.removeClass("mark-"+this.type),this.target.node.removeClass("editing")},getText:function(){return this.$el.text()},setText:function(text){this.$el.text(text)},_onClickClose:function(e){e.preventDefault(),this.$popup.remove(),this.target.node.removeClass("editing"),this.deferred.reject()},_onClickSubmit:function(e){e.preventDefault(),this._submitValue(),this.$popup.remove(),this.target.node.removeClass("editing");var text=this.getText();text?this.deferred.resolve(text):this.deferred.reject()},_onKeypress:function(e){if(13===e.keyCode){this._submitValue(),this.$popup.remove(),this.target.node.removeClass("editing");var text=this.getText();text?this.deferred.resolve(text):this.deferred.reject()}},_submitValue:function(){this.setText(this.$popup.find("input").val().trim())},_getPosition:function(){var containerWidth=this.target.parent.node.width(),viewportBottom=$(window).scrollTop()+$(window).height()-a5.dp.config.exclusionBottom,wordPosition=this.target.node.offset(),pushLeft=this.target.node.position().left+this.$popup.outerWidth()-containerWidth;pushLeft=pushLeft<0?0:pushLeft;var pushUp=wordPosition.top+30+this.$popup.height()-viewportBottom;return pushUp=pushUp<0?0:this.$popup.height()+30,{left:wordPosition.left-this.target.parent.node.offset().left-pushLeft,top:wordPosition.top-this.target.parent.node.offset().top+30-pushUp}}},Obj.extend("a5.view.interaction.IMProofingCorrectionMarker"),a5.view.interaction.IMProofingPlacementMarker={init:function(target,type){this.$el=$('<div class="marker"></div>'),this.target=target,this.type=type},preset:function(){this.set()},set:function(){this.target.append(this.$el),this.target.node.addClass("mark-"+this.type)},reset:function(){this.$el.remove(),this.target.node.removeClass("mark-"+this.type)}},Obj.extend("a5.view.interaction.IMProofingPlacementMarker"),a5.views.interaction.Wordsnake={init:function(model,parent){this._super(model,parent,$('<div class="wt9"><div class="iwt9_canvas" id="IWT-'+model.interaction.index+'"></div></div>')),this._bindEvents()},_bindEvents:function(){this.model.interaction.bind("rendered",_.bind(this.drawSVG,this,this.model.interaction.index,this.model.interaction,!0)),this.model.interaction.bind("show",_.bind(this.drawSVG,this,this.model.interaction.index,this.model.interaction,!0))},drawSVG:function(index,interaction,loadBadAnswers){var self=this;if("input"==this.model.state){this.node.find("#IWT-"+index).html("");var uuid,i2,from,to,selectedWord,letters=[],pos1=null,pos2=null,foundWords=0,colors=["lightblue","lightgreen","pink","orange","brown"],colorClasses=["snk-selection-1","snk-selection-2","snk-selection-3","snk-selection-4","snk-selection-5"],t=interaction.t,firstAnswer=_.first(_(interaction.answers).values());if(!_.isUndefined(t)){var space=a5.dp.config.snakeSpace,clickableArea={width:a5.dp.config.snakeWidth,height:a5.dp.config.snakeHeight},paper=new Raphael("IWT-"+index,space*t.length,100);paper.label="IWT-"+index;for(var rPath=this._calculateRPath(a5.dp.config.snakeVerticalMax,a5.dp.config.snakeVerticalMin,a5.dp.config.snakeHorizontalSpread,space*t.length),path=paper.path("M10,10"+rPath).attr({stroke:"none"}),i=0;i<t.length;i++){var character=paper.text(path.getPointAtLength(i*space).x+clickableArea.width/2,path.getPointAtLength(i*space).y+clickableArea.height/2,t[i]).attr({font:a5.dp.config.snakeFont}),rect=paper.rect(path.getPointAtLength(i*space).x,path.getPointAtLength(i*space).y,clickableArea.width,clickableArea.height);rect.attr({fill:"red",opacity:0}),clickableArea.width*clickableArea.height==0&&(rect=character),rect.character=character,letters.push(character),character.pos=i;var angle=path.getPointAtLength(i*space).alpha;interaction.options.prefillIsFirstitem()&&i>=0&&i<firstAnswer.length?(character.attr({fill:"cyan"}),character.node.setAttribute("class","snk-selected")):(rect.click(function(){if(1==this.character.selected){var test=!0,tmp=this.character.pos;for(uuid=this.character.uuid,selectedWord="";test;)tmp>t.length-1||1!=letters[tmp].selected||letters[tmp].uuid!=uuid?test=!1:(letters[tmp].attr({fill:"black"}),letters[tmp].node.removeAttribute("class"),letters[tmp].selected=!1,letters[tmp].uuid=null,selectedWord+=letters[tmp].attrs.text,tmp++);for(test=!0,tmp=this.character.pos-1;test;)tmp<0||1!=letters[tmp].selected||letters[tmp].uuid!=uuid?test=!1:(letters[tmp].attr({fill:"black"}),letters[tmp].node.removeAttribute("class"),letters[tmp].selected=!1,letters[tmp].uuid=null,selectedWord=letters[tmp].attrs.text+selectedWord,tmp--);interaction.selections=_.filter(interaction.selections,function(item){return item[0]!=selectedWord})}else if(this.character.attr({fill:"cyan"}),this.character.node.setAttribute("class","snk-selected"),null!=pos1&&null==pos2){pos2=this.character.pos;var ok=!0;for(from=pos1,to=pos2,pos1>pos2&&(from=pos2,to=pos1),i2=from;i2<to;i2++)1==letters[i2].selected&&(ok=!1);if(ok){for(uuid=Raphael.createUUID(),selectedWord="",i2=0;i2<t.length;i2++){from=pos1,to=pos2,pos1>pos2&&(from=pos2,to=pos1);var nonAdjacentColors=self._getNonAdjacentColors(colors,from,to,letters),selectedColorIndex=colors.indexOf(nonAdjacentColors[foundWords%nonAdjacentColors.length]);i2>=from&&i2<=to&&(letters[i2].attr({fill:colors[selectedColorIndex]}),letters[i2].node.setAttribute("class",colorClasses[selectedColorIndex]),letters[i2].selected=!0,letters[i2].uuid=uuid,selectedWord+=letters[i2].attrs.text)}interaction.selections.push([selectedWord,from,colors[foundWords%colors.length],colorClasses[foundWords%colors.length]]),foundWords++}else letters[pos1].attr({fill:"black"}),letters[pos1].node.removeAttribute("class"),letters[pos2].attr({fill:"black"}),letters[pos2].node.removeAttribute("class");pos1=null,pos2=null}else null==pos1&&(pos1=this.character.pos);a5.mainBuilder.updateScoresAsync()}),rect.hover(function(){this.attr({cursor:"pointer"})})),angle<180&&(angle+=180),rect!==character&&rect.rotate(angle),character.rotate(angle)}rect&&paper.setSize(rect.attrs.x+rect.attrs.width+10,paper.height),_.each(interaction.selections,function(val){if(1==loadBadAnswers)for(uuid=Raphael.createUUID(),i=val[1];i<val[1]+val[0].length;i++)letters[i].attr({fill:val[2]}),letters[i].node.setAttribute("class",val[3]),letters[i].selected=!0,letters[i].uuid=uuid;else if(_.include(_.values(interaction.answers),val[0]))for(uuid=Raphael.createUUID(),i=val[1];i<val[1]+val[0].length;i++)letters[i].attr({fill:val[2]}),letters[i].node.setAttribute("class",val[3]),letters[i].selected=!0,letters[i].uuid=uuid}),interaction.letters=letters,interaction.paper=paper,interaction.path=path,interaction.colors=colors,interaction.colorClasses=colorClasses,interaction.clean=!0,$("a#btn_answers").length>0&&$("a#btn_answers").is(":visible")&&!$("a#btn_answers").hasClass("inactive_button")&&self.ws.setAnswer()}}},_getNonAdjacentColors:function(colors,from,to,text){var prev,next;from>0&&(prev=text[from-1].attr("fill")),to<text.length-1&&(next=text[to+1].attr("fill"));var adjacentColors=_([prev,next]).compact();return _(colors).difference(adjacentColors)},_calculateRPath:function(y0,y1,incX,maxX){for(var path=[],i=100,j=0;i<maxX+incX;i+=incX,j++)path.push([i,j%2?y1:y0].join(","));return"R"+path.join(" ")}},a5.views.interaction.BaseView.extend("a5.views.interaction.Wordsnake"),a5.view.IMAutocorrect={init:function(parameters){this.vent=new Obj,this.interaction=parameters.interaction,this.$el=this.interaction.$(".interaction"),this.interaction.options.scorecalculationIsOnlyCorrect()&&(this.errorCounter=new a5.view.IMProofingErrorCounter({vent:this.vent})),this.children=[],a5.mainBuilder.bind("frequent_score_update",this._onScoreUpdate,this)},render:function(){return this.errorCounter&&(this.$el.append(this.errorCounter.$el),this.errorCounter.render()),this.$el},add:function(elementView){this.children.push(elementView),elementView.bind("click:element",this._onClickElement,this)},_onClickElement:function(elementView){this._canMark()&&elementView.setMarked()},_onScoreUpdate:function(score){this.vent.trigger("score:update",score)},_canMark:function(){if(this.interaction.options.scorecalculationIsSubtractIncorrect())return!0;var total=0,filled=0;return _.each(this.children,function(elementView){var model=elementView.model;model.needsAnswer()&&total++,model.isFilled()&&filled++}),filled<total}},Obj.extend("a5.view.IMAutocorrect"),a5.view.interaction.IMAutocorrectBlock={init:function(model,parent){this._super(model,parent,$('<div class="contentblock"></div>')),this.model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),this.model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),this.model.isPrefilled()&&this.node.addClass("prefilled"),this.nodes=[]},add:function(child){this.nodes.push(child)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMAutocorrectBlock"),a5.view.interaction.IMAutocorrectElement={init:function(model,parent){this._super(model,parent,$('<span class="markable"><span class="text"></span></span>')),_.bindAll(this,"_onClick"),this.model.bind("state_update:input",this.setInput,this),this.model.bind("state_update:feedback",this.setFeedback,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("input_update:setAnswer",this.checkAnswerInput,this),this.model.bind("restore",this._onRestore,this),this.setInput()},render:function(){return this.node.find(".text").text(this.model.text),this.node},refresh:function(){this.render()},setText:function(text){this.node.find(".text").text(text)},setInput:function(){if(this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.model.isPrefilled()){return void(this.model.getCorrect()&&this.setMarked(!0))}this.node.on("click",this._onClick),this.model.tryAgainKeep||this.model.isCorrect()||this.resetMarked()},setFeedback:function(){this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.model.isFilled()&&this.addCheck({correct:this.model.isCorrect()})},checkAnswerInput:function(){this.node.find(".check").remove(),this.model.isFilled()&&(this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))},showAnswer:function(){this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.resetMarked(!0),this.model.getCorrect()&&this.setMarked(!0),!this.model.isCorrect()&&this.model.needsAnswer()?this.addCheck({empty:!this.model.isFilled()}):this.model.isCorrect()&&this.addCheck({correct:!0})},updateFeedbackState:function(nodes){if(!this.model.isPrefilled()){nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct");var type;if("feedback"===this.model.state)type="checked";else{if("answers"!==this.model.state)return;type="solution"}this.model.isCorrect()?nodes.addClass([type,"correct"].join("-")):this.model.isFilled()?nodes.addClass([type,"incorrect"].join("-")):this.model.needsAnswer()&&nodes.addClass([type,"empty"].join("-"))}},resetMarked:function(silent){this.node.removeClass("marked"),this.node.removeClass("correct incorrect"),this.setText(this.model.text),silent||this.model.unsetMarked()},setMarked:function(silent){this.node.addClass("marked"),this.model.needsAnswer()?(this.node.addClass("correct"),this.setText(this.model.correctText)):(this.node.addClass("incorrect"),this.setText(this.model.text)),silent||this.model.setMarked()},_onRestore:function(){this.setMarked(!0)},_onClick:function(e){e.preventDefault(),this.trigger("click:element",this)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMAutocorrectElement"),a5.view.interaction.IMAutocorrectText={init:function(model,parent){this._super(model,parent,$('<span class="not-markable"></span>')),this.node.text(model.text)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMAutocorrectText"),a5.view.IMAutocorrectErrorCounter={template:"a5.view.IMAutocorrectErrorCounter",init:function(parameters){this.vent=parameters.vent,this.total=0,this.correct=0,this.$el=$('<div class="error-counter"></div>'),this.vent.bind("score:update",this._onScoreUpdate,this)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html(html),this.$el},refresh:function(){this.render()},serializeData:function(){return{total:this.total,correct:this.correct}},_onScoreUpdate:function(score){this.total=score.results.total(),this.correct=score.results.correct(),this.refresh()}},Obj.extend("a5.view.IMAutocorrectErrorCounter"),a5.views.interaction.ISCheckboxView={template:"a5.view.interaction.ISCheckbox",init:function(model,prefill,hideCheckboxes,showInColumns,label,isVisible,cblock,interaction){this.showInColumns=showInColumns,this._super(model,prefill,hideCheckboxes),showInColumns&&(this.label=new a5.views.interaction.ISCheckboxLabel(label)),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this._onDisplayAnswer,this),this.model.bind("state_update:input",this.setInput,this),this.model.bind("max-selections",this.setMaxSelections,this),this.model.bind("next_answer",this.onNextAnswer,this),this.$contentblock=cblock,this.updateVisuals(isVisible,interaction),this._addInteractionEvents(interaction)},createViewFor:function(model){return new a5.views.interaction.ISCheckboxChoiceView(model,this.showInColumns,this)},render:function(){return this._super(),this.showInColumns&&(_.first(this.children).node.before(this.label.$node),this.label.render(),this.node.addClass("checkbox-show-in-columns")),this.node},_addInteractionEvents:function(interaction){interaction&&(interaction.bind("attemptsChanged",_.bind(this._onAttemptsChanged,this)),interaction.bind("restored",_.bind(this._onInteractionRestored,this)))},_onAttemptsChanged:function(attempts){this.model.attempts=attempts.checkAttempts},_onInteractionRestored:function(interaction){this.model.attempts>0&&this._onDisplayAnswer()},_onDisplayAnswer:function(){this.$contentblock.show()},updateVisuals:function(isVisible,interaction){if(this.model.isDisplayActive()){var question=this.$contentblock.find("p").first();question.addClass("expandable-question"),question.prepend(question.siblings("span.enum")),this.setActive(question,this.node,isVisible,!0),question.on("click",_.bind(function(){!question.hasClass("active")&&interaction&&interaction.contentWrap.find(".expandable-question.active").click(),this.setActive(question,this.node,!question.hasClass("active"),!0)},this))}(this.model.isDisplayShowNext()||this.model.isDisplayShowNextHidePrev())&&this.setActive(this.$contentblock,this.$contentblock,isVisible,!0),this.model.isDisplayAll()&&(this.setActive(this.$contentblock,null,isVisible,!1),this.$contentblock.on("click focus",_.bind(function(){this.setActive(this.$contentblock.siblings(".active"),null,!1,!1),this.setActive(this.$contentblock,null,!0,!1)},this)))},setActive:function($activeNode,$displayNode,isActive,hideInactive){$activeNode.toggleClass("active",isActive),$displayNode&&(isActive?$displayNode.show():hideInactive&&$displayNode.hide())},setAnswer:function(){_.find(this.model.choices,function(choice){return choice.selected});("Exam"===LOInfo.mode||"Trainer"===LOInfo.mode)&&this.model.totalSelected()<this.model.totalCorrect()&&this.addCheck({correct:!1}),this._onDisplayAnswer()},setInput:function(){this.node.find(".check").remove(),this._onDisplayAnswer()},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},setMaxSelections:function(maxSelected){if(this.node.toggleClass("no-more-choices",maxSelected&&!this.model.allowSelectAll),maxSelected&&this.$contentblock.next(".contentblock").length&&this._displayShowHideBehavior()){var $nCBlock=this.$contentblock.next(".contentblock");this.setActive($nCBlock,$nCBlock,!0,!0),this.setActive(this.$contentblock,this.$contentblock,!1,this.model.isDisplayShowNextHidePrev())}},_displayShowHideBehavior:function(){return(this.model.isDisplayShowNext()||this.model.isDisplayShowNextHidePrev())&&0===this.model.attempts}},a5.views.Checkbox.extend("a5.views.interaction.ISCheckboxView"),a5.views.interaction.ISCheckboxChoiceView={contentTemplate:"a5.view.interaction.ISCheckboxChoice",template:"a5.view.interaction.ISCheckboxChoiceWrapper",init:function(model,showInColumns,parent){this.showInColumns=showInColumns,this._super(model,parent),showInColumns||this.contentNode.find(".is-checkbox-choice-text").append(model.content.contents()),model.enumeration&&(this.contentNode.prepend('<span class="enum-placeholder"></span>'),model.enumeration.then(function(enumSymbol){this.contentNode.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),model.hasCheckbox?this.addInput():this.node.addClass("input-noradio"),this.model.prefill&&(this.disable(),this.model.hasCorrectAnswer()&&this.select(!0),this.node.addClass("prefill")),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.tryAgain,this),this.updateSelected()},render:function(){return this._super(),this.showInColumns&&this.node.wrapInner("<div class='input-wrapper'></div>"),this.node},updateSelected:function(){if(!this.model.prefill)return this.model.isSelectedAnswer()?this.select(!0):this.unselect(!0),this.disable(),"input"===this.model.parent.state&&"answers"!==this.model.state&&(this.model.tryAgainIsFrozen&&this.isLocked()||this.enable()),"answers"!==this.model.parent.state&&"answers"!==this.model.state||this.model.hasCorrectAnswer()&&this.select(!0),this},select:function(silent){this._super(),this.input?this.input.attr("checked",!0):this.node.addClass("clickedanswer"),this.node.addClass("input-checkbox-checked"),silent||this.model.select()},unselect:function(silent){this._super(),this.input&&this.input.attr("checked",!1),this.node.removeClass("clickedanswer"),this.node.removeClass("input-checkbox-checked"),silent||this.model.unselect()},disable:function(){this._super(),this.input&&this.input.attr("disabled",!0)},enable:function(){this._super(),this.input&&this.input.attr("disabled",!1)},onMouseOver:function(e){this._super(),this.node.addClass("input-checkbox-hover"),this.input||this.node.addClass("input-noradio-hover")},onMouseOut:function(e){this._super(),this.node.removeClass("input-checkbox-hover"),this.node.removeClass("input-noradio-hover")},setAnswer:function(){if(!this.model.prefill&&this.model.selected){var tooltip=this._getFeedbackForTooltip();this.node.find(".check").remove(),this.node.toggleClass("has-feedback",!!tooltip),this.addCheck({correct:this.model.isCorrect(),tooltip:tooltip,correctTooltip:!0,parent:this.node.find(".input-wrapper").length?this.node.find(".input-wrapper"):this.node}),_.defer(_.bind(this.bindAnswerFeedback,this,this.model))}if(!this.showInColumns){var check=this.node.find(".check");check.css("position","static"),check.prependTo(check.parent())}},showAnswer:function(){if(!this.model.prefill){var tooltip=this._getFeedbackForTooltip();this.node.find(".check").remove(),this.node.toggleClass("has-feedback",!!tooltip),
this.model.correct&&!this.model.selected&&this.addCheck({empty:!0,tooltip:tooltip,state:"answers",parent:this.node.find(".input-wrapper").length?this.node.find(".input-wrapper"):this.node}),!this.model.correct&&this.model.selected&&this.addCheck({correct:!1,tooltip:tooltip,state:"answers",parent:this.node.find(".input-wrapper").length?this.node.find(".input-wrapper"):this.node}),this.model.correct&&this.model.selected&&this.addCheck({correct:!0,tooltip:tooltip,correctTooltip:!0,state:"answers",parent:this.node.find(".input-wrapper").length?this.node.find(".input-wrapper"):this.node})}if(!this.showInColumns){var check=this.node.find(".check");check.css("position","static"),check.prependTo(check.parent())}this.updateSelected()},tryAgain:function(){this.node.removeClass("has-feedback"),this.node.find(".check").remove(),this.unbindAnswerFeedback()},updateFeedbackState:function(){this.checkLocked(),this.node.removeClass("checked-empty checked-incorrect checked-correct"),this.node.removeClass("solution-empty solution-incorrect solution-correct"),"feedback"==this.model.parent.state?this.model.isCorrect()?this.node.addClass("checked-correct"):this.model.selected?this.node.addClass("checked-incorrect"):this.node.addClass("checked-empty"):"answers"==this.model.parent.state&&(this.model.correct==this.model.selected?this.node.addClass("solution-correct"):this.node.addClass("solution-incorrect"))},_getFeedbackForTooltip:function(){return this.model.answerFeedback||this.model.parent.getAnswerFeedback()}},a5.views.CheckboxChoiceView.extend("a5.views.interaction.ISCheckboxChoiceView"),a5.views.interaction.ISCheckboxLabel={init:function(label){this.$node=$("<div class='checkbox-column-label'></div>").append(label)},render:function(){return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCheckboxLabel"),a5.views.interaction.ISCheckboxHeader={init:function(answers){this.$node=$("<div class='checkbox-column-header'><div class='header-spacer'></div></div>"),this.answers=answers},render:function(){for(var i=0;i<this.answers.length;i++){var $answerCell=$("<div class='answer-cell'></div>").append(this.answers[i]);this.$node.append($answerCell)}return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCheckboxHeader"),a5.view.interaction.ICExtendedWriting={init:function(model,parent,node,interaction){if(this._super(model,parent,node),this.interaction=interaction,!interaction.hasReadyListener){var dataObj={};dataObj.sectionHash={},dataObj.sectionCount=0,dataObj.sections=[],dataObj.supergapCount=0,dataObj.gapCount=0,dataObj.cks=[],interaction.dataObj=dataObj}var txt=this.node.html(),res=txt.match(/\*([\s\S\w\W]*?)\*/g);if(null!=res){var name,token=res[0],sectionName=token.replace(/\*/g,"");void 0===interaction.dataObj.sectionHash[sectionName]&&(name="sect-"+ ++this.interaction.dataObj.sectionCount,interaction.dataObj.sectionHash[sectionName]=name,interaction.dataObj.sections.push(sectionName)),_.isUndefined(interaction.sections)&&(interaction.sections=[]),interaction.sections.push(interaction.dataObj.sectionHash[sectionName]),txt=txt.replace(token,""),txt=this.replaceGaps(txt),this.node.html(txt),interaction.hasReadyListener||(interaction.hasReadyListener=!0,interaction.onInteractionReadyListeners.register(this.onInteractionReady.bindTo(this)))}},replaceGaps:function(txt){return _.each(txt.match(/\[(.*?)\]/g),function(res){var params=res.split("@"),content=res.replace(/\*/g,"");content=content.replace(/@(.+)@/g,""),content=content.substring(1,content.length-1);var options={maxLength:this.interaction.options.getMaxLength(),maxType:this.interaction.options.get("120"),autogrow:this.interaction.options.textboxAutogrowIsOn(),hasMaxLength:!this.interaction.options.maxLengthIsFalse(),width:"100%",height:"40px"};3===params.length&&_.extend(options,this._extractOptions(params[1]));var input;input="auto"!==options.height?0==res.indexOf("[***")?this._createRichTextArea(options,content):this._createTextArea(options,content):this._createTextInput(options,content),txt=txt.replace(res,input)},this),txt},_extractOptions:function(sizeOpt){var maxStr,options={},size=sizeOpt.split(":");return 1===size.length?(options.width=this._addPxIfNeeded(size[0]),options.height="auto"):2===size.length?(options.width=this._addPxIfNeeded(size[0]),size[1].indexOf("chars")>0||size[1].indexOf("words")>0?(maxStr=size[1].split(" "),options.maxLength=parseInt(maxStr[0],10),options.maxType=maxStr[1],options.height="auto"):options.height=this._addPxIfNeeded(size[1])):3===size.length&&(options.width=this._addPxIfNeeded(size[0]),options.height=this._addPxIfNeeded(size[1]),maxStr=size[2].split(" "),options.maxLength=parseInt(maxStr[0],10),options.maxType=maxStr[1]),options},_addPxIfNeeded:function(val){return-1===val.indexOf("px")&&-1===val.indexOf("%")?val+"px":val},_createTextInput:function(options,content){var maxTypeStr="";options.hasMaxLength&&(maxTypeStr=("chars"===options.maxType?"maxchars":"maxwords")+'="'+options.maxLength+'"');var id="fwti-"+this.interaction.dataObj.gapCount++;return _.str.sprintf('<input type="text" id="%s" style="width:%s;" %s value="%s"></input>',id,options.width,maxTypeStr,content)},_createTextArea:function(options,content){var maxTypeStr="";options.hasMaxLength&&(maxTypeStr=("chars"===options.maxType?"maxchars":"maxwords")+'="'+options.maxLength+'"');var id="fwta-"+this.interaction.dataObj.gapCount++;return _.str.sprintf('<textarea class="plain-editor" id="%s" style="width:%s;height:%s;" %s>%s</textarea>',id,options.width,options.height,maxTypeStr,content)},_createRichTextArea:function(options,content){var id="editor_"+this.interaction._uid+"_"+this.interaction.dataObj.supergapCount++,config={width:options.width,height:options.height,toolbar:[["Bold","Italic","Superscript","Subscript","-","NumberedList","BulletedList","-","Link","Unlink"]],customConfig:"",stylesSet:[]};return options.autogrow?(config.autoGrow_minHeight=50|config.height,config.extraPlugins="autogrow"):(config.resize_enabled=!0,config.resize_dir="both",config.removePlugins="autogrow"),options.hasMaxLength&&(config.MaxLength=options.maxLength,config.MaxLengthType=options.maxType,config.EditorName="cke_"+id),this.interaction.dataObj.cks.push([id,config]),_.str.sprintf('<textarea name="%s" id="%s">%s</textarea>',id,id,content)},insertMenu:function(parent){var tmpl=window.a5.mainBuilder.layout.getTemplate("writing"),subTmpl=window.a5.mainBuilder.layout.getSubpart(tmpl,"writing-item-button"),subTmplAll=window.a5.mainBuilder.layout.getSubpart(tmpl,"writing-item-button-all"),items=[];_.each(this.interaction.dataObj.sections,function(sectionName,index){var btn=subTmpl.replace("##label##",sectionName);btn=btn.replace("##class##","elem-"+index),items.push(btn)}),items.push(subTmplAll),tmpl=window.a5.mainBuilder.layout.replaceSubpart(tmpl,"writing-item-button",items.join("")),tmpl=window.a5.mainBuilder.layout.replaceSubpart(tmpl,"writing-item-button-all","");var html=this.node.html();this.node.empty(),tmpl=tmpl.replace("##right_col##",html),this.node.append(tmpl)},initCKs:function(){for(var self=this,dataObj=this.interaction.dataObj,i=0;i<dataObj.cks.length;i++){var editorName=dataObj.cks[i][0];window.CKEDITOR.replace(editorName,dataObj.cks[i][1]);var cke_instance=window.CKEDITOR.instances[editorName];self.model.registerCKEditor(cke_instance),cke_instance.on("key",a5.utils.checkCKLength),cke_instance.on("paste",a5.utils.checkCKLength),cke_instance.on("blur",a5.utils.hideMaxCharsLabel)}},attachEvents:function(){var self=this;_.each(this.$(".right_col .contentblock"),function(el,index){$(el).addClass(self.interaction.sections[index])}),this.$(".fw_nav  a").unbind("click"),this.$(".fw_nav  a").click(function(e){e.preventDefault(),$(this).toggleClass("fw_nav_selected");var index=$(this).parent().index();if(index==self.interaction.dataObj.sections.length)_.each(self.interaction.dataObj.sections,function(sectionName){self.$("."+self.interaction.dataObj.sectionHash[sectionName]).show()});else{self.$("."+self.interaction.dataObj.sectionHash[self.interaction.dataObj.sections[index]]).toggle()}self.updateMenu(self.$(".fw_nav"))}),a5.utils.setTextAreaMaxlength(this.interaction.contentWrap)},updateMenu:function(btn){var self=this,visCount=0;_.each(this.interaction.dataObj.sections,function(sectionName,index){"none"==this.$("."+self.interaction.dataObj.sectionHash[sectionName]).css("display")?$(btn).find(".elem-"+index).removeClass("fw_nav_selected"):(visCount++,$(btn).find(".elem-"+index).addClass("fw_nav_selected"))},this),visCount==this.interaction.dataObj.sections.length?$(btn).find(".all").addClass("fw_nav_selected"):$(btn).find(".all").removeClass("fw_nav_selected")},onInteractionReady:function(){this.insertMenu(),this.attachEvents(),this.initCKs()}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICExtendedWriting"),a5.views.interaction.ICTextGap={TEXT_PLACEHOLDER:"_",init:function(model,parent){this._super(model,parent,$('<div class="input-text"></div>')),this.pool_word=this._getPoolWord(),this.model.prefill?(this.node.append('<div class="prefill">'+this.model.getCorrect()+"</div>"),$(this.pool_word).addClass("prefill"),this.model.area&&this.node.children(".prefill").css({width:this.model.area[0],height:this.model.area[1]})):(this.model.area?(this.node.addClass("has-textarea"),this.input=this._createTextArea()):(this.node.addClass("has-input"),this.input=this._createTextInput()),this.node.append(this.input),this.bindEvents(),this._canShowCharactersInGap()&&(this.node.addClass("characters-in-gap"),this._initCharactersInGap())),this.model.enumeration&&(this.model.global_enumeration&&!this.model.charactersNumber&&a5.dp.config.continuousEnumerationInsideGaps?this.show_global_enumeration(!0):(this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this)))),this.model.isDistractor()&&this.node.addClass("distractor-gap")},inputValue:function(){return!this.input||this.input.is(".continuous-enumeration")?"":this.model.charactersNumber&&""===this.input.val().replace(new RegExp(this.TEXT_PLACEHOLDER,"g"),"").trim()?"":this.input.val()},bindEvents:function(){_.bindAll(this,"onInputChange","onInputClick","onInputFocus","onInputBlur","onInputMouseOver","onInputMouseOut","onWindowResize"),this.input.on("change input",this.onInputChange),this.input.on("click",this.onInputClick),this.input.on("focus",this.onInputFocus),this.input.on("blur",this.onInputBlur),this.input.on("mouseover",this.onInputMouseOver),this.input.on("mouseout",this.onInputMouseOut),this.onWindowResizeThrottled=_.throttle(this.onWindowResize,300),this._bindResize(),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("state_update:input",this.onStateInput,this),this.model.bind("state_update:feedback",this.onStateFeedback,this),this.model.bind("state_update:answers",this.onStateAnswers,this),this.model.bind("input_update:setAnswer",this.onStateInputFeedback,this),this.model.bind("next_answer",this.onNextAnswer,this)},onInputChange:function(e){this.model.setValue(this.inputValue()),this._setFilled(),this.adjustGapSizeAfterEvent("input:change")},onInputClick:function(e){},onInputFocus:function(e){this.node.addClass("focused"),this._unbindResize();var originalWidth=this.originalInput&&this._getMaxWidthFor(this.originalInput)||0;this.initialWidth=_.min([this.input.width(),originalWidth]),this.adjustGapSizeAfterEvent("input:focus")},onInputBlur:function(e){this.node.removeClass("focused mouseover"),this._bindResize(),this.adjustGapSizeAfterEvent("input:blur")},onInputMouseOver:function(e){this.node.addClass("mouseover")},onInputMouseOut:function(e){this.node.removeClass("mouseover")},onWindowResize:function(e){this.adjustGapSizeAfterEvent("window:resize")},onInteractionShow:function(){this.adjustGapSizeAfterEvent("interaction:show")},onStateUpdate:function(){this.adjustGapSizeAfterEvent("model:state_update")},onStateInput:function(){this.setInput()},onStateFeedback:function(){this.setAnswer()},onStateAnswers:function(){this.showAnswer(),this.adjustGapSizeAfterEvent("model:state_update:answers")},onStateInputFeedback:function(){this.setAnswerInput()},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},show_global_enumeration:function(bind_events){""!=this.inputValue()||this.model.charactersNumber||this.model.enumeration.then(function(enumSymbol){var enumText=a5.utils.enumText(this.model.enumSymbol);this.input.addClass("continuous-enumeration"),this.input.attr("id","enumeration-"+enumText),this.input.val(enumText)}.bind(this)),bind_events&&(this.input.on("focus",_.bind(this.hide_global_enumeration,this)),this.input.on("blur",_.bind(this.show_global_enumeration,this)))},hide_global_enumeration:function(){""!=this.inputValue()||this.model.charactersNumber||(this.input.removeClass("continuous-enumeration"),this.input.val(""))},setInput:function(){this.model.prefill||(this.model.isCorrectable()&&this.updateFeedbackState(this.node),this.input.val(this.model.value),this._canShowCharactersInGap()&&this._initCharactersInGap(),this.node.find(".check").remove(),this.input.attr("disabled",this.isLocked()),this.model.enumeration&&this.model.global_enumeration&&a5.dp.config.continuousEnumerationInsideGaps&&this.show_global_enumeration(),this.model.isFilled()||this.node.removeClass("filled"))},setAnswer:function(){if(!this.model.prefill){this.input.attr("disabled",!0),this.input.val(this.model.value);var setCheck=this.model.isCorrectable();this.setAnswerCheck(setCheck)}},setAnswerInput:function(){if(!this.model.prefill){var setCheck=this.model.isCorrectable()&&this.model.isFilled();this.setAnswerCheck(setCheck),this.updateAnswerInputState(setCheck)}},setAnswerCheck:function(check){this.node.find(".check").remove(),check&&(this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))},showAnswer:function(){if(!this.model.prefill&&(this.input.attr("disabled",!0),this.input.val(this.model.value),this.node.find(".check").remove(),this.model.isCorrectable())){this.updateFeedbackState(this.node);var correct=this.model.getCorrect();this.input.val(correct),this.node.addClass("filled"),this.model.isCorrect()?this.model.isCorrect()&&this.addCheck({correct:!0,tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getAnswerFeedback():this.model.value}):this.addCheck({empty:!this.model.isFilled(),tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getAnswerFeedback():this.model.value}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})}},updateFeedbackState:function(nodes){nodes.removeClass("input-checked-correct input-checked-incorrect input-checked-empty"),this._super(nodes)},updateAnswerInputState:function(check){check&&(this.model.isCorrect()?this.node.addClass("input-checked-correct"):!this.model.isFilled||this.model.isFilled()?this.node.addClass("input-checked-incorrect"):this.node.addClass("input-checked-empty"))},adjustGapSize:function(){if(this.inputValue()){var textWidth=this.input.textWidth();this.input.width(textWidth)}else this.adjustGapSizeToOriginal()},adjustGapSizeOnInput:function(){if(this.inputValue()){var textWidth=this.input.textWidth();textWidth>this.initialWidth?this.input.width(textWidth):this.input.width(this.initialWidth)}else this.initialWidth=this.originalInput&&this._getMaxWidthFor(this.originalInput)||0,this.adjustGapSizeToOriginal()},adjustGapSizeAfterEvent:function(eventType){return this.model.resizeGaps?void("input:change"===eventType?this.adjustGapSizeOnInput():this.adjustGapSize()):this.model.charactersNumber?void this.adjustGapSize():void this.adjustGapSizeToOriginal()},adjustGapSizeToOriginal:function(){if(this.originalInput){var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)}},adjustGapSizeToLongestResponse:function(response){if(this.originalInput={answer:response.answer,width:response.width},/[\s;]*width:/gi.test(this.model.inputStyle))return void _.extend(this.originalInput,{width:this.input.width()});var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)},adjustGapSizeToLongestCorrect:function(response){if(this.originalInput={answer:response.answer,width:response.width},/[\s;]*width:/gi.test(this.model.inputStyle))return void _.extend(this.originalInput,{width:this.input.width()});var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)},_createTextArea:function(){var $textarea=$("<textarea></textarea>");return $textarea.attr("style",this.model.inputStyle),$textarea.css({width:this.model.area[0],height:this.model.area[1]}),$textarea.attr("spellcheck",this.model.spellcheck),$textarea.attr("autocapitalize","off"),$textarea.attr("autocorrect","off"),$textarea.attr("aria-label","Blank input"),$textarea},_createTextInput:function(){var correct_and_distractors=_(this.model.correct).without("%0").concat(this.model.distractors),$input=this.model.charactersNumber||_.isEmpty(correct_and_distractors)||!_.all(correct_and_distractors,a5.utils.isInteger)?$('<input type="text" />'):$('<input type="number" />');return $input.attr("size",this.model.length),$input.attr("style",this.model.inputStyle),$input.attr("spellcheck",this.model.spellcheck),$input.attr("autocapitalize","off"),$input.attr("autocorrect","off"),$input.attr("autocomplete",$("body").is(".isChrome")?"none":"off"),$input.attr("aria-label","Blank input"),$input},_canShowCharactersInGap:function(){return!this.model.prefill&&!this.model.isDistractor()&&this.model.charactersNumber&&this.model.getMaskPattern().trim()},_initCharactersInGap:function(){$.mask.definitions["*"]=new RegExp("[^\\s"+this.TEXT_PLACEHOLDER+"]"),this.input.mask(this.model.getMaskPattern(),{autoclear:!1,allowpartial:!0}),this.input.attr("placeholder",this.model.getMaskPattern().replace(/\*/g,this.TEXT_PLACEHOLDER))},_getMaxWidthFor:function(response){if(/[\s;]*width:/gi.test(this.model.inputStyle))return response.width;var width=this.input.textWidth(response.answer);if(this.model.charactersNumber)if(0===response.width)width=this.input.textWidth(this.TEXT_PLACEHOLDER);else{var placeholderText=response.answer.replace(/\S/g,this.TEXT_PLACEHOLDER);width=_.max([width,this.input.textWidth(placeholderText)])}return width},_setFilled:function(){this.model.isFilled()?(this.node.addClass("filled"),this.pool_word&&$(this.pool_word).addClass("gap-filled")):(this.pool_word&&$(this.pool_word).removeClass("gap-filled"),this.node.removeClass("filled"))},_getPoolWord:function(){var result,pool_words;return this.model.display_words.length>0&&this.model.wordpool?(pool_words=this.model.wordpool.pool.find(".static_word").not(".display-word"),result=_.find(pool_words,function(word){return _.contains(this.model.display_words,$(word).text())},this),$(result).addClass("display-word")):this.model.wordpool&&(pool_words=this.model.wordpool.pool.find(".static_word"),result=_.find(pool_words,function(word){return _.contains(this.model.correct,$(word).text())},this)),result},_bindResize:function(){$(window).on("resize",this.onWindowResizeThrottled)},_unbindResize:function(){$(window).off("resize",this.onWindowResizeThrottled)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGap"),a5.views.interaction.ICMath={init:function(model,parent,interaction,options){this._super(model,parent,$('<div class="input-text"></div>')),this.options=options,this.node.addClass("has-input"),this.input=$('<input type="text" />'),this.input.attr("autocorrect","off"),this.input.attr("style",this.model.inputStyle),this.node.append(this.input),this.bindEvents(interaction),this.model.enumeration&&!this.model.global_enumeration&&(this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this)))},inputValue:function(){return this.hasContinuousEnumeration()?"":this.input.val().trim()},addContinuousEnumeration:function(){this.__continous_enumeration=!0,this.input.addClass("continuous-enumeration")},removeContinuousEnumeration:function(){this.__continous_enumeration=!1,this.input.removeClass("continuous-enumeration")},hasContinuousEnumeration:function(){return this.__continous_enumeration},bindEvents:function(interaction){_.bindAll(this,"_onFocus","_onBlur","_onMouseover","_onMouseout","_onChange","_onFocusGlobalEnumeration","_onBlurGlobalEnumeration","_onInputState","_onSetAnswerState","_onShowAnswerState","_onShowInteraction"),this.input.on("focus",this._onFocus),this.input.on("blur",this._onBlur),this.input.on("mouseover",this._onMouseover),this.input.on("mouseout",this._onMouseout),this.input.on("change",this._onChange),this.input.on("input",this._onChange),this.model.enumeration&&this.model.global_enumeration&&(this.input.on("focus",this._onFocusGlobalEnumeration),this.input.on("blur",this._onBlurGlobalEnumeration),this.model.enumeration.then(function(enumSymbol){this.input.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}.bind(this)),this._onBlurGlobalEnumeration()),this.model.bind("state_update:input",this._onInputState),this.model.bind("state_update:feedback",this._onSetAnswerState),this.model.bind("state_update:answers",this._onShowAnswerState),0===this.options.index&&a5.dp.config.ICTextgapActive&&interaction.bind("show:deferred",this._onShowInteraction)},checkLocked:function(nodes){this.lastState!==this.model.state&&(this._super(nodes),this.lastState=this.model.state)},_onShowInteraction:function(){this.input.focus()},_onFocus:function(){this.node.addClass("focused")},_onBlur:function(){this.node.removeClass("focused"),this.node.removeClass("mouseover"),this.resizeGaps()},_onMouseover:function(){this.node.addClass("mouseover")},_onMouseout:function(){this.node.removeClass("mouseover")},_onChange:function(){this.model.setValue(this.inputValue()),this.node.toggleClass("filled",this.model.isFilled()),requestAnimationFrame(_.bind(function(){this.resizeGaps()},this))},_onBlurGlobalEnumeration:function(){""===this.inputValue()&&(this.addContinuousEnumeration(),this.model.enumeration.then(function(enumSymbol){this.input.val(enumSymbol)}.bind(this)))},_onFocusGlobalEnumeration:function(){""===this.inputValue()&&(this.removeContinuousEnumeration(),this.model.enumeration.then(function(enumSymbol){this.input.val("")}.bind(this)))},_onInputState:function(){this.model.prefill||(this.updateFeedbackState(this.node),this._onStateChange({disable:this.isLocked(),value:this.model.value}),this.model.enumeration&&this.model.global_enumeration&&this._onBlurGlobalEnumeration(),this.node.toggleClass("filled",this.model.isFilled()))},_onSetAnswerState:function(){this.model.prefill||(this._onStateChange({disable:!0,value:this.model.value}),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))},_onShowAnswerState:function(){!this.model.prefill&&this.model.parent.showAnswers()&&(this.updateFeedbackState(this.node),this._onStateChange({disable:!0,value:this.model.getCorrect()}),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.value,empty:!this.model.isFilled()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}),this.model.resizeGaps&&this.adjustGapSize(!0))},_onStateChange:function(opts){this.input.attr("disabled",opts.disable),this.input.val(opts.value),this.node.find(".check").remove(),this.resizeGaps(),this.updateFeedbackState(this.node)},resizeGaps:function(){this.options.resize&&(this.inputValue()?this.adjustGapSize(!0):this.adjustGapSizeToDefault())},adjustGapSize:function(force){var width=this.input.textWidth(),lastWidth=this.__lastWidth||this.input.width();(force||width>lastWidth)&&(this.__lastWidth=width,this.input.width(width))},adjustGapSizeToDefault:function(){if(this.options.defaultSize.value)if("px"===this.options.defaultSize.measure)this.input.width(this.options.defaultSize.value);else{var measuredWidth=this.input.textWidth(this.options.defaultSize.value);this.input.width(measuredWidth)}}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICMath"),a5.views.interaction.ICMathQuizz={DEBOUNCE_INTERVAL:300,init:function(parameters){this._super(parameters.model,parameters.parent,$('<div class="input-text"></div>')),_.bindAll(this,"onContentChangeStarted","onContentChanged","onInputKeyup"),this.bindEvents(),this.onContentChangedDebounced=_.debounce(this.onContentChanged,this.DEBOUNCE_INTERVAL),this.onInputKeyupDebounced=_.debounce(this.onInputKeyup,this.DEBOUNCE_INTERVAL);var uiBuilder=this.model.wirisBuilder.getQuizzesUIBuilder();this.input=uiBuilder.newAnswerField(this.model.questionObject,this.model.questionInstance,0),this.bindWirisEvents()},render:function(){return this.node.addClass("has-input"),this.$hover=$('<div class="editorHover"></div>'),this.node.append(this.$hover),this.node.append($(this.input.getElement())),this.$hover.hide(),this.node},bindWirisEvents:function(){this.input.addQuizzesFieldListener({contentChanged:this.onContentChangedDebounced,contentChangeStarted:this.onContentChangeStarted}),this.input.getFieldType()===com.wiris.quizzes.api.ui.QuizzesUIConstants.TEXT_FIELD&&$(this.input.getElement()).find("input").keyup(this.onInputKeyupDebounced)},onContentChanged:function(){this.setValue(this.input.getValue())},onContentChangeStarted:function(){},onInputKeyup:function(){this.setValue(this.input.getValue())},bindEvents:function(){this.model.bind("state_update:input",this.onStateInput,this),this.model.bind("state_update:feedback",this.onStateFeedback,this),this.model.bind("state_update:answers",this.onStateAnswers,this),this.model.bind("restore",this.onRestore,this)},onStateInput:function(){this.setInput()},onStateFeedback:function(){this.setAnswer()},onStateAnswers:function(){this.showAnswer()},onRestore:function(){this.model.value&&this.input.setValue(this.model.value)},setValue:function(value){"input"===this.model.state&&this.model.setValue(value)},setInput:function(){this.model.prefill||(this.node.find(".check").remove(),this.$hover.hide(),this.model.isFilled()||this.node.removeClass("filled"),this.model.isCorrectable()&&this.updateFeedbackState(this.node),this.model.value&&this.input.setValue(this.model.value))},setAnswer:function(){this.model.prefill||(this.node.find(".check").remove(),this.$hover.show(),this.model.isCorrectable()&&(this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})))},showAnswer:function(){if(!this.model.prefill&&(this.node.find(".check").remove(),this.$hover.show(),this.model.isCorrectable())){this.updateFeedbackState(this.node);var correct=this.model.getCorrect();this.input.setValue(correct),this.node.addClass("filled"),this.model.isCorrect()?this.model.isCorrect()&&this.addCheck({correct:!0}):this.addCheck({correct:!1,empty:!this.model.isFilled()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})}}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICMathQuizz"),a5.views.interaction.ICTextGapInvisible={init:function(model,enumeration){this._super(model,null,$('<div class="contentblock"></div>'));var self=this;_.defer(function(){self.node.closest(".interaction").addClass("invisible")}),this.nodes=[],_.each(this.model.nodes,function(node){var view;node._instance_of("a5.models.interaction.ICTextGapInvisibleText")?(view=new a5.views.interaction.ICTextGapInvisibleText(node,self),self.node.append(view.render()),self.nodes.push(view)):node._instance_of("a5.models.interaction.ICTextGapInvisibleGap")&&(view=new a5.views.interaction.ICTextGapInvisibleGap(node,self),self.node.append(view.render()),self.nodes.push(view))}),enumeration&&(this.node.prepend('<span class="enumblock-placeholder"></span>'),enumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this)))},closeAll:function(){_.each(this.nodes,function(ca){ca.close()})}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGapInvisible"),a5.views.interaction.ICTextGapInvisibleText={init:function(model,parent){this._super(model,parent,$('<span class="word"></span>')),this.node.text(this.model.word)},close:function(){},updateState:function(){}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGapInvisibleText"),a5.views.interaction.ICTextGapInvisibleGap={init:function(model,parent){this._super(model,parent,$('<span class="input-text has-input"><span class="wrapper">&nbsp;<input type="text"></input>&nbsp;</span><span class="text"></span></span>')),this.wrapper=this.node.find(".wrapper").hide(),this.input=this.node.find("input"),this.text=this.node.find(".text"),this.model.hasAnswer()||this.node.addClass("no-answers"),this.debouncedUpdateInput=_.debounce(_.bind(this.inputUpdate,this),500),this.updateState(),this.updateValue()},updateState:function(){var self=this;this.node.unbind(),this.node.find(".check").remove(),this.model.prefill?this.node.addClass("prefill"):"input"==this.model.parent.state?this.node.click(function(e){self.parent.closeAll(),self.wrapper.show(),self.text.hide(),self.node.addClass("expanded"),self.node.unbind(),self.input.focus(),self.node.click(function(e){self.parent.closeAll()}),self.input.click(function(e){e.stopPropagation()}),self.input.bind("keyup change",function(e){self.model.setValue(self.input.val())}),self.input.blur(function(){self.parent.closeAll()})}):"feedback"==this.model.parent.state?this.model.hasAnswer()?this.addCheck({correct:this.model.isCorrect()}):this.model.isFilled()&&this.addCheck({correct:!1}):this.model.parent.state,this.updateValue()},close:function(){this.wrapper.hide(),this.text.show(),this.node.removeClass("expanded"),this.updateState()},inputUpdate:function(){this.input.val(this.model.value)},updateValue:function(){"answers"!=this.model.parent.state?(this.model.prefill?this.text.html(this.model.answers[0]):0==this.model.value.length?(this.text.html("&nbsp;"),this.node.addClass("empty")):(this.text.text(this.model.value),this.node.removeClass("empty")),this.debouncedUpdateInput()):this.model.hasAnswer()?(this.text.text(this.model.answers[0]),this.node.removeClass("empty")):(this.text.html("&nbsp;"),this.node.addClass("empty"))}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGapInvisibleGap"),a5.views.interaction.ICTextCorrectionLine={TEMPLATE:'<div class="contentblock"><div class="inputs"><div class="checkbox"><input type="checkbox"></input></div><div class="input"><input type="text"></input></div></div></div>',init:function(model,parent){this._super(model,parent,$(this.TEMPLATE));var self=this;model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),this.checkbox=this.node.find("input[type='checkbox']"),this.input=this.node.find("input[type='text']"),this.input.attr("autocapitalize","off"),this.input.attr("autocorrect","off"),this.input.attr("autocomplete","off"),model.answers.length>0&&_(model.answers).all(a5.utils.isInteger)&&this.input.attr("type","number"),_.defer(function(){self.node.closest(".interaction").addClass("line")}),_.each(this.model.nodes,function(node){var view=new a5.views.interaction.ICTextCorrectionLineText(node,self);self.node.append(view.render())}),this.node.addClass(this.model.userSelection),_.defer(_.bind(this.updateState,this)),this.model.bind("next-answer",this.onNextAnswer,this)},addCheck:function(options){
"feedback"==this.model.state&&("input"==options.context&&!this.model.inputUserAction||"checkbox"==options.context&&!this.model.checkboxUserAction)||"answers"==this.model.state&&"select_for_correct"==this.model.userSelection&&this.model.signalErrorsAlways&&!this.model.hasAnswer()||this._super(options)},updateState:function(){var self=this;this.input.attr("disabled","input"!=this.model.state||this.model.prefilled),this.checkbox.attr("disabled","input"!=this.model.state||this.model.prefilled),this.input.unbind(),this.checkbox.unbind(),this.node.find(".check").remove(),this.model.prefilled?(this.checkbox.attr("checked",this.model.answers.length>0),this.input.val(this.model.answers.length>0?this.model.answers[0]:""),this.$(".inputs").addClass("prefilled")):(this.checkbox.attr("checked",this.model.checked),this.input.val(this.model.value),_.each(this.model.nodes,function(n){return n.callViews("unmark")}),(this.model.signalErrorsEnabled||this.model.signalErrorsAlways)&&(_.each(this.model.nodes,function(n){n.wrong&&"select_for_error"==this.model.userSelection?(this.checkbox.attr("checked",!0),this.model.setChecked(!0),this.checkbox.attr("disabled",!0),n.callViews("mark")):n.wrong&&"select_for_correct"==this.model.userSelection?(this.checkbox.attr("checked",!1),this.model.setChecked(!1),this.checkbox.attr("disabled",!0),n.callViews("mark")):_.every(this.model.nodes,function(n){return!n.wrong})&&"select_for_correct"==this.model.userSelection&&(this.checkbox.attr("checked",!0),this.model.setChecked(!0),this.checkbox.attr("disabled",!0))},this),"select_for_correct"==this.model.userSelection&&this.input.attr("disabled",this.checkbox.is(":checked"))),"input"==this.model.state?(this.input.bind("keyup change",function(){self.model.inputUserAction=!0,self.model.setValue(self.input.val())}),this.checkbox.bind("change",_.bind(function(){this.model.setChecked(this.checkbox.is(":checked")),"select_for_correct"==this.model.userSelection&&this.input.attr("disabled",this.checkbox.is(":checked"))},this))):"feedback"==this.model.state?("select_for_error"==this.model.userSelection&&this.setFeedbackForError(),"select_for_correct"==this.model.userSelection&&this.setFeedbackForCorrect()):"answers"==this.model.state&&("select_for_error"==this.model.userSelection&&this.showAnswerForError(),"select_for_correct"==this.model.userSelection&&this.showAnswerForCorrect()))},setFeedbackForError:function(){var signalError=this.model.signalErrorsEnabled||this.model.signalErrorsAlways;!this.model.hasAnswer()&&this.model.isCheckCorrect()||signalError||this.addCheck({correct:this.model.isCheckCorrect(),parent:this.checkbox.parent(),context:"checkbox"}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),parent:this.input.parent(),context:"input"})},setFeedbackForCorrect:function(){var signalError=this.model.signalErrorsEnabled||this.model.signalErrorsAlways;this.model.hasAnswer()&&this.model.isCheckCorrect()||signalError||this.addCheck({correct:this.model.isCheckCorrect(),parent:this.input.parent(),context:"checkbox"}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),parent:this.input.parent(),context:"input"})},showAnswerForError:function(){this.checkbox.attr("checked",this.model.hasAnswer()),this.model.hasAnswer()?(this.input.val(this.model.answers[0]),this.model.isCorrect()||_.find(this.model.nodes,function(n){return n.wrong}).callViews("mark")):this.input.val(""),!this.model.hasAnswer()&&this.model.isCheckCorrect()||this.addCheck({correct:this.model.isCheckCorrect(),empty:!this.model.checked,parent:this.checkbox.parent(),context:"checkbox"}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),empty:0==this.model.value.length&&this.model.hasAnswer(),parent:this.input.parent(),context:"input"})},showAnswerForCorrect:function(){this.checkbox.attr("checked",!this.model.hasAnswer()),this.model.hasAnswer()?(this.input.val(this.model.answers[0]),this.model.isCorrect()||_.find(this.model.nodes,function(n){return n.wrong}).callViews("mark")):this.input.val(""),this.addCheck({correct:this.model.isCheckCorrect(),parent:this.input.parent(),context:"input"}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),empty:0==this.model.value.length,parent:this.input.parent(),context:"checkbox"})},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.input.parent())}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextCorrectionLine"),a5.views.interaction.ICTextCorrectionLineText={init:function(model,parent){this._super(model,parent,$('<span class="text"></span>')),this.node.append(this.model.text),this.updateState()},mark:function(){this.node.addClass("wrong")},unmark:function(){this.node.removeClass("wrong")},updateState:function(){this.model.wrong&&this.model.parent.prefilled&&this.$().addClass("prefilled"),"feedback"==this.model.parent.state&&this.bindAnswerFeedback(this.model,{correct:this.model.parent.isCorrect()})}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextCorrectionLineText"),a5.views.interaction.ICTextCorrectionSentence={init:function(model,parent){this._super(model,parent,$('<div class="contentblock"><div class="input"><textarea spellcheck="false"></textarea></div><div class="inputs"><div class="checkbox"><input type="checkbox"></input></div></div></div>'));var self=this;model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),this.checkbox=this.node.find("input[type='checkbox']"),this.input=this.node.find("textarea"),this.input.attr("autocapitalize","off"),this.input.attr("autocorrect","off"),this.input.attr("autocomplete","off"),this.input.attr("rows",this.model.getMaxTextRows()),(this.model.signalErrorsAlways||this.model.signalErrorsEnabled)&&this.node.addClass("signal-errors"),this.node.addClass(this.model.userSelection),_.bind(this.updateState,this),_.defer(function(){self.node.closest(".interaction").addClass("sentence"),self.updateState()}),this.model.bind("next-answer",this.onNextAnswer,this)},addCheck:function(options){if("feedback"!=this.model.state||!(options.parent.is(this.input.parent())&&!this.model.inputUserAction||options.parent.is(this.checkbox.parent())&&!this.model.checkboxUserAction)){if("answers"==this.model.state&&(options.parent.is(this.input.parent())&&!this.model.inputUserAction&&(options.empty=!0,options.correct=void 0),options.parent.is(this.checkbox.parent())&&!this.model.checkboxUserAction)){if(this.model.isCheckCorrect())return;options.empty=!0,options.correct=void 0}this._super(options)}},updateState:function(){var self=this;this.model.prefilled&&this.input.parent().addClass("prefilled"),this.input.attr("disabled","input"!=this.model.state||this.model.prefilled),this.checkbox.attr("disabled","input"!=this.model.state||this.model.prefilled),this.input.unbind(),this.checkbox.unbind(),this.node.find(".check").remove(),this.model.prefilled?(this.checkbox.attr("checked","select_for_correct"!=this.model.userSelection),this.input.val(this.model.getPermutations()[0])):(this.checkbox.attr("checked",this.model.checked),this.input.val(this.model.value),_.each(this.model.nodes,function(n){return n.callViews("unmark")}),(this.model.signalErrorsEnabled||this.model.signalErrorsAlways)&&(this.model.hasAnswer()?"select_for_correct"!=this.model.userSelection:"select_for_correct"==this.model.userSelection)&&(this.checkbox.attr("checked",!0),this.model.setChecked(!0),this.checkbox.attr("disabled",!0),"select_for_correct"==this.model.userSelection&&this.input.attr("disabled",!0)),"input"==this.model.state?(this.input.bind("keyup change",function(){self.model.inputUserAction=!0,self.model.setValue(self.input.val())}),this.checkbox.bind("change",function(){self.model.checkboxUserAction=!0,self.model.setChecked(self.checkbox.is(":checked"))}),"select_for_correct"==this.model.userSelection&&this.checkbox.bind("change",_.bind(function(){this.input.attr("disabled",this.checkbox.is(":checked"))},this))):"feedback"==this.model.state?(this.addCheck({correct:this.model.isCheckCorrect(),parent:this.checkbox.parent()}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),parent:this.input.parent()})):"answers"==this.model.state&&(this.model.hasAnswer()?(this.input.val(this.model.getPermutations()[0]),(!this.model.isCorrect()&&"select_for_correct"!=this.model.userSelection||this.model.isCorrect()&&"select_for_correct"==this.model.userSelection)&&this.checkbox.attr("checked",!0)):this.input.val(this.model.getInitialValue()),(this.model.hasAnswer()||!this.model.isCheckCorrect()||this.model.checkboxUserAction)&&this.addCheck({correct:this.model.isCheckCorrect(),empty:!this.model.checked,parent:this.checkbox.parent()}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),empty:0==this.model.value.length,parent:this.input.parent()})))},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.input.parent())}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextCorrectionSentence"),a5.view.interaction.ICTextCorrectionReplace={init:function(model,parent,classes){this._super(model,parent,$('<div class="contentblock ki24_view"><div class="inputs"><div class="checkbox"><input type="checkbox"></input></div> </div>')),this.node.addClass(classes),this.nodes=[],this.checkbox=this.node.find("input[type='checkbox']"),"off"===this.model.userSelection&&this.node.find(".inputs").hide(),this.bindEvents(),model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),_.defer(_.bind(function(){this.node.closest(".interaction").addClass("replace").toggleClass("user-selection","off"!==this.model.userSelection)},this)),this.node.addClass(this.model.userSelection),this.updateState(),this.model.bind("next-answer",this.onNextAnswer,this)},addCheck:function(options){this.model.checkboxChanged&&this._super(options),!options.correct&&options.empty&&this._super(options)},bindEvents:function(){this.checkbox.on("change",_.bind(function(){this.model.setChecked(!!this.checkbox.attr("checked"))},this)),this.model.bind("state_update",_.bind(this.updateState,this))},closeAllPopups:function(){this.model.sharedObject.editing&&this.model.sharedObject.editing.closePopup()},push:function(child){this.nodes.push(child),(this.model.isPrefilled()||this.model.signalErrorsAlways||this.model.signalErrorsEnabled)&&(this.checkbox.attr("disabled",!0),"select_for_error"===this.model.userSelection&&(this.model.hasAnswer()?this.checkbox.attr("checked",!0):this.checkbox.attr("checked",!1)),"select_for_correct"===this.model.userSelection&&(this.model.hasAnswer()?this.checkbox.attr("checked",!1):this.checkbox.attr("checked",!0)))},updateState:function(){this.node.find(".check").remove();var prefill=this.model.isPrefilled()||this.model.signalErrorsAlways||this.model.signalErrorsEnabled;"input"===this.model.state&&(prefill?(this.checkbox.attr("disabled",!0),"select_for_error"===this.model.userSelection&&(this.model.hasAnswer()?this.checkbox.attr("checked",!0):this.checkbox.attr("checked",!1)),"select_for_correct"===this.model.userSelection&&(this.model.hasAnswer()?this.checkbox.attr("checked",!1):this.checkbox.attr("checked",!0))):(this.checkbox.attr("disabled",!1),this.checkbox.attr("checked",this.model.checked))),"feedback"===this.model.state&&(this.checkbox.attr("disabled",!0),prefill||("select_for_correct"===this.model.userSelection?this.model.hasAnswer()&&this.model.isCheckCorrect()||this.addCheck({correct:this.model.isCheckCorrect(),parent:this.node.find(".inputs")}):"select_for_error"===this.model.userSelection?!this.model.hasAnswer()&&this.model.isCheckCorrect()||this.addCheck({correct:this.model.isCheckCorrect(),parent:this.node.find(".inputs")}):this.addCheck({correct:this.model.isCheckCorrect(),parent:this.node.find(".inputs")}))),"answers"===this.model.state&&(this.checkbox.attr("disabled",!0),prefill||this.addCheck({correct:this.model.isCheckCorrect(),parent:this.node.find(".inputs"),empty:!this.model.checkboxChanged}),this._setShowAnswersCheckbox())},onNextAnswer:function(){this._setShowAnswersCheckbox(),a5.utils.scrollIntoElementIfNeeded(this.checkbox)},_setShowAnswersCheckbox:function(){"select_for_error"===this.model.userSelection&&(this.model.hasAnswer()?this.checkbox.attr("checked",!0):this.checkbox.attr("checked",!1)),"select_for_correct"===this.model.userSelection&&(this.model.hasAnswer()?this.checkbox.attr("checked",!1):this.checkbox.attr("checked",!0))}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICTextCorrectionReplace"),a5.view.interaction.ICTextCorrectionReplaceText={ORIGINAL_TEXT_TEMPLATE:'<span class="original"></span>',SEPARATOR_TEXT_TEMPLATE:'<span class="whitespace"> </span>',ANSWER_TEXT_TEMPLATE:'<span class="answer"></span>',init:function(model,parent){this._super(model,parent,$('<span class="input-text"></span>')),this.updateState(),this.model.bind("state_update",_.bind(this.updateState,this)),this.model.bind("next_answer",this.onNextAnswer,this)},updateValue:function(){this.node.removeClass("modified");var children=this.node.children();this.node.contents().remove(),this.node.append(children),this.model.prefill?(this.node.empty(),this.node.append($(this.ORIGINAL_TEXT_TEMPLATE).text(this.model.text)),this.node.append($(this.SEPARATOR_TEXT_TEMPLATE)),this.node.append($(this.ANSWER_TEXT_TEMPLATE).text(this.model.answers[0])),this.node.addClass("prefilled")):("answers"===this.model.parent.state?this._showAnswerValue():this.node.append(this.model.value),this.model.isFilled()&&this.node.addClass("modified"),"answers"!==this.model.parent.state&&"answers"===this.model.state&&(this.node.addClass("modified"),this.node.contents().remove(),this._showAnswerCheck(),this._showAnswerValue()))},_showAnswerValue:function(){this.model.needsAnswer()?this.node.append(this.model.answers[0]):this.node.append(this.model.text)},updateState:function(){this.model.prefill||(this.node.unbind(),this.node.find(".check").remove(),this.updateFeedbackState(this.node),this.node.removeClass("correct wrong"),(this.model.parent.signalErrorsEnabled||this.model.parent.signalErrorsAlways)&&"input"===this.model.parent.state&&"answers"!==this.model.state&&this.node.addClass(this.model.needsAnswer()?"wrong":"correct"),"input"===this.model.parent.state&&"answers"!==this.model.state?this.node.click(_.bind(this.openPopup,this)):"feedback"===this.model.parent.state?(this.model.isFilled()&&this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})):"answers"===this.model.parent.state&&this._showAnswerCheck()),this.updateValue()},_showAnswerCheck:function(){this.model.needsAnswer()?this.model.isCorrect()?this.addCheck({correct:!0,tooltip:this.model.value}):this.addCheck({empty:!this.model.isFilled(),tooltip:this.model.value}):this.model.isFilled()&&this.addCheck({empty:!1,tooltip:this.model.value})},updateFeedbackState:function(nodes){if(nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct"),this.model.needsAnswer()||this.model.isFilled()){var type;if("feedback"===this.model.parent.state)type="checked";else{if("answers"!==this.model.parent.state)return;type="solution"}this.model.isCorrect()?nodes.addClass([type,"correct"].join("-")):this.model.isFilled()?nodes.addClass([type,"incorrect"].join("-")):nodes.addClass([type,"empty"].join("-"))}},openPopup:function(e){if(this.parent.closeAllPopups(),this.parent.model.sharedObject.editing=this,!$(e.target).hasClass("correct")){this.popup=$(window.a5.mainBuilder.layout.getTemplate("popupki24")),this.popup.css("min-width","256px"),(this.model.needsAnswer()&&_(this.model.answers).all(a5.utils.isInteger)||!this.model.needsAnswer()&&a5.utils.isInteger(this.model.text))&&this.popup.find("input").attr("type","number"),this.parent.node.append(this.popup),this.popup.find("h1").text(this.model.text);var container=a5.utils.scrollParent(this.parent.node),containerRight=container.left+container.width,viewportBottom=$(window).scrollTop()+$(window).height()-a5.dp.config.exclusionBottom,wordPosition=this.node.offset(),pushLeft=wordPosition.left+this.popup.width()-containerRight;pushLeft=pushLeft<0?0:pushLeft;var pushUp=this.node.offset().top+30+this.popup.height()-viewportBottom;pushUp=pushUp<0?0:this.popup.height()+30,this.popup.css({left:wordPosition.left-this.parent.node.offset().left-pushLeft,top:wordPosition.top-this.parent.node.offset().top+30-pushUp}),this.popup.find("a.close").click(_.bind(this.onClickClose,this)),this.popup.find("a:last").click(_.bind(this.onClickSubmit,this)),this.popup.find("input").attr("autocapitalize","off"),this.popup.find("input").attr("autocorrect","off"),this.popup.find("input").attr("autocomplete","off"),this.popup.find("input").keypress(_.bind(this.onKeypress,this)),this.node.addClass("editing"),this.popup.find("input").focus()}},onClickSubmit:function(e){e.preventDefault(),this.submitValue()},onClickClose:function(e){e.preventDefault(),this.closePopup()},onKeypress:function(e){13===e.keyCode&&this.submitValue()},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},submitValue:function(){var value=this.popup.find("input").val().trim();value.length>0&&this.model.setValue(value),this.closePopup()},closePopup:function(){this.node.removeClass("editing"),this.popup&&(this.popup.remove(),this.popup=!1),delete this.parent.model.sharedObject.editing}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICTextCorrectionReplaceText"),a5.view.interaction.ICTextCorrectionReplacePlain={init:function(model,parent){this._super(model,parent,$('<span class="text"></span>')),this.node.append(this.model.text)},updateState:function(){},closePopup:function(){}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICTextCorrectionReplacePlain"),a5.view.interaction.PPFlashcards={init:function(model,parent,mode,cardsPerRow){this._super(model,parent,$('<div class="fc_view"></div>')),this.mode=mode,this.cardsPerRow=cardsPerRow,_.each(this.model.cards,function(model,index){this.node.append(new a5.view.interaction.PPFlashcardsCard(model,this).render()),0!=cardsPerRow&&(index+1)%cardsPerRow==0&&this.node.append('<div style="clear:both"></div>')},this),this.node.addClass(mode)}},a5.views.interaction.BaseView.extend("a5.view.interaction.PPFlashcards"),a5.view.interaction.PPFlashcardsCard={init:function(model,parent,mode){this._super(model,parent,$(a5.mainBuilder.layout.getTemplate("flashcards"))),this.$(".front-container").append(this.model.front),this.$(".back-container").append(this.model.back),this.node.addClass(this.parent.mode),_.bindAll(this,"_onClick","_onKeydown"),this.model.parent.bind("update_state",this.updateState,this),this.model.bind("flipped",this.flipped,this),this.model.bind("update_flipped",this.updateFlipped,this),this.updateState(),this.updateFlipped(),this.model.beforeFlipAudioPlayback&&this.bindFlipOnAudioEnd()},updateState:function(){this.node.unbind(),"input"==this.model.state&&(this.node.on("click",this._onClick),this.node.on("keydown",this._onKeydown))},_onClick:function(){this.flip()},_onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.flip()},flip:function(){this.model.beforeFlipAudioPlayback?this._playAudioAndFlip():this.model.flip()},bindFlipOnAudioEnd:function(){var front_audio=a5.service.media.find(this.$(".front-container")),back_audio=a5.service.media.find(this.$(".back-container")),doFlip=function(){this.model.flip()};front_audio&&(front_audio.bind("stopped",doFlip,this),front_audio.bind("error",doFlip,this)),back_audio&&(back_audio.bind("stopped",doFlip,this),back_audio.bind("error",doFlip,this))},_playAudioAndFlip:function(){var current_container=this.model.flipped?this.$(".back-container"):this.$(".front-container"),audio=a5.service.media.find(current_container),doFlip=_.bind(function(){this.model.flip()},this);!audio||audio.isPlaying()||audio.hasError()?audio&&audio.isPlaying()||doFlip():(a5.service.media.audio.stopAllPlaying(),audio.play())},flipped:function(){this.node.toggleClass("flip"),this.model.flipped&&this.model.autoAudioPlayback&&a5.service.media.play(this.node)},updateFlipped:function(){this.model.flipped?this.node.addClass("flip"):this.node.removeClass("flip")}},a5.views.interaction.BaseView.extend("a5.view.interaction.PPFlashcardsCard"),a5.view.interaction.PPSlideshow={init:function(model,parent){this._super(model,parent,$('<div class="slideshow"><ul></ul></div>')),this.model.bind("change:slide",this.onSlideChange,this),this.model.bind("slide:magnify:start",this.onSlideMagnifyStart,this),this.model.bind("slide:magnify:stop",this.onSlideMagnifyStop,this),this.model.bind("slide:playing",this.onPlay,this),this.model.bind("slide:paused",this.onPaused,this),this.model.bind("slide:ending",this.onSlideEnding,this),this.slides=[],this.toolbar=new a5.view.interaction.PPSlideshowToolbar(this.model,this)},render:function(){return this.$slides=this.node.find("ul"),this.model.shuffle&&(this.model.slides=_.shuffle(this.model.slides)),_.each(this.model.slides,function(slide){var slideView=new a5.view.interaction.PPSlideshowSlide(slide,this);slideView.hide(),this.slides.push(slideView),this.$slides.append(slideView.render())},this),this.node.append(this.toolbar.render()),this.model.goFirst(),this.node},hideAll:function(){_(this.slides).invoke("hide")},toggleDecode:function(){_(this.slides).invoke("toggleDecode")},onSlideChange:function(old,cur){var oldView=this._getSlideView(old),curView=this._getSlideView(cur);oldView&&oldView.hide(),curView&&curView.show()},onSlideMagnifyStart:function(cur){var curView=this._getSlideView(cur);curView&&curView.startMagnify()},onSlideMagnifyStop:function(cur){var curView=this._getSlideView(cur);curView&&curView.stopMagnify()},onPlay:function(){this.playing=!0,this.node.addClass("playing")},onPaused:function(){this.playing=!1,this.node.removeClass("playing")},onSlideEnding:function(cur){var curView=this._getSlideView(cur);curView&&curView.beforeHide()},_getSlideView:function(slide){return _(this.slides).find(function(view){return view.model===slide})}},a5.views.interaction.BaseView.extend("a5.view.interaction.PPSlideshow"),a5.view.interaction.PPSlideshowSlide={DECODE:'<div class="decode-image"></div>',init:function(model,parent){this._super(model,parent,$("<li></li>"))},render:function(){return this.node.append(this.model.content),this.model.decode&&(this.$decode=$(this.DECODE).append(this.model.decode),this.$decode.hide(),this.node.append(this.$decode)),this.node},show:function(){this.node.show()},hide:function(){this.node.hide(),this.node.removeClass("slide-ending")},beforeHide:function(){this.node.addClass("slide-ending")},startMagnify:function(){this.node.addClass("slide-magnified")},stopMagnify:function(){this.node.removeClass("slide-magnified")},toggleDecode:function(){this.$decode&&this.$decode.toggle()}},a5.views.interaction.BaseView.extend("a5.view.interaction.PPSlideshowSlide"),a5.view.interaction.PPSlideshowToolbar={init:function(model,parent){this._super(model,parent,$('<div class="slideshow-toolbar"></div>')),this.model.bind("change:delay",this.onDelayChange,this),this.model.bind("change:slide",this.onSlideChange,this),this.model.bind("slide:playing",this.onPlay,this),this.model.bind("slide:paused",this.onPaused,this),_.bindAll(this,"onClickFirst","onClickLast","onClickPrev","onClickNext","onClickPlay","onClickDelayUp","onClickDelayDown","onClickShuffleOrder","onClickDefaultOrder","onClickToggleDecode","onPlay","onPaused")},render:function(){var template=a5.service.templates.render("a5.view.PPSlideshowToolbar",{automatic:this.model.automaticControl,shuffle:this.model.shuffleControl,decode:this.model.additionalImageControl});return this.node.append(template),this._renderManualControls(),this._renderAutomaticControls(),this._renderShuffleControls(),this._renderAdditionalImageControls(),this.node},_renderManualControls:function(){0!==this.node.find(".slideshow-manual-buttons").length&&(this.node.on("click","a#first-slide",this.onClickFirst),this.node.on("click","a#last-slide",this.onClickLast),this.node.on("click","a#prev-slide",this.onClickPrev),this.node.on("click","a#next-slide",this.onClickNext))},_renderAutomaticControls:function(){var $automaticControls=this.node.find(".slideshow-automatic-buttons");0!==$automaticControls.length&&(this.$delay=$automaticControls.find("#slide-delay"),this.$delay.html(this.model.delay+" sec"),this.$play=$automaticControls.find("a#slide-play"),this.$pause=$automaticControls.find("a#slide-pause"),this.$pause.hide(),this.playText=this.$play.text(),this.pauseText=this.$pause.text(),this.node.on("click","a#slide-play",this.onClickPlay),this.node.on("click","a#slide-delay-dec",this.onClickDelayDown),this.node.on("click","a#slide-delay-inc",this.onClickDelayUp))},_renderShuffleControls:function(){var $shuffleControls=this.node.find(".slideshow-shuffle-buttons");if(0!==$shuffleControls.length){$shuffleControls.find("a#slide-shuffle-order"),$shuffleControls.find("a#slide-default-order");this.node.on("click","a#slide-shuffle-order",this.onClickShuffleOrder),this.node.on("click","a#slide-default-order",this.onClickDefaultOrder)}},_renderAdditionalImageControls:function(){var $additionalImageControls=this.node.find(".slideshow-decode-buttons");0!==$additionalImageControls.length&&(this.$decode=$additionalImageControls.find("a#slide-show-decode"),this.$decodeHide=$additionalImageControls.find("a#slide-hide-decode"),this.$decodeHide.hide(),this.decodeShowText=this.$decode.text(),this.decodeHideText=this.$decodeHide.text(),this.node.on("click","a#slide-show-decode",this.onClickToggleDecode))},onClickFirst:function(e){e.preventDefault(),this.model.goFirst(),this.parent.playing&&this.model.interrupt()},onClickLast:function(e){e.preventDefault(),this.model.goLast(),this.parent.playing&&this.model.interrupt()},onClickPrev:function(e){e.preventDefault(),this.model.goPrev(),this.parent.playing&&this.model.interrupt()},onClickNext:function(e){e.preventDefault(),this.model.goNext(),this.parent.playing&&this.model.interrupt()},onClickPlay:function(e){e.preventDefault(),this.parent.playing?this.model.pause():this.model.play()},onClickDelayUp:function(e){e.preventDefault(),this.model.incDelay(),this.parent.playing&&this.model.interrupt()},onClickDelayDown:function(e){e.preventDefault(),this.model.decDelay(),this.parent.playing&&this.model.interrupt()},onDelayChange:function(delay){this.$delay.html(delay+" sec")},onClickShuffleOrder:function(e){e.preventDefault(),this.parent.hideAll(),this.model.shuffleOrder(),this.parent.playing&&this.model.interrupt()},onClickDefaultOrder:function(e){e.preventDefault(),this.parent.hideAll(),this.model.defaultOrder(),this.parent.playing&&this.model.interrupt()},onClickToggleDecode:function(e){e.preventDefault(),this.$decode.toggleClass("slide-decode-hidden");var text=this.$decode.hasClass("slide-decode-hidden")?this.decodeHideText:this.decodeShowText;this.$decode.text(text),this.parent.toggleDecode()},onSlideChange:function(old,cur){this.$decode&&(cur.decode?this.$decode.show():this.$decode.hide())},onPlay:function(){this.$play.text(this.pauseText)},onPaused:function(){this.$play.text(this.playText)}},a5.views.interaction.BaseView.extend("a5.view.interaction.PPSlideshowToolbar"),a5.views.interaction.RadioAccordion={init:function(model){this._super(model,null,$('<div class="radio-accordion"></div>')),this.children=[]},append:function(child){child.model.bind("before_activate",this.deactivateAll,this),this.children.push(child)},render:function(){return this._super(),_.each(this.children,function(child){this.node.append(child.render())},this),this.children.length>0&&this.children[0].model.activate(),this.node},deactivateAll:function(){_.each(this.children,function(child){child.model.deactivate()},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.RadioAccordion"),a5.views.interaction.RadioAccordionElement={init:function(model,classes){this._super(model,null,$('<div class="radio-section"></div>')),this.node.addClass(classes),model.bind("change:active",this.render,this)},render:function(){this._super(),this.node.off();var data={content:this.model.content,enum:'<span class="enumblock-placeholder"></span>'};return this.node.html(a5.service.templates.render("a5.view.RadioAccordion",data)),this.model.active&&this.model.alertNode.html(a5.service.templates.render("a5.view.RadioAccordionOpenAlert",data)),this.node.toggleClass("active",this.model.active),this.$(".selection-indicator").prop("checked",this.model.active),this.model.enumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol),this.model.alertNode.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this)),this.node.on("click",_.bind(function(e){e.preventDefault(),this.model.activate()},this)),this.node}},a5.views.interaction.BaseView.extend("a5.views.interaction.RadioAccordionElement"),a5.view.interaction.Syllabify={NODE_TEMPLATE:"<div class='syllabify-word'></div>",LETTER_TEMPLATE:"<span class='syllabify-letter'></span>",BREAK_TEMPLATE:"<span class='syllabify-break'></span>",SYLLABLE_TEMPLATE:"<span class='syllabify-syllable'></span>",SYLLABLE_WRONG_MARKER:"<span class='syllabify-marker'>&nbsp;</span>",GAP_TEMPLATE:"<span class='syllabify-gap'></span>",init:function(model){this.model=model,this.node=$(this.NODE_TEMPLATE),this.setInput(),this.model.tts_audio&&this.addTTSPlayer()},splitLetters:function(word){for(var result=[],buffer=[],inside=!1,i=0;i<word.length;i++)"|"!=word[i]?inside?buffer.push(word[i]):result.push(word[i]):(inside=!inside,buffer.join("")&&result.push(buffer.join("")),buffer=[]);return result},bindEvents:function(){this.model.bind("state_update:input",_.bind(this.setInput,this)),this.model.bind("state_update:feedback",_.bind(this.setAnswer,this)),this.model.bind("state_update:answers",_.bind(this.showAnswer,this))},addTTSPlayer:function(){var answer=this.model.correctResponse.values.join("").replace(/\|/g,"");this.tts_player=new a5.views.TTS_Player(answer),$(this.node).prepend(this.tts_player.render())},breakerClick:function(e){this.break_node&&(this.node.find(".syllabify-syllable.temp").removeClass("temp").removeClass("start").removeClass("end"),this.break_node.parent().is(".syllabify-syllable")&&this.break_node.unwrap(),this.break_node.replaceWith($(this.GAP_TEMPLATE)),this.break_node=void 0,this.setChoice())},setChoice:function(){var choice=[];this.node.find(".syllabify-syllable").each(function(i,el){var word="";$(el).find(".syllabify-letter").each(function(i,el){var letter=$(el).text();letter.length>1?word+="|"+letter+"|":word+=letter}),choice.push(word)}),this.model.setChoices(choice)},gapClick:function(e){e.preventDefault();var gap=$(e.currentTarget),next=gap.next(),prev=gap.prev();this._removeDeleting(),next.children(".syllabify-letter").appendTo(gap.prev()),next.remove(),1==this.node.find(".syllabify-syllable").length&&prev.children().first().unwrap(),gap.remove(),this.setChoice()},gapOver:function(e){e.preventDefault(),this._removeBreak(),this._removeEditing();var gap=$(e.currentTarget),next=gap.next(),prev=gap.prev();next.addClass("deleting"),prev.addClass("deleting")},gapOut:function(e){this._removeDeleting(),this._removeEditing()},wordOut:function(e){this._removeEditing(),this._removeBreak()},splitSyllable:function(e){if(!$(e.currentTarget).is(":last-child")){this._removeBreak(),this._removeDeleting();var current=$(e.currentTarget);this._removeEditing(),
current.parents(".syllabify-syllable").addClass("editing");var start=$(this.SYLLABLE_TEMPLATE).addClass("start temp"),end=$(this.SYLLABLE_TEMPLATE).addClass("end temp");this._addBreakAfter(current),this.break_node.nextAll().wrapAll(end);Array.prototype.reverse.call(this.break_node.prevAll()).wrapAll(start)}},_removeBreak:function(){this.break_node&&this.break_node.remove(),this.node.find(".syllabify-syllable.temp").each(function(i,group){$(group).children().first().unwrap()})},_removeEditing:function(){this.node.find(".editing").removeClass("editing")},_removeDeleting:function(){this.node.find(".deleting").removeClass("deleting")},_addBreakAfter:function(node){this.break_node=$(this.BREAK_TEMPLATE),this.break_node.insertAfter(node)},_removeChecks:function(){this.node.find(".check").remove()},_restoreChoices:function(){if(this.model.getChoices().length)_.each(this.model.getChoices(),function(syllable,i){syllable=this.splitLetters(syllable);var $syllable=$(this.SYLLABLE_TEMPLATE);_.each(syllable,function(letter){var $letter=$(this.LETTER_TEMPLATE);$letter.html(letter),$syllable.append($letter)},this),this.node.append($syllable),this.node.append($(this.GAP_TEMPLATE))},this),this.node.find(".syllabify-gap").last().remove();else{var letters=this.splitLetters(this.model.correctResponse.values.join(""));_.each(letters,function(letter){var node=$(this.LETTER_TEMPLATE);node.html(letter),this.node.append(node)},this)}},setInput:function(data){if(this.node.empty(),this._restoreChoices(),this.updateFeedbackState(this.node),/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)?this.bindTouchEvents():this.bindMouseEvents(),this.model.tryAgainIsFrozen){var correct=this.model.getCorrectResponse();correct=_.map(correct,function(syllable){return syllable.replace(/\|/g,"")}),this.node.find(".syllabify-syllable").each(_.bind(function(i,syllable){_.contains(correct,$(syllable).text())&&($(syllable).addClass("checked-correct-locked"),$(syllable).next(".syllabify-gap").addClass("checked-correct-locked"),correct.splice(correct.indexOf($(syllable).text()),1))},this))}},bindMouseEvents:function(){this.node.on("mouseover",".syllabify-letter",_.bind(this.splitSyllable,this)),this.node.on("mouseleave",_.bind(this.wordOut,this)),this.node.on("click",".syllabify-letter",_.bind(this.breakerClick,this)),this.node.on("click",".syllabify-break",_.bind(this.breakerClick,this)),this.node.on("mouseover",".syllabify-gap",_.bind(this.gapOver,this)),this.node.on("mouseout",".syllabify-gap",_.bind(this.gapOut,this)),this.node.on("click",".syllabify-gap",_.bind(this.gapClick,this))},bindTouchEvents:function(){this.node.on("touchstart",".syllabify-letter",_.bind(this.splitSyllable,this)),$(document.body).on("touchmove",".syllabify-letter",_.bind(this.touchMove,this)),this.node.on("touchend",".syllabify-letter",_.bind(this.breakerClick,this)),this.node.on("touchend",".syllabify-break",_.bind(this.breakerClick,this)),this.node.on("touchstart",".syllabify-gap",_.bind(this.gapOver,this)),this.node.on("touchend",".syllabify-gap",_.bind(this.gapClick,this))},touchMove:function(e){e.preventDefault();var touch=e.originalEvent.touches.item(0),element=document.elementFromPoint(touch.pageX,touch.pageY);$(element).is(".syllabify-letter")&&this.node.has(element).length?this.splitSyllable({currentTarget:element}):(this.wordOut(),this.gapOut())},setAnswer:function(data){this.node.off(),this.node.empty(),this._restoreChoices(),this.updateFeedbackState(this.node);var correct=this.model.getCorrectResponse();correct=_.map(correct,function(syllable){return syllable.replace(/\|/g,"")}),this.node.find(".syllabify-syllable").each(_.bind(function(i,syllable){if(_.contains(correct,$(syllable).text()))$(syllable).addClass("checked-correct"),$(syllable).next(".syllabify-gap").addClass("checked-correct"),this.addCheck({parent:$(syllable),correct:!0}),correct.splice(correct.indexOf($(syllable).text()),1);else{$(syllable).addClass("checked-incorrect");var gap=$(syllable).next(".syllabify-gap");gap.addClass("checked-incorrect");var prev=gap.prevAll().find(".syllabify-letter"),index=prev.text().length,tooltip=this.model.getFeedbackAt(index);this.addCheck({parent:$(syllable),correct:!1,tooltip:tooltip})}},this))},showAnswer:function(){this.node.off(),this.node.empty(),this._restoreChoices(),this.updateFeedbackState(this.node);var correctResponses=this.model.getCorrectResponse(),choices=this.model.getChoices(),breaks=[];_.each(choices.join(";"),function(letter,i){";"==letter&&breaks.push(i-breaks.length-1)});var letter_index=0;this.node.empty(),_.each(correctResponses,function(syllable,i){var $syllable=$(this.SYLLABLE_TEMPLATE);if(_.each(this.splitLetters(syllable),function(letter){var $letter=$(this.LETTER_TEMPLATE);$letter.html(letter),$syllable.append($letter);this.node.text().length;_.contains(breaks,letter_index)&&$syllable.append($(this.SYLLABLE_WRONG_MARKER)),letter_index+=1},this),0===choices.length)this.addCheck({empty:!0,parent:$syllable});else if(_.contains(choices,syllable))$syllable.addClass("solution-correct"),this.addCheck({correct:!0,parent:$syllable}),choices.splice(choices.indexOf(syllable),1);else{$syllable.addClass("solution-incorrect");var tooltip=this.model.getChoices().join("-").replace(/\|/g,"");this.addCheck({correct:!1,parent:$syllable,tooltip:tooltip})}this.node.append($syllable),this.node.append($(this.GAP_TEMPLATE))},this),this.node.find(".syllabify-gap").last().remove()},render:function(){return this.bindEvents(),this.node}},a5.views.interaction.BaseView.extend("a5.view.interaction.Syllabify"),a5.views.interaction.ISPelmanism={init:function(model,parent){this._super(model,parent,$('<div class="cards"></div>')),this.cardsPerRow=model.cardsPerRow,this.cardFormat=model.cardFormat,this.cardLayout=model.cardLayout,this.cardBack=model.cardBack,this.node.addClass("template-"+model.cards.length),this.model.bind("pair:match",this.onPairMatch,this)},render:function(){return this._createGame(),a5.eventBus.trigger("is-pelmanism:rendered",this.node),this.node},applyLayout:function(){var layoutNum=0,layoutClass=a5.mainBuilder.layout.getTemplate("pelmanism_card_layout-1");"landscape"===this.cardFormat?(layoutClass=a5.mainBuilder.layout.getTemplate("pelmanism_card_layout-2"),layoutNum=1):"portrait"===this.cardFormat&&(layoutClass=a5.mainBuilder.layout.getTemplate("pelmanism_card_layout-3"),layoutNum=2),this.cardsPerRow>0&&(layoutClass+=" "+a5.mainBuilder.layout.getTemplate("pelmanism_card_layout-4"),layoutNum=3),this.layoutNum=layoutNum,this.layoutClass=layoutClass;var df1_layouts=[],df2_layouts=[];if(df1_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img1-lay1")),df1_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img1-lay2")),df1_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img1-lay3")),df1_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img1-lay4")),df2_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img2-lay1")),df2_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img2-lay2")),df2_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img2-lay3")),df2_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img2-lay4")),"sets"===this.cardLayout){var i=0;_.each([1,2],function(index){_.each(this.model.cards,function(card){card.setNum===index&&(i++,this.addCard(card,df1_layouts,df2_layouts,layoutClass,layoutNum,i<=this.model.cards.length/2))},this)},this)}if("default"===this.cardLayout&&_.each(this.model.cards,function(card){this.addCard(card,df1_layouts,df2_layouts,layoutClass,layoutNum)},this),this.cardsPerRow>0)var t=setInterval(function(){if($("#content").width()>0){var gw=$("#content").width(),w=parseInt($(".panel.layout-4").css("width"),10),per=100/this.cardsPerRow-1;$(".panel").css("width",gw*per/100+"px");var h=parseInt($(".panel").css("height"),10),nw=parseInt($(".panel.layout-4").css("width"),10),nh=h*nw/w;$(".panel.layout-4").css("height",nh+"px"),$(".panel.layout-4 .back").css("height",nh+"px"),$(".panel.layout-4 .front").css("height",nh+"px"),clearInterval(t)}},100)},updateScores:function(){a5.mainBuilder.updateScoresAsync(),this.model.getScores().correct===this.model.getScores().total&&a5.mainBuilder.checkAnswer()},onPairMatch:function(parameters){a5.eventBus.trigger("is-pelmanism:match",parameters)},_createGame:function(){this.node.empty(),this.cards=[],this.model.shuffle(),this.applyLayout(),this.setPrefill(),this.model.setVisualOrder(_.pluck(this.cards,"model")),this.node.append("<div style='clear:both'></div>")},setPrefill:function(){this.model.setPrefill(),_(this.cards).invoke("setPrefill")},addCard:function(card,df1_layouts,df2_layouts,layoutClass,layoutNum,toggle){var view=new a5.views.interaction.ISPelmanismCard(card,this,df1_layouts,df2_layouts,layoutClass,layoutNum,toggle);return this.node.append(view.render()),this.cards.push(view),view}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISPelmanism"),a5.views.interaction.ISPelmanismCard={init:function(model,parent,df1_layouts,df2_layouts,layoutClass,layoutNum,toggle){var id,$t,t=a5.mainBuilder.layout.getTemplate("pelmanism_card");t=a5.mainBuilder.layout.replaceSubpart(t,"pelmanism_card_front",model.back);do{id=a5.utils.createUID()}while(new RegExp(id).test(t));t=a5.mainBuilder.layout.replaceSubpart(t,"pelmanism_card_back",'<div id="'+id+'"></div>'),$t=$(t).find("#"+id).replaceWith(model.content).end(),this._super(model,parent,$t),_.bindAll(this,"_onClick","_onKeydown"),this.$front=this.$(".front"),this.$back=this.$(".back"),this.$front.attr("data-front",model.identifier),this.$back.attr("data-back",model.identifier),this.$back.find("[data-playable-media]").length&&this.$back.addClass("has_audio_attached");var cards=parent.model.cards.length;this.$front.parents(".panel").addClass("layout-"+cards+"-cards"),this.df1_layouts=df1_layouts,this.df2_layouts=df2_layouts,this.layoutNum=layoutNum,this.layoutClass=layoutClass,this.toggle=toggle,this._bindEvents()},_bindEvents:function(){this.$front.off(),this.$front.on("click",this._onClick),this.node.on("keydown",this._onKeydown),this.model.bind("position:change",this._onCardChange,this),this.model.bind("state_update:input",this.tryAgain,this),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this)},showAnswer:function(){this.$(".check").remove(),this.flip(),this.node.removeClass("notpaired"),this.node.addClass("paired"),this.addCheck({correct:this.model.isCorrect(),parent:this.$back}),this.updateFeedbackState(this.node)},setAnswer:function(){this.$(".check").remove(),this.node.removeClass("paired notpaired"),this.$front.removeClass("found"),this.model.isCorrect()?(this.$front.addClass("found"),this.node.addClass("paired")):(this.node.addClass("notpaired"),setTimeout(_.bind(function(){this.node.removeClass("notpaired"),this.model.tryAgain()},this),a5.dp.config.pelmanismFailedPairTime)),this.addCheck({correct:this.model.isCorrect(),parent:this.$back}),this.updateFeedbackState(this.node),this.checkLocked()},tryAgain:function(){this.flop(),this.$(".check").remove(),this.updateFeedbackState(this.node)},flip:function(silent){this.$front.removeClass("active"),this.$back.addClass("active"),this.node.addClass("flip"),!silent&&this.model.autoAudioPlayback&&a5.service.media.play(this.$back)},flop:function(){this.$front.addClass("active"),this.$back.removeClass("active"),this.node.removeClass("flip")},_onCardChange:function(position,card,silent){"faceup"===position?this.flip(silent):this.flop()},_onClick:function(ev){this._startFlip()},_startFlip:function(){"input"===this.model.board.state&&(this.model.beforeFlipAudioPlayback?this._playAudioAndFlip():this.model.flip())},_onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this._startFlip()},_playAudioAndFlip:function(){var audio=a5.service.media.find(this.$back),doFlip=_.bind(function(){this.model.flip(!0)},this);!audio||audio.isPlaying()||audio.hasError()?audio&&audio.isPlaying()||doFlip():(a5.service.media.audio.stopAll(),audio.bind("stopped",doFlip,this),audio.bind("error",doFlip,this),audio.play())},setPrefill:function(){this.model.prefill&&setTimeout(_.bind(function(){this.flip(),this.node.addClass("prefill")},this),1e3)},applyLayout:function(){var defaultClass="";"default"===this.parent.cardLayout&&(defaultClass=" "+this.df1_layouts[this.layoutNum]),"default"===this.parent.cardBack?defaultClass=" "+this.df1_layouts[this.layoutNum]:"defaultsets"===this.parent.cardBack&&(defaultClass=" ",defaultClass+=1==this.model.setNum?this.df1_layouts[this.layoutNum]:this.df2_layouts[this.layoutNum]),this.parent.cardsPerRow>0&&(defaultClass=" ",defaultClass+=1==this.model.setNum?this.df1_layouts[this.layoutNum]:this.df2_layouts[this.layoutNum]),"sets"===this.parent.cardLayout&&(defaultClass=" "+(this.toggle?this.df1_layouts[this.layoutNum]:this.df2_layouts[this.layoutNum])),this.node.addClass(this.layoutClass),this.$front.addClass("active"+defaultClass)},render:function(){return this.applyLayout(),this.model.flop(),this.$("td img").attr("style",""),this.$("td").each(function(){_.isEmpty($(this).html().trim())&&this.toggle&&$(this).html("<img src='"+this.$front.css("background-image").replace("url(","").replace(")","").replace(/"/gi,"")+"' />")}),_.each(this.$back.find("td"),function(b){_.isEmpty($(b).html().trim())&&$(b).html("<img src='"+this.$front.css("background-image").replace("url(","").replace(")","").replace(/"/gi,"")+"' />")}),this.node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISPelmanismCard"),a5.views.interaction.IMVoice={init:function(model){this._super(model,null,$('<div class="input-voice"><div class="input-text"></div><div class="voice-panel"></div></div>')),_.bindAll(this,"onRecordStarted","onRecordEnded"),this.recording=new a5.views.interaction.SpeakingRecording(this.model.recording,{onSimpleRecordEnded:this.onRecordEnded,onSimpleRecordStarted:this.onRecordStarted}),this.model.bind("speech:result",this.onSpeechResult,this),this.model.bind("speech:error",this.onSpeechError,this)},render:function(){return this.node.find(".input-text").append(this.model.text),this.node.find(".voice-panel").append(this.recording.render()),this.node},onRecordStarted:function(){this.node.find(".input-text").html(this.model.text),this.node.removeClass("speech-result")},onRecordEnded:function(){this.model.speechToText()},onSpeechError:function(){logger.error("speech to text failed")},onSpeechResult:function(data){logger.info("speech-to-text: ["+data.text+"] with confidence "+data.confidence);var target=this.model.text.split(/\b/),words=data.text.split(" ");_.each(words,function(word){var index=_.findIndex(target,function(t){return word.toLowerCase()===t.toLowerCase()});index>=0&&(target[index]='<span class="matched">'+target[index]+"</span>")}),_.each(target,function(t,index){/^\w+$/i.test(t)&&(target[index]='<span class="no-matched">'+t+"</span>")}),this.node.find(".input-text").html(target.join("")),this.node.addClass("speech-result")}},a5.views.interaction.BaseView.extend("a5.views.interaction.IMVoice"),a5.views.interaction.BaseView.extend("a5.view.controls.Bar",{init:function(model){this._super(model,null,$("#activity_controls")),this.disableVisibility(),this.node.append(a5.service.templates.render("a5.view.controls.Bar",this.createTemplateModel())),this.noValidationInteractions=["Identify:Select:Maze","Identify:Select:Pelmanism","Identify:Select:Target game","Input:Creative:Dialogue recording","Input:Creative:Extended writing","Input:Creative:Free writing","Input:Creative:Free writing 2 col","Present:Present:Flashcards","Present:Present:Present"],this.noResetButton=[],a5.mainBuilder.options(!0).continuousEnumerationIsOn()&&(this.enumeration_nav=new a5.view.controls.EnumerationNavBar,this.node.prepend(this.enumeration_nav.render())),this.createButtonViews(),this.update(),this.enableVisibility(),a5.callbacks.controls.bar.trigger("added",this.node)},enableVisibility:function(){this.node.css("visibility","")},disableVisibility:function(){this.node.css("visibility","hidden")},createTemplateModel:function(){var interactions=[],showSubmitData=this.model.options(!0).getShowSubmit();if(this.model.introScreen){var nextButtonLabel=this.model.introScreen.options.getNextbuttontext();interactions.push({index:-1,name:0,nextButtonLabel:"default"===nextButtonLabel?"":nextButtonLabel})}return _.each(this.model.intList,function(i){if(!i.isEndResultScreen()){var nextButtonLabel=i.options.getNextbuttontext();interactions.push({index:i.index,name:i.index+1,nextButtonLabel:"default"===nextButtonLabel?"":nextButtonLabel})}}),{interactions:interactions,screenSelection:a5.mainBuilder.options(!0).progressBarIsScreenSelection(),submitText:showSubmitData.submitText,submitTooltip:showSubmitData.submitTooltip,nextButtonLabelSupport:!0}},createButtonViews:function(){this.views=[],_.each(this.$("*[data-event]"),function(e){switch($(e).attr("data-event")){case"special_chars":this.views.push(new a5.view.controls.SpecialCharsButton(this.model,this,$(e)));break;case"hints":this.__hints=new a5.view.controls.HintsButton(this.model,this,$(e)),this.views.push(this.__hints);break;case"pauseboxdrop":this.views.push(new a5.view.controls.PauseBoxdropButton(this.model,this,$(e)));break;case"toc":this.tocButton=new a5.view.controls.TocButton(this.model,this,$(e)),this.views.push(this.tocButton);break;case"display-settings":this.displaySettingsButton=new a5.view.controls.DisplaySettingsButton(this.model,this,$(e)),this.views.push(this.displaySettingsButton);break;case"rights":this.rightsButton=new a5.view.controls.RightsButton(this.model,this,$(e)),this.views.push(this.rightsButton);break;case"reveal":this.views.push(new a5.view.controls.RevealButton(this.model,this,$(e)));break;case"hide":this.views.push(new a5.view.controls.HideButton(this.model,this,$(e)));break;case"check":this.views.push(new a5.view.controls.Button(this.model,this,$(e)));break;default:this.views.push(new a5.view.controls.Button(this.model,this,$(e)))}},this),_.each(this.$("*[data-interaction]"),function(e){this.views.push(new a5.view.controls.InteractionButton(this.model,this,$(e)))},this),_.each(this.$(".scoredisplay"),function(e){this.views.push(new a5.view.controls.Score(this.model,this,$(e)))},this),_.each(this.$(".pagination"),function(e){this.views.push(new a5.view.controls.Pagination(this.model,this,$(e)))},this)},showHints:function(){this.__hints.showHint()},update:function(){_.invoke(this.views,"update")},getStatus:function(buttonId){if(_.isUndefined(buttonId)){var buttons=this._findAllButtons();return _.invoke(buttons,"serialize")}var button=this._findButtonById(buttonId);if(button)return button.serialize()},action:function(id){try{$("#model_text").dialog("close")}catch(e){}switch(id){case"check":this.model.options().checkanswersinstantIsOn()?this.model.checkAnswerInput():($("#content").addClass("inactive"),this.model.checkAnswer());break;case"answers":case"is-hangman-answers":$("#content").removeClass("inactive"),$("#content").addClass("inactive_activity"),this.model.showAnswer();break;case"next_answer":this.model.showNextAnswer();break;case"all_answer":this.model.showAllAnswer();break;case"solution_hint":this.model.showSolutionHint();break;case"forward":this.model.goNext();break;case"previous":this.model.goPrev();break;case"forward_skip":this.model.goLast(!0);break;case"previous_skip":this.model.goFirst();break;case"forward_lo":this.model.goToNextLO();break;case"previous_lo":this.model.goToPrevLO();break;case"retry":$("#content").removeClass("inactive"),$("#content").removeClass("inactive_activity"),this.model.tryAgain();break;case"reset":this.model.reset();break;case"reset_all":this.model.resetAll();break;case"reload_item_bank":this.model.reloadItemBank();break;case"boxdrop":this.model.curInteraction.trigger("boxdrop");break;case"pauseboxdrop":this.model.curInteraction.trigger("pause-boxdrop");break;case"reveal":this.model.reveal();break;case"hide":this.model.hideRevealed();break;case"hints":this.__hints.showHint();break;case"help_text":this.model.curInteraction.showHelpText();break;case"signal":this.model.curInteraction.signal();break;case"hide_signal":this.model.curInteraction.hideSignal();break;case"submit":this.model.submit();break;case"sendscores":this.model.sendScores();break;case"language_selector":break;case"results":this.model.trigger("score_update"),this.model.showResults();break;case"exercises":this.model.showExercises();break;case"save":this.model.save();break;case"mic_settings":a5.service.media.audio_recorder.ready().then(function(){a5.service.media.audio_recorder.instance().show_mic_settings()});break;case"special_chars":this.model.curInteraction.insertSpecialCharacterDialog();break;case"display-settings":this.displaySettingsButton.openDisplaySettings();break;case"toc":this.tocButton.openToc();break;case"export":this.model.curInteraction.insertExportDialog();break;case"book":this.model.openDigitalBook();break;case"lo-notes":this.model.openNotes();break;case"notes":this.model.showLessonNotes(this);break;case"lesson":this.model.showLesson(this);break;case"tools":this.model.toggleToolbox(this);break;case"wiki":this.model.showWiki(this);break;case"fullscreen":this.model.fullscreen();break;case"rights":this.rightsButton.openDialog();break;case"im-proofing-hint":this.model.curInteraction.trigger("im-proofing-hint")}},_findAllButtons:function(){return this.views.filter(function(button){return!!button.action})},_findButtonById:function(id){return this.views.find(function(button){return button.action&&button.action===id})}}),a5.view.controls.getEndResultButtonName=function(which){var ov="";return a5.mainBuilder.options().endResultScreenIsTrue()&&(ov=a5.mainBuilder.options().getEndResultScreen().split("|")),a5.mainBuilder.options().endResultAlwaysIsOn()&&(ov=a5.mainBuilder.options().getEndResultAlways().split("|")),2==ov.length&&ov[which]},a5.view.controls.statusReaders={results:function(model,button){if(!model.curInteraction)return[!1,!1];var visible=!1,active=!1;model.curInteraction.isEndResultScreen()||(model.options().endResultScreenIsTrue()?visible=active=(model.canSubmit||model.canSendScores)&&!model.isFirstAttempt():model.options().endResultAlwaysIsOn()&&(visible=active=!0));var buttonLabel=a5.view.controls.getEndResultButtonName(1);return buttonLabel&&button.node.text(buttonLabel),[visible,active]},special_chars:function(model,button){if(!model.curInteraction)return[!1,!1];var visible=model.options().getSpecialcharactersStudent().length>0,iID=model.curInteraction.identifier;if(visible=visible&&_.contains(["Input:Creative:Free writing","Input:Creative:Extended writing","Input:Completion:Crossword","Input:Completion:Text correction","Input:Completion:Text gap","Input:Completion:Text gap (Label an object)"],iID),_.contains(["Input:Creative:Free writing","Input:Creative:Extended writing"],iID)){var text_inputs_count=model.curInteraction.$(".a5-textinput").length;visible=visible&&0!=text_inputs_count}return[visible,a5.specialCharInserter.isActive()&&"input"===model.curInteraction.status]},exercises:function(model,button){if(!model.curInteraction)return[!1,!1];if(model.curInteraction.isEndResultScreen()){var buttonlabel=a5.view.controls.getEndResultButtonName(0);if(buttonlabel)return button.node.text(buttonlabel),[!0,!0]}return[!1,!1]},signal:function(model,button){if(!model.curInteraction)return[!1,!1];if(model.curInteraction.isEndResultScreen())return[!1,!1];var isTextCorrection="Input:Completion:Text correction"==model.curInteraction.identifier,isOff=model.options().signalErrorIsOff()||model.options().signalErrorIsHighlight(),isInputStatus="input"===model.curInteraction.getStatus(),isNotSignaled=!model.curInteraction.signalErrorActive,active=model.options().signalErrorIsButton()||model.options().signalErrorIsButtonAfterAttempts()&&model.canSubmit&&!model.hasMoreSubmitAttempts();return[isTextCorrection&&isNotSignaled&&!isOff,active&&isInputStatus]},hide_signal:function(model,button){if(!model.curInteraction)return[!1,!1];if(model.curInteraction.isEndResultScreen())return[!1,!1];var isTextCorrection="Input:Completion:Text correction"==model.curInteraction.identifier,isOff=model.options().signalErrorIsOff()||model.options().signalErrorIsHighlight(),isInputStatus="input"===model.curInteraction.getStatus(),isSignaled=model.curInteraction.signalErrorActive;return[isTextCorrection&&isSignaled&&!isOff,isInputStatus]},hints:function(model,button){if(!model.curInteraction)return[!1,!1];var visible=!1,active=!1;if(model.curInteraction.options.showhintsIsAlways())visible=!0,active=!0;else if(model.curInteraction.options.showhintsIsCheckScore()&&(visible=!0,model.curInteraction.lastScore)){var hints_with_attempts=model.curInteraction.options.getValue("318").split("|"),hintPercent=parseInt(hints_with_attempts[0],10),hintAttempts=parseInt(hints_with_attempts[1],10)||0,percent=model.curInteraction.lastScore.percent(!0),attempts=model.curInteraction.checkAttempts;percent<hintPercent&&attempts>=hintAttempts&&(active=!0)}return[visible,active]},help_text:function(model,button){return model.curInteraction&&model.curInteraction.options.activityhelpIsOn()?[!0,!0]:[!1,!1]},submit:function(model,button,scores_and_results){if(!model.curInteraction||model.curInteraction.isEndResultScreen()||model.options(!0).sendscoresIsFinal_check_answers()||"Formative"===LOInfo.mode)return[!1,!1];var active,results,afterCheckAnswers=!1;if(model.options().showForwardIsAfterCheckAnswers()){results=scores_and_results.results;var reachedSubmitAttempts=model.canSubmit&&!model.hasMoreSubmitAttempts(),reachedCheckMaxAttempts=!reachedSubmitAttempts&&!model.curInteraction.hasMoreCheckAttempts(),percentageTreshold=parseFloat(model.options().getShowForward())||0;afterCheckAnswers=model.options().showForwardIsAfterCheckAnswers()&&(button.isNoValidationInteraction()||"input"!==model.curInteraction.getStatus()&&(reachedCheckMaxAttempts||results.percent(!0)>=percentageTreshold)||"input"===model.curInteraction.getStatus()&&"answers"===model.curInteraction.items.state)}if(model.options(!0).finishSubmitIsOn())return active=model.curTask==model.numberOfInteractions()-1,[active,active];if(model.options(!0).showSubmitIsEachScreen())return model.hasMoreSubmitAttempts()?(active=!model.justSubmitted,model.options().showForwardIsAfterCheckAnswers()&&(active=active&&afterCheckAnswers),[!0,active]):[!1,!1];var visible=model.canSubmit&&model.curTask==model.numberOfInteractions()-1&&model.hasMoreSubmitAttempts();if(model.curInteraction){var afterAll=!0,afterOne=!1;_.each(model.intList,function(e){var scores=e.items.getScores();afterAll=afterAll&&model.options(!0).showSubmitIsAfterAll()&&scores.areAllFilled(),afterOne=afterOne||model.options(!0).showSubmitIsAfterOne()&&scores.isFirstFilled()});active=(model.options(!0).showSubmitIsAlways()||afterOne||afterAll)&&!model.justSubmitted,model.options().showForwardIsAfterCheckAnswers()&&(active=active&&afterCheckAnswers),active=active&&_.every(model.intList,function(interaction){return!interaction.options.showSubmitIsAfterAll()||interaction.items.meetsMinLength()})}if(model.options(!0).showSubmitIsOff()&&(visible=!1),model.options().seeAnswersIsBeforeInteraction()&&"Identify:Select:Pelmanism"===model.curInteraction.identifier&&model.options(!0).showSubmitIsAlways()){scores_and_results.scores;results=scores_and_results.results,active=active&&results.isPercent100(!0)||"answers"===model.curInteraction.getStatus()}return[visible,active]},check:function(model,button,scores_and_results){var scores,visible,active;if(!model.curInteraction)return[!1,!1];if(model.curInteraction.isEndResultScreen())return[!1,!1];if(model.options().checkanswersinstantIsOn())return visible=scores_and_results.scores.isFirstFilled(),active="input"===model.curInteraction.getStatus(),[visible,active];if(model.options(!0).finishSubmitIsOn())return[!1,!1];if(model.options().seeAnswersIsBeforeInteraction()&&(scores=scores_and_results.scores,"input"===model.curInteraction.getStatus()&&!scores.isFirstFilled()))return[!1,!1];var beforeSubmitted=model.options(!0).checkAnswersIsBeforeSubmitted()&&(!model.canSubmit||model.hasMoreSubmitAttempts());if(visible=model.options(!0).checkAnswersIsAlways()||model.options(!0).checkAnswersIsAfterAll()||model.options(!0).checkAnswersIsAfterOne()||beforeSubmitted,visible=visible&&!button.isNoValidationInteraction(),active="input"===model.curInteraction.getStatus()&&"answers"!==model.curInteraction.items.state,model.curInteraction){scores=scores_and_results.scores;var afterAll=model.options(!0).checkAnswersIsAfterAll()&&scores.areAllFilled(),afterOne=model.options(!0).checkAnswersIsAfterOne()&&scores.isFirstFilled();active=(model.options(!0).checkAnswersIsAlways()||afterOne||afterAll||beforeSubmitted)&&active}return model.options(!0).showSubmitIsOff()||!model.hasMoreSubmitAttempts()||model.options(!0).checkAnswersIsBeforeSubmitted()||(visible=!1),model.getCheckMaxAttemptsNumber()&&beforeSubmitted&&(active=model.curInteraction.hasMoreCheckAttempts()&&active),[visible,active]},next_answer:function(model,button){if(model.curInteraction){return[model.curInteraction.options.seenextanswerIsOn(),"answers"!==model.curInteraction.items.state&&"answers"!==model.curInteraction.getStatus()]}return[!1,!1]},all_answer:function(model,button){if(model.curInteraction){return[model.curInteraction.options.seeallanswersIsOn(),"answers"!==model.curInteraction.getStatus()]}return[!1,!1]},solution_hint:function(model,button){if(model.curInteraction){return[model.curInteraction.options.solutionHintIsOn(),model.curInteraction.canShowSolutionHint()&&!model.curInteraction.hasShownSolutionHint()&&"answers"!==model.curInteraction.getStatus()]}return[!1,!1]},answers:function(model,button,scores_and_results){var scores=scores_and_results.scores,results=scores_and_results.results;if(!model.curInteraction)return[!1,!1];if(model.curInteraction.isEndResultScreen())return[!1,!1];if(model.options(!0).finishSubmitIsOn())return[!1,!1];if(model.options().seeAnswersIsBeforeInteraction()){if("Identify:Select:Pelmanism"===model.curInteraction.identifier){if(results.isPercent100(!0))return[!1,!1];if("input"===model.curInteraction.getStatus()&&scores.isFirstFilled())return[!0,!0]}if("input"===model.curInteraction.getStatus()&&!scores.isFirstFilled())return[!0,!0];if("input"===model.curInteraction.getStatus()&&scores.isFirstFilled())return[!1,!1];if("corrected"===model.curInteraction.getStatus()&&scores.isFirstFilled()&&!results.isPercent100(!0))return[!0,!0]}var visible=model.options().seeAnswersIsOn();visible=visible&&(!model.options(!0).showSubmitIsOff()||!model.options(!0).checkAnswersIsFalse());var onlyCheckAnswersActive=model.options().showSubmitIsOff()&&!model.options().checkAnswersIsFalse();visible=visible&&(model.canSubmit&&!model.hasMoreSubmitAttempts()||onlyCheckAnswersActive);var active="corrected"===model.curInteraction.getStatus();if(visible=visible&&!button.isNoValidationInteraction(),model.curInteraction){var afterAll=model.options(!0).checkAnswersIsAfterAll()&&scores.areAllFilled(),afterOne=model.options(!0).checkAnswersIsAfterOne()&&scores.isFirstFilled(),always=model.options(!0).checkAnswersIsAlways(),scored100="corrected"===model.curInteraction.getStatus()&&results.isPercent100(!0),reachedSubmitAttempts=model.canSubmit&&!model.hasMoreSubmitAttempts();active=(always||afterOne||afterAll||reachedSubmitAttempts)&&!scored100&&active;if(model.getCheckMaxAttemptsNumber()&&!reachedSubmitAttempts){var checkAttemptsAvailable=model.curInteraction.hasMoreCheckAttempts();active=!checkAttemptsAvailable&&"answers"!==model.curInteraction.getStatus()&&!scored100,visible=model.options().seeAnswersIsOn()&&!checkAttemptsAvailable}}return[visible,active]},retry:function(model,button,scores_and_results){if(!model.curInteraction)return[!1,!1];if(model.curInteraction.isEndResultScreen())return[!1,!1];if(model.options(!0).finishSubmitIsOn())return[!1,!1]
;var reachedSubmitAttempts=model.canSubmit&&!model.hasMoreSubmitAttempts(),canCheckAnswersAfterSubmitted=model.options(!0).checkAnswersIsAlways()||model.options(!0).checkAnswersIsAfterAll()||model.options(!0).checkAnswersIsAfterOne(),visible=!model.options().tryAgainIsFalse();visible=visible&&model.options().tryAgainBehaviourIsButton(),visible=visible&&!button.isNoValidationInteraction(),visible=visible&&(!reachedSubmitAttempts||canCheckAnswersAfterSubmitted);var active="corrected"===model.curInteraction.getStatus()||"answers"===model.curInteraction.getStatus();active=active&&!model.curInteraction.isShowingAnswers(),active=active&&model.curInteraction.hasMoreCheckAttempts();var results=scores_and_results.results,scored100="corrected"===model.curInteraction.getStatus()&&results.isPercent100(!0),hide_tryagain_100=model.options().getTryAgain().indexOf("hide_at_100")>=0;return visible=visible&&(!scored100||!hide_tryagain_100),[visible,active]},reset:function(model,button){if(!model.curInteraction)return[!1,!1];if(model.curInteraction.isEndResultScreen())return[!1,!1];if(("Formative"===LOInfo.mode||"Summative"===LOInfo.mode)&&model.curInteraction.isIntroScreen())return[!1,!1];var visible=model.options().resetIsOn()||model.options().resetIsBeforeSubmitted()&&(!model.canSubmit||model.hasMoreSubmitAttempts());visible=visible&&!button.hideResetButton();return[visible,!0]},reset_all:function(model,button){if(!model.curInteraction)return[!1,!1];var lastScreen=model.curInteraction.isLastInteraction(!0),visible=model.options(!0).resetWholeLOIsOn()&&lastScreen&&(!model.canSubmit&&!model.canSendScores||!model.isFirstAttempt());return[visible,visible]},reload_item_bank:function(model,button){if(!model.curInteraction)return[!1,!1];var hasItemBank="item-bank"===model.curInteraction.source,visible=hasItemBank&&(model.options().resetIsOn()||model.options().resetIsBeforeSubmitted()&&(!model.canSubmit||model.hasMoreSubmitAttempts()));visible=visible&&!button.hideResetButton();return[visible,!0]},boxdrop:function(model,button){if(!model.curInteraction)return[!1,!1];return["Order:Sort:Box drop"==model.curInteraction.identifier,!0]},pauseboxdrop:function(model,button){if(!model.curInteraction)return[!1,!1];return["Order:Sort:Box drop"==model.curInteraction.identifier,!0]},reveal:function(model){return model.curInteraction?model.curInteraction.isEndResultScreen()?[!1,!1]:[!(model.options().revealObjectIsFalse()||model.curInteraction.revealIsHiding)||model.options().revealObjectIsProgressiveplushide()&&a5.dp.config.revealHideAlwaysVisible,model.curInteraction.contentWrap.find(".opt-021-hidden").length>0]:[!1,!1]},hide:function(model){return model.curInteraction?model.curInteraction.isEndResultScreen()?[!1,!1]:[model.options().revealObjectIsProgressiveplushide()&&(model.curInteraction.revealIsHiding||a5.dp.config.revealHideAlwaysVisible),!model.options().revealObjectIsProgressiveplushide()||model.curInteraction.contentWrap.find(".opt-021-revealed").length]:[!1,!1]},save:function(model){if(!model.curInteraction)return[!1,!1];var display=model.options().saveIsSkinbutton()||model.options().saveIsButton_only();return[display,display]},sendscores:function(model,button,scores_and_results){if(!model.curInteraction)return[!1,!1];if(model.curInteraction.isEndResultScreen()||model.options(!0).sendscoresIsFinal_check_answers())return[!1,!1];var visible=model.canSendScores&&model.curTask===model.numberOfInteractions()-1&&model.hasMoreSendScoreAttempts(),active=!0;if(model.options().showForwardIsAfterCheckAnswers()||model.options().showForwardIsAfterSeeAnswers()){var results=scores_and_results.results,reachedCheckMaxAttempts=model.hasMoreSendScoreAttempts()&&!model.curInteraction.hasMoreCheckAttempts(),percentageTreshold=parseFloat(model.options().getShowForward())||0,afterCheckAnswers=model.options().showForwardIsAfterCheckAnswers()&&(button.isNoValidationInteraction()||"input"!==model.curInteraction.getStatus()&&(reachedCheckMaxAttempts||results.percent(!0)>=percentageTreshold)||"input"===model.curInteraction.getStatus()&&"answers"===model.curInteraction.items.state),afterSeeAnswers=model.options().showForwardIsAfterSeeAnswers()&&(button.isNoValidationInteraction()||"answers"===model.curInteraction.getStatus()||"corrected"===model.curInteraction.getStatus()&&results.percent(!0)>=percentageTreshold||"input"===model.curInteraction.getStatus()&&"answers"===model.curInteraction.items.state);active=active&&(afterSeeAnswers||afterCheckAnswers)}return[visible,active]},previous:function(model){if(!model.curInteraction||model.curInteraction.isEndResultScreen()||model.curInteraction.isIntroScreen())return[!1,!1];var visible=model.options().previousIsTrue()||model.options().previousIsAfterSubmitted()&&model.canSubmit&&!model.hasMoreSubmitAttempts();return visible=visible&&model.hasPrev(),[visible,model.hasPrev()]},forward:function(model,button,scores_and_results){if(!model.curInteraction)return[!1,!1];var isPelmanism="Identify:Select:Pelmanism"===model.curInteraction.identifier,isSpeakingRecording="Present:Present:Present"===model.curInteraction.identifier&&model.curInteraction.getItemsByClass("a5.models.interaction.SpeakingRecording").length>0,isDialogueRecording="Input:Creative:Dialogue recording"===model.curInteraction.identifier,isPPFlashcards="Present:Present:Flashcards"===model.curInteraction.identifier;if(model.curInteraction.isEndResultScreen())return[!1,!1];var lastPage=!model.hasNext(!0),visible=model.options().showForwardIsAlways()||model.options().showForwardIsAfterOne()||model.options().showForwardIsAfterAll()||model.options().showForwardIsAfterCheckAnswers()||model.options().showForwardIsAfterSeeAnswers()||model.options().showForwardIsAfterSubmitted()&&model.canSubmit&&!model.hasMoreSubmitAttempts()||model.curInteraction.isIntroScreen()||button.isNoValidationInteraction();visible=visible&&!model.options().showForwardIsOff()&&model.hasNext(!0);var scores=scores_and_results.scores,results=scores_and_results.results,always=model.options().showForwardIsAlways(),afterOne=model.options().showForwardIsAfterOne()&&scores.isFirstFilled(),afterAll=model.options().showForwardIsAfterAll()&&(isPelmanism&&"answers"===model.curInteraction.getStatus()||scores.areAllFilled());(isPPFlashcards||isDialogueRecording||isSpeakingRecording)&&(afterOne=model.options().showForwardIsAfterOne()&&model.curInteraction.items.isFilled(),afterAll=model.options().showForwardIsAfterAll()&&model.curInteraction.items.areAllFilled());var reachedSubmitAttempts=model.canSubmit&&!model.hasMoreSubmitAttempts(),reachedCheckMaxAttempts=!reachedSubmitAttempts&&!model.curInteraction.hasMoreCheckAttempts(),percentageTreshold=parseFloat(model.options().getShowForward())||0,afterCheckAnswers=model.options().showForwardIsAfterCheckAnswers()&&(button.isNoValidationInteraction()||"input"!==model.curInteraction.getStatus()&&(reachedCheckMaxAttempts||results.percent(!0)>=percentageTreshold)||"input"===model.curInteraction.getStatus()&&"answers"===model.curInteraction.items.state),afterSeeAnswers=model.options().showForwardIsAfterSeeAnswers()&&(button.isNoValidationInteraction()||"answers"===model.curInteraction.getStatus()||"corrected"===model.curInteraction.getStatus()&&results.percent(!0)>=percentageTreshold||"input"===model.curInteraction.getStatus()&&"answers"===model.curInteraction.items.state),confidenceLevel=a5.mainBuilder.confidenceLevel,introAndConfidence=model.curInteraction.isIntroScreen();return introAndConfidence&&!_.isUndefined(confidenceLevel)&&(introAndConfidence=""!=confidenceLevel[0]||model.options().showForwardIsAfterSubmitted()&&""==confidenceLevel[1]),model.curInteraction.options.showForwardIsAfterAll()&&(afterAll=afterAll&&model.curInteraction.items.meetsMinLength()),[visible,(always||afterOne||afterAll||afterCheckAnswers||afterSeeAnswers||reachedSubmitAttempts||introAndConfidence)&&!lastPage]},previous_skip:function(model){if(!model.curInteraction)return[!1,!1];if(model.curInteraction.isEndResultScreen())return[!1,!1];if(model.curInteraction.isIntroScreen())return[!1,!1];var visible=model.options().previousIsTrue();return visible=visible&&model.numberOfInteractions()>2,[visible,model.hasPrev()]},forward_skip:function(model){if(!model.curInteraction)return[!1,!1];if(model.curInteraction.isEndResultScreen())return[!1,!1];var visible=model.options().showForwardIsAlways()||model.options().showForwardIsAfterOne();return visible=visible&&model.numberOfInteractions()>2,[visible,!!model.hasNext(!0)]},forward_lo:function(model,button){if(!model.curInteraction)return[!1,!1];var lastScreen=model.curInteraction.isLastInteraction(),active=model.hasNextLO();return[model.options().showNextLOIsOn()&&lastScreen&&(!model.canSubmit&&!model.canSendScores||!model.isFirstAttempt()),active]},previous_lo:function(model,button){if(!model.curInteraction)return[!1,!1];var lastScreen=model.curInteraction.isLastInteraction(),active=model.hasPrevLO();return[model.options().showPreviousLOIsOn()&&lastScreen&&(!model.canSubmit&&!model.canSendScores||!model.isFirstAttempt()),active]},mic_settings:function(model){return[!1,!1]},export:function(model){if(!model.curInteraction)return[!1,!1];var active=model.options().exportFileIsOn();return[active,active]},book:function(model){if(!model.curInteraction)return[!1,!1];var visible=!!window.LOInfo.bookUrl;return[visible,visible]},"lo-notes":function(model){return model.curInteraction?[model.options(!0).lONotesAreaIsOn(),!0]:[!1,!1]},notes:function(model){if(!model.curInteraction)return[!1,!1];var visible=model.lessonNotes&&model.lessonNotes.hasNotes();return[visible,visible&&!model.lessonNotes.isActive()]},lesson:function(model){if(!model.curInteraction)return[!1,!1];var visible=model.lessonNotes&&model.lessonNotes.hasNotes();return[visible,visible&&model.lessonNotes.isActive()]},tools:function(model){return model.curInteraction?[!0,!0]:[!1,!1]},wiki:function(model){if(!model.curInteraction)return[!1,!1];var visible=!!A5.WIKI&&model.curInteraction.wikiTool&&model.curInteraction.wikiTool.hasWiki();return[visible,visible]},fullscreen:function(model){if(!model.curInteraction)return[!1,!1];var visible=model.options().lOfullscreenbuttonIsOn();return[visible,visible]},"display-settings":function(model,button){if(!model.curInteraction)return[!1,!1];var visible=model.options(!0).displaySettingsIsOn();return[visible,visible]},toc:function(model,button){if(!model.curInteraction)return[!1,!1];var visible=!model.options(!0).navigationMenuIsOff();return[visible,visible]},rights:function(model,button){var visible=model.options().copyrightInformationIsOn()&&model.curInteraction.resources&&model.curInteraction.resources.length&&_.some(model.curInteraction.resources,"rights");return[visible,visible]},"im-proofing-hint":function(model,button){if(!model.curInteraction)return[!1,!1];var visible="Identify:Mark:Proofing"===model.curInteraction.identifier&&model.curInteraction.options.signaltargetsIsOn();return[visible,visible]},"is-hangman-answers":function(model,button){return model.curInteraction?["Identify:Select:Hangman"===model.curInteraction.identifier&&model.curInteraction.options.revealSolutionIsWith_button(),"answers"!==model.curInteraction.items.state&&"answers"!==model.curInteraction.getStatus()]:[!1,!1]}},a5.views.interaction.BaseView.extend("a5.view.controls.Button",{init:function(model,parent,node){this._super(model,parent,node),this.model.bind("frequent_score_update:deferred",this.update,this),this.action=this.node.attr("data-event"),this.getStatusFn=a5.view.controls.statusReaders[this.action],_.bindAll(this,"onClick"),this.node.on("click",this.onClick),this.hide(),this.disable()},isNoValidationInteraction:function(){return this.model.curInteraction&&_.contains(this.parent.noValidationInteractions,this.model.curInteraction.identifier)},hideSubmitButton:function(){return _.contains(this.parent.noValidationInteractions,this.model.curInteraction.identifier)},hideResetButton:function(){return _.contains(this.parent.noResetButton,this.model.curInteraction.identifier)},update:function(scores){var hasChanged=!1;if(_.isFunction(this.getStatusFn)){var status=this.getStatusFn(this.model,this,scores||this.model.getCurrentInteractionScores()),visible=status[0],active=status[1];active!==this.active&&(active?this.enable():this.disable(),hasChanged=!0),visible!==this.visible&&(visible?this.show():this.hide(),hasChanged=!0)}hasChanged&&a5.eventBus.trigger("lo:controls:change",this.serialize())},serialize:function(){return{action:this.action,visible:this.visible,active:this.active,label:this.node.text()}},onClick:function(e){e.preventDefault(),this.visible&&this.active&&this.execute()},execute:function(){this.parent.action(this.action)},hide:function(){this.visible=!1,this.node.css("display","none")},show:function(){this.visible=!0,this.node.css("display","")},enable:function(){this.active=!0,this.node.addClass("active_button"),this.node.removeClass("inactive_button")},disable:function(){this.active=!1,this.node.addClass("inactive_button"),this.node.removeClass("active_button")}}),a5.view.controls.Button.extend("a5.view.controls.PauseBoxdropButton",{execute:function(){this._super(),this.node.toggleClass("boxdrop-paused")}}),a5.view.controls.Button.extend("a5.view.controls.SpecialCharsButton",{init:function(model,parent,node){this._super(model,parent,node),a5.specialCharInserter.bind("active inactive",function(){_.delay(_.bind(function(){this.update()},this),600)},this)}}),a5.view.controls.Button.extend("a5.view.controls.HintsButton",{init:function(model,parent,node){this._super(model,parent,node),this.node.find(".hint-label.hint-2").hide(),this.node.find(".hint-label.hint-3").hide(),this.originalLabel1=this.node.find(".hint-label.hint-1").text(),this.originalLabel2=this.node.find(".hint-label.hint-2").text(),this.originalLabel3=this.node.find(".hint-label.hint-3").text(),_.bindAll(this,"onCloseHintDialog","beforeCloseHintDialog")},update:function(){this._super(),this.visible&&this.resetHintLabel()},onCloseHintDialog:function(){a5.mainBuilder.curInteraction.rubricZone.removeClass("hint-visible"),a5.mainBuilder.curInteraction.trigger("interaction:hint:close"),a5.mainBuilder.curInteraction.trigger("interaction:dialog:close"),delete this.$dialog},beforeCloseHintDialog:function(){a5.service.media.stop(this.$dialog)},showHint:function(){this.$dialog&&(this.$dialog.is(":ui-dialog")?this.$dialog.dialog("close"):this.$dialog.empty(),delete this.$dialog);var hints=this._getInteractionHints(a5.mainBuilder.curInteraction),hint=hints.items[hints.current].label;hint=(new a5.preprocessor.TextToSpeech).preprocess(hint),this.renderHint(hint),a5.mainBuilder.curInteraction.trigger("interaction:hint",hints.current),this.changeHintLabel(hints)},renderHint:function(label){$("<div>");a5.mainBuilder.curInteraction.rubricZone.addClass("hint-visible");var model={label:label,dialogClass:"dialog-hint"},callbacks={close:this.onCloseHintDialog,beforeclose:this.beforeCloseHintDialog};this.$dialog=a5.view.dialog.display("a5.view.dialog.Hint",model,callbacks,null,!0,a5.dp.config.appendHintsTo)},resetHintLabel:function(){var hints=this._getInteractionHints(a5.mainBuilder.curInteraction),label1=hints&&hints.items[0]&&hints.items[0].button||this.originalLabel1;this.node.find(".hint-label.hint-1").text(label1);var label2=hints&&hints.items[1]&&hints.items[1].button||this.originalLabel2;this.node.find(".hint-label.hint-2").text(label2);var label3=hints&&hints.items[2]&&hints.items[2].button||this.originalLabel3;this.node.find(".hint-label.hint-3").text(label3),this.showHintLabel(hints.current)},changeHintLabel:function(hints){hints.current=(hints.current+1)%hints.items.length,this.showHintLabel(hints.current)},showHintLabel:function(current){this.node.find(".hint-label").hide(),this.node.find(".hint-label.hint-"+(current+1)).show()},_getInteractionHints:function(interaction){if(interaction.hints)return interaction.hints;try{var hints=interaction.options.getHints();1==interaction.options.getVersion()&&(hints=hints.replace(/"/g,'\\"')),hints=JSON.parse(_.unescape(hints)),hints.current=0,interaction.hints=hints}catch(e){}return _.each(interaction.hints.items,function(item){var preprocessor=new a5.preprocessor.TranslationBlock;preprocessor.isResponsible(interaction,interaction.identifier,item.label)&&(item.label=preprocessor.preprocess(item.label))}),interaction.hints}}),a5.views.interaction.BaseView.extend("a5.view.controls.InteractionButton",{init:function(model,parent,node){this._super(model,parent,node),this.model.bind("frequent_score_update:deferred",this.update,this)},update:function(){var index=parseInt(this.$().attr("data-interaction"),10),interaction=-1==index?this.model.introScreen:this.model.intList[index];this.$().off("click"),this.$().removeClass("selected"),this.$().removeClass("finished"),this.$().removeClass("locked"),interaction&&interaction===this.model.curInteraction&&this.$().addClass("selected"),interaction&&interaction.getScores().areAllFilled()&&this.$().addClass("finished"),interaction&&interaction.locked?this.$().addClass("locked"):this.$().on("click",_.bind(this.click,this))},click:function(){this.model.goTo(parseInt(this.$().attr("data-interaction"),10))}}),a5.views.interaction.BaseView.extend("a5.view.controls.Score",{init:function(model,parent,node){this._super(model,parent,node),this.model.bind("frequent_score_update:deferred",this.update,this)},update:function(){if(this.model.options().runningscoreIsTrue()){this.$().show();var results=null;results=this.model.options().feedbackIsNormal()?this.model.getResults(function(i){return"input"!=i.status}):this.model.getResults(),this.$(".current-score").text(results.correct()),this.$(".total-score").text(results.total())}else this.$().hide()}}),a5.views.interaction.BaseView.extend("a5.view.controls.Pagination",{init:function(model,parent,node){this._super(model,parent,node),this.model.bind("frequent_score_update:deferred",this.update,this),a5.callbacks.controls.pagination.trigger("added",this.$())},update:function(){this.$(".current-page").text(this.model.curInteraction.visibleIndex),this.$(".last-page").text(this.model.getNumberOfInteractions()),this.model.options().progressBarIsFalse()?this.$().hide():this.$().show(),this.model.curInteraction&&this.model.curInteraction.isEndResultScreen()||this.model.options().progressBarIsAuto()&&this.model.getNumberOfInteractions()<=(this.model.options().introScreenIsOn()?0:1)?this.$().parent().hide():this.$().parent().show()}}),a5.views.interaction.BaseView.extend("a5.view.controls.EnumerationNavBar",{BUTTON_TEMPLATE:"<a class='nav-button' href='#'></a>",init:function(model,parent,node){this._super(model,parent,$("<div id='continous-enumeration-nav'></div>")),this.parts={},this.resetting=!1;var partsOption=a5.mainBuilder.options(!0).getLOParts();if(0!=partsOption.length){var last_part=void 0;_.each(partsOption,function(item){var part=new a5.view.controls.EnumerationNavPart(item.from,item.to,item.label,this);last_part=part,this.add_part(part)},this),this.node.hide(),last_part.bind("loaded",_.bind(function(){"Present:Present:Present"!=a5.mainBuilder.curInteraction.identifier&&this.node.show()},this))}},add_part:function(part){this.node.append(part.render())},render:function(){return this._super(),this.node}}),a5.views.interaction.BaseView.extend("a5.view.controls.EnumerationNavPart",{PART_TEMPLATE:"<div class='nav-part' id='screen-part-1'></span>",PART_LABEL_TEMPLATE:"<span>Part #</span>",init:function(start_interaction,end_interaction,label,parent){this._super(null,parent,$(this.PART_TEMPLATE)),this.$part=$(this.PART_LABEL_TEMPLATE),this.$part.html(label),this.buttons=[],this.interactions=_.range(start_interaction,end_interaction+1),_.each(this.interactions,function(interaction,i){this.add_interaction(a5.mainBuilder.intList[interaction-1],i)},this)},add_interaction:function(interaction,i){a5.callbacks.interaction.bind("loaded",_.bind(function(e){interaction==e&&interaction.enumerator&&(i==this.interactions.length-1&&this.trigger("loaded"),interaction.enumerator.done().then(function(offset){this.add_buttons(interaction,offset)}.bind(this)))},this))},add_buttons:function(interaction){var buttons=_.range(interaction.enumerator.offset+1,interaction.enumerator.counter+1),isCheckboxWithEnumInternalCorrect=interaction.options.enumerationinternalIsCorrect()&&"Identify:Select:Checkbox"==interaction.identifier,inputs=[];_.each(interaction.items.itemList,function(item){_.each(item.itemList,function(input){inputs.push(input)})});var inputIndex=0;_.each(buttons,function(n){var input,button,enumID=interaction.enumerator.getEnumSymbol(n,void 0,"|");if(enumID=enumID.replace(".",""),enumID=enumID.replace(")",""),!($("a[href=#enumeration-"+enumID+"]").length>0)){if(isCheckboxWithEnumInternalCorrect){input=this._getInputModelForCheckboxEnumCorrect(inputs,n);var firstEnumID=input.enumeration_internal[0];this._getInputView(firstEnumID),button=this._createButton(interaction,enumID,firstEnumID),input&&a5.mainBuilder.bind("frequent_score_update",_.bind(this._handleScoreUpdateForCheckboxEnumCorrect,this,input,firstEnumID))}else input=this._getInputModel(inputs,inputIndex),this._getInputView(enumID),button=this._createButton(interaction,enumID),input&&a5.mainBuilder.bind("frequent_score_update",_.bind(this._handleScoreUpdate,this,input,enumID));this.node.append(button),a5.callbacks.interaction.bind("showed",this._handleInteractionShowed),inputIndex++}},this)},render:function(){return this._super(),this.node.append(this.$part),this.node},_createButton:function(interaction,enumID,firstEnumID){var button=$("<a class='nav-button' data-interaction='"+interaction.index+"'>"+enumID+"</a>"),enumerationID=firstEnumID||enumID;return button.attr("href","#enumeration-"+enumerationID),button.on("click",function(e){e.preventDefault(),a5.mainBuilder.goTo(interaction.index);var node=$(button.attr("href"));_.delay(function(){node[0]&&(node.focus(),node.find(".expandable-question").trigger("expandable-show"),node.parents(".mCustomScrollbar").mCustomScrollbar("scrollTo",button.attr("href")))},0)}),button},_getInputModel:function(inputs,index){return inputs[index]},_getInputModelForCheckboxEnumCorrect:function(inputs,index){return _.find(inputs,function(input){return _.contains(input.enumeration_internal,index)})},_getInputView:function(enumID){var $view=$("#enumeration-"+enumID);return $view&&$view.on("focus",function(e){e.preventDefault(),$("#continous-enumeration-nav .nav-button").removeClass("selected"),$("#continous-enumeration-nav .nav-button[href=#enumeration-"+enumID+"]").addClass("selected")}),$view},_handleScoreUpdateForCheckboxEnumCorrect:function(input,enumID){var $buttons=$("#continous-enumeration-nav .nav-button[href=#enumeration-"+enumID+"]");_.each($buttons,function(button,index){index<input.totalSelected()?$(button).addClass("finished"):$(button).removeClass("finished")})},_handleScoreUpdate:function(input,enumID){var scores=input.getScores(),$buttons=$("#continous-enumeration-nav .nav-button[href=#enumeration-"+enumID+"]");scores.areAllFilled()?$buttons.addClass("finished"):$buttons.removeClass("finished")},_handleInteractionShowed:function(showedInteraction){"Present:Present:Present"!=showedInteraction.identifier?$("#continous-enumeration-nav").show():$("#continous-enumeration-nav").hide(),$("#continous-enumeration-nav .nav-button").removeClass("selected"),$("#continous-enumeration-nav .nav-button[data-interaction="+showedInteraction.index+"]").addClass("selected")}}),a5.view.controls.Button.extend("a5.view.controls.TocButton",{openToc:function(){new a5.view.Toc({lo:this.model}).show()}}),a5.view.controls.Button.extend("a5.view.controls.DisplaySettingsButton",{openDisplaySettings:function(){new a5.view.DisplaySettings({lo:this.model}).show()}}),a5.view.controls.Button.extend("a5.view.controls.RevealButton",{init:function(model,parent,node){this._super(model,parent,node),this.originalRevealLabel=this._getLabelText(),_.bindAll(this,"onInteractionShowed"),a5.callbacks.interaction.bind("showed",this.onInteractionShowed)},onInteractionShowed:function(interaction){this.model.curInteraction===interaction&&this.updateButton(interaction)},updateButton:function(interaction){var revealObjectData=interaction.options.getRevealObject(),label=revealObjectData.revealLabel||this.originalRevealLabel;this._setLabelText(label)},_getLabelText:function(){var $tooltip=this.node.find(".tooltip").detach(),text=this.node.text();return this.node.append($tooltip),text},_setLabelText:function(text){var $tooltip=this.node.find(".tooltip").detach();this.node.text(text),this.node.append($tooltip)}}),a5.view.controls.Button.extend("a5.view.controls.HideButton",{init:function(model,parent,node){this._super(model,parent,node),this.originalHideLabel=this._getLabelText(),_.bindAll(this,"onInteractionShowed"),a5.callbacks.interaction.bind("showed",this.onInteractionShowed)},onInteractionShowed:function(interaction){this.model.curInteraction===interaction&&this.updateButton(interaction)},updateButton:function(interaction){var revealObjectData=interaction.options.getRevealObject(),label=revealObjectData.hideLabel||this.originalHideLabel;this._setLabelText(label)},_getLabelText:function(){var $tooltip=this.node.find(".tooltip").detach(),text=this.node.text();return this.node.append($tooltip),text},_setLabelText:function(text){var $tooltip=this.node.find(".tooltip").detach();this.node.text(text),this.node.append($tooltip)}}),a5.view.controls.Button.extend("a5.view.controls.RightsButton",{openDialog:function(){new a5.view.RightsView({resources:this.model.curInteraction.resources}).show()}}),a5.preprocessor.Preprocessor={hasTag:function(txt,tag,separator){return this.getTagRegExp(tag,separator).test(txt)},replaceTag:function(txt,tag,callback,separator){var self=this,re=this.getTagRegExp(tag,separator,!0);return txt.replace(re,function(_,__,args){if(args){args=args.split("*");for(var i=0;i<args.length-1;i++)a5.utils.endsWith(args[i],"\\")&&args.splice(i,2,args[i].slice(0,-1).concat("*",args[i+1]))}else args=[];return callback.apply(self,args)})},getTagRegExp:function(tag,separator,glob){var flag=glob?"gi":"i";return separator=separator||"\\*",new RegExp("#"+tag+"("+separator+"([\\s\\S]*?[^&]))?#",flag)},createXmlTag:function(tag,content,attributes){var xml="<"+tag;return _.each(attributes,function(value,attr){void 0!==value&&(xml+=" "+attr+"='"+value.toString().replace(/'/g,"&apos;")+"'")}),content?xml+">"+content+"</"+tag+">":xml+"/>"},replaceTagWithXml:function(txt,tag,xmltag){return xmltag=xmltag||tag,this.replaceTag(txt,tag,function(){return this.createXmlTag(xmltag)})},isResponsible:function(interaction,identifier,input){return!0}},Obj.extend("a5.preprocessor.Preprocessor"),a5.preprocessor.preprocessors=[],a5.preprocessor.apply=function(input,interaction){var identifier=a5.utils.getIdentifier(input)||interaction.identifier;return _.each(a5.preprocessor.preprocessors,function(prep){prep.isResponsible(interaction,identifier,input)&&(input=prep.preprocess(input,interaction))}),input},a5.preprocessor.applyToXMLText=function(text,interaction){return a5.preprocessor.apply(text,interaction)},a5.preprocessor.applyToXMLNode=function(xml,interaction,exclude){var excludeIds=exclude.split(" "),skipTexts={};_.each(excludeIds,function(excludeId){var skip=$(xml).find("#"+excludeId);skip.length&&(skipTexts[excludeId]=a5.utils.serializeXML(skip[0]),skip.empty())});var xmlText=a5.utils.serializeXML(xml);_.each(a5.preprocessor.preprocessors,function(prep){prep.isResponsible(interaction,interaction.identifier,xmlText)&&(xmlText=prep.preprocess(xmlText,interaction))});var resultXml=$.parseXML(xmlText);return _.each(excludeIds,function(excludeId){var skipText=skipTexts[excludeId],skip=$(resultXml).find("#"+excludeId);if(skipText){var skipXml=$.parseXML(skipText),clone=$(skipXml).find("#"+excludeId).clone();skip.after(clone),skip.remove()}}),resultXml},a5.preprocessor.OSSorting={isResponsible:function(interaction,identifier,txt){return"Order:Sort:Sorting"===identifier},preprocess:function(xml){return xml=xml.replace(/<p>\s*<\/p>/gi,""),xml=xml.replace(/<p\/>/gi,"")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.OSSorting"),a5.preprocessor.preprocessors.push(new a5.preprocessor.OSSorting),a5.preprocessor.TextToSpeech={isResponsible:function(interaction,identifier,xml){return interaction.options.audiosupportIsTrue()},preprocess:function(xml){return xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/p>/gi,"<TextToSpeechPlayer/></p>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/tr>/gi,"<TextToSpeechPlayer/></tr>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/h1>/gi,"<TextToSpeechPlayer/></h1>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/h2>/gi,"<TextToSpeechPlayer/></h2>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/h3>/gi,"<TextToSpeechPlayer/></h3>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/h4>/gi,"<TextToSpeechPlayer/></h4>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/h5>/gi,"<TextToSpeechPlayer/></h5>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/li>/gi,"<TextToSpeechPlayer/></li>")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.TextToSpeech"),a5.preprocessor.preprocessors.push(new a5.preprocessor.TextToSpeech),a5.preprocessor.ClueLink={regex:/##h##([\s\w\W]*?)##h##/g,regex_responsible:/(#(CLUETEXT|CLUEWORD).*#)|(##h##([\s\w\W]*?)##h##)/i,isResponsible:function(interaction,identifier,txt){return this.regex_responsible.test(txt)},preprocess:function(txt){var clueLink=txt.match(this.regex);return null!=clueLink&&_.each(clueLink,function(s){var arr=s.replace(/##h##/g,"").split("*"),str=" invalid clue link ";2==arr.length?str='<clueLink cid="'+arr[1]+'">'+arr[0]+"</clueLink>":3==arr.length&&(str='<clueTarget cid="'+arr[1]+'" color="'+arr[2].replace(/#/g,"")+'">'+arr[0]+"</clueTarget>"),txt=txt.replace(s,str)}),txt=this.replaceTag(txt,"highlight",function(text,cid){return this.createXmlTag("clueLink",text,{cid:cid})}),txt=this.replaceTag(txt,"highlight-area",function(text,cid,color){return this.createXmlTag("clueTarget",text,{cid:cid,color:color.replace(/#/g,"")})}),txt=this.replaceTag(txt,"clueword",function(){var cid=_(arguments).initial().join("*"),text=_(arguments).last(),texts=[];return _(text.split("|")).each(function(text,index){texts.push(this.createXmlTag("clueLabel",text,{cid:cid}))},this),this.createXmlTag("clueLink",texts.join(""),{cid:cid})}),txt=this.replaceTag(txt,"cluetext",function(cid,text,color){return this.createXmlTag("clueTarget",text,{cid:cid,color:color})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ClueLink"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ClueLink),a5.preprocessor.Hidden={regex:/#hidden([\d]*)#/i,isResponsible:function(interaction,identifier,xml){return this.regex.test(xml)},preprocess:function(txt){return txt=txt.replace(/#hidden([\d]+)#/gi,"#hidden*$1#"),txt=this.replaceTag(txt,"hidden",function(){var args=[];args.push.apply(args,arguments);var opts;return args[0]&&(opts={prio:args[0]}),this.createXmlTag("hidden",null,opts)})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Hidden"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Hidden),a5.preprocessor.Buddy={regex:/#(buddy|endbuddy).*#/i,triggerBuddy:_.once(function(){var buddyConf;try{buddyConf=JSON.parse(A5.BUDDY_CONFIG)}catch(e){logger.error("Wrong JSON format of A5.BUDDY_CONFIG: ",A5.BUDDY_CONFIG)}buddyConf&&a5.eventBus.trigger("lo:hasBuddy",buddyConf)}),isResponsible:function(interaction,identifier,xml){var hasBuddy=this.regex.test(xml);return hasBuddy&&this.triggerBuddy(),hasBuddy},preprocess:function(xml){return xml=xml.replace(/(<p>)(#buddy\|)(.+?)(#)(?!\w)/gi,"<div id='buddy' data-state='$3'><p class='buddy-remove'>"),xml=xml.replace(/\s*<p>#endbuddy*#/gi,"</div><p class='buddy-remove'>"),xml=xml.replace(/(<p>)(.*?)(#buddyaudio\*)(.*?)(<object )(.+?)([\/>|<\/object>])(#)(.*?)(?!\w)/gim,"<p class='buddyAudioContainer'>$5$6$7"),xml=xml.replace(/<p class='buddy-remove'>(.*?)<\/p>\s*/g,"")}},
a5.preprocessor.Preprocessor.extend("a5.preprocessor.Buddy");a5.preprocessor.preprocessors.push(new a5.preprocessor.Buddy),a5.preprocessor.TextToggle={regex:/#(toggleText|tt).*#/i,isResponsible:function(interaction,identifier,txt){return this.regex.test(txt)},preprocess:function(txt){return txt=txt.replace(/#toggleText-?([\s\w\W]*?)#/g,function(match,text){return"<toggletext>"+(text=text||"Toggle")+"</toggletext>"}),txt=txt.replace(/#tt#(.*?)#\/tt#/gi,function(match,text){return"<togglingtext>"+text+"</togglingtext>"}),txt=this.replaceTag(txt,"toggletext",function(label){return this.createXmlTag("toggletext",label||"Toggle")}),txt=this.replaceTag(txt,"tt",function(text){return this.createXmlTag("togglingtext",text)})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.TextToggle"),a5.preprocessor.preprocessors.push(new a5.preprocessor.TextToggle),a5.preprocessor.ShowAnswer={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"answer")},preprocess:function(txt){return txt=txt.replace(/#answer\*(\d+),screen\*(\d+)#/g,function(match,answer,screen){return'<answer id="'+answer+'" screen="'+screen+'"/>'}),txt=this.replaceTag(txt,"answer",function(screen,answer){return this.createXmlTag("answer",null,{id:answer,screen:screen})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ShowAnswer"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ShowAnswer),a5.preprocessor.DynamicRadio={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"dynamicradio")},preprocess:function(txt){return txt=this.replaceTag(txt,"dynamicradio",function(screen,answer){for(var columns=[],i=2;i<arguments.length;i++)columns.push(arguments[i]);return this.createXmlTag("dynamicRadio",null,{id:answer,screen:screen,columns:columns.toString()})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.DynamicRadio"),a5.preprocessor.preprocessors.push(new a5.preprocessor.DynamicRadio),a5.preprocessor.DynamicCheckbox={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"dynamiccheckbox")},preprocess:function(txt){return txt=this.replaceTag(txt,"dynamiccheckbox",function(screen,answer){for(var columns=[],i=2;i<arguments.length;i++)columns.push(arguments[i]);return this.createXmlTag("dynamicCheckbox",null,{id:answer,screen:screen,columns:columns.toString()})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.DynamicCheckbox"),a5.preprocessor.preprocessors.push(new a5.preprocessor.DynamicCheckbox),a5.preprocessor.ShowText={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"showtext")},preprocess:function(txt){return this.replaceTag(txt,"showtext",function(screen,input){return this.createXmlTag("showtext",null,{screen:screen,input:input})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ShowText"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ShowText),a5.preprocessor.Syllabify={isResponsible:function(interaction,identifier,txt){return"Identify:Mark:Syllabify"===identifier},preprocess:function(xml){return xml=xml.replace(/#syllabify\*([a-zA-Z*]+)#/gi,"<syllabify>$1</syllabify>")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Syllabify"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Syllabify),a5.preprocessor.InlineEditor={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"inlineeditor")},preprocess:function(txt){return txt=this.replaceTag(txt,"inlineeditor",function(preset_text){return"<inlineEditor>"+preset_text+"</inlineEditor>"})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.InlineEditor"),a5.preprocessor.preprocessors.push(new a5.preprocessor.InlineEditor),a5.preprocessor.EndResult={allCorrectAttemptRegStr:"#allcorrectattempt([\\d]+)#",isResponsible:function(interaction,identifier,txt){var tags=["score","totalquestions","pointsavailable","correctanswers","pointsachieved","incorrectanswers","time\\s*taken","timeout","attempts","index","date","foreachinteraction","foreachsection","lomode","manuallymarked","automaticmarked","bandfeedback","unsolved","solved","notattempted"],reg=new RegExp(this.allCorrectAttemptRegStr,"i");return"Present:Present:Present"===identifier&&(_.some(tags,function(tag){return this.hasTag(txt,tag)},this)||reg.test(txt))},preprocess:function(txt){txt=this.replaceTagWithXml(txt,"score"),txt=this.replaceTagWithXml(txt,"totalquestions"),txt=this.replaceTagWithXml(txt,"pointsavailable","totalquestions"),txt=this.replaceTagWithXml(txt,"correctanswers"),txt=this.replaceTagWithXml(txt,"pointsachieved","correctanswers"),txt=this.replaceTagWithXml(txt,"incorrectanswers"),txt=this.replaceTagWithXml(txt,"time\\s*taken","timetaken"),txt=this.replaceTagWithXml(txt,"timeout"),txt=this.replaceTagWithXml(txt,"attempts"),txt=this.replaceTagWithXml(txt,"index"),txt=this.replaceTagWithXml(txt,"date"),txt=this.replaceTag(txt,"foreachinteraction",function(){return"<forEachInteraction>"}),txt=this.replaceTag(txt,"endeachinteraction",function(){return"</forEachInteraction>"}),txt=this.replaceTag(txt,"foreachsection",function(){return"<forEachSection>"}),txt=this.replaceTag(txt,"endeachsection",function(){return"</forEachSection>"}),txt=this.replaceTag(txt,"lomode",function(mode){return'<LOMode mode="'+mode+'">'}),txt=this.replaceTag(txt,"endlomode",function(){return"</LOMode>"}),txt=this.replaceTag(txt,"manuallymarked",function(){return"<manuallyMarked>"}),txt=this.replaceTag(txt,"endmanuallymarked",function(){return"</manuallyMarked>"}),txt=this.replaceTag(txt,"automaticmarked",function(){return"<automaticMarked>"}),txt=this.replaceTag(txt,"endautomaticmarked",function(){return"</automaticMarked>"}),txt=this.replaceTag(txt,"bandfeedback",function(ps){var args=[];return args.push.apply(args,arguments),'<bandFeedback values="'+args.join("*")+'"/>'});var reg=new RegExp(this.allCorrectAttemptRegStr,"gi");return txt=txt.replace(reg,"#allcorrectattempt*$1#"),txt=this.replaceTag(txt,"allcorrectattempt",function(){var args=[];return args.push.apply(args,arguments),this.createXmlTag("allCorrectAttempt",null,{attempt:args[0]})}),txt=this.replaceTag(txt,"unsolved",function(){var args=[];return args.push.apply(args,arguments),this.createXmlTag("unsolved",null,{threshold:args[0]||100})}),txt=this.replaceTag(txt,"solved",function(){var args=[];return args.push.apply(args,arguments),this.createXmlTag("solved",null,{threshold:args[0]||100})}),this.replaceTagWithXml(txt,"notattempted","notAttempted")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.EndResult"),a5.preprocessor.preprocessors.push(new a5.preprocessor.EndResult),a5.preprocessor.Scramble={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"scramble")},preprocess:function(txt){return this.replaceTag(txt,"scramble",function(text){return this.createXmlTag("scramble",text)})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Scramble"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Scramble),a5.preprocessor.RadioCheck={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"radio")||this.hasTag(txt,"checkbox")},preprocess:function(txt){return txt=this.replaceTagWithGroupValue(txt,"radio"),txt=this.replaceTagWithGroupValue(txt,"checkbox")},replaceTagWithGroupValue:function(txt,tag){return this.replaceTag(txt,tag,function(group,value,selected){return this.createXmlTag(tag,null,{group:group,value:value,selected:selected})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.RadioCheck"),a5.preprocessor.preprocessors.push(new a5.preprocessor.RadioCheck),a5.preprocessor.Save={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"save")},preprocess:function(txt){return this.replaceTag(txt,"save",function(image){return this.createXmlTag("save",null,{image:image})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Save"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Save),a5.preprocessor.TextArea={minmax_regex:/^(?:(hide:)?(\d+\s(?:chars|words)))?(?:\|)?(?:(hide:)?(?:min:)?(\d+\s(?:chars|words)))?$/i,regex:/#(textinput|richtextinput|inlinetextinput).*#/i,isResponsible:function(interaction,identifier,txt){return this.regex.test(txt)},preprocess:function(txt){return txt=this.replaceTextInputTag(txt,"textinput"),txt=this.replaceTextInputTag(txt,"richtextinput"),txt=this.replaceTextInputTag(txt,"inlinetextinput")},replaceTextInputTag:function(txt,type,extra_tag){return txt=this.replaceTag(txt,type,function(width,height,max,content){if(this._isMaxParam(height)?(content=max,max=height,height=""):this._isHeightParam(height)?this._isMaxParam(max)||(content=max,max=""):(content=height,max="",height=""),max)var groups=this.minmax_regex.exec(max),hidemax=!!groups[1],hidemin=!!groups[3],maxvalue=groups[2],minvalue=groups[4];var options={width:width,height:height,max:maxvalue,min:minvalue};return hidemax&&(options.hidemax=!0),hidemin&&(options.hidemin=!0),this.createXmlTag(type,content,options)})},_isHeightParam:function(param){return!this._isMaxParam(param)&&!_.isNaN(parseInt(param,10))},_isMaxParam:function(param){return this.minmax_regex.test(param)},_isContentParam:function(param){return!this._isHeightParam(param)&&!this._isMaxParam(param)}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.TextArea"),a5.preprocessor.preprocessors.push(new a5.preprocessor.TextArea),a5.preprocessor.TriggerWord={regex:/#(TRIGWORD|TRIGWORDONCE|TRIGWORDB|TRIGTEXT|RICHTRIGTEXT|ENDRICHTRIGTEXT|TriggerWord).*#/i,isResponsible:function(interaction,identifier,xml){return this.regex.test(xml)},preprocess:function(xml){return xml=xml.replace(/#TRIGWORD\*(.+?)\**(display)*\*([\s\S]+?)#(?!\w)/gi,'<triggerWord display="$2" id="$1">$3</triggerWord>'),xml=xml.replace(/#TRIGWORDONCE\*(.+?)\**(display)*\*([\s\S]+?)#(?!\w)/gi,'<triggerWord once="once" display="$2" id="$1">$3</triggerWord>'),xml=xml.replace(/#TRIGWORDB\*(.+?)\*([\s\S]+?)#(?!\w)/gi,'<triggerWord id="$1" simultaneous="true">$2</triggerWord>'),xml=xml.replace(/#TRIGTEXT\*(.+?)\*([\s\S]+?)#(?!\w)/gi,'<triggerText id="$1">$2</triggerText>'),xml=xml.replace(/<p>#RICHTRIGTEXT\*(.+?)#(?!\w)/gi,'<triggerText id="$1"><p class="trigtext-paragraph-placeholder">'),xml=xml.replace(/<p>#ENDRICHTRIGTEXT*#/gi,'</triggerText><p class="trigtext-paragraph-placeholder">'),xml=this.replaceTag(xml,"triggerWord",function(id){return this.createXmlTag("triggerWord",null,{id:id})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.TriggerWord"),a5.preprocessor.preprocessors.push(new a5.preprocessor.TriggerWord),a5.preprocessor.FeedbackText={regex:/#(FEEDBACKTEXT|ENDFEEDBACKTEXT).*#/i,isResponsible:function(interaction,identifier,xml){return this.regex.test(xml)},preprocess:function(xml){return xml=xml.replace(/<p>#FEEDBACKTEXT\*(.+?)#(?!\w)/gi,'<feedbackText id="$1"><p class="feedbacktext-paragraph-placeholder">'),xml=xml.replace(/\s*<p>#ENDFEEDBACKTEXT*#/gi,'</feedbackText><p class="feedbacktext-paragraph-placeholder">'),xml=xml.replace(/<p class="feedbacktext-paragraph-placeholder">(.*)<\/p>\s*/g,"")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.FeedbackText"),a5.preprocessor.preprocessors.push(new a5.preprocessor.FeedbackText),a5.preprocessor.Confidence={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"confidence-selector")||this.hasTag(xml,"confidence-display")},preprocess:function(txt){return txt=this.replaceTag(txt,"confidence-selector",function(ps){var args=[];args.push.apply(args,arguments);var params={};return _.each(_.rest(args),function(v,i){params["v"+i]=v}),this.createXmlTag("confidenceSelector",arguments[0],params)}),txt=this.replaceTag(txt,"confidence-display",function(ps){return this.createXmlTag("confidenceDisplay")})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Confidence"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Confidence),a5.preprocessor.Alert={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"alert")},preprocess:function(txt){return this.replaceTag(txt,"alert",function(type){return'<alert type="'+type+'"/>'})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Alert"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Alert),a5.preprocessor.ViewText={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"viewtext")},preprocess:function(txt){return this.replaceTag(txt,"viewtext",function(id,text){return this.createXmlTag("div",text,{id:"view-text-"+id,class:"view-text",tabindex:"0"})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ViewText"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ViewText),a5.preprocessor.Navbutton={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"navbutton")},preprocess:function(txt){return this.replaceTag(txt,"navbutton",function(screen,label){return this.createXmlTag("navbutton",label,{screen:screen})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Navbutton"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Navbutton),a5.preprocessor.InfoText={regex:/#infotext[^#]*#/i,isResponsible:function(interaction,identifier,txt){return this.regex.test(txt)},preprocess:function(txt){var xml=this.replaceTag(txt,"infotext",function(){var text,attrs;return 3===arguments.length?(text=arguments[2],attrs={class:arguments[1]}):(text=arguments[1],attrs={icon:arguments[0]}),this.createXmlTag("infotext",text,attrs)});return xml=xml.replace(/([^>\s]*)(<infotext [^>]*>)/gi,'<span class="element-wrap">$1$2'),xml=xml.replace(/(<\/infotext>)([^\s<]*)/gi,"$1$2</span>")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.InfoText"),a5.preprocessor.preprocessors.push(new a5.preprocessor.InfoText),a5.preprocessor.UserSelection={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"userselection")},preprocess:function(txt){return this.replaceTag(txt,"userselection",function(arg1,arg2){var numbers=(arg2||arg1).split(","),multiple=!!arg2;return this.createXmlTag("userselection",null,{step:numbers[0],max:numbers[1],multiple:multiple})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.UserSelection"),a5.preprocessor.preprocessors.push(new a5.preprocessor.UserSelection),a5.preprocessor.Karaoke={isResponsible:function(interaction,identifier,txt){return"Present:Present:Present"===identifier&&this.hasTag(txt,"karaoke")},preprocess:function(txt){return this.replaceTag(txt,"karaoke",function(){var audioID=arguments[0],args=Array.prototype.slice.call(arguments,1),tags=[];return _.each(args,function(arg,index){if(index%2!=0){var times=args[index-1].split("-");tags.push(this.createXmlTag("karaoke",arg,{audio:audioID,from:times[0],to:times[1]}))}},this),tags.join("")})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Karaoke"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Karaoke),a5.preprocessor.Clock={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"clock")},preprocess:function(txt){return this.replaceTag(txt,"clock",function(){var text,attrs;return text=arguments[1],attrs={class:arguments[0],options:arguments[2]},this.createXmlTag("clock",text,attrs)})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Clock"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Clock),a5.preprocessor.ContentMessage={regex:/#contentmessage[^#]*#/i,isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"contentmessage")},preprocess:function(txt){return this.replaceTag(txt,"contentmessage",function(message,text){return this.createXmlTag("contentmessage",text,{message:message})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ContentMessage"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ContentMessage),a5.preprocessor.AnimateObject={regExp:/#animateobject\*([^*]+)\*([^ \t\r\n*#]+)#/gi,isResponsible:function(interaction,identifier,xml){return this.regExp.test(xml)},preprocess:function(txt,interaction){return txt.replace(this.regExp,_.bind(function(str,text,id){var match=a5.dp.animations&&a5.dp.animations[id];if(!match)return"";var animation=AnimationParser.parse(match);interaction.bind("show:deferred",function(){animation.start(interaction)});var blocks=_(text.split("|")).compact();return blocks=_(blocks).map(function(block){return"<span>"+block+"</span>"}),this.createXmlTag("div",blocks.join(""),{id:id,class:"object-animation"})},this))}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.AnimateObject"),a5.preprocessor.preprocessors.push(new a5.preprocessor.AnimateObject),a5.preprocessor.AlternativeText={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"alttext")},preprocess:function(txt){return this.replaceTag(txt,"alttext",function(){var texts=[];return _(arguments).each(function(text,index){texts.push(this.createXmlTag("alternative",text,{id:"alt"+(index+1)}))},this),this.createXmlTag("alternativeText",texts.join(""))})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.AlternativeText"),a5.preprocessor.preprocessors.push(new a5.preprocessor.AlternativeText),a5.preprocessor.TranslationBlock={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"translationBlock")},preprocess:function(txt){return txt=txt.replace(/<p>#translationBlock#\s*<\/p>/gi,"<translationBlock>"),txt=txt.replace(/<p>#endTranslationBlock#\s*<\/p>/gi,"</translationBlock>"),txt=txt.replace(/<p>#language\*([^#]+)#\s*<\/p>/gi,"<language lang='$1'>"),txt=txt.replace(/<p>#endLanguage#\s*<\/p>/gi,"</language>")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.TranslationBlock"),a5.preprocessor.preprocessors.push(new a5.preprocessor.TranslationBlock),a5.preprocessor.ICTextGapPreprocessor={isResponsible:function(interaction,identifier,input){return"Input:Completion:Text gap"===identifier},preprocess:function(xml){return xml=xml.replace(/(?:[^>\s]*)(?:<textEntryInteraction[^>]+>[^\s<]*)+/gi,'<span class="element-wrap">$&</span>')}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ICTextGapPreprocessor"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ICTextGapPreprocessor),a5.preprocessor.ISDropdownPreprocessor={isResponsible:function(interaction,identifier,input){return"Identify:Select:Dropdown"===identifier},preprocess:function(xml){return xml=xml.replace(/(?:[^>\s]*)(?:<inlineChoiceInteraction\b(?:(?!<\/inlineChoiceInteraction).)*<\/inlineChoiceInteraction[^>]*>[^\s<]*)+/gi,'<span class="element-wrap">$&</span>')}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ISDropdownPreprocessor"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ISDropdownPreprocessor),a5.preprocessor.Poll={isResponsible:function(interaction,identifier,txt){return"Present:Present:Present"===identifier&&this.hasTag(txt,"poll")},preprocess:function(txt){return this.replaceTag(txt,"poll",function(){var texts=[],typeAndSets=arguments[0].split("|"),type=typeAndSets[0],sets=typeAndSets.slice(1),options=Array.prototype.slice.call(arguments,1);return sets.forEach(function(set,index){texts.push(this.createXmlTag("set",set,{id:"set"+index}))},this),options.forEach(function(option,index){texts.push(this.createXmlTag("option",option,{id:"alt"+index}))},this),this.createXmlTag("poll",texts.join(""),{type:type})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Poll"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Poll),a5.preprocessor.PollResults={isResponsible:function(interaction,identifier,txt){return"Present:Present:Present"===identifier&&this.hasTag(txt,"pollresults")},preprocess:function(txt){return this.replaceTag(txt,"pollresults",function(screen){return this.createXmlTag("pollresults",null,{screen:screen})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.PollResults"),a5.preprocessor.preprocessors.push(new a5.preprocessor.PollResults),a5.speaking_recording={},a5.preprocessor.SpeakingRecording={regex:/#[recorder|playAll].*#/i,isResponsible:function(interaction,identifier,xml){return xml.match(this.regex)},preprocess:function(xml){var results=xml.match(/#recorder:[^#]*#/g);if(results)for(var i=0;i<results.length;i+=1)xml=xml.replace(results[i],function(syntax){var options=["nopause","save","timelimit","text"],tag=syntax.replace(/#/g,"");tag=tag.split(":");for(var text="",result="<recorder ",i=0;i<tag.length;i+=1)tag[i]=tag[i].replace("#",""),"timelimit"==tag[i]&&tag[i+1].match(/\d+/)?(result+='timelimit="'+tag[i+1]+'" ',tag.splice(i+1,1)):"text"==tag[i]?(text=tag[i+1],tag.splice(i+1,1)):"save"==tag[i]?result+=' save="true" ':"nopause"==tag[i]?result+=' nopause="true" ':1==i&&-1==options.indexOf(tag[i])?result+='audio="'+tag[i]+'" ':2==i&&-1==options.indexOf(tag[i])&&(result+='time="'+tag[i]+'" ');return result+=">"+text+"</recorder>"}(results[i]));return xml=this.replaceTag(xml,"recorder",function(audio,time){return this.createXmlTag("recorder",null,{audio:audio,time:time})}),xml=this.replaceTag(xml,"playAll",function(screens){var from=0,to=0;return 2==screens.split("-").length?(from=parseInt(screens.split("-")[0],10),to=parseInt(screens.split("-")[1],10)):(from=parseInt(screens,10),to=from),this.createXmlTag("playAll",null,{from:from,to:to})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.SpeakingRecording"),a5.preprocessor.preprocessors.push(new a5.preprocessor.SpeakingRecording),a5.model_builder.SpeakingRecording={isResponsible:function(node,interaction){return node.is("recorder, playAll")&&"Input:Match:Voice"!==interaction.identifier},buildRecorder:function(interaction,parentNode,node){var model=new a5.models.interaction.SpeakingRecording({parent:interaction,audioID:node.attr("audio"),timeData:node.attr("time"),nopause:node.attr("nopause")||!a5.dp.config.allowPauseRecordings,timelimit:parseInt(node.attr("timelimit"),10),scorable:"Present:Present:Present"===interaction.identifier&&interaction.options.manualMarkingIsOn()}),view=new a5.views.interaction.SpeakingRecording(model);parentNode.append(view.render()),interaction.blockItems.add(model)},buildPlayAll:function(interaction,parentNode,node){var playAll=new a5.speaking_recording.PlayAllView(parseInt(node.attr("from"),10)-1,parseInt(node.attr("to"),10)-1);parentNode.append(playAll.render())}},a5.model_builder.Base.extend("a5.model_builder.SpeakingRecording"),a5.model_builder.builders.push(new a5.model_builder.SpeakingRecording),a5.models.interaction.SpeakingRecording={init:function(parameters,defaults){this.records=[],this.timeline=[],this._super(parameters,$.extend({audioID:null,timeData:null,nopause:!1,timelimit:null,downloadEnabled:!0,listenEnabled:!0,scorable:!1},defaults)),this.timeData&&_.each(this.timeData.split(","),function(item){2==item.split("-").length?this.timeline.push({from:parseFloat(item.split("-")[0]),to:parseFloat(item.split("-")[1])}):this.timeline.push({record:parseFloat(item)})},this)},getScores:function(){var score=new a5.Score;return this.isScorable()&&(score.incTotal(),this.isFilled()&&score.incFilled()),score},store:function(){return this.records},restore:function(data){_.isUndefined(data)||(this.records=data,this.trigger("updated"))},isFilled:function(){return this.records.length>0},isScorable:function(){return this.scorable}},a5.models.interaction.BaseModel.extend("a5.models.interaction.SpeakingRecording"),a5.speaking_recording.LNRInstances=[],a5.speaking_recording.LNRInstancesPerInteraction=[],a5.views.interaction.BaseView.extend("a5.views.interaction.SpeakingRecording",{NODE_TEMPLATE:'<div class="lrp_wrap"><a class="lrp_listen button">Listen</a><a class="lrp_record button">Record</a><a class="lrp_finish button">Finish</a><a class="lrp_play button">Play</a><a class="lrp_stop button">Stop</a><a class="lrp_download button">Download</a></div>',init:function(model,callbacks){this._super(model,null,$(a5.service.templates.render("a5.speaking_recording.SpeakingRecording",{},this.NODE_TEMPLATE))),this.interaction=model.parent,this.callbacks=callbacks||{},this.listenButton=this.$(".lrp_listen"),this.recordButton=this.$(".lrp_record"),this.finishButton=this.$(".lrp_finish"),this.playButton=this.$(".lrp_play"),this.stopButton=this.$(".lrp_stop"),this.downloadButton=this.$(".lrp_download"),this.playButtonLabel=this.playButton.text(),this.pauseButtonLabel=this.playButton.attr("data-pause-label")||this.playButtonLabel,this.recordButtonLabel=this.recordButton.text(),this.pauseRecordButtonLabel=this.recordButton.attr("data-pause-label")||this.recordButtonLabel,this.allRecordsUploaded=!0,this.model.audioID&&a5.service.media.audio.bind("ready",function(){this.listenAudio=a5.service.media.audio.create(this.model.audioID,{preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase()),preload:!a5.dp.config.audioPreloadDisabled}),a5.dp.config.audioPreloadDisabled&&this.interaction.preloadAudio(this.listenAudio)},this),this.updateState("loading"),this.__ready=!1,a5.service.media.audio_recorder.ready().then(function(recorder){this.interaction.bind("show",function(){a5.service.media.audio_recorder.instance().checkSupport()})}.bind(this)),$.when(a5.service.media.audio.ready(),a5.service.media.audio_recorder.ready()).then(function(){this.__ready||(this.updateState("ready"),this.__ready=!0)}.bind(this)),a5.speaking_recording.LNRInstances.push(this),a5.speaking_recording.LNRInstancesPerInteraction[this.interaction.index]=a5.speaking_recording.LNRInstancesPerInteraction[this.interaction.index]||[],a5.speaking_recording.LNRInstancesPerInteraction[this.interaction.index].push(this),a5.service.media.audio.bind("dopause",function(except){except?this.stopAllExcept(except):this.stopAll()},this),this.model.bind("updated",this.updateState,this),this.interaction.bind("hide",function(){this.stopAll()},this),this.interaction.onInteractionReadyListeners.register(this.stopAll),this.listeningEnabled=!0,this.recordingEnabled=!0},isListeningEnabled:function(){return this.listeningEnabled&&this.listenAudio},isRecordingEnabled:function(){return this.recordingEnabled&&this.model.records.length>0},enableListening:function(){this.listeningEnabled=!0},enableRecording:function(){this.recordingEnabled=!0},disableListening:function(){this.listeningEnabled=!1},disableRecording:function(){this.recordingEnabled=!1},updateState:function(state,rec_state){state&&(this.state=state),rec_state&&(this.rec_state=rec_state),this._initState(),this.model.listenEnabled&&this._updateListenButton(),this._updateRecordButton(),this._updateFinishButton(),this._updatePlayButton(),this._updateStopButton(),this.model.downloadEnabled&&this._updateDownloadButton(),this.trigger("state:changed",this.state,this.rec_state)},stopAll:function(){a5.tasks.clear("lnr"),a5.tasks.current("lnr")&&a5.tasks.current("lnr").stop(),_.each(a5.speaking_recording.LNRInstances,function(lnr){lnr.updateState("ready","ready")})},stopAllExcept:function(except){a5.tasks.clearBy(function(task){return task.view&&task.view===except},"lnr");var currentTask=a5.tasks.current("lnr");currentTask&&currentTask.view!==except&&currentTask.stop(),_.each(a5.speaking_recording.LNRInstances,function(lnr){lnr!==except&&lnr.updateState("ready","ready")})},listen:function(){a5.service.media.pauseAll(),a5.tasks.push(new a5.speaking_recording.LNRListen(this),"lnr"),a5.tasks.push(new a5.speaking_recording.LNREnded(this),"lnr")},startPlayback:function(){a5.service.media.pauseAll(),this.model.timeline&&this.model.timeline.length>0?_.each(this.model.timeline,function(part,i){part.record?a5.tasks.push(new a5.speaking_recording.LNRPlayback(this,i),"lnr"):a5.tasks.push(new a5.speaking_recording.LNRPlay(this,part.from,part.to),"lnr")},this):a5.tasks.push(new a5.speaking_recording.LNRPlayback(this,0),"lnr",!0),a5.tasks.push(new a5.speaking_recording.LNREnded(this),"lnr"),this.updateState("playback")},startRecording:function(){if(a5.service.media.pauseAll(),this.records=[],this.allRecordsUploaded=!1,this.model.timeline&&this.model.timeline.length>0){this.listenAudio.load();var uploadRecordTasks=[];_.each(this.model.timeline,function(part,i){if(part.record){a5.tasks.push(new a5.speaking_recording.LNRRecord(this,part.record,i),"lnr");var uploadRecordTask=new a5.speaking_recording.LNRRecordUpload(this,i);uploadRecordTasks.push(uploadRecordTask),a5.tasks.push(new a5.speaking_recording.LNRRecordUpload(this,i),"lnr")}else a5.tasks.push(new a5.speaking_recording.LNRPlay(this,part.from,part.to),"lnr")},this),a5.tasks.push(new a5.speaking_recording.LNRRecordEnded(this,uploadRecordTasks),"lnr"),this.updateState("recording")}else{var simpleRecordTask=new a5.speaking_recording.LNRSimpleRecord(this),uploadRecordTask=new a5.speaking_recording.LNRRecordUpload(this),recordEndedTask=new a5.speaking_recording.LNRRecordEnded(this,uploadRecordTask);simpleRecordTask.bind("start",this.onSimpleRecordStarted,this),recordEndedTask.bind("stop",this.onSimpleRecordEnded,this),a5.tasks.push(simpleRecordTask,"lnr",!0),a5.tasks.push(uploadRecordTask,"lnr"),a5.tasks.push(recordEndedTask,"lnr"),this.updateState("simple-recording")}},onSimpleRecordEnded:function(){this.callbacks.onSimpleRecordEnded&&this.callbacks.onSimpleRecordEnded()},onSimpleRecordStarted:function(){this.callbacks.onSimpleRecordStarted&&this.callbacks.onSimpleRecordStarted()},askSaveAsFilenameAndDownload:function(){var $dialog=a5.view.dialog.display("a5.view.dialog.RecordingSaveAs",{filename:A5.DEFAULT_SAVEAS_FILENAME},{ok:_.bind(function(){this.downloadAs($dialog.find("#downloadFilename").val())},this)})},downloadAs:function(filename){this.model.timeline&&this.model.timeline.length>0?this.partPlayDownload(filename):this.simpleDownload(filename)},partPlayDownload:function(filename){var inputs=[],clips=[];inputs.push(a5.utils.getAbsoluteURL(a5.service.media.audio.buildUrl(this.model.audioID,"mp3"))),_(this.model.timeline).each(function(part,i){part.record?_(this.model.records[i]).each(function(snippet){inputs.push(a5.service.media.audio_recorder.instance().buildUrl(snippet)),clips.push({input:inputs.length-1})},this):clips.push({input:0,start:part.from,end:part.to})},this),a5.service.toolbelt.audioDownload({inputs:inputs,clips:clips,output:filename})},simpleDownload:function(filename){var inputs=[],clips=[];_(this.model.records[0]).each(function(snippet){inputs.push(a5.service.media.audio_recorder.instance().buildUrl(snippet)),clips.push({input:inputs.length-1})},this),a5.service.toolbelt.audioDownload({inputs:inputs,clips:clips,output:filename})},_showButton:function($button){$button.css("display","")},_hideButton:function($button){$button.css("display","none")},_enableButton:function($button){$button.removeClass("lrp_inactive")},_disableButton:function($button){$button.addClass("lrp_inactive")},_initState:function(){this.$(".button").addClass("lrp_inactive").removeClass("active lrp_listening lrp_playing lrp_recording lrp_uploading").off("click"),this._hideButton(this.downloadButton),this.model.listenEnabled||this._hideButton(this.listenButton),this.node.removeClass("lrp_playing lrp_recording lrp_listening lrp_uploading")},_updateDOMState:function($button,state){$button.addClass(state),this.node.addClass(state)},_updateListenButton:function(){this.model.audioID?(this._showButton(this.listenButton),"ready"!==this.state&&"playback"!==this.state||(this._enableButton(this.listenButton),this.listenButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),this.listen()},this))),"listening"!==this.state&&("recording"!=this.state||"listening"!==this.rec_state&&"listening-paused"!==this.rec_state)||(this._enableButton(this.listenButton),"listening-paused"==this.rec_state?this.listenButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.tasks.current("lnr").unpause()},this)):(this._updateDOMState(this.listenButton,"lrp_listening"),this.listenButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.tasks.current("lnr").pause()},this))))):this._hideButton(this.listenButton)},_updateRecordButton:function(){this.recordButton.text(this.recordButtonLabel),this._showButton(this.recordButton),"recording"!==this.state&&"simple-recording"!==this.state||(this._enableButton(this.recordButton),
"recording"===this.rec_state?(this.model.nopause&&this.recordButton.addClass("lrp_nopause"),this.recordButton.text(this.pauseRecordButtonLabel),this._updateDOMState(this.recordButton,"lrp_recording"),this.recordButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),this.model.nopause?a5.tasks.current("lnr").stop():a5.tasks.current("lnr").pause()},this))):"paused"===this.rec_state&&this.recordButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.tasks.current("lnr").unpause(),a5.tasks.push(a5.tasks.current("lnr"),"lnr",!0)},this))),"ready"!==this.state&&"playback"!==this.state&&"listening"!==this.state||(this._enableButton(this.recordButton),this.recordButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.service.media.audio_recorder.instance()instanceof FlashAudioRecorder?$.when(a5.service.media.audio_recorder.instance().checkMic()).done(function(micEnabled){micEnabled&&this.startRecording()}.bind(this)):this.startRecording()},this)))},_updatePlayButton:function(){this.model.records.length>0?(this.playButton.text(this.playButtonLabel),this._showButton(this.playButton),!this.allRecordsUploaded||"ready"!==this.state&&"listening"!==this.state||(this._enableButton(this.playButton),this.playButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),this.startPlayback()},this))),"playback"===this.state&&(this._enableButton(this.playButton),"playing-paused"===this.rec_state||"listening-paused"===this.rec_state?this.playButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.tasks.current("lnr").unpause()},this)):(this.playButton.text(this.pauseButtonLabel),this._updateDOMState(this.playButton,"lrp_playing"),this.playButton.addClass("active"),this.playButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.tasks.current("lnr").pause()},this))))):this._hideButton(this.playButton)},_updateStopButton:function(){this._showButton(this.stopButton),"listening"!==this.state&&"playback"!==this.state&&"recording"!==this.state&&"simple-recording"!==this.state||(this._enableButton(this.stopButton),this.stopButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),this.stopAll()},this)))},_updateDownloadButton:function(){this.model.records.length>0&&(this.downloadButton.trigger("download:show"),!this.allRecordsUploaded||"ready"!==this.state&&"listening"!==this.state&&"playback"!==this.state||(this._enableButton(this.downloadButton),this.downloadButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),this.askSaveAsFilenameAndDownload()},this))))},_updateFinishButton:function(){"simple-recording"!==this.state||this.model.nopause?this._hideButton(this.finishButton):(this._showButton(this.finishButton),"uploading"===this.rec_state?this._updateDOMState(this.finishButton,"lrp_uploading"):(this._enableButton(this.finishButton),this.finishButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.tasks.current("lnr").stop()},this))))}}),a5.speaking_recording.playAllInstances=[],a5.views.interaction.BaseView.extend("a5.speaking_recording.PlayAllView",{init:function(from,to){this.from=from,this.to=to,this._super(null,null,$(a5.service.templates.render("a5.speaking_recording.PlayAll",{}))),this.$play=this.$("a[data-button=play]"),this.$pause=this.$("a[data-button=pause]"),this.$stop=this.$("a[data-button=stop]"),this.$next=this.$("a[data-button=next]"),this.$prev=this.$("a[data-button=prev]"),this.$all=this.$("a"),this._setPlaying(null),a5.speaking_recording.playAllInstances.push(this)},_setPlaying:function(playing){this.playing=playing,this.$all.addClass("inactive"),this.$all.off("click"),this.playing?(this.$stop.removeClass("inactive"),this.$stop.on("click",_.bind(this.playing.stop,this.playing)),this.$play.removeClass("inactive"),this.$play.addClass("active"),this.playing.hasNext()&&(this.$next.removeClass("inactive"),this.$next.on("click",_.bind(this.playing.next,this.playing))),this.playing.hasPrev()&&(this.$prev.removeClass("inactive"),this.$prev.on("click",_.bind(this.playing.prev,this.playing))),this.playing.paused?(this.$play.removeClass("inactive"),this.$play.removeClass("active"),this.$pause.addClass("active"),this.$play.on("click",_.bind(this.playing.unpause,this.playing)),this.trigger("state:changed","paused")):(this.$pause.removeClass("inactive"),this.$play.removeClass("active").addClass("active"),this.$pause.removeClass("active"),this.$pause.on("click",_.bind(this.playing.pause,this.playing)),this.trigger("state:changed","playing"))):(this.$play.removeClass("inactive"),this.$pause.removeClass("active"),this.$play.on("click",_.bind(this._play,this)),this.trigger("state:changed","stopped"))},_play:function(){var iCounter=0,toPlay=[];for(iCounter=this.from;iCounter<=this.to;iCounter++){var views=a5.speaking_recording.LNRInstancesPerInteraction[iCounter];views&&_.each(views,function(view){0==view.model.timeline.length&&(view.isListeningEnabled()&&toPlay.push(new a5.speaking_recording.PlayAllListening(this,toPlay,toPlay.length,view.listenAudio)),view.isRecordingEnabled()&&toPlay.push(new a5.speaking_recording.PlayAllRecordings(this,toPlay,toPlay.length,view.model.records[0])))},this)}toPlay.length>0&&toPlay[0].play()},stopAll:function(){this.playing&&this.playing.stop()},stopAllExcept:function(except){this.playing&&this.playing!==except&&this.playing.stop()}}),Obj.extend("a5.speaking_recording.PlayAllPart",{init:function(playAll,parts,index){this.playAll=playAll,this.parts=parts,this.index=index,this.paused=!1},play:function(){this.paused=!1,this.playAll._setPlaying(this)},pause:function(){this.paused=!0,this.playAll._setPlaying(this)},unpause:function(){this.paused=!1,this.playAll._setPlaying(this)},stop:function(){this.paused=!1,this.playAll._setPlaying(null)},next:function(){this.stop(),this.hasNext()&&this.parts[this.index+1].play()},prev:function(){this.stop(),this.parts[this.index-1].play()},hasNext:function(){return this.index<this.parts.length-1},hasPrev:function(){return this.index>0}}),a5.speaking_recording.PlayAllPart.extend("a5.speaking_recording.PlayAllListening",{init:function(playAll,parts,index,audio){this._super(playAll,parts,index),this.audio=audio},play:function(){this._super(),this.audio.position(0),this.audio.bind("stopped",this.next,this),this.audio.play()},pause:function(){this._super(),this.audio.pause()},unpause:function(){this._super(),this.audio.play()},stop:function(){this._super(),this.audio.unbind("stopped"),this.audio.stop()}}),a5.speaking_recording.PlayAllPart.extend("a5.speaking_recording.PlayAllRecordings",{init:function(playAll,parts,index,audios){this._super(playAll,parts,index),this.audios=audios},play:function(){this._super();var index=0;function callback(){this.hasNextRecording(index)?(this.audio=a5.service.media.audio_recorder.instance().createSource(this.audios[index]),index+=1,this.audio.bind("stopped",callback,this),this.audio.play()):this.next()}this.audio=a5.service.media.audio_recorder.instance().createSource(this.audios[index]),index+=1,this.audio.bind("stopped",callback,this),this.audio.play()},hasNextRecording:function(index){return index<this.audios.length},pause:function(){this._super(),this.audio.pause()},unpause:function(){this._super(),this.audio.play()},stop:function(){this._super(),this.audio.unbind("stopped"),this.audio.stop()}}),a5.Task.extend("a5.speaking_recording.LNRSimpleRecord",{init:function(view){this.view=view,this.recordedParts=[],this.status="new",this.timelimit=this.view.model.timelimit},run:function(){if("new"===this.status){if(this.status="waiting",this.recording=a5.service.media.audio_recorder.instance().record(this.view.model.id+"_"+this.recordedParts.length),!this.recording)return!0;this.recording.bind("start",this.onRecordingStarted,this),this.recording.bind("recorded",this.onRecordingStopped,this),this.recording.start()}if("ended"===this.status)return this.view.records[0]=this.recordedParts,!0;if(this.timelimit&&"recording"===this.status){this._getElapsedTime()>=1e3*this.timelimit&&this.stop()}return!1},pause:function(){this.recording&&(this.status="paused",this.view.updateState(null,"paused"),this.recording.stop())},unpause:function(){this.status="new"},stop:function(){this.recording&&(this.status="stopping",this.recording.stop())},onRecordingStarted:function(filename){this.startTime=+new Date,this.elapsedTime=0,this.recordedParts.push(filename),this.status="recording",this.view.updateState(null,"recording"),logger.info("start recording")},onRecordingStopped:function(){"stopping"===this.status&&(this.status="ended",logger.info("end recording"))},_getElapsedTime:function(){var current=+new Date,elapsed=current-this.startTime;return this.startTime=current,this.elapsedTime+=elapsed,this.elapsedTime}}),a5.Task.extend("a5.speaking_recording.LNRRecord",{init:function(view,duration,part){this.view=view,this.duration=1e3*duration,this.part=part,this.recordedElapsed=0,this.recordedParts=[],this.timelimit=this.view.model.timelimit,this.status="new"},start:function(filename){this.recordedParts.push(filename),this.status="recording",this.startTime=+new Date,this.timeStarted=+new Date,this.timePlayed=0,this.view.updateState(null,"recording"),logger.info("start recording")},run:function(){if("new"==this.status){if(this.status="waiting",this.recording=a5.service.media.audio_recorder.instance().record(this.view.model.id+"_"+this.recordedParts.length),!this.recording)return!0;this.recording.bind("start",this.start,this),this.recording.start()}if("recording"==this.status||"terminate"==this.status){var total=this.recordedElapsed;total+=+new Date-this.startTime,total>this.duration&&(this.recording.stop(),this.status="stopping",this.recording.bind("recorded",function(){this.status="ended",logger.info("end recording")},this))}if(this.timelimit&&"recording"==this.status){var currentTime=+new Date,played=currentTime-this.timeStarted;this.timeStarted=currentTime,this.timePlayed+=played,this.timePlayed>=1e3*this.timelimit&&this.stop()}return"ended"==this.status&&(this.view.records[this.part]=this.recordedParts,this.view.updateState(),!0)},pause:function(){this.recording&&(this.status="paused",this.recordedElapsed+=+new Date-this.startTime,this.recording.stop(),this.view.updateState(null,"paused"))},unpause:function(){this.status="new"},stop:function(){this.status="terminate"}}),a5.Task.extend("a5.speaking_recording.LNRPlay",{init:function(view,from,to){this.view=view,this.from=1e3*from,this.to=1e3*to,this.status="new"},run:function(){return"new"==this.status&&this.view.listenAudio.position(this.from)&&(this.view.listenAudio.bind("progress",this.progress,this),this.view.listenAudio.bind("stopped",this.stopped,this),this.view.updateState(null,"listening"),this.view.listenAudio.play(),this.status="playing"),"stop"==this.status&&(this.view.listenAudio.stop(),this.view.updateState(),this.status="stopped"),"stopped"==this.status},stop:function(){this.status="stop"},pause:function(){this.status="paused",this.view.listenAudio.pause(),this.view.updateState(null,"listening-paused")},unpause:function(){this.status="playing",this.view.listenAudio.play(),this.view.updateState(null,"listening")},progress:function(time){time>this.to&&(this.status="stop")},stopped:function(time){this.status="stop"}}),a5.Task.extend("a5.speaking_recording.LNRListen",{init:function(view,from,to){this.view=view,this.status="new"},run:function(){return"new"==this.status&&(this.view.listenAudio.bind("stopped",this.stopped,this),this.view.listenAudio.position(0),this.view.listenAudio.play(),this.status="playing",this.view.updateState("listening","listening")),"stop"==this.status&&(this.view.listenAudio.stop(),this.status="stopped"),"stopped"==this.status},stop:function(){this.status="stop"},pause:function(){this.status="paused",this.view.listenAudio.pause(),this.view.updateState(null,"listening-paused")},unpause:function(){this.status="playing",this.view.listenAudio.play(),this.view.updateState(null,"listening")},stopped:function(time){this.status="stop"}}),a5.Task.extend("a5.speaking_recording.LNRRecordEnded",{init:function(view,uploadTasks){this.view=view,this.uploadTasks=uploadTasks},run:function(){return this._uploadWithError()||(this.view.model.records=this.view.records,this.view.allRecordsUploaded=!0,a5.mainBuilder.updateScoresAsync()),this.view.updateState("ready","ready"),!0},stop:function(){},_uploadWithError:function(){return _.isArray(this.uploadTasks)||(this.uploadTasks=[this.uploadTasks]),_.some(this.uploadTasks,function(task){return"error"===task.status})}}),a5.Task.extend("a5.speaking_recording.LNRPlayback",{init:function(view,part){this.view=view,this.part=part,this.snippet=0},run:function(){if(!this.playing&&!this.ended){var id=this.view.model.records[this.part][this.snippet];_.isUndefined(id)||(this.playing=a5.service.media.audio_recorder.instance().createSource(id),this.playing.bind("stopped",_.bind(function(){this.playing=null},this)),this.playing.play()),this.snippet++}return this.ended||this.snippet>=this.view.model.records[this.part].length&&!this.playing},stop:function(){this.playing&&this.playing.stop(),this.ended=!0},pause:function(){this.playing&&(this.status="paused",this.playing.pause(),this.view.updateState(null,"playing-paused"))},unpause:function(){this.playing&&(this.status="playing",this.playing.play(),this.view.updateState(null,"playing"))},stopped:function(time){this.ended=!0}}),a5.Task.extend("a5.speaking_recording.LNRRecordUpload",{init:function(view,part){this.view=view,this.part=part||0,this.status="new"},run:function(){if("new"===this.status){var promises=[];_(this.view.records[this.part]).each(function(snippet,index){var promise=a5.service.media.audio_recorder.instance().upload(snippet).then(function(filename){filename&&(this.view.records[this.part][index]=filename)}.bind(this));promises.push(promise)},this),this.status="uploading",this.view.updateState(null,"uploading"),$.when.apply($,promises).done(_.bind(function(){this.stop()},this)).fail(_.bind(function(){this.error()},this))}return"ended"===this.status||"error"===this.status},stop:function(){this.status="ended"},error:function(){this.status="error"}}),a5.Task.extend("a5.speaking_recording.LNREnded",{init:function(view){this.view=view},run:function(){return this.view.updateState("ready"),!0},stop:function(){}}),a5.views.interaction.TemplateView={render:function(){return this.node.off(),this.node.empty().html(a5.mainBuilder.layout.getTemplate(_(this).result("template")))},bindNode:function(event,selector,handler,options){options=_.defaults(options||{},{preventDefault:!1,stopPropagation:!1}),_.isUndefined(handler)&&(handler=selector,selector=null);var self=this;this.node.on(event,selector,function(e){options.preventDefault&&e.preventDefault(),options.stopPropagation&&e.stopPropagation(),handler.apply(self,arguments)})},bindNodeD:function(event,selector,handler){this.bindNode(event,selector,handler,{preventDefault:!0})},bindNodeP:function(event,selector,handler){this.bindNode(event,selector,handler,{stopPropagation:!0})},bindNodeDP:function(event,selector,handler){this.bindNode(event,selector,handler,{preventDefault:!0,stopPropagation:!0})},unbindNode:function(){this.node.off.apply(this.node,arguments)}},a5.views.interaction.BaseView.extend("a5.views.interaction.TemplateView"),a5.model_builder.BookBuilder={buildBook:function($node,view,model){this._buildLinks($node,view),this._buildTitle(model.title),this._buildHelpLink(),this.engine.getBook().setProperties({model:model,view:view})},_buildLinks:function($node,view){var toolbar=view.toolbar,$links=$("ul.controls");_.each($node.find("> links > a"),function(link){var $link=$(link),linkView=new a5.views.BookLink($link.text(),$link.attr("href"),$link.attr("target"));linkView.bind("open",toolbar.audioPlayer.pause,toolbar.audioPlayer),$links.append(linkView.render())})},_buildTitle:function(title){$(".header > .title, head > title").text(title)},_buildHelpLink:function(){if(window.gon&&gon.helpLink){var link=gon.helpLink.help_links[0];$(".header .link-help a").attr("href",link.url).text(link.value)}}},a5.model_builder.Base.extend("a5.model_builder.BookBuilder"),a5.model_builder.PPEbookBuilder={isResponsible:function(node,interaction){return"Present:Present:Ebook"===interaction.identifier&&node.is("ebook")},buildEbook:function(interaction,$parentNode,$node){this.model=this._createModel(interaction,$node),this.view=this._createView(),$node.attr("annotations")&&!$node.is("[annotations=true]")||!this.view.toolbar.hasAnnotationsButton()||(this.model.annotations=this._createAnnotations(),this.model.annotations.toolbox.bind("toolbox:select",function(tool){"cursor"!==tool.name?(this.view.deselectTools(),this.view.pages.scroller.disableSwipe()):this.view.pages.scroller.enableSwipe()},this)),this._buildPages($node.find("> pages")),this.engine.invoke("book:enable-solution-view")&&this._buildSolutionPages($node.find("> solution-pages"),"true"===$node.attr("solution-hotspot-clone")),this._buildTocEntries($node.find("> toc"),this.view.toc),this.buildBook($node,this.view,this.model),interaction.bind("show",function(){this.bind("opened",function(){a5.eventBus.trigger("book:open_page",this.model.getCurrentPageNumber())},this),this.bind("opened-in-solution-view",function(current,options){options.afterSolutionOpened||a5.eventBus.trigger("book:open_page",this.model.getCurrentPageNumber())},this),a5.eventBus.trigger("book:open_page",this.model.getCurrentPageNumber())},this.view.pages,{once:!0}),interaction.bind("show:deferred",function(){this.updateScroller()},this.view.pages,{once:!0}),_.bindAll(this,"_onWindowResize","_onFullscreenChange"),$(window).on("resize",this._onFullscreenChange),screenfull.enabled&&screenfull.onchange(this._onFullscreenChange),this.model.bind("page_change overlay_change",function(){interaction.store()}),$node.attr("audiocontrols")||this.view.toolbar.audioPlayer.hide(),"true"==$node.attr("autosave")&&interaction.startAutosave(),$parentNode.append(this.view.render()),a5.hooks.ppebookRendered.call(this.view),interaction.blockItems.add(this.model)},_createModel:function(interaction,$node){var pageCount=$node.find("> pages > page").length;return new a5.models.interaction.PPEbook({title:$node.attr("title"),pageCount:pageCount,author:$node.attr("author"),cover:$node.is("[cover=true]"),pagesPerScreen:A5.DEFAULT_PAGES_PER_SCREEN||2,restorePerScreen:"url"!==A5.PAGES_PER_SCREEN_SOURCE,effects:$node.is("[effects=true]"),offset:parseInt($node.attr("offset")||0,10),parent:interaction,startingPage:parseInt(a5.getURLParameter("page"),10)})},_createView:function(){return new a5.views.interaction.PPEbook(this.model)},_createAnnotations:function(){var annotations=new a5.Annotations({language:a5.dp.config.bookAnnotationsLanguage,stage:"annotations",appendTo:a5.dp.config.bookAnnotationsToolbarAppendTo,toolboxInsideBounds:a5.dp.config.bookAnnotationsToolbarInsideBounds,toolboxInitialPosition:a5.dp.config.bookAnnotationsToolbarPosition,keyboard:!0,intView:this.view,displayAsPopup:a5.dp.config.bookAnnotationsToolbarAsPopup,stickyNoteWithTitle:a5.dp.config.bookStickyNoteWithTitle,stickyNoteMinSize:a5.dp.config.bookStickyNoteMinSize,toolbarDragOnlyFromHandle:a5.dp.config.bookAnnotationsToolbarDragOnlyFromHandle});return annotations.toolbox.use(_.map(A5.ANNOTATIONS_TOOLBOX.split(/, ?/),function(name){return new a5.Annotations.Tool[name]})),annotations.useTool(A5.ANNOTATIONS_INITIAL_TOOL),annotations},_buildPages:function($node){_.each($node.children("page"),function(pageNode,index){var $page=$(pageNode),pageModel=new a5.models.interaction.PPEbookPage({index:index,parent:this.model,thumbnail:A5.ASSET_URL_BUILDER($page.attr("thumbnail")),url:A5.ASSET_URL_BUILDER($page.attr("url")),width:parseInt($page.attr("width"),10),height:parseInt($page.attr("height"),10),audio:$page.attr("audio"),engine:this.engine});this.model.append(pageModel),this._buildHotspots(pageModel,$page.find("> hotspots"));var pageView=new a5.views.interaction.PPEbookPage(pageModel,this.view);this.view.append(pageView)},this)},_buildSolutionPages:function($node,cloneHotspots){_.each($node.children("solution-page"),function(pageNode,index){var $page=$(pageNode),pageModel=new a5.models.interaction.PPEbookSolutionPage({index:index,parent:this.model,thumbnail:A5.ASSET_URL_BUILDER($page.attr("thumbnail")),url:A5.ASSET_URL_BUILDER($page.attr("url")),width:parseInt($page.attr("width"),10),height:parseInt($page.attr("height"),10),audio:$page.attr("audio"),ref:$page.attr("ref"),engine:this.engine});this.model.appendSolutionPage(pageModel),cloneHotspots&&(pageModel.hotspots=pageModel.page.hotspots.slice()),this._buildHotspots(pageModel,$page.find("> hotspots"));var pageView=new a5.views.interaction.PPEbookPage(pageModel,this.view);this.view.appendSolutionPage(pageView)},this)},_buildTocEntries:function($node,parent){var currentSection=parent;_.each($node.children("entry, section"),function(item){var $item=$(item);if($item.is("section")){var section=new a5.views.interaction.PPEbookTOCSection(this.model,$item.attr("title"));parent.append(section),currentSection=section}else{var range=this._extractPageRange($item.attr("page")),entry=new a5.views.interaction.PPEbookTOCEntry(this.model,$item.attr("title"),range.start,range.end,$item.attr("pagelabel"));currentSection.append(entry),this._buildTocEntries($item,entry)}},this)},_buildHotspots:function(pageModel,$node){_.each($node.children(),function(entry){var $entry=$(entry),visibility=$entry.attr("visibility");if(!visibility||"all"===visibility||visibility===a5.service.lms.API.getUserRole().toLowerCase()){var hotspotClass=this._extractHotspotClassFromNode($entry),hotspot=new hotspotClass(this.model,this.view,$entry);hotspot.icon=$entry.attr("icon"),hotspot.shape=$entry.attr("shape")||"",hotspot.tooltip=this._buildTooltip($entry),_.each(["top","left","width","height"],function(attr){hotspot[attr]=parseInt($entry.attr(attr),10)}),"external"===hotspot.type&&(this.currentExternalHotspot&&(this.currentExternalHotspot.next=hotspot),hotspot.prev=this.currentExternalHotspot,this.currentExternalHotspot=hotspot),pageModel.addHotspot(hotspot)}},this)},_buildTooltip:function($node){var tooltip=$node.attr("tooltip");return tooltip&&(tooltip=tooltip.split("##")[0]),tooltip},_extractHotspotClassFromNode:function($node){var tagName=$node[0].tagName,className="PPEbookHotspot"+a5.utils.capitalize(tagName);"audio"===tagName?className+=a5.utils.capitalize($node.attr("mode")):"page-link"===tagName?className="PPEbookHotspotPageLink":"content-solution"===tagName?className="PPEbookHotspotContentSolution":"structure-node"===tagName?className=$node.find("> children").length>0?"PPEbookHotspotMultipleStructure":"PPEbookHotspotSingleStructure":"embedded"===tagName&&(className+=a5.utils.capitalize($node.attr("target")));var hotspotClass=a5.views.interaction[className];return hotspotClass=hotspotClass||a5.views.interaction.PPEbookHotspotContent},_extractPageRange:function(pageAttr){var pos=pageAttr.indexOf("-",1),start=-1===pos?pageAttr:pageAttr.substring(0,pos),end=-1===pos?pageAttr:pageAttr.substring(pos+1);return{start:parseInt(start,10),end:parseInt(end,10)}},_onWindowResize:function(){this._updateScroller()},_onFullscreenChange:function(){this._updateScroller()},_updateScroller:function(){this.view.pages.updateScroller({afterResize:!0})}},a5.model_builder.BookBuilder.extend("a5.model_builder.PPEbookBuilder"),a5.models.interaction.Book={title:null},a5.models.interaction.BaseModel.extend("a5.models.interaction.Book"),a5.models.interaction.PPEbook={init:function(parameters){this._super(parameters,{lastVisitedPage:0,page:0,startingPage:null,pageCount:0,pagesPerScreen:0,restorePerScreen:!0,offset:0,cover:!1,effects:!1,author:null,title:null}),this.pages=[],this.solutionPages=[],this.annotations=null,this.overlay=new a5.models.interaction.PPEbookOverlay,this.overlay.bind("changed",function(){this.trigger("overlay_change")},this),this.isValidPage(this.startingPage)&&(this.skipRestorePage=!0,this.page=this.printedPageToPageIndex(this.startingPage))},append:function(page){this.pages.push(page),this.pageCount=this.pages.length,this.annotations&&this.annotations.allocate(page)},appendSolutionPage:function(solutionPage){this.solutionPages.push(solutionPage);var pageIndex=parseInt(solutionPage.ref,10)-1,page=this.pages[pageIndex];page&&(page.solutionPage=solutionPage,solutionPage.page=page),this.annotations&&this.annotations.allocate({index:solutionPage.index+this.pageCount})},storePages:function(){return{children:_(this.pages).reduce(function(result,page,index){var pageData=page.store();return _.isEmpty(pageData)||(result[index]=pageData),result},{})}},restorePages:function(data){_.each(this.pages,function(page,i){page.restore(data.children[i])},this)},serializePages:function(){return _.invoke(this.pages,"serialize")},store:function(){this.annotations&&this.annotations.save();var data=this.storePages();return data.lastVisitedPage=this.lastVisitedPage,data.page=this.page,data.pagesPerScreen=this.pagesPerScreen,data.overlay=this.overlay.store(),data},restore:function(data){data&&(data.children&&this.restorePages(data),this.skipRestorePage||(this.isValidPage(this.pageIndexToPrintedPage(data.page))?this.page=data.page:this.page=0,this.lastVisitedPage=data.lastVisitedPage),this.restorePerScreen&&(this.pagesPerScreen=data.pagesPerScreen),this.overlay.restore(data.overlay),this.trigger("restore"))},openPageNumber:function(pageNumber){this.openPage(this.printedPageToPageIndex(pageNumber))},nextPage:function(){var page=this.page+this.pagesPerScreen;page>=this.pageCount&&(page=this.pageCount-1),this.openPage(page)},previousPage:function(){this.openPage(this.page-this.pagesPerScreen)},openPage:function(page,options){this._inBounds(page)||(page=0),this.lastVisitedPage=this.page,this.page=page,this.trigger("page_change",options)},openLastVisitedPage:function(){this.openPage(this.lastVisitedPage)},setStartingPage:function(page){this.startingPage=page,this.openPageNumber(page)},setPagesPerScreen:function(value){this.pagesPerScreen=value,this.page=this.current.from,this.trigger("page_change"),this.trigger("per_screen_change")},getPagesPerScreen:function(){return this.pagesPerScreen},getRestrictedPages:function(){return this.restrictedPages||(this.restrictedPages=this._expandRestrictedList(a5.service.lms.API.getRestrictedPages())),this.restrictedPages},isRestrictedPage:function(page){return _.contains(this.getRestrictedPages(),this.pageIndexToPrintedPage(page))},hasSolutionPage:function(pageIndex){return pageIndex>=0&&pageIndex<this.pageCount&&!!this.pages[pageIndex].solutionPage},getBookmarks:function(){return _(this.pages).chain().filter(function(page){return page.bookmarked}).map(function(page){return{page:page.number,thumbnail:page.thumbnail,text:page.bookmarkText}}).value()},bookmark:function(printedPage,text){var pageIndex=this.printedPageToPageIndex(printedPage);this.pages[pageIndex].bookmark(text)},unbookmark:function(printedPage){var pageIndex=this.printedPageToPageIndex(printedPage);this.pages[pageIndex].unbookmark()},getNotes:function(){var notes=[];if(this.annotations){var annotations=this.annotations.current.serialize().annotations;_.chain(annotations).pick(function(annotation){return annotation.features.length>0&&_(annotation.features).some(function(feature){return"Block"===feature.type})}).each(function(annotation,pageIndex){_.each(annotation.features,function(feature){"sticky note"===feature.content.tool.name&&notes.push({page:this.pageIndexToPrintedPage(pageIndex),title:feature.content.title})},this)},this)}return notes},addFileHotspot:function(printedPage,hotspot){var page=this.getPageByPageNumber(printedPage);page&&page.addFileHotspot(hotspot)},closeAllHotspots:function(){_(this.pages).invoke("closeHotspots")},getHotspotById:function(id){var found;return _.each(this.pages,function(page){found||(found=page.getHotspotById(id))}),found},getPageByPageNumber:function(printedPage){var pageIndex=this.printedPageToPageIndex(printedPage);return this.pages[pageIndex]},getPageByPageIndex:function(pageIndex){return this.pages[pageIndex]},getCurrentPage:function(){return this.pages[this.current.from]},getCurrentPageNumber:function(){return this.pageIndexToPrintedPage(this.current.from)},pageIndexToPrintedPage:function(pageIndex){return pageIndex-this.offset+1},printedPageToPageIndex:function(printedPage){return printedPage+this.offset-1},isValidPage:function(printedPage){var pageIndex=this.printedPageToPageIndex(printedPage);return!_.isNaN(pageIndex)&&_.isNumber(pageIndex)&&this._inBounds(pageIndex)},save:function(){a5.mainBuilder.curInteraction.store()},_expandRestrictedList:function(list){return _(list).chain().map(function(item){var range=item.split("-"),start=parseInt(_.first(range),10),end=parseInt(_.last(range),10);if(!_.isNaN(start)&&!_.isNaN(end))return _.range(start,end+1)}).compact().flatten().uniq().value()},_inBounds:function(page){return page>=0&&page<this.pageCount}},a5.models.interaction.Book.extend("a5.models.interaction.PPEbook"),a5.models.interaction.PPEbookPage={note:"",bookmarked:!1,bookmarkText:null,restricted:!1,number:null,solutionPage:null,cover:!1,init:function(parameters,defaults){this._super(parameters,{index:null,url:null,width:0,height:0,thumbnail:null,audio:null}),this.cover=this.parent.cover&&0===parameters.index,this.number=this.parent.pageIndexToPrintedPage(parameters.index),this.restricted=this.parent.isRestrictedPage(parameters.index),this.hotspots=[]},bookmark:function(text){this.bookmarked=!0,this.bookmarkText=text},unbookmark:function(){this.bookmarked=!1,this.bookmarkText=null},addFileHotspot:function(hotspot){hotspot.page=this,this.hotspots.push(hotspot),this.trigger("hotspot_added",hotspot)},removeFileHotspot:function(hotspot){this.hotspots=_(this.hotspots).reject(function(h){return h.id===hotspot.id})},addHotspot:function(hotspot){this.hotspots.push(hotspot),this.trigger("hotspot_added",hotspot)},getVisibleHotspots:function(){return(this.dfdVisibleHotspots||(this.dfdVisibleHotspots=function(){var structureHotspotRefs=_.chain(this.hotspots).filter(function(hotspot){return"structure-single"===hotspot.type||"structure-multiple"===hotspot.type}).pluck("ref").value();return $.when(this.engine.invoke("book:hotspots:filter-structure-nodes",structureHotspotRefs))}.bind(this)())).then(function(visibleStructureHotspotRefs){return _.reject(this.hotspots,function(hotspot){return("structure-single"===hotspot.type||"structure-multiple"===hotspot.type)&&!_.contains(visibleStructureHotspotRefs,hotspot.ref)})}.bind(this))},closeHotspots:function(){_(this.hotspots).invoke("close")},getHotspotById:function(id){return _.find(this.hotspots,function(hotspot){return hotspot.id===id})},hasNotes:function(){return!_.isString(this.note)||$(this.note).text().trim().length>0},hasResources:function(){return!!this.engine.invoke("book:has-resources",{page:this.number,index:this.index,offset:this.parent.offset})},hasHotspots:function(){return!!this.hotspots.length},store:function(){var data={};if(this.note&&(data.note=this.note),this.bookmarked&&(data.bookmarked=!0),this.bookmarkText&&(data.bookmarkText=this.bookmarkText),this.hotspots){var hotspots=this._serializeFileHotspots();hotspots.length>0&&(data.hotspots=hotspots)}return data},restore:function(data){data&&("note"in data&&(this.note=data.note),"bookmarked"in data&&(this.bookmarked=data.bookmarked),"bookmarkText"in data&&(this.bookmarkText=data.bookmarkText),this.trigger("restore",data))},serialize:function(){return{page:this.number,cover:this.cover,restricted:this.restricted,thumbnail:this.thumbnail,bookmarked:this.bookmarked,url:this.url}},_serializeFileHotspots:function(){return _(this.hotspots).chain().filter(function(hotspot){return"file"===hotspot.type}).map(function(hotspot){return hotspot.serialize()}).value()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.PPEbookPage"),a5.models.interaction.PPEbookSolutionPage={
init:function(parameters,defaults){this._super(parameters,{index:null,url:null,width:0,height:0,thumbnail:null,audio:null,ref:null,page:null}),this.hotspots=[]},addFileHotspot:function(hotspot){hotspot.page=this,this.hotspots.push(hotspot),this.trigger("hotspot_added",hotspot)},removeFileHotspot:function(hotspot){this.hotspots=_(this.hotspots).reject(function(h){return h.id===hotspot.id})},addHotspot:function(hotspot){this.hotspots.push(hotspot),this.trigger("hotspot_added",hotspot)},getVisibleHotspots:function(){return(this.dfdVisibleHotspots||(this.dfdVisibleHotspots=function(){var structureHotspotRefs=_.chain(this.hotspots).filter(function(hotspot){return"structure-single"===hotspot.type||"structure-multiple"===hotspot.type}).pluck("ref").value();return $.when(this.engine.invoke("book:hotspots:filter-structure-nodes",structureHotspotRefs))}.bind(this)())).then(function(visibleStructureHotspotRefs){return _.reject(this.hotspots,function(hotspot){return("structure-single"===hotspot.type||"structure-multiple"===hotspot.type)&&!_.contains(visibleStructureHotspotRefs,hotspot.ref)})}.bind(this))},store:function(){var data={};if(this.hotspots){var hotspots=this._serializeFileHotspots();hotspots.length>0&&(data.hotspots=hotspots)}return data},restore:function(data){data&&this.trigger("restore",data)},_serializeFileHotspots:function(){return _(this.hotspots).chain().filter(function(hotspot){return"file"===hotspot.type}).map(function(hotspot){return hotspot.serialize()}).value()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.PPEbookSolutionPage"),a5.models.interaction.PPEbookOverlay={setSwatch:function(swatch,isRestore){this.isDisabled(swatch)?(delete this.swatch,this.trigger("disable-overlay")):(this.swatch=swatch,this.trigger("set-swatch",swatch)),isRestore||this.trigger("changed")},isDisabled:function(swatch){return"swatch-none"===swatch},store:function(){return this.swatch},restore:function(data){data&&(this.setSwatch(data,!0),this.trigger("update",data))}},a5.models.interaction.BaseModel.extend("a5.models.interaction.PPEbookOverlay"),a5.views.interaction.BookAudioPlayer={template:"book_audio_player",init:function(model){this._super(model,null,$('<div class="audio-player"></div>')),this.volumeControl=new a5.views.interaction.BookSlider(1),this.volumeControl.bind("change",this.volumeControlChanged,this),this.player=new a5.SimpleAudioPlayer,this.player.bind("change_state",this.stateChanged,this),this.player.bind("change_state:deferred",this.afterStateChanged,this),this.player.bind("change_volume",this.volumeChanged,this)},render:function(){return this._super(),this.$(".sound-mute").before(this.volumeControl.render()),_.defer(_.bind(this.stateChanged,this)),_.defer(_.bind(this.volumeChanged,this)),this.bindNode("click",".sound-play",this.play),this.bindNode("click",".sound-pause",this.pause),this.bindNode("click",".sound-stop",this.stop),this.bindNode("click",".sound-mute",function(){this.player.changeVolume(0)}),this.bindNode("click",".sound-unmute",function(){this.player.changeVolume(1)}),this.node},hide:function(){this.node.hide()},play:function(){this.player.play()},pause:function(){this.player.pause()},stop:function(){this.player.stop()},stateChanged:function(){var playing="playing"==this.player.state;this.$(".sound-play").toggle(!playing),this.$(".sound-pause").toggle(playing)},afterStateChanged:function(){this.node.toggleClass("no-audio",!this.player.queue.length)},volumeControlChanged:function(){this.player.changeVolume(this.volumeControl.current)},volumeChanged:function(){this.volumeControl.setTo(this.player.volume);var muted=this.player.volume<=0;this.$(".sound-mute").toggle(!muted),this.$(".sound-unmute").toggle(muted)}},a5.views.interaction.TemplateView.extend("a5.views.interaction.BookAudioPlayer"),a5.views.BookLink={NODE_TEMPLATE:'<li class="link gui-control linkactivity"></li>',init:function(text,href,target){this.$el=$(this.NODE_TEMPLATE),this.href=href,this.target=target,this.text=text,_.bindAll(this,"_onClick"),this.$el.on("click","a",this._onClick)},render:function(){var $link=$("<a>").text(this.text);return $link.attr("href",this.href),$link.attr("title",this.href),this.$el.html($link),this.$el},open:function(){if(this.trigger("open"),"dialog"!==this.target||navigator.userAgent.toLowerCase().indexOf("nexus 7")>0)a5.mainBuilder.engine.invoke("open-link",this.href);else{var $dialog=$(a5.mainBuilder.layout.getTemplate("ebook_external_link"));$dialog.modal(),$dialog.on("hidden",function(){$dialog.remove()}),a5.mainBuilder.engine.invoke("open-link",this.href,{target:"iframe",$iframe:$dialog.find("iframe")})}},_onClick:function(e){e.preventDefault(),this.open()}},Obj.extend("a5.views.BookLink"),a5.views.interaction.BookSlider={template:"book_slider",disabled:!1,init:function(max){this._super(null,null,$('<div class="slider"></div>')),this.max=max},render:function(){return this._super(),this.bindNodeD("mousedown",this.mousedown),this.node},mousedown:function(e){this.setByCoordinate(e.pageX),$("body").on("mousemove",_.bind(this.mousemove,this)).on("mouseup mouseleave",_.bind(this.mouseup,this)),this.disabled=!0},mousemove:function(e){this.setByCoordinate(e.pageX)},mouseup:function(e){$("body").off("mousemove mouseup mouseleave"),this.disabled=!1},setByCoordinate:function(left){left-=this.node.offset().left,this._setTo(left/this.node.outerWidth()*this.max),this.trigger("change")},setTo:function(value){this.disabled||this._setTo(value)},_setTo:function(value){value>this.max&&(value=this.max),value<0&&(value=0),this.current=value;var valuePct=value/this.max*100;this.$(".handle").css("left",valuePct+"%"),this.$(".progress").css("width",valuePct+"%")},setMax:function(value){this.max=value}},a5.views.interaction.TemplateView.extend("a5.views.interaction.BookSlider"),a5.views.interaction.BookToolbar={init:function(model,parent){this._super(model,parent,$('<div class="toolbar"></div>')),this.audioPlayer=new a5.views.interaction.BookAudioPlayer},render:function(){return this._super(),this.$(".container").prepend(this.audioPlayer.render()),this.node}},a5.views.interaction.TemplateView.extend("a5.views.interaction.BookToolbar"),a5.views.interaction.PPEbook={template:"ebook",init:function(model){this._super(model,null,$('<div class="ebook book"></div>')),this.options={},_.bindAll(this,"_onKeydown","_onKeyup","_onCloseCountdownSetup","_onFullscreenChange","_onClickGoPage","_onSubmitGoPage","_onKeydownCurrentPage","_onClickCurrentPage","_onClick","_onClickGoFirst","_onClickGoLast","_onClickGoPrev","_onClickGoNext","_onChangePagePerScreen","_onClickPagePerScreen","_onClickZoomIn","_onClickZoomOut","_onClickZoomReset","_onClickMarqueeZoom","_onClickHand","_onClickCountdown","_onClickTOC","_onClickNotes","_onClickBookmarks","_onClickToggleBookmark","_onClickAnnotationTools","_onClickWiki","_onClickFullscreen","_onClickLastVisitedPage","_onClickAttachFile","_onClickSolutionView"),this.pages=new a5.views.interaction.PPEbookPages(model,this,model.cover),this.toolbar=new a5.views.interaction.PPEbookToolbar(model,this);var panelType=_.str.capitalize(a5.dp.config.bookPanelsType);this.toc=new a5.view["PPEbookTOC"+panelType](model,this.pages.scroller),this.toc.bind("open",function(){this.node.addClass("toc-opened"),this.$(".go-toc").addClass("active"),this.pages.scroller.addPanOffset(this.$(".sidebar-panel.opened").outerWidth()),this.pages.scroller.toggleHand()},this),this.toc.bind("close",function(){this.node.removeClass("toc-opened"),this.$(".go-toc").removeClass("active"),this.pages.scroller.isZoomedIn()||this.pages.scroller.resetPanOffset(),this.pages.scroller.disableHand(),a5.eventBus.trigger("book:toc_closed")},this),this.resourcesPanel=new a5.view["PPEbookResourcesPanel"+panelType](model,this.pages.scroller),this.resourcesPanel.bind("open",function(){this.node.addClass("resources-opened"),this.$(".resources").addClass("active"),this.pages.scroller.addPanOffset(this.$(".sidebar-panel.opened").outerWidth()),this.pages.scroller.toggleHand()},this),this.resourcesPanel.bind("close",function(){this.node.removeClass("resources-opened"),this.$(".resources").removeClass("active"),this.pages.scroller.isZoomedIn()||this.pages.scroller.resetPanOffset(),this.pages.scroller.disableHand()},this),this.notes=new a5.view["PPEbookNotes"+panelType](model),this.notes.bind("open",function(){this.node.addClass("notes-opened"),this.$(".notes").addClass("active"),this.pages.scroller.addPanOffset(this.$(".sidebar-panel.opened").outerWidth()),this.pages.scroller.toggleHand()},this),this.notes.bind("close",function(){this.node.removeClass("notes-opened"),this.$(".notes").removeClass("active"),this.pages.scroller.isZoomedIn()||this.pages.scroller.resetPanOffset(),this.pages.scroller.disableHand(),this._updateHasNoteFlag()},this),this.bookmarks=new a5.view["PPEbookBookmarks"+panelType](model),this.bookmarks.bind("open",function(){this.node.addClass("bookmarks-opened"),this.$(".bookmarks").addClass("active"),this.pages.scroller.addPanOffset(this.$(".sidebar-panel.opened").outerWidth()),this.pages.scroller.toggleHand()},this),this.bookmarks.bind("close",function(){this.node.removeClass("bookmarks-opened"),this.$(".bookmarks").removeClass("active"),this.pages.scroller.isZoomedIn()||this.pages.scroller.resetPanOffset(),this.pages.scroller.disableHand(),this._updateBookmarkedFlag()},this),this.bookmarks.bind("change",function(){this._updateBookmarkedFlag()},this),this.wiki=new a5.views.WikiTool(model.parent),this.audioPlayer=this.toolbar.audioPlayer.player,model.effects&&this.node.addClass("spine-shadow"),this.pages.bind("opened",this._onPageOpened,this),this.pages.bind("opened-in-solution-view",this._onSolutionPageOpened,this),this.model.overlay.bind("set-swatch",this._updateAddOverlayFlag,this),this.model.overlay.bind("disable-overlay",this._updateRemoveOverlayFlag,this),this.countdownSetup=new a5.views.CountdownSetup(model,this,{onClose:this._onCloseCountdownSetup}),screenfull.enabled&&screenfull.onchange(this._onFullscreenChange),this.model.bind("page_change",this._onPageChange,this)},append:function(page){this.pages.append(page)},appendSolutionPage:function(page){this.pages.appendSolutionPage(page)},render:function(){this._super(),this.pages.render(),this.toolbar.render(),this.node.append(this.toc.$el),this.node.append(this.resourcesPanel.$el),this.node.append(this.notes.$el),this.node.append(this.bookmarks.$el),this.toc.render(),this.resourcesPanel.render(),this.notes.render(),this.bookmarks.render(),this._updatePagesPerScreenFlag(),this._updateHasNoteFlag(),this._updateBookmarkedFlag(),this._updateHasResourceFlag(),this.node.toggleClass("with-annotations",!!this.model.annotations);var solutionPageLock=this.$(".solution-page").attr("data-lock");return this.options.solutionViewLock=_.isEmpty(solutionPageLock)||"page"!==solutionPageLock,this.bindNodeP("click",".go-page",this._onClickGoPage),this.bindNodeD("submit",".go-page",this._onSubmitGoPage),this.bindNode("keydown",".current-page",this._onKeydownCurrentPage),this.bindNodeDP("click",".current-page",this._onClickCurrentPage),this.bindNode("click",this._onClick),this.bindNodeD("click",".go-first",this._onClickGoFirst),this.bindNodeD("click",".go-last",this._onClickGoLast),this.bindNodeD("click",".go-previous:not(.disabled)",this._onClickGoPrev),this.bindNodeD("click",".go-next:not(.disabled)",this._onClickGoNext),this.bindNode("change",".per-screen-switch input",this._onChangePagePerScreen),this.bindNodeD("click",".per-screen-switch span.check",this._onClickPagePerScreen),this.bindNodeD("click",".zoom-in:not(.disabled)",this._onClickZoomIn),this.bindNodeD("click",".zoom-out:not(.disabled)",this._onClickZoomOut),this.bindNodeD("click",".fullscreen",this._onClickZoomReset),this.bindNodeD("click",".marquee-zoom:not(.disabled)",this._onClickMarqueeZoom),this.bindNodeD("click",".hand:not(.disabled)",this._onClickHand),this.bindNodeD("click",".countdown:not(.disabled)",this._onClickCountdown),this.bindNodeD("click",".go-toc",this._onClickTOC),this.bindNodeD("click",".notes",this._onClickNotes),this.bindNodeD("click",".bookmarks",this._onClickBookmarks),this.bindNodeD("click",".bookmark-page",this._onClickToggleBookmark),this.bindNodeD("click",".tools",this._onClickAnnotationTools),this.bindNodeD("click",".wiki",this._onClickWiki),this.bindNodeD("click",".full-screen",this._onClickFullscreen),this.bindNodeD("click",".go-last-visited",this._onClickLastVisitedPage),this.bindNodeD("click",".attach-file",this._onClickAttachFile),this.bindNodeD("click",".solution-page",this._onClickSolutionView),this.bindNodeD("click",".hotspots",this._onClickToggleHotspots),this._enableKeyEvents(),this.trigger("render"),this.node},deselectTools:function(){this.pages.scroller.disableAttachFile(),this.pages.scroller.disableMarqueeZoom()},toggleCountdown:function(active){active?(this._disableKeyEvents(),this.countdownSetup.render().appendTo(a5.dp.config.appendCountdownTo||this.node),this.countdownSetupMode=!0):this.countdownSetup.close()},toggleBookmark:function(active){_.each(this.model.current,function(page){active?(page.model.bookmark(),a5.eventBus.trigger("book:bookmark_added",page.model.serialize())):(page.model.unbookmark(),a5.eventBus.trigger("book:bookmark_deleted",page.model.serialize()))}),this._updateBookmarkedFlag()},sendBack:function(){this.pages.sendBack()},bringFront:function(){this.pages.bringFront()},openResourcesPanel:function(ev){this.closeToc(),this.closeNotes(),this.closeBookmarks(),this.resourcesPanel.toggle()},closeResourcesPanel:function(){this.resourcesPanel.close()},openToc:function(ev){this.closeNotes(),this.closeBookmarks(),this.closeResourcesPanel(),this.toc.toggle()},closeToc:function(){this.toc.close()},openNotes:function(ev){this.closeToc(),this.closeBookmarks(),this.closeResourcesPanel(),this.notes.toggle()},closeNotes:function(){this.notes.close()},openBookmarks:function(ev){this.closeToc(),this.closeNotes(),this.closeResourcesPanel(),this.bookmarks.toggle()},closeBookmarks:function(){this.bookmarks.close()},openAnnotationTools:function(ev){this.model.annotations&&(this.model.annotations.toolbox.view.bind("show",function(){this.$(".tools").addClass("active")},this,{once:!0}),this.model.annotations.toolbox.view.bind("hide",function(){this.$(".tools").removeClass("active")},this,{once:!0}),this.model.annotations.toolbox.view.toggle())},openWiki:function(){this.wiki.show()},toggleFullscreen:function(fullscreen){(_.isUndefined(fullscreen)||fullscreen!=this.isFullscreen)&&(a5.dp.config.bookExternalFullscreen?this._onFullscreenChange():screenfull.enabled&&(this.isFullscreen?screenfull.exit():screenfull.request(document.body)))},toggleSolutionView:function(active){this._isSolutionView=_.isUndefined(active)?!this._isSolutionView:active,this.node.toggleClass("solution-view",this._isSolutionView)},isSolutionView:function(){return!!this._isSolutionView},addFileHotspot:function(page,options){var hotspot=new a5.views.interaction.PPEbookHotspotFile(this.model,this,options);this.model.addFileHotspot(page,hotspot)},_disableKeyEvents:function(){$(document).off("keydown",this._onKeydown),$(document).off("keyup",this._onKeyup)},_enableKeyEvents:function(){this._disableKeyEvents(),$(document).on("keydown",this._onKeydown),$(document).on("keyup",this._onKeyup)},_updateCurrentTocEntry:function(){var $node=$(".current-toc-entry");if($node.length){var entries=this.toc.toc.getEntriesByRange(this.model.current.from,this.model.current.to-1);entries.length?$node.text(entries[0].text):$node.text("")}},_updateAnnotationsToolboxPosition:function(){this.model.annotations&&this.model.annotations.toolbox.view.update()},_onCloseCountdownSetup:function(){this.$(".countdown").removeClass("active"),this._enableKeyEvents(),this.countdownSetupMode=!1},_onFullscreenChange:function(){this.isFullscreen=!this.isFullscreen,$(document.body).toggleClass("fullscreen",this.isFullscreen),this.$(".full-screen").toggleClass("active",this.isFullscreen),a5.eventBus.trigger("book:fullscreen",this.isFullscreen)},_onKeydown:function(ev){var key=ev.which;37==key||33==key?(this.$(".toolbar .go-previous:first").addClass("active"),this.model.previousPage(),ev.preventDefault()):39==key||34==key?(this.$(".toolbar .go-next:last").addClass("active"),this.model.nextPage(),ev.preventDefault()):40==key?(this.pages.scroller.panDown(),ev.preventDefault()):38==key?(this.pages.scroller.panUp(),ev.preventDefault()):36==key?this.model.openPage(0):35==key?this.model.openPage(this.model.pageCount-1):(key>=96&&key<=105||key>=48&&key<=57)&&(this.$(".current-page").is(":focus")||this.$(".current-page").focus(),this.$(".current-page").trigger("keypress",{which:key}),this._disableKeyEvents())},_onKeyup:function(ev){this.$(".toolbar .go-previous:first").removeClass("active"),this.$(".toolbar .go-next:last").removeClass("active")},_onPageChange:function(){this._updateAnnotationsToolboxPosition(),this._updateCurrentTocEntry(),this._closeAlerts()},_onPageOpened:function(current,options){var hasRestrictedPage=!1,hasSolutionPage=!1;this.$(".per-screen-switch [value="+this.model.pagesPerScreen+"]").attr("checked",!0),this.$(".per-screen-switch .check").removeClass("checked"),this.$(".per-screen-switch [data-value="+this.model.pagesPerScreen+"]").addClass("checked"),this.$(".go-next").removeClass("disabled"),this.$(".go-previous").removeClass("disabled"),this.$(".current-page").attr("disabled",!1),this.audioPlayer.clear(),_.each(current,function(page){page.model.audio&&this.audioPlayer.enque(page.model.audio),page.model.restricted&&(hasRestrictedPage=!0),page.model.solutionPage&&(hasSolutionPage=!0)},this),hasRestrictedPage&&a5.eventBus.trigger("book:show_restricted_page",this.model),this._updateSolutionViewFlag(hasSolutionPage),this._updatePagesPerScreenFlag(),this._updateHasNoteFlag(),this._updateBookmarkedFlag(),this._updateHasResourceFlag(),this._updateHasHotspotFlag()},_onSolutionPageOpened:function(current,options){this._onPageOpened(current,options)},_onClickGoPage:function(){},_onSubmitGoPage:function(){var $currentPage=this.$(".current-page"),page=parseInt($currentPage.val(),10);this.model.isValidPage(page)?this.model.openPageNumber(page):this._showInvalidPageAlert(page),$currentPage.val("").blur(),this._enableKeyEvents()},_onKeydownCurrentPage:function(ev){9!==ev.keyCode&&13!==ev.keyCode||(this.$(".go-page").submit(),ev.preventDefault())},_onClickCurrentPage:function(){this._disableKeyEvents()},_onClick:function(){this.$(".current-page").val("").blur(),this.countdownSetupMode||this._enableKeyEvents()},_onClickGoFirst:function(){this.model.openPage(0)},_onClickGoLast:function(){this.model.openPage(this.model.pageCount-1)},_onClickGoPrev:function(){this.model.previousPage()},_onClickGoNext:function(){this.model.nextPage()},_onChangePagePerScreen:function(ev){var pagesPerScreen=parseInt($(ev.target).val(),10);this.model.setPagesPerScreen(pagesPerScreen),a5.eventBus.trigger("book:pages_per_screen_changed",pagesPerScreen)},_onClickPagePerScreen:function(ev){var pagesPerScreen=parseInt($(ev.target).data("value"),10);this.model.setPagesPerScreen(pagesPerScreen),a5.eventBus.trigger("book:pages_per_screen_changed",pagesPerScreen)},_onClickZoomIn:function(){this.pages.scroller.zoomIn()},_onClickZoomOut:function(){this.pages.scroller.zoomOut()},_onClickZoomReset:function(){this.pages.scroller.resetZoom()},_onClickMarqueeZoom:function(){this.pages.scroller.toggleMarqueeZoom()},_onClickHand:function(){this.pages.scroller.toggleHand()},_onClickCountdown:function(ev){$(ev.target).toggleClass("active"),this.toggleCountdown($(ev.target).is(".active"))},_onClickFullscreen:function(){this.toggleFullscreen()},_onClickTOC:function(){this.openToc()},_onClickNotes:function(){this.openNotes()},_onClickBookmarks:function(){this.openBookmarks()},_onClickToggleBookmark:function(ev){$(ev.target).toggleClass("active"),this.toggleBookmark($(ev.target).is(".active"))},_onClickAnnotationTools:function(){this.openAnnotationTools()},_onClickWiki:function(){this.openWiki()},_onClickLastVisitedPage:function(){a5.eventBus.trigger("book:click_last_visited")},_onClickAttachFile:function(){this.pages.scroller.toggleAttachFile()},_onClickSolutionView:function(ev){this.toggleSolutionView(),this.isSolutionView()?this.pages.renderSolutionPage({afterSolutionOpened:!0}):this.model.openPage(this.model.page,{afterSolutionClosed:!0})},_onClickToggleHotspots:function(ev){$(ev.target).toggleClass("active"),this.node.toggleClass("hotspots-off")},_updateHasNoteFlag:function(){var hasNote=_.some(this.model.current,function(page){return page.model.hasNotes()});this.node.toggleClass("has-note",hasNote)},_updateBookmarkedFlag:function(){var bookmarked=_.some(this.model.current,function(page){return page.model.bookmarked});this.node.toggleClass("bookmarked",bookmarked),this.$(".bookmark-page").toggleClass("active",bookmarked)},_updateHasResourceFlag:function(){var from=this.model.current.from,to=this.model.current.to,promises=_.map(this.model.current,function(page){return page.model.hasResources()});this.node.removeClass("has-resource"),$.when.apply(this,promises).done(function(){var hasResource=_.some(arguments)&&from===this.model.current.from&&to===this.model.current.to;this.node.toggleClass("has-resource",hasResource)}.bind(this)).fail(function(){this.node.removeClass("has-resource")}.bind(this))},_updateHasHotspotFlag:function(){var hasHotspot=_.some(this.model.current,function(page){return page.model.hasHotspots()});this.node.toggleClass("has-hotspot",hasHotspot)},_updatePagesPerScreenFlag:function(){this.node.removeClass("double-page single-page"),this.node.addClass(2===this.pages.current.length?"double-page":"single-page")},_updateAddOverlayFlag:function(){this.node.addClass("has-overlay")},_updateRemoveOverlayFlag:function(){this.node.removeClass("has-overlay")},_updateSolutionViewFlag:function(hasSolutionPage){this.node.toggleClass("has-solution-page",hasSolutionPage),this.$(".solution-page").toggleClass("active",this.isSolutionView())},_isEmpty:function(text){return _.isString(text)&&0==$(text).text().trim().length},_closeAlerts:function(){this.invalidPageAlert&&this.invalidPageAlert.close()},_showInvalidPageAlert:function(page){this.invalidPageAlert&&this.invalidPageAlert.close(),this.invalidPageAlert=new a5.view.Alert({template:"a5.view.alert.InvalidPage",data:{current:page,last:this.model.pageIndexToPrintedPage(this.model.pageCount-1)},$root:this.$(".go-page"),alertClass:"invalid-page-alert"}),this.invalidPageAlert.show()}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPEbook"),a5.views.interaction.PPEbookToolbar={template:"ebook_toolbar",init:function(model,parent){this._super(model,parent),a5.dp.config.bookShowCurrentPagePlaceholder&&this.model.bind("page_change",this.onPageChange,this)},render:function(){return this._super(),this.overlayPicker=new a5.views.interaction.PPEbookOverlayPicker(this.model.overlay,this,this.node),this.node.appendTo(this.parent.node),this.showResourcesPanelButton(),this.parent.pages.scroller.bind("zoom_changed",this.toggleZoomButtons,this),this.$(".btn, .single-page, .dual-page, .current-page").delayedTooltip({delay:a5.dp.config.bookTooltipDelay,duration:a5.dp.config.bookTooltipDuration,cancel:"#annotations-toolbox"}),this.trigger("render"),this.node},hasAnnotationsButton:function(){var html=a5.mainBuilder.layout.getTemplate(this.template);return $(html).find(".tools").length>0},onPageChange:function(){this.$(".current-page").attr("placeholder",this.getCurrentPagePlaceholderText())},getCurrentPagePlaceholderText:function(){for(var text=[],n=this.model.getCurrentPageNumber(),p=n;p<n+this.model.current.length;p++)text.push(p);return 2===text.length&&text[0]>=0?text.join(" - "):1===text.length?text[0]<=0?"":text[0]:""},toggleZoomButtons:function(){_.defer(_.bind(function(){var scroller=this.parent.pages.scroller;this.$(".fullscreen").toggleClass("disabled",scroller.isInitialZoom()),this.$(".zoom-in").toggleClass("disabled",scroller.isLastZoomIn()),this.$(".zoom-out").toggleClass("disabled",scroller.isLastZoomOut()),this.$(".marquee-zoom").toggleClass("disabled",scroller.isLastZoomIn())},this))},showResourcesPanelButton:function(){var self=this;$.when(a5.service.lms.API.isEbookShowResourcesEnabled()).done(function(isEnabled){isEnabled?self.bindNode("click",".resources",function(ev){self.parent.openResourcesPanel(ev)}):self.$(".resources").addClass("disabled")}).fail(function(){self.$(".resources").addClass("disabled")})}},a5.views.interaction.BookToolbar.extend("a5.views.interaction.PPEbookToolbar"),a5.views.interaction.PPEbookOverlay={init:function(model,parent,pagesNode){this._super(model,parent,pagesNode.find(".overlay")),_.bindAll(this,"setSwatch","disableOverlay"),model.bind("set-swatch",this.setSwatch),model.bind("disable-overlay",this.disableOverlay),_.isUndefined(getComputedStyle(document.body).mixBlendMode)&&this.node.attr("data-no-blend","true")},updatePosition:function($pages,scroller){var rect=$pages[0].getBoundingClientRect();this.node.css({width:rect.width,height:rect.height,marginTop:scroller.roundedTop(),left:"50%",marginLeft:scroller.roundedLeft()-rect.width/2})},setSwatch:function(swatch){this.node.attr("class","overlay "+swatch)},disableOverlay:function(){this.node.attr("class","overlay")}},a5.views.interaction.BaseView.extend("a5.views.interaction.PPEbookOverlay"),a5.views.interaction.PPEbookOverlayPicker={init:function(model,parent,toolbarNode){this._super(model,parent,toolbarNode.find(".overlay")),_.bindAll(this,"_onClick","_onClickSwatch","_setSwatch","_update"),model.bind("update",this._update),this.node.on("click",this._onClick),this.node.find(".swatch").on("click",this._onClickSwatch)},toggle:function(){this.node.toggleClass("active"),this.node.find(".popup").toggleClass("hidden")},_onClick:function(ev){ev.target===this.node[0]&&this.toggle()},_onClickSwatch:function(ev){var $target=$(ev.target),swatch=_.filter($target.attr("class").split(/\s+/),function(s){return!_.contains(["swatch","active"],s)}).join(" ");this._setSwatch(swatch)},_setSwatch:function(swatch){this.model.setSwatch(swatch),this._update(swatch)},_update:function(swatch){var selector="."+swatch.split(/\s+/).join("."),$target=this.$(selector);$target.siblings().removeClass("active"),$target.addClass("active")}},a5.views.interaction.BaseView.extend("a5.views.interaction.PPEbookOverlayPicker"),a5.view.PPEbookDialog={init:function(){this._super({backdrop:a5.dp.config.bookDialogModal}),this.bind("render",this.onRender,this),this.bind("open",this.onOpen,this)},onRender:function(){a5.hooks.ppebookDialogRendered.call(this)},onOpen:function(){a5.hooks.ppebookDialogShowed.call(this)}},a5.view.BSModal.extend("a5.view.PPEbookDialog"),a5.view.PPEbookSidebar={init:function(){this._super(),this.bind("render",this.onRender,this),this.bind("open",this.onOpen,this)},onRender:function(){a5.hooks.ppebookSidebarRendered.call(this)},onOpen:function(){a5.hooks.ppebookSidebarShowed.call(this)}},a5.view.Sidebar.extend("a5.view.PPEbookSidebar"),a5.view.PPEbookClearAnnotationsDialog={template:"ebook_clear_annotations_dialog",init:function(){this._super(),this.$el.addClass("clear-annotations-popup"),_.bindAll(this,"_onClickClear"),this.$el.on("click",".clear-annotations",this._onClickClear)},_onClickClear:function(){this.trigger("submit")}},a5.view.PPEbookDialog.extend("a5.view.PPEbookClearAnnotationsDialog"),a5.view.PPEbookClearAllAnnotationsDialog={template:"ebook_clear_all_annotations_dialog"},a5.view.PPEbookClearAnnotationsDialog.extend("a5.view.PPEbookClearAllAnnotationsDialog"),a5.view.PPEbookBookmarksDialog={template:"ebook_bookmarks",init:function(model){this._super(),this.bookmarks=new a5.views.interaction.PPEbookBookmarks(model),this.model=model,this.$el.addClass("bookmarks-popup"),_.bindAll(this,"_onClickAdd","_onClickRemove"),this.$el.on("click",".add-bookmark",this._onClickAdd),this.$el.on("click",".remove-bookmark",this._onClickRemove),this.bookmarks.bind("bookmark:open",this._onBookmarkOpen,this),this.bookmarks.bind("bookmark:added",this._onBookmarkAdded,this),this.bookmarks.bind("bookmark:updated",this._onBookmarkUpdated,this),this.bookmarks.bind("bookmark:deleted",this._onBookmarkDeleted,this)},renderContent:function(){this.$el.find(".modal-body").html(this.bookmarks.$el),this.bookmarks.render()},onShow:function(){this.bookmarks.updateBookmarks(),this.bookmarks.refresh(),this._super()},_onClickAdd:function(){this.bookmarks.bookmark()},_onClickRemove:function(){this.bookmarks.unbookmark()},_onBookmarkOpen:function(){this.close()},_onBookmarkAdded:function(){this.trigger("change")},_onBookmarkUpdated:function(){this.trigger("change")},_onBookmarkDeleted:function(){this.trigger("change")}},a5.view.PPEbookDialog.extend("a5.view.PPEbookBookmarksDialog"),a5.view.PPEbookBookmarksSidebar={template:"ebook_bookmarks",init:function(model){this._super(),this.bookmarks=new a5.views.interaction.PPEbookBookmarks(model),this.model=model,this.$el.addClass("bookmarks-popup"),_.bindAll(this,"_onClickAdd","_onClickRemove"),this.$el.on("click",".add-bookmark",this._onClickAdd),this.$el.on("click",".remove-bookmark",this._onClickRemove),this.bookmarks.bind("bookmark:open",this._onBookmarkOpen,this),this.bookmarks.bind("bookmark:added",this._onBookmarkAdded,this),this.bookmarks.bind("bookmark:updated",this._onBookmarkUpdated,this),this.bookmarks.bind("bookmark:deleted",this._onBookmarkDeleted,this)},renderContent:function(){this.$el.find(".modal-body").html(this.bookmarks.$el),this.bookmarks.render()},_onClickAdd:function(){this.bookmarks.bookmark()},_onClickRemove:function(){this.bookmarks.unbookmark()},_onBookmarkOpen:function(){this.close()},_onBookmarkAdded:function(){this.trigger("change")},_onBookmarkUpdated:function(){this.trigger("change")},_onBookmarkDeleted:function(){this.trigger("change")},open:function(){this.bookmarks.updateBookmarks(),this.bookmarks.refresh(),this.model.openSidebar="bookmarks",this._super()},close:function(){delete this.model.openSidebar,this._super()}},a5.view.PPEbookSidebar.extend("a5.view.PPEbookBookmarksSidebar"),a5.views.interaction.PPEbookBookmarks={template:"ebook_bookmarks",init:function(model){this.model=model,this.$el=$("<div>",{class:"ebook-bookmarks"}),this.bookmarks=[],this.model.bind("restore",this._onBookRestore,this)},render:function(){this._detachBookmarks();var html=a5.mainBuilder.layout.getTemplate(_.result(this,"template")),$root=$("<div></div>");return $root.html(html),html=$root.find(".modal-body").html(),this.$el.html(html),this._renderBookmarks("ul"),this.trigger("render"),this.$el},refresh:function(){this.render()},bookmark:function(){var pages=a5.dp.config.bookBookmarkMultiple?this.model.current:[_.first(this.model.current)];_.each(pages,function(page){if(!page.model.bookmarked){var bookmark=new a5.views.interaction.PPEbookBookmark(page.model,this);this._addBookmark(bookmark)}},this)},unbookmark:function(){_.each(this.model.current,function(page){var bookmark=this._getBookmarkByPage(page.model);bookmark&&bookmark.remove()},this)},updateBookmarks:function(){this.bookmarks=[],_.each(this.model.pages,function(page){if(page.bookmarked){var bookmark=new a5.views.interaction.PPEbookBookmark(page,this);this._addBookmark(bookmark,!0)}},this)},_onBookmarkOpen:function(bookmark){this.model.openPageNumber(bookmark.page.number),this.trigger("bookmark:open")},_onBookmarkAdded:function(bookmark){this.refresh(),bookmark.focusInput(),this.trigger("bookmark:added"),a5.eventBus.trigger("book:bookmark_added",bookmark.page.serialize())},_onBookmarkUpdated:function(bookmark){a5.mainBuilder.curInteraction.store(),this.trigger("bookmark:updated"),a5.eventBus.trigger("book:bookmark_updated",bookmark.page.serialize())},_onBookmarkDeleted:function(bookmark){this._removeBookmark(bookmark),this.refresh(),a5.mainBuilder.curInteraction.store(),this.trigger("bookmark:deleted"),a5.eventBus.trigger("book:bookmark_deleted",bookmark.page.serialize())},_onBookRestore:function(){this.updateBookmarks(),this.refresh()},
_renderBookmarks:function($appendTo){var $target=$appendTo||this.$el;_.isString($target)&&($target=this.$el.find($target));var fragment=document.createDocumentFragment();_.each(this.bookmarks,function(child){fragment.appendChild(child.$el[0]),child.render()}),$target.append(fragment)},_detachBookmarks:function(){_.each(this.bookmarks,function(child){child.$el.detach()})},_getBookmarkByPage:function(page){return _.find(this.bookmarks,function(bookmark){return bookmark.page===page})},_removeBookmark:function(bookmark){this.bookmarks=_.without(this.bookmarks,bookmark)},_addBookmark:function(bookmark,silent){this.bookmarks.push(bookmark),this.bookmarks=_.sortBy(this.bookmarks,function(bookmark){return bookmark.page.index}),bookmark.bind("open",this._onBookmarkOpen,this),bookmark.bind("change",this._onBookmarkUpdated,this),bookmark.bind("remove",this._onBookmarkDeleted,this),bookmark.page.bookmark(bookmark.page.bookmarkText),silent||this._onBookmarkAdded(bookmark)}},Obj.extend("a5.views.interaction.PPEbookBookmarks"),a5.views.interaction.PPEbookBookmark={read_template:"ebook_bookmarks_read",write_template:"ebook_bookmarks_write",default_read_template:'<div class="clearfix">    <strong>        <span class="page-label">            <button class="gui-fancy remove" title="Remove bookmark"></button>            <button class="gui-fancy edit" title="Edit bookmark"></button>            <span class="title<%= page.bookmarkText ? "" : " untitled" %>"><%= page.bookmarkText || "untitled" %></span>        </span>    </strong>    <span class="page-number"><%= page.number || "" %></span></div>',default_write_template:'<div class="clearfix">    <form><strong>        <span class="page-label">            <button class="gui-fancy remove" title="Remove bookmark"></button>            <button class="gui-fancy edit" title="Edit bookmark"></button>            <span class="title"><input type="text" value="<%= page.bookmarkText %>" maxlength="64" placeholder="Bookmark title" title="Type in a custom bookmark title" /></span>        </span>    </strong></form>    <span class="page-number"><%= page.number || "" %></span></div>',init:function(page,parent){this.page=page,this.$el=$("<li>",{class:"bookmarks-entry"}),this.editing=_.isNull(this.page.bookmarkText),_.bindAll(this,"_onFormSubmit","_onFormBlur","_onClickEdit","_onClickRemove","_onClickTitle","_onClickPageNumber","_onInputKeydown"),this.$el.on("submit","form",this._onFormSubmit),this.$el.on("blur","form",this._onFormBlur),this.$el.on("keydown","input",this._onInputKeydown),this.$el.on("click",".edit",this._onClickEdit),this.$el.on("click",".remove",this._onClickRemove),this.$el.on("click",".title",this._onClickTitle),this.$el.on("click",".page-number",this._onClickPageNumber)},render:function(){return this.editing?this._renderWrite():this._renderRead(),this.$el.toggleClass("editing",this.editing),this.trigger("render"),this.$el},refresh:function(){this.render()},_onFormSubmit:function(e){e.preventDefault(),this.updateText()},_onFormBlur:function(e){e.preventDefault(),this.updateText()},_onInputKeydown:function(e){e.stopPropagation(),27===e.which&&this.escapeBlur()},_onClickEdit:function(e){e.stopPropagation(),this.editing||this.edit()},_onClickRemove:function(e){e.stopPropagation(),this.editing||this.remove()},_onClickTitle:function(e){this.editing||this.openPage()},_onClickPageNumber:function(e){this.editing||this.openPage()},_renderRead:function(){var html=a5.mainBuilder.layout.getTemplate(_.result(this,"read_template"));if(""===html){html=_.template(this.default_read_template)({page:this.page})}else{var $html=$(html),$title=$html.find(".page-label .title");$title.toggleClass("untitled",!this.page.bookmarkText),this.page.bookmarkText&&$title.html(this.page.bookmarkText);var $pageNum=$html.find(".page-number");this.page.number&&$pageNum.html(this.page.number),html=$html.get(0)}this.$el.empty().append(html)},_renderWrite:function(){var html=a5.mainBuilder.layout.getTemplate(_.result(this,"write_template"));if(""===html){html=_.template(this.default_write_template)({page:this.page})}else{var $html=$(html),$title=$html.find(".page-label .title input[type=text]");$title.toggleClass("untitled",!this.page.bookmarkText),this.page.bookmarkText&&$title.val(this.page.bookmarkText);var $pageNum=$html.find(".page-number");this.page.number&&$pageNum.html(this.page.number),html=$html.get(0)}this.$el.empty().append(html)},updateText:function(){this.editing&&(this.editing=!1,this.page.bookmark(this.$el.find("input").val()),this.refresh(),this.trigger("change",this))},escapeBlur:function(){this.editing&&this.$el.find("input").val(this.page.bookmarkText).blur()},focusInput:function(){this.$el.find("input").focus()},openPage:function(){this.trigger("open",this)},edit:function(){this.editing=!0,this.refresh(),this.focusInput()},remove:function(){this.page.unbookmark(),this.trigger("remove",this)}},Obj.extend("a5.views.interaction.PPEbookBookmark"),a5.views.interaction.PPEbookBookmark.version=5,a5.view.PPEbookNotesDialog={template:"ebook_notes",init:function(book){this._super(),this.notes=a5.dp.config.bookNotesAsTabPanel?new a5.view.PPEbookNotebook(book):new a5.views.interaction.PPEbookNotes(book),this.book=book,this.$el.addClass("notes-popup"),this.notes.bind("page-number:click",this._onClickPageNumber,this)},renderContent:function(){var $notes=this.notes.render();this.$el.find(".modal-body").html($notes)},onShown:function(){this.notes.setup(),this._super()},onHidden:function(){this.notes.checkChanges(),this._super()},onShow:function(){this.notes.teardown(),this.notes.goTo(this.book.page,!0),this.notes.updateNotes(),this._super()},onHide:function(){this.notes.teardown(),this._super()},_onClickPageNumber:function(){this.close()}},a5.view.PPEbookDialog.extend("a5.view.PPEbookNotesDialog"),a5.view.PPEbookNotesSidebar={template:"ebook_notes",init:function(book){this._super(),this.notes=a5.dp.config.bookNotesAsTabPanel?new a5.view.PPEbookNotebook(book):new a5.views.interaction.PPEbookNotes(book),this.book=book,this.$el.addClass("notes-popup"),this.notes.bind("page-number:click",this._onClickPageNumber,this)},renderContent:function(){var $notes=this.notes.render();this.$el.find(".modal-body").html($notes)},open:function(){this.notes.teardown(),this.notes.goTo(this.book.page,!0),this.notes.updateNotes(),this.notes.setup(),this.book.openSidebar="notes",this._super()},close:function(){this.notes.teardown(),this.notes.checkChanges(),delete this.book.openSidebar,this._super()},_onClickPageNumber:function(){this.close()}},a5.view.PPEbookSidebar.extend("a5.view.PPEbookNotesSidebar"),a5.view.PPEbookNotebook={init:function(model,options){this._super(model,options),this.book=model,this.options.offset=this.book.cover?this.getPagesPerScreen()-1:0,this.options.editorSettings=_.result(a5.dp.config,"bookNotesEditor"),this.bind("page-number:click",this._onClickPageNumber,this)},getPages:function(){return this.pages||(this.pages=this.book.pages),this.pages},getTotalPages:function(){return this.book.pageCount},getPagesPerScreen:function(){return this.book.getPagesPerScreen()},getTitle:function(){return this.book.title},getCurrentPageText:function(){for(var text=[],n=this.book.getCurrentPageNumber(),p=n;p<n+this.book.current.length;p++)text.push(p);return 2===text.length&&text[0]>=0?text.join(" - "):1===text.length?text[0]<=0?"":text[0]:""},save:function(){this._super(),this.book.save()},_onClickPageNumber:function(pageNumber){this.book.openPageNumber(pageNumber)}},a5.view.Notebook.extend("a5.view.PPEbookNotebook"),a5.views.interaction.PPEbookNotes={template:"ebook_notes",exportTemplate:"a5.view.NotebookExport",defaultExportTemplate:"<h1>Notes</h1>{{#each pages as |page|}}<h2>Page {{page.number}}</h2><p>{{{page.note}}}</p>{{/each}}",init:function(model){this.book=model,this.vent=new Obj,this.notes=[],this.$el=$("<div>",{class:"ebook-notes"}),_.bindAll(this,"_onClickSave","_onClickPrev","_onClickNext","_onBeforeFlip","_onEndFlip","_onWindowResize"),this.$el.on("click",".save",this._onClickSave),this.$el.on("click",".prev",this._onClickPrev),this.$el.on("click",".next",this._onClickNext),$(window).resize(_.throttle(this._onWindowResize,500)),this.vent.bind("page-number:click",this._onClickPageNumber,this),this.vent.bind("notebook-page:change",this._onNotebookPageChange,this),this.vent.bind("note:change",this._onNoteChange,this),this.vent.bind("note:reset",this._onNoteReset,this)},render:function(){var html=a5.mainBuilder.layout.getTemplate(_(this).result("template")),$root=$("<div></div>");return $root.html(html),html=$root.find(".ebook-notes").html(),this.$el.html(html),this.exportFormatSelect=new a5.view.ExportFormatSelect({$button:this.$el.find(".export")}),this.exportFormatSelect.bind("submit",this._onExport,this),this.$bookblock=this.$el.find(".bb-bookblock"),this.$notes=this.$bookblock.children(".bb-item"),this.trigger("render"),this.$el},refresh:function(){this.render()},append:function(note){this.notes.push(note)},updateNotes:function(){var current=this.book.getPageByPageIndex(this.page),pagesWithSlots=[{page:this.book.getPageByPageIndex(this.page-2),slot:0},{page:this.book.getPageByPageIndex(this.page-1),slot:0},{page:current,slot:1},{page:this.book.getPageByPageIndex(this.page+1),slot:current.cover?2:1},{page:this.book.getPageByPageIndex(this.page+2),slot:2},{page:this.book.getPageByPageIndex(this.page+3),slot:current.cover?3:2}];_.each(pagesWithSlots,function(pageWithSlot){if(pageWithSlot.page){var note=new a5.views.interaction.PPEbookNote({vent:this.vent,page:pageWithSlot.page,book:this.book});this.append(note),this.$notes.eq(pageWithSlot.slot).append(note.$el),note.render()}},this),this.flag(),this.$bookblock.bookblock({shadowSides:0,shadowFlip:.7,startPage:2,onBeforeFlip:this._onBeforeFlip,onEndFlip:this._onEndFlip})},flag:function(){this.$el.toggleClass("no-prev",this.$notes.eq(0).is(":empty")).toggleClass("no-next",this.$notes.eq(2).is(":empty")).toggleClass("single-page",1==this.$notes.eq(1).children().length)},reportChange:function(changes){this.hasChanges=!!changes,this.$el.toggleClass("hasChanges",this.hasChanges),this.hasChanges&&this.save()},checkChanges:function(){this.hasChanges?this.save():this.reset()},save:function(){this._eachNote("save"),a5.mainBuilder.curInteraction.store(),this.reportChange(!1)},reset:function(){this._eachNote("reset")},setup:function(){this._eachNote("editable")},teardown:function(){this._eachNote("cleanup"),this.$notes.empty(),this.$bookblock.is(".bb-vertical")&&this.$bookblock.bookblock("destroy"),this.exportFormatSelect.close(),this.notes=[],this.reportChange(!1)},exportTo:function(formats){var pages=_.filter(this.book.pages,function(page){return page.hasNotes()}),html=a5.service.templates.render(this.exportTemplate,{pages:pages,title:this.book.title},this.defaultExportTemplate);a5.service.toolbelt.exportTo({formats:formats,input:html,output:"notes"})},goPrev:function(){this.$bookblock.bookblock("prev")},goNext:function(){this.$bookblock.bookblock("next")},goTo:function(pageIndex){this.page=this._getCurrent(pageIndex)},_onExport:function(formats){this.exportTo(formats)},_onNotebookPageChange:function(){this.checkChanges(),this.teardown(),this.updateNotes(),this.setup()},_onBeforeFlip:function(current,dir){current=this.book.getPageByPageIndex(this.page);var direction="next"==dir?1:-1,page=this.page+direction*(current.cover?1:2);if((page=Math.max(0,Math.min(this.book.pageCount-1,page)))===this.page)return!0;this.goTo(page)},_onEndFlip:function(old,pageIndex,isLimit){this.vent.trigger("notebook-page:change")},_onClickSave:function(e){e.preventDefault(),this.save()},_onClickPrev:function(e){e.preventDefault(),this.goPrev()},_onClickNext:function(e){e.preventDefault(),this.goNext()},_onClickPageNumber:function(pageNumber){this.book.openPageNumber(pageNumber),this.trigger("page-number:click")},_onNoteChange:function(){this.reportChange(!0)},_onNoteReset:function(){this.reportChange(!1)},_onWindowResize:function(){this._fixCkeToolbox()},_eachNote:function(handler,notes){_.each(notes||this.notes,function(note){return"string"==typeof handler?note[handler].apply(note):handler(note)})},_getCurrent:function(pageIndex){var pagesPerScreen=this.book.pagesPerScreen,offset=this.book.cover?pagesPerScreen-1:0,pageFrom=Math.floor((pageIndex+offset)/pagesPerScreen)*pagesPerScreen-offset;return pageFrom=Math.min(Math.max(pageFrom,0),this.book.pageCount-1)},_fixCkeToolbox:function(){this.$bookblock.length>0&&$(".cke_chrome").css({top:this.$bookblock.offset().top-$(".cke_chrome").height()+20})}},Obj.extend("a5.views.interaction.PPEbookNotes"),a5.views.interaction.PPEbookNote={init:function(parameters){this.book=parameters.book,this.page=parameters.page,this.vent=parameters.vent,this.$el=$("<div>",{class:"note gui-landmark"}),this.$el.toggleClass("cover",this.page.cover),this.noteText=new a5.views.interaction.PPEbookNoteText({text:this.page.note,vent:this.vent,parent:this}),this.pageNumber=new a5.views.interaction.PPEbookNotePageNumber({number:this.page.number,vent:this.vent})},render:function(){return this.$el.empty(),this.$el.append(this.noteText.$el),this.$el.append(this.pageNumber.$el),this.noteText.render(),this.pageNumber.render(),this.$el},editable:function(){this.$el.is(":visible")&&this.noteText.editable()},cleanup:function(){this.noteText.cleanup()},reset:function(){this.noteText.reset()},save:function(){var note=this.noteText.save();_.isString(note)&&(this.page.note=note)}},Obj.extend("a5.views.interaction.PPEbookNote"),a5.views.interaction.PPEbookNoteText={init:function(parameters){this.text=parameters.text,this.parent=parameters.parent,this.vent=parameters.vent,this.$el=$("<div>",{class:"note-text gui-landmark"}),_.bindAll(this,"compare","destroy","_onClick"),this.$el.on("click",this._onClick)},render:function(){return this.$el.html(this.text),this.$el},editable:function(){this.$el.attr("contenteditable",!0),this.editor=CKEDITOR.inline(this.$el[0],{toolbarCanCollapse:!0,dialog_backgroundCoverColor:"black",language:"en",extraPlugins:"sharedspace",sharedSpaces:{top:this.parent.$el[0]},toolbarGroups:[{name:"clipboard",groups:["clipboard","undo"]},{name:"editing",groups:["find","selection"]},{name:"links"},{name:"forms"},{name:"tools"},{name:"document",groups:["mode","document","doctools"]},{name:"others"},{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","blocks","align"]},{name:"styles"},{name:"colors"}],removeButtons:"Underline,Subscript,Superscript"}),this.editor.on("key",this._onEditorKey,this),this.editor.on("change",this._onEditorChange,this),this.editor.on("focus",this._onEditorFocus,this,null,100),this.editor.on("blur",this._onEditorBlur,this,null,100)},cleanup:function(){_.defer(this.destroy)},destroy:function(){this.editor&&(this.editor.destroy(),this.editor=null)},reset:function(){this.cleanup(),this.model&&this.$el.html(this.model.note),this.vent.trigger("note:reset")},compare:function(){this.text!==this.editor.getData()&&this.vent.trigger("note:change")},save:function(){return this.editor&&this.editor.getData()},_onEditorKey:function(e){_.defer(this.compare),e.stop(),e.data.domEvent.stopPropagation()},_onEditorChange:function(e){_.defer(this.compare)},_onEditorFocus:function(e){this.parent.$el.children(".cke").css("display","block")},_onEditorBlur:function(e){this.parent.$el.children(".cke").css("display","")},_onClick:function(e){var href=$(e.target).attr("href");href&&(e.preventDefault(),a5.mainBuilder.engine.invoke("open-link",href))}},Obj.extend("a5.views.interaction.PPEbookNoteText"),a5.views.interaction.PPEbookNotePageNumber={init:function(parameters){this.vent=parameters.vent,this.number=parameters.number,this.$el=$("<div>",{class:"page-number gui-landmark"}),_.bindAll(this,"_onClick"),this.$el.on("click",this._onClick)},render:function(){return this.number>0&&this.$el.html(this.number),this.$el},_onClick:function(e){e.preventDefault(),this.vent.trigger("page-number:click",this.number)}},Obj.extend("a5.views.interaction.PPEbookNotePageNumber"),a5.views.interaction.PPEbookNotes.version=5,a5.views.interaction.PPEbookPages={template:"ebook_pages",init:function(model,parent,cover){this._super(model,parent,$('<div class="pages-wrapper"></div>')),this.cover=cover,this.pages=[],this.solutionPages=[],this.model.bind("page_change",this.renderPage,this),this.model.bind("restore",this.renderPage,this),this.model.bind("per_screen_change",this.onPerScreenChange,this)},append:function(page){page.bind("loaded",this.pageLoaded,this),page.bind("page_click",this.onPageClick,this),this.pages.push(page)},appendSolutionPage:function(page){this.solutionPages.push(page)},allPagesLoaded:function(){return!0},pageLoaded:function(){this.allPagesLoaded()&&this.$(".pages-spinner").hide()},swiped:function(e){if(this.scroller.isZoomedIn()&&!this.scroller.isInitialZoom()||this.model.openSidebar)return!1;e.gesture.direction==Hammer.DIRECTION_RIGHT?this.model.previousPage():e.gesture.direction==Hammer.DIRECTION_LEFT&&this.model.nextPage()},prerender:function(page){var pages=this.pages.slice(page,page+this.model.pagesPerScreen);_(pages).each(function(page){page.render(),page.model.solutionPage&&this._getSolutionPage(page).render()},this)},setCurrent:function(){var offset=this.cover?this.model.pagesPerScreen-1:0,pageFrom=Math.floor((this.model.page+offset)/this.model.pagesPerScreen)*this.model.pagesPerScreen-offset,pageTo=pageFrom+this.model.pagesPerScreen;pageFrom=Math.max(pageFrom,0),pageTo=Math.min(pageTo,this.model.pageCount),this.current=this.pages.slice(pageFrom,pageTo),this.current.from=pageFrom,this.current.to=pageTo,this.model.current=this.current},onPerScreenChange:function(){this.scroller&&(this.scroller.zoom=null,this.scroller.left=0,this.scroller.top=0,this.model.openSidebar||(this.scroller.panOffset=0),this.renderPage())},renderPage:function(options){if(this.setCurrent(),this.parent.options.solutionViewLock&&this.parent.isSolutionView())return void this.renderSolutionPage();this.parent.toggleSolutionView(!1),this.$(".page").remove(),_(this.current).each(function(page){this.$(".pages").append(page.node),page.render()},this),this.prerender(this.current.from+this.model.pagesPerScreen),this.prerender(this.current.from-this.model.pagesPerScreen),this.model.annotations&&a5a.activate(_.map(this.current,function(page,index){return _.extend(page,{index:this.current.from+index})},this)),this.$(".pages-spinner").toggle(!this.allPagesLoaded()),this.renderImages(),this.updateScroller({afterPageChange:!0}),this.trigger("opened",this.current,options||{})},renderSolutionPage:function(options){this._copySpotlight(),this.$(".page").remove();var solutionPages=[];_.each(this.current,function(page){var _page=page;_page.model.solutionPage&&(_page=this._getSolutionPage(_page),solutionPages.push(_page)),this.$(".pages").append(_page.render())},this),this.model.annotations&&(a5a.activate(_.map(solutionPages,function(solutionPage,index){return _.extend(solutionPage,{index:solutionPage.model.index+this.model.pageCount})},this)),this._pasteSpotlight()),this.renderSolutionImages(),this.updateScroller({afterPageChange:!0}),this.trigger("opened-in-solution-view",this.current,options||{})},updateScroller:function(options){if(this.scroller){var initialScale,pagesWidth=_.reduce(this.current,function(memo,page){return memo+page.width},0),pagesHeight=_.max(_.map(this.current,function(page){return page.height}));1===this.model.pagesPerScreen&&a5.dp.config.bookZoomSinglePage&&(initialScale=parseInt(a5.dp.config.bookZoomSinglePage,10)/100,this.scroller.left=0,this.scroller.top=0),this.scroller.updateSize(pagesWidth,pagesHeight,initialScale,options)}},renderImages:function(){this.node.find("> img").remove();var length=this.current.length;_.each(this.current,function(page,index){page.reposition(this.scroller,index,length,this.node)},this),this.$(".pages").css("z-index",1)},renderSolutionImages:function(){this.node.find("> img").remove();var length=this.current.length;_.each(this.current,function(page,index){var _page=page;_page.model.solutionPage&&(_page=this._getSolutionPage(_page)),_page.reposition(this.scroller,index,length,this.node)},this),this.$(".pages").css("z-index",1)},updateImages:function(){var length=this.current.length;_.each(this.current,function(page,index){if(page.reposition(this.scroller,index,length),page.model.solutionPage){this._getSolutionPage(page).reposition(this.scroller,index,length,this.node)}},this)},updateState:function(){this.parent.$(".hand").removeClass("disabled active"),this.parent.$(".hand").toggleClass("disabled",this.scroller.isLastZoomOut()&&0===this.scroller.panOffset),this.parent.$(".hand:not(.disabled)").toggleClass("active",(!this.scroller.isLastZoomOut()||this.scroller.panOffset>0)&&!this.scroller.marqueeZoomEnabled),this.parent.$(".marquee-zoom").toggleClass("disabled",this.scroller.isLastZoomIn()),this.parent.$(".marquee-zoom:not(.disabled)").toggleClass("active",!!this.scroller.marqueeZoomEnabled),this.parent.$(".attach-file:not(.disabled)").toggleClass("active",!!this.scroller.attachFileEnabled),this.node.toggleClass("pan-mode",(!this.scroller.isLastZoomOut()||this.scroller.panOffset>0)&&!this.scroller.marqueeZoomEnabled),this.node.toggleClass("marquee-mode",!!this.scroller.marqueeZoomEnabled),this.node.toggleClass("attach-file-mode",!!this.scroller.attachFileEnabled)},updateOverlay:function(){this.overlay.updatePosition(this.$(".pages"),this.scroller)},onRepositioned:function(){this.updateImages(),this.updateOverlay()},onSizeUpdated:function(){this.updateOverlay()},onZoomChanged:function(){this.updateState()},onMarqueeToggled:function(){this.updateState()},onHandToggled:function(){this.updateState()},onAttachFileToggled:function(){this.updateState()},render:function(){return this._super(),this.node.appendTo(this.parent.node),this.renderPage(),this.scroller=new a5.views.interaction.PPEbookScroller(this.node,this.$(".pages"),{step:a5.dp.config.bookZoomStep/100,marqueeStep:a5.dp.config.bookZoomMarqueeClick/100,wheelStep:a5.dp.config.bookZoomWheelStep/100,pinchStep:a5.dp.config.bookZoomPinchStep/100,keyboardPanStep:a5.dp.config.bookKeyboardPanStep,wheelPan:a5.dp.config.mousewheelActsAsPan}),this.scroller.bind("repositioned",this.onRepositioned,this),this.scroller.bind("size_updated",this.onSizeUpdated,this),this.scroller.bind("zoom_changed",this.onZoomChanged,this),this.scroller.bind("marquee_toggled",this.onMarqueeToggled,this),this.scroller.bind("hand_toggled",this.onHandToggled,this),this.scroller.bind("attach_file_toggled",this.onAttachFileToggled,this),this.scroller.render(),this.overlay=new a5.views.interaction.PPEbookOverlay(this.model.overlay,this,this.node),$.support.touch&&this.bindNode("swipe",this.swiped),this.node},sendBack:function(){this.node.addClass("in-background")},bringFront:function(){this.node.removeClass("in-background")},onPageClick:function(page,coords){if(this.scroller.attachFileEnabled){var hotspot={page:page.number,top:Math.round(coords.y/this.scroller.zoom),left:Math.round(coords.x/this.scroller.zoom)};a5.eventBus.trigger("book:new_file_hotspot",hotspot),this.scroller.attachFileEnabled=!1,this.updateState()}},_getSolutionPage:function(page){var index=page.model.solutionPage.index;return this.solutionPages[index]},_copySpotlight:function(){this.model.annotations&&(this.spotlights=this.$(".page").map(function(index,page){return $(page).find(".content-block-out").detach()}))},_pasteSpotlight:function(){this.model.annotations&&(this.$(".page").each(function(index,page){var $spotlight=this.spotlights[index],$annotations=$(page).find("."+this.model.annotations.options.stage);$annotations.one("redraw.stage",function(){$annotations.append($spotlight)})}.bind(this)),this.spotlights=[])}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPEbookPages"),a5.views.interaction.PPEbookPage={init:function(model,parent){this._super(model,parent,$('<div class="page"></div>')),this.loaded=!1,this.model.bind("hotspot_added",this.onHotspotAdded,this),this.model.bind("restore",this.onRestore,this),this.width=this.model.width,this.height=this.model.height,this._isSolutionView()&&this.node.addClass("solution-view")},render:function(){return this._super(),this.node.empty(),this.node.on("contextmenu",function(e){if(a5.dp.config.protectBookPages)return e.preventDefault(),!1}),this.model.parent.annotations&&$('<div class="annotations"></div>').appendTo(this.node),$('<div class="content" style="width:'+this.model.width+"px;height:"+this.model.height+'px;"></div>').appendTo(this.node),this.model.restricted?(this.node.addClass("page-restricted"),this.node):(this.$image=$("<img/>").attr("width",this.model.width).attr("height",this.model.height),this.$image.load(_.bind(function(){this.loaded=!0,this.trigger("loaded")},this)),this.$image.attr("src",this.model.url),$.when(this.model.getVisibleHotspots()).done(function(hotspots){this.node.append(_.pluck(hotspots,"node")),_.invoke(hotspots,"render")}.bind(this)),this.bindNode("click",this.onClick),this.node)},reposition:function(scroller,index,length,$parent){if(this.$image){var w=this.node.get(0).getBoundingClientRect().width,h=this.node.get(0).getBoundingClientRect().height;if(this.$image.attr("width",w),this.$image.attr("height",h),w=parseFloat(this.$image.attr("width")),h=parseFloat(this.$image.attr("height")),this.$image.css("position","absolute"),this.$image.css("left","50%"),this.$image.css("max-width","none"),$parent&&$parent.append(this.$image),scroller){var marginLeft=index?0:w*length/2;this.$image.css("margin-left",scroller.roundedLeft()-marginLeft+"px"),this.$image.css("margin-top",scroller.roundedTop()+"px")}}},_isSolutionView:function(){return this.model instanceof a5.models.interaction.PPEbookSolutionPage},onClick:function(ev){var pageOffset=this.node.offset(),coords={x:ev.pageX-pageOffset.left,y:ev.pageY-pageOffset.top};this.trigger("page_click",this.model,coords),a5.mainBuilder.trigger("page_click",this)},onHotspotAdded:function(hotspot){this.node.append(hotspot.node),hotspot.render()},onRestore:function(data){data.hotspots&&_.each(data.hotspots,function(hotspot){this.parent.addFileHotspot(this.model.number,hotspot)},this)}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPEbookPage"),a5.views.interaction.PPEbookEmptyPage={init:function(model,parent){this._super(model,parent,$('<div class="page empty-page"></div>')),this.width=this.model.width,this.height=this.model.height},render:function(){return this._super(),this.node.empty(),$('<div class="content" style="display:inline-block;width:'+this.model.width+"px;height:"+this.model.height+'px;"></div>').appendTo(this.node),this.node}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPEbookEmptyPage"),a5.views.interaction.PPEbookHotspot={width:0,height:0,top:0,left:0,visited:!1,id:null,init:function(model,parent,$node){this._super(model,parent,$('<div class="hotspot"></div>')),$node&&(this.id=$node.attr("id")),_.bindAll(this,"onClickOpen")},render:function(){return this.node.off(),this.node.css({width:this.width+"px",height:this.height+"px",top:this.top+"px",left:this.left+"px"}),this.node.addClass([this.icon,this.type,this.shape].join(" ")),this.tooltip&&this.renderTooltip(),this.visited&&this.node.addClass("visited"),this.node.on("click",this.onClickOpen),a5.hooks.ppebookHotspotRendered.call(this),this.node},open:function(){this.visited=!0,"a5.views.interaction.PPEbookHotspotAudioToolbar"!=this._class_name&&a5.eventBus.trigger("audio-toolbar:stop"),this.model.bind("page_change",this.onPageChange,this,{once:!0})},close:function(){},onPageChange:function(){this.close()},onClickOpen:function(e){e.stopPropagation(),this.model.closeAllHotspots(),this.open()},draggableRemoveMarginsOnCreate:function(ev){var $draggable=$(ev.target),marginLeft=parseInt($draggable.css("margin-left"),10);if(parseInt($draggable.css("margin-top"),10)||marginLeft){var offset=$draggable.offset();$draggable.css({"margin-left":0,"margin-top":0}).offset({top:offset.top,left:offset.left})}},renderTooltip:function(){this.node.find(".tooltip").remove(),this.node.append($('<div class="tooltip">').text(this.tooltip));var originalTransform;this.node.delayedTooltip({delay:a5.dp.config.bookTooltipDelay,duration:a5.dp.config.bookTooltipDuration,start:function($tooltip){originalTransform=$tooltip.css("transform"),$tooltip.css("transform","");var transform=$tooltip.css("transform");transform="none"===transform?"":" "+transform,$tooltip.css("transform","scale("+1/this.parent.pages.scroller.zoom+")"+transform)}.bind(this),end:function($tooltip){$tooltip.css("transform",originalTransform)},container:function(){return this.node.closest(".pages-wrapper")}.bind(this)})}},a5.views.interaction.BaseView.extend("a5.views.interaction.PPEbookHotspot"),a5.views.interaction.PPEbookHotspotContent={type:"content",init:function(model,parent,$node){this._super(model,parent,$node),this.interaction=model.parent,this.content=a5.utils.buildContents($node,this.interaction).html(),this.contentWidth=$node.attr("content-width"),this.contentHeight=$node.attr("content-height"),this.contentLeft=$node.attr("content-left"),this.contentTop=$node.attr("content-top"),_.bindAll(this,"onClose")},render:function(){return this._super(),this.$dialog=$(a5.mainBuilder.layout.getTemplate("ebook_hotspot_tip")),this.$dialog.addClass([this.icon,this.shape,"hotspot-dialog-content"].join(" ")),this.$dialog.find(".modal-body").html(this.content),a5.dp.config.draggableHotspotWindow&&this.$dialog.draggable(_.extend({cancel:".close",handle:".modal-header, .modal-footer",containment:"document",create:_.partial(_.defer,this.draggableRemoveMarginsOnCreate)},a5.dp.config.draggableHotspotWindow)),this.$dialog.css({left:_.isUndefined(this.contentLeft)?"":this.contentLeft+"px",top:_.isUndefined(this.contentTop)?"":this.contentTop+"px",marginTop:_.isUndefined(this.contentTop)?"":0,marginLeft:_.isUndefined(this.contentLeft)?"":0,height:_.isUndefined(this.contentHeight)?"":this.contentHeight+"px",width:_.isUndefined(this.contentWidth)?"":this.contentWidth+"px"}),this.node},open:function(){this.opened||(this._super(),this.$modal=this.$dialog.modal({backdrop:a5.dp.config.bookHotspotPopupModal}),this.$modal.on("hidden",this.onClose),this.opened=!0)},onClickOpen:function(e){e.stopPropagation(),this.open()},onClose:function(e){e.preventDefault(),this.$modal&&(this.$modal.remove(),this.$modal=null),this.opened=!1}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotContent"),a5.views.interaction.PPEbookHotspotContentSolution={type:"content-solution",template:"a5.view.dialog.HotspotContentSolution",init:function(model,parent,$node){this._super(model,parent,$node),this.interaction=model.parent,this.content=a5.utils.buildContents($node,this.interaction).html(),this.items=[],this.$el=$("<div>",{title:$node.attr("title")}),_.bindAll(this,"onClose","onClickNext","onClickPrev","onClickToggleAll"),this.$el.on("click",".btn-toggle-all",this.onClickToggleAll),this.$el.on("click",".btn-next",this.onClickNext),this.$el.on("click",".btn-prev",this.onClickPrev),this.$el.addClass([this.icon,this.shape].join(" ")),this.contentWidth=$node.attr("content-width"),this.contentHeight=$node.attr("content-height"),this.contentLeft=$node.attr("content-left"),this.contentTop=$node.attr("content-top")},render:function(){this._super();var html=a5.service.templates.render(this.template,this._serializeData()),$html=$(html);return this.$el.html($html.html()),this.items=this.$el.find(".solution-item").toArray(),this.curItemIndex=0,this.$next=this.$el.find(".btn-next"),this.$prev=this.$el.find(".btn-prev"),this.$all=this.$el.find(".btn-toggle-all"),this.hideAllLabel=this.$all.attr("data-label-hide"),this.showAllLabel=this.$all.attr("data-label-show"),this._hideAll(),this._updateButtons(),this.node},open:function(){this.opened||(this._super(),this.$dialog=this.$el.dialog({dialogClass:"hotspot-dialog-content-solution",height:this.contentHeight,width:this.contentWidth,position:{
my:"left top",at:"left+"+this.contentLeft+" top+"+this.contentTop},resizable:!1}),this.$dialog.on("dialogclose",this.onClose),this.opened=!0)},onClickOpen:function(e){e.stopPropagation(),this.open()},onClose:function(e){e.preventDefault(),this.$dialog&&(this.$dialog.dialog("destroy"),this.$dialog=null),this.opened=!1},onClickNext:function(e){e.preventDefault(),this.$next.is(".disabled")||(this._show(),this._goNext(),this._updateButtons())},onClickPrev:function(e){e.preventDefault(),this.$prev.is(".disabled")||(this._goPrev(),this._hide(),this._updateButtons())},onClickToggleAll:function(e){e.preventDefault(),this.$all.is(".disabled")||(this._isLast()&&!$(this.items[this.curItemIndex]).hasClass("hidden")?(this._hideAll(),this._goFirst()):(this._showAll(),this._goLast()),this._updateButtons())},_serializeData:function(){return{content:this.content}},_showAll:function(){this.$el.find(".solution-item").removeClass("hidden")},_show:function(){var $current=$(this.items[this.curItemIndex]);$current.removeClass("hidden"),a5.utils.scrollIntoElementIfNeeded($current,{behavior:"smooth",block:"nearest"})},_hideAll:function(){this.$el.find(".solution-item").addClass("hidden")},_hide:function(){var $current=$(this.items[this.curItemIndex]),$prev=$(this.items[_.max([this.curItemIndex-1,0])]);$current.addClass("hidden"),a5.utils.scrollIntoElementIfNeeded($prev,{behavior:"smooth",block:"end"})},_goNext:function(){$(this.items[this.curItemIndex]).hasClass("hidden")||(this.curItemIndex=_.min([this.curItemIndex+1,this.items.length-1]))},_goPrev:function(){$(this.items[this.curItemIndex]).hasClass("hidden")&&(this.curItemIndex=_.max([this.curItemIndex-1,0]))},_goFirst:function(){this.curItemIndex=0},_goLast:function(){this.curItemIndex=this.items.length-1},_isFirst:function(){return 0===this.curItemIndex},_isLast:function(){return this.curItemIndex===this.items.length-1},_updateButtons:function(){this.$prev.toggleClass("disabled",this._isFirst()&&$(this.items[this.curItemIndex]).hasClass("hidden")),this.$next.toggleClass("disabled",this._isLast()&&!$(this.items[this.curItemIndex]).hasClass("hidden")),this._isLast()&&!$(this.items[this.curItemIndex]).hasClass("hidden")?this.$all.text(this.hideAllLabel):this.$all.text(this.showAllLabel)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotContentSolution"),a5.views.interaction.PPEbookHotspotUrl={type:"url",init:function(model,parent,$node){this._super(model,parent,$node),this.url=$node.attr("url")},open:function(){this._super(),a5.eventBus.trigger("book:open_url_hotspot",this.url),a5.mainBuilder.engine.invoke("open-link",this.url)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotUrl"),a5.views.interaction.PPEbookHotspotFile={type:"file",longPressTime:500,template:"a5.view.hotspot.File",init:function(model,parent,options){this._super(model,parent),this.id=options.id||a5.utils.createUID(),this.file=options.file,this.width=options.width,this.height=options.height,this.top=options.top,this.left=options.left,this.page=null;var html=a5.service.templates.render(this.template);this.node.html($(html).html()),_.bindAll(this,"onClickRemove","onContextMenu","onLongPress","onTap","onBlur","onDragStart","onDragStop","onDrag"),$(document).on("click",this.onBlur),this.hammerManager=new Hammer.Manager(this.node[0],{recognizers:[[Hammer.Press,{time:this.longPressTime}],[Hammer.Tap]]})},open:function(){this._super(),a5.eventBus.trigger("book:open_file_hotspot",this.file)},render:function(){return this._super(),this.renderChildrenTooltip(),this.hammerManager.off("press tap"),this.hammerManager.on("press",this.onLongPress),this.node.off("click",this.onClickOpen),this.hammerManager.on("tap",this.onTap),this.node.on("click",function(e){e.stopPropagation()}),this.node.on("click",".trash",this.onClickRemove),this.node.on("contextmenu",this.onContextMenu),this.makeDraggable(),this.node},bounds:function(){var $page=this.node.closest(".page");return[0,0,$page.width()-this.node.width(),$page.height()-this.node.height()]},remove:function(){this.node.remove(),this.page.removeFileHotspot(this),a5.eventBus.trigger("book:remove_file_hotspot",{id:this.id,file:this.file})},serialize:function(){return{id:this.id,file:this.file,width:this.width,height:this.height,top:this.top,left:this.left}},toggleToolbar:function(active){this.node.toggleClass("with-toolbar",active)},makeDraggable:function(){this.node.draggable("instance")&&this.node.draggable("destroy"),this.node.draggable({handle:".handle",start:this.onDragStart,drag:this.onDrag,stop:this.onDragStop}),this.node.css("position","")},onClickRemove:function(ev){ev.stopPropagation(),this.remove()},onContextMenu:function(e){this.toggleToolbar(!0)},onBlur:function(e){$.contains(this.node[0],e.srcElement)||this.toggleToolbar(!1)},onTap:function(e){$(e.target).closest(".toolbar").length||(this.model.closeAllHotspots(),this.open())},onLongPress:function(e){$(e.target).closest(".toolbar").length>0||this.toggleToolbar()},onDragStart:function(e,ui){var hammerPan=this.parent.pages.scroller.node.data("hammer").get("pan");this.panEnabled=hammerPan.options.enable,hammerPan.set({enable:!1}),e.stopPropagation(),this.cursorPosition={x:e.clientX,y:e.clientY}},onDrag:function(e,ui){e.stopPropagation();var zoom=this.parent.pages.scroller.zoom,deltaX=e.clientX-this.cursorPosition.x,deltaY=e.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+deltaX)/zoom),newTop=Math.round((ui.originalPosition.top+deltaY)/zoom),bounds=this.bounds();ui.position.left=this.left=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=this.top=Math.min(Math.max(newTop,bounds[1]),bounds[3])},onDragStop:function(e,ui){this.parent.pages.scroller.node.data("hammer").get("pan").set({enable:this.panEnabled}),$(e.originalEvent.target).one("click",function(e){e.stopImmediatePropagation()})},renderChildrenTooltip:function(){var originalTransform;this.node.children().find(".tooltip").each(function(_,el){$(el).parent().delayedTooltip({delay:a5.dp.config.bookTooltipDelay,duration:a5.dp.config.bookTooltipDuration,start:function($tooltip){originalTransform=$tooltip.css("transform"),$tooltip.css("transform","");var transform=$tooltip.css("transform");transform="none"===transform?"":" "+transform,$tooltip.css("transform","scale("+1/this.parent.pages.scroller.zoom+")"+transform)}.bind(this),end:function($tooltip){$tooltip.css("transform",originalTransform)},container:function(){return this.node.closest(".pages-wrapper")}.bind(this)})}.bind(this))}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotFile"),a5.views.interaction.PPEbookHotspotPlatform={type:"platform",init:function(model,parent,$node){this._super(model,parent,$node),this.platformId=$node.attr("platformid")},render:function(){return this._super(),this.$iframe=$('<iframe frameborder="0" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true">').attr("src",this._buildUrl()).addClass("hotspot"),this.node},open:function(){this._super(),this.$iframe.iframeModal()},_buildUrl:function(){return(A5&&A5.PLATFORM_URL_BUILDER||this._defaultUrl).call(null,this.platformId)},_defaultUrl:function(platformId){var course,match=/courses\/(\d+)/.exec(window.location.href);return match&&(course=match[1]),"/api/courses/"+course+"/interactives/"+platformId+".html"}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotPlatform"),a5.views.interaction.PPEbookHotspotEmbeddedTab={type:"embedded",init:function(model,parent,$node){this._super(model,parent,$node),this.ref=$node.attr("ref"),this.options={target:"tab"}},open:function(){this._super(),a5.eventBus.trigger("book:open_embedded",this.ref,this.options)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotEmbeddedTab");a5.views.interaction.PPEbookHotspotEmbeddedIframe={type:"embedded",init:function(model,parent,$node){this._super(model,parent,$node),this.options={target:"iframe",width:$node.attr("content-width"),height:$node.attr("content-height"),left:$node.attr("content-left"),top:$node.attr("content-top")}}},a5.views.interaction.PPEbookHotspotEmbeddedTab.extend("a5.views.interaction.PPEbookHotspotEmbeddedIframe"),a5.views.interaction.PPEbookHotspotExternal={type:"external",init:function(model,parent,$node){this._super(model,parent,$node),this.ref=$node.attr("ref"),_.bindAll(this,"onClickNextExternalHotspot","onClickPreviousExternalHotspot")},render:function(){this._super();var src=this._buildUrl();return src&&(this.$iframe=$('<iframe frameborder="0" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true">').addClass("hotspot"),this.$buttons=$("body").find(".hotspot-external-navigation"),0===this.$buttons.length&&(this.$buttons=$(a5.mainBuilder.layout.getTemplate("ebook_hotspot_external_navigation")),this.$buttons.addClass("invisible"),this.$buttons.appendTo($("body"))),this.$buttons.off(),this.$buttons.on("click",".go-prev-external-hotspot",this.onClickPreviousExternalHotspot),this.$buttons.on("click",".go-next-external-hotspot",this.onClickNextExternalHotspot),this.$iframe.attr("src",src)),this.node},open:function(){this._super(),this.$iframe?this.$iframe.iframeModal({open:function(){this.$buttons.removeClass("invisible"),this.$buttons.find(".go-prev-external-hotspot").toggleClass("is-first-hotspot",!this.prev),this.$buttons.find(".go-next-external-hotspot").toggleClass("is-last-hotspot",!this.next)}.bindTo(this),close:function(){this.$buttons.addClass("invisible"),this.$buttons.find(".go-prev-external-hotspot").removeClass("is-first-hotspot"),this.$buttons.find(".go-next-external-hotspot").removeClass("is-last-hotspot")}.bindTo(this)}):a5.eventBus.trigger("book:open_external_hotspot",this.ref)},onClickPreviousExternalHotspot:function(){this.prev&&this.prev.open()},onClickNextExternalHotspot:function(){this.next&&this.next.open()},_buildUrl:function(){var urlFn=A5&&A5.EXTERNAL_URL_BUILDER;if(_.isFunction(urlFn))return urlFn.call(null,this.ref)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotExternal"),a5.views.interaction.PPEbookHotspotAuthor={type:"author"},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotAuthor"),a5.views.interaction.PPEbookHotspotAudioSmall={type:"audio",init:function(model,parent,$node){this._super(model,parent,$node),this.ref=$node.attr("ref"),_.bindAll(this,"attachAudio"),this.attachAudioOnce=_.once(this.attachAudio)},render:function(){return this._super(),this.attachAudioOnce(),this.node},open:function(){this._super(),this.playing?this.player.pause():(0===this.player.position()&&a5.eventBus.trigger("book:open_audio_hotspot",this.ref,{mode:"small"}),this.node.addClass("playing"),a5.service.media.pauseAllExcept(this.player),this.player.play(),this.playing=!0),this.opened=!0},close:function(){this.opened&&(this.player.stop(),this.opened=!1)},onClickOpen:function(e){e.stopPropagation(),this.opened||this.model.closeAllHotspots(),this.open()},attachAudio:function(){this.node.addClass("inactive"),a5.service.media.audio.bind("ready",function(){this.player=a5.service.media.audio.create(this.ref,{preload:!a5.dp.config.audioPreloadDisabled}),this.node.attr("data-playable-media",this.player.uid),this.player.bind("stopped",function(){this.node.removeClass("playing"),this.playing=!1},this),this.player.bind("paused",function(){this.node.removeClass("playing"),this.playing=!1},this),this.node.removeClass("inactive")},this)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotAudioSmall"),a5.views.interaction.PPEbookHotspotAudioFull={type:"audio",init:function(model,parent,$node){this._super(model,parent,$node),this.ref=$node.attr("ref"),this.subtitles=$node.children("subtitles"),this.transcript=$node.children("transcript"),this.contentLeft=$node.attr("content-left"),this.contentTop=$node.attr("content-top"),this.interaction=model.parent,_.bindAll(this,"onClose","attachAudio"),this.attachAudioOnce=_.once(this.attachAudio)},render:function(){return this._super(),this.$dialog=$(a5.mainBuilder.layout.getTemplate("ebook_hotspot_tip")),this.$dialog.addClass([this.icon,this.shape,"hotspot-dialog-audio"].join(" ")),a5.dp.config.draggableHotspotWindow&&this.$dialog.draggable(_.extend({cancel:".media-footer, .close",containment:"document",create:_.partial(_.defer,this.draggableRemoveMarginsOnCreate),stop:function(ev){$(ev.originalEvent.target).one("click",function(e){e.stopImmediatePropagation()})}},a5.dp.config.draggableHotspotWindow)),this.$dialog.css({left:_.isUndefined(this.contentLeft)?"":this.contentLeft+"px",top:_.isUndefined(this.contentTop)?"":this.contentTop+"px",marginTop:_.isUndefined(this.contentTop)?"":0,marginLeft:_.isUndefined(this.contentLeft)?"":0}),this.$audio=this.attachAudioOnce(),this.node},open:function(){this._super(),a5.eventBus.trigger("book:open_audio_hotspot",this.ref,{mode:"full"}),this.$dialog.find(".modal-body").append(this.$audio),this.$modal=this.$dialog.modal({backdrop:a5.dp.config.bookHotspotPopupModal}),this.$modal.on("hidden",this.onClose)},close:function(){this.$modal&&(this.$modal.modal("hide"),this.$modal=null)},onClose:function(){this.$audio.detach(),this.player.stop(),this.$modal.remove(),a5.eventBus.trigger("transcript:close")},attachAudio:function(){var $html=$(window.a5.mainBuilder.layout.getTemplate("audio_widget")),$inlineTranscript=$(window.a5.mainBuilder.layout.getTemplate("media_transcript"));return $html.find(".the_audio").hide(),a5.service.media.audio.bind("ready",function(){this.player=a5.service.media.audio.create(this.ref,{preload:!a5.dp.config.audioPreloadDisabled,persistVolume:a5.dp.config.audioVolumeStore}),$html.attr("data-playable-media",this.player.uid),a5.model_builder.audioVideoUtils.addAudioPlayerEvents(this.player,$html),a5.model_builder.audioVideoUtils.linkSubtitles(this.subtitles,this.interaction,$html,this.player),a5.model_builder.audioVideoUtils.linkTranscript(this.transcript,this.interaction,$html,this.player,$inlineTranscript)},this),$inlineTranscript.length?$('<div class="transcript-wrap audio">').append($html).append($inlineTranscript):$html}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotAudioFull"),a5.views.interaction.PPEbookHotspotAudioToolbar={type:"audio",init:function(model,parent,$node){this._super(model,parent,$node),this.ref=$node.attr("ref"),this.subtitles=$node.children("subtitles"),this.transcript=$node.children("transcript"),this.interaction=model.parent,this.active=!1,this.$node=$node,_.bindAll(this,"attachAudio"),this.attachAudioOnce=_.once(this.attachAudio);var toolbarRendered=$.Deferred(),audioReady=$.Deferred();this.parent.toolbar.bind("render",function(){toolbarRendered.resolve()},this),a5.service.media.audio.bind("ready",function(){audioReady.resolve()},this),this._ready=$.when(toolbarRendered,audioReady)},ready:function(){return this._ready},render:function(){return this._super(),this.attachAudioOnce(),this.node},attachAudio:function(){this.ready().then(function(){this.$toolbar=this.parent.$("#audio-toolbar"),this.player=a5.service.media.audio.create(this.ref,{preload:!a5.dp.config.audioPreloadDisabled,persistVolume:a5.dp.config.audioVolumeStore}),this.node.attr("data-playable-media",this.player.uid),a5.model_builder.audioVideoUtils.addAudioPlayerEvents(this.player,this.$toolbar),this.player.bind("stopped paused",function(){this.node.removeClass("playing"),this.playing=!1},this),this.player.bind("stopped",function(){this.$toolbar.removeClass("active"),this.active=!1},this),this.player.bind("playing",function(){this.node.addClass("playing"),this.$toolbar.addClass("active"),this.active=!0,this.playing=!0},this),a5.eventBus.bind("audio-toolbar:stop",this.player.stop,this.player)}.bind(this))},bindToolbarEvents:function(){a5.model_builder.audioVideoUtils.removeInterfaceEvents(this.$toolbar,this.player),a5.model_builder.audioVideoUtils.addInterfaceEvents(this.$toolbar,this.player),a5.model_builder.audioVideoUtils.linkSubtitles(this.subtitles,this.interaction,this.$toolbar,this.player),a5.model_builder.audioVideoUtils.linkTranscript(this.transcript,this.interaction,this.$toolbar,this.player,$()),this.player.trigger("volume")},open:function(){this._super(),this.playing?this.player.pause():(this.active||(this.player.position(0),this.$toolbar.find(".duration").html(a5.utils.seconds_to_text(Math.floor(this.player.duration()/1e3))),a5.eventBus.trigger("book:open_audio_hotspot",this.ref,{mode:"toolbar"})),a5.service.media.pauseAllExcept(this.player),this.player.play(),this.bindToolbarEvents()),this.opened=!0},close:function(){this.opened&&(this.player.stop(),this.opened=!1)},onClickOpen:function(e){e.stopPropagation(),this.opened||this.model.closeAllHotspots(),this.open()}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotAudioToolbar"),a5.views.interaction.PPEbookHotspotVideo={type:"video",init:function(model,parent,$node){this._super(model,parent,$node),this.ref=$node.attr("ref"),this.subtitles=$node.children("subtitles"),this.transcript=$node.children("transcript"),this.contentLeft=$node.attr("content-left"),this.contentTop=$node.attr("content-top"),this.interaction=model.parent,_.bindAll(this,"onClose","onOpen","attachVideo"),this.attachVideoOnce=_.once(this.attachVideo)},render:function(){return this._super(),this.$dialog=$(a5.mainBuilder.layout.getTemplate("ebook_hotspot_tip")),this.$dialog.addClass([this.icon,this.shape,"hotspot-dialog-video"].join(" ")),a5.dp.config.draggableHotspotWindow&&this.$dialog.draggable(_.extend({cancel:".media-footer, .close",containment:"document",create:_.partial(_.defer,this.draggableRemoveMarginsOnCreate),stop:function(ev){$(ev.originalEvent.target).one("click",function(e){e.stopImmediatePropagation()})}},a5.dp.config.draggableHotspotWindow)),this.$dialog.css({left:_.isUndefined(this.contentLeft)?"":this.contentLeft+"px",top:_.isUndefined(this.contentTop)?"":this.contentTop+"px",marginTop:_.isUndefined(this.contentTop)?"":0,marginLeft:_.isUndefined(this.contentLeft)?"":0}),this.video=this.attachVideoOnce(),this.node},open:function(){this._super(),this.$dialog.find(".modal-body").append(this.video.$html),this.$modal=this.$dialog.modal({backdrop:a5.dp.config.bookHotspotPopupModal,show:!1}),this.$modal.on("shown",this.onOpen),this.$modal.on("hidden",this.onClose),this.$modal.modal("show")},close:function(){this.$modal&&(this.$modal.modal("hide"),this.$modal=null)},onClose:function(){this.video.$html.detach(),this.$modal.remove(),a5.eventBus.trigger("transcript:close")},onOpen:function(){this.video.instance.adjustSize()},onFullscreenChange:function(fullscreen){fullscreen?this.$dialog.draggable("disable"):this.$dialog.draggable("enable")},attachVideo:function(){var $html=$(window.a5.mainBuilder.layout.getTemplate("video_widget")),$inlineTranscript=$(window.a5.mainBuilder.layout.getTemplate("media_transcript")),$target=$html.find(".the_video"),video=a5.service.media.video.create(this.ref,$target);return a5.model_builder.audioVideoUtils.addVideoPlayerEvents(video,$html),a5.model_builder.audioVideoUtils.linkSubtitles(this.subtitles,this.interaction,$html,video),a5.model_builder.audioVideoUtils.linkTranscript(this.transcript,this.interaction,$html,video,$inlineTranscript),a5.dp.config.draggableHotspotWindow&&video.bind("fullscreenchange",this.onFullscreenChange,this),{$html:$inlineTranscript.length?$('<div class="transcript-wrap video">').append($html).append($inlineTranscript):$html,instance:video}}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotVideo"),a5.views.interaction.PPEbookHotspotPageLink={type:"page-link",init:function(model,parent,$node){this._super(model,parent,$node),this.page=parseInt($node.attr("page"),10)||0,this.book=$node.attr("book")||null,this.model=model},open:function(){this._super(),this.book?a5.eventBus.trigger("book:open_page_link_hotspot",this.book,this.page):this.model.openPageNumber(this.page)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotPageLink"),a5.views.interaction.PPEbookHotspotSingleStructure={type:"structure-single",init:function(model,parent,$node){this._super(model,parent,$node),this.ref=$node.attr("ref")},open:function(){this._super(),a5.eventBus.trigger("book:open_structure_hotspot",this.ref)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotSingleStructure"),a5.views.interaction.PPEbookHotspotMultipleStructure={type:"structure-multiple",init:function(model,parent,$node){this._super(model,parent,$node),this.ref=$node.attr("ref"),this.items=[],$node.find("> children > node").each(function(index,child){var $child=$(child),className=$child.find("> children").length>0?"PPEbookHotspotMultipleStructure":"PPEbookHotspotSingleStructure",hotspot=new a5.views.interaction[className](model,parent,$child);hotspot.icon=$child.attr("icon"),hotspot.shape=$child.attr("shape")||"",_.each(["top","left","width","height"],function(attr){hotspot[attr]=parseInt($child.attr(attr),10)}),this.items.push(hotspot)}.bind(this))},closeItems:function(){_(this.items).each(function(item){item.node.remove()})},open:function(){if(this.opened=!this.opened,this.node.toggleClass("active",this.opened),!this.opened)return void this.closeItems();this._super(),_(this.items).each(function(item){this.node.append(item.render())},this),a5.eventBus.trigger("book:open_structure_hotspot",this.ref)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotMultipleStructure"),a5.views.interaction.PPEbookHotspotMenu={type:"menu",template:"a5.view.dialog.HotspotMenu",init:function(model,parent,$node){this._super(model,parent,$node),this.items=[],this.itemRefs=[],$node.find("> items > item").each(function(index,item){var $item=$(item);this.itemRefs.push($item.attr("ref"))}.bind(this)),this.$el=$("<div>",{class:"hotspot-menu"}),_.bindAll(this,"onClickClose","onClickItem","onBlur"),$(document).on("click",this.onBlur),this.parent.bind("render",this.onBookRendered,this)},render:function(){return this._super(),this.$el.on("click",".btn-close",this.onClickClose),this.$el.on("click",".hotspot-menu-item",this.onClickItem),this.node},close:function(){this.$el.hide(),this.node.removeClass("in-front"),this.opened=!1},open:function(){this.opened||(this._adjustMenuPosition(),this.$el.show(),this.node.addClass("in-front"),this.opened=!0)},onBlur:function(e){$.contains(this.$el[0],e.srcElement)||this.close()},onClickClose:function(e){e.preventDefault(),e.stopPropagation(),this.close()},onClickItem:function(e){e.preventDefault(),e.stopPropagation();var $li=$(e.target).closest(".hotspot-menu-item"),id=$li.attr("data-hotspot-id");this._findItemById(id).open()},onClickOpen:function(e){e.stopPropagation(),this.opened?this.close():(this.model.closeAllHotspots(),this.open())},onBookRendered:function(){this._initItems(),this._renderItems(),this._renderBadge()},_initItems:function(){this.items=_.chain(this.itemRefs).map(function(ref){return this.model.getHotspotById(ref)},this).compact().value();var itemsCountClass="empty-menu";this.items.length>1?itemsCountClass="multiple-items-menu":1===this.items.length&&(itemsCountClass="single-item-menu"),this.node.addClass(itemsCountClass),_.each(this.items,function(item){item.node.addClass("belongs-to-menu belongs-to-"+itemsCountClass)})},_renderItems:function(){var html=a5.service.templates.render(this.template,{items:this.items}),$html=$(html);this.$el.html($html.html()),this.node.append(this.$el)},_renderBadge:function(){var $badge=$('<div class="badge"></div>');$badge.append(this.items.length),this.node.prepend($badge)},_findItemById:function(id){return _.find(this.items,function(item){return item.id===id})},_adjustMenuPosition:function(){this.$el.removeClass("overflow-bottom overflow-right overflow-left"),this.$el.css("visibility","hidden"),this.$el.show();var bbox=this.$el[0].getBoundingClientRect(),pageBox=this.$el.closest(".page")[0].getBoundingClientRect(),viewportBox=this.parent.pages.node[0].getBoundingClientRect(),overflowBottom=bbox.bottom>viewportBox.bottom,overflowRight=bbox.right>pageBox.right,overflowLeft=bbox.left<pageBox.left;this.$el.toggleClass("overflow-bottom",overflowBottom),this.$el.toggleClass("overflow-right",overflowRight),this.$el.toggleClass("overflow-left",overflowLeft),this.$el.hide(),this.$el.css("visibility","")}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotMenu"),a5.view.PPEbookResourcesPanelDialog={template:"ebook_resourcesPanel",init:function(model){this._super(),this.resourcesPanel=new a5.views.interaction.PPEbookResourcesPanel(model),this.model=model,this.$el.addClass("resources-panel-popup")},onShow:function(){this.$el.find("iframe").attr("src",this.resourcesPanel.resourcesUrl()),this._super()}},a5.view.PPEbookDialog.extend("a5.view.PPEbookResourcesPanelDialog"),a5.view.PPEbookResourcesPanelSidebar={template:"ebook_resourcesPanel",init:function(model){this._super(),model.bind("change:resourcePanelMode",_.bind(function(options){this.$el.removeClass("resources-panel-mode-"+options.oldMode),this.$el.addClass("resources-panel-mode-"+options.newMode)},this)),this.resourcesPanel=new a5.views.interaction.PPEbookResourcesPanel(model),this.model=model,this.$el.addClass("resources-panel-popup")},open:function(){var resourcesUrl=this.resourcesPanel.resourcesUrl(),iframe=this.$el.find("iframe");iframe.attr("src")!=resourcesUrl&&(iframe.replaceWith(this.resourcesPanel.template),this.$el.find("iframe").attr("src",resourcesUrl)),this.model.openSidebar="resources",this._super()},close:function(){delete this.model.openSidebar,this._super()}},a5.view.PPEbookSidebar.extend("a5.view.PPEbookResourcesPanelSidebar"),a5.views.interaction.PPEbookResourcesPanel={template:'<iframe frameborder="0" height="100%" width="100%"></iframe>',init:function(model,parent){this.$el=$("<div>",{class:"resources-panel"}),this.model=model},render:function(){return this.$el.html(this.template),this.$el},resourcesUrl:function(){return a5.service.lms.API.getEbookResourcesUrl(this.model.page,this.model.offset)}},Obj.extend("a5.views.interaction.PPEbookResourcesPanel"),a5.vendoredCssName=function(property){var element=$("<div/>")[0],properties=_.map(["","Webkit","Moz","ms","O"],function(prefix){return prefix+property});return _.find(properties,function(property){return!_.isUndefined(element.style[property])})},a5.views.interaction.PPEbookScroller={minZoom:1,maxZoom:1,left:0,top:0,zoom:null,step:.2,marqueeStep:.2,wheelStep:.2,pinchStep:.2,keyboardPanStep:20,wheelPan:!1,init:function($node,$content,params){this._super(null,null,$node),this.$content=$content,this.step=params.step||this.step,this.marqueeStep=params.marqueeStep||this.marqueeStep,this.wheelStep=params.wheelStep||this.wheelStep,this.pinchStep=params.pinchStep||this.pinchStep,this.keyboardPanStep=params.keyboardPanStep||this.keyboardPanStep,this.wheelPan=params.wheelPan||this.wheelPan,this.panOffset=0},zoomTo:function(value,orig){orig=orig||{x:0,y:0};var newZoom=this.inBounds(value,this.minZoom,this.maxZoom),prevZoom=this.zoom||newZoom,scalechange=newZoom/prevZoom,x=scalechange*(orig.x+this.left),y=scalechange*(orig.y+this.top);this.zoom=newZoom,this.left=x-orig.x,this.top=y-orig.y,this.reposition(),this.trigger("zoom_changed")},zoomIn:function(){var value=1+this.step;null!=this.nextZoomIn&&(value=this.nextZoomIn,this.nextZoomIn=null),this._round(this.zoom*(1+this.step),6)>this._round(this.maxZoom,6)?this.nextZoomOut=this.zoom/this.maxZoom:this.nextZoomOut=null,this.zoomBy(value)},zoomOut:function(){var value=1/(1+this.step);null!=this.nextZoomOut&&(value=this.nextZoomOut,this.nextZoomOut=null),this._round(this.zoom/(1+this.step),6)<this._round(this.minZoom,6)?this.nextZoomIn=this.zoom/this.minZoom:this.nextZoomIn=null,this.zoomBy(value)},zoomBy:function(value,origin){this.zoomTo(this.zoom*value,origin)},resetZoom:function(){this.left=0,this.top=0,this.zoom=null,this.zoomTo(this.initialScale)},onPinch:function(e){var touches=e.gesture.pointers,delta=e.gesture.scale>1?1:-1;if(touches.length>1){var orig=this.calculateOrigin((touches[0].pageX+touches[1].pageX)/2,(touches[0].pageY+touches[1].pageY)/2);this.zoomBy(Math.pow(1+this.pinchStep,delta),orig)}},calculateOrigin:function(xx,yy){return{x:xx-this.wrapperPosition.left-this.wrapperOuterWidth/2,y:yy-this.wrapperPosition.top-(this.wrapperOuterHeight-this.wrapperHeight)/2}},onMouseWheel:function(e,delta){if(!this.isMousePressed)if(delta=delta>0?1:-1,this.wheelPan)delta>0?this.panUp():this.panDown();else{var orig=this.calculateOrigin(e.pageX,e.pageY);this.zoomBy(Math.pow(1+this.wheelStep,delta),orig)}},onDragStart:function(e){this.initialZoom=this.zoom,this.initialTop=this.top,this.initialLeft=this.left,this.marqueeZoomEnabled&&(this.$marqueeBox.css({width:0,height:0}),this.$marqueeBox.appendTo(this.node))},onDrag:function(e){var touches=e.gesture.pointers,initialX=touches[0].pageX-e.gesture.deltaX,initialY=touches[0].pageY-e.gesture.deltaY,finalX=touches[0].pageX,finalY=touches[0].pageY,left=Math.min(initialX,finalX),top=Math.min(initialY,finalY);this.marqueeZoomEnabled?this.$marqueeBox.css({left:left-this.wrapperPosition.left,top:top-this.wrapperPosition.top,width:Math.abs(e.gesture.deltaX)+"px",height:Math.abs(e.gesture.deltaY)+"px"}):(this.left=this.initialLeft-e.gesture.deltaX*this.zoom,this.top=this.initialTop-e.gesture.deltaY*this.zoom,this.reposition())},onDragEnd:function(e){if(this.marqueeZoomEnabled){this.disableMarqueeZoom();var value=Math.min(this.wrapperWidth/Math.abs(e.gesture.deltaX),this.wrapperHeight/Math.abs(e.gesture.deltaY)),touches=e.gesture.pointers,initialX=touches[0].pageX-e.gesture.deltaX,initialY=touches[0].pageY-e.gesture.deltaY,finalX=touches[0].pageX,finalY=touches[0].pageY,centerX=(finalX-initialX)/2+initialX,centerY=(finalY-initialY)/2+initialY,orig=this.calculateOrigin(centerX,centerY);this.zoomBy(value,orig);var viewportCenterX=$(window).width()/2,viewportCenterY=$(window).height()/2,viewportOrig=this.calculateOrigin(viewportCenterX,viewportCenterY);this.left=this.left+orig.x-viewportOrig.x,this.top=this.top+orig.y-viewportOrig.y,this.reposition(),this.$marqueeBox.detach()}},onClick:function(e){if(this.marqueeZoomEnabled){this.disableMarqueeZoom();var orig=this.calculateOrigin(e.pageX,e.pageY);this.zoomBy(1+this.marqueeStep,orig)}},panUp:function(){this.top-=this.keyboardPanStep*this.zoom,this.reposition()},panDown:function(){this.top+=this.keyboardPanStep*this.zoom,this.reposition()},toggleMarqueeZoom:function(){this.marqueeZoomEnabled=!this.marqueeZoomEnabled,this.marqueeZoomEnabled&&(this.panEnabled=!1,window.a5a&&a5a.useTool("cursor")),this.attachFileEnabled=!1,this.trigger("marquee_toggled")},disableMarqueeZoom:function(){this.marqueeZoomEnabled=!1,this.trigger("marquee_toggled")},toggleHand:function(){this.panEnabled||(this.panEnabled=!0,this.marqueeZoomEnabled=!1,this.attachFileEnabled=!1,this.trigger("hand_toggled"))},disableHand:function(){this.panEnabled=!1,this.trigger("hand_toggled")},toggleAttachFile:function(){this.attachFileEnabled=!this.attachFileEnabled,this.attachFileEnabled&&window.a5a&&a5a.useTool("cursor"),this.marqueeZoomEnabled=!1,this.trigger("attach_file_toggled"),a5.eventBus.trigger("attach_file_toggled",this.attachFileEnabled)},disableAttachFile:function(){this.attachFileEnabled=!1,this.trigger("attach_file_toggled"),a5.eventBus.trigger("attach_file_toggled",!1)},addPanOffset:function(offset){this.panOffset=offset},resetPanOffset:function(){this.panOffset=0,this.reposition()},disableSwipe:function(){this.node.data("hammer").get("swipe").set({enable:!1})},enableSwipe:function(){this.node.data("hammer").get("swipe").set({enable:!0})},updateSize:function(contentWidth,contentHeight,initialScale,options){this.contentWidth=contentWidth,this.contentHeight=contentHeight,this.wrapperWidth=this.node.width(),this.wrapperOuterWidth=this.node.outerWidth(),this.wrapperHeight=this.node.height(),
this.wrapperOuterHeight=this.node.outerHeight(),this.wrapperPosition=this.node.offset();var defaultInitialView=Math.min(this.wrapperWidth/contentWidth,this.wrapperHeight/contentHeight);a5.dp.config.bookZoomMax?this.maxZoom=parseInt(a5.dp.config.bookZoomMax,10)/100:this.maxZoom=Math.max(1,this.wrapperWidth/contentWidth,this.wrapperHeight/contentHeight),a5.dp.config.bookZoomMin?this.minZoom=parseInt(a5.dp.config.bookZoomMin,10)/100:this.minZoom=defaultInitialView;var prevInitialScale=this.initialScale;this.initialScale=initialScale?this.inBounds(this.wrapperWidth/contentWidth*initialScale,this.minZoom,this.maxZoom):Math.max(defaultInitialView,this.minZoom),prevInitialScale||(prevInitialScale=this.initialScale);var scale;this.zoom&&options&&options.afterPageChange&&a5.dp.config.bookZoomPreserve&&(scale=this.zoom),this.zoom&&this.zoom>prevInitialScale&&options&&options.afterResize&&(scale=this.zoom*this.initialScale/prevInitialScale),this.zoomTo(scale||this.initialScale),this.$content.css({height:contentHeight,width:contentWidth}),this.trigger("size_updated")},render:function(){this.node.hammer({cssProps:{userSelect:"none"}});var hammertime=this.node.data("hammer");hammertime.get("pan").set({direction:Hammer.DIRECTION_ALL}),hammertime.get("pinch").set({enable:!0}),this.$content.css(a5.vendoredCssName("TransformOrigin"),"center top"),this.bindNodeD("panstart transformstart",this.onDragStart),this.bindNodeD("mousewheel",this.onMouseWheel),this.bindNodeD("pinch",this.onPinch),this.bindNodeD("panmove",this.onDrag),this.bindNodeD("click",this.onClick),this.bindNodeD("panend transformend",this.onDragEnd),this.bindNode("mousedown",function(e){this.isMousePressed=!0,(!window.a5a||a5a.current.tool&&"cursor"===a5a.current.tool.name)&&e.preventDefault()}),this.bindNode("mouseup",function(e){this.isMousePressed=!1}),this.$marqueeBox=$('<div class="marquee-box"></div>')},_round:function(number,decimals){return parseFloat(number.toFixed(decimals))},roundedLeft:function(){return this._round(-this.left,6)},roundedTop:function(){return this._round(-this.top,6)},isLastZoomIn:function(){return this._round(this.zoom,6)>=this._round(this.maxZoom,6)},isLastZoomOut:function(){return this._round(this.zoom,6)<=this._round(this.minZoom,6)},isZoomedIn:function(){return this._round(this.zoom,6)>this._round(this.initialScale,6)},isInitialZoom:function(){return this._isWithinHalfAStep(this.zoom,this.initialScale)},_isWithinHalfAStep:function(value1,value2){var minStep=Math.min(this.wheelStep,this.pinchStep),halfStepMultiplier=1+minStep/2,lower=value2/halfStepMultiplier,upper=value2*halfStepMultiplier;return lower<value1&&value1<upper},computeScrollBoundaries:function(){var zoomedWidth=this.contentWidth*this.zoom,zoomedHeight=this.contentHeight*this.zoom,offset=this.panOffset-(this.wrapperWidth-zoomedWidth)/2;offset=this.inBounds(offset,0,this.panOffset);var boundaries={};return boundaries.maxLeft=_.max([(zoomedWidth-this.wrapperWidth)/2,0]),boundaries.maxTop=_.max([zoomedHeight-this.wrapperHeight,0]),boundaries.minLeft=-(boundaries.maxLeft+offset),boundaries.minTop=0,boundaries},inBounds:function(value,min,max){return value>max?max:value<min?min:value},reposition:function(){var bounds=this.computeScrollBoundaries();this.left=this.inBounds(this.left,bounds.minLeft,bounds.maxLeft),this.top=this.inBounds(this.top,bounds.minTop,bounds.maxTop),this.renderReposition(),this.trigger("repositioned")},renderReposition:function(){var property=a5.vendoredCssName("Transform");return property?function(){this.$content.css(property,"translate("+this._round(-(this.left+this.contentWidth/2))+"px,"+this._round(-this.top)+"px) scale("+this._round(this.zoom,6)+")")}:function(){this.$content.css({marginLeft:this._round(-(this.left+this.contentWidth*this.zoom/2)/this.zoom,6)+"px",marginTop:this._round(-this.top/this.zoom,6)+"px",zoom:this._round(this.zoom,6)||""})}}()},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPEbookScroller"),a5.view.PPEbookTOCDialog={template:"ebook_toc",init:function(book){this._super(),this.toc=new a5.views.interaction.PPEbookTOC(book),this.book=book,this.$el.addClass("toc-popup"),this.toc.bind("select:entry",this._onSelectEntry,this)},renderContent:function(){var $title=this.$el.find("h3");$title.attr("data-without-title")||$title.text(this.book.title+" - "+($title.text()||"Table of contents"));var $thumbnail=this.$el.find(".thumbnail");this.book.pages[0].thumbnail&&$thumbnail.length>0&&$thumbnail.html('<img src="'+this.book.pages[0].thumbnail+'"/>'),this.$el.find(".page-count").text(this.book.pageCount);var $toc=this.toc.render();this.$el.find(".modal-body").html($toc)},append:function(entry){this.toc.append(entry)},_onSelectEntry:function(){this.close()}},a5.view.PPEbookDialog.extend("a5.view.PPEbookTOCDialog"),a5.view.PPEbookTOCSidebar={template:"ebook_toc",init:function(book){this._super(),this.toc=new a5.views.interaction.PPEbookTOC(book),this.book=book,this.$el.addClass("toc-popup"),this.toc.bind("select:entry",this._onSelectEntry,this)},renderContent:function(){var $title=this.$el.find("h3");$title.attr("data-without-title")||$title.text(this.book.title+" - "+($title.text()||"Table of contents"));var $thumbnail=this.$el.find(".thumbnail");this.book.pages[0].thumbnail&&$thumbnail.length>0&&$thumbnail.html('<img src="'+this.book.pages[0].thumbnail+'"/>'),this.$el.find(".page-count").text(this.book.pageCount);var $toc=this.toc.render();this.$el.find(".modal-body").html($toc)},append:function(entry){this.toc.append(entry)},_onSelectEntry:function(){this.close()},open:function(){this.book.openSidebar="toc",this._super()},close:function(){delete this.book.openSidebar,this._super()}},a5.view.PPEbookSidebar.extend("a5.view.PPEbookTOCSidebar"),a5.views.interaction.PPEbookTOC={init:function(book){this.book=book,this.$el=$("<ol>",{class:"toc"}),this.children=[],this.book.bind("page_change",this._onPageChange,this),this.book.bind("restore",this._onBookRestore,this)},append:function(entry){this.children.push(entry),entry.bind("select",this._onSelectEntry,this)},render:function(){return this._renderChildren(),this._highlightEntry(),this.$el},getEntriesByRange:function(leftPage,rightPage){var candidates=[];return _(this.children).each(function(entry){if(entry instanceof a5.views.interaction.PPEbookTOCEntry){var range=entry.getRange();(range.start<=leftPage&&leftPage<=range.end||range.start<=rightPage&&rightPage<=range.end)&&candidates.push(entry)}entry.isLeaf()||(candidates=entry.getEntriesByRange(leftPage,rightPage).concat(candidates))},this),candidates},_onSelectEntry:function(entry){this.book.openPageNumber(entry.startPageNumber),this.trigger("select:entry")},_onPageChange:function(){this._highlightEntry()},_onBookRestore:function(){this._highlightEntry()},_highlightEntry:function(){this.$el.find(".highlighted").removeClass("highlighted");var candidates=this.getEntriesByRange(this.book.current.from,this.book.current.to-1),selected=_(candidates).chain().sortBy(function(candidate){var range=candidate.getRange();return range.end-range.start}).first().value();selected&&selected.$el.addClass("highlighted")},_renderChildren:function($target){$target=$target||this.$el,_.isString($target)&&($target=this.$el.find($target));var fragment=document.createDocumentFragment();_.each(this.children,function(child){var $node=child.render&&child.render()||child.$el;$node&&fragment.appendChild($node[0])}),$target.append(fragment)}},Obj.extend("a5.views.interaction.PPEbookTOC"),a5.views.interaction.PPEbookTOCEntry={template:"ebook_toc_entry",init:function(book,text,startPageNumber,endPageNumber,pageLabel){this.$el=$("<li>",{class:"toc-entry"}),this.book=book,this.page=this.book.getPageByPageNumber(startPageNumber),this.page&&(this.thumbnail=this.page.thumbnail),this.text=text,this.startPageNumber=startPageNumber,this.endPageNumber=endPageNumber,this.pageLabel=pageLabel||startPageNumber,this.children=[],_.bindAll(this,"_onClick"),this.$el.on("click",this._onClick)},append:function(entry){this.children.push(entry),entry.bind("select",this._onSelectEntry,this)},render:function(){this.$el.html(a5.mainBuilder.layout.getTemplate(_(this).result("template")));var $thumbnail=this.$el.find(".thumbnail");if(this.thumbnail&&$thumbnail.length>0){var $thumbnailImage=$('<img src="'+this.thumbnail+'"/>');$thumbnail.html($thumbnailImage)}return this.$el.find(".title").text(this.text),this.$el.find(".page-number").text(this.pageLabel),this._renderChildren(this.$el.find("> ol")),this.trigger("render"),this.$el},getRange:function(){return{start:this.book.printedPageToPageIndex(this.startPageNumber),end:this.book.printedPageToPageIndex(this.endPageNumber)}},isLeaf:function(){return 0===this.children.length},getEntriesByRange:function(leftPage,rightPage){var candidates=[];return _(this.children).each(function(entry){if(entry instanceof a5.views.interaction.PPEbookTOCEntry){var range=entry.getRange();(range.start<=leftPage&&leftPage<=range.end||range.start<=rightPage&&rightPage<=range.end)&&candidates.push(entry)}entry.isLeaf()||(candidates=entry.getEntriesByRange(leftPage,rightPage).concat(candidates))},this),candidates},_onClick:function(e){e.stopPropagation(),this.trigger("select",this)},_onSelectEntry:function(entry){this.trigger("select",entry)},_renderChildren:function($target){$target=$target||this.$el,_.isString($target)&&($target=this.$el.find($target));var fragment=document.createDocumentFragment();_.each(this.children,function(child){var $node=child.render&&child.render()||child.$el;$node&&fragment.appendChild($node[0])}),$target.append(fragment)}},Obj.extend("a5.views.interaction.PPEbookTOCEntry"),a5.views.interaction.PPEbookTOCSection={template:'<span class="title"></span><ol></ol>',init:function(book,text){this.$el=$("<li>",{class:"toc-section"}),this.book=book,this.text=text,this.children=[]},append:function(entry){this.children.push(entry),entry.bind("select",this._onSelectEntry,this)},render:function(){return this.$el.html(this.template),this.$el.find(".title").text(this.text),this._renderChildren(this.$el.find("> ol")),this.trigger("render"),this.$el},isLeaf:function(){return!1},getEntriesByRange:function(leftPage,rightPage){var candidates=[];return _(this.children).each(function(entry){if(entry instanceof a5.views.interaction.PPEbookTOCEntry){var range=entry.getRange();(range.start<=leftPage&&leftPage<=range.end||range.start<=rightPage&&rightPage<=range.end)&&candidates.push(entry)}entry.isLeaf()||(candidates=entry.getEntriesByRange(leftPage,rightPage).concat(candidates))},this),candidates},_onSelectEntry:function(entry){this.trigger("select",entry)},_renderChildren:function($target){$target=$target||this.$el,_.isString($target)&&($target=this.$el.find($target));var fragment=document.createDocumentFragment();_.each(this.children,function(child){var $node=child.render&&child.render()||child.$el;$node&&fragment.appendChild($node[0])}),$target.append(fragment)}},Obj.extend("a5.views.interaction.PPEbookTOCSection"),Obj.extend("a5.Annotations",{init:function(options){a5a=this,this.defaults={language:"en",stage:"annotations",appendTo:null,intView:null,displayAsPopup:!0,stickyNoteWithTitle:!1,stickyNoteMinSize:!1},this.options=$.extend({},this.defaults,options),this.intView=this.options.intView,this.config=new a5.Annotations.Config,this.i18n=this.config.i18n,this.current=new a5.Annotations.Current,this.history=new a5.Annotations.History,this.stage=null,this.toolbox=new a5.Annotations.Toolbox,this.cursor=new a5.Annotations.Cursor,this.options.keyboard&&(this.keyboard=new a5.Annotations.KeyboardEvents),this.API=a5.service.lms.API,this.API&&this.API.getData("annotations").done(_.bind(function(annotations){this.current.fromObject(annotations)},this))},allocate:function(interaction){this.current.drawings[interaction.index]||(this.current.drawings[interaction.index]=new a5.Annotations.Drawing)},activate:function(interactions){this.stage&&this.stage.destroy(),_.isArray(interactions)||(interactions=[interactions]),this.stage=new a5.Annotations.Stage(interactions),this.current.view.activate(),this.history.view.activate()},deactivate:function(){},useTool:function(identifier){var tool;tool="number"==typeof identifier?this.toolbox.tools[identifier]:_.find(this.toolbox.tools,function(tool){return identifier==tool.name}),this.toolbox.select(tool,!0)},save:function(){var data=this.current.serialize();_.isEmpty(data.annotations)&&!this.current.hasChanges||this.API.setData("annotations",this.current.serialize()),this.current.changed(!1)}}),Obj.extend("a5.Annotations.C",{init:function(){a5a.config&&(this.i18n=a5a.config.i18n),_.bindAll(this,"i18n")}}),a5.Annotations.C.extend("a5.Annotations.ConfigController",{init:function(){this._super()}}),a5.Annotations.C.extend("a5.Annotations.CurrentController",{init:function(){this.view=new a5.Annotations.CurrentView(this)}}),a5.Annotations.C.extend("a5.Annotations.HistoryController",{init:function(){this._super(),this.view=new a5.Annotations.HistoryView(this)},expectChange:function(drawing){a5a.stage.drawing=drawing,drawing.nextBefore=a5a.stage.drawing.serialize(!0)},expectBatchChange:function(){var drawings=_.values(a5a.current.drawings);_.each(drawings,function(drawing){_.isUndefined(drawing.annotation)||this.expectChange(drawing)},this)},takeBatchSnapshot:function(){var drawings=_.values(a5a.current.drawings),snapshots=_.chain(drawings).filter(function(drawing){return!_.isUndefined(drawing.annotation)}).map(function(drawing){return new a5.Annotations.Moment({annotation:drawing.annotation,before:drawing.nextBefore,after:drawing.serialize(!0)})}).value();this.level>0&&this.reset(),this.snapshots.unshift(snapshots),this.trim(),this.view.update()},takeSnapshot:function(){var drawing=a5a.stage.drawing||a5a.stage.view.$.get(0).drawingInstance,snapshot=new a5.Annotations.Moment({annotation:drawing.annotation,before:drawing.nextBefore,after:drawing.serialize(!0)});this.level>0&&this.reset(),this.snapshots.unshift(snapshot),this.trim(),this.view.update()},undo:function(){if(this.level<this.snapshots.length){this.level++;var snapshot=this.snapshots[this.level-1];_.isArray(snapshot)?_.invoke(snapshot,"undo"):snapshot.undo(),this.view.update(),a5.hooks.ppebookHistoryUndo.call()}},redo:function(){if(this.level>0){var snapshot=this.snapshots[this.level-1];_.isArray(snapshot)?_.invoke(snapshot,"redo"):snapshot.redo(),this.level--,this.view.update(),a5.hooks.ppebookHistoryRedo.call()}},reset:function(){this.snapshots.splice(0,this.level),this.level=0},trim:function(){this.snapshots.length>this.levels&&this.snapshots.pop()}}),a5.Annotations.C.extend("a5.Annotations.MomentController",{init:function(data){this._super(data)},undo:function(){var drawing=a5a.current.drawings[this.annotation];drawing.removeAllFeatures(!0),drawing.fromObject(this.before),a5a.stage.view.redraw()},redo:function(){var drawing=a5a.current.drawings[this.annotation];drawing.removeAllFeatures(!0),drawing.fromObject(this.after),a5a.stage.view.redraw()},trash:function(){}}),a5.Annotations.C.extend("a5.Annotations.StageController",{init:function(interactions){this.view=new a5.Annotations.StageView(this,interactions)},last:function(){return this.drawing.last()},toggle:function(){this.visible=!this.visible,this.view.toggle()},destroy:function(){this.view.destroy()}}),a5.Annotations.C.extend("a5.Annotations.CursorController",{init:function(){this.view=new a5.Annotations.CursorView(this)},select:function(tool){this.tool=tool.name,this.view.update()}}),a5.Annotations.C.extend("a5.Annotations.ToolboxController",{init:function(){this._super(),this.view=this.displayAsPopup?new a5.Annotations.ToolboxPopupView(this):new a5.Annotations.ToolboxStaticView(this)},use:function(tools){this.tools=_.filter(tools,function(tool){return!$(tool.exclude).length}),this.length=this.tools.length,this.view.onToolsChanged&&this.view.onToolsChanged()},specific:function(specifics){_.each(specifics,function(properties,tool){var theTool=_.find(this.tools,function(t){return tool==t.name});_.extend(theTool,properties)},this)},tool:function(name){return _.find(this.tools,function(tool){if(tool.name==name)return tool})||{}},select:function(tool,quiet){this.view.$.is(".lifted")||(this.trigger("toolbox:beforeSelect",tool),$("body :focus").blur(),tool.isSelectable?(this.selected&&this.selected.deselect&&this.selected.deselect(),this.selected=a5a.current.tool=tool,tool.select&&tool.select(),this.view.select(quiet),this.trigger("toolbox:select",tool)):(tool.action(),"hide"===tool.name&&this.view.update&&this.view.update()))}}),a5.Annotations.C.extend("a5.Annotations.ToolController",{init:function(){this.view=new a5.Annotations.ToolView(this),this.isPressed=!1},press:function(x,y,e,ev){var isEraser="eraser"===a5a.toolbox.selected.name;$("body").removeClass("isInputing");var drawing=e.target.drawingInstance||a5a.stage.drawing;a5a.history.expectChange(drawing),isEraser||drawing.addFeature(e,ev),a5a.current.tool.palette&&(this.color=a5a.current.tool.palette.selected),a5a.current.tool.thicknessList&&(this.thickness=a5a.current.tool.thicknessList.selected),this.start=new a5.Annotations.Point(x,y),this.points?(this.points=[],this.points.push(this.start)):isEraser||a5a.stage.last().content.view.render(),$("body").disableSelection(),this.isPressed=!0},drag:function(x,y,e,ev){this.isPressed&&(this.points||"spotlight"===a5a.toolbox.selected.name)&&(this.end=new a5.Annotations.Point(x,y),this.points&&this.points.push(this.end),"eraser"!==a5a.toolbox.selected.name&&a5a.stage.last().content.view.preview(this.end,e,ev))},lift:function(x,y,e,ev){this.isPressed&&(this.end=new a5.Annotations.Point(x,y),this.points&&(this.points.push(this.end),a5a.stage.last().content.view.render(this.points)),"eraser"!==a5a.toolbox.selected.name&&a5a.stage.last().content.view.postview(this.end,e,ev),"spotlight"!==a5a.toolbox.selected.name&&a5a.current.changed(!0),$("body").enableSelection()),this.isPressed=!1}}),a5.Annotations.C.extend("a5.Annotations.ColorPaletteController",{init:function(tool,colors){this.tool=tool,this.view=new a5.Annotations.ColorPaletteView(this),this.select()},select:function(color,dont_close,quiet){color=color||this.colors[0],this.selected=color,this.view.select(dont_close),quiet||this.trigger("select",color)},cycle:function(){var index=_.indexOf(this.colors,this.selected)+1;this.select(this.colors[index],!0)}}),a5.Annotations.C.extend("a5.Annotations.ColorController",{init:function(color){}}),a5.Annotations.C.extend("a5.Annotations.ThicknessListController",{init:function(tool,thicknesses){this.tool=tool,this.view=new a5.Annotations.ThicknessSelectorView(this),this.select()},select:function(thickness,dont_close,quiet){thickness=thickness||this.thicknesses[0],this.selected=thickness,this.view.select(dont_close),quiet||this.trigger("select",thickness)},cycle:function(){var index=_.indexOf(this.thicknesses,this.selected)+1;this.select(this.thicknesses[index],!0)}}),a5.Annotations.C.extend("a5.Annotations.ThicknessController",{init:function(thickness){}}),a5.Annotations.C.extend("a5.Annotations.DrawingController",{init:function(payload){},addFeature:function(e,ev){a5a.stage.drawing=this,a5a.stage.view.$current=a5a.stage.view.$.not(function(){return this!=e.target}),a5a.stage.view.$.find(".content-block-out").each(function(){this.annotationsFeature&&this.annotationsFeature.remove()});var feature=new a5.Annotations.Feature(this,{content:{x:a5a.current.view.coord(ev,"x",a5a.stage.view.$current),y:a5a.current.view.coord(ev,"y",a5a.stage.view.$current)}});feature.contentClass&&"BlockOut"!=feature.contentType&&this.features.push(feature)},removeFeature:function(feature){var index=_.indexOf(this.features,feature);index>=0&&this.features.splice(index,1),this.hasChanges=!0},removeAllFeatures:function(silent){silent||a5a.history.expectChange(this);var features=this.features.slice(0);_.each(features,function(feature){feature.isExportable&&(this.removeFeature(feature),feature.content.remove())},this),silent||a5a.current.changed(!0),this.hasChanges=!0},last:function(){return"BlockOut"==a5a.toolbox.selected.type?a5a.stage.view.$current.find(".content-block-out")[0].annotationsFeature:this.features.slice(-1)[0]}}),a5.Annotations.C.extend("a5.Annotations.FeatureController",{init:function(context,payload){},share:function(){return!!this.isExportable&&(a5a.history.expectChange(this.drawing),this.lock=!this.lock,a5a.current.changed(!0),this.content.view.reportSharingChange(),this.lock)},remove:function(){this.isExportable&&(a5a.history.expectChange(this.drawing),this.drawing.removeFeature(this),this.content.remove(),a5a.current.changed(!0))}}),Obj.extend("a5.Annotations.Content",{}),a5.Annotations.C.extend("a5.Annotations.Content.StrokeController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.StrokeView(this,annotation)},remove:function(){this.view.$.remove()}}),a5.Annotations.C.extend("a5.Annotations.Content.TextController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.TextView(this,annotation)},remove:function(){this.view.$.remove(),a5.eventBus.trigger("book:text_deleted")}}),a5.Annotations.C.extend("a5.Annotations.Content.LinkController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.LinkView(this,annotation)},remove:function(){this.view.$.remove(),a5.eventBus.trigger("book:link_deleted")}}),a5.Annotations.C.extend("a5.Annotations.Content.BlockController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.BlockView(this,annotation)},remove:function(){this.view.$.remove(),a5.eventBus.trigger("book:sticky_note_deleted")}}),a5.Annotations.C.extend("a5.Annotations.Content.BlockOutController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.BlockOutView(this,annotation)},remove:function(){this.view.$.remove(),this.view.$others.remove()}}),a5.Annotations.C.extend("a5.Annotations.Content.InverseMaskController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.InverseMaskView(this,annotation)},remove:function(){this.view.$.remove()}}),a5.Annotations.C.extend("a5.Annotations.Content.MaskController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.MaskView(this,annotation)},remove:function(){this.view.$.remove()}}),a5.Annotations.C.extend("a5.Annotations.StrokeSegmentController",{init:function(annotation,x,y){this.annotation=annotation,this.view=new a5.Annotations.StrokeSegmentView(this,x,y),this.previous=void 0,this.next=void 0},push:function(x,y){return this.x=Math.min(x,this.x),this.y=Math.min(y,this.y),this.view.extentX=Math.max(x,this.view.extentX),this.view.extentY=Math.max(y,this.view.extentY),this.view.width=this.view.extentX-this.x,this.view.height=this.view.extentY-this.y,!(this.length>1&&(this.view.width>a5a.current.tool.maxSegmentPerimeter||this.view.height>a5a.current.tool.maxSegmentPerimeter))&&(this.length=this.points.push(new a5.Annotations.Point(x,y)),!0)}}),a5.Annotations.C.extend("a5.Annotations.PointController",{init:function(x,y){}}),a5.Annotations.C.extend("a5.Annotations.KeyboardEventsController",{init:function(){this._super(),_.bindAll(this,"fireEvent"),this.view=new a5.Annotations.KeyboardEventsView(this),$(document).on("keydown",this.fireEvent)},fireEvent:function(e){if(!(e.originalEvent.repeat||$("body .modal.in").length||$("body").is(".fullscreen")&&27===e.which)){var self=this,modifiers=[],type=$(e.target).is(":input:not(button),[contenteditable]")?"key:input:":"key:";e.shiftKey&&modifiers.push("shift"),e.ctrlKey&&modifiers.push("ctrl"),e.altKey&&modifiers.push("alt");var key=this.nameEventKey(e);key&&""!=key&&$.each(key.split(" "),function(){var keys=modifiers.concat(this.toLowerCase()),main=key[key.length-1];self.view.$node.trigger("annotations:"+type+keys.join("+"),main)})}},nameEventKey:function(e){var name;return!!e.which&&(name=this.key[e.which],name||(name=String.fromCharCode(e.which)),""==name&&(name=e.which),name)}}),a5.Annotations.ConfigController.extend("a5.Annotations.Config",{init:function(){this._super(),this.focusToClickDelay=100,this.historyLevels=100,this.stickyNoteBorder=2,this.stickyNoteThreshold=30,this.defaultCursorColor="black",this.referenceStageWidth=810,this.defaultStickyNoteSize=260,this.defaultTextSize=[40,40],this.defaultLinkSize=[260,80],this.minStickyNoteSize=!!a5a.options.stickyNoteMinSize&&this.defaultStickyNoteSize*parseInt(a5a.options.stickyNoteMinSize,10)/100,this.defaultMaskSize=500,this.stickyNoteWithTitle=a5a.options.stickyNoteWithTitle,this.language=a5a.options.language,this.vocabulary={en:_.extend({undoTool:"Undo",redoTool:"Redo",cursorTool:'<span class="keyboard-key">C</span>ursor',penTool:'<span class="keyboard-key">P</span>en',highlighterTool:'<span class="keyboard-key">H</span>ighlighter',eraserTool:'<span class="keyboard-key">E</span>raser',stickyNoteTool:'<span class="keyboard-key">S</span>ticky Note',textTool:'<span class="keyboard-key">T</span>ext',linkTool:'<span class="keyboard-key">L</span>ink',spotlightTool:'Spotli<span class="keyboard-key">g</span>ht',inverseMaskTool:"Inverse mask",maskTool:"Mask",saveTool:"Save",hideTool:"Hide",showTool:"Show",clearTool:"Clear",clearAllTool:"Clear All",undoToolHint:"Undo last action",redoToolHint:"Redo last undone action",cursorToolHint:"Cursor",penToolHint:"Pen Tool",highlighterToolHint:"Highlighter Tool",eraserToolHint:"Eraser Tool",stickyNoteDefaultTitle:"Untitled",stickyNoteToolHint:"Sticky Note Tool",stickyNoteCollapseHint:"Collapse this sticky note",stickyNoteExpandHint:"Expand sticky note",stickyNoteShareHint:"Share this sticky note with others",stickyNoteUnshareHint:"Revoke sharing of this sticky note",stickyNoteTrashHint:"Delete this sticky note",stickyNoteResizeHint:"Drag this corner to resize",textHandleHint:"Move this text",textToolHint:"Text Tool",textTrashHint:"Delete this text",linkCollapseHint:"Collapse this link",linkExpandHint:"Expand link",linkHandleHint:"Move this link",linkToolHint:"Link Tool",linkTrashHint:"Delete this link",spotlightToolHint:"Spotlight Tool",inverseMaskToolHint:"Inverse Mask Tool",maskToolHint:"Mask Tool",saveToolHint:"Save changes",hideToolHint:"Show/hide annotations",clearToolHint:"Delete annotations",clearAllToolHint:"Delete all annotations",toolboxDragHint:"You can drag the toolbox over to anywhere on the screen",redColor:"Red",blueColor:"Blue",greenColor:"Green",grayColor:"Gray",blackColor:"Black",yellowColor:"Yellow",pinkColor:"Pink",limeColor:"Lime",violetColor:"Violet",orangeColor:"Orange",turquoiseColor:"Turquoise",lightyellowColor:"Light yellow",lightgreyColor:"Light grey",lightblueColor:"Light blue",lightgreenColor:"Light green",lightpinkColor:"Light red",smallThickness:"small",bigThickness:"big",unsavedContentWarning:"Caution: There are some unsaved annotations on this page. If you wish to save them before leaving, choose to stay on the page. To continue without saving choose to leave the page.",stickyNoteTrashQuestionTitle:"Confirm delete",stickyNoteTrashQuestion:"Are you sure you want to delete this Sticky Note?\nClick OK to confirm or Cancel to go back.",stickyNoteSharedTrashQuestion:"Are you sure you want to delete this shared Sticky Note?\nIt will be deleted for everybody you share it with.\nClick OK to confirm or Cancel to go back.",stickyNoteTrashOKLabel:"OK",stickyNoteTrashCancelLabel:"Cancel",stickyNoteShareAnnouncement:"OK, the note will be shared to others after you save changes.\nClick the share icon again to unshare.",stickyNoteUnshareAnnouncement:"OK, this note will no longer be shared with others.\nDon't forget to save your changes.",textTrashQuestionTitle:"Confirm delete",textTrashQuestion:"Are you sure you want to delete this Text?\nClick OK to confirm or Cancel to go back.",textTrashOKLabel:"OK",textTrashCancelLabel:"Cancel",linkTrashQuestionTitle:"Confirm delete",linkTrashQuestion:"Are you sure you want to delete this Link?\nClick OK to confirm or Cancel to go back.",linkTrashOKLabel:"OK",linkTrashCancelLabel:"Cancel",missingApiWarning:"Author API Not Found.",key:{toolCursor:"annotations:key:c annotations:key:esc annotations:key:input:esc",toolPen:"annotations:key:p",toolHighlighter:"annotations:key:h",toolEraser:"annotations:key:e",toolStickyNote:"annotations:key:s",toolSpotlight:"annotations:key:g",toolText:"annotations:key:t",toolLink:"annotations:key:l"}},A5.ANNOTATIONS_VOCABULARY.en),cs:_.extend({undoTool:"ZpÄt",redoTool:"Znovu",cursorTool:'<span class="keyboard-key">K</span>urzor',penTool:'<span class="keyboard-key">P</span>ero',highlighterTool:'<span class="keyboard-key">Z</span>vÃ½razovaÄ',eraserTool:'<span class="keyboard-key">G</span>uma',stickyNoteTool:'PoznÃ¡<span class="keyboard-key">m</span>ka',textTool:'<span class="keyboard-key">T</span>ext',spotlightTool:'<span class="keyboard-key">V</span>ysvÃ­cenÃ­',inverseMaskTool:"Inverse mask",maskTool:"Mask",saveTool:"UloÅ¾it",hideTool:"SkrÃ½t",showTool:"Zobrazit",clearTool:"Clear",penToolHint:"NÃ¡stroj pero",highlighterToolHint:"NÃ¡stroj zvÃ½razovaÄ",eraserToolHint:"NÃ¡stroj guma",stickyNoteDefaultTitle:"Untitled",stickyNoteToolHint:"NÃ¡stroj poznÃ¡mka",stickyNoteCollapseHint:"Sbalit tuto poznÃ¡mku",stickyNoteExpandHint:"Rozbalit poznÃ¡mku",stickyNoteShareHint:"SdÃ­let tuto poznÃ¡mku s ostatnÃ­mi",stickyNoteUnshareHint:"PÅestat sdÃ­let tuto poznÃ¡mku",stickyNoteTrashHint:"Smazat tuto poznÃ¡mku",stickyNoteResizeHint:"TaÅ¾enÃ­m tohoto rohu zmÄnÃ­te velikost",textHandleHint:"TÃ¡hnout",textToolHint:"TextovÃ½ nÃ¡stroj",textTrashHint:"Smazat tuto textovÃ½",linkCollapseHint:"Collapse this link",linkExpandHint:"Expand link",linkHandleHint:"Move this link",linkToolHint:"Link Tool",linkTrashHint:"Delete this link",spotlightToolHint:"NÃ¡stroj vysvÃ­cenÃ­",inverseMaskToolHint:"Inverse Mask Tool",maskToolHint:"Mask Tool",cursorToolHint:"Kurzor",undoToolHint:"VrÃ¡tit zpÄt poslednÃ­ akci",redoToolHint:"Zopakovat poslednÄ vrÃ¡cenou akci",saveToolHint:"UloÅ¾it zmÄny",hideToolHint:"Zobrazit/skrÃ½t anotace",clearToolHint:"Delete annotations",toolboxDragHint:"Paletu s nÃ¡stroji mÅ¯Å¾ete pÅemÃ­stit kamkoliv po obrazovce",redColor:"ÄervenÃ¡",blueColor:"ModrÃ¡",greenColor:"ZelenÃ¡",grayColor:"Å edÃ¡",blackColor:"ÄernÃ¡",yellowColor:"Å½lutÃ¡",pinkColor:"Pink",limeColor:"LimetkovÃ¡",violetColor:"RÅ¯Å¾ovÃ¡",orangeColor:"OranÅ¾ovÃ¡",turquoiseColor:"TyrkysovÃ¡",lightyellowColor:"SvÄtle Å¾lutÃ¡",lightgreyColor:"SvÄtle Å¡edÃ¡",lightblueColor:"SvÄtle modrÃ¡",lightgreenColor:"SvÄtle zelenÃ¡",lightpinkColor:"SvÄtle ÄervenÃ¡",smallThickness:"small",bigThickness:"big",unsavedContentWarning:"VarovÃ¡nÃ­: Na strÃ¡nce jsou nÄkterÃ© neuloÅ¾enÃ© anotace. Pokud je chcete pÅed odchodem uloÅ¾it, zvolte zÅ¯stat na strÃ¡nce. Nebo pokraÄujte bez uloÅ¾enÃ­ opuÅ¡tÄnÃ­m tÃ©to strÃ¡nky.",stickyNoteTrashQuestionTitle:"Confirm delete",stickyNoteTrashQuestion:"Opravdu chcete tuto poznÃ¡mku vymazat?\nPro potvrzenÃ­ zvolte OK nebo se vraÅ¥te volbou ZruÅ¡it.",stickyNoteTrashOKLabel:"OK",stickyNoteTrashCancelLabel:"Cancel",stickyNoteShareAnnouncement:"OK, poznÃ¡mka bude sdÃ­lena s ostatnÃ­mi, jakmile zmÄny uloÅ¾Ã­te.\nKliknÄte znovu pro zruÅ¡enÃ­ sdÃ­lenÃ­.",stickyNoteUnshareAnnouncement:"OK, tato poznÃ¡mka nebude jiÅ¾ nadÃ¡le sdÃ­lena s ostatnÃ­mi.\nNezapomete zmÄny uloÅ¾it.",textTrashQuestionTitle:"Confirm delete",textTrashQuestion:"Opravdu chcete tuto textovÃ½ vymazat?\nPro potvrzenÃ­ zvolte OK nebo se vraÅ¥te volbou ZruÅ¡it.",textTrashOKLabel:"OK",textTrashCancelLabel:"Cancel",linkTrashQuestionTitle:"Confirm delete",linkTrashQuestion:"Are you sure you want to delete this Link?\nClick OK to confirm or Cancel to go back.",linkTrashOKLabel:"OK",linkTrashCancelLabel:"Cancel",missingApiWarning:"Author API nenalezeno.",key:{toolCursor:"annotations:key:k annotations:key:esc annotations:key:input:esc",toolPen:"annotations:key:p",toolHighlighter:"annotations:key:z",toolEraser:"annotations:key:g",toolStickyNote:"annotations:key:m",toolSpotlight:"annotations:key:v",toolText:"annotations:key:t",toolLink:"annotations:key:l"}},A5.ANNOTATIONS_VOCABULARY.cs),de:_.extend({undoTool:"RÃ¼ckgÃ¤ngig",
redoTool:"Wiederholen",cursorTool:'<span class="keyboard-key">A</span>uswahl',penTool:'<span class="keyboard-key">S</span>tift',highlighterTool:'<span class="keyboard-key">M</span>arker',eraserTool:'<span class="keyboard-key">R</span>adiergummi',stickyNoteTool:'<span class="keyboard-key">N</span>otiz',textTool:'<span class="keyboard-key">T</span>ext',spotlightTool:'<span class="keyboard-key">H</span>ervorheben',inverseMaskTool:"Inverse mask",maskTool:"Mask",saveTool:"Speichern",hideTool:"Ausblenden",showTool:"Einblenden",clearTool:"Clear",clearAllTool:"Clear All",undoToolHint:"Letzte Aktion rÃ¼ckgÃ¤ngig machen",redoToolHint:"Letzte Aktion wiederherstellen",cursorToolHint:"Cursor",penToolHint:"Stift-Werkzeug",highlighterToolHint:"Marker-Werkzeug",eraserToolHint:"Radiergummi",stickyNoteDefaultTitle:"Untitled",stickyNoteToolHint:"Notiz-Werkzeug",stickyNoteCollapseHint:"Notiz einklappen",stickyNoteExpandHint:"Notiz ausklappen",stickyNoteShareHint:"Notiz mit anderen teilen",stickyNoteUnshareHint:"Notiz nicht lÃ¤nger mit anderen teilen",stickyNoteTrashHint:"Notiz lÃ¶schen",stickyNoteResizeHint:"Diese Ecke ziehen um die GrÃ¶Ãe zu verÃ¤ndern",textHandleHint:"Verschieben",textToolHint:"Text einfÃ¼gen",textTrashHint:"LÃ¶schen",linkCollapseHint:"Collapse this link",linkExpandHint:"Expand link",linkHandleHint:"Move this link",linkToolHint:"Link Tool",linkTrashHint:"Delete this link",spotlightToolHint:"Hervorheben-Werkzeug",inverseMaskToolHint:"Inverse Mask Tool",maskToolHint:"Mask Tool",saveToolHint:"Speichern",hideToolHint:"Anmerkungen einblenden / ausblenden",clearToolHint:"Delete annotations",clearAllToolHint:"Delete all annotations",toolboxDragHint:"Werkzeugleiste verschieben",redColor:"Rot",blueColor:"Blau",greenColor:"GrÃ¼n",grayColor:"Grau",blackColor:"Schwarz",yellowColor:"Gelb",pinkColor:"Pink",limeColor:"Limettenfarben",violetColor:"Violett",orangeColor:"Orange",turquoiseColor:"TÃ¼rkis",lightyellowColor:"Gelb",lightgreyColor:"Grau",lightblueColor:"Blau",lightgreenColor:"GrÃ¼n",lightpinkColor:"Rot",smallThickness:"small",bigThickness:"big",unsavedContentWarning:"Achtung: Einige Ãnderungen auf dieser Seite wurden noch nicht gespeichert. Um sie zu speichern, bleibe auf der Seite. Um ohne Speichern fortzufahren, verlasse die Seite.",stickyNoteTrashQuestionTitle:"LÃ¶schen bestÃ¤tigen",stickyNoteTrashQuestion:"Diese Notiz lÃ¶schen? OK fÃ¼r LÃ¶schen, anderenfalls Abbrechen auswÃ¤hlen.",stickyNoteSharedTrashQuestion:"Diese mit anderen geteilte Notiz lÃ¶schen?\nSie wird fÃ¼r alle gelÃ¶scht, mit denen sie geteilt ist.\nOK fÃ¼r LÃ¶schen, anderenfalls Abbrechen auswÃ¤hlen.",stickyNoteTrashOKLabel:"OK",stickyNoteTrashCancelLabel:"Abbrechen",stickyNoteShareAnnouncement:"OK, diese Notiz wird mit anderen geteilt nach dem die Ãnderungen gespeichert wurden\ncon nochmals klicken, um rÃ¼ckgÃ¤ngig zu machen.",stickyNoteUnshareAnnouncement:"OK, diese Notiz wird nicht mehr mit anderen geteilt.\nÃnderungen speichern nicht vergessen.",textTrashQuestionTitle:"LÃ¶schen bestÃ¤tigen",textTrashQuestion:"Diese Text lÃ¶schen? OK fÃ¼r LÃ¶schen, anderenfalls Abbrechen auswÃ¤hlen.",textTrashOKLabel:"OK",textTrashCancelLabel:"Abbrechen",linkTrashQuestionTitle:"Confirm delete",linkTrashQuestion:"Are you sure you want to delete this Link?\nClick OK to confirm or Cancel to go back.",linkTrashOKLabel:"OK",linkTrashCancelLabel:"Cancel",missingApiWarning:"Author API nicht gefunden.",key:{toolCursor:"annotations:key:a annotations:key:esc annotations:key:input:esc",toolPen:"annotations:key:s",toolHighlighter:"annotations:key:m",toolEraser:"annotations:key:r",toolStickyNote:"annotations:key:n",toolSpotlight:"annotations:key:h",toolText:"annotations:key:t",toolLink:"annotations:key:l"}},A5.ANNOTATIONS_VOCABULARY.de),es:_.extend({undoTool:"Deshacer",redoTool:"Rehacer",cursorTool:'<span class="keyboard-key">C</span>ursor',penTool:'<span class="keyboard-key">L</span>Ã¡piz',highlighterTool:'<span class="keyboard-key">M</span>arcador',eraserTool:'<span class="keyboard-key">G</span>oma',stickyNoteTool:'<span class="keyboard-key">P</span>ost-it',textTool:'<span class="keyboard-key">T</span>exto',spotlightTool:'<span class="keyboard-key">F</span>oco',inverseMaskTool:"Inverse mask",maskTool:"Mask",saveTool:"Guardar",hideTool:"Ocultar",showTool:"Mostrar",clearTool:"Clear",clearAllTool:"Clear All",undoToolHint:"Deshacer",redoToolHint:"Rehacer",cursorToolHint:"Cursor",penToolHint:"LÃ¡piz",highlighterToolHint:"Marcador",eraserToolHint:"Goma",stickyNoteDefaultTitle:"Sin tÃ­tulo",stickyNoteToolHint:"Post-it",stickyNoteCollapseHint:"Ocultar el Post-it",stickyNoteExpandHint:"Mostrar el Post-it",stickyNoteShareHint:"Share this sticky note with others",stickyNoteUnshareHint:"Revoke sharing of this sticky note",stickyNoteTrashHint:"Eliminar el Post-it",stickyNoteResizeHint:"Arrastrar la esquina del Post-it para modificar su tamaÃ±o",textHandleHint:"Mover el texto",textToolHint:"Texto",textTrashHint:"Eliminar el texto",linkCollapseHint:"Ocultar el enlace",linkExpandHint:"Mostrar el enlace",linkHandleHint:"Mover el enlace",linkToolHint:"Link",linkTrashHint:"Eliminar el enlace",spotlightToolHint:"Foco",inverseMaskToolHint:"Inverse Mask Tool",maskToolHint:"Mask Tool",saveToolHint:"Guardar",hideToolHint:"Mostrar/ocultar las anotaciones",clearToolHint:"Delete annotations",clearAllToolHint:"Delete all annotations",toolboxDragHint:"Puedes mover la barra de herramientas a cualquier parte de la pantalla",redColor:"Rojo",blueColor:"Azul",greenColor:"Verde",grayColor:"Gris",blackColor:"Negro",yellowColor:"Amarillo",pinkColor:"Rosa",limeColor:"Verde",violetColor:"Violeta",orangeColor:"Naranja",turquoiseColor:"Turquesa",lightyellowColor:"Amarillo",lightgreyColor:"Gris",lightblueColor:"Azul",lightgreenColor:"Verde",lightpinkColor:"Rosa",smallThickness:"small",bigThickness:"big",unsavedContentWarning:"AtenciÃ³n: no has guardado todas tus anotaciones en esta pÃ¡gina. Si quieres guardarlas antes de salir, no cierres la pÃ¡gina del libro y haz clic en Guardar en la barra de herramientas. Si quieres seguir sin guardarlas, puedes cerrar la pÃ¡gina del libro.",stickyNoteTrashQuestionTitle:"Confirm delete",stickyNoteTrashQuestion:"Â¿EstÃ¡s seguro/a de que quieras eliminar este post-it?\nHaz clic en Aceptar para confirmarlo o en Cancelar para volver atrÃ¡s.",stickyNoteSharedTrashQuestion:"Are you sure you want to delete this shared Sticky Note?\nIt will be deleted for everybody you share it with.\nClick OK to confirm or Cancel to go back.",stickyNoteTrashOKLabel:"OK",stickyNoteTrashCancelLabel:"Cancel",stickyNoteShareAnnouncement:"OK, the note will be shared to others after you save changes.\nClick the share icon again to unshare.",stickyNoteUnshareAnnouncement:"OK, this note will no longer be shared with others.\nDon't forget to save your changes.",textTrashQuestionTitle:"Borrar texto",textTrashQuestion:"Â¿EstÃ¡s seguro/a de que quieres eliminar este texto?\nHaz clic en Aceptar para confirmarlo o en Cancelar para volver atrÃ¡s.",textTrashOKLabel:"Aceptar",textTrashCancelLabel:"Cancelar",linkTrashQuestionTitle:"Borrar enlace",linkTrashQuestion:"Â¿EstÃ¡s seguro/a de que quieres eliminar este enlace?\nHaz clic en Aceptar para confirmarlo o en Cancelar para volver atrÃ¡s.",linkTrashOKLabel:"OK",linkTrashCancelLabel:"Cancel",missingApiWarning:"Author API Not Found.",key:{toolCursor:"annotations:key:c annotations:key:esc annotations:key:input:esc",toolPen:"annotations:key:l",toolHighlighter:"annotations:key:m",toolEraser:"annotations:key:g",toolStickyNote:"annotations:key:p",toolSpotlight:"annotations:key:f",toolText:"annotations:key:t",toolLink:"annotations:key:l"}},A5.ANNOTATIONS_VOCABULARY.es),fr:_.extend({undoTool:"Annuler",redoTool:"RÃ©tablir",cursorTool:'<span class="keyboard-key">C</span>urseur',penTool:'Cra<span class="keyboard-key">y</span>on',highlighterTool:'<span class="keyboard-key">S</span>urligneur',eraserTool:'<span class="keyboard-key">G</span>omme',stickyNoteTool:'<span class="keyboard-key">P</span>ost-it',textTool:'<span class="keyboard-key">T</span>exte',spotlightTool:'<span class="keyboard-key">F</span>ocus',inverseMaskTool:"Inverse mask",maskTool:"Mask",saveTool:"Enregistrer",hideTool:"Cacher",showTool:"Montrer",clearTool:"Clear",clearAllTool:"Clear all",undoToolHint:"Annuler",redoToolHint:"RÃ©tablir",cursorToolHint:"Curseur",penToolHint:"Crayon",highlighterToolHint:"Surligneur",eraserToolHint:"Gomme",stickyNoteDefaultTitle:"Untitled",stickyNoteToolHint:"Post-it",stickyNoteCollapseHint:"Cacher le Post-it",stickyNoteExpandHint:"Montrer le Post-it",stickyNoteShareHint:"Share this sticky note with others",stickyNoteUnshareHint:"Revoke sharing of this sticky note",stickyNoteTrashHint:"Eliminer le Post-it",stickyNoteResizeHint:"Ãtirer le coin du Post-it pour le redimensionner",textHandleHint:"DÃ©placer le texte",textToolHint:"Texte",textTrashHint:"Eliminer le texte",linkCollapseHint:"Collapse this link",linkExpandHint:"Expand link",linkHandleHint:"Move this link",linkToolHint:"Link Tool",linkTrashHint:"Delete this link",spotlightToolHint:"Focus",inverseMaskToolHint:"Inverse Mask Tool",maskToolHint:"Mask Tool",saveToolHint:"Enregistrer",hideToolHint:"Montrer/cacher les annotations",clearToolHint:"Delete annotations",clearAllToolHint:"Delete all annotations",toolboxDragHint:"Vous pouvez dÃ©placer la barre dâoutils nâimporte oÃ¹ sur lâÃ©cran",redColor:"Rouge",blueColor:"Bleu",greenColor:"Vert",grayColor:"Gris",blackColor:"Noir",yellowColor:"Jaune",pinkColor:"Pink",limeColor:"Vert",violetColor:"Violet",orangeColor:"Orange",turquoiseColor:"Turquoise",lightyellowColor:"Jaune",lightgreyColor:"Gris",lightblueColor:"Bleu",lightgreenColor:"Vert",lightpinkColor:"Rose",smallThickness:"small",bigThickness:"big",unsavedContentWarning:"Attention : vous nâavez pas sauvegardÃ© toutes vos annotations. Si vous souhaitez les sauvegarder, ne fermez pas la page du livre et cliquez sur Enregistrer dans la barre dâoutils. Si vous ne souhaitez pas les sauvegarder, vous pouvez fermer la page du livre.",stickyNoteTrashQuestionTitle:"Confirm delete",stickyNoteTrashQuestion:"Vous allez supprimer ce Post-it. \nCliquez sur Accepter pour le supprimer ou Annuler pour revenir en arriÃ¨re.",stickyNoteTrashOKLabel:"OK",stickyNoteTrashCancelLabel:"Cancel",stickyNoteSharedTrashQuestion:"Are you sure you want to delete this shared Sticky Note?\nIt will be deleted for everybody you share it with.\nClick OK to confirm or Cancel to go back.",stickyNoteShareAnnouncement:"OK, the note will be shared to others after you save changes.\nClick the share icon again to unshare.",stickyNoteUnshareAnnouncement:"OK, this note will no longer be shared with others.\nDon't forget to save your changes.",textTrashQuestionTitle:"Confirm delete",textTrashQuestion:"Vous allez supprimer ce texte. \nCliquez sur Accepter pour le supprimer ou Annuler pour revenir en arriÃ¨re.",textTrashOKLabel:"OK",textTrashCancelLabel:"Cancel",linkTrashQuestionTitle:"Confirm delete",linkTrashQuestion:"Vous allez supprimer ce texte. \nCliquez sur Accepter pour le supprimer ou Annuler pour revenir en arriÃ¨re.",linkTrashOKLabel:"OK",linkTrashCancelLabel:"Cancel",missingApiWarning:"Author API Not Found.",key:{toolCursor:"annotations:key:c annotations:key:esc annotations:key:input:esc",toolPen:"annotations:key:y",toolHighlighter:"annotations:key:s",toolEraser:"annotations:key:g",toolStickyNote:"annotations:key:p",toolSpotlight:"annotations:key:f",toolText:"annotations:key:t",toolLink:"annotations:key:l"}},A5.ANNOTATIONS_VOCABULARY.fr)}},i18n:function(term){return"function"==typeof term&&(term=term()),this.vocabulary[this.language][term]||'translate:"'+term},i18nKey:function(){return this.vocabulary[this.language].key||{}}}),A5.ANNOTATIONS_TOOLBOX=A5.ANNOTATIONS_TOOLBOX||"Undo,Redo,Cursor,Pen,Highlighter,Eraser,StickyNote,Spotlight,Save,Hide",A5.ANNOTATIONS_INITIAL_TOOL=A5.ANNOTATIONS_INITIAL_TOOL||"cursor",A5.ANNOTATIONS_PEN_COLORS=A5.ANNOTATIONS_PEN_COLORS||"red,blue,green,gray,black",A5.ANNOTATIONS_PEN_SIZES=A5.ANNOTATIONS_PEN_SIZES||"small 1.5",A5.ANNOTATIONS_TEXT_COLORS=A5.ANNOTATIONS_TEXT_COLORS||"red,blue,green,black",A5.ANNOTATIONS_TEXT_SIZES=A5.ANNOTATIONS_TEXT_SIZES||"small 12, medium 18, big 24",A5.ANNOTATIONS_HIGHLIGHTER_COLORS=A5.ANNOTATIONS_HIGHLIGHTER_COLORS||"yellow,lime,violet #ee82ee,orange #ffa500,turquoise #40e0d0",A5.ANNOTATIONS_HIGHLIGHTER_SIZES=A5.ANNOTATIONS_HIGHLIGHTER_SIZES||"small 25",A5.ANNOTATIONS_STICKYNOTE_COLORS=A5.ANNOTATIONS_STICKYNOTE_COLORS||"lightyellow,lightgrey,lightblue,lightgreen,lightpink",A5.ANNOTATIONS_VOCABULARY=A5.ANNOTATIONS_VOCABULARY||{},A5.ANNOTATIONS_VOCABULARY={en:A5.ANNOTATIONS_VOCABULARY.en||{},cs:A5.ANNOTATIONS_VOCABULARY.cs||{},de:A5.ANNOTATIONS_VOCABULARY.de||{}},a5.Annotations.CurrentController.extend("a5.Annotations.Current",{init:function(){this._super(),this.tool=void 0,this.drawings={},this.canLock=void 0,this.hasChanges=!1},changed:function(changed){changed&&a5a.history.takeSnapshot(),this.hasChanges=changed,this.view.flagChange()},batchChanged:function(changed){changed&&a5a.history.takeBatchSnapshot(),this.hasChanges=changed,this.view.flagChange()},serialize:function(){return{annotations:function(drawings){var result={};return _.each(drawings,function(drawing,index){var data=drawing.serialize();(data.features.length>0||drawing.hasChanges)&&(result[index]=data,drawing.hasChanges=!1)}),result}(this.drawings)}},fromObject:function(data){data&&(this.canLock=data.locking,_.each(data.annotations,_.bind(function(annotation,index){this.drawings[index]=new a5.Annotations.Drawing(annotation)},this)))}}),a5.Annotations.HistoryController.extend("a5.Annotations.History",{init:function(){this._super(),this.snapshots=[],this.levels=a5a.config.historyLevels,this.level=0}}),a5.Annotations.MomentController.extend("a5.Annotations.Moment",{init:function(data){this._super(data),this.timestamp=new Date,this.annotation=data.annotation,this.before=data.before,this.after=data.after}}),a5.Annotations.StageController.extend("a5.Annotations.Stage",{init:function(interactions){this._super(interactions),this.interaction=interactions,_.defer(this.view.measure),this.drawing=null,this.drawings=_.map(interactions,_.bind(function(interaction,index){return this.view.$[index].drawingInstance=$.extend(a5a.current.drawings[interaction.index],{annotation:interaction.index})},this)),this.visible=!a5a.toolbox.tool("hide").selected}}),a5.Annotations.CursorController.extend("a5.Annotations.Cursor",{init:function(){this._super(),this.tool="cursor"}}),a5.Annotations.ToolboxController.extend("a5.Annotations.Toolbox",{init:function(){this.appendTo=a5a.options.appendTo,this.displayAsPopup=a5a.options.displayAsPopup,this.tools=[],this.length=0,this.selected=void 0,this.x=0,this.y=0,this.visible=!1,this._super()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Pen",{init:function(){this.i18n=a5a.config.i18n,this.name="pen",this.label=this.i18n("penTool"),this.hint=this.i18n("penToolHint"),this.isSelectable=!0,this.type="Stroke",this.lineCap="round",this.opacity=1,this.palette=new a5.Annotations.ColorPalette(this,A5.ANNOTATIONS_PEN_COLORS.split(/, ?/)),this.thicknessList=new a5.Annotations.ThicknessList(this,A5.ANNOTATIONS_PEN_SIZES.split(/, ?/)),this.maxSegmentPerimeter=5,this.points=[],this._super()},serialize:function(){return{name:this.name,thickness:a5a.current.tool.thicknessList.selected.serialize(),opacity:this.opacity,color:a5a.current.tool.palette.selected.serialize()}},deselect:function(){this.view.colorClosed(),this.view.thicknessClosed()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Highlighter",{init:function(){this.i18n=a5a.config.i18n,this.name="highlighter",this.label=this.i18n("highlighterTool"),this.hint=this.i18n("highlighterToolHint"),this.isSelectable=!0,this.type="Stroke",this.lineCap="butt",this.opacity=.25,this.palette=new a5.Annotations.ColorPalette(this,A5.ANNOTATIONS_HIGHLIGHTER_COLORS.split(/, ?/)),this.thicknessList=new a5.Annotations.ThicknessList(this,A5.ANNOTATIONS_HIGHLIGHTER_SIZES.split(/, ?/)),this.i=0,this.maxSegmentPerimeter=5,this.points=[],this._super()},serialize:function(){return{name:this.name,thickness:a5a.current.tool.thicknessList.selected.serialize(),opacity:this.opacity,color:a5a.current.tool.palette.selected.serialize()}},deselect:function(){this.view.colorClosed(),this.view.thicknessClosed()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Eraser",{init:function(){this.i18n=a5a.config.i18n,this.name="eraser",this.label=this.i18n("eraserTool"),this.hint=this.i18n("eraserToolHint"),this.isSelectable=!0,this.type="Stroke",this.isActive=!1,this._super()},stage_events:{"mousedown.eraser":"activate","mousemove.eraser":"scratchFeatures","mouseup.eraser":"deactivate"},select:function(){this.load(a5a.stage.view)},deselect:function(){this.unload(a5a.stage.view)},load:function(stageView){this._bindEventsToStageView(stageView)},unload:function(stageView){this._unbindEventsFromStageView(stageView)},activate:function(e){this.isActive=!0},deactivate:function(e){this.isActive=!1},scratchFeatures:function(e){if(this.isActive){var $content=$(e.target).parents(".content:not(.content-sticky-note,.content-mask,.content-inverse-mask,.content-link)");if($content.length||($content=$(e.target).filter(".content:not(.content-sticky-note,.content-mask,.content-inverse-mask,.content-link)")),$content.length){$content[0].annotationsFeature.remove()}}},_bindEventsToStageView:function(stageView){_.each(this.stage_events,function(handler,event){stageView.$.bind(event,this[handler])},this)},_unbindEventsFromStageView:function(stageView){_.each(this.stage_events,function(handler,event){stageView.$.unbind(event,this[handler])},this)}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.StickyNote",{init:function(){this.i18n=a5a.config.i18n,this.name="sticky note",this.label=this.i18n("stickyNoteTool"),this.hint=this.i18n("stickyNoteToolHint"),this.isSelectable=!0,this.type="Block",this.palette=new a5.Annotations.ColorPalette(this,A5.ANNOTATIONS_STICKYNOTE_COLORS.split(/, ?/)),this._super()},select:function(){a5a.stage.view.$.find(".content-sticky-note:not(.locked) .text").attr({contentEditable:"true"}),a5a.stage.view.$.find(".content-sticky-note:not(.locked) .title").attr({contentEditable:"true"})},deselect:function(){a5a.stage.view.$.find(".content-sticky-note:not(.locked) .text").attr({contentEditable:"false"}),a5a.stage.view.$.find(".content-sticky-note:not(.locked) .title").attr({contentEditable:"false"})},serialize:function(){return{name:this.name,color:a5a.current.tool.palette.selected.serialize()}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Text",{init:function(){this.i18n=a5a.config.i18n,this.name="text",this.label=this.i18n("textTool"),this.hint=this.i18n("textToolHint"),this.isSelectable=!0,this.type="Text",this.palette=new a5.Annotations.ColorPalette(this,A5.ANNOTATIONS_TEXT_COLORS.split(/, ?/)),this.thicknessList=new a5.Annotations.ThicknessList(this,A5.ANNOTATIONS_TEXT_SIZES.split(/, ?/)),this._super()},select:function(){a5a.stage.view.$.find(".content-text .text").attr({contentEditable:"true"})},deselect:function(){a5a.stage.view.$.find(".content-text .text").attr({contentEditable:"false"})},serialize:function(){return{name:this.name,color:a5a.current.tool.palette.selected.serialize(),size:a5a.current.tool.thicknessList.selected.serialize()}},restore:function(data){var size,color;data.color&&(color=_.find(this.palette.colors,{hex:data.color}),this.palette.select(color,!0,!0)),data.size&&(size=_.find(this.thicknessList.thicknesses,{size:data.size}),this.thicknessList.select(size,!0,!0))}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Link",{init:function(){this.i18n=a5a.config.i18n,this.name="link",this.label=this.i18n("linkTool"),this.hint=this.i18n("linkToolHint"),this.isSelectable=!0,this.type="Link",this._super()},select:function(){a5a.stage.view.$.find(".content-link .text").attr({contentEditable:"true"})},deselect:function(){a5a.stage.view.$.find(".content-link .text").attr({contentEditable:"false"})},serialize:function(){return{name:this.name}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Spotlight",{init:function(){this.i18n=a5a.config.i18n,this.name="spotlight",this.label=this.i18n("spotlightTool"),this.hint=this.i18n("spotlightToolHint"),this.isSelectable=!0,this.type="BlockOut",this.exclude="",this._super()},select:function(){},deselect:function(){},serialize:function(){return{name:this.name}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.InverseMask",{init:function(){this.i18n=a5a.config.i18n,this.name="inverse mask",this.label=this.i18n("inverseMaskTool"),this.hint=this.i18n("inverseMaskToolHint"),this.isSelectable=!0,this.type="InverseMask",this.exclude="",this._super()},select:function(){},deselect:function(){},serialize:function(){return{name:this.name}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Mask",{init:function(){this.i18n=a5a.config.i18n,this.name="mask",this.label=this.i18n("maskTool"),this.hint=this.i18n("maskToolHint"),this.isSelectable=!0,this.type="Mask",this.exclude="",this._super()},select:function(){},deselect:function(){},serialize:function(){return{name:this.name}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Cursor",{init:function(){this.i18n=a5a.config.i18n,this.name="cursor",this.label=this.i18n("cursorTool"),this.hint=this.i18n("cursorToolHint"),this.isSelectable=!0,this.isDeactivating=!0,this.type=null,this._super()},select:function(){a5a.intView&&a5a.intView.pages.scroller&&a5a.intView.pages.scroller.node.data("hammer").get("pan").set({enable:!0})},deselect:function(){a5a.intView&&a5a.intView.pages.scroller&&a5a.intView.pages.scroller.node.data("hammer").get("pan").set({enable:!1})}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Undo",{init:function(){this.i18n=a5a.config.i18n,this.name="undo",this.label=this.i18n("undoTool"),this.hint=this.i18n("undoToolHint"),this.isSelectable=!1,this.type="Action",this._super()},action:function(){a5a.history.undo()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Redo",{init:function(){this.i18n=a5a.config.i18n,this.name="redo",this.label=this.i18n("redoTool"),this.hint=this.i18n("redoToolHint"),this.isSelectable=!1,this.type="Action",this._super()},action:function(){a5a.history.redo()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Save",{init:function(){this.i18n=a5a.config.i18n,this.name="save",this.label=this.i18n("saveTool"),this.hint=this.i18n("saveToolHint"),this.isSelectable=!1,this.type="Action",this._super()},action:function(){a5a.current.hasChanges&&a5a.save()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Hide",{init:function(){this.i18n=a5a.config.i18n,this.name="hide",this.label=this.i18n("hideTool"),this.hint=this.i18n("hideToolHint"),this.isSelectable=!1,this.type="Action",this.selected=!1,this._super()},action:function(){this.selected=!this.selected,a5a.stage.toggle(),this.view.$name.html(this.selected?this.i18n("showTool"):this.i18n("hideTool"))}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Clear",{init:function(){this.i18n=a5a.config.i18n,this.name="clear",this.label=this.i18n("clearTool"),this.hint=this.i18n("clearToolHint"),this.isSelectable=!1,this.type="Action",this._super()},action:function(){if(!this.open){var dialog=new a5.view.PPEbookClearAnnotationsDialog,$dialog=dialog.render();""!==$dialog.html()?(this.open=!0,dialog.bind("submit",function(){_.each(a5a.stage.drawings,function(drawing){drawing.removeAllFeatures()})}),dialog.bind("close",function(){$dialog.remove(),this.open=!1},this),dialog.open()):_.each(a5a.stage.drawings,function(drawing){drawing.removeAllFeatures()})}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.ClearAll",{init:function(){this.i18n=a5a.config.i18n,this.name="clearAll",this.label=this.i18n("clearAllTool"),this.hint=this.i18n("clearAllToolHint"),this.isSelectable=!1,this.type="Action",this._super()},action:function(){if(!this.open){var dialog=new a5.view.PPEbookClearAllAnnotationsDialog,$dialog=dialog.render();""!==$dialog.html()?(this.open=!0,dialog.bind("submit",_.bind(function(){this._clear()},this)),dialog.bind("close",function(){$dialog.remove(),this.open=!1},this),dialog.open()):this._clear()}},_clear:function(){var drawings=_.values(a5a.current.drawings);a5a.history.expectBatchChange(),_.each(drawings,function(drawing,index){drawing.removeAllFeatures(!0)}),a5a.current.batchChanged(!0)}}),a5.Annotations.ColorPaletteController.extend("a5.Annotations.ColorPalette",{init:function(tool,colors){this.colors=_.map(colors,function(color){return new a5.Annotations.Color(color)}),this.selected=void 0,this._super(tool,colors)}}),a5.Annotations.ColorController.extend("a5.Annotations.Color",{init:function(color){this.i18n=a5a.config.i18n,color=color.split(/ /),this.name=color[0],this.label=this.i18n(color[0]+"Color"),this.hex=color[1]||color[0],this._super()},serialize:function(){return this.hex}}),a5.Annotations.ThicknessListController.extend("a5.Annotations.ThicknessList",{init:function(tool,thicknesses){this.thicknesses=_.map(thicknesses,function(thickness){return new a5.Annotations.Thickness(thickness)}),this.selected=void 0,this._super(tool,thicknesses)}}),a5.Annotations.ThicknessController.extend("a5.Annotations.Thickness",{init:function(thickness){this.i18n=a5a.config.i18n,thickness=thickness.split(/ /),this.name=thickness[0],this.label=this.i18n(thickness[0]+"Thickness"),this.size=parseFloat(thickness[1]),this._super()},serialize:function(){return this.size}}),a5.Annotations.DrawingController.extend("a5.Annotations.Drawing",{init:function(payload){this._super(payload),payload=payload||{},this.nextBefore={},this.fromObject({features:payload.features})},serialize:function(forHistory){return{features:_.map(this.features,function(feature){if(forHistory||feature.isExportable)return feature.serialize()})}},fromObject:function(data){data&&(this.features=_.map(data.features,function(feature){return new a5.Annotations.Feature(this,feature)},this))}}),a5.Annotations.FeatureController.extend("a5.Annotations.Feature",{init:function(context,payload){this._super(payload),payload=payload||{},this.contentType=payload.type||a5a.current.tool.type,this.drawing=context,this.contentClass=eval("a5.Annotations.Content."+this.contentType),this.contentClass&&(this.content=new this.contentClass(this,payload.content)),this.lock=payload.lock,this.isExportable="string"!=typeof this.lock},serialize:function(){return{type:this.contentType,lock:this.lock,content:this.content.serialize()}}}),a5.Annotations.Content.StrokeController.extend("a5.Annotations.Content.Stroke",{init:function(annotation,payload){payload=payload||{},this.type="Stroke",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.segments=[],this.points=_.map(payload.points,function(point){return new a5.Annotations.Point(point[0],point[1])}),this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){var points=[];return $.each(this.points,function(ix,point){points.push(point.serialize())}),{tool:this.toolSnapshot,points:points}}}),a5.Annotations.StrokeSegmentController.extend("a5.Annotations.StrokeSegment",{init:function(annotation,x,y){this._super(annotation,x,y),this.x=this.view.extentX=x,this.y=this.view.extentY=y,this.points=[],this.length=0},serialize:function(){var points=[];return $.each(this.points,function(ix,point){points.push(point.serialize())}),points}}),a5.Annotations.PointController.extend("a5.Annotations.Point",{init:function(x,y){this._super(x,y),this.x=x,this.y=y},serialize:function(){return[this.x,this.y]}}),a5.Annotations.Content.TextController.extend("a5.Annotations.Content.Text",{init:function(annotation,payload){payload=payload||{},this.type="Text",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.content=payload.content||"",this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,content:this.content}}}),a5.Annotations.Content.LinkController.extend("a5.Annotations.Content.Link",{init:function(annotation,payload){payload=payload||{},this.type="Link",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.width=payload.width,this.height=payload.height,this.content=payload.content||"",this.isCollapsed=!!payload.shrunk,this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,width:this.width,height:this.height,shrunk:this.isCollapsed,content:this.content}}}),a5.Annotations.Content.BlockController.extend("a5.Annotations.Content.Block",{init:function(annotation,payload){payload=payload||{},this.type="Block",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.width=payload.width,this.height=payload.height,this.content=payload.content||"",this.title=payload.title,this.isCollapsed=!!payload.shrunk,this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,width:this.width,height:this.height,shrunk:this.isCollapsed,content:this.content,title:this.title}}}),a5.Annotations.Content.BlockOutController.extend("a5.Annotations.Content.BlockOut",{init:function(annotation,payload){payload=payload||{},this.type="BlockOut",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.width=0,this.height=0,this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,width:this.width,height:this.height,content:this.content}}}),a5.Annotations.Content.InverseMaskController.extend("a5.Annotations.Content.InverseMask",{init:function(annotation,payload){payload=payload||{},this.type="InverseMask",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.width=payload.width,this.height=payload.height,this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,width:this.width,height:this.height,content:this.content}}}),a5.Annotations.Content.MaskController.extend("a5.Annotations.Content.Mask",{init:function(annotation,payload){payload=payload||{},this.type="Mask",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.width=payload.width,this.height=payload.height,this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,width:this.width,height:this.height,content:this.content}}}),a5.Annotations.KeyboardEventsController.extend("a5.Annotations.KeyboardEvents",{init:function(){this.key={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"MODIFIER SHIFT",17:"MODIFIER CTRL",18:"MODIFIER ALT",19:"BREAK",20:"CAPS-LOCK",27:"ESC",32:"SPACE",33:"PAGE-UP",34:"PAGE-DOWN",35:"END",36:"HOME",37:"ARROW LEFT",38:"ARROW UP",39:"ARROW RIGHT",40:"ARROW DOWN",45:"INSERT",46:"DELETE",144:"NUM-LOCK",145:"SCROLL-LOCK",91:"MODIFIER CMD",224:"MODIFIER CMD",93:"MENU",96:"NUMBER 0",97:"NUMBER 1",98:"NUMBER 2",99:"NUMBER 3",100:"NUMBER 4",101:"NUMBER 5",102:"NUMBER 6",103:"NUMBER 7",104:"NUMBER 8",105:"NUMBER 9",106:"MULTIPLY",107:"ADD",109:"SUBTRACT",111:"DIVIDE",112:"FUNC F1",113:"FUNC F2",114:"FUNC F3",115:"FUNC F4",116:"FUNC F5",117:"FUNC F6",118:"FUNC F7",119:"FUNC F8",120:"FUNC F9",121:"FUNC F10",122:"FUNC F11",123:"FUNC F12",124:"FUNC F13",125:"FUNC F14",126:"FUNC F15",127:"FUNC F16",128:"FUNC F17",129:"FUNC F18",130:"FUNC F19",187:"EQUAL"},this._super()}}),Obj.extend("a5.Annotations.V",{init:function(that){this.that=that,this.i18n=that.i18n}}),Obj.extend("a5.Annotations.Utilities",{init:function(){this.touchClickSupport=new a5.Annotations.Utilities.TouchClick,
this.extendjQuery()},coord:function(evnt,axis,elem){var coord,scale,el=elem?$(elem):$(evnt.target),offset=el.offset(),box=el[0].getBoundingClientRect(),pageX=this.inBounds(evnt.pageX,offset.left,offset.left+box.width),pageY=this.inBounds(evnt.pageY,offset.top,offset.top+box.height);return"x"===axis?(scale=el[0].offsetWidth/box.width,coord=Math.round((pageX-offset.left)*scale)):"y"===axis&&(scale=el[0].offsetHeight/box.height,coord=Math.round((pageY-offset.top)*scale)),coord},zoom:function(){return a5.player?a5.player.viewportScaling.zoom:a5a.intView&&a5a.intView.pages&&a5a.intView.pages.scroller?a5a.intView.pages.scroller.zoom:1},extendjQuery:function(){var originalRemoveClass=jQuery.fn.removeClass;jQuery.fn.removeClass=function(){if(arguments[0]instanceof RegExp){var pattern=arguments[0];return $(this).each(function(){this.className=this.className.replace(pattern,"")})}return originalRemoveClass.apply(this,arguments)},jQuery.extend(jQuery.expr[":"],{outside:function(element,i,selector){return 0==$(element).parents(selector[3]).length}})},inBounds:function(val,min,max){return val<min?val=min:val>max&&(val=max),val}}),a5.Annotations.Utilities.extend("a5.Annotations.CurrentView",{init:function(that){this._super(that),_.bindAll(this,"flagChange","offerSave"),this.that=that,this.i18n=a5a.config.i18n,this.domSelector=a5a.options.stage,this.LEFT_BUTTON=0,this.RIGHT_BUTTON=2,this.touchAgent=/iphone|ipod|ipad|android|fennec|rim tablet/i.test(navigator.userAgent),this.isActive=!1,this.supportsCanvas=!$("body").is(".isQt"),$(window).on("beforeunload",this.offerSave),_.defer(this.flagChange)},activate:function(){this.isActive=!0},deactivate:function(){this.isActive=!1},flagChange:function(){$("body").toggleClass("hasUnchangedAnnotations",!a5a.current.hasChanges)},offerSave:function(e){if(this.that.hasChanges)return a5a.toolbox.view.show(),this.i18n("unsavedContentWarning")}}),Obj.extend("a5.Annotations.Utilities.TouchClick",{init:function(){this.touchedOn=null,this.active=!1,_.bindAll(this,"touchHandler")},bindEvents:function(tool){"Stroke"==tool.type||"Block"==tool.type||"BlockOut"==tool.type||"Mask"==tool.type||"InverseMask"==tool.type||"Link"==tool.type?this.active||(this.active=!this.active,document.addEventListener("touchstart",this.touchHandler,!0),document.addEventListener("touchmove",this.touchHandler,!0),document.addEventListener("touchend",this.touchHandler,!0),document.addEventListener("touchcancel",this.touchHandler,!0)):this.active&&(this.active=!this.active,document.removeEventListener("touchstart",this.touchHandler,!0),document.removeEventListener("touchmove",this.touchHandler,!0),document.removeEventListener("touchend",this.touchHandler,!0),document.removeEventListener("touchcancel",this.touchHandler,!0))},touchHandler:function(event){var type;if(event.touches.length<=1){var touch=event.changedTouches[0],target=document.elementFromPoint(touch.clientX,touch.clientY);if($(target).is("[contenteditable], input"))return;switch(event.preventDefault(),event.type){case"touchstart":type="mousedown";break;case"touchmove":type="mousemove";break;case"touchcancel":case"touchend":type="mouseup";break;default:return}switch(event.type){case"touchstart":this.touchedOn=target;break;case"touchend":target==this.touchedOn&&(type+=" click"),this.touchedOn=null}for(var types=type.split(" "),i=0;i<types.length;i++){var simulation=document.createEvent("MouseEvent");simulation.initMouseEvent(types[i],!0,!0,window,1,touch.screenX,touch.screenY,touch.clientX,touch.clientY,!1,!1,!1,!1,a5a.current.view.LEFT_BUTTON,null),target.dispatchEvent(simulation)}return!1}}}),a5.Annotations.V.extend("a5.Annotations.HistoryView",{init:function(that){this._super(that)},activate:function(){this.update()},update:function(){var undoAvailable=this.that.snapshots.length>0&&this.that.level<this.that.snapshots.length,redoAvailable=this.that.level>0;$("body").toggleClass("hasAnnotationsNoUndo",!undoAvailable),$("body").toggleClass("hasAnnotationsNoRedo",!redoAvailable)}}),a5.Annotations.V.extend("a5.Annotations.StageView",{init:function(that,interactions){this._super(that),_.bindAll(this,"redraw","updateSize","measure");var $node=$();_.each(interactions,function(interaction){$node=$node.add(interaction.view?interaction.view.$node:interaction.node||interaction.$)}),this.$=$node.find("."+a5a.current.view.domSelector),$(".active."+a5a.current.view.domSelector).removeClass("active"),this.$.empty(),this.$.addClass("active tool-"+a5a.current.tool.name.replace(/ /g,"-")),this.$.addClass(a5a.current.view.domSelector+"-stage"),this.$drawable=$("<div>",{class:a5a.current.view.domSelector+"-drawable"}).appendTo(this.$),_.defer(_.bind(this.updateSize,this)),this.bindEvents(),_.defer(_.bind(this.calculateStageRatio,this)),$(window).on("resize.stage",_.debounce(this.updateSize,600)),_.defer(this.redraw)},bindEvents:function(){var self=this;a5a.current.tool&&_(a5a.current.tool.load).isFunction()&&a5a.current.tool.load(this),this.$drawable.on("mousedown.stage",function(e){if(a5a.current.tool&&e.button==a5a.current.view.LEFT_BUTTON)return $(e.target).parent().trigger("toolPress",[a5a.current.view.coord(e,"x",this),a5a.current.view.coord(e,"y",this),e]),!!e.preventDefault()}),this.$.on("toolPress.stage",function(e,x,y,ev){$(document).on("mousemove",this,move).on("mouseup",this,up),self.$.addClass("isDrawing"),self.$current=self.$.filter(e.target),a5a.current.tool.press(x,y,e,ev)}).on("toolDrag.stage",function(e,x,y,ev){$(e.target).is(self.$current)&&a5a.current.tool.drag(x,y,e,ev)}).on("toolLift.stage",function(e,x,y,ev){$(document).off("mousemove",move).off("mouseup",up),self.$.removeClass("isDrawing"),a5a.current.tool.lift(x,y,e,ev)});function move(e){$(e.target).parent().trigger("toolDrag",[a5a.current.view.coord(e,"x",e.data),a5a.current.view.coord(e,"y",e.data),e])}function up(e){self.$drawable.parent().trigger("toolLift",[a5a.current.view.coord(e,"x",e.data),a5a.current.view.coord(e,"y",e.data),e])}},redraw:function(){this.$.children().not(this.$drawable).remove(),_.each(this.that.drawings,function(drawing,index){this.$current=this.$.eq(index),this.that.drawing=drawing;var features=drawing.features.slice(0);_.each(features,function(feature,index){feature.content.view.render()}),drawing.features=features},this),this.$.trigger("redraw.stage")},show:function(){this.$.show()},hide:function(){this.$.hide()},toggle:function(){$("body").toggleClass("hidden-annotations",!this.that.visible)},measure:function(){this.that.dimensions={width:this.$.parent().width(),height:this.$.parent().height()}},calculateStageRatio:function(){this.$.each(function(){this.ratio=$(this).parent().width()/a5a.config.referenceStageWidth})},destroy:function(){this.$drawable.unbind(".stage"),this.$.unbind(".stage"),this.$.children().remove(),a5a.current.tool&&_(a5a.current.tool.unload).isFunction()&&a5a.current.tool.unload(this),$(window).off("resize.stage")},updateSize:function(){this.$drawable.css({height:this.$.parent().height()})}}),a5.Annotations.V.extend("a5.Annotations.CursorView",{init:function(that){this._super(that),_.bindAll(this,"update","flagIfWithin"),this.$=$("<div>",{id:a5a.current.view.domSelector+"-cursor",class:""}).appendTo("body"),this.paletteClass=null,this.bindEvents(),_.defer(this.update)},bindEvents:function(){$(document).on("mousemove",this.flagIfWithin)},flagIfWithin:function(e){var show,cursor=this.that.tool;"cursor"!=cursor&&(show="eraser"==cursor?!!$(e.target).parents(".main-content, .page").length:$(e.target).is(a5a.stage.view.$drawable),this.$.toggleClass("within",show||$(e.target).is(this.$)),this.$.css({left:e.clientX,top:e.clientY}))},update:function(newPaletteClass){var color,tool=this.that.tool;this.$.removeClass(/ ?tool-\S+/g),this.$.addClass("tool-"+tool.replace(/ /g,"-")),a5a.current.tool.palette?(color=a5a.current.tool.palette.selected.hex,this.updatePalette(newPaletteClass)):color=a5a.config.defaultCursorColor,this.$.css({color:color})},updatePalette:function(newPaletteClass){var classes=this.$.attr("class").split(" "),tool=this.that.tool;tool=tool.replace(/ /g,"-");var regexp=new RegExp(tool+"-color-");newPaletteClass&&(newPaletteClass=newPaletteClass.replace(/ /g,"-"),regexp.test(newPaletteClass)&&(classes=_.reject(classes,function(c){return regexp.test(c)}),this.paletteClass=newPaletteClass,this.$.attr("class",classes.join(" ")),this.$.addClass(newPaletteClass)))}}),a5.Annotations.V.extend("a5.Annotations.ToolBoxBaseView",{select:function(){var tool=this.that.selected;this.$.children(".selected").removeClass("selected"),tool.view.$.addClass("selected"),a5a.stage&&(a5a.stage.view.$.removeClass(/ ?tool-\S+/g),a5a.stage.view.$.addClass("tool-"+tool.name.replace(/ /g,"-"))),tool.palette&&tool.palette.view.open(),tool.thicknessList&&tool.thicknessList.view.open(),$("body").toggleClass("isUnselectable","cursor"!==tool.name),a5a.current.view.touchClickSupport.bindEvents(tool),a5a.cursor.select(tool)},hide:function(){this.$.hide(),this.that.visible=!1,this.trigger("hide")},show:function(){this.$.show(),this.that.visible=!0,this.trigger("show")},toggle:function(){this.that.visible?this.hide():this.show()},update:function(){}}),a5.Annotations.ToolBoxBaseView.extend("a5.Annotations.ToolboxStaticView",{init:function(that){this._super(that),_.bindAll(this,"appendToolbox"),this.$=$("<ul>",{id:a5a.current.view.domSelector+"-toolbox"}),_.defer(this.appendToolbox)},appendToolbox:function(){this.$appendTo=$(this.that.appendTo),this.$.appendTo(this.$appendTo),this.that.visible=!0}}),a5.Annotations.ToolBoxBaseView.extend("a5.Annotations.ToolboxPopupView",{init:function(that){this._super(that),_.bindAll(this,"appendToolbox","_onResize","update"),this.downX=void 0,this.downY=void 0,this.hasMoved=!1,this.$=$("<ul>",{id:a5a.current.view.domSelector+"-toolbox"}),this.$close=$("<li>",{class:"control control-close"}).appendTo(this.$),this.$drag=$("<li>",{class:"control control-drag",title:this.i18n("toolboxDragHint")}).appendTo(this.$),_.defer(this.appendToolbox),this.bindEvents()},appendToolbox:function(){this.$appendTo=$(this.that.appendTo),this.$.appendTo(this.$appendTo),this.updateInitialPosition()},bindEvents:function(){var self=this;this.$.on("click",function(e){e.stopPropagation()}).on("toolboxDown",function(e,x,y){$(document).on("touchmove mousemove",move).bind("touchend mouseup",up),self.lastX=self.x,self.lastY=self.y,self.downX=x,self.downY=y}).on("toolboxDrag",function(e,x,y){self.hasMoved=!0,self.$.addClass("lifted"),self.x=self.lastX+(x-self.downX),self.y=self.lastY+(y-self.downY),self.update()}).on("toolboxLift",function(e,x,y){$(document).off("touchmove mousemove",move).off("touchend mouseup",up),self.x=self.lastX+(x-self.downX),self.y=self.lastY+(y-self.downY),self.update(),_.defer(function(){self.$.removeClass("lifted")})}).on("mousedown",a5a.options.toolbarDragOnlyFromHandle?".control-drag":null,function(e){if(self._mouseDownEvent=e,e.button==a5a.current.view.LEFT_BUTTON)return self.$.trigger("toolboxDown",[e.clientX,e.clientY]),!!e.preventDefault()}).on("touchstart",a5a.options.toolbarDragOnlyFromHandle?".control-drag":null,function(e){var touch=event.changedTouches[0];self.$.trigger("toolboxDown",[touch.clientX,touch.clientY])}),$(window).on("resize",_.throttle(this._onResize,300));var hammerPan,panEnabled,hasMoved=!1;function move(e){if(hasMoved||(hammerPan=a5a.intView.pages.scroller.node.data("hammer").get("pan"),panEnabled=hammerPan.options.enable,hammerPan.set({enable:!1}),hasMoved=!0),"mousemove"===e.type&&e.pageX===self._mouseDownEvent.pageX&&e.pageY===self._mouseDownEvent.pageY)return!0;if("touchmove"===e.type){var touch=event.changedTouches[0];e.clientX=touch.clientX,e.clientY=touch.clientY}self.$.trigger("toolboxDrag",[e.clientX,e.clientY])}function up(e){if(hasMoved&&(hammerPan.set({enable:panEnabled}),hasMoved=!1),"touchend"===e.type){var touch=event.changedTouches[0];e.clientX=touch.clientX,e.clientY=touch.clientY}self.$.trigger("toolboxLift",[e.clientX,e.clientY])}this.$.on("click",".control-close",function(e){self.hide()})},onToolsChanged:function(){this.that.tools.forEach(function(tool){tool.view.unbind("color:open",this.update),tool.view.unbind("thickness:open",this.update),tool.view.bind("color:open",this.update,this),tool.view.bind("thickness:open",this.update,this)},this)},update:function(){this.hasMoved?this.updatePosition():a5a.options.toolboxInitialPosition&&this.updateInitialPosition()},updatePosition:function(){a5a.options.toolboxInsideBounds&&this._inBounds(),this.$appendTo.length>0&&this.$appendTo.outerWidth()>0&&this.$appendTo.outerHeight()>0&&this.$.css({left:100*this.x/this.$appendTo.outerWidth()+"%",top:100*this.y/this.$appendTo.outerHeight()+"%",bottom:"auto"})},updateInitialPosition:function(){if(this.that.visible||(this.$.css("visibility","hidden"),this.$.css("display","block")),a5a.options.toolboxInitialPosition){var position=_.result(a5a.options,"toolboxInitialPosition");position.left&&(this.x=parseFloat(position.left)),position.top&&(this.y=parseFloat(position.top))}else{var styles=getComputedStyle(this.$.get(0));styles.left.indexOf("%")<0?this.x=parseFloat(styles.left)||this.$.position().left:this.x=parseFloat(styles.left)*this.$appendTo.outerWidth()/100,styles.top.indexOf("%")<0?this.y=parseFloat(styles.top)||this.$.position().top:this.y=parseFloat(styles.top)*this.$appendTo.outerHeight()/100}this.updatePosition(),this.updateLastPosition(),this.that.visible||(this.$.css("display",""),this.$.css("visibility",""))},updateLastPosition:function(){this.lastX=this.x,this.lastY=this.y},select:function(quiet){this._super(),quiet||this.show()},show:function(){this.update(),this._super()},_onResize:function(event){_.defer(this.update)},_inBounds:function(){if(this.$appendTo.length){var offset=this.$appendTo.offset(),width=this.$appendTo.outerWidth(),height=this.$appendTo.outerHeight();this.x<0&&(this.x=0),this.x+this.$.outerWidth()>offset.left+width&&(this.x=offset.left+width-this.$.outerWidth()),this.y<0&&(this.y=0),this.y+this.$.outerHeight()>height&&(this.y=height-this.$.outerHeight())}}}),a5.Annotations.V.extend("a5.Annotations.ToolView",{init:function(that){this.that=that,$(that.exclude).length?this.$=$():(this.$=$("<li>",{class:"tool tool-"+that.name.replace(/ /g,"-"),"data-tool-type":that.type,title:that.hint}).appendTo(a5a.toolbox.view.$),this.$name=$("<span>",{class:"name",html:that.label}).appendTo(this.$),this.$.click(function(e,quiet){a5a.toolbox.select(that,quiet)})),this.bindEvents()},bindEvents:function(){this.bind("color:open",this.colorOpened,this),this.bind("color:close",this.colorClosed,this),this.bind("thickness:open",this.thicknessOpened,this),this.bind("thickness:close",this.thicknessClosed,this)},colorOpened:function(){this.$.addClass("color-open")},colorClosed:function(){this.$.removeClass("color-open")},thicknessOpened:function(){this.$.addClass("thickness-open")},thicknessClosed:function(){this.$.removeClass("thickness-open")},closeChoosers:function(){this.that.palette&&this.that.palette.view.close(),this.that.thicknessList&&this.that.thicknessList.view.close()}}),a5.Annotations.V.extend("a5.Annotations.ColorPaletteView",{init:function(that){this.$=$("<ul>",{class:"colorPalette"}),this.actualClass=null,this.oldClass=null,this._super(that),_.bindAll(this,"updateToolClass","append","updateSample");_.each(this.that.colors,function(color){var $shade=$("<li>",{class:"color color-"+color.name,title:color.label}).appendTo(this.$);$shade.css({backgroundColor:color.hex}),$shade.click(function(e){e.stopPropagation(),a5a.current.tool.palette.select(color,a5.dp.config.annotationsKeepPaletteOpen)})},this),_.defer(this.append)},append:function(){this.$.appendTo(this.that.tool.view.$)},select:function(dont_close){this.$.find(".selected").removeClass("selected"),this.$.find(".color-"+this.that.selected.name).addClass("selected"),_.defer(this.updateToolClass),_.defer(this.updateSample),!dont_close&&this.that.tool.view&&this.that.tool.view.closeChoosers()},updateToolClass:function(){var index=_.indexOf(this.that.colors,this.that.selected)+1;!_.isUndefined(this.that.tool.view)&&index>0&&(this.oldClass=this.actualClass,this.that.tool.view.$.removeClass(this.actualClass),this.actualClass=this.that.tool.name+"-color-"+index,this.that.tool.view.$.addClass(this.actualClass))},updateSample:function(){this.updateCursor(),this.that.tool.view.$.css({color:this.that.selected.hex})},updateCursor:function(){a5a.cursor.view.update(this.actualClass)},open:function(){this.$.css({display:""}),_.isUndefined(this.that.tool.view)||this.that.tool.view.trigger("color:open")},close:function(){this.$.hide(),_.isUndefined(this.that.tool.view)||this.that.tool.view.trigger("color:close")}}),a5.Annotations.V.extend("a5.Annotations.ThicknessSelectorView",{init:function(that){this.$=$("<ul>",{class:"thicknessSelector"}),this.actualClass=null,this.oldClass=null,this._super(that),_.bindAll(this,"updateToolClass","append","updateSample");_.each(this.that.thicknesses,function(thickness){$("<li>",{class:"thickness thickness-"+thickness.name,title:thickness.label}).appendTo(this.$).click(function(e){e.stopPropagation(),a5a.current.tool.thicknessList.select(thickness,a5.dp.config.annotationsKeepPaletteOpen)})},this),_.defer(this.append)},append:function(){this.$.appendTo(this.that.tool.view.$)},select:function(dont_close){this.$.find(".selected").removeClass("selected"),this.$.find(".thickness-"+this.that.selected.name).addClass("selected"),_.defer(this.updateToolClass),_.defer(this.updateSample),!dont_close&&this.that.tool.view&&this.that.tool.view.closeChoosers()},updateToolClass:function(){var index=_.indexOf(this.that.thicknesses,this.that.selected)+1;!_.isUndefined(this.that.tool.view)&&index>0&&(this.oldClass=this.actualClass,this.that.tool.view.$.removeClass(this.actualClass),this.actualClass=this.that.tool.name+"-thickness-"+index,this.that.tool.view.$.addClass(this.actualClass))},updateSample:function(){this.updateCursor(),this.that.tool.view.$.css({thickness:this.that.selected.size})},updateCursor:function(){a5a.cursor.view.update(this.actualClass)},open:function(){this.$.css({display:""}),_.isUndefined(this.that.tool.view)||this.that.tool.view.trigger("thickness:open")},close:function(){this.$.hide(),_.isUndefined(this.that.tool.view)||this.that.tool.view.trigger("thickness:close")}}),a5.Annotations.V.extend("a5.Annotations.Content.StrokeView",{init:function(that,feature){this._super(that),this.feature=feature,this.$=$(),this.that.isLoaded?this.$canvas=$():a5a.current.view.supportsCanvas?(this.$canvas=$("<canvas>",{class:"preview"}).attr(a5a.stage.dimensions).appendTo(a5a.stage.view.$current),this.context=this.$canvas[0].getContext("2d"),this.context.strokeStyle=a5a.current.tool.palette.selected.hex,this.context.lineWidth=a5a.current.tool.thicknessList.selected.size*a5a.stage.view.$current[0].ratio,this.context.lineCap=a5a.current.tool.lineCap,this.context.lineJoin="bevel",this.context.globalAlpha=a5a.current.tool.opacity,this.lastX=void 0,this.lastY=void 0):(this.paper=Raphael(a5a.stage.view.$current[0],a5a.stage.dimensions.width,a5a.stage.dimensions.height),this.$canvas=$(this.paper.canvas),this.$canvas.attr("class","preview"),this.stroke=this.paper.path(),this.stroke.attr({opacity:a5a.current.tool.opacity,stroke:a5a.current.tool.palette.selected.hex,"stroke-width":a5a.current.tool.thicknessList.selected.size*a5a.stage.view.$current[0].ratio,"stroke-linecap":a5a.current.tool.lineCap,"stroke-linejoin":"bevel"}))},preview:function(point){if(a5a.current.view.supportsCanvas)this.context.beginPath(),this.context.moveTo(this.lastX||point.x,this.lastY||point.y),this.context.lineTo(this.lastX=point.x,this.lastY=point.y),this.context.stroke();else{var path=this.stroke.attr("path");path&&"M0,0"!=path?path+=["L",point.x,point.y].join(","):path=["M",point.x,point.y].join(","),this.stroke.attr("path",path)}},postview:function(point){},render:function(points){var tool;if(points)this.that.points=points,tool={};else{tool=this.feature.content.toolSnapshot,points=this.that.points;var exclude=a5a.toolbox.tool(tool.name).exclude}if(!points||!points.length)return void this.feature.remove();a5a.stage.view.$current&&!$("body").is(exclude)&&(this.$=$("<div>",{class:"content content-stroke"}).appendTo(a5a.stage.view.$current),this.$.css({opacity:tool.opacity||a5a.current.tool.opacity}),this.$[0].annotationsFeature=this.feature,this.that.segments.length||(this.that.segments=this.segment(points)),$.each(this.that.segments,function(index,segment){segment.view.render(tool)}),this.$canvas.remove())},segment:function(points){var segments=[];return segments.push(new a5.Annotations.StrokeSegment(this.feature,points[0].x,points[0].y)),$.each(points,_.bind(function(index,point){var segment=segments.slice(-1)[0];if(!segment.push(point.x,point.y)){var newSegment=new a5.Annotations.StrokeSegment(this.feature,point.x,point.y);newSegment.previous=segment,segment.next=newSegment,newSegment.annotation=this.feature,segments.push(newSegment)}},this)),segments}}),a5.Annotations.V.extend("a5.Annotations.StrokeSegmentView",{init:function(that,x,y){this._super(that),this.$=void 0,this.width=0,this.height=0,this.extentX=0,this.extentY=0,this.padding=3},render:function(toolSnapshot){toolSnapshot=toolSnapshot||{};var padding=this.padding=2+(toolSnapshot.thickness||a5a.current.tool.thickness.size)*a5a.stage.view.$current[0].ratio,width=this.width+2*padding,height=this.height+2*padding;a5a.current.view.supportsCanvas?(this.$=$("<canvas>",{class:"segment"}).appendTo(this.that.annotation.content.view.$),this.$.attr({width:width,height:height})):(this.paper=Raphael(this.that.annotation.content.view.$[0],width,height),this.$=$(this.paper.canvas),this.$.attr("class","segment")),this.$.css({left:this.that.x-padding,top:this.that.y-padding}),this.draw(toolSnapshot)},draw:function(toolSnapshot){toolSnapshot=toolSnapshot||{};var tool=a5a.toolbox.tool(toolSnapshot.name||a5a.current.tool.name),points=[].concat(this.that.points);this.that.previous&&points.unshift(this.that.previous.points.slice(-1)[0]),this.that.previous&&points.unshift(this.that.previous.points.slice(-2,-1)[0]),this.that.next&&(points=points.concat(this.that.next.points.slice(0,2))),a5a.current.view.supportsCanvas&&(this.context=this.$[0].getContext("2d"),this.context.strokeStyle=toolSnapshot.color||tool.color.hex,this.context.lineWidth=(toolSnapshot.thickness||tool.thickness.size)*a5a.stage.view.$current[0].ratio,this.context.lineCap=toolSnapshot.lineCap||tool.lineCap,this.context.lineJoin="bevel");for(var pts=[],i=0;i<points.length;i++)pts.push(this.relX(points[i].x)),pts.push(this.relY(points[i].y));var stroke=this.drawSpline(pts,.5);!a5a.current.view.supportsCanvas&&stroke&&stroke.attr({stroke:toolSnapshot.color||tool.color.hex,"stroke-width":(toolSnapshot.thickness||tool.thickness.size)*a5a.stage.view.$current[0].ratio,"stroke-linecap":toolSnapshot.lineCap||tool.lineCap,"stroke-linejoin":"bevel"})},drawSpline:function(pts,t){var i,cp=[],n=pts.length;for(i=0;i<n-4;i+=2)cp=cp.concat(function(x0,y0,x1,y1,x2,y2,t){var d01=Math.sqrt(Math.pow(x1-x0,2)+Math.pow(y1-y0,2));var d12=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2));var fa=t*d01/(d01+d12);var fb=t-fa;var p1x=x1+fa*(x0-x2);var p1y=y1+fa*(y0-y2);var p2x=x1-fb*(x0-x2);var p2y=y1-fb*(y0-y2);return[p1x,p1y,p2x,p2y]}(pts[i],pts[i+1],pts[i+2],pts[i+3],pts[i+4],pts[i+5],t));if(!a5a.current.view.supportsCanvas){var def=[["M",pts[0],pts[1]].join(" ")];for(def.push(["Q",cp[0],cp[1],pts[2],pts[3]].join(" ")),i=2;i<pts.length-5;i+=2)def.push(["C",cp[2*i-2],cp[2*i-1],cp[2*i],cp[2*i+1],pts[i+2],pts[i+3]].join(" "));return def.push(["Q",cp[2*n-10],cp[2*n-9],pts[n-4],pts[n-3]]),this.paper.path(def.join(" "))}for(i=2;i<pts.length-5;i+=2)this.context.beginPath(),this.context.moveTo(pts[i],pts[i+1]),this.context.bezierCurveTo(cp[2*i-2],cp[2*i-1],cp[2*i],cp[2*i+1],pts[i+2],pts[i+3]),this.context.stroke(),this.context.closePath();this.context.beginPath(),this.context.moveTo(pts[0],pts[1]),this.context.quadraticCurveTo(cp[0],cp[1],pts[2],pts[3]),this.context.stroke(),this.context.closePath(),this.context.beginPath(),this.context.moveTo(pts[n-2],pts[n-1]),this.context.quadraticCurveTo(cp[2*n-10],cp[2*n-9],pts[n-4],pts[n-3]),this.context.stroke(),this.context.closePath()},relX:function(x){return x-this.that.x+this.padding},relY:function(y){return y-this.that.y+this.padding}}),a5.Annotations.V.extend("a5.Annotations.Content.TextView",{template:"a5.book.annotations.Text",init:function(that,feature){this._super(that),_.bindAll(this,"updateSizeAndPosition","askToTrash","enterFocus","flagFocus","onBlur","moveStart","moveDrag","moveEnd","onInput","onKeydown","onClickDocument","onClick","onClickText"),this.feature=feature,this.$=$("<div>",{class:"content content-text"})},render:function(){if(a5a.stage.view.$current){var html=a5.service.templates.render(this.template,this.serializeData());this.$.html($(html).html()),this.$.css({color:this.that.toolSnapshot.color,"font-size":this.that.toolSnapshot.size}),this.$text=this.$.find(".text"),this.$handle=this.$.find(".handle"),this.feature.isExportable&&"text"===a5a.toolbox.selected.name?this.enableEditable():this.disableEditable(),this.$.appendTo(a5a.stage.view.$current),this.$[0].annotationsFeature=this.feature,this.enableDraggable(),this.scale=a5a.stage.view.$current[0].ratio,this.$.css({transform:"scale("+this.scale+")","transform-origin":"top left"}),this.$text.css({minWidth:a5a.config.defaultTextSize[0],minHeight:a5a.config.defaultTextSize[1]}),this.updateSizeAndPosition(),this.bindEvents(),a5.eventBus.trigger("book:text_added")}},enableDraggable:function(){this.$.draggable({handle:".handle"})},getContent:function(){var text=this.$text.html();return"<br>"===text&&(text=""),text},enableEditable:function(){this.$text.attr("contentEditable",!0)},disableEditable:function(){this.$text.attr("contentEditable",!1)},serializeData:function(){return{text:this.that.content,handleHint:this.i18n("textHandleHint"),trashHint:this.i18n("textTrashHint")}},preview:function(point,e,ev){this.that.x=this.that.startX,this.that.y=this.that.startY},postview:function(point,e,ev){this.updateSizeAndPosition(),this.focus(),_.defer(function(){this.$.addClass("content-text-selected")}.bind(this))},onClick:function(e){this.$.addClass("content-text-selected")},onClickDocument:function(e){0===$(e.target).closest(this.$).length&&this.$.removeClass("content-text-selected")},onClickText:function(e){this.enterFocus()},bindEvents:function(){this.$.on("keydown",this.onKeydown).on("click",".trash",this.askToTrash).on("click",".text",this.onClickText).on("focus",".text",this.flagFocus).on("blur",".text",this.onBlur).on("dragstart",this.moveStart).on("drag",this.moveDrag).on("dragstop",this.moveEnd).on("input",this.onInput).on("click",this.onClick),$(window).on("resize",_.debounce(this.updateSizeAndPosition,600)),$(document).off("click",this.onClickDocument).on("click",this.onClickDocument),a5a.toolbox.tool("text").palette.bind("select",this.onChangeColor,this),a5a.toolbox.tool("text").thicknessList.bind("select",this.onChangeThickness,this)},updateSizeAndPosition:function(){this.updateSize(),this.updatePosition()},updateSize:function(){this.$text.css({maxWidth:(this.$.parent().width()-this.that.x+1)/this.scale,maxHeight:(this.$.parent().height()-this.that.y+1)/this.scale})},updatePosition:function(){var bounds=this.bounds();this.that.x-=Math.max(0,this.that.x-bounds[2]),this.that.y-=Math.max(0,this.that.y-bounds[3]),this.$.css({left:this.that.x,top:this.that.y})},bounds:function(){var $stage=this.$.parents(".annotations-stage");return[0,0,$stage.width()-this.$.outerWidth()*this.scale,$stage.height()-this.$.outerHeight()*this.scale]},askToTrash:function(e){var $dialog=$('<div class="text-trash-confirm-popup modal hide" tabindex="-1" role="dialog" aria-labelledby="tip" aria-hidden="true"><div class="modal-header"><button type="button" class="close gui-fancy" data-dismiss="modal" aria-hidden="true"></button><h3>'+this.i18n("textTrashQuestionTitle")+'</h3></div><div class="modal-body"><p>'+this.i18n("textTrashQuestion")+'</p></div><div class="modal-footer"><button class="btn btn-ok" data-dismiss="modal" aria-hidden="true">'+this.i18n("textTrashOKLabel")+'</button><button class="btn btn-cancel" data-dismiss="modal" aria-hidden="true">'+this.i18n("textTrashCancelLabel")+"</button></div></div>");$dialog.on("hidden.bs.modal",function(){$dialog.remove()}),$dialog.on("click",".btn-ok",function(){this.feature.remove()}.bind(this)),$dialog.draggable({}),$dialog.modal({})},focus:function(){_.defer(_.bind(this.$text.focus,this.$text))},enterFocus:function(silent){this.$.is(".focused")||("text"!==a5a.current.tool.name&&a5a.useTool("text"),this.$text.focus())},flagFocus:function(e){"text"==a5a.current.tool.name&&a5a.current.tool.restore({size:this.that.toolSnapshot.size,color:this.that.toolSnapshot.color}),this.$.addClass("focused"),$("body").addClass("isInputing"),this.$text.html(this.that.content),this.updateSize()},onBlur:function(e){this.$.removeClass("focused"),$("body").removeClass(" isInputing"),this.persistContent()},persistContent:function(){var content=this.getContent();this.that.content!==content&&(a5a.history.expectChange(this.feature.drawing),this.that.content=content,a5a.current.changed(!0),a5.eventBus.trigger("book:text_updated"))},moveStart:function(ev,ui){ev.stopPropagation(),a5a.useTool("text"),this.cursorPosition={x:ev.clientX,y:ev.clientY},a5a.history.expectChange(this.feature.drawing)},moveDrag:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var changeLeft=ev.clientX-this.cursorPosition.x,changeTop=ev.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+changeLeft)/this.zoomScale),newTop=Math.round((ui.originalPosition.top+changeTop)/this.zoomScale),bounds=this.bounds();ui.position.left=this.that.x=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=this.that.y=Math.min(Math.max(newTop,bounds[1]),bounds[3])}this.updatePosition()},moveEnd:function(ev,ui){ui&&(ev.stopPropagation(),this.that.startX=ui.position.left,this.that.startY=ui.position.top,this.feature.isExportable&&a5a.current.changed(!0))},onInput:function(e){},onKeydown:function(e){e.stopPropagation(),$("body.isIE11").length>0&&_.defer(this.onInput,e)},onChangeColor:function(color){this.$.is(".content-text-selected")&&(a5a.history.expectChange(this.feature.drawing),this.that.toolSnapshot.color=color.hex,this.$text.css("color",color.hex),_.defer(this.enterFocus))},onChangeThickness:function(thickness){this.$.is(".content-text-selected")&&(a5a.history.expectChange(this.feature.drawing),this.that.toolSnapshot.size=thickness.size,this.$text.css("font-size",thickness.size+"px"),this.updateSize(),_.defer(this.enterFocus))}}),a5.Annotations.V.extend("a5.Annotations.Content.LinkView",{template:"a5.book.annotations.Link",longPressTime:500,init:function(that,feature){this._super(that),_.bindAll(this,"updateSizeAndPosition","enterFocus","flagFocus","onBlur","resize","moveStart","moveDrag","moveEnd","expandHint","sizeDrag","sizeEnd","onLongPress","onTap","onContextMenuExpander"),this.feature=feature,this.$=$("<div>",{class:"content content-link"}),this.hammerManager=new Hammer.Manager(this.$[0],{recognizers:[[Hammer.Press,{time:this.longPressTime}],[Hammer.Tap]]})},open:function(){a5.mainBuilder.engine.invoke("open-link",this.that.content)},render:function(){if(a5a.stage.view.$current){var html=a5.service.templates.render(this.template,this.serializeData());this.$.html($(html).html());var originalTransform;this.$.children().find(".tooltip").each(function(_,el){$(el).parent().delayedTooltip({delay:a5.dp.config.bookTooltipDelay,duration:a5.dp.config.bookTooltipDuration,start:function($tooltip){originalTransform=$tooltip.css("transform");var scale=a5a.current.view.zoom();$tooltip.closest(".wrap").length&&(scale*=parseFloat($tooltip.closest(".wrap").css("transform").split(",")[3])),$tooltip.css("transform","");var transform=$tooltip.css("transform")
;transform="none"===transform?"":" "+transform,$tooltip.css("transform","scale("+1/scale+")"+transform)}.bind(this),end:function($tooltip){$tooltip.css("transform",originalTransform)},container:function(){return this.$.closest(".pages-wrapper")}.bind(this)})}.bind(this)),this.$.toggleClass("collapsed",this.that.isCollapsed),this.$wrap=this.$.find(".wrap"),this.$text=this.$.find(".text"),this.$expander=this.$.find(".expander"),this.feature.isExportable&&"link"===a5a.toolbox.selected.name?this.enableEditable():this.disableEditable(),this.$.appendTo(a5a.stage.view.$current);var scale=a5a.stage.view.$current[0].ratio;if(void 0===this.that.width||void 0===this.that.height){this.that.width=a5a.config.defaultLinkSize[0]*scale,this.that.height=a5a.config.defaultLinkSize[1]*scale;var bounds=this.bounds();this.that.x-=Math.max(0,this.that.x-bounds[2]),this.that.y-=Math.max(0,this.that.y-bounds[3])}this.$[0].annotationsFeature=this.feature,this.enableDraggable(),this.$wrap.css({transform:"scale("+scale+")","transform-origin":"left top"}),this.updateSizeAndPosition(),this.bindEvents(),a5.eventBus.trigger("book:link_added")}},enableDraggable:function(){this.$.draggable({cancel:".resize-handle, .text, .toolbar :not(.handle)",handle:".handle"})},enableEditable:function(){this.$text.attr("contentEditable",!0)},disableEditable:function(){this.$text.attr("contentEditable",!1)},serializeData:function(){return{text:this.that.content,expandHint:this.i18n(this.expandHint),handleHint:this.i18n("linkHandleHint"),trashHint:this.i18n("linkTrashHint"),isResizable:!0}},preview:function(point){this.that.x=Math.min(Math.max(this.that.x,this.that.startX),point.x),this.that.y=Math.min(Math.max(this.that.y,this.that.startY),point.y),this.that.width=Math.abs(point.x-this.that.startX),this.that.height=Math.abs(point.y-this.that.startY),this.updateSizeAndPosition()},postview:function(point){this.that.startX=this.that.x,this.that.startY=this.that.y,this.updateSizeAndPosition(),this.focus()},bindEvents:function(){this.hammerManager.off("press tap"),this.hammerManager.on("press",this.onLongPress),this.hammerManager.on("tap",this.onTap),this.$.on("contextmenu",this.onContextMenuExpander).on("focus",".text",this.flagFocus).on("keydown",function(e){e.stopPropagation()}).on("blur",".text",this.onBlur).on("mousedown",".resize-handle",this.resize).on("dragstart",this.moveStart).on("drag",this.moveDrag).on("dragstop",this.moveEnd),$(window).on("resize",_.debounce(this.updateSizeAndPosition,600))},getSize:function(){return{width:this.$.width()||this.that.width,height:this.$.height()||this.that.height}},bounds:function(){var $stage=this.$.parents(".annotations-stage"),noteSize=this.getSize();return[0,0,$stage.width()-noteSize.width,$stage.height()-noteSize.height]},focus:function(e){this.$text.is(":focus")||_.defer(_.bind(this.$text.focus,this.$text)),e&&e.stopPropagation()},enterFocus:function(e){this.$.is(".focused")||!($(e.target).closest(".text, .content").length>0)&&$(e.target).is(":outside(.text)")||(a5a.useTool("link"),this.$text.focus())},updateSizeAndPosition:function(){this.$.css({height:this.that.height,width:this.that.width,left:this.that.x,top:this.that.y}),this.$wrap.css({height:this.that.height/a5a.stage.view.$current[0].ratio,width:this.that.width/a5a.stage.view.$current[0].ratio}),this.that.isCollapsed?(this.$.css({"min-height":"","min-width":""}),this.$wrap.css({"min-height":"","min-width":""})):a5a.config.minStickyNoteSize&&(this.$.css({"min-height":a5a.config.minStickyNoteSize*a5a.stage.view.$current[0].ratio,"min-width":a5a.config.minStickyNoteSize*a5a.stage.view.$current[0].ratio}),this.$wrap.css({"min-height":a5a.config.minStickyNoteSize,"min-width":a5a.config.minStickyNoteSize})),this.updateMaxSize(),this.$.show()},updateMaxSize:function(){this.bounds();this.$wrap.css({maxWidth:(this.$.parent().width()-this.that.x)/this.scale,maxHeight:(this.$.parent().height()-this.that.y)/this.scale})},expandCollapse:function(e){a5a.history.expectChange(this.$[0].annotationsFeature.drawing),this.that.isCollapsed=!this.that.isCollapsed,this.$.toggleClass("collapsed",this.that.isCollapsed),this.toggleToolbar(!1),this.$expander.find(".tooltip").length?this.$expander.find(".tooltip").text(this.i18n(this.expandHint)):this.$expander.attr("title",this.i18n(this.expandHint));var bounds=this.bounds();this.that.x=Math.min(Math.max(this.that.x,bounds[0]),bounds[2]),this.that.y=Math.min(Math.max(this.that.y,bounds[1]),bounds[3]),this.updateSizeAndPosition(),this.that.isCollapsed||this.focus(),this.feature.isExportable&&a5a.current.changed(!0)},askToTrash:function(e){var $dialog=$('<div class="link-trash-confirm-popup modal hide" tabindex="-1" role="dialog" aria-labelledby="tip" aria-hidden="true"><div class="modal-header"><button type="button" class="close gui-fancy" data-dismiss="modal" aria-hidden="true"></button><h3>'+this.i18n("linkTrashQuestionTitle")+'</h3></div><div class="modal-body"><p>'+this.i18n("linkTrashQuestion")+'</p></div><div class="modal-footer"><button class="btn btn-ok" data-dismiss="modal" aria-hidden="true">'+this.i18n("linkTrashOKLabel")+'</button><button class="btn btn-cancel" data-dismiss="modal" aria-hidden="true">'+this.i18n("linkTrashCancelLabel")+"</button></div></div>");$dialog.on("hidden.bs.modal",function(){$dialog.remove()}),$dialog.on("click",".btn-ok",function(){this.feature.remove()}.bind(this)),$dialog.draggable({}),$dialog.modal({})},flagFocus:function(e){this.$.addClass("focused"),$("body").addClass("isInputing"),this.$text.text(this.that.content),this.$.on("mousewheel",this.onMouseWheel)},onBlur:function(e){this.$.removeClass("focused"),$("body").removeClass(" isInputing"),this.persistContent(),this.$.off("mousewheel",this.onMouseWheel)},onMouseWheel:function(e){e.stopPropagation()},persistContent:function(e){var content=this.$text.text();this.that.content!==content&&(a5a.history.expectChange(this.feature.drawing),this.that.content=content,a5a.current.changed(!0),a5.eventBus.trigger("book:link_updated"))},expandHint:function(){return this.that.isCollapsed?"linkExpandHint":"linkCollapseHint"},toggleToolbar:function(active){this.$.toggleClass("with-toolbar",active)},moveStart:function(ev,ui){var hammerPan=a5a.intView.pages.scroller.node.data("hammer").get("pan");this.panEnabled=hammerPan.options.enable,hammerPan.set({enable:!1}),ev.stopPropagation(),this.cursorPosition={x:ev.clientX,y:ev.clientY},a5a.history.expectChange(this.feature.drawing)},moveDrag:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var changeLeft=ev.clientX-this.cursorPosition.x,changeTop=ev.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+changeLeft)/this.zoomScale),newTop=Math.round((ui.originalPosition.top+changeTop)/this.zoomScale),bounds=this.bounds();ui.position.left=this.that.x=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=this.that.y=Math.min(Math.max(newTop,bounds[1]),bounds[3])}},moveEnd:function(ev,ui){if(ui){ev.stopPropagation(),this.that.startX=ui.position.left,this.that.startY=ui.position.top;a5a.intView.pages.scroller.node.data("hammer").get("pan").set({enable:this.panEnabled}),this.feature.isExportable&&a5a.current.changed(!0)}},resize:function(e){if(e.button===a5a.current.view.LEFT_BUTTON)return a5a.stage.view.$current.addClass("isDrawing"),a5a.history.expectChange(this.feature.drawing),$(document).unbind(".resize"),$(document).bind("mousemove.resize",this.sizeDrag),$(document).bind("mouseup.resize",this.sizeEnd),!!e.preventDefault()},sizeDrag:function(e){var target=this.$.parents(".annotations-stage").find(".annotations-drawable")[0],x=a5a.current.view.coord(e,"x",target),y=a5a.current.view.coord(e,"y",target);this.preview(new a5.Annotations.Point(x,y))},sizeEnd:function(e){a5a.stage.view.$.removeClass("isDrawing"),this.that.startX=this.that.x,this.that.startY=this.that.y,$(document).unbind(".resize"),this.feature.isExportable&&a5a.current.changed(!0)},onLongPress:function(e){$(e.target).closest(".toolbar").length>0||(this.that.isCollapsed?this.toggleToolbar():this.toggleToolbar(!1))},onTap:function(e){var $target=$(e.target);$target.closest(".expander").length>0?this.expandCollapse(e):$target.closest(".trash").length>0?this.askToTrash(e):this.that.isCollapsed&&!$target.closest(".toolbar").length&&this.open(),this.that.isCollapsed?$("body").removeClass("isInputing"):this.enterFocus(e)},onContextMenuExpander:function(e){this.that.isCollapsed?this.toggleToolbar(!0):this.toggleToolbar(!1)}}),a5.Annotations.V.extend("a5.Annotations.Content.BlockView",{template:"a5.book.annotations.StickyNote",longPressTime:500,init:function(that,feature){this._super(that),_.bindAll(this,"toggleShare","updateSizeAndPosition","flagFocus","persistContent","persistTitle","resize","moveStart","moveDrag","moveEnd","expandHint","shareHint","sharingChangeAnnouncement","trashQuestion","trashQuestionTitle","sizeDrag","sizeEnd","onLongPress","onTap","onContextMenuExpander"),this.feature=feature,this.$=$("<div>",{class:"content content-sticky-note default"}),this.hammerManager=new Hammer.Manager(this.$[0],{recognizers:[[Hammer.Press,{time:this.longPressTime}],[Hammer.Tap]]})},render:function(){if(a5a.stage.view.$current){var html=a5.service.templates.render(this.template,this.serializeData());this.$.html($(html).html());var originalTransform;this.$.children().find(".tooltip").each(function(_,el){$(el).parent().delayedTooltip({delay:a5.dp.config.bookTooltipDelay,duration:a5.dp.config.bookTooltipDuration,start:function($tooltip){originalTransform=$tooltip.css("transform");var scale=a5a.current.view.zoom();$tooltip.closest(".wrap").length&&(scale*=parseFloat($tooltip.closest(".wrap").css("transform").split(",")[3])),$tooltip.css("transform","");var transform=$tooltip.css("transform");transform="none"===transform?"":" "+transform,$tooltip.css("transform","scale("+1/scale+")"+transform)}.bind(this),end:function($tooltip){$tooltip.css("transform",originalTransform)},container:function(){return this.$.closest(".pages-wrapper")}.bind(this)})}.bind(this)),this.$.toggleClass("collapsed",this.that.isCollapsed),this.$.toggleClass("locked",!this.feature.isExportable),this.$.toggleClass("locking",this.feature.lock),this.$.css("background-color",this.that.toolSnapshot.color),this.$wrap=this.$.find(".wrap"),this.$text=this.$.find(".text"),this.$title=this.$.find(".title"),this.$expander=this.$.find(".expander"),this.$sharer=this.$.find(".share"),this.feature.isExportable&&"sticky note"===a5a.toolbox.selected.name?this.enableEditable():this.disableEditable(),this.$.appendTo(a5a.stage.view.$current);var scale=a5a.stage.view.$current[0].ratio;if(void 0===this.that.width||void 0===this.that.height){this.that.width=a5a.config.defaultStickyNoteSize*scale,this.that.height=a5a.config.defaultStickyNoteSize*scale;var bounds=this.bounds();this.that.x-=Math.max(0,this.that.x-bounds[2]),this.that.y-=Math.max(0,this.that.y-bounds[3])}this.$[0].annotationsFeature=this.feature,this.enableDraggable(),this.$wrap.css({transform:"scale("+scale+")","transform-origin":"left top"}),this.updateSizeAndPosition(),this.bindEvents(),this.$text.linkify(),a5.eventBus.trigger("book:sticky_note_added")}},enableDraggable:function(){this.$.draggable({cancel:".resize-handle, .title, .text, .toolbar :not(.handle)",handle:".handle"})},enableEditable:function(){this.$text.attr("contentEditable",!0),this.$title.attr("contentEditable",!0)},disableEditable:function(){this.$text.attr("contentEditable",!1),this.$title.attr("contentEditable",!1)},serializeData:function(){return{text:this.that.content,title:this.that.title||this.i18n("stickyNoteDefaultTitle"),expandHint:this.i18n(this.expandHint),shareHint:this.i18n(this.shareHint),trashHint:this.i18n("stickyNoteTrashHint"),resizeHint:this.i18n("stickyNoteResizeHint"),isEditable:this.feature.isExportable,isShareable:a5a.current.canLock&&this.feature.isExportable,isResizable:!0,withTitle:a5a.config.stickyNoteWithTitle}},preview:function(point){this.that.x=Math.min(Math.max(this.that.x,this.that.startX),point.x),this.that.y=Math.min(Math.max(this.that.y,this.that.startY),point.y),this.that.width=Math.abs(point.x-this.that.startX),this.that.height=Math.abs(point.y-this.that.startY),(!this.$.is(".default")||Math.max(this.that.width,this.that.height)>a5a.config.stickyNoteThreshold)&&(this.$.removeClass("default"),this.updateSizeAndPosition())},postview:function(point){this.that.startX=this.that.x,this.that.startY=this.that.y,this.updateSizeAndPosition(),this.focus()},bindEvents:function(){this.hammerManager.off("press tap"),this.hammerManager.on("press",this.onLongPress),this.hammerManager.on("tap",this.onTap),this.$.on("contextmenu",this.onContextMenuExpander).on("click",".share",this.toggleShare).on("focus",".text",this.flagFocus).on("focus",".title",this.flagFocus).on("keydown",function(e){e.stopPropagation()}).on("blur",".text",this.persistContent).on("blur",".title",this.persistTitle).on("mousedown",".resize-handle",this.resize).on("dragstart",this.moveStart).on("drag",this.moveDrag).on("dragstop",this.moveEnd),this.$text.on("click","a",function(e){e.preventDefault(),a5.mainBuilder.engine.invoke("open-link",e.target.href)}),$(window).on("resize",_.debounce(this.updateSizeAndPosition,600))},getSize:function(){return{width:this.$.width()||this.that.width,height:this.$.height()||this.that.height}},bounds:function(){var $stage=this.$.parents(".annotations-stage"),noteSize=this.getSize();return[0,0,$stage.width()-noteSize.width-a5a.config.stickyNoteBorder,$stage.height()-noteSize.height-a5a.config.stickyNoteBorder]},focus:function(e){this.$text.is(":focus")||_.defer(_.bind(this.$text.focus,this.$text)),e&&e.stopPropagation()},updateSizeAndPosition:function(){this.$.css({height:this.that.height,width:this.that.width,left:this.that.x,top:this.that.y}),this.$wrap.css({height:this.that.height/a5a.stage.view.$current[0].ratio,width:this.that.width/a5a.stage.view.$current[0].ratio}),this.that.isCollapsed?(this.$.css({"min-height":"","min-width":""}),this.$wrap.css({"min-height":"","min-width":""})):a5a.config.minStickyNoteSize&&(this.$.css({"min-height":a5a.config.minStickyNoteSize*a5a.stage.view.$current[0].ratio,"min-width":a5a.config.minStickyNoteSize*a5a.stage.view.$current[0].ratio}),this.$wrap.css({"min-height":a5a.config.minStickyNoteSize,"min-width":a5a.config.minStickyNoteSize})),this.$.show()},expandCollapse:function(e){a5a.history.expectChange(this.$[0].annotationsFeature.drawing),this.that.isCollapsed=!this.that.isCollapsed,this.$.toggleClass("collapsed",this.that.isCollapsed),this.toggleToolbar(!1),this.$expander.find(".tooltip").length?this.$expander.find(".tooltip").text(this.i18n(this.expandHint)):this.$expander.attr("title",this.i18n(this.expandHint));var bounds=this.bounds();this.that.x=Math.min(Math.max(this.that.x,bounds[0]),bounds[2]),this.that.y=Math.min(Math.max(this.that.y,bounds[1]),bounds[3]),this.updateSizeAndPosition(),this.feature.isExportable&&a5a.current.changed(!0)},askToTrash:function(e){var $dialog=$('<div class="stickynote-trash-confirm-popup modal hide" tabindex="-1" role="dialog" aria-labelledby="tip" aria-hidden="true"><div class="modal-header"><button type="button" class="close gui-fancy" data-dismiss="modal" aria-hidden="true"></button><h3>'+this.i18n(this.trashQuestionTitle)+'</h3></div><div class="modal-body"><p>'+this.i18n(this.trashQuestion)+'</p></div><div class="modal-footer"><button class="btn btn-ok" data-dismiss="modal" aria-hidden="true">'+this.i18n("stickyNoteTrashOKLabel")+'</button><button class="btn btn-cancel" data-dismiss="modal" aria-hidden="true">'+this.i18n("stickyNoteTrashCancelLabel")+"</button></div></div>");$dialog.on("hidden.bs.modal",function(){$dialog.remove()}),$dialog.on("click",".btn-ok",function(){this.feature.remove()}.bind(this)),$dialog.draggable({}),$dialog.modal({})},toggleShare:function(e){this.$.toggleClass("locking",this.feature.share())},reportSharingChange:function(){alert(this.i18n(this.sharingChangeAnnouncement)),this.$sharer.attr("title",this.i18n(this.shareHint))},enterFocus:function(e){this.$.is(".focused")||$(e.target).is("a")||!($(e.target).closest(".text, .title, .content").length>0)&&$(e.target).is(":outside(.text), :outside(.title)")||(a5a.useTool("sticky note"),$(e.target).is(".title")?this.$title.focus():this.$text.focus())},flagFocus:function(e){$(e.target).is(":outside(.tool-sticky-note)")||(this.$.addClass("focused"),$("body").addClass("isInputing"),this.$text.html(this.that.content),this.$.on("mousewheel",this.onMouseWheel))},persistContent:function(e){this.$.removeClass("focused");var prevContent=this.that.content,curContent=this.$text.html();prevContent!==curContent&&(a5a.history.expectChange(this.feature.drawing),this.that.content=curContent,a5a.current.changed(!0),a5.eventBus.trigger("book:sticky_note_updated")),this.$text.linkify(),this.$.off("mousewheel",this.onMouseWheel)},persistTitle:function(e){this.$.removeClass("focused"),this.that.title!==$(e.target).html()&&(a5a.history.expectChange(this.feature.drawing),this.that.title=$(e.target).html(),a5a.current.changed(!0),a5.eventBus.trigger("book:sticky_note_updated")),this.$.off("mousewheel",this.onMouseWheel)},expandHint:function(){return this.that.isCollapsed?"stickyNoteExpandHint":"stickyNoteCollapseHint"},shareHint:function(){return!0===this.feature.lock?"stickyNoteUnshareHint":"stickyNoteShareHint"},sharingChangeAnnouncement:function(){return this.feature.lock?"stickyNoteShareAnnouncement":"stickyNoteUnshareAnnouncement"},trashQuestion:function(){return this.feature.lock?"stickyNoteSharedTrashQuestion":"stickyNoteTrashQuestion"},trashQuestionTitle:function(){return"stickyNoteTrashQuestionTitle"},toggleToolbar:function(active){this.$.toggleClass("with-toolbar",active)},moveStart:function(ev,ui){var hammerPan=a5a.intView.pages.scroller.node.data("hammer").get("pan");this.panEnabled=hammerPan.options.enable,hammerPan.set({enable:!1}),ev.stopPropagation(),this.cursorPosition={x:ev.clientX,y:ev.clientY},a5a.history.expectChange(this.feature.drawing)},moveDrag:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var changeLeft=ev.clientX-this.cursorPosition.x,changeTop=ev.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+changeLeft)/this.zoomScale),newTop=Math.round((ui.originalPosition.top+changeTop)/this.zoomScale),bounds=this.bounds();ui.position.left=this.that.x=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=this.that.y=Math.min(Math.max(newTop,bounds[1]),bounds[3])}},moveEnd:function(ev,ui){if(ui){ev.stopPropagation(),this.that.startX=ui.position.left,this.that.startY=ui.position.top;a5a.intView.pages.scroller.node.data("hammer").get("pan").set({enable:this.panEnabled}),this.feature.isExportable&&a5a.current.changed(!0)}},resize:function(e){if(e.button===a5a.current.view.LEFT_BUTTON)return a5a.stage.view.$current.addClass("isDrawing"),a5a.history.expectChange(this.feature.drawing),$(document).unbind(".resize"),$(document).bind("mousemove.resize",this.sizeDrag),$(document).bind("mouseup.resize",this.sizeEnd),!!e.preventDefault()},sizeDrag:function(e){this.$.removeClass("default");var target=this.$.parents(".annotations-stage").find(".annotations-drawable")[0],x=a5a.current.view.coord(e,"x",target),y=a5a.current.view.coord(e,"y",target);this.preview(new a5.Annotations.Point(x,y))},sizeEnd:function(e){a5a.stage.view.$.removeClass("isDrawing"),this.that.startX=this.that.x,this.that.startY=this.that.y,$(document).unbind(".resize"),this.feature.isExportable&&a5a.current.changed(!0)},onLongPress:function(e){$(e.target).closest(".toolbar").length>0||(this.that.isCollapsed?this.toggleToolbar():this.toggleToolbar(!1))},onTap:function(e){var $target=$(e.target);$target.closest(".expander").length>0?this.expandCollapse(e):$target.closest(".trash").length>0?this.askToTrash(e):this.that.isCollapsed&&!$target.closest(".toolbar").length&&this.expandCollapse(e),this.that.isCollapsed?$("body").removeClass("isInputing"):this.enterFocus(e)},onContextMenuExpander:function(e){this.that.isCollapsed?this.toggleToolbar(!0):this.toggleToolbar(!1)},onMouseWheel:function(e){e.stopPropagation()}}),a5.Annotations.V.extend("a5.Annotations.Content.BlockOutView",{init:function(that,feature){this._super(that),_.bindAll(this,"updateSizeAndPosition"),this.feature=feature,this.$=void 0,this.render()},render:function(){if(!this.$){if(this.$=$("<div>",{class:"content content-block-out"}).appendTo(a5a.stage.view.$current),this.$top=$("<div>",{class:"block-out top"}).appendTo(this.$),this.$left=$("<div>",{class:"block-out left"}).appendTo(this.$),this.$right=$("<div>",{class:"block-out right"}).appendTo(this.$),this.$bottom=$("<div>",{class:"block-out bottom"}).appendTo(this.$),this.$others=$(),a5a.stage.view.$.length>1){var that=this;a5a.stage.view.$.not(function(){return this==a5a.stage.view.$current[0]}).each(function(){that.$others=that.$others.add($("<div>",{class:"content content-block-out complete"}).appendTo($(this)))})}this.$[0].annotationsFeature=this.feature,_.defer(this.updateSizeAndPosition)}},preview:function(point){this.that.x=Math.min(Math.max(this.that.x,this.that.startX),point.x),this.that.y=Math.min(Math.max(this.that.y,this.that.startY),point.y),this.that.width=Math.abs(point.x-this.that.startX),this.that.height=Math.abs(point.y-this.that.startY),this.updateSizeAndPosition()},postview:function(point){this.that.width||this.that.height||this.feature.remove()},updateSizeAndPosition:function(){this.$.css({height:this.that.height,width:this.that.width,left:this.that.x,top:this.that.y}),this.$.show()}}),a5.Annotations.V.extend("a5.Annotations.Content.InverseMaskView",{init:function(that,feature){this._super(that),_.bindAll(this,"updateSizeAndPosition","moveStart","moveDrag","moveEnd","onClickClose","onClickOutside","resizeStart","resize","resizeEnd"),this.feature=feature,this.$=void 0},render:function(){if(a5a.stage.view.$current){if(this.$=$("<div>",{class:"content content-inverse-mask"}),this.$.appendTo(a5a.stage.view.$current),this.$close=$("<div>",{class:"close"}).appendTo(this.$),this.$top=$("<div>",{class:"inverse-mask-out top"}).appendTo(this.$),this.$left=$("<div>",{class:"inverse-mask-out left"}).appendTo(this.$),this.$right=$("<div>",{class:"inverse-mask-out right"}).appendTo(this.$),this.$bottom=$("<div>",{class:"inverse-mask-out bottom"}).appendTo(this.$),void 0===this.that.width||void 0===this.that.height){this.that.width=a5a.config.defaultMaskSize*a5a.stage.view.$current[0].ratio,this.that.height=a5a.config.defaultMaskSize*a5a.stage.view.$current[0].ratio;var bounds=this.bounds();this.that.x-=Math.max(0,this.that.x-bounds[2]),this.that.y-=Math.max(0,this.that.y-bounds[3])}this.$[0].annotationsFeature=this.feature,this.$.resizable().draggable({cancel:".inverse-mask-out, .close"});var page=a5a.intView.model.pages[a5a.stage.drawing.annotation];a5.hooks.ppebookInverseMaskRendered.call(this,{x:this.that.x,y:this.that.y,url:page.url}),this.updateSizeAndPosition(),this.bindEvents()}},preview:function(point){},postview:function(point){},bindEvents:function(){this.$.on("click",".close",this.onClickClose).on("click",".inverse-mask-out",this.onClickOutside).on("dragstart",this.moveStart).on("drag",this.moveDrag).on("dragstop",this.moveEnd).on("resizestart",this.resizeStart).on("resize",this.resize).on("resizestop",this.resizeEnd)},bounds:function(){var $stage=this.$.parents(".annotations-stage");return[0,0,$stage.width()-this.that.width,$stage.height()-this.that.height]},updateSizeAndPosition:function(){this.$.css({height:this.that.height,width:this.that.width,left:this.that.x,top:this.that.y}),this.$.show()},close:function(){a5.hooks.ppebookInverseMaskClose.call(this),this.feature.remove()},onClickClose:function(e){e.stopPropagation(),this.close()},onClickOutside:function(e){e.stopPropagation(),this.close()},moveStart:function(ev,ui){ev.stopPropagation(),this.cursorPosition={x:ev.clientX,y:ev.clientY},a5a.history.expectChange(this.feature.drawing)},moveDrag:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var changeLeft=ev.clientX-this.cursorPosition.x,changeTop=ev.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+changeLeft)/this.zoomScale),newTop=Math.round((ui.originalPosition.top+changeTop)/this.zoomScale),bounds=this.bounds();ui.position.left=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=Math.min(Math.max(newTop,bounds[1]),bounds[3]),a5.hooks.ppebookInverseMaskDragging.call(this,{x:ui.position.left,y:ui.position.top})}},moveEnd:function(ev,ui){ui&&(ev.stopPropagation(),this.that.startX=this.that.x=ui.position.left,this.that.startY=this.that.y=ui.position.top,this.feature.isExportable&&a5a.current.changed(!0))},resizeStart:function(ev,ui){a5a.stage.view.$current.addClass("isDrawing"),a5a.history.expectChange(this.feature.drawing)},resize:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var deltaX=ui.size.width-ui.originalSize.width,deltaY=ui.size.height-ui.originalSize.height,newWidth=ui.originalSize.width+deltaX/this.zoomScale,newHeight=ui.originalSize.height+deltaY/this.zoomScale,$stage=this.$.parents(".annotations-stage");ui.originalPosition.left+newWidth>$stage.width()&&(newWidth=$stage.width()-ui.originalPosition.left),ui.originalPosition.top+newHeight>$stage.height()&&(newHeight=$stage.height()-ui.originalPosition.top),ui.size.width=newWidth,ui.size.height=newHeight}},resizeEnd:function(ev,ui){this.that.width=ui.size.width,this.that.height=ui.size.height,a5a.stage.view.$.removeClass("isDrawing"),this.feature.isExportable&&a5a.current.changed(!0)}}),a5.Annotations.V.extend("a5.Annotations.Content.MaskView",{init:function(that,feature){this._super(that),_.bindAll(this,"updateSizeAndPosition","moveStart","moveDrag","moveEnd","resizeStart","resizeEnd","onClickClose","resize"),this.feature=feature,this.$=void 0},render:function(){if(a5a.stage.view.$current){if(this.$=$("<div>",{class:"content content-mask"}),this.$.appendTo(a5a.stage.view.$current),this.$close=$("<div>",{class:"close"}).appendTo(this.$),this.$effects=$("<div>",{class:"effects"}).appendTo(this.$),void 0===this.that.width||void 0===this.that.height){this.that.width=a5a.config.defaultMaskSize*a5a.stage.view.$current[0].ratio,this.that.height=a5a.config.defaultMaskSize*a5a.stage.view.$current[0].ratio;var bounds=this.bounds();this.that.x-=Math.max(0,this.that.x-bounds[2]),this.that.y-=Math.max(0,this.that.y-bounds[3])}this.$[0].annotationsFeature=this.feature,this.$.resizable().draggable({cancel:".close"});var page=a5a.intView.model.pages[a5a.stage.drawing.annotation];a5.hooks.ppebookMaskRendered.call(this,{x:this.that.x,y:this.that.y,url:page.url}),this.updateSizeAndPosition(),this.bindEvents()}},preview:function(point){},postview:function(point){},bindEvents:function(){this.$.on("click",".close",this.onClickClose).on("dragstart",this.moveStart).on("drag",this.moveDrag).on("dragstop",this.moveEnd).on("resizestart",this.resizeStart).on("resize",this.resize).on("resizestop",this.resizeEnd)},bounds:function(){var $stage=this.$.parents(".annotations-stage");return[0,0,$stage.width()-this.that.width,$stage.height()-this.that.height]},updateSizeAndPosition:function(){this.$.css({height:this.that.height,width:this.that.width,left:this.that.x,top:this.that.y}),this.$.css("display","")},close:function(){a5.hooks.ppebookMaskClose.call(this),this.feature.remove()},onClickClose:function(e){e.stopPropagation(),this.close()},moveStart:function(ev,ui){ev.stopPropagation(),this.cursorPosition={x:ev.clientX,y:ev.clientY},a5a.history.expectChange(this.feature.drawing)},moveDrag:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var changeLeft=ev.clientX-this.cursorPosition.x,changeTop=ev.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+changeLeft)/this.zoomScale),newTop=Math.round((ui.originalPosition.top+changeTop)/this.zoomScale),bounds=this.bounds();ui.position.left=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=Math.min(Math.max(newTop,bounds[1]),bounds[3]),a5.hooks.ppebookMaskDragging.call(this,{x:ui.position.left,y:ui.position.top})}},moveEnd:function(ev,ui){ui&&(ev.stopPropagation(),this.that.startX=this.that.x=ui.position.left,this.that.startY=this.that.y=ui.position.top,this.feature.isExportable&&a5a.current.changed(!0))},resizeStart:function(ev,ui){a5a.stage.view.$current.addClass("isDrawing"),a5a.history.expectChange(this.feature.drawing)},resize:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var deltaX=ui.size.width-ui.originalSize.width,deltaY=ui.size.height-ui.originalSize.height,newWidth=ui.originalSize.width+deltaX/this.zoomScale,newHeight=ui.originalSize.height+deltaY/this.zoomScale,$stage=this.$.parents(".annotations-stage");ui.originalPosition.left+newWidth>$stage.width()&&(newWidth=$stage.width()-ui.originalPosition.left),ui.originalPosition.top+newHeight>$stage.height()&&(newHeight=$stage.height()-ui.originalPosition.top),ui.size.width=newWidth,ui.size.height=newHeight}},resizeEnd:function(ev,ui){this.that.width=ui.size.width,this.that.height=ui.size.height,a5a.stage.view.$.removeClass("isDrawing"),this.feature.isExportable&&a5a.current.changed(!0)}}),a5.Annotations.V.extend("a5.Annotations.KeyboardEventsView",{init:function(that){this._super(that);var key=a5a.config.i18nKey();this.$node=a5a.toolbox.view.$,this.$node.on(key.toolCursor,this._onToolCursor.bind(this)),this.$node.on(key.toolPen,this.clickOn("#annotations-toolbox .tool-pen")),this.$node.on(key.toolHighlighter,this.clickOn("#annotations-toolbox .tool-highlighter")),this.$node.on(key.toolEraser,this.clickOn("#annotations-toolbox .tool-eraser")),this.$node.on(key.toolStickyNote,this.clickOn("#annotations-toolbox .tool-sticky-note")),this.$node.on(key.toolSpotlight,this.clickOn("#annotations-toolbox .tool-spotlight")),this.$node.on(key.toolHide,this.clickOn("#annotations-toolbox .tool-hide")),this.$node.on(key.toolShow,this.clickOn("#annotations-toolbox .tool-hide"))},clickOn:function(domSelector,beforeClicks,quiet){return _.bind(function(e){_.each(beforeClicks,function(selector){$(selector).trigger("click",quiet)}),$(domSelector).focus(),setTimeout(function(){$(domSelector).trigger("click",quiet)},a5a.config.focusToClickDelay)},this)},_onToolCursor:function(e){this.clickOn("#annotations-toolbox .tool-cursor",void 0,!0).call(this,e)}}),a5.SimpleAudioPlayer={volume:1,state:"stopped",playingIndex:0,playing:null,init:function(){this.queue=[]},createAudio:function(url){var audio=new Audio;return audio.volume=this.volume,audio.canPlayType("audio/mpeg;")?audio.src=url+".mp3":audio.src=url+".ogg",$(audio).bind("ended",_.bind(this.playNext,this)).bind("play",_.bind(this.setState,this,"playing")).bind("pause",_.bind(this.setState,this,"paused")).bind("timeupdate",_.bind(this.timeUpdate,this)),audio},enque:function(url){url=url.replace(/\.\w+$/,""),this.queue.push(url)},playFirst:function(){this.playAt(0)},playAt:function(index){this.stop(),index>=0&&index<this.queue.length&&(this.playingIndex=index,this.playing=this.createAudio(this.queue[this.playingIndex]),this.playing.play())},playNext:function(){this.playAt(this.playingIndex+1)},playPrevious:function(){this.playAt(this.playingIndex-1)},play:function(){this.playing?this.playing.play():this.playAt(0)},pause:function(){this.playing&&this.playing.pause()},stop:function(){this.playing&&this.playing.pause(),this.playing=null,this.playingIndex=0,this.setState("stopped")},clear:function(){this.stop(),this.queue=[]},changeVolume:function(value){this.volume=value,this.playing&&(this.playing.volume=value),this.trigger("change_volume")},setState:function(newState){this.state=newState,this.trigger("change_state")},timeUpdate:function(){this.playing?this.trigger("time_update",this.playing.currentTime,this.playing.duration):this.trigger("time_update",NaN,NaN)}},Obj.extend("a5.SimpleAudioPlayer"),
a5.models.interaction.PPAudioBook={init:function(parameters){this._super(parameters,{coverUrl:"",title:null})}},a5.models.interaction.Book.extend("a5.models.interaction.PPAudioBook"),a5.views.interaction.PPAudioBook={template:"audio_book",init:function(model){this._super(model,null,$('<div class="audio-book book"></div>')),this.toolbar=new a5.views.interaction.PPAudioBookToolbar(model,this),this.audioPlayer=this.toolbar.audioPlayer.player,this.audioPlayer.bind("change_state",this.changeActive,this),this.chapters=[]},append:function(title,audio){this.audioPlayer.enque(audio);var index=this.chapters.length,chapter=new a5.views.interaction.PPAudioBookChapter(title);chapter.bind("click",function(){this.openChapter(index)},this),this.chapters.push(chapter)},render:function(){return this._super(),this.node.append(this.toolbar.render()),this.$(".cover-image").attr("src",this.model.coverUrl),_(this.chapters).each(function(chapter){this.$(".chapters").append(chapter.render())},this),this.bindNode("click",".go-next",function(){this.audioPlayer.playNext()}),this.bindNode("click",".go-previous",function(){this.audioPlayer.playPrevious()}),this.node},openChapter:function(index){this.audioPlayer.playAt(index)},changeActive:function(){this.$(".chapter").removeClass("active"),this.audioPlayer.playing&&this.chapters[this.audioPlayer.playingIndex].node.addClass("active")}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPAudioBook"),a5.views.interaction.PPAudioBookToolbar={template:"audio_book_toolbar",init:function(model,parent){this._super(model,parent),this.audioProgress=new a5.views.interaction.BookSlider,this.audioProgress.bind("change",this.changeAudioProgress,this),this.audioPlayer.player.bind("time_update",this.timeUpdate,this)},render:function(){return this._super(),this.$(".time-progress").after(this.audioProgress.render()),this.node},secondsToTime:function(seconds){return isNaN(seconds)?"--:--":a5.utils.secondsToTime(seconds)},timeUpdate:function(current,total){this.audioProgress.setMax(total),this.audioProgress.setTo(current),this.$(".time-progress").text(this.secondsToTime(current)),this.$(".time-total").text(this.secondsToTime(total))},changeAudioProgress:function(){var playing=this.audioPlayer.player.playing;playing&&(playing.currentTime=this.audioProgress.current)}},a5.views.interaction.BookToolbar.extend("a5.views.interaction.PPAudioBookToolbar"),a5.views.interaction.PPAudioBookChapter={init:function(title){this._super(null,null,$('<div class="chapter"></div>')),this.title=title},render:function(){return this._super(),this.node.text(this.title),this.bindNode("click",this.clicked),this.node},clicked:function(){this.trigger("click")}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPAudioBookChapter"),a5.model_builder.PPAudioBook={isResponsible:function($node){return $node.is("audiobook")},buildAudiobook:function(interaction,$parentNode,$node){var model=new a5.models.interaction.PPAudioBook({title:$node.attr("title"),coverUrl:A5.ASSET_URL_BUILDER($node.attr("coverurl"))});interaction.blockItems.add(model);var view=new a5.views.interaction.PPAudioBook(model);_.each($node.find("> chapters > chapter"),function(chapterNode){var $chapter=$(chapterNode);view.append($chapter.attr("title"),$chapter.attr("audio"))},this),this.buildBook($node,view,model),$parentNode.append(view.render()),view.audioPlayer.play()}},a5.model_builder.BookBuilder.extend("a5.model_builder.PPAudioBook"),a5.annotations.Canvas={init:function(options,defaults){this._super(options,$.extend({readOnly:!1},defaults)),this.children=[],this.history=[],this.redoHistory=[]},append:function(child){return this.children.push(child),this.trigger("change:children"),child},savePoint:function(){this.redoHistory=[],this.history.push(this.children.slice(0)),this.trigger("change:history")},setChildren:function(children){this.children=children,this.trigger("change:children")},undo:function(){this.redoHistory.push(this.children),this.setChildren(this.history.pop()),this.trigger("change:history")},redo:function(){this.history.push(this.children.slice(0)),this.setChildren(this.redoHistory.pop()),this.trigger("change:history")},store:function(){return{children:this.children}},restore:function(data){data&&(this.children=data.children)}},a5.models.interaction.BaseModel.extend("a5.annotations.Canvas"),a5.annotations.CanvasView={init:function(model,$node){this._super(model,null,$node),this.bindEvents()},reset:function(){this.unbindEvents()},clear:function(){this.model.setChildren([])},bindEvents:function(){this.model.bind("change:children",this.repaint,this)},unbindEvents:function(){this.model.unbind("change:children",this.repaint)},render:function(){return this._super(),this.node.toggleClass("read-only",this.model.readOnly),this.paper=this.paper||Raphael(this.node[0],this.node.width(),this.node.height()),this.repaint(),this.$svg=$(this.paper.canvas),this.$svg.off("mousedown").on("mousedown",_.bind(this.mousedown,this)),this.node.off("touchstart").on("touchstart",_.bind(this.touchstart,this)),this.$svg.off("click").on("click",_.bind(this.click,this)),this.node},toRelative:function(x,y){var offset=this.node.offset(),matrix=this.node.transformationMatrix(!0),scale=matrix.getScale();return new Point((x-offset.left)/scale,(y-offset.top)/scale)},triggerTool:function(type,e){this.currentTool.trigger(type,this,this.toRelative(e.pageX,e.pageY))},mousedown:function(e){0===e.button&&(e.preventDefault(),e.stopPropagation(),this.$svg.on("mousemove",_.bind(this.mousemove,this)),this.$svg.on("mouseup mouseleave",_.bind(this.mouseup,this)),this.triggerTool("mousedown",e))},mousemove:function(e){e.preventDefault(),e.stopPropagation(),this.triggerTool("mousemove",e)},mouseup:function(e){0===e.button&&(this.$svg.off("mousemove mouseup mouseleave"),this.triggerTool("mouseup",e))},touchstart:function(e){e.preventDefault(),e.stopPropagation(),this.node.on("touchmove",_.bind(this.touchmove,this)),this.node.on("touchend touchcancel",_.bind(this.touchend,this)),this.triggerTool("mousedown",e.originalEvent.changedTouches[0])},touchmove:function(e){e.preventDefault(),e.stopPropagation(),this.triggerTool("mousemove",e.originalEvent.changedTouches[0])},touchend:function(e){this.node.off("touchmove touchend touchcancel"),this.triggerTool("mouseup",e.originalEvent.changedTouches[0])},click:function(e){0===e.button&&this.triggerTool("click",e)},repaint:function(){this.paper&&(this.paper.clear(),this.node.find(".sticky-note").remove(),_.each(this.model.children,function(child){"sticky-note"==child.type?this.paintNote(child):this.paper.add([child])},this))},paintNote:function(model){var view=new a5.annotations.StickyNoteView(model,this);view.bind("remove",function(){this.model.children=_.without(this.model.children,model),this.repaint()},this),this.node.append(view.render())},setScale:function(scale){this.scale=scale,this.trigger("zoom:change",scale)}},a5.views.interaction.BaseView.extend("a5.annotations.CanvasView"),a5.annotations.ToolbarView={currentButton:null,init:function(model){this._super(model,null,$('<div class="annotations-toolbar"></div>')),this.model.annotationsCanvas.model.bind("change:children",this._onChangeChildren,this),this.buttons={}},setModel:function(model){this.model=model,this.model.annotationsCanvas.model.bind("change:children",this._onChangeChildren,this),_.each(this.buttons,function(button){button.reset(),button.canvas=this.model.annotationsCanvas},this)},store:function(){return _.map(this.buttons,function(button){return button.store?button.store():void 0})},restore:function(data){_.each(data,function(button_data,index){button_data&&this.buttons[index]&&this.buttons[index].restore(button_data)},this)},reset:function(){this.model.annotationsCanvas.model.unbind("change:children",this._onChangeChildren),_.each(this.buttons,function(button){button.reset()},this)},renderToggleButton:function(tool,$node){return this.renderButton(new a5.annotations.ToolbarToggleButtonView($node,tool))},renderButton:function(button){return button.canvas=this.model.annotationsCanvas,button.bind("clicked",function(){this.currentButton&&button.deselects_active&&this.currentButton.deactivate(),button.deactivate&&(this.currentButton=button)},this),button.render(),this.buttons.push(button),button},render:function(){this._super(),this.buttons=[],this.node.empty(),this.node.removeClass("open"),this.$().append(a5.service.templates.render("a5.annotations.Toolbar",{}));var model=this.model.annotationsCanvas.model;this.renderButton(new a5.annotations.OnOff(this.$(".on-off"),model)),this.renderButton(new a5.annotations.ClearAll(this.$(".clear-all"),model)),this.renderButton(new a5.annotations.Undo(this.$(".undo"),model)),this.renderButton(new a5.annotations.Redo(this.$(".redo"),model)),this.renderButton(new a5.annotations.Timer(this.$(".toggle-countdown"),model)),this.renderButton(new a5.annotations.Zoom(this.$(".zoom"),model)),_.each(this.$(".overlay-image"),function(node){this.renderButton(new a5.annotations.OverlayImage($(node),model))},this);var togglebuttons={stickynote:[new a5.annotations.StickyNotes,this.$(".sticky-notes")],pen:[new a5.annotations.Pen,this.$(".pen")],eraser:[a5.dp.config.annotationsUseRealEraser?new a5.annotations.SvgPathEraser:new a5.annotations.Eraser,this.$(".eraser")],brush:[new a5.annotations.Brush,this.$(".brush")],pointer:[new a5.annotations.Pointer,this.$(".pointer")],"straight-line":[new a5.annotations.StraightLine,this.$(".straight-line")]};return _.each(togglebuttons,function(value,key){var button=this.renderToggleButton.apply(this,value);key===a5.dp.config.annotationsDefaultTool&&button.activate()},this),this.node.off("click",".toggle").on("click",".toggle",_.bind(this.toggleTools,this)),this.node.off("click",".zoom").on("click",".zoom",_.bind(this.toggleZoom,this)),this.node},toggleZoom:function(){var $subject=$("#maincontent"),zoomed=this.node.hasClass("zoomed");zoomed?(this.node.removeClass("zoomed"),this.node.off("click",".toggle").on("click",".toggle",_.bind(this.toggleTools,this)),this.enableAll(),this.model.annotationsCanvas.setScale(1),$subject.zoom(1)):(this.node.addClass("zoomed"),this.node.off("click",".toggle"),this.$(".tools .toggle-countdown button").prop("disabled",!0),this.$(".tools .punctuation button").prop("disabled",!0),this.$(".tools .connectives button").prop("disabled",!0),this.model.annotationsCanvas.setScale(2),$subject.zoom(2),this.$(".tools .pointer.tool button").click());var scaledHeight=$subject[0].getBoundingClientRect().height,isScaled=$subject.outerHeight()!==scaledHeight;this.model.$("div.scroll.mCustomScrollbar").css({height:isScaled?scaledHeight:""}),this.model.$("div.scroll.mCustomScrollbar").toggleClass("scaled",isScaled),this.model.$("div.scroll.mCustomScrollbar").mCustomScrollbar("update"),zoomed||this.model.$("div.scroll.mCustomScrollbar").mCustomScrollbar("disable"),$("#micro_controls, #page_controls").toggle(zoomed)},toggleTools:function(){this.$(".tools").toggle(),"none"!=this.$(".tools").css("display")?this.node.addClass("open"):this.node.removeClass("open")},minimizeTools:function(){this.$(".tools").toggle(!1),this.node.removeClass("open")},maximizeTools:function(){this.$(".tools").toggle(!0),this.node.addClass("open")},toolsAreVisible:function(){return this.node.is(".open")},disableAll:function(){this.$(".tools button").prop("disabled",!0),_.each(this.buttons,function(button){button.deactivate&&button.deactivate()},this)},enableAll:function(){_.each(this.buttons,function(button){button.checkEnabled()},this)},_onChangeChildren:function(){this.model.store&&this.model.store(),this.model.model&&this.model.model.store&&this.model.model.store()}},a5.views.interaction.BaseView.extend("a5.annotations.ToolbarView"),a5.annotations.ToolbarButtonView={canvas:null,deselects_active:!1,init:function($node,model){this._super(model,null,$node)},render:function(){return this._super(),this.checkEnabled(),this.node.on("click","button",_.bind(this.clicked,this)),this.node},clicked:function(){this.enabled&&this.activate(),this.checkEnabled()},activate:function(){this.trigger("clicked")},reset:function(){},enabled:function(){return!0},checkEnabled:function(){this.$("button").prop("disabled",!this.enabled())}},a5.views.interaction.BaseView.extend("a5.annotations.ToolbarButtonView"),a5.annotations.ToolbarToggleButtonView={deselects_active:!0,render:function(){return this._super(),this.node.on("click",".color",_.bind(this.setToolColor,this)),this.node.on("click",".shape",_.bind(this.setToolShape,this)),this.$(".color:first").click(),this.$(".shape:first").click(),this.node},store:function(){return{active:this.model.activated,color:this.model.color,shape:this.model.shape,palette_index:this.palette_index}},restore:function(data){if(data.active&&this.activate(),data.shape&&this._setShape(data.shape),data.color){this._setColor(data.color);var color_node=this.node.find(".palette").children().get(data.palette_index);$(color_node).click()}},activate:function(){this._super(),this.node.addClass("active"),this.$(".colors, .shapes").show(),this.model.activate(this.canvas),this.canvas.currentTool=this.model},deactivate:function(){this.model.deactivate(this.canvas);this.canvas.currentTool;this.canvas.currentTool=null,this.node.removeClass("active"),a5.dp.config.annotationsKeepPaletteOpen||this.$(".colors, .shapes").hide()},setToolColor:function(e){e.clientX&&this.activate(),this._setColor($(e.target).css("background-color"),$(e.target).index()),a5.dp.config.annotationsKeepPaletteOpen||this.$(".colors").hide()},_setColor:function(color,palette_index){this.model.color=color,this.palette_index=palette_index},setToolShape:function(e){e.clientX&&this.activate(),this._setShape($(e.target).data("shape"),$(e.target).index()),a5.dp.config.annotationsKeepPaletteOpen||this.$(".shapes").hide()},_setShape:function(shape,palette_index){this.model.shape=shape,this.palette_index=palette_index}},a5.annotations.ToolbarButtonView.extend("a5.annotations.ToolbarToggleButtonView"),a5.annotations.TeacherToolbarView={init:function(model,parent,node){this._super(model,parent,$('<div class="annotations-toggle">')),_.bindAll(this,"onToggle")},render:function(){return this.cleanup(),this.node.on("click",this.onToggle),this._super()},cleanup:function(){this.node.off(),this.node.removeClass("off")},setModel:function(model){this.model=model},onToggle:function(){this.model.annotationsCanvas.node.toggle(),this.node.toggleClass("off")},store:function(){return!this.node.hasClass("off")},restore:function(data){this.node.toggleClass("off",!data)}},a5.views.interaction.BaseView.extend("a5.annotations.TeacherToolbarView"),a5.annotations.MouseTool={activate:function(canvas){this.activated=!0,canvas.$svg.css("pointer-events","visiblePainted"),canvas.node.css("background","rgba(0, 0, 0, 0)"),canvas.node.addClass(this.canvasClass)},deactivate:function(canvas){this.activated=!1,canvas.$svg.css("pointer-events","none"),canvas.node.css("background",""),canvas.node.removeClass(this.canvasClass)}},Obj.extend("a5.annotations.MouseTool"),a5.annotations.Pointer={activate:function(canvas){},deactivate:function(canvas){}},Obj.extend("a5.annotations.Pointer"),a5.annotations.Pen={strokeWidth:2,color:"#000000",canvasClass:"using-pen",init:function(){this.bind("mousedown",this.onStart,this),this.bind("mousemove",this.onMove,this),this.bind("mouseup",this.onEnd,this)},onStart:function(canvas,point){this.currentPathPoints="M"+point.left+","+point.top,this.currentPath=canvas.paper.path(this.currentPathPoints),this.currentPath.attr({stroke:this.color,"stroke-width":this.strokeWidth,"stroke-linecap":"round","stroke-linejoin":"bevel"})},onMove:function(canvas,point){this.currentPathPoints+="L"+point.left+","+point.top,this.currentPath.attr({path:this.currentPathPoints})},onEnd:function(canvas,point){canvas.model.savePoint();var attrs=_.extend(this.currentPath.attrs,{type:"path"});canvas.model.append(attrs)}},a5.annotations.MouseTool.extend("a5.annotations.Pen"),a5.annotations.Brush={strokeWidth:12,canvasClass:"using-brush"},a5.annotations.Pen.extend("a5.annotations.Brush"),a5.annotations.StraightLine={distance:20,strokeWidth:2,color:"#000000",canvasClass:"using-straight-line",init:function(){this.$point=$('<div class="straight-line-anchor-point"></div>'),this.bind("mousedown",this.onStart,this),this.bind("mousemove",this.onMove,this),this.bind("mouseup",this.onEnd,this)},deactivate:function(canvas){this._super(canvas),this.isDragging=!1,this.wasFirstClicked=!1,this.$point.remove()},onStart:function(canvas,point){this.isDragging=!1,this.wasFirstClicked||(canvas.node.append(this.$point),this.$point.css({left:point.left,top:point.top}),this.currentPathStartPoint="M"+point.left+","+point.top,this.currentPath=canvas.paper.path(this.currentPathStartPoint),this.currentPath.attr({stroke:this.color,"stroke-width":this.strokeWidth,"stroke-linecap":"round","stroke-linejoin":"bevel"}),this.origin=point)},onMove:function(canvas,point){var dx=Math.abs(point.left-this.origin.left),dy=Math.abs(point.top-this.origin.top);!this.isDragging&&dx<this.distance&&dy<this.distance||(this.$point.remove(),this.isDragging=!0,this.currentPathPoints=this.currentPathStartPoint+"L"+point.left+","+point.top,this.currentPath.attr({path:this.currentPathPoints}))},onEnd:function(canvas,point){var isSecondClick=!this.isDragging&&this.wasFirstClicked;if(isSecondClick&&(this.$point.remove(),this.currentPathPoints=this.currentPathStartPoint+"L"+point.left+","+point.top,this.currentPath.attr({path:this.currentPathPoints})),this.isDragging||isSecondClick){canvas.model.savePoint();var attrs=_.extend(this.currentPath.attrs,{type:"path"});canvas.model.append(attrs)}this.wasFirstClicked=!this.isDragging&&!this.wasFirstClicked}},a5.annotations.MouseTool.extend("a5.annotations.StraightLine"),a5.annotations.Eraser={canvasClass:"using-eraser",init:function(){this.bind("mousedown mousemove mouseup",this.erase,this)},erase:function(canvas,point){var offset=canvas.$svg.parent().offset(),element=canvas.paper.getElementByPoint(point.left+offset.left-window.pageXOffset,point.top+offset.top-window.pageYOffset);element&&(canvas.model.savePoint(),canvas.model.children=_.reject(canvas.model.children,function(child){return _.isEqual(child.path,element.attr("path"))}),canvas.model.trigger("change:children"))}},a5.annotations.MouseTool.extend("a5.annotations.Eraser"),a5.annotations.SvgPathEraser={strokeWidth:12,canvasClass:"using-eraser",init:function(){this.bind("mousedown",this.onStart,this),this.bind("mousemove",this.onMove,this),this.bind("mouseup",this.onEnd,this)},onStart:function(canvas,point){canvas.model.savePoint(),this.currentPathPoints="M"+point.left+","+point.top,this.currentPath=canvas.paper.path(this.currentPathPoints),this.currentPath.attr({"stroke-opacity":0,"stroke-width":this.strokeWidth,"stroke-linecap":"round","stroke-linejoin":"bevel"})},onMove:function(canvas,point){this.currentPathPoints+="L"+point.left+","+point.top,this.currentPath.attr({path:this.currentPathPoints}),this._erase(canvas)},onEnd:function(canvas,point){this._erase(canvas)},_erase:function(canvas){var newpaths=erase(this._getCurrentPaths(canvas),{points:this._convertToArrayPath(this.currentPath.attr("path")),attrs:this.currentPath.attrs},this.strokeWidth);this._update(canvas,newpaths)},_update:function(canvas,newpaths){var children=[];_(newpaths).each(function(path){var strPath=this._convertToRaphaelStringPath(path.points),p=canvas.paper.path(strPath);p.attr(path.attrs),p.attr("stroke",""),children.push(_.extend(p.attrs,{stroke:path.attrs.stroke,type:"path"}))},this),canvas.model.setChildren(children)},_getCurrentPaths:function(canvas){return _(canvas.model.children).chain().where({type:"path"}).map(function(child){return{attrs:_.omit(child,"path"),points:this._convertToArrayPath(child.path)}},this).value()},_convertToRaphaelStringPath:function(path){return _(path).reduce(function(memo,point,index){return memo+(0===index?"M":"L")+point.join(",")},"")},_convertToArrayPath:function(path){return _(path).map(function(point){return _.rest(point)})}},a5.annotations.MouseTool.extend("a5.annotations.SvgPathEraser"),a5.annotations.ClearAll={activate:function(){this._super(),this.canvas.model.savePoint(),this.canvas.model.setChildren([])}},a5.annotations.ToolbarButtonView.extend("a5.annotations.ClearAll"),a5.annotations.OnOff={activated:!0,activate:function(){this._super(),this.activated=!this.activated,this.updateDomStatus()},updateDomStatus:function(){this.canvas.node.toggle(this.activated),this.node.toggleClass("off",!this.activated)},store:function(){return{active:this.activated}},restore:function(data){this.activated=data.active,this.updateDomStatus()}},a5.annotations.ToolbarButtonView.extend("a5.annotations.OnOff"),a5.annotations.Undo={init:function($node,model){this._super($node,model),this.model.bind("change:history",this.checkEnabled,this)},activate:function(){this._super(),this.model.undo()},enabled:function(){return this.model.history.length>0}},a5.annotations.ToolbarButtonView.extend("a5.annotations.Undo"),a5.annotations.Redo={init:function($node,model){this._super($node,model),this.model.bind("change:history",this.checkEnabled,this)},activate:function(){this._super(),this.canvas.model.redo()},enabled:function(){return this.canvas.model.redoHistory.length>0}},a5.annotations.ToolbarButtonView.extend("a5.annotations.Redo"),a5.annotations.OverlayImage={render:function(){return this._super(),this.$image=this.$("img").detach(),this.node},activate:function(){this._super(),this.$image.parent().length>0?this.$image.detach():this.$image.appendTo($("body")).draggable()},reset:function(){this.$image&&this.$image.remove()}},a5.annotations.ToolbarButtonView.extend("a5.annotations.OverlayImage"),a5.annotations.StickyNotes={canvasClass:"using-sticky-notes",color:"black",shape:"",init:function(){this.bind("click mousedown",this.addNote,this)},addNote:function(canvas,point){canvas.$svg.offset();canvas.model.savePoint(),canvas.model.append({type:"sticky-note",left:point.left,top:point.top,collapsed:!1,content:"",shape:this.shape,color:this.color})}},a5.annotations.MouseTool.extend("a5.annotations.StickyNotes"),a5.annotations.StickyNoteView={init:function(model,canvas){this._super(model,null,$('<div class="sticky-note"></div>')),this.canvas=canvas,this.canvas.bind("zoom:change",_.bind(this._updateScale,this))},render:function(){this._super(),this.node.empty(),this.node.off(),this.node.hasClass("ui-draggable")&&this.node.draggable("destroy"),this.node.hasClass("ui-resizable")&&this.node.resizable("destroy"),this.node.toggleClass("expanded",!this.model.collapsed);var template="a5.annotations.StickyNote";if(this.model.collapsed?(template+="Collapsed",this.node.css({width:"auto",height:"auto"})):(template+=this.model.shape,this.node.css({width:this.model.width+"px",height:this.model.height+"px"})),this.node.append(a5.service.templates.render(template,{content:this.model.content})),this.node.addClass(this.model.shape.toLowerCase()),this.node.css({position:"absolute",top:this.model.top+"px",left:this.model.left+"px",backgroundColor:this.model.color,pointerEvents:"auto"}),this.node.on("click",".icon-collapse",_.bind(this.collapse,this)),this.node.on("click",".icon-expand",_.bind(this.expand,this)),this.canvas.model.readOnly){var textNode=this.$(".text-content");textNode.is("[contenteditable]")?textNode.attr("contenteditable",null):textNode.attr("disabled",!0),this.$(".icon-delete").hide()}else this.node.on("click",".icon-delete",_.bind(this.remove,this)),this.node.on("keyup",".text-content",_.bind(this.changed,this)),this.node.draggable({stop:_.bind(this.dragged,this),drag:_.bind(this._onDrag,this),cancel:"[contenteditable]"}),this.node.resizable({stop:_.bind(this.resized,this)});return this.node.on("touchstart",function(e){e.stopPropagation()}),this.node.on("touchstart",".text-content",function(e){e.stopPropagation()}),this.node},expand:function(){this.model.collapsed=!1,this.render()},collapse:function(){this.model.collapsed=!0,this.render()},dragged:function(e,ui){this.model.top=ui.position.top,this.model.left=ui.position.left},resized:function(){this.model.height=this.node.height(),this.model.width=this.node.width()},changed:function(){this.model.content=this.$(".text-content").html()},remove:function(){this.trigger("remove"),this.canvas.unbind("zoom:change",this._updateScale)},_onDrag:function(e,ui){ui.position.top=ui.position.top/(this.scale||1),ui.position.left=ui.position.left/(this.scale||1)},_updateScale:function(scale){this.scale=scale}},a5.views.interaction.BaseView.extend("a5.annotations.StickyNoteView"),a5.annotations.Timer={active:!1,activate:function(){if(this._super(),this.active=!this.active,this.node.toggleClass("active",this.active),this.active){this.view=new a5.annotations.TimerView,$("body").append(this.view.render());var offset=this.node.offset();this.view.node.css({position:"absolute",top:offset.top-this.view.node.outerHeight(!0)+"px",left:offset.left})}else this.view.node.remove()},reset:function(){this.view&&(this.view.stop(),this.view.node.remove())}},a5.annotations.ToolbarButtonView.extend("a5.annotations.Timer"),a5.annotations.TimerView={init:function(model){this._super(model,null,$('<div class="countdown"></div>'))},render:function(){return this._super(),this.node.append(a5.service.templates.render("a5.annotations.Timer")),this.stop(),this.node.draggable(),this.node.on("click",".start",_.bind(this.start,this)),this.node.on("click",".stop",_.bind(this.stop,this)),this.node},currentTime:function(){return(new Date).getTime()/1e3},start:function(){this.startTime=this.currentTime(),this.totalTime=60*parseInt(this.$(".total-time").val(),10),this.timeChangeTimer=setInterval(_.bind(this.changeTime,this),100),this.$(".start, .total-time").hide(),this.$(".stop, .time").show()},stop:function(){clearInterval(this.timeChangeTimer),this.$(".start, .total-time").show(),this.$(".stop, .time").hide()},changeTime:function(){var secondsLeft=Math.ceil(this.totalTime+this.startTime-this.currentTime());secondsLeft<0&&(secondsLeft=0),this.$(".time").text(a5.utils.secondsToTime(secondsLeft)),0==secondsLeft&&this.stop()}},a5.views.interaction.BaseView.extend("a5.annotations.TimerView"),a5.annotations.Zoom={},a5.annotations.ToolbarButtonView.extend("a5.annotations.Zoom"),AnimationParser=function(){function SyntaxError(message,expected,found,offset,line,column){this.message=message,this.expected=expected,this.found=found,this.offset=offset,this.line=line,this.column=column,this.name="SyntaxError"}!function(child,parent){function ctor(){this.constructor=child}ctor.prototype=parent.prototype,child.prototype=new ctor}(SyntaxError,Error);function parse(input){var peg$result,options=arguments.length>1?arguments[1]:{},peg$FAILED={},peg$startRuleFunctions={start:peg$parsestart},peg$startRuleFunction=peg$parsestart,peg$c0=peg$FAILED,peg$c1="#scale",peg$c2={type:"literal",value:"#scale",description:'"#scale"'},peg$c3="#",peg$c4={type:"literal",value:"#",description:'"#"'},peg$c5=function(id,scale,flags){return new a5.animations.Scale(id,scale,flags)},peg$c6="#animate",peg$c7={type:"literal",value:"#animate",description:'"#animate"'},peg$c9=function(id,points,flags){return new a5.animations.Move(id,points,flags)},peg$c10="#sequence",peg$c11={type:"literal",value:"#sequence",description:'"#sequence"'},peg$c12=function(id,ids,flags){return new a5.animations.Sequence(id,ids,flags)},peg$c13="*",peg$c14={type:"literal",value:"*",description:'"*"'},peg$c15=/^[^ \t\r\n*#]/,peg$c16={type:"class",value:"[^ \\t\\r\\n*#]",description:"[^ \\t\\r\\n*#]"},peg$c17=function(id){return id.join("")},peg$c18=function(values){return a5.utils.mergeObjects(values)},peg$c19=function(content){return content},peg$c20="duration:",peg$c21={type:"literal",value:"duration:",description:'"duration:"'},peg$c22=function(time){return{duration:time}},peg$c23="pause:",peg$c24={type:"literal",value:"pause:",description:'"pause:"'},peg$c25=function(time){return{pause:time}},peg$c26="endvalue:",peg$c27={type:"literal",value:"endvalue:",description:'"endvalue:"'},peg$c28=function(value){return{endvalue:value}},peg$c29="variable:",peg$c30={type:"literal",value:"variable:",description:'"variable:"'},peg$c31=function(name){return{variable:new a5.animations.VariableEvaluator(name)}},peg$c32="repeat:",peg$c33={type:"literal",value:"repeat:",description:'"repeat:"'},peg$c34=function(times){return{repeat:times}},peg$c35="reverse",peg$c36={type:"literal",value:"reverse",description:'"reverse"'},peg$c37=function(){return{reverse:!0}},peg$c38="audio:",peg$c39={type:"literal",value:"audio:",description:'"audio:"'},peg$c40=/^[^*#]/,peg$c41={type:"class",value:"[^*#]",description:"[^*#]"},peg$c42=function(id){return{audio:id.join("")}},peg$c43="audioloop",peg$c44={type:"literal",value:"audioloop",description:'"audioloop"'},peg$c45=function(){return{audioloop:!0}},peg$c46="transition:",peg$c47={type:"literal",value:"transition:",description:'"transition:"'},peg$c48=function(name){return{transition:name}},peg$c49=null,peg$c50=function(left,top){return new a5.animations.PointEvaluator(left,top)},peg$c51=",",peg$c52={type:"literal",value:",",description:'","'},peg$c53=function(coord){return coord},peg$c54="%",peg$c55={type:"literal",value:"%",description:'"%"'},peg$c56=function(value){return new a5.animations.PctEvaluator(value)},peg$c57=/^[+\-]/,peg$c58={type:"class",value:"[+\\-]",description:"[+\\-]"},peg$c59=function(left,op,right){return new a5.animations.OperationEvaluator(left,right,op)},peg$c60=/^[*\/]/,peg$c61={type:"class",value:"[*\\/]",description:"[*\\/]"},peg$c62="(",peg$c63={type:"literal",value:"(",description:'"("'},peg$c64=")",peg$c65={type:"literal",value:")",description:'")"'},peg$c66=function(additive){return additive},peg$c67="[",peg$c68={type:"literal",value:"[",description:'"["'},peg$c69="]",peg$c70={type:"literal",value:"]",description:'"]"'},peg$c71=function(name){return new a5.animations.VariableEvaluator(name)},peg$c72=".",peg$c73={type:"literal",value:".",description:'"."'},peg$c74=function(content){return new a5.animations.NumberEvaluator(content.join(""))},peg$c75=function(value){return new a5.animations.NumberEvaluator(value)},peg$c76="forever",peg$c77={type:"literal",value:"forever",description:'"forever"'},peg$c78=function(){return 1/0},peg$c79=function(digits){return parseInt(digits)},peg$c80=/^[0-9]/,peg$c81={type:"class",value:"[0-9]",description:"[0-9]"},peg$c82=function(content){return parseInt(content.join(""))},peg$c83=/^[a-zA-Z]/,peg$c84={type:"class",value:"[a-zA-Z]",description:"[a-zA-Z]"},peg$c85=function(chars){return chars.join("")},peg$c86=/^[ \t\r\n]/,peg$c87={type:"class",value:"[ \\t\\r\\n]",description:"[ \\t\\r\\n]"},peg$currPos=0,peg$reportedPos=0,peg$cachedPos=0,peg$cachedPosDetails={line:1,column:1,seenCR:!1},peg$maxFailPos=0,peg$maxFailExpected=[],peg$silentFails=0;if("startRule"in options){if(!(options.startRule in peg$startRuleFunctions))throw new Error("Can't start parsing from rule \""+options.startRule+'".');peg$startRuleFunction=peg$startRuleFunctions[options.startRule]}function peg$computePosDetails(pos){return peg$cachedPos!==pos&&(peg$cachedPos>pos&&(peg$cachedPos=0,peg$cachedPosDetails={line:1,column:1,seenCR:!1}),function(details,startPos,endPos){var p,ch;for(p=startPos;p<endPos;p++)ch=input.charAt(p),"\n"===ch?(details.seenCR||details.line++,details.column=1,details.seenCR=!1):"\r"===ch||"\u2028"===ch||"\u2029"===ch?(details.line++,details.column=1,details.seenCR=!0):(details.column++,details.seenCR=!1)}(peg$cachedPosDetails,peg$cachedPos,pos),peg$cachedPos=pos),peg$cachedPosDetails}function peg$fail(expected){peg$currPos<peg$maxFailPos||(peg$currPos>peg$maxFailPos&&(peg$maxFailPos=peg$currPos,peg$maxFailExpected=[]),peg$maxFailExpected.push(expected))}function peg$buildException(message,expected,pos){var posDetails=peg$computePosDetails(pos),found=pos<input.length?input.charAt(pos):null;return null!==expected&&function(expected){var i=1
;for(expected.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0});i<expected.length;)expected[i-1]===expected[i]?expected.splice(i,1):i++}(expected),new SyntaxError(null!==message?message:function(expected,found){var expectedDesc,foundDesc,i,expectedDescs=new Array(expected.length);for(i=0;i<expected.length;i++)expectedDescs[i]=expected[i].description;return expectedDesc=expected.length>1?expectedDescs.slice(0,-1).join(", ")+" or "+expectedDescs[expected.length-1]:expectedDescs[0],foundDesc=found?'"'+function(s){function hex(ch){return ch.charCodeAt(0).toString(16).toUpperCase()}return s.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(ch){return"\\x0"+hex(ch)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(ch){return"\\x"+hex(ch)}).replace(/[\u0180-\u0FFF]/g,function(ch){return"\\u0"+hex(ch)}).replace(/[\u1080-\uFFFF]/g,function(ch){return"\\u"+hex(ch)})}(found)+'"':"end of input","Expected "+expectedDesc+" but "+foundDesc+" found."}(expected,found),expected,found,pos,posDetails.line,posDetails.column)}function peg$parsestart(){var s0;return s0=peg$parseanimationmove(),s0===peg$FAILED&&(s0=peg$parseanimationscale())===peg$FAILED&&(s0=peg$parseanimationsequence()),s0}function peg$parseanimationscale(){var s0,s1,s2,s3,s4,s5;return s0=peg$currPos,input.substr(peg$currPos,6)===peg$c1?(s1=peg$c1,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c2)),s1!==peg$FAILED?(s2=peg$parseobjectid(),s2!==peg$FAILED?(s3=peg$parsepoint(),s3!==peg$FAILED?(s4=peg$parseflags(),s4!==peg$FAILED?(35===input.charCodeAt(peg$currPos)?(s5=peg$c3,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c4)),s5!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c5(s2,s3,s4),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parseanimationmove(){var s0,s1,s2,s3,s4,s5;if(s0=peg$currPos,input.substr(peg$currPos,8)===peg$c6?(s1=peg$c6,peg$currPos+=8):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c7)),s1!==peg$FAILED)if((s2=peg$parseobjectid())!==peg$FAILED){if(s3=[],(s4=peg$parsepoint())!==peg$FAILED)for(;s4!==peg$FAILED;)s3.push(s4),s4=peg$parsepoint();else s3=peg$c0;s3!==peg$FAILED?(s4=peg$parseflags(),s4!==peg$FAILED?(35===input.charCodeAt(peg$currPos)?(s5=peg$c3,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c4)),s5!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c9(s2,s3,s4),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)}else peg$currPos=s0,s0=peg$c0;else peg$currPos=s0,s0=peg$c0;return s0}function peg$parseanimationsequence(){var s0,s1,s2,s3,s4,s5;if(s0=peg$currPos,input.substr(peg$currPos,9)===peg$c10?(s1=peg$c10,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c11)),s1!==peg$FAILED)if((s2=peg$parseobjectid())!==peg$FAILED){for(s3=[],s4=peg$parseobjectid();s4!==peg$FAILED;)s3.push(s4),s4=peg$parseobjectid();s3!==peg$FAILED?(s4=peg$parseflags(),s4!==peg$FAILED?(35===input.charCodeAt(peg$currPos)?(s5=peg$c3,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c4)),s5!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c12(s2,s3,s4),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)}else peg$currPos=s0,s0=peg$c0;else peg$currPos=s0,s0=peg$c0;return s0}function peg$parseobjectid(){var s0,s1,s2,s3;if(s0=peg$currPos,42===input.charCodeAt(peg$currPos)?(s1=peg$c13,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c14)),s1!==peg$FAILED){if(s2=[],peg$c15.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c16)),s3!==peg$FAILED)for(;s3!==peg$FAILED;)s2.push(s3),peg$c15.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c16));else s2=peg$c0;s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c17(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)}else peg$currPos=s0,s0=peg$c0;return s0}function peg$parseflags(){var s0,s1,s2;for(s0=peg$currPos,s1=[],s2=peg$parseflag();s2!==peg$FAILED;)s1.push(s2),s2=peg$parseflag();return s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c18(s1)),s0=s1}function peg$parseflag(){var s0,s1,s2;return s0=peg$currPos,42===input.charCodeAt(peg$currPos)?(s1=peg$c13,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c14)),s1!==peg$FAILED?(s2=peg$parsedurationflag(),s2===peg$FAILED&&(s2=peg$parsepauseflag())===peg$FAILED&&(s2=peg$parseendvalueflag())===peg$FAILED&&(s2=peg$parsevariableflag())===peg$FAILED&&(s2=peg$parserepeatflag())===peg$FAILED&&(s2=peg$parsereverseflag())===peg$FAILED&&(s2=peg$parseaudioflag())===peg$FAILED&&(s2=peg$parseaudioloopflag())===peg$FAILED&&(s2=peg$parsetransitionflag()),s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c19(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsedurationflag(){var s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,9)===peg$c20?(s1=peg$c20,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c21)),s1!==peg$FAILED?(s2=peg$parsespace(),s2!==peg$FAILED?(s3=peg$parseinteger(),s3!==peg$FAILED?(s4=peg$parsespace(),s4!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c22(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsepauseflag(){var s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,6)===peg$c23?(s1=peg$c23,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c24)),s1!==peg$FAILED?(s2=peg$parsespace(),s2!==peg$FAILED?(s3=peg$parseinteger(),s3!==peg$FAILED?(s4=peg$parsespace(),s4!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c25(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parseendvalueflag(){var s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,9)===peg$c26?(s1=peg$c26,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c27)),s1!==peg$FAILED?(s2=peg$parsespace(),s2!==peg$FAILED?(s3=peg$parseinteger(),s3!==peg$FAILED?(s4=peg$parsespace(),s4!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c28(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsevariableflag(){var s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,9)===peg$c29?(s1=peg$c29,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c30)),s1!==peg$FAILED?(s2=peg$parsespace(),s2!==peg$FAILED?(s3=peg$parseword(),s3!==peg$FAILED?(s4=peg$parsespace(),s4!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c31(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parserepeatflag(){var s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,7)===peg$c32?(s1=peg$c32,peg$currPos+=7):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c33)),s1!==peg$FAILED?(s2=peg$parsespace(),s2!==peg$FAILED?(s3=peg$parseinteger(),s3===peg$FAILED&&(s3=peg$parseforever()),s3!==peg$FAILED?(s4=peg$parsespace(),s4!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c34(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsereverseflag(){var s0,s1;return s0=peg$currPos,input.substr(peg$currPos,7)===peg$c35?(s1=peg$c35,peg$currPos+=7):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c36)),s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c37()),s0=s1}function peg$parseaudioflag(){var s0,s1,s2,s3;if(s0=peg$currPos,input.substr(peg$currPos,6)===peg$c38?(s1=peg$c38,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c39)),s1!==peg$FAILED){for(s2=[],peg$c40.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c41));s3!==peg$FAILED;)s2.push(s3),peg$c40.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c41));s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c42(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)}else peg$currPos=s0,s0=peg$c0;return s0}function peg$parseaudioloopflag(){var s0,s1;return s0=peg$currPos,input.substr(peg$currPos,9)===peg$c43?(s1=peg$c43,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c44)),s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c45()),s0=s1}function peg$parsetransitionflag(){var s0,s1,s2;return s0=peg$currPos,input.substr(peg$currPos,11)===peg$c46?(s1=peg$c46,peg$currPos+=11):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c47)),s1!==peg$FAILED?(s2=peg$parseword(),s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c48(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsepoint(){var s0,s1,s2,s3;return s0=peg$currPos,42===input.charCodeAt(peg$currPos)?(s1=peg$c13,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c14)),s1!==peg$FAILED?(s2=peg$parsepercent(),s2===peg$FAILED&&(s2=peg$parseprimary()),s2!==peg$FAILED?(s3=peg$parsesecondcoord(),s3===peg$FAILED&&(s3=peg$c49),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c50(s2,s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsesecondcoord(){var s0,s1,s2;return s0=peg$currPos,44===input.charCodeAt(peg$currPos)?(s1=peg$c51,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c52)),s1!==peg$FAILED?(s2=peg$parsepercent(),s2===peg$FAILED&&(s2=peg$parseprimary()),s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c53(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsepercent(){var s0,s1,s2;return s0=peg$currPos,s1=peg$parseprimary(),s1!==peg$FAILED?(37===input.charCodeAt(peg$currPos)?(s2=peg$c54,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c55)),s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c56(s1),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parseadditive(){var s0,s1,s2,s3;return s0=peg$currPos,s1=peg$parsemultiplicative(),s1!==peg$FAILED?(peg$c57.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c58)),s2!==peg$FAILED?(s3=peg$parseadditive(),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c59(s1,s2,s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0===peg$FAILED&&(s0=peg$parsemultiplicative()),s0}function peg$parsemultiplicative(){var s0,s1,s2,s3;return s0=peg$currPos,s1=peg$parseprimary(),s1!==peg$FAILED?(peg$c60.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c61)),s2!==peg$FAILED?(s3=peg$parsemultiplicative(),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c59(s1,s2,s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0===peg$FAILED&&(s0=peg$parseprimary()),s0}function peg$parseprimary(){var s0,s1,s2,s3;return s0=peg$parsefloatvalue(),s0===peg$FAILED&&(s0=peg$parsevariable())===peg$FAILED&&(s0=peg$currPos,40===input.charCodeAt(peg$currPos)?(s1=peg$c62,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c63)),s1!==peg$FAILED?(s2=peg$parseadditive(),s2!==peg$FAILED?(41===input.charCodeAt(peg$currPos)?(s3=peg$c64,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c65)),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c66(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)),s0}function peg$parsevariable(){var s0,s1,s2,s3,s4,s5;return s0=peg$currPos,s1=peg$parsespace(),s1!==peg$FAILED?(91===input.charCodeAt(peg$currPos)?(s2=peg$c67,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c68)),s2!==peg$FAILED?(s3=peg$parseword(),s3!==peg$FAILED?(93===input.charCodeAt(peg$currPos)?(s4=peg$c69,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c70)),s4!==peg$FAILED?(s5=peg$parsespace(),s5!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c71(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsefloatvalue(){var s0,s1,s2,s3,s4,s5;return s0=peg$currPos,s1=peg$parsespace(),s1!==peg$FAILED?(s2=peg$currPos,s3=peg$parsedigits(),s3!==peg$FAILED?(46===input.charCodeAt(peg$currPos)?(s4=peg$c72,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c73)),s4!==peg$FAILED?(s5=peg$parsedigits(),s5!==peg$FAILED?(s3=[s3,s4,s5],s2=s3):(peg$currPos=s2,s2=peg$c0)):(peg$currPos=s2,s2=peg$c0)):(peg$currPos=s2,s2=peg$c0),s2!==peg$FAILED?(s3=peg$parsespace(),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c74(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0===peg$FAILED&&(s0=peg$parseintegervalue()),s0}function peg$parseintegervalue(){var s0,s1;return s0=peg$currPos,s1=peg$parseinteger(),s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c75(s1)),s0=s1}function peg$parseforever(){var s0,s1;return s0=peg$currPos,input.substr(peg$currPos,7)===peg$c76?(s1=peg$c76,peg$currPos+=7):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c77)),s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c78()),s0=s1}function peg$parseinteger(){var s0,s1,s2,s3;return s0=peg$currPos,s1=peg$parsespace(),s1!==peg$FAILED?(s2=peg$parsedigits(),s2!==peg$FAILED?(s3=peg$parsespace(),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c79(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsedigits(){var s0,s1,s2;if(s0=peg$currPos,s1=[],peg$c80.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c81)),s2!==peg$FAILED)for(;s2!==peg$FAILED;)s1.push(s2),peg$c80.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c81));else s1=peg$c0;return s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c82(s1)),s0=s1}function peg$parseword(){var s0,s1,s2;if(s0=peg$currPos,s1=[],peg$c83.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c84)),s2!==peg$FAILED)for(;s2!==peg$FAILED;)s1.push(s2),peg$c83.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c84));else s1=peg$c0;return s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c85(s1)),s0=s1}function peg$parsespace(){var s0,s1;for(s0=[],peg$c86.test(input.charAt(peg$currPos))?(s1=input.charAt(peg$currPos),peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c87));s1!==peg$FAILED;)s0.push(s1),peg$c86.test(input.charAt(peg$currPos))?(s1=input.charAt(peg$currPos),peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c87));return s0}if((peg$result=peg$startRuleFunction())!==peg$FAILED&&peg$currPos===input.length)return peg$result;throw peg$result!==peg$FAILED&&peg$currPos<input.length&&peg$fail({type:"end",description:"end of input"}),peg$buildException(null,peg$maxFailExpected,peg$maxFailPos)}return{SyntaxError:SyntaxError,parse:parse}}(),a5.preprocessor.Animations={preprocess:function(txt,interaction){return txt.replace(/#(animate|scale|sequence)[\s\S]*?#/g,function(match){var animation=AnimationParser.parse(match);return interaction.bind("show:deferred",function(){animation.start(interaction)}),""})}};a5.preprocessor.Preprocessor.extend("a5.preprocessor.Animations"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Animations),a5.animations.NumberEvaluator={init:function(value){this.value=parseFloat(value)},exec:function(){return this.value}},Obj.extend("a5.animations.NumberEvaluator"),a5.animations.PctEvaluator={init:function(value){this.value=value},exec:function(animation,options){return this.value.exec(animation,options)/100*animation[options.scale+"scale"]()}},Obj.extend("a5.animations.PctEvaluator"),a5.animations.PointEvaluator={init:function(left,top){this.left=left,this.top=top||left},exec:function(animation,options){return new Point(this.left.exec(animation,_.extend(options||{},{scale:"x"})),this.top.exec(animation,_.extend(options||{},{scale:"y"})))}},Obj.extend("a5.animations.PointEvaluator"),a5.animations.OperationEvaluator={init:function(left,right,op){this.left=left,this.right=right,this.op=op},exec:function(animation,options){var left=this.left.exec(animation,options),right=this.right.exec(animation,options);switch(this.op){case"+":return left+right;case"-":return left-right;case"*":return left*right;case"/":return left/right}}},Obj.extend("a5.animations.OperationEvaluator"),a5.animations.VariableEvaluator={init:function(name){this.name=name},exec:function(animation){return this[this.name](animation)},originx:function(animation){return animation.$node.offset().left-animation.offset.left},originy:function(animation){return animation.$node.offset().top-animation.offset.top},getResults:function(){return a5.mainBuilder.getResults()},score:function(){return this.getResults().percent()},correctanswers:function(){return this.getResults().correct()},revealedanswers:function(){return this.getResults().revealed()},pointsachieved:function(){return this.correctanswers()},totalquestions:function(){return this.getResults().total()},pointsavailable:function(){return this.totalquestions()},incorrectanswers:function(){return this.totalquestions()-this.revealedanswers()-this.correctanswers()}},Obj.extend("a5.animations.VariableEvaluator"),a5.animations.Base={init:function(objectid,options){this.objectid=objectid,this.options=_.defaults(options,{duration:1e3,pause:0,repeat:1}),this.started=!1},start:function(interaction){this.started||(this.started=!0,this.$node=interaction.contentWrap.find("#"+this.objectid),this.prepare(interaction),this.playAudio(),this.restart())},prepare:function(interaction){},playAudio:function(){this.options.audio&&a5.service.media.audio.bind("ready",function(){var playing=a5.service.media.audio.create(this.options.audio,{preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())});this.options.audioloop&&playing.bind("stopped",function(){playing.play()}),playing.play()},this)},animate:function(properties,callback){this.$node.animate(properties,this.options.duration,"linear",callback)},restart:function(){this.options.repeat-=1,this.reset(),this.$node.delay(this.options.pause),this.animateForward(_.bind(this.animationEnded,this))},animationEnded:function(){this.options.reverse?this.animateBackward(_.bind(this.animationEndedNoReverse,this)):this.animationEndedNoReverse()},animationEndedNoReverse:function(){this.options.repeat>0&&this.restart()},createPlaceholder:function(){return $('<span style="display: inline-block;"></span>').css({height:this.$node.outerHeight(!0),width:this.$node.outerWidth(!0)})},chooseFrame:function(frames){var step=this.options.endvalue/frames.length,index=Math.floor(this.options.variable.exec(this)/step);return index<0&&(index=0),index>=frames.length&&(index=frames.length-1),frames[index]}},Obj.extend("a5.animations.Base"),a5.animations.Move={init:function(objectid,points,options){this._super(objectid,options),this.points=points},prepare:function(interaction){this.offset=interaction.contentWrap.offset(),this.startPoint=this.points[0].exec(this),2==this.points.length?this.endPoint=this.twopointEnd(this.startPoint):this.endPoint=this.multipointEnd(),"static"==this.$node.css("position")&&this.addPlaceholder(),this.$node.detach().appendTo(interaction.contentWrap)},addPlaceholder:function(){this.createPlaceholder().insertAfter(this.$node)},animate:function(to,callback){this._super({left:to.left,top:to.top},callback)},reset:function(){this.$node.css({position:"absolute",zIndex:"1000",left:this.startPoint.left,top:this.startPoint.top})},animateForward:function(callback){this.animate(this.endPoint,callback)},animateBackward:function(callback){this.animate(this.startPoint,callback)},twopointEnd:function(start){var end=this.points[1].exec(this);if(this.options.variable){var part=this.options.variable.exec(this)/this.options.endvalue;end.left=start.left+(end.left-start.left)*part,end.top=start.top+(end.top-start.top)*part}return end},multipointEnd:function(){return this.options.variable?this.chooseFrame(this.points.slice(1)).exec(this):this.points[this.points.length-1].exec(this)}},a5.animations.Base.extend("a5.animations.Move"),a5.animations.Scale={init:function(objectid,to,options){this._super(objectid,options),this.to=to},prepare:function(){this.startSize=new Point(this.xscale(),this.yscale()),this.endSize=this.to.exec(this,{})},xscale:function(){return this.$node.width()},yscale:function(){return this.$node.height()},animate:function(to,callback){this._super({width:to.left,height:to.top},callback)},reset:function(){this.$node.css({width:this.startSize.left,height:this.startSize.top})},animateForward:function(callback){this.animate(this.endSize,callback)},animateBackward:function(callback){this.animate(this.startSize,callback)}},a5.animations.Base.extend("a5.animations.Scale"),a5.animations.Sequence={init:function(objectid,ids,options){this._super(objectid,options),this.ids=ids},prepare:function(interaction){_.each(this.ids,function(id){interaction.contentWrap.find("#"+id).hide()},this),this.$node.wrap(this.createPlaceholder().css({position:"relative"})),this.$node.css({position:"absolute",zIndex:"1000"});var resultId=this.chooseFrame(this.ids);interaction.contentWrap.find("#"+resultId).show().css({position:"absolute",zIndex:"900"}).detach().prependTo(this.$node.parent())},animate:function(value,callback){this._super({opacity:value},callback)},reset:function(){this.$node.css({opacity:1})},animateForward:function(callback){this.animate(0,callback)},animateBackward:function(callback){this.animate(1,callback)}},a5.animations.Base.extend("a5.animations.Sequence"),a5.components.Resources={init:function(parameters){this.interaction=parameters.interaction,this.banks=this._getBanks(),this.resourcesPanelView=new a5.view.ResourcesTabPanel({banks:this.banks,maxAddBy:parameters.maxAddBy,interaction:this.interaction})},_initStage:function(){this.resourcesStage=new a5.model.ResourcesStage({banks:this.banks}),this.resourcesStageView=new a5.view.ResourcesStage({model:this.resourcesStage,interaction:this.interaction,$el:this.interaction.$(".interaction")}),this.combinedUndoRedoManager=new a5.CombinedUndoRedoManager({annotations:this.interaction.annotations,stage:this.resourcesStage}),this.combinedUndoRedoManager.bind("change:history",function(){this.trigger("change")},this)},addActivity:function(activityView){this.activity=activityView},show:function(){return this.interaction.resourcesZone.append(this.resourcesPanelView.$el),this.resourcesPanelView.bind("more-resources:show",this._onMoreResourcesShow,this),this.resourcesPanelView.render(),this.resourcesPanelView.isStageEnabled()&&this._initStage(),this.resourcesStageView&&(this.resourcesStageView.bind("resource-item:drop",function($items){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll();var bounds=this.resourcesStageView.region()[0].getBoundingClientRect(),box=$items.addClass("dropping")[0].getBoundingClientRect(),pushLeft=0,pushRight=0,pushTop=0,pushBottom=0;box.left<bounds.left&&(pushRight=bounds.left-box.left),box.right>bounds.right&&(pushLeft=box.right-bounds.right),box.top<bounds.top&&(pushBottom=bounds.top-box.top),box.bottom>bounds.bottom&&(pushTop=box.bottom-bounds.bottom);var $item=$items;$item.children(":first").is(".resource-item")&&($item=$item.children(":first"));var addBy=1;if($item.is(".resource-item")&&(addBy=this.resourcesPanelView.addBy),$item.hasClass("resource-item-composed"))$item.children("[data-item-id]").each(function(index,el){var $el=$(el),x=$el.offset().left-this.resourcesStageView.region().offset().left+pushRight-pushLeft,y=$el.offset().top-this.resourcesStageView.region().offset().top+pushBottom-pushTop,dx=$item[0].getBoundingClientRect().width;_(addBy).times(function(n){this._drop({x:x+dx*n,y:y,id:$el.attr("data-item-id"),bankItemId:$el.attr("data-bank-item-id")})},this)}.bind(this));else{var x=$item.offset().left-this.resourcesStageView.region().offset().left+pushRight-pushLeft,y=$item.offset().top-this.resourcesStageView.region().offset().top+pushBottom-pushTop,dx=$item[0].getBoundingClientRect().width;_(addBy).times(function(n){this._drop({x:x+dx*n,y:y,id:$item.attr("data-item-id"),bankItemId:$item.attr("data-bank-item-id"),$el:$item})},this)}$item.is(".resource-item")&&this.resourcesPanelView.resetAddBy()},this),this.resourcesPanelView.bind("resource-bank-item:click",function($item){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll(),_(this.resourcesPanelView.addBy).times(function(n){$item.hasClass("resource-item-composed")?this._addCompositeToGrid($item):0===$item.closest(".resource-item-composed").length&&this._addToGrid({id:$item.attr("data-item-id"),bankItemId:$item.attr("data-bank-item-id")})},this),this.resourcesPanelView.resetAddBy()},this),this.resourcesStageView.bind("resource-stage-item:drag",this._onResourceStageItemDrag,this),this.resourcesStageView.bind("action:end",this._onActionEnd,this),this.resourcesStageView.bind("resources-stage:change",this._onResourcesStageChange,this),this.resourcesPanelView.bind("resources-toolbar:flip-horizontal",this._onClickFlipHorizontal,this),this.resourcesPanelView.bind("resources-toolbar:flip-vertical",this._onClickFlipVertical,this),this.resourcesPanelView.bind("resources-toolbar:rotate",this._onClickRotate,this),this.resourcesPanelView.bind("resources-toolbar:delete-selected",this._onClickDeleteSelected,this),this.resourcesPanelView.bind("resources-toolbar:delete-all",this._onClickDeleteAll,this),this.resourcesPanelView.bind("resources-toolbar:save",this._onClickSave,this),this.resourcesPanelView.bind("resources-toolbar:undo",this._onClickUndo,this),this.resourcesPanelView.bind("resources-toolbar:add-all",this._onClickAddAll,this),this.resourcesPanelView.bind("resources-toolbar:add-random",this._onClickAddRandom,this),this.resourcesPanelView.bind("resources-toolbar:add-random-selection",this._onClickAddRandomSelection,this),this.resourcesPanelView.bind("resources-toolbar:reset",this._onClickReset,this),this.resourcesPanelView.bind("resource-bank:activate",this._onResourceBankActivate,this),$(document).on("keyup",function(e){46!==e.which&&8!==e.which||(this.resourcesStage.savePoint(),this.resourcesStageView.deleteSelectedItems())}.bind(this)),$(window).on("resize",_.throttle(this._onResize.bind(this),300)),this.resourcesStageView.render()),this},store:function(){return this.resourcesStage?this.resourcesStage.getState():{}},restore:function(object){this.resourcesStage&&this.resourcesStage.setState(object)},addItem:function($item,x,y){var bankItem=this.banks.findItemById($item.attr("data-item-id")),type=bankItem.bank.id,item=new a5.model.ResourceStageItem({path:bankItem.path,inline:bankItem.inline,type:type,bankItemId:bankItem.id}),resourceStageItem=this.resourcesStageView.addItem(item);resourceStageItem.moveTo(x,y),this.resourcesStageView.selectItem(resourceStageItem),this.resourcesStage.add(item)},addArray:function($item,rows,cols,sepX,sepY){var bankItem=this.banks.findItemById($item.attr("data-item-id")),type=bankItem.bank.id;this.resourcesStage.savePoint();var $clone=$item.clone().css({margin:0,visibility:"hidden"}).addClass("resource-stage-item").addClass(type);this.resourcesStageView.region().append($clone);var matrix=this.resourcesStageView.region().transformationMatrix(!0),scale=matrix.getScale(),box=$clone[0].getBoundingClientRect(),size={width:cols*Math.round(box.width/scale)+(cols-1)*sepX,height:rows*Math.round(box.height/scale)+(rows-1)*sepY},origin={sox:$clone.position().left,soy:$clone.position().top};origin.ox=Math.round(origin.sox/scale*10)/10,origin.oy=Math.round(origin.soy/scale*10)/10;var offset=this.resourcesStage.clickToAddGrid.relativeTo(this.resourcesStageView.region()),offsetX=Math.round(offset.left/scale),offsetY=Math.round(offset.top/scale),snap=this.resourcesStage.clickToAddGrid.snap(size),x=offsetX+snap.x-origin.ox,y=offsetY+snap.y-origin.oy;snap.fit||(x=0,y=0);for(var dx,dy=0,i=0;i<rows;i++){dx=0;for(var j=0;j<cols;j++)this.addItem($item,x+dx,y+dy),j<cols-1&&(dx+=Math.round(box.width/scale)+sepX);dy+=Math.round(box.height/scale)+sepY}$clone.remove()},_onClickRotate:function(anticlockwise){this.resourcesStage.savePoint(),this.resourcesPanelView.unbind("resources-toolbar:flip-horizontal",this._onClickFlipHorizontal),this.resourcesPanelView.unbind("resources-toolbar:flip-vertical",this._onClickFlipVertical),this.resourcesPanelView.unbind("resources-toolbar:rotate",this._onClickRotate),this.resourcesStageView.rotateSelectedItems(anticlockwise)},_onClickFlipHorizontal:function(){this.resourcesStage.savePoint(),this.resourcesPanelView.unbind("resources-toolbar:flip-horizontal",this._onClickFlipHorizontal),this.resourcesPanelView.unbind("resources-toolbar:flip-vertical",this._onClickFlipVertical),this.resourcesPanelView.unbind("resources-toolbar:rotate",this._onClickRotate),this.resourcesStageView.flipHorizontalSelectedItems()},_onClickFlipVertical:function(){this.resourcesStage.savePoint(),this.resourcesPanelView.unbind("resources-toolbar:flip-horizontal",this._onClickFlipHorizontal),this.resourcesPanelView.unbind("resources-toolbar:flip-vertical",this._onClickFlipVertical),this.resourcesPanelView.unbind("resources-toolbar:rotate",this._onClickRotate),this.resourcesStageView.flipVerticalSelectedItems()},_onClickDeleteAll:function(){var resourcesDeleteAllModal=new a5.view.dialog.DeleteAll;resourcesDeleteAllModal.bind("submit",function(){this.resourcesStage.savePoint(),this.resourcesStageView.deleteAllItems(),this.interaction.annotations.setChildren([]),this.trigger("delete-all")},this),resourcesDeleteAllModal.show()},_onClickDeleteSelected:function(){this.resourcesStage.savePoint(),this.resourcesStageView.deleteSelectedItems()},_onClickSave:function(){a5.mainBuilder.save()},_onResourceStageItemDrag:function(draggedItem){this.resourcesStage.savePoint()},_onClickUndo:function(){this.combinedUndoRedoManager.undo()},_onClickAddAll:function(){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll();var items=this.resourcesPanelView.getCurrentResourceBank().getItemsBySelector(".resource-item:visible");_(items).each(function(item){var $item=item.$el;$item.hasClass("resource-item-composed")?$item.children("[data-item-id]").each(function(index,el){var $el=$(el);this._addToGrid({id:$el.attr("data-item-id")})}.bind(this)):0===$item.closest(".resource-item-composed").length&&this._addToGrid({id:$item.attr("data-item-id")})},this)},_onClickAddRandom:function(){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll();var items=this.resourcesPanelView.getCurrentResourceBank().getItemsBySelector(".resource-item:visible:not(.already-added-to-stage)"),item=_(items).sample();if(item){var $item=item.$el;$item.hasClass("resource-item-composed")?$item.children("[data-item-id]").each(function(index,el){var $el=$(el);this._addToGrid({id:$el.attr("data-item-id")})}.bind(this)):0===$item.closest(".resource-item-composed").length&&this._addToGrid({id:$item.attr("data-item-id")})}},_onClickAddRandomSelection:function(){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll();var items=this.resourcesPanelView.getCurrentResourceBank().getItemsBySelector(".resource-item:visible"),numberOfItems=Math.floor(13*Math.random())+3;_.times(numberOfItems,function(){var item=_(items).sample(),$item=item.$el;$item.hasClass("resource-item-composed")?$item.children("[data-item-id]").each(function(index,el){var $el=$(el);this._addToGrid({id:$el.attr("data-item-id")})}.bind(this)):0===$item.closest(".resource-item-composed").length&&this._addToGrid({
id:$item.attr("data-item-id")})},this)},_onClickReset:function(){if(this.resourcesPanelView.getBankById("numeral-cards")){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll();var items=this.resourcesStage.getItemsByType("numeral-cards");_(items).each(function(item){this.resourcesStageView.removeItemById(item.id)},this),this.resourcesStage.resetGrids()}},_onActionEnd:function(){this.resourcesPanelView.bind("resources-toolbar:flip-horizontal",this._onClickFlipHorizontal,this),this.resourcesPanelView.bind("resources-toolbar:flip-vertical",this._onClickFlipVertical,this),this.resourcesPanelView.bind("resources-toolbar:rotate",this._onClickRotate,this)},_onResize:function(e){this.resourcesStage.clickToAddGrid&&this.resourcesStage.clickToAddGrid.refreshDimensions()},_onMoreResourcesShow:function(){var resourcesSelectModal=new a5.view.dialog.ResourceBanksSelect({banks:this.banks});resourcesSelectModal.bind("submit",function(selection){this.banks.updateSelection(selection),this.resourcesPanelView.refresh()},this),resourcesSelectModal.show()},_onResourceBankActivate:function(bank){this.resourcesStageView.$el.toggleClass("numeral-cards","numeral-cards"===bank.id),"numeral-cards"===bank.id?(this.resourcesPanelView.disableAddBy(),this._refreshNumeralCards()):this.resourcesPanelView.enableAddBy()},_onResourcesStageChange:function(){this._refreshNumeralCards()},_drop:function(draggedItem){this.activity&&this.activity.removeItemById(draggedItem.id);var item,bankItem=this.banks.findItemById(draggedItem.bankItemId),type=bankItem.bank.id;if("numeral-cards"===type){if(this.resourcesStage.getItemsByBankItemId(bankItem.id).length>0)return;var numeralCardsBankView=this.resourcesPanelView.getCurrentResourceBank();item=new a5.model.CardStageItem({path:bankItem.path,inline:bankItem.inline,type:type,face:numeralCardsBankView.addFaceMode,bankItemId:bankItem.id})}else item=new a5.model.ResourceStageItem({path:bankItem.path,inline:bankItem.inline,type:type,bankItemId:bankItem.id}),"keypad"===type&&draggedItem.$el&&(item.inline=draggedItem.$el.html());var resourceStageItem=this.resourcesStageView.addItem(item),matrix=this.resourcesStageView.region().transformationMatrix(!0),scale=matrix.getScale(),origin={sox:resourceStageItem.$el.position().left,soy:resourceStageItem.$el.position().top};origin.ox=Math.round(10*origin.sox/scale)/10,origin.oy=Math.round(10*origin.soy/scale)/10;var snap=this.resourcesStage.generalGrid.snap({x:draggedItem.x/scale,y:draggedItem.y/scale}),x=snap.x-origin.ox,y=snap.y-origin.oy;resourceStageItem.moveTo(x,y),this.resourcesStageView.selectItem(resourceStageItem),this.resourcesStage.add(item)},_addToGrid:function(clickedItem){var item,bankItem=this.banks.findItemById(clickedItem.id),type=bankItem.bank.id;if("numeral-cards"===type){if(this.resourcesStage.getItemsByBankItemId(bankItem.id).length>0)return;var numeralCardsBankView=this.resourcesPanelView.getCurrentResourceBank();item=new a5.model.CardStageItem({path:bankItem.path,inline:bankItem.inline,type:type,face:numeralCardsBankView.addFaceMode,bankItemId:bankItem.id})}else item=new a5.model.ResourceStageItem({path:bankItem.path,inline:bankItem.inline,type:type,bankItemId:bankItem.id});var resourceStageItem=this.resourcesStageView.addItem(item),matrix=this.resourcesStageView.region().transformationMatrix(!0),scale=matrix.getScale(),origin={sox:resourceStageItem.$el.position().left,soy:resourceStageItem.$el.position().top};origin.ox=Math.round(origin.sox/scale*10)/10,origin.oy=Math.round(origin.soy/scale*10)/10;var box=resourceStageItem.$el[0].getBoundingClientRect(),size={width:Math.round(box.width/scale),height:Math.round(box.height/scale)},offset=this.resourcesStage.clickToAddGrid.relativeTo(this.resourcesStageView.region()),offsetX=Math.round(offset.left/scale),offsetY=Math.round(offset.top/scale),snap=this.resourcesStage.clickToAddGrid.snap(size),x=offsetX+snap.x-origin.ox,y=offsetY+snap.y-origin.oy;snap.fit?(resourceStageItem.moveTo(x,y),this.resourcesStageView.selectItem(resourceStageItem),this.resourcesStage.add(item)):this.resourcesStageView.removeItem(resourceStageItem)},_addCompositeToGrid:function($compositeItem){var compositeItem=this.banks.findItemById($compositeItem.attr("data-item-id")),type=compositeItem.bank.id,$clone=$compositeItem.clone().css({margin:0,visibility:"hidden"}).addClass("resource-stage-item").addClass(type);this.resourcesStageView.region().append($clone);var matrix=this.resourcesStageView.region().transformationMatrix(!0),scale=matrix.getScale(),box=$clone[0].getBoundingClientRect(),size={width:Math.round(box.width/scale),height:Math.round(box.height/scale)},offset=this.resourcesStage.clickToAddGrid.relativeTo(this.resourcesStageView.region()),offsetX=Math.round(offset.left/scale),offsetY=Math.round(offset.top/scale),snap=this.resourcesStage.clickToAddGrid.snap(size);$clone.children("[data-item-id]").each(function(index,el){var $el=$(el),bankItem=this.banks.findItemById($el.attr("data-item-id")),item=new a5.model.ResourceStageItem({path:bankItem.path,inline:bankItem.inline,type:type,bankItemId:bankItem.id}),resourceStageItem=this.resourcesStageView.addItem(item);if(snap.fit){var compOffset={sox:$el.offset().left-$clone.offset().left,soy:$el.offset().top-$clone.offset().top};compOffset.ox=Math.round(compOffset.sox/scale*10)/10,compOffset.oy=Math.round(compOffset.soy/scale*10)/10;var origin={sox:resourceStageItem.$el.position().left,soy:resourceStageItem.$el.position().top};origin.ox=Math.round(origin.sox/scale*10)/10,origin.oy=Math.round(origin.soy/scale*10)/10;var x=offsetX+snap.x-origin.ox+compOffset.ox,y=offsetY+snap.y-origin.oy+compOffset.oy;resourceStageItem.moveTo(x,y),this.resourcesStageView.selectItem(resourceStageItem),this.resourcesStage.add(item)}else this.resourcesStageView.removeItem(resourceStageItem)}.bind(this)),$clone.remove()},_getBanks:function(){if(!this.banks){var allBanks=_(a5.dp.resourceBanks).map(function(bank){return new a5.model.ResourceBank(bank,this)},this);this.banks=new a5.model.ResourceBankList({availableBanks:this._getAvailableBanks(),allBanks:allBanks})}return this.banks},_getAvailableBanks:function(){var availableBanks=[];try{availableBanks=$.parseJSON(this.interaction.options.getResourceBanks()).items}catch(e){}return availableBanks},_refreshNumeralCards:function(){var bankView=this.resourcesPanelView.getBankById("numeral-cards");if(bankView){var items=this.resourcesStage.getItemsByType("numeral-cards"),alreadyAddedItemIds=_.map(items,function(item){return item.bankItemId}),bankItems=bankView.getItemsBySelector(".resource-item");_.each(bankItems,function(bankItem){bankItem.$el.removeClass("already-added-to-stage"),_.contains(alreadyAddedItemIds,bankItem.$el.attr("data-bank-item-id"))&&bankItem.$el.addClass("already-added-to-stage")})}}},Obj.extend("a5.components.Resources"),a5.LOInfo={init:function(initObj){var info=initObj.info;this.loOptions=new a5.models.options.Options,this.assessmentOptions=new a5.models.options.Options,this.debuggerOptions=new a5.models.options.Options,this.LOOptions=new a5.models.options.Options([this.loOptions,this.assessmentOptions,this.debuggerOptions]),_.isUndefined(info)||(_.isUndefined(info.LOOptions)||this.loOptions.readAll(info.LOOptions),_.isUndefined(info.assessmentOptions)||this.assessmentOptions.readAll(info.assessmentOptions),_.isUndefined(info.debugOptions)||this.debuggerOptions.readAll(info.debugOptions),_.isUndefined(info.UID)||(this.uid=info.UID),_.isUndefined(info.ID)||(this.id=info.ID),_.isUndefined(info.title)||(this.title=info.title))}},Obj.extend("a5.LOInfo",a5.LOInfo),a5.MainBuilder={init:function(){a5.eventBus.trigger("performance:engine_mainbuilder:start"),this.curTask=0,this.intList=[],this.allInteractionsList=[],this.curInteraction=null,this.curFontSize=null,this.interactionsLoader=new a5.service.InteractionsLoader,this.introScreen=null,this.status="input",this.LOInfo=null,this.platformOptions=null,this.startTime=(new Date).getTime(),this.loTimer=new a5.utils.Timer,this.aggregatedLODuration=0,this.sessionLODuration=0,this.submitAttempts=0,this.sendScoreAttempts=0,this.confidenceLevel=["",""],this.lastCheckedInteraction=-1,this.globalHashList={},this.isRunningScore=!1,this.totalSubmitted=!1,this.xmlList=[],this.document=document,this.$body=$(document.body),this.navigationHistory=new a5.model.NavigationHistory,this.metadata=null,this.justSubmitted=!1,this.justScoresSent=!1,this.loadScreensOnDemand=a5.dp.config.loadScreensOnDemand,this.note="",a5.hooks.interactionShowed.add(_.bind(function(interaction){this.navigationHistory.addNavigationAction(interaction)},this)),$("a[href='close']").click(function(e){e.preventDefault(),a5_closeLO()}),$("a#page-close").on("click",_.bind(this.onClickClose,this)),a5.dp.config.postMessageUIManagement&&a5.service.postMessager.addListener("finalizeLO",_.bind(this.close,this)),a5.service.postMessager.addListener("pauseLO",_.bind(this.pauseLO,this)),$(window).on("beforeunload",_.bind(this.onWindowBeforeUnload,this)),$(window).on("unload",_.bind(this.onWindowUnload,this)),this.initLOInfo(),this.initPlatformOptions(),this.initFontSize(),a5.service.reactEngineInterface.addToState(a5.service.React.actions.lo.SET_LO_OPTIONS,this.LOInfo.LOOptions),this.canSubmit=!this.options(!0).showSubmitIsOff()||!this.options(!0).finishSubmitIsOff()||"Formative"===LOInfo.mode,this.canSendScores=!this.options(!0).sendscoresIsOff(),this.initMaxAttempts(),this.initExamTimer(),Object.defineProperty(this,"checkMaxAttempts",{get:function(value){return logger.warn("Deprecated 'a5.mainBuilder.checkMaxAttempts' object. Use 'a5.mainBuilder.getCheckMaxAttemptsNumber()' instead."),this.getCheckMaxAttemptsNumber()}}),this.spinner=new a5.Spinner;var loTitleClass="lo-title-"+(this.options(!0).lOtitledisplayIsOff()?"off":"on"),activityTitleClass="activity-title-"+(this.options(!0).activitytitledisplayIsOff()?"off":"on"),fontSizeClass="lo-fontsize-"+a5.service.lms.API.getLOFontSize(),loControlsClass="lo-controls-"+(A5.LO_WITHOUT_CONTROLS?"off":"on");this.$body.addClass(loTitleClass),this.$body.addClass(activityTitleClass),this.$body.addClass(fontSizeClass),this.$body.addClass(loControlsClass),a5.dp.config.protectImages&&$(document).on("dragstart contextmenu","img",!1),this.loTimer.stamp(),a5.eventBus.trigger("lo:start",{uid:this.LOInfo.uid,id:this.LOInfo.id,lo:this}),a5.eventBus.trigger("performance:engine_mainbuilder:end")},goToPrevLO:function(){a5.eventBus.trigger("lo:prev")},goToNextLO:function(){a5.eventBus.trigger("lo:next")},initFontSize:function(){this.availableFontSizes=_.range(1,a5.dp.config.fontSizeSteps+1),this.availableFontSizes.length&&this.setFontSize(this.getDefaultFontSize())},getAvailableFontSizes:function(){return this.availableFontSizes},getDefaultFontSize:function(){return a5.dp.config.fontSizeDefault},getCurrentFontSize:function(){return this.curFontSize},setFontSize:function(size){if(_.contains(this.availableFontSizes,size)){var $html=$(this.document.documentElement);this.curFontSize&&$html.removeClass("lo-fontsize-"+this.curFontSize),this.curFontSize=size,$html.addClass("lo-fontsize-"+this.curFontSize),a5.hooks.interactionFontUpdated.call()}},resetFontSize:function(){this.setFontSize(this.getDefaultFontSize())},setFontFamily:function(family){$(this.document.documentElement).addClass("lo-fontfamily-"+family),a5.hooks.interactionFontUpdated.call()},resetFontFamily:function(family){family?$(this.document.documentElement).removeClass("lo-fontfamily-"+family):$(this.document.documentElement).removeClass(function(index,className){return className.split(/\s+/).filter(function(c){var regex=new RegExp("^lo-fontfamily-");return c.match(regex)}).join(" ")}),a5.hooks.interactionFontUpdated.call()},getCurrentFontClasses:function(){return $(this.document.documentElement).attr("class").split(/\s+/).filter(function(c){var regex=new RegExp("^lo-(fontfamily|fontsize)-");return c.match(regex)})},getFontClassesRegex:function(){return new RegExp("^lo-(fontfamily|fontsize)-")},hasNextLO:function(){return this.engine.invoke("lo:has-next")},hasPrevLO:function(){return this.engine.invoke("lo:has-prev")},showDebugToolbar:function(){this.debugToolbar=new a5.debug.DebugToolbar,this.debugToolbar.render(this.$body)},numberOfInteractions:function(withEndResult){var count=this.intList.length;return withEndResult||!this.options().endResultScreenIsTrue()&&!this.options().endResultAlwaysIsOn()||(count-=1),count},getNumberOfInteractions:function(withEndResult){return this.numberOfInteractions(withEndResult)},getCurrentInteraction:function(){return this.curInteraction},getSolvableInteractions:function(){return _(this.getInteractionsWithoutEndResult()).filter(function(interaction){return interaction.isSolvable()})},getInteractionsWithoutIntroScreen:function(intList){return this.options().introScreenIsOn()&&(intList=_.rest(intList)),_(intList).reject(function(interaction){return interaction.locked})},getInteractionsWithoutEndResult:function(){var intList=this.intList;return(this.options().endResultScreenIsTrue()||this.options().endResultAlwaysIsOn())&&(intList=_.initial(intList)),_(intList).reject(function(interaction){return interaction.locked})},getUnsolvedInteractions:function(threshold){var intList=this.getSolvableInteractions();return _(intList).filter(function(interaction){return interaction.manualCheckAttempts>0&&interaction.getResults().percent()<threshold})},getSolvedInteractions:function(threshold){var intList=this.getSolvableInteractions();return _(intList).filter(function(interaction){return interaction.manualCheckAttempts>0&&interaction.getResults().percent()>=threshold})},getNotAttemptedInteractions:function(){var intList=this.getInteractionsWithoutEndResult();return _(intList).filter(function(interaction){return 0===interaction.manualCheckAttempts})},getAllCorrectAttemptInteractions:function(attempt){var intList=this.getSolvableInteractions();return _(intList).filter(function(interaction){return interaction.manualCheckAttempts===attempt&&interaction.getResults().isPercent100()})},getAdaptiveInteractions:function(){var intList=this.intList;return _.reject(intList,function(interaction){return interaction.skippedByAdaptive&&0===interaction.manualCheckAttempts},this)},getInteractionsWithAttachments:function(){var interactions=_.chain([this.introScreen,this.intList]).flatten().compact().value();return _.filter(interactions,function(interaction){return interaction.hasAttachments()})},getCheckMaxAttempts:function(){var result={items:[],selection:"off",number:0};try{result=JSON.parse(this.options().getCheckmaxattempts()),"LO_setting"===result.selection&&(result=JSON.parse(htmlDecode(this.options(!0).getCheckmaxattempts()))),result.number=parseInt(result.selection,10)||0,_.isUndefined(result.selection)&&(result.selection="off")}catch(e){}return _.extend(result,{get:function(index){return result.items[index]&&result.items[index].label||""}})},getCheckMaxAttemptsNumber:function(){return this.getCheckMaxAttempts().number},someManuallyMarked:function(){for(var cnt=0;cnt<this.numberOfInteractions();cnt+=1)if(this.intList[cnt].options.manualMarkingIsOn())return!0;return!1},options:function(loOptions){return this.curInteraction&&!loOptions?this.curInteraction.options:this.LOInfo.LOOptions},setLanguageToAllInteractions:function(lang,except){_.each(this.intList,function(interaction){interaction!=except&&_.contains(interaction.getRegisteredLanguages(),lang)&&interaction.setLanguage(lang,this)},this)},updateScores:function(){this.checkAutomaticNext(),this.trigger("frequent_score_update",this.getCurrentInteractionScores())},updateScoresAsync:function(){requestAnimationFrame(_.bind(function(){this.updateScores()},this))},areAllChecked:function(interactions){var intList=interactions||this.getInteractionsWithoutEndResult();return!_.some(intList,function(interaction){return 0===interaction.checkAttempts&&interaction.isSolvable()})},checkAnswerWithFeedbackAllCorrect:function(){this.curInteraction.setAnswer(),this.curInteraction.manualCheckAttempts++,this.showActivityScoreWithFeedbackAllCorrect(this.curInteraction.getResults()),this.lastCheckedInteraction=this.curTask,a5.eventBus.trigger("interaction:check_answer")},checkAnswerInput:function(){this.curInteraction.setAnswerInput()},checkAnswer:function(){"Formative"===LOInfo.mode?this.checkAnswerFormative():this._checkAnswer(),this.curInteraction.store(),this.options(!0).sendscoresIsFinal_check_answers()&&this.areAllChecked()&&this.sendScores()},_showResultsDialog:function(){(new a5.view.AutoEndResults).display()},_checkAnswer:function(){if(!this.options().delayedFeedbackIsFalse())return void this.showDelayedFeedback();var interactions=this.getDelayedFeedbackInteractions();interactions.unshift(this.curInteraction);var results=this.getResults(function(interaction){return _.contains(interactions,interaction)});_.each(interactions,function(interaction){interaction.setAnswer(),interaction.manualCheckAttempts++}),this.options().checkAnswersDisplayIsMarking_and_feedback()&&"Exam"!==LOInfo.mode&&"Trainer"!==LOInfo.mode&&this.showActivityScore(results),this.lastCheckedInteraction=this.curTask,this.updateScores(),a5.eventBus.trigger("interaction:check_answer"),this.options().seeAnswersIsBeforeInteraction()&&!this.curInteraction.hasMoreCheckAttempts()&&($("#content").removeClass("inactive"),$("#content").addClass("inactive_activity"),this.curInteraction.showAnswer())},getLastFeedbackBand:function(){return this._lastFeedbackBand},setLastFeedbackBand:function(feedback){this._lastFeedbackBand=feedback},getLastCheckMaxFeedback:function(){return this._lastCheckMaxFeedback},setLastCheckMaxFeedback:function(feedback){this._lastCheckMaxFeedback=feedback},getDelayedFeedbackInteractions:function(){for(var interactions=[],i=this.curTask-1;i>=0;i--){var interaction=this.intList[i];if(!interaction.options.delayedFeedbackIsTrue())break;interactions.push(interaction)}return interactions},showDelayedFeedback:function(){var data={dialogClass:"dialog-delayed-feedback"},options=this.curInteraction.options;options.delayedFeedbackIsCustom()&&(data.text=options.getDelayedFeedback()),a5.view.dialog.display("a5.view.dialog.DelayedFeedback",data,{})},showActivityScore:function(results){var feedback,random_band=a5.utils.getRandomSubstring(this.getFeedbackBand());this.setLastFeedbackBand(random_band);var allCorrect=results.isPercent100(!0),correctClass=allCorrect?"all-correct":"some-errors";$(a5.dp.config.appendFeedbackTo).removeClass("all-correct some-errors"),$(a5.dp.config.appendFeedbackTo).addClass(correctClass),this.getCheckMaxAttemptsNumber()&&(feedback=this.getCheckMaxAttempts().get(this.curInteraction.checkAttempts-1),feedback=a5.utils.getRandomSubstring(feedback),feedback=a5.preprocessor.apply(feedback,this.curInteraction),this.setLastCheckMaxFeedback(feedback));a5.view.dialog.display("a5.view.dialog.CheckInfo",{dialogClass:"feedback-dialog dialog-check-info "+correctClass,percent:Math.round(results.percent()),total:results.total(),correct:results.correct(),allCorrect:allCorrect,feedback:feedback,feedbackBand:random_band,attempt:this.curInteraction.checkAttempts},{close:function(){this.curInteraction.trigger("interaction:feedback_band:close")}.bind(this)},!1,!0,a5.dp.config.appendFeedbackTo);this.curInteraction.trigger("interaction:feedback_band")},showActivityScoreWithFeedbackAllCorrect:function(results){var random_band=a5.utils.getRandomSubstring(this.getFeedbackBand());this.setLastFeedbackBand(random_band);var allCorrect=results.isPercent100(!0),correctClass=allCorrect?"all-correct":"some-errors";a5.view.dialog.display("a5.view.dialog.CheckInfo",{dialogClass:"feedback-dialog dialog-check-info "+correctClass,total:results.total(),correct:results.correct(),allCorrect:allCorrect,feedbackBand:random_band},{close:function(){this.curInteraction.trigger("interaction:feedback_band:close")}.bind(this)},!1,!0,a5.dp.config.appendFeedbackTo),this.curInteraction.trigger("interaction:feedback_band")},showActivityScoreWithFeedbackBeforeInteraction:function(results){var random_band=a5.utils.getRandomSubstring(this.getFeedbackBand());this.setLastFeedbackBand(random_band),a5.view.dialog.display("a5.view.dialog.CheckInfo",{dialogClass:"feedback-dialog dialog-check-info some-errors",total:results.total(),correct:results.correct(),allCorrect:!1,feedbackBand:random_band},{close:function(){this.curInteraction.trigger("interaction:feedback_band:close")}.bind(this)},!1,!0,a5.dp.config.appendFeedbackTo),this.curInteraction.trigger("interaction:feedback_band")},getFeedbackBand:function(){for(var results=this.curInteraction.getResults(),bands=_.map(this.options().getActivityFeedbackThresholds().split(","),function(x){return parseInt(x,10)});bands.length<3;)bands.unshift(0);var percent=results.percent(),band=3;percent<bands[2]&&(band=2),percent<bands[1]&&(band=1),percent<bands[0]&&(band=0);var bandID=["356","355","354","353"][band],feedback="";for(this.options().has(bandID)&&"false"!=this.options().get(bandID)&&(feedback=_.unescape(this.options().getValue(bandID))),bands=_.map(this.options().getActivityFeedbackThresholds().split(","),function(x){return parseInt(x,10)});bands.length<3;)bands.unshift(0);percent=results.percent(),band=3,percent<bands[2]&&(band=2),percent<bands[1]&&(band=1),percent<bands[0]&&(band=0),bandID=["356","355","354","353"][band],feedback="",this.options().has(bandID)&&"false"!=this.options().get(bandID)&&(feedback=_.unescape(this.options().getValue(bandID))),feedback=feedback.replace(/src=(['"])http(s)*:/gi,"src=$1");var preprocessor=new a5.preprocessor.TranslationBlock;return preprocessor.isResponsible(this.curInteraction,this.curInteraction.identifier,feedback)&&(feedback=preprocessor.preprocess(feedback)),feedback},checkAnswerFormative:function(){this.curInteraction.setAnswer(),this.lastCheckedInteraction=this.curTask,this.updateScores();var results=this.curInteraction.getResults(),feedback=this.getFeedbackBand(),showSubmitData=this.options(!0).getShowSubmit(),showDialog=_.partial(a5.view.dialog.display,"a5.view.dialog.CheckedAnswers",{dialogClass:"dialog-checked-answers",lastPage:this.curInteraction.isLastInteraction(),checked:this.curInteraction.timesChecked,total:results.human().total(),correct:results.human().correct(),feedback:a5.utils.getRandomSubstring(feedback),submitText:showSubmitData.submitText,submitTooltip:showSubmitData.submitTooltip},{tryAgain:_.bind(function(){this.tryAgain(),this.curInteraction.timesChecked++},this),next:_.bind(function(){this.goNext()},this),submit:_.bind(function(){this.options(!0).onlineCheckIsOn()&&!navigator.onLine?a5.view.dialog.display("a5.view.dialog.OfflineCheck",{dialogClass:"offline-check"},{close:_.partial(_.defer,showDialog)},!1,!1,a5.dp.config.appendOfflineTextTo):(this.submit(),_.each(this.intList,function(i){i.showAnswer()}))},this)},!1,!0).bind(a5.view.dialog);showDialog()},checkAutomaticNext:function(){if(this.options().automaticNextIsQuestions()&&this.curInteraction.isLiveCycle("loaded")&&"input"==this.curInteraction.getStatus()){var scores=this.curInteraction.getScores();scores.total==scores.filled&&this.goNext()}},showAnswer:function(){if(this.options().seeAnswersIsBeforeInteraction()){var dialogTemplate=this.curInteraction.checkAttempts?"a5.view.dialog.SeeAnswersAfterCheck":"a5.view.dialog.SeeAnswersBeforeCheck";a5.view.dialog.display(dialogTemplate,{dialogClass:"confirmation-dialog dialog-see-answers"},{ok:_.bind(function(){this.curInteraction.showAnswerBeforeInteraction(),a5.dp.config.showActivityFeedbackAfterSeeAnswersBeforeInteraction&&this.showActivityScoreWithFeedbackBeforeInteraction(this.curInteraction.getResults())},this),cancel:_.bind(function(){},this)})}else this.curInteraction.showAnswer()},showNextAnswer:function(){this.curInteraction.showNextAnswer()},showAllAnswer:function(){this.curInteraction.showAllAnswer()},showSolutionHint:function(){this.curInteraction.showSolutionHint()},tryAgain:function(){this.curInteraction.tryAgain(),this.justSubmitted=!1,this.justScoresSent=!1,a5.eventBus.trigger("interaction:try_again")},reset:function(){a5.view.dialog.display("a5.view.dialog.ReallyReload",{dialogClass:"dialog-really-reload"},{ok:_.bind(function(){this.reloadCurrentInteraction()},this)})},resetAll:function(){a5.view.dialog.display("a5.view.dialog.ReallyReloadAll",{dialogClass:"dialog-really-reload-all"},{ok:_.bind(function(){this.reloadAllInteractions().then(function(){this.goFirst()}.bind(this))},this)})},reloadItemBank:function(){a5.view.dialog.display("a5.view.dialog.ReallyReload",{dialogClass:"dialog-really-reload"},{ok:_.bind(function(){this.reloadCurrentInteractionFromItemBank()},this)})},reloadInteractions:function(interactions,config){return this.trigger("reset",interactions),this.justSubmitted=!1,this.justScoresSent=!1,$.when.apply($,_.invoke(interactions,"reload",config))},reloadCurrentInteraction:function(){return this.reloadInteractions([this.curInteraction])},reloadAllInteractions:function(){return this.submitAttempts=0,this.sendScoreAttempts=0,this.confidenceLevel=["",""],this.pauseLO(),this.reloadInteractions(this.intList,{skipRestore:!0})},reloadCurrentInteractionFromItemBank:function(){if(this.curInteraction.hasItemBank())return this.interactionsLoader.reload(this.curInteraction).then(function(){return this.reloadInteractions([this.curInteraction],{skipReset:!0})}.bind(this))},meetsMinLength:function(){return _.every(this.intList,function(interaction){return interaction.items.meetsMinLength()})},submit:function(no_confirm){var deferredSubmit=$.Deferred();if(this.$body.addClass("lo-submit-in-progress"),this.hasMoreSubmitAttempts())if(this.options(!0).onlineCheckIsOn()&&!navigator.onLine)this.showOfflineWarning(),deferredSubmit.reject();else if(this.options(!0).finishSubmitIsOn())this.submitFinish(deferredSubmit);else{var results=this.getResults(),confirmIfUnanswered=!("if-unanswered"!==a5.dp.config.confirmBeforeSubmit||results.areAllFilled()&&this.meetsMinLength()),confirmAlways="always"===a5.dp.config.confirmBeforeSubmit;"Formative"===LOInfo.mode||no_confirm||!confirmIfUnanswered&&!confirmAlways?this.submitEverything(deferredSubmit):this.showSubmitWarning({onConfirm:function(){this.submitEverything(deferredSubmit)}.bind(this),onCancel:function(){deferredSubmit.reject()}.bind(this)})}else deferredSubmit.reject();return deferredSubmit.always(function(){this.$body.removeClass("lo-submit-in-progress")}.bind(this)),deferredSubmit.then(function(submitData){return a5.eventBus.trigger("lo:submit",submitData),a5.eventBus.trigger("lo:finish"),submitData})},submitEverything:function(deferredSubmit){var results=this.getResults();this.justSubmitted=!0,this.submitAttempts++,this.totalSubmitted=!this.hasMoreSubmitAttempts(),this.setProgress(),this.timer&&this.timer.stop(),_.each(this.intList,function(interaction){"input"===interaction.getStatus()&&interaction.setAnswer(),interaction.store()}),this.updateLODuration(),this.saveDuration(),this.saveScores(),this.saveAttempts(),this.pauseLO(),a5.service.lms.API.submit(results,this.sessionLODuration).then(function(isLOFinished){isLOFinished||(this.hasEndResultScreen()?this.goToResultScreen():a5.dp.config.closeLOAfterSubmit?this.close():this.showSubmitInfo()),deferredSubmit.resolve({score:results,duration:this.sessionLODuration})}.bind(this))},submitFinish:function(deferredSubmit){var results=this.getResultsAsCompleted();this.justSubmitted=!0,this.submitAttempts++,this.totalSubmitted=!this.hasMoreSubmitAttempts(),this.setProgress(),this.timer&&this.timer.stop(),this.updateLODuration(),this.saveDuration(),this.saveScoresAsCompleted(),this.saveAttempts(),this.pauseLO(),a5.service.lms.API.submit(results,this.sessionLODuration).then(function(isLOFinished){isLOFinished||this.showSubmitFinish({onClose:function(){this.goToResultScreen()}.bind(this)}),deferredSubmit.resolve({score:results,duration:this.sessionLODuration})}.bind(this))},showSendScoresInfo:function(){var results=this.getResults();a5.view.dialog.display("a5.view.dialog.SendScoresInfo",{dialogClass:"dialog-send-scores",correct:results.human().correct(),total:results.human().total()})},showNotAllCheckedWarning:function(callbacks){a5.view.dialog.display("a5.view.dialog.sendScores",{dialogClass:"dialog-send-scores"},{ok:function(){callbacks.onConfirm()},close:function(okClicked){okClicked||callbacks.onCancel()}})},showOfflineWarning:function(){a5.view.dialog.display("a5.view.dialog.OfflineCheck",{dialogClass:"offline-check"},{},!1,!1,a5.dp.config.appendOfflineTextTo)},showSubmitFinish:function(callbacks){a5.view.dialog.display("a5.view.dialog.SubmitFinish",{dialogClass:"dialog-submit-finish"},{close:callbacks.onClose})},showSubmitWarning:function(callbacks){var showSubmitData=this.options(!0).getShowSubmit(),data={dialogClass:"confirmation-dialog dialog-really-submit",minLengthNotReached:!this.meetsMinLength(),heading:showSubmitData.dialogHeadingText,headingTooltip:showSubmitData.dialogHeadingTooltip,text:showSubmitData.dialogContentText,textTooltip:showSubmitData.dialogContentTooltip,cancelLabel:showSubmitData.dialogCancelText,cancelTooltip:showSubmitData.dialogCancelTooltip,submitLabel:showSubmitData.dialogSubmitText,submitTooltip:showSubmitData.dialogSubmitTooltip};a5.view.dialog.display("a5.view.dialog.ReallySubmit",data,{ok:function(){callbacks.onConfirm()},close:function(okClicked){okClicked||callbacks.onCancel(),this.$body.removeClass("dialog-no-overlay")}.bind(this)},void 0,!0),this.$body.addClass("dialog-no-overlay")},sendScores:function(){var deferredSendScores=$.Deferred();if(this.$body.addClass("lo-send-scores-in-progress"),this.hasMoreSendScoreAttempts()){var results=this.getResultsForSubmitted(),hasEndResultScreen=this.hasEndResultScreen(),isAdaptive=this.options().forwardButtonIsAdaptive();this.areAllChecked()||isAdaptive?hasEndResultScreen?(this.sendScoreAttempts++,this.pauseLO(),this.saveScores(),this.saveAttempts(),this.updateLODuration(),this.saveDuration(),this.goToResultScreen(),deferredSendScores.resolve({score:results})):(this.sendScoreAttempts++,this.pauseLO(),this.options(!0).sendscoresIsFinal_check_answers()?this._showResultsDialog():this.showSendScoresInfo(),this.saveScores(),this.saveAttempts(),this.updateLODuration(),this.saveDuration(),deferredSendScores.resolve({score:results}),a5.dp.config.postMessageUIManagement&&this.sendPostMessageComplete()):this.showNotAllCheckedWarning({onConfirm:function(){this.sendScoreAttempts++,this.pauseLO(),hasEndResultScreen?(this.saveScores(),this.saveAttempts(),this.updateLODuration(),this.saveDuration(),this.goToResultScreen(),deferredSendScores.resolve({score:results})):_.defer(function(){this.showSendScoresInfo(),this.saveScores(),this.saveAttempts(),this.updateLODuration(),this.saveDuration(),deferredSendScores.resolve({score:results})}.bind(this))}.bind(this),onCancel:function(){deferredSendScores.reject()}})}else deferredSendScores.reject();return deferredSendScores.always(function(){this.$body.removeClass("lo-send-scores-in-progress")}.bind(this)),deferredSendScores.then(function(scoreData){return a5.eventBus.trigger("lo:total_score",scoreData),scoreData})},saveDuration:function(){a5.service.lms.API.setData("duration",this.aggregatedLODuration)},saveAttempts:function(){var attempts=0;this.canSubmit?attempts=this.submitAttempts:this.canSendScores&&(attempts=this.sendScoreAttempts),a5.service.lms.API.setData("attempts",attempts)},saveExamTime:function(){a5.service.lms.API.setData("examTimeElapsed",this.examTimeElapsed),a5.service.lms.API.setData("examTimeOnExtraTime",this.examTimeOnExtraTime)},saveScores:function(){var detailedScores=this.getDetailedScores();a5.service.lms.API.setDetailedScore(detailedScores);var results=this.getResultsForSubmitted();a5.service.lms.API.setScore(results),this.justScoresSent=!0,this.trigger("score_update"),this.updateLocalStorage(),this.updateScores()},saveScoresAsCompleted:function(){var results=this.getResultsAsCompleted();a5.service.lms.API.setScore(results),this.justScoresSent=!0,this.updateLocalStorage(),this.updateScores()},saveNotes:function(){
a5.service.lms.API.setData("note",this.note)},updateNotes:function(note){this.note=note},openNotes:function(){this.notebook&&this.notebook.toggle()},closeNotes:function(){this.notebook&&this.notebook.close()},updateLocalStorage:function(){try{if(!_.isUndefined(window.mu)&&window.localStorage){var scores=this.getResultsForSubmitted();window.localStorage.getItem(window.project+window.mu[0])?window.localStorage.setItem(window.project+"last_"+window.mu[0],JSON.stringify({u:window.mu[1],l:window.mu[2],c:window.mu[3],total:scores.total(),correct:scores.correct(),filled:scores.filled()})):window.localStorage.setItem(window.project+window.mu[0],JSON.stringify({u:window.mu[1],l:window.mu[2],c:window.mu[3],total:scores.total(),correct:scores.correct(),filled:scores.filled()}))}}catch(e){logger.warn(e)}},showSubmitInfo:function(){var results=this.getResults(),attemptsLeft=this.maxAttempts-this.submitAttempts,maxAttempts=this.maxAttempts;_.isFinite(maxAttempts)||(attemptsLeft="Unlimited",maxAttempts="Unlimited"),a5.view.dialog.display("a5.view.dialog.SubmitInfo",{dialogClass:"dialog-submit-info",maxAttempts:maxAttempts,attemptsLeft:attemptsLeft,correct:results.human().correct(),incorrect:results.human().incorrect(),filled:results.human().filled(),total:results.human().total(),attempts:this.submitAttempts,percent:Math.round(results.percent())})},showResults:function(){if(this.options().endResultScreenIsTrue()||this.options().endResultAlwaysIsOn())return"Exam"!==LOInfo.mode&&"Trainer"!==LOInfo.mode||_.last(this.intList).rubricZone.hide(),this.goLast()},showExercises:function(){return this.options().endResultAlwaysIsOn()||this.options().endresultsreturnIsFirst()?this.goFirst(!0):this.goLast(!0)},getScores:function(){var scores=new a5.Score,intList=this.getAdaptiveInteractions();return _.each(intList,function(interaction){if(void 0!==interaction){var score=interaction.getScores();void 0!==score&&(scores.total+=score.total,scores.correct+=score.correct,scores.filled+=score.filled,scores.totalBlocks+=score.totalBlocks,scores.correctBlocks+=score.correctBlocks)}}),scores},getDetailedScores:function(){var intList=this.getAdaptiveInteractions();return _.map(intList,function(i){var res=i.getResults(),type="";return type=i.isIntroScreen()?"intro":i.isEndResultScreen()?"endresult":i.options.manualMarkingIsOn()?"manual":"auto",[type,"auto"===type?res.correct():null,res.total()]})},getResults:function(limitTo,scoreFetcher){limitTo=limitTo||function(){return!0};var results=new a5.ResultList,intList=this.getAdaptiveInteractions();return _.each(_.filter(intList,limitTo),function(interaction){var result=interaction.getResults(scoreFetcher);results.push(result)}),results},getResultsAsCompleted:function(){return new a5.CompletedResult},getCurrentInteractionScores:function(){if(this.curInteraction){var scores=this.curInteraction.getScores(),results=this.curInteraction.getResults(function(){return scores});return{scores:scores,results:results}}},getResultsForSubmitted:function(){return this.getResults(void 0,function(interaction){var score=interaction.getScores();return"input"==interaction.getStatus()&&(score.correct=0,score.correctBlocks=0),score})},getAttempts:function(){var attempts=0;return this.canSubmit?attempts=this.submitAttempts:this.canSendScores&&(attempts=this.sendScoreAttempts),attempts},_applyPreScreenTransition:function(from,to){var direction=from-to<0?"right":"left",$from=this._getInteractionNode(from),$to=this._getInteractionNode(to),offset=$from.offset();$from.css({top:-window.scrollY+offset.top}),this.$body.addClass("screen-transition transition-"+direction),$from.addClass("former"),$to.css({top:offset.top}),a5.dp.config.screenTransitionStart($from,$to)},_applyPostScreenTransition:function(from,to){var $from=this._getInteractionNode(from),$to=this._getInteractionNode(to);$to.addClass("current"),_.defer(function(){this.$body.addClass("transition")}.bind(this)),setTimeout(function(e){this.$body.removeClass("screen-transition transition"),this.$body.removeClass("transition-left transition-right"),$(".content-wrap").removeClass("current former"),this.curInteraction.trigger("screen_transition:end"),a5.dp.config.screenTransitionEnd($from,$to)}.bind(this),a5.dp.config.screenTransitionDuration)},_getInteractionNode:function(interactionIndex){return this.getInteractionFromIndex(interactionIndex).contentWrap},_unfocusEverything:function(){this.curInteraction.contentWrap.find(":focus").blur(),window.CKEDITOR&&CKEDITOR.instances&&_.each(CKEDITOR.instances,function(instance){instance.focusManager.blur(!0)})},goTo:function(interactionIndex){this.curInteraction&&(this.curInteraction.store(),this._unfocusEverything(),a5.dp.config.screenTransitionEnabled&&this._applyPreScreenTransition(this.curInteraction.index,interactionIndex),this.curInteraction.contentWrap.find(":focus").blur()),this.startTask(interactionIndex),this._adjustForwardButtonLabel(this.curTask),this.curInteraction&&a5.dp.config.screenTransitionEnabled&&this._applyPostScreenTransition(this.curInteraction.index,interactionIndex)},goNext:function(){var tNum=this._nextAdaptiveInteraction();if(-1==tNum){var intList=_([this.introScreen,this.intList]).chain().flatten().compact().value();tNum=this._nextAvailableInteraction(intList,this.curTask)}return tNum!==this.curTask&&(this.goTo(tNum),!0)},goLast:function(withoutEndResult){var intList=withoutEndResult?this.getInteractionsWithoutEndResult():this.intList;intList=_([this.introScreen,intList]).chain().flatten().compact().value();var tNum=this._lastAvailableInteraction(intList);return tNum!==this.curTask&&(this.goTo(tNum),!0)},goPrev:function(){var intList=_([this.introScreen,this.intList]).chain().flatten().compact().value(),tNum=this._previousAvailableInteraction(intList,this.curTask);return tNum!==this.curTask&&(this.goTo(tNum),!0)},goFirst:function(withoutIntroScreen){var intList=_([this.introScreen,this.intList]).chain().flatten().compact().value();withoutIntroScreen&&(intList=this.getInteractionsWithoutIntroScreen(intList));var tNum=this._firstAvailableInteraction(intList);return tNum!==this.curTask&&(this.goTo(tNum),!0)},goToResultScreen:function(){return this.showResults()},goToExerciseScreen:function(){return this.showExercises()},hasPrev:function(){var intList=_([this.introScreen,this.intList]).chain().flatten().compact().value();return this.curTask>this._firstAvailableInteraction(intList)},hasNext:function(withoutEndResult){var intList=withoutEndResult?this.getInteractionsWithoutEndResult():this.intList;return intList=_([this.introScreen,intList]).chain().flatten().compact().value(),this.curTask<this._lastAvailableInteraction(intList)},hasIntroScreen:function(){return!!this.introScreen},hasEndResultScreen:function(){return _.last(this.intList).isEndResultScreen()},reveal:function(){var elements=this._getHiddenElements();if(this.options().revealObjectIsAll())elements.removeClass("opt-021-hidden").addClass("opt-021-revealed");else if(elements.length>0){var $next=this._getNextHiddenElements(elements);a5.utils.scrollIntoElementIfNeeded($next.removeClass("opt-021-hidden").addClass("opt-021-revealed"),{behavior:"smooth",block:"start",inline:"nearest"}),elements.length==$next.length&&this.options().revealObjectIsProgressiveplushide()&&(this.curInteraction.revealIsHiding=!0)}this.updateScores()},hideRevealed:function(){var elements=this._getRevealedElements();if(this.options().revealObjectIsAll())elements.removeClass("opt-021-revealed").addClass("opt-021-hidden"),this.curInteraction.revealIsHiding=!1;else{var $next=this._getNextRevealedElements(elements);$next.removeClass("opt-021-revealed").addClass("opt-021-hidden"),elements.length>$next.length&&a5.utils.scrollIntoElementIfNeeded(elements.eq(-$next.length-1,{behavior:"smooth",block:"start",inline:"nearest"})),elements.length==$next.length&&(this.curInteraction.revealIsHiding=!1)}this.updateScores()},_getRevealedElements:function(){var elements=this.curInteraction.contentWrap.find(".opt-021-revealed").toArray();return elements=_.sortBy(elements,function(elem){return parseInt(elem.getAttribute("data-opt-021-prio"),10)||1/0}),$(elements)},_getHiddenElements:function(){var elements=this.curInteraction.contentWrap.find(".opt-021-hidden").toArray();return elements=_.sortBy(elements,function(elem){return parseInt(elem.getAttribute("data-opt-021-prio"),10)||1/0}),$(elements)},_getNextHiddenElements:function(elements){var ref=elements.first();return _.isUndefined(ref.attr("data-opt-021-prio"))?ref:elements.filter(function(index,elem){return elem.getAttribute("data-opt-021-prio")===ref.attr("data-opt-021-prio")})},_getNextRevealedElements:function(elements){var ref=elements.last();return _.isUndefined(ref.attr("data-opt-021-prio"))?ref:elements.filter(function(index,elem){return elem.getAttribute("data-opt-021-prio")===ref.attr("data-opt-021-prio")})},addInteraction:function(url,preview,helpText,resources){this._addInteraction({url:url,preview:preview,helpText:helpText,resources:resources})},setAttempts:function(){if(this.maxAttempts>1&&this.maxAttempts<1e3&&this.submitAttempts<this.maxAttempts&&this.options(!0).finishSubmitIsOff()){$("#the_timer_wrap").show();var cAttempt=Math.min(this.maxAttempts,this.submitAttempts+1);$("#the_timer_wrap .timer_label").text("Attempt: "+cAttempt+"/"+this.maxAttempts)}else $("#the_timer_wrap").hide()},initIntroScreen:function(interaction){this.introScreen=interaction,interaction&&(this.introScreen.index=-1,this.introScreen.visibleIndex=0)},checkIntroScreen:function(list){if(this.options().introScreenIsOn())return _(list).first()},checkEndResultScreen:function(list){if(this.options().endResultScreenIsTrue()||this.options().endResultAlwaysIsOn())return _(list).last()},checkVisibility:function(interaction){var userVisibility=interaction.options.getUserVisibility();return"all"===userVisibility||userVisibility===a5.service.lms.API.getUserRole().toLowerCase()},getAllInteractionsGroups:function(list){return a5.utils.getInteractionsGroups(this.allInteractionsList)},initIntList:function(params){var setParams=_.extend({allowIntroScreen:!0,shuffle:!1,groups:null,count:!1},params),groups=[],allInteractionsList=this.allInteractionsList;if(setParams.groups){var filteredActivities=_.filter(this.allInteractionsList,function(interaction){return!_.isEmpty(interaction.group)&&_.contains(setParams.groups,interaction.group)});filteredActivities.length&&(groups=setParams.groups,allInteractionsList=this.userSelectScreen.concat(filteredActivities))}this.userSelectScreen&&this.userSelectScreen.length&&(allInteractionsList=groups.length?this.userSelectScreen.concat(allInteractionsList):this.userSelectScreen);var filteredList=_(allInteractionsList).filter(this.checkVisibility,this),introScreen=this.checkIntroScreen(allInteractionsList),endResultScreen=this.checkEndResultScreen(filteredList);filteredList=_(filteredList).filter(function(interaction){return interaction!==endResultScreen&&interaction!==introScreen}),setParams.shuffle&&(filteredList=_.shuffle(filteredList)),filteredList=groups.length?this.sliceInteractionsGroup(filteredList,groups,{shuffle:params.shuffle,count:params.count}):this.sliceInteractions(filteredList,{count:params.count}),endResultScreen&&(filteredList=filteredList.concat(endResultScreen)),_.each(filteredList,function(interaction,index){interaction.index=index,interaction.visibleIndex=index+1}),this.intList=filteredList,introScreen&&(introScreen=setParams.allowIntroScreen?introScreen:null,this.initIntroScreen(introScreen))},sliceInteractionsGroup:function(interactionsList,groups,config){var list=interactionsList,groupList=groups,count=config.count;if(count){count>groups.length&&(groupList=groupList.slice(0,config.count));var groupsOrdered=_.map(groupList,function(group){var interlist=_.where(list,{group:group});return config.shuffle&&(interlist=_.shuffle(interlist)),interlist});count=Math.min(count,_.reduce(groupsOrdered,function(memo,item){return memo+item.length},0)),config.shuffle&&(groupsOrdered=_.shuffle(groupsOrdered));for(var nextCatIndex=0,newList=[],i=0;i<count;i++){var cat=groupsOrdered[nextCatIndex],iteraction=cat.splice(0,1),nextCat=groupsOrdered[(nextCatIndex+1)%groupsOrdered.length];0===cat.length&&groupsOrdered.splice(nextCatIndex,1),nextCatIndex=groupsOrdered.indexOf(nextCat),newList=newList.concat(iteraction)}list=_.sortBy(newList,function(item){return groupList.indexOf(item.group)})}return config.shuffle&&(list=_.shuffle(list)),list},sliceInteractions:function(interactionsList,config){var list=interactionsList;return config.count&&(list=list.slice(0,config.count)),list},renderInteraction:function(interaction){return interaction.bind("show",function(){a5.eventBus.trigger("interaction:start",{id:this.index,interaction:this})}),interaction.render()},renderInteractions:function(interactions){var promises=[];return _(interactions).each(function(interaction){promises.push(this.renderInteraction(interaction))},this),promises},renderInteractionDelayed:function(interaction){var deferred=$.Deferred();return a5.tasks.push(new a5.FunctionTask(_.bind(function(){return a5.eventBus.trigger("performance:render_"+interaction.url+":start"),this.renderInteraction(interaction).done(function(){a5.eventBus.trigger("interaction:ready",interaction),deferred.resolve(),a5.eventBus.trigger("performance:render_"+interaction.url+":end")}),!0},this)),"interactions"),deferred.promise()},renderInteractionsDelayed:function(interactions){var promises=[];return _.each(interactions,function(interaction,i){promises.push(this.renderInteractionDelayed(interaction))},this),$.when.apply(this,promises)},openIntList:function(interactions,interactionIndex){var theInt=this.getInteractionFromIndex(interactionIndex);this._notifyOnLORestored(interactions);var _firstInteraction=this.renderInteractionDelayed(theInt),_restOfInteractions=this.renderInteractionsDelayed(_.without(interactions,theInt));this.goTo(interactionIndex),$.when(_firstInteraction,_restOfInteractions).done(function(){a5.eventBus.trigger("lo:ready",interactions),a5.eventBus.trigger("performance:render_LO:end")})},_notifyOnLORestored:function(interactions){if(this.options(!0).restoreLOStateIsOn()){this.restoring=!0;var interactionsToBeRestored=interactions,restoredListener=_.bind(function(interaction){interaction.unbind("restored",restoredListener),interactionsToBeRestored=_.without(interactionsToBeRestored,interaction),0===interactionsToBeRestored.length&&(this.restoring=!1,a5.eventBus.trigger("lo:restored",interactions))},this);_.invoke(interactions,"bind","restored",restoredListener)}},_loadInteractions:function(){var deferred=$.Deferred();return this.interactionsLoader.bind("finished",function(intList,userSelectScreen){this.allInteractionsList=intList,this.userSelectScreen=userSelectScreen,this.initIntList({allowIntroScreen:!0,shuffle:this.options().activitypoolIsRandomiseAll()});var interactions=_([this.introScreen,this.intList]).chain().flatten().compact().value();deferred.resolve(interactions)},this),this.interactionsLoader.start(),deferred.promise()},_loadLMSData:function(){return a5.service.lms.API.getData().then(function(data){if(this.confidenceLevel=data.confidenceLevel||["",""],this.aggregatedLODuration=data.duration,this.examTimeElapsed=data.examTimeElapsed,this.examTimeOnExtraTime=data.examTimeOnExtraTime,this.note=data.note||"",!this.options(!0).restoreLOStateIsOff()){var attempts=data.attempts||0;this.canSubmit?this.submitAttempts=attempts:this.canSendScores&&(this.sendScoreAttempts=attempts),data.displaySettings&&(this.currentDisplayPattern=data.displaySettings.pattern,this.currentDisplayBackground=data.displaySettings.background,this.$body.addClass(this.currentDisplayPattern),this.$body.addClass(this.currentDisplayBackground))}}.bind(this))},_getStartInteractionIndex:function(startActivity,interactions,bookmark){var interactionIndex;if(_.isNumber(startActivity)?(interactionIndex=startActivity,this.options().introScreenIsOn()&&(interactionIndex-=1)):_.isNumber(A5.START_TASK)?(interactionIndex=A5.START_TASK,this.options().introScreenIsOn()&&(interactionIndex-=1)):_.isNumber(bookmark)&&(interactionIndex=bookmark),null==interactionIndex&&(interactionIndex=this.options().introScreenIsOn()?-1:0),A5.DICTIONARY_REF){var target=_.find(interactions,function(interaction){return interaction.highlightDictionaryEntry()});target&&target.index>=0&&(interactionIndex=target.index)}var theInt=this.getInteractionFromIndex(interactionIndex);if(!theInt||theInt.locked){var firstAvailable=this._firstAvailableInteraction(interactions);if(interactionIndex===firstAvailable)throw"No available activities found";interactionIndex=firstAvailable}return interactionIndex},_start:function(interactions,interactionIndex){a5.eventBus.trigger("performance:render_LO:start"),this.timer&&this.timer.startOnShow(interactions),this.loadScreensOnDemand?this.goTo(interactionIndex):this.openIntList(interactions,interactionIndex),this.controls=new a5.view.controls.Bar(this),this._adjustForwardButtonLabel(this.curTask),this.screenNavigation=new a5.views.ScreenNavigation($("#unit-menu")),this.lessonNotes=new a5.views.LessonNotes($("#lesson-notes")),this.options(!0).lONotesAreaIsOn()&&(this.notebook=new a5.view.LONotesDialog(this),this.notebook.bind("open",function(){this.$body.addClass("notes-opened")},this),this.notebook.bind("close",function(){this.$body.removeClass("notes-opened")},this),this.$body.append(this.notebook.$el),this.notebook.render()),$("*[data-event=tools]").length>0&&(this.whiteboardTools=new a5.views.WhiteboardTools("*[data-event=tools]",interactions))},start:function(startActivity){var promises=[];promises.push($.when().then(function(){a5.eventBus.trigger("performance:engine_lmsdata:start")}).then(this._loadLMSData.bind(this)).then(function(){a5.eventBus.trigger("performance:engine_lmsdata:end"),a5.eventBus.trigger("performance:engine_load_interactions:start")}).then(this._loadInteractions.bind(this)).then(function(interactions){return a5.eventBus.trigger("performance:engine_load_interactions:end"),interactions})),_.isUndefined(startActivity)&&promises.push($.when(this.getBookmark())),$.when.apply(this,promises).then(function(interactions,bookmark){var interactionIndex=this._getStartInteractionIndex(startActivity,interactions,bookmark);this._start(interactions,interactionIndex)}.bind(this))},getBookmark:function(){if(!this.options().restoreLOStateIsOff())return a5.service.lms.API.getBookmark()},onWindowBeforeUnload:function(e){if(a5.service.lms.API.isDataDirty()){return e.returnValue="Are you sure you want to close the LO?","Are you sure you want to close the LO?"}},onWindowUnload:function(){a5.service.lms.API.clearDataDirty(),this.close(!0)},onClickClose:function(e){e.preventDefault();var dialog,dirty=a5.service.lms.API.isDataDirty();(a5.dp.config.confirmBeforeClose||dirty)&&(dialog=a5.view.dialog.display("a5.view.dialog.Close",{dialogClass:"dialog-close-lo",unsavedChanges:dirty},{ok:function(){a5.service.lms.API.clearDataDirty(),this.close()}.bind(this),cancel:function(){logger.info("LO Close Canceled")}},!1,!1,a5.dp.config.closeDialogAppendTo)),a5.dp.config.postMessageUIManagement?a5.service.postMessager.sendMessage("closeLO"):dialog||this.close()},sendPostMessageComplete:function(){a5.service.postMessager.sendMessage("completeLO"),a5.service.postMessager.sendMessage("closeLO")},save:function(){_(this.intList).invoke("store",!0),a5.service.lms.API.setData("displaySettings",{pattern:this.currentDisplayPattern,background:this.currentDisplayBackground}),a5.eventBus.trigger("lo:save")},pauseLO:function(){a5.service.media.pauseAll(),a5.service.media.audio.stopAll()},close:function(sync){if(!this.closed){var deferredClose=$.Deferred();this.closed=!0,logger.log("exit..."),null!=this.curInteraction&&this.curInteraction.store(),this.hasMoreSubmitAttempts()&&(this.updateLODuration(),this.saveDuration()),this.timer&&(this.updateExamTime(),this.saveExamTime()),A5.LMS_CLOSE?a5.service.lms.API.close(sync).then(function(){deferredClose.resolve()}):deferredClose.resolve(),this.deferredClose=deferredClose.then(function(){a5.eventBus.trigger("lo:end",this),a5.dp.config.allowLOSelfClosing&&window.close()})}return this.deferredClose},resetLO:function(){this.close(),this.$body.html("");var mainBuilder=new a5.MainBuilder(window.LOInfo),layout=new a5.Layout(A5.SKIN_URL,_.bind(function(){layout.applyPackageLayout().done(_.bind(function(){_.each(a5.mainBuilder.xmlList,function(path){mainBuilder.addInteraction(path)}),a5.mainBuilder=mainBuilder,a5.mainBuilder.layout=this.layout,a5.mainBuilder.start()},this))},this),!0)},getInteractionFromIndex:function(interactionIndex){return interactionIndex<0?this.introScreen:this.intList[interactionIndex]},startTask:function(interactionIndex){null!=this.curInteraction&&(this.curInteraction.hide(),this.curInteraction.stopAutosave(),a5.eventBus.trigger("interaction:end")),this.curTask=interactionIndex;var theInt=this.getInteractionFromIndex(interactionIndex);this.loadScreensOnDemand&&(theInt.isLiveCycle("loaded")||this.renderInteraction(theInt).done(function(){if(a5.eventBus.trigger("interaction:ready",theInt),!this.ready){this.ready=!0;var interactions=_([this.introScreen,this.intList]).chain().flatten().compact().value();a5.eventBus.trigger("lo:ready",interactions),a5.eventBus.trigger("performance:render_LO:end")}}.bind(this))),theInt.show(),this.curInteraction=theInt,this.curInteraction.options.autosaveIsOn()&&this.curInteraction.startAutosave(),this.spinner.toggleFor(theInt),a5.service.lms.API.setBookmark(this.curTask),this.setProgress(),this.updateScores(),this.updateControls()},updateControls:function(){this.controls&&this.controls.update()},_adjustForwardButtonLabel:function(interactionIndex){this.controls&&(this.controls.node.find("*[data-event='forward'] *[data-label-interaction]").css("display","none"),this.controls.node.find("*[data-event='forward'] *[data-label-interaction='"+interactionIndex+"']").css("display",""))},initLOInfo:function(){null==this.LOInfo&&(this.LOInfo=new a5.LOInfo({info:window.LOInfo}))},initPlatformOptions:function(){if(null==this.platformOptions){var options={};a5.service.lms.API.isTTSDisabled()&&(options["052"]={key:"false"},options["034"]={key:"false"}),this.platformOptions=new a5.models.options.Options,this.platformOptions.readAllFromObject(options)}},initMaxAttempts:function(){this.canSubmit?this.options(!0).submissionsIsUnlimited()||this.options(!0).finishSubmitIsOn()?this.maxAttempts=1/0:this.maxAttempts=parseInt(this.options(!0).getSubmissions(),10):this.canSendScores?this.options(!0).sendscoresIsUnlimited()||this.options(!0).sendscoresIsFinal_check_answers()?this.maxAttempts=1/0:this.maxAttempts=parseInt(this.options(!0).getSendscores(),10):this.maxAttempts=0},setProgress:function(){this.setAttempts()},getElapsedTime:function(){return this.loTimer.getTime()},updateLODuration:function(){this.sessionLODuration=this.getElapsedTime(),this.aggregatedLODuration=this.aggregatedLODuration||0,this.aggregatedLODuration+=this.sessionLODuration},updateExamTime:function(){this.examTimeElapsed=this.timer.getElapsedTime(),this.examTimeOnExtraTime=this.timer.isOnExtraTime()},initExamTimer:function(){if(this.options(!0).examsTimerIsOn()){var examTimerData=this.options(!0).getExamsTimer();if(examTimerData){var originalTime=examTimerData.time;this.timer=new a5.model_builder.ExamTimer(_.extend({originalTime:originalTime,lo:this},examTimerData))}}},getAnswerFromScreen:function(answerNum,screenNum){logger.warn("getAnswerFromScreen is not implemented")},interactionDataLoaded:function(interaction){var templateName=$(interaction.xml).children("assessmentitem").attr("template")||"default";a5.service.templates.loadLayoutTemplate(templateName,_.bind(interaction.templateLoaded,interaction),window.LOInfo.template)},loadTemplates:function(){},openDigitalBook:function(){this.engine.invoke("open-link",LOInfo.bookUrl,{target:"lessonPlan"+LOInfo.id+"DigitalBook"})},showLessonNotes:function(buttons){this.lessonNotes.show(),buttons.update()},showLesson:function(buttons){this.lessonNotes.hide(),buttons.update()},toggleToolbox:function(){window.a5a&&a5a.toolbox.view.toggle()},showWiki:function(buttons){this.curInteraction.wikiTool.show(),buttons.update()},fullscreen:function(){screenfull.enabled&&screenfull.toggle()},hasMoreSubmitAttempts:function(){var attemptsLeft=this.maxAttempts-this.submitAttempts;return!_.isFinite(attemptsLeft)||attemptsLeft>0},hasMoreSendScoreAttempts:function(){var attemptsLeft=this.maxAttempts-this.sendScoreAttempts;return!_.isFinite(attemptsLeft)||attemptsLeft>0},isFirstAttempt:function(){return 0===this.getAttempts()},_addInteraction:function(parameters){var interaction;_.defaults(parameters||{},{originalIndex:this.interactionsLoader.queue.length,locked:this._isLockedInteraction(parameters.url)}),this.xmlList.push(parameters.url),interaction=new a5.Interaction(parameters),interaction.bind("show",function(){this.curInteraction&&(this.spinner.toggleFor(this.curInteraction),this.curInteraction.removeBodySubstyle()),interaction.addBodySubstyle()},this),this.interactionsLoader.push(interaction)},_isLockedInteraction:function(url){var lockedInteractions=a5.service.lms.API.getLockedInteractions();return _(lockedInteractions).contains(url)},_nextAvailableInteraction:function(intList,index){var nextInteraction=_(intList).find(function(interaction){return interaction.index>index&&!interaction.locked});return nextInteraction?nextInteraction.index:index},_previousAvailableInteraction:function(intList,index){var prevInteraction=_(intList).chain().filter(function(interaction){return interaction.index<index&&!interaction.locked}).max(function(interaction){return interaction.index}).value();return prevInteraction?prevInteraction.index:index},_firstAvailableInteraction:function(intList){var first=_(intList).find(function(interaction){return!interaction.locked});return first?first.index:this.curTask},_lastAvailableInteraction:function(intList){var list=intList.slice(0).reverse(),last=_(list).find(function(interaction){return!interaction.locked});return last?last.index:this.curTask},_nextAdaptiveInteraction:function(){return this.curInteraction.getNextAdaptiveInteraction()}},Obj.extend("a5.MainBuilder",a5.MainBuilder),Obj.extend("a5.SpecialCharInserter",{init:function(){this.currentInput=null,this.lastInput=null,this.selectionStart=this.selectionEnd=0;var selectors=["textarea",'input[type="text"]'];$("body").on("blur",selectors.join(),_.bind(function(e){$(e.target).closest(".input-text.characters-in-gap").length>0||(this.currentInput&&(this.lastInput=this.currentInput),this.executeDelay=!0,_.delay(_.bind(function(){this.executeDelay&&(this.currentInput=null,this.trigger("inactive"))},this),500))},this)),$("body").on("focus",selectors.join(),_.bind(function(e){if(!($(e.target).closest(".input-text.characters-in-gap").length>0)&&(this.executeDelay=!1,this.currentInput=$(e.target),this.trigger("active",this.currentInput),this.setSelection)){var element=this.getInput();element&&(element=element.get(0),element.setSelectionRange(this.selectionStart,this.selectionEnd)),this.setSelection=!1}},this)),$("body").on("click keyup",selectors.join(),_.bind(function(e){$(e.target).closest(".input-text.characters-in-gap").length>0||(this.selectionStart=this.getInput().prop("selectionStart"),this.selectionEnd=this.getInput().prop("selectionEnd"))},this))},isActive:function(){return!!this.currentInput},getInput:function(){return this.currentInput?this.currentInput:this.lastInput},insert:function(text){text=$("<a>"+text+"</a>").text();var element=this.getInput();if(element){if(element=element.get(0),element.selectionStart||0===element.selectionStart){var startPos=this.selectionStart,endPos=this.selectionEnd,scrollTop=element.scrollTop;element.value=element.value.substring(0,startPos)+text+element.value.substring(endPos,element.value.length),this.selectionStart=startPos+text.length,this.selectionEnd=startPos+text.length,this.setSelection=!0,element.scrollTop=scrollTop}else element.value+=text;this.getInput().trigger("change")}}}),$(function(){a5.specialCharInserter=new a5.SpecialCharInserter}),a5.Spinner={init:function(){var $node=$("body > .spinner");$node.length||($node=$('<div class="spinner"></div>'),$("body").append($node)),this.$node=$node},toggleFor:function(interaction){interaction.isLiveCycle("loaded")?this.$node.hide():this.$node.show()}},Obj.extend("a5.Spinner"),a5.Layout={init:function(parameters){this.dp=parameters.dp,this.packageURL=this.dp.path,this.height=0,this.width=0},load:function(){return this.dp.load().then(function(){$("body").find("#lo-title").css("display",""),a5.hooks.layoutStylesLoaded.call()})},getTemplate:function(){return a5.service.templates.loadContentElementTemplate.apply(a5.service.templates,arguments)},replaceSubpart:function(){return a5.service.templates._replaceSubpart.apply(a5.service.templates,arguments)},getSubpart:function(){return a5.service.templates._getSubpart.apply(a5.service.templates,arguments)},checkSize:function(){var size=a5.dp.config.contentSize(),newHeight=size.height,newWidth=size.width;newHeight===this.height&&newWidth===this.width||(this.height=newHeight,this.width=newWidth,a5.eventBus.trigger("lo:size",{height:this.height,width:this.width}))}},Obj.extend("a5.Layout"),a5.DesignPack={cssFile:"css.css",init:function(parameters){a5.utils.endsWith(parameters.path,"/")||(parameters.path+="/"),this.path=parameters.path,this.development=!!parameters.development,this.enginePath=parameters.enginePath,this.loadingDocument=document.implementation.createHTMLDocument("New Document"),_.bindAll(this,"_correctLinks","_stripLinks","_loadContentElements","_loadHead","_loadHeadForDevelopment","_loadBody","_wrap","_addCss","_addJs","_addEngineCss","_addLessParser","_loadDefaultLayoutTemplate")},load:function(){var p=this._loadContentElements().then(this._loadHead).then(this._loadBody);return this.development&&(p=p.then(this._addLessParser)),p},loadLayoutTemplate:function(name){return this._load("templates/"+name+".html",!/http(s)*:/.test(window.location.protocol)).then(null,this._loadDefaultLayoutTemplate).then(this._wrap)},loadLayoutTemplateFromString:function(str){return this._wrap(str)},loadSkinTemplateSync:function(name,onlyCached){return this._loadSync("skinTemplates/"+name+".handlebars",onlyCached)},loadSkinTemplate:function(name,onlyCached){return this._load("skinTemplates/"+name+".handlebars",onlyCached)},_loadDefaultLayoutTemplate:function(){return this._load("templates/default.html")},_loadContentElements:function(){return this._load("contentElements.html").then(this._wrap).then(this._correctLinks).then(function(dom){this.contentElements=dom.html()}.bind(this))},_loadHead:function(){var p;return p=this.development?this._loadHeadForDevelopment():this._load("head.html").then(this._wrap).then(this._stripLinks).then(this._addEngineCss).then(this._addCss).then(this._addJs),p.then(function(dom){var promises=[];return dom.children("link, script").clone().each(function(i,e){var $e=$(e);if(!$e.attr("data-browser")||$("body."+$e.attr("data-browser")).length>0){if($e.is('link[rel="stylesheet"]')&&!$("body").is(".isPhantom")){var deferred=$.Deferred();e.onload=e.onerror=function(){deferred.resolve()},promises.push(deferred.promise())}$("head").append(e)}}),$.when.apply(this,promises)})},_loadHeadForDevelopment:function(){return this._load("head.html").then(this._wrap).then(this._correctLinks)},_loadBody:function(){return this._load("body.html").then(this._wrap).then(this._correctLinks).then(function(dom){$("body").append(dom.contents().clone()),$("body").attr("data-mode",(LOInfo.mode||"").toLowerCase());var $loTitle=$("body").find("#lo-title"),$activityTitle=$("body").find("#activity_title");void 0!==window.LOInfo.title&&($activityTitle.html(window.LOInfo.title),$loTitle.html(window.LOInfo.title),$loTitle.css("display","none"))})},_loadFromCache:function(name){var absolutePath=this.path+name
;return A5.TEMPLATES&&(A5.TEMPLATES[name]||A5.TEMPLATES[absolutePath])||window.ajaxData&&(window.ajaxData[name]||window.ajaxData[absolutePath])},_loadFromAjax:function(name,options){var path=this.path;options&&options.path&&(path=options.path,delete options.path);var url=path+name;return logger.info("LOADING\t",url.trim()),$.ajax(_.extend({url:url,dataType:"text"},options))},_loadSync:function(name,onlyCached){if(this._isCached(name)||onlyCached)return this._loadFromCache(name);var ret;return this._loadFromAjax(name,{async:!1,cache:!0,success:function(data){ret=data}}),ret},_load:function(name,onlyCached){return this._isCached(name)?$.when(this._loadFromCache(name)):onlyCached?$.Deferred().reject().promise():this._loadFromAjax(name)},_loadFromEngineSync:function(name){var ret;return this._loadFromAjax(name,{path:this.enginePath,async:!1,cache:!0,success:function(data){ret=data}}),ret},_loadFromEngine:function(name){return this._loadFromAjax(name,{path:this.enginePath})},_addEngineCss:function(dom){return dom.append($("<link rel='stylesheet' type='text/css' href='"+this.enginePath+"player.css'/>")),dom},_addCss:function(dom){return dom.append($("<link rel='stylesheet' type='text/css' href='"+this.path+this.cssFile+"'/>")),dom},_addJs:function(dom){var deferred=$.Deferred();return a5.getScript(this.path+"js.js",function(){deferred.resolve(dom)},function(){deferred.reject()}),deferred.promise()},_addLessParser:function(){var deferred=$.Deferred();return window.less={env:"development",logLevel:2,errorReporting:"console",async:!1,fileAsync:!1,poll:1e3,functions:{},dumpLineNumbers:"comments",relativeUrls:!1},a5.getScript("lib/third-party/less.js",function(){deferred.resolve()},function(){deferred.reject()}),deferred.promise()},_isCached:function(name){var absolutePath=this.path+name;return A5.TEMPLATES&&(_(A5.TEMPLATES).has(name)||_(A5.TEMPLATES).has(absolutePath))||window.ajaxData&&(_(window.ajaxData).has(name)||_(window.ajaxData).has(absolutePath))},_wrap:function(html){var $wrap=$("<root></root>",this.loadingDocument);return $wrap[0].innerHTML=html,$wrap},_correctLinks:function(dom){var pattern=/^((https?:\/\/)|\/|#).*/,rep=function(link){return null!==link.match(pattern)?link:this.path+link}.bind(this);return dom.find("*[href]").each(function(i,e){$(e).attr("href",rep($(e).attr("href")))}),dom.find("*[src]").each(function(i,e){$(e).attr("src",rep($(e).attr("src")))}),dom},_stripLinks:function(dom){return dom.find("*[href]").remove(),dom.find("*[src]").remove(),dom}},Obj.extend("a5.DesignPack"),a5.GitDesignPack={cssFile:"css/style.css",load:function(){var p=this._loadTemplatesJS().then(this._loadContentElements).then(this._loadHead).then(this._loadBody);return this.development&&(p=p.then(this._addLessParser)),p},_loadHeadForDevelopment:function(){return this._load("head.html").then(this._wrap).then(this._stripLinks).then(this._addCss).then(this._addJs)},_loadTemplatesJS:function(){var deferred=$.Deferred();return a5.getScript(this.path+"templates.js",function(){deferred.resolve()},function(){deferred.reject()}),deferred.promise()}},a5.DesignPack.extend("a5.GitDesignPack"),a5.InteractionNextTimer={init:function(interaction){interaction.options.automaticNextIsTimer()&&(interaction.bind("show",this.startTimer,this),interaction.bind("hide",this.stopTimer,this),this.time=1e3*parseInt(interaction.options.getAutomaticNext(),10))},timeIsUp:function(){a5.mainBuilder.goNext()},startTimer:function(){this.usedTime=0,this.state="ticking",a5.tasks.push(new a5.InteractionNextTimerTask(this),"automaticNext")},stopTimer:function(){this.state="vanished"}},Obj.extend("a5.InteractionNextTimer"),a5.InteractionNextTimerTask={init:function(manager){this.manager=manager,this.bind("start",function(){this.deltaStartTime=(new Date).getTime()},this)},run:function(){var now=(new Date).getTime();return this.manager.usedTime+=now-this.deltaStartTime,this.deltaStartTime=now,this.manager.usedTime>this.manager.time?(this.manager.timeIsUp(),!0):"vanished"==this.manager.state||void 0}},a5.Task.extend("a5.InteractionNextTimerTask"),a5.Interaction={init:function(parameters,defaults){this._super(parameters,$.extend({url:null,originalIndex:null,index:null,locked:!1,preview:"",helpText:"",resources:[],feedbackText:{},_languages:{},source:"",group:""},defaults)),this.activityTimer=new a5.utils.Timer,this.activityMetadata=a5.mainBuilder.metadata.getScreenMetadata(this.url,this.originalIndex),this.activityOptions=new a5.models.options.Options,this.options=new a5.models.options.Options([a5.mainBuilder.LOInfo.loOptions,this.activityOptions,a5.mainBuilder.LOInfo.assessmentOptions,a5.mainBuilder.platformOptions]),this.items=new a5.models.interaction.BlockItems({parent:this}),this.timesChecked=0,this.checkAttempts=0,this.manualCheckAttempts=0,this.skippedByAdaptive=!1,this.itemBanks=[],this.contentWrap=$("#content_wrap").clone().empty().attr({class:"content-wrap",id:""}),$("#content_wrap").before(this.contentWrap),this.view={$:_.bind(this.$,this),$node:this.contentWrap},this.liveCycle="empty",this.hide(),this.bind("show:deferred",function(){a5.hooks.interactionShowed.call(this),a5.callbacks.interaction.trigger("showed",this)},this),this.bind("show:deferred",function(){if(this.options.flashfirstanswerIsOn()){var duration=parseInt(this.options.getFlashfirstanswer(),10)||a5.dp.config.flashfirstanswerDefaultDuration,answers=this.getFirstAnswer();this.showFlashFirstAnswer(duration,answers)}},this),this.bind("hide",function(){a5.service.media.pauseAll()},this),this.bind("show:deferred",_.bind(this.setMediaNoScroll,this)),$(window).bind("resize scroll",_.bind(this.setMediaNoScroll,this)),this.contentWrap.on("scroll",_.bind(this.setMediaNoScroll,this)),this.bind("show:deferred",_.bind(this.setMediaMode,this)),this.bind("show:deferred",_.bind(function(){this.annotationsToolbar?(this.annotationsToolbar.setModel(this),this.annotationsToolbar.render(),this.annotationsToolbar.node.show(),this.annotationsToolbar.enableAll(),this._annotationsToolbarState&&this.annotationsToolbar.restore(this._annotationsToolbarState)):this.detachAnnotations(),this.teacherAnnotationsToolbar?(this.teacherAnnotationsToolbar.setModel(this),this.teacherAnnotationsToolbar.render(),this.teacherAnnotationsToolbar.node.show(),"_teacherAnnotationsToolbarState"in this&&this.teacherAnnotationsToolbar.restore(this._teacherAnnotationsToolbarState)):this.detachTeacherAnnotations()},this)),this.bind("hide",_.bind(function(){this.annotationsToolbar&&(this._annotationsToolbarState=this.annotationsToolbar.store()),this.teacherAnnotationsToolbar&&(this._teacherAnnotationsToolbarState=this.teacherAnnotationsToolbar.store())},this))},$:function(selector){return this.contentWrap.find(selector)},showFlashFirstAnswer:function(duration,answers){this.$firstanswer_dialog&&(this.$firstanswer_dialog.dialog("close"),delete this.$firstanswer_dialog),_.isArray(answers)||(answers=[answers]);var model={answers:answers,dialogClass:"dialog-flash-first-answer"},callbacks={close:_.bind(function(){delete this.$firstanswer_dialog},this)};this.$firstanswer_dialog=a5.view.dialog.display("a5.view.dialog.FlashFirstAnswersOverlay",model,callbacks),setTimeout(_.bind(function(){this.$firstanswer_dialog.dialog("close")},this),duration)},showHelpText:function(){this.$help_dialog&&(this.$help_dialog.dialog("close"),delete this.$help_dialog);var model={label:this.helpText,dialogClass:"dialog-hint"},callbacks={close:_.bind(function(){delete this.$help_dialog},this)};this.$help_dialog=a5.view.dialog.display("a5.view.dialog.HelpText",model,callbacks,null,!0,a5.dp.config.appendHelpTextTo)},insertSpecialCharacterDialog:function(){function escape(input){return input.replace("&","&")}var characterSets=this.options.getSpecialcharactersStudent().map(function(name){return{name:name,letters:_.map(CATspecialChars[name],escape)}}),$dialog=a5.view.dialog.display("a5.view.dialog.SpecialCharacters",{dialogClass:"dialog-special-characters",characterSets:characterSets},{cancel:function(){var $input=a5.specialCharInserter.getInput();$input&&$input.focus()}});$dialog.on("click","a[data-char]",function(evt){evt.preventDefault();var data_char=$(evt.target).attr("data-char"),$input=a5.specialCharInserter.getInput();a5.specialCharInserter.insert(data_char),$dialog.dialog("close"),$input&&($input.focus(),$input.trigger("specialchar:inserted"))})},insertExportDialog:function(){var $dialog=a5.view.dialog.display("a5.view.dialog.ExportAs",{filename:A5.DEFAULT_SAVEAS_FILENAME},{ok:_.bind(function(){var format=$dialog.find("#export-format option:selected").val(),filename=$dialog.find("#downloadFilename").val(),exporter=new a5.service.InteractionExporter(this);exporter["exportAs"+format.toUpperCase()].call(exporter,filename)},this)})},setLiveCycle:function(liveCycle){_.contains(["empty","loading","loaded"],liveCycle)||logger.error("invalid value "+liveCycle+" for liveCycle"),this.liveCycle=liveCycle},isLiveCycle:function(liveCycle){return this.liveCycle==liveCycle},isEndResultScreen:function(){return(this.options.endResultScreenIsTrue()||this.options.endResultAlwaysIsOn())&&this.index==_.last(a5.mainBuilder.intList).index},isIntroScreen:function(){return-1==this.index},isLastInteraction:function(withEndResult){return a5.mainBuilder.numberOfInteractions(withEndResult)===this.index+1},isSolvable:function(){return this.getScores().total>0},isSolved:function(){return this.getScores().isPercent100()},reload:function(config){return config=config||{},a5.eventBus.trigger("interaction:reset",this),this.trigger("reset",this),config.skipReset||this.reset(),this.afterReset=!0,this.forceSkipRestore=!!config.skipRestore,config.skipRestore&&(this.checkAttempts=0,this.manualCheckAttempts=0),this.render()},reset:function(){this.clear(),this.reset_enumerations(),this.items=new a5.models.interaction.BlockItems({parent:this}),this.status="input",this.firstCall=!1,this.liveCycle="empty",this.interactionDone=!1,this.buildDone=!1,this.skipNextCharacters=0,this.hasMediaToExpand=!1,this.answersChecked=!1,this.itemBanks&&(this.itemBanks=[]),this.referenceToolbar&&this.referenceToolbar.reset(),$("#reference_toolbar").length>0&&(this.referenceToolbar=new a5.views.Toolbar($("#reference_toolbar"))),this.annotationsToolbar&&this.annotationsToolbar.reset(),this.annotationsCanvas&&this.annotationsCanvas.reset(),this.notes=this.notes||new a5.models.NotesModel,this.annotations=this.annotations||new a5.annotations.Canvas({readOnly:this.options.annotationToolsIsOnly_for_teachers()&&"teacher"!==a5.service.lms.API.getUserRole().toLowerCase()}),a5.service.media.pause(this.contentWrap),window.CKEDITOR&&_(CKEDITOR.instances).each(function(cke,id){this.$("#cke_"+id).length&&cke.destroy()},this),this.hasReadyListener=!1,this.revealIsHiding=!1,this.__showingSolutionHint=!1},getID:function(){return this._interactionId||(this._interactionId=a5.service.lms.API.getInteractionIdFor(this.url))},setStatus:function(status){status!==this.status&&(this.status=status,a5.mainBuilder.updateScores(),a5.hooks.interactionStatusChanged.call(this),this.trigger("update-status-to-"+status)),this.$(".interaction").removeClass("status-answers status-feedback status-input status-corrected").addClass("status-"+this.status)},setLanguage:function(lang,quiet){this.translationLanguage=lang,this.trigger("language:change",lang),quiet||a5.mainBuilder.setLanguageToAllInteractions(lang,this)},nextLanguage:function(lang){var languages=this.getRegisteredLanguages(),current=_.indexOf(languages,this.getLanguage()),next=languages[(current+1)%languages.length];this.setLanguage(next)},registerLanguage:function(lang){if(_.contains(lang,":")){var syntax=lang.split(":");return this._languages[syntax[1]]=syntax[0],syntax[1]}return this._language[lang]="",lang},getRegisteredLanguages:function(){return _.keys(this._languages)},getLanguage:function(){return this.translationLanguage||this.options.getTranslationBlock()},getLanguageLabel:function(lang){return this._languages[lang]},getStatus:function(){return this.status},getElapsedTime:function(){return this.activityTimer.getTime()},updateActivityDuration:function(){this.activityDuration=this.getElapsedTime()},hide:function(dontTriggerEvents){this.visible=!1,this.contentWrap.hide(),dontTriggerEvents||this.trigger("hide")},show:function(){this.visible=!0,this.isLiveCycle("loaded")&&(this.referenceToolbar&&this.referenceToolbar.render(),this.contentWrap.show(),this.annotationsCanvas&&this.annotationsCanvas.render(),this.trigger("show"),this.onInteractionShowedListeners.callEach({}),setTimeout(function(){a5.eventBus.trigger("interaction:show",this)}.bind(this),200))},getCorrectResponse:function(id){var cr=this.viewData.getVariable(id);return cr||{values:[]}},getAllResponseDeclaration:function(){return this.viewData.variables},_render:function(template,deferred){this.contentWrap.empty(),this.disableVisibility(),this.contentWrap.show(),this.contentWrap.attr("id","content_wrap_"+this.index);var tDOM=template.clone(),nodeMediaList=tDOM.find("#media"),nodeContentList=tDOM.find("#content"),nodeRubricList=tDOM.find("#rubric"),nodeResourcesList=tDOM.find("#resources");_(nodeMediaList).each(function(e,index){var nodeMedia=$(e);nodeMedia.attr("id","media-"+this.index+"-"+index),nodeMedia.attr("data-zone-type","media"),nodeMedia.addClass("is-media-zone")},this),_(nodeContentList).each(function(e){var nodeContent=$(e);nodeContent.attr("id","content-"+this.index),nodeContent.attr("data-zone-type","content"),nodeContent.addClass("is-content-zone")},this),_(nodeRubricList).each(function(e){var nodeRubric=$(e);nodeRubric.attr("id","rubric-"+this.index),nodeRubric.attr("data-zone-type","rubric"),nodeRubric.addClass("is-rubric-zone")},this),_(nodeResourcesList).each(function(e){var nodeResources=$(e);nodeResources.attr("id","resources-"+this.index),nodeResources.attr("data-zone-type","resources"),nodeResources.addClass("is-resources-zone")},this),this.contentWrap.append(tDOM.contents()),"Present:Present:Ebook"!==this.identifier&&"Present:Present:AudioBook"!==this.identifier||($("body").addClass("isEbook"),this.contentWrap.appendTo("#content_wrap")),this.contentZone=$(this.contentWrap.find("*[data-zone-type='content']")),this.rubricZone=$(this.contentWrap.find("*[data-zone-type='rubric']")),this.mediaZone=$(this.contentWrap.find("*[data-zone-type='media']")),this.resourcesZone=$(this.contentWrap.find("*[data-zone-type='resources']")),this.hasGlobalEnumerator()&&this.enumerator.start(this.getGlobalEnumerationOffset()),this.build_interaction(),this.hasGlobalEnumerator()&&this.enumerator.finish(),this.attachTitle(this.title),this.attachAudios(),this.attachMetadataClasses(),this.setStatus("input"),a5.dp.config.avatarSupport&&(this.avatar=new a5.service.Avatar(this)),a5.mainBuilder.updateScores(),a5.hooks.interactionLoaded.call(this),a5.callbacks.interaction.trigger("loaded",this);var forcedStatus;if(a5.dp.config.forceCorrectedAfterSubmitAttempts){a5.mainBuilder.options(!0).finishSubmitIsOn()||!a5.mainBuilder.canSubmit||a5.mainBuilder.hasMoreSubmitAttempts()||(forcedStatus="corrected")}this.afterReset&&(forcedStatus="input"),this.getSkipRestore()?(this.setLiveCycle("loaded"),deferred.resolve(),this.contentWrap.hide(),this.enableVisibility(),this.visible&&this.show()):this.restore(forcedStatus).done(_.bind(function(){this.setLiveCycle("loaded"),deferred.resolve(),this.contentWrap.hide(),this.enableVisibility(),this.visible&&this.show()},this))},getSkipRestore:function(){return this.options.restoreLOStateIsOff()||this.forceSkipRestore},isVisibleAndLoaded:function(){return this.visible&&this.isLiveCycle("loaded")},enableVisibility:function(){this.contentWrap.removeClass("out-of-flow")},disableVisibility:function(){this.contentWrap.addClass("out-of-flow")},render:function(){this.addContentWrapSubstyle(),this.template=$(this.xml).find("assessmentItem").attr("template")||"default",this.viewData=new a5.ViewData,this.viewData.setXML(this.xml);var deferred=$.Deferred();a5.service.templates.loadLayoutTemplate(this.template,_.bind(function(template){this._render(template,deferred)},this),window.LOInfo.template);return deferred.promise()},parseActivityOptions:function(){var xml=$(this.xml).find("#options").text();this.activityOptions.readAll(xml),this.debugOptions&&this.activityOptions.readAll(this.debugOptions)},dataLoaded:function(){return this.render()},attachAudios:function(){if(this.options.soundEffectsIsSound_effects()){new a5.AudioEvents(a5.mainBuilder.layout.packageURL,this.cssIdentifier(),this)}},preloadAudio:function(audio){this.visible?audio.load():this.bind("show",function(){audio.load()},this,{once:!0})},getScores:function(){var score=this.items.getScores();return score.filled>score.total&&(score.filled=score.total),score.correct<0&&(score.correct=0),score.correctBlocks<0&&(score.correctBlocks=0),this.hasShownSolutionHint()&&!score.revealed&&score.incRevealed(),score},getResults:function(scoreFetcher){return scoreFetcher?new a5.Results(scoreFetcher(this),this.options):new a5.Results(this.getScores(),this.options)},applyValidationMessage:function(score){var preprocessor=new a5.preprocessor.Preprocessor,txt=a5.utils.getRandomSubstring(this.options.getValidationmessage());txt=preprocessor.replaceTag(txt,"vm-incorrectanswers",function(){return score.scores.totalBlocks-score.scores.correctBlocks}),txt=preprocessor.replaceTag(txt,"vm-image",function(id){return'<img src="'+a5_makeMediaURL(id)+'"/>'});var $message=$('<div class="validation-message"></div>');$message.html(txt),this.contentWrap.append($message)},removeValidationMessage:function(){this.contentWrap.find(".validation-message").remove()},setAnswerInput:function(){this.items.setAnswerInput()},setAnswer:function(){this.items.setAnswer(),this.reapplySolutionHint(),this.interactionDone=!0,this.onSetAnswerListeners.callEach({});var score=this.getResults();if(!this.options.feedbackSoundEffectsIsOff()){var commands=this.options.getFeedbackSoundEffects().split("|");_.each(commands,function(command){var parts=command.split(","),test=parts[0].split("-");if(score.percent()>=parseFloat(test[0])&&score.percent()<=parseFloat(test[1])){var audio=a5.service.media.audio.create(parts[1],{preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())});a5.service.media.audio.pauseAll(),audio.play()}})}this.options.validationmessageIsFalse()||score.isPercent100()||this.applyValidationMessage(score),this.lastScore=score,this.setStatus("corrected"),this.checkAttempts++,this.trigger("attemptsChanged",{checkAttempts:this.checkAttempts}),this.setupAutomaticTryAgain()},getFirstAnswer:function(n){return _.first(this.items.getAllAnswers(),n)},showAnswer:function(){this.items.showAnswer(),this.setStatus("answers"),this.setupAutomaticTryAgain()},showNextAnswer:function(){this.items.showNextAnswer(),this.$(".interaction").addClass("status-showing-answers"),a5.mainBuilder.updateScores()},canShowSolutionHint:function(){return this.items.canShowSolutionHint()},hasShownSolutionHint:function(){return!!this.__showingSolutionHint},clearSolutionHint:function(){delete this.__showingSolutionHint,this.items.clearSolutionHint()},reapplySolutionHint:function(){this.hasShownSolutionHint()&&(this.clearSolutionHint(),this.showSolutionHint())},showSolutionHint:function(){this.canShowSolutionHint()&&!this.hasShownSolutionHint()&&(this.__showingSolutionHint=!0,this.items.showSolutionHint(),this.$(".interaction").addClass("status-showing-solution-hint"),a5.mainBuilder.updateScores())},showAllAnswer:function(){this.items.showAnswer(),this.$(".interaction").addClass("status-showing-answers"),this.setStatus("answers"),a5.mainBuilder.controls.update()},isShowingAnswers:function(){return this.$(".interaction").hasClass("status-showing-answers")},showAnswerBeforeInteraction:function(){this.checkAttempts=a5.mainBuilder.getCheckMaxAttemptsNumber(),this.unbindAutomaticTryAgain(),a5.dp.config.resetCheckAttemptsAfterSkipScreen&&(this.manualCheckAttempts=0),this.showAnswer(),a5.eventBus.trigger("interaction:see_answer_before_interaction")},tryAgain:function(){if(this.unbindAutomaticTryAgain(),this.options.tryAgainIsClear())return void this.reload();this.items.tryAgain(),this.reapplySolutionHint(),this.setStatus("input"),this.removeValidationMessage(),this.interactionDone=!1,this.$(".interaction").removeClass("status-showing-answers"),this.onInteractionReadyListeners.callEach({tryAgain:!0})},setupAutomaticTryAgain:function(){var score=this.getScores();this.options.tryAgainBehaviourIsAutomatic()&&this.hasMoreCheckAttempts()&&!score.isPercent100(!0)&&(this.contentWrap.get(0).addEventListener("mousedown",this.automaticTryAgain,!0),this.contentWrap.get(0).addEventListener("touchstart",this.automaticTryAgain,!0))},automaticTryAgain:function(event){"mousedown"===event.type&&0!==event.button||a5.mainBuilder.tryAgain()},unbindAutomaticTryAgain:function(){this.contentWrap.get(0).removeEventListener("mousedown",this.automaticTryAgain,!0),this.contentWrap.get(0).removeEventListener("touchstart",this.automaticTryAgain,!0)},signal:function(){_.each(this.items.itemList,function(item){_.each(item.itemList,function(item2){item2.signalErrors(!0)})}),this.signalErrorActive=!0,a5.mainBuilder.updateScores()},hideSignal:function(){_.each(this.items.itemList,function(item){_.each(item.itemList,function(item2){item2.hideSignalErrors(!0)})}),this.signalErrorActive=!1,a5.mainBuilder.updateScores()},cssIdentifier:function(){if(void 0===this.identifier)return logger.warn("interaction has no identifier: "+this.url),"invalid-identifier";var parts=this.identifier.split(":");return 3!=parts.length?(logger.warn("interaction has invalid identifier: "+this.identifier+" "+this.url),"invalid-identifier"):parts[0].substring(0,1).toLowerCase()+parts[1].substring(0,1).toLowerCase()+"-"+parts[2].trim().toLowerCase().replace(/[^A-Za-z0-9]+/g," ").trim().replace(/ /g,"-")},init_enumerations:function(){this.enumBlock=new a5.models.options.Enumeration(this.options.getEnumeration()),this.enumAnswers=new a5.models.options.Enumeration(this.options.getEnumerationAnswers(),'<span class="enum-answers">|</span>'),a5.mainBuilder.options(!0).continuousEnumerationIsOn()?"false"!==this.options.getEnumerationAnswers()?(this.enumAnswers=new a5.models.options.Enumeration(this.enumAnswers.value,'<span class="enum-answers continuous-enumeration">|</span>'),this.enumerator=this.enumAnswers,this.enumBlock.start()):"false"!==this.options.getEnumeration()&&(this.enumBlock=new a5.models.options.Enumeration(this.enumBlock.value,'<span class="enum">|</span>'),this.enumerator=this.enumBlock,this.enumAnswers.start()):(this.enumBlock.start(),this.enumAnswers.start())},reset_enumerations:function(){a5.mainBuilder.options(!0).continuousEnumerationIsOn()||(this.enumBlock&&this.enumBlock.ready().then(function(){this.enumBlock.reset()}.bind(this)),this.enumAnswers&&this.enumAnswers.ready().then(function(){this.enumAnswers.reset()}.bind(this)))},hasGlobalEnumerator:function(){return!!this.enumerator},getGlobalEnumerationOffset:function(){for(var offset=0,prev=this.index;prev>0;){var interaction=a5.mainBuilder.intList[prev-1];if(interaction&&interaction.hasGlobalEnumerator())break;prev-=1}return prev>0&&(offset=a5.mainBuilder.intList[prev-1].enumerator.getCounter()),offset},enumerationReady:function(){return $.when(this.enumAnswers.ready(),this.enumBlock.ready())},build_interaction:function(){var self=this;this.taskNum=window.a5.mainBuilder.curTask,this.karaoke=null,this.onInteractionReadyListeners=new Listeners(this),this.onInteractionShowedListeners=new Listeners(this),this.onInteractionRestoreListeners=new Listeners(this),this.onSetAnswerListeners=new Listeners(this);var interactionDomRoot=$('<div class="interaction"></div>');interactionDomRoot.addClass(this.cssIdentifier()),interactionDomRoot.addClass("package"),interactionDomRoot.addClass("package-editable"),interactionDomRoot.addClass("editor"),interactionDomRoot.addClass("ic-speaking-and-recording");var kidnappedInteractionDomRoot=interactionDomRoot;if(_.contains(["Identify:Select:Linking multiple lines","Identify:Select:Linking lines","Identify:Mark:Marking","Identify:Mark:Wordsearch"],this.identifier)){this.toolbar=new a5.model.InteractionToolbar;var toolbarView=new a5.view.InteractionToolbar(this.toolbar);kidnappedInteractionDomRoot.append(toolbarView.render()),kidnappedInteractionDomRoot.closest(".interaction").addClass("toolbar")}if(this.contentZone.append(interactionDomRoot),this.prefill=new a5.models.options.Prefill(this),this.rubricZone.html(""),$(this.xml).find("#rubric").length>0){var rubric=$("<div></div>");self.buildModel(rubric,$(this.xml).find("#rubric")),this.rubricZone.html(rubric.find("#rubric").contents())}new a5.views.ResourcesZone(this).render(),this.options.hasResourceBanks()&&"Order:Match:Text gap"!==this.identifier&&this.attachResourcesPanel(),$(this.xml).find("#headerAudio").length>0&&0===$("#activity").find(".headerAudio_"+this.index).length&&(self.buildModel($("#activity"),$(this.xml).find("#headerAudio")),self.rubricZone.addClass("withHeaderAudio")),"Exam"!==LOInfo.mode&&"Trainer"!==LOInfo.mode||self.isEndResultScreen()&&self.bind("show:deferred",function(){self.rubricZone.hide()});var content=$(this.xml).find("itemBody").find("#content");this.buildModel(kidnappedInteractionDomRoot,content),this.attachTeamScoring(kidnappedInteractionDomRoot),this.isMediaRendering=!0;var mediaCounter=0;if(_.each($(this.xml).find("itemBody").children(),function(e){var targetMediaNode,node=$(e);if(node.is("#media"))if("tabbed"==node.attr("class")){targetMediaNode=$("#media-"+this.index+"-"+mediaCounter);$("<div>");0==targetMediaNode.find("ul.tabnav").length&&targetMediaNode.append($("<ul class='tabnav'></ul>")),_.each($(node).find("div.tab"),function(tab,i){$(tab).attr("id","media-"+mediaCounter+"-tab-"+i);var $navElement="<li><a href='#"+$(tab).attr("id")+"'>"+$(tab).attr("label")+"</a></li>";targetMediaNode.find("ul.tabnav").append($navElement),self.buildModel(targetMediaNode,$(tab))},this),targetMediaNode.tabs({create:_.bind(function(e,ui){self.trigger("interaction:supplements:tabs_create",ui)}),activate:_.bind(function(e,tabs){self.trigger("interaction:supplements:tabs_change",tabs.newTab)},self)})}else targetMediaNode=$("#media-"+this.index+"-"+mediaCounter),node.children().each(function(index,e){self.buildModel(targetMediaNode,$(e))}),mediaCounter++},this),self.setMediaMode(),this.mediaZoneView=new a5.views.MediaZone(this),this.mediaZoneView.render(),this.isMediaRendering=!1,this.hasMediaToExpand&&(this.mediaModeInterval=setInterval(this.setMediaMode.bindTo(this),50)),0==$("#model_text").length){var modelTextDomRoot=$('<div id="model_text"></div>');$("body").append(modelTextDomRoot)}this.initializeToolbarButtons(),this.attachModelText(),this.attachCustomText(),this.options.annotationToolsIsOnly_supplements()?(this.attachTabAnnotations(),this.bind("interaction:supplements:tabs_change",_.bind(function(newTab){var id=newTab.find("a.ui-tabs-anchor").first().attr("href").replace("#","");this.switchTabAnnotation(id),this.annotationsCanvas=this._currentAnnotations.annotationsCanvas},this)),this._currentAnnotations?(this.annotationsCanvas=this._currentAnnotations.annotationsCanvas,this.attachAnnotationsToolbar()):(this.attachAnnotations(),this.attachAnnotationsToolbar())):this.options.annotationToolsIsOn()||this.options.annotationToolsIsOnly_for_teachers()&&"teacher"===a5.service.lms.API.getUserRole().toLowerCase()?(this.attachAnnotations(),this.attachAnnotationsToolbar()):this.options.annotationToolsIsOnly_for_teachers()&&this.attachTeacherAnnotations(),this.options.wikiToolIsOn()&&this.attachWiki(),this.attachImageDivClass(),this.attachNoLabelClass(),this.trigger("rendered"),this.onInteractionReadyListeners.callEach({}),this.buildDone=!0,a5.mainBuilder.setProgress(),$(".option056").mouseenter(function(){$(this).find(".opt056-audio").hide(),$(this).find(".opt056-audio-over").show()}),$(".option056").mouseleave(function(){$(this).find(".opt056-audio").show(),$(this).find(".opt056-audio-over").hide()}),$("#content .v_a_media, #content .video").css("position","relative"),$("body").css("visibility","visible"),new a5.InteractionNextTimer(this)},setMediaNoScroll:function(){var scrollTop,scrollLeft;if(this.options.stayinviewIsTrue()&&this.visible)if(a5.dp.config.mediaAreaFixedInView){var stayInViewTop=parseInt(a5.utils.getCSSAttributeFromCSS("#"+this.mediaZone.attr("id"),"is-media-zone stay-in-view","top"),10)||0;scrollTop=$(window).scrollTop(),this.offsetMediaNode=this.offsetMediaNode||this.mediaZone.offset(),this.offsetMediaNode&&(scrollTop<this.offsetMediaNode.top-stayInViewTop?(this.mediaZone.removeClass("stay-in-view"),this.mediaZone.css("top","")):this.mediaZone.addClass("stay-in-view"))}else this.contentZone.length&&(scrollTop=this.contentWrap.scrollTop()||$(window).scrollTop(),scrollLeft=this.contentWrap.scrollLeft()||$(window).scrollLeft(),_.each(this.mediaZone,function(mediaZone){var $mediaZone=$(mediaZone),top=$mediaZone.css("top");$mediaZone.css("top",scrollTop),$mediaZone.offset().top+$mediaZone.outerHeight()>this.contentZone.offset().top+this.contentZone.outerHeight()&&$mediaZone.css("top",top);var left=$mediaZone.css("left");$mediaZone.css("left",scrollLeft),$mediaZone.offset().left+$mediaZone.outerWidth()>this.contentZone.offset().left+this.contentZone.outerWidth()&&$mediaZone.css("left",left)},this))},setMediaMode:function(){a5.dp.config.responsiveSupplements?this.setMediaResponsive():this.setMediaBounds(),clearInterval(this.mediaModeInterval)},setMediaResponsive:function(){var $parent=this.mediaZone.hasClass("ui-tabs")?this.mediaZone.children(".tab"):this.mediaZone;_.each($parent.children(),function(node){var $target=$(node);$target.hasClass("image-as-trigger")?$target=$target.add($target.children()):$target.hasClass("transcript-wrap")?$target=$target.add($target.find("> .v_a_media,.the_video,[poster]")):$target.hasClass("video")&&($target=$target.add($target.find(".the_video,[poster]"))),$target.css("position","").css("z-index","").css("left","").css("top","").css("width","").css("height","")})},setMediaBounds:function(){this.mediaZone.hasClass("ui-tabs")?_.each(this.mediaZone.children(".tab"),function(tab){var maxHeight=0,wasDisplay=$(tab).css("display");$(tab).css({display:"",visibility:"hidden"}),_.each($(tab).children(),function(element){element=$(element);var cssTop=parseInt(element.css("top"),10);isNaN(cssTop)&&(cssTop=0);var height=element.outerHeight()+cssTop;!isNaN(height)&&height>maxHeight&&(maxHeight=height)}),maxHeight<=0&&(maxHeight="auto"),$(tab).css("height",maxHeight+"px"),$(tab).css({display:"none"===wasDisplay?"none":"",visibility:""})},this):this.mediaZone.applyBoundingBox()},attachModelText:function(){var modelText=$(this.xml).find("itemBody").find("#attachments #model_text");if(0!==modelText.length){if(0===$("#model_text").length){var modelTextDomRoot=$('<div id="model_text"></div>');$("body").append(modelTextDomRoot)}if(0===$("#model_text_temp").length){var modelTextTempDomRoot=$('<div id="model_text_temp" style="display:none"></div>');$("body").append(modelTextTempDomRoot)}var modelTextView=new a5.views.interaction.ModelTextView(modelText,this);modelTextView.render(),this.onInteractionRestoreListeners.register(modelTextView.render.bindTo(modelTextView))}},hasAttachments:function(){return Boolean(this.attachments)},attachCustomText:function(){var customText=$(this.xml).find("itemBody").find("#attachments #custom");0!==customText.length&&(this.attachments=new a5.views.interaction.CustomTextView(customText,this),this.attachments.render())},attachAnnotationsToolbar:function(){a5.mainBuilder.annotationsToolbar||(a5.mainBuilder.annotationsToolbar=new a5.annotations.ToolbarView(this),$("#activity_controls").append(a5.mainBuilder.annotationsToolbar.render().hide())),this.annotationsToolbar=a5.mainBuilder.annotationsToolbar},attachAnnotations:function(){var $node=this.contentWrap.find(".annotations");0===$node.length&&($node=$('<div class="annotations"></div>').appendTo(this.contentWrap)),
this.annotationsCanvas=new a5.annotations.CanvasView(this.annotations,$node),this.annotationsCanvas.render(),this._currentAnnotations=this.annotationsCanvas},detachAnnotations:function(){a5.mainBuilder.annotationsToolbar&&a5.mainBuilder.annotationsToolbar.node.hide()},attachTabAnnotations:function(tabs_ui){if(this._tabAnnotationsCollection={},this._toolbarButtonState={},this.mediaZone.is(".ui-tabs")){_.each(this.mediaZone.find(".tab"),function(tab){var $node=$("<div class='annotations'/>");$(tab).prepend($node);var model=new a5.annotations.Canvas,view=new a5.annotations.CanvasView(model,$node);view.render(),this.bind("interaction:trigword:clicked",function(){view.clear()}),this._tabAnnotationsCollection[$(tab).attr("id")]={model:model,annotationsCanvas:view,tabNode:$(tab),button_state:[]}},this);var first_tab=this.mediaZone.find(".tab").first();this._currentAnnotations=this._tabAnnotationsCollection[first_tab.attr("id")]}},attachTeacherAnnotations:function(){this.attachAnnotations();var composedAnnotations={children:[]};a5.service.lms.API.getTeacherAnnotations(this.getID(),function(annotations){composedAnnotations=_.reduce(annotations,function(composed,current){return Array.prototype.push.apply(composed.children,current.children),composed},composedAnnotations),this.annotationsCanvas.model.restore(composedAnnotations)}.bindTo(this)),this.attachTeacherAnnotationsToolbar()},attachTeacherAnnotationsToolbar:function(){a5.mainBuilder.teacherAnnotationsToolbar||(a5.mainBuilder.teacherAnnotationsToolbar=new a5.annotations.TeacherToolbarView(this),$("#activity_controls").append(a5.mainBuilder.teacherAnnotationsToolbar.render().hide())),this.teacherAnnotationsToolbar=a5.mainBuilder.teacherAnnotationsToolbar},detachTeacherAnnotations:function(){a5.mainBuilder.teacherAnnotationsToolbar&&a5.mainBuilder.teacherAnnotationsToolbar.node.hide()},switchTabAnnotation:function(tab_id){var tools_open=this.annotationsToolbar.toolsAreVisible();this._currentAnnotations.button_state=this.annotationsToolbar.store(),this._currentAnnotations=this._tabAnnotationsCollection[tab_id],this.annotationsToolbar.disableAll(),this.annotationsToolbar.setModel(this._currentAnnotations),this.annotationsToolbar.render(),this.annotationsToolbar.enableAll(),this.annotationsToolbar.restore(this._currentAnnotations.button_state),tools_open&&this.annotationsToolbar.maximizeTools()},attachWiki:function(){this.wikiTool=new a5.views.WikiTool(this)},attachResourcesPanel:function(){this.resourcesPanel=new a5.components.Resources({interaction:this,maxAddBy:a5.dp.config.multipleResourceMaximum}),this.resourcesPanel.bind("change",function(){a5.service.lms.API.setDataDirty(),a5.service.lms.API.notify(this)},this),this.resourcesPanel.show()},initializeToolbarButtons:function(){if(this.referenceToolbar||(this.referenceToolbar=new a5.views.Toolbar($("#reference_toolbar"))),"false"!=this.options.getPrintable()&&this.referenceToolbar.addButton(new a5.views.Toolbar.PrintButton),(window.a5.mainBuilder.LOInfo.LOOptions.dictionaryIsTrue()||this.options.dictionaryIsTrue())&&this.referenceToolbar.addButton(new a5.views.Toolbar.DictionaryButton),this.options.notesareaIsTrue()){var notesButton=new a5.views.Toolbar.NotesButton(this.notes);notesButton.bind("notes:show",function(){this.referenceToolbar.trigger("notes:show")},this),notesButton.bind("notes:hide",function(){this.referenceToolbar.trigger("notes:hide")},this),this.referenceToolbar.addButton(notesButton)}this.options.interactivePhonemicChartIsTrue()&&this.referenceToolbar.addButton(new a5.views.Toolbar.SoundButton),this.getRegisteredLanguages().length>1&&this.referenceToolbar.addButton(new a5.views.Toolbar.LanguageSwitcher(this))},buildModels:function(parent,nodes){_.each(nodes,function(child){this.buildModel(parent,$(child))},this)},buildModel:function(parent,node,forceBuild){void 0===forceBuild&&(forceBuild=!1);var builder=_.find(a5.model_builder.builders,function(builder){return builder.isResponsible(node,this,forceBuild)},this);builder?builder.build(this,parent,node,forceBuild):(logger.log("nothing defined for node",node),alert("nothing defined for node <"+node[0].tagName+">"))},buildModelExludeNode:function(parent,node,forceBuild){var self=this;$(node).contents().each(function(index,e){self.buildModel(parent,$(e),forceBuild)})},postBuildModel:function(parent){var self=this,found=!1;_.each(a5.model_postBuilder.builders,function(e){e.isResponsible(parent,self)&&(e.build(self,parent),found=!0)})},attachTeamScoring:function(parent){if(this.options.teamscoringIsOn()){var teams=this.options.getTeamscoring().split("|");_(this.blockItems.itemList).each(function(model){var moderator=new a5.model.Moderator(teams,model),moderatorView=new a5.view.Moderator(moderator);parent.prepend(moderatorView.render())})}},setBlockClass:function(node,className){node.closest(".contentblock").addClass(className)},store:function(force){if(force||this.canStore()){var scores=a5.mainBuilder.getScores(),data=this.items.store()||{};data.status=this.status,data.checkAttempts=this.checkAttempts,data.manualCheckAttempts=this.manualCheckAttempts,data.solutionHint=this.hasShownSolutionHint(),this.questionPool&&data.items&&(data.questionPool=this.questionPool),this.itemBanks.length&&(data.itemBanks=this.itemBanks),this.annotationsCanvas&&!this.teacherAnnotationsToolbar&&(data.annotations=this.annotationsCanvas.model.store()),this._tabAnnotationsCollection&&(data.tabAnnotations=_(this._tabAnnotationsCollection).chain().values().pluck("model").invoke("store").value()),this.notes&&(data.notes=this.notes.store()),this.resourcesPanel&&(data.resources=this.resourcesPanel.store()),this.tc_code&&(data.tc_code=this.tc_code),a5.service.lms.API.setData(this.getID(),data),a5.service.lms.API.notify(this),a5.service.lms.API.setProgress(scores.filled/scores.total)}},canStore:function(){return!this.options.saveIsButton_only()},clear:function(){a5.service.lms.API.setData(this.getID(),{}),a5.service.lms.API.notify(this)},restore:function(status){var _get_data=a5.service.lms.API.getData(this.getID()),_restore=_.bind(function(data){this._restore(data,status)},this);return _get_data.then(_restore)},_restore:function(data,status){if(data=data||{},data.checkAttempts&&data.checkAttempts!==this.checkAttempts&&(this.checkAttempts=data.checkAttempts,this.trigger("attemptsChanged",{checkAttempts:this.checkAttempts})),data.manualCheckAttempts&&(this.manualCheckAttempts=data.manualCheckAttempts),this.options.questionpoolIsYes()){var size=parseInt(this.options.getQuestionpool(),10);data.questionPool&&data.questionPool.length===size?this._setQuestionPool(data.questionPool):this._makeQuestionPool(size)}data.solutionHint&&this.showSolutionHint(),this.tc_code=data.tc_code,this.items.restore(data),this.annotationsCanvas&&this.annotationsCanvas.model.restore(data.annotations),this._tabAnnotationsCollection&&_(this._tabAnnotationsCollection).chain().values().each(function(tabAnnotation,index){data.tabAnnotations&&(tabAnnotation.model.restore(data.tabAnnotations[index]),tabAnnotation.annotationsCanvas.repaint())}),this.notes&&data.notes&&this.notes.restore(data.notes),this.resourcesPanel&&data.resources&&this.resourcesPanel.restore(data.resources),data.itemBanks&&(this.itemBanks=data.itemBanks),data.status=status||data.status,data.status&&(this.manualCheckAttempts&&this.options.tryAgainIsFrozen()&&(this.items.setAnswer(),"input"==data.status&&this.items.tryAgain()),"answers"==data.status?(this.items.showAnswer(),this.setupAutomaticTryAgain()):"corrected"==data.status&&(this.items.setAnswer(),this.setupAutomaticTryAgain()),this.setStatus(data.status)),a5.mainBuilder.updateScores(),a5.mainBuilder.trigger("score_update"),this.trigger("restored",this),a5.callbacks.interaction.trigger("restored",this)},_setQuestionPool:function(questionPool){var $interaction=this.$(".interaction"),$contentBlocks=$interaction.children().detach();questionPool.forEach(function(block){$interaction.append($contentBlocks.eq(block))}),this._setQuestionPoolEnum(),this.items.sample(questionPool)},_makeQuestionPool:function(size){this.questionPool=_.sample(_.times(this.items.length(),_.identity),size),this._setQuestionPool(this.questionPool)},_setQuestionPoolEnum:function(){var $interaction=this.$(".interaction"),$contentBlocks=$interaction.children();this.enumBlock&&this.enumBlock.useEnum()&&this.enumBlock.ready().then(function(){this.enumBlock.reset(),$contentBlocks.each(function(index,cb){var $cb=$(cb),$currentEnum=$cb.find("> .enum");this.enumBlock.next().then(function(enumSpan){$currentEnum.after(enumSpan),$currentEnum.remove(),$cb.attr("id","enumeration-"+a5.utils.enumText(enumSpan))})}.bind(this))}.bind(this))},startAutosave:function(){this.autoSaveTimer||(this.autoSaveTimer=setInterval(_.bind(this.store,this),1e4))},stopAutosave:function(){clearInterval(this.autoSaveTimer),this.autoSaveTimer=null},addBodySubstyle:function(){this.addSubstyleTo($(document.body))},addContentWrapSubstyle:function(){this.addSubstyleTo(this.contentWrap)},addSubstyleTo:function($node){if(!this.options.designPackSubstyleIsOff()){var substyleClass=this.options.getDesignPackSubstyle().toLowerCase();substyleClass&&$node.addClass("substyle-"+substyleClass)}},removeBodySubstyle:function(){if(!this.options.designPackSubstyleIsOff()){var substyleClass=this.options.getDesignPackSubstyle().toLowerCase();substyleClass&&$("body").removeClass("substyle-"+substyleClass)}},attachTitle:function(title){this.contentWrap.find(".interaction-title").html(title)},attachMetadataClasses:function(){if(a5.dp.config.metadataAsCssClasses){var fields=a5.dp.config.metadataAsCssClasses.split(",");fields=_(fields).map(function(field){field=field.trim();var metadata=this.activityMetadata.getValues(field),classes=_(metadata).map(function(m){return"md-"+_.str.slugify(field)+"-"+_.str.slugify(m.value||m.description)});this.contentWrap.addClass(classes.join(" "))},this)}},attachImageDivClass:function(){this.$("div:not(.image-as-trigger) > img").parent().addClass("image-div"),this.$("div > .image-as-trigger").parent().addClass("image-div")},attachNoLabelClass:function(){this.$(".has_audio_attached").each(function(){var $elem=$(this);$elem.toggleClass("no-label",!$elem.text().trim()),$elem.filter(".no-label").toggleClass("image-label",!!$elem.find("img").length)})},highlightDictionaryEntry:function(){var found=!1;return $(this.xml).find("#contentblock").each(function(index,contentblock){var ref=A5.DICTIONARY_REF||"",$entry=$(_.first($(contentblock).contents())),words=a5.utils.splitAndTrim($entry.text(),",");if(_(words).some(function(word){return word.toLowerCase()===ref.toLowerCase()}))return found=!0,$(contentblock).attr("dictionary-selected-entry","dictionary-selected-entry"),!1}),found},hasMoreCheckAttempts:function(){var checkMaxAttempts=a5.mainBuilder.getCheckMaxAttemptsNumber(),attemptsLeft=checkMaxAttempts-this.checkAttempts;return!checkMaxAttempts||attemptsLeft>0},getItemsByClass:function(classes){return this.items.getItemsByClass(classes)},displaySpecificFeedback:function(show){show?a5.eventBus.trigger("interaction:specific-feedback:show",this):a5.eventBus.trigger("interaction:specific-feedback:close",this)},getNextAdaptiveInteraction:function(){var nextInteractionIndex=-1,fwdBtnOption=this.options.getForwardButton();if(this.options.forwardButtonIsAdaptive()&&/^(?:\s*(\d+)\s*\*\s*(\d+)\s*\|)*\s*(\d+)\s*\*\s*(\d+)\s*$/.test(fwdBtnOption))for(var match,interactionIndex,interaction,score=this.getScores().percent(),regex=/\s*(\d+)\s*\*\s*(\d+)\s*(?:\||$)/g;match=regex.exec(fwdBtnOption);)interactionIndex=parseInt(match[2],10)-1,interaction=a5.mainBuilder.getInteractionFromIndex(interactionIndex),score<=parseInt(match[1],10)&&-1===nextInteractionIndex?nextInteractionIndex=interactionIndex:-1===nextInteractionIndex&&(interaction.skippedByAdaptive=!0);return nextInteractionIndex},hasItemBank:function(){return"item-bank"===this.source},setTitleAndGroup:function(title){var regexp=/\{(.*)\}/,groupName="";this.title=title.replace(regexp,_.bind(function(match,group){return groupName=group,""},this)),this.group=groupName}},a5.models.interaction.BaseModel.extend("a5.Interaction"),a5.ItemBankErrors={EMPTY:1,AT:2,SERVER:3,IDS:4,XML:5},a5.ItemBank={init:function(parameters){var defaults={itembankId:null,node:null,activityType:"",tags:[],sets:[],amount:0,questionsXML:[],answersXML:[],errors:[],itemIds:[]};_.chain(parameters).keys().difference(_.keys(defaults)).each(function(newKey){logger.raise("Parameter",newKey,"not supported for",this)},this);var mixedParameters=$.extend({},defaults,parameters||{});$.extend(this,mixedParameters),this.id=a5.utils.createUID()},setData:function(dataObj){var errors=[];if(dataObj.total&&dataObj.total!==this.amount&&logger.warn("Itembank Api: Requested "+this.amount+" entries and got "+dataObj.total),_.isArray(dataObj.item_ids)||logger.warn("Itembank Api not returning item ids on request"),_.isArray(dataObj.item_ids)&&this.itemIds.length&&(_.difference(dataObj.item_ids,this.itemIds).length>0||_.difference(this.itemIds,dataObj.item_ids).length>0))errors.push({type:a5.ItemBankErrors.IDS,msg:"Itembank Api requested for items "+this.itemIds.join(",")+" and received items "+dataObj.item_ids.join(",")});else if(_.isEmpty(dataObj.response_declaration)||_.isEmpty(dataObj.content))errors.push({type:a5.ItemBankErrors.empty,msg:"Empty response from "+this.itembankId+"|"+this.tags.join(",")+"|"+this.sets.join(",")});else if(dataObj.errors)errors=_.pluck(dataObj.errors,"msg").map(function(er){return{type:a5.ItemBankErrors.SERVER,msg:er}});else if(dataObj.activity_type&&dataObj.activity_type!==this.activityType)errors.push({type:a5.ItemBankErrors.AT,msg:"Wrong activity type: expected "+this.activityType+" and got "+dataObj.activity_type});else{var answersXML,questionsXML,itemIds;try{answersXML=$.parseXML("<responses>"+dataObj.response_declaration+"</responses>"),questionsXML=$.parseXML("<question>"+dataObj.content+"</question>"),dataObj.item_ids&&(itemIds=dataObj.item_ids)}catch(exception){errors.push({type:a5.ItemBankErrors.XML,msg:exception.message})}errors.length||(this.answersXML=answersXML,this.questionsXML=questionsXML,this.itemIds=itemIds||[],errors=null)}return errors},getUrl:function(){return A5.ITEM_BANK_API_URL},getAnswersResponsesXML:function(){return $(this.answersXML).find("responses").clone().children()},getQuestionsXML:function(){return $(this.questionsXML).find("question").clone().children()},getUrlParams:function(){var filter={items_bank_id:this.itembankId};this.tags.length&&(filter.tags=this.tags.join(",")),this.sets.length&&(filter.sets=this.sets.join(",")),this.itemIds.length&&(filter.item_ids=this.itemIds.join(","));var page={size:this.amount},params={filter:filter,page:page};return this.itemIds.length||(params.sort="random"),params}},Obj.extend("a5.ItemBank"),a5.Score={init:function(){this.total=0,this.correct=0,this.filled=0,this.revealed=0,this.totalBlocks=0,this.correctBlocks=0,this.blockScore=void 0,this.allFilled=!1},areAllFilled:function(){return this.allFilled||this.filled+this.revealed>=this.total},isFirstFilled:function(){return this.filled+this.revealed>0},setAllFilled:function(){this.allFilled=!0},incTotal:function(val){_.isNumber(val)?this.total+=val:(val||void 0===val)&&this.total++},decTotal:function(val){_.isNumber(val)?this.total-=val:(val||void 0===val)&&this.total--,this.total<0&&(this.total=0)},incCorrect:function(val){_.isNumber(val)?this.correct+=val:(val||void 0===val)&&this.correct++},incFilled:function(val){_.isNumber(val)?this.filled+=val:(val||void 0===val)&&this.filled++},incRevealed:function(val){_.isNumber(val)?this.revealed+=val:(val||void 0===val)&&this.revealed++},decCorrect:function(val){_.isNumber(val)?this.correct-=val:(val||void 0===val)&&this.correct--},percent:function(revealedAsCorrect){return 0==this.total?100:100*(this.correct+(revealedAsCorrect?this.revealed:0))/this.total||0},percentBlocks:function(){return 0==this.totalBlocks?100:100*this.correctBlocks/this.totalBlocks||0},isPercent100:function(revealedAsCorrect){return 100===this.percent(revealedAsCorrect)},isPercentBlocks100:function(){return 100===this.percentBlocks()}},Obj.extend("a5.Score"),a5.Results={init:function(scores,options){this.scores=scores,this.options=options},_noround:function(score){return score},_round:function(score){return Math.round(score)},_roundUp:function(score){return Math.ceil(score)},_roundDown:function(score){return Math.floor(score)},total:function(){return this.options.scoreValuesIs1_point_question()?this.scores.totalBlocks:this.scores.total},correct:function(){var onePointPerBlock=this.options.scoreValuesIs1_point_question(),rounding_function=this._noround,rounding_option=this.options.getScoreRounding();return"roundup"===rounding_option?rounding_function=this._roundUp:"round"===rounding_option?rounding_function=this._round:"rounddown"===rounding_option&&(rounding_function=this._roundDown),rounding_function(onePointPerBlock?this.scores.correctBlocks:this.scores.correct)},filled:function(){return this.scores.filled},revealed:function(){return this.options.scoreValuesIs1_point_question()?0:this.scores.revealed},percent:function(revealedAsCorrect){return 0==this.total()?100:100*(this.correct()+(revealedAsCorrect?this.revealed():0))/this.total()},areAllFilled:function(){return this.scores.areAllFilled()},isFirstFilled:function(){return this.scores.isFirstFilled()},human:function(){return new a5.HumanResult(this)},isPercent100:function(revealedAsCorrect){return 100===this.percent(revealedAsCorrect)}},Obj.extend("a5.Results"),a5.CompletedResult={resetUserScore:function(){},total:function(){return 1},correct:function(){return 1},filled:function(){return 1},revealed:function(){return 0},percent:function(){return 100},areAllFilled:function(){return!0},isFirstFilled:function(){return!0},human:function(){return new a5.HumanResult(this)},isPercent100:function(){return!0}},Obj.extend("a5.CompletedResult"),a5.ResultList={init:function(scores,options){this.results=[]},push:function(result){this.results.push(result)},total:function(){return _.reduce(this.results,function(a,b){return a+b.total()},0)},correct:function(){return _.reduce(this.results,function(a,b){return a+b.correct()},0)},filled:function(){return _.reduce(this.results,function(a,b){return a+b.filled()},0)},revealed:function(){return _.reduce(this.results,function(a,b){return a+b.revealed()},0)},percent:function(revealedAsCorrect){return 0==this.total()?100:100*(this.correct()+(revealedAsCorrect?this.revealed():0))/this.total()},areAllFilled:function(){return _.all(this.results,function(r){return r.scores.areAllFilled()})},isFirstFilled:function(){return _.any(this.results,function(r){return r.scores.isFirstFilled()})},human:function(){return new a5.HumanResult(this)},isPercent100:function(revealedAsCorrect){return 100===this.percent(revealedAsCorrect)}},Obj.extend("a5.ResultList");function toFixedNLZ(num,digits){var val=num.toFixed(digits||1);return/\.0*$/.test(val)&&(val=val.substring(0,val.lastIndexOf("."))),val}Obj.extend("a5.HumanResult",{init:function(subject){this.subject=subject},total:function(){return toFixedNLZ(this.subject.total())},correct:function(){return toFixedNLZ(this.subject.correct())},filled:function(){return toFixedNLZ(this.subject.filled())},revealed:function(){return toFixedNLZ(this.subject.revealed())},percent:function(revealedAsCorrect){return Math.round(this.subject.percent(revealedAsCorrect),1)},incorrect:function(){return toFixedNLZ(this.subject.total()-this.subject.revealed()-this.subject.correct())},isPercent100:function(revealedAsCorrect){return 100===this.percent(revealedAsCorrect)}}),a5.parsers.TocParser={init:function(){this.tocEntryParser=new a5.parsers.TocEntryParser,this.tocSectionParser=new a5.parsers.TocSectionParser(this)},parse:function(lines){return"string"==typeof lines&&(lines=lines.trim().split("\n"),lines=_(lines).map(function(line){return line.replace(/\s+$/,"")})),this._chunkLinesPerLevel(lines).reduce(function(res,blockOfLines){return this._isASectionToken(blockOfLines[0])?res.push(this.tocSectionParser.parse(blockOfLines)):res.push(this.tocEntryParser.parse(blockOfLines[0])),res}.bind(this),[])},_chunkLinesPerLevel:function(lines){var level;return lines.length?(level=this._obtainLevelFor(lines[0]),lines.reduce(function(result,line){var lineLevel,lastLine;return""===line?result:(lineLevel=this._obtainLevelFor(line),lineLevel===level?result.push([line]):lineLevel>level&&(lastLine=result[result.length-1])&&lastLine.push(line),result)}.bind(this),[])):[]},_isASectionToken:function(line){return line.match(/#.*#/)},_obtainLevelFor:function(line){return line.match(/^\s*/)[0].length}},Obj.extend("a5.parsers.TocParser"),a5.parsers.TocSectionParser={init:function(parent){this.tocParser=parent},parse:function(lines){var tocLine,attributes;return tocLine=lines.shift(),attributes=this._extractAttributesFromLine(tocLine),{type:"section",page:parseInt(attributes.page,10),title:attributes.title,tocEntries:this.tocParser.parse(lines)}},_extractTitleFromLine:function(line){var matches=line.match(/#(.*)#/);return matches&&matches[1]&&matches[1].trim()},_extractAttributesFromLine:function(line){var page,regExp=/\[(.*?)\]$/,matches=line.match(regExp);return matches&&(page=matches[1]),{page:page&&page.trim(),title:this._extractTitleFromLine(line.replace(regExp,"").trim())}}},Obj.extend("a5.parsers.TocSectionParser"),a5.parsers.TocEntryParser={init:function(){},parse:function(line){var attributes=this._extractAttributesFromLine(line);return{page:parseInt(attributes.page,10),title:attributes.title}},_extractAttributesFromLine:function(line){var page,title,regExp=/\[(.*?)\]$/,matches=line.match(regExp);return matches&&(page=matches[1]),{page:page&&page.trim(),title:(title=line.replace(regExp,""))&&title.trim()}}},Obj.extend("a5.parsers.TocEntryParser"),function($){$(function(){window.self!==window.top&&$("body").is(".isMac")&&$("body").is(".isChrome")&&$("body").addClass("custom-scrollbar")})}(jQuery),a5.hooks.interactionShowed.add(function(interaction){a5.callbacks.interaction.bind("dp:uiLocaleChanged",function(lang){if(interaction.avatar){var last_audio_is_rubric=interaction.avatar.audios.last_audio===interaction.avatar.audios.rubric_audio;interaction.avatar.audios.rubric_audio.stop(),interaction.avatar.audios.rubric_audio.unbind(),interaction.avatar.__getRubricAudio(),last_audio_is_rubric&&(interaction.avatar.audios.last_audio=interaction.avatar.audios.rubric_audio)}})});try{"object"==typeof localStorage&&(localStorage.setItem("localStorage",1),localStorage.removeItem("localStorage"))}catch(e){logger.warn("No support for storing data. User might be using private mode browser. Disabling localStorage"),Storage.prototype._setItem=Storage.prototype.setItem,Storage.prototype.setItem=function(){}}!function($,document){var oldGetStyles=$.fn.getStyles;$.fn.getStyles=function(){var result=oldGetStyles.apply(this,arguments),$el=this;return document.documentMode&&("height"in result&&(result.height=$el.css("height")),"width"in result&&(result.width=parseInt($el.css("width"),10)+1)),result}}(jQuery,window.document),function($){$.ui.draggable.prototype._normalizeRightBottom=function(){}}(jQuery),function(){a5.hooks.interactionLoaded.add(_.once(function(){if(a5.dp.config.feedbackClickToggle){$(document.body).addClass("dp-config-nofeedbackhover");var active;$(document.body).on("click",".check",function(){active&&active.toggleClass("feedback-force-display"),$(this).is(active)||($(".feedback-force-display").removeClass("feedback-force-display"),$(this).addClass("feedback-force-display"),active=$(this))}),$(document.body).on("click",function(e){active&&!$(e.target).is(active)&&(active.removeClass("feedback-force-display"),active=void 0)})}}))}();var oldMouseStart=$.ui.draggable.prototype._mouseStart;$.ui.draggable.prototype._mouseStart=function(event,overrideHandle,noActivation){this._trigger("beforeStart",event,this._uiHash()),oldMouseStart.apply(this,[event,overrideHandle,noActivation])},function($){var $base=$("base");$base.length>0&&($.ui.tabs.prototype._isLocal=function(){var rhash=/#.*$/;return function(anchor){var anchorUrl,locationUrl;anchor=anchor.cloneNode(!1),anchorUrl=anchor.href.replace(rhash,""),locationUrl=$base.get(0).href.replace(rhash,"");try{anchorUrl=decodeURIComponent(anchorUrl)}catch(error){}try{locationUrl=decodeURIComponent(locationUrl)}catch(error){}return anchor.hash.length>1&&anchorUrl===locationUrl}}())}(jQuery),a5.views.ResourcesZone={init:function(interaction){this.interaction=interaction,this.$el=interaction.resourcesZone,this.$contentWrap=interaction.contentWrap},render:function(){var resources=this._getResourcesFromXML();this.$el.empty(),resources.length&&this.$el.append.apply(this.$el,_(resources).map(function(resource){return resource.render()})),$(".layout",this.$contentWrap).toggleClass("isWithoutResources",!resources.length)},_getResourcesFromXML:function(){return _($("#resources",this.interaction.xml).children()).map(function(resourceNode){return this._createResource($(resourceNode))},this)},_createResource:function($node){var className=a5.utils.capitalize($node[0].tagName)+"Resource";return new(0,a5.views[className])($node)}},Obj.extend("a5.views.ResourcesZone"),a5.views.Resource={template:'<a class="link" href="<%= url %>" data-type="<%= type %>"><strong class="name"><%= title %></strong></a>',init:function(interactionNode){_(this).bindAll("onResourceClick"),this._super(null,null,$('<div class="resource"></div>')),this.renderTemplate=_.template(this.template),this.interactionNode=interactionNode,this.node.on("click",".link",this.onResourceClick)},onResourceClick:function(e){e.preventDefault(),this.open()},render:function(){return this.node.html(this.renderTemplate(this._serializeData()))},open:function(){},buildTitle:function(){},buildUrl:function(){},buildType:function(){},_serializeData:function(){return{url:this.buildUrl(),type:this.buildType(),title:this.buildTitle()}}},a5.views.interaction.BaseView.extend("a5.views.Resource"),a5.views.UrlResource={init:function(interactionNode){this._super(interactionNode),this.url=interactionNode.attr("url"),this.title=interactionNode.attr("title")},open:function(){a5.mainBuilder.engine.invoke("open-link",this.url)},buildUrl:function(){return this.url},buildType:function(){return"url"},buildTitle:function(){return this.title}},a5.views.Resource.extend("a5.views.UrlResource"),a5.views.PlatformResource={init:function(interactionNode){this._super(interactionNode),this.platformId=interactionNode.attr("platformid"),this.title=interactionNode.attr("title")},open:function(){var $iframe=$('<iframe frameborder="0" scrolling="no" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true">');$iframe.attr("src",this.$(".link").attr("href")),$iframe.iframeModal()},buildUrl:function(){return(A5&&A5.PLATFORM_URL_BUILDER||this._defaultUrl).call(null,this.platformId)},buildType:function(){return"platform"},buildTitle:function(){return this.title},_defaultUrl:function(platformId){var course,match=/courses\/(\d+)/.exec(window.location.href);return match&&(course=match[1]),"/api/courses/"+course+"/interactives/"+platformId+".html"}},a5.views.Resource.extend("a5.views.PlatformResource"),function(a5,$,_){a5.views.ScreenNavigation={template:'<ul><% _.each(screens, function(screen) { %><li<% if(screen.isActive) { %> class="active"<% } %>><a href="#" data-index="<%= screen.index %>"><%= screen.title %></a></li><% }) %></ul>',init:function($el){_.bindAll(this,"onScreenClick","onInteractionShowed"),this.$el=$el,this._createScreens(),this.render(),this._bindEvents()},render:function(){this._hasToShowLinks()&&(this._markActiveScreen(),this.renderTemplate=_.template(this.template),this.$el.html(this.renderTemplate({screens:this.screens})))},onScreenClick:function(e){var $element=$(e.currentTarget),interactionIndex=$element.data("index");a5.mainBuilder.goTo(interactionIndex),e.preventDefault()},onInteractionShowed:function(){this.render()},_bindEvents:function(){this.$el.on("click","a",this.onScreenClick),a5.hooks.interactionShowed.add(this.onInteractionShowed)},_markActiveScreen:function(){_(this.screens).each(function(screen){screen.isActive=screen.index===this._getCurrentInteractionNumber()},this)},_createScreens:function(){this.screens=[{title:"Home",index:0}],_(this._getNumberOfInteractions()-1).times(function(n){this.screens.push({title:"Unit "+(n+1),index:n+1})},this)},_hasToShowLinks:function(){return this._getNumberOfInteractions()>1},_getNumberOfInteractions:function(){return a5.mainBuilder.getNumberOfInteractions()},_getCurrentInteractionNumber:function(){return a5.mainBuilder.curTask}},Obj.extend("a5.views.ScreenNavigation")}(a5,jQuery,_),a5.views.MediaZone={init:function(interaction){_.bindAll(this,"flag"),this.interaction=interaction,this.$el=interaction.mediaZone,this._pinnedText={},this._pinnedMedia={},this.interaction.bind("show",this.flag),this.interaction.bind("show",_.bind(this._setUpdatedMedia,this)),this.interaction.bind("show:deferred",_.bind(this._setUpdatedScroll,this)),interaction.options.audiosupportIsTrue()&&this.addTTSPlayer(),this._initPinnedText(),_.defer(_.bind(this._initPinnedMedia,this))},_initPinnedMedia:function(){this.$el.find("*[data-option023]").each(_.bind(this._registerPinnedMedia,this))},_registerPinnedMedia:function(i,el){var regex=/_(\d+)$/,media_uid=$(el).attr("data-playable-media"),media_baseid=media_uid.replace(regex,""),media_obj=a5.service.media.by_id[media_uid];this._pinnedMedia[media_baseid]={obj:media_obj,position:0},media_obj.bind("progress",_.bind(function(position){this._syncPinnedMedia(media_baseid,position)},this)),media_obj.bind("seeked",_.bind(function(position){this._syncPinnedMedia(media_baseid,position)},this)),media_obj.bind("stopped",_.bind(function(){media_obj.audioObject&&this._syncPinnedMedia(media_baseid,0)},this))},_setUpdatedMedia:function(){_.each(this._pinnedMedia,function(media,id){media.obj.position(media.position)},this)},_syncPinnedMedia:function(id,position){_.each(a5.mainBuilder.intList,function(interaction){if(interaction.mediaZoneView){var media=interaction.mediaZoneView._pinnedMedia[id];media&&(media.position=position)}},this)},_initPinnedText:function(){var regex=/option023:(\w+);/;this.$el.find("#text").each(_.bind(function(i,el){var match=$(el).attr("style").match(regex);match&&this.addPinnedText(match[1],el)},this))},_setUpdatedScroll:function(){_.defer(_.bind(function(){_.each(this._pinnedText,function(text,id){text.node.scrollTop(text.top),text.node.scrollLeft(text.left)},this)},this))},addPinnedText:function(id,el){var $el=$(el);this._pinnedText[id]={node:$el,top:$el.scrollTop(),left:$el.scrollLeft()},$el.on("scroll",_.bind(function(e){this.interaction.index==a5.mainBuilder.curInteraction.index&&this.syncPinnedText(id,$el.scrollTop(),$el.scrollLeft())},this))},syncPinnedText:function(id,top,left){_.each(a5.mainBuilder.intList,function(interaction){if(interaction.mediaZoneView){var text=interaction.mediaZoneView._pinnedText[id];text&&(text.top=top,text.left=left)}},this)},addTTSPlayer:function(){var nodes=this.$el.find("img[alt][alt!='']");_.each(nodes,function(node){var alt=$(node).attr("alt");if(!alt.match(/^\s*\.+\s*$/)){var wrap=$("<div class='tts_wrap' style='position:absolute;'>");wrap.css({left:$(node).css("left"),top:$(node).css("top"),width:$(node).width(),height:$(node).height()}),$(node).css({left:"",top:"",position:""});var tts=new a5.views.TTS_Player(alt).render();tts.css("z-index","1000"),$(node).wrap(wrap),$(node).parent().prepend(tts)}})},_hasTextContent:function(node){var hasImgAlt=node.find("img[alt][alt!='']").length>0,hasText=""!==node.text().trim()&&!node.text().trim().match(/^\s*\.+\s*$/);return hasImgAlt||hasText},render:function(){},flag:function(){$("body").toggleClass("isWithoutMedia",this.$el.is(":empty"))}},Obj.extend("a5.views.MediaZone"),a5.views.LessonNotes={
template:'<div class="layout"><div class="annotations"></div><div class="list"><% if (notes.length){ %><% _.each(notes, function(note){ %><div class="note"><% if (note.screen) { %><a class="thumbnail" href="#" data-screen="<%= note.screen %>"><img src="<%= thumbnailsUrl+"?screen="+(note.screen - 1) %>" width="160" height="120"></a><% } %><div class="notes"><%= note.text %></div></div><% }) %><% }else{ %><span class="no_content">No notes.</span><% } %></div></div>',NOTES_REGEX:/<p>\s*<a [^>]*name=\\*"([0-9]+)\\*" ?[^>]*><\/a>\s*<\/p>\n?/,init:function($el){this.notes=this._parseNotes(window.LOInfo.notes,this.NOTES_REGEX),this.active=!1,this.$=$el,this.thumbnailsUrl=window.LOInfo.thumbnailsUrl,this.renderTemplate=_.template(this.template),this.render(),this._bindEvents()},hasNotes:function(){return!!this.notes.length},isActive:function(){return this.active},render:function(){this.$.empty(),this.$.hide(),$(this.renderTemplate(this)).appendTo(this.$)},onClickThumbnail:function(e){var $element=$(e.currentTarget),interactionIndex=$element.data("screen")-1;this.hide(),a5.mainBuilder.goTo(interactionIndex),e.preventDefault()},enableAnnotations:function(){},show:function(){this.active=!0,this.$.show(),$("#content_wrap, #page_controls").hide(),$("body").addClass("isNotesView")},hide:function(){this.active=!1,$("#content_wrap, #page_controls").show(),this.$.hide(),$("body").removeClass("isNotesView")},_bindEvents:function(){this.$.on("click",".thumbnail",_.bind(this.onClickThumbnail,this))},_parseNotes:function(text,regex){var parsedNotes=[];if(text){var notes=text.split(regex);if(""===notes[0]&&notes.shift(),notes.length){notes[0].match(/^[0-9]+$/)||notes.unshift("0");for(var i=0;i<notes.length;i+=2)parsedNotes.push({screen:+notes[i],text:notes[i+1]})}}return parsedNotes}},Obj.extend("a5.views.LessonNotes"),a5.views.WhiteboardTools={init:function(appendTo,interactions){this.annotations=new a5.Annotations({language:a5.dp.config.bookAnnotationsLanguage||"en",stage:"annotations",appendTo:appendTo,keyboard:!0}),this.annotations.config.defaultStickyNoteSize=200,this.annotations.toolbox.use([new a5.Annotations.Tool.Undo,new a5.Annotations.Tool.Redo,new a5.Annotations.Tool.Cursor,new a5.Annotations.Tool.Pen,new a5.Annotations.Tool.Highlighter,new a5.Annotations.Tool.Eraser,new a5.Annotations.Tool.StickyNote,new a5.Annotations.Tool.Spotlight,new a5.Annotations.Tool.Save,new a5.Annotations.Tool.Hide]),this.annotations.useTool("cursor"),_(interactions).each(function(interaction){"Present:Present:Ebook"!==interaction.identifier&&"Present:Present:AudioBook"!==interaction.identifier||this.activate(interaction)},this)},activate:function(interaction){(interaction.view?interaction.view.$node:interaction.node||interaction.$).find("."+a5a.current.view.domSelector).length>0&&(this.annotations.allocate(interaction),interaction.bind("show:deferred",_.bind(function(){this.annotations.activate([interaction])},this)))}},Obj.extend("a5.views.WhiteboardTools"),a5.service.Toolbelt={init:function(){this.convertURL=A5.TOOLBELT_URL+"/convert",this.audioManipulatorURL=A5.TOOLBELT_URL+"/audio-manipulator"},exportTo:function(options){if(_.isArray(options.formats)&&options.formats.length>1){var formats=options.formats;this._exportToMultipleFormats(formats,_.omit(options,"formats"))}else{var format=_.isArray(options.formats)?options.formats[0]:options.formats;this._exportToSingleFormat(format,_.omit(options,"formats"))}},audioDownload:function(options){var data={input:options.inputs.map(function(input){return a5.utils.startsWith(input,"//")?"http:"+input:input}),clips:options.clips,output:options.output},_getLink=$.ajax({type:"POST",data:JSON.stringify(data),contentType:"application/json",url:this.audioManipulatorURL});a5.mainBuilder.engine.invoke("open-link",_getLink,{target:"iframe"})},_exportToSingleFormat:function(format,options){var data=_.extend({from:"html",to:format,disposition:"attachment"},options),$form=this._buildForm(this.convertURL,data);$("body").append($form),$form.submit(),$form.remove()},_exportToMultipleFormats:function(formats,options){_(formats).each(function(format){var data=_.extend({from:"html",to:format,disposition:"attachment"},options),$form=this._buildForm(this.convertURL,data),$iframe=$("<iframe>",{id:"iframe-toolbelt-export",src:"about:blank"}).hide().appendTo("body");$iframe.contents().find("body").append($form),$form.attr("target","_self"),$form.submit(),setTimeout(function(){$iframe.remove()},1e3)},this)},_buildForm:function(action,data){var $form=$("<form>",{action:action,method:"post",target:"_blank"});return _.each(data,function(v,k){_.isArray(v)?_.each(v,function(item){$form.append($("<input>").attr("name",k+"[]").attr("type","hidden").val(item))}):$form.append($("<input>").attr("name",k).attr("type","hidden").val(v))}),$form}},Obj.extend("a5.service.Toolbelt",a5.service.Toolbelt),a5.service.Wiki={init:function(identifier){this.adapter=A5.WIKI&&A5.WIKI.getWikiServiceFor(identifier)},start:function(){return this.adapter.start()},stop:function(){this.adapter.stop()},write:function(content){return this.adapter.write(content)},startEditing:function(){return this.adapter.startEditing()},stopEditing:function(){return this.adapter.stopEditing()},subscribe:function(){this.adapter.subscribe.apply(this.adapter,arguments)},ping:function(){this.adapter.ping()},fetchLogs:function(){return this.adapter.fetchLogs()},fetchLog:function(id){return this.adapter.fetchLog(id)},canEdit:function(){return this.adapter.canEdit()},canExport:function(){return this.adapter.canExport()},canSeeWikiLogs:function(){return this.adapter.canSeeWikiLogs()}},Obj.extend("a5.service.Wiki"),a5.views.Wiki={PING_INTERVAL:5e3,template:'<div class="wiki modal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4>{{{wikiTitle}}}</h4></div><div class="modal-body"></div></div></div></div>',tabsTemplate:'<ul class="nav nav-tabs" id="wiki-tabs"><li class="active"><a href="#wiki-main-panel" data-toggle="tab">Wiki</a></li><li><a href="#wiki-history-panel" data-toggle="tab">History</a></li></ul><div class="tab-content"><div class="tab-pane active" id="wiki-main-panel"></div><div class="tab-pane" id="wiki-history-panel"></div></div>',historyTemplate:'<ul>{{#each wikiEntries as |entry|}}<li><a href="#" data-entry="{{entry.id}}">{{entry.user}} - {{entry.timestamp}}</a></li>{{else}}<p>No entries added yet.</p>{{/each}}</ul>',currentTemplate:'<div class="wiki-status"></div><div class="wiki-content"><textarea readonly="readonly">{{{wikiContent}}}</textarea></div><div class="wiki-toolbar btn-toolbar" role="toolbar"><button id="btn_wiki_take_control" type="button" class="btn btn-primary disabled">Take control</button><button id="btn_wiki_export" type="button" class="btn btn-primary disabled">Export to RTF</button><button id="btn_wiki_save"   type="button" class="btn btn-primary disabled">Save</button></div>',oldTemplate:'<p>This is an old wiki version. See latest wiki <a id="btn_current_wiki" href="#">here</a></p><div class="wiki-content">{{{wikiContent}}}</div>',exportTemplate:'<div class="wiki"><div class="wiki-header"><h4>{{{wikiTitle}}}</h4></div><div class="wiki-body"><div class="wiki-content">{{{wikiContent}}}</div></div></div>',init:function(model,service,exportService){this.model=model,this.service=service,this.exportService=exportService,this.service.subscribe("updated",_.bind(function(content){this.model.setContent(content)},this)),this.service.subscribe("locked",_.bind(function(lock){this.model.setLock({status:lock.status,owner:lock.owner})},this)),this.service.subscribe("unlocked",_.bind(function(){this.model.setLock({status:"unlocked"})},this))},render:function(){var html=a5.service.templates.render("a5.view.Wiki",{wikiTitle:this.model.title},this.template);this.$=$(html),this.$current=$('<div id="wiki-current"></div>'),this.$history=$('<div id="wiki-history"></div>'),this.$old=$('<div id="wiki-old"></div>');var current=a5.service.templates.render("a5.view.WikiCurrent",{wikiContent:this.model.content},this.currentTemplate);this.$current.append(current),this.$.addClass("wiki-loading"),this.editor=this._initCK(),this.editor.on("instanceReady",function(){this.renderContent(),this.model.bind("content:change",function(){this.renderContent()},this),this.renderStatus(),this.model.bind("status:change",function(){this.renderStatus()},this)},this),this.editor.on("destroy",function(){this.model.unbind("content:change"),this.model.unbind("status:change")},this),this.renderToolbar(),this.$.find(".modal-body").empty(),this.$.find(".modal-body").append(this.$current),this.service.start().done(function(){this.renderToolbar(),this.renderTabs(),this.$.removeClass("wiki-loading")}.bind(this)).fail(function(){this.$.removeClass("wiki-loading")}.bind(this))},renderContent:function(){this.model.content&&this.editor.setData(this.model.content)},renderStatus:function(){this.$.removeClass("wiki-locked wiki-unlocked wiki-editing"),this.$current.find(".wiki-status").empty(),this.model.lock&&("unlocked"===this.model.lock.status&&this._unlock(),"owned"===this.model.lock.status&&this._own(),"locked"===this.model.lock.status&&this._lock(this.model.lock.owner))},renderToolbar:function(){this.service.canExport()?(this._showButton("btn_wiki_export"),this._enableButton("btn_wiki_export",this.onExport)):(this._hideButton("btn_wiki_export"),this._disableButton("btn_wiki_export"))},renderTabs:function(){if(this.service.canSeeWikiLogs()){var tabs=a5.service.templates.render("a5.view.WikiTabs",{},this.tabsTemplate),$tabs=$(tabs);$tabs.find("#wiki-main-panel").append(this.$current),$tabs.find("#wiki-main-panel").append(this.$old),$tabs.find("#wiki-history-panel").append(this.$history),$tabs.find("a[href=#wiki-history-panel]").on("show.bs.tab",_.bind(this.onSeeWikiLog,this)),this.$old.hide(),this.$.find(".modal-body").empty(),this.$.find(".modal-body").append($tabs),this.$mainTab=$tabs.find("a[href=#wiki-main-panel]"),this.$historyTab=$tabs.find("a[href=#wiki-history-panel]")}},showAsModal:function(){this.render(),this.$.modal({}).on("hidden",_.bind(this.onCloseModal,this))},onCloseModal:function(){this._destroyCK(),this.service.stopEditing().done(function(){this.service.stop()}.bind(this)),this.$.remove()},onTakeControl:function(e){e.preventDefault(),this.service.startEditing().done(function(){}.bind(this)).fail(function(){}.bind(this))},onSave:function(e){e.preventDefault(),this.service.write(this._getContent()).then(this.service.stopEditing.bind(this.service)).done(function(){}.bind(this)).fail(function(){}.bind(this))},onExport:function(e){e.preventDefault();var input=a5.service.templates.render("a5.view.WikiExport",this._createModel(),this.exportTemplate);this.exportService.exportTo({formats:"rtf",input:input})},onSeeWikiLog:function(e){e.preventDefault(),this.service.fetchLogs().done(function(entries){var logs=a5.service.templates.render("a5.view.WikiHistory",{wikiEntries:_(entries).map(function(entry){return entry.timestamp=new Date(entry.timestamp).toLocaleString(),entry})},this.historyTemplate),$logs=$(logs);this.$history.empty(),this.$history.append($logs),$logs.on("click","li",_.bind(this.onSeeWikiLogEntry,this))}.bind(this))},onSeeWikiLogEntry:function(e){e.preventDefault();var id=$(e.currentTarget).find("a[data-entry]").attr("data-entry");this.service.fetchLog(id).done(function(entry){this.$old.empty();var old=a5.service.templates.render("a5.view.WikiOld",{wikiContent:entry.text},this.oldTemplate);this.$old.append(old),this.$current.hide(),this.$old.show(),this._enableButton("btn_current_wiki",function(){this.$current.show(),this.$old.hide()}.bind(this)),this.$mainTab.tab("show")}.bind(this))},onUpdated:function(content){this.model.setContent(content)},_lock:function(owner){this.$.addClass("wiki-locked"),this.$current.find(".wiki-status").append(owner),this._disableEditor(),this._disableButton("btn_wiki_save"),this._disableButton("btn_wiki_take_control")},_unlock:function(){this.$.addClass("wiki-unlocked"),this._disableEditor(),this._disableButton("btn_wiki_save"),this._enableButton("btn_wiki_take_control",this.onTakeControl)},_own:function(){this.$.addClass("wiki-editing"),this._enableEditor(),this._enableButton("btn_wiki_save",this.onSave),this._disableButton("btn_wiki_take_control")},_createModel:function(){return{wikiTitle:this.model.title,wikiContent:this.model.content}},_disableButton:function(btnID){var $button=this.$.find("#"+btnID);$button.off(),$button.removeClass("btn_active"),$button.addClass("btn_inactive disabled")},_enableButton:function(btnID,clickFn){var $button=this.$.find("#"+btnID);$button.off(),$button.on("click",clickFn.bind(this)),$button.addClass("btn_active"),$button.removeClass("btn_inactive disabled")},_hideButton:function(btnID){this.$.find("#"+btnID).hide()},_showButton:function(btnID){this.$.find("#"+btnID).show()},_initCK:function(){var $textarea=this.$current.find("textarea");return CKEDITOR.replace($textarea[0])},_destroyCK:function(){this.editor.destroy(!0)},_disableEditor:function(){this.editor.removeListener("change",this._ping),this.editor.setReadOnly(!0)},_enableEditor:function(){this.editor.removeListener("change",this._ping),this.editor.on("change",this._ping,this),this.editor.setReadOnly(!1)},_ping:function(){_.debounce(this.service.ping.bind(this.service),this.PING_INTERVAL)},_getContent:function(){return this.editor.getData()}},Obj.extend("a5.views.Wiki"),a5.views.WikiTool={init:function(interaction){var wiki=this.findWiki(interaction.xml);wiki&&(this.model=new a5.models.Wiki({id:interaction.getID(),title:wiki.title,content:wiki.content}))},findWiki:function(xml){var $wiki=$(xml).find("itemBody").find("#wiki");return $wiki.length>0&&{title:$wiki.find("title").html(),content:$wiki.find("content").html()}},hasWiki:function(){return!!this.model},show:function(){if(this.hasWiki()){var wikiService=new a5.service.Wiki(this.model.id);new a5.views.Wiki(this.model,wikiService,a5.service.toolbelt).showAsModal()}}},Obj.extend("a5.views.WikiTool"),a5.models.Wiki={init:function(parameters){this.id=parameters.id,this.title=parameters.title,this.content=parameters.content},setContent:function(content){this.content!==content&&(this.content=content,this.trigger("content:change"))},setLock:function(lock){_(this.lock).isEqual(lock)||(this.lock=lock,this.trigger("status:change"))}},Obj.extend("a5.models.Wiki"),a5.model_builder.OSSortingInteraction={isResponsible:function(node,interaction){return"Order:Sort:Sorting"===interaction.identifier&&node.is("matchInteraction, simpleMatchSet, simpleAssociableChoice")},buildMatchInteraction:function(interaction,parentNode,node){this.vent=this._createEventBus(),this.elementRepository=this._createElementRepository(),this.elementViewRepository=this._createElementViewRepository(this.elementRepository),this.responses=this._createResponses(interaction,node),this.model=this._createInteractiveModel(interaction,this.elementRepository),this.pool=this._createPool(interaction,this.vent),this.targets=this._createTargets(interaction,this.vent),this.targetViewFactory=this._createTargetViewFactory(interaction,this.vent,this.responses),this.view=this._createView(interaction),this.buildContents(node,interaction,parentNode),interaction.options.prefillIsFirstitem()&&this.model.setPrefill(),parentNode.append(this.view.render()),parentNode.addInteractionStyle("drag-drop"),parentNode.addInteractionStyle("wordpool-"+this.pool.align),interaction.options.multipleDestinationsIsOne()||parentNode.addInteractionStyle("multiple-destinations"),interaction.blockItems.add(this.model)},buildSimpleMatchSet:function(interaction,parentNode,node){this.buildContents(node,interaction,parentNode)},buildSimpleAssociableChoice:function(interaction,parentNode,node){if(this._isNodeForTargetBuilding(node)){var targetTable=this._createTargetTable(interaction,parentNode,node);this.targets.add(targetTable)}else{var element=this._createElement(interaction,parentNode,node),elementView=this._createElementView(interaction,element),method=interaction.options.multipleDestinationsIsOne()?"add":"merge";this.elementRepository[method](element),this.elementViewRepository[method](elementView),this.pool[method](element)}},_createEventBus:function(){return new Obj},_createElementRepository:function(){return new a5.models.interaction.OSSortingElementRepository},_createResponses:function(interaction,node){return interaction.getCorrectResponse(node.attr("responseIdentifier"))},_createInteractiveModel:function(interaction,elementRepository){var behavior=this._getGapfillBehavior(interaction);return new a5.models.interaction.OSSortingModel({behavior:behavior,repository:elementRepository,interaction:interaction,responses:this.responses})},_getGapfillBehavior:function(interaction){var behavior=interaction.options.getGapfillbehaviour();return"tap_item"!==behavior&&"tap_target"!==behavior||"mobile"===a5.dp.config.gapfillBehaviourApplicable&&a5.utils.isDocumentOverMobileBreakpoint()&&(behavior="drag"),behavior},_createElementViewRepository:function(elementRepository){return new a5.views.interaction.OSSortingElementViewRepository({elementRepository:elementRepository})},_createView:function(interaction){return new a5.views.interaction.OSSortingView({model:this.model,vent:this.vent,interaction:interaction,pool:this.pool,targets:this.targets})},_createPool:function(interaction,vent){return new a5.views.interaction.OSSortingPoolView({vent:vent,interaction:interaction,elementViewRepository:this.elementViewRepository,elementRepository:this.elementRepository})},_createTargets:function(interaction,vent){return new a5.views.interaction.OSSortingTargetsView({vent:vent,interaction:interaction})},_createTargetViewFactory:function(interaction,vent,responses){return new a5.views.interaction.OSSortingTargetViewFactory({interaction:interaction,vent:vent,responses:responses})},_createTargetTable:function(interaction,parentNode,node){var targetModel=new a5.models.interaction.OSSortingTarget({parent:this.model,identifier:node.attr("identifier"),node:node,interaction:interaction});return this.targetViewFactory.createTargetView({model:targetModel,elementViewRepository:this.elementViewRepository,elementRepository:this.elementRepository,containerImage:this._extractContainerImage(interaction)})},_createElement:function(interaction,parentNode,node){var element=new a5.models.interaction.OSSortingElement({parent:this.model,identifier:node.attr("identifier"),correctTarget:this._retrieveCorrectResponseFromNode(node),interaction:interaction,node:node,correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()});return element.assignAnswerFeedback(node),element},_createElementView:function(interaction,element){return new a5.views.interaction.OSSortingElementView({interaction:interaction,model:element,vent:this.vent})},_retrieveCorrectResponseFromNode:function(node){return this.responses.asMap()[node.attr("identifier")]},_isNodeForTargetBuilding:function(node){return _(this.responses.asMapMulti()).has(node.attr("identifier"))},_extractContainerImage:function(interaction){return $(interaction.options.getContainerStyle()).find("img").get(this.targets.size())}},a5.model_builder.Base.extend("a5.model_builder.OSSortingInteraction"),a5.model_builder.builders.push(new a5.model_builder.OSSortingInteraction),a5.models.interaction.OSSortingModel={init:function(parameters){this._super(parameters,{behavior:"drop",repository:null,interaction:null,responses:null}),this.targets=[]},addTarget:function(target){this.targets.push(target)},getTargetStatus:function(){var result={};return _.each(_.pluck(this.targets,"identifier"),function(target){result[target]=_.filter(this._getElements(),function(element){return element.isInTarget(target)}).length},this),result},getSmallestTarget:function(except){var resp=this.responses.asInverseMap();return _.findKey(this.getTargetStatus(),function(v,k){return v<resp[k].length&&!_.contains(except,k)})},setPrefill:function(){var element=this._firstElement();element&&element.setPrefill()},store:function(){return _(this._getElements()).map(function(element){return element.store()})},restore:function(attrsList){_(this._getElements()).each(function(element,index){element.restore(attrsList[index])})},getScores:function(){var totalCorrect=this._getTotalCorrectElements(),totalWrong=this._getTotalWrongElements(),total=(this._getTotalMissingElements(),this._getTotalElements()),scores=this._super();return scores.incTotal(total),scores.incFilled(_.min([total,totalCorrect+totalWrong])),this.interaction.options.scorecalculationIsSubtractIncorrect()&&(totalCorrect=_.max([0,totalCorrect-totalWrong])),scores.incCorrect(totalCorrect),scores},isCorrect:function(){return _.every(this._getElements(),function(element){return element.isCorrect(_.first(element.currentTarget))})},isFilled:function(){return _.some(this._getElements(),function(target){return target.isInSomeTarget()})},isDrag:function(){return"drag"===this.behavior},isTapItem:function(){return"tap_item"===this.behavior},isTapTarget:function(){return"tap_target"===this.behavior},findElementInTarget:function(target){return _.find(this._getElements(),function(element){return element.isInTarget(target)})},getCandidatesForSolutionHint:function(){return _.filter(this._getElements(),function(item){return!("answers"===item.state||item.isDistractor()||item.isInSomeTarget()||item.prefill||item.prefilled)})},getCandidatesForShowNextAnswer:function(){return _.filter(this._getElements(),function(item){return!("answers"===item.state||item.isDistractor()||item.isCorrect()||item.prefill||item.prefilled)})},getCandidatesForValidation:function(){return _.filter(this._getElements(),function(item){return"answers"!==item.state&&!item.isDistractor()&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint?question.showSolutionHint():question.showNextAnswer?question.showNextAnswer():question.showAnswer&&question.showAnswer()),this.hasCandidatesForValidation()||(this.state="answers"),question},clearAll:function(){_(this._getElements()).invoke("unsetTarget")},clearWrong:function(){_(this._getElements()).invoke("unsetWrongTargets")},tryAgain:function(){this.interaction.options.tryAgainIsLock()||this.interaction.options.tryAgainIsFrozen()||this.interaction.options.tryAgainIsFalse()?this.clearWrong():this.interaction.options.tryAgainIsClear()&&this.clearAll(),_(this._getElements()).invoke("tryAgain"),this._super()},setAnswer:function(){_(this._getElements()).invoke("setAnswer"),this._super()},setAnswerInput:function(){_(this._getElements()).invoke("setAnswerInput"),this._super()},showAnswer:function(){_(this._getElements()).invoke("showAnswer"),this._super()},setSelected:function(element,view){this.selected&&this.selected.deselect(),this.selected!==element?(this.selected=element,this.selectedView=view,this.selected.select()):(this.selected.deselect(),this.selected=void 0,this.selectedView=void 0)},deselect:function(){this.selected&&(this.selected.deselect(),this.selected=void 0,this.selectedView=void 0)},getSelected:function(){return this.selected},getSelectedView:function(){return this.selectedView},_getElements:function(){return this.repository.getElements()},_firstElement:function(){return this.repository.first()},_getWrongOrMissingElements:function(){return this.repository.findWrong().concat(this.repository.findMissing())},_getTotalCorrectElements:function(){return this.repository.getTotalCorrect()},_getTotalWrongElements:function(){return this.repository.getTotalWrong()},_getTotalMissingElements:function(){return this.repository.getTotalMissing()},_getTotalDistractorElements:function(){return this.repository.getTotalDistractor()},_getTotalElements:function(){return this.repository.getTotal()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSSortingModel"),a5.models.interaction.OSSortingElement={init:function(parameters){this._super(parameters,{identifier:"",text:"",correctTarget:[],currentTarget:[],interaction:null,node:"",tryAgainIsFrozen:!1}),this.isMulti=!this.interaction.options.multipleDestinationsIsOne(),this.gaptextaudio=this.interaction.options.gaptextaudioIsTrue(),this.buildText()},buildText:function(){return this.text=this._extractContentFromNode(),this.gaptextaudio&&this.text.prepend(this._createTTSAudio(this.text.text()).render()),this.text},merge:function(element){this.correctTarget=_.union(this.correctTarget,element.correctTarget),this.currentTarget=_.union(this.currentTarget,element.currentTarget)},setPrefill:function(){this.prefilled=!0},isPrefilled:function(){return!!this.prefilled},isInCorrectTarget:function(target){return _.contains(this.correctTarget,target)},isInSomeTarget:function(){return this.currentTarget.length>0},belongsToPool:function(){var belongs=!1;return belongs="answers"===this.state?this.isDistractor():this.isMulti||!this.isInSomeTarget(),!this.isPrefilled()&&belongs},isInTarget:function(target){return target&&_.contains(this.currentTarget,target)},isCorrect:function(target){return!this.isDistractor()&&this.isInTarget(target)&&this.isInCorrectTarget(target)},countCorrect:function(){return!this.isPrefilled()&&_.intersection(this.currentTarget,this.correctTarget).length||0},isWrong:function(target){return this.isInTarget(target)&&!this.isInCorrectTarget(target)},countWrong:function(){return!this.isPrefilled()&&_.difference(this.currentTarget,this.correctTarget).length||0},isMissing:function(target){if(target){var wrongs=_.difference(this.currentTarget,this.correctTarget);return _.difference(this.correctTarget,this.currentTarget).indexOf(target)>=wrongs.length}return this.currentTarget.length<this.correctTarget.length},countMissing:function(){return!this.isPrefilled()&&_.max([this.correctTarget.length-this.currentTarget.length,0])||0},countTotal:function(){return!this.isPrefilled()&&this.correctTarget.length},isDistractor:function(){return!this.correctTarget.length},isEqualTo:function(element){var $elementText=element.text,$text=this.text;return($.trim($elementText.text())||$elementText.find("img[data-mathml]").data("mathml")||$elementText.find("img[src]").attr("src")||$elementText.find('object[type="audio/audio"]').attr("data"))===($.trim($text.text())||$text.find("img[data-mathml]").data("mathml")||$text.find("img[src]").attr("src")||$text.find('object[type="audio/audio"]').attr("data"))},setTarget:function(target,silent){_.contains(this.currentTarget,target)||(this.isMulti||this.unsetTarget(null,!0),this.currentTarget.push(target),silent||this.trigger("changed"))},unsetTarget:function(target,silent){var newTarget;target?_.contains(this.currentTarget,target)&&(newTarget=_(this.currentTarget).without(target)):newTarget=[],0!==_.difference(this.currentTarget,newTarget).length&&(this.currentTarget=newTarget,silent||this.trigger("changed"))},select:function(){this.trigger("selected")},deselect:function(){this.trigger("deselected")},unsetWrongTargets:function(){var targets=_.difference(this.currentTarget,this.correctTarget);_(targets).each(function(target){this.unsetTarget(target)},this)},showNextAnswer:function(){this.isInSomeTarget()&&this.unsetWrongTargets(),this.showAnswer(),this.trigger("changed")},store:function(){return this.currentTarget},restore:function(targets){_(targets).each(function(target){this.setTarget(target)},this)},_extractContentFromNode:function(){return a5.utils.buildContents(this.node,this.interaction,$("<div></div>"))},_createTTSAudio:function(text){return new a5.views.TTS_Player(text)}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSSortingElement"),a5.models.interaction.OSSortingTarget={init:function(parameters){this._super(parameters,{identifier:null,title:"",node:"",interaction:null}),this.buildTitle(),this.parent.addTarget(this)},buildTitle:function(){return this.title=this._extractContentFromNode(),this.title},_extractContentFromNode:function(){return a5.utils.buildContents(this.node,this.interaction,$("<h1></h1>"))}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSSortingTarget"),a5.models.interaction.OSSortingElementRepository={getElements:function(){return this._elements||(this._elements=[])},add:function(element){this.getElements().push(element),element.bind("changed",_.bind(this.onElementChanged,this,element))},merge:function(element){var existing=this.findByElement(element);existing.length?_.first(existing).merge(element):this.add(element)},first:function(){return _(this.getElements()).first()},findByTarget:function(target){return this._filterElements(function(e){return e.isInTarget(target)})},findPrefilledByTarget:function(target){return this._filterElements(function(e){return e.isPrefilled()&&e.isInCorrectTarget(target)})},findRevealedByTarget:function(target){return this._filterElements(function(e){return"answers"===e.state&&e.isInCorrectTarget(target)})},findExpectedByTarget:function(target){return this._filterElements(function(e){return e.isInCorrectTarget(target)})},findCorrect:function(){return this._filterElements(function(e){return!e.isPrefilled()&&e.isCorrect()})},findWrong:function(){return this._filterElements(function(e){return!e.isPrefilled()&&e.isWrong()})},findMissing:function(){return this._filterElements(function(e){return!e.isPrefilled()&&e.isMissing()})},findDistractor:function(){return this._filterElements(function(e){return!e.isPrefilled()&&e.isDistractor()})},findByElement:function(element){return this._filterElements(function(e){return e.isEqualTo(element)})},findAll:function(){return this._filterElements(function(e){return!e.isPrefilled()&&!e.isDistractor()})},getTotalCorrect:function(){return _(this.getElements()).reduce(function(memo,element){return memo+element.countCorrect()},0)},getTotalWrong:function(){return _(this.getElements()).reduce(function(memo,element){return memo+element.countWrong()},0)},getTotalMissing:function(){return _(this.getElements()).reduce(function(memo,element){return memo+element.countMissing()},0)},getTotalDistractor:function(){return this.findDistractor().length},getTotal:function(){return _(this.getElements()).reduce(function(memo,element){return memo+element.countTotal()},0)},onElementChanged:function(element){a5.mainBuilder.updateScoresAsync(),this.trigger("element:changed",element)},_filterElements:function(criteria){return _(this.getElements()).filter(criteria,this)}},Obj.extend("a5.models.interaction.OSSortingElementRepository"),a5.views.interaction.OSSortingView={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="dds_view"></div>')),this.align=this.interaction.options.getPoolAlignment(),this.model.bind("state_update",this.onStateUpdated,this),this.model.bind("next",this.showNext,this)},render:function(){this._super(),this.node.empty();var $pool=this.pool.render(),$targets=this.targets.render();return this.node.append($pool),this.node.append($targets),"bottom"===this.align&&this.node.append($pool),this.node},onStateUpdated:function(){this.vent.trigger("state:changed",this.model.state)}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingView"),a5.views.interaction.OSSortingElementView={
currentTarget:null,init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="drag_item os-sorting-element"></div>')),this.model.bind("state_update",this.onStateUpdated,this),this.model.bind("input_update:setAnswer",this.onSetAnswerInput,this),_.bindAll(this,"beforeStart","onStart","onStop","onDrag")},merge:function(elementView){this.model.merge(elementView.model)},copy:function(){return(!this.model.isMulti||!!this.currentTarget)&&this||new a5.views.interaction.OSSortingElementView({interaction:this.interaction,model:this.model})},setTarget:function(target){this.currentTarget=target},unsetTarget:function(){this.currentTarget=null},getElementIdentifier:function(){return this.model.identifier},render:function(){this._super(),a5.service.media.pause(this.node);var $text=this.model.buildText();return this.node.html($text),this.node.find(".has_audio_attached").toggleClass("no-label",!$text.text()),this.node.find("div:not(.image-as-trigger) > img").parent().addClass("image-div"),this.node.find("div > .image-as-trigger").parent().addClass("image-div"),this.model.isPrefilled()?this.node.addClass("prefilled"):"input"===this.model.state?this.node.attr("tabindex",0):this.node.removeAttr("tabindex"),this.model.parent.isDrag()&&this._createDraggable(),this.model.parent.isTapTarget()&&!this.model.isPrefilled()&&this._bindTapTargetEvents(),this.model.parent.isTapItem()&&!this.model.isPrefilled()&&this._bindTapItemEvents(),this._updateState(),this._setData(),this.deactivateDropOver(),this.model.bind("selected",_.bind(this.onSelected,this)),this.model.bind("deselected",_.bind(this.onDeselected,this)),this.node},onSelected:function(e){this.model.parent.selectedView===this&&this.node.addClass("selected")},onDeselected:function(e){this.node.removeClass("selected")},hasElement:function(element){return this.model===element},activateDropOver:function(){this._hasToShowDropIndicator()&&(this.node.addClass("is-active-target-source dragging_over"),this.interaction.$(".is-content-zone").addClass("drop_indicator"))},deactivateDropOver:function(){this._hasToShowDropIndicator()&&(this.node.removeClass("is-active-target-source dragging_over"),this.interaction.$(".is-content-zone").removeClass("drop_indicator"))},updateFeedbackState:function(){this.lastState!==this.model.state&&(this.checkLocked(),this.lastState=this.model.state),this.node.removeClass("checked-empty checked-incorrect checked-correct"),this.node.removeClass("solution-empty solution-incorrect solution-correct");var type;if("feedback"===this.model.state)type="checked";else{if("answers"!==this.model.state)return;type="solution"}this.model.isCorrect(this.currentTarget)?this.node.addClass([type,"correct"].join("-")):this.model.isMissing(this.currentTarget)?this.node.addClass([type,"empty"].join("-")):this.node.addClass([type,"incorrect"].join("-"))},onStateUpdated:function(){this.render()},onSetAnswerInput:function(){this.node.find(".check").remove(),this.updateFeedbackState(this.node),this._setAnswer(this._hasToShowChecksForFeedback()&&this.model.isInSomeTarget())},_updateState:function(){this.node.find(".check").remove(),this.updateFeedbackState(this.node),"answers"===this.model.state?this._showAnswer():"feedback"===this.model.state?this._setAnswer(this._hasToShowChecksForFeedback()):this._tryAgain()},_setAnswerInput:function(){this._hasToShowChecksForFeedback()&&this.model.isFilled();this._setAnswer()},_tryAgain:function(){this.model.parent.isDrag()&&this._enableDraggable()},_hasToShowChecksForFeedback:function(){return!this.model.isPrefilled()&&(this.currentTarget||this.model.isMissing())},_hasToShowChecksForAnswers:function(){return!this.model.isPrefilled()&&!this.model.isDistractor()&&!!this.currentTarget},_setAnswer:function(check){check&&(this.addCheck({correct:this.model.isCorrect(this.currentTarget),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect(this.currentTarget)}))},_showAnswer:function(){this._hasToShowChecksForAnswers()&&(this.addCheck({correct:this.model.isCorrect(this.currentTarget),empty:this.model.isMissing(this.currentTarget),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect(this.currentTarget)}))},_setData:function(){this.node.data("mvc-view",this)},_createDraggable:function(){this.model.isPrefilled()||this.node.draggable($.extend({revert:"invalid",disabled:!0,delay:150,revertDuration:350,start:this.onStart,stop:this.onStop,drag:this.onDrag,helper:this._createHelper,appendTo:"body",containment:"document",cancel:".checked-correct-locked",beforeStart:this.beforeStart,scope:"screen-"+this.interaction.index},a5.utils.getDraggableOptions(this.interaction)))},_bindTapTargetEvents:function(){this._bindMoveToPoolEvents(),this.node.off("click touchend keydown"),this.node.on("click touchend",_.bind(this.onClickTapTarget,this)),this.node.on("keydown",_.bind(this.onKeydownTapTarget,this))},_bindTapItemEvents:function(){this.node.off("click keydown"),this.node.on("click",_.bind(this.onClickTapItem,this)),this.node.on("keydown",_.bind(this.onKeydownTapItem,this))},_bindMoveToPoolEvents:function(){this.hammer&&this.hammer.destroy(),this.hammer=new Hammer.Manager(this.node[0],{});var doubleTap=new Hammer.Tap({event:"doubletap",taps:2});this.hammer.add(doubleTap),this.hammer.on("doubletap",_.bind(this.onDoubleTap,this)),this.node.on("keydown",_.bind(this.onKeydownMoveToPool,this))},onDoubleTap:function(e){this.moveToPool()},onKeydownMoveToPool:function(e){var key=e.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.moveToPool()},moveToPool:function(){this.currentTarget?this.model.unsetTarget(this.currentTarget,!1):this.model.unsetTarget(null,!1),this.model.parent.deselect()},isInPool:function(){return!!this.node.parents(".wordpool").length},isAppendedTo:function(node){return this.model.isMulti?node.find(".os-sorting-element[data-model-id="+this.node.attr("data-model-id")+"]").length:this.node.parent().is(node)},onClickTapItem:function(e){this.activateTapItem()},onKeydownTapItem:function(e){var key=e.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.activateTapItem()},activateTapItem:function(){if("input"===this.model.state)if(this.isInPool()){var except=this.model.currentTarget;this.model.setTarget(this.model.parent.getSmallestTarget(except))}else this.model.unsetTarget(this.currentTarget,!1)},onClickTapTarget:function(e){this.activateTapTarget()},onKeydownTapTarget:function(e){var key=e.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.activateTapTarget()},activateTapTarget:function(){var curSelected=this.model.parent.getSelected();"input"===this.model.state&&curSelected!=this.model&&this.setSelected()},setSelected:function(){$(document).off("click touchend",this._onBodyClick),$(document).off("keydown",this._onBodyKeydown),this.vent.unbind("pool:element:emptyactivate",this._onPoolEmptyActivate),this.model.parent.setSelected(this.model,this),this.vent.bind("pool:element:emptyactivate",this._onPoolEmptyActivate,this),$(document).on("click touchend",this,this._onBodyClick),$(document).on("keydown",this,this._onBodyKeydown)},_onPoolEmptyActivate:function(e){this.model.parent.selected&&e.pool.recieveElement(this.model.parent.selected)},_onBodyClick:function(e){$(e.target).is(".drop_zone")||$(e.target).is(".drop_item_zone")||0!==$(e.target).parents(".drag_item").length||e.data.model.parent.deselect()},_onBodyKeydown:function(e){var key=e.which;key!==a5.utils.keyCodes.ESCAPE&&(e.data.node[0]===e.target||key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER)||e.data.model.parent.deselect()},_createHelper:function(){var $this=$(this),$clone=$this.addClass("ui-draggable-dragging").clone();return $this.removeClass("ui-draggable-dragging"),a5.dp.config.ossortingCloneCss&&($clone.copyCSS(this),$clone.find("> div").copyCSS($(this).find("> div")),$clone.find("img").copyCSS($(this).find("img")),$clone.find(".drag_audio_player").copyCSS($(this).find(".drag_audio_player"))),$clone},beforeStart:function(e,ui){this.node.find(".check").remove()},onStart:function(e,ui){this.model.isMulti&&!this.currentTarget||this.node.hide(),this.node.draggable("option","scroll",!1),this.lastY=null},onStop:function(e,ui){this.model.isMulti&&!this.currentTarget||this.node.show()},onDrag:function(e,ui){this._adjustVerticalScrollSensitivity(this.lastY,e.pageY,e.clientY),this.lastY=e.pageY},_adjustVerticalScrollSensitivity:function(lastY,currentY,clientY){var currentScrollSensitivity=this.node.draggable("option","scrollSensitivity"),newScrollSensitivity=20;this._isMovingDown(lastY,currentY)&&this._touchBottom(clientY)&&(newScrollSensitivity+=a5.dp.config.exclusionBottom),currentScrollSensitivity!==newScrollSensitivity&&this.node.draggable("option","scrollSensitivity",newScrollSensitivity),this._touchTop(clientY)||this._touchBottom(clientY)||this.node.draggable("option","scroll",!0)},_touchBottom:function(clientY){return clientY>$(window).height()-20-a5.dp.config.exclusionBottom},_touchTop:function(clientY){return clientY<20+a5.dp.config.exclusionTop},_isMovingDown:function(lastY,currentY){return lastY&&currentY>lastY},_enableDraggable:function(){this.model.isPrefilled()||this.node.draggable("enable")},_disableDraggable:function(){this.model.isPrefilled()||this.node.draggable("disable")},_hasToShowDropIndicator:function(){return this.interaction.options.dropIndicatorIsTrue()}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingElementView"),a5.views.interaction.OSSortingElementPoolView={init:function(args){_.extend(this,args),this._super(null,null,$('<div class="drop_item_zone"></div>')),_(this.elements).each(function(element){element.bind("changed",this.onElementChanged,this)},this),_.bindAll(this,"onDrop","onDropOut","onDropOver","onPoolClick","onPoolKeydown"),this.node.on("click",this.onPoolClick),this.node.on("keydown",this.onPoolKeydown)},onPoolClick:function(e){this.isEmpty()&&this.activate()},onPoolKeydown:function(e){var key=e.which;!this.isEmpty()||key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.activate()},activate:function(){this.vent.trigger("pool:element:emptyactivate",{element:this.elements[0],elementView:this._getElementView(this.elements[0]),pool:this})},render:function(){return this._super(),!this.stackable&&this.isPrefilled()&&this.node.hide(),this._renderElementsIfBelongsToPool(),this._createDroppable(),this.node.toggleClass("stacked",this.stackable),this.node.toggleClass("has_drag_item",this._hasElements()),this.isEmpty()?this.node.attr("tabindex",0):this.node.removeAttr("tabindex"),this.node},isEmpty:function(){return!this._hasElements()},isPrefilled:function(){return this.elements.length>0&&_.all(this.elements,function(element){return element.isPrefilled()})},add:function(element){this.interaction.options.randomiseanswersIsTrue()?this._addRandom(element):this.push(element)},merge:function(element){this._findByElement(element).merge(element)},remove:function(element){this.elements=_(this.elements).without(element)},push:function(element){this.elements.push(element)},pop:function(){return this.elements.pop()},hasElement:function(element){return _.contains(this.elements,element)},hasElementByText:function(element){return _.some(this.elements,function(e){return e.isEqualTo(element)})},onElementChanged:function(){this.render()},onDrop:function(e,ui){var elementView=ui.draggable.data("mvc-view"),element=elementView.model;ui.draggable.detach(),ui.draggable.css({left:"",top:"",width:"",height:"",bottom:"",right:""}),elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),this.vent.trigger("pool:element:dropped",{srcElement:element,dstElementPool:this})},onDropOut:function(){this._draggingElement&&_(this._draggingElement.deactivateDropOver).isFunction()&&this._draggingElement.deactivateDropOver()},onDropOver:function(event,ui){this._draggingElement=ui.draggable.data("mvc-view"),this._draggingElement&&_(this._draggingElement.activateDropOver).isFunction()&&this._draggingElement.activateDropOver()},recieveElement:function(element){var view=this._getElementView(element);this.node.append(view.render()),view.currentTarget&&element.unsetTarget(view.currentTarget),this.vent.trigger("pool:element:dropped",{srcElement:element,dstElementPool:this})},_renderElementsIfBelongsToPool:function(){_(this.elements).each(function(element){element.belongsToPool()&&this._renderElement(element)},this)},_renderElement:function(element){var elementView=this._getElementView(element),alreadyRendered=elementView.isAppendedTo(this.node);elementView&&!alreadyRendered&&(elementView.unsetTarget(),this.node.append(elementView.render()))},_getElementView:function(element){return this.elementViewRepository.getElementView(element)},_createDroppable:function(){var config={drop:this.onDrop,out:this.onDropOut,over:this.onDropOver,accept:_.bind(function(el){var elementView=el.data("mvc-view");return this.stackable||this._acceptDrop(elementView&&elementView.model)},this),greedy:!0,tolerance:"pointer",scope:"screen-"+this.interaction.index};this._hasToShowDropIndicator()?_(config).extend({hoverClass:"drop-indicator hovered"}):_(config).extend({hoverClass:"hwb"}),this.node.droppable(config)},_acceptDrop:function(element){return _.all(this.elements,function(element){return!element.belongsToPool()})||_.contains(this.elements,element)},_hasToShowDropIndicator:function(){return this.interaction.options.dropIndicatorIsTrue()},_addRandom:function(element){var pos=Math.floor(Math.random()*(this.elements.length+1));this.elements.splice(pos,0,element)},_hasElements:function(){return _(this.elements).some(function(element){return element.belongsToPool()})},_findByElement:function(element){return _(this.elements).find(function(e){return e.isEqualTo(element)})}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingElementPoolView"),a5.views.interaction.OSSortingElementTargetView={init:function(args){_.extend(this,args),this._super(null,null,$("<li></li>"))},hasElement:function(element){return this.elementView.hasElement(element)},render:function(){return this._super(),this._renderElementView(),this.node},_renderElementView:function(){this.elementView&&this.node.html(this.elementView.render())}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingElementTargetView"),a5.views.interaction.OSSortingElementTargetZoneView={init:function(params){_.extend(this,params),this._super({},this.parent,$('<div class="drop_item_zone"></div>')),_.bindAll(this,"onDrop","onDropOut","onDropOver"),this.mainModel=this.parent.model.parent},render:function(){return this._super(),this.node.empty(),this._renderElement(),this.mainModel.isDrag()&&this._bindDragEvents(),this.mainModel.isTapTarget()&&this._bindTapTargetEvents(),this.node.toggleClass("has_drag_item",!this.isEmpty()),this.isEmpty()&&this.node.attr("tabindex",0),this.node},refresh:function(){this._renderElement(),this.node.toggleClass("has_drag_item",!this.isEmpty()),this.isEmpty()?this.node.attr("tabindex",0):this.node.removeAttr("tabindex")},renderEnumeration:function(){var ret=this.enumeration&&$('<div class="enumanswer"></div>');return ret&&(ret.html('<span class="enum-placeholder"></span>'),this.enumeration.then(function(enumSymbol){ret.find(".enum-placeholder").replaceWith(enumSymbol)})),ret},getElement:function(){return this.element},setElement:function(element){this.element=element},unsetElement:function(){this.element=null},hasElement:function(element){return this.element===element},isEmpty:function(){return!this.element},onDrop:function(e,ui){var elementView=ui.draggable.data("mvc-view"),element=elementView.model;ui.draggable.detach(),ui.draggable.css({left:"",top:"",width:"",height:"",bottom:"",right:""}),elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),this.vent.trigger("target:zone:dropped",{target:this.parent,zone:this,element:element,from:elementView.currentTarget})},onDropOut:function(){this._draggingElement&&_(this._draggingElement.deactivateDropOver).isFunction()&&this._draggingElement.deactivateDropOver()},onDropOver:function(event,ui){this._draggingElement=ui.draggable.data("mvc-view"),this._draggingElement&&_(this._draggingElement.activateDropOver).isFunction()&&this._draggingElement.activateDropOver()},_renderElement:function(){var elementView=this._getElementView();if(elementView){elementView=elementView.copy();elementView.isAppendedTo(this.node)||(elementView.setTarget(this._getTargetIdentifier()),this.node.html(elementView.node),elementView.render())}},_getElementView:function(){return this.element&&this.elementViewRepository.getElementView(this.element)},_bindTapTargetEvents:function(){this.node.off("click keydown"),this.node.on("click",_.bind(this.onClick,this)),this.node.on("keydown",_.bind(this.onKeydown,this))},onClick:function(e){if($(e.target).is(this.node)){this.mainModel.getSelected()&&this._doTargetMove()}},onKeydown:function(e){var key=e.which;e.target!==this.node[0]||key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.mainModel.getSelected()&&this._doTargetMove()},_doTargetMove:function(){var element=this.mainModel.getSelected(),elementView=this.mainModel.getSelectedView();elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),this.mainModel.deselect(),this.vent.trigger("target:zone:dropped",{target:this.parent,zone:this,element:element,from:elementView.currentTarget})},_bindDragEvents:function(){var config={drop:this.onDrop,out:this.onDropOut,over:this.onDropOver,accept:_.bind(function(el){return el.is(".drag_item")&&this._acceptDrop(el)},this),tolerance:"pointer",scope:"screen-"+this.interaction.index};this._hasToShowDropIndicator()?_(config).extend({hoverClass:"drop-indicator hovered"}):_(config).extend({hoverClass:"hwb"}),this.$().droppable(config)},_acceptDrop:function(el){var elementView=el.data("mvc-view"),element=elementView.model;return this.isEmpty()&&(elementView.currentTarget===this.parent.getTargetIdentifier()||!this.parent.hasElement(element))},_getTargetIdentifier:function(){return this.parent.getTargetIdentifier()},_hasToShowDropIndicator:function(){return this.interaction.options.dropIndicatorIsTrue()}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingElementTargetZoneView"),a5.views.interaction.OSSortingPoolView={init:function(args){_.extend(this,args),this._super(null,null,$('<div class="dds_wordpool_view"></div>')),this._renderPoolOnce=_.once(this._renderPool),this.children=[],this.align=this.interaction.options.getPoolAlignment(),this.vent.bind("pool:element:dropped",this.onPoolElementViewDropped,this),this.elementRepository.bind("element:changed",this.onElementChanged,this),this.vent.bind("state:changed",this.onStateChanged,this),this.stack_counter=0,_.bindAll(this,"onDrop","onDropOut","onDropOver")},add:function(element){var elementPoolView;if(!this._hasStacks()||this.children.length<this._getNumberOfStacks())elementPoolView=this._createElementPoolView(element),this.interaction.options.randomiseanswersIsTrue()?this._addRandom(elementPoolView):this.children.push(elementPoolView);else{var stack=this.stack_counter++%this._getNumberOfStacks();elementPoolView=this.children[stack],elementPoolView.add(element)}},merge:function(element){var existing=this._getElementPoolViewByText(element);existing?existing.merge(element):this.add(element)},render:function(){return this.interaction.trigger("before:pool:rendered"),this._renderPoolOnce(),this.renderChildren(".elements"),this.interaction.trigger("pool:rendered"),this.node},onStateChanged:function(state){this.render()},onElementChanged:function(element){var ele=this._getElementPoolView(element);this.render(),_.defer(_.bind(function(){this.interaction.trigger("pool:changed",ele?ele.node:ele)},this))},onPoolElementViewDropped:function(options){var srcElement=options.srcElement,dstElementPool=options.dstElementPool;this._hasStacks()?this._stackElement(srcElement,dstElementPool):this._swapElementPositions(srcElement,dstElementPool),this.render()},onDrop:function(e,ui){var elementView=ui.draggable.data("mvc-view"),element=elementView.model;ui.draggable.detach(),ui.draggable.css({left:"",top:""}),elementView.currentTarget&&element.unsetTarget(elementView.currentTarget)},onDropOut:function(){},onDropOver:function(event,ui){},_renderPool:function(){var $pool=$('<div class="wordpool"><div class="elements pool"></div></div>');if($pool.addClass(this.align),"free"===this.align){var $handle=$('<h2>:: drag to move wordpool ::<span class="reset_position" style="display:none">dock</span></h2>');$handle.on("click",".reset_position",function(){$handle.find(".reset_position").hide(),$pool.css({top:"",left:""})}),$pool.prepend($handle),$pool.draggable({handle:"h2",cancel:".reset_position",containment:this.interaction.contentWrap,start:function(){$handle.find(".reset_position").show()}})}this._makeDroppable($pool),this.node.html($pool)},_addRandom:function(child){var pos=Math.floor(Math.random()*(this.children.length+1));this.children.splice(pos,0,child)},_swapElementPositions:function(srcElement,dstElementPool){var srcIndex=this._getIndexOfElement(srcElement),dstIndex=this._getIndexOfElementPool(dstElementPool);a5.utils.array.swap(this.children,srcIndex,dstIndex)},_stackElement:function(srcElement,dstElementPool){var srcIndex=this._getIndexOfElement(srcElement);this.children[srcIndex].remove(srcElement),dstElementPool.push(srcElement)},_getIndexOfElement:function(element){return _(this.children).findIndex(function(elementPoolView){return elementPoolView.hasElement(element)})},_getIndexOfElementPool:function(elementPool){return this.children.indexOf(elementPool)},_createElementPoolView:function(element){return new a5.views.interaction.OSSortingElementPoolView({vent:this.vent,interaction:this.interaction,elements:[element],elementViewRepository:this.elementViewRepository,stackable:this._hasStacks()})},_makeDroppable:function($pool){var config={drop:this.onDrop,out:this.onDropOut,over:this.onDropOver,accept:_.bind(function(el){var elementView=el.data("mvc-view");return this._acceptDrop(elementView)},this),scope:"screen-"+this.interaction.index};$pool.droppable(config)},_acceptDrop:function(elementView){return elementView&&!!elementView.currentTarget},_hasStacks:function(){return this._getNumberOfStacks()>0},_getNumberOfStacks:function(){var stacks=parseInt(this.interaction.options.getPoolStacks(),10);return _.isNumber(stacks)&&!_.isNaN(stacks)&&stacks||0},_getElementPoolViewByText:function(element){return _.find(this.children,function(elementPoolView){return elementPoolView.hasElementByText(element)})},_getElementPoolView:function(element){return _.find(this.children,function(elementPoolView){return elementPoolView.hasElement(element)})}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingPoolView"),a5.views.interaction.OSSortingTargetsView={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="dds_target_view"></div>')),this.children=[]},add:function(child){this.children.push(child)},size:function(){return this.children.length},render:function(){return this._super(),this.node.empty(),this.renderChildren(),this.node}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingTargetsView"),a5.views.interaction.OSSortingTargetViewWithoutZones={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="drop_zone"><div class="elements"></div></div>')),this._renderTitleOnce=_.once(this._renderTitle),this._renderContainerImageOnce=_.once(this._renderContainerImage),this.mainModel=this.model.parent,this.children=[],this.elementRepository.bind("element:changed",this.onElementChanged,this),this.vent.bind("state:changed",this.onStateChanged,this),_.bindAll(this,"onDrop","onDropOut","onDropOver"),this._setupGapfillBehavior()},_setupGapfillBehavior:function(){this.mainModel.isTapTarget()&&(this._bindTapEvents(),this.node.attr("tabindex",0)),this.mainModel.isTapItem()&&this.node.addClass("ui-droppable")},getTargetIdentifier:function(){return this.model.identifier},render:function(){return this._renderTitleOnce(),this._renderContainerImageOnce(),this._syncElementsFromRepository(),this._addElementViews(),this.mainModel.isDrag()&&this._createDroppable(),this.node},onElementChanged:function(element){this.render()},onStateChanged:function(state){this.state=state,this.render()},onDrop:function(e,ui){var elementView=ui.draggable.data("mvc-view"),element=elementView.model;ui.draggable.detach(),ui.draggable.css({left:"",top:"",width:"",height:"",bottom:"",right:""}),elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),element.setTarget(this.getTargetIdentifier())},onDropOut:function(){this._draggingElement&&_(this._draggingElement.deactivateDropOver).isFunction()&&this._draggingElement.deactivateDropOver()},onDropOver:function(event,ui){this._draggingElement=ui.draggable.data("mvc-view"),this._draggingElement&&_(this._draggingElement.activateDropOver).isFunction()&&this._draggingElement.activateDropOver()},_renderTitle:function(){var $title=this.model.buildTitle();this.node.prepend($title)},_getElementView:function(element){return element&&this.elementViewRepository.getElementView(element)},_addElementView:function(element){var elementView=this._getElementView(element);if(elementView=elementView.copy()){elementView.isAppendedTo(this.$(".elements"))||(elementView.setTarget(this.getTargetIdentifier()),this.$(".elements").append(elementView.node),elementView.render())}},_addElementViews:function(){_.each(this.elements,function(element){this._addElementView(element)},this)},_removeElements:function(elements){this.elements=_(this.elements).difference(elements)},_addElements:function(elements){this.elements=this.elements.concat(elements)},_syncElementsFromRepository:function(){var elementsToRemove,elementsToAdd,elementsInTarget=this._findAllElements(),elementsInRepository=this._findAllElementsFromRepository();elementsToRemove=_(elementsInTarget).difference(elementsInRepository),elementsToAdd=_(elementsInRepository).difference(elementsInTarget),this._removeElements(elementsToRemove),this._addElements(elementsToAdd)},_findAllElements:function(){return this.elements},_findAllElementsFromRepository:function(){return"answers"===this.state?this._getExpectedElements():this._getPrefilledElements().concat(this._getCurrentElements().concat(this._getRevealedElements()))},_getCurrentElements:function(){return this.elementRepository.findByTarget(this.getTargetIdentifier())},_getRevealedElements:function(){return this.elementRepository.findRevealedByTarget(this.getTargetIdentifier())},_getExpectedElements:function(){return this.elementRepository.findExpectedByTarget(this.getTargetIdentifier())},_getPrefilledElements:function(){return this.elementRepository.findPrefilledByTarget(this.getTargetIdentifier())},_wrapElementView:function(elementView){return new a5.views.interaction.OSSortingElementTargetView({elementView:elementView})},_createDroppable:function(){var config={drop:this.onDrop,out:this.onDropOut,over:this.onDropOver,accept:_.bind(function(el){return el.is(".drag_item")&&!this._hasElementView(el.data("mvc-view"))},this),tolerance:"pointer",scope:"screen-"+this.interaction.index};this._hasToShowDropIndicator()?_(config).extend({hoverClass:"drop-indicator hovered"}):_(config).extend({hoverClass:"hwb"}),this.$().droppable(config)},_bindTapEvents:function(){this.node.addClass("ui-droppable"),this.node.off("click"),this.node.on("click",_.bind(this.onClick,this)),this.node.on("keydown",_.bind(this.onKeydown,this))},onClick:function(e){$(e.target).is(this.node)&&this.mainModel.getSelected()&&this._doItemMove()},onKeydown:function(e){var key=e.which;e.target!==this.node[0]||!this.mainModel.getSelected()||key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this._doItemMove()},_doItemMove:function(){var element=this.mainModel.getSelected(),elementView=this.mainModel.getSelectedView();elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),element.setTarget(this.getTargetIdentifier()),this.mainModel.deselect()},_doTargetMove:function(){var element=this.mainModel.getSelected(),elementView=this.mainModel.getSelectedView();elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),element.setTarget(this.getTargetIdentifier()),this.mainModel.deselect()},_renderContainerImage:function(){var image=$(this.containerImage);image.length&&(this.node.addClass("has_container_image"),this.node.css({backgroundImage:"url("+image.attr("src")+")",backgroundRepeat:"no-repeat",minWidth:image.width()+"px",width:image.width()+"px",minHeight:image.height()+"px"}))},_hasElementView:function(elementView){var element;return elementView&&(element=elementView.model)&&element.isInTarget(this.getTargetIdentifier())},_hasToShowDropIndicator:function(){return this.interaction.options.dropIndicatorIsTrue()}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingTargetViewWithoutZones"),a5.views.interaction.OSSortingTargetViewWithZones={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="drop_zone"><div class="elements"></div></div>')),this._renderTitleOnce=_.once(this._renderTitle),this._renderContainerImageOnce=_.once(this._renderContainerImage),this._renderTargetZonesOnce=_.once(this._renderTargetZones),this.children=[],this._addTargetZones(),this.elementRepository.bind("element:changed",this.onElementChanged,this),this.vent.bind("target:zone:dropped",this.onTargetZoneDropped,this),this.vent.bind("state:changed",this.onStateChanged,this)},render:function(){return this._renderTitleOnce(),this._renderContainerImageOnce(),this._renderTargetZonesOnce(),this._syncElementsFromRepository(),this._refreshTargetZones(),this.node},getTargetIdentifier:function(){return this.model.identifier},hasElement:function(element){return _(this.children).some(function(zone){return zone.hasElement(element)})},onElementChanged:function(){this.render()},onStateChanged:function(state){this.state=state,this.render()},onTargetZoneDropped:function(params){var element=params.element,zone=params.zone,target=params.target;params.from===this&&this._unsetElementFromAllZones(element),target===this&&(zone.setElement(element),element.setTarget(this.getTargetIdentifier()))},_renderTitle:function(){var $title=this.model.buildTitle();this.node.prepend($title)},_addTargetZones:function(){_(this.maxZones).times(function(){var zoneView=new a5.views.interaction.OSSortingElementTargetZoneView({parent:this,interaction:this.interaction,vent:this.vent,elementRepository:this.elementRepository,elementViewRepository:this.elementViewRepository,enumeration:this._nextEnumeration()});this.children.push(zoneView)},this)},_renderTargetZones:function(){_(this.children).each(function(child){this.$(".elements").append(child.renderEnumeration()),this.$(".elements").append(child.render())},this)},_refreshTargetZones:function(){_.invoke(this.children,"refresh")},_wrapElementView:function(elementView){return new a5.views.interaction.OSSortingElementTargetView({elementView:elementView})},_renderContainerImage:function(){var image=$(this.containerImage);image.length&&(this.node.addClass("has_container_image"),this.node.css({backgroundImage:"url("+image.attr("src")+")",backgroundRepeat:"no-repeat",minWidth:image.width()+"px",width:image.width()+"px",minHeight:image.height()+"px"}))},_unsetElementFromAllZones:function(element){_(this.children).chain().filter(function(zone){return zone.hasElement(element)}).invoke("unsetElement")},_unsetElementsFromAllZones:function(elements){_(elements).each(this._unsetElementFromAllZones,this)},_addElementsToEmptyZones:function(elements){_(this.children).chain().filter(function(zone){return zone.isEmpty()}).first(elements.length).each(function(zone,index){zone.setElement(elements[index])})},_nextEnumeration:function(){
return this.interaction.enumAnswers.next()},_syncElementsFromRepository:function(){var elementsToRemove,elementsToAdd,elementsInZones=this._findAllElementsFromZones(),elementsInRepository=this._findAllElementsFromRepository();elementsToRemove=_(elementsInZones).difference(elementsInRepository),elementsToAdd=_(elementsInRepository).difference(elementsInZones),this._unsetElementsFromAllZones(elementsToRemove),this._addElementsToEmptyZones(elementsToAdd)},_findAllElementsFromZones:function(){return _(this.children).chain().reject(function(zone){return zone.isEmpty()}).invoke("getElement").value()},_findAllElementsFromRepository:function(){return"answers"===this.state?this._getExpectedElements():this._getPrefilledElements().concat(this._getCurrentElements().concat(this._getRevealedElements()))},_getCurrentElements:function(){return this.elementRepository.findByTarget(this.getTargetIdentifier())},_getExpectedElements:function(){return this.elementRepository.findExpectedByTarget(this.getTargetIdentifier())},_getRevealedElements:function(){return this.elementRepository.findRevealedByTarget(this.getTargetIdentifier())},_getPrefilledElements:function(){return this.elementRepository.findPrefilledByTarget(this.getTargetIdentifier())}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingTargetViewWithZones"),a5.views.interaction.OSSortingElementViewRepository={init:function(args){_.extend(this,args)},add:function(elementView){this._getElements()[elementView.getElementIdentifier()]=elementView},merge:function(elementView){var existing=this.findByElement(elementView.model);existing.length?_.first(existing).merge(elementView):this.add(elementView)},getElementView:function(element){return this._getElements()[element.identifier]},findByTarget:function(target){return this._findElementViewsBy("findByTarget",target)},findPrefilledByTarget:function(target){return this._findElementViewsBy("findPrefilledByTarget",target)},findExpectedByTarget:function(target){return this._findElementViewsBy("findExpectedByTarget",target)},findByElement:function(element){return this._findElementViewsBy("findByElement",element)},_getElements:function(){return this.elements||(this.elements={})},_findElementViewsBy:function(criteria){var args=_(arguments).rest(),method=this.elementRepository[criteria],ret=_(method.apply(this.elementRepository,args)).map(function(element){return this.getElementView(element)},this);return _.compact(ret)}},Obj.extend("a5.views.interaction.OSSortingElementViewRepository"),a5.views.interaction.OSSortingTargetViewFactory={init:function(params){_.extend(this,_(params).pick("interaction","responses","vent"))},createTargetView:function(params){return this._hasTargetZones()?this._createTargetViewWithZones(params):this._createTargetViewWithoutZones(params)},_createTargetViewWithZones:function(params){var model=params.model;return new a5.views.interaction.OSSortingTargetViewWithZones(_(params).extend({interaction:this.interaction,vent:this.vent,maxZones:this._calculateMaxZones(model)}))},_createTargetViewWithoutZones:function(params){return new a5.views.interaction.OSSortingTargetViewWithoutZones(_(params).extend({interaction:this.interaction,vent:this.vent}))},_calculateMaxZones:function(model){var responses=this._extractResponsesFromModel(model);return responses?responses.length:0},_extractResponsesFromModel:function(model){return this.responses.asInverseMap()[model.identifier]},_hasTargetZones:function(){return this.interaction.options.targetzonesIsTrue()}},Obj.extend("a5.views.interaction.OSSortingTargetViewFactory"),a5.model_builder.OSNumberStacksBuilder={isResponsible:function(node,interaction){return"Order:Sort:Number stacks"===interaction.identifier&&node.is("matchInteraction, simpleMatchSet, simpleAssociableChoice")&&interaction.resourcesPanel},buildMatchInteraction:function(interaction,parentNode,node){this.vent=this._createEventBus(),this.model=this._createModel(interaction),this.buildContents(node,interaction,parentNode),this.view=this._createView(interaction),parentNode.append(this.view.node),this.view.render(),interaction.blockItems.add(this.model),interaction.resourcesPanel&&interaction.resourcesPanel.addActivity(this.view)},buildSimpleMatchSet:function(interaction,parentNode,node){this.buildContents(node,interaction,parentNode)},buildSimpleAssociableChoice:function(interaction,parentNode,node){if(this._isNodeForTargetBuilding(node)){var target=this._createTarget(interaction,parentNode,node);this.model.addTarget(target)}},_createEventBus:function(){return new Obj},_createModel:function(interaction){return new a5.models.interaction.OSNumberStacksPanBalance({interaction:interaction})},_createView:function(interaction){return new a5.views.interaction.OSNumberStacksPanBalance({model:this.model,vent:this.vent,interaction:interaction})},_createTarget:function(interaction,parentNode,node){return new a5.models.interaction.OSNumberStacksTarget({identifier:node.attr("identifier"),interaction:interaction,correct:this._extractValue(node)})},_isNodeForTargetBuilding:function(node){return a5.utils.startsWith(node.attr("identifier"),"T")},_extractValue:function(node){var value,jsonString=node.attr("data-author");try{value=JSON.parse(jsonString).value}catch(e){logger.warn("Invalid JSON value for node",node[0])}return value||0}},a5.model_builder.Base.extend("a5.model_builder.OSNumberStacksBuilder"),a5.model_builder.builders.push(new a5.model_builder.OSNumberStacksBuilder),a5.models.interaction.OSNumberStacks={init:function(parameters){this._super(parameters,{interaction:null}),this.targets=[]},addTarget:function(target){this.targets.push(target)},getTargets:function(){return this.targets}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacks"),a5.models.interaction.OSNumberStacksPanBalance={threshold:3,init:function(parameters){this._super(parameters,{interaction:null}),this.targets=[],this.panState="balanced"},addTarget:function(target){this.targets.push(target),target.bind("change",this._onChange,this)},getTargets:function(){return this.targets},getPanLeft:function(){return this.targets[0]},getPanRight:function(){return this.targets[1]},getPanState:function(){return this.panState},updatePanState:function(){var panLeft=this.getPanLeft(),panRight=this.getPanRight(),leftValue=panLeft.getValue(),rightValue=panRight.getValue();leftValue===rightValue?this.panState="balanced":leftValue<rightValue&&rightValue-leftValue<=this.threshold?this.panState="left-high":leftValue<rightValue&&rightValue-leftValue>this.threshold?this.panState="left-highest":rightValue<leftValue&&leftValue-rightValue<=this.threshold?this.panState="left-low":rightValue<leftValue&&leftValue-rightValue>this.threshold&&(this.panState="left-lowest")},store:function(){var targets={};return _.each(this.targets,function(target){targets[target.identifier]=target.store()}),{targets:targets}},restore:function(data){_.each(this.targets,function(target){target.restore(data.targets[target.identifier])}),this.trigger("restore")},_onChange:function(){this.updatePanState(),this.trigger("change")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacksPanBalance"),a5.models.interaction.OSNumberStacksTarget={init:function(parameters){this._super(parameters,{identifier:null,interaction:null,correct:0,value:0}),this.items=[]},add:function(item){this.items.push(item);var v=item.getValue();v=_.isNumber(v)?v:0,this.value+=v,this.trigger("change")},remove:function(item){if(_.contains(this.items,item)){this.items=_.without(this.items,item);var v=item.getValue();v=_.isNumber(v)?v:0,this.value-=v,this.trigger("change")}},empty:function(){this.items=[]},getValue:function(){return this.value},updateValue:function(){this.value=_.reduce(this.items,function(memo,item){var v=item.getValue();return v=_.isNumber(v)?v:0,memo+v},0)},getItems:function(){return this.items},isCorrect:function(){return this.value===this.correct},restore:function(object){this.empty();var banks=this.interaction.resourcesPanel.banks;_.each(object.items,function(item){var bankItem=banks.findItemById(item.bankItemId);bankItem&&"keypad"!==item.type&&(item.inline=bankItem.inline);var stageItem;stageItem="numeral-cards"===item.type?new a5.model.CardStageItem(item):new a5.model.ResourceStageItem(item),this.add(stageItem)},this)},store:function(){return{items:_.invoke(this.items,"serialize")}}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacksTarget"),a5.views.interaction.OSNumberStacks={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="os-number-stacks"></div>')),this.children=this._initTargets()},render:function(){return this.node.empty(),this.renderChildren(),this.node},_initTargets:function(){var targets=this.model.getTargets();return _.map(targets,function(target){return new a5.views.interaction.OSNumberStacksTarget({model:target,vent:this.vent,interaction:this.interaction})},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacks"),a5.views.interaction.OSNumberStacksPanBalance={template:"a5.views.interaction.OSNumberStacksPanBalance",init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="pan-balance-wrapper"></div>')),this.panLeft=new a5.views.interaction.OSNumberStacksPan({model:this.model.getPanLeft(),vent:this.vent,interaction:this.interaction,balance:this}),this.panRight=new a5.views.interaction.OSNumberStacksPan({model:this.model.getPanRight(),vent:this.vent,interaction:this.interaction,balance:this}),this.model.bind("change",this._onChange,this),this.model.bind("restore",this._onRestore,this)},removeItemById:function(id){this.panLeft.removeItemById(id),this.panRight.removeItemById(id)},contains:function($el){return this.panLeft.contains($el)||this.panRight.contains($el)},render:function(){var html=a5.service.templates.render(this.template);return this.node.html(html),this.$(".pan-left").append(this.panLeft.node),this.$(".pan-right").append(this.panRight.node),this.panLeft.render(),this.panRight.render(),this.$panBalance=this.node.find(".pan-balance"),this.node},_onChange:function(){this.$panBalance.removeClass("balanced left-low left-lowest left-high left-highest"),this.$panBalance.addClass(this.model.getPanState())},_onRestore:function(){this.panLeft.refresh(),this.panRight.refresh()}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksPanBalance"),a5.views.interaction.OSNumberStacksTarget={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="os-number-stacks-target"></div>'))},render:function(){return this.node.empty(),this.node}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksTarget"),a5.views.interaction.OSNumberStacksPan={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="os-number-stacks-pan"></div>')),_.bindAll(this,"_onDrop","_onItemDragStart","_onItemDrag","_onItemDragStop"),this.node.on("drop",this._onDrop),this.node.on("dragstart","> .resource-stage-item",this._onItemDragStart),this.node.on("drag","> .resource-stage-item",this._onItemDrag),this.node.on("dragstop","> .resource-stage-item",this._onItemDragStop),this.interaction.resourcesPanel.bind("delete-all",this._onDeleteAll,this),this.children=[]},render:function(){return this.node.empty(),this._makeDroppable(),this._createGrid(),this.node},region:function(){return this.node},refresh:function(){_.invoke(this.children,"remove"),this.children=[],_.each(this.model.getItems(),function(item){this.addItem(item)},this)},addItem:function(item){var resourceStageItem=new a5.view.ResourceStageItem({item:item,interaction:this.interaction});return this.region().append(resourceStageItem.$el),item.cssmatrix=resourceStageItem.$el.transformationMatrix(),resourceStageItem.render(),this.children.push(resourceStageItem),resourceStageItem},removeItem:function(itemView){itemView.remove();var index=this.children.indexOf(itemView);index>=0&&this.children.splice(index,1),this.model.remove(itemView.item)},removeItemById:function(id){var itemView=this._getItemById(id);itemView&&this.removeItem(itemView)},removeAll:function(){var items=this.children.slice(0);_.each(items,function(itemView){this.removeItem(itemView)},this)},contains:function($el){return $el.closest(this.region()).length>0},_onItemDragStart:function(e,ui){this.matrix=this.node.transformationMatrix(!0),this.scale=this.matrix.getScale(),this.draggedItem=this._getItemById(ui.helper.attr("data-item-id")),this.origin={sx:ui.offset.left,sy:ui.offset.top}},_onItemDrag:function(e,ui){this.sdx=ui.offset.left-this.origin.sx,this.sdy=ui.offset.top-this.origin.sy;var bounds=this.interaction.resourcesPanel.resourcesStageView.$el[0].getBoundingClientRect(),box=ui.helper[0].getBoundingClientRect();this.origin.sx+this.sdx<bounds.left?this.sdx=bounds.left-this.origin.sx:this.origin.sx+this.sdx+box.width>bounds.right&&(this.sdx=bounds.right-this.origin.sx-box.width),this.origin.sy+this.sdy<bounds.top?this.sdy=bounds.top-this.origin.sy:this.origin.sy+this.sdy+box.height>bounds.bottom&&(this.sdy=bounds.bottom-this.origin.sy-box.height),ui.position.left=(this.origin.sx+this.sdx-this.node.offset().left)/this.scale,ui.position.top=(this.origin.sy+this.sdy-this.node.offset().top)/this.scale},_onItemDragStop:function(e,ui){},_onDrop:function(e,ui){if(e.stopPropagation(),this.contains(ui.helper)&&!this._isInEdges(ui.helper)){var snap=this.interaction.resourcesPanel.resourcesStage.generalGrid.snap({x:this.dx,y:this.dy});return void this.draggedItem.moveEnd(snap)}this.balance.contains(ui.helper)&&this.balance.removeItemById(ui.helper.attr("data-item-id"));var $item=ui.helper;$item.children(":first").is(".resource-item")&&($item=$item.children(":first"));var addBy=1;$item.is(".resource-item")&&(addBy=this.interaction.resourcesPanel.resourcesPanelView.addBy),_.times(addBy,function(n){if($item.hasClass("resource-item-composed"))$item.children("[data-item-id]").each(function(index,el){var $el=$(el);this._addToGrid({id:$el.attr("data-item-id"),bankItemId:$el.attr("data-bank-item-id")})}.bind(this));else if(0===$item.closest(".resource-item-composed").length){var selectedItems=$item.siblings(".ui-selected").addBack();selectedItems.each(function(index,el){var $el=$(el);this._addToGrid({id:$el.attr("data-item-id"),bankItemId:$el.attr("data-bank-item-id"),$el:$el})}.bind(this))}},this),$item.is(".resource-item")&&this.interaction.resourcesPanel.resourcesPanelView.resetAddBy(),this.vent.trigger("item:drop",this,ui.helper)},_onDeleteAll:function(){this.removeAll()},_makeDroppable:function(){this.node.droppable({accept:".resource-item, .resource-stage-item",scope:"resources-"+this.interaction.index,tolerance:"touch",greedy:!0})},_createGrid:function(){this.grid=new a5.ResourcesStageClickToAddGrid({$grid:this.node})},_addToGrid:function(draggedItem){var resourcesPanel=this.interaction.resourcesPanel;resourcesPanel.resourcesStageView.removeItemById(draggedItem.id);var bankItem=resourcesPanel.banks.findItemById(draggedItem.bankItemId),type=bankItem.bank.id,item=new a5.model.ResourceStageItem({path:bankItem.path,inline:bankItem.inline,type:type,value:bankItem.value,bankItemId:bankItem.id});"keypad"===type&&draggedItem.$el&&(item.inline=draggedItem.$el.html());var resourceStageItem=this.addItem(item),matrix=this.region().transformationMatrix(!0),scale=matrix.getScale(),origin={sox:resourceStageItem.$el.position().left,soy:resourceStageItem.$el.position().top};origin.ox=Math.round(10*origin.sox/scale)/10,origin.oy=Math.round(10*origin.soy/scale)/10;var box=resourceStageItem.$el[0].getBoundingClientRect(),size={width:Math.round(box.width/scale),height:Math.round(box.height/scale)},offset=this.grid.relativeTo(this.node),offsetX=Math.round(offset.left/scale),offsetY=Math.round(offset.top/scale),snap=this.grid.snap(size),x=offsetX+snap.x-origin.ox,y=offsetY+snap.y-origin.oy;resourceStageItem.moveTo(x,y),this.model.add(item)},_getItemById:function(id){return _.find(this.children,function(child){return child.hasId(id)})},_isInEdges:function($el){var box=$el[0].getBoundingClientRect(),container=this.node[0].getBoundingClientRect();return box.right>container.right&&box.left<container.right||box.left<container.left&&box.right>container.left||box.bottom>container.bottom&&box.top<container.bottom},_isOutBounds:function($el){var box=$el[0].getBoundingClientRect(),container=this.node[0].getBoundingClientRect();return box.right<container.left||box.left>container.right||box.bottom<container.top||box.top>container.bottom}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksPan"),a5.model_builder.OSNumberStacksActivityBuilder={isResponsible:function(node,interaction){return"Order:Sort:Number stacks"===interaction.identifier&&node.is("matchInteraction, simpleMatchSet, simpleAssociableChoice")&&!interaction.resourcesPanel},_extractValue:function(node){var value,jsonString=node.attr("data-author");try{value=JSON.parse(jsonString).value}catch(e){logger.warn("Invalid JSON value for node",node[0])}return value||0},_serializeXML:function(node){var xmlText="";return xmlText=(new XMLSerializer).serializeToString(node),xmlText.replace(/<simpleAssociableChoice(.*?)>/gi,"").replace(/<\/simpleAssociableChoice>/gi,"")},buildSimpleMatchSet:function(interaction,parentNode,node){this.buildContents(node,interaction,parentNode)},buildSimpleAssociableChoice:function(interaction,parentNode,node){this.buildContents(node,interaction,parentNode)},buildMatchInteraction:function(interaction,parentNode,node){var choices=node.find("simpleAssociableChoice").filter(function(i,node){return a5.utils.startsWith($(node).attr("identifier"),"C")}).map(_.bind(function(i,choice){var content=$("<div class='content'></div>");return a5.utils.buildModel(interaction,content,$("<div>"+this._serializeXML(choice)+"</div>",node.ownerDocument)),{identifier:$(choice).attr("identifier"),value:this._extractValue($(choice)),content:content}},this)),targets=node.find("simpleAssociableChoice").filter(function(i,node){return a5.utils.startsWith($(node).attr("identifier"),"T")}).map(_.bind(function(i,target){var content=$("<div class='content'></div>");return a5.utils.buildModel(interaction,content,$("<div>"+this._serializeXML(target)+"</div>",node.ownerDocument)),{identifier:$(target).attr("identifier"),value:this._extractValue($(target)),content:content}},this)),stacks=parseInt(interaction.options.getPoolStacks(),10),model=new a5.models.interaction.OSNumberStacksActivityModel({choices:choices,targets:targets,drag_behavior:interaction.options.getGapfillbehaviour(),pool_alignment:interaction.options.getPoolAlignment(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),stacks:parseInt(interaction.options.getPoolStacks(),10),multidest:interaction.options.multipleDestinationsIsUnlimited()},null,interaction),view=new a5.views.interaction.OSNumberStacksActivityView(model,stacks);$(parentNode).append(view.render()),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.OSNumberStacksActivityBuilder"),a5.model_builder.builders.push(new a5.model_builder.OSNumberStacksActivityBuilder),a5.models.interaction.OSNumberStacksActivityModel={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({choices:!1,targets:!1,response:!1,pool_alignment:"none",multidest:!1,stacks:0,tryAgainKeep:!1,drag_behavior:"drag"})),this.parent=interaction,this.poolChoices=new a5.models.interaction.OSNumberStacksActivityTarget({identifier:"POOL-1"},this),this.choices=_.map(this.choices,function(choice){var model=new a5.models.interaction.OSNumberStacksActivityChoice(choice,this);return this.poolChoices.drop(model),model},this),this.targets=_.map(this.targets,function(target){return new a5.models.interaction.OSNumberStacksActivityTarget(target,this)},this)},isDrag:function(){return"drag"===this.drag_behavior},isTapItem:function(){return"tap_item"===this.drag_behavior},isTapTarget:function(){return"tap_target"===this.drag_behavior},getDragByID:function(id){return _.find(this.choices,function(drag){return drag.id===id})},store:function(){return{items:_.map(this.targets,function(target){var data={};return data[target.identifier]=_.pluck(target.residents,"identifier"),data})}},tryAgain:function(){_.invoke(this.targets,"tryAgain"),this._super()},restore:function(data){_.each(data.items,function(target){var target_id=_.keys(target)[0],choice_ids=target[target_id],target_model=_.find(this.targets,function(target){return target_id===target.identifier});_.each(choice_ids,function(choice_id){var choice_model=_.find(this.choices,function(ch){return choice_id===ch.identifier});choice_model&&target_model.drop(choice_model)},this)},this),this.trigger("restore")},getScores:function(){var score=new a5.Score;return _.each(this.targets,function(target){score.incTotal(),target.isCorrect()&&score.incCorrect(),target.isFilled()&&score.incFilled()}),score}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacksActivityModel"),a5.models.interaction.OSNumberStacksActivityChoice={init:function(parameters,parent){this._super(parameters,$.extend({identifier:"",value:0,content:"",parent:parent}))}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacksActivityChoice"),a5.models.interaction.OSNumberStacksActivityTarget={init:function(parameters,parent){this._super(parameters,$.extend({identifier:"",value:0,contents:"",residents:null,parent:parent})),this.residents||(this.residents=[])},isCorrect:function(){return this.getSum()===parseInt(this.value,10)},isFilled:function(){return this.residents&&this.residents.length>0},getSum:function(){return _.reduce(this.residents,function(memo,num){return parseInt(num.value,10)+memo},0)},drop:function(choice){this.residents.push(choice),a5.mainBuilder.updateScores()},remove:function(choice){this.residents.splice(_.findIndex(this.residents,choice),1),a5.mainBuilder.updateScores()},tryAgain:function(){this._super(),this.isCorrect()||this.parent.tryAgainKeep||(this.residents=[]),a5.mainBuilder.updateScores()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacksActivityTarget"),a5.views.interaction.OSNumberStacksActivityView={NODE_TEMPLATE:'<div class="os-number-stacks-wrapper"></div>',TARGET_ZONE:'<div class="target-zone"></div>',init:function(model,stacks,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.node.append($(this.POOL_TEMPLATE)),this._sortingEnabled=!0,this.targets=_.map(this.model.targets,function(target){return target=new a5.views.interaction.OSNumberStacksActivityTarget(target,this),target.residents&&_.each(target.residents,function(resident){var choice=new a5.views.interaction.OSNumberStacksActivityElement(resident,this);target.drop(choice)},this),target},this),this.pool=new a5.views.interaction.OSNumberStacksActivityPool(this.model.poolChoices,stacks,this),this.node.addClass("wordpool-"+this.model.pool_alignment),this.node.append(this.pool.render()),this.target_zone=$(this.TARGET_ZONE),_.each(this.targets,function(target){this.target_zone.append(target.render())},this),"bottom"===this.model.pool_alignment?this.node.prepend(this.target_zone):this.node.append(this.target_zone),this.model.bind("state_update:answers",this.showAnswers,this),this.model.bind("state_update:input",this.tryAgain,this),this.model.bind("restore",this._restoreResidents,this)},_restoreResidents:function(){_.each(this.targets,function(target){target._restoreResidents()})},getElementByID:function(id){var elements=this.getElementList();return _.find(elements,function(element){return parseInt(element.model.id,10)===parseInt(id,10)})},getElementList:function(){return _.union(_.flatten(_.pluck(this.targets,"residents")),this.pool.residents,this.active_choice?[this.active_choice]:[])},_getItems:function(){var items=_.map(this.model.choices,function(e){var result={};return result[e.id]=parseInt(e.value,10),result});return this.model.multidest&&(items=_.flatten(_.map(items,function(item){return[item,item,item,item,item,item,item,item,item,item]}))),items},showAnswers:function(){this.node.find(".check").remove(),this.disableSorting();var targets=_.sortBy(this.targets,function(target){return parseInt(target.model.value,10)}),items=this._getItems();_.each(targets,function(target){target.addCheck({empty:target.model.residents.length,correct:target.model.isCorrect()}),this.model.multidest&&(items=this._getItems());var solution,targetValue=parseInt(target.model.value,10);if(targetValue>target.model.getSum())solution=a5.utils.knapsack.resolve(targetValue-target.model.getSum(),items);else{if(!(targetValue<target.model.getSum()))return;solution=a5.utils.knapsack.resolve(targetValue,items),_.each(target.residents,function(resident){target.remove(resident),this.pool.drop(resident)},this)}items=_.filter(items,function(item){var key=_.keys(item)[0],solution_keys=_.map(solution,function(s){return _.keys(s)[0]});return!_.contains(solution_keys,key)}),_.each(solution,function(item){item=this.getElementByID(_.keys(item)[0]),item.target.remove(item,!0),target.drop(item,!1,!0)},this)},this)},tryAgain:function(){this.node.find(".check").remove(),this.enableSorting(),_.each(this.getElementList(),function(element){element.target.remove(element,!0),this.pool.drop(element)},this),_.each(this.targets,function(target){target.tryAgain()})},isSortingEnabled:function(){return this._sortingEnabled},disableSorting:function(){this._sortingEnabled=!1,this.model.isDrag()&&this._disableSortingPlugin()},_disableSortingPlugin:function(){this.pool.parent.model.stacks?_.each(this.pool.stacks,function(stack){stack.sortable("option","disabled",!0)},this):this.pool.pool.sortable("option","disabled",!0),_.each(this.targets,function(target){target.pool.sortable("option","disabled",!0)},this)},enableSorting:function(){this._sortingEnabled=!0,this.model.isDrag()&&this._enableSortingPlugin()},_enableSortingPlugin:function(){this.pool.parent.model.stacks?_.each(this.pool.stacks,function(stack){stack.sortable("option","disabled",!1)},this):this.pool.pool.sortable("option","disabled",!1),_.each(this.targets,function(target){target.pool.sortable("option","disabled",!1)},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksActivityView"),a5.views.interaction.OSNumberStacksActivityPool={NODE_TEMPLATE:'<div class="ddns_wordpool_view os-number-stacks-pool">',POOL_TEMPLATE:'<div class="pool"></div>',STACK_TEMPLATE:'<div class="drop_item_zone stacked"></div>',init:function(model,stacks,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.pool=$(this.POOL_TEMPLATE),this.node.append(this.pool),this.residents=[],this.stacks=[],_.each(this.model.residents,function(choice){choice=new a5.views.interaction.OSNumberStacksActivityElement(choice,this.parent),this.drop(choice)},this),this.node.addClass("wordpool-"+this.parent.model.pool_alignment)},drop:function(choice,dont_render){if(!dont_render)if(this.parent.model.stacks){var stack=this._getSmallestStack();stack&&stack.append(choice.render())}else this.pool.append(choice.render());return this.residents.push(choice),choice.setTarget(this),choice},_getSmallestStack:function(){var stackBySize=_.map(this.stacks,function(stack){return{size:stack.children().length,node:stack}}),sorted=_.sortBy(stackBySize,function(stack){return stack.size});if(!_.isEmpty(sorted))return _.first(sorted).node},remove:function(choice,dont_detach_node){return this.residents=_.without(this.residents,choice),dont_detach_node||choice.node.detach(),choice},render:function(){return this._super(),this.parent.model.stacks?this._render_stacks():this._render_normal(),this.node},_render_normal:function(){_.each(this.residents,function(choice){this.pool.append(choice.render())},this),this.pool.sortable({disabled:!this.parent.model.isDrag(),start:_.bind(function(e,ui){this.parent.model.multidest&&ui.item.show()},this),receive:_.bind(this.onReceive,this),remove:_.bind(this.onRemove,this),helper:"clone"}),this.pool.sortable("option","connectWith",".drop_zone .drop_item_zone, .pool .drop_item_zone")},_render_stacks:function(){_.times(this.parent.model.stacks,function(){var stack=this._init_stack();this.stacks.push(stack),this.pool.append(stack)},this),_.each(this.residents,function(choice,i){this.stacks[i%this.stacks.length].append(choice.render())},this)},_init_stack:function(){var stack=$(this.STACK_TEMPLATE);return stack.sortable({disabled:!this.parent.model.isDrag(),receive:_.bind(this.onReceive,this),remove:_.bind(this.onRemove,this)}),stack.sortable("option","connectWith",".drop_zone .drop_item_zone, .pool .drop_item_zone"),stack},onReceive:function(event,ui){if(this.parent.model.multidest){var id=$(ui.item).attr("data-model");this.node.find("[data-model="+id+"]").length&&ui.item.remove()}else{var item=this.parent.getElementByID($(ui.item).attr("data-model"));this.model.drop(item.model),this.drop(item,!0)}},onRemove:function(event,ui){var item=this.parent.getElementByID($(ui.item).attr("data-model"));if(this.model.remove(item.model),this.parent.active_choice=this.remove(item,!0),this.parent.model.multidest)return ui.item.clone(!0).appendTo(ui.item.parent()),!1}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksActivityPool"),a5.views.interaction.OSNumberStacksActivityTarget={NODE_TEMPLATE:'<div class="drop_zone os-number-stacks-target">',HEADER_TEMPLATE:"<h1>",POOL_TEMPLATE:'<div class="drop_item_zone">',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.pool=$(this.POOL_TEMPLATE),this.header=$(this.HEADER_TEMPLATE),this.header.html(model.content),this.residents=[],this.node.append(this.header),this.node.append(this.pool),this.model.parent.bind("state_update:feedback",this.setAnswer,this),this.bindEvents()},bindEvents:function(){this.parent.model.isTapItem()&&this.bindTapItem()},bindTapItem:function(){a5.utils.bindDoubleClick(this.pool[0],_.bind(function(e){if(this.parent.isSortingEnabled()&&$(e.target).parents(".drag_element").length>0){var drag_element=$(e.target).parents(".drag_element"),drag_id=drag_element.data("model-id"),drag=this.parent.getElementByID(drag_id);drag_element.data("clone")?(drag_element.remove(),drag.target.model.remove(drag.model)):(drag.target.remove(drag),drag.target.model.remove(drag.model),this.parent.pool.drop(drag))}},this))},setAnswer:function(){this.node.find(".check").remove(),this.parent.disableSorting(),this.addCheck({correct:this.model.isCorrect()})},tryAgain:function(){this.pool.find("[data-clone=true]").remove(),this.node.find(".drag_element").remove(),_.each(this.model.residents,function(item){item=this.parent.getElementByID(item.id);var multidest=this.model.parent.multidest;this.drop(item,!1,multidest)},this)},_restoreResidents:function(){_.each(this.model.residents,function(item){item=this.parent.getElementByID(item.id);var multidest=this.model.parent.multidest;this.drop(item,!1,multidest)},this)},drop:function(choice,dont_render,clone){if(!dont_render){var $choice=choice.render();clone&&($choice=$choice.clone(),$choice.attr("data-clone",!0)),this.pool.append($choice)}return this.residents.push(choice),choice.setTarget(this),choice},remove:function(choice,dont_detach_node){if(this.residents=_.without(this.residents,choice),!dont_detach_node){choice.node.detach();this.node.find("[data-model="+choice.model.id+"]").detach()}return choice},render:function(){return this.pool.sortable({disabled:!this.parent.model.isDrag(),receive:_.bind(this.onReceive,this),remove:_.bind(this.onRemove,this)}),this.pool.sortable("option","connectWith",".ddns_wordpool_view .pool,.wordpool .pool .drop_item_zone, .drop_zone .drop_item_zone"),this._super()},onReceive:function(event,ui){var item=this.parent.getElementByID($(ui.item).attr("data-model"));this.model.drop(item.model),this.drop(item,!0)},onRemove:function(event,ui){var item=this.parent.getElementByID($(ui.item).attr("data-model"));this.model.remove(item.model),this.remove(item,!0),
this.parent.active_choice=this.remove(item,!0)}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksActivityTarget"),a5.views.interaction.OSNumberStacksActivityElement={NODE_TEMPLATE:'<div class="drag_element os-number-stacks-element">',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.node.html(this.model.content),this.bindEvents()},bindEvents:function(){this.parent.model.isTapItem()&&this.bindTapItem()},bindTapItem:function(){this.node.click(_.bind(function(e){if(this.parent.isSortingEnabled()){var target=_.first(this.parent.targets);target.drop(this,!1,this.parent.model.multidest),target.model.drop(this.model)}},this))},render:function(){return this.node.attr("data-model",this.model.id),this._super()},setTarget:function(target){this.target=target,this.model.target=target.model}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksActivityElement"),a5.model_builder.ICDialogueRecording={isResponsible:function(node,interaction){return"Input:Creative:Dialogue recording"===interaction.identifier&&node.is("#contentblock")},buildDiv:function(interaction,parentNode,node){new a5.views.interaction.ICDialogueRecording({characters:this._extractCharacters(node,interaction.options.getSetUserRole()),dialogues:this._extractDialogues(node),hideLinesEnabled:interaction.options.hidelinesIsOn(),downloadAudioEnabled:interaction.options.downloadaudioIsOn(),playAllEnabled:interaction.options.playallIsOn(),originalAudioPlayback:interaction.options.getOriginalAudioPlayback(),interaction:interaction}).render()},_extractCharacters:function(node,userRole){var characters=node.find(".character");return _.map(characters,function(characterNode,i){var $character=$(characterNode);return{label:$character.attr("label"),id:$character.attr("id"),photoUrl:A5.ASSET_URL_BUILDER($character.find("> img").attr("src")),disabled:0!==i&&"role_1"===userRole||1!==i&&"role_2"===userRole}})},_extractDialogues:function(node){var dialogues=node.find(".dialogue");return _.map(dialogues,function(dialogueNode){var $dialogue=$(dialogueNode);return{audioId:$dialogue.find('> [type="audio/audio"]').attr("data"),id:$dialogue.attr("id"),characterId:$dialogue.attr("class").split(" ")[1],content:a5.utils.serializeXML($dialogue.find("> div").get(0))}})}},a5.model_builder.Base.extend("a5.model_builder.ICDialogueRecording"),a5.views.interaction.ICDialogueRecording={template:"a5.views.interaction.DialogueRecording",init:function(parameters){_.extend(this,parameters),this.$el=this.interaction.$(".interaction"),this._initDialogues(),_.bindAll(this,"_onClickRole","_onClickHideLines","_onClickHideAll","_onClickDownloadAll"),this.$el.on("click",".role",this._onClickRole),this.$el.on("click",".btn-hide-lines",this._onClickHideLines),this.$el.on("click",".btn-hide-all",this._onClickHideAll),this.$el.on("click",".btn-download-all",this._onClickDownloadAll),this.speakingRecordingInstances={}},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());this.$el.append($(html).html()),"non_selected_role_only"===this.originalAudioPlayback&&this.$el.addClass("original-audio-for-non-selected-role"),this._renderListenAndRecord(),this.playAllEnabled&&this._renderPlayAll();var roleId=_.find(this.characters,{disabled:!1}).id;this._selectRole(roleId)},serializeData:function(){return{hideLinesEnabled:this.hideLinesEnabled,downloadAudioEnabled:this.downloadAudioEnabled,playAllEnabled:this.playAllEnabled,roles:this.characters,dialogues:this.dialogues}},_onClickRole:function(e){e.preventDefault();var $btn=$(e.currentTarget);if(!$btn.is(".disabled")){var roleId=$btn.attr("id");this._selectRole(roleId),this._refreshDialogues()}},_onClickHideLines:function(e){e.preventDefault();var $btn=$(e.currentTarget);this._toggleHideLines(!$btn.is(".active")),this._toggleHideAll(!1),this._refreshDialogues()},_onClickHideAll:function(e){e.preventDefault();var $btn=$(e.currentTarget);this._toggleHideAll(!$btn.is(".active")),this._toggleHideLines(!1),this._refreshDialogues()},_onClickDownloadAll:function(e){e.preventDefault(),this._askSaveAsFilenameAndDownload()},_toggleHideAll:function(active){this.$el.toggleClass("hide-all-lines",active),this.$el.find(".btn-hide-all").toggleClass("active",active)},_toggleHideLines:function(active){this.$el.toggleClass("hide-my-lines",active),this.$el.find(".btn-hide-lines").toggleClass("active",active)},_initDialogues:function(){_.each(this.dialogues,function(dialogue){dialogue.role=this._findCharacterById(dialogue.characterId)},this)},_refreshDialogues:function(){this.$el.find(".dialogue").removeClass("hidden-line"),this.$el.is(".hide-all-lines")?this.$el.find(".dialogue").addClass("hidden-line"):this.$el.is(".hide-my-lines")&&this.$el.find(".dialogue.role-active").addClass("hidden-line")},_findCharacterById:function(id){return _.find(this.characters,function(character){return character.id===id})},_selectDialoguesByRole:function(roleId){this.$el.find(".dialogue.role-active").removeClass("role-active"),this.$el.find("[data-role-id="+roleId+"]").addClass("role-active")},_enableRecordingsByRole:function(roleId){_.each(a5.speaking_recording.LNRInstancesPerInteraction[this.interaction.index],function(speakingRecordingView){speakingRecordingView.disableRecording(),speakingRecordingView.enableListening()},this),_.each(this.speakingRecordingInstances[roleId],function(speakingRecordingView){speakingRecordingView.enableRecording(),speakingRecordingView.isRecordingEnabled()&&speakingRecordingView.disableListening()},this)},_selectRole:function(roleId){this.$el.find(".role.active").removeClass("active"),this.$el.find("#"+roleId).addClass("active");var roleClasses=_.map(this.characters,function(character){return"role-"+character.id});this.$el.removeClass(roleClasses.join(" ")),this.$el.addClass("role-"+roleId),this._selectDialoguesByRole(roleId),this._enableRecordingsByRole(roleId)},_renderListenAndRecord:function(){_.each(this.dialogues,function(dialogue){this._renderRecorder(dialogue),this._renderAudioPlayer(dialogue)},this)},_renderAudioPlayer:function(dialogue){var $dialogue=this.$el.find("#"+dialogue.id),$player=$dialogue.find(".player");$player.addClass("playbutton");var hasPauseBehaviour=this.interaction.options.audioiconbehaviourIsPause();$player.toggleClass("show-pause-on-playing",hasPauseBehaviour),a5.service.media.audio.bind("ready",function(){var playing=!1,tinyAudio=a5.service.media.audio.create(dialogue.audioId,{preload:!a5.dp.config.audioPreloadDisabled});$player.attr("data-playable-media",tinyAudio.uid),a5.dp.config.audioPreloadDisabled&&this.interaction.preloadAudio(tinyAudio),tinyAudio.bind("paused",function(){$dialogue.removeClass("is-playing"),$player.removeClass("playing"),playing=!1,a5.eventBus.trigger("ic-dialogue:player:state:changed",$player.get(0),"paused")}),tinyAudio.bind("stopped",function(){$dialogue.removeClass("is-playing"),$player.removeClass("playing"),playing=!1,a5.eventBus.trigger("ic-dialogue:player:state:changed",$player.get(0),"stopped")}),tinyAudio.bind("playing",function(){$dialogue.addClass("is-playing"),$player.addClass("playing"),playing=!0,a5.eventBus.trigger("ic-dialogue:player:state:changed",$player.get(0),"playing")}),$player.on("click",function(e){playing?hasPauseBehaviour?tinyAudio.pause():tinyAudio.stop():(a5.service.media.pauseAllExcept(tinyAudio),tinyAudio.play()),e.stopPropagation()}),$player.removeClass("inactive")})},_renderRecorder:function(dialogue){var $dialogue=this.$el.find("#"+dialogue.id),$root=$dialogue.find(".recorder"),model=new a5.models.interaction.ICDialogueRecording({parent:this.interaction,downloadEnabled:!1,listenEnabled:!1,nopause:!0,audioID:dialogue.audioId}),view=new a5.views.interaction.SpeakingRecording(model);view.bind("state:changed",function(state,recState){$dialogue.toggleClass("is-playing","playback"===state&&"playing"===recState),$dialogue.toggleClass("is-recording","recording"===recState),$dialogue.toggleClass("has-recording",model.records.length>0),this.$el.toggleClass("recording-in-progress","recording"===recState),view.isRecordingEnabled()&&view.disableListening(),recState&&a5.eventBus.trigger("ic-dialogue:recorder:state:changed",$root.get(0),recState)},this),$root.append(view.render()),_.isUndefined(this.speakingRecordingInstances[dialogue.role.id])&&(this.speakingRecordingInstances[dialogue.role.id]=[]),this.speakingRecordingInstances[dialogue.role.id].push(view),this.interaction.blockItems.add(model)},_renderPlayAll:function(){var $root=this.$el.find(".play-all"),playAll=new a5.speaking_recording.PlayAllView(this.interaction.index,this.interaction.index);playAll.bind("state:changed",function(state){$root.toggleClass("is-playing","playing"===state),"playing"!==state||this.firstPlayAll||(this._setAllFilled(),this.firstPlayAll=!0)},this);var $playAll=playAll.render();$root.append($playAll.contents())},_askSaveAsFilenameAndDownload:function(){var $dialog=a5.view.dialog.display("a5.view.dialog.RecordingSaveAs",{filename:A5.DEFAULT_SAVEAS_FILENAME},{ok:_.bind(function(){this._downloadAll($dialog.find("#downloadFilename").val())},this)})},_downloadAll:function(filename){var inputs=[],clips=[],recordingViews=a5.speaking_recording.LNRInstancesPerInteraction[this.interaction.index];_.each(this.dialogues,function(dialogue,index){var recordingView=recordingViews[index];recordingView.isListeningEnabled()&&(inputs.push(a5.utils.getAbsoluteURL(a5.service.media.audio.buildUrl(dialogue.audioId,"mp3"))),clips.push({input:inputs.length-1})),recordingView.isRecordingEnabled()&&_.each(recordingView.model.records[0],function(snippet){inputs.push(a5.service.media.audio_recorder.instance().buildUrl(snippet)),clips.push({input:inputs.length-1})},this)},this),a5.service.toolbelt.audioDownload({inputs:inputs,clips:clips,output:filename})},_setAllFilled:function(){_.chain(this.speakingRecordingInstances).values().flatten().pluck("model").invoke("setFilled"),a5.mainBuilder.updateScoresAsync()}},Obj.extend("a5.views.interaction.ICDialogueRecording"),a5.models.interaction.ICDialogueRecording={setFilled:function(){this.filled=!0},isFilled:function(){return this.filled}},a5.models.interaction.SpeakingRecording.extend("a5.models.interaction.ICDialogueRecording"),a5.model_builder.ISHangman={isResponsible:function(node,interaction){return"Identify:Select:Hangman"===interaction.identifier&&node.is("#content, textEntryInteraction")},buildDiv:function(interaction,parentNode,node){if(node.is("#content")){interaction.controller={words:[],vent:new Obj},this._super(interaction,parentNode,node);var model=new a5.model.interaction.ISHangman({words:_.pluck(interaction.controller.words,"model"),scoreValueIs1PerQuestion:interaction.options.scoreValuesIs1_point_question()});new a5.view.ISHangman({$el:interaction.$(".interaction"),words:interaction.controller.words,vent:interaction.controller.vent,$content:parentNode.contents(),model:model,lives:parseInt(interaction.options.getNumberofchances(),10),showAnswerAuto:interaction.options.revealSolutionIsAfter_final_chance()}).render(),interaction.blockItems.add(model)}else this._super(interaction,parentNode,node)},buildTextEntryInteraction:function(interaction,parentNode,node){var response=interaction.getCorrectResponse(node.attr("responseIdentifier")),word=_.first(response.values),model=new a5.model.interaction.ISHangmanWord({text:word}),view=new a5.view.ISHangmanWord({model:model,vent:interaction.controller.vent});interaction.controller.words.push(view),parentNode.append(view.$el),view.render()}},a5.model_builder.Content.extend("a5.model_builder.ISHangman"),a5.view.ISHangman={template:"a5.view.interaction.ISHangman",init:function(parameters){this.model=parameters.model,this.$el=parameters.$el,this.vent=parameters.vent,this.words=parameters.words,this.$content=parameters.$content,this.showAnswerAuto=parameters.showAnswerAuto,this.errorCounter=new a5.model.ISHangmanErrorCounter({total:parameters.lives}),this.vent.bind("success:key",this._onSuccessKey,this),this.vent.bind("wrong:key",this._onWrongKey,this),this.errorCounter.bind("change",this._onErrorChange,this),this.model.bind("restore",this._onRestore,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.tryAgain,this)},render:function(){var html=a5.service.templates.render(this.template);return this.$el.append($(html).html()),this.board=new a5.view.ISHangmanBoard({model:this.model,$el:this.$el.find(".is-hangman-board"),$content:this.$content,vent:this.vent,words:this.words}),this.board.render(),this.keyboard=new a5.view.ISHangmanKeyboard({$el:this.$el.find(".is-hangman-keyboard"),vent:this.vent}),this.keyboard.render(),this.lifeFeedback=new a5.view.ISHangmanLifeFeedback({$el:this.$el.find(".is-hangman-life-feedback"),errorCounter:this.errorCounter}),this.lifeFeedback.render(),this.lifeCounter=new a5.view.ISHangmanLifeCounter({$el:this.$el.find(".is-hangman-life-counter"),errorCounter:this.errorCounter}),this.lifeCounter.render(),this.$el},showAnswer:function(){this.keyboard.disable(),this.board.showAnswer()},tryAgain:function(){this.errorCounter.reset(),this.board.reset(),this.keyboard.reset(),this.renderGameStart()},renderGameOver:function(){this.keyboard.disable(),this.$el.addClass("is-hangman-game-over"),this.skipValidation||(a5.mainBuilder.checkAnswer(),this.showAnswerAuto&&a5.mainBuilder.showAnswer())},renderGameCompleted:function(){this.keyboard.disable(),this.$el.addClass("is-hangman-game-completed"),this.skipValidation||(a5.mainBuilder.checkAnswerWithFeedbackAllCorrect(),this.showAnswerAuto&&a5.mainBuilder.showAnswer())},renderGameStart:function(){this.$el.removeClass("is-hangman-game-completed"),this.$el.removeClass("is-hangman-game-over")},_onErrorChange:function(cur,prev){this.$el.removeClass("is-hangman-life-"+prev),this.$el.addClass("is-hangman-life-"+cur)},_onWrongKey:function(){this.errorCounter.increase(),a5.eventBus.trigger("is-hangman:failure"),this.errorCounter.count===this.errorCounter.total&&this.renderGameOver()},_onSuccessKey:function(){a5.eventBus.trigger("is-hangman:success"),this.board.revealed&&this.renderGameCompleted()},_onRestore:function(){this.skipValidation=!0,_.each(this.model.attemptedLetters,function(c){this.keyboard.hit(c)},this),this.skipValidation=!1}},Obj.extend("a5.view.ISHangman"),a5.view.ISHangmanBoard={init:function(parameters){this.model=parameters.model,this.$el=parameters.$el,this.$content=parameters.$content,this.vent=parameters.vent,this.words=parameters.words,this.vent.bind("hit:key",this._onHitKey,this)},render:function(){return this.$el.append(this.$content),this.$el},test:function(c){if(!this.revealed){var found=!1;_.each(this.words,function(word){var letters=word.test(c);_.isEmpty(letters)||(found=!0,word.reveal(letters))}),this.model.test(c),_.all(this.words,function(word){return word.revealed})&&(this.revealed=!0),found?this.vent.trigger("success:key",c):this.vent.trigger("wrong:key",c)}},reveal:function(){this.revealed=!0,_.invoke(this.words,"reveal")},showAnswer:function(){this.revealed=!0,_.invoke(this.words,"showAnswer")},reset:function(){this.revealed=!1,_.invoke(this.words,"reset")},_onHitKey:function(key){this.test(key.value)}},Obj.extend("a5.view.ISHangmanBoard"),a5.view.ISHangmanWord={template:"a5.view.interaction.ISHangmanWord",init:function(parameters){this.$el=$('<div class="is-hangman-word"></div>'),this.model=parameters.model,this.vent=parameters.vent,this.word=this.model.text},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html($(html).html()),this.letters=_.map(this.word,function(letter,index){return new a5.view.ISHangmanLetter({$el:this.$el.find(".is-hangman-letter").eq(index),value:letter,vent:this.vent})},this),_.invoke(this.letters,"render"),this.$el},serializeData:function(){return{letters:_.range(this.word.length)}},test:function(c){var letters=[];return this.revealed||(letters=_.filter(this.letters,function(letter){return letter.test(c)})),letters},reveal:function(letters){letters=letters||this.letters,_.invoke(letters,"reveal"),_.all(this.letters,function(letter){return letter.revealed})&&(this.$el.addClass("is-hangman-word-revealed"),this.revealed=!0,this.model.reveal())},showAnswer:function(){_.invoke(this.letters,"showAnswer"),this.$el.addClass("is-hangman-word-answer"),this.revealed=!0},reset:function(){_.invoke(this.letters,"reset"),this.$el.removeClass("is-hangman-word-revealed"),this.$el.removeClass("is-hangman-word-answer"),this.revealed=!1}},Obj.extend("a5.view.ISHangmanWord"),a5.view.ISHangmanLetter={init:function(parameters){this.$el=parameters.$el,this.value=parameters.value,this.vent=parameters.vent},render:function(){return this.$el},test:function(c){return a5.utils.removeAccents(this.value.toLowerCase())===a5.utils.removeAccents(c.toLowerCase())&&!this.revealed},reveal:function(){this.$el.addClass("is-hangman-letter-revealed"),this.$el.text(this.value),this.revealed=!0},showAnswer:function(){this.revealed||(this.$el.addClass("is-hangman-letter-empty"),this.$el.text(this.value),this.revealed=!0,this.vent.trigger("empty:key",this.value))},reset:function(){this.$el.removeClass("is-hangman-letter-revealed"),this.$el.removeClass("is-hangman-letter-empty"),this.$el.text(""),this.revealed=!1}},Obj.extend("a5.view.ISHangmanLetter"),a5.view.ISHangmanKeyboard={init:function(parameters){this.$el=parameters.$el,this.vent=parameters.vent,this._initKeys()},render:function(){return this.$el},enable:function(){_.invoke(this.keys,"enable")},disable:function(){_.invoke(this.keys,"disable")},reset:function(){_.invoke(this.keys,"reset")},hit:function(c){var key=this._findKey(c);key&&key.hit()},_findKey:function(value){return this.keys.find(function(key){return key.value===value})},_initKeys:function(){this.keys=[],this.$el.find(".is-hangman-key").each(function(index,key){var $key=$(key),keyView=new a5.view.ISHangmanKey({$el:$key,value:$key.attr("data-char"),vent:this.vent});this.keys.push(keyView)}.bind(this))}},Obj.extend("a5.view.ISHangmanKeyboard"),a5.view.ISHangmanKey={init:function(parameters){this.$el=parameters.$el,this.value=parameters.value,this.vent=parameters.vent,this.vent.bind("success:key",this._onSuccessKey,this),this.vent.bind("wrong:key",this._onWrongKey,this),this.vent.bind("empty:key",this._onEmptyKey,this),_.bindAll(this,"_onClick"),this.enable()},hit:function(){this.attempted||(this.attempted=!0,this.$el.addClass("is-hangman-key-attempted"),this.vent.trigger("hit:key",this))},reset:function(){this.attempted=!1,this.$el.removeClass("is-hangman-key-attempted"),this.$el.removeClass("is-hangman-key-correct"),this.$el.removeClass("is-hangman-key-incorrect"),this.$el.removeClass("is-hangman-key-empty"),this.enable()},enable:function(){this.$el.on("click",this._onClick)},disable:function(){this.$el.off("click",this._onClick)},_onClick:function(e){e.preventDefault(),this.hit()},_onSuccessKey:function(c){a5.utils.removeAccents(this.value.toLowerCase())===a5.utils.removeAccents(c.toLowerCase())&&this.$el.addClass("is-hangman-key-correct")},_onWrongKey:function(c){a5.utils.removeAccents(this.value.toLowerCase())===a5.utils.removeAccents(c.toLowerCase())&&this.$el.addClass("is-hangman-key-incorrect")},_onEmptyKey:function(c){a5.utils.removeAccents(this.value.toLowerCase())===a5.utils.removeAccents(c.toLowerCase())&&this.$el.addClass("is-hangman-key-empty")}},Obj.extend("a5.view.ISHangmanKey"),a5.view.ISHangmanLifeCounter={template:"a5.view.interaction.ISHangmanLifeCounter",init:function(parameters){this.$el=parameters.$el,this.errorCounter=parameters.errorCounter,this.errorCounter.bind("change",this._onError,this)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html($(html).html()),this.$el},refresh:function(){this.render()},serializeData:function(){var lives=_.times(this.errorCounter.total,function(number){return{id:number+1,used:number<this.errorCounter.count}},this);return{errors:this.errorCounter.count,total:this.errorCounter.total,remaining:this.errorCounter.total-this.errorCounter.count,lives:lives}},_onError:function(){this.refresh()}},Obj.extend("a5.view.ISHangmanLifeCounter"),a5.view.ISHangmanLifeFeedback={template:"a5.view.interaction.ISHangmanLifeFeedback",init:function(parameters){this.$el=parameters.$el,this.errorCounter=parameters.errorCounter,this.errorCounter.bind("change",this._onError,this)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html($(html).html()),this.$el},refresh:function(){this.render()},serializeData:function(){return{errors:this.errorCounter.count,total:this.errorCounter.total,remaining:this.errorCounter.total-this.errorCounter.count}},_onError:function(){this.refresh()}},Obj.extend("a5.view.ISHangmanLifeFeedback"),a5.model.interaction.ISHangman={init:function(parameters,defaults){this._super(parameters,$.extend({attemptedLetters:[],words:[],scoreValueIs1PerQuestion:!1},defaults))},test:function(c){_.contains(this.attemptedLetters,c)||this.attemptedLetters.push(c)},store:function(){return this.attemptedLetters},restore:function(attemptedLetters){this.attemptedLetters=attemptedLetters,this.trigger("restore")},getScores:function(){var score=new a5.Score;return _.each(this.words,function(word){word.getScores(score)}),score.incFilled(this.isFilled()),this.scoreValueIs1PerQuestion&&(score.totalBlocks=1,score.correctBlocks=score.total?score.correct/score.total:1),score},tryAgain:function(){this.attemptedLetters=[],this._super()},isFilled:function(){return this.attemptedLetters.length>0}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ISHangman"),a5.model.interaction.ISHangmanWord={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",revealed:!1},defaults))},getScores:function(score){score.incCorrect(this.isCorrect()),score.incTotal()},isCorrect:function(){return this.revealed},reveal:function(){this.revealed=!0},hide:function(){this.revealed=!1}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ISHangmanWord"),a5.model.ISHangmanErrorCounter={init:function(parameters){this.count=0,this.total=parameters.total},reset:function(value){var prev=this.count;this.count=value||0,this.trigger("change",this.count,prev)},increase:function(){var prev=this.count;this.count=_.min([prev+1,this.total]),this.trigger("change",this.count,prev)}},Obj.extend("a5.model.ISHangmanErrorCounter"),A5.ENGINE_TEMPLATES={"a5.view.multiselectCheck":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<ul class="multiselectCheckList group">\n</ul>\n'},useData:!0}),"a5.view.multiselectCheckChoice":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper;return'<li class="group__item">\n  <label class="formCheck formCheck--checkbox">\n    <input class="formCheck__input" type="checkbox">\n    <span class="formCheck__label">'+(null!=(helper=null!=(helper=helpers.data||(null!=depth0?depth0.data:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:container.nullContext||{},{name:"data",hash:{},data:data}):helper)?stack1:"")+"</span>\n  </label>\n</li>\n"},useData:!0}),"a5.view.alert.InvalidPage":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return'<div data-duration="10">\n  <span class="close">x</span>\n  The last page is '+container.escapeExpression((helper=null!=(helper=helpers.last||(null!=depth0?depth0.last:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:container.nullContext||{},{name:"last",hash:{},data:data}):helper))+". Please re-enter page number.\n</div>\n"},useData:!0}),"a5.view.hotspot.File":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="hotspot file">\n  <div class="toolbar">\n    <div class="handle"></div>\n    <div class="trash"></div>\n  </div>\n  <div class="tooltip"></div>\n</div>\n'},useData:!0}),"a5.view.interaction.ICCrosswordCell":Handlebars.template({1:function(container,depth0,helpers,partials,data){var stack1,alias1=null!=depth0?depth0:container.nullContext||{};return(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.word1:depth0,{name:"if",hash:{},fn:container.program(2,data,0),inverse:container.noop,data:data}))?stack1:"")+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.word2:depth0,{name:"if",hash:{},fn:container.program(7,data,0),inverse:container.noop,data:data}))?stack1:"")},2:function(container,depth0,helpers,partials,data){var stack1,alias1=container.lambda,alias2=container.escapeExpression;return"Letter "+alias2(alias1(null!=(stack1=null!=depth0?depth0.word1:depth0)?stack1.cell:stack1,depth0))+" of word "+alias2(alias1(null!=(stack1=null!=depth0?depth0.word1:depth0)?stack1.index:stack1,depth0))+" "+(null!=(stack1=helpers.if.call(null!=depth0?depth0:container.nullContext||{},null!=(stack1=null!=depth0?depth0.word1:depth0)?stack1.isVertical:stack1,{name:"if",hash:{},fn:container.program(3,data,0),inverse:container.program(5,data,0),data:data}))?stack1:"")},3:function(container,depth0,helpers,partials,data){return"down"},5:function(container,depth0,helpers,partials,data){return"across"},7:function(container,depth0,helpers,partials,data){var stack1,alias1=container.lambda,alias2=container.escapeExpression;return", letter "+alias2(alias1(null!=(stack1=null!=depth0?depth0.word2:depth0)?stack1.cell:stack1,depth0))+" of word "+alias2(alias1(null!=(stack1=null!=depth0?depth0.word2:depth0)?stack1.index:stack1,depth0))+" "+(null!=(stack1=helpers.if.call(null!=depth0?depth0:container.nullContext||{},null!=(stack1=null!=depth0?depth0.word2:depth0)?stack1.isVertical:stack1,{name:"if",hash:{},fn:container.program(3,data,0),inverse:container.program(5,data,0),data:data}))?stack1:"")},9:function(container,depth0,helpers,partials,data){var stack1,helper;return'    <span class="clue-cell-enum">'+(null!=(helper=null!=(helper=helpers.enumLabel||(null!=depth0?depth0.enumLabel:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:container.nullContext||{},{name:"enumLabel",hash:{},data:data}):helper)?stack1:"")+"</span>\n"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data,blockParams,depths){var stack1,helper,alias1=null!=depth0?depth0:container.nullContext||{};return'\n<div class="cell">\n  <input type="text" maxlength="1" aria-label="'+(null!=(stack1=container.invokePartial(partials.label,depth0,{name:"label",hash:{word2:null!=depth0?depth0.word2:depth0,word1:null!=depth0?depth0.word1:depth0},data:data,helpers:helpers,partials:partials,decorators:container.decorators}))?stack1:"")+'" tabIndex="'+container.escapeExpression((helper=null!=(helper=helpers.tabIndex||(null!=depth0?depth0.tabIndex:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(alias1,{name:"tabIndex",hash:{},data:data}):helper))+'"></input>\n'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.enumLabel:depth0,{name:"if",hash:{},fn:container.program(9,data,0,blockParams,depths),inverse:container.noop,data:data}))?stack1:"")+"</div>\n"},main_d:function(fn,props,container,depth0,data,blockParams,depths){return fn=container.decorators.inline(fn,props,container,{name:"inline",hash:{},fn:container.program(1,data,0,blockParams,depths),inverse:container.noop,args:["label"],data:data})||fn},useDecorators:!0,usePartial:!0,useData:!0,useDepths:!0}),"a5.views.interaction.DialogueRecording":Handlebars.template({1:function(container,depth0,helpers,partials,data){var stack1,alias1=container.lambda,alias2=container.escapeExpression;return'  <div class="role'+(null!=(stack1=helpers.if.call(null!=depth0?depth0:container.nullContext||{},null!=(stack1=null!=depth0?depth0.role:depth0)?stack1.disabled:stack1,{name:"if",hash:{},fn:container.program(2,data,0),inverse:container.noop,data:data}))?stack1:"")+'" id="'+alias2(alias1(null!=(stack1=null!=depth0?depth0.role:depth0)?stack1.id:stack1,depth0))+'">\n    <div class="role-photo">\n      <img src="'+alias2(alias1(null!=(stack1=null!=depth0?depth0.role:depth0)?stack1.photoUrl:stack1,depth0))+'"/>\n    </div>\n    <div class="role-label">'+alias2(alias1(null!=(stack1=null!=depth0?depth0.role:depth0)?stack1.label:stack1,depth0))+'</div>\n    <div class="btn-select-role"></div>\n  </div>\n'},2:function(container,depth0,helpers,partials,data){return" disabled"},4:function(container,depth0,helpers,partials,data){var stack1,alias1=container.lambda,alias2=container.escapeExpression;return'  <div class="dialogue" id="'+alias2(alias1(null!=(stack1=null!=depth0?depth0.dialogue:depth0)?stack1.id:stack1,depth0))+'" data-role-id="'+alias2(alias1(null!=(stack1=null!=depth0?depth0.dialogue:depth0)?stack1.characterId:stack1,depth0))+'">\n    <div class="role-photo">\n      <img src="'+alias2(alias1(null!=(stack1=null!=(stack1=null!=depth0?depth0.dialogue:depth0)?stack1.role:stack1)?stack1.photoUrl:stack1,depth0))+'"/>\n    </div>\n    <div class="dialogue-content">\n      '+(null!=(stack1=alias1(null!=(stack1=null!=depth0?depth0.dialogue:depth0)?stack1.content:stack1,depth0))?stack1:"")+'\n    </div>\n    <div class="recorder"></div>\n    <div class="player"></div>\n  </div>\n'},6:function(container,depth0,helpers,partials,data,blockParams){var stack1;return null!=(stack1=container.invokePartial(partials.role,depth0,{name:"role",hash:{role:blockParams[0][0]},data:data,blockParams:blockParams,indent:"      ",helpers:helpers,partials:partials,decorators:container.decorators}))?stack1:""},8:function(container,depth0,helpers,partials,data){return'    <div class="hide-lines-buttons">\n      <div class="btn-hide-lines">Hide my lines</div>\n      <div class="btn-hide-all">Hide all lines</div>\n    </div>\n'},10:function(container,depth0,helpers,partials,data,blockParams){var stack1;return null!=(stack1=container.invokePartial(partials.dialogue,depth0,{name:"dialogue",hash:{dialogue:blockParams[0][0]},data:data,blockParams:blockParams,indent:"      ",helpers:helpers,partials:partials,decorators:container.decorators}))?stack1:""},12:function(container,depth0,helpers,partials,data){return'    <div class="play-all"></div>\n'},14:function(container,depth0,helpers,partials,data){return'    <div class="btn-download-all"></div>\n'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data,blockParams,depths){var stack1,alias1=null!=depth0?depth0:container.nullContext||{};return'\n\n<div class="ic-dialogue-recording">\n  <div class="role-selector">\n'+(null!=(stack1=helpers.each.call(alias1,null!=depth0?depth0.roles:depth0,{name:"each",hash:{},fn:container.program(6,data,1,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+"  </div>\n"+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.hideLinesEnabled:depth0,{name:"if",hash:{},fn:container.program(8,data,0,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+'  \n  <div class="dialogues">\n'+(null!=(stack1=helpers.each.call(alias1,null!=depth0?depth0.dialogues:depth0,{name:"each",hash:{},fn:container.program(10,data,1,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+"  </div>\n"+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.playAllEnabled:depth0,{name:"if",hash:{},fn:container.program(12,data,0,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.downloadAudioEnabled:depth0,{name:"if",hash:{},fn:container.program(14,data,0,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+"</div>\n"},main_d:function(fn,props,container,depth0,data,blockParams,depths){var decorators=container.decorators
;return fn=decorators.inline(fn,props,container,{name:"inline",hash:{},fn:container.program(1,data,0,blockParams,depths),inverse:container.noop,args:["role"],data:data,blockParams:blockParams})||fn,fn=decorators.inline(fn,props,container,{name:"inline",hash:{},fn:container.program(4,data,0,blockParams,depths),inverse:container.noop,args:["dialogue"],data:data,blockParams:blockParams})||fn},useDecorators:!0,usePartial:!0,useData:!0,useDepths:!0,useBlockParams:!0}),"a5.view.IMAutocorrectErrorCounter":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper,alias1=null!=depth0?depth0:container.nullContext||{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return'<div class="error-counter">\n  <p>\n    There are '+alias4((helper=null!=(helper=helpers.total||(null!=depth0?depth0.total:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"total",hash:{},data:data}):helper))+" errors. <br>\n    You have found "+alias4((helper=null!=(helper=helpers.correct||(null!=depth0?depth0.correct:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"correct",hash:{},data:data}):helper))+" errors.\n  </p>\n</div>\n"},useData:!0}),"a5.view.IMProofingErrorCounter":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper,alias1=null!=depth0?depth0:container.nullContext||{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return'<div class="error-counter">\n  <p>\n    There are '+alias4((helper=null!=(helper=helpers.total||(null!=depth0?depth0.total:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"total",hash:{},data:data}):helper))+" errors. <br>\n    You have found "+alias4((helper=null!=(helper=helpers.correct||(null!=depth0?depth0.correct:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"correct",hash:{},data:data}):helper))+" errors.\n  </p>\n</div>\n"},useData:!0}),"a5.view.IMProofingToolbar":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="tools">\n  <div class="markers">\n    <a href="#" class="btn-capital">Make capital</a>\n    <a href="#" class="btn-small">Make a small letter</a>\n    <a href="#" class="btn-add">Add something</a>\n    <a href="#" class="btn-delete">Take out something</a>\n    <a href="#" class="btn-spelling">Spelling error</a>\n    <a href="#" class="btn-grammar">Grammar error</a>\n    <a href="#" class="btn-fullstop">Add a period</a>\n    <a href="#" class="btn-para">New paragraph</a>\n    <a href="#" class="btn-indent">Indent</a>\n    <a href="#" class="btn-erase">Erase</a>\n  </div>\n</div>\n'},useData:!0}),"a5.view.is_catch_GameOver":Handlebars.template({1:function(container,depth0,helpers,partials,data){var helper;return"        "+container.escapeExpression((helper=null!=(helper=helpers.text||(null!=depth0?depth0.text:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:container.nullContext||{},{name:"text",hash:{},data:data}):helper))+"\n"},3:function(container,depth0,helpers,partials,data){return"        Game Over\n"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return'<div title="ISCatchMessage">\n  <div class="content-dialog-wrapper">\n    <p>\n'+(null!=(stack1=helpers.if.call(null!=depth0?depth0:container.nullContext||{},null!=depth0?depth0.text:depth0,{name:"if",hash:{},fn:container.program(1,data,0),inverse:container.program(3,data,0),data:data}))?stack1:"")+'    </p>\n    <div class="last-buttons">\n      <a href="#" data-button="ok">OK</a>\n   </div>\n  </div>\n</div>\n'},useData:!0}),"a5.view.is_catch_ScoreBoard":Handlebars.template({1:function(container,depth0,helpers,partials,data){return"    <div class='is_catch_board_timer'/>\n"},3:function(container,depth0,helpers,partials,data){return"    <div class='is_catch_board_score'/>\n"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,alias1=null!=depth0?depth0:container.nullContext||{};return'<div title="ISCatchScoreBoard">\n    <p>\n      This is the score:\n    </p>\n'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.timer:depth0,{name:"if",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.score:depth0,{name:"if",hash:{},fn:container.program(3,data,0),inverse:container.noop,data:data}))?stack1:"")+"</div>\n"},useData:!0}),"a5.view.is_catch_TimeUp":Handlebars.template({1:function(container,depth0,helpers,partials,data){var helper;return"        "+container.escapeExpression((helper=null!=(helper=helpers.text||(null!=depth0?depth0.text:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:container.nullContext||{},{name:"text",hash:{},data:data}):helper))+"\n"},3:function(container,depth0,helpers,partials,data){return"        You ran out of time!\n"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return'<div title="ISCatchMessage">\n  <div class="content-dialog-wrapper">\n    <p>\n'+(null!=(stack1=helpers.if.call(null!=depth0?depth0:container.nullContext||{},null!=depth0?depth0.text:depth0,{name:"if",hash:{},fn:container.program(1,data,0),inverse:container.program(3,data,0),data:data}))?stack1:"")+'    </p>\n    <div class="last-buttons">\n      <a href="#" data-button="ok">OK</a>\n   </div>\n  </div>\n</div>\n'},useData:!0}),"a5.view.interaction.ISCheckbox":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="group" aria-label="possible answers"></div>\n'},useData:!0}),"a5.view.interaction.ISCheckboxChoice":Handlebars.template({1:function(container,depth0,helpers,partials,data){return'<span class="is-checkbox-choice-text"></span>'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return'<span class="item">'+(null!=(stack1=helpers.unless.call(null!=depth0?depth0:container.nullContext||{},null!=depth0?depth0.showInColumns:depth0,{name:"unless",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+"</span>\n"},useData:!0}),"a5.view.interaction.ISCheckboxChoiceWrapper":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="checkbox" aria-checked="false"></div>\n'},useData:!0}),"a5.view.interaction.ISHangman":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="is-hangman">\n  <div class="is-hangman-life-counter"></div>\n  <div class="is-hangman-life-feedback"></div>\n  <div class="is-hangman-board"></div>\n  <div class="is-hangman-keyboard">\n    <div class="is-hangman-key" data-char="a">A</div>\n    <div class="is-hangman-key" data-char="b">B</div>\n    <div class="is-hangman-key" data-char="c">C</div>\n    <div class="is-hangman-key" data-char="d">D</div>\n    <div class="is-hangman-key" data-char="e">E</div>\n    <div class="is-hangman-key" data-char="f">F</div>\n    <div class="is-hangman-key" data-char="g">G</div>\n    <div class="is-hangman-key" data-char="h">H</div>\n    <div class="is-hangman-key" data-char="i">I</div>\n    <div class="is-hangman-key" data-char="j">J</div>\n    <div class="is-hangman-key" data-char="k">K</div>\n    <div class="is-hangman-key" data-char="l">L</div>\n    <div class="is-hangman-key" data-char="m">M</div>\n    <div class="is-hangman-key" data-char="n">N</div>\n    <div class="is-hangman-key" data-char="o">O</div>\n    <div class="is-hangman-key" data-char="p">P</div>\n    <div class="is-hangman-key" data-char="q">Q</div>\n    <div class="is-hangman-key" data-char="r">R</div>\n    <div class="is-hangman-key" data-char="s">S</div>\n    <div class="is-hangman-key" data-char="t">T</div>\n    <div class="is-hangman-key" data-char="u">U</div>\n    <div class="is-hangman-key" data-char="v">V</div>\n    <div class="is-hangman-key" data-char="w">W</div>\n    <div class="is-hangman-key" data-char="x">X</div>\n    <div class="is-hangman-key" data-char="y">Y</div>\n    <div class="is-hangman-key" data-char="z">Z</div>\n  </div>\n</div>\n'},useData:!0}),"a5.view.interaction.ISHangmanLifeCounter":Handlebars.template({1:function(container,depth0,helpers,partials,data){var stack1;return'  <div class="is-hangman-life is-hangman-life-'+container.escapeExpression(container.lambda(null!=(stack1=null!=depth0?depth0.life:depth0)?stack1.id:stack1,depth0))+" "+(null!=(stack1=helpers.if.call(null!=depth0?depth0:container.nullContext||{},null!=(stack1=null!=depth0?depth0.life:depth0)?stack1.used:stack1,{name:"if",hash:{},fn:container.program(2,data,0),inverse:container.noop,data:data}))?stack1:"")+'">\n  </div>\n'},2:function(container,depth0,helpers,partials,data){return"life-used"},4:function(container,depth0,helpers,partials,data,blockParams){var stack1;return null!=(stack1=container.invokePartial(partials.life,depth0,{name:"life",hash:{life:blockParams[0][0]},data:data,blockParams:blockParams,indent:"    ",helpers:helpers,partials:partials,decorators:container.decorators}))?stack1:""},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data,blockParams,depths){var stack1;return"\n<div>\n"+(null!=(stack1=helpers.each.call(null!=depth0?depth0:container.nullContext||{},null!=depth0?depth0.lives:depth0,{name:"each",hash:{},fn:container.program(4,data,1,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+"</div>\n"},main_d:function(fn,props,container,depth0,data,blockParams,depths){return fn=container.decorators.inline(fn,props,container,{name:"inline",hash:{},fn:container.program(1,data,0,blockParams,depths),inverse:container.noop,args:["life"],data:data,blockParams:blockParams})||fn},useDecorators:!0,usePartial:!0,useData:!0,useDepths:!0,useBlockParams:!0}),"a5.view.interaction.ISHangmanLifeFeedback":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<div>\n  "+container.escapeExpression((helper=null!=(helper=helpers.remaining||(null!=depth0?depth0.remaining:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:container.nullContext||{},{name:"remaining",hash:{},data:data}):helper))+" remaining chances\n</div>\n"},useData:!0}),"a5.view.interaction.ISHangmanWord":Handlebars.template({1:function(container,depth0,helpers,partials,data){return'  <div class="is-hangman-letter"></div>\n'},3:function(container,depth0,helpers,partials,data,blockParams){var stack1;return null!=(stack1=container.invokePartial(partials.letter,depth0,{name:"letter",hash:{letter:blockParams[0][0]},data:data,blockParams:blockParams,indent:"    ",helpers:helpers,partials:partials,decorators:container.decorators}))?stack1:""},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data,blockParams,depths){var stack1;return"\n<div>\n"+(null!=(stack1=helpers.each.call(null!=depth0?depth0:container.nullContext||{},null!=depth0?depth0.letters:depth0,{name:"each",hash:{},fn:container.program(3,data,1,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+"</div>\n"},main_d:function(fn,props,container,depth0,data,blockParams,depths){return fn=container.decorators.inline(fn,props,container,{name:"inline",hash:{},fn:container.program(1,data,0,blockParams,depths),inverse:container.noop,args:["letter"],data:data,blockParams:blockParams})||fn},useDecorators:!0,usePartial:!0,useData:!0,useDepths:!0,useBlockParams:!0}),"a5.view.interaction.ISRadioButton":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="radiogroup" aria-label="possible answers"></div>\n'},useData:!0}),"a5.view.interaction.ISRadioButtonChoice":Handlebars.template({1:function(container,depth0,helpers,partials,data){return'<span class="is-radiobutton-choice-text"></span>'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return'<span class="item">'+(null!=(stack1=helpers.unless.call(null!=depth0?depth0:container.nullContext||{},null!=depth0?depth0.showInColumns:depth0,{name:"unless",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+"</span>\n"},useData:!0}),"a5.view.interaction.ISRadioButtonChoiceWrapper":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="radio" aria-checked="false"></div>\n'},useData:!0}),"a5.view.interaction.ISRadioButtonColumns":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="radiogroup" tabindex="0" aria-label="possible answers"></div>\n'},useData:!0}),"a5.view.interaction.ISRadioButtonColumnsChoice":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<span class="item"></span>\n'},useData:!0}),"a5.view.interaction.ISRadioButtonColumnsChoiceWrapper":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="radio" aria-checked="false"></div>\n'},useData:!0}),"a5.view.dialog.Countdown":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="countdown-panel">\n  <div class="display">\n    <span class="hours">00</span>\n    <span class="time-separator">:</span>\n    <span class="minutes">00</span>\n    <span class="time-separator">:</span>\n    <span class="seconds">00</span>\n  </div>\n  <div class="progress"></div>\n  <div class="buttons">\n    <button class="reset">Reset</button>\n    <button class="play">Play</button>\n    <button class="pause">Pause</button>\n    <button class="close">Close</button>\n  </div>\n</div>\n'},useData:!0}),"a5.view.dialog.CountdownSetup":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="countdown-setup-panel">\n  <span class="close">x</span>\n  <div class="display">\n    <div class="hours">\n      <input type="text" value="00" maxlength="2">\n    </div>\n    <span class="time-separator">:</span>\n    <div class="minutes">\n      <input type="text" value="00" maxlength="2">\n    </div>\n    <span class="time-separator">:</span>\n    <div class="seconds">\n      <input type="text" value="00" maxlength="2">\n    </div>\n  </div>\n  <button class="reset">Reset</button>\n  <button class="start">Start</button>\n  <button class="alarm">Alarm</button>\n  <div class="alarm-options"></div>\n</div>\n'},useData:!0}),"a5.view.dialog.CountdownSetupAlarm":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="countdown-setup-alarm">\n</div>\n'},useData:!0}),"a5.book.annotations.Link":Handlebars.template({1:function(container,depth0,helpers,partials,data){return'      <div class="resize-handle"></div>\n'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:container.nullContext||{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return'<div class="content-link">\n  <div class="wrap">\n    <div class="text">\n      '+(null!=(helper=null!=(helper=helpers.text||(null!=depth0?depth0.text:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"text",hash:{},data:data}):helper)?stack1:"")+'\n    </div>\n    <div class="toolbar">\n      <span class="control expander" title="'+alias4((helper=null!=(helper=helpers.expandHint||(null!=depth0?depth0.expandHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"expandHint",hash:{},data:data}):helper))+'"></span>\n      <span class="control handle" title="'+alias4((helper=null!=(helper=helpers.handleHint||(null!=depth0?depth0.handleHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"handleHint",hash:{},data:data}):helper))+'"></span>\n      <span class="control trash" title="'+alias4((helper=null!=(helper=helpers.trashHint||(null!=depth0?depth0.trashHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"trashHint",hash:{},data:data}):helper))+'"</span>\n    </div>\n'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.isResizable:depth0,{name:"if",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+"  </div>\n</div>\n"},useData:!0}),"a5.book.annotations.StickyNote":Handlebars.template({1:function(container,depth0,helpers,partials,data){var stack1,helper;return'      <div class="title">\n        '+(null!=(helper=null!=(helper=helpers.title||(null!=depth0?depth0.title:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:container.nullContext||{},{name:"title",hash:{},data:data}):helper)?stack1:"")+"\n      </div>\n"},3:function(container,depth0,helpers,partials,data){var helper;return'        <span class="control share" title="'+container.escapeExpression((helper=null!=(helper=helpers.shareHint||(null!=depth0?depth0.shareHint:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:container.nullContext||{},{name:"shareHint",hash:{},data:data}):helper))+'"></span>\n'},5:function(container,depth0,helpers,partials,data){var helper;return'        <span class="control trash" title="'+container.escapeExpression((helper=null!=(helper=helpers.trashHint||(null!=depth0?depth0.trashHint:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:container.nullContext||{},{name:"trashHint",hash:{},data:data}):helper))+'"</span>\n'},7:function(container,depth0,helpers,partials,data){var stack1,helper;return'      <div class="lock">'+(null!=(helper=null!=(helper=helpers.lock||(null!=depth0?depth0.lock:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:container.nullContext||{},{name:"lock",hash:{},data:data}):helper)?stack1:"")+"</div>\n"},9:function(container,depth0,helpers,partials,data){var helper;return'      <div class="resize-handle" title="'+container.escapeExpression((helper=null!=(helper=helpers.resizeHint||(null!=depth0?depth0.resizeHint:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:container.nullContext||{},{name:"resizeHint",hash:{},data:data}):helper))+'"></div>\n'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:container.nullContext||{},alias2=helpers.helperMissing;return'<div class="sticky-note">\n  <div class="wrap handle">\n'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.withTitle:depth0,{name:"if",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+'    <div class="text">\n      '+(null!=(helper=null!=(helper=helpers.text||(null!=depth0?depth0.text:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"text",hash:{},data:data}):helper)?stack1:"")+'\n    </div>\n    <div class="toolbar">\n      <span class="control expander" title="'+container.escapeExpression((helper=null!=(helper=helpers.expandHint||(null!=depth0?depth0.expandHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"expandHint",hash:{},data:data}):helper))+'"></span>\n'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.isShareable:depth0,{name:"if",hash:{},fn:container.program(3,data,0),inverse:container.noop,data:data}))?stack1:"")+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.isEditable:depth0,{name:"if",hash:{},fn:container.program(5,data,0),inverse:container.noop,data:data}))?stack1:"")+"    </div>\n"+(null!=(stack1=helpers.unless.call(alias1,null!=depth0?depth0.isEditable:depth0,{name:"unless",hash:{},fn:container.program(7,data,0),inverse:container.noop,data:data}))?stack1:"")+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.isResizable:depth0,{name:"if",hash:{},fn:container.program(9,data,0),inverse:container.noop,data:data}))?stack1:"")+"  </div>\n</div>\n"},useData:!0}),"a5.book.annotations.Text":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:container.nullContext||{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return'<div class="content-text">\n  <div class="wrap">\n    <div class="text">\n      '+(null!=(helper=null!=(helper=helpers.text||(null!=depth0?depth0.text:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"text",hash:{},data:data}):helper)?stack1:"")+'\n    </div>\n    <div class="toolbar">\n      <span class="control handle" title="'+alias4((helper=null!=(helper=helpers.handleHint||(null!=depth0?depth0.handleHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"handleHint",hash:{},data:data}):helper))+'"></span>\n      <span class="control trash" title="'+alias4((helper=null!=(helper=helpers.trashHint||(null!=depth0?depth0.trashHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"trashHint",hash:{},data:data}):helper))+'"></span>\n    </div>\n  </div>\n</div>\n'},useData:!0}),"a5.view.dialog.FlashRequired":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div title="Flash is required">\n  You need the Adobe Flash Player for this activity, download it by clicking the image below.\n  <p>\n    <a href="http://www.adobe.com/go/getflashplayer">\n      <img src="http://www.adobe.com/images/shared/download_buttons/get_flash_player.gif" alt="Get Adobe Flash player"/>\n    </a>\n  </p>\n</div>\n'},useData:!0}),"a5.view.dialog.MicNotFound":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div title="Microphone not found">\n  <p>Please enable a microphone. It is required for this activity.</p>\n</div>\n'},useData:!0}),"a5.view.dialog.RecordingError":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div title="Recording error">\n  <p>A technical error occurred and stopped this recording. Please try again.</p>\n</div>\n'},useData:!0}),"a5.view.dialog.UnsupportedDevice":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div title="Unsupported device">\n  <p>This activity is not supported on this device. Please switch to a desktop device to complete.</p>\n</div>\n'},useData:!0})};