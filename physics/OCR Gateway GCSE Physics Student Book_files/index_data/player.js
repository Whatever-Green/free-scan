!function(window,undefined){var readyList,rootjQuery,core_strundefined=typeof undefined,location=window.location,document=window.document,docElem=document.documentElement,_jQuery=window.jQuery,_$=window.$,class2type={},core_deletedIds=[],core_concat=core_deletedIds.concat,core_push=core_deletedIds.push,core_slice=core_deletedIds.slice,core_indexOf=core_deletedIds.indexOf,core_toString=class2type.toString,core_hasOwn=class2type.hasOwnProperty,core_trim="1.10.2".trim,jQuery=function(selector,context){return new jQuery.fn.init(selector,context,rootjQuery)},core_pnum=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,core_rnotwhite=/\S+/g,rtrim=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,rquickExpr=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,rsingleTag=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,rvalidchars=/^[\],:{}\s]*$/,rvalidbraces=/(?:^|:|,)(?:\s*\[)+/g,rvalidescape=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,rvalidtokens=/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,rmsPrefix=/^-ms-/,rdashAlpha=/-([\da-z])/gi,fcamelCase=function(all,letter){return letter.toUpperCase()},completed=function(event){(document.addEventListener||"load"===event.type||"complete"===document.readyState)&&(detach(),jQuery.ready())},detach=function(){document.addEventListener?(document.removeEventListener("DOMContentLoaded",completed,!1),window.removeEventListener("load",completed,!1)):(document.detachEvent("onreadystatechange",completed),window.detachEvent("onload",completed))};jQuery.fn=jQuery.prototype={jquery:"1.10.2",constructor:jQuery,init:function(selector,context,rootjQuery){var match,elem;if(!selector)return this;if("string"==typeof selector){if(!(match="<"===selector.charAt(0)&&">"===selector.charAt(selector.length-1)&&selector.length>=3?[null,selector,null]:rquickExpr.exec(selector))||!match[1]&&context)return!context||context.jquery?(context||rootjQuery).find(selector):this.constructor(context).find(selector);if(match[1]){if(context=context instanceof jQuery?context[0]:context,jQuery.merge(this,jQuery.parseHTML(match[1],context&&context.nodeType?context.ownerDocument||context:document,!0)),rsingleTag.test(match[1])&&jQuery.isPlainObject(context))for(match in context)jQuery.isFunction(this[match])?this[match](context[match]):this.attr(match,context[match]);return this}if((elem=document.getElementById(match[2]))&&elem.parentNode){if(elem.id!==match[2])return rootjQuery.find(selector);this.length=1,this[0]=elem}return this.context=document,this.selector=selector,this}return selector.nodeType?(this.context=this[0]=selector,this.length=1,this):jQuery.isFunction(selector)?rootjQuery.ready(selector):(selector.selector!==undefined&&(this.selector=selector.selector,this.context=selector.context),jQuery.makeArray(selector,this))},selector:"",length:0,toArray:function(){return core_slice.call(this)},get:function(num){return null==num?this.toArray():num<0?this[this.length+num]:this[num]},pushStack:function(elems){var ret=jQuery.merge(this.constructor(),elems);return ret.prevObject=this,ret.context=this.context,ret},each:function(callback,args){return jQuery.each(this,callback,args)},ready:function(fn){return jQuery.ready.promise().done(fn),this},slice:function(){return this.pushStack(core_slice.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(i){var len=this.length,j=+i+(i<0?len:0);return this.pushStack(j>=0&&j<len?[this[j]]:[])},map:function(callback){return this.pushStack(jQuery.map(this,function(elem,i){return callback.call(elem,i,elem)}))},end:function(){return this.prevObject||this.constructor(null)},push:core_push,sort:[].sort,splice:[].splice},jQuery.fn.init.prototype=jQuery.fn,jQuery.extend=jQuery.fn.extend=function(){var src,copyIsArray,copy,name,options,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=!1;for("boolean"==typeof target&&(deep=target,target=arguments[1]||{},i=2),"object"==typeof target||jQuery.isFunction(target)||(target={}),length===i&&(target=this,--i);i<length;i++)if(null!=(options=arguments[i]))for(name in options)src=target[name],copy=options[name],target!==copy&&(deep&&copy&&(jQuery.isPlainObject(copy)||(copyIsArray=jQuery.isArray(copy)))?(copyIsArray?(copyIsArray=!1,clone=src&&jQuery.isArray(src)?src:[]):clone=src&&jQuery.isPlainObject(src)?src:{},target[name]=jQuery.extend(deep,clone,copy)):copy!==undefined&&(target[name]=copy));return target},jQuery.extend({expando:"jQuery"+("1.10.2"+Math.random()).replace(/\D/g,""),noConflict:function(deep){return window.$===jQuery&&(window.$=_$),deep&&window.jQuery===jQuery&&(window.jQuery=_jQuery),jQuery},isReady:!1,readyWait:1,holdReady:function(hold){hold?jQuery.readyWait++:jQuery.ready(!0)},ready:function(wait){if(!0===wait?!--jQuery.readyWait:!jQuery.isReady){if(!document.body)return setTimeout(jQuery.ready);jQuery.isReady=!0,!0!==wait&&--jQuery.readyWait>0||(readyList.resolveWith(document,[jQuery]),jQuery.fn.trigger&&jQuery(document).trigger("ready").off("ready"))}},isFunction:function(obj){return"function"===jQuery.type(obj)},isArray:Array.isArray||function(obj){return"array"===jQuery.type(obj)},isWindow:function(obj){return null!=obj&&obj==obj.window},isNumeric:function(obj){return!isNaN(parseFloat(obj))&&isFinite(obj)},type:function(obj){return null==obj?String(obj):"object"==typeof obj||"function"==typeof obj?class2type[core_toString.call(obj)]||"object":typeof obj},isPlainObject:function(obj){var key;if(!obj||"object"!==jQuery.type(obj)||obj.nodeType||jQuery.isWindow(obj))return!1;try{if(obj.constructor&&!core_hasOwn.call(obj,"constructor")&&!core_hasOwn.call(obj.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}if(jQuery.support.ownLast)for(key in obj)return core_hasOwn.call(obj,key);for(key in obj);return key===undefined||core_hasOwn.call(obj,key)},isEmptyObject:function(obj){var name;for(name in obj)return!1;return!0},error:function(msg){throw new Error(msg)},parseHTML:function(data,context,keepScripts){if(!data||"string"!=typeof data)return null;"boolean"==typeof context&&(keepScripts=context,context=!1),context=context||document;var parsed=rsingleTag.exec(data),scripts=!keepScripts&&[];return parsed?[context.createElement(parsed[1])]:(parsed=jQuery.buildFragment([data],context,scripts),scripts&&jQuery(scripts).remove(),jQuery.merge([],parsed.childNodes))},parseJSON:function(data){return window.JSON&&window.JSON.parse?window.JSON.parse(data):null===data?data:"string"==typeof data&&(data=jQuery.trim(data))&&rvalidchars.test(data.replace(rvalidescape,"@").replace(rvalidtokens,"]").replace(rvalidbraces,""))?new Function("return "+data)():void jQuery.error("Invalid JSON: "+data)},parseXML:function(data){var xml,tmp;if(!data||"string"!=typeof data)return null;try{window.DOMParser?(tmp=new DOMParser,xml=tmp.parseFromString(data,"text/xml")):(xml=new ActiveXObject("Microsoft.XMLDOM"),xml.async="false",xml.loadXML(data))}catch(e){xml=undefined}return xml&&xml.documentElement&&!xml.getElementsByTagName("parsererror").length||jQuery.error("Invalid XML: "+data),xml},noop:function(){},globalEval:function(data){data&&jQuery.trim(data)&&(window.execScript||function(data){window.eval.call(window,data)})(data)},camelCase:function(string){return string.replace(rmsPrefix,"ms-").replace(rdashAlpha,fcamelCase)},nodeName:function(elem,name){return elem.nodeName&&elem.nodeName.toLowerCase()===name.toLowerCase()},each:function(obj,callback,args){var i=0,length=obj.length,isArray=isArraylike(obj);if(args){if(isArray)for(;i<length&&!1!==callback.apply(obj[i],args);i++);else for(i in obj)if(!1===callback.apply(obj[i],args))break}else if(isArray)for(;i<length&&!1!==callback.call(obj[i],i,obj[i]);i++);else for(i in obj)if(!1===callback.call(obj[i],i,obj[i]))break;return obj},trim:core_trim&&!core_trim.call("\ufeffÂ ")?function(text){return null==text?"":core_trim.call(text)}:function(text){return null==text?"":(text+"").replace(rtrim,"")},makeArray:function(arr,results){var ret=results||[];return null!=arr&&(isArraylike(Object(arr))?jQuery.merge(ret,"string"==typeof arr?[arr]:arr):core_push.call(ret,arr)),ret},inArray:function(elem,arr,i){var len;if(arr){if(core_indexOf)return core_indexOf.call(arr,elem,i);for(len=arr.length,i=i?i<0?Math.max(0,len+i):i:0;i<len;i++)if(i in arr&&arr[i]===elem)return i}return-1},merge:function(first,second){var l=second.length,i=first.length,j=0;if("number"==typeof l)for(;j<l;j++)first[i++]=second[j];else for(;second[j]!==undefined;)first[i++]=second[j++];return first.length=i,first},grep:function(elems,callback,inv){var retVal,ret=[],i=0,length=elems.length;for(inv=!!inv;i<length;i++)retVal=!!callback(elems[i],i),inv!==retVal&&ret.push(elems[i]);return ret},map:function(elems,callback,arg){var value,i=0,length=elems.length,isArray=isArraylike(elems),ret=[];if(isArray)for(;i<length;i++)null!=(value=callback(elems[i],i,arg))&&(ret[ret.length]=value);else for(i in elems)null!=(value=callback(elems[i],i,arg))&&(ret[ret.length]=value);return core_concat.apply([],ret)},guid:1,proxy:function(fn,context){var args,proxy,tmp;return"string"==typeof context&&(tmp=fn[context],context=fn,fn=tmp),jQuery.isFunction(fn)?(args=core_slice.call(arguments,2),proxy=function(){return fn.apply(context||this,args.concat(core_slice.call(arguments)))},proxy.guid=fn.guid=fn.guid||jQuery.guid++,proxy):undefined},access:function(elems,fn,key,value,chainable,emptyGet,raw){var i=0,length=elems.length,bulk=null==key;if("object"===jQuery.type(key)){chainable=!0;for(i in key)jQuery.access(elems,fn,i,key[i],!0,emptyGet,raw)}else if(value!==undefined&&(chainable=!0,jQuery.isFunction(value)||(raw=!0),bulk&&(raw?(fn.call(elems,value),fn=null):(bulk=fn,fn=function(elem,key,value){return bulk.call(jQuery(elem),value)})),fn))for(;i<length;i++)fn(elems[i],key,raw?value:value.call(elems[i],i,fn(elems[i],key)));return chainable?elems:bulk?fn.call(elems):length?fn(elems[0],key):emptyGet},now:function(){return(new Date).getTime()},swap:function(elem,options,callback,args){var ret,name,old={};for(name in options)old[name]=elem.style[name],elem.style[name]=options[name];ret=callback.apply(elem,args||[]);for(name in options)elem.style[name]=old[name];return ret}}),jQuery.ready.promise=function(obj){if(!readyList)if(readyList=jQuery.Deferred(),"complete"===document.readyState)setTimeout(jQuery.ready);else if(document.addEventListener)document.addEventListener("DOMContentLoaded",completed,!1),window.addEventListener("load",completed,!1);else{document.attachEvent("onreadystatechange",completed),window.attachEvent("onload",completed);var top=!1;try{top=null==window.frameElement&&document.documentElement}catch(e){}top&&top.doScroll&&function doScrollCheck(){if(!jQuery.isReady){try{top.doScroll("left")}catch(e){return setTimeout(doScrollCheck,50)}detach(),jQuery.ready()}}()}return readyList.promise(obj)},jQuery.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(i,name){class2type["[object "+name+"]"]=name.toLowerCase()});function isArraylike(obj){var length=obj.length,type=jQuery.type(obj);return!jQuery.isWindow(obj)&&(!(1!==obj.nodeType||!length)||("array"===type||"function"!==type&&(0===length||"number"==typeof length&&length>0&&length-1 in obj)))}rootjQuery=jQuery(document),function(window,undefined){var i,support,cachedruns,Expr,getText,isXML,compile,outermostContext,sortInput,setDocument,document,docElem,documentIsHTML,rbuggyQSA,rbuggyMatches,matches,contains,expando="sizzle"+-new Date,preferredDoc=window.document,dirruns=0,done=0,classCache=createCache(),tokenCache=createCache(),compilerCache=createCache(),hasDuplicate=!1,sortOrder=function(a,b){return a===b?(hasDuplicate=!0,0):0},MAX_NEGATIVE=1<<31,hasOwn={}.hasOwnProperty,arr=[],pop=arr.pop,push_native=arr.push,push=arr.push,slice=arr.slice,indexOf=arr.indexOf||function(elem){for(var i=0,len=this.length;i<len;i++)if(this[i]===elem)return i;return-1},booleans="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",whitespace="[\\x20\\t\\r\\n\\f]",characterEncoding="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",identifier=characterEncoding.replace("w","w#"),attributes="\\["+whitespace+"*("+characterEncoding+")"+whitespace+"*(?:([*^$|!~]?=)"+whitespace+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+identifier+")|)|)"+whitespace+"*\\]",pseudos=":("+characterEncoding+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+attributes.replace(3,8)+")*)|.*)\\)|)",rtrim=new RegExp("^"+whitespace+"+|((?:^|[^\\\\])(?:\\\\.)*)"+whitespace+"+$","g"),rcomma=new RegExp("^"+whitespace+"*,"+whitespace+"*"),rcombinators=new RegExp("^"+whitespace+"*([>+~]|"+whitespace+")"+whitespace+"*"),rsibling=new RegExp(whitespace+"*[+~]"),rattributeQuotes=new RegExp("="+whitespace+"*([^\\]'\"]*)"+whitespace+"*\\]","g"),rpseudo=new RegExp(pseudos),ridentifier=new RegExp("^"+identifier+"$"),matchExpr={ID:new RegExp("^#("+characterEncoding+")"),CLASS:new RegExp("^\\.("+characterEncoding+")"),TAG:new RegExp("^("+characterEncoding.replace("w","w*")+")"),ATTR:new RegExp("^"+attributes),PSEUDO:new RegExp("^"+pseudos),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+whitespace+"*(even|odd|(([+-]|)(\\d*)n|)"+whitespace+"*(?:([+-]|)"+whitespace+"*(\\d+)|))"+whitespace+"*\\)|)","i"),bool:new RegExp("^(?:"+booleans+")$","i"),needsContext:new RegExp("^"+whitespace+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+whitespace+"*((?:-\\d)?\\d*)"+whitespace+"*\\)|)(?=[^-]|$)","i")},rnative=/^[^{]+\{\s*\[native \w/,rquickExpr=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,rinputs=/^(?:input|select|textarea|button)$/i,rheader=/^h\d$/i,rescape=/'|\\/g,runescape=new RegExp("\\\\([\\da-f]{1,6}"+whitespace+"?|("+whitespace+")|.)","ig"),funescape=function(_,escaped,escapedWhitespace){var high="0x"+escaped-65536;return high!==high||escapedWhitespace?escaped:high<0?String.fromCharCode(high+65536):String.fromCharCode(high>>10|55296,1023&high|56320)};try{push.apply(arr=slice.call(preferredDoc.childNodes),preferredDoc.childNodes),arr[preferredDoc.childNodes.length].nodeType}catch(e){push={apply:arr.length?function(target,els){push_native.apply(target,slice.call(els))}:function(target,els){for(var j=target.length,i=0;target[j++]=els[i++];);target.length=j-1}}}function Sizzle(selector,context,results,seed){var match,elem,m,nodeType,i,groups,old,nid,newContext,newSelector;if((context?context.ownerDocument||context:preferredDoc)!==document&&setDocument(context),context=context||document,results=results||[],!selector||"string"!=typeof selector)return results;if(1!==(nodeType=context.nodeType)&&9!==nodeType)return[];if(documentIsHTML&&!seed){if(match=rquickExpr.exec(selector))if(m=match[1]){if(9===nodeType){if(!(elem=context.getElementById(m))||!elem.parentNode)return results;if(elem.id===m)return results.push(elem),results}else if(context.ownerDocument&&(elem=context.ownerDocument.getElementById(m))&&contains(context,elem)&&elem.id===m)return results.push(elem),results}else{if(match[2])return push.apply(results,context.getElementsByTagName(selector)),results;if((m=match[3])&&support.getElementsByClassName&&context.getElementsByClassName)return push.apply(results,context.getElementsByClassName(m)),results}if(support.qsa&&(!rbuggyQSA||!rbuggyQSA.test(selector))){if(nid=old=expando,newContext=context,newSelector=9===nodeType&&selector,1===nodeType&&"object"!==context.nodeName.toLowerCase()){for(groups=tokenize(selector),(old=context.getAttribute("id"))?nid=old.replace(rescape,"\\$&"):context.setAttribute("id",nid),nid="[id='"+nid+"'] ",i=groups.length;i--;)groups[i]=nid+toSelector(groups[i]);newContext=rsibling.test(selector)&&context.parentNode||context,newSelector=groups.join(",")}if(newSelector)try{return push.apply(results,newContext.querySelectorAll(newSelector)),results}catch(qsaError){}finally{old||context.removeAttribute("id")}}}return select(selector.replace(rtrim,"$1"),context,results,seed)}function createCache(){var keys=[];function cache(key,value){return keys.push(key+=" ")>Expr.cacheLength&&delete cache[keys.shift()],cache[key]=value}return cache}function markFunction(fn){return fn[expando]=!0,fn}function assert(fn){var div=document.createElement("div");try{return!!fn(div)}catch(e){return!1}finally{div.parentNode&&div.parentNode.removeChild(div),div=null}}function addHandle(attrs,handler){for(var arr=attrs.split("|"),i=attrs.length;i--;)Expr.attrHandle[arr[i]]=handler}function siblingCheck(a,b){var cur=b&&a,diff=cur&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||MAX_NEGATIVE)-(~a.sourceIndex||MAX_NEGATIVE);if(diff)return diff;if(cur)for(;cur=cur.nextSibling;)if(cur===b)return-1;return a?1:-1}function createPositionalPseudo(fn){return markFunction(function(argument){return argument=+argument,markFunction(function(seed,matches){for(var j,matchIndexes=fn([],seed.length,argument),i=matchIndexes.length;i--;)seed[j=matchIndexes[i]]&&(seed[j]=!(matches[j]=seed[j]))})})}isXML=Sizzle.isXML=function(elem){var documentElement=elem&&(elem.ownerDocument||elem).documentElement;return!!documentElement&&"HTML"!==documentElement.nodeName},support=Sizzle.support={},setDocument=Sizzle.setDocument=function(node){var doc=node?node.ownerDocument||node:preferredDoc,parent=doc.defaultView;return doc!==document&&9===doc.nodeType&&doc.documentElement?(document=doc,docElem=doc.documentElement,documentIsHTML=!isXML(doc),parent&&parent.attachEvent&&parent!==parent.top&&parent.attachEvent("onbeforeunload",function(){setDocument()}),support.attributes=assert(function(div){return div.className="i",!div.getAttribute("className")}),support.getElementsByTagName=assert(function(div){return div.appendChild(doc.createComment("")),!div.getElementsByTagName("*").length}),support.getElementsByClassName=assert(function(div){return div.innerHTML="<div class='a'></div><div class='a i'></div>",div.firstChild.className="i",2===div.getElementsByClassName("i").length}),support.getById=assert(function(div){return docElem.appendChild(div).id=expando,!doc.getElementsByName||!doc.getElementsByName(expando).length}),support.getById?(Expr.find.ID=function(id,context){if(void 0!==context.getElementById&&documentIsHTML){var m=context.getElementById(id);return m&&m.parentNode?[m]:[]}},Expr.filter.ID=function(id){var attrId=id.replace(runescape,funescape);return function(elem){return elem.getAttribute("id")===attrId}}):(delete Expr.find.ID,Expr.filter.ID=function(id){var attrId=id.replace(runescape,funescape);return function(elem){var node=void 0!==elem.getAttributeNode&&elem.getAttributeNode("id");return node&&node.value===attrId}}),Expr.find.TAG=support.getElementsByTagName?function(tag,context){if(void 0!==context.getElementsByTagName)return context.getElementsByTagName(tag)}:function(tag,context){var elem,tmp=[],i=0,results=context.getElementsByTagName(tag);if("*"===tag){for(;elem=results[i++];)1===elem.nodeType&&tmp.push(elem);return tmp}return results},Expr.find.CLASS=support.getElementsByClassName&&function(className,context){if(void 0!==context.getElementsByClassName&&documentIsHTML)return context.getElementsByClassName(className)},rbuggyMatches=[],rbuggyQSA=[],(support.qsa=rnative.test(doc.querySelectorAll))&&(assert(function(div){div.innerHTML="<select><option selected=''></option></select>",div.querySelectorAll("[selected]").length||rbuggyQSA.push("\\["+whitespace+"*(?:value|"+booleans+")"),div.querySelectorAll(":checked").length||rbuggyQSA.push(":checked")}),assert(function(div){var input=doc.createElement("input");input.setAttribute("type","hidden"),div.appendChild(input).setAttribute("t",""),div.querySelectorAll("[t^='']").length&&rbuggyQSA.push("[*^$]="+whitespace+"*(?:''|\"\")"),div.querySelectorAll(":enabled").length||rbuggyQSA.push(":enabled",":disabled"),div.querySelectorAll("*,:x"),rbuggyQSA.push(",.*:")})),(support.matchesSelector=rnative.test(matches=docElem.webkitMatchesSelector||docElem.mozMatchesSelector||docElem.oMatchesSelector||docElem.msMatchesSelector))&&assert(function(div){support.disconnectedMatch=matches.call(div,"div"),matches.call(div,"[s!='']:x"),rbuggyMatches.push("!=",pseudos)}),rbuggyQSA=rbuggyQSA.length&&new RegExp(rbuggyQSA.join("|")),rbuggyMatches=rbuggyMatches.length&&new RegExp(rbuggyMatches.join("|")),contains=rnative.test(docElem.contains)||docElem.compareDocumentPosition?function(a,b){var adown=9===a.nodeType?a.documentElement:a,bup=b&&b.parentNode;return a===bup||!(!bup||1!==bup.nodeType||!(adown.contains?adown.contains(bup):a.compareDocumentPosition&&16&a.compareDocumentPosition(bup)))}:function(a,b){if(b)for(;b=b.parentNode;)if(b===a)return!0;return!1},sortOrder=docElem.compareDocumentPosition?function(a,b){if(a===b)return hasDuplicate=!0,0;var compare=b.compareDocumentPosition&&a.compareDocumentPosition&&a.compareDocumentPosition(b);return compare?1&compare||!support.sortDetached&&b.compareDocumentPosition(a)===compare?a===doc||contains(preferredDoc,a)?-1:b===doc||contains(preferredDoc,b)?1:sortInput?indexOf.call(sortInput,a)-indexOf.call(sortInput,b):0:4&compare?-1:1:a.compareDocumentPosition?-1:1}:function(a,b){var cur,i=0,aup=a.parentNode,bup=b.parentNode,ap=[a],bp=[b];if(a===b)return hasDuplicate=!0,0;if(!aup||!bup)return a===doc?-1:b===doc?1:aup?-1:bup?1:sortInput?indexOf.call(sortInput,a)-indexOf.call(sortInput,b):0;if(aup===bup)return siblingCheck(a,b);for(cur=a;cur=cur.parentNode;)ap.unshift(cur);for(cur=b;cur=cur.parentNode;)bp.unshift(cur);for(;ap[i]===bp[i];)i++;return i?siblingCheck(ap[i],bp[i]):ap[i]===preferredDoc?-1:bp[i]===preferredDoc?1:0},doc):document},Sizzle.matches=function(expr,elements){return Sizzle(expr,null,null,elements)},Sizzle.matchesSelector=function(elem,expr){if((elem.ownerDocument||elem)!==document&&setDocument(elem),expr=expr.replace(rattributeQuotes,"='$1']"),support.matchesSelector&&documentIsHTML&&(!rbuggyMatches||!rbuggyMatches.test(expr))&&(!rbuggyQSA||!rbuggyQSA.test(expr)))try{var ret=matches.call(elem,expr);if(ret||support.disconnectedMatch||elem.document&&11!==elem.document.nodeType)return ret}catch(e){}return Sizzle(expr,document,null,[elem]).length>0},Sizzle.contains=function(context,elem){return(context.ownerDocument||context)!==document&&setDocument(context),contains(context,elem)},Sizzle.attr=function(elem,name){(elem.ownerDocument||elem)!==document&&setDocument(elem);var fn=Expr.attrHandle[name.toLowerCase()],val=fn&&hasOwn.call(Expr.attrHandle,name.toLowerCase())?fn(elem,name,!documentIsHTML):void 0;return void 0===val?support.attributes||!documentIsHTML?elem.getAttribute(name):(val=elem.getAttributeNode(name))&&val.specified?val.value:null:val},Sizzle.error=function(msg){throw new Error("Syntax error, unrecognized expression: "+msg)},Sizzle.uniqueSort=function(results){var elem,duplicates=[],j=0,i=0;if(hasDuplicate=!support.detectDuplicates,sortInput=!support.sortStable&&results.slice(0),results.sort(sortOrder),hasDuplicate){for(;elem=results[i++];)elem===results[i]&&(j=duplicates.push(i));for(;j--;)results.splice(duplicates[j],1)}return results},getText=Sizzle.getText=function(elem){var node,ret="",i=0,nodeType=elem.nodeType;if(nodeType){if(1===nodeType||9===nodeType||11===nodeType){if("string"==typeof elem.textContent)return elem.textContent;for(elem=elem.firstChild;elem;elem=elem.nextSibling)ret+=getText(elem)}else if(3===nodeType||4===nodeType)return elem.nodeValue}else for(;node=elem[i];i++)ret+=getText(node);return ret},Expr=Sizzle.selectors={cacheLength:50,createPseudo:markFunction,match:matchExpr,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(match){return match[1]=match[1].replace(runescape,funescape),match[3]=(match[4]||match[5]||"").replace(runescape,funescape),"~="===match[2]&&(match[3]=" "+match[3]+" "),match.slice(0,4)},CHILD:function(match){return match[1]=match[1].toLowerCase(),"nth"===match[1].slice(0,3)?(match[3]||Sizzle.error(match[0]),match[4]=+(match[4]?match[5]+(match[6]||1):2*("even"===match[3]||"odd"===match[3])),match[5]=+(match[7]+match[8]||"odd"===match[3])):match[3]&&Sizzle.error(match[0]),match},PSEUDO:function(match){var excess,unquoted=!match[5]&&match[2];return matchExpr.CHILD.test(match[0])?null:(match[3]&&void 0!==match[4]?match[2]=match[4]:unquoted&&rpseudo.test(unquoted)&&(excess=tokenize(unquoted,!0))&&(excess=unquoted.indexOf(")",unquoted.length-excess)-unquoted.length)&&(match[0]=match[0].slice(0,excess),match[2]=unquoted.slice(0,excess)),match.slice(0,3))}},filter:{TAG:function(nodeNameSelector){var nodeName=nodeNameSelector.replace(runescape,funescape).toLowerCase();return"*"===nodeNameSelector?function(){return!0}:function(elem){return elem.nodeName&&elem.nodeName.toLowerCase()===nodeName}},CLASS:function(className){var pattern=classCache[className+" "];return pattern||(pattern=new RegExp("(^|"+whitespace+")"+className+"("+whitespace+"|$)"))&&classCache(className,function(elem){return pattern.test("string"==typeof elem.className&&elem.className||void 0!==elem.getAttribute&&elem.getAttribute("class")||"")})},ATTR:function(name,operator,check){return function(elem){var result=Sizzle.attr(elem,name);return null==result?"!="===operator:!operator||(result+="","="===operator?result===check:"!="===operator?result!==check:"^="===operator?check&&0===result.indexOf(check):"*="===operator?check&&result.indexOf(check)>-1:"$="===operator?check&&result.slice(-check.length)===check:"~="===operator?(" "+result+" ").indexOf(check)>-1:"|="===operator&&(result===check||result.slice(0,check.length+1)===check+"-"))}},CHILD:function(type,what,argument,first,last){var simple="nth"!==type.slice(0,3),forward="last"!==type.slice(-4),ofType="of-type"===what;return 1===first&&0===last?function(elem){return!!elem.parentNode}:function(elem,context,xml){var cache,outerCache,node,diff,nodeIndex,start,dir=simple!==forward?"nextSibling":"previousSibling",parent=elem.parentNode,name=ofType&&elem.nodeName.toLowerCase(),useCache=!xml&&!ofType;if(parent){if(simple){for(;dir;){for(node=elem;node=node[dir];)if(ofType?node.nodeName.toLowerCase()===name:1===node.nodeType)return!1;start=dir="only"===type&&!start&&"nextSibling"}return!0}if(start=[forward?parent.firstChild:parent.lastChild],forward&&useCache){for(outerCache=parent[expando]||(parent[expando]={}),cache=outerCache[type]||[],nodeIndex=cache[0]===dirruns&&cache[1],diff=cache[0]===dirruns&&cache[2],node=nodeIndex&&parent.childNodes[nodeIndex];node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop();)if(1===node.nodeType&&++diff&&node===elem){outerCache[type]=[dirruns,nodeIndex,diff];break}}else if(useCache&&(cache=(elem[expando]||(elem[expando]={}))[type])&&cache[0]===dirruns)diff=cache[1];else for(;(node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop())&&((ofType?node.nodeName.toLowerCase()!==name:1!==node.nodeType)||!++diff||(useCache&&((node[expando]||(node[expando]={}))[type]=[dirruns,diff]),node!==elem)););return(diff-=last)===first||diff%first==0&&diff/first>=0}}},PSEUDO:function(pseudo,argument){var args,fn=Expr.pseudos[pseudo]||Expr.setFilters[pseudo.toLowerCase()]||Sizzle.error("unsupported pseudo: "+pseudo);return fn[expando]?fn(argument):fn.length>1?(args=[pseudo,pseudo,"",argument],Expr.setFilters.hasOwnProperty(pseudo.toLowerCase())?markFunction(function(seed,matches){for(var idx,matched=fn(seed,argument),i=matched.length;i--;)idx=indexOf.call(seed,matched[i]),seed[idx]=!(matches[idx]=matched[i])}):function(elem){return fn(elem,0,args)}):fn}},pseudos:{not:markFunction(function(selector){var input=[],results=[],matcher=compile(selector.replace(rtrim,"$1"));return matcher[expando]?markFunction(function(seed,matches,context,xml){for(var elem,unmatched=matcher(seed,null,xml,[]),i=seed.length;i--;)(elem=unmatched[i])&&(seed[i]=!(matches[i]=elem))}):function(elem,context,xml){return input[0]=elem,matcher(input,null,xml,results),!results.pop()}}),has:markFunction(function(selector){return function(elem){return Sizzle(selector,elem).length>0}}),contains:markFunction(function(text){return function(elem){return(elem.textContent||elem.innerText||getText(elem)).indexOf(text)>-1}}),lang:markFunction(function(lang){return ridentifier.test(lang||"")||Sizzle.error("unsupported lang: "+lang),lang=lang.replace(runescape,funescape).toLowerCase(),function(elem){var elemLang;do{if(elemLang=documentIsHTML?elem.lang:elem.getAttribute("xml:lang")||elem.getAttribute("lang"))return(elemLang=elemLang.toLowerCase())===lang||0===elemLang.indexOf(lang+"-")}while((elem=elem.parentNode)&&1===elem.nodeType);return!1}}),target:function(elem){var hash=window.location&&window.location.hash;return hash&&hash.slice(1)===elem.id},root:function(elem){return elem===docElem},focus:function(elem){return elem===document.activeElement&&(!document.hasFocus||document.hasFocus())&&!!(elem.type||elem.href||~elem.tabIndex)},enabled:function(elem){return!1===elem.disabled},disabled:function(elem){return!0===elem.disabled},checked:function(elem){var nodeName=elem.nodeName.toLowerCase();return"input"===nodeName&&!!elem.checked||"option"===nodeName&&!!elem.selected},selected:function(elem){return elem.parentNode&&elem.parentNode.selectedIndex,!0===elem.selected},empty:function(elem){for(elem=elem.firstChild;elem;elem=elem.nextSibling)if(elem.nodeName>"@"||3===elem.nodeType||4===elem.nodeType)return!1;return!0},parent:function(elem){return!Expr.pseudos.empty(elem)},header:function(elem){return rheader.test(elem.nodeName)},input:function(elem){return rinputs.test(elem.nodeName)},button:function(elem){var name=elem.nodeName.toLowerCase();return"input"===name&&"button"===elem.type||"button"===name},text:function(elem){var attr;return"input"===elem.nodeName.toLowerCase()&&"text"===elem.type&&(null==(attr=elem.getAttribute("type"))||attr.toLowerCase()===elem.type)},first:createPositionalPseudo(function(){return[0]}),last:createPositionalPseudo(function(matchIndexes,length){return[length-1]}),eq:createPositionalPseudo(function(matchIndexes,length,argument){return[argument<0?argument+length:argument]}),even:createPositionalPseudo(function(matchIndexes,length){for(var i=0;i<length;i+=2)matchIndexes.push(i);return matchIndexes}),odd:createPositionalPseudo(function(matchIndexes,length){for(var i=1;i<length;i+=2)matchIndexes.push(i);return matchIndexes}),lt:createPositionalPseudo(function(matchIndexes,length,argument){for(var i=argument<0?argument+length:argument;--i>=0;)matchIndexes.push(i);return matchIndexes}),gt:createPositionalPseudo(function(matchIndexes,length,argument){for(var i=argument<0?argument+length:argument;++i<length;)matchIndexes.push(i);return matchIndexes})}},Expr.pseudos.nth=Expr.pseudos.eq;for(i in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})Expr.pseudos[i]=function(type){return function(elem){return"input"===elem.nodeName.toLowerCase()&&elem.type===type}}(i);for(i in{submit:!0,reset:!0})Expr.pseudos[i]=function(type){return function(elem){var name=elem.nodeName.toLowerCase();return("input"===name||"button"===name)&&elem.type===type}}(i);function setFilters(){}setFilters.prototype=Expr.filters=Expr.pseudos,Expr.setFilters=new setFilters;function tokenize(selector,parseOnly){var matched,match,tokens,type,soFar,groups,preFilters,cached=tokenCache[selector+" "];if(cached)return parseOnly?0:cached.slice(0);for(soFar=selector,groups=[],preFilters=Expr.preFilter;soFar;){matched&&!(match=rcomma.exec(soFar))||(match&&(soFar=soFar.slice(match[0].length)||soFar),groups.push(tokens=[])),matched=!1,(match=rcombinators.exec(soFar))&&(matched=match.shift(),tokens.push({value:matched,type:match[0].replace(rtrim," ")}),soFar=soFar.slice(matched.length));for(type in Expr.filter)!(match=matchExpr[type].exec(soFar))||preFilters[type]&&!(match=preFilters[type](match))||(matched=match.shift(),tokens.push({value:matched,type:type,matches:match}),soFar=soFar.slice(matched.length));if(!matched)break}return parseOnly?soFar.length:soFar?Sizzle.error(selector):tokenCache(selector,groups).slice(0)}function toSelector(tokens){
for(var i=0,len=tokens.length,selector="";i<len;i++)selector+=tokens[i].value;return selector}function addCombinator(matcher,combinator,base){var dir=combinator.dir,checkNonElements=base&&"parentNode"===dir,doneName=done++;return combinator.first?function(elem,context,xml){for(;elem=elem[dir];)if(1===elem.nodeType||checkNonElements)return matcher(elem,context,xml)}:function(elem,context,xml){var data,cache,outerCache,dirkey=dirruns+" "+doneName;if(xml){for(;elem=elem[dir];)if((1===elem.nodeType||checkNonElements)&&matcher(elem,context,xml))return!0}else for(;elem=elem[dir];)if(1===elem.nodeType||checkNonElements)if(outerCache=elem[expando]||(elem[expando]={}),(cache=outerCache[dir])&&cache[0]===dirkey){if(!0===(data=cache[1])||data===cachedruns)return!0===data}else if(cache=outerCache[dir]=[dirkey],cache[1]=matcher(elem,context,xml)||cachedruns,!0===cache[1])return!0}}function elementMatcher(matchers){return matchers.length>1?function(elem,context,xml){for(var i=matchers.length;i--;)if(!matchers[i](elem,context,xml))return!1;return!0}:matchers[0]}function condense(unmatched,map,filter,context,xml){for(var elem,newUnmatched=[],i=0,len=unmatched.length,mapped=null!=map;i<len;i++)(elem=unmatched[i])&&(filter&&!filter(elem,context,xml)||(newUnmatched.push(elem),mapped&&map.push(i)));return newUnmatched}function setMatcher(preFilter,selector,matcher,postFilter,postFinder,postSelector){return postFilter&&!postFilter[expando]&&(postFilter=setMatcher(postFilter)),postFinder&&!postFinder[expando]&&(postFinder=setMatcher(postFinder,postSelector)),markFunction(function(seed,results,context,xml){var temp,i,elem,preMap=[],postMap=[],preexisting=results.length,elems=seed||multipleContexts(selector||"*",context.nodeType?[context]:context,[]),matcherIn=!preFilter||!seed&&selector?elems:condense(elems,preMap,preFilter,context,xml),matcherOut=matcher?postFinder||(seed?preFilter:preexisting||postFilter)?[]:results:matcherIn;if(matcher&&matcher(matcherIn,matcherOut,context,xml),postFilter)for(temp=condense(matcherOut,postMap),postFilter(temp,[],context,xml),i=temp.length;i--;)(elem=temp[i])&&(matcherOut[postMap[i]]=!(matcherIn[postMap[i]]=elem));if(seed){if(postFinder||preFilter){if(postFinder){for(temp=[],i=matcherOut.length;i--;)(elem=matcherOut[i])&&temp.push(matcherIn[i]=elem);postFinder(null,matcherOut=[],temp,xml)}for(i=matcherOut.length;i--;)(elem=matcherOut[i])&&(temp=postFinder?indexOf.call(seed,elem):preMap[i])>-1&&(seed[temp]=!(results[temp]=elem))}}else matcherOut=condense(matcherOut===results?matcherOut.splice(preexisting,matcherOut.length):matcherOut),postFinder?postFinder(null,results,matcherOut,xml):push.apply(results,matcherOut)})}function matcherFromTokens(tokens){for(var checkContext,matcher,j,len=tokens.length,leadingRelative=Expr.relative[tokens[0].type],implicitRelative=leadingRelative||Expr.relative[" "],i=leadingRelative?1:0,matchContext=addCombinator(function(elem){return elem===checkContext},implicitRelative,!0),matchAnyContext=addCombinator(function(elem){return indexOf.call(checkContext,elem)>-1},implicitRelative,!0),matchers=[function(elem,context,xml){return!leadingRelative&&(xml||context!==outermostContext)||((checkContext=context).nodeType?matchContext(elem,context,xml):matchAnyContext(elem,context,xml))}];i<len;i++)if(matcher=Expr.relative[tokens[i].type])matchers=[addCombinator(elementMatcher(matchers),matcher)];else{if(matcher=Expr.filter[tokens[i].type].apply(null,tokens[i].matches),matcher[expando]){for(j=++i;j<len&&!Expr.relative[tokens[j].type];j++);return setMatcher(i>1&&elementMatcher(matchers),i>1&&toSelector(tokens.slice(0,i-1).concat({value:" "===tokens[i-2].type?"*":""})).replace(rtrim,"$1"),matcher,i<j&&matcherFromTokens(tokens.slice(i,j)),j<len&&matcherFromTokens(tokens=tokens.slice(j)),j<len&&toSelector(tokens))}matchers.push(matcher)}return elementMatcher(matchers)}function matcherFromGroupMatchers(elementMatchers,setMatchers){var matcherCachedRuns=0,bySet=setMatchers.length>0,byElement=elementMatchers.length>0,superMatcher=function(seed,context,xml,results,expandContext){var elem,j,matcher,setMatched=[],matchedCount=0,i="0",unmatched=seed&&[],outermost=null!=expandContext,contextBackup=outermostContext,elems=seed||byElement&&Expr.find.TAG("*",expandContext&&context.parentNode||context),dirrunsUnique=dirruns+=null==contextBackup?1:Math.random()||.1;for(outermost&&(outermostContext=context!==document&&context,cachedruns=matcherCachedRuns);null!=(elem=elems[i]);i++){if(byElement&&elem){for(j=0;matcher=elementMatchers[j++];)if(matcher(elem,context,xml)){results.push(elem);break}outermost&&(dirruns=dirrunsUnique,cachedruns=++matcherCachedRuns)}bySet&&((elem=!matcher&&elem)&&matchedCount--,seed&&unmatched.push(elem))}if(matchedCount+=i,bySet&&i!==matchedCount){for(j=0;matcher=setMatchers[j++];)matcher(unmatched,setMatched,context,xml);if(seed){if(matchedCount>0)for(;i--;)unmatched[i]||setMatched[i]||(setMatched[i]=pop.call(results));setMatched=condense(setMatched)}push.apply(results,setMatched),outermost&&!seed&&setMatched.length>0&&matchedCount+setMatchers.length>1&&Sizzle.uniqueSort(results)}return outermost&&(dirruns=dirrunsUnique,outermostContext=contextBackup),unmatched};return bySet?markFunction(superMatcher):superMatcher}compile=Sizzle.compile=function(selector,group){var i,setMatchers=[],elementMatchers=[],cached=compilerCache[selector+" "];if(!cached){for(group||(group=tokenize(selector)),i=group.length;i--;)cached=matcherFromTokens(group[i]),cached[expando]?setMatchers.push(cached):elementMatchers.push(cached);cached=compilerCache(selector,matcherFromGroupMatchers(elementMatchers,setMatchers))}return cached};function multipleContexts(selector,contexts,results){for(var i=0,len=contexts.length;i<len;i++)Sizzle(selector,contexts[i],results);return results}function select(selector,context,results,seed){var i,tokens,token,type,find,match=tokenize(selector);if(!seed&&1===match.length){if(tokens=match[0]=match[0].slice(0),tokens.length>2&&"ID"===(token=tokens[0]).type&&support.getById&&9===context.nodeType&&documentIsHTML&&Expr.relative[tokens[1].type]){if(!(context=(Expr.find.ID(token.matches[0].replace(runescape,funescape),context)||[])[0]))return results;selector=selector.slice(tokens.shift().value.length)}for(i=matchExpr.needsContext.test(selector)?0:tokens.length;i--&&(token=tokens[i],!Expr.relative[type=token.type]);)if((find=Expr.find[type])&&(seed=find(token.matches[0].replace(runescape,funescape),rsibling.test(tokens[0].type)&&context.parentNode||context))){if(tokens.splice(i,1),!(selector=seed.length&&toSelector(tokens)))return push.apply(results,seed),results;break}}return compile(selector,match)(seed,context,!documentIsHTML,results,rsibling.test(selector)),results}support.sortStable=expando.split("").sort(sortOrder).join("")===expando,support.detectDuplicates=hasDuplicate,setDocument(),support.sortDetached=assert(function(div1){return 1&div1.compareDocumentPosition(document.createElement("div"))}),assert(function(div){return div.innerHTML="<a href='#'></a>","#"===div.firstChild.getAttribute("href")})||addHandle("type|href|height|width",function(elem,name,isXML){if(!isXML)return elem.getAttribute(name,"type"===name.toLowerCase()?1:2)}),support.attributes&&assert(function(div){return div.innerHTML="<input/>",div.firstChild.setAttribute("value",""),""===div.firstChild.getAttribute("value")})||addHandle("value",function(elem,name,isXML){if(!isXML&&"input"===elem.nodeName.toLowerCase())return elem.defaultValue}),assert(function(div){return null==div.getAttribute("disabled")})||addHandle(booleans,function(elem,name,isXML){var val;if(!isXML)return(val=elem.getAttributeNode(name))&&val.specified?val.value:!0===elem[name]?name.toLowerCase():null}),jQuery.find=Sizzle,jQuery.expr=Sizzle.selectors,jQuery.expr[":"]=jQuery.expr.pseudos,jQuery.unique=Sizzle.uniqueSort,jQuery.text=Sizzle.getText,jQuery.isXMLDoc=Sizzle.isXML,jQuery.contains=Sizzle.contains}(window);var optionsCache={};function createOptions(options){var object=optionsCache[options]={};return jQuery.each(options.match(core_rnotwhite)||[],function(_,flag){object[flag]=!0}),object}jQuery.Callbacks=function(options){options="string"==typeof options?optionsCache[options]||createOptions(options):jQuery.extend({},options);var firing,memory,fired,firingLength,firingIndex,firingStart,list=[],stack=!options.once&&[],fire=function(data){for(memory=options.memory&&data,fired=!0,firingIndex=firingStart||0,firingStart=0,firingLength=list.length,firing=!0;list&&firingIndex<firingLength;firingIndex++)if(!1===list[firingIndex].apply(data[0],data[1])&&options.stopOnFalse){memory=!1;break}firing=!1,list&&(stack?stack.length&&fire(stack.shift()):memory?list=[]:self.disable())},self={add:function(){if(list){var start=list.length;!function add(args){jQuery.each(args,function(_,arg){var type=jQuery.type(arg);"function"===type?options.unique&&self.has(arg)||list.push(arg):arg&&arg.length&&"string"!==type&&add(arg)})}(arguments),firing?firingLength=list.length:memory&&(firingStart=start,fire(memory))}return this},remove:function(){return list&&jQuery.each(arguments,function(_,arg){for(var index;(index=jQuery.inArray(arg,list,index))>-1;)list.splice(index,1),firing&&(index<=firingLength&&firingLength--,index<=firingIndex&&firingIndex--)}),this},has:function(fn){return fn?jQuery.inArray(fn,list)>-1:!(!list||!list.length)},empty:function(){return list=[],firingLength=0,this},disable:function(){return list=stack=memory=undefined,this},disabled:function(){return!list},lock:function(){return stack=undefined,memory||self.disable(),this},locked:function(){return!stack},fireWith:function(context,args){return!list||fired&&!stack||(args=args||[],args=[context,args.slice?args.slice():args],firing?stack.push(args):fire(args)),this},fire:function(){return self.fireWith(this,arguments),this},fired:function(){return!!fired}};return self},jQuery.extend({Deferred:function(func){var tuples=[["resolve","done",jQuery.Callbacks("once memory"),"resolved"],["reject","fail",jQuery.Callbacks("once memory"),"rejected"],["notify","progress",jQuery.Callbacks("memory")]],state="pending",promise={state:function(){return state},always:function(){return deferred.done(arguments).fail(arguments),this},then:function(){var fns=arguments;return jQuery.Deferred(function(newDefer){jQuery.each(tuples,function(i,tuple){var action=tuple[0],fn=jQuery.isFunction(fns[i])&&fns[i];deferred[tuple[1]](function(){var returned=fn&&fn.apply(this,arguments);returned&&jQuery.isFunction(returned.promise)?returned.promise().done(newDefer.resolve).fail(newDefer.reject).progress(newDefer.notify):newDefer[action+"With"](this===promise?newDefer.promise():this,fn?[returned]:arguments)})}),fns=null}).promise()},promise:function(obj){return null!=obj?jQuery.extend(obj,promise):promise}},deferred={};return promise.pipe=promise.then,jQuery.each(tuples,function(i,tuple){var list=tuple[2],stateString=tuple[3];promise[tuple[1]]=list.add,stateString&&list.add(function(){state=stateString},tuples[1^i][2].disable,tuples[2][2].lock),deferred[tuple[0]]=function(){return deferred[tuple[0]+"With"](this===deferred?promise:this,arguments),this},deferred[tuple[0]+"With"]=list.fireWith}),promise.promise(deferred),func&&func.call(deferred,deferred),deferred},when:function(subordinate){var progressValues,progressContexts,resolveContexts,i=0,resolveValues=core_slice.call(arguments),length=resolveValues.length,remaining=1!==length||subordinate&&jQuery.isFunction(subordinate.promise)?length:0,deferred=1===remaining?subordinate:jQuery.Deferred(),updateFunc=function(i,contexts,values){return function(value){contexts[i]=this,values[i]=arguments.length>1?core_slice.call(arguments):value,values===progressValues?deferred.notifyWith(contexts,values):--remaining||deferred.resolveWith(contexts,values)}};if(length>1)for(progressValues=new Array(length),progressContexts=new Array(length),resolveContexts=new Array(length);i<length;i++)resolveValues[i]&&jQuery.isFunction(resolveValues[i].promise)?resolveValues[i].promise().done(updateFunc(i,resolveContexts,resolveValues)).fail(deferred.reject).progress(updateFunc(i,progressContexts,progressValues)):--remaining;return remaining||deferred.resolveWith(resolveContexts,resolveValues),deferred.promise()}}),jQuery.support=function(support){var all,a,input,select,fragment,opt,eventName,isSupported,i,div=document.createElement("div");if(div.setAttribute("className","t"),div.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",all=div.getElementsByTagName("*")||[],!(a=div.getElementsByTagName("a")[0])||!a.style||!all.length)return support;select=document.createElement("select"),opt=select.appendChild(document.createElement("option")),input=div.getElementsByTagName("input")[0],a.style.cssText="top:1px;float:left;opacity:.5",support.getSetAttribute="t"!==div.className,support.leadingWhitespace=3===div.firstChild.nodeType,support.tbody=!div.getElementsByTagName("tbody").length,support.htmlSerialize=!!div.getElementsByTagName("link").length,support.style=/top/.test(a.getAttribute("style")),support.hrefNormalized="/a"===a.getAttribute("href"),support.opacity=/^0.5/.test(a.style.opacity),support.cssFloat=!!a.style.cssFloat,support.checkOn=!!input.value,support.optSelected=opt.selected,support.enctype=!!document.createElement("form").enctype,support.html5Clone="<:nav></:nav>"!==document.createElement("nav").cloneNode(!0).outerHTML,support.inlineBlockNeedsLayout=!1,support.shrinkWrapBlocks=!1,support.pixelPosition=!1,support.deleteExpando=!0,support.noCloneEvent=!0,support.reliableMarginRight=!0,support.boxSizingReliable=!0,input.checked=!0,support.noCloneChecked=input.cloneNode(!0).checked,select.disabled=!0,support.optDisabled=!opt.disabled;try{delete div.test}catch(e){support.deleteExpando=!1}input=document.createElement("input"),input.setAttribute("value",""),support.input=""===input.getAttribute("value"),input.value="t",input.setAttribute("type","radio"),support.radioValue="t"===input.value,input.setAttribute("checked","t"),input.setAttribute("name","t"),fragment=document.createDocumentFragment(),fragment.appendChild(input),support.appendChecked=input.checked,support.checkClone=fragment.cloneNode(!0).cloneNode(!0).lastChild.checked,div.attachEvent&&(div.attachEvent("onclick",function(){support.noCloneEvent=!1}),div.cloneNode(!0).click());for(i in{submit:!0,change:!0,focusin:!0})div.setAttribute(eventName="on"+i,"t"),support[i+"Bubbles"]=eventName in window||!1===div.attributes[eventName].expando;div.style.backgroundClip="content-box",div.cloneNode(!0).style.backgroundClip="",support.clearCloneStyle="content-box"===div.style.backgroundClip;for(i in jQuery(support))break;return support.ownLast="0"!==i,jQuery(function(){var container,marginDiv,tds,divReset="padding:0;margin:0;border:0;display:block;box-sizing:content-box;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;",body=document.getElementsByTagName("body")[0];body&&(container=document.createElement("div"),container.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",body.appendChild(container).appendChild(div),div.innerHTML="<table><tr><td></td><td>t</td></tr></table>",tds=div.getElementsByTagName("td"),tds[0].style.cssText="padding:0;margin:0;border:0;display:none",isSupported=0===tds[0].offsetHeight,tds[0].style.display="",tds[1].style.display="none",support.reliableHiddenOffsets=isSupported&&0===tds[0].offsetHeight,div.innerHTML="",div.style.cssText="box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;",jQuery.swap(body,null!=body.style.zoom?{zoom:1}:{},function(){support.boxSizing=4===div.offsetWidth}),window.getComputedStyle&&(support.pixelPosition="1%"!==(window.getComputedStyle(div,null)||{}).top,support.boxSizingReliable="4px"===(window.getComputedStyle(div,null)||{width:"4px"}).width,marginDiv=div.appendChild(document.createElement("div")),marginDiv.style.cssText=div.style.cssText=divReset,marginDiv.style.marginRight=marginDiv.style.width="0",div.style.width="1px",support.reliableMarginRight=!parseFloat((window.getComputedStyle(marginDiv,null)||{}).marginRight)),typeof div.style.zoom!==core_strundefined&&(div.innerHTML="",div.style.cssText=divReset+"width:1px;padding:1px;display:inline;zoom:1",support.inlineBlockNeedsLayout=3===div.offsetWidth,div.style.display="block",div.innerHTML="<div></div>",div.firstChild.style.width="5px",support.shrinkWrapBlocks=3!==div.offsetWidth,support.inlineBlockNeedsLayout&&(body.style.zoom=1)),body.removeChild(container),container=div=tds=marginDiv=null)}),all=select=fragment=opt=a=input=null,support}({});var rbrace=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,rmultiDash=/([A-Z])/g;function internalData(elem,name,data,pvt){if(jQuery.acceptData(elem)){var ret,thisCache,internalKey=jQuery.expando,isNode=elem.nodeType,cache=isNode?jQuery.cache:elem,id=isNode?elem[internalKey]:elem[internalKey]&&internalKey;if(id&&cache[id]&&(pvt||cache[id].data)||data!==undefined||"string"!=typeof name)return id||(id=isNode?elem[internalKey]=core_deletedIds.pop()||jQuery.guid++:internalKey),cache[id]||(cache[id]=isNode?{}:{toJSON:jQuery.noop}),"object"!=typeof name&&"function"!=typeof name||(pvt?cache[id]=jQuery.extend(cache[id],name):cache[id].data=jQuery.extend(cache[id].data,name)),thisCache=cache[id],pvt||(thisCache.data||(thisCache.data={}),thisCache=thisCache.data),data!==undefined&&(thisCache[jQuery.camelCase(name)]=data),"string"==typeof name?null==(ret=thisCache[name])&&(ret=thisCache[jQuery.camelCase(name)]):ret=thisCache,ret}}function internalRemoveData(elem,name,pvt){if(jQuery.acceptData(elem)){var thisCache,i,isNode=elem.nodeType,cache=isNode?jQuery.cache:elem,id=isNode?elem[jQuery.expando]:jQuery.expando;if(cache[id]){if(name&&(thisCache=pvt?cache[id]:cache[id].data)){jQuery.isArray(name)?name=name.concat(jQuery.map(name,jQuery.camelCase)):name in thisCache?name=[name]:(name=jQuery.camelCase(name),name=name in thisCache?[name]:name.split(" ")),i=name.length;for(;i--;)delete thisCache[name[i]];if(pvt?!isEmptyDataObject(thisCache):!jQuery.isEmptyObject(thisCache))return}(pvt||(delete cache[id].data,isEmptyDataObject(cache[id])))&&(isNode?jQuery.cleanData([elem],!0):jQuery.support.deleteExpando||cache!=cache.window?delete cache[id]:cache[id]=null)}}}jQuery.extend({cache:{},noData:{applet:!0,embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(elem){return!!(elem=elem.nodeType?jQuery.cache[elem[jQuery.expando]]:elem[jQuery.expando])&&!isEmptyDataObject(elem)},data:function(elem,name,data){return internalData(elem,name,data)},removeData:function(elem,name){return internalRemoveData(elem,name)},_data:function(elem,name,data){return internalData(elem,name,data,!0)},_removeData:function(elem,name){return internalRemoveData(elem,name,!0)},acceptData:function(elem){if(elem.nodeType&&1!==elem.nodeType&&9!==elem.nodeType)return!1;var noData=elem.nodeName&&jQuery.noData[elem.nodeName.toLowerCase()];return!noData||!0!==noData&&elem.getAttribute("classid")===noData}}),jQuery.fn.extend({data:function(key,value){var attrs,name,data=null,i=0,elem=this[0];if(key===undefined){if(this.length&&(data=jQuery.data(elem),1===elem.nodeType&&!jQuery._data(elem,"parsedAttrs"))){for(attrs=elem.attributes;i<attrs.length;i++)name=attrs[i].name,0===name.indexOf("data-")&&(name=jQuery.camelCase(name.slice(5)),dataAttr(elem,name,data[name]));jQuery._data(elem,"parsedAttrs",!0)}return data}return"object"==typeof key?this.each(function(){jQuery.data(this,key)}):arguments.length>1?this.each(function(){jQuery.data(this,key,value)}):elem?dataAttr(elem,key,jQuery.data(elem,key)):null},removeData:function(key){return this.each(function(){jQuery.removeData(this,key)})}});function dataAttr(elem,key,data){if(data===undefined&&1===elem.nodeType){var name="data-"+key.replace(rmultiDash,"-$1").toLowerCase();if("string"==typeof(data=elem.getAttribute(name))){try{data="true"===data||"false"!==data&&("null"===data?null:+data+""===data?+data:rbrace.test(data)?jQuery.parseJSON(data):data)}catch(e){}jQuery.data(elem,key,data)}else data=undefined}return data}function isEmptyDataObject(obj){var name;for(name in obj)if(("data"!==name||!jQuery.isEmptyObject(obj[name]))&&"toJSON"!==name)return!1;return!0}jQuery.extend({queue:function(elem,type,data){var queue;if(elem)return type=(type||"fx")+"queue",queue=jQuery._data(elem,type),data&&(!queue||jQuery.isArray(data)?queue=jQuery._data(elem,type,jQuery.makeArray(data)):queue.push(data)),queue||[]},dequeue:function(elem,type){type=type||"fx";var queue=jQuery.queue(elem,type),startLength=queue.length,fn=queue.shift(),hooks=jQuery._queueHooks(elem,type),next=function(){jQuery.dequeue(elem,type)};"inprogress"===fn&&(fn=queue.shift(),startLength--),fn&&("fx"===type&&queue.unshift("inprogress"),delete hooks.stop,fn.call(elem,next,hooks)),!startLength&&hooks&&hooks.empty.fire()},_queueHooks:function(elem,type){var key=type+"queueHooks";return jQuery._data(elem,key)||jQuery._data(elem,key,{empty:jQuery.Callbacks("once memory").add(function(){jQuery._removeData(elem,type+"queue"),jQuery._removeData(elem,key)})})}}),jQuery.fn.extend({queue:function(type,data){var setter=2;return"string"!=typeof type&&(data=type,type="fx",setter--),arguments.length<setter?jQuery.queue(this[0],type):data===undefined?this:this.each(function(){var queue=jQuery.queue(this,type,data);jQuery._queueHooks(this,type),"fx"===type&&"inprogress"!==queue[0]&&jQuery.dequeue(this,type)})},dequeue:function(type){return this.each(function(){jQuery.dequeue(this,type)})},delay:function(time,type){return time=jQuery.fx?jQuery.fx.speeds[time]||time:time,type=type||"fx",this.queue(type,function(next,hooks){var timeout=setTimeout(next,time);hooks.stop=function(){clearTimeout(timeout)}})},clearQueue:function(type){return this.queue(type||"fx",[])},promise:function(type,obj){var tmp,count=1,defer=jQuery.Deferred(),elements=this,i=this.length,resolve=function(){--count||defer.resolveWith(elements,[elements])};for("string"!=typeof type&&(obj=type,type=undefined),type=type||"fx";i--;)(tmp=jQuery._data(elements[i],type+"queueHooks"))&&tmp.empty&&(count++,tmp.empty.add(resolve));return resolve(),defer.promise(obj)}});var nodeHook,boolHook,rclass=/[\t\r\n\f]/g,rreturn=/\r/g,rfocusable=/^(?:input|select|textarea|button|object)$/i,rclickable=/^(?:a|area)$/i,ruseDefault=/^(?:checked|selected)$/i,getSetAttribute=jQuery.support.getSetAttribute,getSetInput=jQuery.support.input;jQuery.fn.extend({attr:function(name,value){return jQuery.access(this,jQuery.attr,name,value,arguments.length>1)},removeAttr:function(name){return this.each(function(){jQuery.removeAttr(this,name)})},prop:function(name,value){return jQuery.access(this,jQuery.prop,name,value,arguments.length>1)},removeProp:function(name){return name=jQuery.propFix[name]||name,this.each(function(){try{this[name]=undefined,delete this[name]}catch(e){}})},addClass:function(value){var classes,elem,cur,clazz,j,i=0,len=this.length,proceed="string"==typeof value&&value;if(jQuery.isFunction(value))return this.each(function(j){jQuery(this).addClass(value.call(this,j,this.className))});if(proceed)for(classes=(value||"").match(core_rnotwhite)||[];i<len;i++)if(elem=this[i],cur=1===elem.nodeType&&(elem.className?(" "+elem.className+" ").replace(rclass," "):" ")){for(j=0;clazz=classes[j++];)cur.indexOf(" "+clazz+" ")<0&&(cur+=clazz+" ");elem.className=jQuery.trim(cur)}return this},removeClass:function(value){var classes,elem,cur,clazz,j,i=0,len=this.length,proceed=0===arguments.length||"string"==typeof value&&value;if(jQuery.isFunction(value))return this.each(function(j){jQuery(this).removeClass(value.call(this,j,this.className))});if(proceed)for(classes=(value||"").match(core_rnotwhite)||[];i<len;i++)if(elem=this[i],cur=1===elem.nodeType&&(elem.className?(" "+elem.className+" ").replace(rclass," "):"")){for(j=0;clazz=classes[j++];)for(;cur.indexOf(" "+clazz+" ")>=0;)cur=cur.replace(" "+clazz+" "," ");elem.className=value?jQuery.trim(cur):""}return this},toggleClass:function(value,stateVal){var type=typeof value;return"boolean"==typeof stateVal&&"string"===type?stateVal?this.addClass(value):this.removeClass(value):jQuery.isFunction(value)?this.each(function(i){jQuery(this).toggleClass(value.call(this,i,this.className,stateVal),stateVal)}):this.each(function(){if("string"===type)for(var className,i=0,self=jQuery(this),classNames=value.match(core_rnotwhite)||[];className=classNames[i++];)self.hasClass(className)?self.removeClass(className):self.addClass(className);else type!==core_strundefined&&"boolean"!==type||(this.className&&jQuery._data(this,"__className__",this.className),this.className=this.className||!1===value?"":jQuery._data(this,"__className__")||"")})},hasClass:function(selector){for(var className=" "+selector+" ",i=0,l=this.length;i<l;i++)if(1===this[i].nodeType&&(" "+this[i].className+" ").replace(rclass," ").indexOf(className)>=0)return!0;return!1},val:function(value){var ret,hooks,isFunction,elem=this[0];{if(arguments.length)return isFunction=jQuery.isFunction(value),this.each(function(i){var val;1===this.nodeType&&(val=isFunction?value.call(this,i,jQuery(this).val()):value,null==val?val="":"number"==typeof val?val+="":jQuery.isArray(val)&&(val=jQuery.map(val,function(value){return null==value?"":value+""})),(hooks=jQuery.valHooks[this.type]||jQuery.valHooks[this.nodeName.toLowerCase()])&&"set"in hooks&&hooks.set(this,val,"value")!==undefined||(this.value=val))});if(elem)return(hooks=jQuery.valHooks[elem.type]||jQuery.valHooks[elem.nodeName.toLowerCase()])&&"get"in hooks&&(ret=hooks.get(elem,"value"))!==undefined?ret:(ret=elem.value,"string"==typeof ret?ret.replace(rreturn,""):null==ret?"":ret)}}}),jQuery.extend({valHooks:{option:{get:function(elem){var val=jQuery.find.attr(elem,"value");return null!=val?val:elem.text}},select:{get:function(elem){for(var value,option,options=elem.options,index=elem.selectedIndex,one="select-one"===elem.type||index<0,values=one?null:[],max=one?index+1:options.length,i=index<0?max:one?index:0;i<max;i++)if(option=options[i],(option.selected||i===index)&&(jQuery.support.optDisabled?!option.disabled:null===option.getAttribute("disabled"))&&(!option.parentNode.disabled||!jQuery.nodeName(option.parentNode,"optgroup"))){if(value=jQuery(option).val(),one)return value;values.push(value)}return values},set:function(elem,value){for(var optionSet,option,options=elem.options,values=jQuery.makeArray(value),i=options.length;i--;)option=options[i],(option.selected=jQuery.inArray(jQuery(option).val(),values)>=0)&&(optionSet=!0);return optionSet||(elem.selectedIndex=-1),values}}},attr:function(elem,name,value){var hooks,ret,nType=elem.nodeType;if(elem&&3!==nType&&8!==nType&&2!==nType)return typeof elem.getAttribute===core_strundefined?jQuery.prop(elem,name,value):(1===nType&&jQuery.isXMLDoc(elem)||(name=name.toLowerCase(),hooks=jQuery.attrHooks[name]||(jQuery.expr.match.bool.test(name)?boolHook:nodeHook)),value===undefined?hooks&&"get"in hooks&&null!==(ret=hooks.get(elem,name))?ret:(ret=jQuery.find.attr(elem,name),null==ret?undefined:ret):null!==value?hooks&&"set"in hooks&&(ret=hooks.set(elem,value,name))!==undefined?ret:(elem.setAttribute(name,value+""),value):void jQuery.removeAttr(elem,name))},removeAttr:function(elem,value){var name,propName,i=0,attrNames=value&&value.match(core_rnotwhite);if(attrNames&&1===elem.nodeType)for(;name=attrNames[i++];)propName=jQuery.propFix[name]||name,jQuery.expr.match.bool.test(name)?getSetInput&&getSetAttribute||!ruseDefault.test(name)?elem[propName]=!1:elem[jQuery.camelCase("default-"+name)]=elem[propName]=!1:jQuery.attr(elem,name,""),elem.removeAttribute(getSetAttribute?name:propName)},attrHooks:{type:{set:function(elem,value){if(!jQuery.support.radioValue&&"radio"===value&&jQuery.nodeName(elem,"input")){var val=elem.value;return elem.setAttribute("type",value),val&&(elem.value=val),value}}}},propFix:{for:"htmlFor",class:"className"},prop:function(elem,name,value){var ret,hooks,notxml,nType=elem.nodeType;if(elem&&3!==nType&&8!==nType&&2!==nType)return notxml=1!==nType||!jQuery.isXMLDoc(elem),notxml&&(name=jQuery.propFix[name]||name,hooks=jQuery.propHooks[name]),value!==undefined?hooks&&"set"in hooks&&(ret=hooks.set(elem,value,name))!==undefined?ret:elem[name]=value:hooks&&"get"in hooks&&null!==(ret=hooks.get(elem,name))?ret:elem[name]},propHooks:{tabIndex:{get:function(elem){var tabindex=jQuery.find.attr(elem,"tabindex");return tabindex?parseInt(tabindex,10):rfocusable.test(elem.nodeName)||rclickable.test(elem.nodeName)&&elem.href?0:-1}}}}),boolHook={set:function(elem,value,name){return!1===value?jQuery.removeAttr(elem,name):getSetInput&&getSetAttribute||!ruseDefault.test(name)?elem.setAttribute(!getSetAttribute&&jQuery.propFix[name]||name,name):elem[jQuery.camelCase("default-"+name)]=elem[name]=!0,name}},jQuery.each(jQuery.expr.match.bool.source.match(/\w+/g),function(i,name){var getter=jQuery.expr.attrHandle[name]||jQuery.find.attr;jQuery.expr.attrHandle[name]=getSetInput&&getSetAttribute||!ruseDefault.test(name)?function(elem,name,isXML){var fn=jQuery.expr.attrHandle[name],ret=isXML?undefined:(jQuery.expr.attrHandle[name]=undefined)!=getter(elem,name,isXML)?name.toLowerCase():null;return jQuery.expr.attrHandle[name]=fn,ret}:function(elem,name,isXML){return isXML?undefined:elem[jQuery.camelCase("default-"+name)]?name.toLowerCase():null}}),getSetInput&&getSetAttribute||(jQuery.attrHooks.value={set:function(elem,value,name){if(!jQuery.nodeName(elem,"input"))return nodeHook&&nodeHook.set(elem,value,name);elem.defaultValue=value}}),getSetAttribute||(nodeHook={set:function(elem,value,name){var ret=elem.getAttributeNode(name);return ret||elem.setAttributeNode(ret=elem.ownerDocument.createAttribute(name)),ret.value=value+="","value"===name||value===elem.getAttribute(name)?value:undefined}},jQuery.expr.attrHandle.id=jQuery.expr.attrHandle.name=jQuery.expr.attrHandle.coords=function(elem,name,isXML){var ret;return isXML?undefined:(ret=elem.getAttributeNode(name))&&""!==ret.value?ret.value:null},jQuery.valHooks.button={get:function(elem,name){var ret=elem.getAttributeNode(name);return ret&&ret.specified?ret.value:undefined},set:nodeHook.set},jQuery.attrHooks.contenteditable={set:function(elem,value,name){nodeHook.set(elem,""!==value&&value,name)}},jQuery.each(["width","height"],function(i,name){jQuery.attrHooks[name]={set:function(elem,value){if(""===value)return elem.setAttribute(name,"auto"),value}}})),jQuery.support.hrefNormalized||jQuery.each(["href","src"],function(i,name){jQuery.propHooks[name]={get:function(elem){return elem.getAttribute(name,4)}}}),jQuery.support.style||(jQuery.attrHooks.style={get:function(elem){return elem.style.cssText||undefined},set:function(elem,value){return elem.style.cssText=value+""}}),jQuery.support.optSelected||(jQuery.propHooks.selected={get:function(elem){var parent=elem.parentNode;return parent&&(parent.selectedIndex,parent.parentNode&&parent.parentNode.selectedIndex),null}}),jQuery.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){jQuery.propFix[this.toLowerCase()]=this}),jQuery.support.enctype||(jQuery.propFix.enctype="encoding"),jQuery.each(["radio","checkbox"],function(){jQuery.valHooks[this]={set:function(elem,value){if(jQuery.isArray(value))return elem.checked=jQuery.inArray(jQuery(elem).val(),value)>=0}},jQuery.support.checkOn||(jQuery.valHooks[this].get=function(elem){return null===elem.getAttribute("value")?"on":elem.value})});var rformElems=/^(?:input|select|textarea)$/i,rkeyEvent=/^key/,rmouseEvent=/^(?:mouse|contextmenu)|click/,rfocusMorph=/^(?:focusinfocus|focusoutblur)$/,rtypenamespace=/^([^.]*)(?:\.(.+)|)$/;function returnTrue(){return!0}function returnFalse(){return!1}function safeActiveElement(){try{return document.activeElement}catch(err){}}jQuery.event={global:{},add:function(elem,types,handler,data,selector){
var tmp,events,t,handleObjIn,special,eventHandle,handleObj,handlers,type,namespaces,origType,elemData=jQuery._data(elem);if(elemData){for(handler.handler&&(handleObjIn=handler,handler=handleObjIn.handler,selector=handleObjIn.selector),handler.guid||(handler.guid=jQuery.guid++),(events=elemData.events)||(events=elemData.events={}),(eventHandle=elemData.handle)||(eventHandle=elemData.handle=function(e){return typeof jQuery===core_strundefined||e&&jQuery.event.triggered===e.type?undefined:jQuery.event.dispatch.apply(eventHandle.elem,arguments)},eventHandle.elem=elem),types=(types||"").match(core_rnotwhite)||[""],t=types.length;t--;)tmp=rtypenamespace.exec(types[t])||[],type=origType=tmp[1],namespaces=(tmp[2]||"").split(".").sort(),type&&(special=jQuery.event.special[type]||{},type=(selector?special.delegateType:special.bindType)||type,special=jQuery.event.special[type]||{},handleObj=jQuery.extend({type:type,origType:origType,data:data,handler:handler,guid:handler.guid,selector:selector,needsContext:selector&&jQuery.expr.match.needsContext.test(selector),namespace:namespaces.join(".")},handleObjIn),(handlers=events[type])||(handlers=events[type]=[],handlers.delegateCount=0,special.setup&&!1!==special.setup.call(elem,data,namespaces,eventHandle)||(elem.addEventListener?elem.addEventListener(type,eventHandle,!1):elem.attachEvent&&elem.attachEvent("on"+type,eventHandle))),special.add&&(special.add.call(elem,handleObj),handleObj.handler.guid||(handleObj.handler.guid=handler.guid)),selector?handlers.splice(handlers.delegateCount++,0,handleObj):handlers.push(handleObj),jQuery.event.global[type]=!0);elem=null}},remove:function(elem,types,handler,selector,mappedTypes){var j,handleObj,tmp,origCount,t,events,special,handlers,type,namespaces,origType,elemData=jQuery.hasData(elem)&&jQuery._data(elem);if(elemData&&(events=elemData.events)){for(types=(types||"").match(core_rnotwhite)||[""],t=types.length;t--;)if(tmp=rtypenamespace.exec(types[t])||[],type=origType=tmp[1],namespaces=(tmp[2]||"").split(".").sort(),type){for(special=jQuery.event.special[type]||{},type=(selector?special.delegateType:special.bindType)||type,handlers=events[type]||[],tmp=tmp[2]&&new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)"),origCount=j=handlers.length;j--;)handleObj=handlers[j],!mappedTypes&&origType!==handleObj.origType||handler&&handler.guid!==handleObj.guid||tmp&&!tmp.test(handleObj.namespace)||selector&&selector!==handleObj.selector&&("**"!==selector||!handleObj.selector)||(handlers.splice(j,1),handleObj.selector&&handlers.delegateCount--,special.remove&&special.remove.call(elem,handleObj));origCount&&!handlers.length&&(special.teardown&&!1!==special.teardown.call(elem,namespaces,elemData.handle)||jQuery.removeEvent(elem,type,elemData.handle),delete events[type])}else for(type in events)jQuery.event.remove(elem,type+types[t],handler,selector,!0);jQuery.isEmptyObject(events)&&(delete elemData.handle,jQuery._removeData(elem,"events"))}},trigger:function(event,data,elem,onlyHandlers){var handle,ontype,cur,bubbleType,special,tmp,i,eventPath=[elem||document],type=core_hasOwn.call(event,"type")?event.type:event,namespaces=core_hasOwn.call(event,"namespace")?event.namespace.split("."):[];if(cur=tmp=elem=elem||document,3!==elem.nodeType&&8!==elem.nodeType&&!rfocusMorph.test(type+jQuery.event.triggered)&&(type.indexOf(".")>=0&&(namespaces=type.split("."),type=namespaces.shift(),namespaces.sort()),ontype=type.indexOf(":")<0&&"on"+type,event=event[jQuery.expando]?event:new jQuery.Event(type,"object"==typeof event&&event),event.isTrigger=onlyHandlers?2:3,event.namespace=namespaces.join("."),event.namespace_re=event.namespace?new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,event.result=undefined,event.target||(event.target=elem),data=null==data?[event]:jQuery.makeArray(data,[event]),special=jQuery.event.special[type]||{},onlyHandlers||!special.trigger||!1!==special.trigger.apply(elem,data))){if(!onlyHandlers&&!special.noBubble&&!jQuery.isWindow(elem)){for(bubbleType=special.delegateType||type,rfocusMorph.test(bubbleType+type)||(cur=cur.parentNode);cur;cur=cur.parentNode)eventPath.push(cur),tmp=cur;tmp===(elem.ownerDocument||document)&&eventPath.push(tmp.defaultView||tmp.parentWindow||window)}for(i=0;(cur=eventPath[i++])&&!event.isPropagationStopped();)event.type=i>1?bubbleType:special.bindType||type,handle=(jQuery._data(cur,"events")||{})[event.type]&&jQuery._data(cur,"handle"),handle&&handle.apply(cur,data),(handle=ontype&&cur[ontype])&&jQuery.acceptData(cur)&&handle.apply&&!1===handle.apply(cur,data)&&event.preventDefault();if(event.type=type,!onlyHandlers&&!event.isDefaultPrevented()&&(!special._default||!1===special._default.apply(eventPath.pop(),data))&&jQuery.acceptData(elem)&&ontype&&elem[type]&&!jQuery.isWindow(elem)){tmp=elem[ontype],tmp&&(elem[ontype]=null),jQuery.event.triggered=type;try{elem[type]()}catch(e){}jQuery.event.triggered=undefined,tmp&&(elem[ontype]=tmp)}return event.result}},dispatch:function(event){event=jQuery.event.fix(event);var i,ret,handleObj,matched,j,handlerQueue=[],args=core_slice.call(arguments),handlers=(jQuery._data(this,"events")||{})[event.type]||[],special=jQuery.event.special[event.type]||{};if(args[0]=event,event.delegateTarget=this,!special.preDispatch||!1!==special.preDispatch.call(this,event)){for(handlerQueue=jQuery.event.handlers.call(this,event,handlers),i=0;(matched=handlerQueue[i++])&&!event.isPropagationStopped();)for(event.currentTarget=matched.elem,j=0;(handleObj=matched.handlers[j++])&&!event.isImmediatePropagationStopped();)event.namespace_re&&!event.namespace_re.test(handleObj.namespace)||(event.handleObj=handleObj,event.data=handleObj.data,(ret=((jQuery.event.special[handleObj.origType]||{}).handle||handleObj.handler).apply(matched.elem,args))!==undefined&&!1===(event.result=ret)&&(event.preventDefault(),event.stopPropagation()));return special.postDispatch&&special.postDispatch.call(this,event),event.result}},handlers:function(event,handlers){var sel,handleObj,matches,i,handlerQueue=[],delegateCount=handlers.delegateCount,cur=event.target;if(delegateCount&&cur.nodeType&&(!event.button||"click"!==event.type))for(;cur!=this;cur=cur.parentNode||this)if(1===cur.nodeType&&(!0!==cur.disabled||"click"!==event.type)){for(matches=[],i=0;i<delegateCount;i++)handleObj=handlers[i],sel=handleObj.selector+" ",matches[sel]===undefined&&(matches[sel]=handleObj.needsContext?jQuery(sel,this).index(cur)>=0:jQuery.find(sel,this,null,[cur]).length),matches[sel]&&matches.push(handleObj);matches.length&&handlerQueue.push({elem:cur,handlers:matches})}return delegateCount<handlers.length&&handlerQueue.push({elem:this,handlers:handlers.slice(delegateCount)}),handlerQueue},fix:function(event){if(event[jQuery.expando])return event;var i,prop,copy,type=event.type,originalEvent=event,fixHook=this.fixHooks[type];for(fixHook||(this.fixHooks[type]=fixHook=rmouseEvent.test(type)?this.mouseHooks:rkeyEvent.test(type)?this.keyHooks:{}),copy=fixHook.props?this.props.concat(fixHook.props):this.props,event=new jQuery.Event(originalEvent),i=copy.length;i--;)prop=copy[i],event[prop]=originalEvent[prop];return event.target||(event.target=originalEvent.srcElement||document),3===event.target.nodeType&&(event.target=event.target.parentNode),event.metaKey=!!event.metaKey,fixHook.filter?fixHook.filter(event,originalEvent):event},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(event,original){return null==event.which&&(event.which=null!=original.charCode?original.charCode:original.keyCode),event}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(event,original){var body,eventDoc,doc,button=original.button,fromElement=original.fromElement;return null==event.pageX&&null!=original.clientX&&(eventDoc=event.target.ownerDocument||document,doc=eventDoc.documentElement,body=eventDoc.body,event.pageX=original.clientX+(doc&&doc.scrollLeft||body&&body.scrollLeft||0)-(doc&&doc.clientLeft||body&&body.clientLeft||0),event.pageY=original.clientY+(doc&&doc.scrollTop||body&&body.scrollTop||0)-(doc&&doc.clientTop||body&&body.clientTop||0)),!event.relatedTarget&&fromElement&&(event.relatedTarget=fromElement===event.target?original.toElement:fromElement),event.which||button===undefined||(event.which=1&button?1:2&button?3:4&button?2:0),event}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==safeActiveElement()&&this.focus)try{return this.focus(),!1}catch(e){}},delegateType:"focusin"},blur:{trigger:function(){if(this===safeActiveElement()&&this.blur)return this.blur(),!1},delegateType:"focusout"},click:{trigger:function(){if(jQuery.nodeName(this,"input")&&"checkbox"===this.type&&this.click)return this.click(),!1},_default:function(event){return jQuery.nodeName(event.target,"a")}},beforeunload:{postDispatch:function(event){event.result!==undefined&&(event.originalEvent.returnValue=event.result)}}},simulate:function(type,elem,event,bubble){var e=jQuery.extend(new jQuery.Event,event,{type:type,isSimulated:!0,originalEvent:{}});bubble?jQuery.event.trigger(e,null,elem):jQuery.event.dispatch.call(elem,e),e.isDefaultPrevented()&&event.preventDefault()}},jQuery.removeEvent=document.removeEventListener?function(elem,type,handle){elem.removeEventListener&&elem.removeEventListener(type,handle,!1)}:function(elem,type,handle){var name="on"+type;elem.detachEvent&&(typeof elem[name]===core_strundefined&&(elem[name]=null),elem.detachEvent(name,handle))},jQuery.Event=function(src,props){if(!(this instanceof jQuery.Event))return new jQuery.Event(src,props);src&&src.type?(this.originalEvent=src,this.type=src.type,this.isDefaultPrevented=src.defaultPrevented||!1===src.returnValue||src.getPreventDefault&&src.getPreventDefault()?returnTrue:returnFalse):this.type=src,props&&jQuery.extend(this,props),this.timeStamp=src&&src.timeStamp||jQuery.now(),this[jQuery.expando]=!0},jQuery.Event.prototype={isDefaultPrevented:returnFalse,isPropagationStopped:returnFalse,isImmediatePropagationStopped:returnFalse,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=returnTrue,e&&(e.preventDefault?e.preventDefault():e.returnValue=!1)},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=returnTrue,e&&(e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=returnTrue,this.stopPropagation()}},jQuery.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(orig,fix){jQuery.event.special[orig]={delegateType:fix,bindType:fix,handle:function(event){var ret,target=this,related=event.relatedTarget,handleObj=event.handleObj;return related&&(related===target||jQuery.contains(target,related))||(event.type=handleObj.origType,ret=handleObj.handler.apply(this,arguments),event.type=fix),ret}}}),jQuery.support.submitBubbles||(jQuery.event.special.submit={setup:function(){if(jQuery.nodeName(this,"form"))return!1;jQuery.event.add(this,"click._submit keypress._submit",function(e){var elem=e.target,form=jQuery.nodeName(elem,"input")||jQuery.nodeName(elem,"button")?elem.form:undefined;form&&!jQuery._data(form,"submitBubbles")&&(jQuery.event.add(form,"submit._submit",function(event){event._submit_bubble=!0}),jQuery._data(form,"submitBubbles",!0))})},postDispatch:function(event){event._submit_bubble&&(delete event._submit_bubble,this.parentNode&&!event.isTrigger&&jQuery.event.simulate("submit",this.parentNode,event,!0))},teardown:function(){if(jQuery.nodeName(this,"form"))return!1;jQuery.event.remove(this,"._submit")}}),jQuery.support.changeBubbles||(jQuery.event.special.change={setup:function(){if(rformElems.test(this.nodeName))return"checkbox"!==this.type&&"radio"!==this.type||(jQuery.event.add(this,"propertychange._change",function(event){"checked"===event.originalEvent.propertyName&&(this._just_changed=!0)}),jQuery.event.add(this,"click._change",function(event){this._just_changed&&!event.isTrigger&&(this._just_changed=!1),jQuery.event.simulate("change",this,event,!0)})),!1;jQuery.event.add(this,"beforeactivate._change",function(e){var elem=e.target;rformElems.test(elem.nodeName)&&!jQuery._data(elem,"changeBubbles")&&(jQuery.event.add(elem,"change._change",function(event){!this.parentNode||event.isSimulated||event.isTrigger||jQuery.event.simulate("change",this.parentNode,event,!0)}),jQuery._data(elem,"changeBubbles",!0))})},handle:function(event){var elem=event.target;if(this!==elem||event.isSimulated||event.isTrigger||"radio"!==elem.type&&"checkbox"!==elem.type)return event.handleObj.handler.apply(this,arguments)},teardown:function(){return jQuery.event.remove(this,"._change"),!rformElems.test(this.nodeName)}}),jQuery.support.focusinBubbles||jQuery.each({focus:"focusin",blur:"focusout"},function(orig,fix){var attaches=0,handler=function(event){jQuery.event.simulate(fix,event.target,jQuery.event.fix(event),!0)};jQuery.event.special[fix]={setup:function(){0==attaches++&&document.addEventListener(orig,handler,!0)},teardown:function(){0==--attaches&&document.removeEventListener(orig,handler,!0)}}}),jQuery.fn.extend({on:function(types,selector,data,fn,one){var type,origFn;if("object"==typeof types){"string"!=typeof selector&&(data=data||selector,selector=undefined);for(type in types)this.on(type,selector,data,types[type],one);return this}if(null==data&&null==fn?(fn=selector,data=selector=undefined):null==fn&&("string"==typeof selector?(fn=data,data=undefined):(fn=data,data=selector,selector=undefined)),!1===fn)fn=returnFalse;else if(!fn)return this;return 1===one&&(origFn=fn,fn=function(event){return jQuery().off(event),origFn.apply(this,arguments)},fn.guid=origFn.guid||(origFn.guid=jQuery.guid++)),this.each(function(){jQuery.event.add(this,types,fn,data,selector)})},one:function(types,selector,data,fn){return this.on(types,selector,data,fn,1)},off:function(types,selector,fn){var handleObj,type;if(types&&types.preventDefault&&types.handleObj)return handleObj=types.handleObj,jQuery(types.delegateTarget).off(handleObj.namespace?handleObj.origType+"."+handleObj.namespace:handleObj.origType,handleObj.selector,handleObj.handler),this;if("object"==typeof types){for(type in types)this.off(type,selector,types[type]);return this}return!1!==selector&&"function"!=typeof selector||(fn=selector,selector=undefined),!1===fn&&(fn=returnFalse),this.each(function(){jQuery.event.remove(this,types,fn,selector)})},trigger:function(type,data){return this.each(function(){jQuery.event.trigger(type,data,this)})},triggerHandler:function(type,data){var elem=this[0];if(elem)return jQuery.event.trigger(type,data,elem,!0)}});var isSimple=/^.[^:#\[\.,]*$/,rparentsprev=/^(?:parents|prev(?:Until|All))/,rneedsContext=jQuery.expr.match.needsContext,guaranteedUnique={children:!0,contents:!0,next:!0,prev:!0};jQuery.fn.extend({find:function(selector){var i,ret=[],self=this,len=self.length;if("string"!=typeof selector)return this.pushStack(jQuery(selector).filter(function(){for(i=0;i<len;i++)if(jQuery.contains(self[i],this))return!0}));for(i=0;i<len;i++)jQuery.find(selector,self[i],ret);return ret=this.pushStack(len>1?jQuery.unique(ret):ret),ret.selector=this.selector?this.selector+" "+selector:selector,ret},has:function(target){var i,targets=jQuery(target,this),len=targets.length;return this.filter(function(){for(i=0;i<len;i++)if(jQuery.contains(this,targets[i]))return!0})},not:function(selector){return this.pushStack(winnow(this,selector||[],!0))},filter:function(selector){return this.pushStack(winnow(this,selector||[],!1))},is:function(selector){return!!winnow(this,"string"==typeof selector&&rneedsContext.test(selector)?jQuery(selector):selector||[],!1).length},closest:function(selectors,context){for(var cur,i=0,l=this.length,ret=[],pos=rneedsContext.test(selectors)||"string"!=typeof selectors?jQuery(selectors,context||this.context):0;i<l;i++)for(cur=this[i];cur&&cur!==context;cur=cur.parentNode)if(cur.nodeType<11&&(pos?pos.index(cur)>-1:1===cur.nodeType&&jQuery.find.matchesSelector(cur,selectors))){cur=ret.push(cur);break}return this.pushStack(ret.length>1?jQuery.unique(ret):ret)},index:function(elem){return elem?"string"==typeof elem?jQuery.inArray(this[0],jQuery(elem)):jQuery.inArray(elem.jquery?elem[0]:elem,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(selector,context){var set="string"==typeof selector?jQuery(selector,context):jQuery.makeArray(selector&&selector.nodeType?[selector]:selector),all=jQuery.merge(this.get(),set);return this.pushStack(jQuery.unique(all))},addBack:function(selector){return this.add(null==selector?this.prevObject:this.prevObject.filter(selector))}});function sibling(cur,dir){do{cur=cur[dir]}while(cur&&1!==cur.nodeType);return cur}jQuery.each({parent:function(elem){var parent=elem.parentNode;return parent&&11!==parent.nodeType?parent:null},parents:function(elem){return jQuery.dir(elem,"parentNode")},parentsUntil:function(elem,i,until){return jQuery.dir(elem,"parentNode",until)},next:function(elem){return sibling(elem,"nextSibling")},prev:function(elem){return sibling(elem,"previousSibling")},nextAll:function(elem){return jQuery.dir(elem,"nextSibling")},prevAll:function(elem){return jQuery.dir(elem,"previousSibling")},nextUntil:function(elem,i,until){return jQuery.dir(elem,"nextSibling",until)},prevUntil:function(elem,i,until){return jQuery.dir(elem,"previousSibling",until)},siblings:function(elem){return jQuery.sibling((elem.parentNode||{}).firstChild,elem)},children:function(elem){return jQuery.sibling(elem.firstChild)},contents:function(elem){return jQuery.nodeName(elem,"iframe")?elem.contentDocument||elem.contentWindow.document:jQuery.merge([],elem.childNodes)}},function(name,fn){jQuery.fn[name]=function(until,selector){var ret=jQuery.map(this,fn,until);return"Until"!==name.slice(-5)&&(selector=until),selector&&"string"==typeof selector&&(ret=jQuery.filter(selector,ret)),this.length>1&&(guaranteedUnique[name]||(ret=jQuery.unique(ret)),rparentsprev.test(name)&&(ret=ret.reverse())),this.pushStack(ret)}}),jQuery.extend({filter:function(expr,elems,not){var elem=elems[0];return not&&(expr=":not("+expr+")"),1===elems.length&&1===elem.nodeType?jQuery.find.matchesSelector(elem,expr)?[elem]:[]:jQuery.find.matches(expr,jQuery.grep(elems,function(elem){return 1===elem.nodeType}))},dir:function(elem,dir,until){for(var matched=[],cur=elem[dir];cur&&9!==cur.nodeType&&(until===undefined||1!==cur.nodeType||!jQuery(cur).is(until));)1===cur.nodeType&&matched.push(cur),cur=cur[dir];return matched},sibling:function(n,elem){for(var r=[];n;n=n.nextSibling)1===n.nodeType&&n!==elem&&r.push(n);return r}});function winnow(elements,qualifier,not){if(jQuery.isFunction(qualifier))return jQuery.grep(elements,function(elem,i){return!!qualifier.call(elem,i,elem)!==not});if(qualifier.nodeType)return jQuery.grep(elements,function(elem){return elem===qualifier!==not});if("string"==typeof qualifier){if(isSimple.test(qualifier))return jQuery.filter(qualifier,elements,not);qualifier=jQuery.filter(qualifier,elements)}return jQuery.grep(elements,function(elem){return jQuery.inArray(elem,qualifier)>=0!==not})}function createSafeFragment(document){var list=nodeNames.split("|"),safeFrag=document.createDocumentFragment();if(safeFrag.createElement)for(;list.length;)safeFrag.createElement(list.pop());return safeFrag}var nodeNames="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",rinlinejQuery=/ jQuery\d+="(?:null|\d+)"/g,rnoshimcache=new RegExp("<(?:"+nodeNames+")[\\s/>]","i"),rleadingWhitespace=/^\s+/,rxhtmlTag=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,rtagName=/<([\w:]+)/,rtbody=/<tbody/i,rhtml=/<|&#?\w+;/,rnoInnerhtml=/<(?:script|style|link)/i,manipulation_rcheckableType=/^(?:checkbox|radio)$/i,rchecked=/checked\s*(?:[^=]|=\s*.checked.)/i,rscriptType=/^$|\/(?:java|ecma)script/i,rscriptTypeMasked=/^true\/(.*)/,rcleanScript=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,wrapMap={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:jQuery.support.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},safeFragment=createSafeFragment(document),fragmentDiv=safeFragment.appendChild(document.createElement("div"));wrapMap.optgroup=wrapMap.option,wrapMap.tbody=wrapMap.tfoot=wrapMap.colgroup=wrapMap.caption=wrapMap.thead,wrapMap.th=wrapMap.td,jQuery.fn.extend({text:function(value){return jQuery.access(this,function(value){return value===undefined?jQuery.text(this):this.empty().append((this[0]&&this[0].ownerDocument||document).createTextNode(value))},null,value,arguments.length)},append:function(){return this.domManip(arguments,function(elem){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){manipulationTarget(this,elem).appendChild(elem)}})},prepend:function(){return this.domManip(arguments,function(elem){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var target=manipulationTarget(this,elem);target.insertBefore(elem,target.firstChild)}})},before:function(){return this.domManip(arguments,function(elem){this.parentNode&&this.parentNode.insertBefore(elem,this)})},after:function(){return this.domManip(arguments,function(elem){this.parentNode&&this.parentNode.insertBefore(elem,this.nextSibling)})},remove:function(selector,keepData){for(var elem,elems=selector?jQuery.filter(selector,this):this,i=0;null!=(elem=elems[i]);i++)keepData||1!==elem.nodeType||jQuery.cleanData(getAll(elem)),elem.parentNode&&(keepData&&jQuery.contains(elem.ownerDocument,elem)&&setGlobalEval(getAll(elem,"script")),elem.parentNode.removeChild(elem));return this},empty:function(){for(var elem,i=0;null!=(elem=this[i]);i++){for(1===elem.nodeType&&jQuery.cleanData(getAll(elem,!1));elem.firstChild;)elem.removeChild(elem.firstChild);elem.options&&jQuery.nodeName(elem,"select")&&(elem.options.length=0)}return this},clone:function(dataAndEvents,deepDataAndEvents){return dataAndEvents=null!=dataAndEvents&&dataAndEvents,deepDataAndEvents=null==deepDataAndEvents?dataAndEvents:deepDataAndEvents,this.map(function(){return jQuery.clone(this,dataAndEvents,deepDataAndEvents)})},html:function(value){return jQuery.access(this,function(value){var elem=this[0]||{},i=0,l=this.length;if(value===undefined)return 1===elem.nodeType?elem.innerHTML.replace(rinlinejQuery,""):undefined;if("string"==typeof value&&!rnoInnerhtml.test(value)&&(jQuery.support.htmlSerialize||!rnoshimcache.test(value))&&(jQuery.support.leadingWhitespace||!rleadingWhitespace.test(value))&&!wrapMap[(rtagName.exec(value)||["",""])[1].toLowerCase()]){value=value.replace(rxhtmlTag,"<$1></$2>");try{for(;i<l;i++)elem=this[i]||{},1===elem.nodeType&&(jQuery.cleanData(getAll(elem,!1)),elem.innerHTML=value);elem=0}catch(e){}}elem&&this.empty().append(value)},null,value,arguments.length)},replaceWith:function(){var args=jQuery.map(this,function(elem){return[elem.nextSibling,elem.parentNode]}),i=0;return this.domManip(arguments,function(elem){var next=args[i++],parent=args[i++];parent&&(next&&next.parentNode!==parent&&(next=this.nextSibling),jQuery(this).remove(),parent.insertBefore(elem,next))},!0),i?this:this.remove()},detach:function(selector){return this.remove(selector,!0)},domManip:function(args,callback,allowIntersection){args=core_concat.apply([],args);var first,node,hasScripts,scripts,doc,fragment,i=0,l=this.length,set=this,iNoClone=l-1,value=args[0],isFunction=jQuery.isFunction(value);if(isFunction||!(l<=1||"string"!=typeof value||jQuery.support.checkClone)&&rchecked.test(value))return this.each(function(index){var self=set.eq(index);isFunction&&(args[0]=value.call(this,index,self.html())),self.domManip(args,callback,allowIntersection)});if(l&&(fragment=jQuery.buildFragment(args,this[0].ownerDocument,!1,!allowIntersection&&this),first=fragment.firstChild,1===fragment.childNodes.length&&(fragment=first),first)){for(scripts=jQuery.map(getAll(fragment,"script"),disableScript),hasScripts=scripts.length;i<l;i++)node=fragment,i!==iNoClone&&(node=jQuery.clone(node,!0,!0),hasScripts&&jQuery.merge(scripts,getAll(node,"script"))),callback.call(this[i],node,i);if(hasScripts)for(doc=scripts[scripts.length-1].ownerDocument,jQuery.map(scripts,restoreScript),i=0;i<hasScripts;i++)node=scripts[i],rscriptType.test(node.type||"")&&!jQuery._data(node,"globalEval")&&jQuery.contains(doc,node)&&(node.src?jQuery._evalUrl(node.src):jQuery.globalEval((node.text||node.textContent||node.innerHTML||"").replace(rcleanScript,"")));fragment=first=null}return this}});function manipulationTarget(elem,content){return jQuery.nodeName(elem,"table")&&jQuery.nodeName(1===content.nodeType?content:content.firstChild,"tr")?elem.getElementsByTagName("tbody")[0]||elem.appendChild(elem.ownerDocument.createElement("tbody")):elem}function disableScript(elem){return elem.type=(null!==jQuery.find.attr(elem,"type"))+"/"+elem.type,elem}function restoreScript(elem){var match=rscriptTypeMasked.exec(elem.type);return match?elem.type=match[1]:elem.removeAttribute("type"),elem}function setGlobalEval(elems,refElements){for(var elem,i=0;null!=(elem=elems[i]);i++)jQuery._data(elem,"globalEval",!refElements||jQuery._data(refElements[i],"globalEval"))}function cloneCopyEvent(src,dest){if(1===dest.nodeType&&jQuery.hasData(src)){var type,i,l,oldData=jQuery._data(src),curData=jQuery._data(dest,oldData),events=oldData.events;if(events){delete curData.handle,curData.events={};for(type in events)for(i=0,l=events[type].length;i<l;i++)jQuery.event.add(dest,type,events[type][i])}curData.data&&(curData.data=jQuery.extend({},curData.data))}}function fixCloneNodeIssues(src,dest){var nodeName,e,data;if(1===dest.nodeType){if(nodeName=dest.nodeName.toLowerCase(),!jQuery.support.noCloneEvent&&dest[jQuery.expando]){data=jQuery._data(dest);for(e in data.events)jQuery.removeEvent(dest,e,data.handle);dest.removeAttribute(jQuery.expando)}"script"===nodeName&&dest.text!==src.text?(disableScript(dest).text=src.text,restoreScript(dest)):"object"===nodeName?(dest.parentNode&&(dest.outerHTML=src.outerHTML),jQuery.support.html5Clone&&src.innerHTML&&!jQuery.trim(dest.innerHTML)&&(dest.innerHTML=src.innerHTML)):"input"===nodeName&&manipulation_rcheckableType.test(src.type)?(dest.defaultChecked=dest.checked=src.checked,dest.value!==src.value&&(dest.value=src.value)):"option"===nodeName?dest.defaultSelected=dest.selected=src.defaultSelected:"input"!==nodeName&&"textarea"!==nodeName||(dest.defaultValue=src.defaultValue)}}jQuery.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(name,original){jQuery.fn[name]=function(selector){for(var elems,i=0,ret=[],insert=jQuery(selector),last=insert.length-1;i<=last;i++)elems=i===last?this:this.clone(!0),jQuery(insert[i])[original](elems),core_push.apply(ret,elems.get());return this.pushStack(ret)}});function getAll(context,tag){var elems,elem,i=0,found=typeof context.getElementsByTagName!==core_strundefined?context.getElementsByTagName(tag||"*"):typeof context.querySelectorAll!==core_strundefined?context.querySelectorAll(tag||"*"):undefined;if(!found)for(found=[],elems=context.childNodes||context;null!=(elem=elems[i]);i++)!tag||jQuery.nodeName(elem,tag)?found.push(elem):jQuery.merge(found,getAll(elem,tag));return tag===undefined||tag&&jQuery.nodeName(context,tag)?jQuery.merge([context],found):found}function fixDefaultChecked(elem){manipulation_rcheckableType.test(elem.type)&&(elem.defaultChecked=elem.checked)}jQuery.extend({clone:function(elem,dataAndEvents,deepDataAndEvents){var destElements,node,clone,i,srcElements,inPage=jQuery.contains(elem.ownerDocument,elem);if(jQuery.support.html5Clone||jQuery.isXMLDoc(elem)||!rnoshimcache.test("<"+elem.nodeName+">")?clone=elem.cloneNode(!0):(fragmentDiv.innerHTML=elem.outerHTML,fragmentDiv.removeChild(clone=fragmentDiv.firstChild)),!(jQuery.support.noCloneEvent&&jQuery.support.noCloneChecked||1!==elem.nodeType&&11!==elem.nodeType||jQuery.isXMLDoc(elem)))for(destElements=getAll(clone),srcElements=getAll(elem),i=0;null!=(node=srcElements[i]);++i)destElements[i]&&fixCloneNodeIssues(node,destElements[i]);if(dataAndEvents)if(deepDataAndEvents)for(srcElements=srcElements||getAll(elem),destElements=destElements||getAll(clone),i=0;null!=(node=srcElements[i]);i++)cloneCopyEvent(node,destElements[i]);else cloneCopyEvent(elem,clone);return destElements=getAll(clone,"script"),destElements.length>0&&setGlobalEval(destElements,!inPage&&getAll(elem,"script")),destElements=srcElements=node=null,clone},buildFragment:function(elems,context,scripts,selection){for(var j,elem,contains,tmp,tag,tbody,wrap,l=elems.length,safe=createSafeFragment(context),nodes=[],i=0;i<l;i++)if((elem=elems[i])||0===elem)if("object"===jQuery.type(elem))jQuery.merge(nodes,elem.nodeType?[elem]:elem);else if(rhtml.test(elem)){for(tmp=tmp||safe.appendChild(context.createElement("div")),tag=(rtagName.exec(elem)||["",""])[1].toLowerCase(),wrap=wrapMap[tag]||wrapMap._default,tmp.innerHTML=wrap[1]+elem.replace(rxhtmlTag,"<$1></$2>")+wrap[2],j=wrap[0];j--;)tmp=tmp.lastChild;if(!jQuery.support.leadingWhitespace&&rleadingWhitespace.test(elem)&&nodes.push(context.createTextNode(rleadingWhitespace.exec(elem)[0])),!jQuery.support.tbody)for(elem="table"!==tag||rtbody.test(elem)?"<table>"!==wrap[1]||rtbody.test(elem)?0:tmp:tmp.firstChild,j=elem&&elem.childNodes.length;j--;)jQuery.nodeName(tbody=elem.childNodes[j],"tbody")&&!tbody.childNodes.length&&elem.removeChild(tbody);for(jQuery.merge(nodes,tmp.childNodes),tmp.textContent="";tmp.firstChild;)tmp.removeChild(tmp.firstChild);tmp=safe.lastChild}else nodes.push(context.createTextNode(elem));for(tmp&&safe.removeChild(tmp),jQuery.support.appendChecked||jQuery.grep(getAll(nodes,"input"),fixDefaultChecked),i=0;elem=nodes[i++];)if((!selection||-1===jQuery.inArray(elem,selection))&&(contains=jQuery.contains(elem.ownerDocument,elem),tmp=getAll(safe.appendChild(elem),"script"),contains&&setGlobalEval(tmp),scripts))for(j=0;elem=tmp[j++];)rscriptType.test(elem.type||"")&&scripts.push(elem);return tmp=null,safe},cleanData:function(elems,acceptData){for(var elem,type,id,data,i=0,internalKey=jQuery.expando,cache=jQuery.cache,deleteExpando=jQuery.support.deleteExpando,special=jQuery.event.special;null!=(elem=elems[i]);i++)if((acceptData||jQuery.acceptData(elem))&&(id=elem[internalKey],data=id&&cache[id])){if(data.events)for(type in data.events)special[type]?jQuery.event.remove(elem,type):jQuery.removeEvent(elem,type,data.handle);cache[id]&&(delete cache[id],deleteExpando?delete elem[internalKey]:typeof elem.removeAttribute!==core_strundefined?elem.removeAttribute(internalKey):elem[internalKey]=null,core_deletedIds.push(id))}},_evalUrl:function(url){return jQuery.ajax({url:url,type:"GET",dataType:"script",async:!1,global:!1,throws:!0})}}),jQuery.fn.extend({wrapAll:function(html){if(jQuery.isFunction(html))return this.each(function(i){jQuery(this).wrapAll(html.call(this,i))});if(this[0]){var wrap=jQuery(html,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&wrap.insertBefore(this[0]),wrap.map(function(){for(var elem=this;elem.firstChild&&1===elem.firstChild.nodeType;)elem=elem.firstChild;return elem}).append(this)}return this},wrapInner:function(html){return jQuery.isFunction(html)?this.each(function(i){jQuery(this).wrapInner(html.call(this,i))}):this.each(function(){var self=jQuery(this),contents=self.contents();contents.length?contents.wrapAll(html):self.append(html)})},wrap:function(html){var isFunction=jQuery.isFunction(html);return this.each(function(i){
jQuery(this).wrapAll(isFunction?html.call(this,i):html)})},unwrap:function(){return this.parent().each(function(){jQuery.nodeName(this,"body")||jQuery(this).replaceWith(this.childNodes)}).end()}});var iframe,getStyles,curCSS,ralpha=/alpha\([^)]*\)/i,ropacity=/opacity\s*=\s*([^)]*)/,rposition=/^(top|right|bottom|left)$/,rdisplayswap=/^(none|table(?!-c[ea]).+)/,rmargin=/^margin/,rnumsplit=new RegExp("^("+core_pnum+")(.*)$","i"),rnumnonpx=new RegExp("^("+core_pnum+")(?!px)[a-z%]+$","i"),rrelNum=new RegExp("^([+-])=("+core_pnum+")","i"),elemdisplay={BODY:"block"},cssShow={position:"absolute",visibility:"hidden",display:"block"},cssNormalTransform={letterSpacing:0,fontWeight:400},cssExpand=["Top","Right","Bottom","Left"],cssPrefixes=["Webkit","O","Moz","ms"];function vendorPropName(style,name){if(name in style)return name;for(var capName=name.charAt(0).toUpperCase()+name.slice(1),origName=name,i=cssPrefixes.length;i--;)if((name=cssPrefixes[i]+capName)in style)return name;return origName}function isHidden(elem,el){return elem=el||elem,"none"===jQuery.css(elem,"display")||!jQuery.contains(elem.ownerDocument,elem)}function showHide(elements,show){for(var display,elem,hidden,values=[],index=0,length=elements.length;index<length;index++)elem=elements[index],elem.style&&(values[index]=jQuery._data(elem,"olddisplay"),display=elem.style.display,show?(values[index]||"none"!==display||(elem.style.display=""),""===elem.style.display&&isHidden(elem)&&(values[index]=jQuery._data(elem,"olddisplay",css_defaultDisplay(elem.nodeName)))):values[index]||(hidden=isHidden(elem),(display&&"none"!==display||!hidden)&&jQuery._data(elem,"olddisplay",hidden?display:jQuery.css(elem,"display"))));for(index=0;index<length;index++)elem=elements[index],elem.style&&(show&&"none"!==elem.style.display&&""!==elem.style.display||(elem.style.display=show?values[index]||"":"none"));return elements}jQuery.fn.extend({css:function(name,value){return jQuery.access(this,function(elem,name,value){var len,styles,map={},i=0;if(jQuery.isArray(name)){for(styles=getStyles(elem),len=name.length;i<len;i++)map[name[i]]=jQuery.css(elem,name[i],!1,styles);return map}return value!==undefined?jQuery.style(elem,name,value):jQuery.css(elem,name)},name,value,arguments.length>1)},show:function(){return showHide(this,!0)},hide:function(){return showHide(this)},toggle:function(state){return"boolean"==typeof state?state?this.show():this.hide():this.each(function(){isHidden(this)?jQuery(this).show():jQuery(this).hide()})}}),jQuery.extend({cssHooks:{opacity:{get:function(elem,computed){if(computed){var ret=curCSS(elem,"opacity");return""===ret?"1":ret}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{float:jQuery.support.cssFloat?"cssFloat":"styleFloat"},style:function(elem,name,value,extra){if(elem&&3!==elem.nodeType&&8!==elem.nodeType&&elem.style){var ret,type,hooks,origName=jQuery.camelCase(name),style=elem.style;if(name=jQuery.cssProps[origName]||(jQuery.cssProps[origName]=vendorPropName(style,origName)),hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName],value===undefined)return hooks&&"get"in hooks&&(ret=hooks.get(elem,!1,extra))!==undefined?ret:style[name];if(!(type=typeof value,"string"===type&&(ret=rrelNum.exec(value))&&(value=(ret[1]+1)*ret[2]+parseFloat(jQuery.css(elem,name)),type="number"),null==value||"number"===type&&isNaN(value)||("number"!==type||jQuery.cssNumber[origName]||(value+="px"),jQuery.support.clearCloneStyle||""!==value||0!==name.indexOf("background")||(style[name]="inherit"),hooks&&"set"in hooks&&(value=hooks.set(elem,value,extra))===undefined)))try{style[name]=value}catch(e){}}},css:function(elem,name,extra,styles){var num,val,hooks,origName=jQuery.camelCase(name);return name=jQuery.cssProps[origName]||(jQuery.cssProps[origName]=vendorPropName(elem.style,origName)),hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName],hooks&&"get"in hooks&&(val=hooks.get(elem,!0,extra)),val===undefined&&(val=curCSS(elem,name,styles)),"normal"===val&&name in cssNormalTransform&&(val=cssNormalTransform[name]),""===extra||extra?(num=parseFloat(val),!0===extra||jQuery.isNumeric(num)?num||0:val):val}}),window.getComputedStyle?(getStyles=function(elem){return window.getComputedStyle(elem,null)},curCSS=function(elem,name,_computed){var width,minWidth,maxWidth,computed=_computed||getStyles(elem),ret=computed?computed.getPropertyValue(name)||computed[name]:undefined,style=elem.style;return computed&&(""!==ret||jQuery.contains(elem.ownerDocument,elem)||(ret=jQuery.style(elem,name)),rnumnonpx.test(ret)&&rmargin.test(name)&&(width=style.width,minWidth=style.minWidth,maxWidth=style.maxWidth,style.minWidth=style.maxWidth=style.width=ret,ret=computed.width,style.width=width,style.minWidth=minWidth,style.maxWidth=maxWidth)),ret}):document.documentElement.currentStyle&&(getStyles=function(elem){return elem.currentStyle},curCSS=function(elem,name,_computed){var left,rs,rsLeft,computed=_computed||getStyles(elem),ret=computed?computed[name]:undefined,style=elem.style;return null==ret&&style&&style[name]&&(ret=style[name]),rnumnonpx.test(ret)&&!rposition.test(name)&&(left=style.left,rs=elem.runtimeStyle,rsLeft=rs&&rs.left,rsLeft&&(rs.left=elem.currentStyle.left),style.left="fontSize"===name?"1em":ret,ret=style.pixelLeft+"px",style.left=left,rsLeft&&(rs.left=rsLeft)),""===ret?"auto":ret});function setPositiveNumber(elem,value,subtract){var matches=rnumsplit.exec(value);return matches?Math.max(0,matches[1]-(subtract||0))+(matches[2]||"px"):value}function augmentWidthOrHeight(elem,name,extra,isBorderBox,styles){for(var i=extra===(isBorderBox?"border":"content")?4:"width"===name?1:0,val=0;i<4;i+=2)"margin"===extra&&(val+=jQuery.css(elem,extra+cssExpand[i],!0,styles)),isBorderBox?("content"===extra&&(val-=jQuery.css(elem,"padding"+cssExpand[i],!0,styles)),"margin"!==extra&&(val-=jQuery.css(elem,"border"+cssExpand[i]+"Width",!0,styles))):(val+=jQuery.css(elem,"padding"+cssExpand[i],!0,styles),"padding"!==extra&&(val+=jQuery.css(elem,"border"+cssExpand[i]+"Width",!0,styles)));return val}function getWidthOrHeight(elem,name,extra){var valueIsBorderBox=!0,val="width"===name?elem.offsetWidth:elem.offsetHeight,styles=getStyles(elem),isBorderBox=jQuery.support.boxSizing&&"border-box"===jQuery.css(elem,"boxSizing",!1,styles);if(val<=0||null==val){if(val=curCSS(elem,name,styles),(val<0||null==val)&&(val=elem.style[name]),rnumnonpx.test(val))return val;valueIsBorderBox=isBorderBox&&(jQuery.support.boxSizingReliable||val===elem.style[name]),val=parseFloat(val)||0}return val+augmentWidthOrHeight(elem,name,extra||(isBorderBox?"border":"content"),valueIsBorderBox,styles)+"px"}function css_defaultDisplay(nodeName){var doc=document,display=elemdisplay[nodeName];return display||(display=actualDisplay(nodeName,doc),"none"!==display&&display||(iframe=(iframe||jQuery("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(doc.documentElement),doc=(iframe[0].contentWindow||iframe[0].contentDocument).document,doc.write("<!doctype html><html><body>"),doc.close(),display=actualDisplay(nodeName,doc),iframe.detach()),elemdisplay[nodeName]=display),display}function actualDisplay(name,doc){var elem=jQuery(doc.createElement(name)).appendTo(doc.body),display=jQuery.css(elem[0],"display");return elem.remove(),display}jQuery.each(["height","width"],function(i,name){jQuery.cssHooks[name]={get:function(elem,computed,extra){if(computed)return 0===elem.offsetWidth&&rdisplayswap.test(jQuery.css(elem,"display"))?jQuery.swap(elem,cssShow,function(){return getWidthOrHeight(elem,name,extra)}):getWidthOrHeight(elem,name,extra)},set:function(elem,value,extra){var styles=extra&&getStyles(elem);return setPositiveNumber(elem,value,extra?augmentWidthOrHeight(elem,name,extra,jQuery.support.boxSizing&&"border-box"===jQuery.css(elem,"boxSizing",!1,styles),styles):0)}}}),jQuery.support.opacity||(jQuery.cssHooks.opacity={get:function(elem,computed){return ropacity.test((computed&&elem.currentStyle?elem.currentStyle.filter:elem.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":computed?"1":""},set:function(elem,value){var style=elem.style,currentStyle=elem.currentStyle,opacity=jQuery.isNumeric(value)?"alpha(opacity="+100*value+")":"",filter=currentStyle&&currentStyle.filter||style.filter||"";style.zoom=1,(value>=1||""===value)&&""===jQuery.trim(filter.replace(ralpha,""))&&style.removeAttribute&&(style.removeAttribute("filter"),""===value||currentStyle&&!currentStyle.filter)||(style.filter=ralpha.test(filter)?filter.replace(ralpha,opacity):filter+" "+opacity)}}),jQuery(function(){jQuery.support.reliableMarginRight||(jQuery.cssHooks.marginRight={get:function(elem,computed){if(computed)return jQuery.swap(elem,{display:"inline-block"},curCSS,[elem,"marginRight"])}}),!jQuery.support.pixelPosition&&jQuery.fn.position&&jQuery.each(["top","left"],function(i,prop){jQuery.cssHooks[prop]={get:function(elem,computed){if(computed)return computed=curCSS(elem,prop),rnumnonpx.test(computed)?jQuery(elem).position()[prop]+"px":computed}}})}),jQuery.expr&&jQuery.expr.filters&&(jQuery.expr.filters.hidden=function(elem){return elem.offsetWidth<=0&&elem.offsetHeight<=0||!jQuery.support.reliableHiddenOffsets&&"none"===(elem.style&&elem.style.display||jQuery.css(elem,"display"))},jQuery.expr.filters.visible=function(elem){return!jQuery.expr.filters.hidden(elem)}),jQuery.each({margin:"",padding:"",border:"Width"},function(prefix,suffix){jQuery.cssHooks[prefix+suffix]={expand:function(value){for(var i=0,expanded={},parts="string"==typeof value?value.split(" "):[value];i<4;i++)expanded[prefix+cssExpand[i]+suffix]=parts[i]||parts[i-2]||parts[0];return expanded}},rmargin.test(prefix)||(jQuery.cssHooks[prefix+suffix].set=setPositiveNumber)});var r20=/%20/g,rbracket=/\[\]$/,rCRLF=/\r?\n/g,rsubmitterTypes=/^(?:submit|button|image|reset|file)$/i,rsubmittable=/^(?:input|select|textarea|keygen)/i;jQuery.fn.extend({serialize:function(){return jQuery.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var elements=jQuery.prop(this,"elements");return elements?jQuery.makeArray(elements):this}).filter(function(){var type=this.type;return this.name&&!jQuery(this).is(":disabled")&&rsubmittable.test(this.nodeName)&&!rsubmitterTypes.test(type)&&(this.checked||!manipulation_rcheckableType.test(type))}).map(function(i,elem){var val=jQuery(this).val();return null==val?null:jQuery.isArray(val)?jQuery.map(val,function(val){return{name:elem.name,value:val.replace(rCRLF,"\r\n")}}):{name:elem.name,value:val.replace(rCRLF,"\r\n")}}).get()}}),jQuery.param=function(a,traditional){var prefix,s=[],add=function(key,value){value=jQuery.isFunction(value)?value():null==value?"":value,s[s.length]=encodeURIComponent(key)+"="+encodeURIComponent(value)};if(traditional===undefined&&(traditional=jQuery.ajaxSettings&&jQuery.ajaxSettings.traditional),jQuery.isArray(a)||a.jquery&&!jQuery.isPlainObject(a))jQuery.each(a,function(){add(this.name,this.value)});else for(prefix in a)buildParams(prefix,a[prefix],traditional,add);return s.join("&").replace(r20,"+")};function buildParams(prefix,obj,traditional,add){var name;if(jQuery.isArray(obj))jQuery.each(obj,function(i,v){traditional||rbracket.test(prefix)?add(prefix,v):buildParams(prefix+"["+("object"==typeof v?i:"")+"]",v,traditional,add)});else if(traditional||"object"!==jQuery.type(obj))add(prefix,obj);else for(name in obj)buildParams(prefix+"["+name+"]",obj[name],traditional,add)}jQuery.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(i,name){jQuery.fn[name]=function(data,fn){return arguments.length>0?this.on(name,null,data,fn):this.trigger(name)}}),jQuery.fn.extend({hover:function(fnOver,fnOut){return this.mouseenter(fnOver).mouseleave(fnOut||fnOver)},bind:function(types,data,fn){return this.on(types,null,data,fn)},unbind:function(types,fn){return this.off(types,null,fn)},delegate:function(selector,types,data,fn){return this.on(types,selector,data,fn)},undelegate:function(selector,types,fn){return 1===arguments.length?this.off(selector,"**"):this.off(types,selector||"**",fn)}});var ajaxLocParts,ajaxLocation,ajax_nonce=jQuery.now(),ajax_rquery=/\?/,rhash=/#.*$/,rts=/([?&])_=[^&]*/,rheaders=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,rlocalProtocol=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,rnoContent=/^(?:GET|HEAD)$/,rprotocol=/^\/\//,rurl=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,_load=jQuery.fn.load,prefilters={},transports={},allTypes="*/".concat("*");try{ajaxLocation=location.href}catch(e){ajaxLocation=document.createElement("a"),ajaxLocation.href="",ajaxLocation=ajaxLocation.href}ajaxLocParts=rurl.exec(ajaxLocation.toLowerCase())||[];function addToPrefiltersOrTransports(structure){return function(dataTypeExpression,func){"string"!=typeof dataTypeExpression&&(func=dataTypeExpression,dataTypeExpression="*");var dataType,i=0,dataTypes=dataTypeExpression.toLowerCase().match(core_rnotwhite)||[];if(jQuery.isFunction(func))for(;dataType=dataTypes[i++];)"+"===dataType[0]?(dataType=dataType.slice(1)||"*",(structure[dataType]=structure[dataType]||[]).unshift(func)):(structure[dataType]=structure[dataType]||[]).push(func)}}function inspectPrefiltersOrTransports(structure,options,originalOptions,jqXHR){var inspected={},seekingTransport=structure===transports;function inspect(dataType){var selected;return inspected[dataType]=!0,jQuery.each(structure[dataType]||[],function(_,prefilterOrFactory){var dataTypeOrTransport=prefilterOrFactory(options,originalOptions,jqXHR);return"string"!=typeof dataTypeOrTransport||seekingTransport||inspected[dataTypeOrTransport]?seekingTransport?!(selected=dataTypeOrTransport):void 0:(options.dataTypes.unshift(dataTypeOrTransport),inspect(dataTypeOrTransport),!1)}),selected}return inspect(options.dataTypes[0])||!inspected["*"]&&inspect("*")}function ajaxExtend(target,src){var deep,key,flatOptions=jQuery.ajaxSettings.flatOptions||{};for(key in src)src[key]!==undefined&&((flatOptions[key]?target:deep||(deep={}))[key]=src[key]);return deep&&jQuery.extend(!0,target,deep),target}jQuery.fn.load=function(url,params,callback){if("string"!=typeof url&&_load)return _load.apply(this,arguments);var selector,response,type,self=this,off=url.indexOf(" ");return off>=0&&(selector=url.slice(off,url.length),url=url.slice(0,off)),jQuery.isFunction(params)?(callback=params,params=undefined):params&&"object"==typeof params&&(type="POST"),self.length>0&&jQuery.ajax({url:url,type:type,dataType:"html",data:params}).done(function(responseText){response=arguments,self.html(selector?jQuery("<div>").append(jQuery.parseHTML(responseText)).find(selector):responseText)}).complete(callback&&function(jqXHR,status){self.each(callback,response||[jqXHR.responseText,status,jqXHR])}),this},jQuery.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(i,type){jQuery.fn[type]=function(fn){return this.on(type,fn)}}),jQuery.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ajaxLocation,type:"GET",isLocal:rlocalProtocol.test(ajaxLocParts[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":allTypes,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":jQuery.parseJSON,"text xml":jQuery.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(target,settings){return settings?ajaxExtend(ajaxExtend(target,jQuery.ajaxSettings),settings):ajaxExtend(jQuery.ajaxSettings,target)},ajaxPrefilter:addToPrefiltersOrTransports(prefilters),ajaxTransport:addToPrefiltersOrTransports(transports),ajax:function(url,options){"object"==typeof url&&(options=url,url=undefined),options=options||{};var parts,i,cacheURL,responseHeadersString,timeoutTimer,fireGlobals,transport,responseHeaders,s=jQuery.ajaxSetup({},options),callbackContext=s.context||s,globalEventContext=s.context&&(callbackContext.nodeType||callbackContext.jquery)?jQuery(callbackContext):jQuery.event,deferred=jQuery.Deferred(),completeDeferred=jQuery.Callbacks("once memory"),statusCode=s.statusCode||{},requestHeaders={},requestHeadersNames={},state=0,strAbort="canceled",jqXHR={readyState:0,getResponseHeader:function(key){var match;if(2===state){if(!responseHeaders)for(responseHeaders={};match=rheaders.exec(responseHeadersString);)responseHeaders[match[1].toLowerCase()]=match[2];match=responseHeaders[key.toLowerCase()]}return null==match?null:match},getAllResponseHeaders:function(){return 2===state?responseHeadersString:null},setRequestHeader:function(name,value){var lname=name.toLowerCase();return state||(name=requestHeadersNames[lname]=requestHeadersNames[lname]||name,requestHeaders[name]=value),this},overrideMimeType:function(type){return state||(s.mimeType=type),this},statusCode:function(map){var code;if(map)if(state<2)for(code in map)statusCode[code]=[statusCode[code],map[code]];else jqXHR.always(map[jqXHR.status]);return this},abort:function(statusText){var finalText=statusText||strAbort;return transport&&transport.abort(finalText),done(0,finalText),this}};if(deferred.promise(jqXHR).complete=completeDeferred.add,jqXHR.success=jqXHR.done,jqXHR.error=jqXHR.fail,s.url=((url||s.url||ajaxLocation)+"").replace(rhash,"").replace(rprotocol,ajaxLocParts[1]+"//"),s.type=options.method||options.type||s.method||s.type,s.dataTypes=jQuery.trim(s.dataType||"*").toLowerCase().match(core_rnotwhite)||[""],null==s.crossDomain&&(parts=rurl.exec(s.url.toLowerCase()),s.crossDomain=!(!parts||parts[1]===ajaxLocParts[1]&&parts[2]===ajaxLocParts[2]&&(parts[3]||("http:"===parts[1]?"80":"443"))===(ajaxLocParts[3]||("http:"===ajaxLocParts[1]?"80":"443")))),s.data&&s.processData&&"string"!=typeof s.data&&(s.data=jQuery.param(s.data,s.traditional)),inspectPrefiltersOrTransports(prefilters,s,options,jqXHR),2===state)return jqXHR;fireGlobals=s.global,fireGlobals&&0==jQuery.active++&&jQuery.event.trigger("ajaxStart"),s.type=s.type.toUpperCase(),s.hasContent=!rnoContent.test(s.type),cacheURL=s.url,s.hasContent||(s.data&&(cacheURL=s.url+=(ajax_rquery.test(cacheURL)?"&":"?")+s.data,delete s.data),!1===s.cache&&(s.url=rts.test(cacheURL)?cacheURL.replace(rts,"$1_="+ajax_nonce++):cacheURL+(ajax_rquery.test(cacheURL)?"&":"?")+"_="+ajax_nonce++)),s.ifModified&&(jQuery.lastModified[cacheURL]&&jqXHR.setRequestHeader("If-Modified-Since",jQuery.lastModified[cacheURL]),jQuery.etag[cacheURL]&&jqXHR.setRequestHeader("If-None-Match",jQuery.etag[cacheURL])),(s.data&&s.hasContent&&!1!==s.contentType||options.contentType)&&jqXHR.setRequestHeader("Content-Type",s.contentType),jqXHR.setRequestHeader("Accept",s.dataTypes[0]&&s.accepts[s.dataTypes[0]]?s.accepts[s.dataTypes[0]]+("*"!==s.dataTypes[0]?", "+allTypes+"; q=0.01":""):s.accepts["*"]);for(i in s.headers)jqXHR.setRequestHeader(i,s.headers[i]);if(s.beforeSend&&(!1===s.beforeSend.call(callbackContext,jqXHR,s)||2===state))return jqXHR.abort();strAbort="abort";for(i in{success:1,error:1,complete:1})jqXHR[i](s[i]);if(transport=inspectPrefiltersOrTransports(transports,s,options,jqXHR)){jqXHR.readyState=1,fireGlobals&&globalEventContext.trigger("ajaxSend",[jqXHR,s]),s.async&&s.timeout>0&&(timeoutTimer=setTimeout(function(){jqXHR.abort("timeout")},s.timeout));try{state=1,transport.send(requestHeaders,done)}catch(e){if(!(state<2))throw e;done(-1,e)}}else done(-1,"No Transport");function done(status,nativeStatusText,responses,headers){var isSuccess,success,error,response,modified,statusText=nativeStatusText;2!==state&&(state=2,timeoutTimer&&clearTimeout(timeoutTimer),transport=undefined,responseHeadersString=headers||"",jqXHR.readyState=status>0?4:0,isSuccess=status>=200&&status<300||304===status,responses&&(response=ajaxHandleResponses(s,jqXHR,responses)),response=ajaxConvert(s,response,jqXHR,isSuccess),isSuccess?(s.ifModified&&(modified=jqXHR.getResponseHeader("Last-Modified"),modified&&(jQuery.lastModified[cacheURL]=modified),(modified=jqXHR.getResponseHeader("etag"))&&(jQuery.etag[cacheURL]=modified)),204===status||"HEAD"===s.type?statusText="nocontent":304===status?statusText="notmodified":(statusText=response.state,success=response.data,error=response.error,isSuccess=!error)):(error=statusText,!status&&statusText||(statusText="error",status<0&&(status=0))),jqXHR.status=status,jqXHR.statusText=(nativeStatusText||statusText)+"",isSuccess?deferred.resolveWith(callbackContext,[success,statusText,jqXHR]):deferred.rejectWith(callbackContext,[jqXHR,statusText,error]),jqXHR.statusCode(statusCode),statusCode=undefined,fireGlobals&&globalEventContext.trigger(isSuccess?"ajaxSuccess":"ajaxError",[jqXHR,s,isSuccess?success:error]),completeDeferred.fireWith(callbackContext,[jqXHR,statusText]),fireGlobals&&(globalEventContext.trigger("ajaxComplete",[jqXHR,s]),--jQuery.active||jQuery.event.trigger("ajaxStop")))}return jqXHR},getJSON:function(url,data,callback){return jQuery.get(url,data,callback,"json")},getScript:function(url,callback){return jQuery.get(url,undefined,callback,"script")}}),jQuery.each(["get","post"],function(i,method){jQuery[method]=function(url,data,callback,type){return jQuery.isFunction(data)&&(type=type||callback,callback=data,data=undefined),jQuery.ajax({url:url,type:method,dataType:type,data:data,success:callback})}});function ajaxHandleResponses(s,jqXHR,responses){for(var firstDataType,ct,finalDataType,type,contents=s.contents,dataTypes=s.dataTypes;"*"===dataTypes[0];)dataTypes.shift(),ct===undefined&&(ct=s.mimeType||jqXHR.getResponseHeader("Content-Type"));if(ct)for(type in contents)if(contents[type]&&contents[type].test(ct)){dataTypes.unshift(type);break}if(dataTypes[0]in responses)finalDataType=dataTypes[0];else{for(type in responses){if(!dataTypes[0]||s.converters[type+" "+dataTypes[0]]){finalDataType=type;break}firstDataType||(firstDataType=type)}finalDataType=finalDataType||firstDataType}if(finalDataType)return finalDataType!==dataTypes[0]&&dataTypes.unshift(finalDataType),responses[finalDataType]}function ajaxConvert(s,response,jqXHR,isSuccess){var conv2,current,conv,tmp,prev,converters={},dataTypes=s.dataTypes.slice();if(dataTypes[1])for(conv in s.converters)converters[conv.toLowerCase()]=s.converters[conv];for(current=dataTypes.shift();current;)if(s.responseFields[current]&&(jqXHR[s.responseFields[current]]=response),!prev&&isSuccess&&s.dataFilter&&(response=s.dataFilter(response,s.dataType)),prev=current,current=dataTypes.shift())if("*"===current)current=prev;else if("*"!==prev&&prev!==current){if(!(conv=converters[prev+" "+current]||converters["* "+current]))for(conv2 in converters)if(tmp=conv2.split(" "),tmp[1]===current&&(conv=converters[prev+" "+tmp[0]]||converters["* "+tmp[0]])){!0===conv?conv=converters[conv2]:!0!==converters[conv2]&&(current=tmp[0],dataTypes.unshift(tmp[1]));break}if(!0!==conv)if(conv&&s.throws)response=conv(response);else try{response=conv(response)}catch(e){return{state:"parsererror",error:conv?e:"No conversion from "+prev+" to "+current}}}return{state:"success",data:response}}jQuery.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(text){return jQuery.globalEval(text),text}}}),jQuery.ajaxPrefilter("script",function(s){s.cache===undefined&&(s.cache=!1),s.crossDomain&&(s.type="GET",s.global=!1)}),jQuery.ajaxTransport("script",function(s){if(s.crossDomain){var script,head=document.head||jQuery("head")[0]||document.documentElement;return{send:function(_,callback){script=document.createElement("script"),script.async=!0,s.scriptCharset&&(script.charset=s.scriptCharset),script.src=s.url,script.onload=script.onreadystatechange=function(_,isAbort){(isAbort||!script.readyState||/loaded|complete/.test(script.readyState))&&(script.onload=script.onreadystatechange=null,script.parentNode&&script.parentNode.removeChild(script),script=null,isAbort||callback(200,"success"))},head.insertBefore(script,head.firstChild)},abort:function(){script&&script.onload(undefined,!0)}}}});var oldCallbacks=[],rjsonp=/(=)\?(?=&|$)|\?\?/;jQuery.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var callback=oldCallbacks.pop()||jQuery.expando+"_"+ajax_nonce++;return this[callback]=!0,callback}}),jQuery.ajaxPrefilter("json jsonp",function(s,originalSettings,jqXHR){var callbackName,overwritten,responseContainer,jsonProp=!1!==s.jsonp&&(rjsonp.test(s.url)?"url":"string"==typeof s.data&&!(s.contentType||"").indexOf("application/x-www-form-urlencoded")&&rjsonp.test(s.data)&&"data");if(jsonProp||"jsonp"===s.dataTypes[0])return callbackName=s.jsonpCallback=jQuery.isFunction(s.jsonpCallback)?s.jsonpCallback():s.jsonpCallback,jsonProp?s[jsonProp]=s[jsonProp].replace(rjsonp,"$1"+callbackName):!1!==s.jsonp&&(s.url+=(ajax_rquery.test(s.url)?"&":"?")+s.jsonp+"="+callbackName),s.converters["script json"]=function(){return responseContainer||jQuery.error(callbackName+" was not called"),responseContainer[0]},s.dataTypes[0]="json",overwritten=window[callbackName],window[callbackName]=function(){responseContainer=arguments},jqXHR.always(function(){window[callbackName]=overwritten,s[callbackName]&&(s.jsonpCallback=originalSettings.jsonpCallback,oldCallbacks.push(callbackName)),responseContainer&&jQuery.isFunction(overwritten)&&overwritten(responseContainer[0]),responseContainer=overwritten=undefined}),"script"});var xhrCallbacks,xhrSupported,xhrId=0,xhrOnUnloadAbort=window.ActiveXObject&&function(){var key;for(key in xhrCallbacks)xhrCallbacks[key](undefined,!0)};function createStandardXHR(){try{return new window.XMLHttpRequest}catch(e){}}function createActiveXHR(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}jQuery.ajaxSettings.xhr=window.ActiveXObject?function(){return!this.isLocal&&createStandardXHR()||createActiveXHR()}:createStandardXHR,xhrSupported=jQuery.ajaxSettings.xhr(),jQuery.support.cors=!!xhrSupported&&"withCredentials"in xhrSupported,(xhrSupported=jQuery.support.ajax=!!xhrSupported)&&jQuery.ajaxTransport(function(s){if(!s.crossDomain||jQuery.support.cors){var callback;return{send:function(headers,complete){var handle,i,xhr=s.xhr();if(s.username?xhr.open(s.type,s.url,s.async,s.username,s.password):xhr.open(s.type,s.url,s.async),s.xhrFields)for(i in s.xhrFields)xhr[i]=s.xhrFields[i];s.mimeType&&xhr.overrideMimeType&&xhr.overrideMimeType(s.mimeType),s.crossDomain||headers["X-Requested-With"]||(headers["X-Requested-With"]="XMLHttpRequest");try{for(i in headers)xhr.setRequestHeader(i,headers[i])}catch(err){}xhr.send(s.hasContent&&s.data||null),callback=function(_,isAbort){var status,responseHeaders,statusText,responses;try{if(callback&&(isAbort||4===xhr.readyState))if(callback=undefined,handle&&(xhr.onreadystatechange=jQuery.noop,xhrOnUnloadAbort&&delete xhrCallbacks[handle]),isAbort)4!==xhr.readyState&&xhr.abort();else{responses={},status=xhr.status,responseHeaders=xhr.getAllResponseHeaders(),"string"==typeof xhr.responseText&&(responses.text=xhr.responseText);try{statusText=xhr.statusText}catch(e){statusText=""}status||!s.isLocal||s.crossDomain?1223===status&&(status=204):status=responses.text?200:404}}catch(firefoxAccessException){isAbort||complete(-1,firefoxAccessException)}responses&&complete(status,statusText,responses,responseHeaders)},s.async?4===xhr.readyState?setTimeout(callback):(handle=++xhrId,xhrOnUnloadAbort&&(xhrCallbacks||(xhrCallbacks={},jQuery(window).unload(xhrOnUnloadAbort)),xhrCallbacks[handle]=callback),xhr.onreadystatechange=callback):callback()},abort:function(){callback&&callback(undefined,!0)}}}});var fxNow,timerId,rfxtypes=/^(?:toggle|show|hide)$/,rfxnum=new RegExp("^(?:([+-])=|)("+core_pnum+")([a-z%]*)$","i"),rrun=/queueHooks$/,animationPrefilters=[defaultPrefilter],tweeners={"*":[function(prop,value){var tween=this.createTween(prop,value),target=tween.cur(),parts=rfxnum.exec(value),unit=parts&&parts[3]||(jQuery.cssNumber[prop]?"":"px"),start=(jQuery.cssNumber[prop]||"px"!==unit&&+target)&&rfxnum.exec(jQuery.css(tween.elem,prop)),scale=1,maxIterations=20;if(start&&start[3]!==unit){unit=unit||start[3],parts=parts||[],start=+target||1;do{scale=scale||".5",start/=scale,jQuery.style(tween.elem,prop,start+unit)}while(scale!==(scale=tween.cur()/target)&&1!==scale&&--maxIterations)}return parts&&(start=tween.start=+start||+target||0,tween.unit=unit,tween.end=parts[1]?start+(parts[1]+1)*parts[2]:+parts[2]),tween}]};function createFxNow(){return setTimeout(function(){fxNow=undefined}),fxNow=jQuery.now()}function createTween(value,prop,animation){for(var tween,collection=(tweeners[prop]||[]).concat(tweeners["*"]),index=0,length=collection.length;index<length;index++)if(tween=collection[index].call(animation,prop,value))return tween}function Animation(elem,properties,options){var result,stopped,index=0,length=animationPrefilters.length,deferred=jQuery.Deferred().always(function(){delete tick.elem}),tick=function(){if(stopped)return!1;for(var currentTime=fxNow||createFxNow(),remaining=Math.max(0,animation.startTime+animation.duration-currentTime),temp=remaining/animation.duration||0,percent=1-temp,index=0,length=animation.tweens.length;index<length;index++)animation.tweens[index].run(percent);return deferred.notifyWith(elem,[animation,percent,remaining]),percent<1&&length?remaining:(deferred.resolveWith(elem,[animation]),!1)},animation=deferred.promise({elem:elem,props:jQuery.extend({},properties),opts:jQuery.extend(!0,{specialEasing:{}},options),originalProperties:properties,originalOptions:options,startTime:fxNow||createFxNow(),duration:options.duration,tweens:[],createTween:function(prop,end){var tween=jQuery.Tween(elem,animation.opts,prop,end,animation.opts.specialEasing[prop]||animation.opts.easing);return animation.tweens.push(tween),tween},stop:function(gotoEnd){var index=0,length=gotoEnd?animation.tweens.length:0;if(stopped)return this;for(stopped=!0;index<length;index++)animation.tweens[index].run(1);return gotoEnd?deferred.resolveWith(elem,[animation,gotoEnd]):deferred.rejectWith(elem,[animation,gotoEnd]),this}}),props=animation.props;for(propFilter(props,animation.opts.specialEasing);index<length;index++)if(result=animationPrefilters[index].call(animation,elem,props,animation.opts))return result;return jQuery.map(props,createTween,animation),jQuery.isFunction(animation.opts.start)&&animation.opts.start.call(elem,animation),jQuery.fx.timer(jQuery.extend(tick,{elem:elem,anim:animation,queue:animation.opts.queue})),animation.progress(animation.opts.progress).done(animation.opts.done,animation.opts.complete).fail(animation.opts.fail).always(animation.opts.always)}function propFilter(props,specialEasing){var index,name,easing,value,hooks;for(index in props)if(name=jQuery.camelCase(index),easing=specialEasing[name],value=props[index],jQuery.isArray(value)&&(easing=value[1],value=props[index]=value[0]),index!==name&&(props[name]=value,delete props[index]),(hooks=jQuery.cssHooks[name])&&"expand"in hooks){value=hooks.expand(value),delete props[name];for(index in value)index in props||(props[index]=value[index],specialEasing[index]=easing)}else specialEasing[name]=easing}jQuery.Animation=jQuery.extend(Animation,{tweener:function(props,callback){jQuery.isFunction(props)?(callback=props,props=["*"]):props=props.split(" ");for(var prop,index=0,length=props.length;index<length;index++)prop=props[index],tweeners[prop]=tweeners[prop]||[],tweeners[prop].unshift(callback)},prefilter:function(callback,prepend){prepend?animationPrefilters.unshift(callback):animationPrefilters.push(callback)}});function defaultPrefilter(elem,props,opts){
var prop,value,toggle,tween,hooks,oldfire,anim=this,orig={},style=elem.style,hidden=elem.nodeType&&isHidden(elem),dataShow=jQuery._data(elem,"fxshow");opts.queue||(hooks=jQuery._queueHooks(elem,"fx"),null==hooks.unqueued&&(hooks.unqueued=0,oldfire=hooks.empty.fire,hooks.empty.fire=function(){hooks.unqueued||oldfire()}),hooks.unqueued++,anim.always(function(){anim.always(function(){hooks.unqueued--,jQuery.queue(elem,"fx").length||hooks.empty.fire()})})),1===elem.nodeType&&("height"in props||"width"in props)&&(opts.overflow=[style.overflow,style.overflowX,style.overflowY],"inline"===jQuery.css(elem,"display")&&"none"===jQuery.css(elem,"float")&&(jQuery.support.inlineBlockNeedsLayout&&"inline"!==css_defaultDisplay(elem.nodeName)?style.zoom=1:style.display="inline-block")),opts.overflow&&(style.overflow="hidden",jQuery.support.shrinkWrapBlocks||anim.always(function(){style.overflow=opts.overflow[0],style.overflowX=opts.overflow[1],style.overflowY=opts.overflow[2]}));for(prop in props)if(value=props[prop],rfxtypes.exec(value)){if(delete props[prop],toggle=toggle||"toggle"===value,value===(hidden?"hide":"show"))continue;orig[prop]=dataShow&&dataShow[prop]||jQuery.style(elem,prop)}if(!jQuery.isEmptyObject(orig)){dataShow?"hidden"in dataShow&&(hidden=dataShow.hidden):dataShow=jQuery._data(elem,"fxshow",{}),toggle&&(dataShow.hidden=!hidden),hidden?jQuery(elem).show():anim.done(function(){jQuery(elem).hide()}),anim.done(function(){var prop;jQuery._removeData(elem,"fxshow");for(prop in orig)jQuery.style(elem,prop,orig[prop])});for(prop in orig)tween=createTween(hidden?dataShow[prop]:0,prop,anim),prop in dataShow||(dataShow[prop]=tween.start,hidden&&(tween.end=tween.start,tween.start="width"===prop||"height"===prop?1:0))}}function Tween(elem,options,prop,end,easing){return new Tween.prototype.init(elem,options,prop,end,easing)}jQuery.Tween=Tween,Tween.prototype={constructor:Tween,init:function(elem,options,prop,end,easing,unit){this.elem=elem,this.prop=prop,this.easing=easing||"swing",this.options=options,this.start=this.now=this.cur(),this.end=end,this.unit=unit||(jQuery.cssNumber[prop]?"":"px")},cur:function(){var hooks=Tween.propHooks[this.prop];return hooks&&hooks.get?hooks.get(this):Tween.propHooks._default.get(this)},run:function(percent){var eased,hooks=Tween.propHooks[this.prop];return this.options.duration?this.pos=eased=jQuery.easing[this.easing](percent,this.options.duration*percent,0,1,this.options.duration):this.pos=eased=percent,this.now=(this.end-this.start)*eased+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),hooks&&hooks.set?hooks.set(this):Tween.propHooks._default.set(this),this}},Tween.prototype.init.prototype=Tween.prototype,Tween.propHooks={_default:{get:function(tween){var result;return null==tween.elem[tween.prop]||tween.elem.style&&null!=tween.elem.style[tween.prop]?(result=jQuery.css(tween.elem,tween.prop,""),result&&"auto"!==result?result:0):tween.elem[tween.prop]},set:function(tween){jQuery.fx.step[tween.prop]?jQuery.fx.step[tween.prop](tween):tween.elem.style&&(null!=tween.elem.style[jQuery.cssProps[tween.prop]]||jQuery.cssHooks[tween.prop])?jQuery.style(tween.elem,tween.prop,tween.now+tween.unit):tween.elem[tween.prop]=tween.now}}},Tween.propHooks.scrollTop=Tween.propHooks.scrollLeft={set:function(tween){tween.elem.nodeType&&tween.elem.parentNode&&(tween.elem[tween.prop]=tween.now)}},jQuery.each(["toggle","show","hide"],function(i,name){var cssFn=jQuery.fn[name];jQuery.fn[name]=function(speed,easing,callback){return null==speed||"boolean"==typeof speed?cssFn.apply(this,arguments):this.animate(genFx(name,!0),speed,easing,callback)}}),jQuery.fn.extend({fadeTo:function(speed,to,easing,callback){return this.filter(isHidden).css("opacity",0).show().end().animate({opacity:to},speed,easing,callback)},animate:function(prop,speed,easing,callback){var empty=jQuery.isEmptyObject(prop),optall=jQuery.speed(speed,easing,callback),doAnimation=function(){var anim=Animation(this,jQuery.extend({},prop),optall);(empty||jQuery._data(this,"finish"))&&anim.stop(!0)};return doAnimation.finish=doAnimation,empty||!1===optall.queue?this.each(doAnimation):this.queue(optall.queue,doAnimation)},stop:function(type,clearQueue,gotoEnd){var stopQueue=function(hooks){var stop=hooks.stop;delete hooks.stop,stop(gotoEnd)};return"string"!=typeof type&&(gotoEnd=clearQueue,clearQueue=type,type=undefined),clearQueue&&!1!==type&&this.queue(type||"fx",[]),this.each(function(){var dequeue=!0,index=null!=type&&type+"queueHooks",timers=jQuery.timers,data=jQuery._data(this);if(index)data[index]&&data[index].stop&&stopQueue(data[index]);else for(index in data)data[index]&&data[index].stop&&rrun.test(index)&&stopQueue(data[index]);for(index=timers.length;index--;)timers[index].elem!==this||null!=type&&timers[index].queue!==type||(timers[index].anim.stop(gotoEnd),dequeue=!1,timers.splice(index,1));!dequeue&&gotoEnd||jQuery.dequeue(this,type)})},finish:function(type){return!1!==type&&(type=type||"fx"),this.each(function(){var index,data=jQuery._data(this),queue=data[type+"queue"],hooks=data[type+"queueHooks"],timers=jQuery.timers,length=queue?queue.length:0;for(data.finish=!0,jQuery.queue(this,type,[]),hooks&&hooks.stop&&hooks.stop.call(this,!0),index=timers.length;index--;)timers[index].elem===this&&timers[index].queue===type&&(timers[index].anim.stop(!0),timers.splice(index,1));for(index=0;index<length;index++)queue[index]&&queue[index].finish&&queue[index].finish.call(this);delete data.finish})}});function genFx(type,includeWidth){var which,attrs={height:type},i=0;for(includeWidth=includeWidth?1:0;i<4;i+=2-includeWidth)which=cssExpand[i],attrs["margin"+which]=attrs["padding"+which]=type;return includeWidth&&(attrs.opacity=attrs.width=type),attrs}jQuery.each({slideDown:genFx("show"),slideUp:genFx("hide"),slideToggle:genFx("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(name,props){jQuery.fn[name]=function(speed,easing,callback){return this.animate(props,speed,easing,callback)}}),jQuery.speed=function(speed,easing,fn){var opt=speed&&"object"==typeof speed?jQuery.extend({},speed):{complete:fn||!fn&&easing||jQuery.isFunction(speed)&&speed,duration:speed,easing:fn&&easing||easing&&!jQuery.isFunction(easing)&&easing};return opt.duration=jQuery.fx.off?0:"number"==typeof opt.duration?opt.duration:opt.duration in jQuery.fx.speeds?jQuery.fx.speeds[opt.duration]:jQuery.fx.speeds._default,null!=opt.queue&&!0!==opt.queue||(opt.queue="fx"),opt.old=opt.complete,opt.complete=function(){jQuery.isFunction(opt.old)&&opt.old.call(this),opt.queue&&jQuery.dequeue(this,opt.queue)},opt},jQuery.easing={linear:function(p){return p},swing:function(p){return.5-Math.cos(p*Math.PI)/2}},jQuery.timers=[],jQuery.fx=Tween.prototype.init,jQuery.fx.tick=function(){var timer,timers=jQuery.timers,i=0;for(fxNow=jQuery.now();i<timers.length;i++)(timer=timers[i])()||timers[i]!==timer||timers.splice(i--,1);timers.length||jQuery.fx.stop(),fxNow=undefined},jQuery.fx.timer=function(timer){timer()&&jQuery.timers.push(timer)&&jQuery.fx.start()},jQuery.fx.interval=13,jQuery.fx.start=function(){timerId||(timerId=setInterval(jQuery.fx.tick,jQuery.fx.interval))},jQuery.fx.stop=function(){clearInterval(timerId),timerId=null},jQuery.fx.speeds={slow:600,fast:200,_default:400},jQuery.fx.step={},jQuery.expr&&jQuery.expr.filters&&(jQuery.expr.filters.animated=function(elem){return jQuery.grep(jQuery.timers,function(fn){return elem===fn.elem}).length}),jQuery.fn.offset=function(options){if(arguments.length)return options===undefined?this:this.each(function(i){jQuery.offset.setOffset(this,options,i)});var docElem,win,box={top:0,left:0},elem=this[0],doc=elem&&elem.ownerDocument;if(doc)return docElem=doc.documentElement,jQuery.contains(docElem,elem)?(typeof elem.getBoundingClientRect!==core_strundefined&&(box=elem.getBoundingClientRect()),win=getWindow(doc),{top:box.top+(win.pageYOffset||docElem.scrollTop)-(docElem.clientTop||0),left:box.left+(win.pageXOffset||docElem.scrollLeft)-(docElem.clientLeft||0)}):box},jQuery.offset={setOffset:function(elem,options,i){var position=jQuery.css(elem,"position");"static"===position&&(elem.style.position="relative");var curTop,curLeft,curElem=jQuery(elem),curOffset=curElem.offset(),curCSSTop=jQuery.css(elem,"top"),curCSSLeft=jQuery.css(elem,"left"),calculatePosition=("absolute"===position||"fixed"===position)&&jQuery.inArray("auto",[curCSSTop,curCSSLeft])>-1,props={},curPosition={};calculatePosition?(curPosition=curElem.position(),curTop=curPosition.top,curLeft=curPosition.left):(curTop=parseFloat(curCSSTop)||0,curLeft=parseFloat(curCSSLeft)||0),jQuery.isFunction(options)&&(options=options.call(elem,i,curOffset)),null!=options.top&&(props.top=options.top-curOffset.top+curTop),null!=options.left&&(props.left=options.left-curOffset.left+curLeft),"using"in options?options.using.call(elem,props):curElem.css(props)}},jQuery.fn.extend({position:function(){if(this[0]){var offsetParent,offset,parentOffset={top:0,left:0},elem=this[0];return"fixed"===jQuery.css(elem,"position")?offset=elem.getBoundingClientRect():(offsetParent=this.offsetParent(),offset=this.offset(),jQuery.nodeName(offsetParent[0],"html")||(parentOffset=offsetParent.offset()),parentOffset.top+=jQuery.css(offsetParent[0],"borderTopWidth",!0),parentOffset.left+=jQuery.css(offsetParent[0],"borderLeftWidth",!0)),{top:offset.top-parentOffset.top-jQuery.css(elem,"marginTop",!0),left:offset.left-parentOffset.left-jQuery.css(elem,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var offsetParent=this.offsetParent||docElem;offsetParent&&!jQuery.nodeName(offsetParent,"html")&&"static"===jQuery.css(offsetParent,"position");)offsetParent=offsetParent.offsetParent;return offsetParent||docElem})}}),jQuery.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(method,prop){var top=/Y/.test(prop);jQuery.fn[method]=function(val){return jQuery.access(this,function(elem,method,val){var win=getWindow(elem);if(val===undefined)return win?prop in win?win[prop]:win.document.documentElement[method]:elem[method];win?win.scrollTo(top?jQuery(win).scrollLeft():val,top?val:jQuery(win).scrollTop()):elem[method]=val},method,val,arguments.length,null)}});function getWindow(elem){return jQuery.isWindow(elem)?elem:9===elem.nodeType&&(elem.defaultView||elem.parentWindow)}jQuery.each({Height:"height",Width:"width"},function(name,type){jQuery.each({padding:"inner"+name,content:type,"":"outer"+name},function(defaultExtra,funcName){jQuery.fn[funcName]=function(margin,value){var chainable=arguments.length&&(defaultExtra||"boolean"!=typeof margin),extra=defaultExtra||(!0===margin||!0===value?"margin":"border");return jQuery.access(this,function(elem,type,value){var doc;return jQuery.isWindow(elem)?elem.document.documentElement["client"+name]:9===elem.nodeType?(doc=elem.documentElement,Math.max(elem.body["scroll"+name],doc["scroll"+name],elem.body["offset"+name],doc["offset"+name],doc["client"+name])):value===undefined?jQuery.css(elem,type,extra):jQuery.style(elem,type,value,extra)},type,chainable?margin:undefined,chainable,null)}})}),jQuery.fn.size=function(){return this.length},jQuery.fn.andSelf=jQuery.fn.addBack,"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=jQuery:(window.jQuery=window.$=jQuery,"function"==typeof define&&define.amd&&define("jquery",[],function(){return jQuery}))}(window),function(a){var h,i,b="0.3.4",c="hasOwnProperty",d=/[\.\/]/,f=function(){},g=function(a,b){return a-b},j={n:{}},k=function(a,b){var n,d=i,e=Array.prototype.slice.call(arguments,2),f=k.listeners(a),l=0,o=[],p={},q=[],r=h;h=a,i=0;for(var t=0,u=f.length;t<u;t++)"zIndex"in f[t]&&(o.push(f[t].zIndex),f[t].zIndex<0&&(p[f[t].zIndex]=f[t]));for(o.sort(g);o[l]<0;)if(n=p[o[l++]],q.push(n.apply(b,e)),i)return i=d,q;for(t=0;t<u;t++)if("zIndex"in(n=f[t]))if(n.zIndex==o[l]){if(q.push(n.apply(b,e)),i)break;do{if(l++,(n=p[o[l]])&&q.push(n.apply(b,e)),i)break}while(n)}else p[n.zIndex]=n;else if(q.push(n.apply(b,e)),i)break;return i=d,h=r,q.length?q:null};k.listeners=function(a){var f,g,h,i,k,l,m,n,b=a.split(d),c=j,o=[c],p=[];for(i=0,k=b.length;i<k;i++){for(n=[],l=0,m=o.length;l<m;l++)for(c=o[l].n,g=[c[b[i]],c["*"]],h=2;h--;)(f=g[h])&&(n.push(f),p=p.concat(f.f||[]));o=n}return p},k.on=function(a,b){for(var c=a.split(d),e=j,g=0,h=c.length;g<h;g++)e=e.n,!e[c[g]]&&(e[c[g]]={n:{}}),e=e[c[g]];for(e.f=e.f||[],g=0,h=e.f.length;g<h;g++)if(e.f[g]==b)return f;return e.f.push(b),function(a){+a==+a&&(b.zIndex=+a)}},k.stop=function(){i=1},k.nt=function(a){return a?new RegExp("(?:\\.|\\/|^)"+a+"(?:\\.|\\/|$)").test(h):h},k.off=k.unbind=function(a,b){var g,h,i,k,l,m,n,f=a.split(d),o=[j];for(k=0,l=f.length;k<l;k++)for(m=0;m<o.length;m+=i.length-2){if(i=[m,1],g=o[m].n,"*"!=f[k])g[f[k]]&&i.push(g[f[k]]);else for(h in g)g[c](h)&&i.push(g[h]);o.splice.apply(o,i)}for(k=0,l=o.length;k<l;k++)for(g=o[k];g.n;){if(b){if(g.f){for(m=0,n=g.f.length;m<n;m++)if(g.f[m]==b){g.f.splice(m,1);break}!g.f.length&&delete g.f}for(h in g.n)if(g.n[c](h)&&g.n[h].f){var p=g.n[h].f;for(m=0,n=p.length;m<n;m++)if(p[m]==b){p.splice(m,1);break}!p.length&&delete g.n[h].f}}else{delete g.f;for(h in g.n)g.n[c](h)&&g.n[h].f&&delete g.n[h].f}g=g.n}},k.once=function(a,b){var c=function(){var d=b.apply(this,arguments);return k.unbind(a,c),d};return k.on(a,c)},k.version=b,k.toString=function(){return"You are running Eve "+b},"undefined"!=typeof module&&module.exports?module.exports=k:"undefined"!=typeof define?define("eve",[],function(){return k}):a.eve=k}(this),function(){function cF(a){for(var b=0;b<cy.length;b++)cy[b].el.paper==a&&cy.splice(b--,1)}function cE(b,d,e,f,h,i){e=Q(e);var j,k,l,o,p,q,t=b.ms,u={},v={},w={};if(f)for(y=0,z=cy.length;y<z;y++){var x=cy[y];if(x.el.id==d.id&&x.anim==b){x.percent!=e?(cy.splice(y,1),l=1):k=x,d.attr(x.totalOrigin);break}}else f=+v;for(var y=0,z=b.percents.length;y<z;y++){if(b.percents[y]==e||b.percents[y]>f*b.top){e=b.percents[y],p=b.percents[y-1]||0,t=t/b.top*(e-p),o=b.percents[y+1],j=b.anim[e];break}f&&d.attr(b.anim[b.percents[y]])}if(j){if(k)k.initstatus=f,k.start=new Date-k.ms*f;else{for(var A in j)if(j[g](A)&&(U[g](A)||d.paper.customAttributes[g](A)))switch(u[A]=d.attr(A),null==u[A]&&(u[A]=T[A]),v[A]=j[A],U[A]){case C:w[A]=(v[A]-u[A])/t;break;case"colour":u[A]=a.getRGB(u[A]);var B=a.getRGB(v[A]);w[A]={r:(B.r-u[A].r)/t,g:(B.g-u[A].g)/t,b:(B.b-u[A].b)/t};break;case"path":var D=bR(u[A],v[A]),E=D[1];for(u[A]=D[0],w[A]=[],y=0,z=u[A].length;y<z;y++){w[A][y]=[0];for(var F=1,G=u[A][y].length;F<G;F++)w[A][y][F]=(E[y][F]-u[A][y][F])/t}break;case"transform":var H=d._,I=ca(H[A],v[A]);if(I)for(u[A]=I.from,v[A]=I.to,w[A]=[],w[A].real=!0,y=0,z=u[A].length;y<z;y++)for(w[A][y]=[u[A][y][0]],F=1,G=u[A][y].length;F<G;F++)w[A][y][F]=(v[A][y][F]-u[A][y][F])/t;else{var J=d.matrix||new cb,K={_:{transform:H.transform},getBBox:function(){return d.getBBox(1)}};u[A]=[J.a,J.b,J.c,J.d,J.e,J.f],b$(K,v[A]),v[A]=K._.transform,w[A]=[(K.matrix.a-J.a)/t,(K.matrix.b-J.b)/t,(K.matrix.c-J.c)/t,(K.matrix.d-J.d)/t,(K.matrix.e-J.e)/t,(K.matrix.f-J.f)/t]}break;case"csv":var L=r(j[A])[s](c),M=r(u[A])[s](c);if("clip-rect"==A)for(u[A]=M,w[A]=[],y=M.length;y--;)w[A][y]=(L[y]-u[A][y])/t;v[A]=L;break;default:for(L=[][n](j[A]),M=[][n](u[A]),w[A]=[],y=d.paper.customAttributes[A].length;y--;)w[A][y]=((L[y]||0)-(M[y]||0))/t}var O=j.easing,P=a.easing_formulas[O];if(!P)if((P=r(O).match(N))&&5==P.length){var R=P;P=function(a){return cC(a,+R[1],+R[2],+R[3],+R[4],t)}}else P=bf;if(q=j.start||b.start||+new Date,x={anim:b,percent:e,timestamp:q,start:q+(b.del||0),status:0,initstatus:f||0,stop:!1,ms:t,easing:P,from:u,diff:w,to:v,el:d,callback:j.callback,prev:p,next:o,repeat:i||b.times,origin:d.attr(),totalOrigin:h},cy.push(x),f&&!k&&!l&&(x.stop=!0,x.start=new Date-t*f,1==cy.length))return cA();l&&(x.start=new Date-x.ms*f),1==cy.length&&cz(cA)}eve("raphael.anim.start."+d.id,d,b)}}function cD(a,b){var c=[],d={};if(this.ms=b,this.times=1,a){for(var e in a)a[g](e)&&(d[Q(e)]=a[e],c.push(Q(e)));c.sort(bd)}this.anim=d,this.top=c[c.length-1],this.percents=c}function cC(a,b,c,d,e,f){function o(a,b){var c,d,e,f,j,k;for(e=a,k=0;k<8;k++){if(f=m(e)-a,z(f)<b)return e;if(j=(3*i*e+2*h)*e+g,z(j)<1e-6)break;e-=f/j}if(c=0,d=1,e=a,e<c)return c;if(e>d)return d;for(;c<d;){if(f=m(e),z(f-a)<b)return e;a>f?c=e:d=e,e=(d-c)/2+c}return e}function m(a){return((i*a+h)*a+g)*a}var g=3*b,h=3*(d-b)-g,i=1-g-h,j=3*c,k=3*(e-c)-j,l=1-j-k;return function(a,b){var c=o(a,b);return((l*c+k)*c+j)*c}(a,1/(200*f))}function cq(){return this.x+q+this.y+q+this.width+" Ã "+this.height}function cb(a,b,c,d,e,f){null!=a?(this.a=+a,this.b=+b,this.c=+c,this.d=+d,this.e=+e,this.f=+f):(this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0)}function bH(b,c,d){b=a._path2curve(b),c=a._path2curve(c);for(var e,f,g,h,i,j,k,l,m,n,o=d?0:[],p=0,q=b.length;p<q;p++){var r=b[p];if("M"==r[0])e=i=r[1],f=j=r[2];else{"C"==r[0]?(m=[e,f].concat(r.slice(1)),e=m[6],f=m[7]):(m=[e,f,e,f,i,j,i,j],e=i,f=j);for(var s=0,t=c.length;s<t;s++){var u=c[s];if("M"==u[0])g=k=u[1],h=l=u[2];else{"C"==u[0]?(n=[g,h].concat(u.slice(1)),g=n[6],h=n[7]):(n=[g,h,g,h,k,l,k,l],g=k,h=l);var v=bG(m,n,d);if(d)o+=v;else{for(var w=0,x=v.length;w<x;w++)v[w].segment1=p,v[w].segment2=s,v[w].bez1=m,v[w].bez2=n;o=o.concat(v)}}}}}return o}function bG(b,c,d){var e=a.bezierBBox(b),f=a.bezierBBox(c);if(!a.isBBoxIntersect(e,f))return d?0:[];for(var g=bB.apply(0,b),h=bB.apply(0,c),i=~~(g/5),j=~~(h/5),k=[],l=[],m={},n=d?0:[],o=0;o<i+1;o++){var p=a.findDotsAtSegment.apply(a,b.concat(o/i));k.push({x:p.x,y:p.y,t:o/i})}for(o=0;o<j+1;o++)p=a.findDotsAtSegment.apply(a,c.concat(o/j)),l.push({x:p.x,y:p.y,t:o/j});for(o=0;o<i;o++)for(var q=0;q<j;q++){var r=k[o],s=k[o+1],t=l[q],u=l[q+1],v=z(s.x-r.x)<.001?"y":"x",w=z(u.x-t.x)<.001?"y":"x",x=bD(r.x,r.y,s.x,s.y,t.x,t.y,u.x,u.y);if(x){if(m[x.x.toFixed(4)]==x.y.toFixed(4))continue;m[x.x.toFixed(4)]=x.y.toFixed(4);var y=r.t+z((x[v]-r[v])/(s[v]-r[v]))*(s.t-r.t),A=t.t+z((x[w]-t[w])/(u[w]-t[w]))*(u.t-t.t);y>=0&&y<=1&&A>=0&&A<=1&&(d?n++:n.push({x:x.x,y:x.y,t1:y,t2:A}))}}return n}function bD(a,b,c,d,e,f,g,h){if(!(x(a,c)<y(e,g)||y(a,c)>x(e,g)||x(b,d)<y(f,h)||y(b,d)>x(f,h))){var i=(a*d-b*c)*(e-g)-(a-c)*(e*h-f*g),j=(a*d-b*c)*(f-h)-(b-d)*(e*h-f*g),k=(a-c)*(f-h)-(b-d)*(e-g);if(!k)return;var l=i/k,m=j/k,n=+l.toFixed(2),o=+m.toFixed(2);if(n<+y(a,c).toFixed(2)||n>+x(a,c).toFixed(2)||n<+y(e,g).toFixed(2)||n>+x(e,g).toFixed(2)||o<+y(b,d).toFixed(2)||o>+x(b,d).toFixed(2)||o<+y(f,h).toFixed(2)||o>+x(f,h).toFixed(2))return;return{x:l,y:m}}}function bC(a,b,c,d,e,f,g,h,i){if(!(i<0||bB(a,b,c,d,e,f,g,h)<i)){var m,k=.5,l=1-k;for(m=bB(a,b,c,d,e,f,g,h,l);z(m-i)>.01;)k/=2,l+=(m<i?1:-1)*k,m=bB(a,b,c,d,e,f,g,h,l);return l}}function bB(a,b,c,d,e,f,g,h,i){null==i&&(i=1),i=i>1?1:i<0?0:i;for(var j=i/2,l=[-.1252,.1252,-.3678,.3678,-.5873,.5873,-.7699,.7699,-.9041,.9041,-.9816,.9816],m=[.2491,.2491,.2335,.2335,.2032,.2032,.1601,.1601,.1069,.1069,.0472,.0472],n=0,o=0;o<12;o++){var p=j*l[o]+j,q=bA(p,a,c,e,g),r=bA(p,b,d,f,h),s=q*q+r*r;n+=m[o]*w.sqrt(s)}return j*n}function bA(a,b,c,d,e){return a*(a*(-3*b+9*c-9*d+3*e)+6*b-12*c+6*d)-3*b+3*c}function by(a,b){for(var c=[],d=0,e=a.length;e-2*!b>d;d+=2){var f=[{x:+a[d-2],y:+a[d-1]},{x:+a[d],y:+a[d+1]},{x:+a[d+2],y:+a[d+3]},{x:+a[d+4],y:+a[d+5]}];b?d?e-4==d?f[3]={x:+a[0],y:+a[1]}:e-2==d&&(f[2]={x:+a[0],y:+a[1]},f[3]={x:+a[2],y:+a[3]}):f[0]={x:+a[e-2],y:+a[e-1]}:e-4==d?f[3]=f[2]:d||(f[0]={x:+a[d],y:+a[d+1]}),c.push(["C",(-f[0].x+6*f[1].x+f[2].x)/6,(-f[0].y+6*f[1].y+f[2].y)/6,(f[1].x+6*f[2].x-f[3].x)/6,(f[1].y+6*f[2].y-f[3].y)/6,f[2].x,f[2].y])}return c}function bx(){return this.hex}function bv(a,b,c){function d(){var e=Array.prototype.slice.call(arguments,0),f=e.join("â"),h=d.cache=d.cache||{},i=d.count=d.count||[];return h[g](f)?(bu(i,f),c?c(h[f]):h[f]):(i.length>=1e3&&delete h[i.shift()],i.push(f),h[f]=a[m](b,e),c?c(h[f]):h[f])}return d}function bu(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return a.push(a.splice(c,1)[0])}function bm(a){if(Object(a)!==a)return a;var b=new a.constructor;for(var c in a)a[g](c)&&(b[c]=bm(a[c]));return b}function a(c){if(a.is(c,"function"))return b?c():eve.on("raphael.DOMload",c);if(a.is(c,E))return a._engine.create[m](a,c.splice(0,3+a.is(c[0],C))).add(c);var d=Array.prototype.slice.call(arguments,0);if(a.is(d[d.length-1],"function")){var e=d.pop();return b?e.call(a._engine.create[m](a,d)):eve.on("raphael.DOMload",function(){e.call(a._engine.create[m](a,d))})}return a._engine.create[m](a,arguments)}a.version="2.1.0",a.eve=eve;var b,k,c=/[, ]+/,d={circle:1,rect:1,path:1,ellipse:1,text:1,image:1},e=/\{(\d+)\}/g,g="hasOwnProperty",h={doc:document,win:window},i={was:Object.prototype[g].call(h.win,"Raphael"),is:h.win.Raphael},j=function(){this.ca=this.customAttributes={}},m="apply",n="concat",o="createTouch"in h.doc,p="",q=" ",r=String,s="split",t="click dblclick mousedown mousemove mouseout mouseover mouseup touchstart touchmove touchend touchcancel"[s](q),u={mousedown:"touchstart",mousemove:"touchmove",mouseup:"touchend"},v=r.prototype.toLowerCase,w=Math,x=w.max,y=w.min,z=w.abs,A=w.pow,B=w.PI,C="number",D="string",E="array",H=Object.prototype.toString,L=(a._ISURL=/^url\(['"]?([^\)]+?)['"]?\)$/i,/^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgba?\(\s*([\d\.]+%?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+%?(?:\s*,\s*[\d\.]+%?)?)\s*\)|hsba?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsla?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\))\s*$/i),M={NaN:1,Infinity:1,"-Infinity":1},N=/^(?:cubic-)?bezier\(([^,]+),([^,]+),([^,]+),([^\)]+)\)/,O=w.round,Q=parseFloat,R=parseInt,S=r.prototype.toUpperCase,T=a._availableAttrs={"arrow-end":"none","arrow-start":"none",blur:0,"clip-rect":"0 0 1e9 1e9",cursor:"default",cx:0,cy:0,fill:"#fff","fill-opacity":1,font:'10px "Arial"',"font-family":'"Arial"',"font-size":"10","font-style":"normal","font-weight":400,gradient:0,height:0,href:"http://raphaeljs.com/","letter-spacing":0,opacity:1,path:"M0,0",r:0,rx:0,ry:0,src:"",stroke:"#000","stroke-dasharray":"","stroke-linecap":"butt","stroke-linejoin":"butt","stroke-miterlimit":0,"stroke-opacity":1,"stroke-width":1,target:"_blank","text-anchor":"middle",title:"Raphael",transform:"",width:0,x:0,y:0},U=a._availableAnimAttrs={blur:C,"clip-rect":"csv",cx:C,cy:C,fill:"colour","fill-opacity":C,"font-size":C,height:C,opacity:C,path:"path",r:C,rx:C,ry:C,stroke:"colour","stroke-opacity":C,"stroke-width":C,transform:"transform",width:C,x:C,y:C},W=/[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/,X={hs:1,rg:1},Y=/,?([achlmqrstvxz]),?/gi,Z=/([achlmrqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,$=/([rstm])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,_=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/gi,bb=(a._radial_gradient=/^r(?:\(([^,]+?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*([^\)]+?)\))?/,{}),bd=function(a,b){return Q(a)-Q(b)},be=function(){},bf=function(a){return a},bg=a._rectPath=function(a,b,c,d,e){return e?[["M",a+e,b],["l",c-2*e,0],["a",e,e,0,0,1,e,e],["l",0,d-2*e],["a",e,e,0,0,1,-e,e],["l",2*e-c,0],["a",e,e,0,0,1,-e,-e],["l",0,2*e-d],["a",e,e,0,0,1,e,-e],["z"]]:[["M",a,b],["l",c,0],["l",0,d],["l",-c,0],["z"]]},bh=function(a,b,c,d){return null==d&&(d=c),[["M",a,b],["m",0,-d],["a",c,d,0,1,1,0,2*d],["a",c,d,0,1,1,0,-2*d],["z"]]},bi=a._getPath={path:function(a){return a.attr("path")},circle:function(a){var b=a.attrs;return bh(b.cx,b.cy,b.r)},ellipse:function(a){var b=a.attrs;return bh(b.cx,b.cy,b.rx,b.ry)},rect:function(a){var b=a.attrs;return bg(b.x,b.y,b.width,b.height,b.r)},image:function(a){var b=a.attrs;return bg(b.x,b.y,b.width,b.height)},text:function(a){var b=a._getBBox();return bg(b.x,b.y,b.width,b.height)}},bj=a.mapPath=function(a,b){if(!b)return a;var c,d,e,f,g,h,i;for(a=bR(a),e=0,g=a.length;e<g;e++)for(i=a[e],f=1,h=i.length;f<h;f+=2)c=b.x(i[f],i[f+1]),d=b.y(i[f],i[f+1]),i[f]=c,i[f+1]=d;return a};if(a._g=h,a.type=h.win.SVGAngle||h.doc.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML","VML"==a.type){var bl,bk=h.doc.createElement("div");if(bk.innerHTML='<v:shape adj="1"/>',bl=bk.firstChild,bl.style.behavior="url(#default#VML)",!bl||"object"!=typeof bl.adj)return a.type=p;bk=null}a.svg=!(a.vml="VML"==a.type),a._Paper=j,a.fn=k=j.prototype=a.prototype,a._id=0,a._oid=0,a.is=function(a,b){return b=v.call(b),"finite"==b?!M[g](+a):"array"==b?a instanceof Array:"null"==b&&null===a||b==typeof a&&null!==a||"object"==b&&a===Object(a)||"array"==b&&Array.isArray&&Array.isArray(a)||H.call(a).slice(8,-1).toLowerCase()==b},a.angle=function(b,c,d,e,f,g){if(null==f){var h=b-d,i=c-e;return h||i?(180+180*w.atan2(-i,-h)/B+360)%360:0}return a.angle(b,c,f,g)-a.angle(d,e,f,g)},a.rad=function(a){return a%360*B/180},a.deg=function(a){return 180*a/B%360},a.snapTo=function(b,c,d){if(d=a.is(d,"finite")?d:10,a.is(b,E)){for(var e=b.length;e--;)if(z(b[e]-c)<=d)return b[e]}else{b=+b;var f=c%b;if(f<d)return c-f;if(f>b-d)return c-f+b}return c};a.createUUID=function(a,b){return function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(a,b).toUpperCase()}}(/[xy]/g,function(a){var b=16*w.random()|0;return("x"==a?b:3&b|8).toString(16)});a.setWindow=function(b){eve("raphael.setWindow",a,h.win,b),h.win=b,h.doc=h.win.document,a._engine.initWin&&a._engine.initWin(h.win)};var bo=function(b){if(a.vml){var d,c=/^\s+|\s+$/g;try{var e=new ActiveXObject("htmlfile");e.write("<body>"),e.close(),d=e.body}catch(f){d=createPopup().document.body}var g=d.createTextRange();bo=bv(function(a){try{d.style.color=r(a).replace(c,p);var b=g.queryCommandValue("ForeColor");return b=(255&b)<<16|65280&b|(16711680&b)>>>16,"#"+("000000"+b.toString(16)).slice(-6)}catch(e){return"none"}})}else{var i=h.doc.createElement("i");i.title="RaphaÃ«l Colour Picker",i.style.display="none",h.doc.body.appendChild(i),bo=bv(function(a){return i.style.color=a,h.doc.defaultView.getComputedStyle(i,p).getPropertyValue("color")})}return bo(b)},bp=function(){return"hsb("+[this.h,this.s,this.b]+")"},bq=function(){return"hsl("+[this.h,this.s,this.l]+")"},br=function(){return this.hex},bs=function(b,c,d){if(null==c&&a.is(b,"object")&&"r"in b&&"g"in b&&"b"in b&&(d=b.b,c=b.g,b=b.r),null==c&&a.is(b,D)){var e=a.getRGB(b);b=e.r,c=e.g,d=e.b}return(b>1||c>1||d>1)&&(b/=255,c/=255,d/=255),[b,c,d]},bt=function(b,c,d,e){b*=255,c*=255,d*=255;var f={r:b,g:c,b:d,hex:a.rgb(b,c,d),toString:br};return a.is(e,"finite")&&(f.opacity=e),f};a.color=function(b){var c;return a.is(b,"object")&&"h"in b&&"s"in b&&"b"in b?(c=a.hsb2rgb(b),b.r=c.r,b.g=c.g,b.b=c.b,b.hex=c.hex):a.is(b,"object")&&"h"in b&&"s"in b&&"l"in b?(c=a.hsl2rgb(b),b.r=c.r,b.g=c.g,b.b=c.b,b.hex=c.hex):(a.is(b,"string")&&(b=a.getRGB(b)),a.is(b,"object")&&"r"in b&&"g"in b&&"b"in b?(c=a.rgb2hsl(b),b.h=c.h,b.s=c.s,b.l=c.l,c=a.rgb2hsb(b),b.v=c.b):(b={hex:"none"},b.r=b.g=b.b=b.h=b.s=b.v=b.l=-1)),b.toString=br,b},a.hsb2rgb=function(a,b,c,d){this.is(a,"object")&&"h"in a&&"s"in a&&"b"in a&&(c=a.b,b=a.s,a=a.h,d=a.o),a*=360;var e,f,g,h,i;return a=a%360/60,i=c*b,h=i*(1-z(a%2-1)),e=f=g=c-i,a=~~a,e+=[i,h,0,0,h,i][a],f+=[h,i,i,h,0,0][a],g+=[0,0,h,i,i,h][a],bt(e,f,g,d)},a.hsl2rgb=function(a,b,c,d){this.is(a,"object")&&"h"in a&&"s"in a&&"l"in a&&(c=a.l,b=a.s,a=a.h),(a>1||b>1||c>1)&&(a/=360,b/=100,c/=100),a*=360;var e,f,g,h,i;return a=a%360/60,i=2*b*(c<.5?c:1-c),h=i*(1-z(a%2-1)),e=f=g=c-i/2,a=~~a,e+=[i,h,0,0,h,i][a],f+=[h,i,i,h,0,0][a],g+=[0,0,h,i,i,h][a],bt(e,f,g,d)},a.rgb2hsb=function(a,b,c){c=bs(a,b,c),a=c[0],b=c[1],c=c[2];var d,e,f,g;return f=x(a,b,c),g=f-y(a,b,c),d=0==g?null:f==a?(b-c)/g:f==b?(c-a)/g+2:(a-b)/g+4,d=(d+360)%6*60/360,e=0==g?0:g/f,{h:d,s:e,b:f,toString:bp}},a.rgb2hsl=function(a,b,c){c=bs(a,b,c),a=c[0],b=c[1],c=c[2];var d,e,f,g,h,i;return g=x(a,b,c),h=y(a,b,c),i=g-h,d=0==i?null:g==a?(b-c)/i:g==b?(c-a)/i+2:(a-b)/i+4,d=(d+360)%6*60/360,f=(g+h)/2,e=0==i?0:f<.5?i/(2*f):i/(2-2*f),{h:d,s:e,l:f,toString:bq}},a._path2string=function(){return this.join(",").replace(Y,"$1")};a._preload=function(a,b){var c=h.doc.createElement("img");c.style.cssText="position:absolute;left:-9999em;top:-9999em",c.onload=function(){b.call(this),this.onload=null,h.doc.body.removeChild(this)},c.onerror=function(){h.doc.body.removeChild(this)},h.doc.body.appendChild(c),c.src=a};a.getRGB=bv(function(b){if(!b||(b=r(b)).indexOf("-")+1)return{r:-1,g:-1,b:-1,hex:"none",error:1,toString:bx};if("none"==b)return{r:-1,g:-1,b:-1,hex:"none",toString:bx};!X[g](b.toLowerCase().substring(0,2))&&"#"!=b.charAt()&&(b=bo(b));var d,e,f,h,i,j,k=b.match(L);return k?(k[2]&&(f=R(k[2].substring(5),16),e=R(k[2].substring(3,5),16),d=R(k[2].substring(1,3),16)),k[3]&&(f=R((i=k[3].charAt(3))+i,16),e=R((i=k[3].charAt(2))+i,16),d=R((i=k[3].charAt(1))+i,16)),k[4]&&(j=k[4][s](W),d=Q(j[0]),"%"==j[0].slice(-1)&&(d*=2.55),e=Q(j[1]),"%"==j[1].slice(-1)&&(e*=2.55),f=Q(j[2]),"%"==j[2].slice(-1)&&(f*=2.55),"rgba"==k[1].toLowerCase().slice(0,4)&&(h=Q(j[3])),j[3]&&"%"==j[3].slice(-1)&&(h/=100)),k[5]?(j=k[5][s](W),d=Q(j[0]),"%"==j[0].slice(-1)&&(d*=2.55),e=Q(j[1]),"%"==j[1].slice(-1)&&(e*=2.55),f=Q(j[2]),"%"==j[2].slice(-1)&&(f*=2.55),("deg"==j[0].slice(-3)||"Â°"==j[0].slice(-1))&&(d/=360),"hsba"==k[1].toLowerCase().slice(0,4)&&(h=Q(j[3])),j[3]&&"%"==j[3].slice(-1)&&(h/=100),a.hsb2rgb(d,e,f,h)):k[6]?(j=k[6][s](W),d=Q(j[0]),"%"==j[0].slice(-1)&&(d*=2.55),e=Q(j[1]),"%"==j[1].slice(-1)&&(e*=2.55),f=Q(j[2]),"%"==j[2].slice(-1)&&(f*=2.55),("deg"==j[0].slice(-3)||"Â°"==j[0].slice(-1))&&(d/=360),"hsla"==k[1].toLowerCase().slice(0,4)&&(h=Q(j[3])),j[3]&&"%"==j[3].slice(-1)&&(h/=100),a.hsl2rgb(d,e,f,h)):(k={r:d,g:e,b:f,toString:bx},k.hex="#"+(16777216|f|e<<8|d<<16).toString(16).slice(1),a.is(h,"finite")&&(k.opacity=h),k)):{r:-1,g:-1,b:-1,hex:"none",error:1,toString:bx}},a),a.hsb=bv(function(b,c,d){return a.hsb2rgb(b,c,d).hex}),a.hsl=bv(function(b,c,d){return a.hsl2rgb(b,c,d).hex}),a.rgb=bv(function(a,b,c){return"#"+(16777216|c|b<<8|a<<16).toString(16).slice(1)}),a.getColor=function(a){var b=this.getColor.start=this.getColor.start||{h:0,s:1,b:a||.75},c=this.hsb2rgb(b.h,b.s,b.b);return b.h+=.075,b.h>1&&(b.h=0,b.s-=.2,b.s<=0&&(this.getColor.start={h:0,s:1,b:b.b})),c.hex},a.getColor.reset=function(){delete this.start},a.parsePathString=function(b){if(!b)return null;var c=bz(b);if(c.arr)return bJ(c.arr);var d={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},e=[];return a.is(b,E)&&a.is(b[0],E)&&(e=bJ(b)),e.length||r(b).replace(Z,function(a,b,c){var f=[],g=b.toLowerCase();if(c.replace(_,function(a,b){b&&f.push(+b)}),
"m"==g&&f.length>2&&(e.push([b][n](f.splice(0,2))),g="l",b="m"==b?"l":"L"),"r"==g)e.push([b][n](f));else for(;f.length>=d[g]&&(e.push([b][n](f.splice(0,d[g]))),d[g]););}),e.toString=a._path2string,c.arr=bJ(e),e},a.parseTransformString=bv(function(b){if(!b)return null;var d=[];return a.is(b,E)&&a.is(b[0],E)&&(d=bJ(b)),d.length||r(b).replace($,function(a,b,c){var e=[];v.call(b);c.replace(_,function(a,b){b&&e.push(+b)}),d.push([b][n](e))}),d.toString=a._path2string,d});var bz=function(a){var b=bz.ps=bz.ps||{};return b[a]?b[a].sleep=100:b[a]={sleep:100},setTimeout(function(){for(var c in b)b[g](c)&&c!=a&&!--b[c].sleep&&delete b[c]}),b[a]};a.findDotsAtSegment=function(a,b,c,d,e,f,g,h,i){var j=1-i,k=A(j,3),l=A(j,2),m=i*i,n=m*i,o=k*a+3*l*i*c+3*j*i*i*e+n*g,p=k*b+3*l*i*d+3*j*i*i*f+n*h,q=a+2*i*(c-a)+m*(e-2*c+a),r=b+2*i*(d-b)+m*(f-2*d+b),s=c+2*i*(e-c)+m*(g-2*e+c),t=d+2*i*(f-d)+m*(h-2*f+d),u=j*a+i*c,v=j*b+i*d,x=j*e+i*g,y=j*f+i*h,z=90-180*w.atan2(q-s,r-t)/B;return(q>s||r<t)&&(z+=180),{x:o,y:p,m:{x:q,y:r},n:{x:s,y:t},start:{x:u,y:v},end:{x:x,y:y},alpha:z}},a.bezierBBox=function(b,c,d,e,f,g,h,i){a.is(b,"array")||(b=[b,c,d,e,f,g,h,i]);var j=bQ.apply(null,b);return{x:j.min.x,y:j.min.y,x2:j.max.x,y2:j.max.y,width:j.max.x-j.min.x,height:j.max.y-j.min.y}},a.isPointInsideBBox=function(a,b,c){return b>=a.x&&b<=a.x2&&c>=a.y&&c<=a.y2},a.isBBoxIntersect=function(b,c){var d=a.isPointInsideBBox;return d(c,b.x,b.y)||d(c,b.x2,b.y)||d(c,b.x,b.y2)||d(c,b.x2,b.y2)||d(b,c.x,c.y)||d(b,c.x2,c.y)||d(b,c.x,c.y2)||d(b,c.x2,c.y2)||(b.x<c.x2&&b.x>c.x||c.x<b.x2&&c.x>b.x)&&(b.y<c.y2&&b.y>c.y||c.y<b.y2&&c.y>b.y)},a.pathIntersection=function(a,b){return bH(a,b)},a.pathIntersectionNumber=function(a,b){return bH(a,b,1)},a.isPointInsidePath=function(b,c,d){var e=a.pathBBox(b);return a.isPointInsideBBox(e,c,d)&&bH(b,[["M",c,d],["H",e.x2+10]],1)%2==1},a._removedFactory=function(a){return function(){eve("raphael.log",null,"RaphaÃ«l: you are calling to method â"+a+"â of removed object",a)}};var bI=a.pathBBox=function(a){var b=bz(a);if(b.bbox)return b.bbox;if(!a)return{x:0,y:0,width:0,height:0,x2:0,y2:0};a=bR(a);for(var g,c=0,d=0,e=[],f=[],h=0,i=a.length;h<i;h++)if(g=a[h],"M"==g[0])c=g[1],d=g[2],e.push(c),f.push(d);else{var j=bQ(c,d,g[1],g[2],g[3],g[4],g[5],g[6]);e=e[n](j.min.x,j.max.x),f=f[n](j.min.y,j.max.y),c=g[5],d=g[6]}var k=y[m](0,e),l=y[m](0,f),o=x[m](0,e),p=x[m](0,f),q={x:k,y:l,x2:o,y2:p,width:o-k,height:p-l};return b.bbox=bm(q),q},bJ=function(b){var c=bm(b);return c.toString=a._path2string,c},bK=a._pathToRelative=function(b){var c=bz(b);if(c.rel)return bJ(c.rel);a.is(b,E)&&a.is(b&&b[0],E)||(b=a.parsePathString(b));var d=[],e=0,f=0,g=0,h=0,i=0;"M"==b[0][0]&&(e=b[0][1],f=b[0][2],g=e,h=f,i++,d.push(["M",e,f]));for(var j=i,k=b.length;j<k;j++){var l=d[j]=[],m=b[j];if(m[0]!=v.call(m[0]))switch(l[0]=v.call(m[0]),l[0]){case"a":l[1]=m[1],l[2]=m[2],l[3]=m[3],l[4]=m[4],l[5]=m[5],l[6]=+(m[6]-e).toFixed(3),l[7]=+(m[7]-f).toFixed(3);break;case"v":l[1]=+(m[1]-f).toFixed(3);break;case"m":g=m[1],h=m[2];default:for(var n=1,o=m.length;n<o;n++)l[n]=+(m[n]-(n%2?e:f)).toFixed(3)}else{l=d[j]=[],"m"==m[0]&&(g=m[1]+e,h=m[2]+f);for(var p=0,q=m.length;p<q;p++)d[j][p]=m[p]}var r=d[j].length;switch(d[j][0]){case"z":e=g,f=h;break;case"h":e+=+d[j][r-1];break;case"v":f+=+d[j][r-1];break;default:e+=+d[j][r-2],f+=+d[j][r-1]}}return d.toString=a._path2string,c.rel=bJ(d),d},bL=a._pathToAbsolute=function(b){var c=bz(b);if(c.abs)return bJ(c.abs);if(a.is(b,E)&&a.is(b&&b[0],E)||(b=a.parsePathString(b)),!b||!b.length)return[["M",0,0]];var d=[],e=0,f=0,g=0,h=0,i=0;"M"==b[0][0]&&(e=+b[0][1],f=+b[0][2],g=e,h=f,i++,d[0]=["M",e,f]);for(var k,l,j=3==b.length&&"M"==b[0][0]&&"R"==b[1][0].toUpperCase()&&"Z"==b[2][0].toUpperCase(),m=i,o=b.length;m<o;m++){if(d.push(k=[]),l=b[m],l[0]!=S.call(l[0]))switch(k[0]=S.call(l[0]),k[0]){case"A":k[1]=l[1],k[2]=l[2],k[3]=l[3],k[4]=l[4],k[5]=l[5],k[6]=+(l[6]+e),k[7]=+(l[7]+f);break;case"V":k[1]=+l[1]+f;break;case"H":k[1]=+l[1]+e;break;case"R":for(var p=[e,f][n](l.slice(1)),q=2,r=p.length;q<r;q++)p[q]=+p[q]+e,p[++q]=+p[q]+f;d.pop(),d=d[n](by(p,j));break;case"M":g=+l[1]+e,h=+l[2]+f;default:for(q=1,r=l.length;q<r;q++)k[q]=+l[q]+(q%2?e:f)}else if("R"==l[0])p=[e,f][n](l.slice(1)),d.pop(),d=d[n](by(p,j)),k=["R"][n](l.slice(-2));else for(var s=0,t=l.length;s<t;s++)k[s]=l[s];switch(k[0]){case"Z":e=g,f=h;break;case"H":e=k[1];break;case"V":f=k[1];break;case"M":g=k[k.length-2],h=k[k.length-1];default:e=k[k.length-2],f=k[k.length-1]}}return d.toString=a._path2string,c.abs=bJ(d),d},bM=function(a,b,c,d){return[a,b,c,d,c,d]},bN=function(a,b,c,d,e,f){var g=1/3,h=2/3;return[g*a+h*c,g*b+h*d,g*e+h*c,g*f+h*d,e,f]},bO=function(a,b,c,d,e,f,g,h,i,j){var o,k=120*B/180,l=B/180*(+e||0),m=[],p=bv(function(a,b,c){return{x:a*w.cos(c)-b*w.sin(c),y:a*w.sin(c)+b*w.cos(c)}});if(j)E=j[0],F=j[1],C=j[2],D=j[3];else{o=p(a,b,-l),a=o.x,b=o.y,o=p(h,i,-l),h=o.x,i=o.y;var t=(w.cos(B/180*e),w.sin(B/180*e),(a-h)/2),u=(b-i)/2,v=t*t/(c*c)+u*u/(d*d);v>1&&(v=w.sqrt(v),c*=v,d*=v);var x=c*c,y=d*d,A=(f==g?-1:1)*w.sqrt(z((x*y-x*u*u-y*t*t)/(x*u*u+y*t*t))),C=A*c*u/d+(a+h)/2,D=A*-d*t/c+(b+i)/2,E=w.asin(((b-D)/d).toFixed(9)),F=w.asin(((i-D)/d).toFixed(9));E=a<C?B-E:E,F=h<C?B-F:F,E<0&&(E=2*B+E),F<0&&(F=2*B+F),g&&E>F&&(E-=2*B),!g&&F>E&&(F-=2*B)}var G=F-E;if(z(G)>k){var H=F,I=h,J=i;F=E+k*(g&&F>E?1:-1),h=C+c*w.cos(F),i=D+d*w.sin(F),m=bO(h,i,c,d,e,0,g,I,J,[F,H,C,D])}G=F-E;var K=w.cos(E),L=w.sin(E),M=w.cos(F),N=w.sin(F),O=w.tan(G/4),P=4/3*c*O,Q=4/3*d*O,R=[a,b],S=[a+P*L,b-Q*K],T=[h+P*N,i-Q*M],U=[h,i];if(S[0]=2*R[0]-S[0],S[1]=2*R[1]-S[1],j)return[S,T,U][n](m);m=[S,T,U][n](m).join()[s](",");for(var V=[],W=0,X=m.length;W<X;W++)V[W]=W%2?p(m[W-1],m[W],l).y:p(m[W],m[W+1],l).x;return V},bP=function(a,b,c,d,e,f,g,h,i){var j=1-i;return{x:A(j,3)*a+3*A(j,2)*i*c+3*j*i*i*e+A(i,3)*g,y:A(j,3)*b+3*A(j,2)*i*d+3*j*i*i*f+A(i,3)*h}},bQ=bv(function(a,b,c,d,e,f,g,h){var q,i=e-2*c+a-(g-2*e+c),j=2*(c-a)-2*(e-c),k=a-c,l=(-j+w.sqrt(j*j-4*i*k))/2/i,n=(-j-w.sqrt(j*j-4*i*k))/2/i,o=[b,h],p=[a,g];return z(l)>"1e12"&&(l=.5),z(n)>"1e12"&&(n=.5),l>0&&l<1&&(q=bP(a,b,c,d,e,f,g,h,l),p.push(q.x),o.push(q.y)),n>0&&n<1&&(q=bP(a,b,c,d,e,f,g,h,n),p.push(q.x),o.push(q.y)),i=f-2*d+b-(h-2*f+d),j=2*(d-b)-2*(f-d),k=b-d,l=(-j+w.sqrt(j*j-4*i*k))/2/i,n=(-j-w.sqrt(j*j-4*i*k))/2/i,z(l)>"1e12"&&(l=.5),z(n)>"1e12"&&(n=.5),l>0&&l<1&&(q=bP(a,b,c,d,e,f,g,h,l),p.push(q.x),o.push(q.y)),n>0&&n<1&&(q=bP(a,b,c,d,e,f,g,h,n),p.push(q.x),o.push(q.y)),{min:{x:y[m](0,p),y:y[m](0,o)},max:{x:x[m](0,p),y:x[m](0,o)}}}),bR=a._path2curve=bv(function(a,b){var c=!b&&bz(a);if(!b&&c.curve)return bJ(c.curve);for(var d=bL(a),e=b&&bL(b),f={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},g={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},h=(function(a,b){var c,d;if(!a)return["C",b.x,b.y,b.x,b.y,b.x,b.y];switch(!(a[0]in{T:1,Q:1})&&(b.qx=b.qy=null),a[0]){case"M":b.X=a[1],b.Y=a[2];break;case"A":a=["C"][n](bO[m](0,[b.x,b.y][n](a.slice(1))));break;case"S":c=b.x+(b.x-(b.bx||b.x)),d=b.y+(b.y-(b.by||b.y)),a=["C",c,d][n](a.slice(1));break;case"T":b.qx=b.x+(b.x-(b.qx||b.x)),b.qy=b.y+(b.y-(b.qy||b.y)),a=["C"][n](bN(b.x,b.y,b.qx,b.qy,a[1],a[2]));break;case"Q":b.qx=a[1],b.qy=a[2],a=["C"][n](bN(b.x,b.y,a[1],a[2],a[3],a[4]));break;case"L":a=["C"][n](bM(b.x,b.y,a[1],a[2]));break;case"H":a=["C"][n](bM(b.x,b.y,a[1],b.y));break;case"V":a=["C"][n](bM(b.x,b.y,b.x,a[1]));break;case"Z":a=["C"][n](bM(b.x,b.y,b.X,b.Y))}return a}),i=function(a,b){if(a[b].length>7){a[b].shift();for(var c=a[b];c.length;)a.splice(b++,0,["C"][n](c.splice(0,6)));a.splice(b,1),l=x(d.length,e&&e.length||0)}},j=function(a,b,c,f,g){a&&b&&"M"==a[g][0]&&"M"!=b[g][0]&&(b.splice(g,0,["M",f.x,f.y]),c.bx=0,c.by=0,c.x=a[g][1],c.y=a[g][2],l=x(d.length,e&&e.length||0))},k=0,l=x(d.length,e&&e.length||0);k<l;k++){d[k]=h(d[k],f),i(d,k),e&&(e[k]=h(e[k],g)),e&&i(e,k),j(d,e,f,g,k),j(e,d,g,f,k);var o=d[k],p=e&&e[k],q=o.length,r=e&&p.length;f.x=o[q-2],f.y=o[q-1],f.bx=Q(o[q-4])||f.x,f.by=Q(o[q-3])||f.y,g.bx=e&&(Q(p[r-4])||g.x),g.by=e&&(Q(p[r-3])||g.y),g.x=e&&p[r-2],g.y=e&&p[r-1]}return e||(c.curve=bJ(d)),e?[d,e]:d},null,bJ),bT=(a._parseDots=bv(function(b){for(var c=[],d=0,e=b.length;d<e;d++){var f={},g=b[d].match(/^([^:]*):?([\d\.]*)/);if(f.color=a.getRGB(g[1]),f.color.error)return null;f.color=f.color.hex,g[2]&&(f.offset=g[2]+"%"),c.push(f)}for(d=1,e=c.length-1;d<e;d++)if(!c[d].offset){for(var h=Q(c[d-1].offset||0),i=0,j=d+1;j<e;j++)if(c[j].offset){i=c[j].offset;break}i||(i=100,j=e),i=Q(i);for(var k=(i-h)/(j-d+1);d<j;d++)h+=k,c[d].offset=h+"%"}return c}),a._tear=function(a,b){a==b.top&&(b.top=a.prev),a==b.bottom&&(b.bottom=a.next),a.next&&(a.next.prev=a.prev),a.prev&&(a.prev.next=a.next)}),bY=(a._tofront=function(a,b){b.top!==a&&(bT(a,b),a.next=null,a.prev=b.top,b.top.next=a,b.top=a)},a._toback=function(a,b){b.bottom!==a&&(bT(a,b),a.next=b.bottom,a.prev=null,b.bottom.prev=a,b.bottom=a)},a._insertafter=function(a,b,c){bT(a,c),b==c.top&&(c.top=a),b.next&&(b.next.prev=a),a.next=b.next,a.prev=b,b.next=a},a._insertbefore=function(a,b,c){bT(a,c),b==c.bottom&&(c.bottom=a),b.prev&&(b.prev.next=a),a.prev=b.prev,b.prev=a,a.next=b},a.toMatrix=function(a,b){var c=bI(a),d={_:{transform:p},getBBox:function(){return c}};return b$(d,b),d.matrix}),b$=(a.transformPath=function(a,b){return bj(a,bY(a,b))},a._extractTransform=function(b,c){if(null==c)return b._.transform;c=r(c).replace(/\.{3}|\u2026/g,b._.transform||p);var d=a.parseTransformString(c),e=0,f=0,g=0,h=1,i=1,j=b._,k=new cb;if(j.transform=d||[],d)for(var l=0,m=d.length;l<m;l++){var u,v,w,x,y,n=d[l],o=n.length,q=r(n[0]).toLowerCase(),s=n[0]!=q,t=s?k.invert():0;"t"==q&&3==o?s?(u=t.x(0,0),v=t.y(0,0),w=t.x(n[1],n[2]),x=t.y(n[1],n[2]),k.translate(w-u,x-v)):k.translate(n[1],n[2]):"r"==q?2==o?(y=y||b.getBBox(1),k.rotate(n[1],y.x+y.width/2,y.y+y.height/2),e+=n[1]):4==o&&(s?(w=t.x(n[2],n[3]),x=t.y(n[2],n[3]),k.rotate(n[1],w,x)):k.rotate(n[1],n[2],n[3]),e+=n[1]):"s"==q?2==o||3==o?(y=y||b.getBBox(1),k.scale(n[1],n[o-1],y.x+y.width/2,y.y+y.height/2),h*=n[1],i*=n[o-1]):5==o&&(s?(w=t.x(n[3],n[4]),x=t.y(n[3],n[4]),k.scale(n[1],n[2],w,x)):k.scale(n[1],n[2],n[3],n[4]),h*=n[1],i*=n[2]):"m"==q&&7==o&&k.add(n[1],n[2],n[3],n[4],n[5],n[6]),j.dirtyT=1,b.matrix=k}b.matrix=k,j.sx=h,j.sy=i,j.deg=e,j.dx=f=k.e,j.dy=g=k.f,1==h&&1==i&&!e&&j.bbox?(j.bbox.x+=+f,j.bbox.y+=+g):j.dirtyT=1}),b_=function(a){var b=a[0];switch(b.toLowerCase()){case"t":return[b,0,0];case"m":return[b,1,0,0,1,0,0];case"r":return 4==a.length?[b,0,a[2],a[3]]:[b,0];case"s":return 5==a.length?[b,1,1,a[3],a[4]]:3==a.length?[b,1,1]:[b,1]}},ca=a._equaliseTransform=function(b,c){c=r(c).replace(/\.{3}|\u2026/g,b),b=a.parseTransformString(b)||[],c=a.parseTransformString(c)||[];for(var h,i,j,k,d=x(b.length,c.length),e=[],f=[],g=0;g<d;g++){if(j=b[g]||b_(c[g]),k=c[g]||b_(j),j[0]!=k[0]||"r"==j[0].toLowerCase()&&(j[2]!=k[2]||j[3]!=k[3])||"s"==j[0].toLowerCase()&&(j[3]!=k[3]||j[4]!=k[4]))return;for(e[g]=[],f[g]=[],h=0,i=x(j.length,k.length);h<i;h++)h in j&&(e[g][h]=j[h]),h in k&&(f[g][h]=k[h])}return{from:e,to:f}};a._getContainer=function(b,c,d,e){var f;if(null!=(f=null!=e||a.is(b,"object")?b:h.doc.getElementById(b)))return f.tagName?null==c?{container:f,width:f.style.pixelWidth||f.offsetWidth,height:f.style.pixelHeight||f.offsetHeight}:{container:f,width:c,height:d}:{container:1,x:b,y:c,width:d,height:e}},a.pathToRelative=bK,a._engine={},a.path2curve=bR,a.matrix=function(a,b,c,d,e,f){return new cb(a,b,c,d,e,f)},function(b){function d(a){var b=w.sqrt(c(a));a[0]&&(a[0]/=b),a[1]&&(a[1]/=b)}function c(a){return a[0]*a[0]+a[1]*a[1]}b.add=function(a,b,c,d,e,f){var j,k,l,m,g=[[],[],[]],h=[[this.a,this.c,this.e],[this.b,this.d,this.f],[0,0,1]],i=[[a,c,e],[b,d,f],[0,0,1]];for(a&&a instanceof cb&&(i=[[a.a,a.c,a.e],[a.b,a.d,a.f],[0,0,1]]),j=0;j<3;j++)for(k=0;k<3;k++){for(m=0,l=0;l<3;l++)m+=h[j][l]*i[l][k];g[j][k]=m}this.a=g[0][0],this.b=g[1][0],this.c=g[0][1],this.d=g[1][1],this.e=g[0][2],this.f=g[1][2]},b.invert=function(){var a=this,b=a.a*a.d-a.b*a.c;return new cb(a.d/b,-a.b/b,-a.c/b,a.a/b,(a.c*a.f-a.d*a.e)/b,(a.b*a.e-a.a*a.f)/b)},b.clone=function(){return new cb(this.a,this.b,this.c,this.d,this.e,this.f)},b.translate=function(a,b){this.add(1,0,0,1,a,b)},b.scale=function(a,b,c,d){null==b&&(b=a),(c||d)&&this.add(1,0,0,1,c,d),this.add(a,0,0,b,0,0),(c||d)&&this.add(1,0,0,1,-c,-d)},b.rotate=function(b,c,d){b=a.rad(b),c=c||0,d=d||0;var e=+w.cos(b).toFixed(9),f=+w.sin(b).toFixed(9);this.add(e,f,-f,e,c,d),this.add(1,0,0,1,-c,-d)},b.x=function(a,b){return a*this.a+b*this.c+this.e},b.y=function(a,b){return a*this.b+b*this.d+this.f},b.get=function(a){return+this[r.fromCharCode(97+a)].toFixed(4)},b.toString=function(){return a.svg?"matrix("+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)].join()+")":[this.get(0),this.get(2),this.get(1),this.get(3),0,0].join()},b.toFilter=function(){return"progid:DXImageTransform.Microsoft.Matrix(M11="+this.get(0)+", M12="+this.get(2)+", M21="+this.get(1)+", M22="+this.get(3)+", Dx="+this.get(4)+", Dy="+this.get(5)+", sizingmethod='auto expand')"},b.offset=function(){return[this.e.toFixed(4),this.f.toFixed(4)]},b.split=function(){var b={};b.dx=this.e,b.dy=this.f;var e=[[this.a,this.c],[this.b,this.d]];b.scalex=w.sqrt(c(e[0])),d(e[0]),b.shear=e[0][0]*e[1][0]+e[0][1]*e[1][1],e[1]=[e[1][0]-e[0][0]*b.shear,e[1][1]-e[0][1]*b.shear],b.scaley=w.sqrt(c(e[1])),d(e[1]),b.shear/=b.scaley;var f=-e[0][1],g=e[1][1];return g<0?(b.rotate=a.deg(w.acos(g)),f<0&&(b.rotate=360-b.rotate)):b.rotate=a.deg(w.asin(f)),b.isSimple=!(+b.shear.toFixed(9)||b.scalex.toFixed(9)!=b.scaley.toFixed(9)&&b.rotate),b.isSuperSimple=!+b.shear.toFixed(9)&&b.scalex.toFixed(9)==b.scaley.toFixed(9)&&!b.rotate,b.noRotation=!+b.shear.toFixed(9)&&!b.rotate,b},b.toTransformString=function(a){var b=a||this[s]();return b.isSimple?(b.scalex=+b.scalex.toFixed(4),b.scaley=+b.scaley.toFixed(4),b.rotate=+b.rotate.toFixed(4),(b.dx||b.dy?"t"+[b.dx,b.dy]:p)+(1!=b.scalex||1!=b.scaley?"s"+[b.scalex,b.scaley,0,0]:p)+(b.rotate?"r"+[b.rotate,0,0]:p)):"m"+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)]}}(cb.prototype);var cc=navigator.userAgent.match(/Version\/(.*?)\s/)||navigator.userAgent.match(/Chrome\/(\d+)/);"Apple Computer, Inc."==navigator.vendor&&(cc&&cc[1]<4||"iP"==navigator.platform.slice(0,2))||"Google Inc."==navigator.vendor&&cc&&cc[1]<8?k.safari=function(){var a=this.rect(-99,-99,this.width+99,this.height+99).attr({stroke:"none"});setTimeout(function(){a.remove()})}:k.safari=be;for(var cd=function(){this.returnValue=!1},ce=function(){return this.originalEvent.preventDefault()},cf=function(){this.cancelBubble=!0},cg=function(){return this.originalEvent.stopPropagation()},ch=function(){return h.doc.addEventListener?function(a,b,c,d){var e=o&&u[b]?u[b]:b,f=function(e){var f=h.doc.documentElement.scrollTop||h.doc.body.scrollTop,i=h.doc.documentElement.scrollLeft||h.doc.body.scrollLeft,j=e.clientX+i,k=e.clientY+f;if(o&&u[g](b))for(var l=0,m=e.targetTouches&&e.targetTouches.length;l<m;l++)if(e.targetTouches[l].target==a){var n=e;e=e.targetTouches[l],e.originalEvent=n,e.preventDefault=ce,e.stopPropagation=cg;break}return c.call(d,e,j,k)};return a.addEventListener(e,f,!1),function(){return a.removeEventListener(e,f,!1),!0}}:h.doc.attachEvent?function(a,b,c,d){var e=function(a){a=a||h.win.event;var b=h.doc.documentElement.scrollTop||h.doc.body.scrollTop,e=h.doc.documentElement.scrollLeft||h.doc.body.scrollLeft,f=a.clientX+e,g=a.clientY+b;return a.preventDefault=a.preventDefault||cd,a.stopPropagation=a.stopPropagation||cf,c.call(d,a,f,g)};return a.attachEvent("on"+b,e),function(){return a.detachEvent("on"+b,e),!0}}:void 0}(),ci=[],cj=function(a){for(var f,b=a.clientX,c=a.clientY,d=h.doc.documentElement.scrollTop||h.doc.body.scrollTop,e=h.doc.documentElement.scrollLeft||h.doc.body.scrollLeft,g=ci.length;g--;){if(f=ci[g],o){for(var j,i=a.touches.length;i--;)if(j=a.touches[i],j.identifier==f.el._drag.id){b=j.clientX,c=j.clientY,(a.originalEvent?a.originalEvent:a).preventDefault();break}}else a.preventDefault();var l,k=f.el.node,m=k.nextSibling,n=k.parentNode,p=k.style.display;h.win.opera&&n.removeChild(k),k.style.display="none",l=f.el.paper.getElementByPoint(b,c),k.style.display=p,h.win.opera&&(m?n.insertBefore(k,m):n.appendChild(k)),l&&eve("raphael.drag.over."+f.el.id,f.el,l),b+=e,c+=d,eve("raphael.drag.move."+f.el.id,f.move_scope||f.el,b-f.el._drag.x,c-f.el._drag.y,b,c,a)}},ck=function(b){a.unmousemove(cj).unmouseup(ck);for(var d,c=ci.length;c--;)d=ci[c],d.el._drag={},eve("raphael.drag.end."+d.el.id,d.end_scope||d.start_scope||d.move_scope||d.el,b);ci=[]},cl=a.el={},cm=t.length;cm--;)!function(b){a[b]=cl[b]=function(c,d){return a.is(c,"function")&&(this.events=this.events||[],this.events.push({name:b,f:c,unbind:ch(this.shape||this.node||h.doc,b,c,d||this)})),this},a["un"+b]=cl["un"+b]=function(a){for(var c=this.events||[],d=c.length;d--;)if(c[d].name==b&&c[d].f==a)return c[d].unbind(),c.splice(d,1),!c.length&&delete this.events,this;return this}}(t[cm]);cl.data=function(b,c){var d=bb[this.id]=bb[this.id]||{};if(1==arguments.length){if(a.is(b,"object")){for(var e in b)b[g](e)&&this.data(e,b[e]);return this}return eve("raphael.data.get."+this.id,this,d[b],b),d[b]}return d[b]=c,eve("raphael.data.set."+this.id,this,c,b),this},cl.removeData=function(a){return null==a?bb[this.id]={}:bb[this.id]&&delete bb[this.id][a],this},cl.hover=function(a,b,c,d){return this.mouseover(a,c).mouseout(b,d||c)},cl.unhover=function(a,b){return this.unmouseover(a).unmouseout(b)};var cn=[];cl.drag=function(b,c,d,e,f,g){function i(i){(i.originalEvent||i).preventDefault();var j=h.doc.documentElement.scrollTop||h.doc.body.scrollTop,k=h.doc.documentElement.scrollLeft||h.doc.body.scrollLeft;this._drag.x=i.clientX+k,this._drag.y=i.clientY+j,this._drag.id=i.identifier,!ci.length&&a.mousemove(cj).mouseup(ck),ci.push({el:this,move_scope:e,start_scope:f,end_scope:g}),c&&eve.on("raphael.drag.start."+this.id,c),b&&eve.on("raphael.drag.move."+this.id,b),d&&eve.on("raphael.drag.end."+this.id,d),eve("raphael.drag.start."+this.id,f||e||this,i.clientX+k,i.clientY+j,i)}return this._drag={},cn.push({el:this,start:i}),this.mousedown(i),this},cl.onDragOver=function(a){a?eve.on("raphael.drag.over."+this.id,a):eve.unbind("raphael.drag.over."+this.id)},cl.undrag=function(){for(var b=cn.length;b--;)cn[b].el==this&&(this.unmousedown(cn[b].start),cn.splice(b,1),eve.unbind("raphael.drag.*."+this.id));!cn.length&&a.unmousemove(cj).unmouseup(ck)},k.circle=function(b,c,d){var e=a._engine.circle(this,b||0,c||0,d||0);return this.__set__&&this.__set__.push(e),e},k.rect=function(b,c,d,e,f){var g=a._engine.rect(this,b||0,c||0,d||0,e||0,f||0);return this.__set__&&this.__set__.push(g),g},k.ellipse=function(b,c,d,e){var f=a._engine.ellipse(this,b||0,c||0,d||0,e||0);return this.__set__&&this.__set__.push(f),f},k.path=function(b){b&&!a.is(b,D)&&!a.is(b[0],E)&&(b+=p);var c=a._engine.path(a.format[m](a,arguments),this);return this.__set__&&this.__set__.push(c),c},k.image=function(b,c,d,e,f){var g=a._engine.image(this,b||"about:blank",c||0,d||0,e||0,f||0);return this.__set__&&this.__set__.push(g),g},k.text=function(b,c,d){var e=a._engine.text(this,b||0,c||0,r(d));return this.__set__&&this.__set__.push(e),e},k.set=function(b){!a.is(b,"array")&&(b=Array.prototype.splice.call(arguments,0,arguments.length));var c=new cG(b);return this.__set__&&this.__set__.push(c),c},k.setStart=function(a){this.__set__=a||this.set()},k.setFinish=function(a){var b=this.__set__;return delete this.__set__,b},k.setSize=function(b,c){return a._engine.setSize.call(this,b,c)},k.setViewBox=function(b,c,d,e,f){return a._engine.setViewBox.call(this,b,c,d,e,f)},k.top=k.bottom=null,k.raphael=a;var co=function(a){var b=a.getBoundingClientRect(),c=a.ownerDocument,d=c.body,e=c.documentElement,f=e.clientTop||d.clientTop||0,g=e.clientLeft||d.clientLeft||0;return{y:b.top+(h.win.pageYOffset||e.scrollTop||d.scrollTop)-f,x:b.left+(h.win.pageXOffset||e.scrollLeft||d.scrollLeft)-g}};k.getElementByPoint=function(a,b){var c=this,d=c.canvas,e=h.doc.elementFromPoint(a,b);if(h.win.opera&&"svg"==e.tagName){var f=co(d),g=d.createSVGRect();g.x=a-f.x,g.y=b-f.y,g.width=g.height=1;var i=d.getIntersectionList(g,null);i.length&&(e=i[i.length-1])}if(!e)return null;for(;e.parentNode&&e!=d.parentNode&&!e.raphael;)e=e.parentNode;return e==c.canvas.parentNode&&(e=d),e=e&&e.raphael?c.getById(e.raphaelid):null},k.getById=function(a){for(var b=this.bottom;b;){if(b.id==a)return b;b=b.next}return null},k.forEach=function(a,b){for(var c=this.bottom;c;){if(!1===a.call(b,c))return this;c=c.next}return this},k.getElementsByPoint=function(a,b){var c=this.set();return this.forEach(function(d){d.isPointInside(a,b)&&c.push(d)}),c},cl.isPointInside=function(b,c){var d=this.realPath=this.realPath||bi[this.type](this);return a.isPointInsidePath(d,b,c)},cl.getBBox=function(a){if(this.removed)return{};var b=this._;return a?(!b.dirty&&b.bboxwt||(this.realPath=bi[this.type](this),b.bboxwt=bI(this.realPath),b.bboxwt.toString=cq,b.dirty=0),b.bboxwt):((b.dirty||b.dirtyT||!b.bbox)&&(!b.dirty&&this.realPath||(b.bboxwt=0,this.realPath=bi[this.type](this)),b.bbox=bI(bj(this.realPath,this.matrix)),b.bbox.toString=cq,b.dirty=b.dirtyT=0),b.bbox)},cl.clone=function(){if(this.removed)return null;var a=this.paper[this.type]().attr(this.attr());return this.__set__&&this.__set__.push(a),a},cl.glow=function(a){if("text"==this.type)return null;a=a||{};var b={width:(a.width||10)+(+this.attr("stroke-width")||1),fill:a.fill||!1,opacity:a.opacity||.5,offsetx:a.offsetx||0,offsety:a.offsety||0,color:a.color||"#000"},c=b.width/2,d=this.paper,e=d.set(),f=this.realPath||bi[this.type](this);f=this.matrix?bj(f,this.matrix):f;for(var g=1;g<c+1;g++)e.push(d.path(f).attr({stroke:b.color,fill:b.fill?b.color:"none","stroke-linejoin":"round","stroke-linecap":"round","stroke-width":+(b.width/c*g).toFixed(3),opacity:+(b.opacity/c).toFixed(3)}));return e.insertBefore(this).translate(b.offsetx,b.offsety)};var cs=function(b,c,d,e,f,g,h,i,j){return null==j?bB(b,c,d,e,f,g,h,i):a.findDotsAtSegment(b,c,d,e,f,g,h,i,bC(b,c,d,e,f,g,h,i,j))},ct=function(b,c){return function(d,e,f){d=bR(d);for(var g,h,i,j,m,k="",l={},n=0,o=0,p=d.length;o<p;o++){if(i=d[o],"M"==i[0])g=+i[1],h=+i[2];else{if(j=cs(g,h,i[1],i[2],i[3],i[4],i[5],i[6]),n+j>e){if(c&&!l.start){if(m=cs(g,h,i[1],i[2],i[3],i[4],i[5],i[6],e-n),k+=["C"+m.start.x,m.start.y,m.m.x,m.m.y,m.x,m.y],f)return k;l.start=k,k=["M"+m.x,m.y+"C"+m.n.x,m.n.y,m.end.x,m.end.y,i[5],i[6]].join(),n+=j,g=+i[5],h=+i[6];continue}if(!b&&!c)return m=cs(g,h,i[1],i[2],i[3],i[4],i[5],i[6],e-n),{x:m.x,y:m.y,alpha:m.alpha}}n+=j,g=+i[5],h=+i[6]}k+=i.shift()+i}return l.end=k,m=b?n:c?l:a.findDotsAtSegment(g,h,i[0],i[1],i[2],i[3],i[4],i[5],1),m.alpha&&(m={x:m.x,y:m.y,alpha:m.alpha}),m}},cu=ct(1),cv=ct(),cw=ct(0,1);a.getTotalLength=cu,a.getPointAtLength=cv,a.getSubpath=function(a,b,c){if(this.getTotalLength(a)-c<1e-6)return cw(a,b).end;var d=cw(a,c,1);return b?cw(d,b).end:d},cl.getTotalLength=function(){if("path"==this.type)return this.node.getTotalLength?this.node.getTotalLength():cu(this.attrs.path)},cl.getPointAtLength=function(a){if("path"==this.type)return cv(this.attrs.path,a)},cl.getSubpath=function(b,c){if("path"==this.type)return a.getSubpath(this.attrs.path,b,c)};var cx=a.easing_formulas={linear:function(a){return a},"<":function(a){return A(a,1.7)},">":function(a){return A(a,.48)},"<>":function(a){var b=.48-a/1.04,c=w.sqrt(.1734+b*b),d=c-b,e=A(z(d),1/3)*(d<0?-1:1),f=-c-b,g=A(z(f),1/3)*(f<0?-1:1),h=e+g+.5;return 3*(1-h)*h*h+h*h*h},backIn:function(a){var b=1.70158;return a*a*((b+1)*a-b)},backOut:function(a){a-=1;var b=1.70158;return a*a*((b+1)*a+b)+1},elastic:function(a){return a==!!a?a:A(2,-10*a)*w.sin(2*(a-.075)*B/.3)+1},bounce:function(a){var d,b=7.5625,c=2.75;return a<1/c?d=b*a*a:a<2/c?(a-=1.5/c,d=b*a*a+.75):a<2.5/c?(a-=2.25/c,d=b*a*a+.9375):(a-=2.625/c,d=b*a*a+.984375),d}};cx.easeIn=cx["ease-in"]=cx["<"],cx.easeOut=cx["ease-out"]=cx[">"],cx.easeInOut=cx["ease-in-out"]=cx["<>"],cx["back-in"]=cx.backIn,cx["back-out"]=cx.backOut;var cy=[],cz=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){setTimeout(a,16)},cA=function(){for(var b=+new Date,c=0;c<cy.length;c++){var d=cy[c];if(!d.el.removed&&!d.paused){var p,s,e=b-d.start,f=d.ms,h=d.easing,i=d.from,j=d.diff,k=d.to,m=(d.t,d.el),o={},r={};if(d.initstatus?(e=(d.initstatus*d.anim.top-d.prev)/(d.percent-d.prev)*f,d.status=d.initstatus,delete d.initstatus,d.stop&&cy.splice(c--,1)):d.status=(d.prev+(d.percent-d.prev)*(e/f))/d.anim.top,!(e<0))if(e<f){var t=h(e/f);for(var u in i)if(i[g](u)){switch(U[u]){case C:p=+i[u]+t*f*j[u];break;case"colour":p="rgb("+[cB(O(i[u].r+t*f*j[u].r)),cB(O(i[u].g+t*f*j[u].g)),cB(O(i[u].b+t*f*j[u].b))].join(",")+")";break;case"path":p=[];for(var v=0,w=i[u].length;v<w;v++){p[v]=[i[u][v][0]];for(var x=1,y=i[u][v].length;x<y;x++)p[v][x]=+i[u][v][x]+t*f*j[u][v][x];p[v]=p[v].join(q)}p=p.join(q);break;case"transform":if(j[u].real)for(p=[],v=0,w=i[u].length;v<w;v++)for(p[v]=[i[u][v][0]],x=1,y=i[u][v].length;x<y;x++)p[v][x]=i[u][v][x]+t*f*j[u][v][x];else{var z=function(a){return+i[u][a]+t*f*j[u][a]};p=[["m",z(0),z(1),z(2),z(3),z(4),z(5)]]}break;case"csv":if("clip-rect"==u)for(p=[],v=4;v--;)p[v]=+i[u][v]+t*f*j[u][v];break;default:var A=[][n](i[u]);for(p=[],v=m.paper.customAttributes[u].length;v--;)p[v]=+A[v]+t*f*j[u][v]}o[u]=p}m.attr(o),function(a,b,c){setTimeout(function(){eve("raphael.anim.frame."+a,b,c)})}(m.id,m,d.anim)}else{if(function(b,c,d){setTimeout(function(){eve("raphael.anim.frame."+c.id,c,d),eve("raphael.anim.finish."+c.id,c,d),a.is(b,"function")&&b.call(c)})}(d.callback,m,d.anim),m.attr(k),cy.splice(c--,1),d.repeat>1&&!d.next){for(s in k)k[g](s)&&(r[s]=d.totalOrigin[s]);d.el.attr(r),cE(d.anim,d.el,d.anim.percents[0],null,d.totalOrigin,d.repeat-1)}d.next&&!d.stop&&cE(d.anim,d.el,d.next,null,d.totalOrigin,d.repeat)}}}a.svg&&m&&m.paper&&m.paper.safari(),cy.length&&cz(cA)},cB=function(a){return a>255?255:a<0?0:a};cl.animateWith=function(b,c,d,e,f,g){var h=this;if(h.removed)return g&&g.call(h),h;var i=d instanceof cD?d:a.animation(d,e,f,g);cE(i,h,i.percents[0],null,h.attr());for(var l=0,m=cy.length;l<m;l++)if(cy[l].anim==c&&cy[l].el==b){cy[m-1].start=cy[l].start;break}return h},cl.onAnimation=function(a){return a?eve.on("raphael.anim.frame."+this.id,a):eve.unbind("raphael.anim.frame."+this.id),this},cD.prototype.delay=function(a){var b=new cD(this.anim,this.ms);return b.times=this.times,b.del=+a||0,b},cD.prototype.repeat=function(a){var b=new cD(this.anim,this.ms);return b.del=this.del,b.times=w.floor(x(a,0))||1,b},a.animation=function(b,c,d,e){if(b instanceof cD)return b;!a.is(d,"function")&&d||(e=e||d||null,d=null),b=Object(b),c=+c||0;var h,i,f={};for(i in b)b[g](i)&&Q(i)!=i&&Q(i)+"%"!=i&&(h=!0,f[i]=b[i]);return h?(d&&(f.easing=d),e&&(f.callback=e),new cD({100:f},c)):new cD(b,c)},cl.animate=function(b,c,d,e){var f=this;if(f.removed)return e&&e.call(f),f;var g=b instanceof cD?b:a.animation(b,c,d,e);return cE(g,f,g.percents[0],null,f.attr()),f},cl.setTime=function(a,b){return a&&null!=b&&this.status(a,y(b,a.ms)/a.ms),this},cl.status=function(a,b){var e,f,c=[],d=0;if(null!=b)return cE(a,this,-1,y(b,1)),this;for(e=cy.length;d<e;d++)if(f=cy[d],f.el.id==this.id&&(!a||f.anim==a)){if(a)return f.status;c.push({anim:f.anim,status:f.status})}return a?0:c},cl.pause=function(a){for(var b=0;b<cy.length;b++)cy[b].el.id==this.id&&(!a||cy[b].anim==a)&&!1!==eve("raphael.anim.pause."+this.id,this,cy[b].anim)&&(cy[b].paused=!0);return this},cl.resume=function(a){for(var b=0;b<cy.length;b++)if(cy[b].el.id==this.id&&(!a||cy[b].anim==a)){var c=cy[b];!1!==eve("raphael.anim.resume."+this.id,this,c.anim)&&(delete c.paused,this.status(c.anim,c.status))}return this},cl.stop=function(a){for(var b=0;b<cy.length;b++)cy[b].el.id==this.id&&(!a||cy[b].anim==a)&&!1!==eve("raphael.anim.stop."+this.id,this,cy[b].anim)&&cy.splice(b--,1);return this},eve.on("raphael.remove",cF),eve.on("raphael.clear",cF),cl.toString=function(){return"RaphaÃ«lâs object"};var cG=function(a){if(this.items=[],this.length=0,this.type="set",a)for(var b=0,c=a.length;b<c;b++)a[b]&&(a[b].constructor==cl.constructor||a[b].constructor==cG)&&(this[this.items.length]=this.items[this.items.length]=a[b],this.length++)},cH=cG.prototype;cH.push=function(){for(var a,b,c=0,d=arguments.length;c<d;c++)(a=arguments[c])&&(a.constructor==cl.constructor||a.constructor==cG)&&(b=this.items.length,this[b]=this.items[b]=a,this.length++);return this},cH.pop=function(){return this.length&&delete this[this.length--],this.items.pop()},cH.forEach=function(a,b){for(var c=0,d=this.items.length;c<d;c++)if(!1===a.call(b,this.items[c],c))return this;return this};for(var cI in cl)cl[g](cI)&&(cH[cI]=function(a){return function(){var b=arguments;return this.forEach(function(c){c[a][m](c,b)})}}(cI));cH.attr=function(b,c){if(b&&a.is(b,E)&&a.is(b[0],"object"))for(var d=0,e=b.length;d<e;d++)this.items[d].attr(b[d]);else for(var f=0,g=this.items.length;f<g;f++)this.items[f].attr(b,c);return this},cH.clear=function(){for(;this.length;)this.pop()},cH.splice=function(a,b,c){a=a<0?x(this.length+a,0):a,b=x(0,y(this.length-a,b));var g,d=[],e=[],f=[];for(g=2;g<arguments.length;g++)f.push(arguments[g]);for(g=0;g<b;g++)e.push(this[a+g]);for(;g<this.length-a;g++)d.push(this[a+g]);var h=f.length;for(g=0;g<h+d.length;g++)this.items[a+g]=this[a+g]=g<h?f[g]:d[g-h];for(g=this.items.length=this.length-=b-h;this[g];)delete this[g++];return new cG(e)},cH.exclude=function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]==a)return this.splice(b,1),!0},cH.animate=function(b,c,d,e){(a.is(d,"function")||!d)&&(e=d||null);var h,j,f=this.items.length,g=f,i=this;if(!f)return this;e&&(j=function(){!--f&&e.call(i)}),d=a.is(d,D)?d:j;var k=a.animation(b,c,d,j);for(h=this.items[--g].animate(k);g--;)this.items[g]&&!this.items[g].removed&&this.items[g].animateWith(h,k,k);return this},cH.insertAfter=function(a){for(var b=this.items.length;b--;)this.items[b].insertAfter(a);return this},cH.getBBox=function(){for(var a=[],b=[],c=[],d=[],e=this.items.length;e--;)if(!this.items[e].removed){var f=this.items[e].getBBox();a.push(f.x),b.push(f.y),c.push(f.x+f.width),d.push(f.y+f.height)}return a=y[m](0,a),b=y[m](0,b),c=x[m](0,c),d=x[m](0,d),{x:a,y:b,x2:c,y2:d,width:c-a,height:d-b}},cH.clone=function(a){a=new cG;for(var b=0,c=this.items.length;b<c;b++)a.push(this.items[b].clone());return a},cH.toString=function(){return"RaphaÃ«lâs set"},a.registerFont=function(a){if(!a.face)return a;this.fonts=this.fonts||{};var b={w:a.w,face:{},glyphs:{}},c=a.face["font-family"];for(var d in a.face)a.face[g](d)&&(b.face[d]=a.face[d]);if(this.fonts[c]?this.fonts[c].push(b):this.fonts[c]=[b],!a.svg){b.face["units-per-em"]=R(a.face["units-per-em"],10);for(var e in a.glyphs)if(a.glyphs[g](e)){var f=a.glyphs[e];if(b.glyphs[e]={w:f.w,k:{},d:f.d&&"M"+f.d.replace(/[mlcxtrv]/g,function(a){return{l:"L",c:"C",x:"z",t:"m",r:"l",v:"c"}[a]||"M"})+"z"},f.k)for(var h in f.k)f[g](h)&&(b.glyphs[e].k[h]=f.k[h])}}return a},k.getFont=function(b,c,d,e){if(e=e||"normal",d=d||"normal",c=+c||{normal:400,bold:700,lighter:300,bolder:800}[c]||400,a.fonts){var f=a.fonts[b];if(!f){var h=new RegExp("(^|\\s)"+b.replace(/[^\w\d\s+!~.:_-]/g,p)+"(\\s|$)","i");for(var i in a.fonts)if(a.fonts[g](i)&&h.test(i)){f=a.fonts[i];break}}var j;if(f)for(var k=0,l=f.length;k<l&&(j=f[k],j.face["font-weight"]!=c||j.face["font-style"]!=d&&j.face["font-style"]||j.face["font-stretch"]!=e);k++);return j}},k.print=function(b,d,e,f,g,h,i){h=h||"middle",i=x(y(i||0,1),-1);var n,j=r(e)[s](p),k=0,l=0,m=p;if(a.is(f,e)&&(f=this.getFont(f)),f){n=(g||16)/f.face["units-per-em"];for(var o=f.face.bbox[s](c),q=+o[0],t=o[3]-o[1],u=0,v=+o[1]+("baseline"==h?t+ +f.face.descent:t/2),w=0,z=j.length;w<z;w++){if("\n"==j[w])k=0,B=0,l=0,u+=t;else{var A=l&&f.glyphs[j[w-1]]||{},B=f.glyphs[j[w]];k+=l?(A.w||f.w)+(A.k&&A.k[j[w]]||0)+f.w*i:0,l=1}B&&B.d&&(m+=a.transformPath(B.d,["t",k*n,u*n,"s",n,n,q,v,"t",(b-q)/n,(d-v)/n]))}}return this.path(m).attr({fill:"#000",stroke:"none"})},k.add=function(b){
if(a.is(b,"array"))for(var h,c=this.set(),e=0,f=b.length;e<f;e++)h=b[e]||{},d[g](h.type)&&c.push(this[h.type]().attr(h));return c},a.format=function(b,c){var d=a.is(c,E)?[0][n](c):arguments;return b&&a.is(b,D)&&d.length-1&&(b=b.replace(e,function(a,b){return null==d[++b]?p:d[b]})),b||p},a.fullfill=function(){var a=/\{([^\}]+)\}/g,b=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,c=function(a,c,d){var e=d;return c.replace(b,function(a,b,c,d,f){b=b||d,e&&(b in e&&(e=e[b]),"function"==typeof e&&f&&(e=e()))}),e=(null==e||e==d?a:e)+""};return function(b,d){return String(b).replace(a,function(a,b){return c(a,b,d)})}}(),a.ninja=function(){return i.was?h.win.Raphael=i.is:delete Raphael,a},a.st=cH,function(b,c,d){function e(){/in/.test(b.readyState)?setTimeout(e,9):a.eve("raphael.DOMload")}null==b.readyState&&b.addEventListener&&(b.addEventListener(c,d=function(){b.removeEventListener(c,d,!1),b.readyState="complete"},!1),b.readyState="loading"),e()}(document,"DOMContentLoaded"),i.was?h.win.Raphael=a:Raphael=a,eve.on("raphael.DOMload",function(){b=!0})}(),window.Raphael.svg&&function(a){var b="hasOwnProperty",c=String,d=parseFloat,e=parseInt,f=Math,g=f.max,h=f.abs,i=f.pow,j=/[, ]+/,k=a.eve,l="",m=" ",n="http://www.w3.org/1999/xlink",o={block:"M5,0 0,2.5 5,5z",classic:"M5,0 0,2.5 5,5 3.5,3 3.5,2z",diamond:"M2.5,0 5,2.5 2.5,5 0,2.5z",open:"M6,1 1,3.5 6,6",oval:"M2.5,0A2.5,2.5,0,0,1,2.5,5 2.5,2.5,0,0,1,2.5,0z"},p={};a.toString=function(){return"Your browser supports SVG.\nYou are running RaphaÃ«l "+this.version};var q=function(d,e){if(e){"string"==typeof d&&(d=q(d));for(var f in e)e[b](f)&&("xlink:"==f.substring(0,6)?d.setAttributeNS(n,f.substring(6),c(e[f])):d.setAttribute(f,c(e[f])))}else d=a._g.doc.createElementNS("http://www.w3.org/2000/svg",d),d.style&&(d.style.webkitTapHighlightColor="rgba(0,0,0,0)");return d},r=function(b,e){var j="linear",k=b.id+e,m=.5,n=.5,o=b.node,p=b.paper,r=o.style,s=a._g.doc.getElementById(k);if(!s){if(e=c(e).replace(a._radial_gradient,function(a,b,c){if(j="radial",b&&c){m=d(b),n=d(c);var e=2*(n>.5)-1;i(m-.5,2)+i(n-.5,2)>.25&&(n=f.sqrt(.25-i(m-.5,2))*e+.5)&&.5!=n&&(n=n.toFixed(5)-1e-5*e)}return l}),e=e.split(/\s*\-\s*/),"linear"==j){var t=e.shift();if(t=-d(t),isNaN(t))return null;var u=[0,0,f.cos(a.rad(t)),f.sin(a.rad(t))],v=1/(g(h(u[2]),h(u[3]))||1);u[2]*=v,u[3]*=v,u[2]<0&&(u[0]=-u[2],u[2]=0),u[3]<0&&(u[1]=-u[3],u[3]=0)}var w=a._parseDots(e);if(!w)return null;if(k=k.replace(/[\(\)\s,\xb0#]/g,"_"),b.gradient&&k!=b.gradient.id&&(p.defs.removeChild(b.gradient),delete b.gradient),!b.gradient){s=q(j+"Gradient",{id:k}),b.gradient=s,q(s,"radial"==j?{fx:m,fy:n}:{x1:u[0],y1:u[1],x2:u[2],y2:u[3],gradientTransform:b.matrix.invert()}),p.defs.appendChild(s);for(var x=0,y=w.length;x<y;x++)s.appendChild(q("stop",{offset:w[x].offset?w[x].offset:x?"100%":"0%","stop-color":w[x].color||"#fff"}))}}return q(o,{fill:"url(#"+k+")",opacity:1,"fill-opacity":1}),r.fill=l,r.opacity=1,r.fillOpacity=1,1},s=function(a){var b=a.getBBox(1);q(a.pattern,{patternTransform:a.matrix.invert()+" translate("+b.x+","+b.y+")"})},t=function(d,e,f){if("path"==d.type){for(var s,t,u,v,w,g=c(e).toLowerCase().split("-"),h=d.paper,i=f?"end":"start",j=d.node,k=d.attrs,m=k["stroke-width"],n=g.length,r="classic",x=3,y=3,z=5;n--;)switch(g[n]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":r=g[n];break;case"wide":y=5;break;case"narrow":y=2;break;case"long":x=5;break;case"short":x=2}if("open"==r?(x+=2,y+=2,z+=2,u=1,v=f?4:1,w={fill:"none",stroke:k.stroke}):(v=u=x/2,w={fill:k.stroke,stroke:"none"}),d._.arrows?f?(d._.arrows.endPath&&p[d._.arrows.endPath]--,d._.arrows.endMarker&&p[d._.arrows.endMarker]--):(d._.arrows.startPath&&p[d._.arrows.startPath]--,d._.arrows.startMarker&&p[d._.arrows.startMarker]--):d._.arrows={},"none"!=r){var A="raphael-marker-"+r,B="raphael-marker-"+i+r+x+y;a._g.doc.getElementById(A)?p[A]++:(h.defs.appendChild(q(q("path"),{"stroke-linecap":"round",d:o[r],id:A})),p[A]=1);var D,C=a._g.doc.getElementById(B);C?(p[B]++,D=C.getElementsByTagName("use")[0]):(C=q(q("marker"),{id:B,markerHeight:y,markerWidth:x,orient:"auto",refX:v,refY:y/2}),D=q(q("use"),{"xlink:href":"#"+A,transform:(f?"rotate(180 "+x/2+" "+y/2+") ":l)+"scale("+x/z+","+y/z+")","stroke-width":(1/((x/z+y/z)/2)).toFixed(4)}),C.appendChild(D),h.defs.appendChild(C),p[B]=1),q(D,w);var F=u*("diamond"!=r&&"oval"!=r);f?(s=d._.arrows.startdx*m||0,t=a.getTotalLength(k.path)-F*m):(s=F*m,t=a.getTotalLength(k.path)-(d._.arrows.enddx*m||0)),w={},w["marker-"+i]="url(#"+B+")",(t||s)&&(w.d=Raphael.getSubpath(k.path,s,t)),q(j,w),d._.arrows[i+"Path"]=A,d._.arrows[i+"Marker"]=B,d._.arrows[i+"dx"]=F,d._.arrows[i+"Type"]=r,d._.arrows[i+"String"]=e}else f?(s=d._.arrows.startdx*m||0,t=a.getTotalLength(k.path)-s):(s=0,t=a.getTotalLength(k.path)-(d._.arrows.enddx*m||0)),d._.arrows[i+"Path"]&&q(j,{d:Raphael.getSubpath(k.path,s,t)}),delete d._.arrows[i+"Path"],delete d._.arrows[i+"Marker"],delete d._.arrows[i+"dx"],delete d._.arrows[i+"Type"],delete d._.arrows[i+"String"];for(w in p)if(p[b](w)&&!p[w]){var G=a._g.doc.getElementById(w);G&&G.parentNode.removeChild(G)}}},u={"":[0],none:[0],"-":[3,1],".":[1,1],"-.":[3,1,1,1],"-..":[3,1,1,1,1,1],". ":[1,3],"- ":[4,3],"--":[8,3],"- .":[4,3,1,3],"--.":[8,3,1,3],"--..":[8,3,1,3,1,3]},v=function(a,b,d){if(b=u[c(b).toLowerCase()]){for(var e=a.attrs["stroke-width"]||"1",f={round:e,square:e,butt:0}[a.attrs["stroke-linecap"]||d["stroke-linecap"]]||0,g=[],h=b.length;h--;)g[h]=b[h]*e+(h%2?1:-1)*f;q(a.node,{"stroke-dasharray":g.join(",")})}},w=function(d,f){var i=d.node,k=d.attrs,m=i.style.visibility;i.style.visibility="hidden";for(var o in f)if(f[b](o)){if(!a._availableAttrs[b](o))continue;var p=f[o];switch(k[o]=p,o){case"blur":d.blur(p);break;case"href":case"title":case"target":var u=i.parentNode;if("a"!=u.tagName.toLowerCase()){var w=q("a");u.insertBefore(w,i),w.appendChild(i),u=w}"target"==o?u.setAttributeNS(n,"show","blank"==p?"new":p):u.setAttributeNS(n,o,p);break;case"cursor":i.style.cursor=p;break;case"transform":d.transform(p);break;case"arrow-start":t(d,p);break;case"arrow-end":t(d,p,1);break;case"clip-rect":var x=c(p).split(j);if(4==x.length){d.clip&&d.clip.parentNode.parentNode.removeChild(d.clip.parentNode);var z=q("clipPath"),A=q("rect");z.id=a.createUUID(),q(A,{x:x[0],y:x[1],width:x[2],height:x[3]}),z.appendChild(A),d.paper.defs.appendChild(z),q(i,{"clip-path":"url(#"+z.id+")"}),d.clip=A}if(!p){var B=i.getAttribute("clip-path");if(B){var C=a._g.doc.getElementById(B.replace(/(^url\(#|\)$)/g,l));C&&C.parentNode.removeChild(C),q(i,{"clip-path":l}),delete d.clip}}break;case"path":"path"==d.type&&(q(i,{d:p?k.path=a._pathToAbsolute(p):"M0,0"}),d._.dirty=1,d._.arrows&&("startString"in d._.arrows&&t(d,d._.arrows.startString),"endString"in d._.arrows&&t(d,d._.arrows.endString,1)));break;case"width":if(i.setAttribute(o,p),d._.dirty=1,!k.fx)break;o="x",p=k.x;case"x":k.fx&&(p=-k.x-(k.width||0));case"rx":if("rx"==o&&"rect"==d.type)break;case"cx":i.setAttribute(o,p),d.pattern&&s(d),d._.dirty=1;break;case"height":if(i.setAttribute(o,p),d._.dirty=1,!k.fy)break;o="y",p=k.y;case"y":k.fy&&(p=-k.y-(k.height||0));case"ry":if("ry"==o&&"rect"==d.type)break;case"cy":i.setAttribute(o,p),d.pattern&&s(d),d._.dirty=1;break;case"r":"rect"==d.type?q(i,{rx:p,ry:p}):i.setAttribute(o,p),d._.dirty=1;break;case"src":"image"==d.type&&i.setAttributeNS(n,"href",p);break;case"stroke-width":1==d._.sx&&1==d._.sy||(p/=g(h(d._.sx),h(d._.sy))||1),d.paper._vbSize&&(p*=d.paper._vbSize),i.setAttribute(o,p),k["stroke-dasharray"]&&v(d,k["stroke-dasharray"],f),d._.arrows&&("startString"in d._.arrows&&t(d,d._.arrows.startString),"endString"in d._.arrows&&t(d,d._.arrows.endString,1));break;case"stroke-dasharray":v(d,p,f);break;case"fill":var D=c(p).match(a._ISURL);if(D){z=q("pattern");var F=q("image");z.id=a.createUUID(),q(z,{x:0,y:0,patternUnits:"userSpaceOnUse",height:1,width:1}),q(F,{x:0,y:0,"xlink:href":D[1]}),z.appendChild(F),function(b){a._preload(D[1],function(){var a=this.offsetWidth,c=this.offsetHeight;q(b,{width:a,height:c}),q(F,{width:a,height:c}),d.paper.safari()})}(z),d.paper.defs.appendChild(z),q(i,{fill:"url(#"+z.id+")"}),d.pattern=z,d.pattern&&s(d);break}var G=a.getRGB(p);if(G.error){if(("circle"==d.type||"ellipse"==d.type||"r"!=c(p).charAt())&&r(d,p)){if("opacity"in k||"fill-opacity"in k){var H=a._g.doc.getElementById(i.getAttribute("fill").replace(/^url\(#|\)$/g,l));if(H){var I=H.getElementsByTagName("stop");q(I[I.length-1],{"stop-opacity":("opacity"in k?k.opacity:1)*("fill-opacity"in k?k["fill-opacity"]:1)})}}k.gradient=p,k.fill="none";break}}else delete f.gradient,delete k.gradient,!a.is(k.opacity,"undefined")&&a.is(f.opacity,"undefined")&&q(i,{opacity:k.opacity}),!a.is(k["fill-opacity"],"undefined")&&a.is(f["fill-opacity"],"undefined")&&q(i,{"fill-opacity":k["fill-opacity"]});G[b]("opacity")&&q(i,{"fill-opacity":G.opacity>1?G.opacity/100:G.opacity});case"stroke":G=a.getRGB(p),i.setAttribute(o,G.hex),"stroke"==o&&G[b]("opacity")&&q(i,{"stroke-opacity":G.opacity>1?G.opacity/100:G.opacity}),"stroke"==o&&d._.arrows&&("startString"in d._.arrows&&t(d,d._.arrows.startString),"endString"in d._.arrows&&t(d,d._.arrows.endString,1));break;case"gradient":("circle"==d.type||"ellipse"==d.type||"r"!=c(p).charAt())&&r(d,p);break;case"opacity":k.gradient&&!k[b]("stroke-opacity")&&q(i,{"stroke-opacity":p>1?p/100:p});case"fill-opacity":if(k.gradient){(H=a._g.doc.getElementById(i.getAttribute("fill").replace(/^url\(#|\)$/g,l)))&&(I=H.getElementsByTagName("stop"),q(I[I.length-1],{"stop-opacity":p}));break}default:"font-size"==o&&(p=e(p,10)+"px");var J=o.replace(/(\-.)/g,function(a){return a.substring(1).toUpperCase()});i.style[J]=p,d._.dirty=1,i.setAttribute(o,p)}}y(d,f),i.style.visibility=m},y=function(d,f){if("text"==d.type&&(f[b]("text")||f[b]("font")||f[b]("font-size")||f[b]("x")||f[b]("y"))){var g=d.attrs,h=d.node,i=h.firstChild?e(a._g.doc.defaultView.getComputedStyle(h.firstChild,l).getPropertyValue("font-size"),10):10;if(f[b]("text")){for(g.text=f.text;h.firstChild;)h.removeChild(h.firstChild);for(var m,j=c(f.text).split("\n"),k=[],n=0,o=j.length;n<o;n++)m=q("tspan"),n&&q(m,{dy:1.2*i,x:g.x}),m.appendChild(a._g.doc.createTextNode(j[n])),h.appendChild(m),k[n]=m}else for(k=h.getElementsByTagName("tspan"),n=0,o=k.length;n<o;n++)n?q(k[n],{dy:1.2*i,x:g.x}):q(k[0],{dy:0});q(h,{x:g.x,y:g.y}),d._.dirty=1;var p=d._getBBox(),r=g.y-(p.y+p.height/2);r&&a.is(r,"finite")&&q(k[0],{dy:r})}},z=function(b,c){this[0]=this.node=b,b.raphael=!0,this.id=a._oid++,b.raphaelid=this.id,this.matrix=a.matrix(),this.realPath=null,this.paper=c,this.attrs=this.attrs||{},this._={transform:[],sx:1,sy:1,deg:0,dx:0,dy:0,dirty:1},!c.bottom&&(c.bottom=this),this.prev=c.top,c.top&&(c.top.next=this),c.top=this,this.next=null},A=a.el;z.prototype=A,A.constructor=z,a._engine.path=function(a,b){var c=q("path");b.canvas&&b.canvas.appendChild(c);var d=new z(c,b);return d.type="path",w(d,{fill:"none",stroke:"#000",path:a}),d},A.rotate=function(a,b,e){if(this.removed)return this;if(a=c(a).split(j),a.length-1&&(b=d(a[1]),e=d(a[2])),a=d(a[0]),null==e&&(b=e),null==b||null==e){var f=this.getBBox(1);b=f.x+f.width/2,e=f.y+f.height/2}return this.transform(this._.transform.concat([["r",a,b,e]])),this},A.scale=function(a,b,e,f){if(this.removed)return this;if(a=c(a).split(j),a.length-1&&(b=d(a[1]),e=d(a[2]),f=d(a[3])),a=d(a[0]),null==b&&(b=a),null==f&&(e=f),null==e||null==f)var g=this.getBBox(1);return e=null==e?g.x+g.width/2:e,f=null==f?g.y+g.height/2:f,this.transform(this._.transform.concat([["s",a,b,e,f]])),this},A.translate=function(a,b){return this.removed?this:(a=c(a).split(j),a.length-1&&(b=d(a[1])),a=d(a[0])||0,b=+b||0,this.transform(this._.transform.concat([["t",a,b]])),this)},A.transform=function(c){var d=this._;if(null==c)return d.transform;if(a._extractTransform(this,c),this.clip&&q(this.clip,{transform:this.matrix.invert()}),this.pattern&&s(this),this.node&&q(this.node,{transform:this.matrix}),1!=d.sx||1!=d.sy){var e=this.attrs[b]("stroke-width")?this.attrs["stroke-width"]:1;this.attr({"stroke-width":e})}return this},A.hide=function(){return!this.removed&&this.paper.safari(this.node.style.display="none"),this},A.show=function(){return!this.removed&&this.paper.safari(this.node.style.display=""),this},A.remove=function(){if(!this.removed&&this.node.parentNode){var b=this.paper;b.__set__&&b.__set__.exclude(this),k.unbind("raphael.*.*."+this.id),this.gradient&&b.defs.removeChild(this.gradient),a._tear(this,b),"a"==this.node.parentNode.tagName.toLowerCase()?this.node.parentNode.parentNode.removeChild(this.node.parentNode):this.node.parentNode.removeChild(this.node);for(var c in this)this[c]="function"==typeof this[c]?a._removedFactory(c):null;this.removed=!0}},A._getBBox=function(){if("none"==this.node.style.display){this.show();var a=!0}var b={};try{b=this.node.getBBox()}catch(c){}finally{b=b||{}}return a&&this.hide(),b},A.attr=function(c,d){if(this.removed)return this;if(null==c){var e={};for(var f in this.attrs)this.attrs[b](f)&&(e[f]=this.attrs[f]);return e.gradient&&"none"==e.fill&&(e.fill=e.gradient)&&delete e.gradient,e.transform=this._.transform,e}if(null==d&&a.is(c,"string")){if("fill"==c&&"none"==this.attrs.fill&&this.attrs.gradient)return this.attrs.gradient;if("transform"==c)return this._.transform;for(var g=c.split(j),h={},i=0,l=g.length;i<l;i++)c=g[i],c in this.attrs?h[c]=this.attrs[c]:a.is(this.paper.customAttributes[c],"function")?h[c]=this.paper.customAttributes[c].def:h[c]=a._availableAttrs[c];return l-1?h:h[g[0]]}if(null==d&&a.is(c,"array")){for(h={},i=0,l=c.length;i<l;i++)h[c[i]]=this.attr(c[i]);return h}if(null!=d){var m={};m[c]=d}else null!=c&&a.is(c,"object")&&(m=c);for(var n in m)k("raphael.attr."+n+"."+this.id,this,m[n]);for(n in this.paper.customAttributes)if(this.paper.customAttributes[b](n)&&m[b](n)&&a.is(this.paper.customAttributes[n],"function")){var o=this.paper.customAttributes[n].apply(this,[].concat(m[n]));this.attrs[n]=m[n];for(var p in o)o[b](p)&&(m[p]=o[p])}return w(this,m),this},A.toFront=function(){if(this.removed)return this;"a"==this.node.parentNode.tagName.toLowerCase()?this.node.parentNode.parentNode.appendChild(this.node.parentNode):this.node.parentNode.appendChild(this.node);var b=this.paper;return b.top!=this&&a._tofront(this,b),this},A.toBack=function(){if(this.removed)return this;var b=this.node.parentNode;"a"==b.tagName.toLowerCase()?b.parentNode.insertBefore(this.node.parentNode,this.node.parentNode.parentNode.firstChild):b.firstChild!=this.node&&b.insertBefore(this.node,this.node.parentNode.firstChild),a._toback(this,this.paper);this.paper;return this},A.insertAfter=function(b){if(this.removed)return this;var c=b.node||b[b.length-1].node;return c.nextSibling?c.parentNode.insertBefore(this.node,c.nextSibling):c.parentNode.appendChild(this.node),a._insertafter(this,b,this.paper),this},A.insertBefore=function(b){if(this.removed)return this;var c=b.node||b[0].node;return c.parentNode.insertBefore(this.node,c),a._insertbefore(this,b,this.paper),this},A.blur=function(b){var c=this;if(0!=+b){var d=q("filter"),e=q("feGaussianBlur");c.attrs.blur=b,d.id=a.createUUID(),q(e,{stdDeviation:+b||1.5}),d.appendChild(e),c.paper.defs.appendChild(d),c._blur=d,q(c.node,{filter:"url(#"+d.id+")"})}else c._blur&&(c._blur.parentNode.removeChild(c._blur),delete c._blur,delete c.attrs.blur),c.node.removeAttribute("filter")},a._engine.circle=function(a,b,c,d){var e=q("circle");a.canvas&&a.canvas.appendChild(e);var f=new z(e,a);return f.attrs={cx:b,cy:c,r:d,fill:"none",stroke:"#000"},f.type="circle",q(e,f.attrs),f},a._engine.rect=function(a,b,c,d,e,f){var g=q("rect");a.canvas&&a.canvas.appendChild(g);var h=new z(g,a);return h.attrs={x:b,y:c,width:d,height:e,r:f||0,rx:f||0,ry:f||0,fill:"none",stroke:"#000"},h.type="rect",q(g,h.attrs),h},a._engine.ellipse=function(a,b,c,d,e){var f=q("ellipse");a.canvas&&a.canvas.appendChild(f);var g=new z(f,a);return g.attrs={cx:b,cy:c,rx:d,ry:e,fill:"none",stroke:"#000"},g.type="ellipse",q(f,g.attrs),g},a._engine.image=function(a,b,c,d,e,f){var g=q("image");q(g,{x:c,y:d,width:e,height:f,preserveAspectRatio:"none"}),g.setAttributeNS(n,"href",b),a.canvas&&a.canvas.appendChild(g);var h=new z(g,a);return h.attrs={x:c,y:d,width:e,height:f,src:b},h.type="image",h},a._engine.text=function(b,c,d,e){var f=q("text");b.canvas&&b.canvas.appendChild(f);var g=new z(f,b);return g.attrs={x:c,y:d,"text-anchor":"middle",text:e,font:a._availableAttrs.font,stroke:"none",fill:"#000"},g.type="text",w(g,g.attrs),g},a._engine.setSize=function(a,b){return this.width=a||this.width,this.height=b||this.height,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this._viewBox&&this.setViewBox.apply(this,this._viewBox),this},a._engine.create=function(){var b=a._getContainer.apply(0,arguments),c=b&&b.container,d=b.x,e=b.y,f=b.width,g=b.height;if(!c)throw new Error("SVG container not found.");var j,h=q("svg"),i="overflow:hidden;";return d=d||0,e=e||0,f=f||512,g=g||342,q(h,{height:g,version:1.1,width:f,xmlns:"http://www.w3.org/2000/svg"}),1==c?(h.style.cssText=i+"position:absolute;left:"+d+"px;top:"+e+"px",a._g.doc.body.appendChild(h),j=1):(h.style.cssText=i+"position:relative",c.firstChild?c.insertBefore(h,c.firstChild):c.appendChild(h)),c=new a._Paper,c.width=f,c.height=g,c.canvas=h,c.clear(),c._left=c._top=0,j&&(c.renderfix=function(){}),c.renderfix(),c},a._engine.setViewBox=function(a,b,c,d,e){k("raphael.setViewBox",this,this._viewBox,[a,b,c,d,e]);var j,l,f=g(c/this.width,d/this.height),h=this.top,i=e?"meet":"xMinYMin";for(null==a?(this._vbSize&&(f=1),delete this._vbSize,j="0 0 "+this.width+m+this.height):(this._vbSize=f,j=a+m+b+m+c+m+d),q(this.canvas,{viewBox:j,preserveAspectRatio:i});f&&h;)l="stroke-width"in h.attrs?h.attrs["stroke-width"]:1,h.attr({"stroke-width":l}),h._.dirty=1,h._.dirtyT=1,h=h.prev;return this._viewBox=[a,b,c,d,!!e],this},a.prototype.renderfix=function(){var c,a=this.canvas,b=a.style;try{c=a.getScreenCTM()||a.createSVGMatrix()}catch(d){c=a.createSVGMatrix()}var e=-c.e%1,f=-c.f%1;(e||f)&&(e&&(this._left=(this._left+e)%1,b.left=this._left+"px"),f&&(this._top=(this._top+f)%1,b.top=this._top+"px"))},a.prototype.clear=function(){a.eve("raphael.clear",this);for(var b=this.canvas;b.firstChild;)b.removeChild(b.firstChild);this.bottom=this.top=null,(this.desc=q("desc")).appendChild(a._g.doc.createTextNode("Created with RaphaÃ«l "+a.version)),b.appendChild(this.desc),b.appendChild(this.defs=q("defs"))},a.prototype.remove=function(){k("raphael.remove",this),this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);for(var b in this)this[b]="function"==typeof this[b]?a._removedFactory(b):null};var B=a.st;for(var C in A)A[b](C)&&!B[b](C)&&(B[C]=function(a){return function(){var b=arguments;return this.forEach(function(c){c[a].apply(c,b)})}}(C))}(window.Raphael),window.Raphael.vml&&function(a){var b="hasOwnProperty",c=String,d=parseFloat,e=Math,f=e.round,g=e.max,h=e.min,i=e.abs,j="fill",k=/[, ]+/,l=a.eve,n=" ",o="",p={M:"m",L:"l",C:"c",Z:"x",m:"t",l:"r",c:"v",z:"x"},q=/([clmz]),?([^clmz]*)/gi,r=/ progid:\S+Blur\([^\)]+\)/g,s=/-?[^,\s-]+/g,t="position:absolute;left:0;top:0;width:1px;height:1px",u=21600,v={path:1,rect:1,image:1},w={circle:1,ellipse:1},x=function(b){var d=/[ahqstv]/gi,e=a._pathToAbsolute;if(c(b).match(d)&&(e=a._path2curve),d=/[clmz]/g,e==a._pathToAbsolute&&!c(b).match(d)){var g=c(b).replace(q,function(a,b,c){var d=[],e="m"==b.toLowerCase(),g=p[b];return c.replace(s,function(a){e&&2==d.length&&(g+=d+p["m"==b?"l":"L"],d=[]),d.push(f(a*u))}),g+d});return g}var i,j,h=e(b);g=[];for(var k=0,l=h.length;k<l;k++){i=h[k],"z"==(j=h[k][0].toLowerCase())&&(j="x");for(var m=1,r=i.length;m<r;m++)j+=f(i[m]*u)+(m!=r-1?",":o);g.push(j)}return g.join(n)},y=function(b,c,d){var e=a.matrix();return e.rotate(-b,.5,.5),{dx:e.x(c,d),dy:e.y(c,d)}},z=function(a,b,c,d,e,f){var g=a._,h=a.matrix,k=g.fillpos,l=a.node,m=l.style,o=1,p="",r=u/b,s=u/c;if(m.visibility="hidden",b&&c){if(l.coordsize=i(r)+n+i(s),m.rotation=f*(b*c<0?-1:1),f){var t=y(f,d,e);d=t.dx,e=t.dy}if(b<0&&(p+="x"),c<0&&(p+=" y")&&(o=-1),m.flip=p,l.coordorigin=d*-r+n+e*-s,k||g.fillsize){var v=l.getElementsByTagName(j);v=v&&v[0],l.removeChild(v),k&&(t=y(f,h.x(k[0],k[1]),h.y(k[0],k[1])),v.position=t.dx*o+n+t.dy*o),g.fillsize&&(v.size=g.fillsize[0]*i(b)+n+g.fillsize[1]*i(c)),l.appendChild(v)}m.visibility="visible"}};a.toString=function(){return"Your browser doesnât support SVG. Falling down to VML.\nYou are running RaphaÃ«l "+this.version};var A=function(a,b,d){for(var e=c(b).toLowerCase().split("-"),f=d?"end":"start",g=e.length,h="classic",i="medium",j="medium";g--;)switch(e[g]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":h=e[g];break;case"wide":case"narrow":j=e[g];break;case"long":case"short":i=e[g]}var k=a.node.getElementsByTagName("stroke")[0];k[f+"arrow"]=h,k[f+"arrowlength"]=i,k[f+"arrowwidth"]=j},B=function(e,i){e.attrs=e.attrs||{};var l=e.node,m=e.attrs,p=l.style,r=v[e.type]&&(i.x!=m.x||i.y!=m.y||i.width!=m.width||i.height!=m.height||i.cx!=m.cx||i.cy!=m.cy||i.rx!=m.rx||i.ry!=m.ry||i.r!=m.r),s=w[e.type]&&(m.cx!=i.cx||m.cy!=i.cy||m.r!=i.r||m.rx!=i.rx||m.ry!=i.ry),t=e;for(var y in i)i[b](y)&&(m[y]=i[y]);if(r&&(m.path=a._getPath[e.type](e),e._.dirty=1),i.href&&(l.href=i.href),i.title&&(l.title=i.title),i.target&&(l.target=i.target),i.cursor&&(p.cursor=i.cursor),"blur"in i&&e.blur(i.blur),(i.path&&"path"==e.type||r)&&(l.path=x(~c(m.path).toLowerCase().indexOf("r")?a._pathToAbsolute(m.path):m.path),"image"==e.type&&(e._.fillpos=[m.x,m.y],e._.fillsize=[m.width,m.height],z(e,1,1,0,0,0))),"transform"in i&&e.transform(i.transform),s){var B=+m.cx,D=+m.cy,E=+m.rx||+m.r||0,G=+m.ry||+m.r||0;l.path=a.format("ar{0},{1},{2},{3},{4},{1},{4},{1}x",f((B-E)*u),f((D-G)*u),f((B+E)*u),f((D+G)*u),f(B*u))}if("clip-rect"in i){var H=c(i["clip-rect"]).split(k);if(4==H.length){H[2]=+H[2]+ +H[0],H[3]=+H[3]+ +H[1];var I=l.clipRect||a._g.doc.createElement("div"),J=I.style;J.clip=a.format("rect({1}px {2}px {3}px {0}px)",H),l.clipRect||(J.position="absolute",J.top=0,J.left=0,J.width=e.paper.width+"px",J.height=e.paper.height+"px",l.parentNode.insertBefore(I,l),I.appendChild(l),l.clipRect=I)}i["clip-rect"]||l.clipRect&&(l.clipRect.style.clip="auto")}if(e.textpath){var K=e.textpath.style;i.font&&(K.font=i.font),i["font-family"]&&(K.fontFamily='"'+i["font-family"].split(",")[0].replace(/^['"]+|['"]+$/g,o)+'"'),i["font-size"]&&(K.fontSize=i["font-size"]),i["font-weight"]&&(K.fontWeight=i["font-weight"]),i["font-style"]&&(K.fontStyle=i["font-style"])}if("arrow-start"in i&&A(t,i["arrow-start"]),"arrow-end"in i&&A(t,i["arrow-end"],1),null!=i.opacity||null!=i["stroke-width"]||null!=i.fill||null!=i.src||null!=i.stroke||null!=i["stroke-width"]||null!=i["stroke-opacity"]||null!=i["fill-opacity"]||null!=i["stroke-dasharray"]||null!=i["stroke-miterlimit"]||null!=i["stroke-linejoin"]||null!=i["stroke-linecap"]){var L=l.getElementsByTagName(j);if(L=L&&L[0],!L&&(L=F(j)),"image"==e.type&&i.src&&(L.src=i.src),i.fill&&(L.on=!0),null!=L.on&&"none"!=i.fill&&null!==i.fill||(L.on=!1),L.on&&i.fill){var N=c(i.fill).match(a._ISURL);if(N){L.parentNode==l&&l.removeChild(L),L.rotate=!0,L.src=N[1],L.type="tile";var O=e.getBBox(1);L.position=O.x+n+O.y,e._.fillpos=[O.x,O.y],a._preload(N[1],function(){e._.fillsize=[this.offsetWidth,this.offsetHeight]})}else L.color=a.getRGB(i.fill).hex,L.src=o,L.type="solid",a.getRGB(i.fill).error&&(t.type in{circle:1,ellipse:1}||"r"!=c(i.fill).charAt())&&C(t,i.fill,L)&&(m.fill="none",m.gradient=i.fill,L.rotate=!1)}if("fill-opacity"in i||"opacity"in i){var P=((+m["fill-opacity"]+1||2)-1)*((+m.opacity+1||2)-1)*((+a.getRGB(i.fill).o+1||2)-1);P=h(g(P,0),1),L.opacity=P,L.src&&(L.color="none")}l.appendChild(L);var Q=l.getElementsByTagName("stroke")&&l.getElementsByTagName("stroke")[0],T=!1;!Q&&(T=Q=F("stroke")),(i.stroke&&"none"!=i.stroke||i["stroke-width"]||null!=i["stroke-opacity"]||i["stroke-dasharray"]||i["stroke-miterlimit"]||i["stroke-linejoin"]||i["stroke-linecap"])&&(Q.on=!0),("none"==i.stroke||null===i.stroke||null==Q.on||0==i.stroke||0==i["stroke-width"])&&(Q.on=!1);var U=a.getRGB(i.stroke);Q.on&&i.stroke&&(Q.color=U.hex),P=((+m["stroke-opacity"]+1||2)-1)*((+m.opacity+1||2)-1)*((+U.o+1||2)-1);var V=.75*(d(i["stroke-width"])||1);if(P=h(g(P,0),1),null==i["stroke-width"]&&(V=m["stroke-width"]),i["stroke-width"]&&(Q.weight=V),V&&V<1&&(P*=V)&&(Q.weight=1),Q.opacity=P,i["stroke-linejoin"]&&(Q.joinstyle=i["stroke-linejoin"]||"miter"),Q.miterlimit=i["stroke-miterlimit"]||8,i["stroke-linecap"]&&(Q.endcap="butt"==i["stroke-linecap"]?"flat":"square"==i["stroke-linecap"]?"square":"round"),i["stroke-dasharray"]){var W={"-":"shortdash",".":"shortdot","-.":"shortdashdot","-..":"shortdashdotdot",". ":"dot","- ":"dash","--":"longdash","- .":"dashdot","--.":"longdashdot","--..":"longdashdotdot"};Q.dashstyle=W[b](i["stroke-dasharray"])?W[i["stroke-dasharray"]]:o}T&&l.appendChild(Q)}if("text"==t.type){t.paper.canvas.style.display=o;var X=t.paper.span,Z=m.font&&m.font.match(/\d+(?:\.\d*)?(?=px)/);p=X.style,m.font&&(p.font=m.font),m["font-family"]&&(p.fontFamily=m["font-family"]),m["font-weight"]&&(p.fontWeight=m["font-weight"]),m["font-style"]&&(p.fontStyle=m["font-style"]),Z=d(m["font-size"]||Z&&Z[0])||10,p.fontSize=100*Z+"px",t.textpath.string&&(X.innerHTML=c(t.textpath.string).replace(/</g,"&#60;").replace(/&/g,"&#38;").replace(/\n/g,"<br>"));var $=X.getBoundingClientRect();t.W=m.w=($.right-$.left)/100,t.H=m.h=($.bottom-$.top)/100,t.X=m.x,t.Y=m.y+t.H/2,("x"in i||"y"in i)&&(t.path.v=a.format("m{0},{1}l{2},{1}",f(m.x*u),f(m.y*u),f(m.x*u)+1));for(var _=["x","y","text","font","font-family","font-weight","font-style","font-size"],ba=0,bb=_.length;ba<bb;ba++)if(_[ba]in i){t._.dirty=1;break}switch(m["text-anchor"]){case"start":t.textpath.style["v-text-align"]="left",t.bbx=t.W/2;break;case"end":t.textpath.style["v-text-align"]="right",t.bbx=-t.W/2;break;default:t.textpath.style["v-text-align"]="center",t.bbx=0}t.textpath.style["v-text-kern"]=!0}},C=function(b,f,g){b.attrs=b.attrs||{};var i=(b.attrs,Math.pow),l="linear",m=".5 .5";if(b.attrs.gradient=f,f=c(f).replace(a._radial_gradient,function(a,b,c){return l="radial",b&&c&&(b=d(b),c=d(c),i(b-.5,2)+i(c-.5,2)>.25&&(c=e.sqrt(.25-i(b-.5,2))*(2*(c>.5)-1)+.5),m=b+n+c),o}),f=f.split(/\s*\-\s*/),"linear"==l){var p=f.shift();if(p=-d(p),isNaN(p))return null}var q=a._parseDots(f);if(!q)return null;if(b=b.shape||b.node,q.length){b.removeChild(g),g.on=!0,g.method="none",g.color=q[0].color,g.color2=q[q.length-1].color;for(var r=[],s=0,t=q.length;s<t;s++)q[s].offset&&r.push(q[s].offset+n+q[s].color);g.colors=r.length?r.join():"0% "+g.color,"radial"==l?(g.type="gradientTitle",g.focus="100%",g.focussize="0 0",g.focusposition=m,g.angle=0):(g.type="gradient",g.angle=(270-p)%360),b.appendChild(g)}return 1},D=function(b,c){this[0]=this.node=b,b.raphael=!0,this.id=a._oid++,b.raphaelid=this.id,this.X=0,this.Y=0,this.attrs={},this.paper=c,this.matrix=a.matrix(),this._={transform:[],sx:1,sy:1,dx:0,dy:0,deg:0,dirty:1,dirtyT:1},!c.bottom&&(c.bottom=this),this.prev=c.top,c.top&&(c.top.next=this),c.top=this,this.next=null},E=a.el;D.prototype=E,E.constructor=D,E.transform=function(b){if(null==b)return this._.transform;var f,d=this.paper._viewBoxShift,e=d?"s"+[d.scale,d.scale]+"-1-1t"+[d.dx,d.dy]:o;d&&(f=b=c(b).replace(/\.{3}|\u2026/g,this._.transform||o)),a._extractTransform(this,e+b);var j,g=this.matrix.clone(),h=this.skew,i=this.node,k=~c(this.attrs.fill).indexOf("-"),l=!c(this.attrs.fill).indexOf("url(");if(g.translate(-.5,-.5),l||k||"image"==this.type)if(h.matrix="1 0 0 1",h.offset="0 0",j=g.split(),k&&j.noRotation||!j.isSimple){i.style.filter=g.toFilter();var m=this.getBBox(),p=this.getBBox(1),q=m.x-p.x,r=m.y-p.y;i.coordorigin=q*-u+n+r*-u,z(this,1,1,q,r,0)}else i.style.filter=o,z(this,j.scalex,j.scaley,j.dx,j.dy,j.rotate);else i.style.filter=o,h.matrix=c(g),h.offset=g.offset();return f&&(this._.transform=f),this},E.rotate=function(a,b,e){if(this.removed)return this;if(null!=a){if(a=c(a).split(k),a.length-1&&(b=d(a[1]),e=d(a[2])),a=d(a[0]),null==e&&(b=e),null==b||null==e){var f=this.getBBox(1);b=f.x+f.width/2,e=f.y+f.height/2}return this._.dirtyT=1,this.transform(this._.transform.concat([["r",a,b,e]])),this}},E.translate=function(a,b){return this.removed?this:(a=c(a).split(k),a.length-1&&(b=d(a[1])),a=d(a[0])||0,b=+b||0,this._.bbox&&(this._.bbox.x+=a,this._.bbox.y+=b),this.transform(this._.transform.concat([["t",a,b]])),this)},E.scale=function(a,b,e,f){if(this.removed)return this;if(a=c(a).split(k),a.length-1&&(b=d(a[1]),e=d(a[2]),f=d(a[3]),isNaN(e)&&(e=null),isNaN(f)&&(f=null)),a=d(a[0]),null==b&&(b=a),null==f&&(e=f),null==e||null==f)var g=this.getBBox(1);return e=null==e?g.x+g.width/2:e,f=null==f?g.y+g.height/2:f,this.transform(this._.transform.concat([["s",a,b,e,f]])),this._.dirtyT=1,this},E.hide=function(){return!this.removed&&(this.node.style.display="none"),this},E.show=function(){return!this.removed&&(this.node.style.display=o),this},E._getBBox=function(){return this.removed?{}:{x:this.X+(this.bbx||0)-this.W/2,y:this.Y-this.H,width:this.W,height:this.H}},E.remove=function(){if(!this.removed&&this.node.parentNode){this.paper.__set__&&this.paper.__set__.exclude(this),a.eve.unbind("raphael.*.*."+this.id),a._tear(this,this.paper),this.node.parentNode.removeChild(this.node),this.shape&&this.shape.parentNode.removeChild(this.shape);for(var b in this)this[b]="function"==typeof this[b]?a._removedFactory(b):null;this.removed=!0}},E.attr=function(c,d){if(this.removed)return this;if(null==c){var e={};for(var f in this.attrs)this.attrs[b](f)&&(e[f]=this.attrs[f]);return e.gradient&&"none"==e.fill&&(e.fill=e.gradient)&&delete e.gradient,e.transform=this._.transform,e}if(null==d&&a.is(c,"string")){if(c==j&&"none"==this.attrs.fill&&this.attrs.gradient)return this.attrs.gradient;for(var g=c.split(k),h={},i=0,m=g.length;i<m;i++)c=g[i],c in this.attrs?h[c]=this.attrs[c]:a.is(this.paper.customAttributes[c],"function")?h[c]=this.paper.customAttributes[c].def:h[c]=a._availableAttrs[c];return m-1?h:h[g[0]]}if(this.attrs&&null==d&&a.is(c,"array")){for(h={},i=0,m=c.length;i<m;i++)h[c[i]]=this.attr(c[i]);return h}var n;null!=d&&(n={},n[c]=d),null==d&&a.is(c,"object")&&(n=c);for(var o in n)l("raphael.attr."+o+"."+this.id,this,n[o]);if(n){for(o in this.paper.customAttributes)if(this.paper.customAttributes[b](o)&&n[b](o)&&a.is(this.paper.customAttributes[o],"function")){var p=this.paper.customAttributes[o].apply(this,[].concat(n[o]));this.attrs[o]=n[o];for(var q in p)p[b](q)&&(n[q]=p[q])}n.text&&"text"==this.type&&(this.textpath.string=n.text),B(this,n)}return this},E.toFront=function(){return!this.removed&&this.node.parentNode.appendChild(this.node),this.paper&&this.paper.top!=this&&a._tofront(this,this.paper),this},E.toBack=function(){return this.removed?this:(this.node.parentNode.firstChild!=this.node&&(this.node.parentNode.insertBefore(this.node,this.node.parentNode.firstChild),a._toback(this,this.paper)),this)},E.insertAfter=function(b){return this.removed?this:(b.constructor==a.st.constructor&&(b=b[b.length-1]),b.node.nextSibling?b.node.parentNode.insertBefore(this.node,b.node.nextSibling):b.node.parentNode.appendChild(this.node),a._insertafter(this,b,this.paper),this)},E.insertBefore=function(b){return this.removed?this:(b.constructor==a.st.constructor&&(b=b[0]),b.node.parentNode.insertBefore(this.node,b.node),a._insertbefore(this,b,this.paper),this)},E.blur=function(b){var c=this.node.runtimeStyle,d=c.filter;d=d.replace(r,o),0!=+b?(this.attrs.blur=b,c.filter=d+n+" progid:DXImageTransform.Microsoft.Blur(pixelradius="+(+b||1.5)+")",c.margin=a.format("-{0}px 0 0 -{0}px",f(+b||1.5))):(c.filter=d,c.margin=0,delete this.attrs.blur)},a._engine.path=function(a,b){var c=F("shape");c.style.cssText=t,c.coordsize=u+n+u,c.coordorigin=b.coordorigin;var d=new D(c,b),e={fill:"none",stroke:"#000"};a&&(e.path=a),d.type="path",d.path=[],d.Path=o,B(d,e),b.canvas.appendChild(c);var f=F("skew");return f.on=!0,c.appendChild(f),d.skew=f,d.transform(o),d},
a._engine.rect=function(b,c,d,e,f,g){var h=a._rectPath(c,d,e,f,g),i=b.path(h),j=i.attrs;return i.X=j.x=c,i.Y=j.y=d,i.W=j.width=e,i.H=j.height=f,j.r=g,j.path=h,i.type="rect",i},a._engine.ellipse=function(a,b,c,d,e){var f=a.path();f.attrs;return f.X=b-d,f.Y=c-e,f.W=2*d,f.H=2*e,f.type="ellipse",B(f,{cx:b,cy:c,rx:d,ry:e}),f},a._engine.circle=function(a,b,c,d){var e=a.path();e.attrs;return e.X=b-d,e.Y=c-d,e.W=e.H=2*d,e.type="circle",B(e,{cx:b,cy:c,r:d}),e},a._engine.image=function(b,c,d,e,f,g){var h=a._rectPath(d,e,f,g),i=b.path(h).attr({stroke:"none"}),k=i.attrs,l=i.node,m=l.getElementsByTagName(j)[0];return k.src=c,i.X=k.x=d,i.Y=k.y=e,i.W=k.width=f,i.H=k.height=g,k.path=h,i.type="image",m.parentNode==l&&l.removeChild(m),m.rotate=!0,m.src=c,m.type="tile",i._.fillpos=[d,e],i._.fillsize=[f,g],l.appendChild(m),z(i,1,1,0,0,0),i},a._engine.text=function(b,d,e,g){var h=F("shape"),i=F("path"),j=F("textpath");d=d||0,e=e||0,g=g||"",i.v=a.format("m{0},{1}l{2},{1}",f(d*u),f(e*u),f(d*u)+1),i.textpathok=!0,j.string=c(g),j.on=!0,h.style.cssText=t,h.coordsize=u+n+u,h.coordorigin="0 0";var k=new D(h,b),l={fill:"#000",stroke:"none",font:a._availableAttrs.font,text:g};k.shape=h,k.path=i,k.textpath=j,k.type="text",k.attrs.text=c(g),k.attrs.x=d,k.attrs.y=e,k.attrs.w=1,k.attrs.h=1,B(k,l),h.appendChild(j),h.appendChild(i),b.canvas.appendChild(h);var m=F("skew");return m.on=!0,h.appendChild(m),k.skew=m,k.transform(o),k},a._engine.setSize=function(b,c){var d=this.canvas.style;return this.width=b,this.height=c,b==+b&&(b+="px"),c==+c&&(c+="px"),d.width=b,d.height=c,d.clip="rect(0 "+b+" "+c+" 0)",this._viewBox&&a._engine.setViewBox.apply(this,this._viewBox),this},a._engine.setViewBox=function(b,c,d,e,f){a.eve("raphael.setViewBox",this,this._viewBox,[b,c,d,e,f]);var k,l,h=this.width,i=this.height,j=1/g(d/h,e/i);return f&&(k=i/e,l=h/d,d*k<h&&(b-=(h-d*k)/2/k),e*l<i&&(c-=(i-e*l)/2/l)),this._viewBox=[b,c,d,e,!!f],this._viewBoxShift={dx:-b,dy:-c,scale:j},this.forEach(function(a){a.transform("...")}),this};var F;a._engine.initWin=function(a){var b=a.document;b.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)");try{!b.namespaces.rvml&&b.namespaces.add("rvml","urn:schemas-microsoft-com:vml"),F=function(a){return b.createElement("<rvml:"+a+' class="rvml">')}}catch(c){F=function(a){return b.createElement("<"+a+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">')}}},a._engine.initWin(a._g.win),a._engine.create=function(){var b=a._getContainer.apply(0,arguments),c=b.container,d=b.height,f=b.width,g=b.x,h=b.y;if(!c)throw new Error("VML container not found.");var i=new a._Paper,j=i.canvas=a._g.doc.createElement("div"),k=j.style;return g=g||0,h=h||0,f=f||512,d=d||342,i.width=f,i.height=d,f==+f&&(f+="px"),d==+d&&(d+="px"),i.coordsize=216e5+n+216e5,i.coordorigin="0 0",i.span=a._g.doc.createElement("span"),i.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;",j.appendChild(i.span),k.cssText=a.format("top:0;left:0;width:{0};height:{1};display:inline-block;position:relative;clip:rect(0 {0} {1} 0);overflow:hidden",f,d),1==c?(a._g.doc.body.appendChild(j),k.left=g+"px",k.top=h+"px",k.position="absolute"):c.firstChild?c.insertBefore(j,c.firstChild):c.appendChild(j),i.renderfix=function(){},i},a.prototype.clear=function(){a.eve("raphael.clear",this),this.canvas.innerHTML=o,this.span=a._g.doc.createElement("span"),this.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;",this.canvas.appendChild(this.span),this.bottom=this.top=null},a.prototype.remove=function(){a.eve("raphael.remove",this),this.canvas.parentNode.removeChild(this.canvas);for(var b in this)this[b]="function"==typeof this[b]?a._removedFactory(b):null;return!0};var G=a.st;for(var H in E)E[b](H)&&!G[b](H)&&(G[H]=function(a){return function(){var b=arguments;return this.forEach(function(c){c[a].apply(c,b)})}}(H))}(window.Raphael),"undefined"!=typeof exports&&(exports.erase=erase);function erase(paths,erasePath,eraseRadius){eraseRadius=eraseRadius||20;var newPaths=[];if(erasePath.points=cleanPath(erasePath.points),1===erasePath.points.length){for(var p=0;p<paths.length;p++)!function(path){var eX=erasePath.points[0][0],eY=erasePath.points[0][1],i=0,last=0;if(1===path.points.length&&!withinCircle(path.points[0][0],path.points[0][1],eX,eY,eraseRadius))return void newPaths.push(path);for(var newPath;i<path.points.length-1;){var p0=path.points[i],p1=path.points[i+1],p0_withinCircle=withinCircle(p0[0],p0[1],eX,eY,eraseRadius),p1_withinCircle=withinCircle(p1[0],p1[1],eX,eY,eraseRadius);if(p0_withinCircle&&p1_withinCircle)i++,last=i;else if(p0_withinCircle&&!p1_withinCircle){var x=getCircleIntersection(p0[0],p0[1],p1[0],p1[1],eX,eY,eraseRadius);x?(path.points[i]=x,last=i):i++}else if(!p0_withinCircle&&p1_withinCircle){var x=getCircleIntersection(p1[0],p1[1],p0[0],p0[1],eX,eY,eraseRadius);x&&(newPath={points:path.points.slice(last,i+1),attrs:path.attrs},newPath.points.push(x),newPaths.push(newPath)),i++,last=i}else{var possIntersects=getCircleIntersections(p0[0],p0[1],p1[0],p1[1],eX,eY,eraseRadius);possIntersects?(newPath={points:path.points.slice(last,i+1),attrs:path.attrs},newPath.points[newPath.points.length-1][0]===possIntersects[0][0]&&newPath[newPath.points.length-1][1]===possIntersects[0][1]||newPath.points.push(possIntersects[0]),newPath.points.length>1&&newPaths.push(newPath),path.points[i]=possIntersects[1],path.points[i+1]&&path.points[i+1][0]==possIntersects[1][0]&&path.points[i+1][1]==possIntersects[1][1]&&i++,last=i):i++}}last!==i&&(newPath={points:path.points.slice(last,path.points.length),attrs:path.attrs})&&newPaths.push(newPath)}(paths[p]);paths=newPaths}else for(var e=0;e<erasePath.points.length-1;e++){for(var p=0;p<paths.length;p++)!function(path,i){var e0=erasePath.points[i],e1=erasePath.points[i+1],i=0,last=0;if(1===path.points.length){var p0_locationIndex=withinCapsule(path.points[0][0],path.points[0][1],e0[0],e0[1],e1[0],e1[1],eraseRadius);if(-1===p0_locationIndex.indexOf(1))return void newPaths.push(path)}for(var newPath;i<path.points.length-1;){var p0=path.points[i],p1=path.points[i+1],p0_locationIndex=withinCapsule(p0[0],p0[1],e0[0],e0[1],e1[0],e1[1],eraseRadius),p1_locationIndex=withinCapsule(p1[0],p1[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);if(-1!==p0_locationIndex.indexOf(1)&&-1!==p1_locationIndex.indexOf(1))i++,last=i;else if(-1!==p0_locationIndex.indexOf(1)&&-1===p1_locationIndex.indexOf(1)){var x=getCapsuleIntersection(p0[0],p0[1],p0_locationIndex,p1[0],p1[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);x?(path.points[i]=x,last=i):i++}else if(-1===p0_locationIndex.indexOf(1)&&-1!==p1_locationIndex.indexOf(1)){var x=getCapsuleIntersection(p1[0],p1[1],p1_locationIndex,p0[0],p0[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);x?(newPath={points:path.points.slice(last,i+1),attrs:path.attrs},newPath.points.push(x),newPaths.push(newPath),i++,last=i):i++}else{var possIntersects=getCapsuleIntersections(p0[0],p0[1],p1[0],p1[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);possIntersects?(newPath={points:path.points.slice(last,i+1),attrs:path.attrs},newPath.points[newPath.points.length-1][0]===possIntersects[0][0]&&newPath.points[newPath.points.length-1][1]===possIntersects[0][1]||newPath.points.push(possIntersects[0]),newPath.points.length>1&&newPaths.push(newPath),path.points[i]=possIntersects[1],path.points[i+1]&&path.points[i+1][0]==possIntersects[1][0]&&path.points[i+1][1]==possIntersects[1][1]&&i++,last=i):i++}}last!==i&&(newPath={points:path.points.slice(last,path.points.length),attrs:path.attrs})&&newPaths.push(newPath)}(paths[p],e);paths=newPaths,newPaths=[]}for(var r=0;r<paths.length;r++)for(var rr=0;rr<paths[r].points.length;rr++)paths[r].points[rr][0]=Math.round(paths[r].points[rr][0]),paths[r].points[rr][1]=Math.round(paths[r].points[rr][1]);return paths}function cleanPath(path){var cleaned=[];if(1===path.length)cleaned=path;else{for(pClean=0;pClean<path.length-1;)path[pClean][0]===path[pClean+1][0]&&path[pClean][1]===path[pClean+1][1]||cleaned.push(path[pClean]),pClean++;0!==path.length&&0===cleaned.length&&cleaned.push(path[0]),path[path.length-1][0]===path[cleaned.length-1][0]&&path[path.length-1][1]===path[cleaned.length-1][1]||cleaned.push(path[pClean])}return cleaned}function getDistance(aX,aY,bX,bY){return Math.sqrt(Math.pow(bX-aX,2)+Math.pow(bY-aY,2))}function withinCircle(x,y,cX,cY,r){return getDistance(x,y,cX,cY)<r?1:0}function withinBox(pX,pY,aX,aY,bX,bY,r){var vec_ab=[bX-aX,bY-aY],vec_ap=[pX-aX,pY-aY],vec_n=[-vec_ab[1],vec_ab[0]],mag_n=Math.sqrt(Math.pow(vec_n[0],2)+Math.pow(vec_n[1],2)),u_vec_n=[vec_n[0]/mag_n,vec_n[1]/mag_n],mag_ab=Math.sqrt(Math.pow(vec_ab[0],2)+Math.pow(vec_ab[1],2)),u_vec_ab=[vec_ab[0]/mag_ab,vec_ab[1]/mag_ab],ap_proj_ab=vec_ap[0]*u_vec_ab[0]+vec_ap[1]*u_vec_ab[1];if(ap_proj_ab<=0||ap_proj_ab>=mag_ab)return 0;var ap_proj_n=vec_ap[0]*u_vec_n[0]+vec_ap[1]*u_vec_n[1];return ap_proj_n>=r||ap_proj_n<=-r?0:1}function withinCapsule(pX,pY,aX,aY,bX,bY,r){var locationIndex=[];return locationIndex.push(withinCircle(pX,pY,aX,aY,r)),locationIndex.push(withinCircle(pX,pY,bX,bY,r)),locationIndex.push(withinBox(pX,pY,aX,aY,bX,bY,r)),locationIndex}function getParallelSegments(aX,aY,bX,bY,r){var vec_v=[bX-aX,bY-aY],vec_n=[-vec_v[1],vec_v[0]],mag_n=Math.sqrt(Math.pow(vec_n[0],2)+Math.pow(vec_n[1],2)),u_vec_n=[vec_n[0]/mag_n,vec_n[1]/mag_n];return[[aX+r*u_vec_n[0],aY+r*u_vec_n[1]],[aX-r*u_vec_n[0],aY-r*u_vec_n[1]],[bX-r*u_vec_n[0],bY-r*u_vec_n[1]],[bX+r*u_vec_n[0],bY+r*u_vec_n[1]]]}function getCircleIntersection(aX,aY,bX,bY,cX,cY,r){var b,vec_ac=[cX-aX,cY-aY],vec_ab=[bX-aX,bY-aY],mag_ab=Math.sqrt(Math.pow(vec_ab[0],2)+Math.pow(vec_ab[1],2)),u_vec_ab=[vec_ab[0]/mag_ab,vec_ab[1]/mag_ab],ac_proj_ab=vec_ac[0]*u_vec_ab[0]+vec_ac[1]*u_vec_ab[1],rightPoint=[aX+ac_proj_ab*u_vec_ab[0],aY+ac_proj_ab*u_vec_ab[1]],distCToRightPoint=Math.sqrt(Math.pow(cX-rightPoint[0],2)+Math.pow(cY-rightPoint[1],2));if(0===distCToRightPoint)b=r;else var b=Math.sqrt(Math.pow(r,2)-Math.pow(distCToRightPoint,2));var intersection=[aX+ac_proj_ab*u_vec_ab[0]+b*u_vec_ab[0],aY+ac_proj_ab*u_vec_ab[1]+b*u_vec_ab[1]];return intersection[0]===aX&&intersection[1]===aY?null:intersection}function getCircleIntersections(aX,aY,bX,bY,cX,cY,r){var vec_ac=[cX-aX,cY-aY],vec_ab=[bX-aX,bY-aY],vec_n=[-vec_ab[1],vec_ab[0]],mag_n=Math.sqrt(Math.pow(vec_n[0],2)+Math.pow(vec_n[1],2)),u_vec_n=[vec_n[0]/mag_n,vec_n[1]/mag_n],mag_d=vec_ac[0]*u_vec_n[0]+vec_ac[1]*u_vec_n[1],closest=getClosestPointOnSegment([aX,aY],[bX,bY],[cX,cY]);if(getLength([closest[0]-cX,closest[1]-cY])>=r)return null;var x=Math.sqrt(Math.pow(r,2)-Math.pow(mag_d,2)),vec_cd=[cX-mag_d*u_vec_n[0],cY-mag_d*u_vec_n[1]],mag_ab=Math.sqrt(Math.pow(vec_ab[0],2)+Math.pow(vec_ab[1],2)),u_vec_ab=[vec_ab[0]/mag_ab,vec_ab[1]/mag_ab],intersections=[[vec_cd[0]-u_vec_ab[0]*x,vec_cd[1]-u_vec_ab[1]*x],[vec_cd[0]+u_vec_ab[0]*x,vec_cd[1]+u_vec_ab[1]*x]];return intersections[0][0]===aX&&intersections[0][1]===aY?null:intersections}function getLineIntersection(aX,aY,bX,bY,cX,cY,dX,dY){var s1_x,s1_y,s2_x,s2_y;s1_x=bX-aX,s1_y=bY-aY,s2_x=dX-cX,s2_y=dY-cY;var s,t;if(-s2_x*s1_y+s1_x*s2_y==0)return null;if(s=(-s1_y*(aX-cX)+s1_x*(aY-cY))/(-s2_x*s1_y+s1_x*s2_y),t=(s2_x*(aY-cY)-s2_y*(aX-cX))/(-s2_x*s1_y+s1_x*s2_y),s>=0&&s<=1&&t>=0&&t<=1){return[aX+t*s1_x,aY+t*s1_y]}return null}function getCapsuleIntersection(aX,aY,locationIndex,bX,bY,c0_x,c0_y,c1_x,c1_y,r){var box=getParallelSegments(c0_x,c0_y,c1_x,c1_y,r),intersections=[];if(locationIndex[0]&&!locationIndex[1]){intersections.push(getCircleIntersection(aX,aY,bX,bY,c0_x,c0_y,r)),intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1])),intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]));var i=getCircleIntersections(aX,aY,bX,bY,c1_x,c1_y,r);i&&intersections.push(i[0],i[1])}else if(!locationIndex[0]&&locationIndex[1]){intersections.push(getCircleIntersection(aX,aY,bX,bY,c1_x,c1_y,r)),intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1])),intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]));var i=getCircleIntersections(aX,aY,bX,bY,c0_x,c0_y,r);i&&intersections.push(i[0],i[1])}else if(locationIndex[0]&&locationIndex[1])intersections.push(getCircleIntersection(aX,aY,bX,bY,c0_x,c0_y,r)),intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1])),intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1])),intersections.push(getCircleIntersection(aX,aY,bX,bY,c1_x,c1_y,r));else{var i=getCircleIntersections(aX,aY,bX,bY,c1_x,c1_y,r),j=getCircleIntersections(aX,aY,bX,bY,c0_x,c0_y,r);i&&intersections.push(i[0],i[1]),j&&intersections.push(j[0],j[1]),intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1])),intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]))}for(var intersection=[aX,aY],n=0;n<intersections.length;n++)intersections[n]&&getDistance(intersections[n][0],intersections[n][1],bX,bY)<getDistance(intersection[0],intersection[1],bX,bY)&&(intersection=intersections[n]);return intersection[0]===aX&&intersection[1]===aY?null:intersection}function getCapsuleIntersections(aX,aY,bX,bY,c0_x,c0_y,c1_x,c1_y,r){var box=getParallelSegments(c0_x,c0_y,c1_x,c1_y,r),intersections=[],tmp=getCircleIntersections(aX,aY,bX,bY,c0_x,c0_y,r);tmp&&intersections.push(tmp[0],tmp[1]),tmp=getCircleIntersections(aX,aY,bX,bY,c1_x,c1_y,r),tmp&&intersections.push(tmp[0],tmp[1]),intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1])),intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]));for(var intersection0=[bX,bY],intersection1=[aX,aY],n=0;n<intersections.length;n++)intersections[n]&&getDistance(intersections[n][0],intersections[n][1],aX,aY)<getDistance(intersection0[0],intersection0[1],aX,aY)&&(intersection0=intersections[n]);for(var m=0;m<intersections.length;m++)intersections[m]&&getDistance(intersections[m][0],intersections[m][1],bX,bY)<getDistance(intersection1[0],intersection1[1],bX,bY)&&(intersection1=intersections[m]);return intersection0[0]===bX&&intersection0[1]===bY||intersection1[0]===aX&&intersection1[1]===aY?null:[intersection0,intersection1]}var getLength=function(P){return Math.sqrt(P[0]*P[0]+P[1]*P[1])},EPS=1e-6,getClosestPointOnSegment=function(A,B,P){var AB=[B[0]-A[0],B[1]-A[1]],len=getLength(AB);if(len<EPS)return A;var PA=[P[0]-A[0],P[1]-A[1]],k=(AB[0]*PA[0]+AB[1]*PA[1])/len;return k<0?A:k>len?B:[A[0]+AB[0]*k/len,A[1]+AB[1]*k/len]};void 0===jQuery.migrateMute&&(jQuery.migrateMute=!0),function(e,t,n){function r(n){var r=t.console;i[n]||(i[n]=!0,e.migrateWarnings.push(n),r&&r.warn&&!e.migrateMute&&(r.warn("JQMIGRATE: "+n),e.migrateTrace&&r.trace&&r.trace()))}function a(t,a,i,o){if(Object.defineProperty)try{return Object.defineProperty(t,a,{configurable:!0,enumerable:!0,get:function(){return r(o),i},set:function(e){r(o),i=e}}),n}catch(s){}e._definePropertyBroken=!0,t[a]=i}var i={};e.migrateWarnings=[],!e.migrateMute&&t.console&&t.console.log&&t.console.log("JQMIGRATE: Logging is active"),e.migrateTrace===n&&(e.migrateTrace=!0),e.migrateReset=function(){i={},e.migrateWarnings.length=0},"BackCompat"===document.compatMode&&r("jQuery is not compatible with Quirks Mode");var o=e("<input/>",{size:1}).attr("size")&&e.attrFn,s=e.attr,u=e.attrHooks.value&&e.attrHooks.value.get||function(){return null},c=e.attrHooks.value&&e.attrHooks.value.set||function(){return n},l=/^(?:input|button)$/i,d=/^[238]$/,p=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,f=/^(?:checked|selected)$/i;a(e,"attrFn",o||{},"jQuery.attrFn is deprecated"),e.attr=function(t,a,i,u){var c=a.toLowerCase(),g=t&&t.nodeType;return u&&(4>s.length&&r("jQuery.fn.attr( props, pass ) is deprecated"),t&&!d.test(g)&&(o?a in o:e.isFunction(e.fn[a])))?e(t)[a](i):("type"===a&&i!==n&&l.test(t.nodeName)&&t.parentNode&&r("Can't change the 'type' of an input or button in IE 6/7/8"),!e.attrHooks[c]&&p.test(c)&&(e.attrHooks[c]={get:function(t,r){var a,i=e.prop(t,r);return!0===i||"boolean"!=typeof i&&(a=t.getAttributeNode(r))&&!1!==a.nodeValue?r.toLowerCase():n},set:function(t,n,r){var a;return!1===n?e.removeAttr(t,r):(a=e.propFix[r]||r,a in t&&(t[a]=!0),t.setAttribute(r,r.toLowerCase())),r}},f.test(c)&&r("jQuery.fn.attr('"+c+"') may use property instead of attribute")),s.call(e,t,a,i))},e.attrHooks.value={get:function(e,t){var n=(e.nodeName||"").toLowerCase();return"button"===n?u.apply(this,arguments):("input"!==n&&"option"!==n&&r("jQuery.fn.attr('value') no longer gets properties"),t in e?e.value:null)},set:function(e,t){var a=(e.nodeName||"").toLowerCase();return"button"===a?c.apply(this,arguments):("input"!==a&&"option"!==a&&r("jQuery.fn.attr('value', val) no longer sets properties"),e.value=t,n)}};var g,h,v=e.fn.init,m=e.parseJSON,y=/^([^<]*)(<[\w\W]+>)([^>]*)$/;e.fn.init=function(t,n,a){var i;return t&&"string"==typeof t&&!e.isPlainObject(n)&&(i=y.exec(e.trim(t)))&&i[0]&&("<"!==t.charAt(0)&&r("$(html) HTML strings must start with '<' character"),i[3]&&r("$(html) HTML text after last tag is ignored"),"#"===i[0].charAt(0)&&(r("HTML string cannot start with a '#' character"),e.error("JQMIGRATE: Invalid selector string (XSS)")),n&&n.context&&(n=n.context),e.parseHTML)?v.call(this,e.parseHTML(i[2],n,!0),n,a):v.apply(this,arguments)},e.fn.init.prototype=e.fn,e.parseJSON=function(e){return e||null===e?m.apply(this,arguments):(r("jQuery.parseJSON requires a valid JSON string"),null)},e.uaMatch=function(e){e=e.toLowerCase();var t=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||0>e.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return{browser:t[1]||"",version:t[2]||"0"}},e.browser||(g=e.uaMatch(navigator.userAgent),h={},g.browser&&(h[g.browser]=!0,h.version=g.version),h.chrome?h.webkit=!0:h.webkit&&(h.safari=!0),e.browser=h),a(e,"browser",e.browser,"jQuery.browser is deprecated"),e.sub=function(){function t(e,n){return new t.fn.init(e,n)}e.extend(!0,t,this),t.superclass=this,t.fn=t.prototype=this(),t.fn.constructor=t,t.sub=this.sub,t.fn.init=function(r,a){return a&&a instanceof e&&!(a instanceof t)&&(a=t(a)),e.fn.init.call(this,r,a,n)},t.fn.init.prototype=t.fn;var n=t(document);return r("jQuery.sub() is deprecated"),t},e.ajaxSetup({converters:{"text json":e.parseJSON}});var b=e.fn.data;e.fn.data=function(t){var a,i,o=this[0];return!o||"events"!==t||1!==arguments.length||(a=e.data(o,t),i=e._data(o,t),a!==n&&a!==i||i===n)?b.apply(this,arguments):(r("Use of jQuery.fn.data('events') is deprecated"),i)};var j=/\/(java|ecma)script/i,w=e.fn.andSelf||e.fn.addBack;e.fn.andSelf=function(){return r("jQuery.fn.andSelf() replaced by jQuery.fn.addBack()"),w.apply(this,arguments)},e.clean||(e.clean=function(t,a,i,o){a=a||document,a=!a.nodeType&&a[0]||a,a=a.ownerDocument||a,r("jQuery.clean() is deprecated");var s,u,c,l,d=[];if(e.merge(d,e.buildFragment(t,a).childNodes),i)for(c=function(e){return!e.type||j.test(e.type)?o?o.push(e.parentNode?e.parentNode.removeChild(e):e):i.appendChild(e):n},s=0;null!=(u=d[s]);s++)e.nodeName(u,"script")&&c(u)||(i.appendChild(u),u.getElementsByTagName!==n&&(l=e.grep(e.merge([],u.getElementsByTagName("script")),c),d.splice.apply(d,[s+1,0].concat(l)),s+=l.length));return d});var Q=e.event.add,x=e.event.remove,k=e.event.trigger,N=e.fn.toggle,T=e.fn.live,M=e.fn.die,S="ajaxStart|ajaxStop|ajaxSend|ajaxComplete|ajaxError|ajaxSuccess",C=RegExp("\\b(?:"+S+")\\b"),H=/(?:^|\s)hover(\.\S+|)\b/,A=function(t){return"string"!=typeof t||e.event.special.hover?t:(H.test(t)&&r("'hover' pseudo-event is deprecated, use 'mouseenter mouseleave'"),t&&t.replace(H,"mouseenter$1 mouseleave$1"))};e.event.props&&"attrChange"!==e.event.props[0]&&e.event.props.unshift("attrChange","attrName","relatedNode","srcElement"),e.event.dispatch&&a(e.event,"handle",e.event.dispatch,"jQuery.event.handle is undocumented and deprecated"),e.event.add=function(e,t,n,a,i){e!==document&&C.test(t)&&r("AJAX events should be attached to document: "+t),Q.call(this,e,A(t||""),n,a,i)},e.event.remove=function(e,t,n,r,a){x.call(this,e,A(t)||"",n,r,a)},e.fn.error=function(){var e=Array.prototype.slice.call(arguments,0);return r("jQuery.fn.error() is deprecated"),e.splice(0,0,"error"),arguments.length?this.bind.apply(this,e):(this.triggerHandler.apply(this,e),this)},e.fn.toggle=function(t,n){if(!e.isFunction(t)||!e.isFunction(n))return N.apply(this,arguments);r("jQuery.fn.toggle(handler, handler...) is deprecated");var a=arguments,i=t.guid||e.guid++,o=0,s=function(n){var r=(e._data(this,"lastToggle"+t.guid)||0)%o;return e._data(this,"lastToggle"+t.guid,r+1),n.preventDefault(),a[r].apply(this,arguments)||!1};for(s.guid=i;a.length>o;)a[o++].guid=i;return this.click(s)},e.fn.live=function(t,n,a){return r("jQuery.fn.live() is deprecated"),T?T.apply(this,arguments):(e(this.context).on(t,this.selector,n,a),this)},e.fn.die=function(t,n){return r("jQuery.fn.die() is deprecated"),M?M.apply(this,arguments):(e(this.context).off(t,this.selector||"**",n),this)},e.event.trigger=function(e,t,n,a){return n||C.test(e)||r("Global events are undocumented and deprecated"),k.call(this,e,t,n||document,a)},e.each(S.split("|"),function(t,n){e.event.special[n]={setup:function(){var t=this;return t!==document&&(e.event.add(document,n+"."+e.guid,function(){e.event.trigger(n,null,t,!0)}),e._data(this,n,e.guid++)),!1},teardown:function(){return this!==document&&e.event.remove(document,n+"."+e._data(this,n)),!1}}})}(jQuery,window),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("underscore",factory):(global=global||self,function(){var current=global._,exports=global._=factory();exports.noConflict=function(){return global._=current,exports}}())}(this,function(){var root="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||Function("return this")()||{},ArrayProto=Array.prototype,ObjProto=Object.prototype,SymbolProto="undefined"!=typeof Symbol?Symbol.prototype:null,push=ArrayProto.push,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty,supportsArrayBuffer="undefined"!=typeof ArrayBuffer,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeCreate=Object.create,nativeIsView=supportsArrayBuffer&&ArrayBuffer.isView,_isNaN=isNaN,_isFinite=isFinite,hasEnumBug=!{toString:null}.propertyIsEnumerable("toString"),nonEnumerableProps=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],MAX_ARRAY_INDEX=Math.pow(2,53)-1;function restArguments(func,startIndex){return startIndex=null==startIndex?func.length-1:+startIndex,function(){for(var length=Math.max(arguments.length-startIndex,0),rest=Array(length),index=0;index<length;index++)rest[index]=arguments[index+startIndex];switch(startIndex){case 0:return func.call(this,rest);case 1:return func.call(this,arguments[0],rest);case 2:return func.call(this,arguments[0],arguments[1],rest)}var args=Array(startIndex+1);for(index=0;index<startIndex;index++)args[index]=arguments[index];return args[startIndex]=rest,func.apply(this,args)}}function isObject(obj){var type=typeof obj;return"function"===type||"object"===type&&!!obj}function isNull(obj){return null===obj}function isUndefined(obj){return void 0===obj}function isBoolean(obj){return!0===obj||!1===obj||"[object Boolean]"===toString.call(obj)}function isElement(obj){return!(!obj||1!==obj.nodeType)}function tagTester(name){return function(obj){return toString.call(obj)==="[object "+name+"]"}}var isString=tagTester("String"),isNumber=tagTester("Number"),isDate=tagTester("Date"),isRegExp=tagTester("RegExp"),isError=tagTester("Error"),isSymbol=tagTester("Symbol"),isMap=tagTester("Map"),isWeakMap=tagTester("WeakMap"),isSet=tagTester("Set"),isWeakSet=tagTester("WeakSet"),isArrayBuffer=tagTester("ArrayBuffer"),isDataView=tagTester("DataView"),isArray=nativeIsArray||tagTester("Array"),isFunction=tagTester("Function"),nodelist=root.document&&root.document.childNodes;"function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof nodelist&&(isFunction=function(obj){return"function"==typeof obj||!1});var isFunction$1=isFunction;function has(obj,key){return null!=obj&&hasOwnProperty.call(obj,key)}var isArguments=tagTester("Arguments");!function(){isArguments(arguments)||(isArguments=function(obj){return has(obj,"callee")})}();var isArguments$1=isArguments;function isFinite$1(obj){return!isSymbol(obj)&&_isFinite(obj)&&!isNaN(parseFloat(obj))}function isNaN$1(obj){return isNumber(obj)&&_isNaN(obj)}function constant(value){return function(){return value}}function createSizePropertyCheck(getSizeProperty){return function(collection){var sizeProperty=getSizeProperty(collection);return"number"==typeof sizeProperty&&sizeProperty>=0&&sizeProperty<=MAX_ARRAY_INDEX}}function shallowProperty(key){return function(obj){return null==obj?void 0:obj[key]}}var getByteLength=shallowProperty("byteLength"),isBufferLike=createSizePropertyCheck(getByteLength),typedArrayPattern=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;function isTypedArray(obj){return nativeIsView?nativeIsView(obj)&&!isDataView(obj):isBufferLike(obj)&&typedArrayPattern.test(toString.call(obj))}var isTypedArray$1=supportsArrayBuffer?isTypedArray:constant(!1),getLength=shallowProperty("length"),isArrayLike=createSizePropertyCheck(getLength);function emulatedSet(keys){for(var hash={},l=keys.length,i=0;i<l;++i)hash[keys[i]]=!0;return{contains:function(key){return hash[key]},push:function(key){return hash[key]=!0,keys.push(key)}}}function collectNonEnumProps(obj,keys){keys=emulatedSet(keys);var nonEnumIdx=nonEnumerableProps.length,constructor=obj.constructor,proto=isFunction$1(constructor)&&constructor.prototype||ObjProto,prop="constructor";for(has(obj,prop)&&!keys.contains(prop)&&keys.push(prop);nonEnumIdx--;)(prop=nonEnumerableProps[nonEnumIdx])in obj&&obj[prop]!==proto[prop]&&!keys.contains(prop)&&keys.push(prop)}function keys(obj){if(!isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)has(obj,key)&&keys.push(key);return hasEnumBug&&collectNonEnumProps(obj,keys),keys}function isEmpty(obj){return null==obj||(isArrayLike(obj)&&(isArray(obj)||isString(obj)||isArguments$1(obj))?0===obj.length:0===keys(obj).length)}function isMatch(object,attrs){var _keys=keys(attrs),length=_keys.length;if(null==object)return!length;for(var obj=Object(object),i=0;i<length;i++){var key=_keys[i];if(attrs[key]!==obj[key]||!(key in obj))return!1}return!0}function _(obj){return obj instanceof _?obj:this instanceof _?void(this._wrapped=obj):new _(obj)}_.VERSION="1.11.0",_.prototype.value=function(){return this._wrapped},_.prototype.valueOf=_.prototype.toJSON=_.prototype.value,_.prototype.toString=function(){return String(this._wrapped)};function eq(a,b,aStack,bStack){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return!1;if(a!==a)return b!==b;var type=typeof a;return("function"===type||"object"===type||"object"==typeof b)&&deepEq(a,b,aStack,bStack)}function deepEq(a,b,aStack,bStack){a instanceof _&&(a=a._wrapped),b instanceof _&&(b=b._wrapped);var className=toString.call(a);if(className!==toString.call(b))return!1;switch(className){case"[object RegExp]":case"[object String]":return""+a==""+b;case"[object Number]":return+a!=+a?+b!=+b:0==+a?1/+a==1/b:+a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object Symbol]":return SymbolProto.valueOf.call(a)===SymbolProto.valueOf.call(b);case"[object ArrayBuffer]":return deepEq(new DataView(a),new DataView(b),aStack,bStack);case"[object DataView]":var byteLength=getByteLength(a);if(byteLength!==getByteLength(b))return!1;for(;byteLength--;)if(a.getUint8(byteLength)!==b.getUint8(byteLength))return!1;return!0}if(isTypedArray$1(a))return deepEq(new DataView(a.buffer),new DataView(b.buffer),aStack,bStack);var areArrays="[object Array]"===className;if(!areArrays){if("object"!=typeof a||"object"!=typeof b)return!1;var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(isFunction$1(aCtor)&&aCtor instanceof aCtor&&isFunction$1(bCtor)&&bCtor instanceof bCtor)&&"constructor"in a&&"constructor"in b)return!1}aStack=aStack||[],bStack=bStack||[];for(var length=aStack.length;length--;)if(aStack[length]===a)return bStack[length]===b;if(aStack.push(a),bStack.push(b),areArrays){if((length=a.length)!==b.length)return!1;for(;length--;)if(!eq(a[length],b[length],aStack,bStack))return!1}else{var key,_keys=keys(a);if(length=_keys.length,keys(b).length!==length)return!1;for(;length--;)if(key=_keys[length],!has(b,key)||!eq(a[key],b[key],aStack,bStack))return!1}return aStack.pop(),bStack.pop(),!0}function isEqual(a,b){return eq(a,b)}function allKeys(obj){if(!isObject(obj))return[];var keys=[];for(var key in obj)keys.push(key);return hasEnumBug&&collectNonEnumProps(obj,keys),keys}function values(obj){for(var _keys=keys(obj),length=_keys.length,values=Array(length),i=0;i<length;i++)values[i]=obj[_keys[i]];return values}function pairs(obj){for(var _keys=keys(obj),length=_keys.length,pairs=Array(length),i=0;i<length;i++)pairs[i]=[_keys[i],obj[_keys[i]]];return pairs}function invert(obj){for(var result={},_keys=keys(obj),i=0,length=_keys.length;i<length;i++)result[obj[_keys[i]]]=_keys[i];return result}function functions(obj){var names=[];for(var key in obj)isFunction$1(obj[key])&&names.push(key);return names.sort()}function createAssigner(keysFunc,defaults){return function(obj){var length=arguments.length;if(defaults&&(obj=Object(obj)),length<2||null==obj)return obj;for(var index=1;index<length;index++)for(var source=arguments[index],keys=keysFunc(source),l=keys.length,i=0;i<l;i++){var key=keys[i];defaults&&void 0!==obj[key]||(obj[key]=source[key])}return obj}}var extend=createAssigner(allKeys),extendOwn=createAssigner(keys),defaults=createAssigner(allKeys,!0);function ctor(){return function(){}}function baseCreate(prototype){if(!isObject(prototype))return{};if(nativeCreate)return nativeCreate(prototype);var Ctor=ctor();Ctor.prototype=prototype;var result=new Ctor;return Ctor.prototype=null,result}function create(prototype,props){var result=baseCreate(prototype);return props&&extendOwn(result,props),result}function clone(obj){return isObject(obj)?isArray(obj)?obj.slice():extend({},obj):obj}function tap(obj,interceptor){return interceptor(obj),obj}function has$1(obj,path){if(!isArray(path))return has(obj,path);for(var length=path.length,i=0;i<length;i++){var key=path[i];if(null==obj||!hasOwnProperty.call(obj,key))return!1;obj=obj[key]}return!!length}function identity(value){return value}function matcher(attrs){return attrs=extendOwn({},attrs),function(obj){return isMatch(obj,attrs)}}function deepGet(obj,path){for(var length=path.length,i=0;i<length;i++){if(null==obj)return;obj=obj[path[i]]}return length?obj:void 0}function property(path){return isArray(path)?function(obj){return deepGet(obj,path)}:shallowProperty(path)}function optimizeCb(func,context,argCount){if(void 0===context)return func;switch(null==argCount?3:argCount){case 1:return function(value){return func.call(context,value)};case 3:return function(value,index,collection){return func.call(context,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(context,accumulator,value,index,collection)}}return function(){return func.apply(context,arguments)}}function baseIteratee(value,context,argCount){return null==value?identity:isFunction$1(value)?optimizeCb(value,context,argCount):isObject(value)&&!isArray(value)?matcher(value):property(value)}function iteratee(value,context){return baseIteratee(value,context,1/0)}_.iteratee=iteratee;function cb(value,context,argCount){
return _.iteratee!==iteratee?_.iteratee(value,context):baseIteratee(value,context,argCount)}function mapObject(obj,iteratee,context){iteratee=cb(iteratee,context);for(var _keys=keys(obj),length=_keys.length,results={},index=0;index<length;index++){var currentKey=_keys[index];results[currentKey]=iteratee(obj[currentKey],currentKey,obj)}return results}function noop(){}function propertyOf(obj){return null==obj?function(){}:function(path){return isArray(path)?deepGet(obj,path):obj[path]}}function times(n,iteratee,context){var accum=Array(Math.max(0,n));iteratee=optimizeCb(iteratee,context,1);for(var i=0;i<n;i++)accum[i]=iteratee(i);return accum}function random(min,max){return null==max&&(max=min,min=0),min+Math.floor(Math.random()*(max-min+1))}var now=Date.now||function(){return(new Date).getTime()};function createEscaper(map){var escaper=function(match){return map[match]},source="(?:"+keys(map).join("|")+")",testRegexp=RegExp(source),replaceRegexp=RegExp(source,"g");return function(string){return string=null==string?"":""+string,testRegexp.test(string)?string.replace(replaceRegexp,escaper):string}}var escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},_escape=createEscaper(escapeMap),unescapeMap=invert(escapeMap),_unescape=createEscaper(unescapeMap),templateSettings=_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},noMatch=/(.)^/,escapes={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},escapeRegExp=/\\|'|\r|\n|\u2028|\u2029/g;function escapeChar(match){return"\\"+escapes[match]}function template(text,settings,oldSettings){!settings&&oldSettings&&(settings=oldSettings),settings=defaults({},settings,_.templateSettings);var matcher=RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g"),index=0,source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){return source+=text.slice(index,offset).replace(escapeRegExp,escapeChar),index=offset+match.length,escape?source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'":interpolate?source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'":evaluate&&(source+="';\n"+evaluate+"\n__p+='"),match}),source+="';\n",settings.variable||(source="with(obj||{}){\n"+source+"}\n"),source="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";var render;try{render=new Function(settings.variable||"obj","_",source)}catch(e){throw e.source=source,e}var template=function(data){return render.call(this,data,_)};return template.source="function("+(settings.variable||"obj")+"){\n"+source+"}",template}function result(obj,path,fallback){isArray(path)||(path=[path]);var length=path.length;if(!length)return isFunction$1(fallback)?fallback.call(obj):fallback;for(var i=0;i<length;i++){var prop=null==obj?void 0:obj[path[i]];void 0===prop&&(prop=fallback,i=length),obj=isFunction$1(prop)?prop.call(obj):prop}return obj}var idCounter=0;function uniqueId(prefix){var id=++idCounter+"";return prefix?prefix+id:id}function chain(obj){var instance=_(obj);return instance._chain=!0,instance}function executeBound(sourceFunc,boundFunc,context,callingContext,args){if(!(callingContext instanceof boundFunc))return sourceFunc.apply(context,args);var self=baseCreate(sourceFunc.prototype),result=sourceFunc.apply(self,args);return isObject(result)?result:self}var partial=restArguments(function(func,boundArgs){var placeholder=partial.placeholder,bound=function(){for(var position=0,length=boundArgs.length,args=Array(length),i=0;i<length;i++)args[i]=boundArgs[i]===placeholder?arguments[position++]:boundArgs[i];for(;position<arguments.length;)args.push(arguments[position++]);return executeBound(func,bound,this,this,args)};return bound});partial.placeholder=_;var bind=restArguments(function(func,context,args){if(!isFunction$1(func))throw new TypeError("Bind must be called on a function");var bound=restArguments(function(callArgs){return executeBound(func,bound,context,this,args.concat(callArgs))});return bound});function flatten(input,depth,strict,output){if(output=output||[],depth||0===depth){if(depth<=0)return output.concat(input)}else depth=1/0;for(var idx=output.length,i=0,length=getLength(input);i<length;i++){var value=input[i];if(isArrayLike(value)&&(isArray(value)||isArguments$1(value)))if(depth>1)flatten(value,depth-1,strict,output),idx=output.length;else for(var j=0,len=value.length;j<len;)output[idx++]=value[j++];else strict||(output[idx++]=value)}return output}var bindAll=restArguments(function(obj,keys){keys=flatten(keys,!1,!1);var index=keys.length;if(index<1)throw new Error("bindAll must be passed function names");for(;index--;){var key=keys[index];obj[key]=bind(obj[key],obj)}return obj});function memoize(func,hasher){var memoize=function(key){var cache=memoize.cache,address=""+(hasher?hasher.apply(this,arguments):key);return has(cache,address)||(cache[address]=func.apply(this,arguments)),cache[address]};return memoize.cache={},memoize}var delay=restArguments(function(func,wait,args){return setTimeout(function(){return func.apply(null,args)},wait)}),defer=partial(delay,_,1);function throttle(func,wait,options){var timeout,context,args,result,previous=0;options||(options={});var later=function(){previous=!1===options.leading?0:now(),timeout=null,result=func.apply(context,args),timeout||(context=args=null)},throttled=function(){var _now=now();previous||!1!==options.leading||(previous=_now);var remaining=wait-(_now-previous);return context=this,args=arguments,remaining<=0||remaining>wait?(timeout&&(clearTimeout(timeout),timeout=null),previous=_now,result=func.apply(context,args),timeout||(context=args=null)):timeout||!1===options.trailing||(timeout=setTimeout(later,remaining)),result};return throttled.cancel=function(){clearTimeout(timeout),previous=0,timeout=context=args=null},throttled}function debounce(func,wait,immediate){var timeout,result,later=function(context,args){timeout=null,args&&(result=func.apply(context,args))},debounced=restArguments(function(args){if(timeout&&clearTimeout(timeout),immediate){var callNow=!timeout;timeout=setTimeout(later,wait),callNow&&(result=func.apply(this,args))}else timeout=delay(later,wait,this,args);return result});return debounced.cancel=function(){clearTimeout(timeout),timeout=null},debounced}function wrap(func,wrapper){return partial(wrapper,func)}function negate(predicate){return function(){return!predicate.apply(this,arguments)}}function compose(){var args=arguments,start=args.length-1;return function(){for(var i=start,result=args[start].apply(this,arguments);i--;)result=args[i].call(this,result);return result}}function after(times,func){return function(){if(--times<1)return func.apply(this,arguments)}}function before(times,func){var memo;return function(){return--times>0&&(memo=func.apply(this,arguments)),times<=1&&(func=null),memo}}var once=partial(before,2);function findKey(obj,predicate,context){predicate=cb(predicate,context);for(var key,_keys=keys(obj),i=0,length=_keys.length;i<length;i++)if(key=_keys[i],predicate(obj[key],key,obj))return key}function createPredicateIndexFinder(dir){return function(array,predicate,context){predicate=cb(predicate,context);for(var length=getLength(array),index=dir>0?0:length-1;index>=0&&index<length;index+=dir)if(predicate(array[index],index,array))return index;return-1}}var findIndex=createPredicateIndexFinder(1),findLastIndex=createPredicateIndexFinder(-1);function sortedIndex(array,obj,iteratee,context){iteratee=cb(iteratee,context,1);for(var value=iteratee(obj),low=0,high=getLength(array);low<high;){var mid=Math.floor((low+high)/2);iteratee(array[mid])<value?low=mid+1:high=mid}return low}function createIndexFinder(dir,predicateFind,sortedIndex){return function(array,item,idx){var i=0,length=getLength(array);if("number"==typeof idx)dir>0?i=idx>=0?idx:Math.max(idx+length,i):length=idx>=0?Math.min(idx+1,length):idx+length+1;else if(sortedIndex&&idx&&length)return idx=sortedIndex(array,item),array[idx]===item?idx:-1;if(item!==item)return idx=predicateFind(slice.call(array,i,length),isNaN$1),idx>=0?idx+i:-1;for(idx=dir>0?i:length-1;idx>=0&&idx<length;idx+=dir)if(array[idx]===item)return idx;return-1}}var indexOf=createIndexFinder(1,findIndex,sortedIndex),lastIndexOf=createIndexFinder(-1,findLastIndex);function find(obj,predicate,context){var keyFinder=isArrayLike(obj)?findIndex:findKey,key=keyFinder(obj,predicate,context);if(void 0!==key&&-1!==key)return obj[key]}function findWhere(obj,attrs){return find(obj,matcher(attrs))}function each(obj,iteratee,context){iteratee=optimizeCb(iteratee,context);var i,length;if(isArrayLike(obj))for(i=0,length=obj.length;i<length;i++)iteratee(obj[i],i,obj);else{var _keys=keys(obj);for(i=0,length=_keys.length;i<length;i++)iteratee(obj[_keys[i]],_keys[i],obj)}return obj}function map(obj,iteratee,context){iteratee=cb(iteratee,context);for(var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length,results=Array(length),index=0;index<length;index++){var currentKey=_keys?_keys[index]:index;results[index]=iteratee(obj[currentKey],currentKey,obj)}return results}function createReduce(dir){var reducer=function(obj,iteratee,memo,initial){var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length,index=dir>0?0:length-1;for(initial||(memo=obj[_keys?_keys[index]:index],index+=dir);index>=0&&index<length;index+=dir){var currentKey=_keys?_keys[index]:index;memo=iteratee(memo,obj[currentKey],currentKey,obj)}return memo};return function(obj,iteratee,memo,context){var initial=arguments.length>=3;return reducer(obj,optimizeCb(iteratee,context,4),memo,initial)}}var reduce=createReduce(1),reduceRight=createReduce(-1);function filter(obj,predicate,context){var results=[];return predicate=cb(predicate,context),each(obj,function(value,index,list){predicate(value,index,list)&&results.push(value)}),results}function reject(obj,predicate,context){return filter(obj,negate(cb(predicate)),context)}function every(obj,predicate,context){predicate=cb(predicate,context);for(var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length,index=0;index<length;index++){var currentKey=_keys?_keys[index]:index;if(!predicate(obj[currentKey],currentKey,obj))return!1}return!0}function some(obj,predicate,context){predicate=cb(predicate,context);for(var _keys=!isArrayLike(obj)&&keys(obj),length=(_keys||obj).length,index=0;index<length;index++){var currentKey=_keys?_keys[index]:index;if(predicate(obj[currentKey],currentKey,obj))return!0}return!1}function contains(obj,item,fromIndex,guard){return isArrayLike(obj)||(obj=values(obj)),("number"!=typeof fromIndex||guard)&&(fromIndex=0),indexOf(obj,item,fromIndex)>=0}var invoke=restArguments(function(obj,path,args){var contextPath,func;return isFunction$1(path)?func=path:isArray(path)&&(contextPath=path.slice(0,-1),path=path[path.length-1]),map(obj,function(context){var method=func;if(!method){if(contextPath&&contextPath.length&&(context=deepGet(context,contextPath)),null==context)return;method=context[path]}return null==method?method:method.apply(context,args)})});function pluck(obj,key){return map(obj,property(key))}function where(obj,attrs){return filter(obj,matcher(attrs))}function max(obj,iteratee,context){var value,computed,result=-1/0,lastComputed=-1/0;if(null==iteratee||"number"==typeof iteratee&&"object"!=typeof obj[0]&&null!=obj){obj=isArrayLike(obj)?obj:values(obj);for(var i=0,length=obj.length;i<length;i++)null!=(value=obj[i])&&value>result&&(result=value)}else iteratee=cb(iteratee,context),each(obj,function(v,index,list){((computed=iteratee(v,index,list))>lastComputed||computed===-1/0&&result===-1/0)&&(result=v,lastComputed=computed)});return result}function min(obj,iteratee,context){var value,computed,result=1/0,lastComputed=1/0;if(null==iteratee||"number"==typeof iteratee&&"object"!=typeof obj[0]&&null!=obj){obj=isArrayLike(obj)?obj:values(obj);for(var i=0,length=obj.length;i<length;i++)null!=(value=obj[i])&&value<result&&(result=value)}else iteratee=cb(iteratee,context),each(obj,function(v,index,list){((computed=iteratee(v,index,list))<lastComputed||computed===1/0&&result===1/0)&&(result=v,lastComputed=computed)});return result}function sample(obj,n,guard){if(null==n||guard)return isArrayLike(obj)||(obj=values(obj)),obj[random(obj.length-1)];var sample=isArrayLike(obj)?clone(obj):values(obj),length=getLength(sample);n=Math.max(Math.min(n,length),0);for(var last=length-1,index=0;index<n;index++){var rand=random(index,last),temp=sample[index];sample[index]=sample[rand],sample[rand]=temp}return sample.slice(0,n)}function shuffle(obj){return sample(obj,1/0)}function sortBy(obj,iteratee,context){var index=0;return iteratee=cb(iteratee,context),pluck(map(obj,function(value,key,list){return{value:value,index:index++,criteria:iteratee(value,key,list)}}).sort(function(left,right){var a=left.criteria,b=right.criteria;if(a!==b){if(a>b||void 0===a)return 1;if(a<b||void 0===b)return-1}return left.index-right.index}),"value")}function group(behavior,partition){return function(obj,iteratee,context){var result=partition?[[],[]]:{};return iteratee=cb(iteratee,context),each(obj,function(value,index){var key=iteratee(value,index,obj);behavior(result,value,key)}),result}}var groupBy=group(function(result,value,key){has(result,key)?result[key].push(value):result[key]=[value]}),indexBy=group(function(result,value,key){result[key]=value}),countBy=group(function(result,value,key){has(result,key)?result[key]++:result[key]=1}),partition=group(function(result,value,pass){result[pass?0:1].push(value)},!0),reStrSymbol=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function toArray(obj){return obj?isArray(obj)?slice.call(obj):isString(obj)?obj.match(reStrSymbol):isArrayLike(obj)?map(obj,identity):values(obj):[]}function size(obj){return null==obj?0:isArrayLike(obj)?obj.length:keys(obj).length}function keyInObj(value,key,obj){return key in obj}var pick=restArguments(function(obj,keys){var result={},iteratee=keys[0];if(null==obj)return result;isFunction$1(iteratee)?(keys.length>1&&(iteratee=optimizeCb(iteratee,keys[1])),keys=allKeys(obj)):(iteratee=keyInObj,keys=flatten(keys,!1,!1),obj=Object(obj));for(var i=0,length=keys.length;i<length;i++){var key=keys[i],value=obj[key];iteratee(value,key,obj)&&(result[key]=value)}return result}),omit=restArguments(function(obj,keys){var context,iteratee=keys[0];return isFunction$1(iteratee)?(iteratee=negate(iteratee),keys.length>1&&(context=keys[1])):(keys=map(flatten(keys,!1,!1),String),iteratee=function(value,key){return!contains(keys,key)}),pick(obj,iteratee,context)});function initial(array,n,guard){return slice.call(array,0,Math.max(0,array.length-(null==n||guard?1:n)))}function first(array,n,guard){return null==array||array.length<1?null==n||guard?void 0:[]:null==n||guard?array[0]:initial(array,array.length-n)}function rest(array,n,guard){return slice.call(array,null==n||guard?1:n)}function last(array,n,guard){return null==array||array.length<1?null==n||guard?void 0:[]:null==n||guard?array[array.length-1]:rest(array,Math.max(0,array.length-n))}function compact(array){return filter(array,Boolean)}function flatten$1(array,depth){return flatten(array,depth,!1)}var difference=restArguments(function(array,rest){return rest=flatten(rest,!0,!0),filter(array,function(value){return!contains(rest,value)})}),without=restArguments(function(array,otherArrays){return difference(array,otherArrays)});function uniq(array,isSorted,iteratee,context){isBoolean(isSorted)||(context=iteratee,iteratee=isSorted,isSorted=!1),null!=iteratee&&(iteratee=cb(iteratee,context));for(var result=[],seen=[],i=0,length=getLength(array);i<length;i++){var value=array[i],computed=iteratee?iteratee(value,i,array):value;isSorted&&!iteratee?(i&&seen===computed||result.push(value),seen=computed):iteratee?contains(seen,computed)||(seen.push(computed),result.push(value)):contains(result,value)||result.push(value)}return result}var union=restArguments(function(arrays){return uniq(flatten(arrays,!0,!0))});function intersection(array){for(var result=[],argsLength=arguments.length,i=0,length=getLength(array);i<length;i++){var item=array[i];if(!contains(result,item)){var j;for(j=1;j<argsLength&&contains(arguments[j],item);j++);j===argsLength&&result.push(item)}}return result}function unzip(array){for(var length=array&&max(array,getLength).length||0,result=Array(length),index=0;index<length;index++)result[index]=pluck(array,index);return result}var zip=restArguments(unzip);function object(list,values){for(var result={},i=0,length=getLength(list);i<length;i++)values?result[list[i]]=values[i]:result[list[i][0]]=list[i][1];return result}function range(start,stop,step){null==stop&&(stop=start||0,start=0),step||(step=stop<start?-1:1);for(var length=Math.max(Math.ceil((stop-start)/step),0),range=Array(length),idx=0;idx<length;idx++,start+=step)range[idx]=start;return range}function chunk(array,count){if(null==count||count<1)return[];for(var result=[],i=0,length=array.length;i<length;)result.push(slice.call(array,i,i+=count));return result}function chainResult(instance,obj){return instance._chain?_(obj).chain():obj}function mixin(obj){return each(functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];return push.apply(args,arguments),chainResult(this,func.apply(_,args))}}),_}each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;return null!=obj&&(method.apply(obj,arguments),"shift"!==name&&"splice"!==name||0!==obj.length||delete obj[0]),chainResult(this,obj)}}),each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;return null!=obj&&(obj=method.apply(obj,arguments)),chainResult(this,obj)}});var allExports={__proto__:null,VERSION:"1.11.0",restArguments:restArguments,isObject:isObject,isNull:isNull,isUndefined:isUndefined,isBoolean:isBoolean,isElement:isElement,isString:isString,isNumber:isNumber,isDate:isDate,isRegExp:isRegExp,isError:isError,isSymbol:isSymbol,isMap:isMap,isWeakMap:isWeakMap,isSet:isSet,isWeakSet:isWeakSet,isArrayBuffer:isArrayBuffer,isDataView:isDataView,isArray:isArray,isFunction:isFunction$1,isArguments:isArguments$1,isFinite:isFinite$1,isNaN:isNaN$1,isTypedArray:isTypedArray$1,isEmpty:isEmpty,isMatch:isMatch,isEqual:isEqual,keys:keys,allKeys:allKeys,values:values,pairs:pairs,invert:invert,functions:functions,methods:functions,extend:extend,extendOwn:extendOwn,assign:extendOwn,defaults:defaults,create:create,clone:clone,tap:tap,has:has$1,mapObject:mapObject,identity:identity,constant:constant,noop:noop,property:property,propertyOf:propertyOf,matcher:matcher,matches:matcher,times:times,random:random,now:now,escape:_escape,unescape:_unescape,templateSettings:templateSettings,template:template,result:result,uniqueId:uniqueId,chain:chain,iteratee:iteratee,partial:partial,bind:bind,bindAll:bindAll,memoize:memoize,delay:delay,defer:defer,throttle:throttle,debounce:debounce,wrap:wrap,negate:negate,compose:compose,after:after,before:before,once:once,findKey:findKey,findIndex:findIndex,findLastIndex:findLastIndex,sortedIndex:sortedIndex,indexOf:indexOf,lastIndexOf:lastIndexOf,find:find,detect:find,findWhere:findWhere,each:each,forEach:each,map:map,collect:map,reduce:reduce,foldl:reduce,inject:reduce,reduceRight:reduceRight,foldr:reduceRight,filter:filter,select:filter,reject:reject,every:every,all:every,some:some,any:some,contains:contains,includes:contains,include:contains,invoke:invoke,pluck:pluck,where:where,max:max,min:min,shuffle:shuffle,sample:sample,sortBy:sortBy,groupBy:groupBy,indexBy:indexBy,countBy:countBy,partition:partition,toArray:toArray,size:size,pick:pick,omit:omit,first:first,head:first,take:first,initial:initial,last:last,rest:rest,tail:rest,drop:rest,compact:compact,flatten:flatten$1,without:without,uniq:uniq,unique:uniq,union:union,intersection:intersection,difference:difference,unzip:unzip,transpose:unzip,zip:zip,object:object,range:range,chunk:chunk,mixin:mixin,default:_},_$1=mixin(allExports);return _$1._=_$1,_$1}),function(e,t){"use strict";var n=t.prototype.trim,r=t.prototype.trimRight,i=t.prototype.trimLeft,s=function(e){return 1*e||0},o=function(e,t){if(t<1)return"";for(var n="";t>0;)1&t&&(n+=e),t>>=1,e+=e;return n},u=[].slice,a=function(e){return null==e?"\\s":e.source?e.source:"["+p.escapeRegExp(e)+"]"},f={lt:"<",gt:">",quot:'"',apos:"'",amp:"&"},l={};for(var c in f)l[f[c]]=c;var h=function(){function e(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}var n=o,r=function(){return r.cache.hasOwnProperty(arguments[0])||(r.cache[arguments[0]]=r.parse(arguments[0])),r.format.call(null,r.cache[arguments[0]],arguments)};return r.format=function(r,i){var a,l,c,p,d,v,m,s=1,o=r.length,u="",f=[];for(l=0;l<o;l++)if("string"===(u=e(r[l])))f.push(r[l]);else if("array"===u){if(p=r[l],p[2])for(a=i[s],c=0;c<p[2].length;c++){if(!a.hasOwnProperty(p[2][c]))throw new Error(h('[_.sprintf] property "%s" does not exist',p[2][c]));a=a[p[2][c]]}else a=p[1]?i[p[1]]:i[s++];if(/[^s]/.test(p[8])&&"number"!=e(a))throw new Error(h("[_.sprintf] expecting number but found %s",e(a)));switch(p[8]){case"b":a=a.toString(2);break;case"c":a=t.fromCharCode(a);break;case"d":a=parseInt(a,10);break;case"e":a=p[7]?a.toExponential(p[7]):a.toExponential();break;case"f":a=p[7]?parseFloat(a).toFixed(p[7]):parseFloat(a);break;case"o":a=a.toString(8);break;case"s":a=(a=t(a))&&p[7]?a.substring(0,p[7]):a;break;case"u":a=Math.abs(a);break;case"x":a=a.toString(16);break;case"X":a=a.toString(16).toUpperCase()}a=/[def]/.test(p[8])&&p[3]&&a>=0?"+"+a:a,v=p[4]?"0"==p[4]?"0":p[4].charAt(1):" ",m=p[6]-t(a).length,d=p[6]?n(v,m):"",f.push(p[5]?a+d:d+a)}return f.join("")},r.cache={},r.parse=function(e){for(var t=e,n=[],r=[],i=0;t;){if(null!==(n=/^[^\x25]+/.exec(t)))r.push(n[0]);else if(null!==(n=/^\x25{2}/.exec(t)))r.push("%");else{if(null===(n=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(t)))throw new Error("[_.sprintf] huh?");if(n[2]){i|=1;var s=[],o=n[2],u=[];if(null===(u=/^([a-z_][a-z_\d]*)/i.exec(o)))throw new Error("[_.sprintf] huh?");for(s.push(u[1]);""!==(o=o.substring(u[0].length));)if(null!==(u=/^\.([a-z_][a-z_\d]*)/i.exec(o)))s.push(u[1]);else{if(null===(u=/^\[(\d+)\]/.exec(o)))throw new Error("[_.sprintf] huh?");s.push(u[1])}n[2]=s}else i|=2;if(3===i)throw new Error("[_.sprintf] mixing positional and named placeholders is not (yet) supported");r.push(n)}t=t.substring(n[0].length)}return r},r}(),p={VERSION:"2.3.0",isBlank:function(e){return null==e&&(e=""),/^\s*$/.test(e)},stripTags:function(e){return null==e?"":t(e).replace(/<\/?[^>]+>/g,"")},capitalize:function(e){return e=null==e?"":t(e),e.charAt(0).toUpperCase()+e.slice(1)},chop:function(e,n){return null==e?[]:(e=t(e),n=~~n,n>0?e.match(new RegExp(".{1,"+n+"}","g")):[e])},clean:function(e){return p.strip(e).replace(/\s+/g," ")},count:function(e,n){return null==e||null==n?0:t(e).split(n).length-1},chars:function(e){return null==e?[]:t(e).split("")},swapCase:function(e){return null==e?"":t(e).replace(/\S/g,function(e){return e===e.toUpperCase()?e.toLowerCase():e.toUpperCase()})},escapeHTML:function(e){return null==e?"":t(e).replace(/[&<>"']/g,function(e){return"&"+l[e]+";"})},unescapeHTML:function(e){return null==e?"":t(e).replace(/\&([^;]+);/g,function(e,n){var r;return n in f?f[n]:(r=n.match(/^#x([\da-fA-F]+)$/))?t.fromCharCode(parseInt(r[1],16)):(r=n.match(/^#(\d+)$/))?t.fromCharCode(~~r[1]):e})},escapeRegExp:function(e){return null==e?"":t(e).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")},splice:function(e,t,n,r){var i=p.chars(e);return i.splice(~~t,~~n,r),i.join("")},insert:function(e,t,n){return p.splice(e,t,0,n)},include:function(e,n){return""===n||null!=e&&-1!==t(e).indexOf(n)},join:function(){var e=u.call(arguments),t=e.shift();return null==t&&(t=""),e.join(t)},lines:function(e){return null==e?[]:t(e).split("\n")},reverse:function(e){return p.chars(e).reverse().join("")},startsWith:function(e,n){return""===n||null!=e&&null!=n&&(e=t(e),n=t(n),e.length>=n.length&&e.slice(0,n.length)===n)},endsWith:function(e,n){return""===n||null!=e&&null!=n&&(e=t(e),n=t(n),e.length>=n.length&&e.slice(e.length-n.length)===n)},succ:function(e){return null==e?"":(e=t(e),e.slice(0,-1)+t.fromCharCode(e.charCodeAt(e.length-1)+1))},titleize:function(e){return null==e?"":t(e).replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})},camelize:function(e){return p.trim(e).replace(/[-_\s]+(.)?/g,function(e,t){return t.toUpperCase()})},underscored:function(e){return p.trim(e).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},dasherize:function(e){return p.trim(e).replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").toLowerCase()},classify:function(e){return p.titleize(t(e).replace(/_/g," ")).replace(/\s/g,"")},humanize:function(e){return p.capitalize(p.underscored(e).replace(/_id$/,"").replace(/_/g," "))},trim:function(e,r){return null==e?"":!r&&n?n.call(e):(r=a(r),t(e).replace(new RegExp("^"+r+"+|"+r+"+$","g"),""))},ltrim:function(e,n){return null==e?"":!n&&i?i.call(e):(n=a(n),t(e).replace(new RegExp("^"+n+"+"),""))},rtrim:function(e,n){return null==e?"":!n&&r?r.call(e):(n=a(n),t(e).replace(new RegExp(n+"+$"),""))},truncate:function(e,n,r){return null==e?"":(e=t(e),r=r||"...",n=~~n,e.length>n?e.slice(0,n)+r:e)},prune:function(e,n,r){if(null==e)return"";if(e=t(e),n=~~n,r=null!=r?t(r):"...",e.length<=n)return e;var i=function(e){return e.toUpperCase()!==e.toLowerCase()?"A":" "},s=e.slice(0,n+1).replace(/.(?=\W*\w*$)/g,i);return s=s.slice(s.length-2).match(/\w\w/)?s.replace(/\s*\S+$/,""):p.rtrim(s.slice(0,s.length-1)),(s+r).length>e.length?e:e.slice(0,s.length)+r},words:function(e,t){return p.isBlank(e)?[]:p.trim(e,t).split(t||/\s+/)},pad:function(e,n,r,i){e=null==e?"":t(e),n=~~n;var s=0;switch(r?r.length>1&&(r=r.charAt(0)):r=" ",i){case"right":return s=n-e.length,e+o(r,s);case"both":return s=n-e.length,o(r,Math.ceil(s/2))+e+o(r,Math.floor(s/2));default:return s=n-e.length,o(r,s)+e}},lpad:function(e,t,n){return p.pad(e,t,n)},rpad:function(e,t,n){return p.pad(e,t,n,"right")},lrpad:function(e,t,n){return p.pad(e,t,n,"both")},sprintf:h,vsprintf:function(e,t){return t.unshift(e),h.apply(null,t)},toNumber:function(e,n){if(null==e||""==e)return 0;e=t(e);var r=s(s(e).toFixed(~~n));return 0!==r||e.match(/^0+$/)?r:Number.NaN},numberFormat:function(e,t,n,r){if(isNaN(e)||null==e)return"";e=e.toFixed(~~t),r=r||",";var i=e.split("."),s=i[0],o=i[1]?(n||".")+i[1]:"";return s.replace(/(\d)(?=(?:\d{3})+$)/g,"$1"+r)+o},strRight:function(e,n){if(null==e)return"";e=t(e),n=null!=n?t(n):n;var r=n?e.indexOf(n):-1;return~r?e.slice(r+n.length,e.length):e},strRightBack:function(e,n){if(null==e)return"";e=t(e),n=null!=n?t(n):n;var r=n?e.lastIndexOf(n):-1;return~r?e.slice(r+n.length,e.length):e},strLeft:function(e,n){if(null==e)return"";e=t(e),n=null!=n?t(n):n;var r=n?e.indexOf(n):-1;return~r?e.slice(0,r):e},strLeftBack:function(e,t){if(null==e)return"";e+="",t=null!=t?""+t:t;var n=e.lastIndexOf(t);return~n?e.slice(0,n):e},toSentence:function(e,t,n,r){t=t||", ",n=n||" and ";var i=e.slice(),s=i.pop();return e.length>2&&r&&(n=p.rtrim(t)+n),i.length?i.join(t)+n+s:s},toSentenceSerial:function(){var e=u.call(arguments);return e[3]=!0,p.toSentence.apply(p,e)},slugify:function(e){if(null==e)return"";var n="ÄÃ Ã¡Ã¤Ã¢Ã£Ã¥Ã¦ÄÄÃ¨Ã©Ã«ÃªÃ¬Ã­Ã¯Ã®ÅÅÃ²Ã³Ã¶Ã´ÃµÃ¸Ã¹ÃºÃ¼Ã»Ã±Ã§Å¼Åº",i=new RegExp(a(n),"g");return e=t(e).toLowerCase().replace(i,function(e){return"aaaaaaaaceeeeeiiiilnoooooouuuunczz".charAt(n.indexOf(e))||"-"}),p.dasherize(e.replace(/[^\w\s-]/g,""))},surround:function(e,t){return[t,e,t].join("")},quote:function(e){return p.surround(e,'"')},exports:function(){var e={};for(var t in this)this.hasOwnProperty(t)&&!t.match(/^(?:include|contains|reverse)$/)&&(e[t]=this[t]);return e},repeat:function(e,n,r){if(null==e)return"";if(n=~~n,null==r)return o(t(e),n);for(var i=[];n>0;i[--n]=e);return i.join(r)},levenshtein:function(e,n){if(null==e&&null==n)return 0;if(null==e)return t(n).length;if(null==n)return t(e).length;e=t(e),n=t(n);for(var i,s,r=[],o=0;o<=n.length;o++)for(var u=0;u<=e.length;u++)s=o&&u?e.charAt(u-1)===n.charAt(o-1)?i:Math.min(r[u],r[u-1],i)+1:o+u,i=r[u],r[u]=s;return r.pop()}};p.strip=p.trim,p.lstrip=p.ltrim,p.rstrip=p.rtrim,p.center=p.lrpad,p.rjust=p.lpad,p.ljust=p.rpad,p.contains=p.include,p.q=p.quote,"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(module.exports=p),exports._s=p):"function"==typeof define&&define.amd?define("underscore.string",[],function(){return p}):(e._=e._||{},e._.string=e._.str=p)}(this,String),function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):factory("object"==typeof exports?require("jquery"):jQuery)}(function($){var ua=navigator.userAgent,iPhone=/iphone/i.test(ua),chrome=/chrome/i.test(ua),android=/android/i.test(ua);$.mask={definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"},autoclear:!0,allowpartial:!1,dataName:"rawMaskFn",placeholder:"_"},$.fn.extend({caret:function(begin,end){if(0!==this.length&&!this.is(":hidden")&&this.get(0)===document.activeElement)return"number"==typeof begin?(end="number"==typeof end?end:begin,this.each(function(){this.setSelectionRange(begin,end)})):(begin=this[0].selectionStart,end=this[0].selectionEnd,{begin:begin,end:end})},unmask:function(){return this.trigger("unmask")},mask:function(mask,settings){var input,defs,tests,partialPosition,firstNonMaskPos,lastRequiredNonMaskPos,len,oldVal;if(!mask&&this.length>0){input=$(this[0]);var fn=input.data($.mask.dataName);return fn?fn():void 0}return settings=$.extend({autoclear:$.mask.autoclear,allowpartial:$.mask.allowpartial,placeholder:$.mask.placeholder,completed:null,onInput:null},settings),defs=$.mask.definitions,tests=[],partialPosition=len=mask.length,firstNonMaskPos=null,mask=String(mask),$.each(mask.split(""),function(i,c){"?"==c?(len--,partialPosition=i):defs[c]?(tests.push(new RegExp(defs[c])),null===firstNonMaskPos&&(firstNonMaskPos=tests.length-1),i<partialPosition&&(lastRequiredNonMaskPos=tests.length-1)):tests.push(null)}),this.trigger("unmask").each(function(){var input=$(this),buffer=$.map(mask.split(""),function(c,i){if("?"!=c)return defs[c]?getPlaceholder(i):c}),defaultBuffer=buffer.join(""),focusText=input.val();function tryFireCompleted(){if(settings.completed){for(var i=firstNonMaskPos;i<=lastRequiredNonMaskPos;i++)if(tests[i]&&buffer[i]===getPlaceholder(i))return;settings.completed.call(input)}}function getPlaceholder(i){return i<settings.placeholder.length?settings.placeholder.charAt(i):settings.placeholder.charAt(0)}function seekNext(pos){for(;++pos<len&&!tests[pos];);return pos}function seekPrev(pos){return Math.max(--pos,0)}function shiftL(begin,end){var i,j;if(!(begin<0)){for(i=begin,j=i+1;i<len;i++)if(tests[i]&&tests[j]){if(!(j<len))break;buffer[i]=buffer[j],buffer[j]=getPlaceholder(j),j+=1}writeBuffer(),input.caret(Math.max(firstNonMaskPos,begin))}}function androidInputEvent(e){var curVal=input.val(),pos=input.caret();if(oldVal&&oldVal.length&&oldVal.length>curVal.length){for(checkVal(!0);pos.begin>0&&!tests[pos.begin-1];)pos.begin--;if(0===pos.begin)for(;pos.begin<firstNonMaskPos&&!tests[pos.begin];)pos.begin++;input.caret(pos.begin,pos.begin)}else{var lastEnteredValue=(checkVal(!0),curVal.charAt(pos.begin));pos.begin<len&&(tests[pos.begin]?tests[pos.begin].test(lastEnteredValue)&&pos.begin++:(pos.begin++,tests[pos.begin].test(lastEnteredValue)&&pos.begin++)),input.caret(pos.begin,pos.begin)}settings.onInput.call(input),tryFireCompleted()}function blurEvent(e){checkVal(),input.val()!=focusText&&input.change()}function keydownEvent(e){if(!input.prop("readonly")){var pos,begin,end,k=e.which||e.keyCode;oldVal=input.val(),8===k||46===k||iPhone&&127===k?(pos=input.caret(),begin=pos.begin,end=pos.end,
end-begin==0&&(begin=46!==k?seekPrev(begin):begin,end=46===k?end+1:end),clearBuffer(begin,end),46===k?(writeBuffer(),input.caret(Math.max(0,end))):(writeBuffer(),input.caret(Math.max(0,begin))),settings.onInput.call(input),e.preventDefault()):13===k?blurEvent.call(this,e):27===k&&(input.val(focusText),input.caret(0,checkVal()),e.preventDefault())}}function keypressEvent(e){if(!input.prop("readonly")){var p,c,next,k=e.which||e.keyCode,pos=input.caret();if(!(e.ctrlKey||e.altKey||e.metaKey||k<32)&&k&&13!==k){if(pos.end-pos.begin!=0&&(clearBuffer(pos.begin,pos.end),shiftL(pos.begin,pos.end-1)),(p=seekNext(pos.begin-1))<len&&(c=String.fromCharCode(k),tests[p].test(c))){if(buffer[p]=c,writeBuffer(),next=seekNext(p),android){var proxy=function(){$.proxy($.fn.caret,input,next)()};setTimeout(proxy,0)}else input.caret(next);pos.begin<=lastRequiredNonMaskPos&&tryFireCompleted()}settings.onInput.call(input),e.preventDefault()}}}function clearBuffer(start,end){var i;for(i=start;i<end&&i<len;i++)tests[i]&&(buffer[i]=getPlaceholder(i))}function writeBuffer(){input.val(buffer.join(""))}function isEmpty(){for(var c,i=0,empty=!0;empty&&i<buffer.length;)c=buffer[i],tests[i]&&tests[i].test(c)&&(empty=!1),i++;return empty}function checkVal(allow){var i,c,pos,test=input.val(),lastMatch=-1;for(i=0,pos=0;i<len;i++)if(!settings.allowpartial&&tests[i]){for(buffer[i]=getPlaceholder(i);pos++<test.length;)if(c=test.charAt(pos-1),tests[i].test(c)){buffer[i]=c,lastMatch=i;break}if(pos>test.length){clearBuffer(i+1,len);break}}else settings.allowpartial&&tests[i]?(test.length&&(buffer[i]=test.charAt(pos),pos++),i<partialPosition&&(lastMatch=i)):(buffer[i]===test.charAt(pos)&&pos++,i<partialPosition&&(lastMatch=i));return allow?writeBuffer():lastMatch+1<partialPosition?settings.autoclear||buffer.join("")===defaultBuffer?(input.val()&&input.val(""),clearBuffer(0,len)):writeBuffer():(writeBuffer(),input.val(input.val().substring(0,lastMatch+1))),partialPosition?i:firstNonMaskPos}input.data($.mask.dataName,function(){return $.map(buffer,function(c,i){return tests[i]&&c!=getPlaceholder(i)?c:null}).join("")});var isClick=!1;input.one("unmask",function(){input.off(".mask").removeData($.mask.dataName)}).on("mousedown.mask",function(e){isClick=!0}).on("click.mask",function(){isClick=!1}).on("focus.mask",function(ev){input.prop("readonly")||isClick&&!isEmpty()||input.data("skipMaskFocus")||(isEmpty()?setTimeout(function(){input.caret(Math.max(firstNonMaskPos,0))},0):(input.caret(Math.max(firstNonMaskPos,0),checkVal()),ev.preventDefault()))}).on("disabled-blur.mask",blurEvent).on("keydown.mask",keydownEvent).on("keypress.mask",keypressEvent).on("input.mask paste.mask",function(){input.prop("readonly")||setTimeout(function(){var pos=checkVal(!0);input.caret(pos),tryFireCompleted(),settings.onInput.call(input)},0)}),chrome&&android&&input.off("input.mask").on("input.mask",androidInputEvent),checkVal()})}})}),function(E){function t(c,a,e){var f,k,l,h,m,w,n,v,g=0,b=[],d=0,q=!1,r=!1,p=[],t=[],u=!1;if(e=e||{},f=e.encoding||"UTF8",v=e.numRounds||1,l=y(a,f),v!==parseInt(v,10)||1>v)throw Error("numRounds must a integer >= 1");if("SHA-1"!==c)throw Error("Chosen SHA variant is not supported");m=512,w=z,n=F,h=160,k=x(c),this.setHMACKey=function(a,b,d){var e;if(!0===r)throw Error("HMAC key already set");if(!0===q)throw Error("Cannot set HMAC key after finalizing hash");if(!0===u)throw Error("Cannot set HMAC key after calling update");if(f=(d||{}).encoding||"UTF8",b=y(b,f)(a),a=b.binLen,b=b.value,e=m>>>3,d=e/4-1,e<a/8){for(b=n(b,a,0,x(c));b.length<=d;)b.push(0);b[d]&=4294967040}else if(e>a/8){for(;b.length<=d;)b.push(0);b[d]&=4294967040}for(a=0;a<=d;a+=1)p[a]=909522486^b[a],t[a]=1549556828^b[a];k=w(p,k),g=m,r=!0},this.update=function(a){var c,e,f,h=0,n=m>>>5;for(c=l(a,b,d),a=c.binLen,e=c.value,c=a>>>5,f=0;f<c;f+=n)h+m<=a&&(k=w(e.slice(f,f+n),k),h+=m);g+=h,b=e.slice(h>>>5),d=a%m,u=!0},this.getHash=function(a,e){var f,l,m;if(!0===r)throw Error("Cannot call getHash after setting HMAC key");switch(m=A(e),a){case"HEX":f=function(a){return B(a,m)};break;case"B64":f=function(a){return C(a,m)};break;case"BYTES":f=D;break;default:throw Error("format must be HEX, B64, or BYTES")}if(!1===q)for(k=n(b,d,g,k),l=1;l<v;l+=1)k=n(k,h,0,x(c));return q=!0,f(k)},this.getHMAC=function(a,e){var f,l,p;if(!1===r)throw Error("Cannot call getHMAC without first setting HMAC key");switch(p=A(e),a){case"HEX":f=function(a){return B(a,p)};break;case"B64":f=function(a){return C(a,p)};break;case"BYTES":f=D;break;default:throw Error("outputFormat must be HEX, B64, or BYTES")}return!1===q&&(l=n(b,d,g,k),k=w(t,x(c)),k=n(l,h,m,k)),q=!0,f(k)}}function G(c,a,e){var b,d,f,k,l,g=c.length;if(a=a||[0],e=e||0,l=e>>>3,0!=g%2)throw Error("String of HEX type must be in byte increments");for(b=0;b<g;b+=2){if(d=parseInt(c.substr(b,2),16),isNaN(d))throw Error("String of HEX type contains invalid characters");for(k=(b>>>1)+l,f=k>>>2;a.length<=f;)a.push(0);a[f]|=d<<8*(3-k%4)}return{value:a,binLen:4*g+e}}function H(c,a,e){var b,d,f,k,g=[],g=a||[0];for(e=e||0,d=e>>>3,b=0;b<c.length;b+=1)a=c.charCodeAt(b),k=b+d,f=k>>>2,g.length<=f&&g.push(0),g[f]|=a<<8*(3-k%4);return{value:g,binLen:8*c.length+e}}function I(c,a,e){var d,f,k,l,h,m,g=[],b=0,g=a||[0];if(e=e||0,a=e>>>3,-1===c.search(/^[a-zA-Z0-9=+\/]+$/))throw Error("Invalid character in base-64 string");if(f=c.indexOf("="),c=c.replace(/\=/g,""),-1!==f&&f<c.length)throw Error("Invalid '=' found in base-64 string");for(f=0;f<c.length;f+=4){for(h=c.substr(f,4),k=l=0;k<h.length;k+=1)d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(h[k]),l|=d<<18-6*k;for(k=0;k<h.length-1;k+=1){for(m=b+a,d=m>>>2;g.length<=d;)g.push(0);g[d]|=(l>>>16-8*k&255)<<8*(3-m%4),b+=1}}return{value:g,binLen:8*b+e}}function B(c,a){var b,d,e="",g=4*c.length;for(b=0;b<g;b+=1)d=c[b>>>2]>>>8*(3-b%4),e+="0123456789abcdef".charAt(d>>>4&15)+"0123456789abcdef".charAt(15&d);return a.outputUpper?e.toUpperCase():e}function C(c,a){var b,d,f,e="",g=4*c.length;for(b=0;b<g;b+=3)for(f=b+1>>>2,d=c.length<=f?0:c[f],f=b+2>>>2,f=c.length<=f?0:c[f],f=(c[b>>>2]>>>8*(3-b%4)&255)<<16|(d>>>8*(3-(b+1)%4)&255)<<8|f>>>8*(3-(b+2)%4)&255,d=0;4>d;d+=1)8*b+6*d<=32*c.length?e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(f>>>6*(3-d)&63):e+=a.b64Pad;return e}function D(c){var g,b,a="",e=4*c.length;for(g=0;g<e;g+=1)b=c[g>>>2]>>>8*(3-g%4)&255,a+=String.fromCharCode(b);return a}function A(c){var a={outputUpper:!1,b64Pad:"="};if(c=c||{},a.outputUpper=c.outputUpper||!1,a.b64Pad=c.b64Pad||"=","boolean"!=typeof a.outputUpper)throw Error("Invalid outputUpper formatting option");if("string"!=typeof a.b64Pad)throw Error("Invalid b64Pad formatting option");return a}function y(c,a){var e;switch(a){case"UTF8":case"UTF16BE":case"UTF16LE":break;default:throw Error("encoding must be UTF8, UTF16BE, or UTF16LE")}switch(c){case"HEX":e=G;break;case"TEXT":e=function(e,b,d){var h,m,p,n,q,f=[],c=[],l=0,f=b||[0];if(b=d||0,p=b>>>3,"UTF8"===a)for(h=0;h<e.length;h+=1)for(d=e.charCodeAt(h),c=[],128>d?c.push(d):2048>d?(c.push(192|d>>>6),c.push(128|63&d)):55296>d||57344<=d?c.push(224|d>>>12,128|d>>>6&63,128|63&d):(h+=1,d=65536+((1023&d)<<10|1023&e.charCodeAt(h)),c.push(240|d>>>18,128|d>>>12&63,128|d>>>6&63,128|63&d)),m=0;m<c.length;m+=1){for(q=l+p,n=q>>>2;f.length<=n;)f.push(0);f[n]|=c[m]<<8*(3-q%4),l+=1}else if("UTF16BE"===a||"UTF16LE"===a)for(h=0;h<e.length;h+=1){for(d=e.charCodeAt(h),"UTF16LE"===a&&(m=255&d,d=m<<8|d>>>8),q=l+p,n=q>>>2;f.length<=n;)f.push(0);f[n]|=d<<8*(2-q%4),l+=2}return{value:f,binLen:8*l+b}};break;case"B64":e=I;break;case"BYTES":e=H;break;default:throw Error("format must be HEX, TEXT, B64, or BYTES")}return e}function r(c,a){return c<<a|c>>>32-a}function p(c,a){var e=(65535&c)+(65535&a);return((c>>>16)+(a>>>16)+(e>>>16)&65535)<<16|65535&e}function u(c,a,e,g,b){var d=(65535&c)+(65535&a)+(65535&e)+(65535&g)+(65535&b);return((c>>>16)+(a>>>16)+(e>>>16)+(g>>>16)+(b>>>16)+(d>>>16)&65535)<<16|65535&d}function x(c){if("SHA-1"!==c)throw Error("No SHA variants supported");return c=[1732584193,4023233417,2562383102,271733878,3285377520]}function z(c,a){var g,b,d,f,k,l,h,e=[];for(g=a[0],b=a[1],d=a[2],f=a[3],k=a[4],h=0;80>h;h+=1)e[h]=16>h?c[h]:r(e[h-3]^e[h-8]^e[h-14]^e[h-16],1),l=20>h?u(r(g,5),b&d^~b&f,k,1518500249,e[h]):40>h?u(r(g,5),b^d^f,k,1859775393,e[h]):60>h?u(r(g,5),b&d^b&f^d&f,k,2400959708,e[h]):u(r(g,5),b^d^f,k,3395469782,e[h]),k=f,f=d,d=r(b,30),b=g,g=l;return a[0]=p(g,a[0]),a[1]=p(b,a[1]),a[2]=p(d,a[2]),a[3]=p(f,a[3]),a[4]=p(k,a[4]),a}function F(c,a,e,g){var b;for(b=15+(a+65>>>9<<4);c.length<=b;)c.push(0);for(c[a>>>5]|=128<<24-a%32,c[b]=a+e,e=c.length,a=0;a<e;a+=16)g=z(c.slice(a,a+16),g);return g}"function"==typeof define&&define.amd?define(function(){return t}):"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports?module.exports=exports=t:exports=t:E.jsSHA=t}(this),function(){"use strict";var document="undefined"!=typeof window&&void 0!==window.document?window.document:{},isCommonjs="undefined"!=typeof module&&module.exports,keyboardAllowed="undefined"!=typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element,fn=function(){for(var val,fnMap=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],i=0,l=fnMap.length,ret={};i<l;i++)if((val=fnMap[i])&&val[1]in document){for(i=0;i<val.length;i++)ret[fnMap[0][i]]=val[i];return ret}return!1}(),eventNameMap={change:fn.fullscreenchange,error:fn.fullscreenerror},screenfull={request:function(elem){var request=fn.requestFullscreen;elem=elem||document.documentElement,/ Version\/5\.1(?:\.\d+)? Safari\//.test(navigator.userAgent)?elem[request]():elem[request](keyboardAllowed?Element.ALLOW_KEYBOARD_INPUT:{})},exit:function(){document[fn.exitFullscreen]()},toggle:function(elem){this.isFullscreen?this.exit():this.request(elem)},onchange:function(callback){this.on("change",callback)},onerror:function(callback){this.on("error",callback)},on:function(event,callback){var eventName=eventNameMap[event];eventName&&document.addEventListener(eventName,callback,!1)},off:function(event,callback){var eventName=eventNameMap[event];eventName&&document.removeEventListener(eventName,callback,!1)},raw:fn};if(!fn)return void(isCommonjs?module.exports=!1:window.screenfull=!1);Object.defineProperties(screenfull,{isFullscreen:{get:function(){return Boolean(document[fn.fullscreenElement])}},element:{enumerable:!0,get:function(){return document[fn.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return Boolean(document[fn.fullscreenEnabled])}}}),isCommonjs?module.exports=screenfull:window.screenfull=screenfull}(),function($){$.fn.getStyles=function(only,except){var style,name,product={};if(only&&only instanceof Array)for(var i=0,l=only.length;i<l;i++)name=only[i],product[name]=this.css(name);else if(this.length){var dom=this.get(0);if(window.getComputedStyle){var pattern=/\-([a-z])/g,uc=function(a,b){return b.toUpperCase()},camelize=function(string){return string.replace(pattern,uc)};if(style=window.getComputedStyle(dom,null)){var camel,value;if(style.length)for(var i=0,l=style.length;i<l;i++)name=style[i],camel=camelize(name),value=style.getPropertyValue(name),product[camel]=value;else for(name in style)camel=camelize(name),value=style.getPropertyValue(name)||style[name],product[camel]=value}}else if(style=dom.currentStyle)for(name in style)product[name]=style[name];else if(style=dom.style)for(name in style)"function"!=typeof style[name]&&(product[name]=style[name])}if(except&&except instanceof Array)for(var i=0,l=except.length;i<l;i++)name=except[i],delete product[name];return product},$.fn.copyCSS=function(source,only,except){var styles=$(source).getStyles(only,except);return this.css(styles),this}}(jQuery),function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.Recorder=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";module.exports=require("./recorder").Recorder},{"./recorder":2}],2:[function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.Recorder=void 0;var _inlineWorker=require("inline-worker"),_inlineWorker2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(_inlineWorker);function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var Recorder=exports.Recorder=function(){function Recorder(cfg){var _this=this;_classCallCheck(this,Recorder),this.config={bufferLen:4096,numChannels:2,mimeType:"audio/wav"},this.recording=!1,this.callbacks={getBuffer:[],exportWAV:[]},Object.assign(this.config,cfg),this.context=this.config.context,this.node=this.config.processor||(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=function(e){if(_this.recording){for(var buffer=[],channel=0;channel<_this.config.numChannels;channel++)buffer.push(e.inputBuffer.getChannelData(channel));_this.worker.postMessage({command:"record",buffer:buffer})}},this.node.connect(this.context.destination);var self={};this.worker=new _inlineWorker2.default(function(){var recLength=0,recBuffers=[],sampleRate=void 0,numChannels=void 0;self.onmessage=function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"exportWAV":exportWAV(e.data.type);break;case"getBuffer":getBuffer();break;case"clear":clear()}};function init(config){sampleRate=config.sampleRate,numChannels=config.numChannels,initBuffers()}function record(inputBuffer){for(var channel=0;channel<numChannels;channel++)recBuffers[channel].push(inputBuffer[channel]);recLength+=inputBuffer[0].length}function exportWAV(type){for(var buffers=[],channel=0;channel<numChannels;channel++)buffers.push(mergeBuffers(recBuffers[channel],recLength));var interleaved=void 0;interleaved=2===numChannels?interleave(buffers[0],buffers[1]):buffers[0];var dataview=encodeWAV(interleaved),audioBlob=new Blob([dataview],{type:type});self.postMessage({command:"exportWAV",data:audioBlob})}function getBuffer(){for(var buffers=[],channel=0;channel<numChannels;channel++)buffers.push(mergeBuffers(recBuffers[channel],recLength));self.postMessage({command:"getBuffer",data:buffers})}function clear(){recLength=0,recBuffers=[],initBuffers()}function initBuffers(){for(var channel=0;channel<numChannels;channel++)recBuffers[channel]=[]}function mergeBuffers(recBuffers,recLength){for(var result=new Float32Array(recLength),offset=0,i=0;i<recBuffers.length;i++)result.set(recBuffers[i],offset),offset+=recBuffers[i].length;return result}function interleave(inputL,inputR){for(var length=inputL.length+inputR.length,result=new Float32Array(length),index=0,inputIndex=0;index<length;)result[index++]=inputL[inputIndex],result[index++]=inputR[inputIndex],inputIndex++;return result}function floatTo16BitPCM(output,offset,input){for(var i=0;i<input.length;i++,offset+=2){var s=Math.max(-1,Math.min(1,input[i]));output.setInt16(offset,s<0?32768*s:32767*s,!0)}}function writeString(view,offset,string){for(var i=0;i<string.length;i++)view.setUint8(offset+i,string.charCodeAt(i))}function encodeWAV(samples){var buffer=new ArrayBuffer(44+2*samples.length),view=new DataView(buffer);return writeString(view,0,"RIFF"),view.setUint32(4,36+2*samples.length,!0),writeString(view,8,"WAVE"),writeString(view,12,"fmt "),view.setUint32(16,16,!0),view.setUint16(20,1,!0),view.setUint16(22,numChannels,!0),view.setUint32(24,sampleRate,!0),view.setUint32(28,4*sampleRate,!0),view.setUint16(32,2*numChannels,!0),view.setUint16(34,16,!0),writeString(view,36,"data"),view.setUint32(40,2*samples.length,!0),floatTo16BitPCM(view,44,samples),view}},self),this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels}}),this.worker.onmessage=function(e){var cb=_this.callbacks[e.data.command].pop();"function"==typeof cb&&cb(e.data.data)}}return _createClass(Recorder,[{key:"record",value:function(){this.recording=!0}},{key:"stop",value:function(){this.recording=!1}},{key:"clear",value:function(){this.worker.postMessage({command:"clear"})}},{key:"getBuffer",value:function(cb){if(!(cb=cb||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(cb),this.worker.postMessage({command:"getBuffer"})}},{key:"exportWAV",value:function(cb,mimeType){if(mimeType=mimeType||this.config.mimeType,!(cb=cb||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(cb),this.worker.postMessage({command:"exportWAV",type:mimeType})}}],[{key:"forceDownload",value:function(blob,filename){var url=(window.URL||window.webkitURL).createObjectURL(blob),link=window.document.createElement("a");link.href=url,link.download=filename||"output.wav";var click=document.createEvent("Event");click.initEvent("click",!0,!0),link.dispatchEvent(click)}}]),Recorder}();exports.default=Recorder},{"inline-worker":3}],3:[function(require,module,exports){"use strict";module.exports=require("./inline-worker")},{"./inline-worker":4}],4:[function(require,module,exports){(function(global){"use strict";var _createClass=function(){function defineProperties(target,props){for(var key in props){var prop=props[key];prop.configurable=!0,prop.value&&(prop.writable=!0)}Object.defineProperties(target,props)}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},WORKER_ENABLED=!!(global===global.window&&global.URL&&global.Blob&&global.Worker),InlineWorker=function(){function InlineWorker(func,self){var _this=this;if(_classCallCheck(this,InlineWorker),WORKER_ENABLED){var functionBody=func.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],url=global.URL.createObjectURL(new global.Blob([functionBody],{type:"text/javascript"}));return new global.Worker(url)}this.self=self,this.self.postMessage=function(data){setTimeout(function(){_this.onmessage({data:data})},0)},setTimeout(function(){func.call(self)},0)}return _createClass(InlineWorker,{postMessage:{value:function(data){var _this=this;setTimeout(function(){_this.self.onmessage({data:data})},0)}}}),InlineWorker}();module.exports=InlineWorker}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)});var TWEEN=TWEEN||function(){var _tweens=[];return{getAll:function(){return _tweens},removeAll:function(){_tweens=[]},add:function(tween){_tweens.push(tween)},remove:function(tween){var i=_tweens.indexOf(tween);-1!==i&&_tweens.splice(i,1)},update:function(time,preserve){if(0===_tweens.length)return!1;var i=0;for(time=void 0!==time?time:TWEEN.now();i<_tweens.length;)_tweens[i].update(time)||preserve?i++:_tweens.splice(i,1);return!0}}}();"undefined"==typeof window&&"undefined"!=typeof process?TWEEN.now=function(){var time=process.hrtime();return 1e3*time[0]+time[1]/1e6}:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?TWEEN.now=window.performance.now.bind(window.performance):void 0!==Date.now?TWEEN.now=Date.now:TWEEN.now=function(){return(new Date).getTime()},TWEEN.Tween=function(object){var _repeatDelayTime,_object=object,_valuesStart={},_valuesEnd={},_valuesStartRepeat={},_duration=1e3,_repeat=0,_yoyo=!1,_isPlaying=!1,_reversed=!1,_delayTime=0,_startTime=null,_easingFunction=TWEEN.Easing.Linear.None,_interpolationFunction=TWEEN.Interpolation.Linear,_chainedTweens=[],_onStartCallback=null,_onStartCallbackFired=!1,_onUpdateCallback=null,_onCompleteCallback=null,_onStopCallback=null;this.to=function(properties,duration){return _valuesEnd=properties,void 0!==duration&&(_duration=duration),this},this.start=function(time){TWEEN.add(this),_isPlaying=!0,_onStartCallbackFired=!1,_startTime=void 0!==time?time:TWEEN.now(),_startTime+=_delayTime;for(var property in _valuesEnd){if(_valuesEnd[property]instanceof Array){if(0===_valuesEnd[property].length)continue;_valuesEnd[property]=[_object[property]].concat(_valuesEnd[property])}void 0!==_object[property]&&(_valuesStart[property]=_object[property],_valuesStart[property]instanceof Array==!1&&(_valuesStart[property]*=1),_valuesStartRepeat[property]=_valuesStart[property]||0)}return this},this.stop=function(){return _isPlaying?(TWEEN.remove(this),_isPlaying=!1,null!==_onStopCallback&&_onStopCallback.call(_object,_object),this.stopChainedTweens(),this):this},this.end=function(){return this.update(_startTime+_duration),this},this.stopChainedTweens=function(){for(var i=0,numChainedTweens=_chainedTweens.length;i<numChainedTweens;i++)_chainedTweens[i].stop()},this.delay=function(amount){return _delayTime=amount,this},this.repeat=function(times){return _repeat=times,this},this.repeatDelay=function(amount){return _repeatDelayTime=amount,this},this.yoyo=function(yoyo){return _yoyo=yoyo,this},this.easing=function(easing){return _easingFunction=easing,this},this.interpolation=function(interpolation){return _interpolationFunction=interpolation,this},this.chain=function(){return _chainedTweens=arguments,this},this.onStart=function(callback){return _onStartCallback=callback,this},this.onUpdate=function(callback){return _onUpdateCallback=callback,this},this.onComplete=function(callback){return _onCompleteCallback=callback,this},this.onStop=function(callback){return _onStopCallback=callback,this},this.update=function(time){var property,elapsed,value;if(time<_startTime)return!0;!1===_onStartCallbackFired&&(null!==_onStartCallback&&_onStartCallback.call(_object,_object),_onStartCallbackFired=!0),elapsed=(time-_startTime)/_duration,elapsed=elapsed>1?1:elapsed,value=_easingFunction(elapsed);for(property in _valuesEnd)if(void 0!==_valuesStart[property]){var start=_valuesStart[property]||0,end=_valuesEnd[property];end instanceof Array?_object[property]=_interpolationFunction(end,value):("string"==typeof end&&(end="+"===end.charAt(0)||"-"===end.charAt(0)?start+parseFloat(end):parseFloat(end)),"number"==typeof end&&(_object[property]=start+(end-start)*value))}if(null!==_onUpdateCallback&&_onUpdateCallback.call(_object,value),1===elapsed){if(_repeat>0){isFinite(_repeat)&&_repeat--;for(property in _valuesStartRepeat){if("string"==typeof _valuesEnd[property]&&(_valuesStartRepeat[property]=_valuesStartRepeat[property]+parseFloat(_valuesEnd[property])),_yoyo){var tmp=_valuesStartRepeat[property];_valuesStartRepeat[property]=_valuesEnd[property],_valuesEnd[property]=tmp}_valuesStart[property]=_valuesStartRepeat[property]}return _yoyo&&(_reversed=!_reversed),_startTime=void 0!==_repeatDelayTime?time+_repeatDelayTime:time+_delayTime,!0}null!==_onCompleteCallback&&_onCompleteCallback.call(_object,_object);for(var i=0,numChainedTweens=_chainedTweens.length;i<numChainedTweens;i++)_chainedTweens[i].start(_startTime+_duration);return!1}return!0}},TWEEN.Easing={Linear:{None:function(k){return k}},Quadratic:{In:function(k){return k*k},Out:function(k){return k*(2-k)},InOut:function(k){return(k*=2)<1?.5*k*k:-.5*(--k*(k-2)-1)}},Cubic:{In:function(k){return k*k*k},Out:function(k){return--k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k:.5*((k-=2)*k*k+2)}},Quartic:{In:function(k){return k*k*k*k},Out:function(k){return 1- --k*k*k*k},InOut:function(k){return(k*=2)<1?.5*k*k*k*k:-.5*((k-=2)*k*k*k-2)}},Quintic:{In:function(k){return k*k*k*k*k},Out:function(k){return--k*k*k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k*k*k:.5*((k-=2)*k*k*k*k+2)}},Sinusoidal:{In:function(k){return 1-Math.cos(k*Math.PI/2)},Out:function(k){return Math.sin(k*Math.PI/2)},InOut:function(k){return.5*(1-Math.cos(Math.PI*k))}},Exponential:{In:function(k){return 0===k?0:Math.pow(1024,k-1)},Out:function(k){return 1===k?1:1-Math.pow(2,-10*k)},InOut:function(k){return 0===k?0:1===k?1:(k*=2)<1?.5*Math.pow(1024,k-1):.5*(2-Math.pow(2,-10*(k-1)))}},Circular:{In:function(k){return 1-Math.sqrt(1-k*k)},Out:function(k){return Math.sqrt(1- --k*k)},InOut:function(k){return(k*=2)<1?-.5*(Math.sqrt(1-k*k)-1):.5*(Math.sqrt(1-(k-=2)*k)+1)}},Elastic:{In:function(k){return 0===k?0:1===k?1:-Math.pow(2,10*(k-1))*Math.sin(5*(k-1.1)*Math.PI)},Out:function(k){return 0===k?0:1===k?1:Math.pow(2,-10*k)*Math.sin(5*(k-.1)*Math.PI)+1},InOut:function(k){return 0===k?0:1===k?1:(k*=2,k<1?-.5*Math.pow(2,10*(k-1))*Math.sin(5*(k-1.1)*Math.PI):.5*Math.pow(2,-10*(k-1))*Math.sin(5*(k-1.1)*Math.PI)+1)}},Back:{In:function(k){var s=1.70158;return k*k*((s+1)*k-s)},Out:function(k){var s=1.70158;return--k*k*((s+1)*k+s)+1},InOut:function(k){var s=2.5949095;return(k*=2)<1?k*k*((s+1)*k-s)*.5:.5*((k-=2)*k*((s+1)*k+s)+2)}},Bounce:{In:function(k){return 1-TWEEN.Easing.Bounce.Out(1-k)},Out:function(k){return k<1/2.75?7.5625*k*k:k<2/2.75?7.5625*(k-=1.5/2.75)*k+.75:k<2.5/2.75?7.5625*(k-=2.25/2.75)*k+.9375:7.5625*(k-=2.625/2.75)*k+.984375},InOut:function(k){return k<.5?.5*TWEEN.Easing.Bounce.In(2*k):.5*TWEEN.Easing.Bounce.Out(2*k-1)+.5}}},TWEEN.Interpolation={Linear:function(v,k){var m=v.length-1,f=m*k,i=Math.floor(f),fn=TWEEN.Interpolation.Utils.Linear;return k<0?fn(v[0],v[1],f):k>1?fn(v[m],v[m-1],m-f):fn(v[i],v[i+1>m?m:i+1],f-i)},Bezier:function(v,k){for(var b=0,n=v.length-1,pw=Math.pow,bn=TWEEN.Interpolation.Utils.Bernstein,i=0;i<=n;i++)b+=pw(1-k,n-i)*pw(k,i)*v[i]*bn(n,i);return b},CatmullRom:function(v,k){var m=v.length-1,f=m*k,i=Math.floor(f),fn=TWEEN.Interpolation.Utils.CatmullRom;return v[0]===v[m]?(k<0&&(i=Math.floor(f=m*(1+k))),fn(v[(i-1+m)%m],v[i],v[(i+1)%m],v[(i+2)%m],f-i)):k<0?v[0]-(fn(v[0],v[0],v[1],v[1],-f)-v[0]):k>1?v[m]-(fn(v[m],v[m],v[m-1],v[m-1],f-m)-v[m]):fn(v[i?i-1:0],v[i],v[m<i+1?m:i+1],v[m<i+2?m:i+2],f-i)},Utils:{Linear:function(p0,p1,t){return(p1-p0)*t+p0},Bernstein:function(n,i){var fc=TWEEN.Interpolation.Utils.Factorial;return fc(n)/fc(i)/fc(n-i)},Factorial:function(){var a=[1];return function(n){var s=1;if(a[n])return a[n];for(var i=n;i>1;i--)s*=i;return a[n]=s,s}}(),CatmullRom:function(p0,p1,p2,p3,t){var v0=.5*(p2-p0),v1=.5*(p3-p1),t2=t*t;return(2*p1-2*p2+v0+v1)*(t*t2)+(-3*p1+3*p2-2*v0-v1)*t2+v0*t+p1}}},function(root){"function"==typeof define&&define.amd?define([],function(){return TWEEN}):"undefined"!=typeof module&&"object"==typeof exports?module.exports=TWEEN:void 0!==root&&(root.TWEEN=TWEEN)}(this);var isRenderGGBElementEnabled=!1,scriptLoadStarted=!1,html5AppletsToProcess=null,ggbHTML5LoadedCodebaseIsWebSimple=!1,ggbHTML5LoadedCodebaseVersion=null,ggbHTML5LoadedScript=null,GGBApplet=function(){"use strict";for(var applet={},ggbVersion="5.0",parameters={},views=null,html5NoWebSimple=!1,html5NoWebSimpleParamExists=!1,appletID=null,initComplete=!1,html5OverwrittenCodebaseVersion=null,html5OverwrittenCodebase=null,i=0;i<arguments.length;i++){var p=arguments[i];if(null!==p)switch(typeof p){case"number":ggbVersion=p.toFixed(1);break;case"string":p.match(new RegExp("^[0-9]\\.[0-9]+$"))?ggbVersion=p:appletID=p;break;case"object":void 0!==p.is3D?views=p:parameters=p;break;case"boolean":html5NoWebSimple=p,html5NoWebSimpleParamExists=!0}}null===views&&(views={is3D:!1,AV:!1,SV:!1,CV:!1,EV2:!1,CP:!1,PC:!1,DA:!1,FI:!1,PV:!1,macro:!1},void 0===parameters.material_id||html5NoWebSimpleParamExists||(html5NoWebSimple=!0)),null!==appletID&&void 0===parameters.id&&(parameters.id=appletID);var jnlpFilePath="",html5Codebase="",isHTML5Offline=!1,loadedAppletType=null,html5CodebaseVersion=null,html5CodebaseScript=null,html5CodebaseIsWebSimple=!1,previewImagePath=null,previewLoadingPath=null,previewPlayPath=null,fonts_css_url=null;void 0!==parameters.height&&(parameters.height=Math.round(parameters.height)),void 0!==parameters.width&&(parameters.width=Math.round(parameters.width));var parseVersion=function(d){return parseFloat(d)>4?parseFloat(d):5};applet.setHTML5Codebase=function(codebase,offline){html5OverwrittenCodebase=codebase,setHTML5CodebaseInternal(codebase,offline)},applet.setJavaCodebase=applet.setJavaCodebaseVersion=applet.isCompiledInstalled=applet.setPreCompiledScriptPath=applet.setPreCompiledResourcePath=function(){},applet.setHTML5CodebaseVersion=function(version,offline){var numVersion=parseFloat(version);if(NaN!==numVersion&&numVersion<5)return void console.log("The GeoGebra HTML5 codebase version "+numVersion+" is deprecated. Using version latest instead.");html5OverwrittenCodebaseVersion=version,setDefaultHTML5CodebaseForVersion(version,offline)},applet.getHTML5CodebaseVersion=function(){return html5CodebaseVersion},applet.getParameters=function(){return parameters},applet.setFontsCSSURL=function(url){fonts_css_url=url},applet.setGiacJSURL=function(url){},applet.setJNLPFile=function(newJnlpFilePath){jnlpFilePath=newJnlpFilePath},applet.setJNLPBaseDir=function(baseDir){},applet.inject=function(){function isOwnIFrame(){return window.frameElement&&window.frameElement.getAttribute("data-singleton")}for(var container,type="auto",container_ID=parameters.id,noPreview=!1,i=0;i<arguments.length;i++){var p=arguments[i];"string"==typeof p?(p=p.toLowerCase(),p.match(/^(prefer)?(java|html5|compiled|auto|screenshot)$/)?type=p:container_ID=arguments[i]):"boolean"==typeof p?noPreview=p:p instanceof HTMLElement&&(container=p)}continueInject();function continueInject(){if(!initComplete)return void setTimeout(continueInject,200);type=detectAppletType(type);var appletElem=container||document.getElementById(container_ID);if(!appletElem)return void console.log("possibly bug on ajax loading? ");if(applet.removeExistingApplet(appletElem,!1),void 0===parameters.width&&appletElem.clientWidth&&(parameters.width=appletElem.clientWidth),void 0===parameters.height&&appletElem.clientHeight&&(parameters.height=appletElem.clientHeight),parameters.width&&parameters.height||"html5"!==type||(delete parameters.width,delete parameters.height),loadedAppletType=type,"screenshot"===type)injectScreenshot(appletElem,parameters);else{var playButton=!1
;parameters.hasOwnProperty("playButton")&&parameters.playButton||parameters.hasOwnProperty("clickToLoad")&&parameters.clickToLoad?playButton=!0:parameters.hasOwnProperty("playButtonAutoDecide")&&parameters.playButtonAutoDecide&&(playButton=(!isInIframe()||isOwnIFrame())&&isMobileDevice()),playButton?(loadedAppletType="screenshot",injectPlayButton(appletElem,parameters,noPreview,type)):injectHTML5Applet(appletElem,parameters,noPreview)}}};function isInIframe(){try{return window.self!==window.top}catch(e){return!0}}function isMobileDevice(){return(!parameters.hasOwnProperty("screenshotGenerator")||!parameters.screenshotGenerator)&&Math.max(screen.width,screen.height)<800}applet.getViews=function(){return views},applet.isJavaInstalled=function(){return!1};var getTubeURL=function(){return void 0!==parameters.tubeurl?parameters.tubeurl:window.location.host.indexOf("www.geogebra.org")>-1||window.location.host.indexOf("alpha.geogebra.org")>-1||window.location.host.indexOf("groot.geogebra.org")>-1||window.location.host.indexOf("beta.geogebra.org")>-1||window.location.host.indexOf("stage.geogebra.org")>-1?window.location.protocol+"//"+window.location.host:"https://www.geogebra.org"};function createCORSRequest(method,url){var xhr=new XMLHttpRequest;return"withCredentials"in xhr?xhr.open(method,url,!0):"undefined"!=typeof XDomainRequest?(xhr=new XDomainRequest,xhr.open(method,url)):xhr=null,xhr}applet.isHTML5Installed=function(){if(isInternetExplorer()){if((views.is3D||"web3d.nocache.js"===html5CodebaseScript)&&getIEVersion()<11)return!1;if(getIEVersion()<10)return!1}return!0},applet.getLoadedAppletType=function(){return loadedAppletType},applet.setPreviewImage=function(previewFilePath,loadingFilePath,playFilePath){previewImagePath=previewFilePath,previewLoadingPath=loadingFilePath,previewPlayPath=playFilePath},applet.removeExistingApplet=function(appletParent,showScreenshot){var i;for("string"==typeof appletParent&&(appletParent=document.getElementById(appletParent)),loadedAppletType=null,i=0;i<appletParent.childNodes.length;i++){var tag=appletParent.childNodes[i].tagName,className=appletParent.childNodes[i].className;"applet_screenshot"===appletParent.childNodes[i].className?showScreenshot?(appletParent.childNodes[i].style.display="block",loadedAppletType="screenshot"):appletParent.childNodes[i].style.display="none":"APPLET"!==tag&&"ARTICLE"!==tag&&"DIV"!==tag||"applet_scaler prerender"===className||(appletParent.removeChild(appletParent.childNodes[i]),i--)}var appName=void 0!==parameters.id?parameters.id:"ggbApplet",app=window[appName];app&&"object"==typeof app&&"function"==typeof app.getBase64&&(app.remove(),window[appName]=null)},applet.refreshHitPoints=function(){if(parseVersion(ggbHTML5LoadedCodebaseVersion)>=5)return!0;var app=applet.getAppletObject();return!(!app||"function"!=typeof app.recalculateEnvironments)&&(app.recalculateEnvironments(),!0)},applet.startAnimation=function(){var app=applet.getAppletObject();return!(!app||"function"!=typeof app.startAnimation)&&(app.startAnimation(),!0)},applet.stopAnimation=function(){var app=applet.getAppletObject();return!(!app||"function"!=typeof app.stopAnimation)&&(app.stopAnimation(),!0)},applet.getAppletObject=function(){var appName=void 0!==parameters.id?parameters.id:"ggbApplet";return window[appName]},applet.resize=function(){};var valBoolean=function(value){return value&&"false"!==value},injectHTML5Applet=function(appletElem,parameters,noPreview){parseVersion(html5CodebaseVersion)<=4.2&&(noPreview=!0);var loadScript=!isRenderGGBElementEnabled&&!scriptLoadStarted;(!isRenderGGBElementEnabled&&!scriptLoadStarted||ggbHTML5LoadedCodebaseVersion!==html5CodebaseVersion||ggbHTML5LoadedCodebaseIsWebSimple&&!html5CodebaseIsWebSimple)&&(loadScript=!0,isRenderGGBElementEnabled=!1,scriptLoadStarted=!1);var article=document.createElement("article"),oriWidth=parameters.width,oriHeight=parameters.height;if(parameters.disableAutoScale=void 0===parameters.disableAutoScale?GGBAppletUtils.isFlexibleWorksheetEditor():parameters.disableAutoScale,void 0!==parameters.width)if(parseVersion(html5CodebaseVersion)<=4.4)valBoolean(parameters.showToolBar)&&(parameters.height-=7),valBoolean(parameters.showAlgebraInput)&&(parameters.height-=37),parameters.width<605&&valBoolean(parameters.showToolBar)&&(parameters.width=605,oriWidth=605);else{var minWidth=100;(valBoolean(parameters.showToolBar)||valBoolean(parameters.showMenuBar))&&(parameters.hasOwnProperty("customToolBar")&&(parameters.customToolbar=parameters.customToolBar),minWidth=valBoolean(parameters.showMenuBar)?245:155),oriWidth<minWidth&&(parameters.width=minWidth,oriWidth=minWidth)}article.className="notranslate",article.style.border="none",article.style.display="inline-block";for(var key in parameters)parameters.hasOwnProperty(key)&&"appletOnLoad"!==key&&article.setAttribute("data-param-"+key,parameters[key]);if(fonts_css_url&&article.setAttribute("data-param-fontscssurl",fonts_css_url),applet.resize=function(){GGBAppletUtils.responsiveResize(appletElem,parameters)},"function"==typeof jQuery)jQuery(window).resize(function(){applet.resize()});else{var oldOnResize=null;void 0!==window.onresize&&"function"==typeof window.onresize&&(oldOnResize=window.onresize),window.onresize=function(){applet.resize(),"function"==typeof oldOnResize&&oldOnResize()}}var oriAppletOnload="function"==typeof parameters.appletOnLoad?parameters.appletOnLoad:function(){};if(noPreview||void 0===parameters.width){var appletScaler=document.createElement("div");appletScaler.className="applet_scaler",appletScaler.style.position="relative",appletScaler.style.display="block",appletScaler.appendChild(article),appletElem.appendChild(appletScaler),parameters.appletOnLoad=function(api){applet.resize(),oriAppletOnload(api)}}else{parameters.hasOwnProperty("showSplash")||article.setAttribute("data-param-showSplash","false");var previewPositioner=appletElem.querySelector(".applet_scaler.prerender"),preRendered=null!==previewPositioner;if(preRendered)var previewContainer=previewPositioner.querySelector(".ggb_preview");else{var previewContainer=createScreenShotDiv(oriWidth,oriHeight,parameters.borderColor,!1);previewPositioner=document.createElement("div"),previewPositioner.className="applet_scaler",previewPositioner.style.position="relative",previewPositioner.style.display="block",previewPositioner.style.width=oriWidth+"px",previewPositioner.style.height=oriHeight+"px"}window.GGBT_spinner&&window.GGBT_spinner.attachSpinner(previewPositioner,"66%"),parseVersion(html5CodebaseVersion)>=5?(parameters.appletOnLoad=function(api){var preview=appletElem.querySelector(".ggb_preview");preview&&preview.parentNode.removeChild(preview),window.GGBT_spinner&&window.GGBT_spinner.removeSpinner(previewPositioner),window.GGBT_wsf_view?$(window).trigger("resize"):window.onresize(),oriAppletOnload(api)},preRendered||previewPositioner.appendChild(previewContainer)):article.appendChild(previewContainer),previewPositioner.appendChild(article),preRendered||appletElem.appendChild(previewPositioner),setTimeout(function(){applet.resize()},1)}function renderGGBElementWithParams(article,parameters){parameters&&"function"==typeof parameters.appletOnLoad&&"function"==typeof renderGGBElement?renderGGBElement(article,parameters.appletOnLoad):renderGGBElement(article),log("GeoGebra HTML5 applet injected and rendered with previously loaded codebase.",parameters)}function renderGGBElementOnTube(a,parameters){"undefined"==typeof renderGGBElement?(null===html5AppletsToProcess&&(html5AppletsToProcess=[]),html5AppletsToProcess.push({article:a,params:parameters}),window.renderGGBElementReady=function(){isRenderGGBElementEnabled=!0,null!==html5AppletsToProcess&&html5AppletsToProcess.length&&(html5AppletsToProcess.forEach(function(obj){renderGGBElementWithParams(obj.article,obj.params)}),html5AppletsToProcess=null)},parseVersion(html5CodebaseVersion)<5&&(a.className+=" geogebraweb")):renderGGBElementWithParams(a,parameters)}if(loadScript){scriptLoadStarted=!0;for(var i=0;i<article.childNodes.length;i++){"TABLE"===article.childNodes[i].tagName&&(article.removeChild(article.childNodes[i]),i--)}if(null!==ggbHTML5LoadedScript){var el=document.querySelector('script[src="'+ggbHTML5LoadedScript+'"]');void 0!==el&&null!==el&&el.parentNode.removeChild(el)}var script=document.createElement("script"),scriptLoaded=function(){renderGGBElementOnTube(article,parameters)};script.src=html5Codebase+html5CodebaseScript,ggbHTML5LoadedCodebaseIsWebSimple=html5CodebaseIsWebSimple,ggbHTML5LoadedCodebaseVersion=html5CodebaseVersion,ggbHTML5LoadedScript=script.src,log("GeoGebra HTML5 codebase loaded: '"+html5Codebase+"'.",parameters),html5OverwrittenCodebase||html5OverwrittenCodebaseVersion&&"5.0"!=html5OverwrittenCodebaseVersion?html5Codebase.requirejs?require(["geogebra/runtime/js/web3d/web3d.nocache"],scriptLoaded):(script.onload=scriptLoaded,appletElem.appendChild(script)):(html5CodebaseIsWebSimple?webSimple.succeeded=webSimple.succeeded||webSimple():web3d.succeeded=web3d.succeeded||web3d(),scriptLoaded())}else renderGGBElementOnTube(article,parameters);parameters.height=oriHeight,parameters.width=oriWidth},injectScreenshot=function(appletElem,parameters,showPlayButton){var previewContainer=createScreenShotDiv(parameters.width,parameters.height,parameters.borderColor,showPlayButton),previewPositioner=document.createElement("div");previewPositioner.style.position="relative",previewPositioner.style.display="block",previewPositioner.style.width=parameters.width+"px",previewPositioner.style.height=parameters.height+"px",previewPositioner.className="applet_screenshot applet_scaler"+(showPlayButton?" applet_screenshot_play":""),previewPositioner.appendChild(previewContainer);var scale=GGBAppletUtils.getScale(parameters,appletElem,showPlayButton);if(showPlayButton?(appletElem.appendChild(getPlayButton()),window.GGBT_wsf_view||(appletElem.style.position="relative")):window.GGBT_spinner&&window.GGBT_spinner.attachSpinner(previewPositioner,"66%"),appletElem.appendChild(previewPositioner),1===scale||isNaN(scale)||(GGBAppletUtils.scaleElement(previewPositioner,scale),previewPositioner.style.width=parameters.width+"px",previewPositioner.style.height=parameters.height+"px",previewPositioner.parentNode.style.width=parameters.width*scale+"px",previewPositioner.parentNode.style.height=parameters.height*scale+"px"),applet.resize=function(){resizeScreenshot(appletElem,previewContainer,previewPositioner,showPlayButton)},"function"==typeof jQuery)jQuery(window).resize(function(){applet.resize()});else{var oldOnResize=null;void 0!==window.onresize&&"function"==typeof window.onresize&&(oldOnResize=window.onresize),window.onresize=function(){applet.resize(),"function"==typeof oldOnResize&&oldOnResize()}}applet.resize()};function resizeScreenshot(appletElem,previewContainer,previewPositioner,showPlayButton,oldOnResize){if(appletElem.contains(previewContainer)){if("object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()){if("fullscreencontent"!==appletElem.id)return;window.GGBT_wsf_view.setCloseBtnPosition(appletElem)}var scale=GGBAppletUtils.getScale(parameters,appletElem,showPlayButton);null!==previewPositioner.parentNode&&(isNaN(scale)||1===scale?(GGBAppletUtils.scaleElement(previewPositioner,1),previewPositioner.parentNode.style.width=parameters.width+"px",previewPositioner.parentNode.style.height=parameters.height+"px"):(GGBAppletUtils.scaleElement(previewPositioner,scale),previewPositioner.parentNode.style.width=parameters.width*scale+"px",previewPositioner.parentNode.style.height=parameters.height*scale+"px")),"object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()&&GGBAppletUtils.positionCenter(appletElem),"object"==typeof window.GGBT_ws_header_footer&&window.GGBT_ws_header_footer.setWsScrollerHeight(),"function"==typeof oldOnResize&&oldOnResize()}}applet.onExitFullscreen=function(fullscreenContainer,appletElem){appletElem.appendChild(fullscreenContainer)};var injectPlayButton=function(appletElem,parameters,noPreview,type){injectScreenshot(appletElem,parameters,!0);for(var play=function(){var elems=[];for(i=0;i<appletElem.childNodes.length;i++)elems.push(appletElem.childNodes[i]);if(window.GGBT_wsf_view){var content=window.GGBT_wsf_view.renderFullScreen(appletElem,parameters.id),container=document.getElementById("fullscreencontainer"),oldcontent=jQuery(appletElem).find(".fullscreencontent");oldcontent.length>0?(content.remove(),oldcontent.attr("id","fullscreencontent").show(),jQuery(container).append(oldcontent),window.onresize()):injectHTML5Applet(content,parameters,!1),window.GGBT_wsf_view.launchFullScreen(container)}else loadedAppletType=type,injectHTML5Applet(appletElem,parameters,!1);if(!window.GGBT_wsf_view)for(i=0;i<elems.length;i++)appletElem.removeChild(elems[i])},imgs=appletElem.getElementsByClassName("ggb_preview_play"),i=0;i<imgs.length;i++)imgs[i].addEventListener("click",play,!1),imgs[i].addEventListener("ontouchstart",play,!1);"function"==typeof window.ggbAppletPlayerOnload&&window.ggbAppletPlayerOnload(appletElem),isMobileDevice()&&window.GGBT_wsf_view&&$(".wsf-element-fullscreen-button").remove()},getPlayButton=function(){var playButtonContainer=document.createElement("div");if(playButtonContainer.className="ggb_preview_play icon-applet-play",!window.GGBT_wsf_view){var css='.icon-applet-play {   width: 100%;   height: 100%;box-sizing: border-box;position: absolute;z-index: 1001;cursor: pointer;border-width: 0px;   background-color: transparent;background-repeat: no-repeat;left: 0;top: 0;background-position: center center;   background-image: url("'+getTubeURL()+'/images/worksheet/icon-start-applet.png");}.icon-applet-play:hover {background-image: url("'+getTubeURL()+'/images/worksheet/icon-start-applet-hover.png");}',style=document.createElement("style");style.styleSheet?style.styleSheet.cssText=css:style.appendChild(document.createTextNode(css)),document.getElementsByTagName("head")[0].appendChild(style)}return playButtonContainer},createScreenShotDiv=function(oriWidth,oriHeight,borderColor,showPlayButton){var previewContainer=document.createElement("div");previewContainer.className="ggb_preview",previewContainer.style.position="absolute",previewContainer.style.zIndex="90",previewContainer.style.width=oriWidth-2+"px",previewContainer.style.height=oriHeight-2+"px",previewContainer.style.top="0px",previewContainer.style.left="0px",previewContainer.style.overflow="hidden",previewContainer.style.backgroundColor="white";var bc="lightgrey";void 0!==borderColor&&(bc="none"===borderColor?"transparent":borderColor),previewContainer.style.border="1px solid "+bc;var preview=document.createElement("img");if(preview.style.position="relative",preview.style.zIndex="1000",preview.style.top="-1px",preview.style.left="-1px",null!==previewImagePath&&preview.setAttribute("src",previewImagePath),preview.style.opacity=.7,null!==previewLoadingPath){var previewOverlay,pWidth,pHeight;if(!showPlayButton){previewOverlay=document.createElement("img"),previewOverlay.style.position="absolute",previewOverlay.style.zIndex="1001",previewOverlay.style.opacity=1,preview.style.opacity=.3,pWidth=360,pWidth>oriWidth/4*3&&(pWidth=oriWidth/4*3),pHeight=pWidth/5.8,previewOverlay.setAttribute("src",previewLoadingPath),previewOverlay.setAttribute("width",pWidth),previewOverlay.setAttribute("height",pHeight);var pX=(oriWidth-pWidth)/2,pY=(oriHeight-pHeight)/2;previewOverlay.style.left=pX+"px",previewOverlay.style.top=pY+"px",previewContainer.appendChild(previewOverlay)}}return previewContainer.appendChild(preview),previewContainer},detectAppletType=function(preferredType){return preferredType=preferredType.toLowerCase(),"html5"===preferredType||"screenshot"===preferredType?preferredType:"html5"},getIEVersion=function(){var a=navigator.appVersion;return a.indexOf("Trident/7.0")>0?11:a.indexOf("MSIE")+1?parseFloat(a.split("MSIE")[1]):999},isInternetExplorer=function(){return 999!==getIEVersion()},modules=["web","webSimple","web3d","tablet","tablet3d","phone"],setDefaultHTML5CodebaseForVersion=function(version,offline){if(html5CodebaseVersion=version,offline)return void setHTML5CodebaseInternal(html5CodebaseVersion,!0);var hasWebSimple=!html5NoWebSimple;if(hasWebSimple){var v=parseVersion(html5CodebaseVersion);!isNaN(v)&&v<4.4&&(hasWebSimple=!1)}var protocol,codebase;protocol="http"===window.location.protocol.substr(0,4)?window.location.protocol:"http:";var index=html5CodebaseVersion.indexOf("//");codebase=index>0?html5CodebaseVersion:0===index?protocol+html5CodebaseVersion:"https://cdn.geogebra.org/apps/latest/";for(var key in modules)if(html5CodebaseVersion.slice(-1*modules[key].length)===modules[key]||html5CodebaseVersion.slice(-1*(modules[key].length+1))===modules[key]+"/")return void setHTML5CodebaseInternal(codebase,!1);GGBAppletUtils.isFlexibleWorksheetEditor()||!hasWebSimple||views.is3D||views.AV||views.SV||views.CV||views.EV2||views.CP||views.PC||views.DA||views.FI||views.PV||valBoolean(parameters.showToolBar)||valBoolean(parameters.showMenuBar)||valBoolean(parameters.showAlgebraInput)||valBoolean(parameters.enableRightClick)||parameters.appName&&"classic"!=parameters.appName?codebase+="web3d/":codebase+="webSimple/",setHTML5CodebaseInternal(codebase,!1)},setHTML5CodebaseInternal=function(codebase,offline){if(codebase.requirejs)return void(html5Codebase=codebase);"/"!==codebase.slice(-1)&&(codebase+="/"),html5Codebase=codebase,null===offline&&(offline=-1===codebase.indexOf("http")),isHTML5Offline=offline,html5CodebaseScript="web.nocache.js",html5CodebaseIsWebSimple=!1;var folders=html5Codebase.split("/");folders.length>1&&(offline||"webSimple"!==folders[folders.length-2]?modules.indexOf(folders[folders.length-2])>=0&&(html5CodebaseScript=folders[folders.length-2]+".nocache.js"):(html5CodebaseScript="webSimple.nocache.js",html5CodebaseIsWebSimple=!0)),folders=codebase.split("/"),html5CodebaseVersion=folders[folders.length-3],"test"===html5CodebaseVersion.substr(0,4)?html5CodebaseVersion=html5CodebaseVersion.substr(4,1)+"."+html5CodebaseVersion.substr(5,1):"war"!==html5CodebaseVersion.substr(0,3)&&"beta"!==html5CodebaseVersion.substr(0,4)||(html5CodebaseVersion="5.0");var numVersion=parseFloat(html5CodebaseVersion);NaN!==numVersion&&numVersion<5&&(console.log("The GeoGebra HTML5 codebase version "+numVersion+" is deprecated. Using version latest instead."),setDefaultHTML5CodebaseForVersion("5.0",offline))},log=function(text,parameters){window.console&&window.console.log&&(!parameters||void 0===parameters.showLogging||parameters.showLogging&&"false"!==parameters.showLogging)&&console.log(text)};void 0!==parameters.material_id?function(successCallback,materialsApiURL){var tubeurl=materialsApiURL?materialsApiURL.substring(0,materialsApiURL.indexOf("/",8)):getTubeURL(),api_request={request:{"-api":"1.0.0",login:{"-type":"cookie","-getuserinfo":"false"},task:{"-type":"fetch",fields:{field:[{"-name":"id"},{"-name":"geogebra_format"},{"-name":"width"},{"-name":"height"},{"-name":"toolbar"},{"-name":"menubar"},{"-name":"inputbar"},{"-name":"stylebar"},{"-name":"reseticon"},{"-name":"labeldrags"},{"-name":"shiftdragzoom"},{"-name":"rightclick"},{"-name":"ggbbase64"},{"-name":"preview_url"},{"-name":"appname"}]},filters:{field:[{"-name":"id","#text":""+parameters.material_id}]},order:{"-by":"id","-type":"asc"},limit:{"-num":"1"}}}},success=function(){var text=xhr.responseText,jsondata=JSON.parse(text),item=null;for(i=0;jsondata.responses&&i<jsondata.responses.response.length;i++)void 0!==jsondata.responses.response[i].item&&(item=jsondata.responses.response[i].item);if(null===item)return void onError();""!==item.geogebra_format&&(ggbVersion=item.geogebra_format),void 0===parameters.ggbBase64&&(parameters.ggbBase64=item.ggbBase64),void 0===parameters.width&&(parameters.width=item.width),void 0===parameters.height&&(parameters.height=item.height),void 0===parameters.showToolBar&&(parameters.showToolBar="true"===item.toolbar),void 0===parameters.showMenuBar&&(parameters.showMenuBar="true"===item.menubar),void 0===parameters.showAlgebraInput&&(parameters.showAlgebraInput="true"===item.inputbar),void 0===parameters.allowStyleBar&&(parameters.allowStyleBar="true"===item.stylebar),void 0===parameters.showResetIcon&&(parameters.showResetIcon="true"===item.reseticon),void 0===parameters.enableLabelDrags&&(parameters.enableLabelDrags="true"===item.labeldrags),void 0===parameters.enableShiftDragZoom&&(parameters.enableShiftDragZoom="true"===item.shiftdragzoom),void 0===parameters.enableRightClick&&(parameters.enableRightClick="true"===item.rightclick),void 0===parameters.showToolBarHelp&&(parameters.showToolBarHelp=parameters.showToolBar),void 0===parameters.appname&&(parameters.appname=item.appname),parseFloat(item.geogebra_format)>=5&&(views.is3D=!0);var previewUrl=void 0===item.previewUrl?tubeurl+"/files/material-"+item.id+".png":item.previewUrl;applet.setPreviewImage(previewImagePath||previewUrl,tubeurl+"/images/GeoGebra_loading.png",tubeurl+"/images/applet_play.png"),successCallback()},url=tubeurl+"/api/json.php",xhr=createCORSRequest("POST",url),onError=function(){parameters.onError&&parameters.onError(),log("Error: The request for fetching material_id "+parameters.material_id+" from tube was not successful.")};if(!xhr)return void onError();xhr.onload=success,xhr.onerror=onError,xhr.onprogress=function(){},xhr.setRequestHeader&&xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),xhr.send(JSON.stringify(api_request))}(continueInit,parameters.materialsApi):continueInit();function continueInit(){var html5Version=ggbVersion;null!==html5OverwrittenCodebaseVersion?html5Version=html5OverwrittenCodebaseVersion:parseFloat(html5Version)<5&&(html5Version="5.0"),setDefaultHTML5CodebaseForVersion(html5Version,!1),null!==html5OverwrittenCodebase&&setHTML5CodebaseInternal(html5OverwrittenCodebase,isHTML5Offline),initComplete=!0}return applet},GGBAppletUtils=function(){"use strict";function isFlexibleWorksheetEditor(){return void 0!==window.GGBT_wsf_edit}function scaleElement(el,scale){1!=scale?(el.style.transformOrigin="0% 0% 0px",el.style.webkitTransformOrigin="0% 0% 0px",el.style.transform="scale("+scale+","+scale+")",el.style.webkitTransform="scale("+scale+","+scale+")",el.style.maxWidth="initial",null!==el.querySelector(".ggb_preview")&&(el.querySelector(".ggb_preview").style.maxWidth="initial"),void 0!==el.querySelectorAll(".ggb_preview img")[0]&&(el.querySelectorAll(".ggb_preview img")[0].style.maxWidth="initial"),void 0!==el.querySelectorAll(".ggb_preview img")[1]&&(el.querySelectorAll(".ggb_preview img")[1].style.maxWidth="initial")):(el.style.transform="none",el.style.webkitTransform="none")}function getWidthHeight(appletElem,appletWidth,allowUpscale,autoHeight,noBorder,scaleContainerClass){var container=null;if(void 0!=scaleContainerClass&&""!=scaleContainerClass)for(var parent=appletElem.parentNode;null!=parent;){if((" "+parent.className+" ").indexOf(" "+scaleContainerClass+" ")>-1){container=parent;break}parent=parent.parentNode}var myWidth=0,myHeight=0,windowWidth=0,border=0,borderRight=0,borderLeft=0,borderTop=0;if(container)myWidth=container.offsetWidth,myHeight=Math.max(autoHeight?container.offsetWidth:0,container.offsetHeight);else{if(window.innerWidth&&document.documentElement.clientWidth?(myWidth=Math.min(window.innerWidth,document.documentElement.clientWidth),myHeight=Math.min(window.innerHeight,document.documentElement.clientHeight),windowWidth=myWidth):"number"==typeof window.innerWidth?(myWidth=window.innerWidth,myHeight=window.innerHeight,windowWidth=window.innerWidth):document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)?(myWidth=document.documentElement.clientWidth,myHeight=document.documentElement.clientHeight,windowWidth=document.documentElement.clientWidth):document.body&&(document.body.clientWidth||document.body.clientHeight)&&(myWidth=document.body.clientWidth,myHeight=document.body.clientHeight,windowWidth=document.documentElement.clientWidth),appletElem){var rect=appletElem.getBoundingClientRect();rect.left>0&&rect.left<=myWidth&&(void 0===noBorder||!noBorder)&&("rtl"===document.dir?(borderRight=myWidth-rect.width-rect.left,borderLeft=windowWidth<=480?10:30):(borderLeft=rect.left,borderRight=windowWidth<=480?10:30),border=borderLeft+borderRight)}if(appletElem&&"object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()){appletElem.getBoundingClientRect();"closePositionRight"===window.GGBT_wsf_view.getCloseBtnPosition()?(border=40,borderTop=0):"closePositionTop"===window.GGBT_wsf_view.getCloseBtnPosition()&&(border=0,borderTop=40)}}return appletElem&&((void 0===allowUpscale||!allowUpscale)&&appletWidth>0&&appletWidth+border<myWidth?myWidth=appletWidth:myWidth-=border,"object"!=typeof window.GGBT_wsf_view||!window.GGBT_wsf_view.isFullscreen()||void 0!==allowUpscale&&allowUpscale||(myHeight-=borderTop)),{width:myWidth,height:myHeight}}function calcScale(parameters,appletElem,allowUpscale,showPlayButton,scaleContainerClass){if(parameters.isScreenshoGenerator)return 1;var ignoreHeight=void 0!==showPlayButton&&showPlayButton,noScaleMargin=void 0!=parameters.noScaleMargin&&parameters.noScaleMargin,autoHeight=function(value){return value&&"false"!==value}(parameters.autoHeight),windowSize=getWidthHeight(appletElem,parameters.width,allowUpscale,autoHeight,ignoreHeight&&window.GGBT_wsf_view||noScaleMargin,scaleContainerClass),windowWidth=parseInt(windowSize.width),appletWidth=parameters.width,appletHeight=parameters.height;if(void 0===appletWidth){var articles=appletElem.getElementsByTagName("article");1===articles.length&&(appletWidth=articles[0].offsetWidth,appletHeight=articles[0].offsetHeight)}var xscale=windowWidth/appletWidth,yscale=ignoreHeight?1:windowSize.height/appletHeight;return void 0===allowUpscale||allowUpscale||(xscale=Math.min(1,xscale),yscale=Math.min(1,yscale)),Math.min(xscale,yscale)}function getScale(parameters,appletElem,showPlayButton){var autoScale,scale=1,allowUpscale=!1;return parameters.hasOwnProperty("allowUpscale")&&(allowUpscale=parameters.allowUpscale),parameters.hasOwnProperty("scale")&&(scale=parseFloat(parameters.scale),(isNaN(scale)||null===scale||0===scale)&&(scale=1),scale>1&&(allowUpscale=!0)),appletElem&&"object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()&&(allowUpscale=!0),parameters.hasOwnProperty("disableAutoScale")&&parameters.disableAutoScale?scale:(autoScale=calcScale(parameters,appletElem,allowUpscale,showPlayButton,parameters.scaleContainerClass),!allowUpscale||parameters.hasOwnProperty("scale")&&1!==scale?Math.min(scale,autoScale):autoScale)}function positionCenter(appletElem){var windowWidth=Math.min(window.innerWidth,document.documentElement.clientWidth),windowHeight=Math.min(window.innerHeight,document.documentElement.clientHeight),appletRect=appletElem.getBoundingClientRect(),calcHorizontalBorder=(windowWidth-appletRect.width)/2,calcVerticalBorder=(windowHeight-appletRect.height)/2;calcVerticalBorder<0&&(calcVerticalBorder=0),appletElem.style.position="relative","closePositionRight"===window.GGBT_wsf_view.getCloseBtnPosition()?(appletElem.style.left=calcHorizontalBorder<40?"40px":calcHorizontalBorder+"px",appletElem.style.top=calcVerticalBorder+"px"):"closePositionTop"===window.GGBT_wsf_view.getCloseBtnPosition()&&(appletElem.style.top=calcVerticalBorder<40?"40px":calcVerticalBorder+"px",appletElem.style.left=calcHorizontalBorder+"px")}function responsiveResize(appletElem,parameters){var article=appletElem.getElementsByTagName("article")[0];if(article){if("object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()){var articles=appletElem.getElementsByTagName("article");if(articles.length>0&&parameters.id!==articles[0].getAttribute("data-param-id"))return;window.GGBT_wsf_view.setCloseBtnPosition(appletElem)}if(article.parentElement&&/fullscreen/.test(article.parentElement.className))return;var scale=getScale(parameters,appletElem);isFlexibleWorksheetEditor()&&article.setAttribute("data-param-scale",scale);for(var scaleElem=null,i=0;i<appletElem.childNodes.length;i++)if(void 0!==appletElem.childNodes[i].className&&appletElem.childNodes[i].className.match(/^applet_scaler/)){scaleElem=appletElem.childNodes[i];break}if(null!==scaleElem&&null!==scaleElem.querySelector(".noscale"))return;var appName=void 0!==parameters.id?parameters.id:"ggbApplet",app=window[appName];null!=app&&app.recalculateEnvironments||null===scaleElem||scaleElem.className.match(/fullscreen/)||(scaleElem.parentNode.style.transform="",isNaN(scale)||1===scale?(scaleElement(scaleElem,1),scaleElem.parentNode.style.width=parameters.width+"px",scaleElem.parentNode.style.height=parameters.height+"px"):(scaleElem.parentNode.style.width=parameters.width*scale+"px",scaleElem.parentNode.style.height=parameters.height*scale+"px",scaleElement(scaleElem,scale))),"object"==typeof window.GGBT_wsf_view&&window.GGBT_wsf_view.isFullscreen()&&positionCenter(appletElem),window.GGBT_wsf_view&&!window.GGBT_wsf_view.isFullscreen()&&window.GGBT_wsf_general.adjustContentToResize($(article).parents(".content-added-content"))}}return{responsiveResize:responsiveResize,isFlexibleWorksheetEditor:isFlexibleWorksheetEditor,positionCenter:positionCenter,getScale:getScale,scaleElement:scaleElement}}();"function"==typeof define&&define.amd&&define([],function(){return GGBApplet}),GGBAppletUtils.makeModule=function(name,permutation){function webModule(){var I="bootstrap",J="begin",K="gwt.codesvr."+name+"=",L="gwt.codesvr=",M=name,N="startup",O="DUMMY",P=0,Q=1,R="iframe",S="position:absolute; width:0; height:0; border:none; left: -1000px;",T=" top: -1000px;",U="CSS1Compat",V="<!doctype html>",W="",X="<html><head></head><body></body></html>",Y="undefined",Z="readystatechange",$=10,_="Chrome",ab='eval("',bb='");',cb="script",db="javascript",eb="moduleStartup",fb="moduleRequested",gb="Failed to load ",hb="head",ib="meta",jb="name",kb=name+"::",lb="::",mb="gwt:property",nb="content",ob="=",pb="gwt:onPropertyErrorFn",qb='Bad handler "',rb='" for "gwt:onPropertyErrorFn"',sb="gwt:onLoadErrorFn",tb='" for "gwt:onLoadErrorFn"',ub="#",vb="?",wb="/",xb="img",yb="clear.cache.gif",zb="baseUrl",Ab=name+".nocache.js",Bb="base",Cb="//",Db="user.agent",Eb="webkit",Fb="safari",Gb="msie",Hb=11,Ib="ie10",Jb=9,Kb="ie9",Lb=8,Mb="ie8",Nb="gecko",Ob="gecko1_8",Pb=2,Qb=3,Rb=4,Sb="selectingPermutation",Tb=name+".devmode.js",Ub=permutation,Vb=":1",Wb=":2",Xb=":3",Yb=":",Zb=".cache.js",$b="loadExternalRefs",_b="end",o=window,p=document;function q(){var a=o.location.search;return-1!=a.indexOf(K)||-1!=a.indexOf(L)}function r(a,b){}webModule.__sendStats=r,webModule.__moduleName=M,webModule.__errFn=null,webModule.__moduleBase=O,webModule.__softPermutationId=P,webModule.__computePropValue=null,webModule.__getPropMap=null,webModule.__installRunAsyncCode=function(){},webModule.__gwtStartLoadingFragment=function(){return null},webModule.__gwt_isKnownPropertyValue=function(){return!1},webModule.__gwt_getMetaProperty=function(){return null};var s=null,t=o.__gwt_activeModules=o.__gwt_activeModules||{};t[M]={moduleName:M},webModule.__moduleStartupDone=function(e){var f=t[M].bindings;t[M].bindings=function(){for(var a=f?f():{},b=e[webModule.__softPermutationId],c=P;c<b.length;c++){var d=b[c];a[d[P]]=d[Q]}return a}};var u;function v(){return w(),u}function w(){if(!u){var a=p.createElement(R);a.id=M,a.style.cssText=S+T,a.tabIndex=-1,p.body.appendChild(a),u=a.contentWindow.document,u.open();var b=document.compatMode==U?V:W;u.write(b+X),u.close()}}function A(k){function l(a){function b(){return typeof p.readyState==Y?typeof p.body!=Y&&null!=p.body:/loaded|complete/.test(p.readyState)}var c=b();if(c)return void a();function d(){if(!c){if(!b())return;c=!0,a(),p.removeEventListener&&p.removeEventListener(Z,d,!1),e&&clearInterval(e)}}p.addEventListener&&p.addEventListener(Z,d,!1);var e=setInterval(function(){d()},$)}function m(c){function d(a,b){a.removeChild(b)}
var g,e=v(),f=e.body;if(navigator.userAgent.indexOf(_)>-1&&window.JSON){var h=e.createDocumentFragment();h.appendChild(e.createTextNode(ab));for(var i=P;i<c.length;i++){var j=window.JSON.stringify(c[i]);h.appendChild(e.createTextNode(j.substring(Q,j.length-Q)))}h.appendChild(e.createTextNode(bb)),g=e.createElement(cb),g.language=db,g.appendChild(h),f.appendChild(g),d(f,g)}else for(var i=P;i<c.length;i++)g=e.createElement(cb),g.language=db,g.text=c[i],f.appendChild(g),d(f,g)}webModule.onScriptDownloaded=function(a){l(function(){m(a)})};var n=p.createElement(cb);n.src=k,webModule.__errFn&&(n.onerror=function(){webModule.__errFn(M,new Error(gb+code))}),p.getElementsByTagName(hb)[P].appendChild(n)}webModule.__startLoadingFragment=function(a){return D(a)},webModule.__installRunAsyncCode=function(a){var b=v(),c=b.body,d=b.createElement(cb);d.language=db,d.text=a,c.appendChild(d),c.removeChild(d)};function B(){for(var c={},d,e,f=p.getElementsByTagName(ib),g=P,h=f.length;g<h;++g){var i=f[g],j=i.getAttribute(jb),k;if(j){if(j=j.replace(kb,W),j.indexOf(lb)>=P)continue;if(j==mb){if(k=i.getAttribute(nb)){var l,m=k.indexOf(ob);m>=P?(j=k.substring(P,m),l=k.substring(m+Q)):(j=k,l=W),c[j]=l}}else if(j==pb){if(k=i.getAttribute(nb))try{d=eval(k)}catch(a){alert(qb+k+rb)}}else if(j==sb&&(k=i.getAttribute(nb)))try{e=eval(k)}catch(a){alert(qb+k+tb)}}}__gwt_getMetaProperty=function(a){var b=c[a];return null==b?null:b},s=d,webModule.__errFn=e}function C(){function e(a){var b=a.lastIndexOf(ub);-1==b&&(b=a.length);var c=a.indexOf(vb);-1==c&&(c=a.length);var d=a.lastIndexOf(wb,Math.min(c,b));return d>=P?a.substring(P,d+Q):W}var k=function(){var a=__gwt_getMetaProperty(zb);return null!=a?a:W}();return k==W&&(k=function(){for(var a=p.getElementsByTagName(cb),b=P;b<a.length;++b)if(-1!=a[b].src.indexOf(Ab))return e(a[b].src);return W}()),k==W&&(k=function(){var a=p.getElementsByTagName(Bb);return a.length>P?a[a.length-Q].href:W}()),k==W&&function(){var a=p.location;return a.href==a.protocol+Cb+a.host+a.pathname+a.search+a.hash}()&&(k=e(p.location.href)),k=function(a){if(a.match(/^\w+:\/\//));else{var b=p.createElement(xb);b.src=a+yb,a=e(b.src)}return a}(k)}function D(a){return a.match(/^\//)?a:a.match(/^[a-zA-Z]+:\/\//)?a:webModule.__moduleBase+a}function F(){var f=[],g=P;function h(a,b){for(var c=f,d=P,e=a.length-Q;d<e;++d)c=c[a[d]]||(c[a[d]]=[]);c[a[e]]=b}var i=[],j=[];function k(a){var b=j[a](),c=i[a];if(b in c)return b;var d=[];for(var e in c)d[c[e]]=e;throw s&&s(a,d,b),null}if(j[Db]=function(){var a=navigator.userAgent.toLowerCase(),b=p.documentMode;return function(){return-1!=a.indexOf(Eb)}()?Fb:function(){return-1!=a.indexOf(Gb)&&b>=$&&b<Hb}()?Ib:function(){return-1!=a.indexOf(Gb)&&b>=Jb&&b<Hb}()?Kb:function(){return-1!=a.indexOf(Gb)&&b>=Lb&&b<Hb}()?Mb:function(){return-1!=a.indexOf(Nb)||b>=Hb}()?Ob:Fb},i[Db]={gecko1_8:P,ie10:Q,ie8:Pb,ie9:Qb,safari:Rb},__gwt_isKnownPropertyValue=function(a,b){return b in i[a]},webModule.__getPropMap=function(){var a={};for(var b in i)i.hasOwnProperty(b)&&(a[b]=k(b));return a},webModule.__computePropValue=k,o.__gwt_activeModules[M].bindings=webModule.__getPropMap,q())return D(Tb);var l;try{h([Ob],Ub),h([Ib],Ub+Vb),h([Kb],Ub+Wb),h([Fb],Ub+Xb),l=f[k(Db)];var m=l.indexOf(Yb);-1!=m&&(g=parseInt(l.substring(m+Q),$),l=l.substring(P,m))}catch(a){}return webModule.__softPermutationId=g,D(l+Zb)}function G(){o.__gwt_stylesLoaded||(o.__gwt_stylesLoaded={})}B(),webModule.__moduleBase="https://cdn.geogebra.org/apps/latest/"+name+"/",t[M].moduleBase=webModule.__moduleBase;var H=F();return G(),A(H),!0}return webModule},"function"!=typeof window.web3d&&(web3d=GGBAppletUtils.makeModule("web3d","12DD9077EF918DCD14C081861B4DBB92")),"function"!=typeof window.webSimple&&(webSimple=GGBAppletUtils.makeModule("webSimple","071BACE69702ED544D8A8B4B63C3C2A1")),function(window,document,undefined){var j=!0,k=null,l=!1;function p(a){return function(){return this[a]}}var aa=this;function q(a,b){var c=a.split("."),d=aa;!(c[0]in d)&&d.execScript&&d.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());)c.length||void 0===b?d=d[e]?d[e]:d[e]={}:d[e]=b}function ba(a,b,c){return a.call.apply(a.bind,arguments)}function ca(a,b,c){if(!a)throw Error();if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(c,d),a.apply(b,c)}}return function(){return a.apply(b,arguments)}}function s(a,b,c){return s=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ba:ca,s.apply(k,arguments)}var da=Date.now||function(){return+new Date};function ea(a,b){this.G=a,this.u=b||a,this.z=this.u.document}ea.prototype.createElement=function(a,b,c){if(a=this.z.createElement(a),b)for(var d in b)b.hasOwnProperty(d)&&("style"==d?a.style.cssText=b[d]:a.setAttribute(d,b[d]));return c&&a.appendChild(this.z.createTextNode(c)),a};function fa(a,b,c){a=a.z.getElementsByTagName(b)[0],a||(a=document.documentElement),a&&a.lastChild&&a.insertBefore(c,a.lastChild)}function t(a,b){for(var c=a.className.split(/\s+/),d=0,e=c.length;d<e;d++)if(c[d]==b)return;c.push(b),a.className=c.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function u(a,b){for(var c=a.className.split(/\s+/),d=[],e=0,f=c.length;e<f;e++)c[e]!=b&&d.push(c[e]);a.className=d.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function ga(a,b){for(var c=a.className.split(/\s+/),d=0,e=c.length;d<e;d++)if(c[d]==b)return j;return l}function v(a){var b=a.u.location.protocol;return"about:"==b&&(b=a.G.location.protocol),"https:"==b?"https:":"http:"}function w(a,b){var c=a.createElement("link",{rel:"stylesheet",href:b}),d=l;c.onload=function(){d||(d=j)},c.onerror=function(){d||(d=j)},fa(a,"head",c)}function x(a,b,c,d){var e=a.z.getElementsByTagName("head")[0];if(e){var f=a.createElement("script",{src:b}),g=l;return f.onload=f.onreadystatechange=function(){g||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(g=j,c&&c(k),f.onload=f.onreadystatechange=k,"HEAD"==f.parentNode.tagName&&e.removeChild(f))},e.appendChild(f),window.setTimeout(function(){g||(g=j,c&&c(Error("Script load timeout")))},d||5e3),f}return k}function y(a,b,c){this.w=a,this.S=b,this.za=c}q("webfont.BrowserInfo",y),y.prototype.pa=p("w"),y.prototype.hasWebFontSupport=y.prototype.pa,y.prototype.qa=p("S"),y.prototype.hasWebKitFallbackBug=y.prototype.qa,y.prototype.ra=p("za"),y.prototype.hasWebKitMetricsBug=y.prototype.ra;function z(a,b,c,d){this.e=a!=k?a:k,this.o=b!=k?b:k,this.aa=c!=k?c:k,this.f=d!=k?d:k}var ha=/^([0-9]+)(?:[\._-]([0-9]+))?(?:[\._-]([0-9]+))?(?:[\._+-]?(.*))?$/;z.prototype.toString=function(){return[this.e,this.o||"",this.aa||"",this.f||""].join("")};function A(a){a=ha.exec(a);var b=k,c=k,d=k,e=k;return a&&(a[1]!==k&&a[1]&&(b=parseInt(a[1],10)),a[2]!==k&&a[2]&&(c=parseInt(a[2],10)),a[3]!==k&&a[3]&&(d=parseInt(a[3],10)),a[4]!==k&&a[4]&&(e=/^[0-9]+$/.test(a[4])?parseInt(a[4],10):a[4])),new z(b,c,d,e)}function B(a,b,c,d,e,f,g,h,m,n,r){this.J=a,this.Fa=b,this.ya=c,this.fa=d,this.Da=e,this.ea=f,this.wa=g,this.Ea=h,this.va=m,this.da=n,this.k=r}q("webfont.UserAgent",B),B.prototype.getName=p("J"),B.prototype.getName=B.prototype.getName,B.prototype.oa=p("ya"),B.prototype.getVersion=B.prototype.oa,B.prototype.ka=p("fa"),B.prototype.getEngine=B.prototype.ka,B.prototype.la=p("ea"),B.prototype.getEngineVersion=B.prototype.la,B.prototype.ma=p("wa"),B.prototype.getPlatform=B.prototype.ma,B.prototype.na=p("va"),B.prototype.getPlatformVersion=B.prototype.na,B.prototype.ja=p("da"),B.prototype.getDocumentMode=B.prototype.ja,B.prototype.ia=p("k"),B.prototype.getBrowserInfo=B.prototype.ia;function C(a,b){this.a=a,this.H=b}var ia=new B("Unknown",new z,"Unknown","Unknown",new z,"Unknown","Unknown",new z,"Unknown",void 0,new y(l,l,l));C.prototype.parse=function(){var a;if(-1!=this.a.indexOf("MSIE")){a=D(this);var b=E(this),c=A(b),d=F(this.a,/MSIE ([\d\w\.]+)/,1),e=A(d);a=new B("MSIE",e,d,"MSIE",e,d,a,c,b,G(this.H),new y("Windows"==a&&6<=e.e||"Windows Phone"==a&&8<=c.e,l,l))}else if(-1!=this.a.indexOf("Opera"))a:{a="Unknown";var b=F(this.a,/Presto\/([\d\w\.]+)/,1),c=A(b),d=E(this),e=A(d),f=G(this.H);if(c.e!==k?a="Presto":(-1!=this.a.indexOf("Gecko")&&(a="Gecko"),b=F(this.a,/rv:([^\)]+)/,1),c=A(b)),-1!=this.a.indexOf("Opera Mini/")){var g=F(this.a,/Opera Mini\/([\d\.]+)/,1),h=A(g);a=new B("OperaMini",h,g,a,c,b,D(this),e,d,f,new y(l,l,l))}else{if(-1!=this.a.indexOf("Version/")&&(g=F(this.a,/Version\/([\d\.]+)/,1),h=A(g),h.e!==k)){a=new B("Opera",h,g,a,c,b,D(this),e,d,f,new y(10<=h.e,l,l));break a}g=F(this.a,/Opera[\/ ]([\d\.]+)/,1),h=A(g),a=h.e!==k?new B("Opera",h,g,a,c,b,D(this),e,d,f,new y(10<=h.e,l,l)):new B("Opera",new z,"Unknown",a,c,b,D(this),e,d,f,new y(l,l,l))}}else/OPR\/[\d.]+/.test(this.a)?a=ja(this):/AppleWeb(K|k)it/.test(this.a)?a=ja(this):-1!=this.a.indexOf("Gecko")?(a="Unknown",b=new z,c="Unknown",d=E(this),e=A(d),f=l,-1!=this.a.indexOf("Firefox")?(a="Firefox",c=F(this.a,/Firefox\/([\d\w\.]+)/,1),b=A(c),f=3<=b.e&&5<=b.o):-1!=this.a.indexOf("Mozilla")&&(a="Mozilla"),g=F(this.a,/rv:([^\)]+)/,1),h=A(g),f||(f=1<h.e||1==h.e&&9<h.o||1==h.e&&9==h.o&&2<=h.aa||g.match(/1\.9\.1b[123]/)!=k||g.match(/1\.9\.1\.[\d\.]+/)!=k),a=new B(a,b,c,"Gecko",h,g,D(this),e,d,G(this.H),new y(f,l,l))):a=ia;return a};function D(a){var b=F(a.a,/(iPod|iPad|iPhone|Android|Windows Phone|BB\d{2}|BlackBerry)/,1);return""!=b?(/BB\d{2}/.test(b)&&(b="BlackBerry"),b):(a=F(a.a,/(Linux|Mac_PowerPC|Macintosh|Windows|CrOS)/,1),""!=a?("Mac_PowerPC"==a&&(a="Macintosh"),a):"Unknown")}function E(a){var b=F(a.a,/(OS X|Windows NT|Android) ([^;)]+)/,2);if(b||(b=F(a.a,/Windows Phone( OS)? ([^;)]+)/,2))||(b=F(a.a,/(iPhone )?OS ([\d_]+)/,2)))return b;if(b=F(a.a,/(?:Linux|CrOS) ([^;)]+)/,1))for(var b=b.split(/\s/),c=0;c<b.length;c+=1)if(/^[\d\._]+$/.test(b[c]))return b[c];return(a=F(a.a,/(BB\d{2}|BlackBerry).*?Version\/([^\s]*)/,2))?a:"Unknown"}function ja(a){var b=D(a),c=E(a),d=A(c),e=F(a.a,/AppleWeb(?:K|k)it\/([\d\.\+]+)/,1),f=A(e),g="Unknown",h=new z,m="Unknown",n=l;return/OPR\/[\d.]+/.test(a.a)?g="Opera":-1!=a.a.indexOf("Chrome")||-1!=a.a.indexOf("CrMo")||-1!=a.a.indexOf("CriOS")?g="Chrome":/Silk\/\d/.test(a.a)?g="Silk":"BlackBerry"==b||"Android"==b?g="BuiltinBrowser":-1!=a.a.indexOf("PhantomJS")?g="PhantomJS":-1!=a.a.indexOf("Safari")?g="Safari":-1!=a.a.indexOf("AdobeAIR")&&(g="AdobeAIR"),"BuiltinBrowser"==g?m="Unknown":"Silk"==g?m=F(a.a,/Silk\/([\d\._]+)/,1):"Chrome"==g?m=F(a.a,/(Chrome|CrMo|CriOS)\/([\d\.]+)/,2):-1!=a.a.indexOf("Version/")?m=F(a.a,/Version\/([\d\.\w]+)/,1):"AdobeAIR"==g?m=F(a.a,/AdobeAIR\/([\d\.]+)/,1):"Opera"==g?m=F(a.a,/OPR\/([\d.]+)/,1):"PhantomJS"==g&&(m=F(a.a,/PhantomJS\/([\d.]+)/,1)),h=A(m),n="AdobeAIR"==g?2<h.e||2==h.e&&5<=h.o:"BlackBerry"==b?10<=d.e:"Android"==b?2<d.e||2==d.e&&1<d.o:526<=f.e||525<=f.e&&13<=f.o,new B(g,h,m,"AppleWebKit",f,e,b,d,c,G(a.H),new y(n,536>f.e||536==f.e&&11>f.o,"iPhone"==b||"iPad"==b||"iPod"==b||"Macintosh"==b))}function F(a,b,c){return(a=a.match(b))&&a[c]?a[c]:""}function G(a){if(a.documentMode)return a.documentMode}function ka(a){this.ua=a||"-"}ka.prototype.f=function(a){for(var b=[],c=0;c<arguments.length;c++)b.push(arguments[c].replace(/[\W_]+/g,"").toLowerCase());return b.join(this.ua)};function H(a,b){this.J=a,this.T=4,this.K="n";var c=(b||"n4").match(/^([nio])([1-9])$/i);c&&(this.K=c[1],this.T=parseInt(c[2],10))}H.prototype.getName=p("J");function I(a){return a.K+a.T}function la(a){var b=4,c="n",d=k;return a&&((d=a.match(/(normal|oblique|italic)/i))&&d[1]&&(c=d[1].substr(0,1).toLowerCase()),(d=a.match(/([1-9]00|normal|bold)/i))&&d[1]&&(/bold/i.test(d[1])?b=7:/[1-9]00/.test(d[1])&&(b=parseInt(d[1].substr(0,1),10)))),c+b}function ma(a,b,c){this.c=a,this.h=b,this.M=c,this.j="wf",this.g=new ka("-")}function na(a){t(a.h,a.g.f(a.j,"loading")),J(a,"loading")}function K(a){u(a.h,a.g.f(a.j,"loading")),ga(a.h,a.g.f(a.j,"active"))||t(a.h,a.g.f(a.j,"inactive")),J(a,"inactive")}function J(a,b,c){a.M[b]&&(c?a.M[b](c.getName(),I(c)):a.M[b]())}function L(a,b){this.c=a,this.C=b,this.s=this.c.createElement("span",{"aria-hidden":"true"},this.C)}function M(a,b){var c;c=[];for(var d=b.J.split(/,\s*/),e=0;e<d.length;e++){var f=d[e].replace(/['"]/g,"");-1==f.indexOf(" ")?c.push(f):c.push("'"+f+"'")}c=c.join(","),d="normal",e=b.T+"00","o"===b.K?d="oblique":"i"===b.K&&(d="italic"),a.s.style.cssText="position:absolute;top:-999px;left:-999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+c+";font-style:"+d+";font-weight:"+e+";"}function N(a){fa(a.c,"body",a.s)}L.prototype.remove=function(){var a=this.s;a.parentNode&&a.parentNode.removeChild(a)};function oa(a,b,c,d,e,f,g,h){this.U=a,this.sa=b,this.c=c,this.q=d,this.C=h||"BESbswy",this.k=e,this.F={},this.R=f||5e3,this.Y=g||k,this.B=this.A=k,a=new L(this.c,this.C),N(a);for(var m in O)O.hasOwnProperty(m)&&(M(a,new H(O[m],I(this.q))),this.F[O[m]]=a.s.offsetWidth);a.remove()}var O={Ca:"serif",Ba:"sans-serif",Aa:"monospace"};oa.prototype.start=function(){this.A=new L(this.c,this.C),N(this.A),this.B=new L(this.c,this.C),N(this.B),this.xa=da(),M(this.A,new H(this.q.getName()+",serif",I(this.q))),M(this.B,new H(this.q.getName()+",sans-serif",I(this.q))),qa(this)};function ra(a,b,c){for(var d in O)if(O.hasOwnProperty(d)&&b===a.F[O[d]]&&c===a.F[O[d]])return j;return l}function qa(a){var b=a.A.s.offsetWidth,c=a.B.s.offsetWidth;b===a.F.serif&&c===a.F["sans-serif"]||a.k.S&&ra(a,b,c)?da()-a.xa>=a.R?a.k.S&&ra(a,b,c)&&(a.Y===k||a.Y.hasOwnProperty(a.q.getName()))?P(a,a.U):P(a,a.sa):setTimeout(s(function(){qa(this)},a),25):P(a,a.U)}function P(a,b){a.A.remove(),a.B.remove(),b(a.q)}function R(a,b,c,d){this.c=b,this.t=c,this.N=0,this.ba=this.X=l,this.R=d,this.k=a.k}function sa(a,b,c,d,e){if(0===b.length&&e)K(a.t);else for(a.N+=b.length,e&&(a.X=e),e=0;e<b.length;e++){var f=b[e],g=c[f.getName()],h=a.t,m=f;t(h.h,h.g.f(h.j,m.getName(),I(m).toString(),"loading")),J(h,"fontloading",m),new oa(s(a.ga,a),s(a.ha,a),a.c,f,a.k,a.R,d,g).start()}}R.prototype.ga=function(a){var b=this.t;u(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"loading")),u(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"inactive")),t(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"active")),J(b,"fontactive",a),this.ba=j,ta(this)},R.prototype.ha=function(a){var b=this.t;u(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"loading")),ga(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"active"))||t(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"inactive")),J(b,"fontinactive",a),ta(this)};function ta(a){0==--a.N&&a.X&&(a.ba?(a=a.t,u(a.h,a.g.f(a.j,"loading")),u(a.h,a.g.f(a.j,"inactive")),t(a.h,a.g.f(a.j,"active")),J(a,"active")):K(a.t))}function S(a,b,c){this.G=a,this.V=b,this.a=c,this.O=this.P=0}function T(a,b){U.V.Z[a]=b}S.prototype.load=function(a){var b=a.context||this.G;if(this.c=new ea(this.G,b),b=new ma(this.c,b.document.documentElement,a),this.a.k.w){var f,c=this.V,d=this.c,e=[];for(f in a)if(a.hasOwnProperty(f)){var g=c.Z[f];g&&e.push(g(a[f],d))}for(a=a.timeout,this.O=this.P=e.length,a=new R(this.a,this.c,b,a),f=0,c=e.length;f<c;f++)d=e[f],d.v(this.a,s(this.ta,this,d,b,a))}else K(b)},S.prototype.ta=function(a,b,c,d){var e=this;d?a.load(function(a,d,h){var m=0==--e.P;m&&na(b),setTimeout(function(){sa(c,a,d||{},h||k,m)},0)}):(a=0==--this.P,this.O--,a&&(0==this.O?K(b):na(b)),sa(c,[],{},k,a))};var ua=window,va=new C(navigator.userAgent,document).parse(),U=ua.WebFont=new S(window,new function(){this.Z={}},va);U.load=U.load;function V(a,b){this.c=a,this.d=b}V.prototype.load=function(a){var b,c,d=this.d.urls||[],e=this.d.families||[];for(b=0,c=d.length;b<c;b++)w(this.c,d[b]);for(d=[],b=0,c=e.length;b<c;b++){var f=e[b].split(":");if(f[1])for(var g=f[1].split(","),h=0;h<g.length;h+=1)d.push(new H(f[0],g[h]));else d.push(new H(f[0]))}a(d)},V.prototype.v=function(a,b){return b(a.k.w)},T("custom",function(a,b){return new V(b,a)});function W(a,b){this.c=a,this.d=b,this.m=[]}W.prototype.D=function(a){return v(this.c)+(this.d.api||"//f.fontdeck.com/s/css/js/")+(this.c.u.location.hostname||this.c.G.location.hostname)+"/"+a+".js"},W.prototype.v=function(a,b){var c=this.d.id,d=this.c.u,e=this;c?(d.__webfontfontdeckmodule__||(d.__webfontfontdeckmodule__={}),d.__webfontfontdeckmodule__[c]=function(a,c){for(var d=0,m=c.fonts.length;d<m;++d){var n=c.fonts[d];e.m.push(new H(n.name,la("font-weight:"+n.weight+";font-style:"+n.style)))}b(a)},x(this.c,this.D(c),function(a){a&&b(l)})):b(l)},W.prototype.load=function(a){a(this.m)},T("fontdeck",function(a,b){return new W(b,a)});function wa(a,b,c){this.L=a||b+xa,this.p=[],this.Q=[],this.ca=c||""}var xa="//fonts.googleapis.com/css";wa.prototype.f=function(){if(0==this.p.length)throw Error("No fonts to load !");if(-1!=this.L.indexOf("kit="))return this.L;for(var a=this.p.length,b=[],c=0;c<a;c++)b.push(this.p[c].replace(/ /g,"+"));return a=this.L+"?family="+b.join("%7C"),0<this.Q.length&&(a+="&subset="+this.Q.join(",")),0<this.ca.length&&(a+="&text="+encodeURIComponent(this.ca)),a};function ya(a){this.p=a,this.$=[],this.I={}}var za={latin:"BESbswy",cyrillic:"&#1081;&#1103;&#1046;",greek:"&#945;&#946;&#931;",khmer:"&#x1780;&#x1781;&#x1782;",Hanuman:"&#x1780;&#x1781;&#x1782;"},Aa={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},Ba={i:"i",italic:"i",n:"n",normal:"n"},Ca=RegExp("^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$");ya.prototype.parse=function(){for(var a=this.p.length,b=0;b<a;b++){var c=this.p[b].split(":"),d=c[0].replace(/\+/g," "),e=["n4"];if(2<=c.length){var f,g=c[1];if(f=[],g)for(var g=g.split(","),h=g.length,m=0;m<h;m++){var n;if(n=g[m],n.match(/^[\w]+$/)){n=Ca.exec(n.toLowerCase());var r=void 0;if(n==k)r="";else{if(r=void 0,(r=n[1])==k||""==r)r="4";else var pa=Aa[r],r=pa||(isNaN(r)?"4":r.substr(0,1));r=[n[2]==k||""==n[2]?"n":Ba[n[2]],r].join("")}n=r}else n="";n&&f.push(n)}0<f.length&&(e=f),3==c.length&&(c=c[2],f=[],c=c?c.split(","):f,0<c.length&&(c=za[c[0]])&&(this.I[d]=c))}for(this.I[d]||(c=za[d])&&(this.I[d]=c),c=0;c<e.length;c+=1)this.$.push(new H(d,e[c]))}};function X(a,b,c){this.a=a,this.c=b,this.d=c}var Da={Arimo:j,Cousine:j,Tinos:j};X.prototype.v=function(a,b){b(a.k.w)},X.prototype.load=function(a){var b=this.c;if("MSIE"==this.a.getName()&&this.d.blocking!=j){var c=s(this.W,this,a),d=function(){b.z.body?c():setTimeout(d,0)};d()}else this.W(a)},X.prototype.W=function(a){for(var b=this.c,c=new wa(this.d.api,v(b),this.d.text),d=this.d.families,e=d.length,f=0;f<e;f++){var g=d[f].split(":");3==g.length&&c.Q.push(g.pop());var h="";2==g.length&&""!=g[1]&&(h=":"),c.p.push(g.join(h))}d=new ya(d),d.parse(),w(b,c.f()),a(d.$,d.I,Da)},T("google",function(a,b){return new X(new C(navigator.userAgent,document).parse(),b,a)});function Y(a,b){this.c=a,this.d=b}var Ea={regular:"n4",bold:"n7",italic:"i4",bolditalic:"i7",r:"n4",b:"n7",i:"i4",bi:"i7"};Y.prototype.v=function(a,b){return b(a.k.w)},Y.prototype.load=function(a){w(this.c,v(this.c)+"//webfonts.fontslive.com/css/"+this.d.key+".css");for(var b=this.d.families,c=[],d=0,e=b.length;d<e;d++)c.push.apply(c,Fa(b[d]));a(c)};function Fa(a){var b=a.split(":");if(a=b[0],b[1]){for(var c=b[1].split(","),b=[],d=0,e=c.length;d<e;d++){var f=c[d];if(f){var g=Ea[f];b.push(g||f)}}for(c=[],d=0;d<b.length;d+=1)c.push(new H(a,b[d]));return c}return[new H(a)]}T("ascender",function(a,b){return new Y(b,a)});function Z(a,b,c){this.a=a,this.c=b,this.d=c,this.m=[]}Z.prototype.v=function(a,b){var c=this,d=c.d.projectId,e=c.d.version;if(d){var f=c.c.u;x(this.c,c.D(d,e),function(e){if(e)b(l);else{if(f["__mti_fntLst"+d]&&(e=f["__mti_fntLst"+d]()))for(var h=0;h<e.length;h++)c.m.push(new H(e[h].fontfamily));b(a.k.w)}}).id="__MonotypeAPIScript__"+d}else b(l)},Z.prototype.D=function(a,b){return v(this.c)+"//"+(this.d.api||"fast.fonts.com/jsapi").replace(/^.*http(s?):(\/\/)?/,"")+"/"+a+".js"+(b?"?v="+b:"")},Z.prototype.load=function(a){a(this.m)},T("monotype",function(a,b){return new Z(new C(navigator.userAgent,document).parse(),b,a)});function $(a,b){this.c=a,this.d=b,this.m=[]}$.prototype.D=function(a){var b=v(this.c);return(this.d.api||b+"//use.typekit.net")+"/"+a+".js"},$.prototype.v=function(a,b){var c=this.d.id,d=this.d,e=this.c.u,f=this;c?(e.__webfonttypekitmodule__||(e.__webfonttypekitmodule__={}),e.__webfonttypekitmodule__[c]=function(c){c(a,d,function(a,c,d){for(var e=0;e<c.length;e+=1){var g=d[c[e]];if(g)for(var Q=0;Q<g.length;Q+=1)f.m.push(new H(c[e],g[Q]));else f.m.push(new H(c[e]))}b(a)})},x(this.c,this.D(c),function(a){a&&b(l)},2e3)):b(l)},$.prototype.load=function(a){a(this.m)},T("typekit",function(a,b){return new $(b,a)}),window.WebFontConfig&&U.load(window.WebFontConfig)}(this,document);function Vec2(x_,y_){this.x=x_,this.y=y_,this.mulS=function(value){return new Vec2(this.x*value,this.y*value)},this.mulV=function(vec_){return new Vec2(this.x*vec_.x,this.y*vec_.y)},this.divS=function(value){return new Vec2(this.x/value,this.y/value)},this.addS=function(value){return new Vec2(this.x+value,this.y+value)},this.addV=function(vec_){return new Vec2(this.x+vec_.x,this.y+vec_.y)},this.subS=function(value){return new Vec2(this.x-value,this.y-value)},this.subV=function(vec_){return new Vec2(this.x-vec_.x,this.y-vec_.y)},this.abs=function(){return new Vec2(Math.abs(this.x),Math.abs(this.y))},this.dot=function(vec_){return this.x*vec_.x+this.y*vec_.y},this.length=function(){return Math.sqrt(this.dot(this))},this.lengthSqr=function(){return this.dot(this)},this.angle=function(vec_){vec_=vec_||new Vec2(1,0);var n1=new Vec2(this.x,this.y),n2=new Vec2(vec_.x,vec_.y);return n1.normalize(),n2.normalize(),Math.atan2(n1.y,n1.x)-Math.atan2(n2.y,n2.x)},this.lerp=function(vec_,value){return new Vec2(this.x+(vec_.x-this.x)*value,this.y+(vec_.y-this.y)*value)},this.normalize=function(){var vlen=this.length();this.x=this.x/vlen,this.y=this.y/vlen},this.round=function(){this.x=Math.round(this.x),this.y=Math.round(this.y)},this.equals=function(o){return this.x==o.x&&this.y==o.y},this.asCSS=function(){return{left:this.x,top:this.y}}}Vec2.fromCSS=function(css){return new Vec2(parseInt(css.left,10),parseInt(css.top,10))};var saveAs=saveAs||function(view){"use strict";if(!(void 0===view||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view},save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),can_use_save_link="download"in save_link,click=function(node){var event=new MouseEvent("click");node.dispatchEvent(event)},is_safari=/constructor/i.test(view.HTMLElement),is_chrome_ios=/CriOS\/[\d]+/.test(navigator.userAgent),throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex},0)},revoke=function(file){var revoker=function(){"string"==typeof file?get_URL().revokeObjectURL(file):file.remove()};setTimeout(revoker,4e4)},dispatch=function(filesaver,event_types,event){event_types=[].concat(event_types);for(var i=event_types.length;i--;){var listener=filesaver["on"+event_types[i]];if("function"==typeof listener)try{listener.call(filesaver,event||filesaver)}catch(ex){throw_outside(ex)}}},auto_bom=function(blob){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)?new Blob([String.fromCharCode(65279),blob],{type:blob.type}):blob},FileSaver=function(blob,name,no_auto_bom){no_auto_bom||(blob=auto_bom(blob));var object_url,filesaver=this,type=blob.type,force="application/octet-stream"===type,dispatch_all=function(){dispatch(filesaver,"writestart progress write writeend".split(" "))};if(filesaver.readyState=filesaver.INIT,can_use_save_link)return object_url=get_URL().createObjectURL(blob),void setTimeout(function(){save_link.href=object_url,save_link.download=name,click(save_link),dispatch_all(),revoke(object_url),filesaver.readyState=filesaver.DONE});!function(){if((is_chrome_ios||force&&is_safari)&&view.FileReader){var reader=new FileReader;return reader.onloadend=function(){var url=is_chrome_ios?reader.result:reader.result.replace(/^data:[^;]*;/,"data:attachment/file;");view.open(url,"_blank")||(view.location.href=url),url=void 0,filesaver.readyState=filesaver.DONE,dispatch_all()},reader.readAsDataURL(blob),void(filesaver.readyState=filesaver.INIT)}if(object_url||(object_url=get_URL().createObjectURL(blob)),force)view.location.href=object_url;else{view.open(object_url,"_blank")||(view.location.href=object_url)}filesaver.readyState=filesaver.DONE,dispatch_all(),revoke(object_url)}()},FS_proto=FileSaver.prototype,saveAs=function(blob,name,no_auto_bom){return new FileSaver(blob,name||blob.name||"download",no_auto_bom)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(blob,name,no_auto_bom){return name=name||blob.name||"download",no_auto_bom||(blob=auto_bom(blob)),navigator.msSaveOrOpenBlob(blob,name)}:(FS_proto.abort=function(){},FS_proto.readyState=FS_proto.INIT=0,FS_proto.WRITING=1,FS_proto.DONE=2,FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null,saveAs)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);if("undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define([],function(){return saveAs}),window.triggerOnUnload=function(){a5.mainBuilder.onWindowUnload()},!window.Node)var Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};var cbSplit;cbSplit||(cbSplit=function(str,separator,limit){if("[object RegExp]"!==Object.prototype.toString.call(separator))return cbSplit._nativeSplit.call(str,separator,limit);var separator2,match,lastIndex,lastLength,output=[],lastLastIndex=0,flags=(separator.ignoreCase?"i":"")+(separator.multiline?"m":"")+(separator.sticky?"y":""),separator=RegExp(separator.source,flags+"g");if(str+="",cbSplit._compliantExecNpcg||(separator2=RegExp("^"+separator.source+"$(?!\\s)",flags)),void 0===limit||+limit<0)limit=1/0;else if(!(limit=Math.floor(+limit)))return[];for(;(match=separator.exec(str))&&!((lastIndex=match.index+match[0].length)>lastLastIndex&&(output.push(str.slice(lastLastIndex,match.index)),!cbSplit._compliantExecNpcg&&match.length>1&&match[0].replace(separator2,function(){for(var i=1;i<arguments.length-2;i++)void 0===arguments[i]&&(match[i]=void 0)}),match.length>1&&match.index<str.length&&Array.prototype.push.apply(output,match.slice(1)),lastLength=match[0].length,lastLastIndex=lastIndex,output.length>=limit));)separator.lastIndex===match.index&&separator.lastIndex++;return lastLastIndex===str.length?!lastLength&&separator.test("")||output.push(""):output.push(str.slice(lastLastIndex)),output.length>limit?output.slice(0,limit):output},cbSplit._compliantExecNpcg=void 0===/()??/.exec("")[1],cbSplit._nativeSplit=String.prototype.split),String.prototype.split=function(separator,limit){return cbSplit(this,separator,limit)},Function.prototype.bind||(Function.prototype.bind=function(context){var func=this;return function(){func.apply(context,arguments)}}),Array.prototype.forEach||(Array.prototype.forEach=function(fun){var len=this.length>>>0;if("function"!=typeof fun)throw new TypeError;for(var thisp=arguments[1],i=0;i<len;i++)i in this&&fun.call(thisp,this[i],i,this)}),Function.prototype.bind&&"undefined"!=typeof console&&"object"==typeof console.log&&["log","info","warn","error","assert","dir","clear","profile","profileEnd"].forEach(function(method){console[method]=this.bind(console[method],console)},Function.prototype.call),Function.prototype.bindTo||(Function.prototype.bindTo=function(context){var func=this;return function(){func.apply(context,arguments)}}),String.prototype.trim||(String.prototype.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")}),Array.prototype.extract||Object.defineProperty(Array.prototype,"extract",{enumerable:!1,writeable:!0,value:function(){for(var na=[],cnt=0;cnt<arguments.length;cnt++)na.push(this[arguments[cnt]]);return na}}),Array.prototype.remove||Object.defineProperty(Array.prototype,"remove",{enumerable:!1,writeable:!0,value:function(element){for(var i=0;i<this.length;i++)if(this[i]==element)return this.splice(i,1),i;return-1}}),Array.prototype.removeAt||Object.defineProperty(Array.prototype,"removeAt",{enumerable:!1,writeable:!0,value:function(pos){var ret=this[pos];return this.splice(pos,1),ret}}),Array.prototype.indexOf||Object.defineProperty(Array.prototype,"indexOf",{enumerable:!1,writeable:!0,value:function(element){for(var i=0;i<this.length;i++)if(this[i]==element)return i;return-1}}),Array.prototype.contains||Object.defineProperty(Array.prototype,"contains",{enumerable:!1,writeable:!0,value:function(element){for(var i=0;i<this.length;i++)if(this[i]==element)return!0;return!1}}),Array.prototype.sameSet||Object.defineProperty(Array.prototype,"sameSet",{enumerable:!1,writeable:!0,value:function(set){var valid=this.length==set.length;if(valid)for(var i=0;i<this.length;i++)set.contains(this[i])||(valid=!1);return valid}}),window.len||(window.len=function(obj){var key,size=0;for(key in obj)obj.hasOwnProperty(key)&&size++;return size}),class_space={},window.objectCounter=0,function(global){function _getProp(class_name){return _(class_name.split(".")).reduce(function(res,current){return res[current]},global)}var initializing=!1,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(class_name,prop){if(!prop&&!(prop=_getProp(class_name)))throw"Invalid Class Definition";var _super=this.prototype;initializing=!0;var prototype=new this;initializing=!1;for(var name in prop)prototype[name]="function"==typeof prop[name]&&"function"==typeof _super[name]&&fnTest.test(prop[name])?function(name,fn){return function(){"init"==name&&void 0===this._uid&&(this._uid=class_name+":"+window.objectCounter++);var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);return this._super=tmp,ret}}(name,prop[name]):prop[name];function Class(){!initializing&&this.init&&(this._class_name=class_name,this.init.apply(this,arguments))}Class.prototype=prototype,Class.constructor=Class,Class.extend=arguments.callee,class_space[class_name]=Class;var namespace=window,modules=class_name.split("."),className=modules.splice(modules.length-1,1);modules.forEach(function(v){v in namespace||(namespace[v]={}),namespace=namespace[v]}),namespace[className[0]]=Class}}(this),Class.extend("Obj",{bind:function(event,callback,context,options){options=options||{},this.events=this.events||{},_.each(event.split(" "),function(event){this.events[event]=this.events[event]||[],this.events[event].push(_.extend({callback:callback,context:context},options))},this)},unbind:function(name,func){if(_.isFunction(name)&&_.isUndefined(func)&&(func=name,name=void 0),_.isString(name)&&_.isFunction(func))this.events&&_.each(name.split(" "),function(event){this.events[event]&&(this.events[event]=_.reject(this.events[event],function(e){return e.callback===func}))},this);else if(_.isString(name)&&_.isUndefined(func))this.events&&_.each(name.split(" "),function(event){this.events[event]&&delete this.events[event]},this);else if(_.isUndefined(name)&&_.isFunction(func))this.events&&_.each(this.events,function(value,key){this.events[key]=_.reject(this.events[key],function(e){return e.callback===func})},this);else{if(!_.isUndefined(name)||!_.isUndefined(func))throw"invalid parameters";this.events=null}},trigger:function(event){var args=Array.prototype.slice.call(arguments,1);this._logTriggerCalls&&logger.info("trigger",event,"on",this,"with parameters",args,this),
this.events&&(this.eachEvent(event,function(callback,context){callback.apply(context,args)}),this.eachEvent(event+":deferred",function(callback,context){_.defer(function(){callback.apply(context,args)})}))},eachEvent:function(name,callback){var once_callbacks=[];_.each(this.events[name],function(event,i){callback.call(this,event.callback,event.context||this),event.once&&once_callbacks.push(i)},this);for(var i=once_callbacks.length-1;i>=0;i--)this.events[name].splice(once_callbacks[i],1)},_instance_of:function(clazz){return this._class_name==clazz},_enableTriggerLogs:function(enable){_.isUndefined(enable)&&(enable=!0),this._logTriggerCalls=enable}}),Obj.extend("Listeners",{init:function(model){this.model=model,this.callbacks=[],this.name=null},getName:function(){if(null==this.name)for(var x in this.model)this.model[x]==this&&(this.name=x);return this.name},register:function(func,context){if(null!=context)throw"only one parameter supported";this.callbacks.push(func)},remove:function(func,context){if(null!=context)throw"only one parameter supported";this.callbacks.remove(func)},call:function(argus){var args=$.extend({},argus||{});this.callbacks.forEach(function(f){f.apply(window,[args])})},callWithouthParents:function(argus){var args=$.extend({},argus||{});args.model=this.model,this._call($.extend({},args))},callEach:function(argus){var args=$.extend({},argus||{});args.model=this.model,this._call($.extend({},args))},_call:function(args){var model=this.model;this.callbacks.forEach(function(f){args.caller=model,f.apply(window,[args])})}}),Obj.extend("Logger",{log:function(log){"undefined"!=typeof console&&void 0!==console.log&&($.browser.msie&&"8.0"==$.browser.version?console.log(this.join(arguments)):console.log.apply(console,arguments))},join:function(args){for(var ret="",cnt=0;cnt<args.length;cnt++)ret+=args[cnt],cnt<args.length-1&&(ret+=" ");return ret},raise:function(){throw"undefined"!=typeof console&&void 0!==console.error?console.error.apply(console,arguments):alert(this.join(arguments)),this.join(arguments)},warn:function(message){"undefined"!=typeof console&&void 0!==console.warn&&console.warn.apply(console,arguments)},info:function(message){"undefined"!=typeof console&&void 0!==console.info&&console.info.apply(console,arguments)},error:function(){"undefined"!=typeof console&&void 0!==console.error?console.error.apply(console,arguments):alert(this.join(arguments))},timeStart:function(){var d=new Date;this._time=6e4*d.getMinutes()+1e3*d.getSeconds()+d.getMilliseconds()},time:function(){var d=new Date,time=6e4*d.getMinutes()+1e3*d.getSeconds()+d.getMilliseconds();if("undefined"!=typeof console){var args=[].splice.call(arguments,0);args.splice(0,0,time-this._time);try{console.log.apply(console,args)}catch(e){}}}}),logger=new Logger,$(function(){var userAgent=a5.utils.parseUserAgent(),body=jQuery("body");for(key in userAgent)userAgent[key]&&body.addClass(key);userAgent.isIpadOS&&!a5.dp.config.IpadOSNotIOS&&body.addClass("isIOS"),$("body").mousedown(function(){$("body").addClass("mouse_pressed")}).mouseup(function(){$("body").removeClass("mouse_pressed")}).mouseleave(function(){$("body").removeClass("mouse_pressed")})});var a5={logger:{},components:{header_media:{}},model:{interaction:{}},view:{interaction:{},dialog:{}},parsers:{},models:{variable:{},item:{interaction:{choize:{}},response:{declaration:{}}},forms:{},options:{}},utils:{array:{}},service:{lms:{},media:{},scroll:{}},preprocessor:{},annotations:{},animations:{},dp:{}};a5.models.interaction={},a5.models.HighlightInteraction={},a5.views={},a5.views.interaction={},a5.model_builder={interaction:{}},a5.model_postBuilder={},function(a5,$,_){a5.Engine=function(){var _instance,Engine=function(params){if(_instance)return _instance;_instance=this,params=params||{},this._ready=$.Deferred(),a5.performance=new a5.PerformanceBenchmark,this._channel=params.channel,a5.eventBus.trigger("performance:engine_overhead:start"),a5.eventBus.bind("lo:ready",this._onReady,this),_.bindAll(this,"_loadConfig","_loadDP","_loadLayout","_init","_start","_initLRS","_initLMS","_initI18N","_setA5andLOInfo","_openVideo","_openAudio")};return _(Engine).extend({getInstance:function(){return _instance||new Engine},version:""}),_(Engine.prototype).extend({channel:function(){return this._channel},initialize:function(config){return this._loadConfig=_.partial(this._loadConfig,config),this._initialized=this._initialized||$.when().then(function(){a5.eventBus.trigger("performance:engine_config_load:start")}).then(this._loadConfig).then(function(){a5.eventBus.trigger("performance:engine_config_load:end"),a5.eventBus.trigger("performance:engine_dp_load:start")}).then(this._loadDP).then(function(){a5.eventBus.trigger("performance:engine_dp_load:end"),a5.eventBus.trigger("performance:engine_init_load:start")}).then(this._init).then(function(){a5.eventBus.trigger("performance:engine_init_load:end"),a5.eventBus.trigger("performance:engine_layout_load:start")}).then(this._loadLayout).then(function(){if(a5.eventBus.trigger("performance:engine_layout_load:end"),this.config.get("start_on_init"))return this._start()}.bind(this)),this._initialized},finalize:function(){return $.when().then(this._close)},start:function(){return $.when().then(this._start)},ready:function(){return this._ready.promise()},addEventListener:function(event,callback,context,options){a5.eventBus.bind(event,callback,context,options)},removeEventListener:function(name,func){a5.eventBus.unbind(name,func)},register:function(key,val){a5.registry[key]=val},lookup:function(key){return a5.registry[key]},invoke:function(key){var val=this.lookup(key);return _.isFunction(val)&&(val=val.apply(this,Array.prototype.slice.call(arguments,1))),val},isBook:function(){return"ebook"===this.config.get("type").toLowerCase()},isLO:function(){return"standard"===this.config.get("type").toLowerCase()},getBook:function(){return this.book=this.book||new a5.Book(this)},getLO:function(){return this.lo=this.lo||new a5.LearningObject(this)},getSize:function(){return{width:this.layout.width,height:this.layout.height}},openVideo:function(parameters){return $.when(parameters).then(this._openVideo)},openAudio:function(parameters){return $.when(parameters).then(this._openAudio)},_onReady:function(){this._ready.resolve()},_setA5andLOInfo:function(config){A5.LMS_NO_STORE=config.lms_no_store,A5.LMS_NO_RESTORE=config.lms_no_restore,A5.ENGINE_ROOT=config.engine_root,A5.SKIN_URL=config.skin_url,A5.SKIN_ROOT=config.skin_root,A5.SKIN_TYPE=config.skin_type,A5.TOOLBELT_URL=config.toolbelt_url,A5.START_TASK=config.start_task,A5.DEFAULT_SAVEAS_FILENAME=config.default_saveas_filename,A5.DICTIONARY_REF=config.dictionary_ref,A5.EXTERNAL_URL_BUILDER=config.external_url_builder,A5.LMS_CLOSE=!config.lms_no_close,A5.DEFAULT_PAGES_PER_SCREEN=config.book_pages_per_screen,A5.PAGES_PER_SCREEN_SOURCE=config.book_pages_per_screen_source,A5.LO_WITHOUT_CONTROLS=config.lo_without_controls,A5.LO_WITH_EXTERNAL_RESULT_SCREEN=config.lo_with_external_result_screen,A5.GEOGEBRA=config.geogebra,A5.MATHJAX=config.mathjax,A5.WIRIS_QUIZ_LIBRARY_RESOURCES_URL=config.wiris_quiz_library_resources_url,A5.WIRIS_QUIZ_VALIDATION_SERVICE_URL=config.wiris_quiz_validation_service_url,A5.ITEM_BANK_API_URL=config.item_bank_api_url,A5.CKEDITOR_FOLDER_PATH=config.ckeditor_folder_path,A5.PDFJS_FOLDER_PATH=config.pdfjs_folder_path,A5.JSCHANNEL_FOLDER_PATH=config.jschannel_folder_path,A5.REACT_BUNDLE_FOLDER_PATH=config.react_bundle_folder_path,A5.I18NEXT_FOLDER_PATH=config.i18next_folder_path,A5.LRS_ACTOR=config.lrs_actor,A5.LRS_ENDPOINT=config.lrs_endpoint,A5.LRS_AUTH=config.lrs_auth,A5.LRS_FETCH=config.lrs_fetch,A5.LRS_ACTIVITY_ID=config.lrs_activity_id,A5.LRS_REGISTRATION=config.lrs_registration,A5.BUDDY_CONFIG=config.buddyConfig,A5.ASSET_URL_BUILDER=config.asset_url_builder,window.LOInfo=config.LOInfo||{}},_initLMS:function(){var allAPIs=_.map(this.config.get("lms_apis").split(","),function(name){return new a5.service.lms[name+"API"](this)},this);return a5.service.lms.foundAPIs=_(allAPIs).chain().filter(function(api){return api.hasAPI()}).value(),logger.info("LMS APIs tested: ",_.map(allAPIs,function(a){return a._class_name.substring(15)}).join(", ")),logger.info("LMS APIs found: ",_.map(a5.service.lms.foundAPIs,function(a){return a._class_name.substring(15)}).join(", ")),a5.service.lms.API=new a5.service.lms.APIFacade(new a5.service.lms.MultiAPI(a5.service.lms.foundAPIs),!this.config.get("lms_no_store"),!this.config.get("lms_no_restore")),a5.service.lms.hasAPI=function(API){return _.find(a5.service.lms.foundAPIs,function(api){return api._class_name.substring(15)==API})},a5.service.lms.API.start()},_initLRS:function(){var lmsApis=this.config.get("lms_apis").split(",");if(_.contains(lmsApis,"TinCan"))return this.invoke("init-lrs",{endpoint:this.config.get("lrs_endpoint")})},_initConverter:function(){a5.service.converter=this.invoke("init-external-converter")||new a5.service.Toolbelt},_initAudio:function(){a5.service.media.audio=new a5.service.media.audio_manager.Creator({urlBuilder:this.config.get("audio_url_builder"),preferOga:this.config.get("audio_format_prefer_oga"),formats:this.config.get("audio_formats"),debug:this.config.get("debug")}),$(window).on("unload",function(){a5.service.media.audio.pauseAll()})},_initVideo:function(){a5.service.media.video=new a5.service.media.video_manager.Creator({urlBuilder:this.config.get("video_url_builder"),preferWebm:this.config.get("video_format_prefer_webm"),formats:this.config.get("video_formats")}),$(window).on("unload",function(){a5.service.media.video.pauseAll()})},_initTTS:function(){a5.service.media.tts_audio=new a5.service.media.tts_audio_manager.Creator({urlBuilder:this.config.get("tts_audio_url_builder")})},_initToolbelt:function(){a5.service.toolbelt=new a5.service.Toolbelt},_initSTT:function(){a5.service.media.stt=new a5.service.media.SpeechToText},_initTemplateService:function(){return $.when(this.invoke("platform-data")).then(function(platformData){a5.service.templates=new a5.service.Templates({globals:{platformData:platformData},dp:this.dp})}.bind(this))},_initBuilders:function(){var builders=["Anchor","PPEbookBuilder","PPAudioBook","ICDialogueRecording","ISHangman"];_.each(builders,function(builder){a5.model_builder.builders.push(new a5.model_builder[builder](this))},this)},_initRecorder:function(){a5.service.media.audio_recorder=new a5.service.media.recorder_manager.AudioRecorder(this)},_initSpecialChars:function(){window.CATspecialChars={},window.CATspecialChars.French=["&#192;","&#224;","&#194;","&#226;","&#198;","&#230;","&#199;","&#231;","&#201;","&#233;","&#200;","&#232;","&#202;","&#234;","&#203;","&#235;","&#206;","&#238;","&#207;","&#239;","&#212;","&#244;","&#338;","&#339;","&#217;","&#249;","&#219;","&#251;","&#220;","&#252;","&#376;","&#255;"],window.CATspecialChars.Spanish=["&#193;","&#225;","&#201;","&#233;","&#205;","&#237;","&#211;","&#243;","&#218;","&#250;","&#220;","&#252;","&#209;","&#241;","&#191;","&#161;"],window.CATspecialChars.German=["&#196;","&#228;","&#214;","&#246;","&#220;","&#252;","&#223;"],window.CATspecialChars.Ancient_Greek=["&#913;","&#945;","&#925;","&#957;","&#914;","&#946;","&#926;","&#958;","&#915;","&#947;","&#927;","&#959;","&#916;","&#948;","&#928;","&#960;","&#917;","&#949;","&#929;","&#961;","&#918;","&#950;","&#931;","&#963;","&#962;","&#919;","&#951;","&#932;","&#964;","&#920;","&#952;","&#933;","&#965;","&#921;","&#953;","&#934;","&#966;","&#922;","&#954;","&#935;","&#967;","&#923;","&#955;","&#936;","&#968;","&#924;","&#956;","&#937;","&#969;"],window.CATspecialChars.Scientific_Characters=["&#8652;","&#8592;","&#8594;","&#91;","&#93;","&#40;","&#41;","&#43;","&#8722;","&#247;","&#215;","&#177;","&#8805;","&#62;","&#60;","&#8804;","&#8734;","&#176;","&#8212;","&#8801;","&#61;","&#948;&#43;","&#948;&#8722;","&#10677;","&#8733;","&#8730;"],window.CATspecialChars.Arithmetic_Operators=["&#43;","&#8758;","&#8226","&#8722;","&#60;","&#62;","&#61;","&#8539;","&#188;","&#189;","&#190;"],window.CATspecialChars.Swedish=["&#197;","&#229"],window.CATspecialChars.Danish=["&#197;","&#229","&#198","&#230","&#216","&#248"],window.CATspecialChars.Polish=["&#380;","&#347","&#243","&#321","&#322","&#261","&#324","&#263","&#378","&#281"],window.CATspecialChars.Turkish=["&#286;","&#287","&#304","&#305","&#350","&#351","&#199","&#231"]},_startSizeObserver:function(){$(window).on("resize",function(){this.layout.checkSize()}.bind(this)),a5.eventBus.bind("interaction:show",function(interaction){this.layout.checkSize(),interaction.bind("screen_transition:end",function(){this.layout.checkSize()},this,{once:!0})},this)},_loadConfig:function(externalConfig){return this.config=new a5.Config,this.config.load(externalConfig).then(this._setA5andLOInfo)},_loadDP:function(){var dpOptions={path:this.config.get("skin_url"),enginePath:this.config.get("engine_root"),development:this.config.get("debug")};return this.dp="git"===this.config.get("skin_type")?new a5.GitDesignPack(dpOptions):new a5.DesignPack(dpOptions),this.dp.preload(),this.dp.load()},_loadLayout:function(){return this.layout=new a5.Layout({dp:this.dp,engine:this}),this.layout.load()},_initPostMessager:function(){a5.service.postMessager=new a5.service.PostMessager},_initLibraryLoader:function(){a5.service.libraryLoader=new a5.service.ExternalLibraryLoader},_initReactEngineInterface:function(){a5.service.reactEngineInterface=new a5.service.React.EngineInterface},_initI18N:function(){var language=this.config.get("language");if(language&&_.contains(a5.dp.config.languageAvailable,language)||(language=a5.dp.config.languageDefault),language){var libs=[a5.service.libraryLoader.LIBRARY_FILES.I18NEXT];return $.when(a5.service.libraryLoader.load(libs)).then(function(){logger.log(libs.join(",")+" loaded.");var ns="translation";return a5.dp.config.translationAsJSONP?this._initI18NextByJSONP(language,ns):this._initI18NextByXHR(language,ns)}.bind(this)).fail(function(){logger.error("couldn't load: "+libs.join(","))})}},_initI18NextByXHR:function(language,ns){var deferred=$.Deferred();return i18next.use(i18nextXHRBackend).init({lng:language,fallbackLng:!1,defaultNS:ns,backend:{crossDomain:!0,loadPath:this.config.get("languages_path")+"{{lng}}/{{ns}}.json"}},function(err){err&&logger.error(err),deferred.resolve()}),deferred.promise()},_initI18NextByJSONP:function(language,ns){var deferred=$.Deferred(),deferredResources=$.Deferred();i18next.init({lng:language,fallbackLng:!1,defaultNS:ns,resources:{}},function(err){err&&logger.error(err),deferred.resolve()}),a5.setTranslation=function(language,translation){i18next.addResourceBundle(language,ns,translation,!0,!0)};var file=this.config.get("languages_path")+language+"/"+ns+".js",doneCallback=function(){a5.setTranslation=null,deferredResources.resolve()},errorCallback=function(val){logger.error("error loading jsonp ",val)};return a5.getScript(file,doneCallback,errorCallback),$.when(deferred,deferredResources)},_init:function(){return $.when().then(this._initLRS).then(this._initLMS).then(function(){this._initAudio(),this._initVideo(),this._initTTS(),this._initToolbelt(),this._initSTT(),this._initBuilders(),this._initRecorder(),this._initPostMessager(),this._initLibraryLoader(),this._initReactEngineInterface(),this._initSpecialChars(),this._initConverter()}.bind(this)).then(this._initI18N).then(function(){this._initTemplateService()}.bind(this))},_start:function(){a5.mainBuilder=new a5.MainBuilder,a5.mainBuilder.engine=this,a5.mainBuilder.layout=this.layout,a5.mainBuilder.metadata=this.config.get("metadata")||new a5.models.Metadata;var screens=this.config.get("screens");_(screens).each(function(scr){a5.mainBuilder.addInteraction(scr.name,scr.preview,scr.helpText,scr.resources)}),this._startSizeObserver(),a5.mainBuilder.start(),a5.eventBus.trigger("performance:engine_overhead:end")},_close:function(){a5.mainBuilder&&a5.mainBuilder.close()},_openVideo:function(parameters){$("body").removeClass("standalone-video standalone-audio"),a5.service.media.video.pauseAll(),a5.service.media.audio.pauseAll();var deferred=$.Deferred(),view=new a5.view.Video({layout:this.layout,ref:parameters.ref,subtitles:parameters.subtitles,transcript:parameters.transcript});return $("body").addClass("standalone-video"),$("#content_wrap").html(view.$el),view.bind("ready",function(){this.layout.checkSize(),deferred.resolve()}.bind(this)),view.render(),deferred.promise()},_openAudio:function(parameters){$("body").removeClass("standalone-video standalone-audio"),a5.service.media.video.pauseAll(),a5.service.media.audio.pauseAll();var deferred=$.Deferred(),view=new a5.view.Audio({layout:this.layout,ref:parameters.ref,subtitles:parameters.subtitles,transcript:parameters.transcript});return $("body").addClass("standalone-audio"),$("#content_wrap").html(view.$el),view.bind("ready",function(){this.layout.checkSize(),deferred.resolve()}.bind(this)),view.render(),deferred.promise()}}),Engine}()}(a5,jQuery,_),function(a5,$,_){a5.Book=function(){var Book=function(engine){this.engine=engine,_.bindAll(this,"_openPage","_openTOC","_closeTOC","_bookmark","_unbookmark","_sendBack","_bringFront")};return _(Book.prototype).extend({ready:function(){return this.engine.ready()},close:function(){return this.engine.finalize()},setProperties:function(properties){this.model=properties.model,this.view=properties.view},addEventListener:function(event,callback,context,options){this.engine.addEventListener("book:"+event,callback,context,options)},removeEventListener:function(name,func){this.engine.removeEventListener("book:"+name,func)},register:function(key,val){this.engine.register("book:"+key,val)},lookup:function(key){return this.engine.lookup("book:"+key)},invoke:function(key){return this.engine.invoke("book:"+key)},openPage:function(page){return $.when(page).then(this._openPage)},getCurrentPage:function(){return this.model.getCurrentPageNumber()},openTOC:function(){return $.when().then(this._openTOC)},closeTOC:function(){return $.when().then(this._closeTOC)},getBookmarks:function(){return this.model.getBookmarks()},unbookmark:function(page){return $.when(page).then(this._unbookmark)},bookmark:function(page,text){return $.when(page,text).then(this._bookmark)},getNotes:function(){return this.model.getNotes()},sendBack:function(){return $.when().then(this._sendBack)},bringFront:function(){return $.when().then(this._bringFront)},addFileHotspot:function(page,options){this.view.addFileHotspot(page,options)},setPagesPerScreen:function(pagesPerScreen){this.model.setPagesPerScreen(pagesPerScreen)},getPagesPerScreen:function(){return this.model.getPagesPerScreen()},resourcePanelMode:function(mode){if(!_.isUndefined(mode)){var oldMode=this.model.resourcePanelMode;this.model.resourcePanelMode=mode,this.model.trigger("change:resourcePanelMode",{oldMode:oldMode,newMode:mode})}return this.model.resourcePanelMode},toggleFullscreen:function(fullscreen){this.view.toggleFullscreen(fullscreen)},pauseMedia:function(){a5.service.media.pauseAll()},getSize:function(){return this.engine.getSize()},getPages:function(){return this.model.serializePages()},_openPage:function(page){this.model.openPageNumber(page)},_openTOC:function(){this.view.openToc()},_closeTOC:function(){this.view.closeToc()},_unbookmark:function(page){this.model.unbookmark(page)},_bookmark:function(page,text){this.model.bookmark(page,text)},_sendBack:function(){this.view.sendBack()},_bringFront:function(){this.view.bringFront()}}),Book}()}(a5,jQuery,_),function(a5,$,_){a5.LearningObject=function(){var LearningObject=function(engine){this.engine=engine,_.bindAll(this,"_goNext","_goPrev","_goToExerciseScreen","_goToResultScreen","_submit","_sendScores","_checkAnswer","_showAnswer","_revealAllAnswers","_revealNextAnswer","_revealObject","_hideObject")};return _(LearningObject.prototype).extend({ready:function(){return this.engine.ready()},close:function(){return this.engine.finalize()},addEventListener:function(event,callback,context,options){this.engine.addEventListener(event,callback,context,options)},removeEventListener:function(name,func){this.engine.removeEventListener(name,func)},register:function(key,val){this.engine.register(key,val)},lookup:function(key){return this.engine.lookup(key)},invoke:function(key){return this.engine.invoke(key)},getCurrentInteraction:function(){return a5.mainBuilder.getCurrentInteraction().visibleIndex},getCurrentScreen:function(){return a5.mainBuilder.getCurrentInteraction().visibleIndex+(a5.mainBuilder.hasIntroScreen()?1:0)},currentScreen:function(){return this.getCurrentScreen()},goNext:function(){return $.when().then(this._goNext)},goPrev:function(){return $.when().then(this._goPrev)},goToExerciseScreen:function(){return $.when().then(this._goToExerciseScreen)},reviewAnswers:function(){return this.goToExerciseScreen()},goToResultScreen:function(){return $.when().then(this._goToResultScreen)},showResults:function(){return this.goToResultScreen()},getNumberOfInteractions:function(){return a5.mainBuilder.getNumberOfInteractions()},getNumberOfScreens:function(){return a5.mainBuilder.getNumberOfInteractions()+(a5.mainBuilder.hasIntroScreen()?1:0)},totalScreens:function(){return this.getNumberOfScreens()},submit:function(){return $.when().then(this._submit)},sendScores:function(){return $.when().then(this._sendScores)},checkAnswer:function(){return $.when().then(this._checkAnswer)},checkAnswers:function(){return this.checkAnswer()},showAnswer:function(){return $.when().then(this._showAnswer)},showAnswers:function(){return this.showAnswer()},revealAllAnswers:function(){return $.when().then(this._revealAllAnswers)},revealNextAnswer:function(){return $.when().then(this._revealNextAnswer)},revealObject:function(){return $.when().then(this._revealObject)},hideObject:function(){return $.when().then(this._hideObject)},pauseMedia:function(){a5.service.media.pauseAll()},getSize:function(){return this.engine.getSize()},getControlsStatus:function(buttonId){return a5.mainBuilder.controls.getStatus(buttonId)},getAvailableFontSizes:function(){return a5.mainBuilder.getAvailableFontSizes()},getDefaultFontSize:function(){return a5.mainBuilder.getDefaultFontSize()},getCurrentFontSize:function(){return a5.mainBuilder.getCurrentFontSize()},setFontSize:function(size){a5.mainBuilder.setFontSize(size)},resetFontSize:function(){a5.mainBuilder.resetFontSize()},setFontFamily:function(family){a5.mainBuilder.setFontFamily(family)},resetFontFamily:function(family){a5.mainBuilder.resetFontFamily(family)},openNotes:function(){a5.mainBuilder.openNotes()},closeNotes:function(){a5.mainBuilder.closeNotes()},getNotes:function(){return a5.mainBuilder.note},_goNext:function(){a5.mainBuilder.hasNext()&&a5.mainBuilder.goNext()},_goPrev:function(){a5.mainBuilder.hasPrev()&&a5.mainBuilder.goPrev()},_goToExerciseScreen:function(){a5.mainBuilder.goToExerciseScreen()},_goToResultScreen:function(){a5.mainBuilder.goToResultScreen()},_submit:function(){return a5.mainBuilder.submit()},_sendScores:function(){return a5.mainBuilder.sendScores()},_checkAnswer:function(){a5.mainBuilder.checkAnswer()},_showAnswer:function(){a5.mainBuilder.showAnswer()},_revealAllAnswers:function(){a5.mainBuilder.showAllAnswer()},_revealNextAnswer:function(){a5.mainBuilder.showNextAnswer()},_revealObject:function(){a5.mainBuilder.reveal()},_hideObject:function(){a5.mainBuilder.hideRevealed()}}),LearningObject}()}(a5,jQuery,_),function(a5,$,_){window.A5||(A5={}),window.LOInfo||(LOInfo={}),a5.Config=function(){var _getURLParameter=function(name){name=name.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?&]"+name+"=([^&#]*)"),results=regex.exec(location.search);return null==results?"":decodeURIComponent(results[1].replace(/\+/g," "))},Config=function(){this.config={},this.config.start_on_init=!0,this.config.lms_apis="Scorm,Author,Console",this.config.lms_no_store=!1,this.config.lms_no_restore=!1,this.config.lms_no_close=!1,this.config.toolbelt_url="//toolbelt-test.avallain.com",this.config.default_saveas_filename="StudentUserName_CourseName_Topic",this.config.asset_url_builder=function(id){return id},this.config.audio_url_builder=this.config.video_url_builder=function(id,format){return"media/"+id+"."+format},this.config.external_url_builder=null,this.config.tts_audio_url_builder=function(lang,speaker,text){return a5.config.get("tts_audio_service_url")+"?lang="+encodeURIComponent(lang)+"&speaker="+encodeURIComponent(speaker)+"&text="+encodeURIComponent(text)},this.config.tts_audio_service_url="http://www.writeon.ie/speaktext.do",this.config.tts_audio_lang="en",this.config.tts_audio_voice="Acapela Telecom HQ TTS English (UK) (Rachel 22 kHz)",this.config.audio_formats="mp3,oga",this.config.video_formats="webm,mp4",this.config.debug=!1,this.config.skin_type="classic",this.config.type="Standard",this.config.book_pages_per_screen=2,this.config.book_pages_per_screen_source="default",this.config.lo_without_controls=!1,this.config.geogebra="//author-engine-production.avallain.net/geogebra/v5/HTML5/5.0/web/",this.config.mathjax="//author-engine-production.avallain.net/mathjax/2.7.1",this.config.wiris_quiz_library_resources_url="//author-engine-production.avallain.net/wirisquiz/3.52.0/resources",this.config.wiris_quiz_validation_service_url="",this.config.item_bank_api_url="https://api-avallain-author-dev.avallain.net/api/v2/items_bank_items_for_engine",this.config.ckeditor_folder_path="lib/third-party/ckeditor_4.5.7/",this.config.pdfjs_folder_path="lib/third-party/pdfjs/",this.config.jschannel_folder_path="lib/third-party/jschannel/",this.config.i18next_folder_path="lib/third-party/i18next/",this.config.LOInfo={},_.bindAll(this,"_merge","_loadLearningObjectInfoConfig")};return Config.prototype.get=function(key){return this.config[key]},Config.prototype.set=function(key,value){this.config[key]=value},Config.prototype.load=function(external){var authorConfig=this._loadAuthorConfig(),urlConfig=this._loadURLConfig(),externalConfig=this._loadExternalConfig(external),learningObjectConfig=this._loadLearningObjectInfoConfig();return $.when.apply(this,[learningObjectConfig,authorConfig,externalConfig,urlConfig]).then(this._merge)},Config.prototype._merge=function(learningObjectConfig,authorConfig,externalConfig,urlConfig){if(_.extend(this.config,learningObjectConfig,authorConfig,externalConfig,urlConfig),!this.config.lms_apis.match(/Dummy/gi)){var lms_apis=_.compact(this.config.lms_apis.split(","));lms_apis.push("Dummy"),this.config.lms_apis=lms_apis.join(",")}this.config.engine_root&&this.config.engine_root.replace(/http(s)*:/,""),this.config.toolbelt_url&&(this.config.toolbelt_url.replace(/http(s)*:/,""),this.config.toolbelt_url=("https:"===window.location.protocol?"https:":"http:")+this.config.toolbelt_url);var startTask=parseInt(this.config.start_task,10);_.isNaN(startTask)?this.config.start_task=void 0:this.config.start_task=startTask,this.config.skin_url&&_.isUndefined(this.config.skin_root)&&(this.config.skin_root=this.config.skin_url),this.config.react_bundle_folder_path||(this.config.react_bundle_folder_path=this.config.engine_root),this.config.tts_build_token=function(text){return a5.sha1hex(text+"4e042af043922a2b7025573e637722ca").replace(/^0+/,"")},this.config.tts_audio_url_builder=_.bind(function(text){var speaker=this.config.tts_audio_voice,token=this.config.tts_build_token(text);return this.config.tts_audio_service_url+"?speaker="+encodeURIComponent(speaker)+"&text="+encodeURIComponent(text)+"&token="+encodeURIComponent(token)},this),/http(s)*:/.test(window.location.protocol)&&_(["audio_url_builder","video_url_builder","tts_audio_url_builder","external_url_builder","asset_url_builder"]).each(function(fn){var oldFn=this.config[fn];_.isFunction(oldFn)&&(this.config[fn]=function(){var ret=oldFn.apply(this,arguments)||"";return logger.log("Sanitized "+ret+" url to avoid mixed content warnings."),ret.replace(/http(s)*:/,"")})},this);var audioFormats=this.config.audio_formats.split(",");this.config.audio_formats=_.invoke(audioFormats,"trim");var videoFormats=this.config.video_formats.split(",");this.config.video_formats=_.invoke(videoFormats,"trim");var book_pages_per_screen=parseInt(this.config.book_pages_per_screen,10);return _.isNaN(book_pages_per_screen)?this.config.book_pages_per_screen=void 0:this.config.book_pages_per_screen=book_pages_per_screen,this.config.languages_path||(this.config.languages_path=this.config.skin_url+"locales/"),this.config},Config.prototype._loadLearningObjectInfo=function(){return(new a5.utils.Loader).load("LearningObjectInfo.xml")},Config.prototype._parseLearningObjectInfo=function(data){var config={};try{var xml=$.parseXML(data.text),$lo=$(xml).find("LearningObjectInfo"),$screens=$lo.find("screens > screen"),$engine=$lo.find("engine"),$dp=$lo.find("designPack");config.lms_apis=$lo.find("lmsApis").text()||void 0,config.engine_root=$engine.find("root").text()||void 0,config.skin_type=$dp.find("type").text()||void 0,config.skin_url=$dp.find("root").text()||void 0,config.type=$lo.find("> type").text()||void 0,$lo.find("toolbeltServer").text()&&(config.toolbelt_url="//"+$lo.find("toolbeltServer").text());var lnrCDNURL=$lo.find("lnrCDNURL").text(),assetCDNURL=$lo.find("assetCDNURL").text();assetCDNURL&&(lnrCDNURL&&(config.audio_url_builder=function(id,format){return(0===id.indexOf("r5_")?lnrCDNURL:assetCDNURL)+"/"+id+"."+format},config.video_url_builder=function(id,format){return assetCDNURL+"/"+id+"."+format}),config.asset_url_builder=function(id){return id?(/^https?:\/\/|^\/\//i.test(id)?"":assetCDNURL+"/")+id:""});var tts={};try{tts=JSON.parse($lo.find("tts"))}catch(e){}config.tts_audio_service_url=tts.TTS_AUDIO_SERVICE_URL,config.tts_audio_voice=tts.TTS_AUDIO_VOICE;var audioFormats=$lo.find("audio").text(),videoFormats=$lo.find("video").text();audioFormats&&(config.audio_formats=audioFormats),videoFormats&&(config.video_formats=videoFormats),config.LOInfo={UID:$lo.find("UID").text(),ID:$lo.find("ID").text(),title:$lo.find("> title").text(),mode:$lo.find("mode").text(),LOOptions:$lo.find("LOOptions").text()};var metadata=new a5.models.Metadata;metadata.load($lo),config.metadata=metadata,config.screens=[],$screens.each(function(index,screenNode){var $screenNode=$(screenNode),screenName=$screenNode.find("> name").text(),screenHelpText=$screenNode.find("> helpText").text(),resources=$screenNode.find("> resources > resource").map(function(_,res){var $res=$(res);return{identifier:$res.find("> identifier").text(),rights:$res.find("> rights").text()}}).get();(screenName||screenHelpText||resources.length)&&config.screens.push({name:screenName,preview:$screenNode.find("> previewImageFullPath").text(),helpText:screenHelpText,resources:resources})})}catch(e){logger.warn("invalid LearningObjectInfo.xml")}return config=_(config).omit(function(value,key){return _.isUndefined(value)})},Config.prototype._loadLearningObjectInfoConfig=function(){var deferred=$.Deferred();return $.when().then(this._loadLearningObjectInfo).then(this._parseLearningObjectInfo).done(function(config){deferred.resolve(config)}).fail(function(){deferred.resolve({})}),deferred.promise()},Config.prototype._loadExternalConfig=function(external){external=external||{};var config=external,xmlList=external.xmls;return xmlList&&(config.screens=_(xmlList).map(function(xml){return{name:decodeURIComponent(xml),preview:!1}})),config=_(config).omit(function(value,key){return _.isUndefined(value)})},Config.prototype._loadAuthorConfig=function(author){author=author||A5;var config={};return config.lms_apis=author.LMS_APIS,config.lms_no_store=author.LMS_NO_STORE,config.lms_no_restore=author.LMS_NO_RESTORE,config.engine_root=author.ENGINE_ROOT,config.skin_type=author.SKIN_TYPE,config.skin_url=author.SKIN_URL,config.skin_root=author.SKIN_ROOT,config.toolbelt_url=author.TOOLBELT_URL,config.default_saveas_filename=author.DEFAULT_SAVEAS_FILENAME,config.asset_url_builder=author.ASSET_URL_BUILDER,config.audio_url_builder=author.AUDIO_URL_BUILDER,config.video_url_builder=author.VIDEO_URL_BUILDER,
config.external_url_builder=author.EXTERNAL_URL_BUILDER,config.tts_audio_url_builder=author.TTS_AUDIO_URL_BUILDER,config.tts_audio_service_url=author.TTS_AUDIO_SERVICE_URL||window.LOInfo.TTS_AUDIO_SERVICE_URL,config.tts_audio_lang=author.TTS_AUDIO_LANG,config.tts_audio_voice=author.TTS_AUDIO_VOICE||window.LOInfo.TTS_AUDIO_VOICE,config.audio_formats=author.AUDIO_FORMATS,config.video_formats=author.VIDEO_FORMATS,config.debug=!!author.DEBUG,config.start_task=author.START_TASK,config.book_pages_per_screen=author.DEFAULT_PAGES_PER_SCREEN,config.lo_without_controls=author.LO_WITHOUT_CONTROLS,config.geogebra=author.GEOGEBRA,config.mathjax=author.MATHJAX,config.wiris_quiz_library_resources_url=author.WIRIS_QUIZ_LIBRARY_RESOURCES_URL,config.wiris_quiz_validation_service_url=author.WIRIS_QUIZ_VALIDATION_SERVICE_URL,config.item_bank_api_url=author.ITEM_BANK_API_URL,config.ckeditor_folder_path=author.CKEDITOR_FOLDER_PATH,config.react_bundle_folder_path=author.REACT_BUNDLE_FOLDER_PATH,config.i18next_folder_path=author.I18NEXT_FOLDER_PATH,config.language=author.LANGUAGE,config.languages_path=author.LANGUAGES_PATH,config.book_pages_per_screen&&(config.book_pages_per_screen_source="author"),_.isEmpty(window.LOInfo)||(config.LOInfo=window.LOInfo),config=_(config).omit(function(value,key){return _.isUndefined(value)})},Config.prototype._loadURLConfig=function(){var config={};config.lms_apis=_getURLParameter("a5_lms_api"),config.lms_no_store="false"===_getURLParameter("a5_store"),config.lms_no_restore="false"===_getURLParameter("a5_restore"),config.lms_no_close="false"===_getURLParameter("a5_lms_close"),config.dictionary_ref=_getURLParameter("a5_dictionary_ref"),config.audio_format_prefer_oga="oga"===_getURLParameter("a5_audio_format_prefer"),config.video_format_prefer_webm="webm"===_getURLParameter("a5_video_format_prefer"),config.start_task=_getURLParameter("a5_start_task"),config.book_pages_per_screen=_getURLParameter("a5_book_pages_per_screen"),config.lo_without_controls="true"===_getURLParameter("lo_without_controls"),config.buddyConfig=_getURLParameter("buddy"),config.language=_getURLParameter("language"),config.book_pages_per_screen&&(config.book_pages_per_screen_source="url");var xmlList=_getURLParameter("xmlList");return xmlList&&(config.screens=_(xmlList.split(",")).map(function(xml){return{name:decodeURIComponent(xml),preview:!1}})),config.skin_url=_getURLParameter("package"),config.lrs_endpoint=_getURLParameter("endpoint"),config=_(config).omit(function(value,key){return!value})},Config}()}(a5,jQuery,_),function($){a5.dp.config={allowLOSelfClosing:!1,allowPauseRecordings:!0,annotationsDefaultTool:"pointer",annotationsKeepPaletteOpen:!1,annotationsUseRealEraser:!1,appendAttachmentTo:!1,appendCountdownTo:!1,appendFeedbackTo:!1,appendHintsTo:!1,appendHelpTextTo:!1,appendOfflineTextTo:!1,appendTeamScoreTo:!1,audioPreloadDisabled:!1,audioTinyPlayerPlayspeedButton:.5,audioVolumeStore:!0,audioUseNativeControls:!1,avatarAutostartDisabled:!1,avatarHideWhenHintsOff:!1,avatarSupport:!1,avatarUrlBuilder:function(id,fmt){return a5.mainBuilder.layout.packageURL+id+"."+fmt},bookAnnotationsLanguage:"en",bookAnnotationsToolbarAppendTo:".ebook .toolbar .tools.btn",bookAnnotationsToolbarAsPopup:!0,bookAnnotationsToolbarDragOnlyFromHandle:!1,bookAnnotationsToolbarInsideBounds:!1,bookAnnotationsToolbarPosition:!1,bookBookmarkMultiple:!1,bookCountdownTime:"00:20:00",bookDialogModal:!0,bookExternalFullscreen:!1,bookHotspotPopupModal:!0,bookKeyboardPanStep:20,bookNotesAsTabPanel:!1,bookNotesEditor:!1,bookNotesExportFormats:"rtf",bookPanelsType:"dialog",bookShowCurrentPagePlaceholder:!1,bookStickyNoteMinSize:!1,bookStickyNoteWithTitle:!1,bookTooltipDelay:1e3,bookTooltipDuration:4e3,bookZoomMarqueeClick:50,bookZoomMax:!1,bookZoomMin:!1,bookZoomPreserve:!0,bookZoomSinglePage:!1,bookZoomPinchStep:5,bookZoomStep:20,bookZoomWheelStep:5,boxdropAnswersPosition:!1,catchGameMovementSpeed:0,closeLOAfterSubmit:!1,colouringOpacity:1,confirmBeforeClose:!1,confirmBeforeSubmit:"if-unanswered",contentSize:function(){return{width:$(document).width(),height:$(document).height()}},continuousEnumerationInsideGaps:!1,displayAllScreens:!1,displayFeedbackAfterSeeAnswer:!1,draggableHotspotWindow:!1,draggableOptions:{},drawRectLinkLines:!1,droppableToleranceRadius:30,dropdownNativeSelect:!1,exclusionBottom:0,exclusionTop:0,forceCorrectedAfterSubmitAttempts:!1,feedbackClickToggle:!1,flashfirstanswerDefaultDuration:1500,fontSizeDefault:!1,fontSizeSteps:!1,forwardConfirmation:!1,gapfillBehaviourApplicable:"all",hideSingleColorMarkButtons:!1,ICTextgapActive:!0,IMProofingSignalDuration:2e3,imVoiceTimelimit:30,IpadOSNotIOS:!1,isRadiobuttonVoiceTimelimit:30,keepDragElementInsideContentZone:!0,languageDefault:!1,languageAvailable:[],linkingLinesAnswersCorrectColor:null,linkingLinesAnswersCorrectStyle:"solid",linkingLinesAnswersWrongColor:null,linkingLinesAnswersWrongStyle:"solid",linkingLinesColors:null,linkingLinesContainedEvents:!1,linkingLinesDefaultColor:null,linkingLinesFeedbackCorrectColor:null,linkingLinesFeedbackCorrectStyle:"solid",linkingLinesFeedbackWrongColor:null,linkingLinesFeedbackWrongStyle:"solid",linkingLinesLineWidth:null,linkingLinesPrefillColor:null,linkingLinesPrefillStyle:"solid",linkingLinesPreserveColorAfterCorrect:!1,linkingLinesTouchDirection:[0,1],linkingLinesTouchDuration:1e3,linkingLinesUnattemptedColor:null,linkingLinesUnattemptedStyle:"solid",linkingMultipleLinesAnswersCorrectColor:null,linkingMultipleLinesAnswersCorrectStyle:"solid",linkingMultipleLinesAnswersHoverColor:null,linkingMultipleLinesAnswersWrongColor:null,linkingMultipleLinesAnswersWrongStyle:"dotted",linkingMultipleLinesDefaultColor:null,linkingMultipleLinesFeedbackCorrectColor:null,linkingMultipleLinesFeedbackCorrectStyle:"solid",linkingMultipleLinesFeedbackWrongColor:null,linkingMultipleLinesFeedbackWrongStyle:"dotted",linkingMultipleLinesHoverColor:null,linkingMultipleLinesLineWidth:null,linkingMultipleLinesPrefillColor:null,linkingMultipleLinesPrefillStyle:"solid",linkingMultipleLinesPreserveColorAfterCorrect:!1,linkingMultipleLinesUnattemptedColor:null,linkingMultipleLinesUnattemptedStyle:"solid",linkingMultipleLinesSeeNextAnswerColor:null,linkingMultipleLinesSeeNextAnswerStyle:null,linkingSelectionAreaEnabled:!1,loadScreensOnDemand:!1,loNotesEditor:!1,markableActsAsToggle:!1,markingDefaultColors:{$default:["#A30000","#365403","#575700","#005F61","#9E0086","#6D524A"]},markingLetterDialogEnabled:!1,mathsGapDefaultWidth:100,mediaAreaFixedInView:!1,metadataAsCssClasses:!1,mobileBreakpoint:0,mousewheelActsAsPan:!1,multipleOpenAttachments:!0,multipleResourceMaximum:10,nonModalDialogs:[],ompairsNew:!1,omTextGapLabelAnObjectAutoscaling:!1,ossortingCloneCss:!0,ossequenceTransitionDelay:0,pelmanismFailedPairTime:2e3,pelmanismShowAnswerDelay:1e3,positionedTranscript:!0,postMessageUIManagement:!1,ppslideshowDelay:6,ppslideshowEndingTime:.4,ppslideshowMagnifyEnd:"70%",ppslideshowMagnifyStart:"50%",ppslideshowMaxTime:10,ppslideshowMinTime:2,ppslideshowStep:1,protectBookPages:!1,protectImages:!1,reactActivitiesEnabled:!1,reactActivities:["Input:Completion:Crossword"],referenceOpenInTab:!1,resetCheckAttemptsAfterSkipScreen:!1,responsiveAttachments:!1,responsiveSupplements:!1,revealHideAlwaysVisible:!1,screenTransitionDuration:1e3,screenTransitionEnabled:!1,screenTransitionStart:function($from,$to){},screenTransitionEnd:function($from,$to){},showActivityFeedbackAfterSeeAnswersBeforeInteraction:!1,skipDialogs:!1,snakeFont:"italic 20px Georgia",snakeHeight:0,snakeHorizontalSpread:100,snakeSpace:18,snakeVerticalMax:60,snakeVerticalMin:20,snakeWidth:0,specificFeedbackAuto:!1,specificFeedbackDiv:!1,teamScoringDelay:2e3,translationAsJSONP:!1,videoActivityTimeout:2e3,videoUseNativeControls:!1,wordsearchCellSize:32,wordsearchCheckmarks:!1},Object.defineProperty(a5.dp.config,"tooltipClearance",{set:function(obj){logger.warn("Deprecated 'tooltipClearance' option used. Not needed anymore")}}),Object.defineProperty(a5.dp.config,"snake",{set:function(obj){logger.warn("Deprecated 'snake' object. Use flat properties instead (snakeSpace, snakeWidth, snakeHeight, snakeFont)"),obj.space&&(a5.dp.config.snakeSpace=obj.space),obj.width&&(a5.dp.config.snakeWidth=obj.width),obj.height&&(a5.dp.config.snakeHeight=obj.height),obj.font&&(a5.dp.config.snakeFont=obj.font)}}),Object.defineProperty(a5.dp.config,"ppslideshowOptions",{set:function(obj){logger.warn("Deprecated 'ppslideshowOptions' object. Use flat properties instead (ppslideshowStep, ppslideshowDelay, ppslideshowMagnifyStart, ppslideshowMagnifyEnd, ppslideshowMinTime, ppslideshowMaxTime, ppslideshowEndingTime)"),obj.step&&(a5.dp.config.ppslideshowStep=obj.step),obj.delay&&(a5.dp.config.ppslideshowDelay=obj.delay),obj.magnifyStart&&(a5.dp.config.ppslideshowMagnifyStart=obj.magnifyStart),obj.magnifyEnd&&(a5.dp.config.ppslideshowMagnifyEnd=obj.magnifyEnd),obj.minTime&&(a5.dp.config.ppslideshowMinTime=obj.minTime),obj.maxTime&&(a5.dp.config.ppslideshowMaxTime=obj.maxTime),obj.endingTime&&(a5.dp.config.ppslideshowEndingTime=obj.endingTime)}}),Object.defineProperty(a5.dp.config,"wordsearch",{set:function(obj){logger.warn("Deprecated 'wordsearch' object. Use flat properties instead (wordsearchCellSize, wordsearchCheckmarks)"),obj.cellSize&&(a5.dp.config.wordsearchCellSize=obj.cellSize),obj.checkmarks&&(a5.dp.config.wordsearchCheckmarks=obj.checkmarks)}})}(jQuery),function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):factory(jQuery)}(function($){$.ui=$.ui||{},$.extend($.ui,{version:"1.11.4",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),$.fn.extend({scrollParent:function(includeHidden){var position=this.css("position"),excludeStaticParent="absolute"===position,overflowRegex=includeHidden?/(auto|scroll|hidden)/:/(auto|scroll)/,scrollParent=this.parents().filter(function(){var parent=$(this);return(!excludeStaticParent||"static"!==parent.css("position"))&&overflowRegex.test(parent.css("overflow")+parent.css("overflow-y")+parent.css("overflow-x"))}).eq(0);return"fixed"!==position&&scrollParent.length?scrollParent:$(this[0].ownerDocument||document)},uniqueId:function(){var uuid=0;return function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++uuid)})}}(),removeUniqueId:function(){return this.each(function(){/^ui-id-\d+$/.test(this.id)&&$(this).removeAttr("id")})}});function focusable(element,isTabIndexNotNaN){var map,mapName,img,nodeName=element.nodeName.toLowerCase();return"area"===nodeName?(map=element.parentNode,mapName=map.name,!(!element.href||!mapName||"map"!==map.nodeName.toLowerCase())&&(!!(img=$("img[usemap='#"+mapName+"']")[0])&&visible(img))):(/^(input|select|textarea|button|object)$/.test(nodeName)?!element.disabled:"a"===nodeName?element.href||isTabIndexNotNaN:isTabIndexNotNaN)&&visible(element)}function visible(element){return $.expr.filters.visible(element)&&!$(element).parents().addBack().filter(function(){return"hidden"===$.css(this,"visibility")}).length}$.extend($.expr[":"],{data:$.expr.createPseudo?$.expr.createPseudo(function(dataName){return function(elem){return!!$.data(elem,dataName)}}):function(elem,i,match){return!!$.data(elem,match[3])},focusable:function(element){return focusable(element,!isNaN($.attr(element,"tabindex")))},tabbable:function(element){var tabIndex=$.attr(element,"tabindex"),isTabIndexNaN=isNaN(tabIndex);return(isTabIndexNaN||tabIndex>=0)&&focusable(element,!isTabIndexNaN)}}),$("<a>").outerWidth(1).jquery||$.each(["Width","Height"],function(i,name){var side="Width"===name?["Left","Right"]:["Top","Bottom"],type=name.toLowerCase(),orig={innerWidth:$.fn.innerWidth,innerHeight:$.fn.innerHeight,outerWidth:$.fn.outerWidth,outerHeight:$.fn.outerHeight};function reduce(elem,size,border,margin){return $.each(side,function(){size-=parseFloat($.css(elem,"padding"+this))||0,border&&(size-=parseFloat($.css(elem,"border"+this+"Width"))||0),margin&&(size-=parseFloat($.css(elem,"margin"+this))||0)}),size}$.fn["inner"+name]=function(size){return void 0===size?orig["inner"+name].call(this):this.each(function(){$(this).css(type,reduce(this,size)+"px")})},$.fn["outer"+name]=function(size,margin){return"number"!=typeof size?orig["outer"+name].call(this,size):this.each(function(){$(this).css(type,reduce(this,size,!0,margin)+"px")})}}),$.fn.addBack||($.fn.addBack=function(selector){return this.add(null==selector?this.prevObject:this.prevObject.filter(selector))}),$("<a>").data("a-b","a").removeData("a-b").data("a-b")&&($.fn.removeData=function(removeData){return function(key){return arguments.length?removeData.call(this,$.camelCase(key)):removeData.call(this)}}($.fn.removeData)),$.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),$.fn.extend({focus:function(orig){return function(delay,fn){return"number"==typeof delay?this.each(function(){var elem=this;setTimeout(function(){$(elem).focus(),fn&&fn.call(elem)},delay)}):orig.apply(this,arguments)}}($.fn.focus),disableSelection:function(){var eventType="onselectstart"in document.createElement("div")?"selectstart":"mousedown";return function(){return this.bind(eventType+".ui-disableSelection",function(event){event.preventDefault()})}}(),enableSelection:function(){return this.unbind(".ui-disableSelection")},zIndex:function(zIndex){if(void 0!==zIndex)return this.css("zIndex",zIndex);if(this.length)for(var position,value,elem=$(this[0]);elem.length&&elem[0]!==document;){if(("absolute"===(position=elem.css("position"))||"relative"===position||"fixed"===position)&&(value=parseInt(elem.css("zIndex"),10),!isNaN(value)&&0!==value))return value;elem=elem.parent()}return 0}}),$.ui.plugin={add:function(module,option,set){var i,proto=$.ui[module].prototype;for(i in set)proto.plugins[i]=proto.plugins[i]||[],proto.plugins[i].push([option,set[i]])},call:function(instance,name,args,allowDisconnected){var i,set=instance.plugins[name];if(set&&(allowDisconnected||instance.element[0].parentNode&&11!==instance.element[0].parentNode.nodeType))for(i=0;i<set.length;i++)instance.options[set[i][0]]&&set[i][1].apply(instance.element,args)}};var widget_uuid=0,widget_slice=Array.prototype.slice;$.cleanData=function(orig){return function(elems){var events,elem,i;for(i=0;null!=(elem=elems[i]);i++)try{events=$._data(elem,"events"),events&&events.remove&&$(elem).triggerHandler("remove")}catch(e){}orig(elems)}}($.cleanData),$.widget=function(name,base,prototype){var fullName,existingConstructor,constructor,basePrototype,proxiedPrototype={},namespace=name.split(".")[0];return name=name.split(".")[1],fullName=namespace+"-"+name,prototype||(prototype=base,base=$.Widget),$.expr[":"][fullName.toLowerCase()]=function(elem){return!!$.data(elem,fullName)},$[namespace]=$[namespace]||{},existingConstructor=$[namespace][name],constructor=$[namespace][name]=function(options,element){if(!this._createWidget)return new constructor(options,element);arguments.length&&this._createWidget(options,element)},$.extend(constructor,existingConstructor,{version:prototype.version,_proto:$.extend({},prototype),_childConstructors:[]}),basePrototype=new base,basePrototype.options=$.widget.extend({},basePrototype.options),$.each(prototype,function(prop,value){if(!$.isFunction(value))return void(proxiedPrototype[prop]=value);proxiedPrototype[prop]=function(){var _super=function(){return base.prototype[prop].apply(this,arguments)},_superApply=function(args){return base.prototype[prop].apply(this,args)};return function(){var returnValue,__super=this._super,__superApply=this._superApply;return this._super=_super,this._superApply=_superApply,returnValue=value.apply(this,arguments),this._super=__super,this._superApply=__superApply,returnValue}}()}),constructor.prototype=$.widget.extend(basePrototype,{widgetEventPrefix:existingConstructor?basePrototype.widgetEventPrefix||name:name},proxiedPrototype,{constructor:constructor,namespace:namespace,widgetName:name,widgetFullName:fullName}),existingConstructor?($.each(existingConstructor._childConstructors,function(i,child){var childPrototype=child.prototype;$.widget(childPrototype.namespace+"."+childPrototype.widgetName,constructor,child._proto)}),delete existingConstructor._childConstructors):base._childConstructors.push(constructor),$.widget.bridge(name,constructor),constructor},$.widget.extend=function(target){for(var key,value,input=widget_slice.call(arguments,1),inputIndex=0,inputLength=input.length;inputIndex<inputLength;inputIndex++)for(key in input[inputIndex])value=input[inputIndex][key],input[inputIndex].hasOwnProperty(key)&&void 0!==value&&($.isPlainObject(value)?target[key]=$.isPlainObject(target[key])?$.widget.extend({},target[key],value):$.widget.extend({},value):target[key]=value);return target},$.widget.bridge=function(name,object){var fullName=object.prototype.widgetFullName||name;$.fn[name]=function(options){var isMethodCall="string"==typeof options,args=widget_slice.call(arguments,1),returnValue=this;return isMethodCall?this.each(function(){var methodValue,instance=$.data(this,fullName);return"instance"===options?(returnValue=instance,!1):instance?$.isFunction(instance[options])&&"_"!==options.charAt(0)?(methodValue=instance[options].apply(instance,args),methodValue!==instance&&void 0!==methodValue?(returnValue=methodValue&&methodValue.jquery?returnValue.pushStack(methodValue.get()):methodValue,!1):void 0):$.error("no such method '"+options+"' for "+name+" widget instance"):$.error("cannot call methods on "+name+" prior to initialization; attempted to call method '"+options+"'")}):(args.length&&(options=$.widget.extend.apply(null,[options].concat(args))),this.each(function(){var instance=$.data(this,fullName);instance?(instance.option(options||{}),instance._init&&instance._init()):$.data(this,fullName,new object(options,this))})),returnValue}},$.Widget=function(){},$.Widget._childConstructors=[],$.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(options,element){element=$(element||this.defaultElement||this)[0],this.element=$(element),this.uuid=widget_uuid++,this.eventNamespace="."+this.widgetName+this.uuid,this.bindings=$(),this.hoverable=$(),this.focusable=$(),element!==this&&($.data(element,this.widgetFullName,this),this._on(!0,this.element,{remove:function(event){event.target===element&&this.destroy()}}),this.document=$(element.style?element.ownerDocument:element.document||element),this.window=$(this.document[0].defaultView||this.document[0].parentWindow)),this.options=$.widget.extend({},this.options,this._getCreateOptions(),options),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:$.noop,_getCreateEventData:$.noop,_create:$.noop,_init:$.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetFullName).removeData($.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")},_destroy:$.noop,widget:function(){return this.element},option:function(key,value){var parts,curOption,i,options=key;if(0===arguments.length)return $.widget.extend({},this.options);if("string"==typeof key)if(options={},parts=key.split("."),key=parts.shift(),parts.length){for(curOption=options[key]=$.widget.extend({},this.options[key]),i=0;i<parts.length-1;i++)curOption[parts[i]]=curOption[parts[i]]||{},curOption=curOption[parts[i]];if(key=parts.pop(),1===arguments.length)return void 0===curOption[key]?null:curOption[key];curOption[key]=value}else{if(1===arguments.length)return void 0===this.options[key]?null:this.options[key];options[key]=value}return this._setOptions(options),this},_setOptions:function(options){var key;for(key in options)this._setOption(key,options[key]);return this},_setOption:function(key,value){return this.options[key]=value,"disabled"===key&&(this.widget().toggleClass(this.widgetFullName+"-disabled",!!value),value&&(this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus"))),this},enable:function(){return this._setOptions({disabled:!1})},disable:function(){return this._setOptions({disabled:!0})},_on:function(suppressDisabledCheck,element,handlers){var delegateElement,instance=this;"boolean"!=typeof suppressDisabledCheck&&(handlers=element,element=suppressDisabledCheck,suppressDisabledCheck=!1),handlers?(element=delegateElement=$(element),this.bindings=this.bindings.add(element)):(handlers=element,element=this.element,delegateElement=this.widget()),$.each(handlers,function(event,handler){function handlerProxy(){if(suppressDisabledCheck||!0!==instance.options.disabled&&!$(this).hasClass("ui-state-disabled"))return("string"==typeof handler?instance[handler]:handler).apply(instance,arguments)}"string"!=typeof handler&&(handlerProxy.guid=handler.guid=handler.guid||handlerProxy.guid||$.guid++);var match=event.match(/^([\w:-]*)\s*(.*)$/),eventName=match[1]+instance.eventNamespace,selector=match[2];selector?delegateElement.delegate(selector,eventName,handlerProxy):element.bind(eventName,handlerProxy)})},_off:function(element,eventName){eventName=(eventName||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,element.unbind(eventName).undelegate(eventName),this.bindings=$(this.bindings.not(element).get()),this.focusable=$(this.focusable.not(element).get()),this.hoverable=$(this.hoverable.not(element).get())},_delay:function(handler,delay){function handlerProxy(){return("string"==typeof handler?instance[handler]:handler).apply(instance,arguments)}var instance=this;return setTimeout(handlerProxy,delay||0)},_hoverable:function(element){this.hoverable=this.hoverable.add(element),this._on(element,{mouseenter:function(event){$(event.currentTarget).addClass("ui-state-hover")},mouseleave:function(event){$(event.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(element){this.focusable=this.focusable.add(element),this._on(element,{focusin:function(event){$(event.currentTarget).addClass("ui-state-focus")},focusout:function(event){$(event.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(type,event,data){var prop,orig,callback=this.options[type];if(data=data||{},event=$.Event(event),event.type=(type===this.widgetEventPrefix?type:this.widgetEventPrefix+type).toLowerCase(),event.target=this.element[0],orig=event.originalEvent)for(prop in orig)prop in event||(event[prop]=orig[prop]);return this.element.trigger(event,data),!($.isFunction(callback)&&!1===callback.apply(this.element[0],[event].concat(data))||event.isDefaultPrevented())}},$.each({show:"fadeIn",hide:"fadeOut"},function(method,defaultEffect){$.Widget.prototype["_"+method]=function(element,options,callback){"string"==typeof options&&(options={effect:options});var hasOptions,effectName=options?!0===options||"number"==typeof options?defaultEffect:options.effect||defaultEffect:method;options=options||{},"number"==typeof options&&(options={duration:options}),hasOptions=!$.isEmptyObject(options),options.complete=callback,options.delay&&element.delay(options.delay),hasOptions&&$.effects&&$.effects.effect[effectName]?element[method](options):effectName!==method&&element[effectName]?element[effectName](options.duration,options.easing,callback):element.queue(function(next){$(this)[method](),callback&&callback.call(element[0]),next()})}});var mouseHandled=($.widget,!1);$(document).mouseup(function(){mouseHandled=!1});$.widget("ui.mouse",{version:"1.11.4",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var that=this;this.element.bind("mousedown."+this.widgetName,function(event){return that._mouseDown(event)}).bind("click."+this.widgetName,function(event){if(!0===$.data(event.target,that.widgetName+".preventClickEvent"))return $.removeData(event.target,that.widgetName+".preventClickEvent"),event.stopImmediatePropagation(),!1}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&this.document.unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(event){if(!mouseHandled){this._mouseMoved=!1,this._mouseStarted&&this._mouseUp(event),this._mouseDownEvent=event;var that=this,btnIsLeft=1===event.which,elIsCancel=!("string"!=typeof this.options.cancel||!event.target.nodeName)&&$(event.target).closest(this.options.cancel).length;return!(btnIsLeft&&!elIsCancel&&this._mouseCapture(event))||(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){that.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(event)&&this._mouseDelayMet(event)&&(this._mouseStarted=!1!==this._mouseStart(event),!this._mouseStarted)?(event.preventDefault(),!0):(!0===$.data(event.target,this.widgetName+".preventClickEvent")&&$.removeData(event.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(event){return that._mouseMove(event)},this._mouseUpDelegate=function(event){return that._mouseUp(event)},this.document.bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),event.preventDefault(),mouseHandled=!0,!0))}},_mouseMove:function(event){if(this._mouseMoved){if($.ui.ie&&(!document.documentMode||document.documentMode<9)&&!event.button)return this._mouseUp(event);if(!event.which)return this._mouseUp(event)}return(event.which||event.button)&&(this._mouseMoved=!0),this._mouseStarted?(this._mouseDrag(event),event.preventDefault()):(this._mouseDistanceMet(event)&&this._mouseDelayMet(event)&&(this._mouseStarted=!1!==this._mouseStart(this._mouseDownEvent,event),this._mouseStarted?this._mouseDrag(event):this._mouseUp(event)),!this._mouseStarted)},_mouseUp:function(event){return this.document.unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,event.target===this._mouseDownEvent.target&&$.data(event.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(event)),mouseHandled=!1,!1},_mouseDistanceMet:function(event){return Math.max(Math.abs(this._mouseDownEvent.pageX-event.pageX),Math.abs(this._mouseDownEvent.pageY-event.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}});!function(){$.ui=$.ui||{};var cachedScrollbarWidth,supportsOffsetFractions,max=Math.max,abs=Math.abs,round=Math.round,rhorizontal=/left|center|right/,rvertical=/top|center|bottom/,roffset=/[\+\-]\d+(\.[\d]+)?%?/,rposition=/^\w+/,rpercent=/%$/,_position=$.fn.position;function getOffsets(offsets,width,height){return[parseFloat(offsets[0])*(rpercent.test(offsets[0])?width/100:1),parseFloat(offsets[1])*(rpercent.test(offsets[1])?height/100:1)]}function parseCss(element,property){return parseInt($.css(element,property),10)||0}function getDimensions(elem){var raw=elem[0];return 9===raw.nodeType?{width:elem.width(),height:elem.height(),offset:{top:0,left:0}}:$.isWindow(raw)?{width:elem.width(),height:elem.height(),offset:{top:elem.scrollTop(),left:elem.scrollLeft()}}:raw.preventDefault?{width:0,height:0,offset:{top:raw.pageY,left:raw.pageX}}:{width:elem.outerWidth(),height:elem.outerHeight(),offset:elem.offset()}}$.position={scrollbarWidth:function(){if(void 0!==cachedScrollbarWidth)return cachedScrollbarWidth;var w1,w2,div=$("<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"),innerDiv=div.children()[0];return $("body").append(div),w1=innerDiv.offsetWidth,div.css("overflow","scroll"),w2=innerDiv.offsetWidth,w1===w2&&(w2=div[0].clientWidth),div.remove(),cachedScrollbarWidth=w1-w2},getScrollInfo:function(within){var overflowX=within.isWindow||within.isDocument?"":within.element.css("overflow-x"),overflowY=within.isWindow||within.isDocument?"":within.element.css("overflow-y"),hasOverflowX="scroll"===overflowX||"auto"===overflowX&&within.width<within.element[0].scrollWidth;return{width:"scroll"===overflowY||"auto"===overflowY&&within.height<within.element[0].scrollHeight?$.position.scrollbarWidth():0,height:hasOverflowX?$.position.scrollbarWidth():0}},getWithinInfo:function(element){var withinElement=$(element||window),isWindow=$.isWindow(withinElement[0]),isDocument=!!withinElement[0]&&9===withinElement[0].nodeType;return{element:withinElement,isWindow:isWindow,isDocument:isDocument,offset:withinElement.offset()||{left:0,top:0},scrollLeft:withinElement.scrollLeft(),scrollTop:withinElement.scrollTop(),width:isWindow||isDocument?withinElement.width():withinElement.outerWidth(),height:isWindow||isDocument?withinElement.height():withinElement.outerHeight()}}},$.fn.position=function(options){if(!options||!options.of)return _position.apply(this,arguments);options=$.extend({},options);var atOffset,targetWidth,targetHeight,targetOffset,basePosition,dimensions,target=$(options.of),within=$.position.getWithinInfo(options.within),scrollInfo=$.position.getScrollInfo(within),collision=(options.collision||"flip").split(" "),offsets={};return dimensions=getDimensions(target),target[0].preventDefault&&(options.at="left top"),targetWidth=dimensions.width,targetHeight=dimensions.height,targetOffset=dimensions.offset,basePosition=$.extend({},targetOffset),$.each(["my","at"],function(){var horizontalOffset,verticalOffset,pos=(options[this]||"").split(" ");1===pos.length&&(pos=rhorizontal.test(pos[0])?pos.concat(["center"]):rvertical.test(pos[0])?["center"].concat(pos):["center","center"]),pos[0]=rhorizontal.test(pos[0])?pos[0]:"center",pos[1]=rvertical.test(pos[1])?pos[1]:"center",horizontalOffset=roffset.exec(pos[0]),verticalOffset=roffset.exec(pos[1]),offsets[this]=[horizontalOffset?horizontalOffset[0]:0,verticalOffset?verticalOffset[0]:0],options[this]=[rposition.exec(pos[0])[0],rposition.exec(pos[1])[0]]}),1===collision.length&&(collision[1]=collision[0]),"right"===options.at[0]?basePosition.left+=targetWidth:"center"===options.at[0]&&(basePosition.left+=targetWidth/2),"bottom"===options.at[1]?basePosition.top+=targetHeight:"center"===options.at[1]&&(basePosition.top+=targetHeight/2),atOffset=getOffsets(offsets.at,targetWidth,targetHeight),basePosition.left+=atOffset[0],basePosition.top+=atOffset[1],this.each(function(){var collisionPosition,using,elem=$(this),elemWidth=elem.outerWidth(),elemHeight=elem.outerHeight(),marginLeft=parseCss(this,"marginLeft"),marginTop=parseCss(this,"marginTop"),collisionWidth=elemWidth+marginLeft+parseCss(this,"marginRight")+scrollInfo.width,collisionHeight=elemHeight+marginTop+parseCss(this,"marginBottom")+scrollInfo.height,position=$.extend({},basePosition),myOffset=getOffsets(offsets.my,elem.outerWidth(),elem.outerHeight());"right"===options.my[0]?position.left-=elemWidth:"center"===options.my[0]&&(position.left-=elemWidth/2),"bottom"===options.my[1]?position.top-=elemHeight:"center"===options.my[1]&&(position.top-=elemHeight/2),position.left+=myOffset[0],position.top+=myOffset[1],supportsOffsetFractions||(position.left=round(position.left),position.top=round(position.top)),collisionPosition={marginLeft:marginLeft,marginTop:marginTop},$.each(["left","top"],function(i,dir){$.ui.position[collision[i]]&&$.ui.position[collision[i]][dir](position,{targetWidth:targetWidth,targetHeight:targetHeight,elemWidth:elemWidth,elemHeight:elemHeight,collisionPosition:collisionPosition,collisionWidth:collisionWidth,collisionHeight:collisionHeight,offset:[atOffset[0]+myOffset[0],atOffset[1]+myOffset[1]],my:options.my,at:options.at,within:within,elem:elem})}),options.using&&(using=function(props){
var left=targetOffset.left-position.left,right=left+targetWidth-elemWidth,top=targetOffset.top-position.top,bottom=top+targetHeight-elemHeight,feedback={target:{element:target,left:targetOffset.left,top:targetOffset.top,width:targetWidth,height:targetHeight},element:{element:elem,left:position.left,top:position.top,width:elemWidth,height:elemHeight},horizontal:right<0?"left":left>0?"right":"center",vertical:bottom<0?"top":top>0?"bottom":"middle"};targetWidth<elemWidth&&abs(left+right)<targetWidth&&(feedback.horizontal="center"),targetHeight<elemHeight&&abs(top+bottom)<targetHeight&&(feedback.vertical="middle"),max(abs(left),abs(right))>max(abs(top),abs(bottom))?feedback.important="horizontal":feedback.important="vertical",options.using.call(this,props,feedback)}),elem.offset($.extend(position,{using:using}))})},$.ui.position={fit:{left:function(position,data){var newOverRight,within=data.within,withinOffset=within.isWindow?within.scrollLeft:within.offset.left,outerWidth=within.width,collisionPosLeft=position.left-data.collisionPosition.marginLeft,overLeft=withinOffset-collisionPosLeft,overRight=collisionPosLeft+data.collisionWidth-outerWidth-withinOffset;data.collisionWidth>outerWidth?overLeft>0&&overRight<=0?(newOverRight=position.left+overLeft+data.collisionWidth-outerWidth-withinOffset,position.left+=overLeft-newOverRight):position.left=overRight>0&&overLeft<=0?withinOffset:overLeft>overRight?withinOffset+outerWidth-data.collisionWidth:withinOffset:overLeft>0?position.left+=overLeft:overRight>0?position.left-=overRight:position.left=max(position.left-collisionPosLeft,position.left)},top:function(position,data){var newOverBottom,within=data.within,withinOffset=within.isWindow?within.scrollTop:within.offset.top,outerHeight=data.within.height,collisionPosTop=position.top-data.collisionPosition.marginTop,overTop=withinOffset-collisionPosTop,overBottom=collisionPosTop+data.collisionHeight-outerHeight-withinOffset;data.collisionHeight>outerHeight?overTop>0&&overBottom<=0?(newOverBottom=position.top+overTop+data.collisionHeight-outerHeight-withinOffset,position.top+=overTop-newOverBottom):position.top=overBottom>0&&overTop<=0?withinOffset:overTop>overBottom?withinOffset+outerHeight-data.collisionHeight:withinOffset:overTop>0?position.top+=overTop:overBottom>0?position.top-=overBottom:position.top=max(position.top-collisionPosTop,position.top)}},flip:{left:function(position,data){var newOverRight,newOverLeft,within=data.within,withinOffset=within.offset.left+within.scrollLeft,outerWidth=within.width,offsetLeft=within.isWindow?within.scrollLeft:within.offset.left,collisionPosLeft=position.left-data.collisionPosition.marginLeft,overLeft=collisionPosLeft-offsetLeft,overRight=collisionPosLeft+data.collisionWidth-outerWidth-offsetLeft,myOffset="left"===data.my[0]?-data.elemWidth:"right"===data.my[0]?data.elemWidth:0,atOffset="left"===data.at[0]?data.targetWidth:"right"===data.at[0]?-data.targetWidth:0,offset=-2*data.offset[0];overLeft<0?((newOverRight=position.left+myOffset+atOffset+offset+data.collisionWidth-outerWidth-withinOffset)<0||newOverRight<abs(overLeft))&&(position.left+=myOffset+atOffset+offset):overRight>0&&((newOverLeft=position.left-data.collisionPosition.marginLeft+myOffset+atOffset+offset-offsetLeft)>0||abs(newOverLeft)<overRight)&&(position.left+=myOffset+atOffset+offset)},top:function(position,data){var newOverTop,newOverBottom,within=data.within,withinOffset=within.offset.top+within.scrollTop,outerHeight=within.height,offsetTop=within.isWindow?within.scrollTop:within.offset.top,collisionPosTop=position.top-data.collisionPosition.marginTop,overTop=collisionPosTop-offsetTop,overBottom=collisionPosTop+data.collisionHeight-outerHeight-offsetTop,top="top"===data.my[1],myOffset=top?-data.elemHeight:"bottom"===data.my[1]?data.elemHeight:0,atOffset="top"===data.at[1]?data.targetHeight:"bottom"===data.at[1]?-data.targetHeight:0,offset=-2*data.offset[1];overTop<0?((newOverBottom=position.top+myOffset+atOffset+offset+data.collisionHeight-outerHeight-withinOffset)<0||newOverBottom<abs(overTop))&&(position.top+=myOffset+atOffset+offset):overBottom>0&&((newOverTop=position.top-data.collisionPosition.marginTop+myOffset+atOffset+offset-offsetTop)>0||abs(newOverTop)<overBottom)&&(position.top+=myOffset+atOffset+offset)}},flipfit:{left:function(){$.ui.position.flip.left.apply(this,arguments),$.ui.position.fit.left.apply(this,arguments)},top:function(){$.ui.position.flip.top.apply(this,arguments),$.ui.position.fit.top.apply(this,arguments)}}},function(){var testElement,testElementParent,testElementStyle,offsetLeft,i,body=document.getElementsByTagName("body")[0],div=document.createElement("div");testElement=document.createElement(body?"div":"body"),testElementStyle={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},body&&$.extend(testElementStyle,{position:"absolute",left:"-1000px",top:"-1000px"});for(i in testElementStyle)testElement.style[i]=testElementStyle[i];testElement.appendChild(div),testElementParent=body||document.documentElement,testElementParent.insertBefore(testElement,testElementParent.firstChild),div.style.cssText="position: absolute; left: 10.7432222px;",offsetLeft=$(div).offset().left,supportsOffsetFractions=offsetLeft>10&&offsetLeft<11,testElement.innerHTML="",testElementParent.removeChild(testElement)}()}();$.ui.position;$.widget("ui.draggable",$.ui.mouse,{version:"1.11.4",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"===this.options.helper&&this._setPositionRelative(),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._setHandleClassName(),this._mouseInit()},_setOption:function(key,value){this._super(key,value),"handle"===key&&(this._removeHandleClassName(),this._setHandleClassName())},_destroy:function(){if((this.helper||this.element).is(".ui-draggable-dragging"))return void(this.destroyOnClear=!0);this.element.removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._removeHandleClassName(),this._mouseDestroy()},_mouseCapture:function(event){var o=this.options;return this._blurActiveElement(event),!(this.helper||o.disabled||$(event.target).closest(".ui-resizable-handle").length>0)&&(this.handle=this._getHandle(event),!!this.handle&&(this._blockFrames(!0===o.iframeFix?"iframe":o.iframeFix),!0))},_blockFrames:function(selector){this.iframeBlocks=this.document.find(selector).map(function(){var iframe=$(this);return $("<div>").css("position","absolute").appendTo(iframe.parent()).outerWidth(iframe.outerWidth()).outerHeight(iframe.outerHeight()).offset(iframe.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_blurActiveElement:function(event){var document=this.document[0];if(this.handleElement.is(event.target))try{document.activeElement&&"body"!==document.activeElement.nodeName.toLowerCase()&&$(document.activeElement).blur()}catch(error){}},_mouseStart:function(event){var o=this.options;return this.helper=this._createHelper(event),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),$.ui.ddmanager&&($.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(!0),this.offsetParent=this.helper.offsetParent(),this.hasFixedAncestor=this.helper.parents().filter(function(){return"fixed"===$(this).css("position")}).length>0,this.positionAbs=this.element.offset(),this._refreshOffsets(event),this.originalPosition=this.position=this._generatePosition(event,!1),this.originalPageX=event.pageX,this.originalPageY=event.pageY,o.cursorAt&&this._adjustOffsetFromHelper(o.cursorAt),this._setContainment(),!1===this._trigger("start",event)?(this._clear(),!1):(this._cacheHelperProportions(),$.ui.ddmanager&&!o.dropBehaviour&&$.ui.ddmanager.prepareOffsets(this,event),this._normalizeRightBottom(),this._mouseDrag(event,!0),$.ui.ddmanager&&$.ui.ddmanager.dragStart(this,event),!0)},_refreshOffsets:function(event){this.offset={top:this.positionAbs.top-this.margins.top,left:this.positionAbs.left-this.margins.left,scroll:!1,parent:this._getParentOffset(),relative:this._getRelativeOffset()},this.offset.click={left:event.pageX-this.offset.left,top:event.pageY-this.offset.top}},_mouseDrag:function(event,noPropagation){if(this.hasFixedAncestor&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(event,!0),this.positionAbs=this._convertPositionTo("absolute"),!noPropagation){var ui=this._uiHash();if(!1===this._trigger("drag",event,ui))return this._mouseUp({}),!1;this.position=ui.position}return this.helper[0].style.left=this.position.left+"px",this.helper[0].style.top=this.position.top+"px",$.ui.ddmanager&&$.ui.ddmanager.drag(this,event),!1},_mouseStop:function(event){var that=this,dropped=!1;return $.ui.ddmanager&&!this.options.dropBehaviour&&(dropped=$.ui.ddmanager.drop(this,event)),this.dropped&&(dropped=this.dropped,this.dropped=!1),"invalid"===this.options.revert&&!dropped||"valid"===this.options.revert&&dropped||!0===this.options.revert||$.isFunction(this.options.revert)&&this.options.revert.call(this.element,dropped)?$(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){!1!==that._trigger("stop",event)&&that._clear()}):!1!==this._trigger("stop",event)&&this._clear(),!1},_mouseUp:function(event){return this._unblockFrames(),$.ui.ddmanager&&$.ui.ddmanager.dragStop(this,event),this.handleElement.is(event.target)&&this.element.focus(),$.ui.mouse.prototype._mouseUp.call(this,event)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(event){return!this.options.handle||!!$(event.target).closest(this.element.find(this.options.handle)).length},_setHandleClassName:function(){this.handleElement=this.options.handle?this.element.find(this.options.handle):this.element,this.handleElement.addClass("ui-draggable-handle")},_removeHandleClassName:function(){this.handleElement.removeClass("ui-draggable-handle")},_createHelper:function(event){var o=this.options,helperIsFunction=$.isFunction(o.helper),helper=helperIsFunction?$(o.helper.apply(this.element[0],[event])):"clone"===o.helper?this.element.clone().removeAttr("id"):this.element;return helper.parents("body").length||helper.appendTo("parent"===o.appendTo?this.element[0].parentNode:o.appendTo),helperIsFunction&&helper[0]===this.element[0]&&this._setPositionRelative(),helper[0]===this.element[0]||/(fixed|absolute)/.test(helper.css("position"))||helper.css("position","absolute"),helper},_setPositionRelative:function(){/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative")},_adjustOffsetFromHelper:function(obj){"string"==typeof obj&&(obj=obj.split(" ")),$.isArray(obj)&&(obj={left:+obj[0],top:+obj[1]||0}),"left"in obj&&(this.offset.click.left=obj.left+this.margins.left),"right"in obj&&(this.offset.click.left=this.helperProportions.width-obj.right+this.margins.left),"top"in obj&&(this.offset.click.top=obj.top+this.margins.top),"bottom"in obj&&(this.offset.click.top=this.helperProportions.height-obj.bottom+this.margins.top)},_isRootNode:function(element){return/(html|body)/i.test(element.tagName)||element===this.document[0]},_getParentOffset:function(){var po=this.offsetParent.offset(),document=this.document[0];return"absolute"===this.cssPosition&&this.scrollParent[0]!==document&&$.contains(this.scrollParent[0],this.offsetParent[0])&&(po.left+=this.scrollParent.scrollLeft(),po.top+=this.scrollParent.scrollTop()),this._isRootNode(this.offsetParent[0])&&(po={top:0,left:0}),{top:po.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:po.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"!==this.cssPosition)return{top:0,left:0};var p=this.element.position(),scrollIsRootNode=this._isRootNode(this.scrollParent[0]);return{top:p.top-(parseInt(this.helper.css("top"),10)||0)+(scrollIsRootNode?0:this.scrollParent.scrollTop()),left:p.left-(parseInt(this.helper.css("left"),10)||0)+(scrollIsRootNode?0:this.scrollParent.scrollLeft())}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var isUserScrollable,c,ce,o=this.options,document=this.document[0];return this.relativeContainer=null,o.containment?"window"===o.containment?void(this.containment=[$(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,$(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,$(window).scrollLeft()+$(window).width()-this.helperProportions.width-this.margins.left,$(window).scrollTop()+($(window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):"document"===o.containment?void(this.containment=[0,0,$(document).width()-this.helperProportions.width-this.margins.left,($(document).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):o.containment.constructor===Array?void(this.containment=o.containment):("parent"===o.containment&&(o.containment=this.helper[0].parentNode),c=$(o.containment),void((ce=c[0])&&(isUserScrollable=/(scroll|auto)/.test(c.css("overflow")),this.containment=[(parseInt(c.css("borderLeftWidth"),10)||0)+(parseInt(c.css("paddingLeft"),10)||0),(parseInt(c.css("borderTopWidth"),10)||0)+(parseInt(c.css("paddingTop"),10)||0),(isUserScrollable?Math.max(ce.scrollWidth,ce.offsetWidth):ce.offsetWidth)-(parseInt(c.css("borderRightWidth"),10)||0)-(parseInt(c.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(isUserScrollable?Math.max(ce.scrollHeight,ce.offsetHeight):ce.offsetHeight)-(parseInt(c.css("borderBottomWidth"),10)||0)-(parseInt(c.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relativeContainer=c))):void(this.containment=null)},_convertPositionTo:function(d,pos){pos||(pos=this.position);var mod="absolute"===d?1:-1,scrollIsRootNode=this._isRootNode(this.scrollParent[0]);return{top:pos.top+this.offset.relative.top*mod+this.offset.parent.top*mod-("fixed"===this.cssPosition?-this.offset.scroll.top:scrollIsRootNode?0:this.offset.scroll.top)*mod,left:pos.left+this.offset.relative.left*mod+this.offset.parent.left*mod-("fixed"===this.cssPosition?-this.offset.scroll.left:scrollIsRootNode?0:this.offset.scroll.left)*mod}},_generatePosition:function(event,constrainPosition){var containment,co,top,left,o=this.options,scrollIsRootNode=this._isRootNode(this.scrollParent[0]),pageX=event.pageX,pageY=event.pageY;return scrollIsRootNode&&this.offset.scroll||(this.offset.scroll={top:this.scrollParent.scrollTop(),left:this.scrollParent.scrollLeft()}),constrainPosition&&(this.containment&&(this.relativeContainer?(co=this.relativeContainer.offset(),containment=[this.containment[0]+co.left,this.containment[1]+co.top,this.containment[2]+co.left,this.containment[3]+co.top]):containment=this.containment,event.pageX-this.offset.click.left<containment[0]&&(pageX=containment[0]+this.offset.click.left),event.pageY-this.offset.click.top<containment[1]&&(pageY=containment[1]+this.offset.click.top),event.pageX-this.offset.click.left>containment[2]&&(pageX=containment[2]+this.offset.click.left),event.pageY-this.offset.click.top>containment[3]&&(pageY=containment[3]+this.offset.click.top)),o.grid&&(top=o.grid[1]?this.originalPageY+Math.round((pageY-this.originalPageY)/o.grid[1])*o.grid[1]:this.originalPageY,pageY=containment?top-this.offset.click.top>=containment[1]||top-this.offset.click.top>containment[3]?top:top-this.offset.click.top>=containment[1]?top-o.grid[1]:top+o.grid[1]:top,left=o.grid[0]?this.originalPageX+Math.round((pageX-this.originalPageX)/o.grid[0])*o.grid[0]:this.originalPageX,pageX=containment?left-this.offset.click.left>=containment[0]||left-this.offset.click.left>containment[2]?left:left-this.offset.click.left>=containment[0]?left-o.grid[0]:left+o.grid[0]:left),"y"===o.axis&&(pageX=this.originalPageX),"x"===o.axis&&(pageY=this.originalPageY)),{top:pageY-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.offset.scroll.top:scrollIsRootNode?0:this.offset.scroll.top),left:pageX-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.offset.scroll.left:scrollIsRootNode?0:this.offset.scroll.left)}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]===this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1,this.destroyOnClear&&this.destroy()},_normalizeRightBottom:function(){"y"!==this.options.axis&&"auto"!==this.helper.css("right")&&(this.helper.width(this.helper.width()),this.helper.css("right","auto")),"x"!==this.options.axis&&"auto"!==this.helper.css("bottom")&&(this.helper.height(this.helper.height()),this.helper.css("bottom","auto"))},_trigger:function(type,event,ui){return ui=ui||this._uiHash(),$.ui.plugin.call(this,type,[event,ui,this],!0),/^(drag|start|stop)/.test(type)&&(this.positionAbs=this._convertPositionTo("absolute"),ui.offset=this.positionAbs),$.Widget.prototype._trigger.call(this,type,event,ui)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),$.ui.plugin.add("draggable","connectToSortable",{start:function(event,ui,draggable){var uiSortable=$.extend({},ui,{item:draggable.element});draggable.sortables=[],$(draggable.options.connectToSortable).each(function(){var sortable=$(this).sortable("instance");sortable&&!sortable.options.disabled&&(draggable.sortables.push(sortable),sortable.refreshPositions(),sortable._trigger("activate",event,uiSortable))})},stop:function(event,ui,draggable){var uiSortable=$.extend({},ui,{item:draggable.element});draggable.cancelHelperRemoval=!1,$.each(draggable.sortables,function(){var sortable=this;sortable.isOver?(sortable.isOver=0,draggable.cancelHelperRemoval=!0,sortable.cancelHelperRemoval=!1,sortable._storedCSS={position:sortable.placeholder.css("position"),top:sortable.placeholder.css("top"),left:sortable.placeholder.css("left")},sortable._mouseStop(event),sortable.options.helper=sortable.options._helper):(sortable.cancelHelperRemoval=!0,sortable._trigger("deactivate",event,uiSortable))})},drag:function(event,ui,draggable){$.each(draggable.sortables,function(){var innermostIntersecting=!1,sortable=this;sortable.positionAbs=draggable.positionAbs,sortable.helperProportions=draggable.helperProportions,sortable.offset.click=draggable.offset.click,sortable._intersectsWith(sortable.containerCache)&&(innermostIntersecting=!0,$.each(draggable.sortables,function(){return this.positionAbs=draggable.positionAbs,this.helperProportions=draggable.helperProportions,this.offset.click=draggable.offset.click,this!==sortable&&this._intersectsWith(this.containerCache)&&$.contains(sortable.element[0],this.element[0])&&(innermostIntersecting=!1),innermostIntersecting})),innermostIntersecting?(sortable.isOver||(sortable.isOver=1,draggable._parent=ui.helper.parent(),sortable.currentItem=ui.helper.appendTo(sortable.element).data("ui-sortable-item",!0),sortable.options._helper=sortable.options.helper,sortable.options.helper=function(){return ui.helper[0]},event.target=sortable.currentItem[0],sortable._mouseCapture(event,!0),sortable._mouseStart(event,!0,!0),sortable.offset.click.top=draggable.offset.click.top,sortable.offset.click.left=draggable.offset.click.left,sortable.offset.parent.left-=draggable.offset.parent.left-sortable.offset.parent.left,sortable.offset.parent.top-=draggable.offset.parent.top-sortable.offset.parent.top,draggable._trigger("toSortable",event),draggable.dropped=sortable.element,$.each(draggable.sortables,function(){this.refreshPositions()}),draggable.currentItem=draggable.element,sortable.fromOutside=draggable),sortable.currentItem&&(sortable._mouseDrag(event),ui.position=sortable.position)):sortable.isOver&&(sortable.isOver=0,sortable.cancelHelperRemoval=!0,sortable.options._revert=sortable.options.revert,sortable.options.revert=!1,sortable._trigger("out",event,sortable._uiHash(sortable)),sortable._mouseStop(event,!0),sortable.options.revert=sortable.options._revert,sortable.options.helper=sortable.options._helper,sortable.placeholder&&sortable.placeholder.remove(),ui.helper.appendTo(draggable._parent),draggable._refreshOffsets(event),ui.position=draggable._generatePosition(event,!0),draggable._trigger("fromSortable",event),draggable.dropped=!1,$.each(draggable.sortables,function(){this.refreshPositions()}))})}}),$.ui.plugin.add("draggable","cursor",{start:function(event,ui,instance){var t=$("body"),o=instance.options;t.css("cursor")&&(o._cursor=t.css("cursor")),t.css("cursor",o.cursor)},stop:function(event,ui,instance){var o=instance.options;o._cursor&&$("body").css("cursor",o._cursor)}}),$.ui.plugin.add("draggable","opacity",{start:function(event,ui,instance){var t=$(ui.helper),o=instance.options;t.css("opacity")&&(o._opacity=t.css("opacity")),t.css("opacity",o.opacity)},stop:function(event,ui,instance){var o=instance.options;o._opacity&&$(ui.helper).css("opacity",o._opacity)}}),$.ui.plugin.add("draggable","scroll",{start:function(event,ui,i){i.scrollParentNotHidden||(i.scrollParentNotHidden=i.helper.scrollParent(!1)),i.scrollParentNotHidden[0]!==i.document[0]&&"HTML"!==i.scrollParentNotHidden[0].tagName&&(i.overflowOffset=i.scrollParentNotHidden.offset())},drag:function(event,ui,i){var o=i.options,scrolled=!1,scrollParent=i.scrollParentNotHidden[0],document=i.document[0];scrollParent!==document&&"HTML"!==scrollParent.tagName?(o.axis&&"x"===o.axis||(i.overflowOffset.top+scrollParent.offsetHeight-event.pageY<o.scrollSensitivity?scrollParent.scrollTop=scrolled=scrollParent.scrollTop+o.scrollSpeed:event.pageY-i.overflowOffset.top<o.scrollSensitivity&&(scrollParent.scrollTop=scrolled=scrollParent.scrollTop-o.scrollSpeed)),o.axis&&"y"===o.axis||(i.overflowOffset.left+scrollParent.offsetWidth-event.pageX<o.scrollSensitivity?scrollParent.scrollLeft=scrolled=scrollParent.scrollLeft+o.scrollSpeed:event.pageX-i.overflowOffset.left<o.scrollSensitivity&&(scrollParent.scrollLeft=scrolled=scrollParent.scrollLeft-o.scrollSpeed))):(o.axis&&"x"===o.axis||(event.pageY-$(document).scrollTop()<o.scrollSensitivity?scrolled=$(document).scrollTop($(document).scrollTop()-o.scrollSpeed):$(window).height()-(event.pageY-$(document).scrollTop())<o.scrollSensitivity&&(scrolled=$(document).scrollTop($(document).scrollTop()+o.scrollSpeed))),o.axis&&"y"===o.axis||(event.pageX-$(document).scrollLeft()<o.scrollSensitivity?scrolled=$(document).scrollLeft($(document).scrollLeft()-o.scrollSpeed):$(window).width()-(event.pageX-$(document).scrollLeft())<o.scrollSensitivity&&(scrolled=$(document).scrollLeft($(document).scrollLeft()+o.scrollSpeed)))),!1!==scrolled&&$.ui.ddmanager&&!o.dropBehaviour&&$.ui.ddmanager.prepareOffsets(i,event)}}),$.ui.plugin.add("draggable","snap",{start:function(event,ui,i){var o=i.options;i.snapElements=[],$(o.snap.constructor!==String?o.snap.items||":data(ui-draggable)":o.snap).each(function(){var $t=$(this),$o=$t.offset();this!==i.element[0]&&i.snapElements.push({item:this,width:$t.outerWidth(),height:$t.outerHeight(),top:$o.top,left:$o.left})})},drag:function(event,ui,inst){var ts,bs,ls,rs,l,r,t,b,i,first,o=inst.options,d=o.snapTolerance,x1=ui.offset.left,x2=x1+inst.helperProportions.width,y1=ui.offset.top,y2=y1+inst.helperProportions.height;for(i=inst.snapElements.length-1;i>=0;i--)l=inst.snapElements[i].left-inst.margins.left,r=l+inst.snapElements[i].width,t=inst.snapElements[i].top-inst.margins.top,b=t+inst.snapElements[i].height,x2<l-d||x1>r+d||y2<t-d||y1>b+d||!$.contains(inst.snapElements[i].item.ownerDocument,inst.snapElements[i].item)?(inst.snapElements[i].snapping&&inst.options.snap.release&&inst.options.snap.release.call(inst.element,event,$.extend(inst._uiHash(),{snapItem:inst.snapElements[i].item})),inst.snapElements[i].snapping=!1):("inner"!==o.snapMode&&(ts=Math.abs(t-y2)<=d,bs=Math.abs(b-y1)<=d,ls=Math.abs(l-x2)<=d,rs=Math.abs(r-x1)<=d,ts&&(ui.position.top=inst._convertPositionTo("relative",{top:t-inst.helperProportions.height,left:0}).top),bs&&(ui.position.top=inst._convertPositionTo("relative",{top:b,left:0}).top),ls&&(ui.position.left=inst._convertPositionTo("relative",{top:0,left:l-inst.helperProportions.width}).left),rs&&(ui.position.left=inst._convertPositionTo("relative",{top:0,left:r}).left)),first=ts||bs||ls||rs,"outer"!==o.snapMode&&(ts=Math.abs(t-y1)<=d,bs=Math.abs(b-y2)<=d,ls=Math.abs(l-x1)<=d,rs=Math.abs(r-x2)<=d,ts&&(ui.position.top=inst._convertPositionTo("relative",{top:t,left:0}).top),bs&&(ui.position.top=inst._convertPositionTo("relative",{top:b-inst.helperProportions.height,left:0}).top),ls&&(ui.position.left=inst._convertPositionTo("relative",{top:0,left:l}).left),rs&&(ui.position.left=inst._convertPositionTo("relative",{top:0,left:r-inst.helperProportions.width}).left)),!inst.snapElements[i].snapping&&(ts||bs||ls||rs||first)&&inst.options.snap.snap&&inst.options.snap.snap.call(inst.element,event,$.extend(inst._uiHash(),{snapItem:inst.snapElements[i].item})),inst.snapElements[i].snapping=ts||bs||ls||rs||first)}}),$.ui.plugin.add("draggable","stack",{start:function(event,ui,instance){var min,o=instance.options,group=$.makeArray($(o.stack)).sort(function(a,b){return(parseInt($(a).css("zIndex"),10)||0)-(parseInt($(b).css("zIndex"),10)||0)});group.length&&(min=parseInt($(group[0]).css("zIndex"),10)||0,$(group).each(function(i){$(this).css("zIndex",min+i)}),this.css("zIndex",min+group.length))}}),$.ui.plugin.add("draggable","zIndex",{start:function(event,ui,instance){var t=$(ui.helper),o=instance.options;t.css("zIndex")&&(o._zIndex=t.css("zIndex")),t.css("zIndex",o.zIndex)},stop:function(event,ui,instance){var o=instance.options;o._zIndex&&$(ui.helper).css("zIndex",o._zIndex)}});$.ui.draggable;$.widget("ui.droppable",{version:"1.11.4",widgetEventPrefix:"drop",options:{accept:"*",activeClass:!1,addClasses:!0,greedy:!1,hoverClass:!1,scope:"default",tolerance:"intersect",activate:null,deactivate:null,drop:null,out:null,over:null},_create:function(){var proportions,o=this.options,accept=o.accept;this.isover=!1,this.isout=!0,this.accept=$.isFunction(accept)?accept:function(d){return d.is(accept)},this.proportions=function(){if(!arguments.length)return proportions||(proportions={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight});proportions=arguments[0]},this._addToManager(o.scope),o.addClasses&&this.element.addClass("ui-droppable")},_addToManager:function(scope){$.ui.ddmanager.droppables[scope]=$.ui.ddmanager.droppables[scope]||[],$.ui.ddmanager.droppables[scope].push(this)},_splice:function(drop){for(var i=0;i<drop.length;i++)drop[i]===this&&drop.splice(i,1)},_destroy:function(){var drop=$.ui.ddmanager.droppables[this.options.scope];this._splice(drop),this.element.removeClass("ui-droppable ui-droppable-disabled")},_setOption:function(key,value){if("accept"===key)this.accept=$.isFunction(value)?value:function(d){return d.is(value)};else if("scope"===key){var drop=$.ui.ddmanager.droppables[this.options.scope];this._splice(drop),this._addToManager(value)}this._super(key,value)},_activate:function(event){var draggable=$.ui.ddmanager.current;this.options.activeClass&&this.element.addClass(this.options.activeClass),draggable&&this._trigger("activate",event,this.ui(draggable))},_deactivate:function(event){var draggable=$.ui.ddmanager.current;this.options.activeClass&&this.element.removeClass(this.options.activeClass),draggable&&this._trigger("deactivate",event,this.ui(draggable))},_over:function(event){var draggable=$.ui.ddmanager.current;draggable&&(draggable.currentItem||draggable.element)[0]!==this.element[0]&&this.accept.call(this.element[0],draggable.currentItem||draggable.element)&&(this.options.hoverClass&&this.element.addClass(this.options.hoverClass),this._trigger("over",event,this.ui(draggable)))},_out:function(event){var draggable=$.ui.ddmanager.current;draggable&&(draggable.currentItem||draggable.element)[0]!==this.element[0]&&this.accept.call(this.element[0],draggable.currentItem||draggable.element)&&(this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("out",event,this.ui(draggable)))},_drop:function(event,custom){var draggable=custom||$.ui.ddmanager.current,childrenIntersection=!1;return!(!draggable||(draggable.currentItem||draggable.element)[0]===this.element[0])&&(this.element.find(":data(ui-droppable)").not(".ui-draggable-dragging").each(function(){var inst=$(this).droppable("instance");if(inst.options.greedy&&!inst.options.disabled&&inst.options.scope===draggable.options.scope&&inst.accept.call(inst.element[0],draggable.currentItem||draggable.element)&&$.ui.intersect(draggable,$.extend(inst,{offset:inst.element.offset()}),inst.options.tolerance,event))return childrenIntersection=!0,!1}),!childrenIntersection&&(!!this.accept.call(this.element[0],draggable.currentItem||draggable.element)&&(this.options.activeClass&&this.element.removeClass(this.options.activeClass),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("drop",event,this.ui(draggable)),this.element)))},ui:function(c){return{draggable:c.currentItem||c.element,helper:c.helper,position:c.position,offset:c.positionAbs}}}),$.ui.intersect=function(){function isOverAxis(x,reference,size){return x>=reference&&x<reference+size}return function(draggable,droppable,toleranceMode,event){if(!droppable.offset)return!1;var x1=(draggable.positionAbs||draggable.position.absolute).left+draggable.margins.left,y1=(draggable.positionAbs||draggable.position.absolute).top+draggable.margins.top,x2=x1+draggable.helperProportions.width,y2=y1+draggable.helperProportions.height,l=droppable.offset.left,t=droppable.offset.top,r=l+droppable.proportions().width,b=t+droppable.proportions().height;switch(toleranceMode){case"fit":return l<=x1&&x2<=r&&t<=y1&&y2<=b;case"intersect":return l<x1+draggable.helperProportions.width/2&&x2-draggable.helperProportions.width/2<r&&t<y1+draggable.helperProportions.height/2&&y2-draggable.helperProportions.height/2<b;case"pointer":return isOverAxis(event.pageY,t,droppable.proportions().height)&&isOverAxis(event.pageX,l,droppable.proportions().width);case"touch":return(y1>=t&&y1<=b||y2>=t&&y2<=b||y1<t&&y2>b)&&(x1>=l&&x1<=r||x2>=l&&x2<=r||x1<l&&x2>r);default:return!1}}}(),$.ui.ddmanager={current:null,droppables:{default:[]},prepareOffsets:function(t,event){var i,j,m=$.ui.ddmanager.droppables[t.options.scope]||[],type=event?event.type:null,list=(t.currentItem||t.element).find(":data(ui-droppable)").addBack();droppablesLoop:for(i=0;i<m.length;i++)if(!(m[i].options.disabled||t&&!m[i].accept.call(m[i].element[0],t.currentItem||t.element))){for(j=0;j<list.length;j++)if(list[j]===m[i].element[0]){m[i].proportions().height=0;continue droppablesLoop}m[i].visible="none"!==m[i].element.css("display"),m[i].visible&&("mousedown"===type&&m[i]._activate.call(m[i],event),m[i].offset=m[i].element.offset(),m[i].proportions({width:m[i].element[0].offsetWidth,height:m[i].element[0].offsetHeight}))}},drop:function(draggable,event){var dropped=!1
;return $.each(($.ui.ddmanager.droppables[draggable.options.scope]||[]).slice(),function(){this.options&&(!this.options.disabled&&this.visible&&$.ui.intersect(draggable,this,this.options.tolerance,event)&&(dropped=this._drop.call(this,event)||dropped),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],draggable.currentItem||draggable.element)&&(this.isout=!0,this.isover=!1,this._deactivate.call(this,event)))}),dropped},dragStart:function(draggable,event){draggable.element.parentsUntil("body").bind("scroll.droppable",function(){draggable.options.refreshPositions||$.ui.ddmanager.prepareOffsets(draggable,event)})},drag:function(draggable,event){draggable.options.refreshPositions&&$.ui.ddmanager.prepareOffsets(draggable,event),$.each($.ui.ddmanager.droppables[draggable.options.scope]||[],function(){if(!this.options.disabled&&!this.greedyChild&&this.visible){var parentInstance,scope,parent,intersects=$.ui.intersect(draggable,this,this.options.tolerance,event),c=!intersects&&this.isover?"isout":intersects&&!this.isover?"isover":null;c&&(this.options.greedy&&(scope=this.options.scope,parent=this.element.parents(":data(ui-droppable)").filter(function(){return $(this).droppable("instance").options.scope===scope}),parent.length&&(parentInstance=$(parent[0]).droppable("instance"),parentInstance.greedyChild="isover"===c)),parentInstance&&"isover"===c&&(parentInstance.isover=!1,parentInstance.isout=!0,parentInstance._out.call(parentInstance,event)),this[c]=!0,this["isout"===c?"isover":"isout"]=!1,this["isover"===c?"_over":"_out"].call(this,event),parentInstance&&"isout"===c&&(parentInstance.isout=!1,parentInstance.isover=!0,parentInstance._over.call(parentInstance,event)))}})},dragStop:function(draggable,event){draggable.element.parentsUntil("body").unbind("scroll.droppable"),draggable.options.refreshPositions||$.ui.ddmanager.prepareOffsets(draggable,event)}};$.ui.droppable;$.widget("ui.resizable",$.ui.mouse,{version:"1.11.4",widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:90,resize:null,start:null,stop:null},_num:function(value){return parseInt(value,10)||0},_isNumber:function(value){return!isNaN(parseInt(value,10))},_hasScroll:function(el,a){if("hidden"===$(el).css("overflow"))return!1;var scroll=a&&"left"===a?"scrollLeft":"scrollTop",has=!1;return el[scroll]>0||(el[scroll]=1,has=el[scroll]>0,el[scroll]=0,has)},_create:function(){var n,i,handle,axis,hname,that=this,o=this.options;if(this.element.addClass("ui-resizable"),$.extend(this,{_aspectRatio:!!o.aspectRatio,aspectRatio:o.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:o.helper||o.ghost||o.animate?o.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/^(canvas|textarea|input|select|button|img)$/i)&&(this.element.wrap($("<div class='ui-wrapper' style='overflow: hidden;'></div>").css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("ui-resizable",this.element.resizable("instance")),this.elementIsWrapper=!0,this.element.css({marginLeft:this.originalElement.css("marginLeft"),marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom")}),this.originalElement.css({marginLeft:0,marginTop:0,marginRight:0,marginBottom:0}),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css({margin:this.originalElement.css("margin")}),this._proportionallyResize()),this.handles=o.handles||($(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se"),this._handles=$(),this.handles.constructor===String)for("all"===this.handles&&(this.handles="n,e,s,w,se,sw,ne,nw"),n=this.handles.split(","),this.handles={},i=0;i<n.length;i++)handle=$.trim(n[i]),hname="ui-resizable-"+handle,axis=$("<div class='ui-resizable-handle "+hname+"'></div>"),axis.css({zIndex:o.zIndex}),"se"===handle&&axis.addClass("ui-icon ui-icon-gripsmall-diagonal-se"),this.handles[handle]=".ui-resizable-"+handle,this.element.append(axis);this._renderAxis=function(target){var i,axis,padPos,padWrapper;target=target||this.element;for(i in this.handles)this.handles[i].constructor===String?this.handles[i]=this.element.children(this.handles[i]).first().show():(this.handles[i].jquery||this.handles[i].nodeType)&&(this.handles[i]=$(this.handles[i]),this._on(this.handles[i],{mousedown:that._mouseDown})),this.elementIsWrapper&&this.originalElement[0].nodeName.match(/^(textarea|input|select|button)$/i)&&(axis=$(this.handles[i],this.element),padWrapper=/sw|ne|nw|se|n|s/.test(i)?axis.outerHeight():axis.outerWidth(),padPos=["padding",/ne|nw|n/.test(i)?"Top":/se|sw|s/.test(i)?"Bottom":/^e$/.test(i)?"Right":"Left"].join(""),target.css(padPos,padWrapper),this._proportionallyResize()),this._handles=this._handles.add(this.handles[i])},this._renderAxis(this.element),this._handles=this._handles.add(this.element.find(".ui-resizable-handle")),this._handles.disableSelection(),this._handles.mouseover(function(){that.resizing||(this.className&&(axis=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i)),that.axis=axis&&axis[1]?axis[1]:"se")}),o.autoHide&&(this._handles.hide(),$(this.element).addClass("ui-resizable-autohide").mouseenter(function(){o.disabled||($(this).removeClass("ui-resizable-autohide"),that._handles.show())}).mouseleave(function(){o.disabled||that.resizing||($(this).addClass("ui-resizable-autohide"),that._handles.hide())})),this._mouseInit()},_destroy:function(){this._mouseDestroy();var wrapper,_destroy=function(exp){$(exp).removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing").removeData("resizable").removeData("ui-resizable").unbind(".resizable").find(".ui-resizable-handle").remove()};return this.elementIsWrapper&&(_destroy(this.element),wrapper=this.element,this.originalElement.css({position:wrapper.css("position"),width:wrapper.outerWidth(),height:wrapper.outerHeight(),top:wrapper.css("top"),left:wrapper.css("left")}).insertAfter(wrapper),wrapper.remove()),this.originalElement.css("resize",this.originalResizeStyle),_destroy(this.originalElement),this},_mouseCapture:function(event){var i,handle,capture=!1;for(i in this.handles)((handle=$(this.handles[i])[0])===event.target||$.contains(handle,event.target))&&(capture=!0);return!this.options.disabled&&capture},_mouseStart:function(event){var curleft,curtop,cursor,o=this.options,el=this.element;return this.resizing=!0,this._renderProxy(),curleft=this._num(this.helper.css("left")),curtop=this._num(this.helper.css("top")),o.containment&&(curleft+=$(o.containment).scrollLeft()||0,curtop+=$(o.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:curleft,top:curtop},this.size=this._helper?{width:this.helper.width(),height:this.helper.height()}:{width:el.width(),height:el.height()},this.originalSize=this._helper?{width:el.outerWidth(),height:el.outerHeight()}:{width:el.width(),height:el.height()},this.sizeDiff={width:el.outerWidth()-el.width(),height:el.outerHeight()-el.height()},this.originalPosition={left:curleft,top:curtop},this.originalMousePosition={left:event.pageX,top:event.pageY},this.aspectRatio="number"==typeof o.aspectRatio?o.aspectRatio:this.originalSize.width/this.originalSize.height||1,cursor=$(".ui-resizable-"+this.axis).css("cursor"),$("body").css("cursor","auto"===cursor?this.axis+"-resize":cursor),el.addClass("ui-resizable-resizing"),this._propagate("start",event),!0},_mouseDrag:function(event){var data,props,smp=this.originalMousePosition,a=this.axis,dx=event.pageX-smp.left||0,dy=event.pageY-smp.top||0,trigger=this._change[a];return this._updatePrevProperties(),!!trigger&&(data=trigger.apply(this,[event,dx,dy]),this._updateVirtualBoundaries(event.shiftKey),(this._aspectRatio||event.shiftKey)&&(data=this._updateRatio(data,event)),data=this._respectSize(data,event),this._updateCache(data),this._propagate("resize",event),props=this._applyChanges(),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),$.isEmptyObject(props)||(this._updatePrevProperties(),this._trigger("resize",event,this.ui()),this._applyChanges()),!1)},_mouseStop:function(event){this.resizing=!1;var pr,ista,soffseth,soffsetw,s,left,top,o=this.options,that=this;return this._helper&&(pr=this._proportionallyResizeElements,ista=pr.length&&/textarea/i.test(pr[0].nodeName),soffseth=ista&&this._hasScroll(pr[0],"left")?0:that.sizeDiff.height,soffsetw=ista?0:that.sizeDiff.width,s={width:that.helper.width()-soffsetw,height:that.helper.height()-soffseth},left=parseInt(that.element.css("left"),10)+(that.position.left-that.originalPosition.left)||null,top=parseInt(that.element.css("top"),10)+(that.position.top-that.originalPosition.top)||null,o.animate||this.element.css($.extend(s,{top:top,left:left})),that.helper.height(that.size.height),that.helper.width(that.size.width),this._helper&&!o.animate&&this._proportionallyResize()),$("body").css("cursor","auto"),this.element.removeClass("ui-resizable-resizing"),this._propagate("stop",event),this._helper&&this.helper.remove(),!1},_updatePrevProperties:function(){this.prevPosition={top:this.position.top,left:this.position.left},this.prevSize={width:this.size.width,height:this.size.height}},_applyChanges:function(){var props={};return this.position.top!==this.prevPosition.top&&(props.top=this.position.top+"px"),this.position.left!==this.prevPosition.left&&(props.left=this.position.left+"px"),this.size.width!==this.prevSize.width&&(props.width=this.size.width+"px"),this.size.height!==this.prevSize.height&&(props.height=this.size.height+"px"),this.helper.css(props),props},_updateVirtualBoundaries:function(forceAspectRatio){var pMinWidth,pMaxWidth,pMinHeight,pMaxHeight,b,o=this.options;b={minWidth:this._isNumber(o.minWidth)?o.minWidth:0,maxWidth:this._isNumber(o.maxWidth)?o.maxWidth:1/0,minHeight:this._isNumber(o.minHeight)?o.minHeight:0,maxHeight:this._isNumber(o.maxHeight)?o.maxHeight:1/0},(this._aspectRatio||forceAspectRatio)&&(pMinWidth=b.minHeight*this.aspectRatio,pMinHeight=b.minWidth/this.aspectRatio,pMaxWidth=b.maxHeight*this.aspectRatio,pMaxHeight=b.maxWidth/this.aspectRatio,pMinWidth>b.minWidth&&(b.minWidth=pMinWidth),pMinHeight>b.minHeight&&(b.minHeight=pMinHeight),pMaxWidth<b.maxWidth&&(b.maxWidth=pMaxWidth),pMaxHeight<b.maxHeight&&(b.maxHeight=pMaxHeight)),this._vBoundaries=b},_updateCache:function(data){this.offset=this.helper.offset(),this._isNumber(data.left)&&(this.position.left=data.left),this._isNumber(data.top)&&(this.position.top=data.top),this._isNumber(data.height)&&(this.size.height=data.height),this._isNumber(data.width)&&(this.size.width=data.width)},_updateRatio:function(data){var cpos=this.position,csize=this.size,a=this.axis;return this._isNumber(data.height)?data.width=data.height*this.aspectRatio:this._isNumber(data.width)&&(data.height=data.width/this.aspectRatio),"sw"===a&&(data.left=cpos.left+(csize.width-data.width),data.top=null),"nw"===a&&(data.top=cpos.top+(csize.height-data.height),data.left=cpos.left+(csize.width-data.width)),data},_respectSize:function(data){var o=this._vBoundaries,a=this.axis,ismaxw=this._isNumber(data.width)&&o.maxWidth&&o.maxWidth<data.width,ismaxh=this._isNumber(data.height)&&o.maxHeight&&o.maxHeight<data.height,isminw=this._isNumber(data.width)&&o.minWidth&&o.minWidth>data.width,isminh=this._isNumber(data.height)&&o.minHeight&&o.minHeight>data.height,dw=this.originalPosition.left+this.originalSize.width,dh=this.position.top+this.size.height,cw=/sw|nw|w/.test(a),ch=/nw|ne|n/.test(a);return isminw&&(data.width=o.minWidth),isminh&&(data.height=o.minHeight),ismaxw&&(data.width=o.maxWidth),ismaxh&&(data.height=o.maxHeight),isminw&&cw&&(data.left=dw-o.minWidth),ismaxw&&cw&&(data.left=dw-o.maxWidth),isminh&&ch&&(data.top=dh-o.minHeight),ismaxh&&ch&&(data.top=dh-o.maxHeight),data.width||data.height||data.left||!data.top?data.width||data.height||data.top||!data.left||(data.left=null):data.top=null,data},_getPaddingPlusBorderDimensions:function(element){for(var i=0,widths=[],borders=[element.css("borderTopWidth"),element.css("borderRightWidth"),element.css("borderBottomWidth"),element.css("borderLeftWidth")],paddings=[element.css("paddingTop"),element.css("paddingRight"),element.css("paddingBottom"),element.css("paddingLeft")];i<4;i++)widths[i]=parseInt(borders[i],10)||0,widths[i]+=parseInt(paddings[i],10)||0;return{height:widths[0]+widths[2],width:widths[1]+widths[3]}},_proportionallyResize:function(){if(this._proportionallyResizeElements.length)for(var prel,i=0,element=this.helper||this.element;i<this._proportionallyResizeElements.length;i++)prel=this._proportionallyResizeElements[i],this.outerDimensions||(this.outerDimensions=this._getPaddingPlusBorderDimensions(prel)),prel.css({height:element.height()-this.outerDimensions.height||0,width:element.width()-this.outerDimensions.width||0})},_renderProxy:function(){var el=this.element,o=this.options;this.elementOffset=el.offset(),this._helper?(this.helper=this.helper||$("<div style='overflow:hidden;'></div>"),this.helper.addClass(this._helper).css({width:this.element.outerWidth()-1,height:this.element.outerHeight()-1,position:"absolute",left:this.elementOffset.left+"px",top:this.elementOffset.top+"px",zIndex:++o.zIndex}),this.helper.appendTo("body").disableSelection()):this.helper=this.element},_change:{e:function(event,dx){return{width:this.originalSize.width+dx}},w:function(event,dx){var cs=this.originalSize;return{left:this.originalPosition.left+dx,width:cs.width-dx}},n:function(event,dx,dy){var cs=this.originalSize;return{top:this.originalPosition.top+dy,height:cs.height-dy}},s:function(event,dx,dy){return{height:this.originalSize.height+dy}},se:function(event,dx,dy){return $.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[event,dx,dy]))},sw:function(event,dx,dy){return $.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[event,dx,dy]))},ne:function(event,dx,dy){return $.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[event,dx,dy]))},nw:function(event,dx,dy){return $.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[event,dx,dy]))}},_propagate:function(n,event){$.ui.plugin.call(this,n,[event,this.ui()]),"resize"!==n&&this._trigger(n,event,this.ui())},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}),$.ui.plugin.add("resizable","animate",{stop:function(event){var that=$(this).resizable("instance"),o=that.options,pr=that._proportionallyResizeElements,ista=pr.length&&/textarea/i.test(pr[0].nodeName),soffseth=ista&&that._hasScroll(pr[0],"left")?0:that.sizeDiff.height,soffsetw=ista?0:that.sizeDiff.width,style={width:that.size.width-soffsetw,height:that.size.height-soffseth},left=parseInt(that.element.css("left"),10)+(that.position.left-that.originalPosition.left)||null,top=parseInt(that.element.css("top"),10)+(that.position.top-that.originalPosition.top)||null;that.element.animate($.extend(style,top&&left?{top:top,left:left}:{}),{duration:o.animateDuration,easing:o.animateEasing,step:function(){var data={width:parseInt(that.element.css("width"),10),height:parseInt(that.element.css("height"),10),top:parseInt(that.element.css("top"),10),left:parseInt(that.element.css("left"),10)};pr&&pr.length&&$(pr[0]).css({width:data.width,height:data.height}),that._updateCache(data),that._propagate("resize",event)}})}}),$.ui.plugin.add("resizable","containment",{start:function(){var element,p,co,ch,cw,width,height,that=$(this).resizable("instance"),o=that.options,el=that.element,oc=o.containment,ce=oc instanceof $?oc.get(0):/parent/.test(oc)?el.parent().get(0):oc;ce&&(that.containerElement=$(ce),/document/.test(oc)||oc===document?(that.containerOffset={left:0,top:0},that.containerPosition={left:0,top:0},that.parentData={element:$(document),left:0,top:0,width:$(document).width(),height:$(document).height()||document.body.parentNode.scrollHeight}):(element=$(ce),p=[],$(["Top","Right","Left","Bottom"]).each(function(i,name){p[i]=that._num(element.css("padding"+name))}),that.containerOffset=element.offset(),that.containerPosition=element.position(),that.containerSize={height:element.innerHeight()-p[3],width:element.innerWidth()-p[1]},co=that.containerOffset,ch=that.containerSize.height,cw=that.containerSize.width,width=that._hasScroll(ce,"left")?ce.scrollWidth:cw,height=that._hasScroll(ce)?ce.scrollHeight:ch,that.parentData={element:ce,left:co.left,top:co.top,width:width,height:height}))},resize:function(event){var woset,hoset,isParent,isOffsetRelative,that=$(this).resizable("instance"),o=that.options,co=that.containerOffset,cp=that.position,pRatio=that._aspectRatio||event.shiftKey,cop={top:0,left:0},ce=that.containerElement,continueResize=!0;ce[0]!==document&&/static/.test(ce.css("position"))&&(cop=co),cp.left<(that._helper?co.left:0)&&(that.size.width=that.size.width+(that._helper?that.position.left-co.left:that.position.left-cop.left),pRatio&&(that.size.height=that.size.width/that.aspectRatio,continueResize=!1),that.position.left=o.helper?co.left:0),cp.top<(that._helper?co.top:0)&&(that.size.height=that.size.height+(that._helper?that.position.top-co.top:that.position.top),pRatio&&(that.size.width=that.size.height*that.aspectRatio,continueResize=!1),that.position.top=that._helper?co.top:0),isParent=that.containerElement.get(0)===that.element.parent().get(0),isOffsetRelative=/relative|absolute/.test(that.containerElement.css("position")),isParent&&isOffsetRelative?(that.offset.left=that.parentData.left+that.position.left,that.offset.top=that.parentData.top+that.position.top):(that.offset.left=that.element.offset().left,that.offset.top=that.element.offset().top),woset=Math.abs(that.sizeDiff.width+(that._helper?that.offset.left-cop.left:that.offset.left-co.left)),hoset=Math.abs(that.sizeDiff.height+(that._helper?that.offset.top-cop.top:that.offset.top-co.top)),woset+that.size.width>=that.parentData.width&&(that.size.width=that.parentData.width-woset,pRatio&&(that.size.height=that.size.width/that.aspectRatio,continueResize=!1)),hoset+that.size.height>=that.parentData.height&&(that.size.height=that.parentData.height-hoset,pRatio&&(that.size.width=that.size.height*that.aspectRatio,continueResize=!1)),continueResize||(that.position.left=that.prevPosition.left,that.position.top=that.prevPosition.top,that.size.width=that.prevSize.width,that.size.height=that.prevSize.height)},stop:function(){var that=$(this).resizable("instance"),o=that.options,co=that.containerOffset,cop=that.containerPosition,ce=that.containerElement,helper=$(that.helper),ho=helper.offset(),w=helper.outerWidth()-that.sizeDiff.width,h=helper.outerHeight()-that.sizeDiff.height;that._helper&&!o.animate&&/relative/.test(ce.css("position"))&&$(this).css({left:ho.left-cop.left-co.left,width:w,height:h}),that._helper&&!o.animate&&/static/.test(ce.css("position"))&&$(this).css({left:ho.left-cop.left-co.left,width:w,height:h})}}),$.ui.plugin.add("resizable","alsoResize",{start:function(){var that=$(this).resizable("instance"),o=that.options;$(o.alsoResize).each(function(){var el=$(this);el.data("ui-resizable-alsoresize",{width:parseInt(el.width(),10),height:parseInt(el.height(),10),left:parseInt(el.css("left"),10),top:parseInt(el.css("top"),10)})})},resize:function(event,ui){var that=$(this).resizable("instance"),o=that.options,os=that.originalSize,op=that.originalPosition,delta={height:that.size.height-os.height||0,width:that.size.width-os.width||0,top:that.position.top-op.top||0,left:that.position.left-op.left||0};$(o.alsoResize).each(function(){var el=$(this),start=$(this).data("ui-resizable-alsoresize"),style={},css=el.parents(ui.originalElement[0]).length?["width","height"]:["width","height","top","left"];$.each(css,function(i,prop){var sum=(start[prop]||0)+(delta[prop]||0);sum&&sum>=0&&(style[prop]=sum||null)}),el.css(style)})},stop:function(){$(this).removeData("resizable-alsoresize")}}),$.ui.plugin.add("resizable","ghost",{start:function(){var that=$(this).resizable("instance"),o=that.options,cs=that.size;that.ghost=that.originalElement.clone(),that.ghost.css({opacity:.25,display:"block",position:"relative",height:cs.height,width:cs.width,margin:0,left:0,top:0}).addClass("ui-resizable-ghost").addClass("string"==typeof o.ghost?o.ghost:""),that.ghost.appendTo(that.helper)},resize:function(){var that=$(this).resizable("instance");that.ghost&&that.ghost.css({position:"relative",height:that.size.height,width:that.size.width})},stop:function(){var that=$(this).resizable("instance");that.ghost&&that.helper&&that.helper.get(0).removeChild(that.ghost.get(0))}}),$.ui.plugin.add("resizable","grid",{resize:function(){var outerDimensions,that=$(this).resizable("instance"),o=that.options,cs=that.size,os=that.originalSize,op=that.originalPosition,a=that.axis,grid="number"==typeof o.grid?[o.grid,o.grid]:o.grid,gridX=grid[0]||1,gridY=grid[1]||1,ox=Math.round((cs.width-os.width)/gridX)*gridX,oy=Math.round((cs.height-os.height)/gridY)*gridY,newWidth=os.width+ox,newHeight=os.height+oy,isMaxWidth=o.maxWidth&&o.maxWidth<newWidth,isMaxHeight=o.maxHeight&&o.maxHeight<newHeight,isMinWidth=o.minWidth&&o.minWidth>newWidth,isMinHeight=o.minHeight&&o.minHeight>newHeight;o.grid=grid,isMinWidth&&(newWidth+=gridX),isMinHeight&&(newHeight+=gridY),isMaxWidth&&(newWidth-=gridX),isMaxHeight&&(newHeight-=gridY),/^(se|s|e)$/.test(a)?(that.size.width=newWidth,that.size.height=newHeight):/^(ne)$/.test(a)?(that.size.width=newWidth,that.size.height=newHeight,that.position.top=op.top-oy):/^(sw)$/.test(a)?(that.size.width=newWidth,that.size.height=newHeight,that.position.left=op.left-ox):((newHeight-gridY<=0||newWidth-gridX<=0)&&(outerDimensions=that._getPaddingPlusBorderDimensions(this)),newHeight-gridY>0?(that.size.height=newHeight,that.position.top=op.top-oy):(newHeight=gridY-outerDimensions.height,that.size.height=newHeight,that.position.top=op.top+os.height-newHeight),newWidth-gridX>0?(that.size.width=newWidth,that.position.left=op.left-ox):(newWidth=gridX-outerDimensions.width,that.size.width=newWidth,that.position.left=op.left+os.width-newWidth))}});$.ui.resizable,$.widget("ui.selectable",$.ui.mouse,{version:"1.11.4",options:{appendTo:"body",autoRefresh:!0,distance:0,filter:"*",tolerance:"touch",selected:null,selecting:null,start:null,stop:null,unselected:null,unselecting:null},_create:function(){var selectees,that=this;this.element.addClass("ui-selectable"),this.dragged=!1,this.refresh=function(){selectees=$(that.options.filter,that.element[0]),selectees.addClass("ui-selectee"),selectees.each(function(){var $this=$(this),pos=$this.offset();$.data(this,"selectable-item",{element:this,$element:$this,left:pos.left,top:pos.top,right:pos.left+$this.outerWidth(),bottom:pos.top+$this.outerHeight(),startselected:!1,selected:$this.hasClass("ui-selected"),selecting:$this.hasClass("ui-selecting"),unselecting:$this.hasClass("ui-unselecting")})})},this.refresh(),this.selectees=selectees.addClass("ui-selectee"),this._mouseInit(),this.helper=$("<div class='ui-selectable-helper'></div>")},_destroy:function(){this.selectees.removeClass("ui-selectee").removeData("selectable-item"),this.element.removeClass("ui-selectable ui-selectable-disabled"),this._mouseDestroy()},_mouseStart:function(event){var that=this,options=this.options;this.opos=[event.pageX,event.pageY],this.options.disabled||(this.selectees=$(options.filter,this.element[0]),this._trigger("start",event),$(options.appendTo).append(this.helper),this.helper.css({left:event.pageX,top:event.pageY,width:0,height:0}),options.autoRefresh&&this.refresh(),this.selectees.filter(".ui-selected").each(function(){var selectee=$.data(this,"selectable-item");selectee.startselected=!0,event.metaKey||event.ctrlKey||(selectee.$element.removeClass("ui-selected"),selectee.selected=!1,selectee.$element.addClass("ui-unselecting"),selectee.unselecting=!0,that._trigger("unselecting",event,{unselecting:selectee.element}))}),$(event.target).parents().addBack().each(function(){var doSelect,selectee=$.data(this,"selectable-item");if(selectee)return doSelect=!event.metaKey&&!event.ctrlKey||!selectee.$element.hasClass("ui-selected"),selectee.$element.removeClass(doSelect?"ui-unselecting":"ui-selected").addClass(doSelect?"ui-selecting":"ui-unselecting"),selectee.unselecting=!doSelect,selectee.selecting=doSelect,selectee.selected=doSelect,doSelect?that._trigger("selecting",event,{selecting:selectee.element}):that._trigger("unselecting",event,{unselecting:selectee.element}),!1}))},_mouseDrag:function(event){if(this.dragged=!0,!this.options.disabled){var tmp,that=this,options=this.options,x1=this.opos[0],y1=this.opos[1],x2=event.pageX,y2=event.pageY;return x1>x2&&(tmp=x2,x2=x1,x1=tmp),y1>y2&&(tmp=y2,y2=y1,y1=tmp),this.helper.css({left:x1,top:y1,width:x2-x1,height:y2-y1}),this.selectees.each(function(){var selectee=$.data(this,"selectable-item"),hit=!1;selectee&&selectee.element!==that.element[0]&&("touch"===options.tolerance?hit=!(selectee.left>x2||selectee.right<x1||selectee.top>y2||selectee.bottom<y1):"fit"===options.tolerance&&(hit=selectee.left>x1&&selectee.right<x2&&selectee.top>y1&&selectee.bottom<y2),hit?(selectee.selected&&(selectee.$element.removeClass("ui-selected"),selectee.selected=!1),selectee.unselecting&&(selectee.$element.removeClass("ui-unselecting"),selectee.unselecting=!1),selectee.selecting||(selectee.$element.addClass("ui-selecting"),selectee.selecting=!0,that._trigger("selecting",event,{selecting:selectee.element}))):(selectee.selecting&&((event.metaKey||event.ctrlKey)&&selectee.startselected?(selectee.$element.removeClass("ui-selecting"),selectee.selecting=!1,selectee.$element.addClass("ui-selected"),selectee.selected=!0):(selectee.$element.removeClass("ui-selecting"),selectee.selecting=!1,selectee.startselected&&(selectee.$element.addClass("ui-unselecting"),selectee.unselecting=!0),that._trigger("unselecting",event,{unselecting:selectee.element}))),selectee.selected&&(event.metaKey||event.ctrlKey||selectee.startselected||(selectee.$element.removeClass("ui-selected"),selectee.selected=!1,selectee.$element.addClass("ui-unselecting"),selectee.unselecting=!0,that._trigger("unselecting",event,{unselecting:selectee.element})))))}),!1}},_mouseStop:function(event){var that=this;return this.dragged=!1,$(".ui-unselecting",this.element[0]).each(function(){var selectee=$.data(this,"selectable-item");selectee.$element.removeClass("ui-unselecting"),selectee.unselecting=!1,selectee.startselected=!1,that._trigger("unselected",event,{unselected:selectee.element})}),$(".ui-selecting",this.element[0]).each(function(){var selectee=$.data(this,"selectable-item");selectee.$element.removeClass("ui-selecting").addClass("ui-selected"),selectee.selecting=!1,selectee.selected=!0,selectee.startselected=!0,that._trigger("selected",event,{selected:selectee.element})}),this._trigger("stop",event),this.helper.remove(),!1}}),$.widget("ui.sortable",$.ui.mouse,{version:"1.11.4",widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3,activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_isOverAxis:function(x,reference,size){return x>=reference&&x<reference+size},_isFloating:function(item){return/left|right/.test(item.css("float"))||/inline|table-cell/.test(item.css("display"))},_create:function(){this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.offset=this.element.offset(),this._mouseInit(),this._setHandleClassName(),this.ready=!0},_setOption:function(key,value){this._super(key,value),"handle"===key&&this._setHandleClassName()},_setHandleClassName:function(){this.element.find(".ui-sortable-handle").removeClass("ui-sortable-handle"),$.each(this.items,function(){(this.instance.options.handle?this.item.find(this.instance.options.handle):this.item).addClass("ui-sortable-handle")})},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled").find(".ui-sortable-handle").removeClass("ui-sortable-handle"),this._mouseDestroy();for(var i=this.items.length-1;i>=0;i--)this.items[i].item.removeData(this.widgetName+"-item");return this},_mouseCapture:function(event,overrideHandle){var currentItem=null,validHandle=!1,that=this;return!this.reverting&&(!this.options.disabled&&"static"!==this.options.type&&(this._refreshItems(event),$(event.target).parents().each(function(){if($.data(this,that.widgetName+"-item")===that)return currentItem=$(this),!1}),$.data(event.target,that.widgetName+"-item")===that&&(currentItem=$(event.target)),!!currentItem&&(!(this.options.handle&&!overrideHandle&&($(this.options.handle,currentItem).find("*").addBack().each(function(){this===event.target&&(validHandle=!0)}),!validHandle))&&(this.currentItem=currentItem,this._removeCurrentsFromItems(),!0))))},_mouseStart:function(event,overrideHandle,noActivation){var i,body,o=this.options;if(this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(event),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},$.extend(this.offset,{click:{left:event.pageX-this.offset.left,top:event.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(event),this.originalPageX=event.pageX,this.originalPageY=event.pageY,o.cursorAt&&this._adjustOffsetFromHelper(o.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!==this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),o.containment&&this._setContainment(),o.cursor&&"auto"!==o.cursor&&(body=this.document.find("body"),this.storedCursor=body.css("cursor"),body.css("cursor",o.cursor),this.storedStylesheet=$("<style>*{ cursor: "+o.cursor+" !important; }</style>").appendTo(body)),o.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",o.opacity)),o.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",o.zIndex)),this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",event,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions(),!noActivation)for(i=this.containers.length-1;i>=0;i--)this.containers[i]._trigger("activate",event,this._uiHash(this));return $.ui.ddmanager&&($.ui.ddmanager.current=this),$.ui.ddmanager&&!o.dropBehaviour&&$.ui.ddmanager.prepareOffsets(this,event),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(event),!0},_mouseDrag:function(event){var i,item,itemElement,intersection,o=this.options,scrolled=!1
;for(this.position=this._generatePosition(event),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-event.pageY<o.scrollSensitivity?this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop+o.scrollSpeed:event.pageY-this.overflowOffset.top<o.scrollSensitivity&&(this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop-o.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-event.pageX<o.scrollSensitivity?this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft+o.scrollSpeed:event.pageX-this.overflowOffset.left<o.scrollSensitivity&&(this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft-o.scrollSpeed)):(event.pageY-this.document.scrollTop()<o.scrollSensitivity?scrolled=this.document.scrollTop(this.document.scrollTop()-o.scrollSpeed):this.window.height()-(event.pageY-this.document.scrollTop())<o.scrollSensitivity&&(scrolled=this.document.scrollTop(this.document.scrollTop()+o.scrollSpeed)),event.pageX-this.document.scrollLeft()<o.scrollSensitivity?scrolled=this.document.scrollLeft(this.document.scrollLeft()-o.scrollSpeed):this.window.width()-(event.pageX-this.document.scrollLeft())<o.scrollSensitivity&&(scrolled=this.document.scrollLeft(this.document.scrollLeft()+o.scrollSpeed))),!1!==scrolled&&$.ui.ddmanager&&!o.dropBehaviour&&$.ui.ddmanager.prepareOffsets(this,event)),this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),i=this.items.length-1;i>=0;i--)if(item=this.items[i],itemElement=item.item[0],(intersection=this._intersectsWithPointer(item))&&item.instance===this.currentContainer&&!(itemElement===this.currentItem[0]||this.placeholder[1===intersection?"next":"prev"]()[0]===itemElement||$.contains(this.placeholder[0],itemElement)||"semi-dynamic"===this.options.type&&$.contains(this.element[0],itemElement))){if(this.direction=1===intersection?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(item))break;this._rearrange(event,item),this._trigger("change",event,this._uiHash());break}return this._contactContainers(event),$.ui.ddmanager&&$.ui.ddmanager.drag(this,event),this._trigger("sort",event,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(event,noPropagation){if(event){if($.ui.ddmanager&&!this.options.dropBehaviour&&$.ui.ddmanager.drop(this,event),this.options.revert){var that=this,cur=this.placeholder.offset(),axis=this.options.axis,animation={};axis&&"x"!==axis||(animation.left=cur.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollLeft)),axis&&"y"!==axis||(animation.top=cur.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollTop)),this.reverting=!0,$(this.helper).animate(animation,parseInt(this.options.revert,10)||500,function(){that._clear(event)})}else this._clear(event,noPropagation);return!1}},cancel:function(){if(this.dragging){this._mouseUp({target:null}),"original"===this.options.helper?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();for(var i=this.containers.length-1;i>=0;i--)this.containers[i]._trigger("deactivate",null,this._uiHash(this)),this.containers[i].containerCache.over&&(this.containers[i]._trigger("out",null,this._uiHash(this)),this.containers[i].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),"original"!==this.options.helper&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),$.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?$(this.domPosition.prev).after(this.currentItem):$(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(o){var items=this._getItemsAsjQuery(o&&o.connected),str=[];return o=o||{},$(items).each(function(){var res=($(o.item||this).attr(o.attribute||"id")||"").match(o.expression||/(.+)[\-=_](.+)/);res&&str.push((o.key||res[1]+"[]")+"="+(o.key&&o.expression?res[1]:res[2]))}),!str.length&&o.key&&str.push(o.key+"="),str.join("&")},toArray:function(o){var items=this._getItemsAsjQuery(o&&o.connected),ret=[];return o=o||{},items.each(function(){ret.push($(o.item||this).attr(o.attribute||"id")||"")}),ret},_intersectsWith:function(item){var x1=this.positionAbs.left,x2=x1+this.helperProportions.width,y1=this.positionAbs.top,y2=y1+this.helperProportions.height,l=item.left,r=l+item.width,t=item.top,b=t+item.height,dyClick=this.offset.click.top,dxClick=this.offset.click.left,isOverElementHeight="x"===this.options.axis||y1+dyClick>t&&y1+dyClick<b,isOverElementWidth="y"===this.options.axis||x1+dxClick>l&&x1+dxClick<r,isOverElement=isOverElementHeight&&isOverElementWidth;return"pointer"===this.options.tolerance||this.options.forcePointerForContainers||"pointer"!==this.options.tolerance&&this.helperProportions[this.floating?"width":"height"]>item[this.floating?"width":"height"]?isOverElement:l<x1+this.helperProportions.width/2&&x2-this.helperProportions.width/2<r&&t<y1+this.helperProportions.height/2&&y2-this.helperProportions.height/2<b},_intersectsWithPointer:function(item){var isOverElementHeight="x"===this.options.axis||this._isOverAxis(this.positionAbs.top+this.offset.click.top,item.top,item.height),isOverElementWidth="y"===this.options.axis||this._isOverAxis(this.positionAbs.left+this.offset.click.left,item.left,item.width),isOverElement=isOverElementHeight&&isOverElementWidth,verticalDirection=this._getDragVerticalDirection(),horizontalDirection=this._getDragHorizontalDirection();return!!isOverElement&&(this.floating?horizontalDirection&&"right"===horizontalDirection||"down"===verticalDirection?2:1:verticalDirection&&("down"===verticalDirection?2:1))},_intersectsWithSides:function(item){var isOverBottomHalf=this._isOverAxis(this.positionAbs.top+this.offset.click.top,item.top+item.height/2,item.height),isOverRightHalf=this._isOverAxis(this.positionAbs.left+this.offset.click.left,item.left+item.width/2,item.width),verticalDirection=this._getDragVerticalDirection(),horizontalDirection=this._getDragHorizontalDirection();return this.floating&&horizontalDirection?"right"===horizontalDirection&&isOverRightHalf||"left"===horizontalDirection&&!isOverRightHalf:verticalDirection&&("down"===verticalDirection&&isOverBottomHalf||"up"===verticalDirection&&!isOverBottomHalf)},_getDragVerticalDirection:function(){var delta=this.positionAbs.top-this.lastPositionAbs.top;return 0!==delta&&(delta>0?"down":"up")},_getDragHorizontalDirection:function(){var delta=this.positionAbs.left-this.lastPositionAbs.left;return 0!==delta&&(delta>0?"right":"left")},refresh:function(event){return this._refreshItems(event),this._setHandleClassName(),this.refreshPositions(),this},_connectWith:function(){var options=this.options;return options.connectWith.constructor===String?[options.connectWith]:options.connectWith},_getItemsAsjQuery:function(connected){var i,j,cur,inst,items=[],queries=[],connectWith=this._connectWith();if(connectWith&&connected)for(i=connectWith.length-1;i>=0;i--)for(cur=$(connectWith[i],this.document[0]),j=cur.length-1;j>=0;j--)(inst=$.data(cur[j],this.widgetFullName))&&inst!==this&&!inst.options.disabled&&queries.push([$.isFunction(inst.options.items)?inst.options.items.call(inst.element):$(inst.options.items,inst.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),inst]);queries.push([$.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):$(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);function addItems(){items.push(this)}for(i=queries.length-1;i>=0;i--)queries[i][0].each(addItems);return $(items)},_removeCurrentsFromItems:function(){var list=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=$.grep(this.items,function(item){for(var j=0;j<list.length;j++)if(list[j]===item.item[0])return!1;return!0})},_refreshItems:function(event){this.items=[],this.containers=[this];var i,j,cur,inst,targetData,_queries,item,queriesLength,items=this.items,queries=[[$.isFunction(this.options.items)?this.options.items.call(this.element[0],event,{item:this.currentItem}):$(this.options.items,this.element),this]],connectWith=this._connectWith();if(connectWith&&this.ready)for(i=connectWith.length-1;i>=0;i--)for(cur=$(connectWith[i],this.document[0]),j=cur.length-1;j>=0;j--)(inst=$.data(cur[j],this.widgetFullName))&&inst!==this&&!inst.options.disabled&&(queries.push([$.isFunction(inst.options.items)?inst.options.items.call(inst.element[0],event,{item:this.currentItem}):$(inst.options.items,inst.element),inst]),this.containers.push(inst));for(i=queries.length-1;i>=0;i--)for(targetData=queries[i][1],_queries=queries[i][0],j=0,queriesLength=_queries.length;j<queriesLength;j++)item=$(_queries[j]),item.data(this.widgetName+"-item",targetData),items.push({item:item,instance:targetData,width:0,height:0,left:0,top:0})},refreshPositions:function(fast){this.floating=!!this.items.length&&("x"===this.options.axis||this._isFloating(this.items[0].item)),this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());var i,item,t,p;for(i=this.items.length-1;i>=0;i--)item=this.items[i],item.instance!==this.currentContainer&&this.currentContainer&&item.item[0]!==this.currentItem[0]||(t=this.options.toleranceElement?$(this.options.toleranceElement,item.item):item.item,fast||(item.width=t.outerWidth(),item.height=t.outerHeight()),p=t.offset(),item.left=p.left,item.top=p.top);if(this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(i=this.containers.length-1;i>=0;i--)p=this.containers[i].element.offset(),this.containers[i].containerCache.left=p.left,this.containers[i].containerCache.top=p.top,this.containers[i].containerCache.width=this.containers[i].element.outerWidth(),this.containers[i].containerCache.height=this.containers[i].element.outerHeight();return this},_createPlaceholder:function(that){that=that||this;var className,o=that.options;o.placeholder&&o.placeholder.constructor!==String||(className=o.placeholder,o.placeholder={element:function(){var nodeName=that.currentItem[0].nodeName.toLowerCase(),element=$("<"+nodeName+">",that.document[0]).addClass(className||that.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper");return"tbody"===nodeName?that._createTrPlaceholder(that.currentItem.find("tr").eq(0),$("<tr>",that.document[0]).appendTo(element)):"tr"===nodeName?that._createTrPlaceholder(that.currentItem,element):"img"===nodeName&&element.attr("src",that.currentItem.attr("src")),className||element.css("visibility","hidden"),element},update:function(container,p){className&&!o.forcePlaceholderSize||(p.height()||p.height(that.currentItem.innerHeight()-parseInt(that.currentItem.css("paddingTop")||0,10)-parseInt(that.currentItem.css("paddingBottom")||0,10)),p.width()||p.width(that.currentItem.innerWidth()-parseInt(that.currentItem.css("paddingLeft")||0,10)-parseInt(that.currentItem.css("paddingRight")||0,10)))}}),that.placeholder=$(o.placeholder.element.call(that.element,that.currentItem)),that.currentItem.after(that.placeholder),o.placeholder.update(that,that.placeholder)},_createTrPlaceholder:function(sourceTr,targetTr){var that=this;sourceTr.children().each(function(){$("<td>&#160;</td>",that.document[0]).attr("colspan",$(this).attr("colspan")||1).appendTo(targetTr)})},_contactContainers:function(event){var i,j,dist,itemWithLeastDistance,posProperty,sizeProperty,cur,nearBottom,floating,axis,innermostContainer=null,innermostIndex=null;for(i=this.containers.length-1;i>=0;i--)if(!$.contains(this.currentItem[0],this.containers[i].element[0]))if(this._intersectsWith(this.containers[i].containerCache)){if(innermostContainer&&$.contains(this.containers[i].element[0],innermostContainer.element[0]))continue;innermostContainer=this.containers[i],innermostIndex=i}else this.containers[i].containerCache.over&&(this.containers[i]._trigger("out",event,this._uiHash(this)),this.containers[i].containerCache.over=0);if(innermostContainer)if(1===this.containers.length)this.containers[innermostIndex].containerCache.over||(this.containers[innermostIndex]._trigger("over",event,this._uiHash(this)),this.containers[innermostIndex].containerCache.over=1);else{for(dist=1e4,itemWithLeastDistance=null,floating=innermostContainer.floating||this._isFloating(this.currentItem),posProperty=floating?"left":"top",sizeProperty=floating?"width":"height",axis=floating?"clientX":"clientY",j=this.items.length-1;j>=0;j--)$.contains(this.containers[innermostIndex].element[0],this.items[j].item[0])&&this.items[j].item[0]!==this.currentItem[0]&&(cur=this.items[j].item.offset()[posProperty],nearBottom=!1,event[axis]-cur>this.items[j][sizeProperty]/2&&(nearBottom=!0),Math.abs(event[axis]-cur)<dist&&(dist=Math.abs(event[axis]-cur),itemWithLeastDistance=this.items[j],this.direction=nearBottom?"up":"down"));if(!itemWithLeastDistance&&!this.options.dropOnEmpty)return;if(this.currentContainer===this.containers[innermostIndex])return void(this.currentContainer.containerCache.over||(this.containers[innermostIndex]._trigger("over",event,this._uiHash()),this.currentContainer.containerCache.over=1));itemWithLeastDistance?this._rearrange(event,itemWithLeastDistance,null,!0):this._rearrange(event,null,this.containers[innermostIndex].element,!0),this._trigger("change",event,this._uiHash()),this.containers[innermostIndex]._trigger("change",event,this._uiHash(this)),this.currentContainer=this.containers[innermostIndex],this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[innermostIndex]._trigger("over",event,this._uiHash(this)),this.containers[innermostIndex].containerCache.over=1}},_createHelper:function(event){var o=this.options,helper=$.isFunction(o.helper)?$(o.helper.apply(this.element[0],[event,this.currentItem])):"clone"===o.helper?this.currentItem.clone():this.currentItem;return helper.parents("body").length||$("parent"!==o.appendTo?o.appendTo:this.currentItem[0].parentNode)[0].appendChild(helper[0]),helper[0]===this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),helper[0].style.width&&!o.forceHelperSize||helper.width(this.currentItem.width()),helper[0].style.height&&!o.forceHelperSize||helper.height(this.currentItem.height()),helper},_adjustOffsetFromHelper:function(obj){"string"==typeof obj&&(obj=obj.split(" ")),$.isArray(obj)&&(obj={left:+obj[0],top:+obj[1]||0}),"left"in obj&&(this.offset.click.left=obj.left+this.margins.left),"right"in obj&&(this.offset.click.left=this.helperProportions.width-obj.right+this.margins.left),"top"in obj&&(this.offset.click.top=obj.top+this.margins.top),"bottom"in obj&&(this.offset.click.top=this.helperProportions.height-obj.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var po=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==this.document[0]&&$.contains(this.scrollParent[0],this.offsetParent[0])&&(po.left+=this.scrollParent.scrollLeft(),po.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===this.document[0].body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&$.ui.ie)&&(po={top:0,left:0}),{top:po.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:po.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"===this.cssPosition){var p=this.currentItem.position();return{top:p.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:p.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var ce,co,over,o=this.options;"parent"===o.containment&&(o.containment=this.helper[0].parentNode),"document"!==o.containment&&"window"!==o.containment||(this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,"document"===o.containment?this.document.width():this.window.width()-this.helperProportions.width-this.margins.left,("document"===o.containment?this.document.width():this.window.height()||this.document[0].body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),/^(document|window|parent)$/.test(o.containment)||(ce=$(o.containment)[0],co=$(o.containment).offset(),over="hidden"!==$(ce).css("overflow"),this.containment=[co.left+(parseInt($(ce).css("borderLeftWidth"),10)||0)+(parseInt($(ce).css("paddingLeft"),10)||0)-this.margins.left,co.top+(parseInt($(ce).css("borderTopWidth"),10)||0)+(parseInt($(ce).css("paddingTop"),10)||0)-this.margins.top,co.left+(over?Math.max(ce.scrollWidth,ce.offsetWidth):ce.offsetWidth)-(parseInt($(ce).css("borderLeftWidth"),10)||0)-(parseInt($(ce).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,co.top+(over?Math.max(ce.scrollHeight,ce.offsetHeight):ce.offsetHeight)-(parseInt($(ce).css("borderTopWidth"),10)||0)-(parseInt($(ce).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top])},_convertPositionTo:function(d,pos){pos||(pos=this.position);var mod="absolute"===d?1:-1,scroll="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&$.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,scrollIsRootNode=/(html|body)/i.test(scroll[0].tagName);return{top:pos.top+this.offset.relative.top*mod+this.offset.parent.top*mod-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():scrollIsRootNode?0:scroll.scrollTop())*mod,left:pos.left+this.offset.relative.left*mod+this.offset.parent.left*mod-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():scrollIsRootNode?0:scroll.scrollLeft())*mod}},_generatePosition:function(event){var top,left,o=this.options,pageX=event.pageX,pageY=event.pageY,scroll="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&$.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,scrollIsRootNode=/(html|body)/i.test(scroll[0].tagName);return"relative"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&this.scrollParent[0]!==this.offsetParent[0]||(this.offset.relative=this._getRelativeOffset()),this.originalPosition&&(this.containment&&(event.pageX-this.offset.click.left<this.containment[0]&&(pageX=this.containment[0]+this.offset.click.left),event.pageY-this.offset.click.top<this.containment[1]&&(pageY=this.containment[1]+this.offset.click.top),event.pageX-this.offset.click.left>this.containment[2]&&(pageX=this.containment[2]+this.offset.click.left),event.pageY-this.offset.click.top>this.containment[3]&&(pageY=this.containment[3]+this.offset.click.top)),o.grid&&(top=this.originalPageY+Math.round((pageY-this.originalPageY)/o.grid[1])*o.grid[1],pageY=this.containment?top-this.offset.click.top>=this.containment[1]&&top-this.offset.click.top<=this.containment[3]?top:top-this.offset.click.top>=this.containment[1]?top-o.grid[1]:top+o.grid[1]:top,left=this.originalPageX+Math.round((pageX-this.originalPageX)/o.grid[0])*o.grid[0],pageX=this.containment?left-this.offset.click.left>=this.containment[0]&&left-this.offset.click.left<=this.containment[2]?left:left-this.offset.click.left>=this.containment[0]?left-o.grid[0]:left+o.grid[0]:left)),{top:pageY-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():scrollIsRootNode?0:scroll.scrollTop()),left:pageX-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():scrollIsRootNode?0:scroll.scrollLeft())}},_rearrange:function(event,i,a,hardRefresh){a?a[0].appendChild(this.placeholder[0]):i.item[0].parentNode.insertBefore(this.placeholder[0],"down"===this.direction?i.item[0]:i.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var counter=this.counter;this._delay(function(){counter===this.counter&&this.refreshPositions(!hardRefresh)})},_clear:function(event,noPropagation){this.reverting=!1;var i,delayedTriggers=[];if(!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null,this.helper[0]===this.currentItem[0]){for(i in this._storedCSS)"auto"!==this._storedCSS[i]&&"static"!==this._storedCSS[i]||(this._storedCSS[i]="");this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else this.currentItem.show();this.fromOutside&&!noPropagation&&delayedTriggers.push(function(event){this._trigger("receive",event,this._uiHash(this.fromOutside))}),!this.fromOutside&&this.domPosition.prev===this.currentItem.prev().not(".ui-sortable-helper")[0]&&this.domPosition.parent===this.currentItem.parent()[0]||noPropagation||delayedTriggers.push(function(event){this._trigger("update",event,this._uiHash())}),this!==this.currentContainer&&(noPropagation||(delayedTriggers.push(function(event){this._trigger("remove",event,this._uiHash())}),delayedTriggers.push(function(c){return function(event){c._trigger("receive",event,this._uiHash(this))}}.call(this,this.currentContainer)),delayedTriggers.push(function(c){return function(event){c._trigger("update",event,this._uiHash(this))}}.call(this,this.currentContainer))));function delayEvent(type,instance,container){return function(event){container._trigger(type,event,instance._uiHash(instance))}}for(i=this.containers.length-1;i>=0;i--)noPropagation||delayedTriggers.push(delayEvent("deactivate",this,this.containers[i])),this.containers[i].containerCache.over&&(delayedTriggers.push(delayEvent("out",this,this.containers[i])),this.containers[i].containerCache.over=0);if(this.storedCursor&&(this.document.find("body").css("cursor",this.storedCursor),this.storedStylesheet.remove()),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex","auto"===this._storedZIndex?"":this._storedZIndex),this.dragging=!1,noPropagation||this._trigger("beforeStop",event,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.cancelHelperRemoval||(this.helper[0]!==this.currentItem[0]&&this.helper.remove(),this.helper=null),!noPropagation){for(i=0;i<delayedTriggers.length;i++)delayedTriggers[i].call(this,event);this._trigger("stop",event,this._uiHash())}return this.fromOutside=!1,!this.cancelHelperRemoval},_trigger:function(){!1===$.Widget.prototype._trigger.apply(this,arguments)&&this.cancel()},_uiHash:function(_inst){var inst=_inst||this;return{helper:inst.helper,placeholder:inst.placeholder||$([]),position:inst.position,originalPosition:inst.originalPosition,offset:inst.positionAbs,item:inst.currentItem,sender:_inst?_inst.element:null}}}),$.widget("ui.accordion",{version:"1.11.4",options:{active:0,animate:{},collapsible:!1,event:"click",header:"> li > :first-child,> :not(li):even",heightStyle:"auto",icons:{activeHeader:"ui-icon-triangle-1-s",header:"ui-icon-triangle-1-e"},activate:null,beforeActivate:null},hideProps:{borderTopWidth:"hide",borderBottomWidth:"hide",paddingTop:"hide",paddingBottom:"hide",height:"hide"},showProps:{borderTopWidth:"show",borderBottomWidth:"show",paddingTop:"show",paddingBottom:"show",height:"show"},_create:function(){var options=this.options;this.prevShow=this.prevHide=$(),this.element.addClass("ui-accordion ui-widget ui-helper-reset").attr("role","tablist"),options.collapsible||!1!==options.active&&null!=options.active||(options.active=0),this._processPanels(),options.active<0&&(options.active+=this.headers.length),this._refresh()},_getCreateEventData:function(){return{header:this.active,panel:this.active.length?this.active.next():$()}},_createIcons:function(){var icons=this.options.icons;icons&&($("<span>").addClass("ui-accordion-header-icon ui-icon "+icons.header).prependTo(this.headers),this.active.children(".ui-accordion-header-icon").removeClass(icons.header).addClass(icons.activeHeader),this.headers.addClass("ui-accordion-icons"))},_destroyIcons:function(){this.headers.removeClass("ui-accordion-icons").children(".ui-accordion-header-icon").remove()},_destroy:function(){var contents;this.element.removeClass("ui-accordion ui-widget ui-helper-reset").removeAttr("role"),this.headers.removeClass("ui-accordion-header ui-accordion-header-active ui-state-default ui-corner-all ui-state-active ui-state-disabled ui-corner-top").removeAttr("role").removeAttr("aria-expanded").removeAttr("aria-selected").removeAttr("aria-controls").removeAttr("tabIndex").removeUniqueId(),this._destroyIcons(),contents=this.headers.next().removeClass("ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content ui-accordion-content-active ui-state-disabled").css("display","").removeAttr("role").removeAttr("aria-hidden").removeAttr("aria-labelledby").removeUniqueId(),"content"!==this.options.heightStyle&&contents.css("height","")},_setOption:function(key,value){if("active"===key)return void this._activate(value);"event"===key&&(this.options.event&&this._off(this.headers,this.options.event),this._setupEvents(value)),this._super(key,value),"collapsible"!==key||value||!1!==this.options.active||this._activate(0),"icons"===key&&(this._destroyIcons(),value&&this._createIcons()),"disabled"===key&&(this.element.toggleClass("ui-state-disabled",!!value).attr("aria-disabled",value),this.headers.add(this.headers.next()).toggleClass("ui-state-disabled",!!value))},_keydown:function(event){if(!event.altKey&&!event.ctrlKey){var keyCode=$.ui.keyCode,length=this.headers.length,currentIndex=this.headers.index(event.target),toFocus=!1;switch(event.keyCode){case keyCode.RIGHT:case keyCode.DOWN:toFocus=this.headers[(currentIndex+1)%length];break;case keyCode.LEFT:case keyCode.UP:toFocus=this.headers[(currentIndex-1+length)%length];break;case keyCode.SPACE:case keyCode.ENTER:this._eventHandler(event);break;case keyCode.HOME:toFocus=this.headers[0];break;case keyCode.END:toFocus=this.headers[length-1]}toFocus&&($(event.target).attr("tabIndex",-1),$(toFocus).attr("tabIndex",0),toFocus.focus(),event.preventDefault())}},_panelKeyDown:function(event){event.keyCode===$.ui.keyCode.UP&&event.ctrlKey&&$(event.currentTarget).prev().focus()},refresh:function(){var options=this.options;this._processPanels(),!1===options.active&&!0===options.collapsible||!this.headers.length?(options.active=!1,this.active=$()):!1===options.active?this._activate(0):this.active.length&&!$.contains(this.element[0],this.active[0])?this.headers.length===this.headers.find(".ui-state-disabled").length?(options.active=!1,this.active=$()):this._activate(Math.max(0,options.active-1)):options.active=this.headers.index(this.active),this._destroyIcons(),this._refresh()},_processPanels:function(){var prevHeaders=this.headers,prevPanels=this.panels;this.headers=this.element.find(this.options.header).addClass("ui-accordion-header ui-state-default ui-corner-all"),this.panels=this.headers.next().addClass("ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom").filter(":not(.ui-accordion-content-active)").hide(),prevPanels&&(this._off(prevHeaders.not(this.headers)),this._off(prevPanels.not(this.panels)))},_refresh:function(){var maxHeight,options=this.options,heightStyle=options.heightStyle,parent=this.element.parent();this.active=this._findActive(options.active).addClass("ui-accordion-header-active ui-state-active ui-corner-top").removeClass("ui-corner-all"),this.active.next().addClass("ui-accordion-content-active").show(),this.headers.attr("role","tab").each(function(){var header=$(this),headerId=header.uniqueId().attr("id"),panel=header.next(),panelId=panel.uniqueId().attr("id");header.attr("aria-controls",panelId),panel.attr("aria-labelledby",headerId)}).next().attr("role","tabpanel"),this.headers.not(this.active).attr({"aria-selected":"false","aria-expanded":"false",tabIndex:-1}).next().attr({"aria-hidden":"true"}).hide(),this.active.length?this.active.attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0}).next().attr({"aria-hidden":"false"}):this.headers.eq(0).attr("tabIndex",0),this._createIcons(),this._setupEvents(options.event),"fill"===heightStyle?(maxHeight=parent.height(),this.element.siblings(":visible").each(function(){var elem=$(this),position=elem.css("position");"absolute"!==position&&"fixed"!==position&&(maxHeight-=elem.outerHeight(!0))}),this.headers.each(function(){maxHeight-=$(this).outerHeight(!0)}),this.headers.next().each(function(){$(this).height(Math.max(0,maxHeight-$(this).innerHeight()+$(this).height()))}).css("overflow","auto")):"auto"===heightStyle&&(maxHeight=0,this.headers.next().each(function(){maxHeight=Math.max(maxHeight,$(this).css("height","").height())}).height(maxHeight))},_activate:function(index){var active=this._findActive(index)[0];active!==this.active[0]&&(active=active||this.active[0],this._eventHandler({target:active,currentTarget:active,preventDefault:$.noop}))},_findActive:function(selector){return"number"==typeof selector?this.headers.eq(selector):$()},_setupEvents:function(event){var events={keydown:"_keydown"};event&&$.each(event.split(" "),function(index,eventName){events[eventName]="_eventHandler"}),this._off(this.headers.add(this.headers.next())),this._on(this.headers,events),this._on(this.headers.next(),{keydown:"_panelKeyDown"}),this._hoverable(this.headers),this._focusable(this.headers)},_eventHandler:function(event){var options=this.options,active=this.active,clicked=$(event.currentTarget),clickedIsActive=clicked[0]===active[0],collapsing=clickedIsActive&&options.collapsible,toShow=collapsing?$():clicked.next(),toHide=active.next(),eventData={oldHeader:active,oldPanel:toHide,newHeader:collapsing?$():clicked,newPanel:toShow};event.preventDefault(),clickedIsActive&&!options.collapsible||!1===this._trigger("beforeActivate",event,eventData)||(options.active=!collapsing&&this.headers.index(clicked),this.active=clickedIsActive?$():clicked,this._toggle(eventData),active.removeClass("ui-accordion-header-active ui-state-active"),options.icons&&active.children(".ui-accordion-header-icon").removeClass(options.icons.activeHeader).addClass(options.icons.header),clickedIsActive||(clicked.removeClass("ui-corner-all").addClass("ui-accordion-header-active ui-state-active ui-corner-top"),options.icons&&clicked.children(".ui-accordion-header-icon").removeClass(options.icons.header).addClass(options.icons.activeHeader),clicked.next().addClass("ui-accordion-content-active")))},_toggle:function(data){var toShow=data.newPanel,toHide=this.prevShow.length?this.prevShow:data.oldPanel;this.prevShow.add(this.prevHide).stop(!0,!0),this.prevShow=toShow,this.prevHide=toHide,this.options.animate?this._animate(toShow,toHide,data):(toHide.hide(),toShow.show(),this._toggleComplete(data)),toHide.attr({"aria-hidden":"true"}),toHide.prev().attr({"aria-selected":"false","aria-expanded":"false"}),toShow.length&&toHide.length?toHide.prev().attr({tabIndex:-1,"aria-expanded":"false"}):toShow.length&&this.headers.filter(function(){return 0===parseInt($(this).attr("tabIndex"),10)}).attr("tabIndex",-1),
toShow.attr("aria-hidden","false").prev().attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0})},_animate:function(toShow,toHide,data){var total,easing,duration,that=this,adjust=0,boxSizing=toShow.css("box-sizing"),down=toShow.length&&(!toHide.length||toShow.index()<toHide.index()),animate=this.options.animate||{},options=down&&animate.down||animate,complete=function(){that._toggleComplete(data)};return"number"==typeof options&&(duration=options),"string"==typeof options&&(easing=options),easing=easing||options.easing||animate.easing,duration=duration||options.duration||animate.duration,toHide.length?toShow.length?(total=toShow.show().outerHeight(),toHide.animate(this.hideProps,{duration:duration,easing:easing,step:function(now,fx){fx.now=Math.round(now)}}),void toShow.hide().animate(this.showProps,{duration:duration,easing:easing,complete:complete,step:function(now,fx){fx.now=Math.round(now),"height"!==fx.prop?"content-box"===boxSizing&&(adjust+=fx.now):"content"!==that.options.heightStyle&&(fx.now=Math.round(total-toHide.outerHeight()-adjust),adjust=0)}})):toHide.animate(this.hideProps,duration,easing,complete):toShow.animate(this.showProps,duration,easing,complete)},_toggleComplete:function(data){var toHide=data.oldPanel;toHide.removeClass("ui-accordion-content-active").prev().removeClass("ui-corner-top").addClass("ui-corner-all"),toHide.length&&(toHide.parent()[0].className=toHide.parent()[0].className),this._trigger("activate",null,data)}}),$.widget("ui.menu",{version:"1.11.4",defaultElement:"<ul>",delay:300,options:{icons:{submenu:"ui-icon-carat-1-e"},items:"> *",menus:"ul",position:{my:"left-1 top",at:"right top"},role:"menu",blur:null,focus:null,select:null},_create:function(){this.activeMenu=this.element,this.mouseHandled=!1,this.element.uniqueId().addClass("ui-menu ui-widget ui-widget-content").toggleClass("ui-menu-icons",!!this.element.find(".ui-icon").length).attr({role:this.options.role,tabIndex:0}),this.options.disabled&&this.element.addClass("ui-state-disabled").attr("aria-disabled","true"),this._on({"mousedown .ui-menu-item":function(event){event.preventDefault()},"click .ui-menu-item":function(event){var target=$(event.target);!this.mouseHandled&&target.not(".ui-state-disabled").length&&(this.select(event),event.isPropagationStopped()||(this.mouseHandled=!0),target.has(".ui-menu").length?this.expand(event):!this.element.is(":focus")&&$(this.document[0].activeElement).closest(".ui-menu").length&&(this.element.trigger("focus",[!0]),this.active&&1===this.active.parents(".ui-menu").length&&clearTimeout(this.timer)))},"mouseenter .ui-menu-item":function(event){if(!this.previousFilter){var target=$(event.currentTarget);target.siblings(".ui-state-active").removeClass("ui-state-active"),this.focus(event,target)}},mouseleave:"collapseAll","mouseleave .ui-menu":"collapseAll",focus:function(event,keepActiveItem){var item=this.active||this.element.find(this.options.items).eq(0);keepActiveItem||this.focus(event,item)},blur:function(event){this._delay(function(){$.contains(this.element[0],this.document[0].activeElement)||this.collapseAll(event)})},keydown:"_keydown"}),this.refresh(),this._on(this.document,{click:function(event){this._closeOnDocumentClick(event)&&this.collapseAll(event),this.mouseHandled=!1}})},_destroy:function(){this.element.removeAttr("aria-activedescendant").find(".ui-menu").addBack().removeClass("ui-menu ui-widget ui-widget-content ui-menu-icons ui-front").removeAttr("role").removeAttr("tabIndex").removeAttr("aria-labelledby").removeAttr("aria-expanded").removeAttr("aria-hidden").removeAttr("aria-disabled").removeUniqueId().show(),this.element.find(".ui-menu-item").removeClass("ui-menu-item").removeAttr("role").removeAttr("aria-disabled").removeUniqueId().removeClass("ui-state-hover").removeAttr("tabIndex").removeAttr("role").removeAttr("aria-haspopup").children().each(function(){var elem=$(this);elem.data("ui-menu-submenu-carat")&&elem.remove()}),this.element.find(".ui-menu-divider").removeClass("ui-menu-divider ui-widget-content")},_keydown:function(event){var match,prev,character,skip,preventDefault=!0;switch(event.keyCode){case $.ui.keyCode.PAGE_UP:this.previousPage(event);break;case $.ui.keyCode.PAGE_DOWN:this.nextPage(event);break;case $.ui.keyCode.HOME:this._move("first","first",event);break;case $.ui.keyCode.END:this._move("last","last",event);break;case $.ui.keyCode.UP:this.previous(event);break;case $.ui.keyCode.DOWN:this.next(event);break;case $.ui.keyCode.LEFT:this.collapse(event);break;case $.ui.keyCode.RIGHT:this.active&&!this.active.is(".ui-state-disabled")&&this.expand(event);break;case $.ui.keyCode.ENTER:case $.ui.keyCode.SPACE:this._activate(event);break;case $.ui.keyCode.ESCAPE:this.collapse(event);break;default:preventDefault=!1,prev=this.previousFilter||"",character=String.fromCharCode(event.keyCode),skip=!1,clearTimeout(this.filterTimer),character===prev?skip=!0:character=prev+character,match=this._filterMenuItems(character),match=skip&&-1!==match.index(this.active.next())?this.active.nextAll(".ui-menu-item"):match,match.length||(character=String.fromCharCode(event.keyCode),match=this._filterMenuItems(character)),match.length?(this.focus(event,match),this.previousFilter=character,this.filterTimer=this._delay(function(){delete this.previousFilter},1e3)):delete this.previousFilter}preventDefault&&event.preventDefault()},_activate:function(event){this.active.is(".ui-state-disabled")||(this.active.is("[aria-haspopup='true']")?this.expand(event):this.select(event))},refresh:function(){var menus,items,that=this,icon=this.options.icons.submenu,submenus=this.element.find(this.options.menus);this.element.toggleClass("ui-menu-icons",!!this.element.find(".ui-icon").length),submenus.filter(":not(.ui-menu)").addClass("ui-menu ui-widget ui-widget-content ui-front").hide().attr({role:this.options.role,"aria-hidden":"true","aria-expanded":"false"}).each(function(){var menu=$(this),item=menu.parent(),submenuCarat=$("<span>").addClass("ui-menu-icon ui-icon "+icon).data("ui-menu-submenu-carat",!0);item.attr("aria-haspopup","true").prepend(submenuCarat),menu.attr("aria-labelledby",item.attr("id"))}),menus=submenus.add(this.element),items=menus.find(this.options.items),items.not(".ui-menu-item").each(function(){var item=$(this);that._isDivider(item)&&item.addClass("ui-widget-content ui-menu-divider")}),items.not(".ui-menu-item, .ui-menu-divider").addClass("ui-menu-item").uniqueId().attr({tabIndex:-1,role:this._itemRole()}),items.filter(".ui-state-disabled").attr("aria-disabled","true"),this.active&&!$.contains(this.element[0],this.active[0])&&this.blur()},_itemRole:function(){return{menu:"menuitem",listbox:"option"}[this.options.role]},_setOption:function(key,value){"icons"===key&&this.element.find(".ui-menu-icon").removeClass(this.options.icons.submenu).addClass(value.submenu),"disabled"===key&&this.element.toggleClass("ui-state-disabled",!!value).attr("aria-disabled",value),this._super(key,value)},focus:function(event,item){var nested,focused;this.blur(event,event&&"focus"===event.type),this._scrollIntoView(item),this.active=item.first(),focused=this.active.addClass("ui-state-focus").removeClass("ui-state-active"),this.options.role&&this.element.attr("aria-activedescendant",focused.attr("id")),this.active.parent().closest(".ui-menu-item").addClass("ui-state-active"),event&&"keydown"===event.type?this._close():this.timer=this._delay(function(){this._close()},this.delay),nested=item.children(".ui-menu"),nested.length&&event&&/^mouse/.test(event.type)&&this._startOpening(nested),this.activeMenu=item.parent(),this._trigger("focus",event,{item:item})},_scrollIntoView:function(item){var borderTop,paddingTop,offset,scroll,elementHeight,itemHeight;this._hasScroll()&&(borderTop=parseFloat($.css(this.activeMenu[0],"borderTopWidth"))||0,paddingTop=parseFloat($.css(this.activeMenu[0],"paddingTop"))||0,offset=item.offset().top-this.activeMenu.offset().top-borderTop-paddingTop,scroll=this.activeMenu.scrollTop(),elementHeight=this.activeMenu.height(),itemHeight=item.outerHeight(),offset<0?this.activeMenu.scrollTop(scroll+offset):offset+itemHeight>elementHeight&&this.activeMenu.scrollTop(scroll+offset-elementHeight+itemHeight))},blur:function(event,fromFocus){fromFocus||clearTimeout(this.timer),this.active&&(this.active.removeClass("ui-state-focus"),this.active=null,this._trigger("blur",event,{item:this.active}))},_startOpening:function(submenu){clearTimeout(this.timer),"true"===submenu.attr("aria-hidden")&&(this.timer=this._delay(function(){this._close(),this._open(submenu)},this.delay))},_open:function(submenu){var position=$.extend({of:this.active},this.options.position);clearTimeout(this.timer),this.element.find(".ui-menu").not(submenu.parents(".ui-menu")).hide().attr("aria-hidden","true"),submenu.show().removeAttr("aria-hidden").attr("aria-expanded","true").position(position)},collapseAll:function(event,all){clearTimeout(this.timer),this.timer=this._delay(function(){var currentMenu=all?this.element:$(event&&event.target).closest(this.element.find(".ui-menu"));currentMenu.length||(currentMenu=this.element),this._close(currentMenu),this.blur(event),this.activeMenu=currentMenu},this.delay)},_close:function(startMenu){startMenu||(startMenu=this.active?this.active.parent():this.element),startMenu.find(".ui-menu").hide().attr("aria-hidden","true").attr("aria-expanded","false").end().find(".ui-state-active").not(".ui-state-focus").removeClass("ui-state-active")},_closeOnDocumentClick:function(event){return!$(event.target).closest(".ui-menu").length},_isDivider:function(item){return!/[^\-\u2014\u2013\s]/.test(item.text())},collapse:function(event){var newItem=this.active&&this.active.parent().closest(".ui-menu-item",this.element);newItem&&newItem.length&&(this._close(),this.focus(event,newItem))},expand:function(event){var newItem=this.active&&this.active.children(".ui-menu ").find(this.options.items).first();newItem&&newItem.length&&(this._open(newItem.parent()),this._delay(function(){this.focus(event,newItem)}))},next:function(event){this._move("next","first",event)},previous:function(event){this._move("prev","last",event)},isFirstItem:function(){return this.active&&!this.active.prevAll(".ui-menu-item").length},isLastItem:function(){return this.active&&!this.active.nextAll(".ui-menu-item").length},_move:function(direction,filter,event){var next;this.active&&(next="first"===direction||"last"===direction?this.active["first"===direction?"prevAll":"nextAll"](".ui-menu-item").eq(-1):this.active[direction+"All"](".ui-menu-item").eq(0)),next&&next.length&&this.active||(next=this.activeMenu.find(this.options.items)[filter]()),this.focus(event,next)},nextPage:function(event){var item,base,height;if(!this.active)return void this.next(event);this.isLastItem()||(this._hasScroll()?(base=this.active.offset().top,height=this.element.height(),this.active.nextAll(".ui-menu-item").each(function(){return item=$(this),item.offset().top-base-height<0}),this.focus(event,item)):this.focus(event,this.activeMenu.find(this.options.items)[this.active?"last":"first"]()))},previousPage:function(event){var item,base,height;if(!this.active)return void this.next(event);this.isFirstItem()||(this._hasScroll()?(base=this.active.offset().top,height=this.element.height(),this.active.prevAll(".ui-menu-item").each(function(){return item=$(this),item.offset().top-base+height>0}),this.focus(event,item)):this.focus(event,this.activeMenu.find(this.options.items).first()))},_hasScroll:function(){return this.element.outerHeight()<this.element.prop("scrollHeight")},select:function(event){this.active=this.active||$(event.target).closest(".ui-menu-item");var ui={item:this.active};this.active.has(".ui-menu").length||this.collapseAll(event,!0),this._trigger("select",event,ui)},_filterMenuItems:function(character){var escapedCharacter=character.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),regex=new RegExp("^"+escapedCharacter,"i");return this.activeMenu.find(this.options.items).filter(".ui-menu-item").filter(function(){return regex.test($.trim($(this).text()))})}});$.widget("ui.autocomplete",{version:"1.11.4",defaultElement:"<input>",options:{appendTo:null,autoFocus:!1,delay:300,minLength:1,position:{my:"left top",at:"left bottom",collision:"none"},source:null,change:null,close:null,focus:null,open:null,response:null,search:null,select:null},requestIndex:0,pending:0,_create:function(){var suppressKeyPress,suppressKeyPressRepeat,suppressInput,nodeName=this.element[0].nodeName.toLowerCase(),isTextarea="textarea"===nodeName,isInput="input"===nodeName;this.isMultiLine=!!isTextarea||!isInput&&this.element.prop("isContentEditable"),this.valueMethod=this.element[isTextarea||isInput?"val":"text"],this.isNewMenu=!0,this.element.addClass("ui-autocomplete-input").attr("autocomplete","off"),this._on(this.element,{keydown:function(event){if(this.element.prop("readOnly"))return suppressKeyPress=!0,suppressInput=!0,void(suppressKeyPressRepeat=!0);suppressKeyPress=!1,suppressInput=!1,suppressKeyPressRepeat=!1;var keyCode=$.ui.keyCode;switch(event.keyCode){case keyCode.PAGE_UP:suppressKeyPress=!0,this._move("previousPage",event);break;case keyCode.PAGE_DOWN:suppressKeyPress=!0,this._move("nextPage",event);break;case keyCode.UP:suppressKeyPress=!0,this._keyEvent("previous",event);break;case keyCode.DOWN:suppressKeyPress=!0,this._keyEvent("next",event);break;case keyCode.ENTER:this.menu.active&&(suppressKeyPress=!0,event.preventDefault(),this.menu.select(event));break;case keyCode.TAB:this.menu.active&&this.menu.select(event);break;case keyCode.ESCAPE:this.menu.element.is(":visible")&&(this.isMultiLine||this._value(this.term),this.close(event),event.preventDefault());break;default:suppressKeyPressRepeat=!0,this._searchTimeout(event)}},keypress:function(event){if(suppressKeyPress)return suppressKeyPress=!1,void(this.isMultiLine&&!this.menu.element.is(":visible")||event.preventDefault());if(!suppressKeyPressRepeat){var keyCode=$.ui.keyCode;switch(event.keyCode){case keyCode.PAGE_UP:this._move("previousPage",event);break;case keyCode.PAGE_DOWN:this._move("nextPage",event);break;case keyCode.UP:this._keyEvent("previous",event);break;case keyCode.DOWN:this._keyEvent("next",event)}}},input:function(event){if(suppressInput)return suppressInput=!1,void event.preventDefault();this._searchTimeout(event)},focus:function(){this.selectedItem=null,this.previous=this._value()},blur:function(event){if(this.cancelBlur)return void delete this.cancelBlur;clearTimeout(this.searching),this.close(event),this._change(event)}}),this._initSource(),this.menu=$("<ul>").addClass("ui-autocomplete ui-front").appendTo(this._appendTo()).menu({role:null}).hide().menu("instance"),this._on(this.menu.element,{mousedown:function(event){event.preventDefault(),this.cancelBlur=!0,this._delay(function(){delete this.cancelBlur});var menuElement=this.menu.element[0];$(event.target).closest(".ui-menu-item").length||this._delay(function(){var that=this;this.document.one("mousedown",function(event){event.target===that.element[0]||event.target===menuElement||$.contains(menuElement,event.target)||that.close()})})},menufocus:function(event,ui){var label,item;if(this.isNewMenu&&(this.isNewMenu=!1,event.originalEvent&&/^mouse/.test(event.originalEvent.type)))return this.menu.blur(),void this.document.one("mousemove",function(){$(event.target).trigger(event.originalEvent)});item=ui.item.data("ui-autocomplete-item"),!1!==this._trigger("focus",event,{item:item})&&event.originalEvent&&/^key/.test(event.originalEvent.type)&&this._value(item.value),(label=ui.item.attr("aria-label")||item.value)&&$.trim(label).length&&(this.liveRegion.children().hide(),$("<div>").text(label).appendTo(this.liveRegion))},menuselect:function(event,ui){var item=ui.item.data("ui-autocomplete-item"),previous=this.previous;this.element[0]!==this.document[0].activeElement&&(this.element.focus(),this.previous=previous,this._delay(function(){this.previous=previous,this.selectedItem=item})),!1!==this._trigger("select",event,{item:item})&&this._value(item.value),this.term=this._value(),this.close(event),this.selectedItem=item}}),this.liveRegion=$("<span>",{role:"status","aria-live":"assertive","aria-relevant":"additions"}).addClass("ui-helper-hidden-accessible").appendTo(this.document[0].body),this._on(this.window,{beforeunload:function(){this.element.removeAttr("autocomplete")}})},_destroy:function(){clearTimeout(this.searching),this.element.removeClass("ui-autocomplete-input").removeAttr("autocomplete"),this.menu.element.remove(),this.liveRegion.remove()},_setOption:function(key,value){this._super(key,value),"source"===key&&this._initSource(),"appendTo"===key&&this.menu.element.appendTo(this._appendTo()),"disabled"===key&&value&&this.xhr&&this.xhr.abort()},_appendTo:function(){var element=this.options.appendTo;return element&&(element=element.jquery||element.nodeType?$(element):this.document.find(element).eq(0)),element&&element[0]||(element=this.element.closest(".ui-front")),element.length||(element=this.document[0].body),element},_initSource:function(){var array,url,that=this;$.isArray(this.options.source)?(array=this.options.source,this.source=function(request,response){response($.ui.autocomplete.filter(array,request.term))}):"string"==typeof this.options.source?(url=this.options.source,this.source=function(request,response){that.xhr&&that.xhr.abort(),that.xhr=$.ajax({url:url,data:request,dataType:"json",success:function(data){response(data)},error:function(){response([])}})}):this.source=this.options.source},_searchTimeout:function(event){clearTimeout(this.searching),this.searching=this._delay(function(){var equalValues=this.term===this._value(),menuVisible=this.menu.element.is(":visible"),modifierKey=event.altKey||event.ctrlKey||event.metaKey||event.shiftKey;equalValues&&(!equalValues||menuVisible||modifierKey)||(this.selectedItem=null,this.search(null,event))},this.options.delay)},search:function(value,event){return value=null!=value?value:this._value(),this.term=this._value(),value.length<this.options.minLength?this.close(event):!1!==this._trigger("search",event)?this._search(value):void 0},_search:function(value){this.pending++,this.element.addClass("ui-autocomplete-loading"),this.cancelSearch=!1,this.source({term:value},this._response())},_response:function(){var index=++this.requestIndex;return $.proxy(function(content){index===this.requestIndex&&this.__response(content),--this.pending||this.element.removeClass("ui-autocomplete-loading")},this)},__response:function(content){content&&(content=this._normalize(content)),this._trigger("response",null,{content:content}),!this.options.disabled&&content&&content.length&&!this.cancelSearch?(this._suggest(content),this._trigger("open")):this._close()},close:function(event){this.cancelSearch=!0,this._close(event)},_close:function(event){this.menu.element.is(":visible")&&(this.menu.element.hide(),this.menu.blur(),this.isNewMenu=!0,this._trigger("close",event))},_change:function(event){this.previous!==this._value()&&this._trigger("change",event,{item:this.selectedItem})},_normalize:function(items){return items.length&&items[0].label&&items[0].value?items:$.map(items,function(item){return"string"==typeof item?{label:item,value:item}:$.extend({},item,{label:item.label||item.value,value:item.value||item.label})})},_suggest:function(items){var ul=this.menu.element.empty();this._renderMenu(ul,items),this.isNewMenu=!0,this.menu.refresh(),ul.show(),this._resizeMenu(),ul.position($.extend({of:this.element},this.options.position)),this.options.autoFocus&&this.menu.next()},_resizeMenu:function(){var ul=this.menu.element;ul.outerWidth(Math.max(ul.width("").outerWidth()+1,this.element.outerWidth()))},_renderMenu:function(ul,items){var that=this;$.each(items,function(index,item){that._renderItemData(ul,item)})},_renderItemData:function(ul,item){return this._renderItem(ul,item).data("ui-autocomplete-item",item)},_renderItem:function(ul,item){return $("<li>").text(item.label).appendTo(ul)},_move:function(direction,event){return this.menu.element.is(":visible")?this.menu.isFirstItem()&&/^previous/.test(direction)||this.menu.isLastItem()&&/^next/.test(direction)?(this.isMultiLine||this._value(this.term),void this.menu.blur()):void this.menu[direction](event):void this.search(null,event)},widget:function(){return this.menu.element},_value:function(){return this.valueMethod.apply(this.element,arguments)},_keyEvent:function(keyEvent,event){this.isMultiLine&&!this.menu.element.is(":visible")||(this._move(keyEvent,event),event.preventDefault())}}),$.extend($.ui.autocomplete,{escapeRegex:function(value){return value.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")},filter:function(array,term){var matcher=new RegExp($.ui.autocomplete.escapeRegex(term),"i");return $.grep(array,function(value){return matcher.test(value.label||value.value||value)})}}),$.widget("ui.autocomplete",$.ui.autocomplete,{options:{messages:{noResults:"No search results.",results:function(amount){return amount+(amount>1?" results are":" result is")+" available, use up and down arrow keys to navigate."}}},__response:function(content){var message;this._superApply(arguments),this.options.disabled||this.cancelSearch||(message=content&&content.length?this.options.messages.results(content.length):this.options.messages.noResults,this.liveRegion.children().hide(),$("<div>").text(message).appendTo(this.liveRegion))}});var lastActive,baseClasses=($.ui.autocomplete,"ui-button ui-widget ui-state-default ui-corner-all"),typeClasses="ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",formResetHandler=function(){var form=$(this);setTimeout(function(){form.find(":ui-button").button("refresh")},1)},radioGroup=function(radio){var name=radio.name,form=radio.form,radios=$([]);return name&&(name=name.replace(/'/g,"\\'"),radios=form?$(form).find("[name='"+name+"'][type=radio]"):$("[name='"+name+"'][type=radio]",radio.ownerDocument).filter(function(){return!this.form})),radios};$.widget("ui.button",{version:"1.11.4",defaultElement:"<button>",options:{disabled:null,text:!0,label:null,icons:{primary:null,secondary:null}},_create:function(){this.element.closest("form").unbind("reset"+this.eventNamespace).bind("reset"+this.eventNamespace,formResetHandler),"boolean"!=typeof this.options.disabled?this.options.disabled=!!this.element.prop("disabled"):this.element.prop("disabled",this.options.disabled),this._determineButtonType(),this.hasTitle=!!this.buttonElement.attr("title");var that=this,options=this.options,toggleButton="checkbox"===this.type||"radio"===this.type,activeClass=toggleButton?"":"ui-state-active";null===options.label&&(options.label="input"===this.type?this.buttonElement.val():this.buttonElement.html()),this._hoverable(this.buttonElement),this.buttonElement.addClass(baseClasses).attr("role","button").bind("mouseenter"+this.eventNamespace,function(){options.disabled||this===lastActive&&$(this).addClass("ui-state-active")}).bind("mouseleave"+this.eventNamespace,function(){options.disabled||$(this).removeClass(activeClass)}).bind("click"+this.eventNamespace,function(event){options.disabled&&(event.preventDefault(),event.stopImmediatePropagation())}),this._on({focus:function(){this.buttonElement.addClass("ui-state-focus")},blur:function(){this.buttonElement.removeClass("ui-state-focus")}}),toggleButton&&this.element.bind("change"+this.eventNamespace,function(){that.refresh()}),"checkbox"===this.type?this.buttonElement.bind("click"+this.eventNamespace,function(){if(options.disabled)return!1}):"radio"===this.type?this.buttonElement.bind("click"+this.eventNamespace,function(){if(options.disabled)return!1;$(this).addClass("ui-state-active"),that.buttonElement.attr("aria-pressed","true");var radio=that.element[0];radioGroup(radio).not(radio).map(function(){return $(this).button("widget")[0]}).removeClass("ui-state-active").attr("aria-pressed","false")}):(this.buttonElement.bind("mousedown"+this.eventNamespace,function(){if(options.disabled)return!1;$(this).addClass("ui-state-active"),lastActive=this,that.document.one("mouseup",function(){lastActive=null})}).bind("mouseup"+this.eventNamespace,function(){if(options.disabled)return!1;$(this).removeClass("ui-state-active")}).bind("keydown"+this.eventNamespace,function(event){if(options.disabled)return!1;event.keyCode!==$.ui.keyCode.SPACE&&event.keyCode!==$.ui.keyCode.ENTER||$(this).addClass("ui-state-active")}).bind("keyup"+this.eventNamespace+" blur"+this.eventNamespace,function(){$(this).removeClass("ui-state-active")}),this.buttonElement.is("a")&&this.buttonElement.keyup(function(event){event.keyCode===$.ui.keyCode.SPACE&&$(this).click()})),this._setOption("disabled",options.disabled),this._resetButton()},_determineButtonType:function(){var ancestor,labelSelector,checked;this.element.is("[type=checkbox]")?this.type="checkbox":this.element.is("[type=radio]")?this.type="radio":this.element.is("input")?this.type="input":this.type="button","checkbox"===this.type||"radio"===this.type?(ancestor=this.element.parents().last(),labelSelector="label[for='"+this.element.attr("id")+"']",this.buttonElement=ancestor.find(labelSelector),this.buttonElement.length||(ancestor=ancestor.length?ancestor.siblings():this.element.siblings(),this.buttonElement=ancestor.filter(labelSelector),this.buttonElement.length||(this.buttonElement=ancestor.find(labelSelector))),this.element.addClass("ui-helper-hidden-accessible"),checked=this.element.is(":checked"),checked&&this.buttonElement.addClass("ui-state-active"),this.buttonElement.prop("aria-pressed",checked)):this.buttonElement=this.element},widget:function(){return this.buttonElement},_destroy:function(){this.element.removeClass("ui-helper-hidden-accessible"),this.buttonElement.removeClass(baseClasses+" ui-state-active "+typeClasses).removeAttr("role").removeAttr("aria-pressed").html(this.buttonElement.find(".ui-button-text").html()),this.hasTitle||this.buttonElement.removeAttr("title")},_setOption:function(key,value){if(this._super(key,value),"disabled"===key)return this.widget().toggleClass("ui-state-disabled",!!value),this.element.prop("disabled",!!value),void(value&&("checkbox"===this.type||"radio"===this.type?this.buttonElement.removeClass("ui-state-focus"):this.buttonElement.removeClass("ui-state-focus ui-state-active")));this._resetButton()},refresh:function(){var isDisabled=this.element.is("input, button")?this.element.is(":disabled"):this.element.hasClass("ui-button-disabled");isDisabled!==this.options.disabled&&this._setOption("disabled",isDisabled),"radio"===this.type?radioGroup(this.element[0]).each(function(){$(this).is(":checked")?$(this).button("widget").addClass("ui-state-active").attr("aria-pressed","true"):$(this).button("widget").removeClass("ui-state-active").attr("aria-pressed","false")}):"checkbox"===this.type&&(this.element.is(":checked")?this.buttonElement.addClass("ui-state-active").attr("aria-pressed","true"):this.buttonElement.removeClass("ui-state-active").attr("aria-pressed","false"))},_resetButton:function(){if("input"===this.type)return void(this.options.label&&this.element.val(this.options.label));var buttonElement=this.buttonElement.removeClass(typeClasses),buttonText=$("<span></span>",this.document[0]).addClass("ui-button-text").html(this.options.label).appendTo(buttonElement.empty()).text(),icons=this.options.icons,multipleIcons=icons.primary&&icons.secondary,buttonClasses=[];icons.primary||icons.secondary?(this.options.text&&buttonClasses.push("ui-button-text-icon"+(multipleIcons?"s":icons.primary?"-primary":"-secondary")),icons.primary&&buttonElement.prepend("<span class='ui-button-icon-primary ui-icon "+icons.primary+"'></span>"),icons.secondary&&buttonElement.append("<span class='ui-button-icon-secondary ui-icon "+icons.secondary+"'></span>"),this.options.text||(buttonClasses.push(multipleIcons?"ui-button-icons-only":"ui-button-icon-only"),this.hasTitle||buttonElement.attr("title",$.trim(buttonText)))):buttonClasses.push("ui-button-text-only"),buttonElement.addClass(buttonClasses.join(" "))}}),$.widget("ui.buttonset",{version:"1.11.4",options:{items:"button, input[type=button], input[type=submit], input[type=reset], input[type=checkbox], input[type=radio], a, :data(ui-button)"},_create:function(){this.element.addClass("ui-buttonset")},_init:function(){this.refresh()},_setOption:function(key,value){"disabled"===key&&this.buttons.button("option",key,value),this._super(key,value)},refresh:function(){var rtl="rtl"===this.element.css("direction"),allButtons=this.element.find(this.options.items),existingButtons=allButtons.filter(":ui-button");allButtons.not(":ui-button").button(),existingButtons.button("refresh"),this.buttons=allButtons.map(function(){return $(this).button("widget")[0]}).removeClass("ui-corner-all ui-corner-left ui-corner-right").filter(":first").addClass(rtl?"ui-corner-right":"ui-corner-left").end().filter(":last").addClass(rtl?"ui-corner-left":"ui-corner-right").end().end()},_destroy:function(){this.element.removeClass("ui-buttonset"),this.buttons.map(function(){return $(this).button("widget")[0]}).removeClass("ui-corner-left ui-corner-right").end().button("destroy")}});$.ui.button;$.extend($.ui,{datepicker:{version:"1.11.4"}});var datepicker_instActive;function datepicker_getZindex(elem){for(var position,value;elem.length&&elem[0]!==document;){if(("absolute"===(position=elem.css("position"))||"relative"===position||"fixed"===position)&&(value=parseInt(elem.css("zIndex"),10),!isNaN(value)&&0!==value))return value;elem=elem.parent()}return 0}function Datepicker(){this._curInst=null,this._keyEvent=!1,this._disabledInputs=[],this._datepickerShowing=!1,this._inDialog=!1,this._mainDivId="ui-datepicker-div",this._inlineClass="ui-datepicker-inline",this._appendClass="ui-datepicker-append",this._triggerClass="ui-datepicker-trigger",this._dialogClass="ui-datepicker-dialog",this._disableClass="ui-datepicker-disabled",this._unselectableClass="ui-datepicker-unselectable",this._currentClass="ui-datepicker-current-day",this._dayOverClass="ui-datepicker-days-cell-over",this.regional=[],this.regional[""]={closeText:"Done",prevText:"Prev",nextText:"Next",currentText:"Today",monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],dayNamesMin:["Su","Mo","Tu","We","Th","Fr","Sa"],weekHeader:"Wk",dateFormat:"mm/dd/yy",firstDay:0,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},this._defaults={showOn:"focus",showAnim:"fadeIn",showOptions:{},defaultDate:null,appendText:"",buttonText:"...",buttonImage:"",buttonImageOnly:!1,hideIfNoPrevNext:!1,navigationAsDateFormat:!1,gotoCurrent:!1,changeMonth:!1,changeYear:!1,yearRange:"c-10:c+10",showOtherMonths:!1,selectOtherMonths:!1,showWeek:!1,calculateWeek:this.iso8601Week,shortYearCutoff:"+10",minDate:null,maxDate:null,duration:"fast",beforeShowDay:null,beforeShow:null,onSelect:null,onChangeMonthYear:null,onClose:null,numberOfMonths:1,showCurrentAtPos:0,stepMonths:1,stepBigMonths:12,altField:"",altFormat:"",constrainInput:!0,showButtonPanel:!1,autoSize:!1,disabled:!1},$.extend(this._defaults,this.regional[""]),this.regional.en=$.extend(!0,{},this.regional[""]),this.regional["en-US"]=$.extend(!0,{},this.regional.en),this.dpDiv=datepicker_bindHover($("<div id='"+this._mainDivId+"' class='ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>"))}$.extend(Datepicker.prototype,{markerClassName:"hasDatepicker",maxRows:4,_widgetDatepicker:function(){return this.dpDiv},setDefaults:function(settings){return datepicker_extendRemove(this._defaults,settings||{}),this},_attachDatepicker:function(target,settings){var nodeName,inline,inst;nodeName=target.nodeName.toLowerCase(),
inline="div"===nodeName||"span"===nodeName,target.id||(this.uuid+=1,target.id="dp"+this.uuid),inst=this._newInst($(target),inline),inst.settings=$.extend({},settings||{}),"input"===nodeName?this._connectDatepicker(target,inst):inline&&this._inlineDatepicker(target,inst)},_newInst:function(target,inline){return{id:target[0].id.replace(/([^A-Za-z0-9_\-])/g,"\\\\$1"),input:target,selectedDay:0,selectedMonth:0,selectedYear:0,drawMonth:0,drawYear:0,inline:inline,dpDiv:inline?datepicker_bindHover($("<div class='"+this._inlineClass+" ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>")):this.dpDiv}},_connectDatepicker:function(target,inst){var input=$(target);inst.append=$([]),inst.trigger=$([]),input.hasClass(this.markerClassName)||(this._attachments(input,inst),input.addClass(this.markerClassName).keydown(this._doKeyDown).keypress(this._doKeyPress).keyup(this._doKeyUp),this._autoSize(inst),$.data(target,"datepicker",inst),inst.settings.disabled&&this._disableDatepicker(target))},_attachments:function(input,inst){var showOn,buttonText,buttonImage,appendText=this._get(inst,"appendText"),isRTL=this._get(inst,"isRTL");inst.append&&inst.append.remove(),appendText&&(inst.append=$("<span class='"+this._appendClass+"'>"+appendText+"</span>"),input[isRTL?"before":"after"](inst.append)),input.unbind("focus",this._showDatepicker),inst.trigger&&inst.trigger.remove(),showOn=this._get(inst,"showOn"),"focus"!==showOn&&"both"!==showOn||input.focus(this._showDatepicker),"button"!==showOn&&"both"!==showOn||(buttonText=this._get(inst,"buttonText"),buttonImage=this._get(inst,"buttonImage"),inst.trigger=$(this._get(inst,"buttonImageOnly")?$("<img/>").addClass(this._triggerClass).attr({src:buttonImage,alt:buttonText,title:buttonText}):$("<button type='button'></button>").addClass(this._triggerClass).html(buttonImage?$("<img/>").attr({src:buttonImage,alt:buttonText,title:buttonText}):buttonText)),input[isRTL?"before":"after"](inst.trigger),inst.trigger.click(function(){return $.datepicker._datepickerShowing&&$.datepicker._lastInput===input[0]?$.datepicker._hideDatepicker():$.datepicker._datepickerShowing&&$.datepicker._lastInput!==input[0]?($.datepicker._hideDatepicker(),$.datepicker._showDatepicker(input[0])):$.datepicker._showDatepicker(input[0]),!1}))},_autoSize:function(inst){if(this._get(inst,"autoSize")&&!inst.inline){var findMax,max,maxI,i,date=new Date(2009,11,20),dateFormat=this._get(inst,"dateFormat");dateFormat.match(/[DM]/)&&(findMax=function(names){for(max=0,maxI=0,i=0;i<names.length;i++)names[i].length>max&&(max=names[i].length,maxI=i);return maxI},date.setMonth(findMax(this._get(inst,dateFormat.match(/MM/)?"monthNames":"monthNamesShort"))),date.setDate(findMax(this._get(inst,dateFormat.match(/DD/)?"dayNames":"dayNamesShort"))+20-date.getDay())),inst.input.attr("size",this._formatDate(inst,date).length)}},_inlineDatepicker:function(target,inst){var divSpan=$(target);divSpan.hasClass(this.markerClassName)||(divSpan.addClass(this.markerClassName).append(inst.dpDiv),$.data(target,"datepicker",inst),this._setDate(inst,this._getDefaultDate(inst),!0),this._updateDatepicker(inst),this._updateAlternate(inst),inst.settings.disabled&&this._disableDatepicker(target),inst.dpDiv.css("display","block"))},_dialogDatepicker:function(input,date,onSelect,settings,pos){var id,browserWidth,browserHeight,scrollX,scrollY,inst=this._dialogInst;return inst||(this.uuid+=1,id="dp"+this.uuid,this._dialogInput=$("<input type='text' id='"+id+"' style='position: absolute; top: -100px; width: 0px;'/>"),this._dialogInput.keydown(this._doKeyDown),$("body").append(this._dialogInput),inst=this._dialogInst=this._newInst(this._dialogInput,!1),inst.settings={},$.data(this._dialogInput[0],"datepicker",inst)),datepicker_extendRemove(inst.settings,settings||{}),date=date&&date.constructor===Date?this._formatDate(inst,date):date,this._dialogInput.val(date),this._pos=pos?pos.length?pos:[pos.pageX,pos.pageY]:null,this._pos||(browserWidth=document.documentElement.clientWidth,browserHeight=document.documentElement.clientHeight,scrollX=document.documentElement.scrollLeft||document.body.scrollLeft,scrollY=document.documentElement.scrollTop||document.body.scrollTop,this._pos=[browserWidth/2-100+scrollX,browserHeight/2-150+scrollY]),this._dialogInput.css("left",this._pos[0]+20+"px").css("top",this._pos[1]+"px"),inst.settings.onSelect=onSelect,this._inDialog=!0,this.dpDiv.addClass(this._dialogClass),this._showDatepicker(this._dialogInput[0]),$.blockUI&&$.blockUI(this.dpDiv),$.data(this._dialogInput[0],"datepicker",inst),this},_destroyDatepicker:function(target){var nodeName,$target=$(target),inst=$.data(target,"datepicker");$target.hasClass(this.markerClassName)&&(nodeName=target.nodeName.toLowerCase(),$.removeData(target,"datepicker"),"input"===nodeName?(inst.append.remove(),inst.trigger.remove(),$target.removeClass(this.markerClassName).unbind("focus",this._showDatepicker).unbind("keydown",this._doKeyDown).unbind("keypress",this._doKeyPress).unbind("keyup",this._doKeyUp)):"div"!==nodeName&&"span"!==nodeName||$target.removeClass(this.markerClassName).empty(),datepicker_instActive===inst&&(datepicker_instActive=null))},_enableDatepicker:function(target){var nodeName,inline,$target=$(target),inst=$.data(target,"datepicker");$target.hasClass(this.markerClassName)&&(nodeName=target.nodeName.toLowerCase(),"input"===nodeName?(target.disabled=!1,inst.trigger.filter("button").each(function(){this.disabled=!1}).end().filter("img").css({opacity:"1.0",cursor:""})):"div"!==nodeName&&"span"!==nodeName||(inline=$target.children("."+this._inlineClass),inline.children().removeClass("ui-state-disabled"),inline.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!1)),this._disabledInputs=$.map(this._disabledInputs,function(value){return value===target?null:value}))},_disableDatepicker:function(target){var nodeName,inline,$target=$(target),inst=$.data(target,"datepicker");$target.hasClass(this.markerClassName)&&(nodeName=target.nodeName.toLowerCase(),"input"===nodeName?(target.disabled=!0,inst.trigger.filter("button").each(function(){this.disabled=!0}).end().filter("img").css({opacity:"0.5",cursor:"default"})):"div"!==nodeName&&"span"!==nodeName||(inline=$target.children("."+this._inlineClass),inline.children().addClass("ui-state-disabled"),inline.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!0)),this._disabledInputs=$.map(this._disabledInputs,function(value){return value===target?null:value}),this._disabledInputs[this._disabledInputs.length]=target)},_isDisabledDatepicker:function(target){if(!target)return!1;for(var i=0;i<this._disabledInputs.length;i++)if(this._disabledInputs[i]===target)return!0;return!1},_getInst:function(target){try{return $.data(target,"datepicker")}catch(err){throw"Missing instance data for this datepicker"}},_optionDatepicker:function(target,name,value){var settings,date,minDate,maxDate,inst=this._getInst(target);if(2===arguments.length&&"string"==typeof name)return"defaults"===name?$.extend({},$.datepicker._defaults):inst?"all"===name?$.extend({},inst.settings):this._get(inst,name):null;settings=name||{},"string"==typeof name&&(settings={},settings[name]=value),inst&&(this._curInst===inst&&this._hideDatepicker(),date=this._getDateDatepicker(target,!0),minDate=this._getMinMaxDate(inst,"min"),maxDate=this._getMinMaxDate(inst,"max"),datepicker_extendRemove(inst.settings,settings),null!==minDate&&void 0!==settings.dateFormat&&void 0===settings.minDate&&(inst.settings.minDate=this._formatDate(inst,minDate)),null!==maxDate&&void 0!==settings.dateFormat&&void 0===settings.maxDate&&(inst.settings.maxDate=this._formatDate(inst,maxDate)),"disabled"in settings&&(settings.disabled?this._disableDatepicker(target):this._enableDatepicker(target)),this._attachments($(target),inst),this._autoSize(inst),this._setDate(inst,date),this._updateAlternate(inst),this._updateDatepicker(inst))},_changeDatepicker:function(target,name,value){this._optionDatepicker(target,name,value)},_refreshDatepicker:function(target){var inst=this._getInst(target);inst&&this._updateDatepicker(inst)},_setDateDatepicker:function(target,date){var inst=this._getInst(target);inst&&(this._setDate(inst,date),this._updateDatepicker(inst),this._updateAlternate(inst))},_getDateDatepicker:function(target,noDefault){var inst=this._getInst(target);return inst&&!inst.inline&&this._setDateFromField(inst,noDefault),inst?this._getDate(inst):null},_doKeyDown:function(event){var onSelect,dateStr,sel,inst=$.datepicker._getInst(event.target),handled=!0,isRTL=inst.dpDiv.is(".ui-datepicker-rtl");if(inst._keyEvent=!0,$.datepicker._datepickerShowing)switch(event.keyCode){case 9:$.datepicker._hideDatepicker(),handled=!1;break;case 13:return sel=$("td."+$.datepicker._dayOverClass+":not(."+$.datepicker._currentClass+")",inst.dpDiv),sel[0]&&$.datepicker._selectDay(event.target,inst.selectedMonth,inst.selectedYear,sel[0]),onSelect=$.datepicker._get(inst,"onSelect"),onSelect?(dateStr=$.datepicker._formatDate(inst),onSelect.apply(inst.input?inst.input[0]:null,[dateStr,inst])):$.datepicker._hideDatepicker(),!1;case 27:$.datepicker._hideDatepicker();break;case 33:$.datepicker._adjustDate(event.target,event.ctrlKey?-$.datepicker._get(inst,"stepBigMonths"):-$.datepicker._get(inst,"stepMonths"),"M");break;case 34:$.datepicker._adjustDate(event.target,event.ctrlKey?+$.datepicker._get(inst,"stepBigMonths"):+$.datepicker._get(inst,"stepMonths"),"M");break;case 35:(event.ctrlKey||event.metaKey)&&$.datepicker._clearDate(event.target),handled=event.ctrlKey||event.metaKey;break;case 36:(event.ctrlKey||event.metaKey)&&$.datepicker._gotoToday(event.target),handled=event.ctrlKey||event.metaKey;break;case 37:(event.ctrlKey||event.metaKey)&&$.datepicker._adjustDate(event.target,isRTL?1:-1,"D"),handled=event.ctrlKey||event.metaKey,event.originalEvent.altKey&&$.datepicker._adjustDate(event.target,event.ctrlKey?-$.datepicker._get(inst,"stepBigMonths"):-$.datepicker._get(inst,"stepMonths"),"M");break;case 38:(event.ctrlKey||event.metaKey)&&$.datepicker._adjustDate(event.target,-7,"D"),handled=event.ctrlKey||event.metaKey;break;case 39:(event.ctrlKey||event.metaKey)&&$.datepicker._adjustDate(event.target,isRTL?-1:1,"D"),handled=event.ctrlKey||event.metaKey,event.originalEvent.altKey&&$.datepicker._adjustDate(event.target,event.ctrlKey?+$.datepicker._get(inst,"stepBigMonths"):+$.datepicker._get(inst,"stepMonths"),"M");break;case 40:(event.ctrlKey||event.metaKey)&&$.datepicker._adjustDate(event.target,7,"D"),handled=event.ctrlKey||event.metaKey;break;default:handled=!1}else 36===event.keyCode&&event.ctrlKey?$.datepicker._showDatepicker(this):handled=!1;handled&&(event.preventDefault(),event.stopPropagation())},_doKeyPress:function(event){var chars,chr,inst=$.datepicker._getInst(event.target);if($.datepicker._get(inst,"constrainInput"))return chars=$.datepicker._possibleChars($.datepicker._get(inst,"dateFormat")),chr=String.fromCharCode(null==event.charCode?event.keyCode:event.charCode),event.ctrlKey||event.metaKey||chr<" "||!chars||chars.indexOf(chr)>-1},_doKeyUp:function(event){var date,inst=$.datepicker._getInst(event.target);if(inst.input.val()!==inst.lastVal)try{date=$.datepicker.parseDate($.datepicker._get(inst,"dateFormat"),inst.input?inst.input.val():null,$.datepicker._getFormatConfig(inst)),date&&($.datepicker._setDateFromField(inst),$.datepicker._updateAlternate(inst),$.datepicker._updateDatepicker(inst))}catch(err){}return!0},_showDatepicker:function(input){if(input=input.target||input,"input"!==input.nodeName.toLowerCase()&&(input=$("input",input.parentNode)[0]),!$.datepicker._isDisabledDatepicker(input)&&$.datepicker._lastInput!==input){var inst,beforeShow,beforeShowSettings,isFixed,offset,showAnim,duration;inst=$.datepicker._getInst(input),$.datepicker._curInst&&$.datepicker._curInst!==inst&&($.datepicker._curInst.dpDiv.stop(!0,!0),inst&&$.datepicker._datepickerShowing&&$.datepicker._hideDatepicker($.datepicker._curInst.input[0])),beforeShow=$.datepicker._get(inst,"beforeShow"),beforeShowSettings=beforeShow?beforeShow.apply(input,[input,inst]):{},!1!==beforeShowSettings&&(datepicker_extendRemove(inst.settings,beforeShowSettings),inst.lastVal=null,$.datepicker._lastInput=input,$.datepicker._setDateFromField(inst),$.datepicker._inDialog&&(input.value=""),$.datepicker._pos||($.datepicker._pos=$.datepicker._findPos(input),$.datepicker._pos[1]+=input.offsetHeight),isFixed=!1,$(input).parents().each(function(){return!(isFixed|="fixed"===$(this).css("position"))}),offset={left:$.datepicker._pos[0],top:$.datepicker._pos[1]},$.datepicker._pos=null,inst.dpDiv.empty(),inst.dpDiv.css({position:"absolute",display:"block",top:"-1000px"}),$.datepicker._updateDatepicker(inst),offset=$.datepicker._checkOffset(inst,offset,isFixed),inst.dpDiv.css({position:$.datepicker._inDialog&&$.blockUI?"static":isFixed?"fixed":"absolute",display:"none",left:offset.left+"px",top:offset.top+"px"}),inst.inline||(showAnim=$.datepicker._get(inst,"showAnim"),duration=$.datepicker._get(inst,"duration"),inst.dpDiv.css("z-index",datepicker_getZindex($(input))+1),$.datepicker._datepickerShowing=!0,$.effects&&$.effects.effect[showAnim]?inst.dpDiv.show(showAnim,$.datepicker._get(inst,"showOptions"),duration):inst.dpDiv[showAnim||"show"](showAnim?duration:null),$.datepicker._shouldFocusInput(inst)&&inst.input.focus(),$.datepicker._curInst=inst))}},_updateDatepicker:function(inst){this.maxRows=4,datepicker_instActive=inst,inst.dpDiv.empty().append(this._generateHTML(inst)),this._attachHandlers(inst);var origyearshtml,numMonths=this._getNumberOfMonths(inst),cols=numMonths[1],activeCell=inst.dpDiv.find("."+this._dayOverClass+" a");activeCell.length>0&&datepicker_handleMouseover.apply(activeCell.get(0)),inst.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width(""),cols>1&&inst.dpDiv.addClass("ui-datepicker-multi-"+cols).css("width",17*cols+"em"),inst.dpDiv[(1!==numMonths[0]||1!==numMonths[1]?"add":"remove")+"Class"]("ui-datepicker-multi"),inst.dpDiv[(this._get(inst,"isRTL")?"add":"remove")+"Class"]("ui-datepicker-rtl"),inst===$.datepicker._curInst&&$.datepicker._datepickerShowing&&$.datepicker._shouldFocusInput(inst)&&inst.input.focus(),inst.yearshtml&&(origyearshtml=inst.yearshtml,setTimeout(function(){origyearshtml===inst.yearshtml&&inst.yearshtml&&inst.dpDiv.find("select.ui-datepicker-year:first").replaceWith(inst.yearshtml),origyearshtml=inst.yearshtml=null},0))},_shouldFocusInput:function(inst){return inst.input&&inst.input.is(":visible")&&!inst.input.is(":disabled")&&!inst.input.is(":focus")},_checkOffset:function(inst,offset,isFixed){var dpWidth=inst.dpDiv.outerWidth(),dpHeight=inst.dpDiv.outerHeight(),inputWidth=inst.input?inst.input.outerWidth():0,inputHeight=inst.input?inst.input.outerHeight():0,viewWidth=document.documentElement.clientWidth+(isFixed?0:$(document).scrollLeft()),viewHeight=document.documentElement.clientHeight+(isFixed?0:$(document).scrollTop());return offset.left-=this._get(inst,"isRTL")?dpWidth-inputWidth:0,offset.left-=isFixed&&offset.left===inst.input.offset().left?$(document).scrollLeft():0,offset.top-=isFixed&&offset.top===inst.input.offset().top+inputHeight?$(document).scrollTop():0,offset.left-=Math.min(offset.left,offset.left+dpWidth>viewWidth&&viewWidth>dpWidth?Math.abs(offset.left+dpWidth-viewWidth):0),offset.top-=Math.min(offset.top,offset.top+dpHeight>viewHeight&&viewHeight>dpHeight?Math.abs(dpHeight+inputHeight):0),offset},_findPos:function(obj){for(var position,inst=this._getInst(obj),isRTL=this._get(inst,"isRTL");obj&&("hidden"===obj.type||1!==obj.nodeType||$.expr.filters.hidden(obj));)obj=obj[isRTL?"previousSibling":"nextSibling"];return position=$(obj).offset(),[position.left,position.top]},_hideDatepicker:function(input){var showAnim,duration,postProcess,onClose,inst=this._curInst;!inst||input&&inst!==$.data(input,"datepicker")||this._datepickerShowing&&(showAnim=this._get(inst,"showAnim"),duration=this._get(inst,"duration"),postProcess=function(){$.datepicker._tidyDialog(inst)},$.effects&&($.effects.effect[showAnim]||$.effects[showAnim])?inst.dpDiv.hide(showAnim,$.datepicker._get(inst,"showOptions"),duration,postProcess):inst.dpDiv["slideDown"===showAnim?"slideUp":"fadeIn"===showAnim?"fadeOut":"hide"](showAnim?duration:null,postProcess),showAnim||postProcess(),this._datepickerShowing=!1,onClose=this._get(inst,"onClose"),onClose&&onClose.apply(inst.input?inst.input[0]:null,[inst.input?inst.input.val():"",inst]),this._lastInput=null,this._inDialog&&(this._dialogInput.css({position:"absolute",left:"0",top:"-100px"}),$.blockUI&&($.unblockUI(),$("body").append(this.dpDiv))),this._inDialog=!1)},_tidyDialog:function(inst){inst.dpDiv.removeClass(this._dialogClass).unbind(".ui-datepicker-calendar")},_checkExternalClick:function(event){if($.datepicker._curInst){var $target=$(event.target),inst=$.datepicker._getInst($target[0]);($target[0].id===$.datepicker._mainDivId||0!==$target.parents("#"+$.datepicker._mainDivId).length||$target.hasClass($.datepicker.markerClassName)||$target.closest("."+$.datepicker._triggerClass).length||!$.datepicker._datepickerShowing||$.datepicker._inDialog&&$.blockUI)&&(!$target.hasClass($.datepicker.markerClassName)||$.datepicker._curInst===inst)||$.datepicker._hideDatepicker()}},_adjustDate:function(id,offset,period){var target=$(id),inst=this._getInst(target[0]);this._isDisabledDatepicker(target[0])||(this._adjustInstDate(inst,offset+("M"===period?this._get(inst,"showCurrentAtPos"):0),period),this._updateDatepicker(inst))},_gotoToday:function(id){var date,target=$(id),inst=this._getInst(target[0]);this._get(inst,"gotoCurrent")&&inst.currentDay?(inst.selectedDay=inst.currentDay,inst.drawMonth=inst.selectedMonth=inst.currentMonth,inst.drawYear=inst.selectedYear=inst.currentYear):(date=new Date,inst.selectedDay=date.getDate(),inst.drawMonth=inst.selectedMonth=date.getMonth(),inst.drawYear=inst.selectedYear=date.getFullYear()),this._notifyChange(inst),this._adjustDate(target)},_selectMonthYear:function(id,select,period){var target=$(id),inst=this._getInst(target[0]);inst["selected"+("M"===period?"Month":"Year")]=inst["draw"+("M"===period?"Month":"Year")]=parseInt(select.options[select.selectedIndex].value,10),this._notifyChange(inst),this._adjustDate(target)},_selectDay:function(id,month,year,td){var inst,target=$(id);$(td).hasClass(this._unselectableClass)||this._isDisabledDatepicker(target[0])||(inst=this._getInst(target[0]),inst.selectedDay=inst.currentDay=$("a",td).html(),inst.selectedMonth=inst.currentMonth=month,inst.selectedYear=inst.currentYear=year,this._selectDate(id,this._formatDate(inst,inst.currentDay,inst.currentMonth,inst.currentYear)))},_clearDate:function(id){var target=$(id);this._selectDate(target,"")},_selectDate:function(id,dateStr){var onSelect,target=$(id),inst=this._getInst(target[0]);dateStr=null!=dateStr?dateStr:this._formatDate(inst),inst.input&&inst.input.val(dateStr),this._updateAlternate(inst),onSelect=this._get(inst,"onSelect"),onSelect?onSelect.apply(inst.input?inst.input[0]:null,[dateStr,inst]):inst.input&&inst.input.trigger("change"),inst.inline?this._updateDatepicker(inst):(this._hideDatepicker(),this._lastInput=inst.input[0],"object"!=typeof inst.input[0]&&inst.input.focus(),this._lastInput=null)},_updateAlternate:function(inst){var altFormat,date,dateStr,altField=this._get(inst,"altField");altField&&(altFormat=this._get(inst,"altFormat")||this._get(inst,"dateFormat"),date=this._getDate(inst),dateStr=this.formatDate(altFormat,date,this._getFormatConfig(inst)),$(altField).each(function(){$(this).val(dateStr)}))},noWeekends:function(date){var day=date.getDay();return[day>0&&day<6,""]},iso8601Week:function(date){var time,checkDate=new Date(date.getTime());return checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7)),time=checkDate.getTime(),checkDate.setMonth(0),checkDate.setDate(1),Math.floor(Math.round((time-checkDate)/864e5)/7)+1},parseDate:function(format,value,settings){if(null==format||null==value)throw"Invalid arguments";if(""===(value="object"==typeof value?value.toString():value+""))return null;var iFormat,dim,extra,date,iValue=0,shortYearCutoffTemp=(settings?settings.shortYearCutoff:null)||this._defaults.shortYearCutoff,shortYearCutoff="string"!=typeof shortYearCutoffTemp?shortYearCutoffTemp:(new Date).getFullYear()%100+parseInt(shortYearCutoffTemp,10),dayNamesShort=(settings?settings.dayNamesShort:null)||this._defaults.dayNamesShort,dayNames=(settings?settings.dayNames:null)||this._defaults.dayNames,monthNamesShort=(settings?settings.monthNamesShort:null)||this._defaults.monthNamesShort,monthNames=(settings?settings.monthNames:null)||this._defaults.monthNames,year=-1,month=-1,day=-1,doy=-1,literal=!1,lookAhead=function(match){var matches=iFormat+1<format.length&&format.charAt(iFormat+1)===match;return matches&&iFormat++,matches},getNumber=function(match){var isDoubled=lookAhead(match),size="@"===match?14:"!"===match?20:"y"===match&&isDoubled?4:"o"===match?3:2,minSize="y"===match?size:1,digits=new RegExp("^\\d{"+minSize+","+size+"}"),num=value.substring(iValue).match(digits);if(!num)throw"Missing number at position "+iValue;return iValue+=num[0].length,parseInt(num[0],10)},getName=function(match,shortNames,longNames){var index=-1,names=$.map(lookAhead(match)?longNames:shortNames,function(v,k){return[[k,v]]}).sort(function(a,b){return-(a[1].length-b[1].length)});if($.each(names,function(i,pair){var name=pair[1];if(value.substr(iValue,name.length).toLowerCase()===name.toLowerCase())return index=pair[0],iValue+=name.length,!1}),-1!==index)return index+1;throw"Unknown name at position "+iValue},checkLiteral=function(){if(value.charAt(iValue)!==format.charAt(iFormat))throw"Unexpected literal at position "+iValue;iValue++};for(iFormat=0;iFormat<format.length;iFormat++)if(literal)"'"!==format.charAt(iFormat)||lookAhead("'")?checkLiteral():literal=!1;else switch(format.charAt(iFormat)){case"d":day=getNumber("d");break;case"D":getName("D",dayNamesShort,dayNames);break;case"o":doy=getNumber("o");break;case"m":month=getNumber("m");break;case"M":month=getName("M",monthNamesShort,monthNames);break;case"y":year=getNumber("y");break;case"@":date=new Date(getNumber("@")),year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate();break;case"!":date=new Date((getNumber("!")-this._ticksTo1970)/1e4),year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate();break;case"'":lookAhead("'")?checkLiteral():literal=!0;break;default:checkLiteral()}if(iValue<value.length&&(extra=value.substr(iValue),!/^\s+/.test(extra)))throw"Extra/unparsed characters found in date: "+extra;if(-1===year?year=(new Date).getFullYear():year<100&&(year+=(new Date).getFullYear()-(new Date).getFullYear()%100+(year<=shortYearCutoff?0:-100)),doy>-1)for(month=1,day=doy;;){if(dim=this._getDaysInMonth(year,month-1),day<=dim)break;month++,day-=dim}if(date=this._daylightSavingAdjust(new Date(year,month-1,day)),date.getFullYear()!==year||date.getMonth()+1!==month||date.getDate()!==day)throw"Invalid date";return date},ATOM:"yy-mm-dd",COOKIE:"D, dd M yy",ISO_8601:"yy-mm-dd",RFC_822:"D, d M y",RFC_850:"DD, dd-M-y",RFC_1036:"D, d M y",RFC_1123:"D, d M yy",RFC_2822:"D, d M yy",RSS:"D, d M y",TICKS:"!",TIMESTAMP:"@",W3C:"yy-mm-dd",_ticksTo1970:24*(718685+Math.floor(492.5)-Math.floor(19.7)+Math.floor(4.925))*60*60*1e7,formatDate:function(format,date,settings){if(!date)return"";var iFormat,dayNamesShort=(settings?settings.dayNamesShort:null)||this._defaults.dayNamesShort,dayNames=(settings?settings.dayNames:null)||this._defaults.dayNames,monthNamesShort=(settings?settings.monthNamesShort:null)||this._defaults.monthNamesShort,monthNames=(settings?settings.monthNames:null)||this._defaults.monthNames,lookAhead=function(match){var matches=iFormat+1<format.length&&format.charAt(iFormat+1)===match;return matches&&iFormat++,matches},formatNumber=function(match,value,len){var num=""+value;if(lookAhead(match))for(;num.length<len;)num="0"+num;return num},formatName=function(match,value,shortNames,longNames){return lookAhead(match)?longNames[value]:shortNames[value]},output="",literal=!1;if(date)for(iFormat=0;iFormat<format.length;iFormat++)if(literal)"'"!==format.charAt(iFormat)||lookAhead("'")?output+=format.charAt(iFormat):literal=!1;else switch(format.charAt(iFormat)){case"d":output+=formatNumber("d",date.getDate(),2);break;case"D":output+=formatName("D",date.getDay(),dayNamesShort,dayNames);break;case"o":output+=formatNumber("o",Math.round((new Date(date.getFullYear(),date.getMonth(),date.getDate()).getTime()-new Date(date.getFullYear(),0,0).getTime())/864e5),3);break;case"m":output+=formatNumber("m",date.getMonth()+1,2);break;case"M":output+=formatName("M",date.getMonth(),monthNamesShort,monthNames);break;case"y":output+=lookAhead("y")?date.getFullYear():(date.getYear()%100<10?"0":"")+date.getYear()%100;break;case"@":output+=date.getTime();break;case"!":output+=1e4*date.getTime()+this._ticksTo1970;break;case"'":lookAhead("'")?output+="'":literal=!0;break;default:output+=format.charAt(iFormat)}return output},_possibleChars:function(format){var iFormat,chars="",literal=!1,lookAhead=function(match){var matches=iFormat+1<format.length&&format.charAt(iFormat+1)===match;return matches&&iFormat++,matches};for(iFormat=0;iFormat<format.length;iFormat++)if(literal)"'"!==format.charAt(iFormat)||lookAhead("'")?chars+=format.charAt(iFormat):literal=!1;else switch(format.charAt(iFormat)){case"d":case"m":case"y":case"@":chars+="0123456789";break;case"D":case"M":return null;case"'":lookAhead("'")?chars+="'":literal=!0;break;default:chars+=format.charAt(iFormat)}return chars},_get:function(inst,name){return void 0!==inst.settings[name]?inst.settings[name]:this._defaults[name]},_setDateFromField:function(inst,noDefault){if(inst.input.val()!==inst.lastVal){var dateFormat=this._get(inst,"dateFormat"),dates=inst.lastVal=inst.input?inst.input.val():null,defaultDate=this._getDefaultDate(inst),date=defaultDate,settings=this._getFormatConfig(inst);try{date=this.parseDate(dateFormat,dates,settings)||defaultDate}catch(event){dates=noDefault?"":dates}inst.selectedDay=date.getDate(),inst.drawMonth=inst.selectedMonth=date.getMonth(),inst.drawYear=inst.selectedYear=date.getFullYear(),inst.currentDay=dates?date.getDate():0,inst.currentMonth=dates?date.getMonth():0,inst.currentYear=dates?date.getFullYear():0,this._adjustInstDate(inst)}},_getDefaultDate:function(inst){return this._restrictMinMax(inst,this._determineDate(inst,this._get(inst,"defaultDate"),new Date))},_determineDate:function(inst,date,defaultDate){var newDate=null==date||""===date?defaultDate:"string"==typeof date?function(offset){try{return $.datepicker.parseDate($.datepicker._get(inst,"dateFormat"),offset,$.datepicker._getFormatConfig(inst))}catch(e){}for(var date=(offset.toLowerCase().match(/^c/)?$.datepicker._getDate(inst):null)||new Date,year=date.getFullYear(),month=date.getMonth(),day=date.getDate(),pattern=/([+\-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,matches=pattern.exec(offset);matches;){switch(matches[2]||"d"){case"d":case"D":day+=parseInt(matches[1],10);break;case"w":case"W":day+=7*parseInt(matches[1],10);break;case"m":case"M":month+=parseInt(matches[1],10),day=Math.min(day,$.datepicker._getDaysInMonth(year,month));break;case"y":case"Y":year+=parseInt(matches[1],10),day=Math.min(day,$.datepicker._getDaysInMonth(year,month))}matches=pattern.exec(offset)}return new Date(year,month,day)}(date):"number"==typeof date?isNaN(date)?defaultDate:function(offset){var date=new Date;return date.setDate(date.getDate()+offset),date}(date):new Date(date.getTime());return newDate=newDate&&"Invalid Date"===newDate.toString()?defaultDate:newDate,newDate&&(newDate.setHours(0),newDate.setMinutes(0),newDate.setSeconds(0),newDate.setMilliseconds(0)),this._daylightSavingAdjust(newDate)},_daylightSavingAdjust:function(date){return date?(date.setHours(date.getHours()>12?date.getHours()+2:0),date):null},_setDate:function(inst,date,noChange){var clear=!date,origMonth=inst.selectedMonth,origYear=inst.selectedYear,newDate=this._restrictMinMax(inst,this._determineDate(inst,date,new Date));inst.selectedDay=inst.currentDay=newDate.getDate(),inst.drawMonth=inst.selectedMonth=inst.currentMonth=newDate.getMonth(),inst.drawYear=inst.selectedYear=inst.currentYear=newDate.getFullYear(),origMonth===inst.selectedMonth&&origYear===inst.selectedYear||noChange||this._notifyChange(inst),this._adjustInstDate(inst),inst.input&&inst.input.val(clear?"":this._formatDate(inst))},_getDate:function(inst){return!inst.currentYear||inst.input&&""===inst.input.val()?null:this._daylightSavingAdjust(new Date(inst.currentYear,inst.currentMonth,inst.currentDay))},_attachHandlers:function(inst){var stepMonths=this._get(inst,"stepMonths"),id="#"+inst.id.replace(/\\\\/g,"\\");inst.dpDiv.find("[data-handler]").map(function(){var handler={prev:function(){$.datepicker._adjustDate(id,-stepMonths,"M")},next:function(){$.datepicker._adjustDate(id,+stepMonths,"M")},hide:function(){$.datepicker._hideDatepicker()},today:function(){$.datepicker._gotoToday(id)},selectDay:function(){return $.datepicker._selectDay(id,+this.getAttribute("data-month"),+this.getAttribute("data-year"),this),!1},selectMonth:function(){return $.datepicker._selectMonthYear(id,this,"M"),!1},selectYear:function(){return $.datepicker._selectMonthYear(id,this,"Y"),!1}};$(this).bind(this.getAttribute("data-event"),handler[this.getAttribute("data-handler")])})},_generateHTML:function(inst){var maxDraw,prevText,prev,nextText,next,currentText,gotoDate,controls,buttonPanel,firstDay,showWeek,dayNames,dayNamesMin,monthNames,monthNamesShort,beforeShowDay,showOtherMonths,selectOtherMonths,defaultDate,html,dow,row,group,col,selectedDate,cornerClass,calender,thead,day,daysInMonth,leadDays,curRows,numRows,printDate,dRow,tbody,daySettings,otherMonth,unselectable,tempDate=new Date,today=this._daylightSavingAdjust(new Date(tempDate.getFullYear(),tempDate.getMonth(),tempDate.getDate())),isRTL=this._get(inst,"isRTL"),showButtonPanel=this._get(inst,"showButtonPanel"),hideIfNoPrevNext=this._get(inst,"hideIfNoPrevNext"),navigationAsDateFormat=this._get(inst,"navigationAsDateFormat"),numMonths=this._getNumberOfMonths(inst),showCurrentAtPos=this._get(inst,"showCurrentAtPos"),stepMonths=this._get(inst,"stepMonths"),isMultiMonth=1!==numMonths[0]||1!==numMonths[1],currentDate=this._daylightSavingAdjust(inst.currentDay?new Date(inst.currentYear,inst.currentMonth,inst.currentDay):new Date(9999,9,9)),minDate=this._getMinMaxDate(inst,"min"),maxDate=this._getMinMaxDate(inst,"max"),drawMonth=inst.drawMonth-showCurrentAtPos,drawYear=inst.drawYear;if(drawMonth<0&&(drawMonth+=12,drawYear--),maxDate)for(maxDraw=this._daylightSavingAdjust(new Date(maxDate.getFullYear(),maxDate.getMonth()-numMonths[0]*numMonths[1]+1,maxDate.getDate())),maxDraw=minDate&&maxDraw<minDate?minDate:maxDraw;this._daylightSavingAdjust(new Date(drawYear,drawMonth,1))>maxDraw;)--drawMonth<0&&(drawMonth=11,drawYear--);for(inst.drawMonth=drawMonth,inst.drawYear=drawYear,prevText=this._get(inst,"prevText"),prevText=navigationAsDateFormat?this.formatDate(prevText,this._daylightSavingAdjust(new Date(drawYear,drawMonth-stepMonths,1)),this._getFormatConfig(inst)):prevText,prev=this._canAdjustMonth(inst,-1,drawYear,drawMonth)?"<a class='ui-datepicker-prev ui-corner-all' data-handler='prev' data-event='click' title='"+prevText+"'><span class='ui-icon ui-icon-circle-triangle-"+(isRTL?"e":"w")+"'>"+prevText+"</span></a>":hideIfNoPrevNext?"":"<a class='ui-datepicker-prev ui-corner-all ui-state-disabled' title='"+prevText+"'><span class='ui-icon ui-icon-circle-triangle-"+(isRTL?"e":"w")+"'>"+prevText+"</span></a>",nextText=this._get(inst,"nextText"),nextText=navigationAsDateFormat?this.formatDate(nextText,this._daylightSavingAdjust(new Date(drawYear,drawMonth+stepMonths,1)),this._getFormatConfig(inst)):nextText,
next=this._canAdjustMonth(inst,1,drawYear,drawMonth)?"<a class='ui-datepicker-next ui-corner-all' data-handler='next' data-event='click' title='"+nextText+"'><span class='ui-icon ui-icon-circle-triangle-"+(isRTL?"w":"e")+"'>"+nextText+"</span></a>":hideIfNoPrevNext?"":"<a class='ui-datepicker-next ui-corner-all ui-state-disabled' title='"+nextText+"'><span class='ui-icon ui-icon-circle-triangle-"+(isRTL?"w":"e")+"'>"+nextText+"</span></a>",currentText=this._get(inst,"currentText"),gotoDate=this._get(inst,"gotoCurrent")&&inst.currentDay?currentDate:today,currentText=navigationAsDateFormat?this.formatDate(currentText,gotoDate,this._getFormatConfig(inst)):currentText,controls=inst.inline?"":"<button type='button' class='ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all' data-handler='hide' data-event='click'>"+this._get(inst,"closeText")+"</button>",buttonPanel=showButtonPanel?"<div class='ui-datepicker-buttonpane ui-widget-content'>"+(isRTL?controls:"")+(this._isInRange(inst,gotoDate)?"<button type='button' class='ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all' data-handler='today' data-event='click'>"+currentText+"</button>":"")+(isRTL?"":controls)+"</div>":"",firstDay=parseInt(this._get(inst,"firstDay"),10),firstDay=isNaN(firstDay)?0:firstDay,showWeek=this._get(inst,"showWeek"),dayNames=this._get(inst,"dayNames"),dayNamesMin=this._get(inst,"dayNamesMin"),monthNames=this._get(inst,"monthNames"),monthNamesShort=this._get(inst,"monthNamesShort"),beforeShowDay=this._get(inst,"beforeShowDay"),showOtherMonths=this._get(inst,"showOtherMonths"),selectOtherMonths=this._get(inst,"selectOtherMonths"),defaultDate=this._getDefaultDate(inst),html="",row=0;row<numMonths[0];row++){for(group="",this.maxRows=4,col=0;col<numMonths[1];col++){if(selectedDate=this._daylightSavingAdjust(new Date(drawYear,drawMonth,inst.selectedDay)),cornerClass=" ui-corner-all",calender="",isMultiMonth){if(calender+="<div class='ui-datepicker-group",numMonths[1]>1)switch(col){case 0:calender+=" ui-datepicker-group-first",cornerClass=" ui-corner-"+(isRTL?"right":"left");break;case numMonths[1]-1:calender+=" ui-datepicker-group-last",cornerClass=" ui-corner-"+(isRTL?"left":"right");break;default:calender+=" ui-datepicker-group-middle",cornerClass=""}calender+="'>"}for(calender+="<div class='ui-datepicker-header ui-widget-header ui-helper-clearfix"+cornerClass+"'>"+(/all|left/.test(cornerClass)&&0===row?isRTL?next:prev:"")+(/all|right/.test(cornerClass)&&0===row?isRTL?prev:next:"")+this._generateMonthYearHeader(inst,drawMonth,drawYear,minDate,maxDate,row>0||col>0,monthNames,monthNamesShort)+"</div><table class='ui-datepicker-calendar'><thead><tr>",thead=showWeek?"<th class='ui-datepicker-week-col'>"+this._get(inst,"weekHeader")+"</th>":"",dow=0;dow<7;dow++)day=(dow+firstDay)%7,thead+="<th scope='col'"+((dow+firstDay+6)%7>=5?" class='ui-datepicker-week-end'":"")+"><span title='"+dayNames[day]+"'>"+dayNamesMin[day]+"</span></th>";for(calender+=thead+"</tr></thead><tbody>",daysInMonth=this._getDaysInMonth(drawYear,drawMonth),drawYear===inst.selectedYear&&drawMonth===inst.selectedMonth&&(inst.selectedDay=Math.min(inst.selectedDay,daysInMonth)),leadDays=(this._getFirstDayOfMonth(drawYear,drawMonth)-firstDay+7)%7,curRows=Math.ceil((leadDays+daysInMonth)/7),numRows=isMultiMonth&&this.maxRows>curRows?this.maxRows:curRows,this.maxRows=numRows,printDate=this._daylightSavingAdjust(new Date(drawYear,drawMonth,1-leadDays)),dRow=0;dRow<numRows;dRow++){for(calender+="<tr>",tbody=showWeek?"<td class='ui-datepicker-week-col'>"+this._get(inst,"calculateWeek")(printDate)+"</td>":"",dow=0;dow<7;dow++)daySettings=beforeShowDay?beforeShowDay.apply(inst.input?inst.input[0]:null,[printDate]):[!0,""],otherMonth=printDate.getMonth()!==drawMonth,unselectable=otherMonth&&!selectOtherMonths||!daySettings[0]||minDate&&printDate<minDate||maxDate&&printDate>maxDate,tbody+="<td class='"+((dow+firstDay+6)%7>=5?" ui-datepicker-week-end":"")+(otherMonth?" ui-datepicker-other-month":"")+(printDate.getTime()===selectedDate.getTime()&&drawMonth===inst.selectedMonth&&inst._keyEvent||defaultDate.getTime()===printDate.getTime()&&defaultDate.getTime()===selectedDate.getTime()?" "+this._dayOverClass:"")+(unselectable?" "+this._unselectableClass+" ui-state-disabled":"")+(otherMonth&&!showOtherMonths?"":" "+daySettings[1]+(printDate.getTime()===currentDate.getTime()?" "+this._currentClass:"")+(printDate.getTime()===today.getTime()?" ui-datepicker-today":""))+"'"+(otherMonth&&!showOtherMonths||!daySettings[2]?"":" title='"+daySettings[2].replace(/'/g,"&#39;")+"'")+(unselectable?"":" data-handler='selectDay' data-event='click' data-month='"+printDate.getMonth()+"' data-year='"+printDate.getFullYear()+"'")+">"+(otherMonth&&!showOtherMonths?"&#xa0;":unselectable?"<span class='ui-state-default'>"+printDate.getDate()+"</span>":"<a class='ui-state-default"+(printDate.getTime()===today.getTime()?" ui-state-highlight":"")+(printDate.getTime()===currentDate.getTime()?" ui-state-active":"")+(otherMonth?" ui-priority-secondary":"")+"' href='#'>"+printDate.getDate()+"</a>")+"</td>",printDate.setDate(printDate.getDate()+1),printDate=this._daylightSavingAdjust(printDate);calender+=tbody+"</tr>"}drawMonth++,drawMonth>11&&(drawMonth=0,drawYear++),calender+="</tbody></table>"+(isMultiMonth?"</div>"+(numMonths[0]>0&&col===numMonths[1]-1?"<div class='ui-datepicker-row-break'></div>":""):""),group+=calender}html+=group}return html+=buttonPanel,inst._keyEvent=!1,html},_generateMonthYearHeader:function(inst,drawMonth,drawYear,minDate,maxDate,secondary,monthNames,monthNamesShort){var inMinYear,inMaxYear,month,years,thisYear,determineYear,year,endYear,changeMonth=this._get(inst,"changeMonth"),changeYear=this._get(inst,"changeYear"),showMonthAfterYear=this._get(inst,"showMonthAfterYear"),html="<div class='ui-datepicker-title'>",monthHtml="";if(secondary||!changeMonth)monthHtml+="<span class='ui-datepicker-month'>"+monthNames[drawMonth]+"</span>";else{for(inMinYear=minDate&&minDate.getFullYear()===drawYear,inMaxYear=maxDate&&maxDate.getFullYear()===drawYear,monthHtml+="<select class='ui-datepicker-month' data-handler='selectMonth' data-event='change'>",month=0;month<12;month++)(!inMinYear||month>=minDate.getMonth())&&(!inMaxYear||month<=maxDate.getMonth())&&(monthHtml+="<option value='"+month+"'"+(month===drawMonth?" selected='selected'":"")+">"+monthNamesShort[month]+"</option>");monthHtml+="</select>"}if(showMonthAfterYear||(html+=monthHtml+(!secondary&&changeMonth&&changeYear?"":"&#xa0;")),!inst.yearshtml)if(inst.yearshtml="",secondary||!changeYear)html+="<span class='ui-datepicker-year'>"+drawYear+"</span>";else{for(years=this._get(inst,"yearRange").split(":"),thisYear=(new Date).getFullYear(),determineYear=function(value){var year=value.match(/c[+\-].*/)?drawYear+parseInt(value.substring(1),10):value.match(/[+\-].*/)?thisYear+parseInt(value,10):parseInt(value,10);return isNaN(year)?thisYear:year},year=determineYear(years[0]),endYear=Math.max(year,determineYear(years[1]||"")),year=minDate?Math.max(year,minDate.getFullYear()):year,endYear=maxDate?Math.min(endYear,maxDate.getFullYear()):endYear,inst.yearshtml+="<select class='ui-datepicker-year' data-handler='selectYear' data-event='change'>";year<=endYear;year++)inst.yearshtml+="<option value='"+year+"'"+(year===drawYear?" selected='selected'":"")+">"+year+"</option>";inst.yearshtml+="</select>",html+=inst.yearshtml,inst.yearshtml=null}return html+=this._get(inst,"yearSuffix"),showMonthAfterYear&&(html+=(!secondary&&changeMonth&&changeYear?"":"&#xa0;")+monthHtml),html+="</div>"},_adjustInstDate:function(inst,offset,period){var year=inst.drawYear+("Y"===period?offset:0),month=inst.drawMonth+("M"===period?offset:0),day=Math.min(inst.selectedDay,this._getDaysInMonth(year,month))+("D"===period?offset:0),date=this._restrictMinMax(inst,this._daylightSavingAdjust(new Date(year,month,day)));inst.selectedDay=date.getDate(),inst.drawMonth=inst.selectedMonth=date.getMonth(),inst.drawYear=inst.selectedYear=date.getFullYear(),"M"!==period&&"Y"!==period||this._notifyChange(inst)},_restrictMinMax:function(inst,date){var minDate=this._getMinMaxDate(inst,"min"),maxDate=this._getMinMaxDate(inst,"max"),newDate=minDate&&date<minDate?minDate:date;return maxDate&&newDate>maxDate?maxDate:newDate},_notifyChange:function(inst){var onChange=this._get(inst,"onChangeMonthYear");onChange&&onChange.apply(inst.input?inst.input[0]:null,[inst.selectedYear,inst.selectedMonth+1,inst])},_getNumberOfMonths:function(inst){var numMonths=this._get(inst,"numberOfMonths");return null==numMonths?[1,1]:"number"==typeof numMonths?[1,numMonths]:numMonths},_getMinMaxDate:function(inst,minMax){return this._determineDate(inst,this._get(inst,minMax+"Date"),null)},_getDaysInMonth:function(year,month){return 32-this._daylightSavingAdjust(new Date(year,month,32)).getDate()},_getFirstDayOfMonth:function(year,month){return new Date(year,month,1).getDay()},_canAdjustMonth:function(inst,offset,curYear,curMonth){var numMonths=this._getNumberOfMonths(inst),date=this._daylightSavingAdjust(new Date(curYear,curMonth+(offset<0?offset:numMonths[0]*numMonths[1]),1));return offset<0&&date.setDate(this._getDaysInMonth(date.getFullYear(),date.getMonth())),this._isInRange(inst,date)},_isInRange:function(inst,date){var yearSplit,currentYear,minDate=this._getMinMaxDate(inst,"min"),maxDate=this._getMinMaxDate(inst,"max"),minYear=null,maxYear=null,years=this._get(inst,"yearRange");return years&&(yearSplit=years.split(":"),currentYear=(new Date).getFullYear(),minYear=parseInt(yearSplit[0],10),maxYear=parseInt(yearSplit[1],10),yearSplit[0].match(/[+\-].*/)&&(minYear+=currentYear),yearSplit[1].match(/[+\-].*/)&&(maxYear+=currentYear)),(!minDate||date.getTime()>=minDate.getTime())&&(!maxDate||date.getTime()<=maxDate.getTime())&&(!minYear||date.getFullYear()>=minYear)&&(!maxYear||date.getFullYear()<=maxYear)},_getFormatConfig:function(inst){var shortYearCutoff=this._get(inst,"shortYearCutoff");return shortYearCutoff="string"!=typeof shortYearCutoff?shortYearCutoff:(new Date).getFullYear()%100+parseInt(shortYearCutoff,10),{shortYearCutoff:shortYearCutoff,dayNamesShort:this._get(inst,"dayNamesShort"),dayNames:this._get(inst,"dayNames"),monthNamesShort:this._get(inst,"monthNamesShort"),monthNames:this._get(inst,"monthNames")}},_formatDate:function(inst,day,month,year){day||(inst.currentDay=inst.selectedDay,inst.currentMonth=inst.selectedMonth,inst.currentYear=inst.selectedYear);var date=day?"object"==typeof day?day:this._daylightSavingAdjust(new Date(year,month,day)):this._daylightSavingAdjust(new Date(inst.currentYear,inst.currentMonth,inst.currentDay));return this.formatDate(this._get(inst,"dateFormat"),date,this._getFormatConfig(inst))}});function datepicker_bindHover(dpDiv){var selector="button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";return dpDiv.delegate(selector,"mouseout",function(){$(this).removeClass("ui-state-hover"),-1!==this.className.indexOf("ui-datepicker-prev")&&$(this).removeClass("ui-datepicker-prev-hover"),-1!==this.className.indexOf("ui-datepicker-next")&&$(this).removeClass("ui-datepicker-next-hover")}).delegate(selector,"mouseover",datepicker_handleMouseover)}function datepicker_handleMouseover(){$.datepicker._isDisabledDatepicker(datepicker_instActive.inline?datepicker_instActive.dpDiv.parent()[0]:datepicker_instActive.input[0])||($(this).parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover"),$(this).addClass("ui-state-hover"),-1!==this.className.indexOf("ui-datepicker-prev")&&$(this).addClass("ui-datepicker-prev-hover"),-1!==this.className.indexOf("ui-datepicker-next")&&$(this).addClass("ui-datepicker-next-hover"))}function datepicker_extendRemove(target,props){$.extend(target,props);for(var name in props)null==props[name]&&(target[name]=props[name]);return target}$.fn.datepicker=function(options){if(!this.length)return this;$.datepicker.initialized||($(document).mousedown($.datepicker._checkExternalClick),$.datepicker.initialized=!0),0===$("#"+$.datepicker._mainDivId).length&&$("body").append($.datepicker.dpDiv);var otherArgs=Array.prototype.slice.call(arguments,1);return"string"!=typeof options||"isDisabled"!==options&&"getDate"!==options&&"widget"!==options?"option"===options&&2===arguments.length&&"string"==typeof arguments[1]?$.datepicker["_"+options+"Datepicker"].apply($.datepicker,[this[0]].concat(otherArgs)):this.each(function(){"string"==typeof options?$.datepicker["_"+options+"Datepicker"].apply($.datepicker,[this].concat(otherArgs)):$.datepicker._attachDatepicker(this,options)}):$.datepicker["_"+options+"Datepicker"].apply($.datepicker,[this[0]].concat(otherArgs))},$.datepicker=new Datepicker,$.datepicker.initialized=!1,$.datepicker.uuid=(new Date).getTime(),$.datepicker.version="1.11.4";$.datepicker,$.widget("ui.dialog",{version:"1.11.4",options:{appendTo:"body",autoOpen:!0,buttons:[],closeOnEscape:!0,closeText:"Close",dialogClass:"",draggable:!0,hide:null,height:"auto",maxHeight:null,maxWidth:null,minHeight:150,minWidth:150,modal:!1,position:{my:"center",at:"center",of:window,collision:"fit",using:function(pos){var topOffset=$(this).css(pos).offset().top;topOffset<0&&$(this).css("top",pos.top-topOffset)}},resizable:!0,show:null,title:null,width:300,beforeClose:null,close:null,drag:null,dragStart:null,dragStop:null,focus:null,open:null,resize:null,resizeStart:null,resizeStop:null},sizeRelatedOptions:{buttons:!0,height:!0,maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0,width:!0},resizableRelatedOptions:{maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0},_create:function(){this.originalCss={display:this.element[0].style.display,width:this.element[0].style.width,minHeight:this.element[0].style.minHeight,maxHeight:this.element[0].style.maxHeight,height:this.element[0].style.height},this.originalPosition={parent:this.element.parent(),index:this.element.parent().children().index(this.element)},this.originalTitle=this.element.attr("title"),this.options.title=this.options.title||this.originalTitle,this._createWrapper(),this.element.show().removeAttr("title").addClass("ui-dialog-content ui-widget-content").appendTo(this.uiDialog),this._createTitlebar(),this._createButtonPane(),this.options.draggable&&$.fn.draggable&&this._makeDraggable(),this.options.resizable&&$.fn.resizable&&this._makeResizable(),this._isOpen=!1,this._trackFocus()},_init:function(){this.options.autoOpen&&this.open()},_appendTo:function(){var element=this.options.appendTo;return element&&(element.jquery||element.nodeType)?$(element):this.document.find(element||"body").eq(0)},_destroy:function(){var next,originalPosition=this.originalPosition;this._untrackInstance(),this._destroyOverlay(),this.element.removeUniqueId().removeClass("ui-dialog-content ui-widget-content").css(this.originalCss).detach(),this.uiDialog.stop(!0,!0).remove(),this.originalTitle&&this.element.attr("title",this.originalTitle),next=originalPosition.parent.children().eq(originalPosition.index),next.length&&next[0]!==this.element[0]?next.before(this.element):originalPosition.parent.append(this.element)},widget:function(){return this.uiDialog},disable:$.noop,enable:$.noop,close:function(event){var activeElement,that=this;if(this._isOpen&&!1!==this._trigger("beforeClose",event)){if(this._isOpen=!1,this._focusedElement=null,this._destroyOverlay(),this._untrackInstance(),!this.opener.filter(":focusable").focus().length)try{activeElement=this.document[0].activeElement,activeElement&&"body"!==activeElement.nodeName.toLowerCase()&&$(activeElement).blur()}catch(error){}this._hide(this.uiDialog,this.options.hide,function(){that._trigger("close",event)})}},isOpen:function(){return this._isOpen},moveToTop:function(){this._moveToTop()},_moveToTop:function(event,silent){var moved=!1,zIndices=this.uiDialog.siblings(".ui-front:visible").map(function(){return+$(this).css("z-index")}).get(),zIndexMax=Math.max.apply(null,zIndices);return zIndexMax>=+this.uiDialog.css("z-index")&&(this.uiDialog.css("z-index",zIndexMax+1),moved=!0),moved&&!silent&&this._trigger("focus",event),moved},open:function(){var that=this;if(this._isOpen)return void(this._moveToTop()&&this._focusTabbable());this._isOpen=!0,this.opener=$(this.document[0].activeElement),this._size(),this._position(),this._createOverlay(),this._moveToTop(null,!0),this.overlay&&this.overlay.css("z-index",this.uiDialog.css("z-index")-1),this._show(this.uiDialog,this.options.show,function(){that._focusTabbable(),that._trigger("focus")}),this._makeFocusTarget(),this._trigger("open")},_focusTabbable:function(){var hasFocus=this._focusedElement;hasFocus||(hasFocus=this.element.find("[autofocus]")),hasFocus.length||(hasFocus=this.element.find(":tabbable")),hasFocus.length||(hasFocus=this.uiDialogButtonPane.find(":tabbable")),hasFocus.length||(hasFocus=this.uiDialogTitlebarClose.filter(":tabbable")),hasFocus.length||(hasFocus=this.uiDialog),hasFocus.eq(0).focus()},_keepFocus:function(event){function checkFocus(){var activeElement=this.document[0].activeElement;this.uiDialog[0]===activeElement||$.contains(this.uiDialog[0],activeElement)||this._focusTabbable()}event.preventDefault(),checkFocus.call(this),this._delay(checkFocus)},_createWrapper:function(){this.uiDialog=$("<div>").addClass("ui-dialog ui-widget ui-widget-content ui-corner-all ui-front "+this.options.dialogClass).hide().attr({tabIndex:-1,role:"dialog"}).appendTo(this._appendTo()),this._on(this.uiDialog,{keydown:function(event){if(this.options.closeOnEscape&&!event.isDefaultPrevented()&&event.keyCode&&event.keyCode===$.ui.keyCode.ESCAPE)return event.preventDefault(),void this.close(event);if(event.keyCode===$.ui.keyCode.TAB&&!event.isDefaultPrevented()){var tabbables=this.uiDialog.find(":tabbable"),first=tabbables.filter(":first"),last=tabbables.filter(":last");event.target!==last[0]&&event.target!==this.uiDialog[0]||event.shiftKey?event.target!==first[0]&&event.target!==this.uiDialog[0]||!event.shiftKey||(this._delay(function(){last.focus()}),event.preventDefault()):(this._delay(function(){first.focus()}),event.preventDefault())}},mousedown:function(event){this._moveToTop(event)&&this._focusTabbable()}}),this.element.find("[aria-describedby]").length||this.uiDialog.attr({"aria-describedby":this.element.uniqueId().attr("id")})},_createTitlebar:function(){var uiDialogTitle;this.uiDialogTitlebar=$("<div>").addClass("ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix").prependTo(this.uiDialog),this._on(this.uiDialogTitlebar,{mousedown:function(event){$(event.target).closest(".ui-dialog-titlebar-close")||this.uiDialog.focus()}}),this.uiDialogTitlebarClose=$("<button type='button'></button>").button({label:this.options.closeText,icons:{primary:"ui-icon-closethick"},text:!1}).addClass("ui-dialog-titlebar-close").appendTo(this.uiDialogTitlebar),this._on(this.uiDialogTitlebarClose,{click:function(event){event.preventDefault(),this.close(event)}}),uiDialogTitle=$("<span>").uniqueId().addClass("ui-dialog-title").prependTo(this.uiDialogTitlebar),this._title(uiDialogTitle),this.uiDialog.attr({"aria-labelledby":uiDialogTitle.attr("id")})},_title:function(title){this.options.title||title.html("&#160;"),title.text(this.options.title)},_createButtonPane:function(){this.uiDialogButtonPane=$("<div>").addClass("ui-dialog-buttonpane ui-widget-content ui-helper-clearfix"),this.uiButtonSet=$("<div>").addClass("ui-dialog-buttonset").appendTo(this.uiDialogButtonPane),this._createButtons()},_createButtons:function(){var that=this,buttons=this.options.buttons;if(this.uiDialogButtonPane.remove(),this.uiButtonSet.empty(),$.isEmptyObject(buttons)||$.isArray(buttons)&&!buttons.length)return void this.uiDialog.removeClass("ui-dialog-buttons");$.each(buttons,function(name,props){var click,buttonOptions;props=$.isFunction(props)?{click:props,text:name}:props,props=$.extend({type:"button"},props),click=props.click,props.click=function(){click.apply(that.element[0],arguments)},buttonOptions={icons:props.icons,text:props.showText},delete props.icons,delete props.showText,$("<button></button>",props).button(buttonOptions).appendTo(that.uiButtonSet)}),this.uiDialog.addClass("ui-dialog-buttons"),this.uiDialogButtonPane.appendTo(this.uiDialog)},_makeDraggable:function(){var that=this,options=this.options;function filteredUi(ui){return{position:ui.position,offset:ui.offset}}this.uiDialog.draggable({cancel:".ui-dialog-content, .ui-dialog-titlebar-close",handle:".ui-dialog-titlebar",containment:"document",start:function(event,ui){$(this).addClass("ui-dialog-dragging"),that._blockFrames(),that._trigger("dragStart",event,filteredUi(ui))},drag:function(event,ui){that._trigger("drag",event,filteredUi(ui))},stop:function(event,ui){var left=ui.offset.left-that.document.scrollLeft(),top=ui.offset.top-that.document.scrollTop();options.position={my:"left top",at:"left"+(left>=0?"+":"")+left+" top"+(top>=0?"+":"")+top,of:that.window},$(this).removeClass("ui-dialog-dragging"),that._unblockFrames(),that._trigger("dragStop",event,filteredUi(ui))}})},_makeResizable:function(){var that=this,options=this.options,handles=options.resizable,position=this.uiDialog.css("position"),resizeHandles="string"==typeof handles?handles:"n,e,s,w,se,sw,ne,nw";function filteredUi(ui){return{originalPosition:ui.originalPosition,originalSize:ui.originalSize,position:ui.position,size:ui.size}}this.uiDialog.resizable({cancel:".ui-dialog-content",containment:"document",alsoResize:this.element,maxWidth:options.maxWidth,maxHeight:options.maxHeight,minWidth:options.minWidth,minHeight:this._minHeight(),handles:resizeHandles,start:function(event,ui){$(this).addClass("ui-dialog-resizing"),that._blockFrames(),that._trigger("resizeStart",event,filteredUi(ui))},resize:function(event,ui){that._trigger("resize",event,filteredUi(ui))},stop:function(event,ui){var offset=that.uiDialog.offset(),left=offset.left-that.document.scrollLeft(),top=offset.top-that.document.scrollTop();options.height=that.uiDialog.height(),options.width=that.uiDialog.width(),options.position={my:"left top",at:"left"+(left>=0?"+":"")+left+" top"+(top>=0?"+":"")+top,of:that.window},$(this).removeClass("ui-dialog-resizing"),that._unblockFrames(),that._trigger("resizeStop",event,filteredUi(ui))}}).css("position",position)},_trackFocus:function(){this._on(this.widget(),{focusin:function(event){this._makeFocusTarget(),this._focusedElement=$(event.target)}})},_makeFocusTarget:function(){this._untrackInstance(),this._trackingInstances().unshift(this)},_untrackInstance:function(){var instances=this._trackingInstances(),exists=$.inArray(this,instances);-1!==exists&&instances.splice(exists,1)},_trackingInstances:function(){var instances=this.document.data("ui-dialog-instances");return instances||(instances=[],this.document.data("ui-dialog-instances",instances)),instances},_minHeight:function(){var options=this.options;return"auto"===options.height?options.minHeight:Math.min(options.minHeight,options.height)},_position:function(){var isVisible=this.uiDialog.is(":visible");isVisible||this.uiDialog.show(),this.uiDialog.position(this.options.position),isVisible||this.uiDialog.hide()},_setOptions:function(options){var that=this,resize=!1,resizableOptions={};$.each(options,function(key,value){that._setOption(key,value),key in that.sizeRelatedOptions&&(resize=!0),key in that.resizableRelatedOptions&&(resizableOptions[key]=value)}),resize&&(this._size(),this._position()),this.uiDialog.is(":data(ui-resizable)")&&this.uiDialog.resizable("option",resizableOptions)},_setOption:function(key,value){var isDraggable,isResizable,uiDialog=this.uiDialog;"dialogClass"===key&&uiDialog.removeClass(this.options.dialogClass).addClass(value),"disabled"!==key&&(this._super(key,value),"appendTo"===key&&this.uiDialog.appendTo(this._appendTo()),"buttons"===key&&this._createButtons(),"closeText"===key&&this.uiDialogTitlebarClose.button({label:""+value}),"draggable"===key&&(isDraggable=uiDialog.is(":data(ui-draggable)"),isDraggable&&!value&&uiDialog.draggable("destroy"),!isDraggable&&value&&this._makeDraggable()),"position"===key&&this._position(),"resizable"===key&&(isResizable=uiDialog.is(":data(ui-resizable)"),isResizable&&!value&&uiDialog.resizable("destroy"),isResizable&&"string"==typeof value&&uiDialog.resizable("option","handles",value),isResizable||!1===value||this._makeResizable()),"title"===key&&this._title(this.uiDialogTitlebar.find(".ui-dialog-title")))},_size:function(){var nonContentHeight,minContentHeight,maxContentHeight,options=this.options;this.element.show().css({width:"auto",minHeight:0,maxHeight:"none",height:0}),options.minWidth>options.width&&(options.width=options.minWidth),nonContentHeight=this.uiDialog.css({height:"auto",width:options.width}).outerHeight(),minContentHeight=Math.max(0,options.minHeight-nonContentHeight),maxContentHeight="number"==typeof options.maxHeight?Math.max(0,options.maxHeight-nonContentHeight):"none","auto"===options.height?this.element.css({minHeight:minContentHeight,maxHeight:maxContentHeight,height:"auto"}):this.element.height(Math.max(0,options.height-nonContentHeight)),this.uiDialog.is(":data(ui-resizable)")&&this.uiDialog.resizable("option","minHeight",this._minHeight())},_blockFrames:function(){this.iframeBlocks=this.document.find("iframe").map(function(){var iframe=$(this);return $("<div>").css({position:"absolute",width:iframe.outerWidth(),height:iframe.outerHeight()}).appendTo(iframe.parent()).offset(iframe.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_allowInteraction:function(event){return!!$(event.target).closest(".ui-dialog").length||!!$(event.target).closest(".ui-datepicker").length},_createOverlay:function(){if(this.options.modal){var isOpening=!0;this._delay(function(){isOpening=!1}),this.document.data("ui-dialog-overlays")||this._on(this.document,{focusin:function(event){isOpening||this._allowInteraction(event)||(event.preventDefault(),this._trackingInstances()[0]._focusTabbable())}}),this.overlay=$("<div>").addClass("ui-widget-overlay ui-front").appendTo(this._appendTo()),this._on(this.overlay,{mousedown:"_keepFocus"}),this.document.data("ui-dialog-overlays",(this.document.data("ui-dialog-overlays")||0)+1)}},_destroyOverlay:function(){if(this.options.modal&&this.overlay){var overlays=this.document.data("ui-dialog-overlays")-1;overlays?this.document.data("ui-dialog-overlays",overlays):this.document.unbind("focusin").removeData("ui-dialog-overlays"),this.overlay.remove(),this.overlay=null}}}),$.widget("ui.progressbar",{version:"1.11.4",options:{max:100,value:0,change:null,complete:null},min:0,_create:function(){this.oldValue=this.options.value=this._constrainedValue(),this.element.addClass("ui-progressbar ui-widget ui-widget-content ui-corner-all").attr({role:"progressbar","aria-valuemin":this.min}),this.valueDiv=$("<div class='ui-progressbar-value ui-widget-header ui-corner-left'></div>").appendTo(this.element),this._refreshValue()},_destroy:function(){this.element.removeClass("ui-progressbar ui-widget ui-widget-content ui-corner-all").removeAttr("role").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuenow"),this.valueDiv.remove()},value:function(newValue){if(void 0===newValue)return this.options.value;this.options.value=this._constrainedValue(newValue),this._refreshValue()},_constrainedValue:function(newValue){return void 0===newValue&&(newValue=this.options.value),this.indeterminate=!1===newValue,"number"!=typeof newValue&&(newValue=0),!this.indeterminate&&Math.min(this.options.max,Math.max(this.min,newValue))},_setOptions:function(options){var value=options.value;delete options.value,this._super(options),this.options.value=this._constrainedValue(value),this._refreshValue()},_setOption:function(key,value){"max"===key&&(value=Math.max(this.min,value)),"disabled"===key&&this.element.toggleClass("ui-state-disabled",!!value).attr("aria-disabled",value),this._super(key,value)},_percentage:function(){return this.indeterminate?100:100*(this.options.value-this.min)/(this.options.max-this.min)},_refreshValue:function(){var value=this.options.value,percentage=this._percentage();this.valueDiv.toggle(this.indeterminate||value>this.min).toggleClass("ui-corner-right",value===this.options.max).width(percentage.toFixed(0)+"%"),this.element.toggleClass("ui-progressbar-indeterminate",this.indeterminate),this.indeterminate?(this.element.removeAttr("aria-valuenow"),this.overlayDiv||(this.overlayDiv=$("<div class='ui-progressbar-overlay'></div>").appendTo(this.valueDiv))):(this.element.attr({"aria-valuemax":this.options.max,"aria-valuenow":value}),this.overlayDiv&&(this.overlayDiv.remove(),this.overlayDiv=null)),this.oldValue!==value&&(this.oldValue=value,this._trigger("change")),value===this.options.max&&this._trigger("complete")}}),$.widget("ui.selectmenu",{version:"1.11.4",defaultElement:"<select>",options:{appendTo:null,disabled:null,icons:{button:"ui-icon-triangle-1-s"},position:{my:"left top",at:"left bottom",collision:"none"},width:null,change:null,close:null,focus:null,open:null,select:null},_create:function(){var selectmenuId=this.element.uniqueId().attr("id");this.ids={element:selectmenuId,button:selectmenuId+"-button",menu:selectmenuId+"-menu"},this._drawButton(),this._drawMenu(),this.options.disabled&&this.disable()},_drawButton:function(){var that=this;this.label=$("label[for='"+this.ids.element+"']").attr("for",this.ids.button),this._on(this.label,{click:function(event){this.button.focus(),event.preventDefault()}}),this.element.hide(),this.button=$("<span>",{class:"ui-selectmenu-button ui-widget ui-state-default ui-corner-all",tabindex:this.options.disabled?-1:0,id:this.ids.button,role:"combobox","aria-expanded":"false","aria-autocomplete":"list","aria-owns":this.ids.menu,"aria-haspopup":"true"}).insertAfter(this.element),$("<span>",{class:"ui-icon "+this.options.icons.button}).prependTo(this.button),this.buttonText=$("<span>",{class:"ui-selectmenu-text"}).appendTo(this.button),this._setText(this.buttonText,this.element.find("option:selected").text()),this._resizeButton(),this._on(this.button,this._buttonEvents),this.button.one("focusin",function(){that.menuItems||that._refreshMenu()}),this._hoverable(this.button),this._focusable(this.button)},_drawMenu:function(){var that=this;this.menu=$("<ul>",{"aria-hidden":"true","aria-labelledby":this.ids.button,id:this.ids.menu}),this.menuWrap=$("<div>",{class:"ui-selectmenu-menu ui-front"}).append(this.menu).appendTo(this._appendTo()),this.menuInstance=this.menu.menu({role:"listbox",select:function(event,ui){event.preventDefault(),that._setSelection(),that._select(ui.item.data("ui-selectmenu-item"),event)},focus:function(event,ui){var item=ui.item.data("ui-selectmenu-item");null!=that.focusIndex&&item.index!==that.focusIndex&&(that._trigger("focus",event,{item:item}),that.isOpen||that._select(item,event)),that.focusIndex=item.index,that.button.attr("aria-activedescendant",that.menuItems.eq(item.index).attr("id"))}}).menu("instance"),this.menu.addClass("ui-corner-bottom").removeClass("ui-corner-all"),this.menuInstance._off(this.menu,"mouseleave"),this.menuInstance._closeOnDocumentClick=function(){return!1},this.menuInstance._isDivider=function(){return!1}},refresh:function(){this._refreshMenu(),this._setText(this.buttonText,this._getSelectedItem().text()),this.options.width||this._resizeButton()},_refreshMenu:function(){this.menu.empty();var item,options=this.element.find("option");options.length&&(this._parseOptions(options),this._renderMenu(this.menu,this.items),this.menuInstance.refresh(),this.menuItems=this.menu.find("li").not(".ui-selectmenu-optgroup"),item=this._getSelectedItem(),this.menuInstance.focus(null,item),this._setAria(item.data("ui-selectmenu-item")),this._setOption("disabled",this.element.prop("disabled")))},open:function(event){this.options.disabled||(this.menuItems?(this.menu.find(".ui-state-focus").removeClass("ui-state-focus"),
this.menuInstance.focus(null,this._getSelectedItem())):this._refreshMenu(),this.isOpen=!0,this._toggleAttr(),this._resizeMenu(),this._position(),this._on(this.document,this._documentClick),this._trigger("open",event))},_position:function(){this.menuWrap.position($.extend({of:this.button},this.options.position))},close:function(event){this.isOpen&&(this.isOpen=!1,this._toggleAttr(),this.range=null,this._off(this.document),this._trigger("close",event))},widget:function(){return this.button},menuWidget:function(){return this.menu},_renderMenu:function(ul,items){var that=this,currentOptgroup="";$.each(items,function(index,item){item.optgroup!==currentOptgroup&&($("<li>",{class:"ui-selectmenu-optgroup ui-menu-divider"+(item.element.parent("optgroup").prop("disabled")?" ui-state-disabled":""),text:item.optgroup}).appendTo(ul),currentOptgroup=item.optgroup),that._renderItemData(ul,item)})},_renderItemData:function(ul,item){return this._renderItem(ul,item).data("ui-selectmenu-item",item)},_renderItem:function(ul,item){var li=$("<li>");return item.disabled&&li.addClass("ui-state-disabled"),this._setText(li,item.label),li.appendTo(ul)},_setText:function(element,value){value?element.text(value):element.html("&#160;")},_move:function(direction,event){var item,next,filter=".ui-menu-item";this.isOpen?item=this.menuItems.eq(this.focusIndex):(item=this.menuItems.eq(this.element[0].selectedIndex),filter+=":not(.ui-state-disabled)"),next="first"===direction||"last"===direction?item["first"===direction?"prevAll":"nextAll"](filter).eq(-1):item[direction+"All"](filter).eq(0),next.length&&this.menuInstance.focus(event,next)},_getSelectedItem:function(){return this.menuItems.eq(this.element[0].selectedIndex)},_toggle:function(event){this[this.isOpen?"close":"open"](event)},_setSelection:function(){var selection;this.range&&(window.getSelection?(selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(this.range)):this.range.select(),this.button.focus())},_documentClick:{mousedown:function(event){this.isOpen&&($(event.target).closest(".ui-selectmenu-menu, #"+this.ids.button).length||this.close(event))}},_buttonEvents:{mousedown:function(){var selection;window.getSelection?(selection=window.getSelection(),selection.rangeCount&&(this.range=selection.getRangeAt(0))):this.range=document.selection.createRange()},click:function(event){this._setSelection(),this._toggle(event)},keydown:function(event){var preventDefault=!0;switch(event.keyCode){case $.ui.keyCode.TAB:case $.ui.keyCode.ESCAPE:this.close(event),preventDefault=!1;break;case $.ui.keyCode.ENTER:this.isOpen&&this._selectFocusedItem(event);break;case $.ui.keyCode.UP:event.altKey?this._toggle(event):this._move("prev",event);break;case $.ui.keyCode.DOWN:event.altKey?this._toggle(event):this._move("next",event);break;case $.ui.keyCode.SPACE:this.isOpen?this._selectFocusedItem(event):this._toggle(event);break;case $.ui.keyCode.LEFT:this._move("prev",event);break;case $.ui.keyCode.RIGHT:this._move("next",event);break;case $.ui.keyCode.HOME:case $.ui.keyCode.PAGE_UP:this._move("first",event);break;case $.ui.keyCode.END:case $.ui.keyCode.PAGE_DOWN:this._move("last",event);break;default:this.menu.trigger(event),preventDefault=!1}preventDefault&&event.preventDefault()}},_selectFocusedItem:function(event){var item=this.menuItems.eq(this.focusIndex);item.hasClass("ui-state-disabled")||this._select(item.data("ui-selectmenu-item"),event)},_select:function(item,event){var oldIndex=this.element[0].selectedIndex;this.element[0].selectedIndex=item.index,this._setText(this.buttonText,item.label),this._setAria(item),this._trigger("select",event,{item:item}),item.index!==oldIndex&&this._trigger("change",event,{item:item}),this.close(event)},_setAria:function(item){var id=this.menuItems.eq(item.index).attr("id");this.button.attr({"aria-labelledby":id,"aria-activedescendant":id}),this.menu.attr("aria-activedescendant",id)},_setOption:function(key,value){"icons"===key&&this.button.find("span.ui-icon").removeClass(this.options.icons.button).addClass(value.button),this._super(key,value),"appendTo"===key&&this.menuWrap.appendTo(this._appendTo()),"disabled"===key&&(this.menuInstance.option("disabled",value),this.button.toggleClass("ui-state-disabled",value).attr("aria-disabled",value),this.element.prop("disabled",value),value?(this.button.attr("tabindex",-1),this.close()):this.button.attr("tabindex",0)),"width"===key&&this._resizeButton()},_appendTo:function(){var element=this.options.appendTo;return element&&(element=element.jquery||element.nodeType?$(element):this.document.find(element).eq(0)),element&&element[0]||(element=this.element.closest(".ui-front")),element.length||(element=this.document[0].body),element},_toggleAttr:function(){this.button.toggleClass("ui-corner-top",this.isOpen).toggleClass("ui-corner-all",!this.isOpen).attr("aria-expanded",this.isOpen),this.menuWrap.toggleClass("ui-selectmenu-open",this.isOpen),this.menu.attr("aria-hidden",!this.isOpen)},_resizeButton:function(){var width=this.options.width;width||(width=this.element.show().outerWidth(),this.element.hide()),this.button.outerWidth(width)},_resizeMenu:function(){this.menu.outerWidth(Math.max(this.button.outerWidth(),this.menu.width("").outerWidth()+1))},_getCreateOptions:function(){return{disabled:this.element.prop("disabled")}},_parseOptions:function(options){var data=[];options.each(function(index,item){var option=$(item),optgroup=option.parent("optgroup");data.push({element:option,index:index,value:option.val(),label:option.text(),optgroup:optgroup.attr("label")||"",disabled:optgroup.prop("disabled")||option.prop("disabled")})}),this.items=data},_destroy:function(){this.menuWrap.remove(),this.button.remove(),this.element.show(),this.element.removeUniqueId(),this.label.attr("for",this.ids.element)}}),$.widget("ui.slider",$.ui.mouse,{version:"1.11.4",widgetEventPrefix:"slide",options:{animate:!1,distance:0,max:100,min:0,orientation:"horizontal",range:!1,step:1,value:0,values:null,change:null,slide:null,start:null,stop:null},numPages:5,_create:function(){this._keySliding=!1,this._mouseSliding=!1,this._animateOff=!0,this._handleIndex=null,this._detectOrientation(),this._mouseInit(),this._calculateNewMax(),this.element.addClass("ui-slider ui-slider-"+this.orientation+" ui-widget ui-widget-content ui-corner-all"),this._refresh(),this._setOption("disabled",this.options.disabled),this._animateOff=!1},_refresh:function(){this._createRange(),this._createHandles(),this._setupEvents(),this._refreshValue()},_createHandles:function(){var i,handleCount,options=this.options,existingHandles=this.element.find(".ui-slider-handle").addClass("ui-state-default ui-corner-all"),handles=[];for(handleCount=options.values&&options.values.length||1,existingHandles.length>handleCount&&(existingHandles.slice(handleCount).remove(),existingHandles=existingHandles.slice(0,handleCount)),i=existingHandles.length;i<handleCount;i++)handles.push("<span class='ui-slider-handle ui-state-default ui-corner-all' tabindex='0'></span>");this.handles=existingHandles.add($(handles.join("")).appendTo(this.element)),this.handle=this.handles.eq(0),this.handles.each(function(i){$(this).data("ui-slider-handle-index",i)})},_createRange:function(){var options=this.options,classes="";options.range?(!0===options.range&&(options.values?options.values.length&&2!==options.values.length?options.values=[options.values[0],options.values[0]]:$.isArray(options.values)&&(options.values=options.values.slice(0)):options.values=[this._valueMin(),this._valueMin()]),this.range&&this.range.length?this.range.removeClass("ui-slider-range-min ui-slider-range-max").css({left:"",bottom:""}):(this.range=$("<div></div>").appendTo(this.element),classes="ui-slider-range ui-widget-header ui-corner-all"),this.range.addClass(classes+("min"===options.range||"max"===options.range?" ui-slider-range-"+options.range:""))):(this.range&&this.range.remove(),this.range=null)},_setupEvents:function(){this._off(this.handles),this._on(this.handles,this._handleEvents),this._hoverable(this.handles),this._focusable(this.handles)},_destroy:function(){this.handles.remove(),this.range&&this.range.remove(),this.element.removeClass("ui-slider ui-slider-horizontal ui-slider-vertical ui-widget ui-widget-content ui-corner-all"),this._mouseDestroy()},_mouseCapture:function(event){var position,normValue,distance,closestHandle,index,offset,mouseOverHandle,that=this,o=this.options;return!o.disabled&&(this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()},this.elementOffset=this.element.offset(),position={x:event.pageX,y:event.pageY},normValue=this._normValueFromMouse(position),distance=this._valueMax()-this._valueMin()+1,this.handles.each(function(i){var thisDistance=Math.abs(normValue-that.values(i));(distance>thisDistance||distance===thisDistance&&(i===that._lastChangedValue||that.values(i)===o.min))&&(distance=thisDistance,closestHandle=$(this),index=i)}),!1!==this._start(event,index)&&(this._mouseSliding=!0,this._handleIndex=index,closestHandle.addClass("ui-state-active").focus(),offset=closestHandle.offset(),mouseOverHandle=!$(event.target).parents().addBack().is(".ui-slider-handle"),this._clickOffset=mouseOverHandle?{left:0,top:0}:{left:event.pageX-offset.left-closestHandle.width()/2,top:event.pageY-offset.top-closestHandle.height()/2-(parseInt(closestHandle.css("borderTopWidth"),10)||0)-(parseInt(closestHandle.css("borderBottomWidth"),10)||0)+(parseInt(closestHandle.css("marginTop"),10)||0)},this.handles.hasClass("ui-state-hover")||this._slide(event,index,normValue),this._animateOff=!0,!0))},_mouseStart:function(){return!0},_mouseDrag:function(event){var position={x:event.pageX,y:event.pageY},normValue=this._normValueFromMouse(position);return this._slide(event,this._handleIndex,normValue),!1},_mouseStop:function(event){return this.handles.removeClass("ui-state-active"),this._mouseSliding=!1,this._stop(event,this._handleIndex),this._change(event,this._handleIndex),this._handleIndex=null,this._clickOffset=null,this._animateOff=!1,!1},_detectOrientation:function(){this.orientation="vertical"===this.options.orientation?"vertical":"horizontal"},_normValueFromMouse:function(position){var pixelTotal,pixelMouse,percentMouse,valueTotal,valueMouse;return"horizontal"===this.orientation?(pixelTotal=this.elementSize.width,pixelMouse=position.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)):(pixelTotal=this.elementSize.height,pixelMouse=position.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)),percentMouse=pixelMouse/pixelTotal,percentMouse>1&&(percentMouse=1),percentMouse<0&&(percentMouse=0),"vertical"===this.orientation&&(percentMouse=1-percentMouse),valueTotal=this._valueMax()-this._valueMin(),valueMouse=this._valueMin()+percentMouse*valueTotal,this._trimAlignValue(valueMouse)},_start:function(event,index){var uiHash={handle:this.handles[index],value:this.value()};return this.options.values&&this.options.values.length&&(uiHash.value=this.values(index),uiHash.values=this.values()),this._trigger("start",event,uiHash)},_slide:function(event,index,newVal){var otherVal,newValues,allowed;this.options.values&&this.options.values.length?(otherVal=this.values(index?0:1),2===this.options.values.length&&!0===this.options.range&&(0===index&&newVal>otherVal||1===index&&newVal<otherVal)&&(newVal=otherVal),newVal!==this.values(index)&&(newValues=this.values(),newValues[index]=newVal,allowed=this._trigger("slide",event,{handle:this.handles[index],value:newVal,values:newValues}),otherVal=this.values(index?0:1),!1!==allowed&&this.values(index,newVal))):newVal!==this.value()&&!1!==(allowed=this._trigger("slide",event,{handle:this.handles[index],value:newVal}))&&this.value(newVal)},_stop:function(event,index){var uiHash={handle:this.handles[index],value:this.value()};this.options.values&&this.options.values.length&&(uiHash.value=this.values(index),uiHash.values=this.values()),this._trigger("stop",event,uiHash)},_change:function(event,index){if(!this._keySliding&&!this._mouseSliding){var uiHash={handle:this.handles[index],value:this.value()};this.options.values&&this.options.values.length&&(uiHash.value=this.values(index),uiHash.values=this.values()),this._lastChangedValue=index,this._trigger("change",event,uiHash)}},value:function(newValue){return arguments.length?(this.options.value=this._trimAlignValue(newValue),this._refreshValue(),void this._change(null,0)):this._value()},values:function(index,newValue){var vals,newValues,i;if(arguments.length>1)return this.options.values[index]=this._trimAlignValue(newValue),this._refreshValue(),void this._change(null,index);if(!arguments.length)return this._values();if(!$.isArray(arguments[0]))return this.options.values&&this.options.values.length?this._values(index):this.value();for(vals=this.options.values,newValues=arguments[0],i=0;i<vals.length;i+=1)vals[i]=this._trimAlignValue(newValues[i]),this._change(null,i);this._refreshValue()},_setOption:function(key,value){var i,valsLength=0;switch("range"===key&&!0===this.options.range&&("min"===value?(this.options.value=this._values(0),this.options.values=null):"max"===value&&(this.options.value=this._values(this.options.values.length-1),this.options.values=null)),$.isArray(this.options.values)&&(valsLength=this.options.values.length),"disabled"===key&&this.element.toggleClass("ui-state-disabled",!!value),this._super(key,value),key){case"orientation":this._detectOrientation(),this.element.removeClass("ui-slider-horizontal ui-slider-vertical").addClass("ui-slider-"+this.orientation),this._refreshValue(),this.handles.css("horizontal"===value?"bottom":"left","");break;case"value":this._animateOff=!0,this._refreshValue(),this._change(null,0),this._animateOff=!1;break;case"values":for(this._animateOff=!0,this._refreshValue(),i=0;i<valsLength;i+=1)this._change(null,i);this._animateOff=!1;break;case"step":case"min":case"max":this._animateOff=!0,this._calculateNewMax(),this._refreshValue(),this._animateOff=!1;break;case"range":this._animateOff=!0,this._refresh(),this._animateOff=!1}},_value:function(){var val=this.options.value;return val=this._trimAlignValue(val)},_values:function(index){var val,vals,i;if(arguments.length)return val=this.options.values[index],val=this._trimAlignValue(val);if(this.options.values&&this.options.values.length){for(vals=this.options.values.slice(),i=0;i<vals.length;i+=1)vals[i]=this._trimAlignValue(vals[i]);return vals}return[]},_trimAlignValue:function(val){if(val<=this._valueMin())return this._valueMin();if(val>=this._valueMax())return this._valueMax();var step=this.options.step>0?this.options.step:1,valModStep=(val-this._valueMin())%step,alignValue=val-valModStep;return 2*Math.abs(valModStep)>=step&&(alignValue+=valModStep>0?step:-step),parseFloat(alignValue.toFixed(5))},_calculateNewMax:function(){var max=this.options.max,min=this._valueMin(),step=this.options.step;max=Math.floor(+(max-min).toFixed(this._precision())/step)*step+min,this.max=parseFloat(max.toFixed(this._precision()))},_precision:function(){var precision=this._precisionOf(this.options.step);return null!==this.options.min&&(precision=Math.max(precision,this._precisionOf(this.options.min))),precision},_precisionOf:function(num){var str=num.toString(),decimal=str.indexOf(".");return-1===decimal?0:str.length-decimal-1},_valueMin:function(){return this.options.min},_valueMax:function(){return this.max},_refreshValue:function(){var lastValPercent,valPercent,value,valueMin,valueMax,oRange=this.options.range,o=this.options,that=this,animate=!this._animateOff&&o.animate,_set={};this.options.values&&this.options.values.length?this.handles.each(function(i){valPercent=(that.values(i)-that._valueMin())/(that._valueMax()-that._valueMin())*100,_set["horizontal"===that.orientation?"left":"bottom"]=valPercent+"%",$(this).stop(1,1)[animate?"animate":"css"](_set,o.animate),!0===that.options.range&&("horizontal"===that.orientation?(0===i&&that.range.stop(1,1)[animate?"animate":"css"]({left:valPercent+"%"},o.animate),1===i&&that.range[animate?"animate":"css"]({width:valPercent-lastValPercent+"%"},{queue:!1,duration:o.animate})):(0===i&&that.range.stop(1,1)[animate?"animate":"css"]({bottom:valPercent+"%"},o.animate),1===i&&that.range[animate?"animate":"css"]({height:valPercent-lastValPercent+"%"},{queue:!1,duration:o.animate}))),lastValPercent=valPercent}):(value=this.value(),valueMin=this._valueMin(),valueMax=this._valueMax(),valPercent=valueMax!==valueMin?(value-valueMin)/(valueMax-valueMin)*100:0,_set["horizontal"===this.orientation?"left":"bottom"]=valPercent+"%",this.handle.stop(1,1)[animate?"animate":"css"](_set,o.animate),"min"===oRange&&"horizontal"===this.orientation&&this.range.stop(1,1)[animate?"animate":"css"]({width:valPercent+"%"},o.animate),"max"===oRange&&"horizontal"===this.orientation&&this.range[animate?"animate":"css"]({width:100-valPercent+"%"},{queue:!1,duration:o.animate}),"min"===oRange&&"vertical"===this.orientation&&this.range.stop(1,1)[animate?"animate":"css"]({height:valPercent+"%"},o.animate),"max"===oRange&&"vertical"===this.orientation&&this.range[animate?"animate":"css"]({height:100-valPercent+"%"},{queue:!1,duration:o.animate}))},_handleEvents:{keydown:function(event){var curVal,newVal,step,index=$(event.target).data("ui-slider-handle-index");switch(event.keyCode){case $.ui.keyCode.HOME:case $.ui.keyCode.END:case $.ui.keyCode.PAGE_UP:case $.ui.keyCode.PAGE_DOWN:case $.ui.keyCode.UP:case $.ui.keyCode.RIGHT:case $.ui.keyCode.DOWN:case $.ui.keyCode.LEFT:if(event.preventDefault(),!this._keySliding&&(this._keySliding=!0,$(event.target).addClass("ui-state-active"),!1===this._start(event,index)))return}switch(step=this.options.step,curVal=newVal=this.options.values&&this.options.values.length?this.values(index):this.value(),event.keyCode){case $.ui.keyCode.HOME:newVal=this._valueMin();break;case $.ui.keyCode.END:newVal=this._valueMax();break;case $.ui.keyCode.PAGE_UP:newVal=this._trimAlignValue(curVal+(this._valueMax()-this._valueMin())/this.numPages);break;case $.ui.keyCode.PAGE_DOWN:newVal=this._trimAlignValue(curVal-(this._valueMax()-this._valueMin())/this.numPages);break;case $.ui.keyCode.UP:case $.ui.keyCode.RIGHT:if(curVal===this._valueMax())return;newVal=this._trimAlignValue(curVal+step);break;case $.ui.keyCode.DOWN:case $.ui.keyCode.LEFT:if(curVal===this._valueMin())return;newVal=this._trimAlignValue(curVal-step)}this._slide(event,index,newVal)},keyup:function(event){var index=$(event.target).data("ui-slider-handle-index");this._keySliding&&(this._keySliding=!1,this._stop(event,index),this._change(event,index),$(event.target).removeClass("ui-state-active"))}}});function spinner_modifier(fn){return function(){var previous=this.element.val();fn.apply(this,arguments),this._refresh(),previous!==this.element.val()&&this._trigger("change")}}var jQuery=($.widget("ui.spinner",{version:"1.11.4",defaultElement:"<input>",widgetEventPrefix:"spin",options:{culture:null,icons:{down:"ui-icon-triangle-1-s",up:"ui-icon-triangle-1-n"},incremental:!0,max:null,min:null,numberFormat:null,page:10,step:1,change:null,spin:null,start:null,stop:null},_create:function(){this._setOption("max",this.options.max),this._setOption("min",this.options.min),this._setOption("step",this.options.step),""!==this.value()&&this._value(this.element.val(),!0),this._draw(),this._on(this._events),this._refresh(),this._on(this.window,{beforeunload:function(){this.element.removeAttr("autocomplete")}})},_getCreateOptions:function(){var options={},element=this.element;return $.each(["min","max","step"],function(i,option){var value=element.attr(option);void 0!==value&&value.length&&(options[option]=value)}),options},_events:{keydown:function(event){this._start(event)&&this._keydown(event)&&event.preventDefault()},keyup:"_stop",focus:function(){this.previous=this.element.val()},blur:function(event){if(this.cancelBlur)return void delete this.cancelBlur;this._stop(),this._refresh(),this.previous!==this.element.val()&&this._trigger("change",event)},mousewheel:function(event,delta){if(delta){if(!this.spinning&&!this._start(event))return!1;this._spin((delta>0?1:-1)*this.options.step,event),clearTimeout(this.mousewheelTimer),this.mousewheelTimer=this._delay(function(){this.spinning&&this._stop(event)},100),event.preventDefault()}},"mousedown .ui-spinner-button":function(event){var previous;previous=this.element[0]===this.document[0].activeElement?this.previous:this.element.val();function checkFocus(){this.element[0]===this.document[0].activeElement||(this.element.focus(),this.previous=previous,this._delay(function(){this.previous=previous}))}event.preventDefault(),checkFocus.call(this),this.cancelBlur=!0,this._delay(function(){delete this.cancelBlur,checkFocus.call(this)}),!1!==this._start(event)&&this._repeat(null,$(event.currentTarget).hasClass("ui-spinner-up")?1:-1,event)},"mouseup .ui-spinner-button":"_stop","mouseenter .ui-spinner-button":function(event){if($(event.currentTarget).hasClass("ui-state-active"))return!1!==this._start(event)&&void this._repeat(null,$(event.currentTarget).hasClass("ui-spinner-up")?1:-1,event)},"mouseleave .ui-spinner-button":"_stop"},_draw:function(){var uiSpinner=this.uiSpinner=this.element.addClass("ui-spinner-input").attr("autocomplete","off").wrap(this._uiSpinnerHtml()).parent().append(this._buttonHtml());this.element.attr("role","spinbutton"),this.buttons=uiSpinner.find(".ui-spinner-button").attr("tabIndex",-1).button().removeClass("ui-corner-all"),this.buttons.height()>Math.ceil(.5*uiSpinner.height())&&uiSpinner.height()>0&&uiSpinner.height(uiSpinner.height()),this.options.disabled&&this.disable()},_keydown:function(event){var options=this.options,keyCode=$.ui.keyCode;switch(event.keyCode){case keyCode.UP:return this._repeat(null,1,event),!0;case keyCode.DOWN:return this._repeat(null,-1,event),!0;case keyCode.PAGE_UP:return this._repeat(null,options.page,event),!0;case keyCode.PAGE_DOWN:return this._repeat(null,-options.page,event),!0}return!1},_uiSpinnerHtml:function(){return"<span class='ui-spinner ui-widget ui-widget-content ui-corner-all'></span>"},_buttonHtml:function(){return"<a class='ui-spinner-button ui-spinner-up ui-corner-tr'><span class='ui-icon "+this.options.icons.up+"'>&#9650;</span></a><a class='ui-spinner-button ui-spinner-down ui-corner-br'><span class='ui-icon "+this.options.icons.down+"'>&#9660;</span></a>"},_start:function(event){return!(!this.spinning&&!1===this._trigger("start",event))&&(this.counter||(this.counter=1),this.spinning=!0,!0)},_repeat:function(i,steps,event){i=i||500,clearTimeout(this.timer),this.timer=this._delay(function(){this._repeat(40,steps,event)},i),this._spin(steps*this.options.step,event)},_spin:function(step,event){var value=this.value()||0;this.counter||(this.counter=1),value=this._adjustValue(value+step*this._increment(this.counter)),this.spinning&&!1===this._trigger("spin",event,{value:value})||(this._value(value),this.counter++)},_increment:function(i){var incremental=this.options.incremental;return incremental?$.isFunction(incremental)?incremental(i):Math.floor(i*i*i/5e4-i*i/500+17*i/200+1):1},_precision:function(){var precision=this._precisionOf(this.options.step);return null!==this.options.min&&(precision=Math.max(precision,this._precisionOf(this.options.min))),precision},_precisionOf:function(num){var str=num.toString(),decimal=str.indexOf(".");return-1===decimal?0:str.length-decimal-1},_adjustValue:function(value){var base,aboveMin,options=this.options;return base=null!==options.min?options.min:0,aboveMin=value-base,aboveMin=Math.round(aboveMin/options.step)*options.step,value=base+aboveMin,value=parseFloat(value.toFixed(this._precision())),null!==options.max&&value>options.max?options.max:null!==options.min&&value<options.min?options.min:value},_stop:function(event){this.spinning&&(clearTimeout(this.timer),clearTimeout(this.mousewheelTimer),this.counter=0,this.spinning=!1,this._trigger("stop",event))},_setOption:function(key,value){if("culture"===key||"numberFormat"===key){var prevValue=this._parse(this.element.val());return this.options[key]=value,void this.element.val(this._format(prevValue))}"max"!==key&&"min"!==key&&"step"!==key||"string"==typeof value&&(value=this._parse(value)),"icons"===key&&(this.buttons.first().find(".ui-icon").removeClass(this.options.icons.up).addClass(value.up),this.buttons.last().find(".ui-icon").removeClass(this.options.icons.down).addClass(value.down)),this._super(key,value),"disabled"===key&&(this.widget().toggleClass("ui-state-disabled",!!value),this.element.prop("disabled",!!value),this.buttons.button(value?"disable":"enable"))},_setOptions:spinner_modifier(function(options){this._super(options)}),_parse:function(val){return"string"==typeof val&&""!==val&&(val=window.Globalize&&this.options.numberFormat?Globalize.parseFloat(val,10,this.options.culture):+val),""===val||isNaN(val)?null:val},_format:function(value){return""===value?"":window.Globalize&&this.options.numberFormat?Globalize.format(value,this.options.numberFormat,this.options.culture):value},_refresh:function(){this.element.attr({"aria-valuemin":this.options.min,"aria-valuemax":this.options.max,"aria-valuenow":this._parse(this.element.val())})},isValid:function(){var value=this.value();return null!==value&&value===this._adjustValue(value)},_value:function(value,allowAny){var parsed;""!==value&&null!==(parsed=this._parse(value))&&(allowAny||(parsed=this._adjustValue(parsed)),value=this._format(parsed)),this.element.val(value),this._refresh()},_destroy:function(){this.element.removeClass("ui-spinner-input").prop("disabled",!1).removeAttr("autocomplete").removeAttr("role").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuenow"),this.uiSpinner.replaceWith(this.element)},stepUp:spinner_modifier(function(steps){this._stepUp(steps)}),_stepUp:function(steps){this._start()&&(this._spin((steps||1)*this.options.step),this._stop())},stepDown:spinner_modifier(function(steps){this._stepDown(steps)}),_stepDown:function(steps){this._start()&&(this._spin((steps||1)*-this.options.step),this._stop())},pageUp:spinner_modifier(function(pages){this._stepUp((pages||1)*this.options.page)}),pageDown:spinner_modifier(function(pages){this._stepDown((pages||1)*this.options.page)}),value:function(newVal){if(!arguments.length)return this._parse(this.element.val());spinner_modifier(this._value).call(this,newVal)},widget:function(){return this.uiSpinner}}),$.widget("ui.tabs",{version:"1.11.4",delay:300,options:{active:null,collapsible:!1,event:"click",heightStyle:"content",hide:null,show:null,activate:null,beforeActivate:null,beforeLoad:null,load:null},_isLocal:function(){var rhash=/#.*$/;return function(anchor){var anchorUrl,locationUrl;anchor=anchor.cloneNode(!1),anchorUrl=anchor.href.replace(rhash,""),locationUrl=location.href.replace(rhash,"");try{anchorUrl=decodeURIComponent(anchorUrl)}catch(error){}try{locationUrl=decodeURIComponent(locationUrl)}catch(error){}return anchor.hash.length>1&&anchorUrl===locationUrl}}(),_create:function(){var that=this,options=this.options;this.running=!1,this.element.addClass("ui-tabs ui-widget ui-widget-content ui-corner-all").toggleClass("ui-tabs-collapsible",options.collapsible),this._processTabs(),options.active=this._initialActive(),$.isArray(options.disabled)&&(options.disabled=$.unique(options.disabled.concat($.map(this.tabs.filter(".ui-state-disabled"),function(li){return that.tabs.index(li)}))).sort()),!1!==this.options.active&&this.anchors.length?this.active=this._findActive(options.active):this.active=$(),this._refresh(),this.active.length&&this.load(options.active)},_initialActive:function(){var active=this.options.active,collapsible=this.options.collapsible,locationHash=location.hash.substring(1);return null===active&&(locationHash&&this.tabs.each(function(i,tab){if($(tab).attr("aria-controls")===locationHash)return active=i,!1}),null===active&&(active=this.tabs.index(this.tabs.filter(".ui-tabs-active"))),null!==active&&-1!==active||(active=!!this.tabs.length&&0)),!1!==active&&-1===(active=this.tabs.index(this.tabs.eq(active)))&&(active=!collapsible&&0),!collapsible&&!1===active&&this.anchors.length&&(active=0),active},_getCreateEventData:function(){return{tab:this.active,panel:this.active.length?this._getPanelForTab(this.active):$()}},_tabKeydown:function(event){var focusedTab=$(this.document[0].activeElement).closest("li"),selectedIndex=this.tabs.index(focusedTab),goingForward=!0;if(!this._handlePageNav(event)){switch(event.keyCode){case $.ui.keyCode.RIGHT:case $.ui.keyCode.DOWN:selectedIndex++;break;case $.ui.keyCode.UP:case $.ui.keyCode.LEFT:goingForward=!1,selectedIndex--;break;case $.ui.keyCode.END:selectedIndex=this.anchors.length-1;break;case $.ui.keyCode.HOME:selectedIndex=0;break;case $.ui.keyCode.SPACE:return event.preventDefault(),clearTimeout(this.activating),void this._activate(selectedIndex);case $.ui.keyCode.ENTER:return event.preventDefault(),clearTimeout(this.activating),void this._activate(selectedIndex!==this.options.active&&selectedIndex);default:return}event.preventDefault(),clearTimeout(this.activating),selectedIndex=this._focusNextTab(selectedIndex,goingForward),event.ctrlKey||event.metaKey||(focusedTab.attr("aria-selected","false"),this.tabs.eq(selectedIndex).attr("aria-selected","true"),this.activating=this._delay(function(){this.option("active",selectedIndex)},this.delay))}},_panelKeydown:function(event){this._handlePageNav(event)||event.ctrlKey&&event.keyCode===$.ui.keyCode.UP&&(event.preventDefault(),this.active.focus())},_handlePageNav:function(event){return event.altKey&&event.keyCode===$.ui.keyCode.PAGE_UP?(this._activate(this._focusNextTab(this.options.active-1,!1)),!0):event.altKey&&event.keyCode===$.ui.keyCode.PAGE_DOWN?(this._activate(this._focusNextTab(this.options.active+1,!0)),!0):void 0},_findNextTab:function(index,goingForward){var lastTabIndex=this.tabs.length-1;for(;-1!==$.inArray(function(){return index>lastTabIndex&&(index=0),index<0&&(index=lastTabIndex),index}(),this.options.disabled);)index=goingForward?index+1:index-1;return index},_focusNextTab:function(index,goingForward){return index=this._findNextTab(index,goingForward),this.tabs.eq(index).focus(),index},_setOption:function(key,value){return"active"===key?void this._activate(value):"disabled"===key?void this._setupDisabled(value):(this._super(key,value),"collapsible"===key&&(this.element.toggleClass("ui-tabs-collapsible",value),value||!1!==this.options.active||this._activate(0)),"event"===key&&this._setupEvents(value),void("heightStyle"===key&&this._setupHeightStyle(value)))},_sanitizeSelector:function(hash){return hash?hash.replace(/[!"$%&'()*+,.\/:;<=>?@\[\]\^`{|}~]/g,"\\$&"):""},refresh:function(){var options=this.options,lis=this.tablist.children(":has(a[href])");options.disabled=$.map(lis.filter(".ui-state-disabled"),function(tab){return lis.index(tab)}),this._processTabs(),!1!==options.active&&this.anchors.length?this.active.length&&!$.contains(this.tablist[0],this.active[0])?this.tabs.length===options.disabled.length?(options.active=!1,this.active=$()):this._activate(this._findNextTab(Math.max(0,options.active-1),!1)):options.active=this.tabs.index(this.active):(options.active=!1,this.active=$()),this._refresh()},_refresh:function(){this._setupDisabled(this.options.disabled),this._setupEvents(this.options.event),this._setupHeightStyle(this.options.heightStyle),this.tabs.not(this.active).attr({"aria-selected":"false","aria-expanded":"false",tabIndex:-1}),this.panels.not(this._getPanelForTab(this.active)).hide().attr({"aria-hidden":"true"}),this.active.length?(this.active.addClass("ui-tabs-active ui-state-active").attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0}),this._getPanelForTab(this.active).show().attr({"aria-hidden":"false"})):this.tabs.eq(0).attr("tabIndex",0)},_processTabs:function(){var that=this,prevTabs=this.tabs,prevAnchors=this.anchors,prevPanels=this.panels
;this.tablist=this._getList().addClass("ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all").attr("role","tablist").delegate("> li","mousedown"+this.eventNamespace,function(event){$(this).is(".ui-state-disabled")&&event.preventDefault()}).delegate(".ui-tabs-anchor","focus"+this.eventNamespace,function(){$(this).closest("li").is(".ui-state-disabled")&&this.blur()}),this.tabs=this.tablist.find("> li:has(a[href])").addClass("ui-state-default ui-corner-top").attr({role:"tab",tabIndex:-1}),this.anchors=this.tabs.map(function(){return $("a",this)[0]}).addClass("ui-tabs-anchor").attr({role:"presentation",tabIndex:-1}),this.panels=$(),this.anchors.each(function(i,anchor){var selector,panel,panelId,anchorId=$(anchor).uniqueId().attr("id"),tab=$(anchor).closest("li"),originalAriaControls=tab.attr("aria-controls");that._isLocal(anchor)?(selector=anchor.hash,panelId=selector.substring(1),panel=that.element.find(that._sanitizeSelector(selector))):(panelId=tab.attr("aria-controls")||$({}).uniqueId()[0].id,selector="#"+panelId,panel=that.element.find(selector),panel.length||(panel=that._createPanel(panelId),panel.insertAfter(that.panels[i-1]||that.tablist)),panel.attr("aria-live","polite")),panel.length&&(that.panels=that.panels.add(panel)),originalAriaControls&&tab.data("ui-tabs-aria-controls",originalAriaControls),tab.attr({"aria-controls":panelId,"aria-labelledby":anchorId}),panel.attr("aria-labelledby",anchorId)}),this.panels.addClass("ui-tabs-panel ui-widget-content ui-corner-bottom").attr("role","tabpanel"),prevTabs&&(this._off(prevTabs.not(this.tabs)),this._off(prevAnchors.not(this.anchors)),this._off(prevPanels.not(this.panels)))},_getList:function(){return this.tablist||this.element.find("ol,ul").eq(0)},_createPanel:function(id){return $("<div>").attr("id",id).addClass("ui-tabs-panel ui-widget-content ui-corner-bottom").data("ui-tabs-destroy",!0)},_setupDisabled:function(disabled){$.isArray(disabled)&&(disabled.length?disabled.length===this.anchors.length&&(disabled=!0):disabled=!1);for(var li,i=0;li=this.tabs[i];i++)!0===disabled||-1!==$.inArray(i,disabled)?$(li).addClass("ui-state-disabled").attr("aria-disabled","true"):$(li).removeClass("ui-state-disabled").removeAttr("aria-disabled");this.options.disabled=disabled},_setupEvents:function(event){var events={};event&&$.each(event.split(" "),function(index,eventName){events[eventName]="_eventHandler"}),this._off(this.anchors.add(this.tabs).add(this.panels)),this._on(!0,this.anchors,{click:function(event){event.preventDefault()}}),this._on(this.anchors,events),this._on(this.tabs,{keydown:"_tabKeydown"}),this._on(this.panels,{keydown:"_panelKeydown"}),this._focusable(this.tabs),this._hoverable(this.tabs)},_setupHeightStyle:function(heightStyle){var maxHeight,parent=this.element.parent();"fill"===heightStyle?(maxHeight=parent.height(),maxHeight-=this.element.outerHeight()-this.element.height(),this.element.siblings(":visible").each(function(){var elem=$(this),position=elem.css("position");"absolute"!==position&&"fixed"!==position&&(maxHeight-=elem.outerHeight(!0))}),this.element.children().not(this.panels).each(function(){maxHeight-=$(this).outerHeight(!0)}),this.panels.each(function(){$(this).height(Math.max(0,maxHeight-$(this).innerHeight()+$(this).height()))}).css("overflow","auto")):"auto"===heightStyle&&(maxHeight=0,this.panels.each(function(){maxHeight=Math.max(maxHeight,$(this).height("").height())}).height(maxHeight))},_eventHandler:function(event){var options=this.options,active=this.active,anchor=$(event.currentTarget),tab=anchor.closest("li"),clickedIsActive=tab[0]===active[0],collapsing=clickedIsActive&&options.collapsible,toShow=collapsing?$():this._getPanelForTab(tab),toHide=active.length?this._getPanelForTab(active):$(),eventData={oldTab:active,oldPanel:toHide,newTab:collapsing?$():tab,newPanel:toShow};event.preventDefault(),tab.hasClass("ui-state-disabled")||tab.hasClass("ui-tabs-loading")||this.running||clickedIsActive&&!options.collapsible||!1===this._trigger("beforeActivate",event,eventData)||(options.active=!collapsing&&this.tabs.index(tab),this.active=clickedIsActive?$():tab,this.xhr&&this.xhr.abort(),toHide.length||toShow.length||$.error("jQuery UI Tabs: Mismatching fragment identifier."),toShow.length&&this.load(this.tabs.index(tab),event),this._toggle(event,eventData))},_toggle:function(event,eventData){var that=this,toShow=eventData.newPanel,toHide=eventData.oldPanel;this.running=!0;function complete(){that.running=!1,that._trigger("activate",event,eventData)}function show(){eventData.newTab.closest("li").addClass("ui-tabs-active ui-state-active"),toShow.length&&that.options.show?that._show(toShow,that.options.show,complete):(toShow.show(),complete())}toHide.length&&this.options.hide?this._hide(toHide,this.options.hide,function(){eventData.oldTab.closest("li").removeClass("ui-tabs-active ui-state-active"),show()}):(eventData.oldTab.closest("li").removeClass("ui-tabs-active ui-state-active"),toHide.hide(),show()),toHide.attr("aria-hidden","true"),eventData.oldTab.attr({"aria-selected":"false","aria-expanded":"false"}),toShow.length&&toHide.length?eventData.oldTab.attr("tabIndex",-1):toShow.length&&this.tabs.filter(function(){return 0===$(this).attr("tabIndex")}).attr("tabIndex",-1),toShow.attr("aria-hidden","false"),eventData.newTab.attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0})},_activate:function(index){var anchor,active=this._findActive(index);active[0]!==this.active[0]&&(active.length||(active=this.active),anchor=active.find(".ui-tabs-anchor")[0],this._eventHandler({target:anchor,currentTarget:anchor,preventDefault:$.noop}))},_findActive:function(index){return!1===index?$():this.tabs.eq(index)},_getIndex:function(index){return"string"==typeof index&&(index=this.anchors.index(this.anchors.filter("[href$='"+index+"']"))),index},_destroy:function(){this.xhr&&this.xhr.abort(),this.element.removeClass("ui-tabs ui-widget ui-widget-content ui-corner-all ui-tabs-collapsible"),this.tablist.removeClass("ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all").removeAttr("role"),this.anchors.removeClass("ui-tabs-anchor").removeAttr("role").removeAttr("tabIndex").removeUniqueId(),this.tablist.unbind(this.eventNamespace),this.tabs.add(this.panels).each(function(){$.data(this,"ui-tabs-destroy")?$(this).remove():$(this).removeClass("ui-state-default ui-state-active ui-state-disabled ui-corner-top ui-corner-bottom ui-widget-content ui-tabs-active ui-tabs-panel").removeAttr("tabIndex").removeAttr("aria-live").removeAttr("aria-busy").removeAttr("aria-selected").removeAttr("aria-labelledby").removeAttr("aria-hidden").removeAttr("aria-expanded").removeAttr("role")}),this.tabs.each(function(){var li=$(this),prev=li.data("ui-tabs-aria-controls");prev?li.attr("aria-controls",prev).removeData("ui-tabs-aria-controls"):li.removeAttr("aria-controls")}),this.panels.show(),"content"!==this.options.heightStyle&&this.panels.css("height","")},enable:function(index){var disabled=this.options.disabled;!1!==disabled&&(void 0===index?disabled=!1:(index=this._getIndex(index),disabled=$.isArray(disabled)?$.map(disabled,function(num){return num!==index?num:null}):$.map(this.tabs,function(li,num){return num!==index?num:null})),this._setupDisabled(disabled))},disable:function(index){var disabled=this.options.disabled;if(!0!==disabled){if(void 0===index)disabled=!0;else{if(index=this._getIndex(index),-1!==$.inArray(index,disabled))return;disabled=$.isArray(disabled)?$.merge([index],disabled).sort():[index]}this._setupDisabled(disabled)}},load:function(index,event){index=this._getIndex(index);var that=this,tab=this.tabs.eq(index),anchor=tab.find(".ui-tabs-anchor"),panel=this._getPanelForTab(tab),eventData={tab:tab,panel:panel},complete=function(jqXHR,status){"abort"===status&&that.panels.stop(!1,!0),tab.removeClass("ui-tabs-loading"),panel.removeAttr("aria-busy"),jqXHR===that.xhr&&delete that.xhr};this._isLocal(anchor[0])||(this.xhr=$.ajax(this._ajaxSettings(anchor,event,eventData)),this.xhr&&"canceled"!==this.xhr.statusText&&(tab.addClass("ui-tabs-loading"),panel.attr("aria-busy","true"),this.xhr.done(function(response,status,jqXHR){setTimeout(function(){panel.html(response),that._trigger("load",event,eventData),complete(jqXHR,status)},1)}).fail(function(jqXHR,status){setTimeout(function(){complete(jqXHR,status)},1)})))},_ajaxSettings:function(anchor,event,eventData){var that=this;return{url:anchor.attr("href"),beforeSend:function(jqXHR,settings){return that._trigger("beforeLoad",event,$.extend({jqXHR:jqXHR,ajaxSettings:settings},eventData))}}},_getPanelForTab:function(tab){var id=$(tab).attr("aria-controls");return this.element.find(this._sanitizeSelector("#"+id))}}),$.widget("ui.tooltip",{version:"1.11.4",options:{content:function(){var title=$(this).attr("title")||"";return $("<a>").text(title).html()},hide:!0,items:"[title]:not([disabled])",position:{my:"left top+15",at:"left bottom",collision:"flipfit flip"},show:!0,tooltipClass:null,track:!1,close:null,open:null},_addDescribedBy:function(elem,id){var describedby=(elem.attr("aria-describedby")||"").split(/\s+/);describedby.push(id),elem.data("ui-tooltip-id",id).attr("aria-describedby",$.trim(describedby.join(" ")))},_removeDescribedBy:function(elem){var id=elem.data("ui-tooltip-id"),describedby=(elem.attr("aria-describedby")||"").split(/\s+/),index=$.inArray(id,describedby);-1!==index&&describedby.splice(index,1),elem.removeData("ui-tooltip-id"),describedby=$.trim(describedby.join(" ")),describedby?elem.attr("aria-describedby",describedby):elem.removeAttr("aria-describedby")},_create:function(){this._on({mouseover:"open",focusin:"open"}),this.tooltips={},this.parents={},this.options.disabled&&this._disable(),this.liveRegion=$("<div>").attr({role:"log","aria-live":"assertive","aria-relevant":"additions"}).addClass("ui-helper-hidden-accessible").appendTo(this.document[0].body)},_setOption:function(key,value){var that=this;if("disabled"===key)return this[value?"_disable":"_enable"](),void(this.options[key]=value);this._super(key,value),"content"===key&&$.each(this.tooltips,function(id,tooltipData){that._updateContent(tooltipData.element)})},_disable:function(){var that=this;$.each(this.tooltips,function(id,tooltipData){var event=$.Event("blur");event.target=event.currentTarget=tooltipData.element[0],that.close(event,!0)}),this.element.find(this.options.items).addBack().each(function(){var element=$(this);element.is("[title]")&&element.data("ui-tooltip-title",element.attr("title")).removeAttr("title")})},_enable:function(){this.element.find(this.options.items).addBack().each(function(){var element=$(this);element.data("ui-tooltip-title")&&element.attr("title",element.data("ui-tooltip-title"))})},open:function(event){var that=this,target=$(event?event.target:this.element).closest(this.options.items);target.length&&!target.data("ui-tooltip-id")&&(target.attr("title")&&target.data("ui-tooltip-title",target.attr("title")),target.data("ui-tooltip-open",!0),event&&"mouseover"===event.type&&target.parents().each(function(){var blurEvent,parent=$(this);parent.data("ui-tooltip-open")&&(blurEvent=$.Event("blur"),blurEvent.target=blurEvent.currentTarget=this,that.close(blurEvent,!0)),parent.attr("title")&&(parent.uniqueId(),that.parents[this.id]={element:this,title:parent.attr("title")},parent.attr("title",""))}),this._registerCloseHandlers(event,target),this._updateContent(target,event))},_updateContent:function(target,event){var content,contentOption=this.options.content,that=this,eventType=event?event.type:null;if("string"==typeof contentOption)return this._open(event,target,contentOption);(content=contentOption.call(target[0],function(response){that._delay(function(){target.data("ui-tooltip-open")&&(event&&(event.type=eventType),this._open(event,target,response))})}))&&this._open(event,target,content)},_open:function(event,target,content){var tooltipData,tooltip,delayedShow,a11yContent,positionOption=$.extend({},this.options.position);function position(event){positionOption.of=event,tooltip.is(":hidden")||tooltip.position(positionOption)}if(content){if(tooltipData=this._find(target))return void tooltipData.tooltip.find(".ui-tooltip-content").html(content);target.is("[title]")&&(event&&"mouseover"===event.type?target.attr("title",""):target.removeAttr("title")),tooltipData=this._tooltip(target),tooltip=tooltipData.tooltip,this._addDescribedBy(target,tooltip.attr("id")),tooltip.find(".ui-tooltip-content").html(content),this.liveRegion.children().hide(),content.clone?(a11yContent=content.clone(),a11yContent.removeAttr("id").find("[id]").removeAttr("id")):a11yContent=content,$("<div>").html(a11yContent).appendTo(this.liveRegion),this.options.track&&event&&/^mouse/.test(event.type)?(this._on(this.document,{mousemove:position}),position(event)):tooltip.position($.extend({of:target},this.options.position)),tooltip.hide(),this._show(tooltip,this.options.show),this.options.show&&this.options.show.delay&&(delayedShow=this.delayedShow=setInterval(function(){tooltip.is(":visible")&&(position(positionOption.of),clearInterval(delayedShow))},$.fx.interval)),this._trigger("open",event,{tooltip:tooltip})}},_registerCloseHandlers:function(event,target){var events={keyup:function(event){if(event.keyCode===$.ui.keyCode.ESCAPE){var fakeEvent=$.Event(event);fakeEvent.currentTarget=target[0],this.close(fakeEvent,!0)}}};target[0]!==this.element[0]&&(events.remove=function(){this._removeTooltip(this._find(target).tooltip)}),event&&"mouseover"!==event.type||(events.mouseleave="close"),event&&"focusin"!==event.type||(events.focusout="close"),this._on(!0,target,events)},close:function(event){var tooltip,that=this,target=$(event?event.currentTarget:this.element),tooltipData=this._find(target);if(!tooltipData)return void target.removeData("ui-tooltip-open");tooltip=tooltipData.tooltip,tooltipData.closing||(clearInterval(this.delayedShow),target.data("ui-tooltip-title")&&!target.attr("title")&&target.attr("title",target.data("ui-tooltip-title")),this._removeDescribedBy(target),tooltipData.hiding=!0,tooltip.stop(!0),this._hide(tooltip,this.options.hide,function(){that._removeTooltip($(this))}),target.removeData("ui-tooltip-open"),this._off(target,"mouseleave focusout keyup"),target[0]!==this.element[0]&&this._off(target,"remove"),this._off(this.document,"mousemove"),event&&"mouseleave"===event.type&&$.each(this.parents,function(id,parent){$(parent.element).attr("title",parent.title),delete that.parents[id]}),tooltipData.closing=!0,this._trigger("close",event,{tooltip:tooltip}),tooltipData.hiding||(tooltipData.closing=!1))},_tooltip:function(element){var tooltip=$("<div>").attr("role","tooltip").addClass("ui-tooltip ui-widget ui-corner-all ui-widget-content "+(this.options.tooltipClass||"")),id=tooltip.uniqueId().attr("id");return $("<div>").addClass("ui-tooltip-content").appendTo(tooltip),tooltip.appendTo(this.document[0].body),this.tooltips[id]={element:element,tooltip:tooltip}},_find:function(target){var id=target.data("ui-tooltip-id");return id?this.tooltips[id]:null},_removeTooltip:function(tooltip){tooltip.remove(),delete this.tooltips[tooltip.attr("id")]},_destroy:function(){var that=this;$.each(this.tooltips,function(id,tooltipData){var event=$.Event("blur"),element=tooltipData.element;event.target=event.currentTarget=element[0],that.close(event,!0),$("#"+id).remove(),element.data("ui-tooltip-title")&&(element.attr("title")||element.attr("title",element.data("ui-tooltip-title")),element.removeData("ui-tooltip-title"))}),this.liveRegion.remove()}}),$);$.effects={effect:{}},function(jQuery,undefined){var colors,rplusequals=/^([\-+])=\s*(\d+\.?\d*)/,stringParsers=[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(execResult){return[execResult[1],execResult[2],execResult[3],execResult[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(execResult){return[2.55*execResult[1],2.55*execResult[2],2.55*execResult[3],execResult[4]]}},{re:/#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})/,parse:function(execResult){return[parseInt(execResult[1],16),parseInt(execResult[2],16),parseInt(execResult[3],16)]}},{re:/#([a-f0-9])([a-f0-9])([a-f0-9])/,parse:function(execResult){return[parseInt(execResult[1]+execResult[1],16),parseInt(execResult[2]+execResult[2],16),parseInt(execResult[3]+execResult[3],16)]}},{re:/hsla?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,space:"hsla",parse:function(execResult){return[execResult[1],execResult[2]/100,execResult[3]/100,execResult[4]]}}],color=jQuery.Color=function(color,green,blue,alpha){return new jQuery.Color.fn.parse(color,green,blue,alpha)},spaces={rgba:{props:{red:{idx:0,type:"byte"},green:{idx:1,type:"byte"},blue:{idx:2,type:"byte"}}},hsla:{props:{hue:{idx:0,type:"degrees"},saturation:{idx:1,type:"percent"},lightness:{idx:2,type:"percent"}}}},propTypes={byte:{floor:!0,max:255},percent:{max:1},degrees:{mod:360,floor:!0}},support=color.support={},supportElem=jQuery("<p>")[0],each=jQuery.each;supportElem.style.cssText="background-color:rgba(1,1,1,.5)",support.rgba=supportElem.style.backgroundColor.indexOf("rgba")>-1,each(spaces,function(spaceName,space){space.cache="_"+spaceName,space.props.alpha={idx:3,type:"percent",def:1}});function clamp(value,prop,allowEmpty){var type=propTypes[prop.type]||{};return null==value?allowEmpty||!prop.def?null:prop.def:(value=type.floor?~~value:parseFloat(value),isNaN(value)?prop.def:type.mod?(value+type.mod)%type.mod:0>value?0:type.max<value?type.max:value)}function stringParse(string){var inst=color(),rgba=inst._rgba=[];return string=string.toLowerCase(),each(stringParsers,function(i,parser){var parsed,match=parser.re.exec(string),values=match&&parser.parse(match),spaceName=parser.space||"rgba";if(values)return parsed=inst[spaceName](values),inst[spaces[spaceName].cache]=parsed[spaces[spaceName].cache],rgba=inst._rgba=parsed._rgba,!1}),rgba.length?("0,0,0,0"===rgba.join()&&jQuery.extend(rgba,colors.transparent),inst):colors[string]}color.fn=jQuery.extend(color.prototype,{parse:function(red,green,blue,alpha){if(void 0===red)return this._rgba=[null,null,null,null],this;(red.jquery||red.nodeType)&&(red=jQuery(red).css(green),green=void 0);var inst=this,type=jQuery.type(red),rgba=this._rgba=[];return void 0!==green&&(red=[red,green,blue,alpha],type="array"),"string"===type?this.parse(stringParse(red)||colors._default):"array"===type?(each(spaces.rgba.props,function(key,prop){rgba[prop.idx]=clamp(red[prop.idx],prop)}),this):"object"===type?(red instanceof color?each(spaces,function(spaceName,space){red[space.cache]&&(inst[space.cache]=red[space.cache].slice())}):each(spaces,function(spaceName,space){var cache=space.cache;each(space.props,function(key,prop){if(!inst[cache]&&space.to){if("alpha"===key||null==red[key])return;inst[cache]=space.to(inst._rgba)}inst[cache][prop.idx]=clamp(red[key],prop,!0)}),inst[cache]&&jQuery.inArray(null,inst[cache].slice(0,3))<0&&(inst[cache][3]=1,space.from&&(inst._rgba=space.from(inst[cache])))}),this):void 0},is:function(compare){var is=color(compare),same=!0,inst=this;return each(spaces,function(_,space){var localCache,isCache=is[space.cache];return isCache&&(localCache=inst[space.cache]||space.to&&space.to(inst._rgba)||[],each(space.props,function(_,prop){if(null!=isCache[prop.idx])return same=isCache[prop.idx]===localCache[prop.idx]})),same}),same},_space:function(){var used=[],inst=this;return each(spaces,function(spaceName,space){inst[space.cache]&&used.push(spaceName)}),used.pop()},transition:function(other,distance){var end=color(other),spaceName=end._space(),space=spaces[spaceName],startColor=0===this.alpha()?color("transparent"):this,start=startColor[space.cache]||space.to(startColor._rgba),result=start.slice();return end=end[space.cache],each(space.props,function(key,prop){var index=prop.idx,startValue=start[index],endValue=end[index],type=propTypes[prop.type]||{};null!==endValue&&(null===startValue?result[index]=endValue:(type.mod&&(endValue-startValue>type.mod/2?startValue+=type.mod:startValue-endValue>type.mod/2&&(startValue-=type.mod)),result[index]=clamp((endValue-startValue)*distance+startValue,prop)))}),this[spaceName](result)},blend:function(opaque){if(1===this._rgba[3])return this;var rgb=this._rgba.slice(),a=rgb.pop(),blend=color(opaque)._rgba;return color(jQuery.map(rgb,function(v,i){return(1-a)*blend[i]+a*v}))},toRgbaString:function(){var prefix="rgba(",rgba=jQuery.map(this._rgba,function(v,i){return null==v?i>2?1:0:v});return 1===rgba[3]&&(rgba.pop(),prefix="rgb("),prefix+rgba.join()+")"},toHslaString:function(){var prefix="hsla(",hsla=jQuery.map(this.hsla(),function(v,i){return null==v&&(v=i>2?1:0),i&&i<3&&(v=Math.round(100*v)+"%"),v});return 1===hsla[3]&&(hsla.pop(),prefix="hsl("),prefix+hsla.join()+")"},toHexString:function(includeAlpha){var rgba=this._rgba.slice(),alpha=rgba.pop();return includeAlpha&&rgba.push(~~(255*alpha)),"#"+jQuery.map(rgba,function(v){return v=(v||0).toString(16),1===v.length?"0"+v:v}).join("")},toString:function(){return 0===this._rgba[3]?"transparent":this.toRgbaString()}}),color.fn.parse.prototype=color.fn;function hue2rgb(p,q,h){return h=(h+1)%1,6*h<1?p+(q-p)*h*6:2*h<1?q:3*h<2?p+(q-p)*(2/3-h)*6:p}spaces.hsla.to=function(rgba){if(null==rgba[0]||null==rgba[1]||null==rgba[2])return[null,null,null,rgba[3]];var h,s,r=rgba[0]/255,g=rgba[1]/255,b=rgba[2]/255,a=rgba[3],max=Math.max(r,g,b),min=Math.min(r,g,b),diff=max-min,add=max+min,l=.5*add;return h=min===max?0:r===max?60*(g-b)/diff+360:g===max?60*(b-r)/diff+120:60*(r-g)/diff+240,s=0===diff?0:l<=.5?diff/add:diff/(2-add),[Math.round(h)%360,s,l,null==a?1:a]},spaces.hsla.from=function(hsla){if(null==hsla[0]||null==hsla[1]||null==hsla[2])return[null,null,null,hsla[3]];var h=hsla[0]/360,s=hsla[1],l=hsla[2],a=hsla[3],q=l<=.5?l*(1+s):l+s-l*s,p=2*l-q;return[Math.round(255*hue2rgb(p,q,h+1/3)),Math.round(255*hue2rgb(p,q,h)),Math.round(255*hue2rgb(p,q,h-1/3)),a]},each(spaces,function(spaceName,space){var props=space.props,cache=space.cache,to=space.to,from=space.from;color.fn[spaceName]=function(value){if(to&&!this[cache]&&(this[cache]=to(this._rgba)),void 0===value)return this[cache].slice();var ret,type=jQuery.type(value),arr="array"===type||"object"===type?value:arguments,local=this[cache].slice();return each(props,function(key,prop){var val=arr["object"===type?key:prop.idx];null==val&&(val=local[prop.idx]),local[prop.idx]=clamp(val,prop)}),from?(ret=color(from(local)),ret[cache]=local,ret):color(local)},each(props,function(key,prop){color.fn[key]||(color.fn[key]=function(value){var match,vtype=jQuery.type(value),fn="alpha"===key?this._hsla?"hsla":"rgba":spaceName,local=this[fn](),cur=local[prop.idx];return"undefined"===vtype?cur:("function"===vtype&&(value=value.call(this,cur),vtype=jQuery.type(value)),null==value&&prop.empty?this:("string"===vtype&&(match=rplusequals.exec(value))&&(value=cur+parseFloat(match[2])*("+"===match[1]?1:-1)),local[prop.idx]=value,this[fn](local)))})})}),color.hook=function(hook){var hooks=hook.split(" ");each(hooks,function(i,hook){jQuery.cssHooks[hook]={set:function(elem,value){var parsed,curElem,backgroundColor="";if("transparent"!==value&&("string"!==jQuery.type(value)||(parsed=stringParse(value)))){if(value=color(parsed||value),!support.rgba&&1!==value._rgba[3]){for(curElem="backgroundColor"===hook?elem.parentNode:elem;(""===backgroundColor||"transparent"===backgroundColor)&&curElem&&curElem.style;)try{backgroundColor=jQuery.css(curElem,"backgroundColor"),curElem=curElem.parentNode}catch(e){}value=value.blend(backgroundColor&&"transparent"!==backgroundColor?backgroundColor:"_default")}value=value.toRgbaString()}try{elem.style[hook]=value}catch(e){}}},jQuery.fx.step[hook]=function(fx){fx.colorInit||(fx.start=color(fx.elem,hook),fx.end=color(fx.end),fx.colorInit=!0),jQuery.cssHooks[hook].set(fx.elem,fx.start.transition(fx.end,fx.pos))}})},color.hook("backgroundColor borderBottomColor borderLeftColor borderRightColor borderTopColor color columnRuleColor outlineColor textDecorationColor textEmphasisColor"),jQuery.cssHooks.borderColor={expand:function(value){var expanded={};return each(["Top","Right","Bottom","Left"],function(i,part){expanded["border"+part+"Color"]=value}),expanded}},colors=jQuery.Color.names={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00",transparent:[null,null,null,0],_default:"#ffffff"}}(jQuery),function(){var classAnimationActions=["add","remove","toggle"],shorthandStyles={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};$.each(["borderLeftStyle","borderRightStyle","borderBottomStyle","borderTopStyle"],function(_,prop){$.fx.step[prop]=function(fx){("none"!==fx.end&&!fx.setAttr||1===fx.pos&&!fx.setAttr)&&(jQuery.style(fx.elem,prop,fx.end),fx.setAttr=!0)}});function getElementStyles(elem){var key,len,style=elem.ownerDocument.defaultView?elem.ownerDocument.defaultView.getComputedStyle(elem,null):elem.currentStyle,styles={};if(style&&style.length&&style[0]&&style[style[0]])for(len=style.length;len--;)key=style[len],"string"==typeof style[key]&&(styles[$.camelCase(key)]=style[key]);else for(key in style)"string"==typeof style[key]&&(styles[key]=style[key]);return styles}function styleDifference(oldStyle,newStyle){var name,value,diff={};for(name in newStyle)value=newStyle[name],oldStyle[name]!==value&&(shorthandStyles[name]||!$.fx.step[name]&&isNaN(parseFloat(value))||(diff[name]=value));return diff}$.fn.addBack||($.fn.addBack=function(selector){return this.add(null==selector?this.prevObject:this.prevObject.filter(selector))}),$.effects.animateClass=function(value,duration,easing,callback){var o=$.speed(duration,easing,callback);return this.queue(function(){var applyClassChange,animated=$(this),baseClass=animated.attr("class")||"",allAnimations=o.children?animated.find("*").addBack():animated;allAnimations=allAnimations.map(function(){return{el:$(this),start:getElementStyles(this)}}),applyClassChange=function(){$.each(classAnimationActions,function(i,action){value[action]&&animated[action+"Class"](value[action])})},applyClassChange(),allAnimations=allAnimations.map(function(){return this.end=getElementStyles(this.el[0]),this.diff=styleDifference(this.start,this.end),this}),animated.attr("class",baseClass),allAnimations=allAnimations.map(function(){var styleInfo=this,dfd=$.Deferred(),opts=$.extend({},o,{queue:!1,complete:function(){dfd.resolve(styleInfo)}});return this.el.animate(this.diff,opts),dfd.promise()}),$.when.apply($,allAnimations.get()).done(function(){applyClassChange(),$.each(arguments,function(){var el=this.el;$.each(this.diff,function(key){el.css(key,"")})}),o.complete.call(animated[0])})})},$.fn.extend({addClass:function(orig){return function(classNames,speed,easing,callback){return speed?$.effects.animateClass.call(this,{add:classNames},speed,easing,callback):orig.apply(this,arguments)}}($.fn.addClass),removeClass:function(orig){return function(classNames,speed,easing,callback){return arguments.length>1?$.effects.animateClass.call(this,{remove:classNames},speed,easing,callback):orig.apply(this,arguments)}}($.fn.removeClass),toggleClass:function(orig){return function(classNames,force,speed,easing,callback){return"boolean"==typeof force||void 0===force?speed?$.effects.animateClass.call(this,force?{add:classNames}:{remove:classNames},speed,easing,callback):orig.apply(this,arguments):$.effects.animateClass.call(this,{toggle:classNames},force,speed,easing)}}($.fn.toggleClass),switchClass:function(remove,add,speed,easing,callback){return $.effects.animateClass.call(this,{add:add,remove:remove},speed,easing,callback)}})}(),function(){$.extend($.effects,{version:"1.11.4",save:function(element,set){for(var i=0;i<set.length;i++)null!==set[i]&&element.data("ui-effects-"+set[i],element[0].style[set[i]])},restore:function(element,set){var val,i;for(i=0;i<set.length;i++)null!==set[i]&&(val=element.data("ui-effects-"+set[i]),void 0===val&&(val=""),element.css(set[i],val))},setMode:function(el,mode){return"toggle"===mode&&(mode=el.is(":hidden")?"show":"hide"),mode},getBaseline:function(origin,original){var y,x;switch(origin[0]){case"top":y=0;break;case"middle":y=.5;break;case"bottom":y=1;break;default:y=origin[0]/original.height}switch(origin[1]){case"left":x=0;break;case"center":x=.5;break;case"right":x=1;break;default:x=origin[1]/original.width}return{x:x,y:y}},createWrapper:function(element){if(element.parent().is(".ui-effects-wrapper"))return element.parent();var props={width:element.outerWidth(!0),height:element.outerHeight(!0),float:element.css("float")},wrapper=$("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0}),size={width:element.width(),height:element.height()},active=document.activeElement;try{active.id}catch(e){active=document.body}return element.wrap(wrapper),(element[0]===active||$.contains(element[0],active))&&$(active).focus(),wrapper=element.parent(),"static"===element.css("position")?(wrapper.css({position:"relative"}),element.css({position:"relative"})):($.extend(props,{position:element.css("position"),zIndex:element.css("z-index")}),$.each(["top","left","bottom","right"],function(i,pos){props[pos]=element.css(pos),isNaN(parseInt(props[pos],10))&&(props[pos]="auto")}),element.css({position:"relative",top:0,left:0,right:"auto",bottom:"auto"})),element.css(size),wrapper.css(props).show()},removeWrapper:function(element){var active=document.activeElement;return element.parent().is(".ui-effects-wrapper")&&(element.parent().replaceWith(element),(element[0]===active||$.contains(element[0],active))&&$(active).focus()),element},setTransition:function(element,list,factor,value){return value=value||{},$.each(list,function(i,x){var unit=element.cssUnit(x);unit[0]>0&&(value[x]=unit[0]*factor+unit[1])}),value}});function _normalizeArguments(effect,options,speed,callback){return $.isPlainObject(effect)&&(options=effect,effect=effect.effect),effect={effect:effect},null==options&&(options={}),$.isFunction(options)&&(callback=options,speed=null,options={}),("number"==typeof options||$.fx.speeds[options])&&(callback=speed,speed=options,options={}),$.isFunction(speed)&&(callback=speed,speed=null),options&&$.extend(effect,options),speed=speed||options.duration,effect.duration=$.fx.off?0:"number"==typeof speed?speed:speed in $.fx.speeds?$.fx.speeds[speed]:$.fx.speeds._default,effect.complete=callback||options.complete,effect}function standardAnimationOption(option){return!(option&&"number"!=typeof option&&!$.fx.speeds[option])||("string"==typeof option&&!$.effects.effect[option]||(!!$.isFunction(option)||"object"==typeof option&&!option.effect))}$.fn.extend({effect:function(){var args=_normalizeArguments.apply(this,arguments),mode=args.mode,queue=args.queue,effectMethod=$.effects.effect[args.effect];if($.fx.off||!effectMethod)return mode?this[mode](args.duration,args.complete):this.each(function(){args.complete&&args.complete.call(this)});function run(next){var elem=$(this),complete=args.complete,mode=args.mode;function done(){$.isFunction(complete)&&complete.call(elem[0]),$.isFunction(next)&&next()}(elem.is(":hidden")?"hide"===mode:"show"===mode)?(elem[mode](),done()):effectMethod.call(elem[0],args,done)}return!1===queue?this.each(run):this.queue(queue||"fx",run)},show:function(orig){return function(option){if(standardAnimationOption(option))return orig.apply(this,arguments);var args=_normalizeArguments.apply(this,arguments);return args.mode="show",this.effect.call(this,args)}}($.fn.show),hide:function(orig){return function(option){if(standardAnimationOption(option))return orig.apply(this,arguments)
;var args=_normalizeArguments.apply(this,arguments);return args.mode="hide",this.effect.call(this,args)}}($.fn.hide),toggle:function(orig){return function(option){if(standardAnimationOption(option)||"boolean"==typeof option)return orig.apply(this,arguments);var args=_normalizeArguments.apply(this,arguments);return args.mode="toggle",this.effect.call(this,args)}}($.fn.toggle),cssUnit:function(key){var style=this.css(key),val=[];return $.each(["em","px","%","pt"],function(i,unit){style.indexOf(unit)>0&&(val=[parseFloat(style),unit])}),val}})}(),function(){var baseEasings={};$.each(["Quad","Cubic","Quart","Quint","Expo"],function(i,name){baseEasings[name]=function(p){return Math.pow(p,i+2)}}),$.extend(baseEasings,{Sine:function(p){return 1-Math.cos(p*Math.PI/2)},Circ:function(p){return 1-Math.sqrt(1-p*p)},Elastic:function(p){return 0===p||1===p?p:-Math.pow(2,8*(p-1))*Math.sin((80*(p-1)-7.5)*Math.PI/15)},Back:function(p){return p*p*(3*p-2)},Bounce:function(p){for(var pow2,bounce=4;p<((pow2=Math.pow(2,--bounce))-1)/11;);return 1/Math.pow(4,3-bounce)-7.5625*Math.pow((3*pow2-2)/22-p,2)}}),$.each(baseEasings,function(name,easeIn){$.easing["easeIn"+name]=easeIn,$.easing["easeOut"+name]=function(p){return 1-easeIn(1-p)},$.easing["easeInOut"+name]=function(p){return p<.5?easeIn(2*p)/2:1-easeIn(-2*p+2)/2}})}();$.effects,$.effects.effect.blind=function(o,done){var wrapper,distance,margin,el=$(this),rvertical=/up|down|vertical/,rpositivemotion=/up|left|vertical|horizontal/,props=["position","top","bottom","left","right","height","width"],mode=$.effects.setMode(el,o.mode||"hide"),direction=o.direction||"up",vertical=rvertical.test(direction),ref=vertical?"height":"width",ref2=vertical?"top":"left",motion=rpositivemotion.test(direction),animation={},show="show"===mode;el.parent().is(".ui-effects-wrapper")?$.effects.save(el.parent(),props):$.effects.save(el,props),el.show(),wrapper=$.effects.createWrapper(el).css({overflow:"hidden"}),distance=wrapper[ref](),margin=parseFloat(wrapper.css(ref2))||0,animation[ref]=show?distance:0,motion||(el.css(vertical?"bottom":"right",0).css(vertical?"top":"left","auto").css({position:"absolute"}),animation[ref2]=show?margin:distance+margin),show&&(wrapper.css(ref,0),motion||wrapper.css(ref2,margin+distance)),wrapper.animate(animation,{duration:o.duration,easing:o.easing,queue:!1,complete:function(){"hide"===mode&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}})},$.effects.effect.bounce=function(o,done){var i,upAnim,downAnim,el=$(this),props=["position","top","bottom","left","right","height","width"],mode=$.effects.setMode(el,o.mode||"effect"),hide="hide"===mode,show="show"===mode,direction=o.direction||"up",distance=o.distance,times=o.times||5,anims=2*times+(show||hide?1:0),speed=o.duration/anims,easing=o.easing,ref="up"===direction||"down"===direction?"top":"left",motion="up"===direction||"left"===direction,queue=el.queue(),queuelen=queue.length;for((show||hide)&&props.push("opacity"),$.effects.save(el,props),el.show(),$.effects.createWrapper(el),distance||(distance=el["top"===ref?"outerHeight":"outerWidth"]()/3),show&&(downAnim={opacity:1},downAnim[ref]=0,el.css("opacity",0).css(ref,motion?2*-distance:2*distance).animate(downAnim,speed,easing)),hide&&(distance/=Math.pow(2,times-1)),downAnim={},downAnim[ref]=0,i=0;i<times;i++)upAnim={},upAnim[ref]=(motion?"-=":"+=")+distance,el.animate(upAnim,speed,easing).animate(downAnim,speed,easing),distance=hide?2*distance:distance/2;hide&&(upAnim={opacity:0},upAnim[ref]=(motion?"-=":"+=")+distance,el.animate(upAnim,speed,easing)),el.queue(function(){hide&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}),queuelen>1&&queue.splice.apply(queue,[1,0].concat(queue.splice(queuelen,anims+1))),el.dequeue()},$.effects.effect.clip=function(o,done){var wrapper,animate,distance,el=$(this),props=["position","top","bottom","left","right","height","width"],mode=$.effects.setMode(el,o.mode||"hide"),show="show"===mode,direction=o.direction||"vertical",vert="vertical"===direction,size=vert?"height":"width",position=vert?"top":"left",animation={};$.effects.save(el,props),el.show(),wrapper=$.effects.createWrapper(el).css({overflow:"hidden"}),animate="IMG"===el[0].tagName?wrapper:el,distance=animate[size](),show&&(animate.css(size,0),animate.css(position,distance/2)),animation[size]=show?distance:0,animation[position]=show?0:distance/2,animate.animate(animation,{queue:!1,duration:o.duration,easing:o.easing,complete:function(){show||el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}})},$.effects.effect.drop=function(o,done){var distance,el=$(this),props=["position","top","bottom","left","right","opacity","height","width"],mode=$.effects.setMode(el,o.mode||"hide"),show="show"===mode,direction=o.direction||"left",ref="up"===direction||"down"===direction?"top":"left",motion="up"===direction||"left"===direction?"pos":"neg",animation={opacity:show?1:0};$.effects.save(el,props),el.show(),$.effects.createWrapper(el),distance=o.distance||el["top"===ref?"outerHeight":"outerWidth"](!0)/2,show&&el.css("opacity",0).css(ref,"pos"===motion?-distance:distance),animation[ref]=(show?"pos"===motion?"+=":"-=":"pos"===motion?"-=":"+=")+distance,el.animate(animation,{queue:!1,duration:o.duration,easing:o.easing,complete:function(){"hide"===mode&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}})},$.effects.effect.explode=function(o,done){var i,j,left,top,mx,my,rows=o.pieces?Math.round(Math.sqrt(o.pieces)):3,cells=rows,el=$(this),mode=$.effects.setMode(el,o.mode||"hide"),show="show"===mode,offset=el.show().css("visibility","hidden").offset(),width=Math.ceil(el.outerWidth()/cells),height=Math.ceil(el.outerHeight()/rows),pieces=[];function childComplete(){pieces.push(this),pieces.length===rows*cells&&animComplete()}for(i=0;i<rows;i++)for(top=offset.top+i*height,my=i-(rows-1)/2,j=0;j<cells;j++)left=offset.left+j*width,mx=j-(cells-1)/2,el.clone().appendTo("body").wrap("<div></div>").css({position:"absolute",visibility:"visible",left:-j*width,top:-i*height}).parent().addClass("ui-effects-explode").css({position:"absolute",overflow:"hidden",width:width,height:height,left:left+(show?mx*width:0),top:top+(show?my*height:0),opacity:show?0:1}).animate({left:left+(show?0:mx*width),top:top+(show?0:my*height),opacity:show?1:0},o.duration||500,o.easing,childComplete);function animComplete(){el.css({visibility:"visible"}),$(pieces).remove(),show||el.hide(),done()}},$.effects.effect.fade=function(o,done){var el=$(this),mode=$.effects.setMode(el,o.mode||"toggle");el.animate({opacity:mode},{queue:!1,duration:o.duration,easing:o.easing,complete:done})},$.effects.effect.fold=function(o,done){var wrapper,distance,el=$(this),props=["position","top","bottom","left","right","height","width"],mode=$.effects.setMode(el,o.mode||"hide"),show="show"===mode,hide="hide"===mode,size=o.size||15,percent=/([0-9]+)%/.exec(size),horizFirst=!!o.horizFirst,widthFirst=show!==horizFirst,ref=widthFirst?["width","height"]:["height","width"],duration=o.duration/2,animation1={},animation2={};$.effects.save(el,props),el.show(),wrapper=$.effects.createWrapper(el).css({overflow:"hidden"}),distance=widthFirst?[wrapper.width(),wrapper.height()]:[wrapper.height(),wrapper.width()],percent&&(size=parseInt(percent[1],10)/100*distance[hide?0:1]),show&&wrapper.css(horizFirst?{height:0,width:size}:{height:size,width:0}),animation1[ref[0]]=show?distance[0]:size,animation2[ref[1]]=show?distance[1]:0,wrapper.animate(animation1,duration,o.easing).animate(animation2,duration,o.easing,function(){hide&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()})},$.effects.effect.highlight=function(o,done){var elem=$(this),props=["backgroundImage","backgroundColor","opacity"],mode=$.effects.setMode(elem,o.mode||"show"),animation={backgroundColor:elem.css("backgroundColor")};"hide"===mode&&(animation.opacity=0),$.effects.save(elem,props),elem.show().css({backgroundImage:"none",backgroundColor:o.color||"#ffff99"}).animate(animation,{queue:!1,duration:o.duration,easing:o.easing,complete:function(){"hide"===mode&&elem.hide(),$.effects.restore(elem,props),done()}})},$.effects.effect.size=function(o,done){var original,baseline,factor,el=$(this),props0=["position","top","bottom","left","right","width","height","overflow","opacity"],props1=["position","top","bottom","left","right","overflow","opacity"],props2=["width","height","overflow"],cProps=["fontSize"],vProps=["borderTopWidth","borderBottomWidth","paddingTop","paddingBottom"],hProps=["borderLeftWidth","borderRightWidth","paddingLeft","paddingRight"],mode=$.effects.setMode(el,o.mode||"effect"),restore=o.restore||"effect"!==mode,scale=o.scale||"both",origin=o.origin||["middle","center"],position=el.css("position"),props=restore?props0:props1,zero={height:0,width:0,outerHeight:0,outerWidth:0};"show"===mode&&el.show(),original={height:el.height(),width:el.width(),outerHeight:el.outerHeight(),outerWidth:el.outerWidth()},"toggle"===o.mode&&"show"===mode?(el.from=o.to||zero,el.to=o.from||original):(el.from=o.from||("show"===mode?zero:original),el.to=o.to||("hide"===mode?zero:original)),factor={from:{y:el.from.height/original.height,x:el.from.width/original.width},to:{y:el.to.height/original.height,x:el.to.width/original.width}},"box"!==scale&&"both"!==scale||(factor.from.y!==factor.to.y&&(props=props.concat(vProps),el.from=$.effects.setTransition(el,vProps,factor.from.y,el.from),el.to=$.effects.setTransition(el,vProps,factor.to.y,el.to)),factor.from.x!==factor.to.x&&(props=props.concat(hProps),el.from=$.effects.setTransition(el,hProps,factor.from.x,el.from),el.to=$.effects.setTransition(el,hProps,factor.to.x,el.to))),"content"!==scale&&"both"!==scale||factor.from.y!==factor.to.y&&(props=props.concat(cProps).concat(props2),el.from=$.effects.setTransition(el,cProps,factor.from.y,el.from),el.to=$.effects.setTransition(el,cProps,factor.to.y,el.to)),$.effects.save(el,props),el.show(),$.effects.createWrapper(el),el.css("overflow","hidden").css(el.from),origin&&(baseline=$.effects.getBaseline(origin,original),el.from.top=(original.outerHeight-el.outerHeight())*baseline.y,el.from.left=(original.outerWidth-el.outerWidth())*baseline.x,el.to.top=(original.outerHeight-el.to.outerHeight)*baseline.y,el.to.left=(original.outerWidth-el.to.outerWidth)*baseline.x),el.css(el.from),"content"!==scale&&"both"!==scale||(vProps=vProps.concat(["marginTop","marginBottom"]).concat(cProps),hProps=hProps.concat(["marginLeft","marginRight"]),props2=props0.concat(vProps).concat(hProps),el.find("*[width]").each(function(){var child=$(this),c_original={height:child.height(),width:child.width(),outerHeight:child.outerHeight(),outerWidth:child.outerWidth()};restore&&$.effects.save(child,props2),child.from={height:c_original.height*factor.from.y,width:c_original.width*factor.from.x,outerHeight:c_original.outerHeight*factor.from.y,outerWidth:c_original.outerWidth*factor.from.x},child.to={height:c_original.height*factor.to.y,width:c_original.width*factor.to.x,outerHeight:c_original.height*factor.to.y,outerWidth:c_original.width*factor.to.x},factor.from.y!==factor.to.y&&(child.from=$.effects.setTransition(child,vProps,factor.from.y,child.from),child.to=$.effects.setTransition(child,vProps,factor.to.y,child.to)),factor.from.x!==factor.to.x&&(child.from=$.effects.setTransition(child,hProps,factor.from.x,child.from),child.to=$.effects.setTransition(child,hProps,factor.to.x,child.to)),child.css(child.from),child.animate(child.to,o.duration,o.easing,function(){restore&&$.effects.restore(child,props2)})})),el.animate(el.to,{queue:!1,duration:o.duration,easing:o.easing,complete:function(){0===el.to.opacity&&el.css("opacity",el.from.opacity),"hide"===mode&&el.hide(),$.effects.restore(el,props),restore||("static"===position?el.css({position:"relative",top:el.to.top,left:el.to.left}):$.each(["top","left"],function(idx,pos){el.css(pos,function(_,str){var val=parseInt(str,10),toRef=idx?el.to.left:el.to.top;return"auto"===str?toRef+"px":val+toRef+"px"})})),$.effects.removeWrapper(el),done()}})},$.effects.effect.scale=function(o,done){var el=$(this),options=$.extend(!0,{},o),mode=$.effects.setMode(el,o.mode||"effect"),percent=parseInt(o.percent,10)||(0===parseInt(o.percent,10)?0:"hide"===mode?0:100),direction=o.direction||"both",origin=o.origin,original={height:el.height(),width:el.width(),outerHeight:el.outerHeight(),outerWidth:el.outerWidth()},factor={y:"horizontal"!==direction?percent/100:1,x:"vertical"!==direction?percent/100:1};options.effect="size",options.queue=!1,options.complete=done,"effect"!==mode&&(options.origin=origin||["middle","center"],options.restore=!0),options.from=o.from||("show"===mode?{height:0,width:0,outerHeight:0,outerWidth:0}:original),options.to={height:original.height*factor.y,width:original.width*factor.x,outerHeight:original.outerHeight*factor.y,outerWidth:original.outerWidth*factor.x},options.fade&&("show"===mode&&(options.from.opacity=0,options.to.opacity=1),"hide"===mode&&(options.from.opacity=1,options.to.opacity=0)),el.effect(options)},$.effects.effect.puff=function(o,done){var elem=$(this),mode=$.effects.setMode(elem,o.mode||"hide"),hide="hide"===mode,percent=parseInt(o.percent,10)||150,factor=percent/100,original={height:elem.height(),width:elem.width(),outerHeight:elem.outerHeight(),outerWidth:elem.outerWidth()};$.extend(o,{effect:"scale",queue:!1,fade:!0,mode:mode,complete:done,percent:hide?percent:100,from:hide?original:{height:original.height*factor,width:original.width*factor,outerHeight:original.outerHeight*factor,outerWidth:original.outerWidth*factor}}),elem.effect(o)},$.effects.effect.pulsate=function(o,done){var i,elem=$(this),mode=$.effects.setMode(elem,o.mode||"show"),show="show"===mode,hide="hide"===mode,showhide=show||"hide"===mode,anims=2*(o.times||5)+(showhide?1:0),duration=o.duration/anims,animateTo=0,queue=elem.queue(),queuelen=queue.length;for(!show&&elem.is(":visible")||(elem.css("opacity",0).show(),animateTo=1),i=1;i<anims;i++)elem.animate({opacity:animateTo},duration,o.easing),animateTo=1-animateTo;elem.animate({opacity:animateTo},duration,o.easing),elem.queue(function(){hide&&elem.hide(),done()}),queuelen>1&&queue.splice.apply(queue,[1,0].concat(queue.splice(queuelen,anims+1))),elem.dequeue()},$.effects.effect.shake=function(o,done){var i,el=$(this),props=["position","top","bottom","left","right","height","width"],mode=$.effects.setMode(el,o.mode||"effect"),direction=o.direction||"left",distance=o.distance||20,times=o.times||3,anims=2*times+1,speed=Math.round(o.duration/anims),ref="up"===direction||"down"===direction?"top":"left",positiveMotion="up"===direction||"left"===direction,animation={},animation1={},animation2={},queue=el.queue(),queuelen=queue.length;for($.effects.save(el,props),el.show(),$.effects.createWrapper(el),animation[ref]=(positiveMotion?"-=":"+=")+distance,animation1[ref]=(positiveMotion?"+=":"-=")+2*distance,animation2[ref]=(positiveMotion?"-=":"+=")+2*distance,el.animate(animation,speed,o.easing),i=1;i<times;i++)el.animate(animation1,speed,o.easing).animate(animation2,speed,o.easing);el.animate(animation1,speed,o.easing).animate(animation,speed/2,o.easing).queue(function(){"hide"===mode&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}),queuelen>1&&queue.splice.apply(queue,[1,0].concat(queue.splice(queuelen,anims+1))),el.dequeue()},$.effects.effect.slide=function(o,done){var distance,el=$(this),props=["position","top","bottom","left","right","width","height"],mode=$.effects.setMode(el,o.mode||"show"),show="show"===mode,direction=o.direction||"left",ref="up"===direction||"down"===direction?"top":"left",positiveMotion="up"===direction||"left"===direction,animation={};$.effects.save(el,props),el.show(),distance=o.distance||el["top"===ref?"outerHeight":"outerWidth"](!0),$.effects.createWrapper(el).css({overflow:"hidden"}),show&&el.css(ref,positiveMotion?isNaN(distance)?"-"+distance:-distance:distance),animation[ref]=(show?positiveMotion?"+=":"-=":positiveMotion?"-=":"+=")+distance,el.animate(animation,{queue:!1,duration:o.duration,easing:o.easing,complete:function(){"hide"===mode&&el.hide(),$.effects.restore(el,props),$.effects.removeWrapper(el),done()}})},$.effects.effect.transfer=function(o,done){var elem=$(this),target=$(o.to),targetFixed="fixed"===target.css("position"),body=$("body"),fixTop=targetFixed?body.scrollTop():0,fixLeft=targetFixed?body.scrollLeft():0,endPosition=target.offset(),animation={top:endPosition.top-fixTop,left:endPosition.left-fixLeft,height:target.innerHeight(),width:target.innerWidth()},startPosition=elem.offset(),transfer=$("<div class='ui-effects-transfer'></div>").appendTo(document.body).addClass(o.className).css({top:startPosition.top-fixTop,left:startPosition.left-fixLeft,height:elem.innerHeight(),width:elem.innerWidth(),position:targetFixed?"fixed":"absolute"}).animate(animation,o.duration,o.easing,function(){transfer.remove(),done()})}}),function($){$.support.touch="ontouchend"in document||navigator.maxTouchPoints>0;function simulateMouseEvent(event,simulatedType){if(!(event.originalEvent.touches.length>1)){event.preventDefault();var touch=event.originalEvent.changedTouches[0],simulatedEvent=document.createEvent("MouseEvents");simulatedEvent.initMouseEvent(simulatedType,!0,!0,window,1,touch.screenX,touch.screenY,touch.clientX,touch.clientY,!1,!1,!1,!1,0,null),event.target.dispatchEvent(simulatedEvent)}}if($.support.touch){var touchHandled,mouseProto=$.ui.mouse.prototype,_mouseInit=mouseProto._mouseInit,_mouseDestroy=mouseProto._mouseDestroy;mouseProto._touchStart=function(event){var self=this;!touchHandled&&self._mouseCapture(event.originalEvent.changedTouches[0])&&(touchHandled=!0,self._touchMoved=!1,this._startedMove=event.timeStamp,simulateMouseEvent(event,"mouseover"),simulateMouseEvent(event,"mousemove"),simulateMouseEvent(event,"mousedown"))},mouseProto._touchMove=function(event){touchHandled&&(this._touchMoved=!0,simulateMouseEvent(event,"mousemove"))},mouseProto._touchEnd=function(event){if(touchHandled){simulateMouseEvent(event,"mouseup"),simulateMouseEvent(event,"mouseout");var timeMoving=event.timeStamp-this._startedMove;(!this._touchMoved||timeMoving<500)&&simulateMouseEvent(event,"click"),touchHandled=!1}},mouseProto._mouseInit=function(){var self=this;self.element.bind({touchstart:$.proxy(self,"_touchStart"),touchmove:$.proxy(self,"_touchMove"),touchend:$.proxy(self,"_touchEnd")}),_mouseInit.call(self)},mouseProto._mouseDestroy=function(){var self=this;self.element.unbind({touchstart:$.proxy(self,"_touchStart"),touchmove:$.proxy(self,"_touchMove"),touchend:$.proxy(self,"_touchEnd")}),_mouseDestroy.call(self)}}}(jQuery),window.Modernizr=function(a,b,c){function z(a){j.cssText=a}function B(a,b){return typeof a===b}function C(a,b){return!!~(""+a).indexOf(b)}function D(a,b){for(var d in a){var e=a[d];if(!C(e,"-")&&j[e]!==c)return"pfx"!=b||e}return!1}function E(a,b,d){for(var e in a){var f=b[a[e]];if(f!==c)return!1===d?a[e]:B(f,"function")?f.bind(d||b):f}return!1}function F(a,b,c){var d=a.charAt(0).toUpperCase()+a.slice(1),e=(a+" "+o.join(d+" ")+d).split(" ");return B(b,"string")||B(b,"undefined")?D(e,b):(e=(a+" "+p.join(d+" ")+d).split(" "),E(e,b,c))}var v,y,e={},g=b.documentElement,h="modernizr",i=b.createElement(h),j=i.style,m=" -webkit- -moz- -o- -ms- ".split(" "),n="Webkit Moz O ms",o=n.split(" "),p=n.toLowerCase().split(" "),q={},t=[],u=t.slice,w=function(a,c,d,e){var f,i,j,k,l=b.createElement("div"),m=b.body,n=m||b.createElement("body");if(parseInt(d,10))for(;d--;)j=b.createElement("div"),j.id=e?e[d]:h+(d+1),l.appendChild(j);return f=["&#173;",'<style id="s',h,'">',a,"</style>"].join(""),l.id=h,(m?l:n).innerHTML+=f,n.appendChild(l),m||(n.style.background="",n.style.overflow="hidden",k=g.style.overflow,g.style.overflow="hidden",g.appendChild(n)),i=c(l,a),m?l.parentNode.removeChild(l):(n.parentNode.removeChild(n),g.style.overflow=k),!!i},x={}.hasOwnProperty;y=B(x,"undefined")||B(x.call,"undefined")?function(a,b){return b in a&&B(a.constructor.prototype[b],"undefined")}:function(a,b){return x.call(a,b)},Function.prototype.bind||(Function.prototype.bind=function(b){var c=this;if("function"!=typeof c)throw new TypeError;var d=u.call(arguments,1),e=function(){if(this instanceof e){var a=function(){};a.prototype=c.prototype;var f=new a,g=c.apply(f,d.concat(u.call(arguments)));return Object(g)===g?g:f}return c.apply(b,d.concat(u.call(arguments)))};return e}),q.csstransforms3d=function(){var a=!!F("perspective");return a&&"webkitPerspective"in g.style&&w("@media (transform-3d),(-webkit-transform-3d){#modernizr{left:9px;position:absolute;height:3px;}}",function(b,c){a=9===b.offsetLeft&&3===b.offsetHeight}),a},q.csstransitions=function(){return F("transition")};for(var G in q)y(q,G)&&(v=G.toLowerCase(),e[v]=q[G](),t.push((e[v]?"":"no-")+v));return e.addTest=function(a,b){if("object"==typeof a)for(var d in a)y(a,d)&&e.addTest(d,a[d]);else{if(a=a.toLowerCase(),e[a]!==c)return e;b="function"==typeof b?b():b,g.className+=" "+(b?"":"no-")+a,e[a]=b}return e},z(""),i=null,function(a,b){function k(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"</style>",d.insertBefore(c.lastChild,d.firstChild)}function l(){var a=r.elements;return"string"==typeof a?a.split(" "):a}function m(a){var b=i[a[g]];return b||(b={},h++,a[g]=h,i[h]=b),b}function n(a,c,f){if(c||(c=b),j)return c.createElement(a);f||(f=m(c));var g;return g=f.cache[a]?f.cache[a].cloneNode():e.test(a)?(f.cache[a]=f.createElem(a)).cloneNode():f.createElem(a),g.canHaveChildren&&!d.test(a)?f.frag.appendChild(g):g}function o(a,c){if(a||(a=b),j)return a.createDocumentFragment();c=c||m(a);for(var d=c.frag.cloneNode(),e=0,f=l(),g=f.length;e<g;e++)d.createElement(f[e]);return d}function p(a,b){b.cache||(b.cache={},b.createElem=a.createElement,b.createFrag=a.createDocumentFragment,b.frag=b.createFrag()),a.createElement=function(c){return r.shivMethods?n(c,a,b):b.createElem(c)},a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+l().join().replace(/\w+/g,function(a){return b.createElem(a),b.frag.createElement(a),'c("'+a+'")'})+");return n}")(r,b.frag)}function q(a){a||(a=b);var c=m(a);return r.shivCSS&&!f&&!c.hasCSS&&(c.hasCSS=!!k(a,"article,aside,figcaption,figure,footer,header,hgroup,nav,section{display:block}mark{background:#FF0;color:#000}")),j||p(a,c),a}var f,j,c=a.html5||{},d=/^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i,e=/^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i,g="_html5shiv",h=0,i={};!function(){try{var a=b.createElement("a");a.innerHTML="<xyz></xyz>",f="hidden"in a,j=1==a.childNodes.length||function(){b.createElement("a");var a=b.createDocumentFragment();return void 0===a.cloneNode||void 0===a.createDocumentFragment||void 0===a.createElement}()}catch(c){f=!0,j=!0}}();var r={elements:c.elements||"abbr article aside audio bdi canvas data datalist details figcaption figure footer header hgroup mark meter nav output progress section summary time video",shivCSS:!1!==c.shivCSS,supportsUnknownElements:j,shivMethods:!1!==c.shivMethods,type:"default",shivDocument:q,createElement:n,createDocumentFragment:o};a.html5=r,q(b)}(this,b),e._version="2.6.2",e._prefixes=m,e._domPrefixes=p,e._cssomPrefixes=o,e.testProp=function(a){return D([a])},e.testAllProps=F,e.testStyles=w,e.prefixed=function(a,b,c){return b?F(a,b,c):F(a,"pfx")},g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+" js "+t.join(" "),e}(0,this.document),function(a,b,c){function d(a){return"[object Function]"==o.call(a)}function e(a){return"string"==typeof a}function f(){}function g(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function h(){var a=p.shift();q=1,a?a.t?m(function(){("c"==a.t?B.injectCss:B.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):q=0}function i(a,c,d,e,f,i,j){function k(b){if(!o&&g(l.readyState)&&(u.r=o=1,!q&&h(),l.onload=l.onreadystatechange=null,b)){"img"!=a&&m(function(){t.removeChild(l)},50);for(var d in y[c])y[c].hasOwnProperty(d)&&y[c][d].onload()}}var j=j||B.errorTimeout,l=b.createElement(a),o=0,r=0,u={t:d,s:c,e:f,a:i,x:j};1===y[c]&&(r=1,y[c]=[]),"object"==a?l.data=c:(l.src=c,l.type=a),l.width=l.height="0",l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,r)},p.splice(e,0,u),"img"!=a&&(r||2===y[c]?(t.insertBefore(l,s?null:n),m(k,j)):y[c].push(l))}function j(a,b,c,d,f){return q=0,b=b||"j",e(a)?i("c"==b?v:u,a,b,this.i++,c,d,f):(p.splice(this.i++,0,a),1==p.length&&h()),this}function k(){var a=B;return a.loader={load:j,i:0},a}var A,B,l=b.documentElement,m=a.setTimeout,n=b.getElementsByTagName("script")[0],o={}.toString,p=[],q=0,r="MozAppearance"in l.style,s=r&&!!b.createRange().compareNode,t=s?l:n.parentNode,l=a.opera&&"[object Opera]"==o.call(a.opera),l=!!b.attachEvent&&!l,u=r?"object":l?"script":"img",v=l?"script":u,w=Array.isArray||function(a){return"[object Array]"==o.call(a)},x=[],y={},z={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}};B=function(a){function b(a){var e,f,g,a=a.split("!"),b=x.length,c=a.pop(),d=a.length,c={url:c,origUrl:c,prefixes:a};for(f=0;f<d;f++)g=a[f].split("="),(e=z[g.shift()])&&(c=e(c,g));for(f=0;f<b;f++)c=x[f](c);return c}function g(a,e,f,g,h){var i=b(a),j=i.autoCallback;i.url.split(".").pop().split("?").shift(),i.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]),i.instead?i.instead(a,e,f,g,h):(y[i.url]?i.noexec=!0:y[i.url]=1,f.load(i.url,i.forceCSS||!i.forceJS&&"css"==i.url.split(".").pop().split("?").shift()?"c":c,i.noexec,i.attrs,i.timeout),(d(e)||d(j))&&f.load(function(){k(),e&&e(i.origUrl,h,g),j&&j(i.origUrl,h,g),y[i.url]=2})))}function h(a,b){function c(a,c){if(a){if(e(a))c||(j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}),g(a,j,b,0,h);else if(Object(a)===a)for(n in m=function(){var c,b=0;for(c in a)a.hasOwnProperty(c)&&b++;return b}(),a)a.hasOwnProperty(n)&&(!c&&!--m&&(d(j)?j=function(){var a=[].slice.call(arguments);k.apply(this,a),l()}:j[n]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b),l()}}(k[n])),g(a[n],j,b,n,h))}else!c&&l()}var m,n,h=!!a.test,i=a.load||a.both,j=a.callback||f,k=j,l=a.complete||f;c(h?a.yep:a.nope,!!i),i&&c(i)}var i,j,l=this.yepnope.loader;if(e(a))g(a,0,l,0);else if(w(a))for(i=0;i<a.length;i++)j=a[i],e(j)?g(j,0,l,0):w(j)?B(j):Object(j)===j&&h(j,l);else Object(a)===a&&h(a,l)},B.addPrefix=function(a,b){z[a]=b},B.addFilter=function(a){x.push(a)},B.errorTimeout=1e4,null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",A=function(){b.removeEventListener("DOMContentLoaded",A,0),b.readyState="complete"},0)),a.yepnope=k(),a.yepnope.executeStack=h,a.yepnope.injectJs=function(a,c,d,e,i,j){var l,o,k=b.createElement("script"),e=e||B.errorTimeout;k.src=a;for(o in d)k.setAttribute(o,d[o]);c=j?h:c||f,k.onreadystatechange=k.onload=function(){!l&&g(k.readyState)&&(l=1,c(),k.onload=k.onreadystatechange=null)},m(function(){l||(l=1,c(1))},e),i?k.onload():n.parentNode.insertBefore(k,n)},a.yepnope.injectCss=function(a,c,d,e,g,i){var j,e=b.createElement("link"),c=i?h:c||f;e.href=a,e.rel="stylesheet",e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(n.parentNode.insertBefore(e,n),m(c,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))},function($,window,undefined){"use strict";var $window=$(window),Modernizr=window.Modernizr;Modernizr.addTest("csstransformspreserve3d",function(){var computedStyle,prop=Modernizr.prefixed("transformStyle"),val="preserve-3d";return!!prop&&(prop=prop.replace(/([A-Z])/g,function(str,m1){return"-"+m1.toLowerCase()}).replace(/^ms-/,"-ms-"),Modernizr.testStyles("#modernizr{"+prop+":"+val+";}",function(el,rule){computedStyle=window.getComputedStyle?getComputedStyle(el,null).getPropertyValue(prop):""}),computedStyle===val)});var $special,resizeTimeout,$event=$.event;$special=$event.special.debouncedresize={setup:function(){$(this).on("resize",$special.handler)},teardown:function(){$(this).off("resize",$special.handler)},handler:function(event,execAsap){var context=this,args=arguments,dispatch=function(){event.type="debouncedresize",$event.dispatch.apply(context,args)};resizeTimeout&&clearTimeout(resizeTimeout),execAsap?dispatch():resizeTimeout=setTimeout(dispatch,$special.threshold)},threshold:150},$.BookBlock=function(options,element){this.$el=$(element),this._init(options)},$.BookBlock.defaults={startPage:1,orientation:"vertical",direction:"ltr",speed:1e3,easing:"ease-in-out",shadows:!0,shadowSides:.2,shadowFlip:.1,circular:!1,nextEl:"",prevEl:"",autoplay:!1,interval:3e3,onEndFlip:function(old,page,isLimit){return!1},onBeforeFlip:function(page){return!1}},$.BookBlock.prototype={_init:function(options){this.options=$.extend(!0,{},$.BookBlock.defaults,options),this.$el.addClass("bb-"+this.options.orientation),this.$items=this.$el.children(".bb-item").hide(),this.itemsCount=this.$items.length,this.options.startPage>0&&this.options.startPage<=this.itemsCount?this.current=this.options.startPage-1:(logError("startPage option is out of range"),this.current=0),this.previous=-1,this.$current=this.$items.eq(this.current).show(),this.elWidth=this.$el.width();var transEndEventNames={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"};this.transEndEventName=transEndEventNames[Modernizr.prefixed("transition")]+".bookblock",this.support=Modernizr.csstransitions&&Modernizr.csstransforms3d&&Modernizr.csstransformspreserve3d,this._initEvents(),this.options.autoplay&&(this.options.circular=!0,this._startSlideshow())},_initEvents:function(){var self=this;""!==this.options.nextEl&&$(this.options.nextEl).on("click.bookblock touchstart.bookblock",function(){return self._action("next"),!1}),""!==this.options.prevEl&&$(this.options.prevEl).on("click.bookblock touchstart.bookblock",function(){return self._action("prev"),!1}),$window.on("debouncedresize",function(){self.elWidth=self.$el.width()})},_action:function(dir,page){this._stopSlideshow(),this._navigate(dir,page)},_navigate:function(dir,page){return!this.isAnimating&&(!this.options.onBeforeFlip(this.current,dir)&&(this.isAnimating=!0,this.$current=this.$items.eq(this.current),void 0!==page?this.current=page:"next"===dir&&"ltr"===this.options.direction||"prev"===dir&&"rtl"===this.options.direction?this.options.circular||this.current!==this.itemsCount-1?(this.previous=this.current,this.current=this.current<this.itemsCount-1?this.current+1:0):this.end=!0:("prev"===dir&&"ltr"===this.options.direction||"next"===dir&&"rtl"===this.options.direction)&&(this.options.circular||0!==this.current?(this.previous=this.current,this.current=this.current>0?this.current-1:this.itemsCount-1):this.end=!0),this.$nextItem=!this.options.circular&&this.end?this.$current:this.$items.eq(this.current),void(this.support?this._layout(dir):this._layoutNoSupport(dir))))},_layoutNoSupport:function(dir){this.$items.hide(),this.$nextItem.show(),this.end=!1,this.isAnimating=!1;var isLimit="next"===dir&&this.current===this.itemsCount-1||"prev"===dir&&0===this.current;this.options.onEndFlip(this.previous,this.current,isLimit)},_layout:function(dir){var self=this,$s_left=this._addSide("left",dir),$s_middle=this._addSide("middle",dir),$s_right=this._addSide("right",dir),$o_left=$s_left.find("div.bb-overlay"),$o_middle_f=$s_middle.find("div.bb-flipoverlay:first"),$o_middle_b=$s_middle.find("div.bb-flipoverlay:last"),$o_right=$s_right.find("div.bb-overlay"),speed=this.end?400:this.options.speed;if(this.$items.hide(),this.$el.prepend($s_left,$s_middle,$s_right),$s_middle.css({transitionDuration:speed+"ms",transitionTimingFunction:this.options.easing}).on(this.transEndEventName,function(event){if($(event.target).hasClass("bb-page")){self.$el.children(".bb-page").remove(),self.$nextItem.show(),
self.end=!1,self.isAnimating=!1;var isLimit="next"===dir&&self.current===self.itemsCount-1||"prev"===dir&&0===self.current;$s_middle.is(".bb-flip-next-end, .bb-flip-previous-end")||self.options.onEndFlip(self.previous,self.current,isLimit)}}),"prev"===dir&&$s_middle.addClass("bb-flip-initial"),this.options.shadows&&!this.end){var o_left_style="next"===dir?{transition:"opacity "+this.options.speed/2+"ms linear "+this.options.speed/2+"ms"}:{transition:"opacity "+this.options.speed/2+"ms linear",opacity:this.options.shadowSides},o_middle_f_style="next"===dir?{transition:"opacity "+this.options.speed/2+"ms linear"}:{transition:"opacity "+this.options.speed/2+"ms linear "+this.options.speed/2+"ms",opacity:this.options.shadowFlip},o_middle_b_style="next"===dir?{transition:"opacity "+this.options.speed/2+"ms linear "+this.options.speed/2+"ms",opacity:this.options.shadowFlip}:{transition:"opacity "+this.options.speed/2+"ms linear"},o_right_style="next"===dir?{transition:"opacity "+this.options.speed/2+"ms linear",opacity:this.options.shadowSides}:{transition:"opacity "+this.options.speed/2+"ms linear "+this.options.speed/2+"ms"};$o_middle_f.css(o_middle_f_style),$o_middle_b.css(o_middle_b_style),$o_left.css(o_left_style),$o_right.css(o_right_style)}setTimeout(function(){$s_middle.addClass(self.end?"bb-flip-"+dir+"-end":"bb-flip-"+dir),self.options.shadows&&!self.end&&($o_middle_f.css({opacity:"next"===dir?self.options.shadowFlip:0}),$o_middle_b.css({opacity:"next"===dir?0:self.options.shadowFlip}),$o_left.css({opacity:"next"===dir?self.options.shadowSides:0}),$o_right.css({opacity:"next"===dir?0:self.options.shadowSides}))},25)},_addSide:function(side,dir){var $side;switch(side){case"left":$side=$('<div class="bb-page"><div class="bb-back"><div class="bb-outer"><div class="bb-content"><div class="bb-inner">'+("next"===dir?this.$current.html():this.$nextItem.html())+'</div></div><div class="bb-overlay"></div></div></div></div>').css("z-index",102);break;case"middle":$side=$('<div class="bb-page"><div class="bb-front"><div class="bb-outer"><div class="bb-content"><div class="bb-inner">'+("next"===dir?this.$current.html():this.$nextItem.html())+'</div></div><div class="bb-flipoverlay"></div></div></div><div class="bb-back"><div class="bb-outer"><div class="bb-content" style="width:'+this.elWidth+'px"><div class="bb-inner">'+("next"===dir?this.$nextItem.html():this.$current.html())+'</div></div><div class="bb-flipoverlay"></div></div></div></div>').css("z-index",103);break;case"right":$side=$('<div class="bb-page"><div class="bb-front"><div class="bb-outer"><div class="bb-content"><div class="bb-inner">'+("next"===dir?this.$nextItem.html():this.$current.html())+'</div></div><div class="bb-overlay"></div></div></div></div>').css("z-index",101)}return $side},_startSlideshow:function(){var self=this;this.slideshow=setTimeout(function(){self._navigate("next"),self.options.autoplay&&self._startSlideshow()},this.options.interval)},_stopSlideshow:function(){this.options.autoplay&&(clearTimeout(this.slideshow),this.options.autoplay=!1)},next:function(){this._action("ltr"===this.options.direction?"next":"prev")},prev:function(){this._action("ltr"===this.options.direction?"prev":"next")},jump:function(page){if((page-=1)===this.current||page>=this.itemsCount||page<0)return!1;var dir;dir="ltr"===this.options.direction?page>this.current?"next":"prev":page>this.current?"prev":"next",this._action(dir,page)},last:function(){this.jump(this.itemsCount)},first:function(){this.jump(1)},isActive:function(){return this.isAnimating},update:function(){var $currentItem=this.$items.eq(this.current);this.$items=this.$el.children(".bb-item"),this.itemsCount=this.$items.length,this.current=$currentItem.index()},destroy:function(){this.options.autoplay&&this._stopSlideshow(),this.$el.removeClass("bb-"+this.options.orientation),this.$items.show(),""!==this.options.nextEl&&$(this.options.nextEl).off(".bookblock"),""!==this.options.prevEl&&$(this.options.prevEl).off(".bookblock"),$window.off("debouncedresize")}};var logError=function(message){window.console&&window.console.error(message)};$.fn.bookblock=function(options){if("string"==typeof options){var args=Array.prototype.slice.call(arguments,1);this.each(function(){var instance=$.data(this,"bookblock");return instance?$.isFunction(instance[options])&&"_"!==options.charAt(0)?void instance[options].apply(instance,args):void logError("no such method '"+options+"' for bookblock instance"):void logError("cannot call methods on bookblock prior to initialization; attempted to call method '"+options+"'")})}else this.each(function(){var instance=$.data(this,"bookblock");instance?instance._init(options):instance=$.data(this,"bookblock",new $.BookBlock(options,this))});return this}}(jQuery,window),function(root,factory){"object"==typeof exports&&"object"==typeof module?module.exports=factory():"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?exports.Handlebars=factory():root.Handlebars=factory()}(this,function(){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={exports:{},id:moduleId,loaded:!1};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.loaded=!0,module.exports}return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.p="",__webpack_require__(0)}([function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _handlebarsRuntime=__webpack_require__(2),_handlebarsRuntime2=_interopRequireDefault(_handlebarsRuntime),_handlebarsCompilerAst=__webpack_require__(21),_handlebarsCompilerAst2=_interopRequireDefault(_handlebarsCompilerAst),_handlebarsCompilerBase=__webpack_require__(22),_handlebarsCompilerCompiler=__webpack_require__(27),_handlebarsCompilerJavascriptCompiler=__webpack_require__(28),_handlebarsCompilerJavascriptCompiler2=_interopRequireDefault(_handlebarsCompilerJavascriptCompiler),_handlebarsCompilerVisitor=__webpack_require__(25),_handlebarsCompilerVisitor2=_interopRequireDefault(_handlebarsCompilerVisitor),_handlebarsNoConflict=__webpack_require__(20),_handlebarsNoConflict2=_interopRequireDefault(_handlebarsNoConflict),_create=_handlebarsRuntime2.default.create;function create(){var hb=_create();return hb.compile=function(input,options){return _handlebarsCompilerCompiler.compile(input,options,hb)},hb.precompile=function(input,options){return _handlebarsCompilerCompiler.precompile(input,options,hb)},hb.AST=_handlebarsCompilerAst2.default,hb.Compiler=_handlebarsCompilerCompiler.Compiler,hb.JavaScriptCompiler=_handlebarsCompilerJavascriptCompiler2.default,hb.Parser=_handlebarsCompilerBase.parser,hb.parse=_handlebarsCompilerBase.parse,hb}var inst=create();inst.create=create,_handlebarsNoConflict2.default(inst),inst.Visitor=_handlebarsCompilerVisitor2.default,inst.default=inst,exports.default=inst,module.exports=exports.default},function(module,exports){"use strict";exports.default=function(obj){return obj&&obj.__esModule?obj:{default:obj}},exports.__esModule=!0},function(module,exports,__webpack_require__){"use strict";var _interopRequireWildcard=__webpack_require__(3).default,_interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _handlebarsBase=__webpack_require__(4),base=_interopRequireWildcard(_handlebarsBase),_handlebarsSafeString=__webpack_require__(18),_handlebarsSafeString2=_interopRequireDefault(_handlebarsSafeString),_handlebarsException=__webpack_require__(6),_handlebarsException2=_interopRequireDefault(_handlebarsException),_handlebarsUtils=__webpack_require__(5),Utils=_interopRequireWildcard(_handlebarsUtils),_handlebarsRuntime=__webpack_require__(19),runtime=_interopRequireWildcard(_handlebarsRuntime),_handlebarsNoConflict=__webpack_require__(20),_handlebarsNoConflict2=_interopRequireDefault(_handlebarsNoConflict);function create(){var hb=new base.HandlebarsEnvironment;return Utils.extend(hb,base),hb.SafeString=_handlebarsSafeString2.default,hb.Exception=_handlebarsException2.default,hb.Utils=Utils,hb.escapeExpression=Utils.escapeExpression,hb.VM=runtime,hb.template=function(spec){return runtime.template(spec,hb)},hb}var inst=create();inst.create=create,_handlebarsNoConflict2.default(inst),inst.default=inst,exports.default=inst,module.exports=exports.default},function(module,exports){"use strict";exports.default=function(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj},exports.__esModule=!0},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.HandlebarsEnvironment=HandlebarsEnvironment;var _utils=__webpack_require__(5),_exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception),_helpers=__webpack_require__(7),_decorators=__webpack_require__(15),_logger=__webpack_require__(17),_logger2=_interopRequireDefault(_logger);exports.VERSION="4.0.5";exports.COMPILER_REVISION=7;var REVISION_CHANGES={1:"<= 1.0.rc.2",2:"== 1.0.0-rc.3",3:"== 1.0.0-rc.4",4:"== 1.x.x",5:"== 2.0.0-alpha.x",6:">= 2.0.0-beta.1",7:">= 4.0.0"};exports.REVISION_CHANGES=REVISION_CHANGES;function HandlebarsEnvironment(helpers,partials,decorators){this.helpers=helpers||{},this.partials=partials||{},this.decorators=decorators||{},_helpers.registerDefaultHelpers(this),_decorators.registerDefaultDecorators(this)}HandlebarsEnvironment.prototype={constructor:HandlebarsEnvironment,logger:_logger2.default,log:_logger2.default.log,registerHelper:function(name,fn){if("[object Object]"===_utils.toString.call(name)){if(fn)throw new _exception2.default("Arg not supported with multiple helpers");_utils.extend(this.helpers,name)}else this.helpers[name]=fn},unregisterHelper:function(name){delete this.helpers[name]},registerPartial:function(name,partial){if("[object Object]"===_utils.toString.call(name))_utils.extend(this.partials,name);else{if(void 0===partial)throw new _exception2.default('Attempting to register a partial called "'+name+'" as undefined');this.partials[name]=partial}},unregisterPartial:function(name){delete this.partials[name]},registerDecorator:function(name,fn){if("[object Object]"===_utils.toString.call(name)){if(fn)throw new _exception2.default("Arg not supported with multiple decorators");_utils.extend(this.decorators,name)}else this.decorators[name]=fn},unregisterDecorator:function(name){delete this.decorators[name]}};var log=_logger2.default.log;exports.log=log,exports.createFrame=_utils.createFrame,exports.logger=_logger2.default},function(module,exports){"use strict";exports.__esModule=!0,exports.extend=extend,exports.indexOf=indexOf,exports.escapeExpression=escapeExpression,exports.isEmpty=isEmpty,exports.createFrame=createFrame,exports.blockParams=blockParams,exports.appendContextPath=appendContextPath;var escape={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;","=":"&#x3D;"},badChars=/[&<>"'`=]/g,possible=/[&<>"'`=]/;function escapeChar(chr){return escape[chr]}function extend(obj){for(var i=1;i<arguments.length;i++)for(var key in arguments[i])Object.prototype.hasOwnProperty.call(arguments[i],key)&&(obj[key]=arguments[i][key]);return obj}var toString=Object.prototype.toString;exports.toString=toString;var isFunction=function(value){return"function"==typeof value};isFunction(/x/)&&(exports.isFunction=isFunction=function(value){return"function"==typeof value&&"[object Function]"===toString.call(value)}),exports.isFunction=isFunction;var isArray=Array.isArray||function(value){return!(!value||"object"!=typeof value)&&"[object Array]"===toString.call(value)};exports.isArray=isArray;function indexOf(array,value){for(var i=0,len=array.length;i<len;i++)if(array[i]===value)return i;return-1}function escapeExpression(string){if("string"!=typeof string){if(string&&string.toHTML)return string.toHTML();if(null==string)return"";if(!string)return string+"";string=""+string}return possible.test(string)?string.replace(badChars,escapeChar):string}function isEmpty(value){return!value&&0!==value||!(!isArray(value)||0!==value.length)}function createFrame(object){var frame=extend({},object);return frame._parent=object,frame}function blockParams(params,ids){return params.path=ids,params}function appendContextPath(contextPath,id){return(contextPath?contextPath+".":"")+id}},function(module,exports){"use strict";exports.__esModule=!0;var errorProps=["description","fileName","lineNumber","message","name","number","stack"];function Exception(message,node){var loc=node&&node.loc,line=void 0,column=void 0;loc&&(line=loc.start.line,column=loc.start.column,message+=" - "+line+":"+column);for(var tmp=Error.prototype.constructor.call(this,message),idx=0;idx<errorProps.length;idx++)this[errorProps[idx]]=tmp[errorProps[idx]];Error.captureStackTrace&&Error.captureStackTrace(this,Exception),loc&&(this.lineNumber=line,this.column=column)}Exception.prototype=new Error,exports.default=Exception,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.registerDefaultHelpers=registerDefaultHelpers;var _helpersBlockHelperMissing=__webpack_require__(8),_helpersBlockHelperMissing2=_interopRequireDefault(_helpersBlockHelperMissing),_helpersEach=__webpack_require__(9),_helpersEach2=_interopRequireDefault(_helpersEach),_helpersHelperMissing=__webpack_require__(10),_helpersHelperMissing2=_interopRequireDefault(_helpersHelperMissing),_helpersIf=__webpack_require__(11),_helpersIf2=_interopRequireDefault(_helpersIf),_helpersLog=__webpack_require__(12),_helpersLog2=_interopRequireDefault(_helpersLog),_helpersLookup=__webpack_require__(13),_helpersLookup2=_interopRequireDefault(_helpersLookup),_helpersWith=__webpack_require__(14),_helpersWith2=_interopRequireDefault(_helpersWith);function registerDefaultHelpers(instance){_helpersBlockHelperMissing2.default(instance),_helpersEach2.default(instance),_helpersHelperMissing2.default(instance),_helpersIf2.default(instance),_helpersLog2.default(instance),_helpersLookup2.default(instance),_helpersWith2.default(instance)}},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5);exports.default=function(instance){instance.registerHelper("blockHelperMissing",function(context,options){var inverse=options.inverse,fn=options.fn;if(!0===context)return fn(this);if(!1===context||null==context)return inverse(this);if(_utils.isArray(context))return context.length>0?(options.ids&&(options.ids=[options.name]),instance.helpers.each(context,options)):inverse(this);if(options.data&&options.ids){var data=_utils.createFrame(options.data);data.contextPath=_utils.appendContextPath(options.data.contextPath,options.name),options={data:data}}return fn(context,options)})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _utils=__webpack_require__(5),_exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception);exports.default=function(instance){instance.registerHelper("each",function(context,options){if(!options)throw new _exception2.default("Must pass iterator to #each");var fn=options.fn,inverse=options.inverse,i=0,ret="",data=void 0,contextPath=void 0;options.data&&options.ids&&(contextPath=_utils.appendContextPath(options.data.contextPath,options.ids[0])+"."),_utils.isFunction(context)&&(context=context.call(this)),options.data&&(data=_utils.createFrame(options.data));function execIteration(field,index,last){data&&(data.key=field,data.index=index,data.first=0===index,data.last=!!last,contextPath&&(data.contextPath=contextPath+field)),ret+=fn(context[field],{data:data,blockParams:_utils.blockParams([context[field],field],[contextPath+field,null])})}if(context&&"object"==typeof context)if(_utils.isArray(context))for(var j=context.length;i<j;i++)i in context&&execIteration(i,i,i===context.length-1);else{var priorKey=void 0;for(var key in context)context.hasOwnProperty(key)&&(void 0!==priorKey&&execIteration(priorKey,i-1),priorKey=key,i++);void 0!==priorKey&&execIteration(priorKey,i-1,!0)}return 0===i&&(ret=inverse(this)),ret})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception);exports.default=function(instance){instance.registerHelper("helperMissing",function(){if(1!==arguments.length)throw new _exception2.default('Missing helper: "'+arguments[arguments.length-1].name+'"')})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5);exports.default=function(instance){instance.registerHelper("if",function(conditional,options){return _utils.isFunction(conditional)&&(conditional=conditional.call(this)),!options.hash.includeZero&&!conditional||_utils.isEmpty(conditional)?options.inverse(this):options.fn(this)}),instance.registerHelper("unless",function(conditional,options){return instance.helpers.if.call(this,conditional,{fn:options.inverse,inverse:options.fn,hash:options.hash})})},module.exports=exports.default},function(module,exports){"use strict";exports.__esModule=!0,exports.default=function(instance){instance.registerHelper("log",function(){for(var args=[void 0],options=arguments[arguments.length-1],i=0;i<arguments.length-1;i++)args.push(arguments[i]);var level=1;null!=options.hash.level?level=options.hash.level:options.data&&null!=options.data.level&&(level=options.data.level),args[0]=level,instance.log.apply(instance,args)})},module.exports=exports.default},function(module,exports){"use strict";exports.__esModule=!0,exports.default=function(instance){instance.registerHelper("lookup",function(obj,field){return obj&&obj[field]})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5);exports.default=function(instance){instance.registerHelper("with",function(context,options){_utils.isFunction(context)&&(context=context.call(this));var fn=options.fn;if(_utils.isEmpty(context))return options.inverse(this);var data=options.data;return options.data&&options.ids&&(data=_utils.createFrame(options.data),data.contextPath=_utils.appendContextPath(options.data.contextPath,options.ids[0])),fn(context,{data:data,blockParams:_utils.blockParams([context],[data&&data.contextPath])})})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.registerDefaultDecorators=registerDefaultDecorators;var _decoratorsInline=__webpack_require__(16),_decoratorsInline2=_interopRequireDefault(_decoratorsInline);function registerDefaultDecorators(instance){_decoratorsInline2.default(instance)}},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5);exports.default=function(instance){instance.registerDecorator("inline",function(fn,props,container,options){var ret=fn;return props.partials||(props.partials={},ret=function(context,options){var original=container.partials;container.partials=_utils.extend({},original,props.partials);var ret=fn(context,options);return container.partials=original,ret}),props.partials[options.args[0]]=options.fn,ret})},module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5),logger={methodMap:["debug","info","warn","error"],level:"info",lookupLevel:function(level){if("string"==typeof level){var levelMap=_utils.indexOf(logger.methodMap,level.toLowerCase());level=levelMap>=0?levelMap:parseInt(level,10)}return level},log:function(level){if(level=logger.lookupLevel(level),"undefined"!=typeof console&&logger.lookupLevel(logger.level)<=level){var method=logger.methodMap[level];console[method]||(method="log");for(var _len=arguments.length,message=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)message[_key-1]=arguments[_key];console[method].apply(console,message)}}};exports.default=logger,module.exports=exports.default},function(module,exports){"use strict";exports.__esModule=!0;function SafeString(string){this.string=string}SafeString.prototype.toString=SafeString.prototype.toHTML=function(){return""+this.string},exports.default=SafeString,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireWildcard=__webpack_require__(3).default,_interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.checkRevision=checkRevision,exports.template=template,exports.wrapProgram=wrapProgram,exports.resolvePartial=resolvePartial,exports.invokePartial=invokePartial,exports.noop=noop;var _utils=__webpack_require__(5),Utils=_interopRequireWildcard(_utils),_exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception),_base=__webpack_require__(4);function checkRevision(compilerInfo){var compilerRevision=compilerInfo&&compilerInfo[0]||1,currentRevision=_base.COMPILER_REVISION;if(compilerRevision!==currentRevision){if(compilerRevision<currentRevision){var runtimeVersions=_base.REVISION_CHANGES[currentRevision],compilerVersions=_base.REVISION_CHANGES[compilerRevision];throw new _exception2.default("Template was precompiled with an older version of Handlebars than the current runtime. Please update your precompiler to a newer version ("+runtimeVersions+") or downgrade your runtime to an older version ("+compilerVersions+").")}throw new _exception2.default("Template was precompiled with a newer version of Handlebars than the current runtime. Please update your runtime to a newer version ("+compilerInfo[1]+").")}}function template(templateSpec,env){if(!env)throw new _exception2.default("No environment passed to template");if(!templateSpec||!templateSpec.main)throw new _exception2.default("Unknown template object: "+typeof templateSpec);templateSpec.main.decorator=templateSpec.main_d,env.VM.checkRevision(templateSpec.compiler);function invokePartialWrapper(partial,context,options){options.hash&&(context=Utils.extend({},context,options.hash),options.ids&&(options.ids[0]=!0)),partial=env.VM.resolvePartial.call(this,partial,context,options);var result=env.VM.invokePartial.call(this,partial,context,options);if(null==result&&env.compile&&(options.partials[options.name]=env.compile(partial,templateSpec.compilerOptions,env),result=options.partials[options.name](context,options)),null!=result){if(options.indent){for(var lines=result.split("\n"),i=0,l=lines.length;i<l&&(lines[i]||i+1!==l);i++)lines[i]=options.indent+lines[i];result=lines.join("\n")}return result}throw new _exception2.default("The partial "+options.name+" could not be compiled when running in runtime-only mode")}var container={strict:function(obj,name){if(!(name in obj))throw new _exception2.default('"'+name+'" not defined in '+obj);return obj[name]},lookup:function(depths,name){for(var len=depths.length,i=0;i<len;i++)if(depths[i]&&null!=depths[i][name])return depths[i][name]},lambda:function(current,context){return"function"==typeof current?current.call(context):current},escapeExpression:Utils.escapeExpression,invokePartial:invokePartialWrapper,fn:function(i){var ret=templateSpec[i];return ret.decorator=templateSpec[i+"_d"],ret},programs:[],program:function(i,data,declaredBlockParams,blockParams,depths){var programWrapper=this.programs[i],fn=this.fn(i);return data||depths||blockParams||declaredBlockParams?programWrapper=wrapProgram(this,i,fn,data,declaredBlockParams,blockParams,depths):programWrapper||(programWrapper=this.programs[i]=wrapProgram(this,i,fn)),programWrapper},data:function(value,depth){for(;value&&depth--;)value=value._parent;return value},merge:function(param,common){var obj=param||common;return param&&common&&param!==common&&(obj=Utils.extend({},common,param)),obj},noop:env.VM.noop,compilerInfo:templateSpec.compiler};function ret(context){var options=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],data=options.data;ret._setup(options),!options.partial&&templateSpec.useData&&(data=initData(context,data));var depths=void 0,blockParams=templateSpec.useBlockParams?[]:void 0;templateSpec.useDepths&&(depths=options.depths?context!==options.depths[0]?[context].concat(options.depths):options.depths:[context]);function main(context){return""+templateSpec.main(container,context,container.helpers,container.partials,data,blockParams,depths)}return(main=executeDecorators(templateSpec.main,main,container,options.depths||[],data,blockParams))(context,options)}return ret.isTop=!0,ret._setup=function(options){options.partial?(container.helpers=options.helpers,container.partials=options.partials,container.decorators=options.decorators):(container.helpers=container.merge(options.helpers,env.helpers),templateSpec.usePartial&&(container.partials=container.merge(options.partials,env.partials)),(templateSpec.usePartial||templateSpec.useDecorators)&&(container.decorators=container.merge(options.decorators,env.decorators)))},ret._child=function(i,data,blockParams,depths){if(templateSpec.useBlockParams&&!blockParams)throw new _exception2.default("must pass block params");if(templateSpec.useDepths&&!depths)throw new _exception2.default("must pass parent depths");return wrapProgram(container,i,templateSpec[i],data,0,blockParams,depths)},ret}function wrapProgram(container,i,fn,data,declaredBlockParams,blockParams,depths){function prog(context){var options=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],currentDepths=depths;return depths&&context!==depths[0]&&(currentDepths=[context].concat(depths)),fn(container,context,container.helpers,container.partials,options.data||data,blockParams&&[options.blockParams].concat(blockParams),currentDepths)}return prog=executeDecorators(fn,prog,container,depths,data,blockParams),prog.program=i,prog.depth=depths?depths.length:0,prog.blockParams=declaredBlockParams||0,prog}function resolvePartial(partial,context,options){return partial?partial.call||options.name||(options.name=partial,partial=options.partials[partial]):partial="@partial-block"===options.name?options.data["partial-block"]:options.partials[options.name],partial}function invokePartial(partial,context,options){options.partial=!0,options.ids&&(options.data.contextPath=options.ids[0]||options.data.contextPath);var partialBlock=void 0;if(options.fn&&options.fn!==noop&&(options.data=_base.createFrame(options.data),partialBlock=options.data["partial-block"]=options.fn,partialBlock.partials&&(options.partials=Utils.extend({},options.partials,partialBlock.partials))),void 0===partial&&partialBlock&&(partial=partialBlock),void 0===partial)throw new _exception2.default("The partial "+options.name+" could not be found");if(partial instanceof Function)return partial(context,options)}function noop(){return""}function initData(context,data){return data&&"root"in data||(data=data?_base.createFrame(data):{},data.root=context),data}function executeDecorators(fn,prog,container,depths,data,blockParams){if(fn.decorator){var props={};prog=fn.decorator(prog,props,container,depths&&depths[0],data,blockParams,depths),Utils.extend(prog,props)}return prog}},function(module,exports){(function(global){"use strict";exports.__esModule=!0,exports.default=function(Handlebars){var root=void 0!==global?global:window,$Handlebars=root.Handlebars;Handlebars.noConflict=function(){return root.Handlebars===Handlebars&&(root.Handlebars=$Handlebars),Handlebars}},module.exports=exports.default}).call(exports,function(){return this}())},function(module,exports){"use strict";exports.__esModule=!0;var AST={helpers:{helperExpression:function(node){return"SubExpression"===node.type||("MustacheStatement"===node.type||"BlockStatement"===node.type)&&!!(node.params&&node.params.length||node.hash)},scopedId:function(path){return/^\.|this\b/.test(path.original)},simpleId:function(path){return 1===path.parts.length&&!AST.helpers.scopedId(path)&&!path.depth}}};exports.default=AST,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default,_interopRequireWildcard=__webpack_require__(3).default;exports.__esModule=!0,exports.parse=parse;var _parser=__webpack_require__(23),_parser2=_interopRequireDefault(_parser),_whitespaceControl=__webpack_require__(24),_whitespaceControl2=_interopRequireDefault(_whitespaceControl),_helpers=__webpack_require__(26),Helpers=_interopRequireWildcard(_helpers),_utils=__webpack_require__(5);exports.parser=_parser2.default;var yy={};_utils.extend(yy,Helpers);function parse(input,options){return"Program"===input.type?input:(_parser2.default.yy=yy,yy.locInfo=function(locInfo){return new yy.SourceLocation(options&&options.srcName,locInfo)},new _whitespaceControl2.default(options).accept(_parser2.default.parse(input)))}},function(module,exports){"use strict";var handlebars=function(){var parser={trace:function(){},yy:{},symbols_:{error:2,root:3,program:4,EOF:5,program_repetition0:6,statement:7,mustache:8,block:9,rawBlock:10,partial:11,partialBlock:12,content:13,COMMENT:14,CONTENT:15,openRawBlock:16,rawBlock_repetition_plus0:17,END_RAW_BLOCK:18,OPEN_RAW_BLOCK:19,helperName:20,openRawBlock_repetition0:21,openRawBlock_option0:22,CLOSE_RAW_BLOCK:23,openBlock:24,block_option0:25,closeBlock:26,openInverse:27,block_option1:28,OPEN_BLOCK:29,openBlock_repetition0:30,openBlock_option0:31,openBlock_option1:32,CLOSE:33,OPEN_INVERSE:34,openInverse_repetition0:35,openInverse_option0:36,openInverse_option1:37,openInverseChain:38,OPEN_INVERSE_CHAIN:39,openInverseChain_repetition0:40,openInverseChain_option0:41,openInverseChain_option1:42,inverseAndProgram:43,INVERSE:44,inverseChain:45,inverseChain_option0:46,OPEN_ENDBLOCK:47,OPEN:48,mustache_repetition0:49,mustache_option0:50,OPEN_UNESCAPED:51,mustache_repetition1:52,mustache_option1:53,CLOSE_UNESCAPED:54,OPEN_PARTIAL:55,partialName:56,partial_repetition0:57,partial_option0:58,openPartialBlock:59,OPEN_PARTIAL_BLOCK:60,openPartialBlock_repetition0:61,openPartialBlock_option0:62,param:63,sexpr:64,OPEN_SEXPR:65,sexpr_repetition0:66,sexpr_option0:67,CLOSE_SEXPR:68,hash:69,hash_repetition_plus0:70,hashSegment:71,ID:72,EQUALS:73,blockParams:74,OPEN_BLOCK_PARAMS:75,blockParams_repetition_plus0:76,CLOSE_BLOCK_PARAMS:77,path:78,dataName:79,STRING:80,NUMBER:81,BOOLEAN:82,UNDEFINED:83,NULL:84,DATA:85,pathSegments:86,SEP:87,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",14:"COMMENT",15:"CONTENT",18:"END_RAW_BLOCK",19:"OPEN_RAW_BLOCK",23:"CLOSE_RAW_BLOCK",29:"OPEN_BLOCK",33:"CLOSE",34:"OPEN_INVERSE",39:"OPEN_INVERSE_CHAIN",44:"INVERSE",47:"OPEN_ENDBLOCK",48:"OPEN",51:"OPEN_UNESCAPED",54:"CLOSE_UNESCAPED",55:"OPEN_PARTIAL",60:"OPEN_PARTIAL_BLOCK",65:"OPEN_SEXPR",68:"CLOSE_SEXPR",72:"ID",73:"EQUALS",75:"OPEN_BLOCK_PARAMS",77:"CLOSE_BLOCK_PARAMS",80:"STRING",81:"NUMBER",82:"BOOLEAN",83:"UNDEFINED",84:"NULL",85:"DATA",87:"SEP"},
productions_:[0,[3,2],[4,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[13,1],[10,3],[16,5],[9,4],[9,4],[24,6],[27,6],[38,6],[43,2],[45,3],[45,1],[26,3],[8,5],[8,5],[11,5],[12,3],[59,5],[63,1],[63,1],[64,5],[69,1],[71,3],[74,3],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[56,1],[56,1],[79,2],[78,1],[86,3],[86,1],[6,0],[6,2],[17,1],[17,2],[21,0],[21,2],[22,0],[22,1],[25,0],[25,1],[28,0],[28,1],[30,0],[30,2],[31,0],[31,1],[32,0],[32,1],[35,0],[35,2],[36,0],[36,1],[37,0],[37,1],[40,0],[40,2],[41,0],[41,1],[42,0],[42,1],[46,0],[46,1],[49,0],[49,2],[50,0],[50,1],[52,0],[52,2],[53,0],[53,1],[57,0],[57,2],[58,0],[58,1],[61,0],[61,2],[62,0],[62,1],[66,0],[66,2],[67,0],[67,1],[70,1],[70,2],[76,1],[76,2]],performAction:function(yytext,yyleng,yylineno,yy,yystate,$$,_$){var $0=$$.length-1;switch(yystate){case 1:return $$[$0-1];case 2:this.$=yy.prepareProgram($$[$0]);break;case 3:case 4:case 5:case 6:case 7:case 8:this.$=$$[$0];break;case 9:this.$={type:"CommentStatement",value:yy.stripComment($$[$0]),strip:yy.stripFlags($$[$0],$$[$0]),loc:yy.locInfo(this._$)};break;case 10:this.$={type:"ContentStatement",original:$$[$0],value:$$[$0],loc:yy.locInfo(this._$)};break;case 11:this.$=yy.prepareRawBlock($$[$0-2],$$[$0-1],$$[$0],this._$);break;case 12:this.$={path:$$[$0-3],params:$$[$0-2],hash:$$[$0-1]};break;case 13:this.$=yy.prepareBlock($$[$0-3],$$[$0-2],$$[$0-1],$$[$0],!1,this._$);break;case 14:this.$=yy.prepareBlock($$[$0-3],$$[$0-2],$$[$0-1],$$[$0],!0,this._$);break;case 15:this.$={open:$$[$0-5],path:$$[$0-4],params:$$[$0-3],hash:$$[$0-2],blockParams:$$[$0-1],strip:yy.stripFlags($$[$0-5],$$[$0])};break;case 16:case 17:this.$={path:$$[$0-4],params:$$[$0-3],hash:$$[$0-2],blockParams:$$[$0-1],strip:yy.stripFlags($$[$0-5],$$[$0])};break;case 18:this.$={strip:yy.stripFlags($$[$0-1],$$[$0-1]),program:$$[$0]};break;case 19:var inverse=yy.prepareBlock($$[$0-2],$$[$0-1],$$[$0],$$[$0],!1,this._$),program=yy.prepareProgram([inverse],$$[$0-1].loc);program.chained=!0,this.$={strip:$$[$0-2].strip,program:program,chain:!0};break;case 20:this.$=$$[$0];break;case 21:this.$={path:$$[$0-1],strip:yy.stripFlags($$[$0-2],$$[$0])};break;case 22:case 23:this.$=yy.prepareMustache($$[$0-3],$$[$0-2],$$[$0-1],$$[$0-4],yy.stripFlags($$[$0-4],$$[$0]),this._$);break;case 24:this.$={type:"PartialStatement",name:$$[$0-3],params:$$[$0-2],hash:$$[$0-1],indent:"",strip:yy.stripFlags($$[$0-4],$$[$0]),loc:yy.locInfo(this._$)};break;case 25:this.$=yy.preparePartialBlock($$[$0-2],$$[$0-1],$$[$0],this._$);break;case 26:this.$={path:$$[$0-3],params:$$[$0-2],hash:$$[$0-1],strip:yy.stripFlags($$[$0-4],$$[$0])};break;case 27:case 28:this.$=$$[$0];break;case 29:this.$={type:"SubExpression",path:$$[$0-3],params:$$[$0-2],hash:$$[$0-1],loc:yy.locInfo(this._$)};break;case 30:this.$={type:"Hash",pairs:$$[$0],loc:yy.locInfo(this._$)};break;case 31:this.$={type:"HashPair",key:yy.id($$[$0-2]),value:$$[$0],loc:yy.locInfo(this._$)};break;case 32:this.$=yy.id($$[$0-1]);break;case 33:case 34:this.$=$$[$0];break;case 35:this.$={type:"StringLiteral",value:$$[$0],original:$$[$0],loc:yy.locInfo(this._$)};break;case 36:this.$={type:"NumberLiteral",value:Number($$[$0]),original:Number($$[$0]),loc:yy.locInfo(this._$)};break;case 37:this.$={type:"BooleanLiteral",value:"true"===$$[$0],original:"true"===$$[$0],loc:yy.locInfo(this._$)};break;case 38:this.$={type:"UndefinedLiteral",original:void 0,value:void 0,loc:yy.locInfo(this._$)};break;case 39:this.$={type:"NullLiteral",original:null,value:null,loc:yy.locInfo(this._$)};break;case 40:case 41:this.$=$$[$0];break;case 42:this.$=yy.preparePath(!0,$$[$0],this._$);break;case 43:this.$=yy.preparePath(!1,$$[$0],this._$);break;case 44:$$[$0-2].push({part:yy.id($$[$0]),original:$$[$0],separator:$$[$0-1]}),this.$=$$[$0-2];break;case 45:this.$=[{part:yy.id($$[$0]),original:$$[$0]}];break;case 46:this.$=[];break;case 47:$$[$0-1].push($$[$0]);break;case 48:this.$=[$$[$0]];break;case 49:$$[$0-1].push($$[$0]);break;case 50:this.$=[];break;case 51:$$[$0-1].push($$[$0]);break;case 58:this.$=[];break;case 59:$$[$0-1].push($$[$0]);break;case 64:this.$=[];break;case 65:$$[$0-1].push($$[$0]);break;case 70:this.$=[];break;case 71:$$[$0-1].push($$[$0]);break;case 78:this.$=[];break;case 79:$$[$0-1].push($$[$0]);break;case 82:this.$=[];break;case 83:$$[$0-1].push($$[$0]);break;case 86:this.$=[];break;case 87:$$[$0-1].push($$[$0]);break;case 90:this.$=[];break;case 91:$$[$0-1].push($$[$0]);break;case 94:this.$=[];break;case 95:$$[$0-1].push($$[$0]);break;case 98:this.$=[$$[$0]];break;case 99:$$[$0-1].push($$[$0]);break;case 100:this.$=[$$[$0]];break;case 101:$$[$0-1].push($$[$0])}},table:[{3:1,4:2,5:[2,46],6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{1:[3]},{5:[1,4]},{5:[2,2],7:5,8:6,9:7,10:8,11:9,12:10,13:11,14:[1,12],15:[1,20],16:17,19:[1,23],24:15,27:16,29:[1,21],34:[1,22],39:[2,2],44:[2,2],47:[2,2],48:[1,13],51:[1,14],55:[1,18],59:19,60:[1,24]},{1:[2,1]},{5:[2,47],14:[2,47],15:[2,47],19:[2,47],29:[2,47],34:[2,47],39:[2,47],44:[2,47],47:[2,47],48:[2,47],51:[2,47],55:[2,47],60:[2,47]},{5:[2,3],14:[2,3],15:[2,3],19:[2,3],29:[2,3],34:[2,3],39:[2,3],44:[2,3],47:[2,3],48:[2,3],51:[2,3],55:[2,3],60:[2,3]},{5:[2,4],14:[2,4],15:[2,4],19:[2,4],29:[2,4],34:[2,4],39:[2,4],44:[2,4],47:[2,4],48:[2,4],51:[2,4],55:[2,4],60:[2,4]},{5:[2,5],14:[2,5],15:[2,5],19:[2,5],29:[2,5],34:[2,5],39:[2,5],44:[2,5],47:[2,5],48:[2,5],51:[2,5],55:[2,5],60:[2,5]},{5:[2,6],14:[2,6],15:[2,6],19:[2,6],29:[2,6],34:[2,6],39:[2,6],44:[2,6],47:[2,6],48:[2,6],51:[2,6],55:[2,6],60:[2,6]},{5:[2,7],14:[2,7],15:[2,7],19:[2,7],29:[2,7],34:[2,7],39:[2,7],44:[2,7],47:[2,7],48:[2,7],51:[2,7],55:[2,7],60:[2,7]},{5:[2,8],14:[2,8],15:[2,8],19:[2,8],29:[2,8],34:[2,8],39:[2,8],44:[2,8],47:[2,8],48:[2,8],51:[2,8],55:[2,8],60:[2,8]},{5:[2,9],14:[2,9],15:[2,9],19:[2,9],29:[2,9],34:[2,9],39:[2,9],44:[2,9],47:[2,9],48:[2,9],51:[2,9],55:[2,9],60:[2,9]},{20:25,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:36,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:37,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{4:38,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{13:40,15:[1,20],17:39},{20:42,56:41,64:43,65:[1,44],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:45,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{5:[2,10],14:[2,10],15:[2,10],18:[2,10],19:[2,10],29:[2,10],34:[2,10],39:[2,10],44:[2,10],47:[2,10],48:[2,10],51:[2,10],55:[2,10],60:[2,10]},{20:46,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:47,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:48,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:42,56:49,64:43,65:[1,44],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[2,78],49:50,65:[2,78],72:[2,78],80:[2,78],81:[2,78],82:[2,78],83:[2,78],84:[2,78],85:[2,78]},{23:[2,33],33:[2,33],54:[2,33],65:[2,33],68:[2,33],72:[2,33],75:[2,33],80:[2,33],81:[2,33],82:[2,33],83:[2,33],84:[2,33],85:[2,33]},{23:[2,34],33:[2,34],54:[2,34],65:[2,34],68:[2,34],72:[2,34],75:[2,34],80:[2,34],81:[2,34],82:[2,34],83:[2,34],84:[2,34],85:[2,34]},{23:[2,35],33:[2,35],54:[2,35],65:[2,35],68:[2,35],72:[2,35],75:[2,35],80:[2,35],81:[2,35],82:[2,35],83:[2,35],84:[2,35],85:[2,35]},{23:[2,36],33:[2,36],54:[2,36],65:[2,36],68:[2,36],72:[2,36],75:[2,36],80:[2,36],81:[2,36],82:[2,36],83:[2,36],84:[2,36],85:[2,36]},{23:[2,37],33:[2,37],54:[2,37],65:[2,37],68:[2,37],72:[2,37],75:[2,37],80:[2,37],81:[2,37],82:[2,37],83:[2,37],84:[2,37],85:[2,37]},{23:[2,38],33:[2,38],54:[2,38],65:[2,38],68:[2,38],72:[2,38],75:[2,38],80:[2,38],81:[2,38],82:[2,38],83:[2,38],84:[2,38],85:[2,38]},{23:[2,39],33:[2,39],54:[2,39],65:[2,39],68:[2,39],72:[2,39],75:[2,39],80:[2,39],81:[2,39],82:[2,39],83:[2,39],84:[2,39],85:[2,39]},{23:[2,43],33:[2,43],54:[2,43],65:[2,43],68:[2,43],72:[2,43],75:[2,43],80:[2,43],81:[2,43],82:[2,43],83:[2,43],84:[2,43],85:[2,43],87:[1,51]},{72:[1,35],86:52},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{52:53,54:[2,82],65:[2,82],72:[2,82],80:[2,82],81:[2,82],82:[2,82],83:[2,82],84:[2,82],85:[2,82]},{25:54,38:56,39:[1,58],43:57,44:[1,59],45:55,47:[2,54]},{28:60,43:61,44:[1,59],47:[2,56]},{13:63,15:[1,20],18:[1,62]},{15:[2,48],18:[2,48]},{33:[2,86],57:64,65:[2,86],72:[2,86],80:[2,86],81:[2,86],82:[2,86],83:[2,86],84:[2,86],85:[2,86]},{33:[2,40],65:[2,40],72:[2,40],80:[2,40],81:[2,40],82:[2,40],83:[2,40],84:[2,40],85:[2,40]},{33:[2,41],65:[2,41],72:[2,41],80:[2,41],81:[2,41],82:[2,41],83:[2,41],84:[2,41],85:[2,41]},{20:65,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:66,47:[1,67]},{30:68,33:[2,58],65:[2,58],72:[2,58],75:[2,58],80:[2,58],81:[2,58],82:[2,58],83:[2,58],84:[2,58],85:[2,58]},{33:[2,64],35:69,65:[2,64],72:[2,64],75:[2,64],80:[2,64],81:[2,64],82:[2,64],83:[2,64],84:[2,64],85:[2,64]},{21:70,23:[2,50],65:[2,50],72:[2,50],80:[2,50],81:[2,50],82:[2,50],83:[2,50],84:[2,50],85:[2,50]},{33:[2,90],61:71,65:[2,90],72:[2,90],80:[2,90],81:[2,90],82:[2,90],83:[2,90],84:[2,90],85:[2,90]},{20:75,33:[2,80],50:72,63:73,64:76,65:[1,44],69:74,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{72:[1,80]},{23:[2,42],33:[2,42],54:[2,42],65:[2,42],68:[2,42],72:[2,42],75:[2,42],80:[2,42],81:[2,42],82:[2,42],83:[2,42],84:[2,42],85:[2,42],87:[1,51]},{20:75,53:81,54:[2,84],63:82,64:76,65:[1,44],69:83,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:84,47:[1,67]},{47:[2,55]},{4:85,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{47:[2,20]},{20:86,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:87,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{26:88,47:[1,67]},{47:[2,57]},{5:[2,11],14:[2,11],15:[2,11],19:[2,11],29:[2,11],34:[2,11],39:[2,11],44:[2,11],47:[2,11],48:[2,11],51:[2,11],55:[2,11],60:[2,11]},{15:[2,49],18:[2,49]},{20:75,33:[2,88],58:89,63:90,64:76,65:[1,44],69:91,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{65:[2,94],66:92,68:[2,94],72:[2,94],80:[2,94],81:[2,94],82:[2,94],83:[2,94],84:[2,94],85:[2,94]},{5:[2,25],14:[2,25],15:[2,25],19:[2,25],29:[2,25],34:[2,25],39:[2,25],44:[2,25],47:[2,25],48:[2,25],51:[2,25],55:[2,25],60:[2,25]},{20:93,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,31:94,33:[2,60],63:95,64:76,65:[1,44],69:96,70:77,71:78,72:[1,79],75:[2,60],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,33:[2,66],36:97,63:98,64:76,65:[1,44],69:99,70:77,71:78,72:[1,79],75:[2,66],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,22:100,23:[2,52],63:101,64:76,65:[1,44],69:102,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,33:[2,92],62:103,63:104,64:76,65:[1,44],69:105,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,106]},{33:[2,79],65:[2,79],72:[2,79],80:[2,79],81:[2,79],82:[2,79],83:[2,79],84:[2,79],85:[2,79]},{33:[2,81]},{23:[2,27],33:[2,27],54:[2,27],65:[2,27],68:[2,27],72:[2,27],75:[2,27],80:[2,27],81:[2,27],82:[2,27],83:[2,27],84:[2,27],85:[2,27]},{23:[2,28],33:[2,28],54:[2,28],65:[2,28],68:[2,28],72:[2,28],75:[2,28],80:[2,28],81:[2,28],82:[2,28],83:[2,28],84:[2,28],85:[2,28]},{23:[2,30],33:[2,30],54:[2,30],68:[2,30],71:107,72:[1,108],75:[2,30]},{23:[2,98],33:[2,98],54:[2,98],68:[2,98],72:[2,98],75:[2,98]},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],73:[1,109],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{23:[2,44],33:[2,44],54:[2,44],65:[2,44],68:[2,44],72:[2,44],75:[2,44],80:[2,44],81:[2,44],82:[2,44],83:[2,44],84:[2,44],85:[2,44],87:[2,44]},{54:[1,110]},{54:[2,83],65:[2,83],72:[2,83],80:[2,83],81:[2,83],82:[2,83],83:[2,83],84:[2,83],85:[2,83]},{54:[2,85]},{5:[2,13],14:[2,13],15:[2,13],19:[2,13],29:[2,13],34:[2,13],39:[2,13],44:[2,13],47:[2,13],48:[2,13],51:[2,13],55:[2,13],60:[2,13]},{38:56,39:[1,58],43:57,44:[1,59],45:112,46:111,47:[2,76]},{33:[2,70],40:113,65:[2,70],72:[2,70],75:[2,70],80:[2,70],81:[2,70],82:[2,70],83:[2,70],84:[2,70],85:[2,70]},{47:[2,18]},{5:[2,14],14:[2,14],15:[2,14],19:[2,14],29:[2,14],34:[2,14],39:[2,14],44:[2,14],47:[2,14],48:[2,14],51:[2,14],55:[2,14],60:[2,14]},{33:[1,114]},{33:[2,87],65:[2,87],72:[2,87],80:[2,87],81:[2,87],82:[2,87],83:[2,87],84:[2,87],85:[2,87]},{33:[2,89]},{20:75,63:116,64:76,65:[1,44],67:115,68:[2,96],69:117,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,118]},{32:119,33:[2,62],74:120,75:[1,121]},{33:[2,59],65:[2,59],72:[2,59],75:[2,59],80:[2,59],81:[2,59],82:[2,59],83:[2,59],84:[2,59],85:[2,59]},{33:[2,61],75:[2,61]},{33:[2,68],37:122,74:123,75:[1,121]},{33:[2,65],65:[2,65],72:[2,65],75:[2,65],80:[2,65],81:[2,65],82:[2,65],83:[2,65],84:[2,65],85:[2,65]},{33:[2,67],75:[2,67]},{23:[1,124]},{23:[2,51],65:[2,51],72:[2,51],80:[2,51],81:[2,51],82:[2,51],83:[2,51],84:[2,51],85:[2,51]},{23:[2,53]},{33:[1,125]},{33:[2,91],65:[2,91],72:[2,91],80:[2,91],81:[2,91],82:[2,91],83:[2,91],84:[2,91],85:[2,91]},{33:[2,93]},{5:[2,22],14:[2,22],15:[2,22],19:[2,22],29:[2,22],34:[2,22],39:[2,22],44:[2,22],47:[2,22],48:[2,22],51:[2,22],55:[2,22],60:[2,22]},{23:[2,99],33:[2,99],54:[2,99],68:[2,99],72:[2,99],75:[2,99]},{73:[1,109]},{20:75,63:126,64:76,65:[1,44],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,23],14:[2,23],15:[2,23],19:[2,23],29:[2,23],34:[2,23],39:[2,23],44:[2,23],47:[2,23],48:[2,23],51:[2,23],55:[2,23],60:[2,23]},{47:[2,19]},{47:[2,77]},{20:75,33:[2,72],41:127,63:128,64:76,65:[1,44],69:129,70:77,71:78,72:[1,79],75:[2,72],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,24],14:[2,24],15:[2,24],19:[2,24],29:[2,24],34:[2,24],39:[2,24],44:[2,24],47:[2,24],48:[2,24],51:[2,24],55:[2,24],60:[2,24]},{68:[1,130]},{65:[2,95],68:[2,95],72:[2,95],80:[2,95],81:[2,95],82:[2,95],83:[2,95],84:[2,95],85:[2,95]},{68:[2,97]},{5:[2,21],14:[2,21],15:[2,21],19:[2,21],29:[2,21],34:[2,21],39:[2,21],44:[2,21],47:[2,21],48:[2,21],51:[2,21],55:[2,21],60:[2,21]},{33:[1,131]},{33:[2,63]},{72:[1,133],76:132},{33:[1,134]},{33:[2,69]},{15:[2,12]},{14:[2,26],15:[2,26],19:[2,26],29:[2,26],34:[2,26],47:[2,26],48:[2,26],51:[2,26],55:[2,26],60:[2,26]},{23:[2,31],33:[2,31],54:[2,31],68:[2,31],72:[2,31],75:[2,31]},{33:[2,74],42:135,74:136,75:[1,121]},{33:[2,71],65:[2,71],72:[2,71],75:[2,71],80:[2,71],81:[2,71],82:[2,71],83:[2,71],84:[2,71],85:[2,71]},{33:[2,73],75:[2,73]},{23:[2,29],33:[2,29],54:[2,29],65:[2,29],68:[2,29],72:[2,29],75:[2,29],80:[2,29],81:[2,29],82:[2,29],83:[2,29],84:[2,29],85:[2,29]},{14:[2,15],15:[2,15],19:[2,15],29:[2,15],34:[2,15],39:[2,15],44:[2,15],47:[2,15],48:[2,15],51:[2,15],55:[2,15],60:[2,15]},{72:[1,138],77:[1,137]},{72:[2,100],77:[2,100]},{14:[2,16],15:[2,16],19:[2,16],29:[2,16],34:[2,16],44:[2,16],47:[2,16],48:[2,16],51:[2,16],55:[2,16],60:[2,16]},{33:[1,139]},{33:[2,75]},{33:[2,32]},{72:[2,101],77:[2,101]},{14:[2,17],15:[2,17],19:[2,17],29:[2,17],34:[2,17],39:[2,17],44:[2,17],47:[2,17],48:[2,17],51:[2,17],55:[2,17],60:[2,17]}],defaultActions:{4:[2,1],55:[2,55],57:[2,20],61:[2,57],74:[2,81],83:[2,85],87:[2,18],91:[2,89],102:[2,53],105:[2,93],111:[2,19],112:[2,77],117:[2,97],120:[2,63],123:[2,69],124:[2,12],136:[2,75],137:[2,32]},parseError:function(str,hash){throw new Error(str)},parse:function(input){var self=this,stack=[0],vstack=[null],lstack=[],table=this.table,yytext="",yylineno=0,yyleng=0,recovering=0;this.lexer.setInput(input),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,this.yy.parser=this,void 0===this.lexer.yylloc&&(this.lexer.yylloc={});var yyloc=this.lexer.yylloc;lstack.push(yyloc);var ranges=this.lexer.options&&this.lexer.options.ranges;"function"==typeof this.yy.parseError&&(this.parseError=this.yy.parseError);for(var symbol,preErrorSymbol,state,action,r,p,len,newState,expected,yyval={};;){if(state=stack[stack.length-1],this.defaultActions[state]?action=this.defaultActions[state]:(null!==symbol&&void 0!==symbol||(symbol=function(){var token;return token=self.lexer.lex()||1,"number"!=typeof token&&(token=self.symbols_[token]||token),token}()),action=table[state]&&table[state][symbol]),void 0===action||!action.length||!action[0]){var errStr="";if(!recovering){expected=[];for(p in table[state])this.terminals_[p]&&p>2&&expected.push("'"+this.terminals_[p]+"'");errStr=this.lexer.showPosition?"Parse error on line "+(yylineno+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+expected.join(", ")+", got '"+(this.terminals_[symbol]||symbol)+"'":"Parse error on line "+(yylineno+1)+": Unexpected "+(1==symbol?"end of input":"'"+(this.terminals_[symbol]||symbol)+"'"),this.parseError(errStr,{text:this.lexer.match,token:this.terminals_[symbol]||symbol,line:this.lexer.yylineno,loc:yyloc,expected:expected})}}if(action[0]instanceof Array&&action.length>1)throw new Error("Parse Error: multiple actions possible at state: "+state+", token: "+symbol);switch(action[0]){case 1:stack.push(symbol),vstack.push(this.lexer.yytext),lstack.push(this.lexer.yylloc),stack.push(action[1]),symbol=null,preErrorSymbol?(symbol=preErrorSymbol,preErrorSymbol=null):(yyleng=this.lexer.yyleng,yytext=this.lexer.yytext,yylineno=this.lexer.yylineno,yyloc=this.lexer.yylloc,recovering>0&&recovering--);break;case 2:if(len=this.productions_[action[1]][1],yyval.$=vstack[vstack.length-len],yyval._$={first_line:lstack[lstack.length-(len||1)].first_line,last_line:lstack[lstack.length-1].last_line,first_column:lstack[lstack.length-(len||1)].first_column,last_column:lstack[lstack.length-1].last_column},ranges&&(yyval._$.range=[lstack[lstack.length-(len||1)].range[0],lstack[lstack.length-1].range[1]]),void 0!==(r=this.performAction.call(yyval,yytext,yyleng,yylineno,this.yy,action[1],vstack,lstack)))return r;len&&(stack=stack.slice(0,-1*len*2),vstack=vstack.slice(0,-1*len),lstack=lstack.slice(0,-1*len)),stack.push(this.productions_[action[1]][0]),vstack.push(yyval.$),lstack.push(yyval._$),newState=table[stack[stack.length-2]][stack[stack.length-1]],stack.push(newState);break;case 3:return!0}}return!0}},lexer=function(){var lexer={EOF:1,parseError:function(str,hash){if(!this.yy.parser)throw new Error(str);this.yy.parser.parseError(str,hash)},setInput:function(input){return this._input=input,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var ch=this._input[0];return this.yytext+=ch,this.yyleng++,this.offset++,this.match+=ch,this.matched+=ch,ch.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),ch},unput:function(ch){var len=ch.length,lines=ch.split(/(?:\r\n?|\n)/g);this._input=ch+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-len-1),this.offset-=len;var oldLines=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),lines.length-1&&(this.yylineno-=lines.length-1);var r=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:lines?(lines.length===oldLines.length?this.yylloc.first_column:0)+oldLines[oldLines.length-lines.length].length-lines[0].length:this.yylloc.first_column-len},this.options.ranges&&(this.yylloc.range=[r[0],r[0]+this.yyleng-len]),this},more:function(){return this._more=!0,this},less:function(n){this.unput(this.match.slice(n))},pastInput:function(){var past=this.matched.substr(0,this.matched.length-this.match.length);return(past.length>20?"...":"")+past.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var next=this.match;return next.length<20&&(next+=this._input.substr(0,20-next.length)),(next.substr(0,20)+(next.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var pre=this.pastInput(),c=new Array(pre.length+1).join("-");return pre+this.upcomingInput()+"\n"+c+"^"},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var token,match,tempMatch,index,lines;this._more||(this.yytext="",this.match="");for(var rules=this._currentRules(),i=0;i<rules.length&&(!(tempMatch=this._input.match(this.rules[rules[i]]))||match&&!(tempMatch[0].length>match[0].length)||(match=tempMatch,index=i,this.options.flex));i++);return match?(lines=match[0].match(/(?:\r\n?|\n).*/g),lines&&(this.yylineno+=lines.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:lines?lines[lines.length-1].length-lines[lines.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+match[0].length},this.yytext+=match[0],this.match+=match[0],this.matches=match,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._input=this._input.slice(match[0].length),this.matched+=match[0],token=this.performAction.call(this,this.yy,this,rules[index],this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),token||void 0):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var r=this.next();return void 0!==r?r:this.lex()},begin:function(condition){this.conditionStack.push(condition)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules},topState:function(){return this.conditionStack[this.conditionStack.length-2]},pushState:function(condition){this.begin(condition)}};return lexer.options={},lexer.performAction=function(yy,yy_,$avoiding_name_collisions,YY_START){function strip(start,end){return yy_.yytext=yy_.yytext.substr(start,yy_.yyleng-end)}switch($avoiding_name_collisions){case 0:if("\\\\"===yy_.yytext.slice(-2)?(strip(0,1),this.begin("mu")):"\\"===yy_.yytext.slice(-1)?(strip(0,1),this.begin("emu")):this.begin("mu"),yy_.yytext)return 15;break;case 1:return 15;case 2:return this.popState(),15;case 3:return this.begin("raw"),15;case 4:return this.popState(),"raw"===this.conditionStack[this.conditionStack.length-1]?15:(yy_.yytext=yy_.yytext.substr(5,yy_.yyleng-9),"END_RAW_BLOCK");case 5:return 15;case 6:return this.popState(),14;case 7:return 65;case 8:return 68;case 9:return 19;case 10:return this.popState(),this.begin("raw"),23;case 11:return 55;case 12:return 60;case 13:return 29;case 14:return 47;case 15:case 16:return this.popState(),44;case 17:return 34;case 18:return 39;case 19:return 51;case 20:return 48;case 21:this.unput(yy_.yytext),this.popState(),this.begin("com");break;case 22:return this.popState(),14;case 23:return 48;case 24:return 73;case 25:case 26:return 72;case 27:return 87;case 28:break;case 29:return this.popState(),54;case 30:return this.popState(),33;case 31:return yy_.yytext=strip(1,2).replace(/\\"/g,'"'),80;case 32:return yy_.yytext=strip(1,2).replace(/\\'/g,"'"),80;case 33:return 85;case 34:case 35:return 82;case 36:return 83;case 37:return 84;case 38:return 81;case 39:return 75;case 40:return 77;case 41:return 72;case 42:return yy_.yytext=yy_.yytext.replace(/\\([\\\]])/g,"$1"),72;case 43:return"INVALID";case 44:return 5}},lexer.rules=[/^(?:[^\x00]*?(?=(\{\{)))/,/^(?:[^\x00]+)/,/^(?:[^\x00]{2,}?(?=(\{\{|\\\{\{|\\\\\{\{|$)))/,/^(?:\{\{\{\{(?=[^\/]))/,/^(?:\{\{\{\{\/[^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=[=}\s\/.])\}\}\}\})/,/^(?:[^\x00]*?(?=(\{\{\{\{)))/,/^(?:[\s\S]*?--(~)?\}\})/,/^(?:\()/,/^(?:\))/,/^(?:\{\{\{\{)/,/^(?:\}\}\}\})/,/^(?:\{\{(~)?>)/,/^(?:\{\{(~)?#>)/,/^(?:\{\{(~)?#\*?)/,/^(?:\{\{(~)?\/)/,/^(?:\{\{(~)?\^\s*(~)?\}\})/,/^(?:\{\{(~)?\s*else\s*(~)?\}\})/,/^(?:\{\{(~)?\^)/,/^(?:\{\{(~)?\s*else\b)/,/^(?:\{\{(~)?\{)/,/^(?:\{\{(~)?&)/,/^(?:\{\{(~)?!--)/,/^(?:\{\{(~)?![\s\S]*?\}\})/,/^(?:\{\{(~)?\*?)/,/^(?:=)/,/^(?:\.\.)/,/^(?:\.(?=([=~}\s\/.)|])))/,/^(?:[\/.])/,/^(?:\s+)/,/^(?:\}(~)?\}\})/,/^(?:(~)?\}\})/,/^(?:"(\\["]|[^"])*")/,/^(?:'(\\[']|[^'])*')/,/^(?:@)/,/^(?:true(?=([~}\s)])))/,/^(?:false(?=([~}\s)])))/,/^(?:undefined(?=([~}\s)])))/,/^(?:null(?=([~}\s)])))/,/^(?:-?[0-9]+(?:\.[0-9]+)?(?=([~}\s)])))/,/^(?:as\s+\|)/,/^(?:\|)/,/^(?:([^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=([=~}\s\/.)|]))))/,/^(?:\[(\\\]|[^\]])*\])/,/^(?:.)/,/^(?:$)/],lexer.conditions={mu:{rules:[7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44],inclusive:!1},emu:{rules:[2],inclusive:!1},com:{rules:[6],inclusive:!1},raw:{rules:[3,4,5],inclusive:!1},INITIAL:{rules:[0,1,44],inclusive:!0}},lexer}();parser.lexer=lexer;function Parser(){this.yy={}}return Parser.prototype=parser,parser.Parser=Parser,new Parser}();exports.__esModule=!0,exports.default=handlebars},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _visitor=__webpack_require__(25),_visitor2=_interopRequireDefault(_visitor);function WhitespaceControl(){var options=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.options=options}WhitespaceControl.prototype=new _visitor2.default,WhitespaceControl.prototype.Program=function(program){var doStandalone=!this.options.ignoreStandalone,isRoot=!this.isRootSeen;this.isRootSeen=!0;for(var body=program.body,i=0,l=body.length;i<l;i++){var current=body[i],strip=this.accept(current);if(strip){var _isPrevWhitespace=isPrevWhitespace(body,i,isRoot),_isNextWhitespace=isNextWhitespace(body,i,isRoot),openStandalone=strip.openStandalone&&_isPrevWhitespace,closeStandalone=strip.closeStandalone&&_isNextWhitespace,inlineStandalone=strip.inlineStandalone&&_isPrevWhitespace&&_isNextWhitespace;strip.close&&omitRight(body,i,!0),strip.open&&omitLeft(body,i,!0),doStandalone&&inlineStandalone&&(omitRight(body,i),omitLeft(body,i)&&"PartialStatement"===current.type&&(current.indent=/([ \t]+$)/.exec(body[i-1].original)[1])),doStandalone&&openStandalone&&(omitRight((current.program||current.inverse).body),omitLeft(body,i)),doStandalone&&closeStandalone&&(omitRight(body,i),omitLeft((current.inverse||current.program).body))}}return program},WhitespaceControl.prototype.BlockStatement=WhitespaceControl.prototype.DecoratorBlock=WhitespaceControl.prototype.PartialBlockStatement=function(block){this.accept(block.program),this.accept(block.inverse);var program=block.program||block.inverse,inverse=block.program&&block.inverse,firstInverse=inverse,lastInverse=inverse;if(inverse&&inverse.chained)for(firstInverse=inverse.body[0].program;lastInverse.chained;)lastInverse=lastInverse.body[lastInverse.body.length-1].program;var strip={open:block.openStrip.open,close:block.closeStrip.close,openStandalone:isNextWhitespace(program.body),closeStandalone:isPrevWhitespace((firstInverse||program).body)};if(block.openStrip.close&&omitRight(program.body,null,!0),inverse){var inverseStrip=block.inverseStrip;inverseStrip.open&&omitLeft(program.body,null,!0),inverseStrip.close&&omitRight(firstInverse.body,null,!0),block.closeStrip.open&&omitLeft(lastInverse.body,null,!0),!this.options.ignoreStandalone&&isPrevWhitespace(program.body)&&isNextWhitespace(firstInverse.body)&&(omitLeft(program.body),omitRight(firstInverse.body))}else block.closeStrip.open&&omitLeft(program.body,null,!0);return strip},WhitespaceControl.prototype.Decorator=WhitespaceControl.prototype.MustacheStatement=function(mustache){return mustache.strip},WhitespaceControl.prototype.PartialStatement=WhitespaceControl.prototype.CommentStatement=function(node){var strip=node.strip||{};return{inlineStandalone:!0,open:strip.open,close:strip.close}};function isPrevWhitespace(body,i,isRoot){void 0===i&&(i=body.length);var prev=body[i-1],sibling=body[i-2];return prev?"ContentStatement"===prev.type?(sibling||!isRoot?/\r?\n\s*?$/:/(^|\r?\n)\s*?$/).test(prev.original):void 0:isRoot}function isNextWhitespace(body,i,isRoot){void 0===i&&(i=-1);var next=body[i+1],sibling=body[i+2];return next?"ContentStatement"===next.type?(sibling||!isRoot?/^\s*?\r?\n/:/^\s*?(\r?\n|$)/).test(next.original):void 0:isRoot}function omitRight(body,i,multiple){var current=body[null==i?0:i+1];if(current&&"ContentStatement"===current.type&&(multiple||!current.rightStripped)){var original=current.value;current.value=current.value.replace(multiple?/^\s+/:/^[ \t]*\r?\n?/,""),current.rightStripped=current.value!==original}}function omitLeft(body,i,multiple){var current=body[null==i?body.length-1:i-1];if(current&&"ContentStatement"===current.type&&(multiple||!current.leftStripped)){var original=current.value;return current.value=current.value.replace(multiple?/\s+$/:/[ \t]+$/,""),current.leftStripped=current.value!==original,current.leftStripped}}exports.default=WhitespaceControl,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception);function Visitor(){this.parents=[]}Visitor.prototype={constructor:Visitor,mutating:!1,acceptKey:function(node,name){var value=this.accept(node[name]);if(this.mutating){if(value&&!Visitor.prototype[value.type])throw new _exception2.default('Unexpected node type "'+value.type+'" found when accepting '+name+" on "+node.type);node[name]=value}},acceptRequired:function(node,name){if(this.acceptKey(node,name),!node[name])throw new _exception2.default(node.type+" requires "+name)},acceptArray:function(array){for(var i=0,l=array.length;i<l;i++)this.acceptKey(array,i),array[i]||(array.splice(i,1),i--,l--)},accept:function(object){if(object){if(!this[object.type])throw new _exception2.default("Unknown type: "+object.type,object);this.current&&this.parents.unshift(this.current),this.current=object;var ret=this[object.type](object);return this.current=this.parents.shift(),!this.mutating||ret?ret:!1!==ret?object:void 0}},Program:function(program){this.acceptArray(program.body)},MustacheStatement:visitSubExpression,Decorator:visitSubExpression,BlockStatement:visitBlock,DecoratorBlock:visitBlock,PartialStatement:visitPartial,PartialBlockStatement:function(partial){visitPartial.call(this,partial),this.acceptKey(partial,"program")},ContentStatement:function(){},CommentStatement:function(){},SubExpression:visitSubExpression,PathExpression:function(){},StringLiteral:function(){},NumberLiteral:function(){},BooleanLiteral:function(){},UndefinedLiteral:function(){},NullLiteral:function(){},Hash:function(hash){this.acceptArray(hash.pairs)},HashPair:function(pair){this.acceptRequired(pair,"value")}};function visitSubExpression(mustache){this.acceptRequired(mustache,"path"),this.acceptArray(mustache.params),this.acceptKey(mustache,"hash")}function visitBlock(block){visitSubExpression.call(this,block),this.acceptKey(block,"program"),this.acceptKey(block,"inverse")}function visitPartial(partial){this.acceptRequired(partial,"name"),this.acceptArray(partial.params),this.acceptKey(partial,"hash")}
exports.default=Visitor,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.SourceLocation=SourceLocation,exports.id=id,exports.stripFlags=stripFlags,exports.stripComment=stripComment,exports.preparePath=preparePath,exports.prepareMustache=prepareMustache,exports.prepareRawBlock=prepareRawBlock,exports.prepareBlock=prepareBlock,exports.prepareProgram=prepareProgram,exports.preparePartialBlock=preparePartialBlock;var _exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception);function validateClose(open,close){if(close=close.path?close.path.original:close,open.path.original!==close){var errorNode={loc:open.path.loc};throw new _exception2.default(open.path.original+" doesn't match "+close,errorNode)}}function SourceLocation(source,locInfo){this.source=source,this.start={line:locInfo.first_line,column:locInfo.first_column},this.end={line:locInfo.last_line,column:locInfo.last_column}}function id(token){return/^\[.*\]$/.test(token)?token.substr(1,token.length-2):token}function stripFlags(open,close){return{open:"~"===open.charAt(2),close:"~"===close.charAt(close.length-3)}}function stripComment(comment){return comment.replace(/^\{\{~?\!-?-?/,"").replace(/-?-?~?\}\}$/,"")}function preparePath(data,parts,loc){loc=this.locInfo(loc);for(var original=data?"@":"",dig=[],depth=0,depthString="",i=0,l=parts.length;i<l;i++){var part=parts[i].part,isLiteral=parts[i].original!==part;if(original+=(parts[i].separator||"")+part,isLiteral||".."!==part&&"."!==part&&"this"!==part)dig.push(part);else{if(dig.length>0)throw new _exception2.default("Invalid path: "+original,{loc:loc});".."===part&&(depth++,depthString+="../")}}return{type:"PathExpression",data:data,depth:depth,parts:dig,original:original,loc:loc}}function prepareMustache(path,params,hash,open,strip,locInfo){var escapeFlag=open.charAt(3)||open.charAt(2),escaped="{"!==escapeFlag&&"&"!==escapeFlag;return{type:/\*/.test(open)?"Decorator":"MustacheStatement",path:path,params:params,hash:hash,escaped:escaped,strip:strip,loc:this.locInfo(locInfo)}}function prepareRawBlock(openRawBlock,contents,close,locInfo){validateClose(openRawBlock,close),locInfo=this.locInfo(locInfo);var program={type:"Program",body:contents,strip:{},loc:locInfo};return{type:"BlockStatement",path:openRawBlock.path,params:openRawBlock.params,hash:openRawBlock.hash,program:program,openStrip:{},inverseStrip:{},closeStrip:{},loc:locInfo}}function prepareBlock(openBlock,program,inverseAndProgram,close,inverted,locInfo){close&&close.path&&validateClose(openBlock,close);var decorator=/\*/.test(openBlock.open);program.blockParams=openBlock.blockParams;var inverse=void 0,inverseStrip=void 0;if(inverseAndProgram){if(decorator)throw new _exception2.default("Unexpected inverse block on decorator",inverseAndProgram);inverseAndProgram.chain&&(inverseAndProgram.program.body[0].closeStrip=close.strip),inverseStrip=inverseAndProgram.strip,inverse=inverseAndProgram.program}return inverted&&(inverted=inverse,inverse=program,program=inverted),{type:decorator?"DecoratorBlock":"BlockStatement",path:openBlock.path,params:openBlock.params,hash:openBlock.hash,program:program,inverse:inverse,openStrip:openBlock.strip,inverseStrip:inverseStrip,closeStrip:close&&close.strip,loc:this.locInfo(locInfo)}}function prepareProgram(statements,loc){if(!loc&&statements.length){var firstLoc=statements[0].loc,lastLoc=statements[statements.length-1].loc;firstLoc&&lastLoc&&(loc={source:firstLoc.source,start:{line:firstLoc.start.line,column:firstLoc.start.column},end:{line:lastLoc.end.line,column:lastLoc.end.column}})}return{type:"Program",body:statements,strip:{},loc:loc}}function preparePartialBlock(open,program,close,locInfo){return validateClose(open,close),{type:"PartialBlockStatement",name:open.path,params:open.params,hash:open.hash,program:program,openStrip:open.strip,closeStrip:close&&close.strip,loc:this.locInfo(locInfo)}}},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0,exports.Compiler=Compiler,exports.precompile=precompile,exports.compile=compile;var _exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception),_utils=__webpack_require__(5),_ast=__webpack_require__(21),_ast2=_interopRequireDefault(_ast),slice=[].slice;function Compiler(){}Compiler.prototype={compiler:Compiler,equals:function(other){var len=this.opcodes.length;if(other.opcodes.length!==len)return!1;for(var i=0;i<len;i++){var opcode=this.opcodes[i],otherOpcode=other.opcodes[i];if(opcode.opcode!==otherOpcode.opcode||!argEquals(opcode.args,otherOpcode.args))return!1}len=this.children.length;for(var i=0;i<len;i++)if(!this.children[i].equals(other.children[i]))return!1;return!0},guid:0,compile:function(program,options){this.sourceNode=[],this.opcodes=[],this.children=[],this.options=options,this.stringParams=options.stringParams,this.trackIds=options.trackIds,options.blockParams=options.blockParams||[];var knownHelpers=options.knownHelpers;if(options.knownHelpers={helperMissing:!0,blockHelperMissing:!0,each:!0,if:!0,unless:!0,with:!0,log:!0,lookup:!0},knownHelpers)for(var _name in knownHelpers)_name in knownHelpers&&(options.knownHelpers[_name]=knownHelpers[_name]);return this.accept(program)},compileProgram:function(program){var childCompiler=new this.compiler,result=childCompiler.compile(program,this.options),guid=this.guid++;return this.usePartial=this.usePartial||result.usePartial,this.children[guid]=result,this.useDepths=this.useDepths||result.useDepths,guid},accept:function(node){if(!this[node.type])throw new _exception2.default("Unknown type: "+node.type,node);this.sourceNode.unshift(node);var ret=this[node.type](node);return this.sourceNode.shift(),ret},Program:function(program){this.options.blockParams.unshift(program.blockParams);for(var body=program.body,bodyLength=body.length,i=0;i<bodyLength;i++)this.accept(body[i]);return this.options.blockParams.shift(),this.isSimple=1===bodyLength,this.blockParams=program.blockParams?program.blockParams.length:0,this},BlockStatement:function(block){transformLiteralToPath(block);var program=block.program,inverse=block.inverse;program=program&&this.compileProgram(program),inverse=inverse&&this.compileProgram(inverse);var type=this.classifySexpr(block);"helper"===type?this.helperSexpr(block,program,inverse):"simple"===type?(this.simpleSexpr(block),this.opcode("pushProgram",program),this.opcode("pushProgram",inverse),this.opcode("emptyHash"),this.opcode("blockValue",block.path.original)):(this.ambiguousSexpr(block,program,inverse),this.opcode("pushProgram",program),this.opcode("pushProgram",inverse),this.opcode("emptyHash"),this.opcode("ambiguousBlockValue")),this.opcode("append")},DecoratorBlock:function(decorator){var program=decorator.program&&this.compileProgram(decorator.program),params=this.setupFullMustacheParams(decorator,program,void 0),path=decorator.path;this.useDecorators=!0,this.opcode("registerDecorator",params.length,path.original)},PartialStatement:function(partial){this.usePartial=!0;var program=partial.program;program&&(program=this.compileProgram(partial.program));var params=partial.params;if(params.length>1)throw new _exception2.default("Unsupported number of partial arguments: "+params.length,partial);params.length||(this.options.explicitPartialContext?this.opcode("pushLiteral","undefined"):params.push({type:"PathExpression",parts:[],depth:0}));var partialName=partial.name.original,isDynamic="SubExpression"===partial.name.type;isDynamic&&this.accept(partial.name),this.setupFullMustacheParams(partial,program,void 0,!0);var indent=partial.indent||"";this.options.preventIndent&&indent&&(this.opcode("appendContent",indent),indent=""),this.opcode("invokePartial",isDynamic,partialName,indent),this.opcode("append")},PartialBlockStatement:function(partialBlock){this.PartialStatement(partialBlock)},MustacheStatement:function(mustache){this.SubExpression(mustache),mustache.escaped&&!this.options.noEscape?this.opcode("appendEscaped"):this.opcode("append")},Decorator:function(decorator){this.DecoratorBlock(decorator)},ContentStatement:function(content){content.value&&this.opcode("appendContent",content.value)},CommentStatement:function(){},SubExpression:function(sexpr){transformLiteralToPath(sexpr);var type=this.classifySexpr(sexpr);"simple"===type?this.simpleSexpr(sexpr):"helper"===type?this.helperSexpr(sexpr):this.ambiguousSexpr(sexpr)},ambiguousSexpr:function(sexpr,program,inverse){var path=sexpr.path,name=path.parts[0],isBlock=null!=program||null!=inverse;this.opcode("getContext",path.depth),this.opcode("pushProgram",program),this.opcode("pushProgram",inverse),path.strict=!0,this.accept(path),this.opcode("invokeAmbiguous",name,isBlock)},simpleSexpr:function(sexpr){var path=sexpr.path;path.strict=!0,this.accept(path),this.opcode("resolvePossibleLambda")},helperSexpr:function(sexpr,program,inverse){var params=this.setupFullMustacheParams(sexpr,program,inverse),path=sexpr.path,name=path.parts[0];if(this.options.knownHelpers[name])this.opcode("invokeKnownHelper",params.length,name);else{if(this.options.knownHelpersOnly)throw new _exception2.default("You specified knownHelpersOnly, but used the unknown helper "+name,sexpr);path.strict=!0,path.falsy=!0,this.accept(path),this.opcode("invokeHelper",params.length,path.original,_ast2.default.helpers.simpleId(path))}},PathExpression:function(path){this.addDepth(path.depth),this.opcode("getContext",path.depth);var name=path.parts[0],scoped=_ast2.default.helpers.scopedId(path),blockParamId=!path.depth&&!scoped&&this.blockParamIndex(name);blockParamId?this.opcode("lookupBlockParam",blockParamId,path.parts):name?path.data?(this.options.data=!0,this.opcode("lookupData",path.depth,path.parts,path.strict)):this.opcode("lookupOnContext",path.parts,path.falsy,path.strict,scoped):this.opcode("pushContext")},StringLiteral:function(string){this.opcode("pushString",string.value)},NumberLiteral:function(number){this.opcode("pushLiteral",number.value)},BooleanLiteral:function(bool){this.opcode("pushLiteral",bool.value)},UndefinedLiteral:function(){this.opcode("pushLiteral","undefined")},NullLiteral:function(){this.opcode("pushLiteral","null")},Hash:function(hash){var pairs=hash.pairs,i=0,l=pairs.length;for(this.opcode("pushHash");i<l;i++)this.pushParam(pairs[i].value);for(;i--;)this.opcode("assignToHash",pairs[i].key);this.opcode("popHash")},opcode:function(name){this.opcodes.push({opcode:name,args:slice.call(arguments,1),loc:this.sourceNode[0].loc})},addDepth:function(depth){depth&&(this.useDepths=!0)},classifySexpr:function(sexpr){var isSimple=_ast2.default.helpers.simpleId(sexpr.path),isBlockParam=isSimple&&!!this.blockParamIndex(sexpr.path.parts[0]),isHelper=!isBlockParam&&_ast2.default.helpers.helperExpression(sexpr),isEligible=!isBlockParam&&(isHelper||isSimple);if(isEligible&&!isHelper){var _name2=sexpr.path.parts[0],options=this.options;options.knownHelpers[_name2]?isHelper=!0:options.knownHelpersOnly&&(isEligible=!1)}return isHelper?"helper":isEligible?"ambiguous":"simple"},pushParams:function(params){for(var i=0,l=params.length;i<l;i++)this.pushParam(params[i])},pushParam:function(val){var value=null!=val.value?val.value:val.original||"";if(this.stringParams)value.replace&&(value=value.replace(/^(\.?\.\/)*/g,"").replace(/\//g,".")),val.depth&&this.addDepth(val.depth),this.opcode("getContext",val.depth||0),this.opcode("pushStringParam",value,val.type),"SubExpression"===val.type&&this.accept(val);else{if(this.trackIds){var blockParamIndex=void 0;if(!val.parts||_ast2.default.helpers.scopedId(val)||val.depth||(blockParamIndex=this.blockParamIndex(val.parts[0])),blockParamIndex){var blockParamChild=val.parts.slice(1).join(".");this.opcode("pushId","BlockParam",blockParamIndex,blockParamChild)}else value=val.original||value,value.replace&&(value=value.replace(/^this(?:\.|$)/,"").replace(/^\.\//,"").replace(/^\.$/,"")),this.opcode("pushId",val.type,value)}this.accept(val)}},setupFullMustacheParams:function(sexpr,program,inverse,omitEmpty){var params=sexpr.params;return this.pushParams(params),this.opcode("pushProgram",program),this.opcode("pushProgram",inverse),sexpr.hash?this.accept(sexpr.hash):this.opcode("emptyHash",omitEmpty),params},blockParamIndex:function(name){for(var depth=0,len=this.options.blockParams.length;depth<len;depth++){var blockParams=this.options.blockParams[depth],param=blockParams&&_utils.indexOf(blockParams,name);if(blockParams&&param>=0)return[depth,param]}}};function precompile(input,options,env){if(null==input||"string"!=typeof input&&"Program"!==input.type)throw new _exception2.default("You must pass a string or Handlebars AST to Handlebars.precompile. You passed "+input);options=options||{},"data"in options||(options.data=!0),options.compat&&(options.useDepths=!0);var ast=env.parse(input,options),environment=(new env.Compiler).compile(ast,options);return(new env.JavaScriptCompiler).compile(environment,options)}function compile(input,options,env){if(void 0===options&&(options={}),null==input||"string"!=typeof input&&"Program"!==input.type)throw new _exception2.default("You must pass a string or Handlebars AST to Handlebars.compile. You passed "+input);"data"in options||(options.data=!0),options.compat&&(options.useDepths=!0);var compiled=void 0;function compileInput(){var ast=env.parse(input,options),environment=(new env.Compiler).compile(ast,options),templateSpec=(new env.JavaScriptCompiler).compile(environment,options,void 0,!0);return env.template(templateSpec)}function ret(context,execOptions){return compiled||(compiled=compileInput()),compiled.call(this,context,execOptions)}return ret._setup=function(setupOptions){return compiled||(compiled=compileInput()),compiled._setup(setupOptions)},ret._child=function(i,data,blockParams,depths){return compiled||(compiled=compileInput()),compiled._child(i,data,blockParams,depths)},ret}function argEquals(a,b){if(a===b)return!0;if(_utils.isArray(a)&&_utils.isArray(b)&&a.length===b.length){for(var i=0;i<a.length;i++)if(!argEquals(a[i],b[i]))return!1;return!0}}function transformLiteralToPath(sexpr){if(!sexpr.path.parts){var literal=sexpr.path;sexpr.path={type:"PathExpression",data:!1,depth:0,parts:[literal.original+""],original:literal.original+"",loc:literal.loc}}}},function(module,exports,__webpack_require__){"use strict";var _interopRequireDefault=__webpack_require__(1).default;exports.__esModule=!0;var _base=__webpack_require__(4),_exception=__webpack_require__(6),_exception2=_interopRequireDefault(_exception),_utils=__webpack_require__(5),_codeGen=__webpack_require__(29),_codeGen2=_interopRequireDefault(_codeGen);function Literal(value){this.value=value}function JavaScriptCompiler(){}JavaScriptCompiler.prototype={nameLookup:function(parent,name){return JavaScriptCompiler.isValidJavaScriptVariableName(name)?[parent,".",name]:[parent,"[",JSON.stringify(name),"]"]},depthedLookup:function(name){return[this.aliasable("container.lookup"),'(depths, "',name,'")']},compilerInfo:function(){var revision=_base.COMPILER_REVISION;return[revision,_base.REVISION_CHANGES[revision]]},appendToBuffer:function(source,location,explicit){return _utils.isArray(source)||(source=[source]),source=this.source.wrap(source,location),this.environment.isSimple?["return ",source,";"]:explicit?["buffer += ",source,";"]:(source.appendToBuffer=!0,source)},initializeBuffer:function(){return this.quotedString("")},compile:function(environment,options,context,asObject){this.environment=environment,this.options=options,this.stringParams=this.options.stringParams,this.trackIds=this.options.trackIds,this.precompile=!asObject,this.name=this.environment.name,this.isChild=!!context,this.context=context||{decorators:[],programs:[],environments:[]},this.preamble(),this.stackSlot=0,this.stackVars=[],this.aliases={},this.registers={list:[]},this.hashes=[],this.compileStack=[],this.inlineStack=[],this.blockParams=[],this.compileChildren(environment,options),this.useDepths=this.useDepths||environment.useDepths||environment.useDecorators||this.options.compat,this.useBlockParams=this.useBlockParams||environment.useBlockParams;var opcodes=environment.opcodes,opcode=void 0,firstLoc=void 0,i=void 0,l=void 0;for(i=0,l=opcodes.length;i<l;i++)opcode=opcodes[i],this.source.currentLocation=opcode.loc,firstLoc=firstLoc||opcode.loc,this[opcode.opcode].apply(this,opcode.args);if(this.source.currentLocation=firstLoc,this.pushSource(""),this.stackSlot||this.inlineStack.length||this.compileStack.length)throw new _exception2.default("Compile completed with content left on stack");this.decorators.isEmpty()?this.decorators=void 0:(this.useDecorators=!0,this.decorators.prepend("var decorators = container.decorators;\n"),this.decorators.push("return fn;"),asObject?this.decorators=Function.apply(this,["fn","props","container","depth0","data","blockParams","depths",this.decorators.merge()]):(this.decorators.prepend("function(fn, props, container, depth0, data, blockParams, depths) {\n"),this.decorators.push("}\n"),this.decorators=this.decorators.merge()));var fn=this.createFunctionContext(asObject);if(this.isChild)return fn;var ret={compiler:this.compilerInfo(),main:fn};this.decorators&&(ret.main_d=this.decorators,ret.useDecorators=!0);var _context=this.context,programs=_context.programs,decorators=_context.decorators;for(i=0,l=programs.length;i<l;i++)programs[i]&&(ret[i]=programs[i],decorators[i]&&(ret[i+"_d"]=decorators[i],ret.useDecorators=!0));return this.environment.usePartial&&(ret.usePartial=!0),this.options.data&&(ret.useData=!0),this.useDepths&&(ret.useDepths=!0),this.useBlockParams&&(ret.useBlockParams=!0),this.options.compat&&(ret.compat=!0),asObject?ret.compilerOptions=this.options:(ret.compiler=JSON.stringify(ret.compiler),this.source.currentLocation={start:{line:1,column:0}},ret=this.objectLiteral(ret),options.srcName?(ret=ret.toStringWithSourceMap({file:options.destName}),ret.map=ret.map&&ret.map.toString()):ret=ret.toString()),ret},preamble:function(){this.lastContext=0,this.source=new _codeGen2.default(this.options.srcName),this.decorators=new _codeGen2.default(this.options.srcName)},createFunctionContext:function(asObject){var varDeclarations="",locals=this.stackVars.concat(this.registers.list);locals.length>0&&(varDeclarations+=", "+locals.join(", "));var aliasCount=0;for(var alias in this.aliases){var node=this.aliases[alias];this.aliases.hasOwnProperty(alias)&&node.children&&node.referenceCount>1&&(varDeclarations+=", alias"+ ++aliasCount+"="+alias,node.children[0]="alias"+aliasCount)}var params=["container","depth0","helpers","partials","data"];(this.useBlockParams||this.useDepths)&&params.push("blockParams"),this.useDepths&&params.push("depths");var source=this.mergeSource(varDeclarations);return asObject?(params.push(source),Function.apply(this,params)):this.source.wrap(["function(",params.join(","),") {\n  ",source,"}"])},mergeSource:function(varDeclarations){var isSimple=this.environment.isSimple,appendOnly=!this.forceBuffer,appendFirst=void 0,sourceSeen=void 0,bufferStart=void 0,bufferEnd=void 0;return this.source.each(function(line){line.appendToBuffer?(bufferStart?line.prepend("  + "):bufferStart=line,bufferEnd=line):(bufferStart&&(sourceSeen?bufferStart.prepend("buffer += "):appendFirst=!0,bufferEnd.add(";"),bufferStart=bufferEnd=void 0),sourceSeen=!0,isSimple||(appendOnly=!1))}),appendOnly?bufferStart?(bufferStart.prepend("return "),bufferEnd.add(";")):sourceSeen||this.source.push('return "";'):(varDeclarations+=", buffer = "+(appendFirst?"":this.initializeBuffer()),bufferStart?(bufferStart.prepend("return buffer + "),bufferEnd.add(";")):this.source.push("return buffer;")),varDeclarations&&this.source.prepend("var "+varDeclarations.substring(2)+(appendFirst?"":";\n")),this.source.merge()},blockValue:function(name){var blockHelperMissing=this.aliasable("helpers.blockHelperMissing"),params=[this.contextName(0)];this.setupHelperArgs(name,0,params);var blockName=this.popStack();params.splice(1,0,blockName),this.push(this.source.functionCall(blockHelperMissing,"call",params))},ambiguousBlockValue:function(){var blockHelperMissing=this.aliasable("helpers.blockHelperMissing"),params=[this.contextName(0)];this.setupHelperArgs("",0,params,!0),this.flushInline();var current=this.topStack();params.splice(1,0,current),this.pushSource(["if (!",this.lastHelper,") { ",current," = ",this.source.functionCall(blockHelperMissing,"call",params),"}"])},appendContent:function(content){this.pendingContent?content=this.pendingContent+content:this.pendingLocation=this.source.currentLocation,this.pendingContent=content},append:function(){if(this.isInline())this.replaceStack(function(current){return[" != null ? ",current,' : ""']}),this.pushSource(this.appendToBuffer(this.popStack()));else{var local=this.popStack();this.pushSource(["if (",local," != null) { ",this.appendToBuffer(local,void 0,!0)," }"]),this.environment.isSimple&&this.pushSource(["else { ",this.appendToBuffer("''",void 0,!0)," }"])}},appendEscaped:function(){this.pushSource(this.appendToBuffer([this.aliasable("container.escapeExpression"),"(",this.popStack(),")"]))},getContext:function(depth){this.lastContext=depth},pushContext:function(){this.pushStackLiteral(this.contextName(this.lastContext))},lookupOnContext:function(parts,falsy,strict,scoped){var i=0;scoped||!this.options.compat||this.lastContext?this.pushContext():this.push(this.depthedLookup(parts[i++])),this.resolvePath("context",parts,i,falsy,strict)},lookupBlockParam:function(blockParamId,parts){this.useBlockParams=!0,this.push(["blockParams[",blockParamId[0],"][",blockParamId[1],"]"]),this.resolvePath("context",parts,1)},lookupData:function(depth,parts,strict){depth?this.pushStackLiteral("container.data(data, "+depth+")"):this.pushStackLiteral("data"),this.resolvePath("data",parts,0,!0,strict)},resolvePath:function(type,parts,i,falsy,strict){var _this=this;if(this.options.strict||this.options.assumeObjects)return void this.push(strictLookup(this.options.strict&&strict,this,parts,type));for(var len=parts.length;i<len;i++)this.replaceStack(function(current){var lookup=_this.nameLookup(current,parts[i],type);return falsy?[" && ",lookup]:[" != null ? ",lookup," : ",current]})},resolvePossibleLambda:function(){this.push([this.aliasable("container.lambda"),"(",this.popStack(),", ",this.contextName(0),")"])},pushStringParam:function(string,type){this.pushContext(),this.pushString(type),"SubExpression"!==type&&("string"==typeof string?this.pushString(string):this.pushStackLiteral(string))},emptyHash:function(omitEmpty){this.trackIds&&this.push("{}"),this.stringParams&&(this.push("{}"),this.push("{}")),this.pushStackLiteral(omitEmpty?"undefined":"{}")},pushHash:function(){this.hash&&this.hashes.push(this.hash),this.hash={values:[],types:[],contexts:[],ids:[]}},popHash:function(){var hash=this.hash;this.hash=this.hashes.pop(),this.trackIds&&this.push(this.objectLiteral(hash.ids)),this.stringParams&&(this.push(this.objectLiteral(hash.contexts)),this.push(this.objectLiteral(hash.types))),this.push(this.objectLiteral(hash.values))},pushString:function(string){this.pushStackLiteral(this.quotedString(string))},pushLiteral:function(value){this.pushStackLiteral(value)},pushProgram:function(guid){null!=guid?this.pushStackLiteral(this.programExpression(guid)):this.pushStackLiteral(null)},registerDecorator:function(paramSize,name){var foundDecorator=this.nameLookup("decorators",name,"decorator"),options=this.setupHelperArgs(name,paramSize);this.decorators.push(["fn = ",this.decorators.functionCall(foundDecorator,"",["fn","props","container",options])," || fn;"])},invokeHelper:function(paramSize,name,isSimple){var nonHelper=this.popStack(),helper=this.setupHelper(paramSize,name),simple=isSimple?[helper.name," || "]:"",lookup=["("].concat(simple,nonHelper);this.options.strict||lookup.push(" || ",this.aliasable("helpers.helperMissing")),lookup.push(")"),this.push(this.source.functionCall(lookup,"call",helper.callParams))},invokeKnownHelper:function(paramSize,name){var helper=this.setupHelper(paramSize,name);this.push(this.source.functionCall(helper.name,"call",helper.callParams))},invokeAmbiguous:function(name,helperCall){this.useRegister("helper");var nonHelper=this.popStack();this.emptyHash();var helper=this.setupHelper(0,name,helperCall),helperName=this.lastHelper=this.nameLookup("helpers",name,"helper"),lookup=["(","(helper = ",helperName," || ",nonHelper,")"];this.options.strict||(lookup[0]="(helper = ",lookup.push(" != null ? helper : ",this.aliasable("helpers.helperMissing"))),this.push(["(",lookup,helper.paramsInit?["),(",helper.paramsInit]:[],"),","(typeof helper === ",this.aliasable('"function"')," ? ",this.source.functionCall("helper","call",helper.callParams)," : helper))"])},invokePartial:function(isDynamic,name,indent){var params=[],options=this.setupParams(name,1,params);isDynamic&&(name=this.popStack(),delete options.name),indent&&(options.indent=JSON.stringify(indent)),options.helpers="helpers",options.partials="partials",options.decorators="container.decorators",isDynamic?params.unshift(name):params.unshift(this.nameLookup("partials",name,"partial")),this.options.compat&&(options.depths="depths"),options=this.objectLiteral(options),params.push(options),this.push(this.source.functionCall("container.invokePartial","",params))},assignToHash:function(key){var value=this.popStack(),context=void 0,type=void 0,id=void 0;this.trackIds&&(id=this.popStack()),this.stringParams&&(type=this.popStack(),context=this.popStack());var hash=this.hash;context&&(hash.contexts[key]=context),type&&(hash.types[key]=type),id&&(hash.ids[key]=id),hash.values[key]=value},pushId:function(type,name,child){"BlockParam"===type?this.pushStackLiteral("blockParams["+name[0]+"].path["+name[1]+"]"+(child?" + "+JSON.stringify("."+child):"")):"PathExpression"===type?this.pushString(name):"SubExpression"===type?this.pushStackLiteral("true"):this.pushStackLiteral("null")},compiler:JavaScriptCompiler,compileChildren:function(environment,options){for(var children=environment.children,child=void 0,compiler=void 0,i=0,l=children.length;i<l;i++){child=children[i],compiler=new this.compiler;var index=this.matchExistingProgram(child);null==index?(this.context.programs.push(""),index=this.context.programs.length,child.index=index,child.name="program"+index,this.context.programs[index]=compiler.compile(child,options,this.context,!this.precompile),this.context.decorators[index]=compiler.decorators,this.context.environments[index]=child,this.useDepths=this.useDepths||compiler.useDepths,this.useBlockParams=this.useBlockParams||compiler.useBlockParams):(child.index=index,child.name="program"+index,this.useDepths=this.useDepths||child.useDepths,this.useBlockParams=this.useBlockParams||child.useBlockParams)}},matchExistingProgram:function(child){for(var i=0,len=this.context.environments.length;i<len;i++){var environment=this.context.environments[i];if(environment&&environment.equals(child))return i}},programExpression:function(guid){var child=this.environment.children[guid],programParams=[child.index,"data",child.blockParams];return(this.useBlockParams||this.useDepths)&&programParams.push("blockParams"),this.useDepths&&programParams.push("depths"),"container.program("+programParams.join(", ")+")"},useRegister:function(name){this.registers[name]||(this.registers[name]=!0,this.registers.list.push(name))},push:function(expr){return expr instanceof Literal||(expr=this.source.wrap(expr)),this.inlineStack.push(expr),expr},pushStackLiteral:function(item){this.push(new Literal(item))},pushSource:function(source){this.pendingContent&&(this.source.push(this.appendToBuffer(this.source.quotedString(this.pendingContent),this.pendingLocation)),this.pendingContent=void 0),source&&this.source.push(source)},replaceStack:function(callback){var prefix=["("],stack=void 0,createdStack=void 0,usedLiteral=void 0;if(!this.isInline())throw new _exception2.default("replaceStack on non-inline");var top=this.popStack(!0);if(top instanceof Literal)stack=[top.value],prefix=["(",stack],usedLiteral=!0;else{createdStack=!0;var _name=this.incrStack();prefix=["((",this.push(_name)," = ",top,")"],stack=this.topStack()}var item=callback.call(this,stack);usedLiteral||this.popStack(),createdStack&&this.stackSlot--,this.push(prefix.concat(item,")"))},incrStack:function(){return this.stackSlot++,this.stackSlot>this.stackVars.length&&this.stackVars.push("stack"+this.stackSlot),this.topStackName()},topStackName:function(){return"stack"+this.stackSlot},flushInline:function(){var inlineStack=this.inlineStack;this.inlineStack=[];for(var i=0,len=inlineStack.length;i<len;i++){var entry=inlineStack[i];if(entry instanceof Literal)this.compileStack.push(entry);else{var stack=this.incrStack();this.pushSource([stack," = ",entry,";"]),this.compileStack.push(stack)}}},isInline:function(){return this.inlineStack.length},popStack:function(wrapped){var inline=this.isInline(),item=(inline?this.inlineStack:this.compileStack).pop();if(!wrapped&&item instanceof Literal)return item.value;if(!inline){if(!this.stackSlot)throw new _exception2.default("Invalid stack pop");this.stackSlot--}return item},topStack:function(){var stack=this.isInline()?this.inlineStack:this.compileStack,item=stack[stack.length-1];return item instanceof Literal?item.value:item},contextName:function(context){return this.useDepths&&context?"depths["+context+"]":"depth"+context},quotedString:function(str){return this.source.quotedString(str)},objectLiteral:function(obj){return this.source.objectLiteral(obj)},aliasable:function(name){var ret=this.aliases[name];return ret?(ret.referenceCount++,ret):(ret=this.aliases[name]=this.source.wrap(name),ret.aliasable=!0,ret.referenceCount=1,ret)},setupHelper:function(paramSize,name,blockHelper){var params=[];return{params:params,paramsInit:this.setupHelperArgs(name,paramSize,params,blockHelper),name:this.nameLookup("helpers",name,"helper"),callParams:[this.aliasable(this.contextName(0)+" != null ? "+this.contextName(0)+" : {}")].concat(params)}},setupParams:function(helper,paramSize,params){var options={},contexts=[],types=[],ids=[],objectArgs=!params,param=void 0;objectArgs&&(params=[]),options.name=this.quotedString(helper),options.hash=this.popStack(),this.trackIds&&(options.hashIds=this.popStack()),this.stringParams&&(options.hashTypes=this.popStack(),options.hashContexts=this.popStack());var inverse=this.popStack(),program=this.popStack();(program||inverse)&&(options.fn=program||"container.noop",options.inverse=inverse||"container.noop");for(var i=paramSize;i--;)param=this.popStack(),params[i]=param,this.trackIds&&(ids[i]=this.popStack()),this.stringParams&&(types[i]=this.popStack(),contexts[i]=this.popStack());return objectArgs&&(options.args=this.source.generateArray(params)),this.trackIds&&(options.ids=this.source.generateArray(ids)),this.stringParams&&(options.types=this.source.generateArray(types),options.contexts=this.source.generateArray(contexts)),this.options.data&&(options.data="data"),this.useBlockParams&&(options.blockParams="blockParams"),options},setupHelperArgs:function(helper,paramSize,params,useRegister){var options=this.setupParams(helper,paramSize,params);return options=this.objectLiteral(options),useRegister?(this.useRegister("options"),params.push("options"),["options=",options]):params?(params.push(options),""):options}},function(){
for(var reservedWords="break else new var case finally return void catch for switch while continue function this with default if throw delete in try do instanceof typeof abstract enum int short boolean export interface static byte extends long super char final native synchronized class float package throws const goto private transient debugger implements protected volatile double import public let yield await null true false".split(" "),compilerWords=JavaScriptCompiler.RESERVED_WORDS={},i=0,l=reservedWords.length;i<l;i++)compilerWords[reservedWords[i]]=!0}(),JavaScriptCompiler.isValidJavaScriptVariableName=function(name){return!JavaScriptCompiler.RESERVED_WORDS[name]&&/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(name)};function strictLookup(requireTerminal,compiler,parts,type){var stack=compiler.popStack(),i=0,len=parts.length;for(requireTerminal&&len--;i<len;i++)stack=compiler.nameLookup(stack,parts[i],type);return requireTerminal?[compiler.aliasable("container.strict"),"(",stack,", ",compiler.quotedString(parts[i]),")"]:stack}exports.default=JavaScriptCompiler,module.exports=exports.default},function(module,exports,__webpack_require__){"use strict";exports.__esModule=!0;var _utils=__webpack_require__(5),SourceNode=void 0;try{}catch(err){}SourceNode||(SourceNode=function(line,column,srcFile,chunks){this.src="",chunks&&this.add(chunks)},SourceNode.prototype={add:function(chunks){_utils.isArray(chunks)&&(chunks=chunks.join("")),this.src+=chunks},prepend:function(chunks){_utils.isArray(chunks)&&(chunks=chunks.join("")),this.src=chunks+this.src},toStringWithSourceMap:function(){return{code:this.toString()}},toString:function(){return this.src}});function castChunk(chunk,codeGen,loc){if(_utils.isArray(chunk)){for(var ret=[],i=0,len=chunk.length;i<len;i++)ret.push(codeGen.wrap(chunk[i],loc));return ret}return"boolean"==typeof chunk||"number"==typeof chunk?chunk+"":chunk}function CodeGen(srcFile){this.srcFile=srcFile,this.source=[]}CodeGen.prototype={isEmpty:function(){return!this.source.length},prepend:function(source,loc){this.source.unshift(this.wrap(source,loc))},push:function(source,loc){this.source.push(this.wrap(source,loc))},merge:function(){var source=this.empty();return this.each(function(line){source.add(["  ",line,"\n"])}),source},each:function(iter){for(var i=0,len=this.source.length;i<len;i++)iter(this.source[i])},empty:function(){var loc=this.currentLocation||{start:{}};return new SourceNode(loc.start.line,loc.start.column,this.srcFile)},wrap:function(chunk){var loc=arguments.length<=1||void 0===arguments[1]?this.currentLocation||{start:{}}:arguments[1];return chunk instanceof SourceNode?chunk:(chunk=castChunk(chunk,this,loc),new SourceNode(loc.start.line,loc.start.column,this.srcFile,chunk))},functionCall:function(fn,type,params){return params=this.generateList(params),this.wrap([fn,type?"."+type+"(":"(",params,")"])},quotedString:function(str){return'"'+(str+"").replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")+'"'},objectLiteral:function(obj){var pairs=[];for(var key in obj)if(obj.hasOwnProperty(key)){var value=castChunk(obj[key],this);"undefined"!==value&&pairs.push([this.quotedString(key),":",value])}var ret=this.generateList(pairs);return ret.prepend("{"),ret.add("}"),ret},generateList:function(entries){for(var ret=this.empty(),i=0,len=entries.length;i<len;i++)i&&ret.add(","),ret.add(castChunk(entries[i],this));return ret},generateArray:function(entries){var ret=this.generateList(entries);return ret.prepend("["),ret.add("]"),ret}},exports.default=CodeGen,module.exports=exports.default}])}),function(){"use strict";var HowlerGlobal=function(){this.init()};HowlerGlobal.prototype={init:function(){var self=this||Howler;return self._counter=1e3,self._html5AudioPool=[],self.html5PoolSize=10,self._codecs={},self._howls=[],self._muted=!1,self._volume=1,self._canPlayEvent="canplaythrough",self._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,self.masterGain=null,self.noAudio=!1,self.usingWebAudio=!0,self.autoSuspend=!0,self.ctx=null,self.autoUnlock=!0,self._setup(),self},volume:function(vol){var self=this||Howler;if(vol=parseFloat(vol),self.ctx||setupAudioContext(),void 0!==vol&&vol>=0&&vol<=1){if(self._volume=vol,self._muted)return self;self.usingWebAudio&&self.masterGain.gain.setValueAtTime(vol,Howler.ctx.currentTime);for(var i=0;i<self._howls.length;i++)if(!self._howls[i]._webAudio)for(var ids=self._howls[i]._getSoundIds(),j=0;j<ids.length;j++){var sound=self._howls[i]._soundById(ids[j]);sound&&sound._node&&(sound._node.volume=sound._volume*vol)}return self}return self._volume},mute:function(muted){var self=this||Howler;self.ctx||setupAudioContext(),self._muted=muted,self.usingWebAudio&&self.masterGain.gain.setValueAtTime(muted?0:self._volume,Howler.ctx.currentTime);for(var i=0;i<self._howls.length;i++)if(!self._howls[i]._webAudio)for(var ids=self._howls[i]._getSoundIds(),j=0;j<ids.length;j++){var sound=self._howls[i]._soundById(ids[j]);sound&&sound._node&&(sound._node.muted=!!muted||sound._muted)}return self},stop:function(){for(var self=this||Howler,i=0;i<self._howls.length;i++)self._howls[i].stop();return self},unload:function(){for(var self=this||Howler,i=self._howls.length-1;i>=0;i--)self._howls[i].unload();return self.usingWebAudio&&self.ctx&&void 0!==self.ctx.close&&(self.ctx.close(),self.ctx=null,setupAudioContext()),self},codecs:function(ext){return(this||Howler)._codecs[ext.replace(/^x-/,"")]},_setup:function(){var self=this||Howler;if(self.state=self.ctx?self.ctx.state||"suspended":"suspended",self._autoSuspend(),!self.usingWebAudio)if("undefined"!=typeof Audio)try{var test=new Audio;void 0===test.oncanplaythrough&&(self._canPlayEvent="canplay")}catch(e){self.noAudio=!0}else self.noAudio=!0;try{var test=new Audio;test.muted&&(self.noAudio=!0)}catch(e){}return self.noAudio||self._setupCodecs(),self},_setupCodecs:function(){var self=this||Howler,audioTest=null;try{audioTest="undefined"!=typeof Audio?new Audio:null}catch(err){return self}if(!audioTest||"function"!=typeof audioTest.canPlayType)return self;var mpegTest=audioTest.canPlayType("audio/mpeg;").replace(/^no$/,""),checkOpera=self._navigator&&self._navigator.userAgent.match(/OPR\/([0-6].)/g),isOldOpera=checkOpera&&parseInt(checkOpera[0].split("/")[1],10)<33;return self._codecs={mp3:!(isOldOpera||!mpegTest&&!audioTest.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!mpegTest,opus:!!audioTest.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!audioTest.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!audioTest.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(audioTest.canPlayType('audio/wav; codecs="1"')||audioTest.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!audioTest.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!audioTest.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(audioTest.canPlayType("audio/x-m4a;")||audioTest.canPlayType("audio/m4a;")||audioTest.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(audioTest.canPlayType("audio/x-m4b;")||audioTest.canPlayType("audio/m4b;")||audioTest.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(audioTest.canPlayType("audio/x-mp4;")||audioTest.canPlayType("audio/mp4;")||audioTest.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!audioTest.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!audioTest.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),dolby:!!audioTest.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(audioTest.canPlayType("audio/x-flac;")||audioTest.canPlayType("audio/flac;")).replace(/^no$/,"")},self},_unlockAudio:function(){var self=this||Howler;if(!self._audioUnlocked&&self.ctx){self._audioUnlocked=!1,self.autoUnlock=!1,self._mobileUnloaded||44100===self.ctx.sampleRate||(self._mobileUnloaded=!0,self.unload()),self._scratchBuffer=self.ctx.createBuffer(1,1,22050);var unlock=function(e){for(;self._html5AudioPool.length<self.html5PoolSize;)try{var audioNode=new Audio;audioNode._unlocked=!0,self._releaseHtml5Audio(audioNode)}catch(e){self.noAudio=!0;break}for(var i=0;i<self._howls.length;i++)if(!self._howls[i]._webAudio)for(var ids=self._howls[i]._getSoundIds(),j=0;j<ids.length;j++){var sound=self._howls[i]._soundById(ids[j]);sound&&sound._node&&!sound._node._unlocked&&(sound._node._unlocked=!0,sound._node.load())}self._autoResume();var source=self.ctx.createBufferSource();source.buffer=self._scratchBuffer,source.connect(self.ctx.destination),void 0===source.start?source.noteOn(0):source.start(0),"function"==typeof self.ctx.resume&&self.ctx.resume(),source.onended=function(){source.disconnect(0),self._audioUnlocked=!0,document.removeEventListener("touchstart",unlock,!0),document.removeEventListener("touchend",unlock,!0),document.removeEventListener("click",unlock,!0);for(var i=0;i<self._howls.length;i++)self._howls[i]._emit("unlock")}};return document.addEventListener("touchstart",unlock,!0),document.addEventListener("touchend",unlock,!0),document.addEventListener("click",unlock,!0),self}},_obtainHtml5Audio:function(){var self=this||Howler;if(self._html5AudioPool.length)return self._html5AudioPool.pop();var testPlay=(new Audio).play();return testPlay&&"undefined"!=typeof Promise&&(testPlay instanceof Promise||"function"==typeof testPlay.then)&&testPlay.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(audio){var self=this||Howler;return audio._unlocked&&self._html5AudioPool.push(audio),self},_autoSuspend:function(){var self=this;if(self.autoSuspend&&self.ctx&&void 0!==self.ctx.suspend&&Howler.usingWebAudio){for(var i=0;i<self._howls.length;i++)if(self._howls[i]._webAudio)for(var j=0;j<self._howls[i]._sounds.length;j++)if(!self._howls[i]._sounds[j]._paused)return self;return self._suspendTimer&&clearTimeout(self._suspendTimer),self._suspendTimer=setTimeout(function(){if(self.autoSuspend){self._suspendTimer=null,self.state="suspending";var handleSuspension=function(){self.state="suspended",self._resumeAfterSuspend&&(delete self._resumeAfterSuspend,self._autoResume())};self.ctx.suspend().then(handleSuspension,handleSuspension)}},3e4),self}},_autoResume:function(){var self=this;if(self.ctx&&void 0!==self.ctx.resume&&Howler.usingWebAudio)return"running"===self.state&&"interrupted"!==self.ctx.state&&self._suspendTimer?(clearTimeout(self._suspendTimer),self._suspendTimer=null):"suspended"===self.state||"running"===self.state&&"interrupted"===self.ctx.state?(self.ctx.resume().then(function(){self.state="running";for(var i=0;i<self._howls.length;i++)self._howls[i]._emit("resume")}),self._suspendTimer&&(clearTimeout(self._suspendTimer),self._suspendTimer=null)):"suspending"===self.state&&(self._resumeAfterSuspend=!0),self}};var Howler=new HowlerGlobal,Howl=function(o){var self=this;if(!o.src||0===o.src.length)return void console.error("An array of source files must be passed with any new Howl.");self.init(o)};Howl.prototype={init:function(o){var self=this;return Howler.ctx||setupAudioContext(),self._autoplay=o.autoplay||!1,self._format="string"!=typeof o.format?o.format:[o.format],self._html5=o.html5||!1,self._muted=o.mute||!1,self._loop=o.loop||!1,self._pool=o.pool||5,self._preload="boolean"!=typeof o.preload&&"metadata"!==o.preload||o.preload,self._rate=o.rate||1,self._sprite=o.sprite||{},self._src="string"!=typeof o.src?o.src:[o.src],self._volume=void 0!==o.volume?o.volume:1,self._xhr={method:o.xhr&&o.xhr.method?o.xhr.method:"GET",headers:o.xhr&&o.xhr.headers?o.xhr.headers:null,withCredentials:!(!o.xhr||!o.xhr.withCredentials)&&o.xhr.withCredentials},self._duration=0,self._state="unloaded",self._sounds=[],self._endTimers={},self._queue=[],self._playLock=!1,self._onend=o.onend?[{fn:o.onend}]:[],self._onfade=o.onfade?[{fn:o.onfade}]:[],self._onload=o.onload?[{fn:o.onload}]:[],self._onloaderror=o.onloaderror?[{fn:o.onloaderror}]:[],self._onplayerror=o.onplayerror?[{fn:o.onplayerror}]:[],self._onpause=o.onpause?[{fn:o.onpause}]:[],self._onplay=o.onplay?[{fn:o.onplay}]:[],self._onstop=o.onstop?[{fn:o.onstop}]:[],self._onmute=o.onmute?[{fn:o.onmute}]:[],self._onvolume=o.onvolume?[{fn:o.onvolume}]:[],self._onrate=o.onrate?[{fn:o.onrate}]:[],self._onseek=o.onseek?[{fn:o.onseek}]:[],self._onunlock=o.onunlock?[{fn:o.onunlock}]:[],self._onresume=[],self._webAudio=Howler.usingWebAudio&&!self._html5,void 0!==Howler.ctx&&Howler.ctx&&Howler.autoUnlock&&Howler._unlockAudio(),Howler._howls.push(self),self._autoplay&&self._queue.push({event:"play",action:function(){self.play()}}),self._preload&&"none"!==self._preload&&self.load(),self},load:function(){var self=this,url=null;if(Howler.noAudio)return void self._emit("loaderror",null,"No audio support.");"string"==typeof self._src&&(self._src=[self._src]);for(var i=0;i<self._src.length;i++){var ext,str;if(self._format&&self._format[i])ext=self._format[i];else{if("string"!=typeof(str=self._src[i])){self._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}ext=/^data:audio\/([^;,]+);/i.exec(str),ext||(ext=/\.([^.]+)$/.exec(str.split("?",1)[0])),ext&&(ext=ext[1].toLowerCase())}if(ext||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),ext&&Howler.codecs(ext)){url=self._src[i];break}}return url?(self._src=url,self._state="loading","https:"===window.location.protocol&&"http:"===url.slice(0,5)&&(self._html5=!0,self._webAudio=!1),new Sound(self),self._webAudio&&loadBuffer(self),self):void self._emit("loaderror",null,"No codec support for selected audio sources.")},play:function(sprite,internal){var self=this,id=null;if("number"==typeof sprite)id=sprite,sprite=null;else{if("string"==typeof sprite&&"loaded"===self._state&&!self._sprite[sprite])return null;if(void 0===sprite&&(sprite="__default",!self._playLock)){for(var num=0,i=0;i<self._sounds.length;i++)self._sounds[i]._paused&&!self._sounds[i]._ended&&(num++,id=self._sounds[i]._id);1===num?sprite=null:id=null}}var sound=id?self._soundById(id):self._inactiveSound();if(!sound)return null;if(id&&!sprite&&(sprite=sound._sprite||"__default"),"loaded"!==self._state){sound._sprite=sprite,sound._ended=!1;var soundId=sound._id;return self._queue.push({event:"play",action:function(){self.play(soundId)}}),soundId}if(id&&!sound._paused)return internal||self._loadQueue("play"),sound._id;self._webAudio&&Howler._autoResume();var seek=Math.max(0,sound._seek>0?sound._seek:self._sprite[sprite][0]/1e3),duration=Math.max(0,(self._sprite[sprite][0]+self._sprite[sprite][1])/1e3-seek),timeout=1e3*duration/Math.abs(sound._rate),start=self._sprite[sprite][0]/1e3,stop=(self._sprite[sprite][0]+self._sprite[sprite][1])/1e3;sound._sprite=sprite,sound._ended=!1,sound._paused=!1;var setParams=function(){sound._paused=!1,sound._seek=seek,sound._start=start,sound._stop=stop,sound._loop=!(!sound._loop&&!self._sprite[sprite][2])};if(seek>=stop)return void self._ended(sound);var node=sound._node;if(self._webAudio){var playWebAudio=function(){self._playLock=!1,setParams(),self._refreshBuffer(sound);var vol=sound._muted||self._muted?0:sound._volume;node.gain.setValueAtTime(vol,Howler.ctx.currentTime),sound._playStart=Howler.ctx.currentTime,void 0===node.bufferSource.start?sound._loop?node.bufferSource.noteGrainOn(0,seek,86400):node.bufferSource.noteGrainOn(0,seek,duration):sound._loop?node.bufferSource.start(0,seek,86400):node.bufferSource.start(0,seek,duration),timeout!==1/0&&(self._endTimers[sound._id]=setTimeout(self._ended.bind(self,sound),timeout)),internal||setTimeout(function(){self._emit("play",sound._id),self._loadQueue()},0)};"running"===Howler.state&&"interrupted"!==Howler.ctx.state?playWebAudio():(self._playLock=!0,self.once("resume",playWebAudio),self._clearTimer(sound._id))}else{var playHtml5=function(){node.currentTime=seek,node.muted=sound._muted||self._muted||Howler._muted||node.muted,node.volume=sound._volume*Howler.volume(),node.playbackRate=sound._rate;try{var play=node.play();if(play&&"undefined"!=typeof Promise&&(play instanceof Promise||"function"==typeof play.then)?(self._playLock=!0,setParams(),play.then(function(){self._playLock=!1,node._unlocked=!0,internal||(self._emit("play",sound._id),self._loadQueue())}).catch(function(){self._playLock=!1,self._emit("playerror",sound._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),sound._ended=!0,sound._paused=!0})):internal?self._playLock=!1:(self._playLock=!1,setParams(),self._emit("play",sound._id),self._loadQueue()),node.playbackRate=sound._rate,node.paused)return void self._emit("playerror",sound._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==sprite||sound._loop?self._endTimers[sound._id]=setTimeout(self._ended.bind(self,sound),timeout):(self._endTimers[sound._id]=function(){self._ended(sound),node.removeEventListener("ended",self._endTimers[sound._id],!1)},node.addEventListener("ended",self._endTimers[sound._id],!1))}catch(err){self._emit("playerror",sound._id,err)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===node.src&&(node.src=self._src,node.load());var loadedNoReadyState=window&&window.ejecta||!node.readyState&&Howler._navigator.isCocoonJS;if(node.readyState>=3||loadedNoReadyState)playHtml5();else{self._playLock=!0;var listener=function(){playHtml5(),node.removeEventListener(Howler._canPlayEvent,listener,!1)};node.addEventListener(Howler._canPlayEvent,listener,!1),self._clearTimer(sound._id)}}return sound._id},pause:function(id){var self=this;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"pause",action:function(){self.pause(id)}}),self;for(var ids=self._getSoundIds(id),i=0;i<ids.length;i++){self._clearTimer(ids[i]);var sound=self._soundById(ids[i]);if(sound&&!sound._paused&&(sound._seek=self.seek(ids[i]),sound._rateSeek=0,sound._paused=!0,self._stopFade(ids[i]),sound._node))if(self._webAudio){if(!sound._node.bufferSource)continue;void 0===sound._node.bufferSource.stop?sound._node.bufferSource.noteOff(0):sound._node.bufferSource.stop(0),self._cleanBuffer(sound._node)}else isNaN(sound._node.duration)&&sound._node.duration!==1/0||sound._node.pause();arguments[1]||self._emit("pause",sound?sound._id:null)}return self},stop:function(id,internal){var self=this;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"stop",action:function(){self.stop(id)}}),self;for(var ids=self._getSoundIds(id),i=0;i<ids.length;i++){self._clearTimer(ids[i]);var sound=self._soundById(ids[i]);sound&&(sound._seek=sound._start||0,sound._rateSeek=0,sound._paused=!0,sound._ended=!0,self._stopFade(ids[i]),sound._node&&(self._webAudio?sound._node.bufferSource&&(void 0===sound._node.bufferSource.stop?sound._node.bufferSource.noteOff(0):sound._node.bufferSource.stop(0),self._cleanBuffer(sound._node)):isNaN(sound._node.duration)&&sound._node.duration!==1/0||(sound._node.currentTime=sound._start||0,sound._node.pause(),sound._node.duration===1/0&&self._clearSound(sound._node))),internal||self._emit("stop",sound._id))}return self},mute:function(muted,id){var self=this;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"mute",action:function(){self.mute(muted,id)}}),self;if(void 0===id){if("boolean"!=typeof muted)return self._muted;self._muted=muted}for(var ids=self._getSoundIds(id),i=0;i<ids.length;i++){var sound=self._soundById(ids[i]);sound&&(sound._muted=muted,sound._interval&&self._stopFade(sound._id),self._webAudio&&sound._node?sound._node.gain.setValueAtTime(muted?0:sound._volume,Howler.ctx.currentTime):sound._node&&(sound._node.muted=!!Howler._muted||muted),self._emit("mute",sound._id))}return self},volume:function(){var vol,id,self=this,args=arguments;if(0===args.length)return self._volume;if(1===args.length||2===args.length&&void 0===args[1]){self._getSoundIds().indexOf(args[0])>=0?id=parseInt(args[0],10):vol=parseFloat(args[0])}else args.length>=2&&(vol=parseFloat(args[0]),id=parseInt(args[1],10));var sound;if(!(void 0!==vol&&vol>=0&&vol<=1))return sound=id?self._soundById(id):self._sounds[0],sound?sound._volume:0;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"volume",action:function(){self.volume.apply(self,args)}}),self;void 0===id&&(self._volume=vol),id=self._getSoundIds(id);for(var i=0;i<id.length;i++)(sound=self._soundById(id[i]))&&(sound._volume=vol,args[2]||self._stopFade(id[i]),self._webAudio&&sound._node&&!sound._muted?sound._node.gain.setValueAtTime(vol,Howler.ctx.currentTime):sound._node&&!sound._muted&&(sound._node.volume=vol*Howler.volume()),self._emit("volume",sound._id));return self},fade:function(from,to,len,id){var self=this;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"fade",action:function(){self.fade(from,to,len,id)}}),self;from=Math.min(Math.max(0,parseFloat(from)),1),to=Math.min(Math.max(0,parseFloat(to)),1),len=parseFloat(len),self.volume(from,id);for(var ids=self._getSoundIds(id),i=0;i<ids.length;i++){var sound=self._soundById(ids[i]);if(sound){if(id||self._stopFade(ids[i]),self._webAudio&&!sound._muted){var currentTime=Howler.ctx.currentTime,end=currentTime+len/1e3;sound._volume=from,sound._node.gain.setValueAtTime(from,currentTime),sound._node.gain.linearRampToValueAtTime(to,end)}self._startFadeInterval(sound,from,to,len,ids[i],void 0===id)}}return self},_startFadeInterval:function(sound,from,to,len,id,isGroup){var self=this,vol=from,diff=to-from,steps=Math.abs(diff/.01),stepLen=Math.max(4,steps>0?len/steps:len),lastTick=Date.now();sound._fadeTo=to,sound._interval=setInterval(function(){var tick=(Date.now()-lastTick)/len;lastTick=Date.now(),vol+=diff*tick,vol=Math.round(100*vol)/100,vol=diff<0?Math.max(to,vol):Math.min(to,vol),self._webAudio?sound._volume=vol:self.volume(vol,sound._id,!0),isGroup&&(self._volume=vol),(to<from&&vol<=to||to>from&&vol>=to)&&(clearInterval(sound._interval),sound._interval=null,sound._fadeTo=null,self.volume(to,sound._id),self._emit("fade",sound._id))},stepLen)},_stopFade:function(id){var self=this,sound=self._soundById(id);return sound&&sound._interval&&(self._webAudio&&sound._node.gain.cancelScheduledValues(Howler.ctx.currentTime),clearInterval(sound._interval),sound._interval=null,self.volume(sound._fadeTo,id),sound._fadeTo=null,self._emit("fade",id)),self},loop:function(){var loop,id,sound,self=this,args=arguments;if(0===args.length)return self._loop;if(1===args.length){if("boolean"!=typeof args[0])return!!(sound=self._soundById(parseInt(args[0],10)))&&sound._loop;loop=args[0],self._loop=loop}else 2===args.length&&(loop=args[0],id=parseInt(args[1],10));for(var ids=self._getSoundIds(id),i=0;i<ids.length;i++)(sound=self._soundById(ids[i]))&&(sound._loop=loop,self._webAudio&&sound._node&&sound._node.bufferSource&&(sound._node.bufferSource.loop=loop,loop&&(sound._node.bufferSource.loopStart=sound._start||0,sound._node.bufferSource.loopEnd=sound._stop)));return self},rate:function(){var rate,id,self=this,args=arguments;if(0===args.length)id=self._sounds[0]._id;else if(1===args.length){var ids=self._getSoundIds(),index=ids.indexOf(args[0]);index>=0?id=parseInt(args[0],10):rate=parseFloat(args[0])}else 2===args.length&&(rate=parseFloat(args[0]),id=parseInt(args[1],10));var sound;if("number"!=typeof rate)return sound=self._soundById(id),sound?sound._rate:self._rate;if("loaded"!==self._state||self._playLock)return self._queue.push({event:"rate",action:function(){self.rate.apply(self,args)}}),self;void 0===id&&(self._rate=rate),id=self._getSoundIds(id);for(var i=0;i<id.length;i++)if(sound=self._soundById(id[i])){self.playing(id[i])&&(sound._rateSeek=self.seek(id[i]),sound._playStart=self._webAudio?Howler.ctx.currentTime:sound._playStart),sound._rate=rate,self._webAudio&&sound._node&&sound._node.bufferSource?sound._node.bufferSource.playbackRate.setValueAtTime(rate,Howler.ctx.currentTime):sound._node&&(sound._node.playbackRate=rate);var seek=self.seek(id[i]),duration=(self._sprite[sound._sprite][0]+self._sprite[sound._sprite][1])/1e3-seek,timeout=1e3*duration/Math.abs(sound._rate);!self._endTimers[id[i]]&&sound._paused||(self._clearTimer(id[i]),self._endTimers[id[i]]=setTimeout(self._ended.bind(self,sound),timeout)),self._emit("rate",sound._id)}return self},seek:function(){var seek,id,self=this,args=arguments;if(0===args.length)id=self._sounds[0]._id;else if(1===args.length){var ids=self._getSoundIds(),index=ids.indexOf(args[0]);index>=0?id=parseInt(args[0],10):self._sounds.length&&(id=self._sounds[0]._id,seek=parseFloat(args[0]))}else 2===args.length&&(seek=parseFloat(args[0]),id=parseInt(args[1],10));if(void 0===id)return self;if("number"==typeof seek&&("loaded"!==self._state||self._playLock))return self._queue.push({event:"seek",action:function(){self.seek.apply(self,args)}}),self;var sound=self._soundById(id);if(sound){if(!("number"==typeof seek&&seek>=0)){if(self._webAudio){var realTime=self.playing(id)?Howler.ctx.currentTime-sound._playStart:0,rateSeek=sound._rateSeek?sound._rateSeek-sound._seek:0;return sound._seek+(rateSeek+realTime*Math.abs(sound._rate))}return sound._node.currentTime}var playing=self.playing(id);playing&&self.pause(id,!0),sound._seek=seek,sound._ended=!1,self._clearTimer(id),self._webAudio||!sound._node||isNaN(sound._node.duration)||(sound._node.currentTime=seek);var seekAndEmit=function(){self._emit("seek",id),playing&&self.play(id,!0)};if(playing&&!self._webAudio){var emitSeek=function(){self._playLock?setTimeout(emitSeek,0):seekAndEmit()};setTimeout(emitSeek,0)}else seekAndEmit()}return self},playing:function(id){var self=this;if("number"==typeof id){var sound=self._soundById(id);return!!sound&&!sound._paused}for(var i=0;i<self._sounds.length;i++)if(!self._sounds[i]._paused)return!0;return!1},duration:function(id){var self=this,duration=self._duration,sound=self._soundById(id);return sound&&(duration=self._sprite[sound._sprite][1]/1e3),duration},state:function(){return this._state},unload:function(){for(var self=this,sounds=self._sounds,i=0;i<sounds.length;i++)sounds[i]._paused||self.stop(sounds[i]._id),self._webAudio||(self._clearSound(sounds[i]._node),sounds[i]._node.removeEventListener("error",sounds[i]._errorFn,!1),sounds[i]._node.removeEventListener(Howler._canPlayEvent,sounds[i]._loadFn,!1),sounds[i]._node.removeEventListener("ended",sounds[i]._endFn,!1),Howler._releaseHtml5Audio(sounds[i]._node)),delete sounds[i]._node,self._clearTimer(sounds[i]._id);var index=Howler._howls.indexOf(self);index>=0&&Howler._howls.splice(index,1);var remCache=!0;for(i=0;i<Howler._howls.length;i++)if(Howler._howls[i]._src===self._src||self._src.indexOf(Howler._howls[i]._src)>=0){remCache=!1;break}return cache&&remCache&&delete cache[self._src],Howler.noAudio=!1,self._state="unloaded",self._sounds=[],self=null,null},on:function(event,fn,id,once){var self=this,events=self["_on"+event];return"function"==typeof fn&&events.push(once?{id:id,fn:fn,once:once}:{id:id,fn:fn}),self},off:function(event,fn,id){var self=this,events=self["_on"+event],i=0;if("number"==typeof fn&&(id=fn,fn=null),fn||id)for(i=0;i<events.length;i++){var isId=id===events[i].id;if(fn===events[i].fn&&isId||!fn&&isId){events.splice(i,1);break}}else if(event)self["_on"+event]=[];else{var keys=Object.keys(self);for(i=0;i<keys.length;i++)0===keys[i].indexOf("_on")&&Array.isArray(self[keys[i]])&&(self[keys[i]]=[])}return self},once:function(event,fn,id){var self=this;return self.on(event,fn,id,1),self},_emit:function(event,id,msg){for(var self=this,events=self["_on"+event],i=events.length-1;i>=0;i--)events[i].id&&events[i].id!==id&&"load"!==event||(setTimeout(function(fn){fn.call(this,id,msg)}.bind(self,events[i].fn),0),events[i].once&&self.off(event,events[i].fn,events[i].id));return self._loadQueue(event),self},_loadQueue:function(event){var self=this;if(self._queue.length>0){var task=self._queue[0];task.event===event&&(self._queue.shift(),self._loadQueue()),event||task.action()}return self},_ended:function(sound){var self=this,sprite=sound._sprite;if(!self._webAudio&&sound._node&&!sound._node.paused&&!sound._node.ended&&sound._node.currentTime<sound._stop)return setTimeout(self._ended.bind(self,sound),100),self;var loop=!(!sound._loop&&!self._sprite[sprite][2]);if(self._emit("end",sound._id),!self._webAudio&&loop&&self.stop(sound._id,!0).play(sound._id),self._webAudio&&loop){self._emit("play",sound._id),sound._seek=sound._start||0,sound._rateSeek=0,sound._playStart=Howler.ctx.currentTime;var timeout=1e3*(sound._stop-sound._start)/Math.abs(sound._rate);self._endTimers[sound._id]=setTimeout(self._ended.bind(self,sound),timeout)}return self._webAudio&&!loop&&(sound._paused=!0,sound._ended=!0,sound._seek=sound._start||0,sound._rateSeek=0,self._clearTimer(sound._id),self._cleanBuffer(sound._node),Howler._autoSuspend()),self._webAudio||loop||self.stop(sound._id,!0),self},_clearTimer:function(id){var self=this;if(self._endTimers[id]){if("function"!=typeof self._endTimers[id])clearTimeout(self._endTimers[id]);else{var sound=self._soundById(id);sound&&sound._node&&sound._node.removeEventListener("ended",self._endTimers[id],!1)}delete self._endTimers[id]}return self},_soundById:function(id){for(var self=this,i=0;i<self._sounds.length;i++)if(id===self._sounds[i]._id)return self._sounds[i];return null},_inactiveSound:function(){var self=this;self._drain();for(var i=0;i<self._sounds.length;i++)if(self._sounds[i]._ended)return self._sounds[i].reset();return new Sound(self)},_drain:function(){var self=this,limit=self._pool,cnt=0,i=0;if(!(self._sounds.length<limit)){for(i=0;i<self._sounds.length;i++)self._sounds[i]._ended&&cnt++;for(i=self._sounds.length-1;i>=0;i--){if(cnt<=limit)return;self._sounds[i]._ended&&(self._webAudio&&self._sounds[i]._node&&self._sounds[i]._node.disconnect(0),self._sounds.splice(i,1),cnt--)}}},_getSoundIds:function(id){var self=this;if(void 0===id){for(var ids=[],i=0;i<self._sounds.length;i++)ids.push(self._sounds[i]._id);return ids}return[id]},_refreshBuffer:function(sound){var self=this;return sound._node.bufferSource=Howler.ctx.createBufferSource(),sound._node.bufferSource.buffer=cache[self._src],sound._panner?sound._node.bufferSource.connect(sound._panner):sound._node.bufferSource.connect(sound._node),sound._node.bufferSource.loop=sound._loop,sound._loop&&(sound._node.bufferSource.loopStart=sound._start||0,sound._node.bufferSource.loopEnd=sound._stop||0),sound._node.bufferSource.playbackRate.setValueAtTime(sound._rate,Howler.ctx.currentTime),self},_cleanBuffer:function(node){var self=this,isIOS=Howler._navigator&&Howler._navigator.vendor.indexOf("Apple")>=0;if(Howler._scratchBuffer&&node.bufferSource&&(node.bufferSource.onended=null,node.bufferSource.disconnect(0),isIOS))try{node.bufferSource.buffer=Howler._scratchBuffer}catch(e){}return node.bufferSource=null,self},_clearSound:function(node){/MSIE |Trident\//.test(Howler._navigator&&Howler._navigator.userAgent)||(node.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var Sound=function(howl){this._parent=howl,this.init()};Sound.prototype={init:function(){var self=this,parent=self._parent;return self._muted=parent._muted,self._loop=parent._loop,self._volume=parent._volume,self._rate=parent._rate,self._seek=0,self._paused=!0,self._ended=!0,self._sprite="__default",self._id=++Howler._counter,parent._sounds.push(self),self.create(),self},create:function(){var self=this,parent=self._parent,volume=Howler._muted||self._muted||self._parent._muted?0:self._volume;return parent._webAudio?(self._node=void 0===Howler.ctx.createGain?Howler.ctx.createGainNode():Howler.ctx.createGain(),self._node.gain.setValueAtTime(volume,Howler.ctx.currentTime),self._node.paused=!0,self._node.connect(Howler.masterGain)):Howler.noAudio||(self._node=Howler._obtainHtml5Audio(),
self._errorFn=self._errorListener.bind(self),self._node.addEventListener("error",self._errorFn,!1),self._loadFn=self._loadListener.bind(self),self._node.addEventListener(Howler._canPlayEvent,self._loadFn,!1),self._endFn=self._endListener.bind(self),self._node.addEventListener("ended",self._endFn,!1),self._node.src=parent._src,self._node.preload=!0===parent._preload?"auto":parent._preload,self._node.volume=volume*Howler.volume(),self._node.load()),self},reset:function(){var self=this,parent=self._parent;return self._muted=parent._muted,self._loop=parent._loop,self._volume=parent._volume,self._rate=parent._rate,self._seek=0,self._rateSeek=0,self._paused=!0,self._ended=!0,self._sprite="__default",self._id=++Howler._counter,self},_errorListener:function(){var self=this;self._parent._emit("loaderror",self._id,self._node.error?self._node.error.code:0),self._node.removeEventListener("error",self._errorFn,!1)},_loadListener:function(){var self=this,parent=self._parent;parent._duration=Math.ceil(10*self._node.duration)/10,0===Object.keys(parent._sprite).length&&(parent._sprite={__default:[0,1e3*parent._duration]}),"loaded"!==parent._state&&(parent._state="loaded",parent._emit("load"),parent._loadQueue()),self._node.removeEventListener(Howler._canPlayEvent,self._loadFn,!1)},_endListener:function(){var self=this,parent=self._parent;parent._duration===1/0&&(parent._duration=Math.ceil(10*self._node.duration)/10,parent._sprite.__default[1]===1/0&&(parent._sprite.__default[1]=1e3*parent._duration),parent._ended(self)),self._node.removeEventListener("ended",self._endFn,!1)}};var cache={},loadBuffer=function(self){var url=self._src;if(cache[url])return self._duration=cache[url].duration,void loadSound(self);if(/^data:[^;]+;base64,/.test(url)){for(var data=atob(url.split(",")[1]),dataView=new Uint8Array(data.length),i=0;i<data.length;++i)dataView[i]=data.charCodeAt(i);decodeAudioData(dataView.buffer,self)}else{var xhr=new XMLHttpRequest;xhr.open(self._xhr.method,url,!0),xhr.withCredentials=self._xhr.withCredentials,xhr.responseType="arraybuffer",self._xhr.headers&&Object.keys(self._xhr.headers).forEach(function(key){xhr.setRequestHeader(key,self._xhr.headers[key])}),xhr.onload=function(){var code=(xhr.status+"")[0];if("0"!==code&&"2"!==code&&"3"!==code)return void self._emit("loaderror",null,"Failed loading audio file with status: "+xhr.status+".");decodeAudioData(xhr.response,self)},xhr.onerror=function(){self._webAudio&&(self._html5=!0,self._webAudio=!1,self._sounds=[],delete cache[url],self.load())},safeXhrSend(xhr)}},safeXhrSend=function(xhr){try{xhr.send()}catch(e){xhr.onerror()}},decodeAudioData=function(arraybuffer,self){var error=function(){self._emit("loaderror",null,"Decoding audio data failed.")},success=function(buffer){buffer&&self._sounds.length>0?(cache[self._src]=buffer,loadSound(self,buffer)):error()};"undefined"!=typeof Promise&&1===Howler.ctx.decodeAudioData.length?Howler.ctx.decodeAudioData(arraybuffer).then(success).catch(error):Howler.ctx.decodeAudioData(arraybuffer,success,error)},loadSound=function(self,buffer){buffer&&!self._duration&&(self._duration=buffer.duration),0===Object.keys(self._sprite).length&&(self._sprite={__default:[0,1e3*self._duration]}),"loaded"!==self._state&&(self._state="loaded",self._emit("load"),self._loadQueue())},setupAudioContext=function(){if(Howler.usingWebAudio){try{"undefined"!=typeof AudioContext?Howler.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?Howler.ctx=new webkitAudioContext:Howler.usingWebAudio=!1}catch(e){Howler.usingWebAudio=!1}Howler.ctx||(Howler.usingWebAudio=!1);var iOS=/iP(hone|od|ad)/.test(Howler._navigator&&Howler._navigator.platform),appVersion=Howler._navigator&&Howler._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),version=appVersion?parseInt(appVersion[1],10):null;if(iOS&&version&&version<9){var safari=/safari/.test(Howler._navigator&&Howler._navigator.userAgent.toLowerCase());Howler._navigator&&!safari&&(Howler.usingWebAudio=!1)}Howler.usingWebAudio&&(Howler.masterGain=void 0===Howler.ctx.createGain?Howler.ctx.createGainNode():Howler.ctx.createGain(),Howler.masterGain.gain.setValueAtTime(Howler._muted?0:Howler._volume,Howler.ctx.currentTime),Howler.masterGain.connect(Howler.ctx.destination)),Howler._setup()}};"function"==typeof define&&define.amd&&define([],function(){return{Howler:Howler,Howl:Howl}}),"undefined"!=typeof exports&&(exports.Howler=Howler,exports.Howl=Howl),"undefined"!=typeof global?(global.HowlerGlobal=HowlerGlobal,global.Howler=Howler,global.Howl=Howl,global.Sound=Sound):"undefined"!=typeof window&&(window.HowlerGlobal=HowlerGlobal,window.Howler=Howler,window.Howl=Howl,window.Sound=Sound)}(),window.VIDEOJS_NO_DYNAMIC_STYLE=!0,function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory(require("global/window"),require("global/document")):"function"==typeof define&&define.amd?define(["global/window","global/document"],factory):(global=global||self,global.videojs=factory(global.window,global.document))}(this,function(window$1,document){window$1=window$1&&window$1.hasOwnProperty("default")?window$1.default:window$1,document=document&&document.hasOwnProperty("default")?document.default:document;var version="7.6.6",history=[],LogByTypeFactory=function(name,log){return function(type,level,args){var lvl=log.levels[level],lvlRegExp=new RegExp("^("+lvl+")$");if("log"!==type&&args.unshift(type.toUpperCase()+":"),args.unshift(name+":"),history&&history.push([].concat(args)),window$1.console){var fn=window$1.console[type];fn||"debug"!==type||(fn=window$1.console.info||window$1.console.log),fn&&lvl&&lvlRegExp.test(type)&&fn[Array.isArray(args)?"apply":"call"](window$1.console,args)}}};function createLogger(name){var logByType,level="info",log=function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];logByType("log",level,args)};return logByType=LogByTypeFactory(name,log),log.createLogger=function(subname){return createLogger(name+": "+subname)},log.levels={all:"debug|log|warn|error",off:"",debug:"debug|log|warn|error",info:"log|warn|error",warn:"warn|error",error:"error",DEFAULT:level},log.level=function(lvl){if("string"==typeof lvl){if(!log.levels.hasOwnProperty(lvl))throw new Error('"'+lvl+'" in not a valid log level');level=lvl}return level},log.history=function(){return history?[].concat(history):[]},log.history.filter=function(fname){return(history||[]).filter(function(historyItem){return new RegExp(".*"+fname+".*").test(historyItem[0])})},log.history.clear=function(){history&&(history.length=0)},log.history.disable=function(){null!==history&&(history.length=0,history=null)},log.history.enable=function(){null===history&&(history=[])},log.error=function(){for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++)args[_key2]=arguments[_key2];return logByType("error",level,args)},log.warn=function(){for(var _len3=arguments.length,args=new Array(_len3),_key3=0;_key3<_len3;_key3++)args[_key3]=arguments[_key3];return logByType("warn",level,args)},log.debug=function(){for(var _len4=arguments.length,args=new Array(_len4),_key4=0;_key4<_len4;_key4++)args[_key4]=arguments[_key4];return logByType("debug",level,args)},log}var log=createLogger("VIDEOJS"),createLogger$1=log.createLogger,toString=Object.prototype.toString,keys=function(object){return isObject(object)?Object.keys(object):[]};function each(object,fn){keys(object).forEach(function(key){return fn(object[key],key)})}function reduce(object,fn,initial){return void 0===initial&&(initial=0),keys(object).reduce(function(accum,key){return fn(accum,object[key],key)},initial)}function assign(target){for(var _len=arguments.length,sources=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)sources[_key-1]=arguments[_key];return Object.assign?Object.assign.apply(Object,[target].concat(sources)):(sources.forEach(function(source){source&&each(source,function(value,key){target[key]=value})}),target)}function isObject(value){return!!value&&"object"==typeof value}function isPlain(value){return isObject(value)&&"[object Object]"===toString.call(value)&&value.constructor===Object}function computedStyle(el,prop){if(!el||!prop)return"";if("function"==typeof window$1.getComputedStyle){var computedStyleValue=window$1.getComputedStyle(el);return computedStyleValue?computedStyleValue.getPropertyValue(prop)||computedStyleValue[prop]:""}return""}function isNonBlankString(str){return"string"==typeof str&&/\S/.test(str)}function throwIfWhitespace(str){if(/\s/.test(str))throw new Error("class has illegal whitespace characters")}function classRegExp(className){return new RegExp("(^|\\s)"+className+"($|\\s)")}function isReal(){return document===window$1.document}function isEl(value){return isObject(value)&&1===value.nodeType}function isInFrame(){try{return window$1.parent!==window$1.self}catch(x){return!0}}function createQuerier(method){return function(selector,context){if(!isNonBlankString(selector))return document[method](null);isNonBlankString(context)&&(context=document.querySelector(context));var ctx=isEl(context)?context:document;return ctx[method]&&ctx[method](selector)}}function createEl(tagName,properties,attributes,content){void 0===tagName&&(tagName="div"),void 0===properties&&(properties={}),void 0===attributes&&(attributes={});var el=document.createElement(tagName);return Object.getOwnPropertyNames(properties).forEach(function(propName){var val=properties[propName];-1!==propName.indexOf("aria-")||"role"===propName||"type"===propName?(log.warn("Setting attributes in the second argument of createEl()\nhas been deprecated. Use the third argument instead.\ncreateEl(type, properties, attributes). Attempting to set "+propName+" to "+val+"."),el.setAttribute(propName,val)):"textContent"===propName?textContent(el,val):el[propName]=val}),Object.getOwnPropertyNames(attributes).forEach(function(attrName){el.setAttribute(attrName,attributes[attrName])}),content&&appendContent(el,content),el}function textContent(el,text){return void 0===el.textContent?el.innerText=text:el.textContent=text,el}function prependTo(child,parent){parent.firstChild?parent.insertBefore(child,parent.firstChild):parent.appendChild(child)}function hasClass(element,classToCheck){return throwIfWhitespace(classToCheck),element.classList?element.classList.contains(classToCheck):classRegExp(classToCheck).test(element.className)}function addClass(element,classToAdd){return element.classList?element.classList.add(classToAdd):hasClass(element,classToAdd)||(element.className=(element.className+" "+classToAdd).trim()),element}function removeClass(element,classToRemove){return element.classList?element.classList.remove(classToRemove):(throwIfWhitespace(classToRemove),element.className=element.className.split(/\s+/).filter(function(c){return c!==classToRemove}).join(" ")),element}function toggleClass(element,classToToggle,predicate){var has=hasClass(element,classToToggle);if("function"==typeof predicate&&(predicate=predicate(element,classToToggle)),"boolean"!=typeof predicate&&(predicate=!has),predicate!==has)return predicate?addClass(element,classToToggle):removeClass(element,classToToggle),element}function setAttributes(el,attributes){Object.getOwnPropertyNames(attributes).forEach(function(attrName){var attrValue=attributes[attrName];null===attrValue||void 0===attrValue||!1===attrValue?el.removeAttribute(attrName):el.setAttribute(attrName,!0===attrValue?"":attrValue)})}function getAttributes(tag){var obj={};if(tag&&tag.attributes&&tag.attributes.length>0)for(var attrs=tag.attributes,i=attrs.length-1;i>=0;i--){var attrName=attrs[i].name,attrVal=attrs[i].value;"boolean"!=typeof tag[attrName]&&-1===",autoplay,controls,playsinline,loop,muted,default,defaultMuted,".indexOf(","+attrName+",")||(attrVal=null!==attrVal),obj[attrName]=attrVal}return obj}function getAttribute(el,attribute){return el.getAttribute(attribute)}function setAttribute(el,attribute,value){el.setAttribute(attribute,value)}function removeAttribute(el,attribute){el.removeAttribute(attribute)}function blockTextSelection(){document.body.focus(),document.onselectstart=function(){return!1}}function unblockTextSelection(){document.onselectstart=function(){return!0}}function getBoundingClientRect(el){if(el&&el.getBoundingClientRect&&el.parentNode){var rect=el.getBoundingClientRect(),result={};return["bottom","height","left","right","top","width"].forEach(function(k){void 0!==rect[k]&&(result[k]=rect[k])}),result.height||(result.height=parseFloat(computedStyle(el,"height"))),result.width||(result.width=parseFloat(computedStyle(el,"width"))),result}}function findPosition(el){var box;if(el.getBoundingClientRect&&el.parentNode&&(box=el.getBoundingClientRect()),!box)return{left:0,top:0};var docEl=document.documentElement,body=document.body,clientLeft=docEl.clientLeft||body.clientLeft||0,scrollLeft=window$1.pageXOffset||body.scrollLeft,left=box.left+scrollLeft-clientLeft,clientTop=docEl.clientTop||body.clientTop||0,scrollTop=window$1.pageYOffset||body.scrollTop,top=box.top+scrollTop-clientTop;return{left:Math.round(left),top:Math.round(top)}}function getPointerPosition(el,event){var position={},box=findPosition(el),boxW=el.offsetWidth,boxH=el.offsetHeight,boxY=box.top,boxX=box.left,pageY=event.pageY,pageX=event.pageX;return event.changedTouches&&(pageX=event.changedTouches[0].pageX,pageY=event.changedTouches[0].pageY),position.y=Math.max(0,Math.min(1,(boxY-pageY+boxH)/boxH)),position.x=Math.max(0,Math.min(1,(pageX-boxX)/boxW)),position}function isTextNode(value){return isObject(value)&&3===value.nodeType}function emptyEl(el){for(;el.firstChild;)el.removeChild(el.firstChild);return el}function normalizeContent(content){return"function"==typeof content&&(content=content()),(Array.isArray(content)?content:[content]).map(function(value){return"function"==typeof value&&(value=value()),isEl(value)||isTextNode(value)?value:"string"==typeof value&&/\S/.test(value)?document.createTextNode(value):void 0}).filter(function(value){return value})}function appendContent(el,content){return normalizeContent(content).forEach(function(node){return el.appendChild(node)}),el}function insertContent(el,content){return appendContent(emptyEl(el),content)}function isSingleLeftClick(event){return void 0===event.button&&void 0===event.buttons||(0===event.button&&void 0===event.buttons||("mouseup"===event.type&&0===event.button&&0===event.buttons||0===event.button&&1===event.buttons))}var videojs,$=createQuerier("querySelector"),$$=createQuerier("querySelectorAll"),Dom=Object.freeze({isReal:isReal,isEl:isEl,isInFrame:isInFrame,createEl:createEl,textContent:textContent,prependTo:prependTo,hasClass:hasClass,addClass:addClass,removeClass:removeClass,toggleClass:toggleClass,setAttributes:setAttributes,getAttributes:getAttributes,getAttribute:getAttribute,setAttribute:setAttribute,removeAttribute:removeAttribute,blockTextSelection:blockTextSelection,unblockTextSelection:unblockTextSelection,getBoundingClientRect:getBoundingClientRect,findPosition:findPosition,getPointerPosition:getPointerPosition,isTextNode:isTextNode,emptyEl:emptyEl,normalizeContent:normalizeContent,appendContent:appendContent,insertContent:insertContent,isSingleLeftClick:isSingleLeftClick,$:$,$$:$$}),_windowLoaded=!1,autoSetup=function(){if(isReal()&&!1!==videojs.options.autoSetup){var vids=Array.prototype.slice.call(document.getElementsByTagName("video")),audios=Array.prototype.slice.call(document.getElementsByTagName("audio")),divs=Array.prototype.slice.call(document.getElementsByTagName("video-js")),mediaEls=vids.concat(audios,divs);if(mediaEls&&mediaEls.length>0)for(var i=0,e=mediaEls.length;i<e;i++){var mediaEl=mediaEls[i];if(!mediaEl||!mediaEl.getAttribute){autoSetupTimeout(1);break}if(void 0===mediaEl.player){var options=mediaEl.getAttribute("data-setup");null!==options&&videojs(mediaEl)}}else _windowLoaded||autoSetupTimeout(1)}};function autoSetupTimeout(wait,vjs){vjs&&(videojs=vjs),window$1.setTimeout(autoSetup,wait)}function setWindowLoaded(){_windowLoaded=!0,window$1.removeEventListener("load",setWindowLoaded)}isReal()&&("complete"===document.readyState?setWindowLoaded():window$1.addEventListener("load",setWindowLoaded));var createStyleElement=function(className){var style=document.createElement("style");return style.className=className,style},setTextContent=function(el,content){el.styleSheet?el.styleSheet.cssText=content:el.textContent=content},_guid=3;function newGUID(){return _guid++}var FakeWeakMap;window$1.WeakMap||(FakeWeakMap=function(){function FakeWeakMap(){this.vdata="vdata"+Math.floor(window$1.performance&&window$1.performance.now()||Date.now()),this.data={}}var _proto=FakeWeakMap.prototype;return _proto.set=function(key,value){var access=key[this.vdata]||newGUID();return key[this.vdata]||(key[this.vdata]=access),this.data[access]=value,this},_proto.get=function(key){var access=key[this.vdata];if(access)return this.data[access];log("We have no data for this element",key)},_proto.has=function(key){return key[this.vdata]in this.data},_proto.delete=function(key){var access=key[this.vdata];access&&(delete this.data[access],delete key[this.vdata])},FakeWeakMap}());var DomData=window$1.WeakMap?new WeakMap:new FakeWeakMap;function _cleanUpEvents(elem,type){if(DomData.has(elem)){var data=DomData.get(elem);0===data.handlers[type].length&&(delete data.handlers[type],elem.removeEventListener?elem.removeEventListener(type,data.dispatcher,!1):elem.detachEvent&&elem.detachEvent("on"+type,data.dispatcher)),Object.getOwnPropertyNames(data.handlers).length<=0&&(delete data.handlers,delete data.dispatcher,delete data.disabled),0===Object.getOwnPropertyNames(data).length&&DomData.delete(elem)}}function _handleMultipleEvents(fn,elem,types,callback){types.forEach(function(type){fn(elem,type,callback)})}function fixEvent(event){function returnTrue(){return!0}function returnFalse(){return!1}if(!event||!event.isPropagationStopped){var old=event||window$1.event;event={};for(var key in old)"layerX"!==key&&"layerY"!==key&&"keyLocation"!==key&&"webkitMovementX"!==key&&"webkitMovementY"!==key&&("returnValue"===key&&old.preventDefault||(event[key]=old[key]));if(event.target||(event.target=event.srcElement||document),event.relatedTarget||(event.relatedTarget=event.fromElement===event.target?event.toElement:event.fromElement),event.preventDefault=function(){old.preventDefault&&old.preventDefault(),event.returnValue=!1,old.returnValue=!1,event.defaultPrevented=!0},event.defaultPrevented=!1,event.stopPropagation=function(){old.stopPropagation&&old.stopPropagation(),event.cancelBubble=!0,old.cancelBubble=!0,event.isPropagationStopped=returnTrue},event.isPropagationStopped=returnFalse,event.stopImmediatePropagation=function(){old.stopImmediatePropagation&&old.stopImmediatePropagation(),event.isImmediatePropagationStopped=returnTrue,event.stopPropagation()},event.isImmediatePropagationStopped=returnFalse,null!==event.clientX&&void 0!==event.clientX){var doc=document.documentElement,body=document.body;event.pageX=event.clientX+(doc&&doc.scrollLeft||body&&body.scrollLeft||0)-(doc&&doc.clientLeft||body&&body.clientLeft||0),event.pageY=event.clientY+(doc&&doc.scrollTop||body&&body.scrollTop||0)-(doc&&doc.clientTop||body&&body.clientTop||0)}event.which=event.charCode||event.keyCode,null!==event.button&&void 0!==event.button&&(event.button=1&event.button?0:4&event.button?1:2&event.button?2:0)}return event}var _supportsPassive=!1;!function(){try{var opts=Object.defineProperty({},"passive",{get:function(){_supportsPassive=!0}});window$1.addEventListener("test",null,opts),window$1.removeEventListener("test",null,opts)}catch(e){}}();var passiveEvents=["touchstart","touchmove"];function on(elem,type,fn){if(Array.isArray(type))return _handleMultipleEvents(on,elem,type,fn);DomData.has(elem)||DomData.set(elem,{});var data=DomData.get(elem);if(data.handlers||(data.handlers={}),data.handlers[type]||(data.handlers[type]=[]),fn.guid||(fn.guid=newGUID()),data.handlers[type].push(fn),data.dispatcher||(data.disabled=!1,data.dispatcher=function(event,hash){if(!data.disabled){event=fixEvent(event);var handlers=data.handlers[event.type];if(handlers)for(var handlersCopy=handlers.slice(0),m=0,n=handlersCopy.length;m<n&&!event.isImmediatePropagationStopped();m++)try{handlersCopy[m].call(elem,event,hash)}catch(e){log.error(e)}}}),1===data.handlers[type].length)if(elem.addEventListener){var options=!1;_supportsPassive&&passiveEvents.indexOf(type)>-1&&(options={passive:!0}),elem.addEventListener(type,data.dispatcher,options)}else elem.attachEvent&&elem.attachEvent("on"+type,data.dispatcher)}function off(elem,type,fn){if(DomData.has(elem)){var data=DomData.get(elem);if(data.handlers){if(Array.isArray(type))return _handleMultipleEvents(off,elem,type,fn);var removeType=function(el,t){data.handlers[t]=[],_cleanUpEvents(el,t)};if(void 0!==type){var handlers=data.handlers[type];if(handlers){if(!fn)return void removeType(elem,type);if(fn.guid)for(var n=0;n<handlers.length;n++)handlers[n].guid===fn.guid&&handlers.splice(n--,1);_cleanUpEvents(elem,type)}}else for(var t in data.handlers)Object.prototype.hasOwnProperty.call(data.handlers||{},t)&&removeType(elem,t)}}}function trigger(elem,event,hash){var elemData=DomData.has(elem)?DomData.get(elem):{},parent=elem.parentNode||elem.ownerDocument;if("string"==typeof event?event={type:event,target:elem}:event.target||(event.target=elem),event=fixEvent(event),elemData.dispatcher&&elemData.dispatcher.call(elem,event,hash),parent&&!event.isPropagationStopped()&&!0===event.bubbles)trigger.call(null,parent,event,hash);else if(!parent&&!event.defaultPrevented&&event.target&&event.target[event.type]){DomData.has(event.target)||DomData.set(event.target,{});var targetData=DomData.get(event.target);event.target[event.type]&&(targetData.disabled=!0,"function"==typeof event.target[event.type]&&event.target[event.type](),targetData.disabled=!1)}return!event.defaultPrevented}function one(elem,type,fn){if(Array.isArray(type))return _handleMultipleEvents(one,elem,type,fn);var func=function func(){off(elem,type,func),fn.apply(this,arguments)};func.guid=fn.guid=fn.guid||newGUID(),on(elem,type,func)}function any(elem,type,fn){var func=function func(){off(elem,type,func),fn.apply(this,arguments)};func.guid=fn.guid=fn.guid||newGUID(),on(elem,type,func)}var Events=Object.freeze({fixEvent:fixEvent,on:on,off:off,trigger:trigger,one:one,any:any}),UPDATE_REFRESH_INTERVAL=30,bind=function(context,fn,uid){fn.guid||(fn.guid=newGUID());var bound=fn.bind(context);return bound.guid=uid?uid+"_"+fn.guid:fn.guid,bound},throttle=function(fn,wait){var last=window$1.performance.now();return function(){var now=window$1.performance.now();now-last>=wait&&(fn.apply(void 0,arguments),last=now)}},debounce=function(func,wait,immediate,context){void 0===context&&(context=window$1);var timeout,cancel=function(){context.clearTimeout(timeout),timeout=null},debounced=function(){var self=this,args=arguments,_later=function(){timeout=null,_later=null,immediate||func.apply(self,args)};!timeout&&immediate&&func.apply(self,args),context.clearTimeout(timeout),timeout=context.setTimeout(_later,wait)};return debounced.cancel=cancel,debounced},EventTarget=function(){};EventTarget.prototype.allowedEvents_={},EventTarget.prototype.on=function(type,fn){var ael=this.addEventListener;this.addEventListener=function(){},on(this,type,fn),this.addEventListener=ael},EventTarget.prototype.addEventListener=EventTarget.prototype.on,EventTarget.prototype.off=function(type,fn){off(this,type,fn)},EventTarget.prototype.removeEventListener=EventTarget.prototype.off,EventTarget.prototype.one=function(type,fn){var ael=this.addEventListener;this.addEventListener=function(){},one(this,type,fn),this.addEventListener=ael},EventTarget.prototype.any=function(type,fn){var ael=this.addEventListener;this.addEventListener=function(){},any(this,type,fn),this.addEventListener=ael},EventTarget.prototype.trigger=function(event){var type=event.type||event;"string"==typeof event&&(event={type:type}),event=fixEvent(event),this.allowedEvents_[type]&&this["on"+type]&&this["on"+type](event),trigger(this,event)},EventTarget.prototype.dispatchEvent=EventTarget.prototype.trigger;var EVENT_MAP;EventTarget.prototype.queueTrigger=function(event){var _this=this;EVENT_MAP||(EVENT_MAP=new Map);var type=event.type||event,map=EVENT_MAP.get(this);map||(map=new Map,EVENT_MAP.set(this,map));var oldTimeout=map.get(type);map.delete(type),window$1.clearTimeout(oldTimeout);var timeout=window$1.setTimeout(function(){0===map.size&&(map=null,EVENT_MAP.delete(_this)),_this.trigger(event)},0);map.set(type,timeout)};var isEvented=function(object){return object instanceof EventTarget||!!object.eventBusEl_&&["on","one","off","trigger"].every(function(k){return"function"==typeof object[k]})},addEventedCallback=function(target,callback){isEvented(target)?callback():(target.eventedCallbacks||(target.eventedCallbacks=[]),target.eventedCallbacks.push(callback))},isValidEventType=function(type){return"string"==typeof type&&/\S/.test(type)||Array.isArray(type)&&!!type.length},validateTarget=function(target){if(!target.nodeName&&!isEvented(target))throw new Error("Invalid target; must be a DOM node or evented object.")},validateEventType=function(type){if(!isValidEventType(type))throw new Error("Invalid event type; must be a non-empty string or array.")},validateListener=function(listener){if("function"!=typeof listener)throw new Error("Invalid listener; must be a function.")},normalizeListenArgs=function(self,args){var target,type,listener,isTargetingSelf=args.length<3||args[0]===self||args[0]===self.eventBusEl_;return isTargetingSelf?(target=self.eventBusEl_,args.length>=3&&args.shift(),type=args[0],listener=args[1]):(target=args[0],type=args[1],listener=args[2]),validateTarget(target),validateEventType(type),validateListener(listener),listener=bind(self,listener),{isTargetingSelf:isTargetingSelf,target:target,type:type,listener:listener}},listen=function(target,method,type,listener){validateTarget(target),target.nodeName?Events[method](target,type,listener):target[method](type,listener)},EventedMixin={on:function(){for(var _this=this,_len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];var _normalizeListenArgs=normalizeListenArgs(this,args),isTargetingSelf=_normalizeListenArgs.isTargetingSelf,target=_normalizeListenArgs.target,type=_normalizeListenArgs.type,listener=_normalizeListenArgs.listener;if(listen(target,"on",type,listener),!isTargetingSelf){var removeListenerOnDispose=function(){return _this.off(target,type,listener)};removeListenerOnDispose.guid=listener.guid;var removeRemoverOnTargetDispose=function(){return _this.off("dispose",removeListenerOnDispose)};removeRemoverOnTargetDispose.guid=listener.guid,listen(this,"on","dispose",removeListenerOnDispose),listen(target,"on","dispose",removeRemoverOnTargetDispose)}},one:function(){for(var _this2=this,_len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++)args[_key2]=arguments[_key2];var _normalizeListenArgs2=normalizeListenArgs(this,args),isTargetingSelf=_normalizeListenArgs2.isTargetingSelf,target=_normalizeListenArgs2.target,type=_normalizeListenArgs2.type,listener=_normalizeListenArgs2.listener;if(isTargetingSelf)listen(target,"one",type,listener);else{var wrapper=function wrapper(){_this2.off(target,type,wrapper);for(var _len3=arguments.length,largs=new Array(_len3),_key3=0;_key3<_len3;_key3++)largs[_key3]=arguments[_key3];listener.apply(null,largs)};wrapper.guid=listener.guid,listen(target,"one",type,wrapper)}},any:function(){for(var _this3=this,_len4=arguments.length,args=new Array(_len4),_key4=0;_key4<_len4;_key4++)args[_key4]=arguments[_key4];var _normalizeListenArgs3=normalizeListenArgs(this,args),isTargetingSelf=_normalizeListenArgs3.isTargetingSelf,target=_normalizeListenArgs3.target,type=_normalizeListenArgs3.type,listener=_normalizeListenArgs3.listener;if(isTargetingSelf)listen(target,"any",type,listener);else{var wrapper=function wrapper(){_this3.off(target,type,wrapper);for(var _len5=arguments.length,largs=new Array(_len5),_key5=0;_key5<_len5;_key5++)largs[_key5]=arguments[_key5];listener.apply(null,largs)};wrapper.guid=listener.guid,listen(target,"any",type,wrapper)}},off:function(targetOrType,typeOrListener,listener){if(!targetOrType||isValidEventType(targetOrType))off(this.eventBusEl_,targetOrType,typeOrListener);else{var target=targetOrType,type=typeOrListener;validateTarget(target),validateEventType(type),validateListener(listener),listener=bind(this,listener),this.off("dispose",listener),target.nodeName?(off(target,type,listener),off(target,"dispose",listener)):isEvented(target)&&(target.off(type,listener),target.off("dispose",listener))}},trigger:function(event,hash){return trigger(this.eventBusEl_,event,hash)}};function evented(target,options){void 0===options&&(options={});var _options=options,eventBusKey=_options.eventBusKey;if(eventBusKey){if(!target[eventBusKey].nodeName)throw new Error('The eventBusKey "'+eventBusKey+'" does not refer to an element.');target.eventBusEl_=target[eventBusKey]}else target.eventBusEl_=createEl("span",{className:"vjs-event-bus"});return assign(target,EventedMixin),target.eventedCallbacks&&target.eventedCallbacks.forEach(function(callback){callback()}),target.on("dispose",function(){target.off(),window$1.setTimeout(function(){target.eventBusEl_=null},0)}),target}var StatefulMixin={state:{},setState:function(stateUpdates){var _this=this;"function"==typeof stateUpdates&&(stateUpdates=stateUpdates());var changes;return each(stateUpdates,function(value,key){_this.state[key]!==value&&(changes=changes||{},changes[key]={from:_this.state[key],to:value}),_this.state[key]=value}),changes&&isEvented(this)&&this.trigger({changes:changes,type:"statechanged"}),changes}};function stateful(target,defaultState){return assign(target,StatefulMixin),target.state=assign({},target.state,defaultState),"function"==typeof target.handleStateChanged&&isEvented(target)&&target.on("statechanged",target.handleStateChanged),target}var toLowerCase=function(string){return"string"!=typeof string?string:string.replace(/./,function(w){return w.toLowerCase()})},toTitleCase=function(string){return"string"!=typeof string?string:string.replace(/./,function(w){return w.toUpperCase()})},titleCaseEquals=function(str1,str2){return toTitleCase(str1)===toTitleCase(str2)};function mergeOptions(){for(var result={},_len=arguments.length,sources=new Array(_len),_key=0;_key<_len;_key++)sources[_key]=arguments[_key];return sources.forEach(function(source){source&&each(source,function(value,key){if(!isPlain(value))return void(result[key]=value);isPlain(result[key])||(result[key]={}),result[key]=mergeOptions(result[key],value)})}),result}var Component=function(){function Component(player,options,ready){if(!player&&this.play?this.player_=player=this:this.player_=player,this.parentComponent_=null,this.options_=mergeOptions({},this.options_),options=this.options_=mergeOptions(this.options_,options),this.id_=options.id||options.el&&options.el.id,!this.id_){var id=player&&player.id&&player.id()||"no_player";this.id_=id+"_component_"+newGUID()}this.name_=options.name||null,options.el?this.el_=options.el:!1!==options.createEl&&(this.el_=this.createEl()),!1!==options.evented&&evented(this,{eventBusKey:this.el_?"el_":null}),stateful(this,this.constructor.defaultState),this.children_=[],this.childIndex_={},this.childNameIndex_={};var SetSham;window$1.Set||(SetSham=function(){function SetSham(){this.set_={}}var _proto2=SetSham.prototype;return _proto2.has=function(key){return key in this.set_},_proto2.delete=function(key){var has=this.has(key);return delete this.set_[key],has},_proto2.add=function(key){return this.set_[key]=1,this},_proto2.forEach=function(callback,thisArg){for(var key in this.set_)callback.call(thisArg,key,key,this)},SetSham}()),this.setTimeoutIds_=window$1.Set?new Set:new SetSham,
this.setIntervalIds_=window$1.Set?new Set:new SetSham,this.rafIds_=window$1.Set?new Set:new SetSham,this.clearingTimersOnDispose_=!1,!1!==options.initChildren&&this.initChildren(),this.ready(ready),!1!==options.reportTouchActivity&&this.enableTouchActivity()}var _proto=Component.prototype;return _proto.dispose=function(){if(this.trigger({type:"dispose",bubbles:!1}),this.children_)for(var i=this.children_.length-1;i>=0;i--)this.children_[i].dispose&&this.children_[i].dispose();this.children_=null,this.childIndex_=null,this.childNameIndex_=null,this.parentComponent_=null,this.el_&&(this.el_.parentNode&&this.el_.parentNode.removeChild(this.el_),DomData.has(this.el_)&&DomData.delete(this.el_),this.el_=null),this.player_=null},_proto.player=function(){return this.player_},_proto.options=function(obj){return obj?(this.options_=mergeOptions(this.options_,obj),this.options_):this.options_},_proto.el=function(){return this.el_},_proto.createEl=function(tagName,properties,attributes){return createEl(tagName,properties,attributes)},_proto.localize=function(string,tokens,defaultValue){void 0===defaultValue&&(defaultValue=string);var code=this.player_.language&&this.player_.language(),languages=this.player_.languages&&this.player_.languages(),language=languages&&languages[code],primaryCode=code&&code.split("-")[0],primaryLang=languages&&languages[primaryCode],localizedString=defaultValue;return language&&language[string]?localizedString=language[string]:primaryLang&&primaryLang[string]&&(localizedString=primaryLang[string]),tokens&&(localizedString=localizedString.replace(/\{(\d+)\}/g,function(match,index){var value=tokens[index-1],ret=value;return void 0===value&&(ret=match),ret})),localizedString},_proto.contentEl=function(){return this.contentEl_||this.el_},_proto.id=function(){return this.id_},_proto.name=function(){return this.name_},_proto.children=function(){return this.children_},_proto.getChildById=function(id){return this.childIndex_[id]},_proto.getChild=function(name){if(name)return this.childNameIndex_[name]},_proto.addChild=function(child,options,index){void 0===options&&(options={}),void 0===index&&(index=this.children_.length);var component,componentName;if("string"==typeof child){componentName=toTitleCase(child);var componentClassName=options.componentClass||componentName;options.name=componentName;var ComponentClass=Component.getComponent(componentClassName);if(!ComponentClass)throw new Error("Component "+componentClassName+" does not exist");if("function"!=typeof ComponentClass)return null;component=new ComponentClass(this.player_||this,options)}else component=child;if(component.parentComponent_&&component.parentComponent_.removeChild(component),this.children_.splice(index,0,component),component.parentComponent_=this,"function"==typeof component.id&&(this.childIndex_[component.id()]=component),componentName=componentName||component.name&&toTitleCase(component.name()),componentName&&(this.childNameIndex_[componentName]=component,this.childNameIndex_[toLowerCase(componentName)]=component),"function"==typeof component.el&&component.el()){var childNodes=this.contentEl().children,refNode=childNodes[index]||null;this.contentEl().insertBefore(component.el(),refNode)}return component},_proto.removeChild=function(component){if("string"==typeof component&&(component=this.getChild(component)),component&&this.children_){for(var childFound=!1,i=this.children_.length-1;i>=0;i--)if(this.children_[i]===component){childFound=!0,this.children_.splice(i,1);break}if(childFound){component.parentComponent_=null,this.childIndex_[component.id()]=null,this.childNameIndex_[toTitleCase(component.name())]=null,this.childNameIndex_[toLowerCase(component.name())]=null;var compEl=component.el();compEl&&compEl.parentNode===this.contentEl()&&this.contentEl().removeChild(component.el())}}},_proto.initChildren=function(){var _this=this,children=this.options_.children;if(children){var workingChildren,parentOptions=this.options_,handleAdd=function(child){var name=child.name,opts=child.opts;if(void 0!==parentOptions[name]&&(opts=parentOptions[name]),!1!==opts){!0===opts&&(opts={}),opts.playerOptions=_this.options_.playerOptions;var newChild=_this.addChild(name,opts);newChild&&(_this[name]=newChild)}},Tech=Component.getComponent("Tech");workingChildren=Array.isArray(children)?children:Object.keys(children),workingChildren.concat(Object.keys(this.options_).filter(function(child){return!workingChildren.some(function(wchild){return"string"==typeof wchild?child===wchild:child===wchild.name})})).map(function(child){var name,opts;return"string"==typeof child?(name=child,opts=children[name]||_this.options_[name]||{}):(name=child.name,opts=child),{name:name,opts:opts}}).filter(function(child){var c=Component.getComponent(child.opts.componentClass||toTitleCase(child.name));return c&&!Tech.isTech(c)}).forEach(handleAdd)}},_proto.buildCSSClass=function(){return""},_proto.ready=function(fn,sync){if(void 0===sync&&(sync=!1),fn)return this.isReady_?void(sync?fn.call(this):this.setTimeout(fn,1)):(this.readyQueue_=this.readyQueue_||[],void this.readyQueue_.push(fn))},_proto.triggerReady=function(){this.isReady_=!0,this.setTimeout(function(){var readyQueue=this.readyQueue_;this.readyQueue_=[],readyQueue&&readyQueue.length>0&&readyQueue.forEach(function(fn){fn.call(this)},this),this.trigger("ready")},1)},_proto.$=function(selector,context){return $(selector,context||this.contentEl())},_proto.$$=function(selector,context){return $$(selector,context||this.contentEl())},_proto.hasClass=function(classToCheck){return hasClass(this.el_,classToCheck)},_proto.addClass=function(classToAdd){addClass(this.el_,classToAdd)},_proto.removeClass=function(classToRemove){removeClass(this.el_,classToRemove)},_proto.toggleClass=function(classToToggle,predicate){toggleClass(this.el_,classToToggle,predicate)},_proto.show=function(){this.removeClass("vjs-hidden")},_proto.hide=function(){this.addClass("vjs-hidden")},_proto.lockShowing=function(){this.addClass("vjs-lock-showing")},_proto.unlockShowing=function(){this.removeClass("vjs-lock-showing")},_proto.getAttribute=function(attribute){return getAttribute(this.el_,attribute)},_proto.setAttribute=function(attribute,value){setAttribute(this.el_,attribute,value)},_proto.removeAttribute=function(attribute){removeAttribute(this.el_,attribute)},_proto.width=function(num,skipListeners){return this.dimension("width",num,skipListeners)},_proto.height=function(num,skipListeners){return this.dimension("height",num,skipListeners)},_proto.dimensions=function(width,height){this.width(width,!0),this.height(height)},_proto.dimension=function(widthOrHeight,num,skipListeners){if(void 0!==num)return null!==num&&num===num||(num=0),-1!==(""+num).indexOf("%")||-1!==(""+num).indexOf("px")?this.el_.style[widthOrHeight]=num:this.el_.style[widthOrHeight]="auto"===num?"":num+"px",void(skipListeners||this.trigger("componentresize"));if(!this.el_)return 0;var val=this.el_.style[widthOrHeight],pxIndex=val.indexOf("px");return-1!==pxIndex?parseInt(val.slice(0,pxIndex),10):parseInt(this.el_["offset"+toTitleCase(widthOrHeight)],10)},_proto.currentDimension=function(widthOrHeight){var computedWidthOrHeight=0;if("width"!==widthOrHeight&&"height"!==widthOrHeight)throw new Error("currentDimension only accepts width or height value");if(computedWidthOrHeight=computedStyle(this.el_,widthOrHeight),0===(computedWidthOrHeight=parseFloat(computedWidthOrHeight))||isNaN(computedWidthOrHeight)){var rule="offset"+toTitleCase(widthOrHeight);computedWidthOrHeight=this.el_[rule]}return computedWidthOrHeight},_proto.currentDimensions=function(){return{width:this.currentDimension("width"),height:this.currentDimension("height")}},_proto.currentWidth=function(){return this.currentDimension("width")},_proto.currentHeight=function(){return this.currentDimension("height")},_proto.focus=function(){this.el_.focus()},_proto.blur=function(){this.el_.blur()},_proto.handleKeyDown=function(event){this.player_&&(event.stopPropagation(),this.player_.handleKeyDown(event))},_proto.handleKeyPress=function(event){this.handleKeyDown(event)},_proto.emitTapEvents=function(){var couldBeTap,touchStart=0,firstTouch=null;this.on("touchstart",function(event){1===event.touches.length&&(firstTouch={pageX:event.touches[0].pageX,pageY:event.touches[0].pageY},touchStart=window$1.performance.now(),couldBeTap=!0)}),this.on("touchmove",function(event){if(event.touches.length>1)couldBeTap=!1;else if(firstTouch){var xdiff=event.touches[0].pageX-firstTouch.pageX,ydiff=event.touches[0].pageY-firstTouch.pageY,touchDistance=Math.sqrt(xdiff*xdiff+ydiff*ydiff);touchDistance>10&&(couldBeTap=!1)}});var noTap=function(){couldBeTap=!1};this.on("touchleave",noTap),this.on("touchcancel",noTap),this.on("touchend",function(event){if(firstTouch=null,!0===couldBeTap){window$1.performance.now()-touchStart<200&&(event.preventDefault(),this.trigger("tap"))}})},_proto.enableTouchActivity=function(){if(this.player()&&this.player().reportUserActivity){var touchHolding,report=bind(this.player(),this.player().reportUserActivity);this.on("touchstart",function(){report(),this.clearInterval(touchHolding),touchHolding=this.setInterval(report,250)});var touchEnd=function(event){report(),this.clearInterval(touchHolding)};this.on("touchmove",report),this.on("touchend",touchEnd),this.on("touchcancel",touchEnd)}},_proto.setTimeout=function(fn,timeout){var timeoutId,_this2=this;return fn=bind(this,fn),this.clearTimersOnDispose_(),timeoutId=window$1.setTimeout(function(){_this2.setTimeoutIds_.has(timeoutId)&&_this2.setTimeoutIds_.delete(timeoutId),fn()},timeout),this.setTimeoutIds_.add(timeoutId),timeoutId},_proto.clearTimeout=function(timeoutId){return this.setTimeoutIds_.has(timeoutId)&&(this.setTimeoutIds_.delete(timeoutId),window$1.clearTimeout(timeoutId)),timeoutId},_proto.setInterval=function(fn,interval){fn=bind(this,fn),this.clearTimersOnDispose_();var intervalId=window$1.setInterval(fn,interval);return this.setIntervalIds_.add(intervalId),intervalId},_proto.clearInterval=function(intervalId){return this.setIntervalIds_.has(intervalId)&&(this.setIntervalIds_.delete(intervalId),window$1.clearInterval(intervalId)),intervalId},_proto.requestAnimationFrame=function(fn){var _this3=this;if(!this.supportsRaf_)return this.setTimeout(fn,1e3/60);this.clearTimersOnDispose_();var id;return fn=bind(this,fn),id=window$1.requestAnimationFrame(function(){_this3.rafIds_.has(id)&&_this3.rafIds_.delete(id),fn()}),this.rafIds_.add(id),id},_proto.cancelAnimationFrame=function(id){return this.supportsRaf_?(this.rafIds_.has(id)&&(this.rafIds_.delete(id),window$1.cancelAnimationFrame(id)),id):this.clearTimeout(id)},_proto.clearTimersOnDispose_=function(){var _this4=this;this.clearingTimersOnDispose_||(this.clearingTimersOnDispose_=!0,this.one("dispose",function(){[["rafIds_","cancelAnimationFrame"],["setTimeoutIds_","clearTimeout"],["setIntervalIds_","clearInterval"]].forEach(function(_ref){var idName=_ref[0],cancelName=_ref[1];_this4[idName].forEach(_this4[cancelName],_this4)}),_this4.clearingTimersOnDispose_=!1}))},Component.registerComponent=function(name,ComponentToRegister){if("string"!=typeof name||!name)throw new Error('Illegal component name, "'+name+'"; must be a non-empty string.');var Tech=Component.getComponent("Tech"),isTech=Tech&&Tech.isTech(ComponentToRegister),isComp=Component===ComponentToRegister||Component.prototype.isPrototypeOf(ComponentToRegister.prototype);if(isTech||!isComp){var reason;throw reason=isTech?"techs must be registered using Tech.registerTech()":"must be a Component subclass",new Error('Illegal component, "'+name+'"; '+reason+".")}name=toTitleCase(name),Component.components_||(Component.components_={});var Player=Component.getComponent("Player");if("Player"===name&&Player&&Player.players){var players=Player.players,playerNames=Object.keys(players);if(players&&playerNames.length>0&&playerNames.map(function(pname){return players[pname]}).every(Boolean))throw new Error("Can not register Player component after player has been created.")}return Component.components_[name]=ComponentToRegister,Component.components_[toLowerCase(name)]=ComponentToRegister,ComponentToRegister},Component.getComponent=function(name){if(name&&Component.components_)return Component.components_[name]},Component}();Component.prototype.supportsRaf_="function"==typeof window$1.requestAnimationFrame&&"function"==typeof window$1.cancelAnimationFrame,Component.registerComponent("Component",Component);function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o})(o,p)}function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _construct(Parent,args,Class){return _construct=isNativeReflectConstruct()?Reflect.construct:function(Parent,args,Class){var a=[null];a.push.apply(a,args);var Constructor=Function.bind.apply(Parent,a),instance=new Constructor;return Class&&_setPrototypeOf(instance,Class.prototype),instance},_construct.apply(null,arguments)}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}var USER_AGENT=window$1.navigator&&window$1.navigator.userAgent||"",webkitVersionMap=/AppleWebKit\/([\d.]+)/i.exec(USER_AGENT),appleWebkitVersion=webkitVersionMap?parseFloat(webkitVersionMap.pop()):null,IS_IPAD=/iPad/i.test(USER_AGENT),IS_IPHONE=/iPhone/i.test(USER_AGENT)&&!IS_IPAD,IS_IPOD=/iPod/i.test(USER_AGENT),IS_IOS=IS_IPHONE||IS_IPAD||IS_IPOD,IOS_VERSION=function(){var match=USER_AGENT.match(/OS (\d+)_/i);return match&&match[1]?match[1]:null}(),IS_ANDROID=/Android/i.test(USER_AGENT),ANDROID_VERSION=function(){var match=USER_AGENT.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!match)return null;var major=match[1]&&parseFloat(match[1]),minor=match[2]&&parseFloat(match[2]);return major&&minor?parseFloat(match[1]+"."+match[2]):major||null}(),IS_NATIVE_ANDROID=IS_ANDROID&&ANDROID_VERSION<5&&appleWebkitVersion<537,IS_FIREFOX=/Firefox/i.test(USER_AGENT),IS_EDGE=/Edge/i.test(USER_AGENT),IS_CHROME=!IS_EDGE&&(/Chrome/i.test(USER_AGENT)||/CriOS/i.test(USER_AGENT)),CHROME_VERSION=function(){var match=USER_AGENT.match(/(Chrome|CriOS)\/(\d+)/);return match&&match[2]?parseFloat(match[2]):null}(),IE_VERSION=function(){var result=/MSIE\s(\d+)\.\d/.exec(USER_AGENT),version=result&&parseFloat(result[1]);return!version&&/Trident\/7.0/i.test(USER_AGENT)&&/rv:11.0/.test(USER_AGENT)&&(version=11),version}(),IS_SAFARI=/Safari/i.test(USER_AGENT)&&!IS_CHROME&&!IS_ANDROID&&!IS_EDGE,IS_ANY_SAFARI=(IS_SAFARI||IS_IOS)&&!IS_CHROME,IS_WINDOWS=/Windows/i.test(USER_AGENT),TOUCH_ENABLED=isReal()&&("ontouchstart"in window$1||window$1.navigator.maxTouchPoints||window$1.DocumentTouch&&window$1.document instanceof window$1.DocumentTouch),browser=Object.freeze({IS_IPAD:IS_IPAD,IS_IPHONE:IS_IPHONE,IS_IPOD:IS_IPOD,IS_IOS:IS_IOS,IOS_VERSION:IOS_VERSION,IS_ANDROID:IS_ANDROID,ANDROID_VERSION:ANDROID_VERSION,IS_NATIVE_ANDROID:IS_NATIVE_ANDROID,IS_FIREFOX:IS_FIREFOX,IS_EDGE:IS_EDGE,IS_CHROME:IS_CHROME,CHROME_VERSION:CHROME_VERSION,IE_VERSION:IE_VERSION,IS_SAFARI:IS_SAFARI,IS_ANY_SAFARI:IS_ANY_SAFARI,IS_WINDOWS:IS_WINDOWS,TOUCH_ENABLED:TOUCH_ENABLED});function rangeCheck(fnName,index,maxIndex){if("number"!=typeof index||index<0||index>maxIndex)throw new Error("Failed to execute '"+fnName+"' on 'TimeRanges': The index provided ("+index+") is non-numeric or out of bounds (0-"+maxIndex+").")}function getRange(fnName,valueIndex,ranges,rangeIndex){return rangeCheck(fnName,rangeIndex,ranges.length-1),ranges[rangeIndex][valueIndex]}function createTimeRangesObj(ranges){return void 0===ranges||0===ranges.length?{length:0,start:function(){throw new Error("This TimeRanges object is empty")},end:function(){throw new Error("This TimeRanges object is empty")}}:{length:ranges.length,start:getRange.bind(null,"start",0,ranges),end:getRange.bind(null,"end",1,ranges)}}function createTimeRanges(start,end){return Array.isArray(start)?createTimeRangesObj(start):void 0===start||void 0===end?createTimeRangesObj():createTimeRangesObj([[start,end]])}function bufferedPercent(buffered,duration){var start,end,bufferedDuration=0;if(!duration)return 0;buffered&&buffered.length||(buffered=createTimeRanges(0,0));for(var i=0;i<buffered.length;i++)start=buffered.start(i),end=buffered.end(i),end>duration&&(end=duration),bufferedDuration+=end-start;return bufferedDuration/duration}for(var browserApi,FullscreenApi={prefixed:!0},apiMap=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror","fullscreen"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror","-webkit-full-screen"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror","-moz-full-screen"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError","-ms-fullscreen"]],specApi=apiMap[0],i=0;i<apiMap.length;i++)if(apiMap[i][1]in document){browserApi=apiMap[i];break}if(browserApi){for(var _i=0;_i<browserApi.length;_i++)FullscreenApi[specApi[_i]]=browserApi[_i];FullscreenApi.prefixed=browserApi[0]!==specApi[0]}function MediaError(value){if(value instanceof MediaError)return value;"number"==typeof value?this.code=value:"string"==typeof value?this.message=value:isObject(value)&&("number"==typeof value.code&&(this.code=value.code),assign(this,value)),this.message||(this.message=MediaError.defaultMessages[this.code]||"")}MediaError.prototype.code=0,MediaError.prototype.message="",MediaError.prototype.status=null,MediaError.errorTypes=["MEDIA_ERR_CUSTOM","MEDIA_ERR_ABORTED","MEDIA_ERR_NETWORK","MEDIA_ERR_DECODE","MEDIA_ERR_SRC_NOT_SUPPORTED","MEDIA_ERR_ENCRYPTED"],MediaError.defaultMessages={1:"You aborted the media playback",2:"A network error caused the media download to fail part-way.",3:"The media playback was aborted due to a corruption problem or because the media used features your browser did not support.",4:"The media could not be loaded, either because the server or network failed or because the format is not supported.",5:"The media is encrypted and we do not have the keys to decrypt it."};for(var errNum=0;errNum<MediaError.errorTypes.length;errNum++)MediaError[MediaError.errorTypes[errNum]]=errNum,MediaError.prototype[MediaError.errorTypes[errNum]]=errNum;var tuple=SafeParseTuple;function SafeParseTuple(obj,reviver){var json,error=null;try{json=JSON.parse(obj,reviver)}catch(err){error=err}return[error,json]}function isPromise(value){return void 0!==value&&null!==value&&"function"==typeof value.then}function silencePromise(value){isPromise(value)&&value.then(null,function(e){})}var trackToJson_=function(track){return["kind","label","language","id","inBandMetadataTrackDispatchType","mode","src"].reduce(function(acc,prop,i){return track[prop]&&(acc[prop]=track[prop]),acc},{cues:track.cues&&Array.prototype.map.call(track.cues,function(cue){return{startTime:cue.startTime,endTime:cue.endTime,text:cue.text,id:cue.id}})})},textTracksToJson=function(tech){var trackEls=tech.$$("track"),trackObjs=Array.prototype.map.call(trackEls,function(t){return t.track});return Array.prototype.map.call(trackEls,function(trackEl){var json=trackToJson_(trackEl.track);return trackEl.src&&(json.src=trackEl.src),json}).concat(Array.prototype.filter.call(tech.textTracks(),function(track){return-1===trackObjs.indexOf(track)}).map(trackToJson_))},jsonToTextTracks=function(json,tech){return json.forEach(function(track){var addedTrack=tech.addRemoteTextTrack(track).track;!track.src&&track.cues&&track.cues.forEach(function(cue){return addedTrack.addCue(cue)})}),tech.textTracks()},textTrackConverter={textTracksToJson:textTracksToJson,jsonToTextTracks:jsonToTextTracks,trackToJson_:trackToJson_};function createCommonjsModule(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}var keycode=createCommonjsModule(function(module,exports){function keyCode(searchInput){if(searchInput&&"object"==typeof searchInput){var hasKeyCode=searchInput.which||searchInput.keyCode||searchInput.charCode;hasKeyCode&&(searchInput=hasKeyCode)}if("number"==typeof searchInput)return names[searchInput];var search=String(searchInput),foundNamedKey=codes[search.toLowerCase()];if(foundNamedKey)return foundNamedKey;var foundNamedKey=aliases[search.toLowerCase()];return foundNamedKey||(1===search.length?search.charCodeAt(0):void 0)}keyCode.isEventKey=function(event,nameOrCode){if(event&&"object"==typeof event){var keyCode=event.which||event.keyCode||event.charCode;if(null===keyCode||void 0===keyCode)return!1;if("string"==typeof nameOrCode){var foundNamedKey=codes[nameOrCode.toLowerCase()];if(foundNamedKey)return foundNamedKey===keyCode;var foundNamedKey=aliases[nameOrCode.toLowerCase()];if(foundNamedKey)return foundNamedKey===keyCode}else if("number"==typeof nameOrCode)return nameOrCode===keyCode;return!1}},exports=module.exports=keyCode;var codes=exports.code=exports.codes={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,"pause/break":19,"caps lock":20,esc:27,space:32,"page up":33,"page down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46,command:91,"left command":91,"right command":93,"numpad *":106,"numpad +":107,"numpad -":109,"numpad .":110,"numpad /":111,"num lock":144,"scroll lock":145,"my computer":182,"my calculator":183,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},aliases=exports.aliases={windows:91,"â§":16,"â¥":18,"â":17,"â":91,ctl:17,control:17,option:18,pause:19,break:19,caps:20,return:13,escape:27,spc:32,spacebar:32,pgup:33,pgdn:34,ins:45,del:46,cmd:91};for(i=97;i<123;i++)codes[String.fromCharCode(i)]=i-32;for(var i=48;i<58;i++)codes[i-48]=i;for(i=1;i<13;i++)codes["f"+i]=i+111;for(i=0;i<10;i++)codes["numpad "+i]=i+96;var names=exports.names=exports.title={};for(i in codes)names[codes[i]]=i;for(var alias in aliases)codes[alias]=aliases[alias]}),MODAL_CLASS_NAME=(keycode.code,keycode.codes,keycode.aliases,keycode.names,keycode.title,"vjs-modal-dialog"),ModalDialog=function(_Component){_inheritsLoose(ModalDialog,_Component);function ModalDialog(player,options){var _this;return _this=_Component.call(this,player,options)||this,_this.opened_=_this.hasBeenOpened_=_this.hasBeenFilled_=!1,_this.closeable(!_this.options_.uncloseable),_this.content(_this.options_.content),_this.contentEl_=createEl("div",{className:MODAL_CLASS_NAME+"-content"},{role:"document"}),_this.descEl_=createEl("p",{className:MODAL_CLASS_NAME+"-description vjs-control-text",id:_this.el().getAttribute("aria-describedby")}),textContent(_this.descEl_,_this.description()),_this.el_.appendChild(_this.descEl_),_this.el_.appendChild(_this.contentEl_),_this}var _proto=ModalDialog.prototype;return _proto.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:this.buildCSSClass(),tabIndex:-1},{"aria-describedby":this.id()+"_description","aria-hidden":"true","aria-label":this.label(),role:"dialog"})},_proto.dispose=function(){this.contentEl_=null,this.descEl_=null,this.previouslyActiveEl_=null,_Component.prototype.dispose.call(this)},_proto.buildCSSClass=function(){return MODAL_CLASS_NAME+" vjs-hidden "+_Component.prototype.buildCSSClass.call(this)},_proto.label=function(){return this.localize(this.options_.label||"Modal Window")},_proto.description=function(){var desc=this.options_.description||this.localize("This is a modal window.");return this.closeable()&&(desc+=" "+this.localize("This modal can be closed by pressing the Escape key or activating the close button.")),desc},_proto.open=function(){if(!this.opened_){var player=this.player();this.trigger("beforemodalopen"),this.opened_=!0,(this.options_.fillAlways||!this.hasBeenOpened_&&!this.hasBeenFilled_)&&this.fill(),this.wasPlaying_=!player.paused(),this.options_.pauseOnOpen&&this.wasPlaying_&&player.pause(),this.on("keydown",this.handleKeyDown),this.hadControls_=player.controls(),player.controls(!1),this.show(),this.conditionalFocus_(),this.el().setAttribute("aria-hidden","false"),this.trigger("modalopen"),this.hasBeenOpened_=!0}},_proto.opened=function(value){return"boolean"==typeof value&&this[value?"open":"close"](),this.opened_},_proto.close=function(){if(this.opened_){var player=this.player();this.trigger("beforemodalclose"),this.opened_=!1,this.wasPlaying_&&this.options_.pauseOnOpen&&player.play(),this.off("keydown",this.handleKeyDown),this.hadControls_&&player.controls(!0),this.hide(),this.el().setAttribute("aria-hidden","true"),this.trigger("modalclose"),this.conditionalBlur_(),this.options_.temporary&&this.dispose()}},_proto.closeable=function(value){if("boolean"==typeof value){var closeable=this.closeable_=!!value,close=this.getChild("closeButton");if(closeable&&!close){var temp=this.contentEl_;this.contentEl_=this.el_,close=this.addChild("closeButton",{controlText:"Close Modal Dialog"}),this.contentEl_=temp,this.on(close,"close",this.close)}!closeable&&close&&(this.off(close,"close",this.close),this.removeChild(close),close.dispose())}return this.closeable_},_proto.fill=function(){this.fillWith(this.content())},_proto.fillWith=function(content){var contentEl=this.contentEl(),parentEl=contentEl.parentNode,nextSiblingEl=contentEl.nextSibling;this.trigger("beforemodalfill"),this.hasBeenFilled_=!0,parentEl.removeChild(contentEl),this.empty(),insertContent(contentEl,content),this.trigger("modalfill"),nextSiblingEl?parentEl.insertBefore(contentEl,nextSiblingEl):parentEl.appendChild(contentEl);var closeButton=this.getChild("closeButton");closeButton&&parentEl.appendChild(closeButton.el_)},_proto.empty=function(){this.trigger("beforemodalempty"),emptyEl(this.contentEl()),this.trigger("modalempty")},_proto.content=function(value){return void 0!==value&&(this.content_=value),this.content_},_proto.conditionalFocus_=function(){var activeEl=document.activeElement,playerEl=this.player_.el_;this.previouslyActiveEl_=null,(playerEl.contains(activeEl)||playerEl===activeEl)&&(this.previouslyActiveEl_=activeEl,this.focus())},_proto.conditionalBlur_=function(){this.previouslyActiveEl_&&(this.previouslyActiveEl_.focus(),this.previouslyActiveEl_=null)},_proto.handleKeyDown=function(event){if(event.stopPropagation(),keycode.isEventKey(event,"Escape")&&this.closeable())return event.preventDefault(),void this.close();if(keycode.isEventKey(event,"Tab")){for(var focusIndex,focusableEls=this.focusableEls_(),activeEl=this.el_.querySelector(":focus"),i=0;i<focusableEls.length;i++)if(activeEl===focusableEls[i]){focusIndex=i;break}document.activeElement===this.el_&&(focusIndex=0),event.shiftKey&&0===focusIndex?(focusableEls[focusableEls.length-1].focus(),event.preventDefault()):event.shiftKey||focusIndex!==focusableEls.length-1||(focusableEls[0].focus(),event.preventDefault())}},_proto.focusableEls_=function(){var allChildren=this.el_.querySelectorAll("*");return Array.prototype.filter.call(allChildren,function(child){return(child instanceof window$1.HTMLAnchorElement||child instanceof window$1.HTMLAreaElement)&&child.hasAttribute("href")||(child instanceof window$1.HTMLInputElement||child instanceof window$1.HTMLSelectElement||child instanceof window$1.HTMLTextAreaElement||child instanceof window$1.HTMLButtonElement)&&!child.hasAttribute("disabled")||child instanceof window$1.HTMLIFrameElement||child instanceof window$1.HTMLObjectElement||child instanceof window$1.HTMLEmbedElement||child.hasAttribute("tabindex")&&-1!==child.getAttribute("tabindex")||child.hasAttribute("contenteditable")})},ModalDialog}(Component);ModalDialog.prototype.options_={pauseOnOpen:!0,temporary:!0},Component.registerComponent("ModalDialog",ModalDialog);var TrackList=function(_EventTarget){_inheritsLoose(TrackList,_EventTarget);function TrackList(tracks){var _this;void 0===tracks&&(tracks=[]),_this=_EventTarget.call(this)||this,_this.tracks_=[],Object.defineProperty(_assertThisInitialized(_this),"length",{get:function(){return this.tracks_.length}});for(var i=0;i<tracks.length;i++)_this.addTrack(tracks[i]);return _this}var _proto=TrackList.prototype;return _proto.addTrack=function(track){var index=this.tracks_.length;""+index in this||Object.defineProperty(this,index,{get:function(){return this.tracks_[index]}}),-1===this.tracks_.indexOf(track)&&(this.tracks_.push(track),this.trigger({track:track,type:"addtrack",target:this}))},_proto.removeTrack=function(rtrack){for(var track,i=0,l=this.length;i<l;i++)if(this[i]===rtrack){track=this[i],track.off&&track.off(),this.tracks_.splice(i,1);break}track&&this.trigger({track:track,type:"removetrack",target:this})},_proto.getTrackById=function(id){for(var result=null,i=0,l=this.length;i<l;i++){var track=this[i];if(track.id===id){result=track;break}}return result},TrackList}(EventTarget);TrackList.prototype.allowedEvents_={change:"change",addtrack:"addtrack",removetrack:"removetrack"};for(var event in TrackList.prototype.allowedEvents_)TrackList.prototype["on"+event]=null;var disableOthers=function(list,track){for(var i=0;i<list.length;i++)Object.keys(list[i]).length&&track.id!==list[i].id&&(list[i].enabled=!1)},AudioTrackList=function(_TrackList){_inheritsLoose(AudioTrackList,_TrackList);function AudioTrackList(tracks){var _this;void 0===tracks&&(tracks=[]);for(var i=tracks.length-1;i>=0;i--)if(tracks[i].enabled){disableOthers(tracks,tracks[i]);break}return _this=_TrackList.call(this,tracks)||this,_this.changing_=!1,_this}var _proto=AudioTrackList.prototype;return _proto.addTrack=function(track){var _this2=this;track.enabled&&disableOthers(this,track),_TrackList.prototype.addTrack.call(this,track),track.addEventListener&&(track.enabledChange_=function(){_this2.changing_||(_this2.changing_=!0,disableOthers(_this2,track),_this2.changing_=!1,_this2.trigger("change"))},track.addEventListener("enabledchange",track.enabledChange_))},_proto.removeTrack=function(rtrack){_TrackList.prototype.removeTrack.call(this,rtrack),rtrack.removeEventListener&&rtrack.enabledChange_&&(rtrack.removeEventListener("enabledchange",rtrack.enabledChange_),rtrack.enabledChange_=null)},AudioTrackList}(TrackList),disableOthers$1=function(list,track){for(var i=0;i<list.length;i++)Object.keys(list[i]).length&&track.id!==list[i].id&&(list[i].selected=!1)},VideoTrackList=function(_TrackList){_inheritsLoose(VideoTrackList,_TrackList);function VideoTrackList(tracks){var _this;void 0===tracks&&(tracks=[]);for(var i=tracks.length-1;i>=0;i--)if(tracks[i].selected){disableOthers$1(tracks,tracks[i]);break}return _this=_TrackList.call(this,tracks)||this,_this.changing_=!1,Object.defineProperty(_assertThisInitialized(_this),"selectedIndex",{get:function(){for(var _i=0;_i<this.length;_i++)if(this[_i].selected)return _i;return-1},set:function(){}}),_this}var _proto=VideoTrackList.prototype;return _proto.addTrack=function(track){var _this2=this;track.selected&&disableOthers$1(this,track),_TrackList.prototype.addTrack.call(this,track),track.addEventListener&&(track.selectedChange_=function(){_this2.changing_||(_this2.changing_=!0,disableOthers$1(_this2,track),_this2.changing_=!1,_this2.trigger("change"))},track.addEventListener("selectedchange",track.selectedChange_))},_proto.removeTrack=function(rtrack){_TrackList.prototype.removeTrack.call(this,rtrack),rtrack.removeEventListener&&rtrack.selectedChange_&&(rtrack.removeEventListener("selectedchange",rtrack.selectedChange_),rtrack.selectedChange_=null)},VideoTrackList}(TrackList),TextTrackList=function(_TrackList){_inheritsLoose(TextTrackList,_TrackList)
;function TextTrackList(){return _TrackList.apply(this,arguments)||this}var _proto=TextTrackList.prototype;return _proto.addTrack=function(track){var _this=this;_TrackList.prototype.addTrack.call(this,track),this.queueChange_||(this.queueChange_=function(){return _this.queueTrigger("change")}),this.triggerSelectedlanguagechange||(this.triggerSelectedlanguagechange_=function(){return _this.trigger("selectedlanguagechange")}),track.addEventListener("modechange",this.queueChange_),-1===["metadata","chapters"].indexOf(track.kind)&&track.addEventListener("modechange",this.triggerSelectedlanguagechange_)},_proto.removeTrack=function(rtrack){_TrackList.prototype.removeTrack.call(this,rtrack),rtrack.removeEventListener&&(this.queueChange_&&rtrack.removeEventListener("modechange",this.queueChange_),this.selectedlanguagechange_&&rtrack.removeEventListener("modechange",this.triggerSelectedlanguagechange_))},TextTrackList}(TrackList),HtmlTrackElementList=function(){function HtmlTrackElementList(trackElements){void 0===trackElements&&(trackElements=[]),this.trackElements_=[],Object.defineProperty(this,"length",{get:function(){return this.trackElements_.length}});for(var i=0,length=trackElements.length;i<length;i++)this.addTrackElement_(trackElements[i])}var _proto=HtmlTrackElementList.prototype;return _proto.addTrackElement_=function(trackElement){var index=this.trackElements_.length;""+index in this||Object.defineProperty(this,index,{get:function(){return this.trackElements_[index]}}),-1===this.trackElements_.indexOf(trackElement)&&this.trackElements_.push(trackElement)},_proto.getTrackElementByTrack_=function(track){for(var trackElement_,i=0,length=this.trackElements_.length;i<length;i++)if(track===this.trackElements_[i].track){trackElement_=this.trackElements_[i];break}return trackElement_},_proto.removeTrackElement_=function(trackElement){for(var i=0,length=this.trackElements_.length;i<length;i++)if(trackElement===this.trackElements_[i]){this.trackElements_[i].track&&"function"==typeof this.trackElements_[i].track.off&&this.trackElements_[i].track.off(),"function"==typeof this.trackElements_[i].off&&this.trackElements_[i].off(),this.trackElements_.splice(i,1);break}},HtmlTrackElementList}(),TextTrackCueList=function(){function TextTrackCueList(cues){TextTrackCueList.prototype.setCues_.call(this,cues),Object.defineProperty(this,"length",{get:function(){return this.length_}})}var _proto=TextTrackCueList.prototype;return _proto.setCues_=function(cues){var oldLength=this.length||0,i=0,l=cues.length;this.cues_=cues,this.length_=cues.length;var defineProp=function(index){""+index in this||Object.defineProperty(this,""+index,{get:function(){return this.cues_[index]}})};if(oldLength<l)for(i=oldLength;i<l;i++)defineProp.call(this,i)},_proto.getCueById=function(id){for(var result=null,i=0,l=this.length;i<l;i++){var cue=this[i];if(cue.id===id){result=cue;break}}return result},TextTrackCueList}(),VideoTrackKind={alternative:"alternative",captions:"captions",main:"main",sign:"sign",subtitles:"subtitles",commentary:"commentary"},AudioTrackKind={alternative:"alternative",descriptions:"descriptions",main:"main","main-desc":"main-desc",translation:"translation",commentary:"commentary"},TextTrackKind={subtitles:"subtitles",captions:"captions",descriptions:"descriptions",chapters:"chapters",metadata:"metadata"},TextTrackMode={disabled:"disabled",hidden:"hidden",showing:"showing"},Track=function(_EventTarget){_inheritsLoose(Track,_EventTarget);function Track(options){var _this;void 0===options&&(options={}),_this=_EventTarget.call(this)||this;var trackProps={id:options.id||"vjs_track_"+newGUID(),kind:options.kind||"",label:options.label||"",language:options.language||""};for(var key in trackProps)!function(key){Object.defineProperty(_assertThisInitialized(_this),key,{get:function(){return trackProps[key]},set:function(){}})}(key);return _this}return Track}(EventTarget),parseUrl=function(url){var props=["protocol","hostname","port","pathname","search","hash","host"],a=document.createElement("a");a.href=url;var div,addToBody=""===a.host&&"file:"!==a.protocol;addToBody&&(div=document.createElement("div"),div.innerHTML='<a href="'+url+'"></a>',a=div.firstChild,div.setAttribute("style","display:none; position:absolute;"),document.body.appendChild(div));for(var details={},i=0;i<props.length;i++)details[props[i]]=a[props[i]];return"http:"===details.protocol&&(details.host=details.host.replace(/:80$/,"")),"https:"===details.protocol&&(details.host=details.host.replace(/:443$/,"")),details.protocol||(details.protocol=window$1.location.protocol),addToBody&&document.body.removeChild(div),details},getAbsoluteURL=function(url){if(!url.match(/^https?:\/\//)){var div=document.createElement("div");div.innerHTML='<a href="'+url+'">x</a>',url=div.firstChild.href}return url},getFileExtension=function(path){if("string"==typeof path){var splitPathRe=/^(\/?)([\s\S]*?)((?:\.{1,2}|[^\/]+?)(\.([^\.\/\?]+)))(?:[\/]*|[\?].*)$/,pathParts=splitPathRe.exec(path);if(pathParts)return pathParts.pop().toLowerCase()}return""},isCrossOrigin=function(url){var winLoc=window$1.location,urlInfo=parseUrl(url);return(":"===urlInfo.protocol?winLoc.protocol:urlInfo.protocol)+urlInfo.host!==winLoc.protocol+winLoc.host},Url=Object.freeze({parseUrl:parseUrl,getAbsoluteURL:getAbsoluteURL,getFileExtension:getFileExtension,isCrossOrigin:isCrossOrigin}),isFunction_1=isFunction,toString$1=Object.prototype.toString;function isFunction(fn){var string=toString$1.call(fn);return"[object Function]"===string||"function"==typeof fn&&"[object RegExp]"!==string||"undefined"!=typeof window&&(fn===window.setTimeout||fn===window.alert||fn===window.confirm||fn===window.prompt)}var keysShim,slice=Array.prototype.slice,toStr=Object.prototype.toString,implementation=function(that){var target=this;if("function"!=typeof target||"[object Function]"!==toStr.call(target))throw new TypeError("Function.prototype.bind called on incompatible "+target);for(var bound,args=slice.call(arguments,1),binder=function(){if(this instanceof bound){var result=target.apply(this,args.concat(slice.call(arguments)));return Object(result)===result?result:this}return target.apply(that,args.concat(slice.call(arguments)))},boundLength=Math.max(0,target.length-args.length),boundArgs=[],i=0;i<boundLength;i++)boundArgs.push("$"+i);if(bound=Function("binder","return function ("+boundArgs.join(",")+"){ return binder.apply(this,arguments); }")(binder),target.prototype){var Empty=function(){};Empty.prototype=target.prototype,bound.prototype=new Empty,Empty.prototype=null}return bound},functionBind=Function.prototype.bind||implementation,toStr$1=Object.prototype.toString,isArguments=function(value){var str=toStr$1.call(value),isArgs="[object Arguments]"===str;return isArgs||(isArgs="[object Array]"!==str&&null!==value&&"object"==typeof value&&"number"==typeof value.length&&value.length>=0&&"[object Function]"===toStr$1.call(value.callee)),isArgs};if(!Object.keys){var has=Object.prototype.hasOwnProperty,toStr$2=Object.prototype.toString,isArgs=isArguments,isEnumerable=Object.prototype.propertyIsEnumerable,hasDontEnumBug=!isEnumerable.call({toString:null},"toString"),hasProtoEnumBug=isEnumerable.call(function(){},"prototype"),dontEnums=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],equalsConstructorPrototype=function(o){var ctor=o.constructor;return ctor&&ctor.prototype===o},excludedKeys={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},hasAutomationEqualityBug=function(){if("undefined"==typeof window)return!1;for(var k in window)try{if(!excludedKeys["$"+k]&&has.call(window,k)&&null!==window[k]&&"object"==typeof window[k])try{equalsConstructorPrototype(window[k])}catch(e){return!0}}catch(e){return!0}return!1}(),equalsConstructorPrototypeIfNotBuggy=function(o){if("undefined"==typeof window||!hasAutomationEqualityBug)return equalsConstructorPrototype(o);try{return equalsConstructorPrototype(o)}catch(e){return!1}};keysShim=function(object){var isObject=null!==object&&"object"==typeof object,isFunction="[object Function]"===toStr$2.call(object),isArguments=isArgs(object),isString=isObject&&"[object String]"===toStr$2.call(object),theKeys=[];if(!isObject&&!isFunction&&!isArguments)throw new TypeError("Object.keys called on a non-object");var skipProto=hasProtoEnumBug&&isFunction;if(isString&&object.length>0&&!has.call(object,0))for(var i=0;i<object.length;++i)theKeys.push(String(i));if(isArguments&&object.length>0)for(var j=0;j<object.length;++j)theKeys.push(String(j));else for(var name in object)skipProto&&"prototype"===name||!has.call(object,name)||theKeys.push(String(name));if(hasDontEnumBug)for(var skipConstructor=equalsConstructorPrototypeIfNotBuggy(object),k=0;k<dontEnums.length;++k)skipConstructor&&"constructor"===dontEnums[k]||!has.call(object,dontEnums[k])||theKeys.push(dontEnums[k]);return theKeys}}var implementation$1=keysShim,slice$1=Array.prototype.slice,origKeys=Object.keys,keysShim$1=origKeys?function(o){return origKeys(o)}:implementation$1,originalKeys=Object.keys;keysShim$1.shim=function(){if(Object.keys){(function(){var args=Object.keys(arguments);return args&&args.length===arguments.length})(1,2)||(Object.keys=function(object){return originalKeys(isArguments(object)?slice$1.call(object):object)})}else Object.keys=keysShim$1;return Object.keys||keysShim$1};var objectKeys=keysShim$1,hasSymbols="function"==typeof Symbol&&"symbol"==typeof Symbol("foo"),toStr$3=Object.prototype.toString,concat=Array.prototype.concat,origDefineProperty=Object.defineProperty,isFunction$1=function(fn){return"function"==typeof fn&&"[object Function]"===toStr$3.call(fn)},supportsDescriptors=origDefineProperty&&function(){var obj={};try{origDefineProperty(obj,"x",{enumerable:!1,value:obj});for(var _ in obj)return!1;return obj.x===obj}catch(e){return!1}}(),defineProperty=function(object,name,value,predicate){(!(name in object)||isFunction$1(predicate)&&predicate())&&(supportsDescriptors?origDefineProperty(object,name,{configurable:!0,enumerable:!1,value:value,writable:!0}):object[name]=value)},defineProperties=function(object,map){var predicates=arguments.length>2?arguments[2]:{},props=objectKeys(map);hasSymbols&&(props=concat.call(props,Object.getOwnPropertySymbols(map)));for(var i=0;i<props.length;i+=1)defineProperty(object,props[i],map[props[i]],predicates[props[i]])};defineProperties.supportsDescriptors=!!supportsDescriptors;var defineProperties_1=defineProperties,ThrowTypeError=Object.getOwnPropertyDescriptor?function(){return Object.getOwnPropertyDescriptor(arguments,"callee").get}():function(){throw new TypeError},hasSymbols$1="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator,getProto=Object.getPrototypeOf||function(x){return x.__proto__},TypedArray="undefined"==typeof Uint8Array?void 0:getProto(Uint8Array),INTRINSICS={"$ %Array%":Array,"$ %ArrayBuffer%":"undefined"==typeof ArrayBuffer?void 0:ArrayBuffer,"$ %ArrayBufferPrototype%":"undefined"==typeof ArrayBuffer?void 0:ArrayBuffer.prototype,"$ %ArrayIteratorPrototype%":hasSymbols$1?getProto([][Symbol.iterator]()):void 0,"$ %ArrayPrototype%":Array.prototype,"$ %ArrayProto_entries%":Array.prototype.entries,"$ %ArrayProto_forEach%":Array.prototype.forEach,"$ %ArrayProto_keys%":Array.prototype.keys,"$ %ArrayProto_values%":Array.prototype.values,"$ %AsyncFromSyncIteratorPrototype%":void 0,"$ %AsyncFunction%":void 0,"$ %AsyncFunctionPrototype%":void 0,"$ %AsyncGenerator%":void 0,"$ %AsyncGeneratorFunction%":void 0,"$ %AsyncGeneratorPrototype%":void 0,"$ %AsyncIteratorPrototype%":void 0,"$ %Atomics%":"undefined"==typeof Atomics?void 0:Atomics,"$ %Boolean%":Boolean,"$ %BooleanPrototype%":Boolean.prototype,"$ %DataView%":"undefined"==typeof DataView?void 0:DataView,"$ %DataViewPrototype%":"undefined"==typeof DataView?void 0:DataView.prototype,"$ %Date%":Date,"$ %DatePrototype%":Date.prototype,"$ %decodeURI%":decodeURI,"$ %decodeURIComponent%":decodeURIComponent,"$ %encodeURI%":encodeURI,"$ %encodeURIComponent%":encodeURIComponent,"$ %Error%":Error,"$ %ErrorPrototype%":Error.prototype,"$ %eval%":eval,"$ %EvalError%":EvalError,"$ %EvalErrorPrototype%":EvalError.prototype,"$ %Float32Array%":"undefined"==typeof Float32Array?void 0:Float32Array,"$ %Float32ArrayPrototype%":"undefined"==typeof Float32Array?void 0:Float32Array.prototype,"$ %Float64Array%":"undefined"==typeof Float64Array?void 0:Float64Array,"$ %Float64ArrayPrototype%":"undefined"==typeof Float64Array?void 0:Float64Array.prototype,"$ %Function%":Function,"$ %FunctionPrototype%":Function.prototype,"$ %Generator%":void 0,"$ %GeneratorFunction%":void 0,"$ %GeneratorPrototype%":void 0,"$ %Int8Array%":"undefined"==typeof Int8Array?void 0:Int8Array,"$ %Int8ArrayPrototype%":"undefined"==typeof Int8Array?void 0:Int8Array.prototype,"$ %Int16Array%":"undefined"==typeof Int16Array?void 0:Int16Array,"$ %Int16ArrayPrototype%":"undefined"==typeof Int16Array?void 0:Int8Array.prototype,"$ %Int32Array%":"undefined"==typeof Int32Array?void 0:Int32Array,"$ %Int32ArrayPrototype%":"undefined"==typeof Int32Array?void 0:Int32Array.prototype,"$ %isFinite%":isFinite,"$ %isNaN%":isNaN,"$ %IteratorPrototype%":hasSymbols$1?getProto(getProto([][Symbol.iterator]())):void 0,"$ %JSON%":JSON,"$ %JSONParse%":JSON.parse,"$ %Map%":"undefined"==typeof Map?void 0:Map,"$ %MapIteratorPrototype%":"undefined"!=typeof Map&&hasSymbols$1?getProto((new Map)[Symbol.iterator]()):void 0,"$ %MapPrototype%":"undefined"==typeof Map?void 0:Map.prototype,"$ %Math%":Math,"$ %Number%":Number,"$ %NumberPrototype%":Number.prototype,"$ %Object%":Object,"$ %ObjectPrototype%":Object.prototype,"$ %ObjProto_toString%":Object.prototype.toString,"$ %ObjProto_valueOf%":Object.prototype.valueOf,"$ %parseFloat%":parseFloat,"$ %parseInt%":parseInt,"$ %Promise%":"undefined"==typeof Promise?void 0:Promise,"$ %PromisePrototype%":"undefined"==typeof Promise?void 0:Promise.prototype,"$ %PromiseProto_then%":"undefined"==typeof Promise?void 0:Promise.prototype.then,"$ %Promise_all%":"undefined"==typeof Promise?void 0:Promise.all,"$ %Promise_reject%":"undefined"==typeof Promise?void 0:Promise.reject,"$ %Promise_resolve%":"undefined"==typeof Promise?void 0:Promise.resolve,"$ %Proxy%":"undefined"==typeof Proxy?void 0:Proxy,"$ %RangeError%":RangeError,"$ %RangeErrorPrototype%":RangeError.prototype,"$ %ReferenceError%":ReferenceError,"$ %ReferenceErrorPrototype%":ReferenceError.prototype,"$ %Reflect%":"undefined"==typeof Reflect?void 0:Reflect,"$ %RegExp%":RegExp,"$ %RegExpPrototype%":RegExp.prototype,"$ %Set%":"undefined"==typeof Set?void 0:Set,"$ %SetIteratorPrototype%":"undefined"!=typeof Set&&hasSymbols$1?getProto((new Set)[Symbol.iterator]()):void 0,"$ %SetPrototype%":"undefined"==typeof Set?void 0:Set.prototype,"$ %SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?void 0:SharedArrayBuffer,"$ %SharedArrayBufferPrototype%":"undefined"==typeof SharedArrayBuffer?void 0:SharedArrayBuffer.prototype,"$ %String%":String,"$ %StringIteratorPrototype%":hasSymbols$1?getProto(""[Symbol.iterator]()):void 0,"$ %StringPrototype%":String.prototype,"$ %Symbol%":hasSymbols$1?Symbol:void 0,"$ %SymbolPrototype%":hasSymbols$1?Symbol.prototype:void 0,"$ %SyntaxError%":SyntaxError,"$ %SyntaxErrorPrototype%":SyntaxError.prototype,"$ %ThrowTypeError%":ThrowTypeError,"$ %TypedArray%":TypedArray,"$ %TypedArrayPrototype%":TypedArray?TypedArray.prototype:void 0,"$ %TypeError%":TypeError,"$ %TypeErrorPrototype%":TypeError.prototype,"$ %Uint8Array%":"undefined"==typeof Uint8Array?void 0:Uint8Array,"$ %Uint8ArrayPrototype%":"undefined"==typeof Uint8Array?void 0:Uint8Array.prototype,"$ %Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?void 0:Uint8ClampedArray,"$ %Uint8ClampedArrayPrototype%":"undefined"==typeof Uint8ClampedArray?void 0:Uint8ClampedArray.prototype,"$ %Uint16Array%":"undefined"==typeof Uint16Array?void 0:Uint16Array,"$ %Uint16ArrayPrototype%":"undefined"==typeof Uint16Array?void 0:Uint16Array.prototype,"$ %Uint32Array%":"undefined"==typeof Uint32Array?void 0:Uint32Array,"$ %Uint32ArrayPrototype%":"undefined"==typeof Uint32Array?void 0:Uint32Array.prototype,"$ %URIError%":URIError,"$ %URIErrorPrototype%":URIError.prototype,"$ %WeakMap%":"undefined"==typeof WeakMap?void 0:WeakMap,"$ %WeakMapPrototype%":"undefined"==typeof WeakMap?void 0:WeakMap.prototype,"$ %WeakSet%":"undefined"==typeof WeakSet?void 0:WeakSet,"$ %WeakSetPrototype%":"undefined"==typeof WeakSet?void 0:WeakSet.prototype},GetIntrinsic=function(name,allowMissing){if(arguments.length>1&&"boolean"!=typeof allowMissing)throw new TypeError('"allowMissing" argument must be a boolean');var key="$ "+name;if(!(key in INTRINSICS))throw new SyntaxError("intrinsic "+name+" does not exist!");if(void 0===INTRINSICS[key]&&!allowMissing)throw new TypeError("intrinsic "+name+" exists, but is not available. Please file an issue!");return INTRINSICS[key]},src=functionBind.call(Function.call,Object.prototype.hasOwnProperty),$TypeError=GetIntrinsic("%TypeError%"),$SyntaxError=GetIntrinsic("%SyntaxError%"),predicates={"Property Descriptor":function(ES,Desc){if("Object"!==ES.Type(Desc))return!1;var allowed={"[[Configurable]]":!0,"[[Enumerable]]":!0,"[[Get]]":!0,"[[Set]]":!0,"[[Value]]":!0,"[[Writable]]":!0};for(var key in Desc)if(src(Desc,key)&&!allowed[key])return!1;var isData=src(Desc,"[[Value]]"),IsAccessor=src(Desc,"[[Get]]")||src(Desc,"[[Set]]");if(isData&&IsAccessor)throw new $TypeError("Property Descriptors may not be both accessor and data descriptors");return!0}},assertRecord=function(ES,recordType,argumentName,value){var predicate=predicates[recordType];if("function"!=typeof predicate)throw new $SyntaxError("unknown record type: "+recordType);if(!predicate(ES,value))throw new $TypeError(argumentName+" must be a "+recordType);console.log(predicate(ES,value),value)},_isNaN=Number.isNaN||function(a){return a!==a},$isNaN=Number.isNaN||function(a){return a!==a},_isFinite=Number.isFinite||function(x){return"number"==typeof x&&!$isNaN(x)&&x!==1/0&&x!==-1/0},sign=function(number){return number>=0?1:-1},mod=function(number,modulo){var remain=number%modulo;return Math.floor(remain>=0?remain:remain+modulo)},fnToStr=Function.prototype.toString,constructorRegex=/^\s*class\b/,isES6ClassFn=function(value){try{var fnStr=fnToStr.call(value);return constructorRegex.test(fnStr)}catch(e){return!1}},tryFunctionObject=function(value){try{return!isES6ClassFn(value)&&(fnToStr.call(value),!0)}catch(e){return!1}},toStr$4=Object.prototype.toString,hasToStringTag="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,isCallable=function(value){if(!value)return!1;if("function"!=typeof value&&"object"!=typeof value)return!1;if("function"==typeof value&&!value.prototype)return!0;if(hasToStringTag)return tryFunctionObject(value);if(isES6ClassFn(value))return!1;var strClass=toStr$4.call(value);return"[object Function]"===strClass||"[object GeneratorFunction]"===strClass},isPrimitive=function(value){return null===value||"function"!=typeof value&&"object"!=typeof value},toStr$5=Object.prototype.toString,ES5internalSlots={"[[DefaultValue]]":function(O){var actualHint;if((actualHint=arguments.length>1?arguments[1]:"[object Date]"===toStr$5.call(O)?String:Number)===String||actualHint===Number){var value,i,methods=actualHint===String?["toString","valueOf"]:["valueOf","toString"];for(i=0;i<methods.length;++i)if(isCallable(O[methods[i]])&&(value=O[methods[i]](),isPrimitive(value)))return value;throw new TypeError("No default value")}throw new TypeError("invalid [[DefaultValue]] hint supplied")}},es5=function(input){return isPrimitive(input)?input:arguments.length>1?ES5internalSlots["[[DefaultValue]]"](input,arguments[1]):ES5internalSlots["[[DefaultValue]]"](input)},$Object=GetIntrinsic("%Object%"),$TypeError$1=GetIntrinsic("%TypeError%"),$String=GetIntrinsic("%String%"),ES5={ToPrimitive:es5,ToBoolean:function(value){return!!value},ToNumber:function(value){return+value},ToInteger:function(value){var number=this.ToNumber(value);return _isNaN(number)?0:0!==number&&_isFinite(number)?sign(number)*Math.floor(Math.abs(number)):number},ToInt32:function(x){return this.ToNumber(x)>>0},ToUint32:function(x){return this.ToNumber(x)>>>0},ToUint16:function(value){var number=this.ToNumber(value);if(_isNaN(number)||0===number||!_isFinite(number))return 0;var posInt=sign(number)*Math.floor(Math.abs(number));return mod(posInt,65536)},ToString:function(value){return $String(value)},ToObject:function(value){return this.CheckObjectCoercible(value),$Object(value)},CheckObjectCoercible:function(value,optMessage){if(null==value)throw new $TypeError$1(optMessage||"Cannot call method on "+value);return value},IsCallable:isCallable,SameValue:function(x,y){return x===y?0!==x||1/x==1/y:_isNaN(x)&&_isNaN(y)},Type:function(x){return null===x?"Null":void 0===x?"Undefined":"function"==typeof x||"object"==typeof x?"Object":"number"==typeof x?"Number":"boolean"==typeof x?"Boolean":"string"==typeof x?"String":void 0},IsPropertyDescriptor:function(Desc){if("Object"!==this.Type(Desc))return!1;var allowed={"[[Configurable]]":!0,"[[Enumerable]]":!0,"[[Get]]":!0,"[[Set]]":!0,"[[Value]]":!0,"[[Writable]]":!0};for(var key in Desc)if(src(Desc,key)&&!allowed[key])return!1;var isData=src(Desc,"[[Value]]"),IsAccessor=src(Desc,"[[Get]]")||src(Desc,"[[Set]]");if(isData&&IsAccessor)throw new $TypeError$1("Property Descriptors may not be both accessor and data descriptors");return!0},IsAccessorDescriptor:function(Desc){return void 0!==Desc&&(assertRecord(this,"Property Descriptor","Desc",Desc),!(!src(Desc,"[[Get]]")&&!src(Desc,"[[Set]]")))},IsDataDescriptor:function(Desc){return void 0!==Desc&&(assertRecord(this,"Property Descriptor","Desc",Desc),!(!src(Desc,"[[Value]]")&&!src(Desc,"[[Writable]]")))},IsGenericDescriptor:function(Desc){return void 0!==Desc&&(assertRecord(this,"Property Descriptor","Desc",Desc),!this.IsAccessorDescriptor(Desc)&&!this.IsDataDescriptor(Desc))},FromPropertyDescriptor:function(Desc){if(void 0===Desc)return Desc;if(assertRecord(this,"Property Descriptor","Desc",Desc),this.IsDataDescriptor(Desc))return{value:Desc["[[Value]]"],writable:!!Desc["[[Writable]]"],enumerable:!!Desc["[[Enumerable]]"],configurable:!!Desc["[[Configurable]]"]};if(this.IsAccessorDescriptor(Desc))return{get:Desc["[[Get]]"],set:Desc["[[Set]]"],enumerable:!!Desc["[[Enumerable]]"],configurable:!!Desc["[[Configurable]]"]};throw new $TypeError$1("FromPropertyDescriptor must be called with a fully populated Property Descriptor")},ToPropertyDescriptor:function(Obj){if("Object"!==this.Type(Obj))throw new $TypeError$1("ToPropertyDescriptor requires an object");var desc={};if(src(Obj,"enumerable")&&(desc["[[Enumerable]]"]=this.ToBoolean(Obj.enumerable)),src(Obj,"configurable")&&(desc["[[Configurable]]"]=this.ToBoolean(Obj.configurable)),src(Obj,"value")&&(desc["[[Value]]"]=Obj.value),src(Obj,"writable")&&(desc["[[Writable]]"]=this.ToBoolean(Obj.writable)),src(Obj,"get")){var getter=Obj.get;if(void 0!==getter&&!this.IsCallable(getter))throw new TypeError("getter must be a function");desc["[[Get]]"]=getter}if(src(Obj,"set")){var setter=Obj.set;if(void 0!==setter&&!this.IsCallable(setter))throw new $TypeError$1("setter must be a function");desc["[[Set]]"]=setter}if((src(desc,"[[Get]]")||src(desc,"[[Set]]"))&&(src(desc,"[[Value]]")||src(desc,"[[Writable]]")))throw new $TypeError$1("Invalid property descriptor. Cannot both specify accessors and a value or writable attribute");return desc}},es5$1=ES5,replace=functionBind.call(Function.call,String.prototype.replace),leftWhitespace=/^[\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u180E\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF]+/,rightWhitespace=/[\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u180E\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF]+$/,implementation$2=function(){var S=es5$1.ToString(es5$1.CheckObjectCoercible(this));return replace(replace(S,leftWhitespace,""),rightWhitespace,"")},zeroWidthSpace="â",polyfill=function(){return String.prototype.trim&&zeroWidthSpace.trim()===zeroWidthSpace?String.prototype.trim:implementation$2},shim=function(){var polyfill$1=polyfill();return defineProperties_1(String.prototype,{trim:polyfill$1},{trim:function(){return String.prototype.trim!==polyfill$1}}),polyfill$1},boundTrim=functionBind.call(Function.call,polyfill());defineProperties_1(boundTrim,{getPolyfill:polyfill,implementation:implementation$2,shim:shim});var string_prototype_trim=boundTrim,toStr$6=Object.prototype.toString,hasOwnProperty=Object.prototype.hasOwnProperty,forEachArray=function(array,iterator,receiver){for(var i=0,len=array.length;i<len;i++)hasOwnProperty.call(array,i)&&(null==receiver?iterator(array[i],i,array):iterator.call(receiver,array[i],i,array))},forEachString=function(string,iterator,receiver){for(var i=0,len=string.length;i<len;i++)null==receiver?iterator(string.charAt(i),i,string):iterator.call(receiver,string.charAt(i),i,string)},forEachObject=function(object,iterator,receiver){for(var k in object)hasOwnProperty.call(object,k)&&(null==receiver?iterator(object[k],k,object):iterator.call(receiver,object[k],k,object))},forEach=function(list,iterator,thisArg){if(!isCallable(iterator))throw new TypeError("iterator must be a function");var receiver;arguments.length>=3&&(receiver=thisArg),"[object Array]"===toStr$6.call(list)?forEachArray(list,iterator,receiver):"string"==typeof list?forEachString(list,iterator,receiver):forEachObject(list,iterator,receiver)},forEach_1=forEach,isArray=function(arg){return"[object Array]"===Object.prototype.toString.call(arg)},parseHeaders=function(headers){if(!headers)return{};var result={};return forEach_1(string_prototype_trim(headers).split("\n"),function(row){var index=row.indexOf(":"),key=string_prototype_trim(row.slice(0,index)).toLowerCase(),value=string_prototype_trim(row.slice(index+1));void 0===result[key]?result[key]=value:isArray(result[key])?result[key].push(value):result[key]=[result[key],value]}),result},immutable=extend,hasOwnProperty$1=Object.prototype.hasOwnProperty;function extend(){for(var target={},i=0;i<arguments.length;i++){var source=arguments[i];for(var key in source)hasOwnProperty$1.call(source,key)&&(target[key]=source[key])}return target}var xhr=createXHR;createXHR.XMLHttpRequest=window$1.XMLHttpRequest||noop,createXHR.XDomainRequest="withCredentials"in new createXHR.XMLHttpRequest?createXHR.XMLHttpRequest:window$1.XDomainRequest,function(array,iterator){for(var i=0;i<array.length;i++)iterator(array[i])}(["get","put","post","patch","head","delete"],function(method){createXHR["delete"===method?"del":method]=function(uri,options,callback){return options=initParams(uri,options,callback),options.method=method.toUpperCase(),_createXHR(options)}});function isEmpty(obj){for(var i in obj)if(obj.hasOwnProperty(i))return!1;return!0}function initParams(uri,options,callback){var params=uri;return isFunction_1(options)?(callback=options,"string"==typeof uri&&(params={uri:uri})):params=immutable(options,{uri:uri}),params.callback=callback,params}function createXHR(uri,options,callback){return options=initParams(uri,options,callback),_createXHR(options)}function _createXHR(options){if(void 0===options.callback)throw new Error("callback argument missing");var called=!1,callback=function(err,response,body){called||(called=!0,options.callback(err,response,body))};function readystatechange(){4===xhr.readyState&&setTimeout(loadFunc,0)}function getBody(){var body=void 0;if(body=xhr.response?xhr.response:xhr.responseText||getXml(xhr),isJson)try{body=JSON.parse(body)}catch(e){}return body}function errorFunc(evt){return clearTimeout(timeoutTimer),evt instanceof Error||(evt=new Error(""+(evt||"Unknown XMLHttpRequest Error"))),evt.statusCode=0,callback(evt,failureResponse)}function loadFunc(){if(!aborted){var status;clearTimeout(timeoutTimer),status=options.useXDR&&void 0===xhr.status?200:1223===xhr.status?204:xhr.status;var response=failureResponse,err=null;return 0!==status?(response={body:getBody(),statusCode:status,method:method,headers:{},url:uri,rawRequest:xhr},xhr.getAllResponseHeaders&&(response.headers=parseHeaders(xhr.getAllResponseHeaders()))):err=new Error("Internal XMLHttpRequest Error"),callback(err,response,response.body)}}var xhr=options.xhr||null;xhr||(xhr=options.cors||options.useXDR?new createXHR.XDomainRequest:new createXHR.XMLHttpRequest);var key,aborted,timeoutTimer,uri=xhr.url=options.uri||options.url,method=xhr.method=options.method||"GET",body=options.body||options.data,headers=xhr.headers=options.headers||{},sync=!!options.sync,isJson=!1,failureResponse={body:void 0,headers:{},statusCode:0,method:method,url:uri,rawRequest:xhr};if("json"in options&&!1!==options.json&&(isJson=!0,headers.accept||headers.Accept||(headers.Accept="application/json"),"GET"!==method&&"HEAD"!==method&&(headers["content-type"]||headers["Content-Type"]||(headers["Content-Type"]="application/json"),body=JSON.stringify(!0===options.json?body:options.json))),xhr.onreadystatechange=readystatechange,xhr.onload=loadFunc,xhr.onerror=errorFunc,xhr.onprogress=function(){},xhr.onabort=function(){aborted=!0},xhr.ontimeout=errorFunc,xhr.open(method,uri,!sync,options.username,options.password),sync||(xhr.withCredentials=!!options.withCredentials),!sync&&options.timeout>0&&(timeoutTimer=setTimeout(function(){if(!aborted){aborted=!0,xhr.abort("timeout");var e=new Error("XMLHttpRequest timeout");e.code="ETIMEDOUT",errorFunc(e)}},options.timeout)),xhr.setRequestHeader)for(key in headers)headers.hasOwnProperty(key)&&xhr.setRequestHeader(key,headers[key]);else if(options.headers&&!isEmpty(options.headers))throw new Error("Headers cannot be set on an XDomainRequest object");return"responseType"in options&&(xhr.responseType=options.responseType),"beforeSend"in options&&"function"==typeof options.beforeSend&&options.beforeSend(xhr),xhr.send(body||null),xhr}function getXml(xhr){if("document"===xhr.responseType)return xhr.responseXML;var firefoxBugTakenEffect=xhr.responseXML&&"parsererror"===xhr.responseXML.documentElement.nodeName;return""!==xhr.responseType||firefoxBugTakenEffect?null:xhr.responseXML}function noop(){}var parseCues=function(srcContent,track){var parser=new window$1.WebVTT.Parser(window$1,window$1.vttjs,window$1.WebVTT.StringDecoder()),errors=[];parser.oncue=function(cue){track.addCue(cue)},parser.onparsingerror=function(error){errors.push(error)},parser.onflush=function(){track.trigger({type:"loadeddata",target:track})},parser.parse(srcContent),errors.length>0&&(window$1.console&&window$1.console.groupCollapsed&&window$1.console.groupCollapsed("Text Track parsing errors for "+track.src),errors.forEach(function(error){return log.error(error)}),window$1.console&&window$1.console.groupEnd&&window$1.console.groupEnd()),parser.flush()},loadTrack=function(src,track){var opts={uri:src},crossOrigin=isCrossOrigin(src);crossOrigin&&(opts.cors=crossOrigin),xhr(opts,bind(this,function(err,response,responseBody){if(err)return log.error(err,response);track.loaded_=!0,"function"!=typeof window$1.WebVTT?track.tech_&&track.tech_.any(["vttjsloaded","vttjserror"],function(event){return"vttjserror"===event.type?void log.error("vttjs failed to load, stopping trying to process "+track.src):parseCues(responseBody,track)}):parseCues(responseBody,track)}))},TextTrack=function(_Track){_inheritsLoose(TextTrack,_Track);function TextTrack(options){var _this;if(void 0===options&&(options={}),!options.tech)throw new Error("A tech was not provided.");var settings=mergeOptions(options,{kind:TextTrackKind[options.kind]||"subtitles",language:options.language||options.srclang||""
}),mode=TextTrackMode[settings.mode]||"disabled",default_=settings.default;"metadata"!==settings.kind&&"chapters"!==settings.kind||(mode="hidden"),_this=_Track.call(this,settings)||this,_this.tech_=settings.tech,_this.cues_=[],_this.activeCues_=[];var cues=new TextTrackCueList(_this.cues_),activeCues=new TextTrackCueList(_this.activeCues_),changed=!1,timeupdateHandler=bind(_assertThisInitialized(_this),function(){this.activeCues=this.activeCues,changed&&(this.trigger("cuechange"),changed=!1)});return"disabled"!==mode&&_this.tech_.ready(function(){_this.tech_.on("timeupdate",timeupdateHandler)},!0),Object.defineProperties(_assertThisInitialized(_this),{default:{get:function(){return default_},set:function(){}},mode:{get:function(){return mode},set:function(newMode){var _this2=this;TextTrackMode[newMode]&&(mode=newMode,"disabled"!==mode?this.tech_.ready(function(){_this2.tech_.on("timeupdate",timeupdateHandler)},!0):this.tech_.off("timeupdate",timeupdateHandler),this.trigger("modechange"))}},cues:{get:function(){return this.loaded_?cues:null},set:function(){}},activeCues:{get:function(){if(!this.loaded_)return null;if(0===this.cues.length)return activeCues;for(var ct=this.tech_.currentTime(),active=[],i=0,l=this.cues.length;i<l;i++){var cue=this.cues[i];cue.startTime<=ct&&cue.endTime>=ct?active.push(cue):cue.startTime===cue.endTime&&cue.startTime<=ct&&cue.startTime+.5>=ct&&active.push(cue)}if(changed=!1,active.length!==this.activeCues_.length)changed=!0;else for(var _i=0;_i<active.length;_i++)-1===this.activeCues_.indexOf(active[_i])&&(changed=!0);return this.activeCues_=active,activeCues.setCues_(this.activeCues_),activeCues},set:function(){}}}),settings.src?(_this.src=settings.src,loadTrack(settings.src,_assertThisInitialized(_this))):_this.loaded_=!0,_this}var _proto=TextTrack.prototype;return _proto.addCue=function(originalCue){var cue=originalCue;if(window$1.vttjs&&!(originalCue instanceof window$1.vttjs.VTTCue)){cue=new window$1.vttjs.VTTCue(originalCue.startTime,originalCue.endTime,originalCue.text);for(var prop in originalCue)prop in cue||(cue[prop]=originalCue[prop]);cue.id=originalCue.id,cue.originalCue_=originalCue}for(var tracks=this.tech_.textTracks(),i=0;i<tracks.length;i++)tracks[i]!==this&&tracks[i].removeCue(cue);this.cues_.push(cue),this.cues.setCues_(this.cues_)},_proto.removeCue=function(_removeCue){for(var i=this.cues_.length;i--;){var cue=this.cues_[i];if(cue===_removeCue||cue.originalCue_&&cue.originalCue_===_removeCue){this.cues_.splice(i,1),this.cues.setCues_(this.cues_);break}}},TextTrack}(Track);TextTrack.prototype.allowedEvents_={cuechange:"cuechange"};var AudioTrack=function(_Track){_inheritsLoose(AudioTrack,_Track);function AudioTrack(options){var _this;void 0===options&&(options={});var settings=mergeOptions(options,{kind:AudioTrackKind[options.kind]||""});_this=_Track.call(this,settings)||this;var enabled=!1;return Object.defineProperty(_assertThisInitialized(_this),"enabled",{get:function(){return enabled},set:function(newEnabled){"boolean"==typeof newEnabled&&newEnabled!==enabled&&(enabled=newEnabled,this.trigger("enabledchange"))}}),settings.enabled&&(_this.enabled=settings.enabled),_this.loaded_=!0,_this}return AudioTrack}(Track),VideoTrack=function(_Track){_inheritsLoose(VideoTrack,_Track);function VideoTrack(options){var _this;void 0===options&&(options={});var settings=mergeOptions(options,{kind:VideoTrackKind[options.kind]||""});_this=_Track.call(this,settings)||this;var selected=!1;return Object.defineProperty(_assertThisInitialized(_this),"selected",{get:function(){return selected},set:function(newSelected){"boolean"==typeof newSelected&&newSelected!==selected&&(selected=newSelected,this.trigger("selectedchange"))}}),settings.selected&&(_this.selected=settings.selected),_this}return VideoTrack}(Track),NONE=0,LOADED=2,HTMLTrackElement=function(_EventTarget){_inheritsLoose(HTMLTrackElement,_EventTarget);function HTMLTrackElement(options){var _this;void 0===options&&(options={}),_this=_EventTarget.call(this)||this;var readyState,track=new TextTrack(options);return _this.kind=track.kind,_this.src=track.src,_this.srclang=track.language,_this.label=track.label,_this.default=track.default,Object.defineProperties(_assertThisInitialized(_this),{readyState:{get:function(){return readyState}},track:{get:function(){return track}}}),readyState=NONE,track.addEventListener("loadeddata",function(){readyState=LOADED,_this.trigger({type:"load",target:_assertThisInitialized(_this)})}),_this}return HTMLTrackElement}(EventTarget);HTMLTrackElement.prototype.allowedEvents_={load:"load"},HTMLTrackElement.NONE=NONE,HTMLTrackElement.LOADING=1,HTMLTrackElement.LOADED=LOADED,HTMLTrackElement.ERROR=3;var NORMAL={audio:{ListClass:AudioTrackList,TrackClass:AudioTrack,capitalName:"Audio"},video:{ListClass:VideoTrackList,TrackClass:VideoTrack,capitalName:"Video"},text:{ListClass:TextTrackList,TrackClass:TextTrack,capitalName:"Text"}};Object.keys(NORMAL).forEach(function(type){NORMAL[type].getterName=type+"Tracks",NORMAL[type].privateName=type+"Tracks_"});var REMOTE={remoteText:{ListClass:TextTrackList,TrackClass:TextTrack,capitalName:"RemoteText",getterName:"remoteTextTracks",privateName:"remoteTextTracks_"},remoteTextEl:{ListClass:HtmlTrackElementList,TrackClass:HTMLTrackElement,capitalName:"RemoteTextTrackEls",getterName:"remoteTextTrackEls",privateName:"remoteTextTrackEls_"}},ALL=mergeOptions(NORMAL,REMOTE);REMOTE.names=Object.keys(REMOTE),NORMAL.names=Object.keys(NORMAL),ALL.names=[].concat(REMOTE.names).concat(NORMAL.names);var _objCreate=Object.create||function(){function F(){}return function(o){if(1!==arguments.length)throw new Error("Object.create shim only accepts one parameter.");return F.prototype=o,new F}}();function ParsingError(errorData,message){this.name="ParsingError",this.code=errorData.code,this.message=message||errorData.message}ParsingError.prototype=_objCreate(Error.prototype),ParsingError.prototype.constructor=ParsingError,ParsingError.Errors={BadSignature:{code:0,message:"Malformed WebVTT signature."},BadTimeStamp:{code:1,message:"Malformed time stamp."}};function parseTimeStamp(input){function computeSeconds(h,m,s,f){return 3600*(0|h)+60*(0|m)+(0|s)+(0|f)/1e3}var m=input.match(/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/);return m?m[3]?computeSeconds(m[1],m[2],m[3].replace(":",""),m[4]):m[1]>59?computeSeconds(m[1],m[2],0,m[4]):computeSeconds(0,m[1],m[2],m[4]):null}function Settings(){this.values=_objCreate(null)}Settings.prototype={set:function(k,v){this.get(k)||""===v||(this.values[k]=v)},get:function(k,dflt,defaultKey){return defaultKey?this.has(k)?this.values[k]:dflt[defaultKey]:this.has(k)?this.values[k]:dflt},has:function(k){return k in this.values},alt:function(k,v,a){for(var n=0;n<a.length;++n)if(v===a[n]){this.set(k,v);break}},integer:function(k,v){/^-?\d+$/.test(v)&&this.set(k,parseInt(v,10))},percent:function(k,v){return!!(v.match(/^([\d]{1,3})(\.[\d]*)?%$/)&&(v=parseFloat(v))>=0&&v<=100)&&(this.set(k,v),!0)}};function parseOptions(input,callback,keyValueDelim,groupDelim){var groups=groupDelim?input.split(groupDelim):[input];for(var i in groups)if("string"==typeof groups[i]){var kv=groups[i].split(keyValueDelim);if(2===kv.length){var k=kv[0],v=kv[1];callback(k,v)}}}function parseCue(input,cue,regionList){var oInput=input;function consumeTimeStamp(){var ts=parseTimeStamp(input);if(null===ts)throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed timestamp: "+oInput);return input=input.replace(/^[^\sa-zA-Z-]+/,""),ts}function skipWhitespace(){input=input.replace(/^\s+/,"")}if(skipWhitespace(),cue.startTime=consumeTimeStamp(),skipWhitespace(),"--\x3e"!==input.substr(0,3))throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed time stamp (time stamps must be separated by '--\x3e'): "+oInput);input=input.substr(3),skipWhitespace(),cue.endTime=consumeTimeStamp(),skipWhitespace(),function(input,cue){var settings=new Settings;parseOptions(input,function(k,v){switch(k){case"region":for(var i=regionList.length-1;i>=0;i--)if(regionList[i].id===v){settings.set(k,regionList[i].region);break}break;case"vertical":settings.alt(k,v,["rl","lr"]);break;case"line":var vals=v.split(","),vals0=vals[0];settings.integer(k,vals0),settings.percent(k,vals0)&&settings.set("snapToLines",!1),settings.alt(k,vals0,["auto"]),2===vals.length&&settings.alt("lineAlign",vals[1],["start","middle","end"]);break;case"position":vals=v.split(","),settings.percent(k,vals[0]),2===vals.length&&settings.alt("positionAlign",vals[1],["start","middle","end"]);break;case"size":settings.percent(k,v);break;case"align":settings.alt(k,v,["start","middle","end","left","right"])}},/:/,/\s/),cue.region=settings.get("region",null),cue.vertical=settings.get("vertical",""),cue.line=settings.get("line","auto"),cue.lineAlign=settings.get("lineAlign","start"),cue.snapToLines=settings.get("snapToLines",!0),cue.size=settings.get("size",100),cue.align=settings.get("align","middle"),cue.position=settings.get("position",{start:0,left:0,middle:50,end:100,right:100},cue.align),cue.positionAlign=settings.get("positionAlign",{start:"start",left:"start",middle:"middle",end:"end",right:"end"},cue.align)}(input,cue)}var ESCAPE={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"â","&rlm;":"â","&nbsp;":"Â "},TAG_NAME={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},TAG_ANNOTATION={v:"title",lang:"lang"},NEEDS_PARENT={rt:"ruby"};function parseContent(window,input){function unescape1(e){return ESCAPE[e]}for(var t,rootDiv=window.document.createElement("div"),current=rootDiv,tagStack=[];null!==(t=function(){if(!input)return null;var m=input.match(/^([^<]*)(<[^>]*>?)?/);return function(result){return input=input.substr(result.length),result}(m[1]?m[1]:m[2])}());)if("<"!==t[0])current.appendChild(window.document.createTextNode(function(s){for(;m=s.match(/&(amp|lt|gt|lrm|rlm|nbsp);/);)s=s.replace(m[0],unescape1);return s}(t)));else{if("/"===t[1]){tagStack.length&&tagStack[tagStack.length-1]===t.substr(2).replace(">","")&&(tagStack.pop(),current=current.parentNode);continue}var node,ts=parseTimeStamp(t.substr(1,t.length-2));if(ts){node=window.document.createProcessingInstruction("timestamp",ts),current.appendChild(node);continue}var m=t.match(/^<([^.\s\/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/);if(!m)continue;if(!(node=function(type,annotation){var tagName=TAG_NAME[type];if(!tagName)return null;var element=window.document.createElement(tagName);element.localName=tagName;var name=TAG_ANNOTATION[type];return name&&annotation&&(element[name]=annotation.trim()),element}(m[1],m[3])))continue;if(!function(current,element){return!NEEDS_PARENT[element.localName]||NEEDS_PARENT[element.localName]===current.localName}(current,node))continue;m[2]&&(node.className=m[2].substr(1).replace("."," ")),tagStack.push(m[1]),current.appendChild(node),current=node}return rootDiv}var strongRTLRanges=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];function isStrongRTLChar(charCode){for(var i=0;i<strongRTLRanges.length;i++){var currentRange=strongRTLRanges[i];if(charCode>=currentRange[0]&&charCode<=currentRange[1])return!0}return!1}function determineBidi(cueDiv){var charCode,nodeStack=[],text="";if(!cueDiv||!cueDiv.childNodes)return"ltr";function pushNodes(nodeStack,node){for(var i=node.childNodes.length-1;i>=0;i--)nodeStack.push(node.childNodes[i])}function nextTextNode(nodeStack){if(!nodeStack||!nodeStack.length)return null;var node=nodeStack.pop(),text=node.textContent||node.innerText;if(text){var m=text.match(/^.*(\n|\r)/);return m?(nodeStack.length=0,m[0]):text}return"ruby"===node.tagName?nextTextNode(nodeStack):node.childNodes?(pushNodes(nodeStack,node),nextTextNode(nodeStack)):void 0}for(pushNodes(nodeStack,cueDiv);text=nextTextNode(nodeStack);)for(var i=0;i<text.length;i++)if(charCode=text.charCodeAt(i),isStrongRTLChar(charCode))return"rtl";return"ltr"}function computeLinePos(cue){if("number"==typeof cue.line&&(cue.snapToLines||cue.line>=0&&cue.line<=100))return cue.line;if(!cue.track||!cue.track.textTrackList||!cue.track.textTrackList.mediaElement)return-1;for(var track=cue.track,trackList=track.textTrackList,count=0,i=0;i<trackList.length&&trackList[i]!==track;i++)"showing"===trackList[i].mode&&count++;return-1*++count}function StyleBox(){}StyleBox.prototype.applyStyles=function(styles,div){div=div||this.div;for(var prop in styles)styles.hasOwnProperty(prop)&&(div.style[prop]=styles[prop])},StyleBox.prototype.formatStyle=function(val,unit){return 0===val?0:val+unit};function CueStyleBox(window,cue,styleOptions){StyleBox.call(this),this.cue=cue,this.cueDiv=parseContent(window,cue.text);var styles={color:"rgba(255, 255, 255, 1)",backgroundColor:"rgba(0, 0, 0, 0.8)",position:"relative",left:0,right:0,top:0,bottom:0,display:"inline",writingMode:""===cue.vertical?"horizontal-tb":"lr"===cue.vertical?"vertical-lr":"vertical-rl",unicodeBidi:"plaintext"};this.applyStyles(styles,this.cueDiv),this.div=window.document.createElement("div"),styles={direction:determineBidi(this.cueDiv),writingMode:""===cue.vertical?"horizontal-tb":"lr"===cue.vertical?"vertical-lr":"vertical-rl",unicodeBidi:"plaintext",textAlign:"middle"===cue.align?"center":cue.align,font:styleOptions.font,whiteSpace:"pre-line",position:"absolute"},this.applyStyles(styles),this.div.appendChild(this.cueDiv);var textPos=0;switch(cue.positionAlign){case"start":textPos=cue.position;break;case"middle":textPos=cue.position-cue.size/2;break;case"end":textPos=cue.position-cue.size}""===cue.vertical?this.applyStyles({left:this.formatStyle(textPos,"%"),width:this.formatStyle(cue.size,"%")}):this.applyStyles({top:this.formatStyle(textPos,"%"),height:this.formatStyle(cue.size,"%")}),this.move=function(box){this.applyStyles({top:this.formatStyle(box.top,"px"),bottom:this.formatStyle(box.bottom,"px"),left:this.formatStyle(box.left,"px"),right:this.formatStyle(box.right,"px"),height:this.formatStyle(box.height,"px"),width:this.formatStyle(box.width,"px")})}}CueStyleBox.prototype=_objCreate(StyleBox.prototype),CueStyleBox.prototype.constructor=CueStyleBox;function BoxPosition(obj){var lh,height,width,top;if(obj.div){height=obj.div.offsetHeight,width=obj.div.offsetWidth,top=obj.div.offsetTop;var rects=(rects=obj.div.childNodes)&&(rects=rects[0])&&rects.getClientRects&&rects.getClientRects();obj=obj.div.getBoundingClientRect(),lh=rects?Math.max(rects[0]&&rects[0].height||0,obj.height/rects.length):0}this.left=obj.left,this.right=obj.right,this.top=obj.top||top,this.height=obj.height||height,this.bottom=obj.bottom||top+(obj.height||height),this.width=obj.width||width,this.lineHeight=void 0!==lh?lh:obj.lineHeight}BoxPosition.prototype.move=function(axis,toMove){switch(toMove=void 0!==toMove?toMove:this.lineHeight,axis){case"+x":this.left+=toMove,this.right+=toMove;break;case"-x":this.left-=toMove,this.right-=toMove;break;case"+y":this.top+=toMove,this.bottom+=toMove;break;case"-y":this.top-=toMove,this.bottom-=toMove}},BoxPosition.prototype.overlaps=function(b2){return this.left<b2.right&&this.right>b2.left&&this.top<b2.bottom&&this.bottom>b2.top},BoxPosition.prototype.overlapsAny=function(boxes){for(var i=0;i<boxes.length;i++)if(this.overlaps(boxes[i]))return!0;return!1},BoxPosition.prototype.within=function(container){return this.top>=container.top&&this.bottom<=container.bottom&&this.left>=container.left&&this.right<=container.right},BoxPosition.prototype.overlapsOppositeAxis=function(container,axis){switch(axis){case"+x":return this.left<container.left;case"-x":return this.right>container.right;case"+y":return this.top<container.top;case"-y":return this.bottom>container.bottom}},BoxPosition.prototype.intersectPercentage=function(b2){return Math.max(0,Math.min(this.right,b2.right)-Math.max(this.left,b2.left))*Math.max(0,Math.min(this.bottom,b2.bottom)-Math.max(this.top,b2.top))/(this.height*this.width)},BoxPosition.prototype.toCSSCompatValues=function(reference){return{top:this.top-reference.top,bottom:reference.bottom-this.bottom,left:this.left-reference.left,right:reference.right-this.right,height:this.height,width:this.width}},BoxPosition.getSimpleBoxPosition=function(obj){var height=obj.div?obj.div.offsetHeight:obj.tagName?obj.offsetHeight:0,width=obj.div?obj.div.offsetWidth:obj.tagName?obj.offsetWidth:0,top=obj.div?obj.div.offsetTop:obj.tagName?obj.offsetTop:0;return obj=obj.div?obj.div.getBoundingClientRect():obj.tagName?obj.getBoundingClientRect():obj,{left:obj.left,right:obj.right,top:obj.top||top,height:obj.height||height,bottom:obj.bottom||top+(obj.height||height),width:obj.width||width}};function moveBoxToLinePosition(window,styleBox,containerBox,boxPositions){var boxPosition=new BoxPosition(styleBox),cue=styleBox.cue,linePos=computeLinePos(cue),axis=[];if(cue.snapToLines){var size;switch(cue.vertical){case"":axis=["+y","-y"],size="height";break;case"rl":axis=["+x","-x"],size="width";break;case"lr":axis=["-x","+x"],size="width"}var step=boxPosition.lineHeight,position=step*Math.round(linePos),maxPosition=containerBox[size]+step,initialAxis=axis[0];Math.abs(position)>maxPosition&&(position=position<0?-1:1,position*=Math.ceil(maxPosition/step)*step),linePos<0&&(position+=""===cue.vertical?containerBox.height:containerBox.width,axis=axis.reverse()),boxPosition.move(initialAxis,position)}else{var calculatedPercentage=boxPosition.lineHeight/containerBox.height*100;switch(cue.lineAlign){case"middle":linePos-=calculatedPercentage/2;break;case"end":linePos-=calculatedPercentage}switch(cue.vertical){case"":styleBox.applyStyles({top:styleBox.formatStyle(linePos,"%")});break;case"rl":styleBox.applyStyles({left:styleBox.formatStyle(linePos,"%")});break;case"lr":styleBox.applyStyles({right:styleBox.formatStyle(linePos,"%")})}axis=["+y","-x","+x","-y"],boxPosition=new BoxPosition(styleBox)}var bestPosition=function(b,axis){for(var bestPosition,specifiedPosition=new BoxPosition(b),percentage=1,i=0;i<axis.length;i++){for(;b.overlapsOppositeAxis(containerBox,axis[i])||b.within(containerBox)&&b.overlapsAny(boxPositions);)b.move(axis[i]);if(b.within(containerBox))return b;var p=b.intersectPercentage(containerBox);percentage>p&&(bestPosition=new BoxPosition(b),percentage=p),b=new BoxPosition(specifiedPosition)}return bestPosition||specifiedPosition}(boxPosition,axis);styleBox.move(bestPosition.toCSSCompatValues(containerBox))}function WebVTT$1(){}WebVTT$1.StringDecoder=function(){return{decode:function(data){if(!data)return"";if("string"!=typeof data)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(data))}}},WebVTT$1.convertCueToDOMTree=function(window,cuetext){return window&&cuetext?parseContent(window,cuetext):null};WebVTT$1.processCues=function(window,cues,overlay){if(!window||!cues||!overlay)return null;for(;overlay.firstChild;)overlay.removeChild(overlay.firstChild);var paddedOverlay=window.document.createElement("div");paddedOverlay.style.position="absolute",paddedOverlay.style.left="0",paddedOverlay.style.right="0",paddedOverlay.style.top="0",paddedOverlay.style.bottom="0",paddedOverlay.style.margin="1.5%",overlay.appendChild(paddedOverlay);if(function(cues){for(var i=0;i<cues.length;i++)if(cues[i].hasBeenReset||!cues[i].displayState)return!0;return!1}(cues)){var boxPositions=[],containerBox=BoxPosition.getSimpleBoxPosition(paddedOverlay),fontSize=Math.round(.05*containerBox.height*100)/100,styleOptions={font:fontSize+"px sans-serif"};!function(){for(var styleBox,cue,i=0;i<cues.length;i++)cue=cues[i],styleBox=new CueStyleBox(window,cue,styleOptions),paddedOverlay.appendChild(styleBox.div),moveBoxToLinePosition(window,styleBox,containerBox,boxPositions),cue.displayState=styleBox.div,boxPositions.push(BoxPosition.getSimpleBoxPosition(styleBox))}()}else for(var i=0;i<cues.length;i++)paddedOverlay.appendChild(cues[i].displayState)},WebVTT$1.Parser=function(window,vttjs,decoder){decoder||(decoder=vttjs,vttjs={}),vttjs||(vttjs={}),this.window=window,this.vttjs=vttjs,this.state="INITIAL",this.buffer="",this.decoder=decoder||new TextDecoder("utf8"),this.regionList=[]},WebVTT$1.Parser.prototype={reportOrThrowError:function(e){if(!(e instanceof ParsingError))throw e;this.onparsingerror&&this.onparsingerror(e)},parse:function(data){var self=this;data&&(self.buffer+=self.decoder.decode(data,{stream:!0}));function collectNextLine(){for(var buffer=self.buffer,pos=0;pos<buffer.length&&"\r"!==buffer[pos]&&"\n"!==buffer[pos];)++pos;var line=buffer.substr(0,pos);return"\r"===buffer[pos]&&++pos,"\n"===buffer[pos]&&++pos,self.buffer=buffer.substr(pos),line}function parseRegion(input){var settings=new Settings;if(parseOptions(input,function(k,v){switch(k){case"id":settings.set(k,v);break;case"width":settings.percent(k,v);break;case"lines":settings.integer(k,v);break;case"regionanchor":case"viewportanchor":var xy=v.split(",");if(2!==xy.length)break;var anchor=new Settings;if(anchor.percent("x",xy[0]),anchor.percent("y",xy[1]),!anchor.has("x")||!anchor.has("y"))break;settings.set(k+"X",anchor.get("x")),settings.set(k+"Y",anchor.get("y"));break;case"scroll":settings.alt(k,v,["up"])}},/=/,/\s/),settings.has("id")){var region=new(self.vttjs.VTTRegion||self.window.VTTRegion);region.width=settings.get("width",100),region.lines=settings.get("lines",3),region.regionAnchorX=settings.get("regionanchorX",0),region.regionAnchorY=settings.get("regionanchorY",100),region.viewportAnchorX=settings.get("viewportanchorX",0),region.viewportAnchorY=settings.get("viewportanchorY",100),region.scroll=settings.get("scroll",""),self.onregion&&self.onregion(region),self.regionList.push({id:settings.get("id"),region:region})}}function parseTimestampMap(input){var settings=new Settings;parseOptions(input,function(k,v){switch(k){case"MPEGT":settings.integer(k+"S",v);break;case"LOCA":settings.set(k+"L",parseTimeStamp(v))}},/[^\d]:/,/,/),self.ontimestampmap&&self.ontimestampmap({MPEGTS:settings.get("MPEGTS"),LOCAL:settings.get("LOCAL")})}try{var line;if("INITIAL"===self.state){if(!/\r\n|\n/.test(self.buffer))return this;line=collectNextLine();var m=line.match(/^WEBVTT([ \t].*)?$/);if(!m||!m[0])throw new ParsingError(ParsingError.Errors.BadSignature);self.state="HEADER"}for(var alreadyCollectedLine=!1;self.buffer;){if(!/\r\n|\n/.test(self.buffer))return this;switch(alreadyCollectedLine?alreadyCollectedLine=!1:line=collectNextLine(),self.state){case"HEADER":/:/.test(line)?function(input){input.match(/X-TIMESTAMP-MAP/)?parseOptions(input,function(k,v){switch(k){case"X-TIMESTAMP-MAP":parseTimestampMap(v)}},/=/):parseOptions(input,function(k,v){switch(k){case"Region":parseRegion(v)}},/:/)}(line):line||(self.state="ID");continue;case"NOTE":line||(self.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(line)){self.state="NOTE";break}if(!line)continue;if(self.cue=new(self.vttjs.VTTCue||self.window.VTTCue)(0,0,""),self.state="CUE",-1===line.indexOf("--\x3e")){self.cue.id=line;continue}case"CUE":try{parseCue(line,self.cue,self.regionList)}catch(e){self.reportOrThrowError(e),self.cue=null,self.state="BADCUE";continue}self.state="CUETEXT";continue;case"CUETEXT":var hasSubstring=-1!==line.indexOf("--\x3e");if(!line||hasSubstring&&(alreadyCollectedLine=!0)){self.oncue&&self.oncue(self.cue),self.cue=null,self.state="ID";continue}self.cue.text&&(self.cue.text+="\n"),self.cue.text+=line;continue;case"BADCUE":line||(self.state="ID");continue}}}catch(e){self.reportOrThrowError(e),"CUETEXT"===self.state&&self.cue&&self.oncue&&self.oncue(self.cue),self.cue=null,self.state="INITIAL"===self.state?"BADWEBVTT":"BADCUE"}return this},flush:function(){var self=this;try{if(self.buffer+=self.decoder.decode(),(self.cue||"HEADER"===self.state)&&(self.buffer+="\n\n",self.parse()),"INITIAL"===self.state)throw new ParsingError(ParsingError.Errors.BadSignature)}catch(e){self.reportOrThrowError(e)}return self.onflush&&self.onflush(),this}};var vtt=WebVTT$1,autoKeyword="auto",directionSetting={"":1,lr:1,rl:1},alignSetting={start:1,middle:1,end:1,left:1,right:1};function findDirectionSetting(value){return"string"==typeof value&&(!!directionSetting[value.toLowerCase()]&&value.toLowerCase())}function findAlignSetting(value){return"string"==typeof value&&(!!alignSetting[value.toLowerCase()]&&value.toLowerCase())}function VTTCue(startTime,endTime,text){this.hasBeenReset=!1;var _id="",_pauseOnExit=!1,_startTime=startTime,_endTime=endTime,_text=text,_region=null,_vertical="",_snapToLines=!0,_line="auto",_lineAlign="start",_position=50,_positionAlign="middle",_size=50,_align="middle";Object.defineProperties(this,{id:{enumerable:!0,get:function(){return _id},set:function(value){_id=""+value}},pauseOnExit:{enumerable:!0,get:function(){return _pauseOnExit},set:function(value){_pauseOnExit=!!value}},startTime:{enumerable:!0,get:function(){return _startTime},set:function(value){if("number"!=typeof value)throw new TypeError("Start time must be set to a number.");_startTime=value,this.hasBeenReset=!0}},endTime:{enumerable:!0,get:function(){return _endTime},set:function(value){if("number"!=typeof value)throw new TypeError("End time must be set to a number.");_endTime=value,this.hasBeenReset=!0}},text:{enumerable:!0,get:function(){return _text},set:function(value){_text=""+value,this.hasBeenReset=!0}},region:{enumerable:!0,get:function(){return _region},set:function(value){_region=value,this.hasBeenReset=!0}},vertical:{enumerable:!0,get:function(){return _vertical},set:function(value){var setting=findDirectionSetting(value);if(!1===setting)throw new SyntaxError("An invalid or illegal string was specified.");_vertical=setting,this.hasBeenReset=!0}},snapToLines:{enumerable:!0,get:function(){return _snapToLines},set:function(value){_snapToLines=!!value,this.hasBeenReset=!0}},line:{enumerable:!0,get:function(){return _line},set:function(value){if("number"!=typeof value&&value!==autoKeyword)throw new SyntaxError("An invalid number or illegal string was specified.");_line=value,this.hasBeenReset=!0}},lineAlign:{enumerable:!0,get:function(){return _lineAlign},set:function(value){var setting=findAlignSetting(value);if(!setting)throw new SyntaxError("An invalid or illegal string was specified.");_lineAlign=setting,this.hasBeenReset=!0}},position:{enumerable:!0,get:function(){return _position},set:function(value){if(value<0||value>100)throw new Error("Position must be between 0 and 100.");_position=value,this.hasBeenReset=!0}},positionAlign:{enumerable:!0,get:function(){return _positionAlign},set:function(value){var setting=findAlignSetting(value);if(!setting)throw new SyntaxError("An invalid or illegal string was specified.");_positionAlign=setting,this.hasBeenReset=!0}},size:{enumerable:!0,get:function(){return _size},set:function(value){if(value<0||value>100)throw new Error("Size must be between 0 and 100.");_size=value,this.hasBeenReset=!0}},align:{enumerable:!0,get:function(){return _align},set:function(value){var setting=findAlignSetting(value);if(!setting)throw new SyntaxError("An invalid or illegal string was specified.");_align=setting,this.hasBeenReset=!0}}}),this.displayState=void 0}VTTCue.prototype.getCueAsHTML=function(){return WebVTT.convertCueToDOMTree(window,this.text)};var vttcue=VTTCue,scrollSetting={"":!0,up:!0};function findScrollSetting(value){return"string"==typeof value&&(!!scrollSetting[value.toLowerCase()]&&value.toLowerCase())}function isValidPercentValue(value){return"number"==typeof value&&value>=0&&value<=100}function VTTRegion(){var _width=100,_lines=3,_regionAnchorX=0,_regionAnchorY=100,_viewportAnchorX=0,_viewportAnchorY=100,_scroll="";Object.defineProperties(this,{width:{enumerable:!0,get:function(){return _width},set:function(value){if(!isValidPercentValue(value))throw new Error("Width must be between 0 and 100.");_width=value}},lines:{enumerable:!0,get:function(){return _lines},set:function(value){if("number"!=typeof value)throw new TypeError("Lines must be set to a number.");_lines=value}},regionAnchorY:{enumerable:!0,get:function(){return _regionAnchorY},set:function(value){if(!isValidPercentValue(value))throw new Error("RegionAnchorX must be between 0 and 100.");_regionAnchorY=value}},regionAnchorX:{enumerable:!0,get:function(){return _regionAnchorX},set:function(value){if(!isValidPercentValue(value))throw new Error("RegionAnchorY must be between 0 and 100.");_regionAnchorX=value}},viewportAnchorY:{enumerable:!0,get:function(){return _viewportAnchorY},set:function(value){if(!isValidPercentValue(value))throw new Error("ViewportAnchorY must be between 0 and 100.");_viewportAnchorY=value}},viewportAnchorX:{enumerable:!0,get:function(){return _viewportAnchorX},set:function(value){if(!isValidPercentValue(value))throw new Error("ViewportAnchorX must be between 0 and 100.");_viewportAnchorX=value}},scroll:{enumerable:!0,get:function(){return _scroll},set:function(value){var setting=findScrollSetting(value);if(!1===setting)throw new SyntaxError("An invalid or illegal string was specified.");_scroll=setting}}})}var vttregion=VTTRegion,browserIndex=createCommonjsModule(function(module){var vttjs=module.exports={WebVTT:vtt,VTTCue:vttcue,VTTRegion:vttregion};window$1.vttjs=vttjs,window$1.WebVTT=vttjs.WebVTT;var cueShim=vttjs.VTTCue,regionShim=vttjs.VTTRegion,nativeVTTCue=window$1.VTTCue,nativeVTTRegion=window$1.VTTRegion;vttjs.shim=function(){window$1.VTTCue=cueShim,window$1.VTTRegion=regionShim},vttjs.restore=function(){window$1.VTTCue=nativeVTTCue,window$1.VTTRegion=nativeVTTRegion},window$1.VTTCue||vttjs.shim()});browserIndex.WebVTT,browserIndex.VTTCue,browserIndex.VTTRegion;function createTrackHelper(self,kind,label,language,options){void 0===options&&(options={});var tracks=self.textTracks();options.kind=kind,label&&(options.label=label),language&&(options.language=language),options.tech=self;var track=new ALL.text.TrackClass(options);return tracks.addTrack(track),track}var Tech=function(_Component){_inheritsLoose(Tech,_Component);function Tech(options,ready){var _this;return void 0===options&&(options={}),void 0===ready&&(ready=function(){}),options.reportTouchActivity=!1,_this=_Component.call(this,null,options,ready)||this,_this.hasStarted_=!1,_this.on("playing",function(){this.hasStarted_=!0}),_this.on("loadstart",function(){this.hasStarted_=!1}),ALL.names.forEach(function(name){var props=ALL[name];options&&options[props.getterName]&&(_this[props.privateName]=options[props.getterName])}),_this.featuresProgressEvents||_this.manualProgressOn(),_this.featuresTimeupdateEvents||_this.manualTimeUpdatesOn(),["Text","Audio","Video"].forEach(function(track){!1===options["native"+track+"Tracks"]&&(_this["featuresNative"+track+"Tracks"]=!1)}),
!1===options.nativeCaptions||!1===options.nativeTextTracks?_this.featuresNativeTextTracks=!1:!0!==options.nativeCaptions&&!0!==options.nativeTextTracks||(_this.featuresNativeTextTracks=!0),_this.featuresNativeTextTracks||_this.emulateTextTracks(),_this.autoRemoteTextTracks_=new ALL.text.ListClass,_this.initTrackListeners(),options.nativeControlsForTouch||_this.emitTapEvents(),_this.constructor&&(_this.name_=_this.constructor.name||"Unknown Tech"),_this}var _proto=Tech.prototype;return _proto.triggerSourceset=function(src){var _this2=this;this.isReady_||this.one("ready",function(){return _this2.setTimeout(function(){return _this2.triggerSourceset(src)},1)}),this.trigger({src:src,type:"sourceset"})},_proto.manualProgressOn=function(){this.on("durationchange",this.onDurationChange),this.manualProgress=!0,this.one("ready",this.trackProgress)},_proto.manualProgressOff=function(){this.manualProgress=!1,this.stopTrackingProgress(),this.off("durationchange",this.onDurationChange)},_proto.trackProgress=function(event){this.stopTrackingProgress(),this.progressInterval=this.setInterval(bind(this,function(){var numBufferedPercent=this.bufferedPercent();this.bufferedPercent_!==numBufferedPercent&&this.trigger("progress"),this.bufferedPercent_=numBufferedPercent,1===numBufferedPercent&&this.stopTrackingProgress()}),500)},_proto.onDurationChange=function(event){this.duration_=this.duration()},_proto.buffered=function(){return createTimeRanges(0,0)},_proto.bufferedPercent=function(){return bufferedPercent(this.buffered(),this.duration_)},_proto.stopTrackingProgress=function(){this.clearInterval(this.progressInterval)},_proto.manualTimeUpdatesOn=function(){this.manualTimeUpdates=!0,this.on("play",this.trackCurrentTime),this.on("pause",this.stopTrackingCurrentTime)},_proto.manualTimeUpdatesOff=function(){this.manualTimeUpdates=!1,this.stopTrackingCurrentTime(),this.off("play",this.trackCurrentTime),this.off("pause",this.stopTrackingCurrentTime)},_proto.trackCurrentTime=function(){this.currentTimeInterval&&this.stopTrackingCurrentTime(),this.currentTimeInterval=this.setInterval(function(){this.trigger({type:"timeupdate",target:this,manuallyTriggered:!0})},250)},_proto.stopTrackingCurrentTime=function(){this.clearInterval(this.currentTimeInterval),this.trigger({type:"timeupdate",target:this,manuallyTriggered:!0})},_proto.dispose=function(){this.clearTracks(NORMAL.names),this.manualProgress&&this.manualProgressOff(),this.manualTimeUpdates&&this.manualTimeUpdatesOff(),_Component.prototype.dispose.call(this)},_proto.clearTracks=function(types){var _this3=this;types=[].concat(types),types.forEach(function(type){for(var list=_this3[type+"Tracks"]()||[],i=list.length;i--;){var track=list[i];"text"===type&&_this3.removeRemoteTextTrack(track),list.removeTrack(track)}})},_proto.cleanupAutoTextTracks=function(){for(var list=this.autoRemoteTextTracks_||[],i=list.length;i--;){var track=list[i];this.removeRemoteTextTrack(track)}},_proto.reset=function(){},_proto.error=function(err){return void 0!==err&&(this.error_=new MediaError(err),this.trigger("error")),this.error_},_proto.played=function(){return this.hasStarted_?createTimeRanges(0,0):createTimeRanges()},_proto.setCurrentTime=function(){this.manualTimeUpdates&&this.trigger({type:"timeupdate",target:this,manuallyTriggered:!0})},_proto.initTrackListeners=function(){var _this4=this;NORMAL.names.forEach(function(name){var props=NORMAL[name],trackListChanges=function(){_this4.trigger(name+"trackchange")},tracks=_this4[props.getterName]();tracks.addEventListener("removetrack",trackListChanges),tracks.addEventListener("addtrack",trackListChanges),_this4.on("dispose",function(){tracks.removeEventListener("removetrack",trackListChanges),tracks.removeEventListener("addtrack",trackListChanges)})})},_proto.addWebVttScript_=function(){var _this5=this;if(!window$1.WebVTT)if(document.body.contains(this.el())){if(!this.options_["vtt.js"]&&isPlain(browserIndex)&&Object.keys(browserIndex).length>0)return void this.trigger("vttjsloaded");var script=document.createElement("script");script.src=this.options_["vtt.js"]||"https://vjs.zencdn.net/vttjs/0.14.1/vtt.min.js",script.onload=function(){_this5.trigger("vttjsloaded")},script.onerror=function(){_this5.trigger("vttjserror")},this.on("dispose",function(){script.onload=null,script.onerror=null}),window$1.WebVTT=!0,this.el().parentNode.appendChild(script)}else this.ready(this.addWebVttScript_)},_proto.emulateTextTracks=function(){var _this6=this,tracks=this.textTracks(),remoteTracks=this.remoteTextTracks(),handleAddTrack=function(e){return tracks.addTrack(e.track)},handleRemoveTrack=function(e){return tracks.removeTrack(e.track)};remoteTracks.on("addtrack",handleAddTrack),remoteTracks.on("removetrack",handleRemoveTrack),this.addWebVttScript_();var updateDisplay=function(){return _this6.trigger("texttrackchange")},textTracksChanges=function(){updateDisplay();for(var i=0;i<tracks.length;i++){var track=tracks[i];track.removeEventListener("cuechange",updateDisplay),"showing"===track.mode&&track.addEventListener("cuechange",updateDisplay)}};textTracksChanges(),tracks.addEventListener("change",textTracksChanges),tracks.addEventListener("addtrack",textTracksChanges),tracks.addEventListener("removetrack",textTracksChanges),this.on("dispose",function(){remoteTracks.off("addtrack",handleAddTrack),remoteTracks.off("removetrack",handleRemoveTrack),tracks.removeEventListener("change",textTracksChanges),tracks.removeEventListener("addtrack",textTracksChanges),tracks.removeEventListener("removetrack",textTracksChanges);for(var i=0;i<tracks.length;i++){tracks[i].removeEventListener("cuechange",updateDisplay)}})},_proto.addTextTrack=function(kind,label,language){if(!kind)throw new Error("TextTrack kind is required but was not provided");return createTrackHelper(this,kind,label,language)},_proto.createRemoteTextTrack=function(options){var track=mergeOptions(options,{tech:this});return new REMOTE.remoteTextEl.TrackClass(track)},_proto.addRemoteTextTrack=function(options,manualCleanup){var _this7=this;void 0===options&&(options={});var htmlTrackElement=this.createRemoteTextTrack(options);return!0!==manualCleanup&&!1!==manualCleanup&&(log.warn('Calling addRemoteTextTrack without explicitly setting the "manualCleanup" parameter to `true` is deprecated and default to `false` in future version of video.js'),manualCleanup=!0),this.remoteTextTrackEls().addTrackElement_(htmlTrackElement),this.remoteTextTracks().addTrack(htmlTrackElement.track),!0!==manualCleanup&&this.ready(function(){return _this7.autoRemoteTextTracks_.addTrack(htmlTrackElement.track)}),htmlTrackElement},_proto.removeRemoteTextTrack=function(track){var trackElement=this.remoteTextTrackEls().getTrackElementByTrack_(track);this.remoteTextTrackEls().removeTrackElement_(trackElement),this.remoteTextTracks().removeTrack(track),this.autoRemoteTextTracks_.removeTrack(track)},_proto.getVideoPlaybackQuality=function(){return{}},_proto.requestPictureInPicture=function(){var PromiseClass=this.options_.Promise||window$1.Promise;if(PromiseClass)return PromiseClass.reject()},_proto.setPoster=function(){},_proto.playsinline=function(){},_proto.setPlaysinline=function(){},_proto.overrideNativeAudioTracks=function(){},_proto.overrideNativeVideoTracks=function(){},_proto.canPlayType=function(){return""},Tech.canPlayType=function(){return""},Tech.canPlaySource=function(srcObj,options){return Tech.canPlayType(srcObj.type)},Tech.isTech=function(component){return component.prototype instanceof Tech||component instanceof Tech||component===Tech},Tech.registerTech=function(name,tech){if(Tech.techs_||(Tech.techs_={}),!Tech.isTech(tech))throw new Error("Tech "+name+" must be a Tech");if(!Tech.canPlayType)throw new Error("Techs must have a static canPlayType method on them");if(!Tech.canPlaySource)throw new Error("Techs must have a static canPlaySource method on them");return name=toTitleCase(name),Tech.techs_[name]=tech,Tech.techs_[toLowerCase(name)]=tech,"Tech"!==name&&Tech.defaultTechOrder_.push(name),tech},Tech.getTech=function(name){if(name)return Tech.techs_&&Tech.techs_[name]?Tech.techs_[name]:(name=toTitleCase(name),window$1&&window$1.videojs&&window$1.videojs[name]?(log.warn("The "+name+" tech was added to the videojs object when it should be registered using videojs.registerTech(name, tech)"),window$1.videojs[name]):void 0)},Tech}(Component);ALL.names.forEach(function(name){var props=ALL[name];Tech.prototype[props.getterName]=function(){return this[props.privateName]=this[props.privateName]||new props.ListClass,this[props.privateName]}}),Tech.prototype.featuresVolumeControl=!0,Tech.prototype.featuresMuteControl=!0,Tech.prototype.featuresFullscreenResize=!1,Tech.prototype.featuresPlaybackRate=!1,Tech.prototype.featuresProgressEvents=!1,Tech.prototype.featuresSourceset=!1,Tech.prototype.featuresTimeupdateEvents=!1,Tech.prototype.featuresNativeTextTracks=!1,Tech.withSourceHandlers=function(_Tech){_Tech.registerSourceHandler=function(handler,index){var handlers=_Tech.sourceHandlers;handlers||(handlers=_Tech.sourceHandlers=[]),void 0===index&&(index=handlers.length),handlers.splice(index,0,handler)},_Tech.canPlayType=function(type){for(var can,handlers=_Tech.sourceHandlers||[],i=0;i<handlers.length;i++)if(can=handlers[i].canPlayType(type))return can;return""},_Tech.selectSourceHandler=function(source,options){for(var handlers=_Tech.sourceHandlers||[],i=0;i<handlers.length;i++)if(handlers[i].canHandleSource(source,options))return handlers[i];return null},_Tech.canPlaySource=function(srcObj,options){var sh=_Tech.selectSourceHandler(srcObj,options);return sh?sh.canHandleSource(srcObj,options):""},["seekable","seeking","duration"].forEach(function(fnName){var originalFn=this[fnName];"function"==typeof originalFn&&(this[fnName]=function(){return this.sourceHandler_&&this.sourceHandler_[fnName]?this.sourceHandler_[fnName].apply(this.sourceHandler_,arguments):originalFn.apply(this,arguments)})},_Tech.prototype),_Tech.prototype.setSource=function(source){var sh=_Tech.selectSourceHandler(source,this.options_);sh||(_Tech.nativeSourceHandler?sh=_Tech.nativeSourceHandler:log.error("No source handler found for the current source.")),this.disposeSourceHandler(),this.off("dispose",this.disposeSourceHandler),sh!==_Tech.nativeSourceHandler&&(this.currentSource_=source),this.sourceHandler_=sh.handleSource(source,this,this.options_),this.one("dispose",this.disposeSourceHandler)},_Tech.prototype.disposeSourceHandler=function(){this.currentSource_&&(this.clearTracks(["audio","video"]),this.currentSource_=null),this.cleanupAutoTextTracks(),this.sourceHandler_&&(this.sourceHandler_.dispose&&this.sourceHandler_.dispose(),this.sourceHandler_=null)}},Component.registerComponent("Tech",Tech),Tech.registerTech("Tech",Tech),Tech.defaultTechOrder_=[];var middlewares={},middlewareInstances={},TERMINATOR={};function use(type,middleware){middlewares[type]=middlewares[type]||[],middlewares[type].push(middleware)}function setSource(player,src,next){player.setTimeout(function(){return setSourceHelper(src,middlewares[src.type],next,player)},1)}function setTech(middleware,tech){middleware.forEach(function(mw){return mw.setTech&&mw.setTech(tech)})}function get(middleware,tech,method){return middleware.reduceRight(middlewareIterator(method),tech[method]())}function set(middleware,tech,method,arg){return tech[method](middleware.reduce(middlewareIterator(method),arg))}function mediate(middleware,tech,method,arg){void 0===arg&&(arg=null);var callMethod="call"+toTitleCase(method),middlewareValue=middleware.reduce(middlewareIterator(callMethod),arg),terminated=middlewareValue===TERMINATOR,returnValue=terminated?null:tech[method](middlewareValue);return executeRight(middleware,method,returnValue,terminated),returnValue}var allowedGetters={buffered:1,currentTime:1,duration:1,seekable:1,played:1,paused:1,volume:1},allowedSetters={setCurrentTime:1,setVolume:1},allowedMediators={play:1,pause:1};function middlewareIterator(method){return function(value,mw){return value===TERMINATOR?TERMINATOR:mw[method]?mw[method](value):value}}function executeRight(mws,method,value,terminated){for(var i=mws.length-1;i>=0;i--){var mw=mws[i];mw[method]&&mw[method](terminated,value)}}function clearCacheForPlayer(player){middlewareInstances[player.id()]=null}function getOrCreateFactory(player,mwFactory){var mws=middlewareInstances[player.id()],mw=null;if(void 0===mws||null===mws)return mw=mwFactory(player),middlewareInstances[player.id()]=[[mwFactory,mw]],mw;for(var i=0;i<mws.length;i++){var _mws$i=mws[i],mwf=_mws$i[0],mwi=_mws$i[1];mwf===mwFactory&&(mw=mwi)}return null===mw&&(mw=mwFactory(player),mws.push([mwFactory,mw])),mw}function setSourceHelper(src,middleware,next,player,acc,lastRun){void 0===src&&(src={}),void 0===middleware&&(middleware=[]),void 0===acc&&(acc=[]),void 0===lastRun&&(lastRun=!1);var _middleware=middleware,mwFactory=_middleware[0],mwrest=_middleware.slice(1);if("string"==typeof mwFactory)setSourceHelper(src,middlewares[mwFactory],next,player,acc,lastRun);else if(mwFactory){var mw=getOrCreateFactory(player,mwFactory);if(!mw.setSource)return acc.push(mw),setSourceHelper(src,mwrest,next,player,acc,lastRun);mw.setSource(assign({},src),function(err,_src){if(err)return setSourceHelper(src,mwrest,next,player,acc,lastRun);acc.push(mw),setSourceHelper(_src,src.type===_src.type?mwrest:middlewares[_src.type],next,player,acc,lastRun)})}else mwrest.length?setSourceHelper(src,mwrest,next,player,acc,lastRun):lastRun?next(src,acc):setSourceHelper(src,middlewares["*"],next,player,acc,!0)}var MimetypesKind={opus:"video/ogg",ogv:"video/ogg",mp4:"video/mp4",mov:"video/mp4",m4v:"video/mp4",mkv:"video/x-matroska",m4a:"audio/mp4",mp3:"audio/mpeg",aac:"audio/aac",oga:"audio/ogg",m3u8:"application/x-mpegURL",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",png:"image/png",svg:"image/svg+xml",webp:"image/webp"},getMimetype=function(src){void 0===src&&(src="");var ext=getFileExtension(src);return MimetypesKind[ext.toLowerCase()]||""},findMimetype=function(player,src){if(!src)return"";if(player.cache_.source.src===src&&player.cache_.source.type)return player.cache_.source.type;var matchingSources=player.cache_.sources.filter(function(s){return s.src===src});if(matchingSources.length)return matchingSources[0].type;for(var sources=player.$$("source"),i=0;i<sources.length;i++){var s=sources[i];if(s.type&&s.src&&s.src===src)return s.type}return getMimetype(src)},filterSource=function filterSource(src){if(Array.isArray(src)){var newsrc=[];src.forEach(function(srcobj){srcobj=filterSource(srcobj),Array.isArray(srcobj)?newsrc=newsrc.concat(srcobj):isObject(srcobj)&&newsrc.push(srcobj)}),src=newsrc}else src="string"==typeof src&&src.trim()?[fixSource({src:src})]:isObject(src)&&"string"==typeof src.src&&src.src&&src.src.trim()?[fixSource(src)]:[];return src};function fixSource(src){if(!src.type){var mimetype=getMimetype(src.src);mimetype&&(src.type=mimetype)}return src}var MediaLoader=function(_Component){_inheritsLoose(MediaLoader,_Component);function MediaLoader(player,options,ready){var _this,options_=mergeOptions({createEl:!1},options);if(_this=_Component.call(this,player,options_,ready)||this,options.playerOptions.sources&&0!==options.playerOptions.sources.length)player.src(options.playerOptions.sources);else for(var i=0,j=options.playerOptions.techOrder;i<j.length;i++){var techName=toTitleCase(j[i]),tech=Tech.getTech(techName);if(techName||(tech=Component.getComponent(techName)),tech&&tech.isSupported()){player.loadTech_(techName);break}}return _this}return MediaLoader}(Component);Component.registerComponent("MediaLoader",MediaLoader);var ClickableComponent=function(_Component){_inheritsLoose(ClickableComponent,_Component);function ClickableComponent(player,options){var _this;return _this=_Component.call(this,player,options)||this,_this.emitTapEvents(),_this.enable(),_this}var _proto=ClickableComponent.prototype;return _proto.createEl=function(tag,props,attributes){void 0===tag&&(tag="div"),void 0===props&&(props={}),void 0===attributes&&(attributes={}),props=assign({innerHTML:'<span aria-hidden="true" class="vjs-icon-placeholder"></span>',className:this.buildCSSClass(),tabIndex:0},props),"button"===tag&&log.error("Creating a ClickableComponent with an HTML element of "+tag+" is not supported; use a Button instead."),attributes=assign({role:"button"},attributes),this.tabIndex_=props.tabIndex;var el=_Component.prototype.createEl.call(this,tag,props,attributes);return this.createControlTextEl(el),el},_proto.dispose=function(){this.controlTextEl_=null,_Component.prototype.dispose.call(this)},_proto.createControlTextEl=function(el){return this.controlTextEl_=createEl("span",{className:"vjs-control-text"},{"aria-live":"polite"}),el&&el.appendChild(this.controlTextEl_),this.controlText(this.controlText_,el),this.controlTextEl_},_proto.controlText=function(text,el){if(void 0===el&&(el=this.el()),void 0===text)return this.controlText_||"Need Text";var localizedText=this.localize(text);this.controlText_=text,textContent(this.controlTextEl_,localizedText),this.nonIconControl||el.setAttribute("title",localizedText)},_proto.buildCSSClass=function(){return"vjs-control vjs-button "+_Component.prototype.buildCSSClass.call(this)},_proto.enable=function(){this.enabled_||(this.enabled_=!0,this.removeClass("vjs-disabled"),this.el_.setAttribute("aria-disabled","false"),void 0!==this.tabIndex_&&this.el_.setAttribute("tabIndex",this.tabIndex_),this.on(["tap","click"],this.handleClick),this.on("keydown",this.handleKeyDown))},_proto.disable=function(){this.enabled_=!1,this.addClass("vjs-disabled"),this.el_.setAttribute("aria-disabled","true"),void 0!==this.tabIndex_&&this.el_.removeAttribute("tabIndex"),this.off("mouseover",this.handleMouseOver),this.off("mouseout",this.handleMouseOut),this.off(["tap","click"],this.handleClick),this.off("keydown",this.handleKeyDown)},_proto.handleClick=function(event){},_proto.handleKeyDown=function(event){keycode.isEventKey(event,"Space")||keycode.isEventKey(event,"Enter")?(event.preventDefault(),event.stopPropagation(),this.trigger("click")):_Component.prototype.handleKeyDown.call(this,event)},ClickableComponent}(Component);Component.registerComponent("ClickableComponent",ClickableComponent);var PosterImage=function(_ClickableComponent){_inheritsLoose(PosterImage,_ClickableComponent);function PosterImage(player,options){var _this;return _this=_ClickableComponent.call(this,player,options)||this,_this.update(),player.on("posterchange",bind(_assertThisInitialized(_this),_this.update)),_this}var _proto=PosterImage.prototype;return _proto.dispose=function(){this.player().off("posterchange",this.update),_ClickableComponent.prototype.dispose.call(this)},_proto.createEl=function(){return createEl("div",{className:"vjs-poster",tabIndex:-1})},_proto.update=function(event){var url=this.player().poster();this.setSrc(url),url?this.show():this.hide()},_proto.setSrc=function(url){var backgroundImage="";url&&(backgroundImage='url("'+url+'")'),this.el_.style.backgroundImage=backgroundImage},_proto.handleClick=function(event){this.player_.controls()&&(this.player_.tech(!0)&&this.player_.tech(!0).focus(),this.player_.paused()?silencePromise(this.player_.play()):this.player_.pause())},PosterImage}(ClickableComponent);Component.registerComponent("PosterImage",PosterImage);var fontMap={monospace:"monospace",sansSerif:"sans-serif",serif:"serif",monospaceSansSerif:'"Andale Mono", "Lucida Console", monospace',monospaceSerif:'"Courier New", monospace',proportionalSansSerif:"sans-serif",proportionalSerif:"serif",casual:'"Comic Sans MS", Impact, fantasy',script:'"Monotype Corsiva", cursive',smallcaps:'"Andale Mono", "Lucida Console", monospace, sans-serif'};function constructColor(color,opacity){var hex;if(4===color.length)hex=color[1]+color[1]+color[2]+color[2]+color[3]+color[3];else{if(7!==color.length)throw new Error("Invalid color code provided, "+color+"; must be formatted as e.g. #f0e or #f604e2.");hex=color.slice(1)}return"rgba("+parseInt(hex.slice(0,2),16)+","+parseInt(hex.slice(2,4),16)+","+parseInt(hex.slice(4,6),16)+","+opacity+")"}function tryUpdateStyle(el,style,rule){try{el.style[style]=rule}catch(e){return}}var TextTrackDisplay=function(_Component){_inheritsLoose(TextTrackDisplay,_Component);function TextTrackDisplay(player,options,ready){var _this;_this=_Component.call(this,player,options,ready)||this;var updateDisplayHandler=bind(_assertThisInitialized(_this),_this.updateDisplay);return player.on("loadstart",bind(_assertThisInitialized(_this),_this.toggleDisplay)),player.on("texttrackchange",updateDisplayHandler),player.on("loadedmetadata",bind(_assertThisInitialized(_this),_this.preselectTrack)),player.ready(bind(_assertThisInitialized(_this),function(){if(player.tech_&&player.tech_.featuresNativeTextTracks)return void this.hide();player.on("fullscreenchange",updateDisplayHandler),player.on("playerresize",updateDisplayHandler),window$1.addEventListener("orientationchange",updateDisplayHandler),player.on("dispose",function(){return window$1.removeEventListener("orientationchange",updateDisplayHandler)});for(var tracks=this.options_.playerOptions.tracks||[],i=0;i<tracks.length;i++)this.player_.addRemoteTextTrack(tracks[i],!0);this.preselectTrack()})),_this}var _proto=TextTrackDisplay.prototype;return _proto.preselectTrack=function(){for(var firstDesc,firstCaptions,preferredTrack,modes={captions:1,subtitles:1},trackList=this.player_.textTracks(),userPref=this.player_.cache_.selectedLanguage,i=0;i<trackList.length;i++){var track=trackList[i];userPref&&userPref.enabled&&userPref.language&&userPref.language===track.language&&track.kind in modes?track.kind===userPref.kind?preferredTrack=track:preferredTrack||(preferredTrack=track):userPref&&!userPref.enabled?(preferredTrack=null,firstDesc=null,firstCaptions=null):track.default&&("descriptions"!==track.kind||firstDesc?track.kind in modes&&!firstCaptions&&(firstCaptions=track):firstDesc=track)}preferredTrack?preferredTrack.mode="showing":firstCaptions?firstCaptions.mode="showing":firstDesc&&(firstDesc.mode="showing")},_proto.toggleDisplay=function(){this.player_.tech_&&this.player_.tech_.featuresNativeTextTracks?this.hide():this.show()},_proto.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:"vjs-text-track-display"},{"aria-live":"off","aria-atomic":"true"})},_proto.clearDisplay=function(){"function"==typeof window$1.WebVTT&&window$1.WebVTT.processCues(window$1,[],this.el_)},_proto.updateDisplay=function(){var tracks=this.player_.textTracks(),allowMultipleShowingTracks=this.options_.allowMultipleShowingTracks;if(this.clearDisplay(),allowMultipleShowingTracks){for(var showingTracks=[],_i=0;_i<tracks.length;++_i){var track=tracks[_i];"showing"===track.mode&&showingTracks.push(track)}return void this.updateForTrack(showingTracks)}for(var descriptionsTrack=null,captionsSubtitlesTrack=null,i=tracks.length;i--;){var _track=tracks[i];"showing"===_track.mode&&("descriptions"===_track.kind?descriptionsTrack=_track:captionsSubtitlesTrack=_track)}captionsSubtitlesTrack?("off"!==this.getAttribute("aria-live")&&this.setAttribute("aria-live","off"),this.updateForTrack(captionsSubtitlesTrack)):descriptionsTrack&&("assertive"!==this.getAttribute("aria-live")&&this.setAttribute("aria-live","assertive"),this.updateForTrack(descriptionsTrack))},_proto.updateDisplayState=function(track){for(var overrides=this.player_.textTrackSettings.getValues(),cues=track.activeCues,i=cues.length;i--;){var cue=cues[i];if(cue){var cueDiv=cue.displayState;if(overrides.color&&(cueDiv.firstChild.style.color=overrides.color),overrides.textOpacity&&tryUpdateStyle(cueDiv.firstChild,"color",constructColor(overrides.color||"#fff",overrides.textOpacity)),overrides.backgroundColor&&(cueDiv.firstChild.style.backgroundColor=overrides.backgroundColor),overrides.backgroundOpacity&&tryUpdateStyle(cueDiv.firstChild,"backgroundColor",constructColor(overrides.backgroundColor||"#000",overrides.backgroundOpacity)),overrides.windowColor&&(overrides.windowOpacity?tryUpdateStyle(cueDiv,"backgroundColor",constructColor(overrides.windowColor,overrides.windowOpacity)):cueDiv.style.backgroundColor=overrides.windowColor),overrides.edgeStyle&&("dropshadow"===overrides.edgeStyle?cueDiv.firstChild.style.textShadow="2px 2px 3px #222, 2px 2px 4px #222, 2px 2px 5px #222":"raised"===overrides.edgeStyle?cueDiv.firstChild.style.textShadow="1px 1px #222, 2px 2px #222, 3px 3px #222":"depressed"===overrides.edgeStyle?cueDiv.firstChild.style.textShadow="1px 1px #ccc, 0 1px #ccc, -1px -1px #222, 0 -1px #222":"uniform"===overrides.edgeStyle&&(cueDiv.firstChild.style.textShadow="0 0 4px #222, 0 0 4px #222, 0 0 4px #222, 0 0 4px #222")),overrides.fontPercent&&1!==overrides.fontPercent){var fontSize=window$1.parseFloat(cueDiv.style.fontSize);cueDiv.style.fontSize=fontSize*overrides.fontPercent+"px",cueDiv.style.height="auto",cueDiv.style.top="auto",cueDiv.style.bottom="2px"}overrides.fontFamily&&"default"!==overrides.fontFamily&&("small-caps"===overrides.fontFamily?cueDiv.firstChild.style.fontVariant="small-caps":cueDiv.firstChild.style.fontFamily=fontMap[overrides.fontFamily])}}},_proto.updateForTrack=function(tracks){if(Array.isArray(tracks)||(tracks=[tracks]),"function"==typeof window$1.WebVTT&&!tracks.every(function(track){return!track.activeCues})){for(var cues=[],i=0;i<tracks.length;++i)for(var track=tracks[i],j=0;j<track.activeCues.length;++j)cues.push(track.activeCues[j]);window$1.WebVTT.processCues(window$1,cues,this.el_);for(var _i2=0;_i2<tracks.length;++_i2){for(var _track2=tracks[_i2],_j=0;_j<_track2.activeCues.length;++_j){var cueEl=_track2.activeCues[_j].displayState;addClass(cueEl,"vjs-text-track-cue"),addClass(cueEl,"vjs-text-track-cue-"+(_track2.language?_track2.language:_i2))}this.player_.textTrackSettings&&this.updateDisplayState(_track2)}}},TextTrackDisplay}(Component);Component.registerComponent("TextTrackDisplay",TextTrackDisplay);var LoadingSpinner=function(_Component){_inheritsLoose(LoadingSpinner,_Component);function LoadingSpinner(){return _Component.apply(this,arguments)||this}return LoadingSpinner.prototype.createEl=function(){var isAudio=this.player_.isAudio(),playerType=this.localize(isAudio?"Audio Player":"Video Player"),controlText=createEl("span",{className:"vjs-control-text",innerHTML:this.localize("{1} is loading.",[playerType])}),el=_Component.prototype.createEl.call(this,"div",{className:"vjs-loading-spinner",dir:"ltr"});return el.appendChild(controlText),el},LoadingSpinner}(Component);Component.registerComponent("LoadingSpinner",LoadingSpinner);var Button=function(_ClickableComponent){_inheritsLoose(Button,_ClickableComponent);function Button(){return _ClickableComponent.apply(this,arguments)||this}var _proto=Button.prototype;return _proto.createEl=function(tag,props,attributes){void 0===props&&(props={}),void 0===attributes&&(attributes={}),tag="button",props=assign({innerHTML:'<span aria-hidden="true" class="vjs-icon-placeholder"></span>',className:this.buildCSSClass()},props),attributes=assign({type:"button"},attributes);var el=Component.prototype.createEl.call(this,tag,props,attributes);return this.createControlTextEl(el),el},_proto.addChild=function(child,options){void 0===options&&(options={});var className=this.constructor.name;return log.warn("Adding an actionable (user controllable) child to a Button ("+className+") is not supported; use a ClickableComponent instead."),Component.prototype.addChild.call(this,child,options)},_proto.enable=function(){_ClickableComponent.prototype.enable.call(this),this.el_.removeAttribute("disabled")},_proto.disable=function(){_ClickableComponent.prototype.disable.call(this),this.el_.setAttribute("disabled","disabled")},_proto.handleKeyDown=function(event){if(keycode.isEventKey(event,"Space")||keycode.isEventKey(event,"Enter"))return void event.stopPropagation();_ClickableComponent.prototype.handleKeyDown.call(this,event)},Button}(ClickableComponent);Component.registerComponent("Button",Button);var BigPlayButton=function(_Button){_inheritsLoose(BigPlayButton,_Button);function BigPlayButton(player,options){var _this;return _this=_Button.call(this,player,options)||this,_this.mouseused_=!1,_this.on("mousedown",_this.handleMouseDown),_this}var _proto=BigPlayButton.prototype;return _proto.buildCSSClass=function(){return"vjs-big-play-button"},_proto.handleClick=function(event){var playPromise=this.player_.play();if(this.mouseused_&&event.clientX&&event.clientY)return silencePromise(playPromise),void(this.player_.tech(!0)&&this.player_.tech(!0).focus());var cb=this.player_.getChild("controlBar"),playToggle=cb&&cb.getChild("playToggle");if(!playToggle)return void this.player_.tech(!0).focus();var playFocus=function(){return playToggle.focus()};isPromise(playPromise)?playPromise.then(playFocus,function(){}):this.setTimeout(playFocus,1)},_proto.handleKeyDown=function(event){this.mouseused_=!1,_Button.prototype.handleKeyDown.call(this,event)},_proto.handleMouseDown=function(event){this.mouseused_=!0},BigPlayButton}(Button);BigPlayButton.prototype.controlText_="Play Video",Component.registerComponent("BigPlayButton",BigPlayButton);var CloseButton=function(_Button){_inheritsLoose(CloseButton,_Button);function CloseButton(player,options){var _this;return _this=_Button.call(this,player,options)||this,_this.controlText(options&&options.controlText||_this.localize("Close")),_this}var _proto=CloseButton.prototype;return _proto.buildCSSClass=function(){return"vjs-close-button "+_Button.prototype.buildCSSClass.call(this)},_proto.handleClick=function(event){this.trigger({type:"close",bubbles:!1})},_proto.handleKeyDown=function(event){keycode.isEventKey(event,"Esc")?(event.preventDefault(),event.stopPropagation(),this.trigger("click")):_Button.prototype.handleKeyDown.call(this,event)},CloseButton}(Button);Component.registerComponent("CloseButton",CloseButton);var PlayToggle=function(_Button){_inheritsLoose(PlayToggle,_Button);function PlayToggle(player,options){var _this;return void 0===options&&(options={}),_this=_Button.call(this,player,options)||this,options.replay=void 0===options.replay||options.replay,_this.on(player,"play",_this.handlePlay),_this.on(player,"pause",_this.handlePause),options.replay&&_this.on(player,"ended",_this.handleEnded),_this}var _proto=PlayToggle.prototype;return _proto.buildCSSClass=function(){return"vjs-play-control "+_Button.prototype.buildCSSClass.call(this)},_proto.handleClick=function(event){this.player_.paused()?this.player_.play():this.player_.pause()},_proto.handleSeeked=function(event){this.removeClass("vjs-ended"),this.player_.paused()?this.handlePause(event):this.handlePlay(event)},_proto.handlePlay=function(event){this.removeClass("vjs-ended"),this.removeClass("vjs-paused"),this.addClass("vjs-playing"),this.controlText("Pause")},_proto.handlePause=function(event){this.removeClass("vjs-playing"),this.addClass("vjs-paused"),this.controlText("Play")},_proto.handleEnded=function(event){this.removeClass("vjs-playing"),this.addClass("vjs-ended"),this.controlText("Replay"),this.one(this.player_,"seeked",this.handleSeeked)},PlayToggle}(Button);PlayToggle.prototype.controlText_="Play",Component.registerComponent("PlayToggle",PlayToggle);var defaultImplementation=function(seconds,guide){seconds=seconds<0?0:seconds;var s=Math.floor(seconds%60),m=Math.floor(seconds/60%60),h=Math.floor(seconds/3600),gm=Math.floor(guide/60%60),gh=Math.floor(guide/3600);return(isNaN(seconds)||seconds===1/0)&&(h=m=s="-"),h=h>0||gh>0?h+":":"",m=((h||gm>=10)&&m<10?"0"+m:m)+":",s=s<10?"0"+s:s,h+m+s},implementation$3=defaultImplementation;function setFormatTime(customImplementation){implementation$3=customImplementation}function resetFormatTime(){implementation$3=defaultImplementation}function formatTime(seconds,guide){return void 0===guide&&(guide=seconds),implementation$3(seconds,guide)}var TimeDisplay=function(_Component){_inheritsLoose(TimeDisplay,_Component);function TimeDisplay(player,options){var _this
;return _this=_Component.call(this,player,options)||this,_this.throttledUpdateContent=throttle(bind(_assertThisInitialized(_this),_this.updateContent),UPDATE_REFRESH_INTERVAL),_this.on(player,"timeupdate",_this.throttledUpdateContent),_this}var _proto=TimeDisplay.prototype;return _proto.createEl=function(){var className=this.buildCSSClass(),el=_Component.prototype.createEl.call(this,"div",{className:className+" vjs-time-control vjs-control",innerHTML:'<span class="vjs-control-text" role="presentation">'+this.localize(this.labelText_)+"Â </span>"});return this.contentEl_=createEl("span",{className:className+"-display"},{"aria-live":"off",role:"presentation"}),this.updateTextNode_(),el.appendChild(this.contentEl_),el},_proto.dispose=function(){this.contentEl_=null,this.textNode_=null,_Component.prototype.dispose.call(this)},_proto.updateTextNode_=function(){if(this.contentEl_){for(;this.contentEl_.firstChild;)this.contentEl_.removeChild(this.contentEl_.firstChild);this.textNode_=document.createTextNode(this.formattedTime_||this.formatTime_(0)),this.contentEl_.appendChild(this.textNode_)}},_proto.formatTime_=function(time){return formatTime(time)},_proto.updateFormattedTime_=function(time){var formattedTime=this.formatTime_(time);formattedTime!==this.formattedTime_&&(this.formattedTime_=formattedTime,this.requestAnimationFrame(this.updateTextNode_))},_proto.updateContent=function(event){},TimeDisplay}(Component);TimeDisplay.prototype.labelText_="Time",TimeDisplay.prototype.controlText_="Time",Component.registerComponent("TimeDisplay",TimeDisplay);var CurrentTimeDisplay=function(_TimeDisplay){_inheritsLoose(CurrentTimeDisplay,_TimeDisplay);function CurrentTimeDisplay(player,options){var _this;return _this=_TimeDisplay.call(this,player,options)||this,_this.on(player,"ended",_this.handleEnded),_this}var _proto=CurrentTimeDisplay.prototype;return _proto.buildCSSClass=function(){return"vjs-current-time"},_proto.updateContent=function(event){var time=this.player_.scrubbing()?this.player_.getCache().currentTime:this.player_.currentTime();this.updateFormattedTime_(time)},_proto.handleEnded=function(event){this.player_.duration()&&this.updateFormattedTime_(this.player_.duration())},CurrentTimeDisplay}(TimeDisplay);CurrentTimeDisplay.prototype.labelText_="Current Time",CurrentTimeDisplay.prototype.controlText_="Current Time",Component.registerComponent("CurrentTimeDisplay",CurrentTimeDisplay);var DurationDisplay=function(_TimeDisplay){_inheritsLoose(DurationDisplay,_TimeDisplay);function DurationDisplay(player,options){var _this;return _this=_TimeDisplay.call(this,player,options)||this,_this.on(player,"durationchange",_this.updateContent),_this.on(player,"loadstart",_this.updateContent),_this.on(player,"loadedmetadata",_this.throttledUpdateContent),_this}var _proto=DurationDisplay.prototype;return _proto.buildCSSClass=function(){return"vjs-duration"},_proto.updateContent=function(event){var duration=this.player_.duration();this.duration_!==duration&&(this.duration_=duration,this.updateFormattedTime_(duration))},DurationDisplay}(TimeDisplay);DurationDisplay.prototype.labelText_="Duration",DurationDisplay.prototype.controlText_="Duration",Component.registerComponent("DurationDisplay",DurationDisplay);var TimeDivider=function(_Component){_inheritsLoose(TimeDivider,_Component);function TimeDivider(){return _Component.apply(this,arguments)||this}return TimeDivider.prototype.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:"vjs-time-control vjs-time-divider",innerHTML:"<div><span>/</span></div>"},{"aria-hidden":!0})},TimeDivider}(Component);Component.registerComponent("TimeDivider",TimeDivider);var RemainingTimeDisplay=function(_TimeDisplay){_inheritsLoose(RemainingTimeDisplay,_TimeDisplay);function RemainingTimeDisplay(player,options){var _this;return _this=_TimeDisplay.call(this,player,options)||this,_this.on(player,"durationchange",_this.throttledUpdateContent),_this.on(player,"ended",_this.handleEnded),_this}var _proto=RemainingTimeDisplay.prototype;return _proto.buildCSSClass=function(){return"vjs-remaining-time"},_proto.createEl=function(){var el=_TimeDisplay.prototype.createEl.call(this);return el.insertBefore(createEl("span",{},{"aria-hidden":!0},"-"),this.contentEl_),el},_proto.updateContent=function(event){"number"==typeof this.player_.duration()&&(this.player_.remainingTimeDisplay?this.updateFormattedTime_(this.player_.remainingTimeDisplay()):this.updateFormattedTime_(this.player_.remainingTime()))},_proto.handleEnded=function(event){this.player_.duration()&&this.updateFormattedTime_(0)},RemainingTimeDisplay}(TimeDisplay);RemainingTimeDisplay.prototype.labelText_="Remaining Time",RemainingTimeDisplay.prototype.controlText_="Remaining Time",Component.registerComponent("RemainingTimeDisplay",RemainingTimeDisplay);var LiveDisplay=function(_Component){_inheritsLoose(LiveDisplay,_Component);function LiveDisplay(player,options){var _this;return _this=_Component.call(this,player,options)||this,_this.updateShowing(),_this.on(_this.player(),"durationchange",_this.updateShowing),_this}var _proto=LiveDisplay.prototype;return _proto.createEl=function(){var el=_Component.prototype.createEl.call(this,"div",{className:"vjs-live-control vjs-control"});return this.contentEl_=createEl("div",{className:"vjs-live-display",innerHTML:'<span class="vjs-control-text">'+this.localize("Stream Type")+"Â </span>"+this.localize("LIVE")},{"aria-live":"off"}),el.appendChild(this.contentEl_),el},_proto.dispose=function(){this.contentEl_=null,_Component.prototype.dispose.call(this)},_proto.updateShowing=function(event){this.player().duration()===1/0?this.show():this.hide()},LiveDisplay}(Component);Component.registerComponent("LiveDisplay",LiveDisplay);var SeekToLive=function(_Button){_inheritsLoose(SeekToLive,_Button);function SeekToLive(player,options){var _this;return _this=_Button.call(this,player,options)||this,_this.updateLiveEdgeStatus(),_this.player_.liveTracker&&_this.on(_this.player_.liveTracker,"liveedgechange",_this.updateLiveEdgeStatus),_this}var _proto=SeekToLive.prototype;return _proto.createEl=function(){var el=_Button.prototype.createEl.call(this,"button",{className:"vjs-seek-to-live-control vjs-control"});return this.textEl_=createEl("span",{className:"vjs-seek-to-live-text",innerHTML:this.localize("LIVE")},{"aria-hidden":"true"}),el.appendChild(this.textEl_),el},_proto.updateLiveEdgeStatus=function(e){!this.player_.liveTracker||this.player_.liveTracker.atLiveEdge()?(this.setAttribute("aria-disabled",!0),this.addClass("vjs-at-live-edge"),this.controlText("Seek to live, currently playing live")):(this.setAttribute("aria-disabled",!1),this.removeClass("vjs-at-live-edge"),this.controlText("Seek to live, currently behind live"))},_proto.handleClick=function(){this.player_.liveTracker.seekToLiveEdge()},_proto.dispose=function(){this.player_.liveTracker&&this.off(this.player_.liveTracker,"liveedgechange",this.updateLiveEdgeStatus),this.textEl_=null,_Button.prototype.dispose.call(this)},SeekToLive}(Button);SeekToLive.prototype.controlText_="Seek to live, currently playing live",Component.registerComponent("SeekToLive",SeekToLive);var Slider=function(_Component){_inheritsLoose(Slider,_Component);function Slider(player,options){var _this;return _this=_Component.call(this,player,options)||this,_this.bar=_this.getChild(_this.options_.barName),_this.vertical(!!_this.options_.vertical),_this.enable(),_this}var _proto=Slider.prototype;return _proto.enabled=function(){return this.enabled_},_proto.enable=function(){this.enabled()||(this.on("mousedown",this.handleMouseDown),this.on("touchstart",this.handleMouseDown),this.on("keydown",this.handleKeyDown),this.on("click",this.handleClick),this.on(this.player_,"controlsvisible",this.update),this.playerEvent&&this.on(this.player_,this.playerEvent,this.update),this.removeClass("disabled"),this.setAttribute("tabindex",0),this.enabled_=!0)},_proto.disable=function(){if(this.enabled()){var doc=this.bar.el_.ownerDocument;this.off("mousedown",this.handleMouseDown),this.off("touchstart",this.handleMouseDown),this.off("keydown",this.handleKeyDown),this.off("click",this.handleClick),this.off(this.player_,"controlsvisible",this.update),this.off(doc,"mousemove",this.handleMouseMove),this.off(doc,"mouseup",this.handleMouseUp),this.off(doc,"touchmove",this.handleMouseMove),this.off(doc,"touchend",this.handleMouseUp),this.removeAttribute("tabindex"),this.addClass("disabled"),this.playerEvent&&this.off(this.player_,this.playerEvent,this.update),this.enabled_=!1}},_proto.createEl=function(type,props,attributes){return void 0===props&&(props={}),void 0===attributes&&(attributes={}),props.className=props.className+" vjs-slider",props=assign({tabIndex:0},props),attributes=assign({role:"slider","aria-valuenow":0,"aria-valuemin":0,"aria-valuemax":100,tabIndex:0},attributes),_Component.prototype.createEl.call(this,type,props,attributes)},_proto.handleMouseDown=function(event){var doc=this.bar.el_.ownerDocument;"mousedown"===event.type&&event.preventDefault(),"touchstart"!==event.type||IS_CHROME||event.preventDefault(),blockTextSelection(),this.addClass("vjs-sliding"),this.trigger("slideractive"),this.on(doc,"mousemove",this.handleMouseMove),this.on(doc,"mouseup",this.handleMouseUp),this.on(doc,"touchmove",this.handleMouseMove),this.on(doc,"touchend",this.handleMouseUp),this.handleMouseMove(event)},_proto.handleMouseMove=function(event){},_proto.handleMouseUp=function(){var doc=this.bar.el_.ownerDocument;unblockTextSelection(),this.removeClass("vjs-sliding"),this.trigger("sliderinactive"),this.off(doc,"mousemove",this.handleMouseMove),this.off(doc,"mouseup",this.handleMouseUp),this.off(doc,"touchmove",this.handleMouseMove),this.off(doc,"touchend",this.handleMouseUp),this.update()},_proto.update=function(){if(this.el_){var progress=this.getPercent(),bar=this.bar;if(bar){("number"!=typeof progress||progress!==progress||progress<0||progress===1/0)&&(progress=0);var percentage=(100*progress).toFixed(2)+"%",style=bar.el().style,sizeKey=this.vertical()?"height":"width";return style[sizeKey]!==percentage&&(style[sizeKey]=percentage),progress}}},_proto.calculateDistance=function(event){var position=getPointerPosition(this.el_,event);return this.vertical()?position.y:position.x},_proto.handleKeyDown=function(event){keycode.isEventKey(event,"Left")||keycode.isEventKey(event,"Down")?(event.preventDefault(),event.stopPropagation(),this.stepBack()):keycode.isEventKey(event,"Right")||keycode.isEventKey(event,"Up")?(event.preventDefault(),event.stopPropagation(),this.stepForward()):_Component.prototype.handleKeyDown.call(this,event)},_proto.handleClick=function(event){event.stopPropagation(),event.preventDefault()},_proto.vertical=function(bool){if(void 0===bool)return this.vertical_||!1;this.vertical_=!!bool,this.vertical_?this.addClass("vjs-slider-vertical"):this.addClass("vjs-slider-horizontal")},Slider}(Component);Component.registerComponent("Slider",Slider);var LoadProgressBar=function(_Component){_inheritsLoose(LoadProgressBar,_Component);function LoadProgressBar(player,options){var _this;return _this=_Component.call(this,player,options)||this,_this.partEls_=[],_this.on(player,"progress",_this.update),_this}var _proto=LoadProgressBar.prototype;return _proto.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:"vjs-load-progress",innerHTML:'<span class="vjs-control-text"><span>'+this.localize("Loaded")+'</span>: <span class="vjs-control-text-loaded-percentage">0%</span></span>'})},_proto.dispose=function(){this.partEls_=null,_Component.prototype.dispose.call(this)},_proto.update=function(event){var liveTracker=this.player_.liveTracker,buffered=this.player_.buffered(),duration=liveTracker&&liveTracker.isLive()?liveTracker.seekableEnd():this.player_.duration(),bufferedEnd=this.player_.bufferedEnd(),children=this.partEls_,controlTextPercentage=this.$(".vjs-control-text-loaded-percentage"),percentify=function(time,end,rounded){var percent=time/end||0;return percent=100*(percent>=1?1:percent),rounded&&(percent=percent.toFixed(2)),percent+"%"};this.el_.style.width=percentify(bufferedEnd,duration),textContent(controlTextPercentage,percentify(bufferedEnd,duration,!0));for(var i=0;i<buffered.length;i++){var start=buffered.start(i),end=buffered.end(i),part=children[i];part||(part=this.el_.appendChild(createEl()),children[i]=part),part.style.left=percentify(start,bufferedEnd),part.style.width=percentify(end-start,bufferedEnd)}for(var _i=children.length;_i>buffered.length;_i--)this.el_.removeChild(children[_i-1]);children.length=buffered.length},LoadProgressBar}(Component);Component.registerComponent("LoadProgressBar",LoadProgressBar);var TimeTooltip=function(_Component){_inheritsLoose(TimeTooltip,_Component);function TimeTooltip(player,options){var _this;return _this=_Component.call(this,player,options)||this,_this.update=throttle(bind(_assertThisInitialized(_this),_this.update),UPDATE_REFRESH_INTERVAL),_this}var _proto=TimeTooltip.prototype;return _proto.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:"vjs-time-tooltip"},{"aria-hidden":"true"})},_proto.update=function(seekBarRect,seekBarPoint,content){var tooltipRect=getBoundingClientRect(this.el_),playerRect=getBoundingClientRect(this.player_.el()),seekBarPointPx=seekBarRect.width*seekBarPoint;if(playerRect&&tooltipRect){var spaceLeftOfPoint=seekBarRect.left-playerRect.left+seekBarPointPx,spaceRightOfPoint=seekBarRect.width-seekBarPointPx+(playerRect.right-seekBarRect.right),pullTooltipBy=tooltipRect.width/2;spaceLeftOfPoint<pullTooltipBy?pullTooltipBy+=pullTooltipBy-spaceLeftOfPoint:spaceRightOfPoint<pullTooltipBy&&(pullTooltipBy=spaceRightOfPoint),pullTooltipBy<0?pullTooltipBy=0:pullTooltipBy>tooltipRect.width&&(pullTooltipBy=tooltipRect.width),this.el_.style.right="-"+pullTooltipBy+"px",this.write(content)}},_proto.write=function(content){textContent(this.el_,content)},_proto.updateTime=function(seekBarRect,seekBarPoint,time,cb){var _this2=this;this.rafId_&&this.cancelAnimationFrame(this.rafId_),this.rafId_=this.requestAnimationFrame(function(){var content,duration=_this2.player_.duration();if(_this2.player_.liveTracker&&_this2.player_.liveTracker.isLive()){var liveWindow=_this2.player_.liveTracker.liveWindow(),secondsBehind=liveWindow-seekBarPoint*liveWindow;content=(secondsBehind<1?"":"-")+formatTime(secondsBehind,liveWindow)}else content=formatTime(time,duration);_this2.update(seekBarRect,seekBarPoint,content),cb&&cb()})},TimeTooltip}(Component);Component.registerComponent("TimeTooltip",TimeTooltip);var PlayProgressBar=function(_Component){_inheritsLoose(PlayProgressBar,_Component);function PlayProgressBar(player,options){var _this;return _this=_Component.call(this,player,options)||this,_this.update=throttle(bind(_assertThisInitialized(_this),_this.update),UPDATE_REFRESH_INTERVAL),_this}var _proto=PlayProgressBar.prototype;return _proto.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:"vjs-play-progress vjs-slider-bar"},{"aria-hidden":"true"})},_proto.update=function(seekBarRect,seekBarPoint){var timeTooltip=this.getChild("timeTooltip");if(timeTooltip){var time=this.player_.scrubbing()?this.player_.getCache().currentTime:this.player_.currentTime();timeTooltip.updateTime(seekBarRect,seekBarPoint,time)}},PlayProgressBar}(Component);PlayProgressBar.prototype.options_={children:[]},IS_IOS||IS_ANDROID||PlayProgressBar.prototype.options_.children.push("timeTooltip"),Component.registerComponent("PlayProgressBar",PlayProgressBar);var MouseTimeDisplay=function(_Component){_inheritsLoose(MouseTimeDisplay,_Component);function MouseTimeDisplay(player,options){var _this;return _this=_Component.call(this,player,options)||this,_this.update=throttle(bind(_assertThisInitialized(_this),_this.update),UPDATE_REFRESH_INTERVAL),_this}var _proto=MouseTimeDisplay.prototype;return _proto.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:"vjs-mouse-display"})},_proto.update=function(seekBarRect,seekBarPoint){var _this2=this,time=seekBarPoint*this.player_.duration();this.getChild("timeTooltip").updateTime(seekBarRect,seekBarPoint,time,function(){_this2.el_.style.left=seekBarRect.width*seekBarPoint+"px"})},MouseTimeDisplay}(Component);MouseTimeDisplay.prototype.options_={children:["timeTooltip"]},Component.registerComponent("MouseTimeDisplay",MouseTimeDisplay);var SeekBar=function(_Slider){_inheritsLoose(SeekBar,_Slider);function SeekBar(player,options){var _this;return _this=_Slider.call(this,player,options)||this,_this.setEventHandlers_(),_this}var _proto=SeekBar.prototype;return _proto.setEventHandlers_=function(){this.update=throttle(bind(this,this.update),30),this.on(this.player_,"timeupdate",this.update),this.on(this.player_,"ended",this.handleEnded),this.on(this.player_,"durationchange",this.update),this.player_.liveTracker&&this.on(this.player_.liveTracker,"liveedgechange",this.update),this.updateInterval=null,this.on(this.player_,["playing"],this.enableInterval_),this.on(this.player_,["ended","pause","waiting"],this.disableInterval_),"hidden"in document&&"visibilityState"in document&&this.on(document,"visibilitychange",this.toggleVisibility_)},_proto.toggleVisibility_=function(e){document.hidden?this.disableInterval_(e):(this.enableInterval_(),this.requestAnimationFrame(this.update))},_proto.enableInterval_=function(){var _this2=this;this.clearInterval(this.updateInterval),this.updateInterval=this.setInterval(function(){_this2.requestAnimationFrame(_this2.update)},30)},_proto.disableInterval_=function(e){this.player_.liveTracker&&this.player_.liveTracker.isLive()&&"ended"!==e.type||this.clearInterval(this.updateInterval)},_proto.createEl=function(){return _Slider.prototype.createEl.call(this,"div",{className:"vjs-progress-holder"},{"aria-label":this.localize("Progress Bar")})},_proto.update_=function(currentTime,percent){var liveTracker=this.player_.liveTracker,duration=this.player_.duration();liveTracker&&liveTracker.isLive()&&(duration=this.player_.liveTracker.liveCurrentTime()),this.el_.setAttribute("aria-valuenow",(100*percent).toFixed(2)),this.el_.setAttribute("aria-valuetext",this.localize("progress bar timing: currentTime={1} duration={2}",[formatTime(currentTime,duration),formatTime(duration,duration)],"{1} of {2}")),this.bar&&this.bar.update(getBoundingClientRect(this.el_),percent)},_proto.update=function(event){if(null!==this.el().offsetParent){var percent=_Slider.prototype.update.call(this);return this.update_(this.getCurrentTime_(),percent),percent}},_proto.getCurrentTime_=function(){return this.player_.scrubbing()?this.player_.getCache().currentTime:this.player_.currentTime()},_proto.handleEnded=function(event){this.update_(this.player_.duration(),1)},_proto.getPercent=function(){var percent,currentTime=this.getCurrentTime_(),liveTracker=this.player_.liveTracker;return liveTracker&&liveTracker.isLive()?(percent=(currentTime-liveTracker.seekableStart())/liveTracker.liveWindow(),liveTracker.atLiveEdge()&&(percent=1)):percent=currentTime/this.player_.duration(),percent>=1?1:percent||0},_proto.handleMouseDown=function(event){isSingleLeftClick(event)&&(event.stopPropagation(),this.player_.scrubbing(!0),this.videoWasPlaying=!this.player_.paused(),this.player_.pause(),_Slider.prototype.handleMouseDown.call(this,event))},_proto.handleMouseMove=function(event){if(isSingleLeftClick(event)){var newTime,distance=this.calculateDistance(event),liveTracker=this.player_.liveTracker;if(liveTracker&&liveTracker.isLive()){var seekableStart=liveTracker.seekableStart(),seekableEnd=liveTracker.liveCurrentTime();if(newTime=seekableStart+distance*liveTracker.liveWindow(),newTime>=seekableEnd&&(newTime=seekableEnd),newTime<=seekableStart&&(newTime=seekableStart+.1),newTime===1/0)return}else(newTime=distance*this.player_.duration())===this.player_.duration()&&(newTime-=.1);this.player_.currentTime(newTime)}},_proto.enable=function(){_Slider.prototype.enable.call(this);var mouseTimeDisplay=this.getChild("mouseTimeDisplay");mouseTimeDisplay&&mouseTimeDisplay.show()},_proto.disable=function(){_Slider.prototype.disable.call(this);var mouseTimeDisplay=this.getChild("mouseTimeDisplay");mouseTimeDisplay&&mouseTimeDisplay.hide()},_proto.handleMouseUp=function(event){_Slider.prototype.handleMouseUp.call(this,event),event&&event.stopPropagation(),this.player_.scrubbing(!1),this.player_.trigger({type:"timeupdate",target:this,manuallyTriggered:!0}),this.videoWasPlaying&&silencePromise(this.player_.play())},_proto.stepForward=function(){this.player_.currentTime(this.player_.currentTime()+5)},_proto.stepBack=function(){this.player_.currentTime(this.player_.currentTime()-5)},_proto.handleAction=function(event){this.player_.paused()?this.player_.play():this.player_.pause()},_proto.handleKeyDown=function(event){if(keycode.isEventKey(event,"Space")||keycode.isEventKey(event,"Enter"))event.preventDefault(),event.stopPropagation(),this.handleAction(event);else if(keycode.isEventKey(event,"Home"))event.preventDefault(),event.stopPropagation(),this.player_.currentTime(0);else if(keycode.isEventKey(event,"End"))event.preventDefault(),event.stopPropagation(),this.player_.currentTime(this.player_.duration());else if(/^[0-9]$/.test(keycode(event))){event.preventDefault(),event.stopPropagation();var gotoFraction=10*(keycode.codes[keycode(event)]-keycode.codes[0])/100;this.player_.currentTime(this.player_.duration()*gotoFraction)}else keycode.isEventKey(event,"PgDn")?(event.preventDefault(),event.stopPropagation(),this.player_.currentTime(this.player_.currentTime()-60)):keycode.isEventKey(event,"PgUp")?(event.preventDefault(),event.stopPropagation(),this.player_.currentTime(this.player_.currentTime()+60)):_Slider.prototype.handleKeyDown.call(this,event)},SeekBar}(Slider);SeekBar.prototype.options_={children:["loadProgressBar","playProgressBar"],barName:"playProgressBar"},IS_IOS||IS_ANDROID||SeekBar.prototype.options_.children.splice(1,0,"mouseTimeDisplay"),Component.registerComponent("SeekBar",SeekBar);var ProgressControl=function(_Component){_inheritsLoose(ProgressControl,_Component);function ProgressControl(player,options){var _this;return _this=_Component.call(this,player,options)||this,_this.handleMouseMove=throttle(bind(_assertThisInitialized(_this),_this.handleMouseMove),UPDATE_REFRESH_INTERVAL),_this.throttledHandleMouseSeek=throttle(bind(_assertThisInitialized(_this),_this.handleMouseSeek),UPDATE_REFRESH_INTERVAL),_this.enable(),_this}var _proto=ProgressControl.prototype;return _proto.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:"vjs-progress-control vjs-control"})},_proto.handleMouseMove=function(event){var seekBar=this.getChild("seekBar");if(seekBar){var mouseTimeDisplay=seekBar.getChild("mouseTimeDisplay"),seekBarEl=seekBar.el(),seekBarRect=getBoundingClientRect(seekBarEl),seekBarPoint=getPointerPosition(seekBarEl,event).x;seekBarPoint>1?seekBarPoint=1:seekBarPoint<0&&(seekBarPoint=0),mouseTimeDisplay&&mouseTimeDisplay.update(seekBarRect,seekBarPoint)}},_proto.handleMouseSeek=function(event){var seekBar=this.getChild("seekBar");seekBar&&seekBar.handleMouseMove(event)},_proto.enabled=function(){return this.enabled_},_proto.disable=function(){this.children().forEach(function(child){return child.disable&&child.disable()}),this.enabled()&&(this.off(["mousedown","touchstart"],this.handleMouseDown),this.off(this.el_,"mousemove",this.handleMouseMove),this.handleMouseUp(),this.addClass("disabled"),this.enabled_=!1)},_proto.enable=function(){this.children().forEach(function(child){return child.enable&&child.enable()}),this.enabled()||(this.on(["mousedown","touchstart"],this.handleMouseDown),this.on(this.el_,"mousemove",this.handleMouseMove),this.removeClass("disabled"),this.enabled_=!0)},_proto.handleMouseDown=function(event){var doc=this.el_.ownerDocument,seekBar=this.getChild("seekBar");seekBar&&seekBar.handleMouseDown(event),this.on(doc,"mousemove",this.throttledHandleMouseSeek),this.on(doc,"touchmove",this.throttledHandleMouseSeek),this.on(doc,"mouseup",this.handleMouseUp),this.on(doc,"touchend",this.handleMouseUp)},_proto.handleMouseUp=function(event){var doc=this.el_.ownerDocument,seekBar=this.getChild("seekBar");seekBar&&seekBar.handleMouseUp(event),this.off(doc,"mousemove",this.throttledHandleMouseSeek),this.off(doc,"touchmove",this.throttledHandleMouseSeek),this.off(doc,"mouseup",this.handleMouseUp),this.off(doc,"touchend",this.handleMouseUp)},ProgressControl}(Component);ProgressControl.prototype.options_={children:["seekBar"]},Component.registerComponent("ProgressControl",ProgressControl);var PictureInPictureToggle=function(_Button){_inheritsLoose(PictureInPictureToggle,_Button);function PictureInPictureToggle(player,options){var _this;return _this=_Button.call(this,player,options)||this,_this.on(player,["enterpictureinpicture","leavepictureinpicture"],_this.handlePictureInPictureChange),document.pictureInPictureEnabled||_this.disable(),_this}var _proto=PictureInPictureToggle.prototype;return _proto.buildCSSClass=function(){return"vjs-picture-in-picture-control "+_Button.prototype.buildCSSClass.call(this)},_proto.handlePictureInPictureChange=function(event){this.player_.isInPictureInPicture()?this.controlText("Exit Picture-in-Picture"):this.controlText("Picture-in-Picture")},_proto.handleClick=function(event){this.player_.isInPictureInPicture()?this.player_.exitPictureInPicture():this.player_.requestPictureInPicture()},PictureInPictureToggle}(Button);PictureInPictureToggle.prototype.controlText_="Picture-in-Picture",Component.registerComponent("PictureInPictureToggle",PictureInPictureToggle);var FullscreenToggle=function(_Button){_inheritsLoose(FullscreenToggle,_Button);function FullscreenToggle(player,options){var _this;return _this=_Button.call(this,player,options)||this,_this.on(player,"fullscreenchange",_this.handleFullscreenChange),!1===document[player.fsApi_.fullscreenEnabled]&&_this.disable(),_this}var _proto=FullscreenToggle.prototype;return _proto.buildCSSClass=function(){return"vjs-fullscreen-control "+_Button.prototype.buildCSSClass.call(this)},_proto.handleFullscreenChange=function(event){this.player_.isFullscreen()?this.controlText("Non-Fullscreen"):this.controlText("Fullscreen")},_proto.handleClick=function(event){this.player_.isFullscreen()?this.player_.exitFullscreen():this.player_.requestFullscreen()},FullscreenToggle}(Button);FullscreenToggle.prototype.controlText_="Fullscreen",Component.registerComponent("FullscreenToggle",FullscreenToggle);var checkVolumeSupport=function(self,player){player.tech_&&!player.tech_.featuresVolumeControl&&self.addClass("vjs-hidden"),self.on(player,"loadstart",function(){player.tech_.featuresVolumeControl?self.removeClass("vjs-hidden"):self.addClass("vjs-hidden")})},VolumeLevel=function(_Component){_inheritsLoose(VolumeLevel,_Component);function VolumeLevel(){return _Component.apply(this,arguments)||this}return VolumeLevel.prototype.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:"vjs-volume-level",innerHTML:'<span class="vjs-control-text"></span>'})},VolumeLevel}(Component);Component.registerComponent("VolumeLevel",VolumeLevel);var VolumeBar=function(_Slider){_inheritsLoose(VolumeBar,_Slider);function VolumeBar(player,options){var _this;return _this=_Slider.call(this,player,options)||this,_this.on("slideractive",_this.updateLastVolume_),_this.on(player,"volumechange",_this.updateARIAAttributes),player.ready(function(){return _this.updateARIAAttributes()}),_this}var _proto=VolumeBar.prototype;return _proto.createEl=function(){return _Slider.prototype.createEl.call(this,"div",{className:"vjs-volume-bar vjs-slider-bar"},{"aria-label":this.localize("Volume Level"),"aria-live":"polite"})},_proto.handleMouseDown=function(event){isSingleLeftClick(event)&&_Slider.prototype.handleMouseDown.call(this,event)},_proto.handleMouseMove=function(event){isSingleLeftClick(event)&&(this.checkMuted(),this.player_.volume(this.calculateDistance(event)))},_proto.checkMuted=function(){this.player_.muted()&&this.player_.muted(!1)},_proto.getPercent=function(){return this.player_.muted()?0:this.player_.volume()},_proto.stepForward=function(){this.checkMuted(),this.player_.volume(this.player_.volume()+.1)},_proto.stepBack=function(){this.checkMuted(),this.player_.volume(this.player_.volume()-.1)},_proto.updateARIAAttributes=function(event){var ariaValue=this.player_.muted()?0:this.volumeAsPercentage_();this.el_.setAttribute("aria-valuenow",ariaValue),this.el_.setAttribute("aria-valuetext",ariaValue+"%")},_proto.volumeAsPercentage_=function(){return Math.round(100*this.player_.volume())},_proto.updateLastVolume_=function(){var _this2=this,volumeBeforeDrag=this.player_.volume();this.one("sliderinactive",function(){0===_this2.player_.volume()&&_this2.player_.lastVolume_(volumeBeforeDrag)})},VolumeBar}(Slider);VolumeBar.prototype.options_={children:["volumeLevel"],barName:"volumeLevel"},VolumeBar.prototype.playerEvent="volumechange",Component.registerComponent("VolumeBar",VolumeBar);var VolumeControl=function(_Component){_inheritsLoose(VolumeControl,_Component);function VolumeControl(player,options){var _this;return void 0===options&&(options={}),options.vertical=options.vertical||!1,(void 0===options.volumeBar||isPlain(options.volumeBar))&&(options.volumeBar=options.volumeBar||{},options.volumeBar.vertical=options.vertical),_this=_Component.call(this,player,options)||this,checkVolumeSupport(_assertThisInitialized(_this),player),_this.throttledHandleMouseMove=throttle(bind(_assertThisInitialized(_this),_this.handleMouseMove),UPDATE_REFRESH_INTERVAL),_this.on("mousedown",_this.handleMouseDown),_this.on("touchstart",_this.handleMouseDown),_this.on(_this.volumeBar,["focus","slideractive"],function(){_this.volumeBar.addClass("vjs-slider-active"),_this.addClass("vjs-slider-active"),_this.trigger("slideractive")}),_this.on(_this.volumeBar,["blur","sliderinactive"],function(){_this.volumeBar.removeClass("vjs-slider-active"),_this.removeClass("vjs-slider-active"),_this.trigger("sliderinactive")}),_this}var _proto=VolumeControl.prototype;return _proto.createEl=function(){var orientationClass="vjs-volume-horizontal";return this.options_.vertical&&(orientationClass="vjs-volume-vertical"),_Component.prototype.createEl.call(this,"div",{className:"vjs-volume-control vjs-control "+orientationClass})},_proto.handleMouseDown=function(event){var doc=this.el_.ownerDocument;this.on(doc,"mousemove",this.throttledHandleMouseMove),this.on(doc,"touchmove",this.throttledHandleMouseMove),this.on(doc,"mouseup",this.handleMouseUp),this.on(doc,"touchend",this.handleMouseUp)},_proto.handleMouseUp=function(event){var doc=this.el_.ownerDocument;this.off(doc,"mousemove",this.throttledHandleMouseMove),this.off(doc,"touchmove",this.throttledHandleMouseMove),this.off(doc,"mouseup",this.handleMouseUp),this.off(doc,"touchend",this.handleMouseUp)},_proto.handleMouseMove=function(event){this.volumeBar.handleMouseMove(event)},VolumeControl}(Component);VolumeControl.prototype.options_={children:["volumeBar"]},Component.registerComponent("VolumeControl",VolumeControl);var checkMuteSupport=function(self,player){player.tech_&&!player.tech_.featuresMuteControl&&self.addClass("vjs-hidden"),self.on(player,"loadstart",function(){player.tech_.featuresMuteControl?self.removeClass("vjs-hidden"):self.addClass("vjs-hidden")})},MuteToggle=function(_Button){_inheritsLoose(MuteToggle,_Button);function MuteToggle(player,options){var _this;return _this=_Button.call(this,player,options)||this,checkMuteSupport(_assertThisInitialized(_this),player),_this.on(player,["loadstart","volumechange"],_this.update),_this}var _proto=MuteToggle.prototype;return _proto.buildCSSClass=function(){return"vjs-mute-control "+_Button.prototype.buildCSSClass.call(this)},_proto.handleClick=function(event){var vol=this.player_.volume(),lastVolume=this.player_.lastVolume_();if(0===vol){var volumeToSet=lastVolume<.1?.1:lastVolume
;this.player_.volume(volumeToSet),this.player_.muted(!1)}else this.player_.muted(!this.player_.muted())},_proto.update=function(event){this.updateIcon_(),this.updateControlText_()},_proto.updateIcon_=function(){var vol=this.player_.volume(),level=3;IS_IOS&&this.player_.tech_&&this.player_.tech_.el_&&this.player_.muted(this.player_.tech_.el_.muted),0===vol||this.player_.muted()?level=0:vol<.33?level=1:vol<.67&&(level=2);for(var i=0;i<4;i++)removeClass(this.el_,"vjs-vol-"+i);addClass(this.el_,"vjs-vol-"+level)},_proto.updateControlText_=function(){var soundOff=this.player_.muted()||0===this.player_.volume(),text=soundOff?"Unmute":"Mute";this.controlText()!==text&&this.controlText(text)},MuteToggle}(Button);MuteToggle.prototype.controlText_="Mute",Component.registerComponent("MuteToggle",MuteToggle);var VolumePanel=function(_Component){_inheritsLoose(VolumePanel,_Component);function VolumePanel(player,options){var _this;return void 0===options&&(options={}),void 0!==options.inline?options.inline=options.inline:options.inline=!0,(void 0===options.volumeControl||isPlain(options.volumeControl))&&(options.volumeControl=options.volumeControl||{},options.volumeControl.vertical=!options.inline),_this=_Component.call(this,player,options)||this,_this.on(player,["loadstart"],_this.volumePanelState_),_this.on(_this.muteToggle,"keyup",_this.handleKeyPress),_this.on(_this.volumeControl,"keyup",_this.handleVolumeControlKeyUp),_this.on("keydown",_this.handleKeyPress),_this.on("mouseover",_this.handleMouseOver),_this.on("mouseout",_this.handleMouseOut),_this.on(_this.volumeControl,["slideractive"],_this.sliderActive_),_this.on(_this.volumeControl,["sliderinactive"],_this.sliderInactive_),_this}var _proto=VolumePanel.prototype;return _proto.sliderActive_=function(){this.addClass("vjs-slider-active")},_proto.sliderInactive_=function(){this.removeClass("vjs-slider-active")},_proto.volumePanelState_=function(){this.volumeControl.hasClass("vjs-hidden")&&this.muteToggle.hasClass("vjs-hidden")&&this.addClass("vjs-hidden"),this.volumeControl.hasClass("vjs-hidden")&&!this.muteToggle.hasClass("vjs-hidden")&&this.addClass("vjs-mute-toggle-only")},_proto.createEl=function(){var orientationClass="vjs-volume-panel-horizontal";return this.options_.inline||(orientationClass="vjs-volume-panel-vertical"),_Component.prototype.createEl.call(this,"div",{className:"vjs-volume-panel vjs-control "+orientationClass})},_proto.dispose=function(){this.handleMouseOut(),_Component.prototype.dispose.call(this)},_proto.handleVolumeControlKeyUp=function(event){keycode.isEventKey(event,"Esc")&&this.muteToggle.focus()},_proto.handleMouseOver=function(event){this.addClass("vjs-hover"),on(document,"keyup",bind(this,this.handleKeyPress))},_proto.handleMouseOut=function(event){this.removeClass("vjs-hover"),off(document,"keyup",bind(this,this.handleKeyPress))},_proto.handleKeyPress=function(event){keycode.isEventKey(event,"Esc")&&this.handleMouseOut()},VolumePanel}(Component);VolumePanel.prototype.options_={children:["muteToggle","volumeControl"]},Component.registerComponent("VolumePanel",VolumePanel);var Menu=function(_Component){_inheritsLoose(Menu,_Component);function Menu(player,options){var _this;return _this=_Component.call(this,player,options)||this,options&&(_this.menuButton_=options.menuButton),_this.focusedChild_=-1,_this.on("keydown",_this.handleKeyDown),_this.boundHandleBlur_=bind(_assertThisInitialized(_this),_this.handleBlur),_this.boundHandleTapClick_=bind(_assertThisInitialized(_this),_this.handleTapClick),_this}var _proto=Menu.prototype;return _proto.addEventListenerForItem=function(component){component instanceof Component&&(this.on(component,"blur",this.boundHandleBlur_),this.on(component,["tap","click"],this.boundHandleTapClick_))},_proto.removeEventListenerForItem=function(component){component instanceof Component&&(this.off(component,"blur",this.boundHandleBlur_),this.off(component,["tap","click"],this.boundHandleTapClick_))},_proto.removeChild=function(component){"string"==typeof component&&(component=this.getChild(component)),this.removeEventListenerForItem(component),_Component.prototype.removeChild.call(this,component)},_proto.addItem=function(component){var childComponent=this.addChild(component);childComponent&&this.addEventListenerForItem(childComponent)},_proto.createEl=function(){var contentElType=this.options_.contentElType||"ul";this.contentEl_=createEl(contentElType,{className:"vjs-menu-content"}),this.contentEl_.setAttribute("role","menu");var el=_Component.prototype.createEl.call(this,"div",{append:this.contentEl_,className:"vjs-menu"});return el.appendChild(this.contentEl_),on(el,"click",function(event){event.preventDefault(),event.stopImmediatePropagation()}),el},_proto.dispose=function(){this.contentEl_=null,this.boundHandleBlur_=null,this.boundHandleTapClick_=null,_Component.prototype.dispose.call(this)},_proto.handleBlur=function(event){var relatedTarget=event.relatedTarget||document.activeElement;if(!this.children().some(function(element){return element.el()===relatedTarget})){var btn=this.menuButton_;btn&&btn.buttonPressed_&&relatedTarget!==btn.el().firstChild&&btn.unpressButton()}},_proto.handleTapClick=function(event){if(this.menuButton_){this.menuButton_.unpressButton();var childComponents=this.children();if(!Array.isArray(childComponents))return;var foundComponent=childComponents.filter(function(component){return component.el()===event.target})[0];if(!foundComponent)return;"CaptionSettingsMenuItem"!==foundComponent.name()&&this.menuButton_.focus()}},_proto.handleKeyDown=function(event){keycode.isEventKey(event,"Left")||keycode.isEventKey(event,"Down")?(event.preventDefault(),event.stopPropagation(),this.stepForward()):(keycode.isEventKey(event,"Right")||keycode.isEventKey(event,"Up"))&&(event.preventDefault(),event.stopPropagation(),this.stepBack())},_proto.stepForward=function(){var stepChild=0;void 0!==this.focusedChild_&&(stepChild=this.focusedChild_+1),this.focus(stepChild)},_proto.stepBack=function(){var stepChild=0;void 0!==this.focusedChild_&&(stepChild=this.focusedChild_-1),this.focus(stepChild)},_proto.focus=function(item){void 0===item&&(item=0);var children=this.children().slice();children.length&&children[0].className&&/vjs-menu-title/.test(children[0].className)&&children.shift(),children.length>0&&(item<0?item=0:item>=children.length&&(item=children.length-1),this.focusedChild_=item,children[item].el_.focus())},Menu}(Component);Component.registerComponent("Menu",Menu);var MenuButton=function(_Component){_inheritsLoose(MenuButton,_Component);function MenuButton(player,options){var _this;void 0===options&&(options={}),_this=_Component.call(this,player,options)||this,_this.menuButton_=new Button(player,options),_this.menuButton_.controlText(_this.controlText_),_this.menuButton_.el_.setAttribute("aria-haspopup","true");var buttonClass=Button.prototype.buildCSSClass();return _this.menuButton_.el_.className=_this.buildCSSClass()+" "+buttonClass,_this.menuButton_.removeClass("vjs-control"),_this.addChild(_this.menuButton_),_this.update(),_this.enabled_=!0,_this.on(_this.menuButton_,"tap",_this.handleClick),_this.on(_this.menuButton_,"click",_this.handleClick),_this.on(_this.menuButton_,"keydown",_this.handleKeyDown),_this.on(_this.menuButton_,"mouseenter",function(){_this.addClass("vjs-hover"),_this.menu.show(),on(document,"keyup",bind(_assertThisInitialized(_this),_this.handleMenuKeyUp))}),_this.on("mouseleave",_this.handleMouseLeave),_this.on("keydown",_this.handleSubmenuKeyDown),_this}var _proto=MenuButton.prototype;return _proto.update=function(){var menu=this.createMenu();this.menu&&(this.menu.dispose(),this.removeChild(this.menu)),this.menu=menu,this.addChild(menu),this.buttonPressed_=!1,this.menuButton_.el_.setAttribute("aria-expanded","false"),this.items&&this.items.length<=this.hideThreshold_?this.hide():this.show()},_proto.createMenu=function(){var menu=new Menu(this.player_,{menuButton:this});if(this.hideThreshold_=0,this.options_.title){var titleEl=createEl("li",{className:"vjs-menu-title",innerHTML:toTitleCase(this.options_.title),tabIndex:-1});this.hideThreshold_+=1;var titleComponent=new Component(this.player_,{el:titleEl});menu.addItem(titleComponent)}if(this.items=this.createItems(),this.items)for(var i=0;i<this.items.length;i++)menu.addItem(this.items[i]);return menu},_proto.createItems=function(){},_proto.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:this.buildWrapperCSSClass()},{})},_proto.buildWrapperCSSClass=function(){var menuButtonClass="vjs-menu-button";return!0===this.options_.inline?menuButtonClass+="-inline":menuButtonClass+="-popup","vjs-menu-button "+menuButtonClass+" "+Button.prototype.buildCSSClass()+" "+_Component.prototype.buildCSSClass.call(this)},_proto.buildCSSClass=function(){var menuButtonClass="vjs-menu-button";return!0===this.options_.inline?menuButtonClass+="-inline":menuButtonClass+="-popup","vjs-menu-button "+menuButtonClass+" "+_Component.prototype.buildCSSClass.call(this)},_proto.controlText=function(text,el){return void 0===el&&(el=this.menuButton_.el()),this.menuButton_.controlText(text,el)},_proto.dispose=function(){this.handleMouseLeave(),_Component.prototype.dispose.call(this)},_proto.handleClick=function(event){this.buttonPressed_?this.unpressButton():this.pressButton()},_proto.handleMouseLeave=function(event){this.removeClass("vjs-hover"),off(document,"keyup",bind(this,this.handleMenuKeyUp))},_proto.focus=function(){this.menuButton_.focus()},_proto.blur=function(){this.menuButton_.blur()},_proto.handleKeyDown=function(event){keycode.isEventKey(event,"Esc")||keycode.isEventKey(event,"Tab")?(this.buttonPressed_&&this.unpressButton(),keycode.isEventKey(event,"Tab")||(event.preventDefault(),this.menuButton_.focus())):(keycode.isEventKey(event,"Up")||keycode.isEventKey(event,"Down"))&&(this.buttonPressed_||(event.preventDefault(),this.pressButton()))},_proto.handleMenuKeyUp=function(event){(keycode.isEventKey(event,"Esc")||keycode.isEventKey(event,"Tab"))&&this.removeClass("vjs-hover")},_proto.handleSubmenuKeyPress=function(event){this.handleSubmenuKeyDown(event)},_proto.handleSubmenuKeyDown=function(event){(keycode.isEventKey(event,"Esc")||keycode.isEventKey(event,"Tab"))&&(this.buttonPressed_&&this.unpressButton(),keycode.isEventKey(event,"Tab")||(event.preventDefault(),this.menuButton_.focus()))},_proto.pressButton=function(){if(this.enabled_){if(this.buttonPressed_=!0,this.menu.show(),this.menu.lockShowing(),this.menuButton_.el_.setAttribute("aria-expanded","true"),IS_IOS&&isInFrame())return;this.menu.focus()}},_proto.unpressButton=function(){this.enabled_&&(this.buttonPressed_=!1,this.menu.unlockShowing(),this.menu.hide(),this.menuButton_.el_.setAttribute("aria-expanded","false"))},_proto.disable=function(){this.unpressButton(),this.enabled_=!1,this.addClass("vjs-disabled"),this.menuButton_.disable()},_proto.enable=function(){this.enabled_=!0,this.removeClass("vjs-disabled"),this.menuButton_.enable()},MenuButton}(Component);Component.registerComponent("MenuButton",MenuButton);var TrackButton=function(_MenuButton){_inheritsLoose(TrackButton,_MenuButton);function TrackButton(player,options){var _this,tracks=options.tracks;if(_this=_MenuButton.call(this,player,options)||this,_this.items.length<=1&&_this.hide(),!tracks)return _assertThisInitialized(_this);var updateHandler=bind(_assertThisInitialized(_this),_this.update);return tracks.addEventListener("removetrack",updateHandler),tracks.addEventListener("addtrack",updateHandler),_this.player_.on("ready",updateHandler),_this.player_.on("dispose",function(){tracks.removeEventListener("removetrack",updateHandler),tracks.removeEventListener("addtrack",updateHandler)}),_this}return TrackButton}(MenuButton);Component.registerComponent("TrackButton",TrackButton);var MenuKeys=["Tab","Esc","Up","Down","Right","Left"],MenuItem=function(_ClickableComponent){_inheritsLoose(MenuItem,_ClickableComponent);function MenuItem(player,options){var _this;return _this=_ClickableComponent.call(this,player,options)||this,_this.selectable=options.selectable,_this.isSelected_=options.selected||!1,_this.multiSelectable=options.multiSelectable,_this.selected(_this.isSelected_),_this.selectable?_this.multiSelectable?_this.el_.setAttribute("role","menuitemcheckbox"):_this.el_.setAttribute("role","menuitemradio"):_this.el_.setAttribute("role","menuitem"),_this}var _proto=MenuItem.prototype;return _proto.createEl=function(type,props,attrs){return this.nonIconControl=!0,_ClickableComponent.prototype.createEl.call(this,"li",assign({className:"vjs-menu-item",innerHTML:'<span class="vjs-menu-item-text">'+this.localize(this.options_.label)+"</span>",tabIndex:-1},props),attrs)},_proto.handleKeyDown=function(event){MenuKeys.some(function(key){return keycode.isEventKey(event,key)})||_ClickableComponent.prototype.handleKeyDown.call(this,event)},_proto.handleClick=function(event){this.selected(!0)},_proto.selected=function(_selected){this.selectable&&(_selected?(this.addClass("vjs-selected"),this.el_.setAttribute("aria-checked","true"),this.controlText(", selected"),this.isSelected_=!0):(this.removeClass("vjs-selected"),this.el_.setAttribute("aria-checked","false"),this.controlText(""),this.isSelected_=!1))},MenuItem}(ClickableComponent);Component.registerComponent("MenuItem",MenuItem);var TextTrackMenuItem=function(_MenuItem){_inheritsLoose(TextTrackMenuItem,_MenuItem);function TextTrackMenuItem(player,options){var _this,track=options.track,tracks=player.textTracks();options.label=track.label||track.language||"Unknown",options.selected="showing"===track.mode,_this=_MenuItem.call(this,player,options)||this,_this.track=track,_this.kinds=(options.kinds||[options.kind||_this.track.kind]).filter(Boolean);var changeHandler=function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];_this.handleTracksChange.apply(_assertThisInitialized(_this),args)},selectedLanguageChangeHandler=function(){for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++)args[_key2]=arguments[_key2];_this.handleSelectedLanguageChange.apply(_assertThisInitialized(_this),args)};if(player.on(["loadstart","texttrackchange"],changeHandler),tracks.addEventListener("change",changeHandler),tracks.addEventListener("selectedlanguagechange",selectedLanguageChangeHandler),_this.on("dispose",function(){player.off(["loadstart","texttrackchange"],changeHandler),tracks.removeEventListener("change",changeHandler),tracks.removeEventListener("selectedlanguagechange",selectedLanguageChangeHandler)}),void 0===tracks.onchange){var event;_this.on(["tap","click"],function(){if("object"!=typeof window$1.Event)try{event=new window$1.Event("change")}catch(err){}event||(event=document.createEvent("Event"),event.initEvent("change",!0,!0)),tracks.dispatchEvent(event)})}return _this.handleTracksChange(),_this}var _proto=TextTrackMenuItem.prototype;return _proto.handleClick=function(event){var referenceTrack=this.track,tracks=this.player_.textTracks();if(_MenuItem.prototype.handleClick.call(this,event),tracks)for(var i=0;i<tracks.length;i++){var track=tracks[i];-1!==this.kinds.indexOf(track.kind)&&(track===referenceTrack?"showing"!==track.mode&&(track.mode="showing"):"disabled"!==track.mode&&(track.mode="disabled"))}},_proto.handleTracksChange=function(event){var shouldBeSelected="showing"===this.track.mode;shouldBeSelected!==this.isSelected_&&this.selected(shouldBeSelected)},_proto.handleSelectedLanguageChange=function(event){if("showing"===this.track.mode){var selectedLanguage=this.player_.cache_.selectedLanguage;if(selectedLanguage&&selectedLanguage.enabled&&selectedLanguage.language===this.track.language&&selectedLanguage.kind!==this.track.kind)return;this.player_.cache_.selectedLanguage={enabled:!0,language:this.track.language,kind:this.track.kind}}},_proto.dispose=function(){this.track=null,_MenuItem.prototype.dispose.call(this)},TextTrackMenuItem}(MenuItem);Component.registerComponent("TextTrackMenuItem",TextTrackMenuItem);var OffTextTrackMenuItem=function(_TextTrackMenuItem){_inheritsLoose(OffTextTrackMenuItem,_TextTrackMenuItem);function OffTextTrackMenuItem(player,options){return options.track={player:player,kind:options.kind,kinds:options.kinds,default:!1,mode:"disabled"},options.kinds||(options.kinds=[options.kind]),options.label?options.track.label=options.label:options.track.label=options.kinds.join(" and ")+" off",options.selectable=!0,options.multiSelectable=!1,_TextTrackMenuItem.call(this,player,options)||this}var _proto=OffTextTrackMenuItem.prototype;return _proto.handleTracksChange=function(event){for(var tracks=this.player().textTracks(),shouldBeSelected=!0,i=0,l=tracks.length;i<l;i++){var track=tracks[i];if(this.options_.kinds.indexOf(track.kind)>-1&&"showing"===track.mode){shouldBeSelected=!1;break}}shouldBeSelected!==this.isSelected_&&this.selected(shouldBeSelected)},_proto.handleSelectedLanguageChange=function(event){for(var tracks=this.player().textTracks(),allHidden=!0,i=0,l=tracks.length;i<l;i++){var track=tracks[i];if(["captions","descriptions","subtitles"].indexOf(track.kind)>-1&&"showing"===track.mode){allHidden=!1;break}}allHidden&&(this.player_.cache_.selectedLanguage={enabled:!1})},OffTextTrackMenuItem}(TextTrackMenuItem);Component.registerComponent("OffTextTrackMenuItem",OffTextTrackMenuItem);var TextTrackButton=function(_TrackButton){_inheritsLoose(TextTrackButton,_TrackButton);function TextTrackButton(player,options){return void 0===options&&(options={}),options.tracks=player.textTracks(),_TrackButton.call(this,player,options)||this}return TextTrackButton.prototype.createItems=function(items,TrackMenuItem){void 0===items&&(items=[]),void 0===TrackMenuItem&&(TrackMenuItem=TextTrackMenuItem);var label;this.label_&&(label=this.label_+" off"),items.push(new OffTextTrackMenuItem(this.player_,{kinds:this.kinds_,kind:this.kind_,label:label})),this.hideThreshold_+=1;var tracks=this.player_.textTracks();Array.isArray(this.kinds_)||(this.kinds_=[this.kind_]);for(var i=0;i<tracks.length;i++){var track=tracks[i];if(this.kinds_.indexOf(track.kind)>-1){var item=new TrackMenuItem(this.player_,{track:track,kinds:this.kinds_,kind:this.kind_,selectable:!0,multiSelectable:!1});item.addClass("vjs-"+track.kind+"-menu-item"),items.push(item)}}return items},TextTrackButton}(TrackButton);Component.registerComponent("TextTrackButton",TextTrackButton);var ChaptersTrackMenuItem=function(_MenuItem){_inheritsLoose(ChaptersTrackMenuItem,_MenuItem);function ChaptersTrackMenuItem(player,options){var _this,track=options.track,cue=options.cue,currentTime=player.currentTime();return options.selectable=!0,options.multiSelectable=!1,options.label=cue.text,options.selected=cue.startTime<=currentTime&&currentTime<cue.endTime,_this=_MenuItem.call(this,player,options)||this,_this.track=track,_this.cue=cue,track.addEventListener("cuechange",bind(_assertThisInitialized(_this),_this.update)),_this}var _proto=ChaptersTrackMenuItem.prototype;return _proto.handleClick=function(event){_MenuItem.prototype.handleClick.call(this),this.player_.currentTime(this.cue.startTime),this.update(this.cue.startTime)},_proto.update=function(event){var cue=this.cue,currentTime=this.player_.currentTime();this.selected(cue.startTime<=currentTime&&currentTime<cue.endTime)},ChaptersTrackMenuItem}(MenuItem);Component.registerComponent("ChaptersTrackMenuItem",ChaptersTrackMenuItem);var ChaptersButton=function(_TextTrackButton){_inheritsLoose(ChaptersButton,_TextTrackButton);function ChaptersButton(player,options,ready){return _TextTrackButton.call(this,player,options,ready)||this}var _proto=ChaptersButton.prototype;return _proto.buildCSSClass=function(){return"vjs-chapters-button "+_TextTrackButton.prototype.buildCSSClass.call(this)},_proto.buildWrapperCSSClass=function(){return"vjs-chapters-button "+_TextTrackButton.prototype.buildWrapperCSSClass.call(this)},_proto.update=function(event){this.track_&&(!event||"addtrack"!==event.type&&"removetrack"!==event.type)||this.setTrack(this.findChaptersTrack()),_TextTrackButton.prototype.update.call(this)},_proto.setTrack=function(track){if(this.track_!==track){if(this.updateHandler_||(this.updateHandler_=this.update.bind(this)),this.track_){var remoteTextTrackEl=this.player_.remoteTextTrackEls().getTrackElementByTrack_(this.track_);remoteTextTrackEl&&remoteTextTrackEl.removeEventListener("load",this.updateHandler_),this.track_=null}if(this.track_=track,this.track_){this.track_.mode="hidden";var _remoteTextTrackEl=this.player_.remoteTextTrackEls().getTrackElementByTrack_(this.track_);_remoteTextTrackEl&&_remoteTextTrackEl.addEventListener("load",this.updateHandler_)}}},_proto.findChaptersTrack=function(){for(var tracks=this.player_.textTracks()||[],i=tracks.length-1;i>=0;i--){var track=tracks[i];if(track.kind===this.kind_)return track}},_proto.getMenuCaption=function(){return this.track_&&this.track_.label?this.track_.label:this.localize(toTitleCase(this.kind_))},_proto.createMenu=function(){return this.options_.title=this.getMenuCaption(),_TextTrackButton.prototype.createMenu.call(this)},_proto.createItems=function(){var items=[];if(!this.track_)return items;var cues=this.track_.cues;if(!cues)return items;for(var i=0,l=cues.length;i<l;i++){var cue=cues[i],mi=new ChaptersTrackMenuItem(this.player_,{track:this.track_,cue:cue});items.push(mi)}return items},ChaptersButton}(TextTrackButton);ChaptersButton.prototype.kind_="chapters",ChaptersButton.prototype.controlText_="Chapters",Component.registerComponent("ChaptersButton",ChaptersButton);var DescriptionsButton=function(_TextTrackButton){_inheritsLoose(DescriptionsButton,_TextTrackButton);function DescriptionsButton(player,options,ready){var _this;_this=_TextTrackButton.call(this,player,options,ready)||this;var tracks=player.textTracks(),changeHandler=bind(_assertThisInitialized(_this),_this.handleTracksChange);return tracks.addEventListener("change",changeHandler),_this.on("dispose",function(){tracks.removeEventListener("change",changeHandler)}),_this}var _proto=DescriptionsButton.prototype;return _proto.handleTracksChange=function(event){for(var tracks=this.player().textTracks(),disabled=!1,i=0,l=tracks.length;i<l;i++){var track=tracks[i];if(track.kind!==this.kind_&&"showing"===track.mode){disabled=!0;break}}disabled?this.disable():this.enable()},_proto.buildCSSClass=function(){return"vjs-descriptions-button "+_TextTrackButton.prototype.buildCSSClass.call(this)},_proto.buildWrapperCSSClass=function(){return"vjs-descriptions-button "+_TextTrackButton.prototype.buildWrapperCSSClass.call(this)},DescriptionsButton}(TextTrackButton);DescriptionsButton.prototype.kind_="descriptions",DescriptionsButton.prototype.controlText_="Descriptions",Component.registerComponent("DescriptionsButton",DescriptionsButton);var SubtitlesButton=function(_TextTrackButton){_inheritsLoose(SubtitlesButton,_TextTrackButton);function SubtitlesButton(player,options,ready){return _TextTrackButton.call(this,player,options,ready)||this}var _proto=SubtitlesButton.prototype;return _proto.buildCSSClass=function(){return"vjs-subtitles-button "+_TextTrackButton.prototype.buildCSSClass.call(this)},_proto.buildWrapperCSSClass=function(){return"vjs-subtitles-button "+_TextTrackButton.prototype.buildWrapperCSSClass.call(this)},SubtitlesButton}(TextTrackButton);SubtitlesButton.prototype.kind_="subtitles",SubtitlesButton.prototype.controlText_="Subtitles",Component.registerComponent("SubtitlesButton",SubtitlesButton);var CaptionSettingsMenuItem=function(_TextTrackMenuItem){_inheritsLoose(CaptionSettingsMenuItem,_TextTrackMenuItem);function CaptionSettingsMenuItem(player,options){var _this;return options.track={player:player,kind:options.kind,label:options.kind+" settings",selectable:!1,default:!1,mode:"disabled"},options.selectable=!1,options.name="CaptionSettingsMenuItem",_this=_TextTrackMenuItem.call(this,player,options)||this,_this.addClass("vjs-texttrack-settings"),_this.controlText(", opens "+options.kind+" settings dialog"),_this}return CaptionSettingsMenuItem.prototype.handleClick=function(event){this.player().getChild("textTrackSettings").open()},CaptionSettingsMenuItem}(TextTrackMenuItem);Component.registerComponent("CaptionSettingsMenuItem",CaptionSettingsMenuItem);var CaptionsButton=function(_TextTrackButton){_inheritsLoose(CaptionsButton,_TextTrackButton);function CaptionsButton(player,options,ready){return _TextTrackButton.call(this,player,options,ready)||this}var _proto=CaptionsButton.prototype;return _proto.buildCSSClass=function(){return"vjs-captions-button "+_TextTrackButton.prototype.buildCSSClass.call(this)},_proto.buildWrapperCSSClass=function(){return"vjs-captions-button "+_TextTrackButton.prototype.buildWrapperCSSClass.call(this)},_proto.createItems=function(){var items=[];return this.player().tech_&&this.player().tech_.featuresNativeTextTracks||!this.player().getChild("textTrackSettings")||(items.push(new CaptionSettingsMenuItem(this.player_,{kind:this.kind_})),this.hideThreshold_+=1),_TextTrackButton.prototype.createItems.call(this,items)},CaptionsButton}(TextTrackButton);CaptionsButton.prototype.kind_="captions",CaptionsButton.prototype.controlText_="Captions",Component.registerComponent("CaptionsButton",CaptionsButton);var SubsCapsMenuItem=function(_TextTrackMenuItem){_inheritsLoose(SubsCapsMenuItem,_TextTrackMenuItem);function SubsCapsMenuItem(){return _TextTrackMenuItem.apply(this,arguments)||this}return SubsCapsMenuItem.prototype.createEl=function(type,props,attrs){var innerHTML='<span class="vjs-menu-item-text">'+this.localize(this.options_.label);return"captions"===this.options_.track.kind&&(innerHTML+='\n        <span aria-hidden="true" class="vjs-icon-placeholder"></span>\n        <span class="vjs-control-text"> '+this.localize("Captions")+"</span>\n      "),innerHTML+="</span>",_TextTrackMenuItem.prototype.createEl.call(this,type,assign({innerHTML:innerHTML},props),attrs)},SubsCapsMenuItem}(TextTrackMenuItem);Component.registerComponent("SubsCapsMenuItem",SubsCapsMenuItem);var SubsCapsButton=function(_TextTrackButton){_inheritsLoose(SubsCapsButton,_TextTrackButton);function SubsCapsButton(player,options){var _this;return void 0===options&&(options={}),_this=_TextTrackButton.call(this,player,options)||this,_this.label_="subtitles",["en","en-us","en-ca","fr-ca"].indexOf(_this.player_.language_)>-1&&(_this.label_="captions"),_this.menuButton_.controlText(toTitleCase(_this.label_)),_this}var _proto=SubsCapsButton.prototype;return _proto.buildCSSClass=function(){return"vjs-subs-caps-button "+_TextTrackButton.prototype.buildCSSClass.call(this)},_proto.buildWrapperCSSClass=function(){return"vjs-subs-caps-button "+_TextTrackButton.prototype.buildWrapperCSSClass.call(this)},_proto.createItems=function(){var items=[];return this.player().tech_&&this.player().tech_.featuresNativeTextTracks||!this.player().getChild("textTrackSettings")||(items.push(new CaptionSettingsMenuItem(this.player_,{kind:this.label_})),this.hideThreshold_+=1),items=_TextTrackButton.prototype.createItems.call(this,items,SubsCapsMenuItem)},SubsCapsButton}(TextTrackButton);SubsCapsButton.prototype.kinds_=["captions","subtitles"],SubsCapsButton.prototype.controlText_="Subtitles",Component.registerComponent("SubsCapsButton",SubsCapsButton);var AudioTrackMenuItem=function(_MenuItem){_inheritsLoose(AudioTrackMenuItem,_MenuItem);function AudioTrackMenuItem(player,options){var _this,track=options.track,tracks=player.audioTracks();options.label=track.label||track.language||"Unknown",options.selected=track.enabled,_this=_MenuItem.call(this,player,options)||this,_this.track=track,_this.addClass("vjs-"+track.kind+"-menu-item");var changeHandler=function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];_this.handleTracksChange.apply(_assertThisInitialized(_this),args)};return tracks.addEventListener("change",changeHandler),_this.on("dispose",function(){tracks.removeEventListener("change",changeHandler)}),_this}var _proto=AudioTrackMenuItem.prototype;return _proto.createEl=function(type,props,attrs){var innerHTML='<span class="vjs-menu-item-text">'+this.localize(this.options_.label);return"main-desc"===this.options_.track.kind&&(innerHTML+='\n        <span aria-hidden="true" class="vjs-icon-placeholder"></span>\n        <span class="vjs-control-text"> '+this.localize("Descriptions")+"</span>\n      "),innerHTML+="</span>",_MenuItem.prototype.createEl.call(this,type,assign({innerHTML:innerHTML},props),attrs)},_proto.handleClick=function(event){var tracks=this.player_.audioTracks();_MenuItem.prototype.handleClick.call(this,event);for(var i=0;i<tracks.length;i++){var track=tracks[i];track.enabled=track===this.track}},_proto.handleTracksChange=function(event){this.selected(this.track.enabled)},AudioTrackMenuItem}(MenuItem);Component.registerComponent("AudioTrackMenuItem",AudioTrackMenuItem);var AudioTrackButton=function(_TrackButton){_inheritsLoose(AudioTrackButton,_TrackButton);function AudioTrackButton(player,options){return void 0===options&&(options={}),options.tracks=player.audioTracks(),_TrackButton.call(this,player,options)||this}var _proto=AudioTrackButton.prototype;return _proto.buildCSSClass=function(){return"vjs-audio-button "+_TrackButton.prototype.buildCSSClass.call(this)},_proto.buildWrapperCSSClass=function(){return"vjs-audio-button "+_TrackButton.prototype.buildWrapperCSSClass.call(this)},_proto.createItems=function(items){void 0===items&&(items=[]),this.hideThreshold_=1;for(var tracks=this.player_.audioTracks(),i=0;i<tracks.length;i++){var track=tracks[i];items.push(new AudioTrackMenuItem(this.player_,{track:track,selectable:!0,multiSelectable:!1}))}return items},AudioTrackButton}(TrackButton);AudioTrackButton.prototype.controlText_="Audio Track",Component.registerComponent("AudioTrackButton",AudioTrackButton);var PlaybackRateMenuItem=function(_MenuItem){_inheritsLoose(PlaybackRateMenuItem,_MenuItem);function PlaybackRateMenuItem(player,options){var _this,label=options.rate,rate=parseFloat(label,10);return options.label=label,options.selected=1===rate,options.selectable=!0,options.multiSelectable=!1,_this=_MenuItem.call(this,player,options)||this,_this.label=label,_this.rate=rate,_this.on(player,"ratechange",_this.update),_this}var _proto=PlaybackRateMenuItem.prototype;return _proto.handleClick=function(event){_MenuItem.prototype.handleClick.call(this),this.player().playbackRate(this.rate)},_proto.update=function(event){this.selected(this.player().playbackRate()===this.rate)},PlaybackRateMenuItem}(MenuItem);PlaybackRateMenuItem.prototype.contentElType="button",Component.registerComponent("PlaybackRateMenuItem",PlaybackRateMenuItem);var PlaybackRateMenuButton=function(_MenuButton){_inheritsLoose(PlaybackRateMenuButton,_MenuButton);function PlaybackRateMenuButton(player,options){var _this;return _this=_MenuButton.call(this,player,options)||this,_this.updateVisibility(),_this.updateLabel(),_this.on(player,"loadstart",_this.updateVisibility),_this.on(player,"ratechange",_this.updateLabel),_this}var _proto=PlaybackRateMenuButton.prototype;return _proto.createEl=function(){var el=_MenuButton.prototype.createEl.call(this);return this.labelEl_=createEl("div",{className:"vjs-playback-rate-value",innerHTML:"1x"}),el.appendChild(this.labelEl_),el},_proto.dispose=function(){this.labelEl_=null,_MenuButton.prototype.dispose.call(this)},_proto.buildCSSClass=function(){return"vjs-playback-rate "+_MenuButton.prototype.buildCSSClass.call(this)},_proto.buildWrapperCSSClass=function(){return"vjs-playback-rate "+_MenuButton.prototype.buildWrapperCSSClass.call(this)},_proto.createMenu=function(){var menu=new Menu(this.player()),rates=this.playbackRates();if(rates)for(var i=rates.length-1;i>=0;i--)menu.addChild(new PlaybackRateMenuItem(this.player(),{rate:rates[i]+"x"}));return menu},_proto.updateARIAAttributes=function(){this.el().setAttribute("aria-valuenow",this.player().playbackRate())},_proto.handleClick=function(event){
for(var currentRate=this.player().playbackRate(),rates=this.playbackRates(),newRate=rates[0],i=0;i<rates.length;i++)if(rates[i]>currentRate){newRate=rates[i];break}this.player().playbackRate(newRate)},_proto.playbackRates=function(){return this.options_.playbackRates||this.options_.playerOptions&&this.options_.playerOptions.playbackRates},_proto.playbackRateSupported=function(){return this.player().tech_&&this.player().tech_.featuresPlaybackRate&&this.playbackRates()&&this.playbackRates().length>0},_proto.updateVisibility=function(event){this.playbackRateSupported()?this.removeClass("vjs-hidden"):this.addClass("vjs-hidden")},_proto.updateLabel=function(event){this.playbackRateSupported()&&(this.labelEl_.innerHTML=this.player().playbackRate()+"x")},PlaybackRateMenuButton}(MenuButton);PlaybackRateMenuButton.prototype.controlText_="Playback Rate",Component.registerComponent("PlaybackRateMenuButton",PlaybackRateMenuButton);var Spacer=function(_Component){_inheritsLoose(Spacer,_Component);function Spacer(){return _Component.apply(this,arguments)||this}var _proto=Spacer.prototype;return _proto.buildCSSClass=function(){return"vjs-spacer "+_Component.prototype.buildCSSClass.call(this)},_proto.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:this.buildCSSClass()})},Spacer}(Component);Component.registerComponent("Spacer",Spacer);var CustomControlSpacer=function(_Spacer){_inheritsLoose(CustomControlSpacer,_Spacer);function CustomControlSpacer(){return _Spacer.apply(this,arguments)||this}var _proto=CustomControlSpacer.prototype;return _proto.buildCSSClass=function(){return"vjs-custom-control-spacer "+_Spacer.prototype.buildCSSClass.call(this)},_proto.createEl=function(){var el=_Spacer.prototype.createEl.call(this,{className:this.buildCSSClass()});return el.innerHTML="Â ",el},CustomControlSpacer}(Spacer);Component.registerComponent("CustomControlSpacer",CustomControlSpacer);var ControlBar=function(_Component){_inheritsLoose(ControlBar,_Component);function ControlBar(){return _Component.apply(this,arguments)||this}return ControlBar.prototype.createEl=function(){return _Component.prototype.createEl.call(this,"div",{className:"vjs-control-bar",dir:"ltr"})},ControlBar}(Component);ControlBar.prototype.options_={children:["playToggle","volumePanel","currentTimeDisplay","timeDivider","durationDisplay","progressControl","liveDisplay","seekToLive","remainingTimeDisplay","customControlSpacer","playbackRateMenuButton","chaptersButton","descriptionsButton","subsCapsButton","audioTrackButton","fullscreenToggle"]},"exitPictureInPicture"in document&&ControlBar.prototype.options_.children.splice(ControlBar.prototype.options_.children.length-1,0,"pictureInPictureToggle"),Component.registerComponent("ControlBar",ControlBar);var ErrorDisplay=function(_ModalDialog){_inheritsLoose(ErrorDisplay,_ModalDialog);function ErrorDisplay(player,options){var _this;return _this=_ModalDialog.call(this,player,options)||this,_this.on(player,"error",_this.open),_this}var _proto=ErrorDisplay.prototype;return _proto.buildCSSClass=function(){return"vjs-error-display "+_ModalDialog.prototype.buildCSSClass.call(this)},_proto.content=function(){var error=this.player().error();return error?this.localize(error.message):""},ErrorDisplay}(ModalDialog);ErrorDisplay.prototype.options_=mergeOptions(ModalDialog.prototype.options_,{pauseOnOpen:!1,fillAlways:!0,temporary:!1,uncloseable:!0}),Component.registerComponent("ErrorDisplay",ErrorDisplay);var COLOR_BLACK=["#000","Black"],COLOR_BLUE=["#00F","Blue"],COLOR_CYAN=["#0FF","Cyan"],COLOR_GREEN=["#0F0","Green"],COLOR_MAGENTA=["#F0F","Magenta"],COLOR_RED=["#F00","Red"],COLOR_WHITE=["#FFF","White"],COLOR_YELLOW=["#FF0","Yellow"],OPACITY_OPAQUE=["1","Opaque"],OPACITY_SEMI=["0.5","Semi-Transparent"],OPACITY_TRANS=["0","Transparent"],selectConfigs={backgroundColor:{selector:".vjs-bg-color > select",id:"captions-background-color-%s",label:"Color",options:[COLOR_BLACK,COLOR_WHITE,COLOR_RED,COLOR_GREEN,COLOR_BLUE,COLOR_YELLOW,COLOR_MAGENTA,COLOR_CYAN]},backgroundOpacity:{selector:".vjs-bg-opacity > select",id:"captions-background-opacity-%s",label:"Transparency",options:[OPACITY_OPAQUE,OPACITY_SEMI,OPACITY_TRANS]},color:{selector:".vjs-fg-color > select",id:"captions-foreground-color-%s",label:"Color",options:[COLOR_WHITE,COLOR_BLACK,COLOR_RED,COLOR_GREEN,COLOR_BLUE,COLOR_YELLOW,COLOR_MAGENTA,COLOR_CYAN]},edgeStyle:{selector:".vjs-edge-style > select",id:"%s",label:"Text Edge Style",options:[["none","None"],["raised","Raised"],["depressed","Depressed"],["uniform","Uniform"],["dropshadow","Dropshadow"]]},fontFamily:{selector:".vjs-font-family > select",id:"captions-font-family-%s",label:"Font Family",options:[["proportionalSansSerif","Proportional Sans-Serif"],["monospaceSansSerif","Monospace Sans-Serif"],["proportionalSerif","Proportional Serif"],["monospaceSerif","Monospace Serif"],["casual","Casual"],["script","Script"],["small-caps","Small Caps"]]},fontPercent:{selector:".vjs-font-percent > select",id:"captions-font-size-%s",label:"Font Size",options:[["0.50","50%"],["0.75","75%"],["1.00","100%"],["1.25","125%"],["1.50","150%"],["1.75","175%"],["2.00","200%"],["3.00","300%"],["4.00","400%"]],default:2,parser:function(v){return"1.00"===v?null:Number(v)}},textOpacity:{selector:".vjs-text-opacity > select",id:"captions-foreground-opacity-%s",label:"Transparency",options:[OPACITY_OPAQUE,OPACITY_SEMI]},windowColor:{selector:".vjs-window-color > select",id:"captions-window-color-%s",label:"Color"},windowOpacity:{selector:".vjs-window-opacity > select",id:"captions-window-opacity-%s",label:"Transparency",options:[OPACITY_TRANS,OPACITY_SEMI,OPACITY_OPAQUE]}};selectConfigs.windowColor.options=selectConfigs.backgroundColor.options;function parseOptionValue(value,parser){if(parser&&(value=parser(value)),value&&"none"!==value)return value}function getSelectedOptionValue(el,parser){return parseOptionValue(el.options[el.options.selectedIndex].value,parser)}function setSelectedOption(el,value,parser){if(value)for(var i=0;i<el.options.length;i++)if(parseOptionValue(el.options[i].value,parser)===value){el.selectedIndex=i;break}}var TextTrackSettings=function(_ModalDialog){_inheritsLoose(TextTrackSettings,_ModalDialog);function TextTrackSettings(player,options){var _this;return options.temporary=!1,_this=_ModalDialog.call(this,player,options)||this,_this.updateDisplay=bind(_assertThisInitialized(_this),_this.updateDisplay),_this.fill(),_this.hasBeenOpened_=_this.hasBeenFilled_=!0,_this.endDialog=createEl("p",{className:"vjs-control-text",textContent:_this.localize("End of dialog window.")}),_this.el().appendChild(_this.endDialog),_this.setDefaults(),void 0===options.persistTextTrackSettings&&(_this.options_.persistTextTrackSettings=_this.options_.playerOptions.persistTextTrackSettings),_this.on(_this.$(".vjs-done-button"),"click",function(){_this.saveSettings(),_this.close()}),_this.on(_this.$(".vjs-default-button"),"click",function(){_this.setDefaults(),_this.updateDisplay()}),each(selectConfigs,function(config){_this.on(_this.$(config.selector),"change",_this.updateDisplay)}),_this.options_.persistTextTrackSettings&&_this.restoreSettings(),_this}var _proto=TextTrackSettings.prototype;return _proto.dispose=function(){this.endDialog=null,_ModalDialog.prototype.dispose.call(this)},_proto.createElSelect_=function(key,legendId,type){var _this2=this;void 0===legendId&&(legendId=""),void 0===type&&(type="label");var config=selectConfigs[key],id=config.id.replace("%s",this.id_),selectLabelledbyIds=[legendId,id].join(" ").trim();return["<"+type+' id="'+id+'" class="'+("label"===type?"vjs-label":"")+'">',this.localize(config.label),"</"+type+">",'<select aria-labelledby="'+selectLabelledbyIds+'">'].concat(config.options.map(function(o){var optionId=id+"-"+o[1].replace(/\W+/g,"");return['<option id="'+optionId+'" value="'+o[0]+'" ','aria-labelledby="'+selectLabelledbyIds+" "+optionId+'">',_this2.localize(o[1]),"</option>"].join("")})).concat("</select>").join("")},_proto.createElFgColor_=function(){var legendId="captions-text-legend-"+this.id_;return['<fieldset class="vjs-fg-color vjs-track-setting">','<legend id="'+legendId+'">',this.localize("Text"),"</legend>",this.createElSelect_("color",legendId),'<span class="vjs-text-opacity vjs-opacity">',this.createElSelect_("textOpacity",legendId),"</span>","</fieldset>"].join("")},_proto.createElBgColor_=function(){var legendId="captions-background-"+this.id_;return['<fieldset class="vjs-bg-color vjs-track-setting">','<legend id="'+legendId+'">',this.localize("Background"),"</legend>",this.createElSelect_("backgroundColor",legendId),'<span class="vjs-bg-opacity vjs-opacity">',this.createElSelect_("backgroundOpacity",legendId),"</span>","</fieldset>"].join("")},_proto.createElWinColor_=function(){var legendId="captions-window-"+this.id_;return['<fieldset class="vjs-window-color vjs-track-setting">','<legend id="'+legendId+'">',this.localize("Window"),"</legend>",this.createElSelect_("windowColor",legendId),'<span class="vjs-window-opacity vjs-opacity">',this.createElSelect_("windowOpacity",legendId),"</span>","</fieldset>"].join("")},_proto.createElColors_=function(){return createEl("div",{className:"vjs-track-settings-colors",innerHTML:[this.createElFgColor_(),this.createElBgColor_(),this.createElWinColor_()].join("")})},_proto.createElFont_=function(){return createEl("div",{className:"vjs-track-settings-font",innerHTML:['<fieldset class="vjs-font-percent vjs-track-setting">',this.createElSelect_("fontPercent","","legend"),"</fieldset>",'<fieldset class="vjs-edge-style vjs-track-setting">',this.createElSelect_("edgeStyle","","legend"),"</fieldset>",'<fieldset class="vjs-font-family vjs-track-setting">',this.createElSelect_("fontFamily","","legend"),"</fieldset>"].join("")})},_proto.createElControls_=function(){var defaultsDescription=this.localize("restore all settings to the default values");return createEl("div",{className:"vjs-track-settings-controls",innerHTML:['<button type="button" class="vjs-default-button" title="'+defaultsDescription+'">',this.localize("Reset"),'<span class="vjs-control-text"> '+defaultsDescription+"</span>","</button>",'<button type="button" class="vjs-done-button">'+this.localize("Done")+"</button>"].join("")})},_proto.content=function(){return[this.createElColors_(),this.createElFont_(),this.createElControls_()]},_proto.label=function(){return this.localize("Caption Settings Dialog")},_proto.description=function(){return this.localize("Beginning of dialog window. Escape will cancel and close the window.")},_proto.buildCSSClass=function(){return _ModalDialog.prototype.buildCSSClass.call(this)+" vjs-text-track-settings"},_proto.getValues=function(){var _this3=this;return reduce(selectConfigs,function(accum,config,key){var value=getSelectedOptionValue(_this3.$(config.selector),config.parser);return void 0!==value&&(accum[key]=value),accum},{})},_proto.setValues=function(values){var _this4=this;each(selectConfigs,function(config,key){setSelectedOption(_this4.$(config.selector),values[key],config.parser)})},_proto.setDefaults=function(){var _this5=this;each(selectConfigs,function(config){var index=config.hasOwnProperty("default")?config.default:0;_this5.$(config.selector).selectedIndex=index})},_proto.restoreSettings=function(){var values;try{values=JSON.parse(window$1.localStorage.getItem("vjs-text-track-settings"))}catch(err){log.warn(err)}values&&this.setValues(values)},_proto.saveSettings=function(){if(this.options_.persistTextTrackSettings){var values=this.getValues();try{Object.keys(values).length?window$1.localStorage.setItem("vjs-text-track-settings",JSON.stringify(values)):window$1.localStorage.removeItem("vjs-text-track-settings")}catch(err){log.warn(err)}}},_proto.updateDisplay=function(){var ttDisplay=this.player_.getChild("textTrackDisplay");ttDisplay&&ttDisplay.updateDisplay()},_proto.conditionalBlur_=function(){this.previouslyActiveEl_=null;var cb=this.player_.controlBar,subsCapsBtn=cb&&cb.subsCapsButton,ccBtn=cb&&cb.captionsButton;subsCapsBtn?subsCapsBtn.focus():ccBtn&&ccBtn.focus()},TextTrackSettings}(ModalDialog);Component.registerComponent("TextTrackSettings",TextTrackSettings);var ResizeManager=function(_Component){_inheritsLoose(ResizeManager,_Component);function ResizeManager(player,options){var _this,RESIZE_OBSERVER_AVAILABLE=options.ResizeObserver||window$1.ResizeObserver;null===options.ResizeObserver&&(RESIZE_OBSERVER_AVAILABLE=!1);var options_=mergeOptions({createEl:!RESIZE_OBSERVER_AVAILABLE,reportTouchActivity:!1},options);return _this=_Component.call(this,player,options_)||this,_this.ResizeObserver=options.ResizeObserver||window$1.ResizeObserver,_this.loadListener_=null,_this.resizeObserver_=null,_this.debouncedHandler_=debounce(function(){_this.resizeHandler()},100,!1,_assertThisInitialized(_this)),RESIZE_OBSERVER_AVAILABLE?(_this.resizeObserver_=new _this.ResizeObserver(_this.debouncedHandler_),_this.resizeObserver_.observe(player.el())):(_this.loadListener_=function(){if(_this.el_&&_this.el_.contentWindow){var debouncedHandler_=_this.debouncedHandler_,unloadListener_=_this.unloadListener_=function(){off(this,"resize",debouncedHandler_),off(this,"unload",unloadListener_),unloadListener_=null};on(_this.el_.contentWindow,"unload",unloadListener_),on(_this.el_.contentWindow,"resize",debouncedHandler_)}},_this.one("load",_this.loadListener_)),_this}var _proto=ResizeManager.prototype;return _proto.createEl=function(){return _Component.prototype.createEl.call(this,"iframe",{className:"vjs-resize-manager",tabIndex:-1},{"aria-hidden":"true"})},_proto.resizeHandler=function(){this.player_&&this.player_.trigger&&this.player_.trigger("playerresize")},_proto.dispose=function(){this.debouncedHandler_&&this.debouncedHandler_.cancel(),this.resizeObserver_&&(this.player_.el()&&this.resizeObserver_.unobserve(this.player_.el()),this.resizeObserver_.disconnect()),this.loadListener_&&this.off("load",this.loadListener_),this.el_&&this.el_.contentWindow&&this.unloadListener_&&this.unloadListener_.call(this.el_.contentWindow),this.ResizeObserver=null,this.resizeObserver=null,this.debouncedHandler_=null,this.loadListener_=null,_Component.prototype.dispose.call(this)},ResizeManager}(Component);Component.registerComponent("ResizeManager",ResizeManager);var median=function(arr){var mid=Math.floor(arr.length/2),sortedList=[].concat(arr).sort(function(a,b){return a-b});return arr.length%2!=0?sortedList[mid]:(sortedList[mid-1]+sortedList[mid])/2},LiveTracker=function(_Component){_inheritsLoose(LiveTracker,_Component);function LiveTracker(player,options){var _this,options_=mergeOptions({createEl:!1},options);return _this=_Component.call(this,player,options_)||this,_this.reset_(),_this.on(_this.player_,"durationchange",_this.handleDurationchange),IE_VERSION&&"hidden"in document&&"visibilityState"in document&&_this.on(document,"visibilitychange",_this.handleVisibilityChange),_this}var _proto=LiveTracker.prototype;return _proto.handleVisibilityChange=function(){this.player_.duration()===1/0&&(document.hidden?this.stopTracking():this.startTracking())},_proto.isBehind_=function(){if(!this.timeupdateSeen_)return!1;var liveCurrentTime=this.liveCurrentTime(),currentTime=this.player_.currentTime(),liveEdgeWindow=2*this.seekableIncrement_+.07;return liveCurrentTime!==1/0&&liveCurrentTime-liveEdgeWindow>=currentTime},_proto.trackLive_=function(){this.pastSeekEnd_=this.pastSeekEnd_;var seekable=this.player_.seekable();if(seekable&&seekable.length){var newSeekEnd=this.seekableEnd();newSeekEnd!==this.lastSeekEnd_&&(this.lastSeekEnd_&&(this.seekableIncrementList_=this.seekableIncrementList_.slice(-11),this.seekableIncrementList_.push(Math.abs(newSeekEnd-this.lastSeekEnd_)),this.seekableIncrementList_.length>3&&(this.seekableIncrement_=median(this.seekableIncrementList_))),this.pastSeekEnd_=0,this.lastSeekEnd_=newSeekEnd,this.trigger("seekableendchange")),this.pastSeekEnd_=this.pastSeekEnd()+.03,this.isBehind_()!==this.behindLiveEdge()&&(this.behindLiveEdge_=this.isBehind_(),this.trigger("liveedgechange"))}},_proto.handleDurationchange=function(){this.player_.duration()===1/0?this.startTracking():this.stopTracking()},_proto.startTracking=function(){var _this2=this;this.isTracking()||(this.timeupdateSeen_||(this.timeupdateSeen_=this.player_.hasStarted()),this.trackingInterval_=this.setInterval(this.trackLive_,30),this.trackLive_(),this.on(this.player_,"play",this.trackLive_),this.on(this.player_,"pause",this.trackLive_),this.timeupdateSeen_||(this.one(this.player_,"play",this.handlePlay),this.handleTimeupdate=function(){_this2.timeupdateSeen_=!0,_this2.handleTimeupdate=null},this.one(this.player_,"timeupdate",this.handleTimeupdate)))},_proto.handlePlay=function(){this.one(this.player_,"timeupdate",this.seekToLiveEdge)},_proto.reset_=function(){this.pastSeekEnd_=0,this.lastSeekEnd_=null,this.behindLiveEdge_=null,this.timeupdateSeen_=!1,this.clearInterval(this.trackingInterval_),this.trackingInterval_=null,this.seekableIncrement_=12,this.seekableIncrementList_=[],this.off(this.player_,"play",this.trackLive_),this.off(this.player_,"pause",this.trackLive_),this.off(this.player_,"play",this.handlePlay),this.off(this.player_,"timeupdate",this.seekToLiveEdge),this.handleTimeupdate&&(this.off(this.player_,"timeupdate",this.handleTimeupdate),this.handleTimeupdate=null)},_proto.stopTracking=function(){this.isTracking()&&this.reset_()},_proto.seekableEnd=function(){for(var seekable=this.player_.seekable(),seekableEnds=[],i=seekable?seekable.length:0;i--;)seekableEnds.push(seekable.end(i));return seekableEnds.length?seekableEnds.sort()[seekableEnds.length-1]:1/0},_proto.seekableStart=function(){for(var seekable=this.player_.seekable(),seekableStarts=[],i=seekable?seekable.length:0;i--;)seekableStarts.push(seekable.start(i));return seekableStarts.length?seekableStarts.sort()[0]:0},_proto.liveWindow=function(){var liveCurrentTime=this.liveCurrentTime();return liveCurrentTime===1/0?1/0:liveCurrentTime-this.seekableStart()},_proto.isLive=function(){return this.isTracking()},_proto.atLiveEdge=function(){return!this.behindLiveEdge()},_proto.liveCurrentTime=function(){return this.pastSeekEnd()+this.seekableEnd()},_proto.pastSeekEnd=function(){return this.pastSeekEnd_},_proto.behindLiveEdge=function(){return this.behindLiveEdge_},_proto.isTracking=function(){return"number"==typeof this.trackingInterval_},_proto.seekToLiveEdge=function(){this.atLiveEdge()||(this.player_.currentTime(this.liveCurrentTime()),this.player_.paused()&&this.player_.play())},_proto.dispose=function(){this.stopTracking(),_Component.prototype.dispose.call(this)},LiveTracker}(Component);Component.registerComponent("LiveTracker",LiveTracker);var sourcesetLoad=function(tech){var el=tech.el();if(el.hasAttribute("src"))return tech.triggerSourceset(el.src),!0;var sources=tech.$$("source"),srcUrls=[],src="";if(!sources.length)return!1;for(var i=0;i<sources.length;i++){var url=sources[i].src;url&&-1===srcUrls.indexOf(url)&&srcUrls.push(url)}return!!srcUrls.length&&(1===srcUrls.length&&(src=srcUrls[0]),tech.triggerSourceset(src),!0)},innerHTMLDescriptorPolyfill=Object.defineProperty({},"innerHTML",{get:function(){return this.cloneNode(!0).innerHTML},set:function(v){var dummy=document.createElement(this.nodeName.toLowerCase());dummy.innerHTML=v;for(var docFrag=document.createDocumentFragment();dummy.childNodes.length;)docFrag.appendChild(dummy.childNodes[0]);return this.innerText="",window$1.Element.prototype.appendChild.call(this,docFrag),this.innerHTML}}),getDescriptor=function(priority,prop){for(var descriptor={},i=0;i<priority.length&&!((descriptor=Object.getOwnPropertyDescriptor(priority[i],prop))&&descriptor.set&&descriptor.get);i++);return descriptor.enumerable=!0,descriptor.configurable=!0,descriptor},getInnerHTMLDescriptor=function(tech){return getDescriptor([tech.el(),window$1.HTMLMediaElement.prototype,window$1.Element.prototype,innerHTMLDescriptorPolyfill],"innerHTML")},firstSourceWatch=function(tech){var el=tech.el();if(!el.resetSourceWatch_){var old={},innerDescriptor=getInnerHTMLDescriptor(tech),appendWrapper=function(appendFn){return function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];var retval=appendFn.apply(el,args);return sourcesetLoad(tech),retval}};["append","appendChild","insertAdjacentHTML"].forEach(function(k){el[k]&&(old[k]=el[k],el[k]=appendWrapper(old[k]))}),Object.defineProperty(el,"innerHTML",mergeOptions(innerDescriptor,{set:appendWrapper(innerDescriptor.set)})),el.resetSourceWatch_=function(){el.resetSourceWatch_=null,Object.keys(old).forEach(function(k){el[k]=old[k]}),Object.defineProperty(el,"innerHTML",innerDescriptor)},tech.one("sourceset",el.resetSourceWatch_)}},srcDescriptorPolyfill=Object.defineProperty({},"src",{get:function(){return this.hasAttribute("src")?getAbsoluteURL(window$1.Element.prototype.getAttribute.call(this,"src")):""},set:function(v){return window$1.Element.prototype.setAttribute.call(this,"src",v),v}}),getSrcDescriptor=function(tech){return getDescriptor([tech.el(),window$1.HTMLMediaElement.prototype,srcDescriptorPolyfill],"src")},setupSourceset=function(tech){if(tech.featuresSourceset){var el=tech.el();if(!el.resetSourceset_){var srcDescriptor=getSrcDescriptor(tech),oldSetAttribute=el.setAttribute,oldLoad=el.load;Object.defineProperty(el,"src",mergeOptions(srcDescriptor,{set:function(v){var retval=srcDescriptor.set.call(el,v);return tech.triggerSourceset(el.src),retval}})),el.setAttribute=function(n,v){var retval=oldSetAttribute.call(el,n,v);return/src/i.test(n)&&tech.triggerSourceset(el.src),retval},el.load=function(){var retval=oldLoad.call(el);return sourcesetLoad(tech)||(tech.triggerSourceset(""),firstSourceWatch(tech)),retval},el.currentSrc?tech.triggerSourceset(el.currentSrc):sourcesetLoad(tech)||firstSourceWatch(tech),el.resetSourceset_=function(){el.resetSourceset_=null,el.load=oldLoad,el.setAttribute=oldSetAttribute,Object.defineProperty(el,"src",srcDescriptor),el.resetSourceWatch_&&el.resetSourceWatch_()}}}},Html5=function(_Tech){_inheritsLoose(Html5,_Tech);function Html5(options,ready){var _this;_this=_Tech.call(this,options,ready)||this;var source=options.source,crossoriginTracks=!1;if(source&&(_this.el_.currentSrc!==source.src||options.tag&&3===options.tag.initNetworkState_)?_this.setSource(source):_this.handleLateInit_(_this.el_),options.enableSourceset&&_this.setupSourcesetHandling_(),_this.el_.hasChildNodes()){for(var nodes=_this.el_.childNodes,nodesLength=nodes.length,removeNodes=[];nodesLength--;){var node=nodes[nodesLength];"track"===node.nodeName.toLowerCase()&&(_this.featuresNativeTextTracks?(_this.remoteTextTrackEls().addTrackElement_(node),_this.remoteTextTracks().addTrack(node.track),_this.textTracks().addTrack(node.track),crossoriginTracks||_this.el_.hasAttribute("crossorigin")||!isCrossOrigin(node.src)||(crossoriginTracks=!0)):removeNodes.push(node))}for(var i=0;i<removeNodes.length;i++)_this.el_.removeChild(removeNodes[i])}return _this.proxyNativeTracks_(),_this.featuresNativeTextTracks&&crossoriginTracks&&log.warn("Text Tracks are being loaded from another origin but the crossorigin attribute isn't used.\nThis may prevent text tracks from loading."),_this.restoreMetadataTracksInIOSNativePlayer_(),(TOUCH_ENABLED||IS_IPHONE||IS_NATIVE_ANDROID)&&!0===options.nativeControlsForTouch&&_this.setControls(!0),_this.proxyWebkitFullscreen_(),_this.triggerReady(),_this}var _proto=Html5.prototype;return _proto.dispose=function(){this.el_&&this.el_.resetSourceset_&&this.el_.resetSourceset_(),Html5.disposeMediaElement(this.el_),this.options_=null,_Tech.prototype.dispose.call(this)},_proto.setupSourcesetHandling_=function(){setupSourceset(this)},_proto.restoreMetadataTracksInIOSNativePlayer_=function(){var metadataTracksPreFullscreenState,textTracks=this.textTracks(),takeMetadataTrackSnapshot=function(){metadataTracksPreFullscreenState=[];for(var i=0;i<textTracks.length;i++){var track=textTracks[i];"metadata"===track.kind&&metadataTracksPreFullscreenState.push({track:track,storedMode:track.mode})}};takeMetadataTrackSnapshot(),textTracks.addEventListener("change",takeMetadataTrackSnapshot),this.on("dispose",function(){return textTracks.removeEventListener("change",takeMetadataTrackSnapshot)});var restoreTrackMode=function restoreTrackMode(){for(var i=0;i<metadataTracksPreFullscreenState.length;i++){var storedTrack=metadataTracksPreFullscreenState[i];"disabled"===storedTrack.track.mode&&storedTrack.track.mode!==storedTrack.storedMode&&(storedTrack.track.mode=storedTrack.storedMode)}textTracks.removeEventListener("change",restoreTrackMode)};this.on("webkitbeginfullscreen",function(){textTracks.removeEventListener("change",takeMetadataTrackSnapshot),textTracks.removeEventListener("change",restoreTrackMode),textTracks.addEventListener("change",restoreTrackMode)}),this.on("webkitendfullscreen",function(){textTracks.removeEventListener("change",takeMetadataTrackSnapshot),textTracks.addEventListener("change",takeMetadataTrackSnapshot),textTracks.removeEventListener("change",restoreTrackMode)})},_proto.overrideNative_=function(type,override){var _this2=this;if(override===this["featuresNative"+type+"Tracks"]){var lowerCaseType=type.toLowerCase();this[lowerCaseType+"TracksListeners_"]&&Object.keys(this[lowerCaseType+"TracksListeners_"]).forEach(function(eventName){_this2.el()[lowerCaseType+"Tracks"].removeEventListener(eventName,_this2[lowerCaseType+"TracksListeners_"][eventName])}),this["featuresNative"+type+"Tracks"]=!override,this[lowerCaseType+"TracksListeners_"]=null,this.proxyNativeTracksForType_(lowerCaseType)}},_proto.overrideNativeAudioTracks=function(override){this.overrideNative_("Audio",override)},_proto.overrideNativeVideoTracks=function(override){this.overrideNative_("Video",override)},_proto.proxyNativeTracksForType_=function(name){var _this3=this,props=NORMAL[name],elTracks=this.el()[props.getterName],techTracks=this[props.getterName]();if(this["featuresNative"+props.capitalName+"Tracks"]&&elTracks&&elTracks.addEventListener){var listeners={change:function(e){techTracks.trigger({type:"change",target:techTracks,currentTarget:techTracks,srcElement:techTracks})},addtrack:function(e){techTracks.addTrack(e.track)},removetrack:function(e){techTracks.removeTrack(e.track)}},removeOldTracks=function(){for(var removeTracks=[],i=0;i<techTracks.length;i++){for(var found=!1,j=0;j<elTracks.length;j++)if(elTracks[j]===techTracks[i]){found=!0;break}found||removeTracks.push(techTracks[i])}for(;removeTracks.length;)techTracks.removeTrack(removeTracks.shift())};this[props.getterName+"Listeners_"]=listeners,Object.keys(listeners).forEach(function(eventName){var listener=listeners[eventName];elTracks.addEventListener(eventName,listener),_this3.on("dispose",function(e){return elTracks.removeEventListener(eventName,listener)})}),this.on("loadstart",removeOldTracks),this.on("dispose",function(e){return _this3.off("loadstart",removeOldTracks)})}},_proto.proxyNativeTracks_=function(){var _this4=this;NORMAL.names.forEach(function(name){_this4.proxyNativeTracksForType_(name)})},_proto.createEl=function(){var el=this.options_.tag;if(!el||!this.options_.playerElIngest&&!this.movingMediaElementInDOM){if(el){var clone=el.cloneNode(!0);el.parentNode&&el.parentNode.insertBefore(clone,el),Html5.disposeMediaElement(el),el=clone}else{el=document.createElement("video");var tagAttributes=this.options_.tag&&getAttributes(this.options_.tag),attributes=mergeOptions({},tagAttributes);TOUCH_ENABLED&&!0===this.options_.nativeControlsForTouch||delete attributes.controls,setAttributes(el,assign(attributes,{id:this.options_.techId,class:"vjs-tech"}))}el.playerId=this.options_.playerId}void 0!==this.options_.preload&&setAttribute(el,"preload",this.options_.preload);for(var settingsAttrs=["loop","muted","playsinline","autoplay"],i=0;i<settingsAttrs.length;i++){var attr=settingsAttrs[i],value=this.options_[attr];void 0!==value&&(value?setAttribute(el,attr,attr):removeAttribute(el,attr),el[attr]=value)}return el},_proto.handleLateInit_=function(el){if(0!==el.networkState&&3!==el.networkState){if(0===el.readyState){var loadstartFired=!1,setLoadstartFired=function(){loadstartFired=!0};this.on("loadstart",setLoadstartFired);var triggerLoadstart=function(){loadstartFired||this.trigger("loadstart")};return this.on("loadedmetadata",triggerLoadstart),void this.ready(function(){this.off("loadstart",setLoadstartFired),this.off("loadedmetadata",triggerLoadstart),loadstartFired||this.trigger("loadstart")})}var eventsToTrigger=["loadstart"];eventsToTrigger.push("loadedmetadata"),el.readyState>=2&&eventsToTrigger.push("loadeddata"),el.readyState>=3&&eventsToTrigger.push("canplay"),el.readyState>=4&&eventsToTrigger.push("canplaythrough"),this.ready(function(){eventsToTrigger.forEach(function(type){this.trigger(type)},this)})}},_proto.setCurrentTime=function(seconds){try{this.el_.currentTime=seconds}catch(e){log(e,"Video is not ready. (Video.js)")}},_proto.duration=function(){var _this5=this;if(this.el_.duration===1/0&&IS_ANDROID&&IS_CHROME&&0===this.el_.currentTime){var checkProgress=function checkProgress(){_this5.el_.currentTime>0&&(_this5.el_.duration===1/0&&_this5.trigger("durationchange"),_this5.off("timeupdate",checkProgress))};return this.on("timeupdate",checkProgress),NaN}return this.el_.duration||NaN},_proto.width=function(){return this.el_.offsetWidth},_proto.height=function(){return this.el_.offsetHeight},_proto.proxyWebkitFullscreen_=function(){var _this6=this;if("webkitDisplayingFullscreen"in this.el_){var endFn=function(){this.trigger("fullscreenchange",{isFullscreen:!1})},beginFn=function(){"webkitPresentationMode"in this.el_&&"picture-in-picture"!==this.el_.webkitPresentationMode&&(this.one("webkitendfullscreen",endFn),this.trigger("fullscreenchange",{isFullscreen:!0}))};this.on("webkitbeginfullscreen",beginFn),this.on("dispose",function(){_this6.off("webkitbeginfullscreen",beginFn),_this6.off("webkitendfullscreen",endFn)})}},_proto.supportsFullScreen=function(){if("function"==typeof this.el_.webkitEnterFullScreen){var userAgent=window$1.navigator&&window$1.navigator.userAgent||"";if(/Android/.test(userAgent)||!/Chrome|Mac OS X 10.5/.test(userAgent))return!0}return!1},_proto.enterFullScreen=function(){var video=this.el_;video.paused&&video.networkState<=video.HAVE_METADATA?(this.el_.play(),this.setTimeout(function(){video.pause(),video.webkitEnterFullScreen()},0)):video.webkitEnterFullScreen()},_proto.exitFullScreen=function(){this.el_.webkitExitFullScreen()},_proto.requestPictureInPicture=function(){return this.el_.requestPictureInPicture()},_proto.src=function(_src){if(void 0===_src)return this.el_.src;this.setSrc(_src)},_proto.reset=function(){Html5.resetMediaElement(this.el_)},_proto.currentSrc=function(){return this.currentSource_?this.currentSource_.src:this.el_.currentSrc},_proto.setControls=function(val){this.el_.controls=!!val},_proto.addTextTrack=function(kind,label,language){return this.featuresNativeTextTracks?this.el_.addTextTrack(kind,label,language):_Tech.prototype.addTextTrack.call(this,kind,label,language)},_proto.createRemoteTextTrack=function(options){if(!this.featuresNativeTextTracks)return _Tech.prototype.createRemoteTextTrack.call(this,options);var htmlTrackElement=document.createElement("track");return options.kind&&(htmlTrackElement.kind=options.kind),options.label&&(htmlTrackElement.label=options.label),(options.language||options.srclang)&&(htmlTrackElement.srclang=options.language||options.srclang),options.default&&(htmlTrackElement.default=options.default),options.id&&(htmlTrackElement.id=options.id),options.src&&(htmlTrackElement.src=options.src),htmlTrackElement},_proto.addRemoteTextTrack=function(options,manualCleanup){var htmlTrackElement=_Tech.prototype.addRemoteTextTrack.call(this,options,manualCleanup);return this.featuresNativeTextTracks&&this.el().appendChild(htmlTrackElement),htmlTrackElement},_proto.removeRemoteTextTrack=function(track){
if(_Tech.prototype.removeRemoteTextTrack.call(this,track),this.featuresNativeTextTracks)for(var tracks=this.$$("track"),i=tracks.length;i--;)track!==tracks[i]&&track!==tracks[i].track||this.el().removeChild(tracks[i])},_proto.getVideoPlaybackQuality=function(){if("function"==typeof this.el().getVideoPlaybackQuality)return this.el().getVideoPlaybackQuality();var videoPlaybackQuality={};return void 0!==this.el().webkitDroppedFrameCount&&void 0!==this.el().webkitDecodedFrameCount&&(videoPlaybackQuality.droppedVideoFrames=this.el().webkitDroppedFrameCount,videoPlaybackQuality.totalVideoFrames=this.el().webkitDecodedFrameCount),window$1.performance&&"function"==typeof window$1.performance.now?videoPlaybackQuality.creationTime=window$1.performance.now():window$1.performance&&window$1.performance.timing&&"number"==typeof window$1.performance.timing.navigationStart&&(videoPlaybackQuality.creationTime=window$1.Date.now()-window$1.performance.timing.navigationStart),videoPlaybackQuality},Html5}(Tech);if(isReal()){Html5.TEST_VID=document.createElement("video");var track=document.createElement("track");track.kind="captions",track.srclang="en",track.label="English",Html5.TEST_VID.appendChild(track)}Html5.isSupported=function(){try{Html5.TEST_VID.volume=.5}catch(e){return!1}return!(!Html5.TEST_VID||!Html5.TEST_VID.canPlayType)},Html5.canPlayType=function(type){return Html5.TEST_VID.canPlayType(type)},Html5.canPlaySource=function(srcObj,options){return Html5.canPlayType(srcObj.type)},Html5.canControlVolume=function(){try{var volume=Html5.TEST_VID.volume;return Html5.TEST_VID.volume=volume/2+.1,volume!==Html5.TEST_VID.volume}catch(e){return!1}},Html5.canMuteVolume=function(){try{var muted=Html5.TEST_VID.muted;return Html5.TEST_VID.muted=!muted,Html5.TEST_VID.muted?setAttribute(Html5.TEST_VID,"muted","muted"):removeAttribute(Html5.TEST_VID,"muted"),muted!==Html5.TEST_VID.muted}catch(e){return!1}},Html5.canControlPlaybackRate=function(){if(IS_ANDROID&&IS_CHROME&&CHROME_VERSION<58)return!1;try{var playbackRate=Html5.TEST_VID.playbackRate;return Html5.TEST_VID.playbackRate=playbackRate/2+.1,playbackRate!==Html5.TEST_VID.playbackRate}catch(e){return!1}},Html5.canOverrideAttributes=function(){try{var noop=function(){};Object.defineProperty(document.createElement("video"),"src",{get:noop,set:noop}),Object.defineProperty(document.createElement("audio"),"src",{get:noop,set:noop}),Object.defineProperty(document.createElement("video"),"innerHTML",{get:noop,set:noop}),Object.defineProperty(document.createElement("audio"),"innerHTML",{get:noop,set:noop})}catch(e){return!1}return!0},Html5.supportsNativeTextTracks=function(){return IS_ANY_SAFARI||IS_IOS&&IS_CHROME},Html5.supportsNativeVideoTracks=function(){return!(!Html5.TEST_VID||!Html5.TEST_VID.videoTracks)},Html5.supportsNativeAudioTracks=function(){return!(!Html5.TEST_VID||!Html5.TEST_VID.audioTracks)},Html5.Events=["loadstart","suspend","abort","error","emptied","stalled","loadedmetadata","loadeddata","canplay","canplaythrough","playing","waiting","seeking","seeked","ended","durationchange","timeupdate","progress","play","pause","ratechange","resize","volumechange"],Html5.prototype.featuresVolumeControl=Html5.canControlVolume(),Html5.prototype.featuresMuteControl=Html5.canMuteVolume(),Html5.prototype.featuresPlaybackRate=Html5.canControlPlaybackRate(),Html5.prototype.featuresSourceset=Html5.canOverrideAttributes(),Html5.prototype.movingMediaElementInDOM=!IS_IOS,Html5.prototype.featuresFullscreenResize=!0,Html5.prototype.featuresProgressEvents=!0,Html5.prototype.featuresTimeupdateEvents=!0,Html5.prototype.featuresNativeTextTracks=Html5.supportsNativeTextTracks(),Html5.prototype.featuresNativeVideoTracks=Html5.supportsNativeVideoTracks(),Html5.prototype.featuresNativeAudioTracks=Html5.supportsNativeAudioTracks();var canPlayType=Html5.TEST_VID&&Html5.TEST_VID.constructor.prototype.canPlayType,mpegurlRE=/^application\/(?:x-|vnd\.apple\.)mpegurl/i;Html5.patchCanPlayType=function(){ANDROID_VERSION>=4&&!IS_FIREFOX&&!IS_CHROME&&(Html5.TEST_VID.constructor.prototype.canPlayType=function(type){return type&&mpegurlRE.test(type)?"maybe":canPlayType.call(this,type)})},Html5.unpatchCanPlayType=function(){var r=Html5.TEST_VID.constructor.prototype.canPlayType;return Html5.TEST_VID.constructor.prototype.canPlayType=canPlayType,r},Html5.patchCanPlayType(),Html5.disposeMediaElement=function(el){if(el){for(el.parentNode&&el.parentNode.removeChild(el);el.hasChildNodes();)el.removeChild(el.firstChild);el.removeAttribute("src"),"function"==typeof el.load&&function(){try{el.load()}catch(e){}}()}},Html5.resetMediaElement=function(el){if(el){for(var sources=el.querySelectorAll("source"),i=sources.length;i--;)el.removeChild(sources[i]);el.removeAttribute("src"),"function"==typeof el.load&&function(){try{el.load()}catch(e){}}()}},["muted","defaultMuted","autoplay","controls","loop","playsinline"].forEach(function(prop){Html5.prototype[prop]=function(){return this.el_[prop]||this.el_.hasAttribute(prop)}}),["muted","defaultMuted","autoplay","loop","playsinline"].forEach(function(prop){Html5.prototype["set"+toTitleCase(prop)]=function(v){this.el_[prop]=v,v?this.el_.setAttribute(prop,prop):this.el_.removeAttribute(prop)}}),["paused","currentTime","buffered","volume","poster","preload","error","seeking","seekable","ended","playbackRate","defaultPlaybackRate","played","networkState","readyState","videoWidth","videoHeight"].forEach(function(prop){Html5.prototype[prop]=function(){return this.el_[prop]}}),["volume","src","poster","preload","playbackRate","defaultPlaybackRate"].forEach(function(prop){Html5.prototype["set"+toTitleCase(prop)]=function(v){this.el_[prop]=v}}),["pause","load","play"].forEach(function(prop){Html5.prototype[prop]=function(){return this.el_[prop]()}}),Tech.withSourceHandlers(Html5),Html5.nativeSourceHandler={},Html5.nativeSourceHandler.canPlayType=function(type){try{return Html5.TEST_VID.canPlayType(type)}catch(e){return""}},Html5.nativeSourceHandler.canHandleSource=function(source,options){if(source.type)return Html5.nativeSourceHandler.canPlayType(source.type);if(source.src){var ext=getFileExtension(source.src);return Html5.nativeSourceHandler.canPlayType("video/"+ext)}return""},Html5.nativeSourceHandler.handleSource=function(source,tech,options){tech.setSrc(source.src)},Html5.nativeSourceHandler.dispose=function(){},Html5.registerSourceHandler(Html5.nativeSourceHandler),Tech.registerTech("Html5",Html5);var TECH_EVENTS_RETRIGGER=["progress","abort","suspend","emptied","stalled","loadedmetadata","loadeddata","timeupdate","resize","volumechange","texttrackchange"],TECH_EVENTS_QUEUE={canplay:"CanPlay",canplaythrough:"CanPlayThrough",playing:"Playing",seeked:"Seeked"},BREAKPOINT_ORDER=["tiny","xsmall","small","medium","large","xlarge","huge"],BREAKPOINT_CLASSES={};BREAKPOINT_ORDER.forEach(function(k){var v="x"===k.charAt(0)?"x-"+k.substring(1):k;BREAKPOINT_CLASSES[k]="vjs-layout-"+v});var DEFAULT_BREAKPOINTS={tiny:210,xsmall:320,small:425,medium:768,large:1440,xlarge:2560,huge:1/0},Player=function(_Component){_inheritsLoose(Player,_Component);function Player(tag,options,ready){var _this;if(tag.id=tag.id||options.id||"vjs_video_"+newGUID(),options=assign(Player.getTagSettings(tag),options),options.initChildren=!1,options.createEl=!1,options.evented=!1,options.reportTouchActivity=!1,!options.language)if("function"==typeof tag.closest){var closest=tag.closest("[lang]");closest&&closest.getAttribute&&(options.language=closest.getAttribute("lang"))}else for(var element=tag;element&&1===element.nodeType;){if(getAttributes(element).hasOwnProperty("lang")){options.language=element.getAttribute("lang");break}element=element.parentNode}if(_this=_Component.call(this,null,options,ready)||this,_this.boundDocumentFullscreenChange_=bind(_assertThisInitialized(_this),_this.documentFullscreenChange_),_this.boundFullWindowOnEscKey_=bind(_assertThisInitialized(_this),_this.fullWindowOnEscKey),_this.log=createLogger$1(_this.id_),_this.fsApi_=FullscreenApi,_this.isPosterFromTech_=!1,_this.queuedCallbacks_=[],_this.isReady_=!1,_this.hasStarted_=!1,_this.userActive_=!1,!_this.options_||!_this.options_.techOrder||!_this.options_.techOrder.length)throw new Error("No techOrder specified. Did you overwrite videojs.options instead of just changing the properties you want to override?");if(_this.tag=tag,_this.tagAttributes=tag&&getAttributes(tag),_this.language(_this.options_.language),options.languages){var languagesToLower={};Object.getOwnPropertyNames(options.languages).forEach(function(name){languagesToLower[name.toLowerCase()]=options.languages[name]}),_this.languages_=languagesToLower}else _this.languages_=Player.prototype.options_.languages;_this.resetCache_(),_this.poster_=options.poster||"",_this.controls_=!!options.controls,tag.controls=!1,tag.removeAttribute("controls"),_this.changingSrc_=!1,_this.playCallbacks_=[],_this.playTerminatedQueue_=[],tag.hasAttribute("autoplay")?_this.autoplay(!0):_this.autoplay(_this.options_.autoplay),options.plugins&&Object.keys(options.plugins).forEach(function(name){if("function"!=typeof _this[name])throw new Error('plugin "'+name+'" does not exist')}),_this.scrubbing_=!1,_this.el_=_this.createEl(),evented(_assertThisInitialized(_this),{eventBusKey:"el_"}),_this.fluid_&&_this.on("playerreset",_this.updateStyleEl_);var playerOptionsCopy=mergeOptions(_this.options_);options.plugins&&Object.keys(options.plugins).forEach(function(name){_this[name](options.plugins[name])}),_this.options_.playerOptions=playerOptionsCopy,_this.middleware_=[],_this.initChildren(),_this.isAudio("audio"===tag.nodeName.toLowerCase()),_this.controls()?_this.addClass("vjs-controls-enabled"):_this.addClass("vjs-controls-disabled"),_this.el_.setAttribute("role","region"),_this.isAudio()?_this.el_.setAttribute("aria-label",_this.localize("Audio Player")):_this.el_.setAttribute("aria-label",_this.localize("Video Player")),_this.isAudio()&&_this.addClass("vjs-audio"),_this.flexNotSupported_()&&_this.addClass("vjs-no-flex"),TOUCH_ENABLED&&_this.addClass("vjs-touch-enabled"),IS_IOS||_this.addClass("vjs-workinghover"),Player.players[_this.id_]=_assertThisInitialized(_this);var majorVersion=version.split(".")[0];return _this.addClass("vjs-v"+majorVersion),_this.userActive(!0),_this.reportUserActivity(),_this.one("play",_this.listenForUserActivity_),_this.on("stageclick",_this.handleStageClick_),_this.on("keydown",_this.handleKeyDown),_this.breakpoints(_this.options_.breakpoints),_this.responsive(_this.options_.responsive),_this}var _proto=Player.prototype;return _proto.dispose=function(){var _this2=this;this.trigger("dispose"),this.off("dispose"),off(document,this.fsApi_.fullscreenchange,this.boundDocumentFullscreenChange_),off(document,"keydown",this.boundFullWindowOnEscKey_),this.styleEl_&&this.styleEl_.parentNode&&(this.styleEl_.parentNode.removeChild(this.styleEl_),this.styleEl_=null),Player.players[this.id_]=null,this.tag&&this.tag.player&&(this.tag.player=null),this.el_&&this.el_.player&&(this.el_.player=null),this.tech_&&(this.tech_.dispose(),this.isPosterFromTech_=!1,this.poster_=""),this.playerElIngest_&&(this.playerElIngest_=null),this.tag&&(this.tag=null),clearCacheForPlayer(this),ALL.names.forEach(function(name){var props=ALL[name],list=_this2[props.getterName]();list&&list.off&&list.off()}),_Component.prototype.dispose.call(this)},_proto.createEl=function(){var el,tag=this.tag,playerElIngest=this.playerElIngest_=tag.parentNode&&tag.parentNode.hasAttribute&&tag.parentNode.hasAttribute("data-vjs-player"),divEmbed="video-js"===this.tag.tagName.toLowerCase();playerElIngest?el=this.el_=tag.parentNode:divEmbed||(el=this.el_=_Component.prototype.createEl.call(this,"div"));var attrs=getAttributes(tag);if(divEmbed){for(el=this.el_=tag,tag=this.tag=document.createElement("video");el.children.length;)tag.appendChild(el.firstChild);hasClass(el,"video-js")||addClass(el,"video-js"),el.appendChild(tag),playerElIngest=this.playerElIngest_=el,Object.keys(el).forEach(function(k){try{tag[k]=el[k]}catch(e){}})}if(tag.setAttribute("tabindex","-1"),attrs.tabindex="-1",(IE_VERSION||IS_CHROME&&IS_WINDOWS)&&(tag.setAttribute("role","application"),attrs.role="application"),tag.removeAttribute("width"),tag.removeAttribute("height"),"width"in attrs&&delete attrs.width,"height"in attrs&&delete attrs.height,Object.getOwnPropertyNames(attrs).forEach(function(attr){divEmbed&&"class"===attr||el.setAttribute(attr,attrs[attr]),divEmbed&&tag.setAttribute(attr,attrs[attr])}),tag.playerId=tag.id,tag.id+="_html5_api",tag.className="vjs-tech",tag.player=el.player=this,this.addClass("vjs-paused"),!0!==window$1.VIDEOJS_NO_DYNAMIC_STYLE){this.styleEl_=createStyleElement("vjs-styles-dimensions");var defaultsStyleEl=$(".vjs-styles-defaults"),head=$("head");head.insertBefore(this.styleEl_,defaultsStyleEl?defaultsStyleEl.nextSibling:head.firstChild)}this.fill_=!1,this.fluid_=!1,this.width(this.options_.width),this.height(this.options_.height),this.fill(this.options_.fill),this.fluid(this.options_.fluid),this.aspectRatio(this.options_.aspectRatio);for(var links=tag.getElementsByTagName("a"),i=0;i<links.length;i++){var linkEl=links.item(i);addClass(linkEl,"vjs-hidden"),linkEl.setAttribute("hidden","hidden")}return tag.initNetworkState_=tag.networkState,tag.parentNode&&!playerElIngest&&tag.parentNode.insertBefore(el,tag),prependTo(tag,el),this.children_.unshift(tag),this.el_.setAttribute("lang",this.language_),this.el_=el,el},_proto.width=function(value){return this.dimension("width",value)},_proto.height=function(value){return this.dimension("height",value)},_proto.dimension=function(_dimension,value){var privDimension=_dimension+"_";if(void 0===value)return this[privDimension]||0;if(""===value)return this[privDimension]=void 0,void this.updateStyleEl_();var parsedVal=parseFloat(value);if(isNaN(parsedVal))return void log.error('Improper value "'+value+'" supplied for for '+_dimension);this[privDimension]=parsedVal,this.updateStyleEl_()},_proto.fluid=function(bool){if(void 0===bool)return!!this.fluid_;this.fluid_=!!bool,isEvented(this)&&this.off("playerreset",this.updateStyleEl_),bool?(this.addClass("vjs-fluid"),this.fill(!1),addEventedCallback(function(){this.on("playerreset",this.updateStyleEl_)})):this.removeClass("vjs-fluid"),this.updateStyleEl_()},_proto.fill=function(bool){if(void 0===bool)return!!this.fill_;this.fill_=!!bool,bool?(this.addClass("vjs-fill"),this.fluid(!1)):this.removeClass("vjs-fill")},_proto.aspectRatio=function(ratio){if(void 0===ratio)return this.aspectRatio_;if(!/^\d+\:\d+$/.test(ratio))throw new Error("Improper value supplied for aspect ratio. The format should be width:height, for example 16:9.");this.aspectRatio_=ratio,this.fluid(!0),this.updateStyleEl_()},_proto.updateStyleEl_=function(){if(!0===window$1.VIDEOJS_NO_DYNAMIC_STYLE){var _width="number"==typeof this.width_?this.width_:this.options_.width,_height="number"==typeof this.height_?this.height_:this.options_.height,techEl=this.tech_&&this.tech_.el();return void(techEl&&(_width>=0&&(techEl.width=_width),_height>=0&&(techEl.height=_height)))}var width,height,aspectRatio,idClass;aspectRatio=void 0!==this.aspectRatio_&&"auto"!==this.aspectRatio_?this.aspectRatio_:this.videoWidth()>0?this.videoWidth()+":"+this.videoHeight():"16:9";var ratioParts=aspectRatio.split(":"),ratioMultiplier=ratioParts[1]/ratioParts[0];width=void 0!==this.width_?this.width_:void 0!==this.height_?this.height_/ratioMultiplier:this.videoWidth()||300,height=void 0!==this.height_?this.height_:width*ratioMultiplier,idClass=/^[^a-zA-Z]/.test(this.id())?"dimensions-"+this.id():this.id()+"-dimensions",this.addClass(idClass),setTextContent(this.styleEl_,"\n      ."+idClass+" {\n        width: "+width+"px;\n        height: "+height+"px;\n      }\n\n      ."+idClass+".vjs-fluid {\n        padding-top: "+100*ratioMultiplier+"%;\n      }\n    ")},_proto.loadTech_=function(techName,source){var _this3=this;this.tech_&&this.unloadTech_();var titleTechName=toTitleCase(techName),camelTechName=techName.charAt(0).toLowerCase()+techName.slice(1);"Html5"!==titleTechName&&this.tag&&(Tech.getTech("Html5").disposeMediaElement(this.tag),this.tag.player=null,this.tag=null),this.techName_=titleTechName,this.isReady_=!1;var autoplay="string"!=typeof this.autoplay()&&this.autoplay(),techOptions={source:source,autoplay:autoplay,nativeControlsForTouch:this.options_.nativeControlsForTouch,playerId:this.id(),techId:this.id()+"_"+camelTechName+"_api",playsinline:this.options_.playsinline,preload:this.options_.preload,loop:this.options_.loop,muted:this.options_.muted,poster:this.poster(),language:this.language(),playerElIngest:this.playerElIngest_||!1,"vtt.js":this.options_["vtt.js"],canOverridePoster:!!this.options_.techCanOverridePoster,enableSourceset:this.options_.enableSourceset,Promise:this.options_.Promise};ALL.names.forEach(function(name){var props=ALL[name];techOptions[props.getterName]=_this3[props.privateName]}),assign(techOptions,this.options_[titleTechName]),assign(techOptions,this.options_[camelTechName]),assign(techOptions,this.options_[techName.toLowerCase()]),this.tag&&(techOptions.tag=this.tag),source&&source.src===this.cache_.src&&this.cache_.currentTime>0&&(techOptions.startTime=this.cache_.currentTime);var TechClass=Tech.getTech(techName);if(!TechClass)throw new Error("No Tech named '"+titleTechName+"' exists! '"+titleTechName+"' should be registered using videojs.registerTech()'");this.tech_=new TechClass(techOptions),this.tech_.ready(bind(this,this.handleTechReady_),!0),textTrackConverter.jsonToTextTracks(this.textTracksJson_||[],this.tech_),TECH_EVENTS_RETRIGGER.forEach(function(event){_this3.on(_this3.tech_,event,_this3["handleTech"+toTitleCase(event)+"_"])}),Object.keys(TECH_EVENTS_QUEUE).forEach(function(event){_this3.on(_this3.tech_,event,function(eventObj){if(0===_this3.tech_.playbackRate()&&_this3.tech_.seeking())return void _this3.queuedCallbacks_.push({callback:_this3["handleTech"+TECH_EVENTS_QUEUE[event]+"_"].bind(_this3),event:eventObj});_this3["handleTech"+TECH_EVENTS_QUEUE[event]+"_"](eventObj)})}),this.on(this.tech_,"loadstart",this.handleTechLoadStart_),this.on(this.tech_,"sourceset",this.handleTechSourceset_),this.on(this.tech_,"waiting",this.handleTechWaiting_),this.on(this.tech_,"ended",this.handleTechEnded_),this.on(this.tech_,"seeking",this.handleTechSeeking_),this.on(this.tech_,"play",this.handleTechPlay_),this.on(this.tech_,"firstplay",this.handleTechFirstPlay_),this.on(this.tech_,"pause",this.handleTechPause_),this.on(this.tech_,"durationchange",this.handleTechDurationChange_),this.on(this.tech_,"fullscreenchange",this.handleTechFullscreenChange_),this.on(this.tech_,"enterpictureinpicture",this.handleTechEnterPictureInPicture_),this.on(this.tech_,"leavepictureinpicture",this.handleTechLeavePictureInPicture_),this.on(this.tech_,"error",this.handleTechError_),this.on(this.tech_,"loadedmetadata",this.updateStyleEl_),this.on(this.tech_,"posterchange",this.handleTechPosterChange_),this.on(this.tech_,"textdata",this.handleTechTextData_),this.on(this.tech_,"ratechange",this.handleTechRateChange_),this.usingNativeControls(this.techGet_("controls")),this.controls()&&!this.usingNativeControls()&&this.addTechControlsListeners_(),this.tech_.el().parentNode===this.el()||"Html5"===titleTechName&&this.tag||prependTo(this.tech_.el(),this.el()),this.tag&&(this.tag.player=null,this.tag=null)},_proto.unloadTech_=function(){var _this4=this;ALL.names.forEach(function(name){var props=ALL[name];_this4[props.privateName]=_this4[props.getterName]()}),this.textTracksJson_=textTrackConverter.textTracksToJson(this.tech_),this.isReady_=!1,this.tech_.dispose(),this.tech_=!1,this.isPosterFromTech_&&(this.poster_="",this.trigger("posterchange")),this.isPosterFromTech_=!1},_proto.tech=function(safety){return void 0===safety&&log.warn("Using the tech directly can be dangerous. I hope you know what you're doing.\nSee https://github.com/videojs/video.js/issues/2617 for more info.\n"),this.tech_},_proto.addTechControlsListeners_=function(){this.removeTechControlsListeners_(),this.on(this.tech_,"mouseup",this.handleTechClick_),this.on(this.tech_,"dblclick",this.handleTechDoubleClick_),this.on(this.tech_,"touchstart",this.handleTechTouchStart_),this.on(this.tech_,"touchmove",this.handleTechTouchMove_),this.on(this.tech_,"touchend",this.handleTechTouchEnd_),this.on(this.tech_,"tap",this.handleTechTap_)},_proto.removeTechControlsListeners_=function(){this.off(this.tech_,"tap",this.handleTechTap_),this.off(this.tech_,"touchstart",this.handleTechTouchStart_),this.off(this.tech_,"touchmove",this.handleTechTouchMove_),this.off(this.tech_,"touchend",this.handleTechTouchEnd_),this.off(this.tech_,"mouseup",this.handleTechClick_),this.off(this.tech_,"dblclick",this.handleTechDoubleClick_)},_proto.handleTechReady_=function(){this.triggerReady(),this.cache_.volume&&this.techCall_("setVolume",this.cache_.volume),this.handleTechPosterChange_(),this.handleTechDurationChange_()},_proto.handleTechLoadStart_=function(){this.removeClass("vjs-ended"),this.removeClass("vjs-seeking"),this.error(null),this.handleTechDurationChange_(),this.paused()?(this.hasStarted(!1),this.trigger("loadstart")):(this.trigger("loadstart"),this.trigger("firstplay")),this.manualAutoplay_(this.autoplay())},_proto.manualAutoplay_=function(type){var _this5=this;if(this.tech_&&"string"==typeof type){var promise,muted=function(){var previouslyMuted=_this5.muted();_this5.muted(!0);var restoreMuted=function(){_this5.muted(previouslyMuted)};_this5.playTerminatedQueue_.push(restoreMuted);var mutedPromise=_this5.play();if(isPromise(mutedPromise))return mutedPromise.catch(restoreMuted)};if("any"===type&&!0!==this.muted()?(promise=this.play(),isPromise(promise)&&(promise=promise.catch(muted))):promise="muted"===type&&!0!==this.muted()?muted():this.play(),isPromise(promise))return promise.then(function(){_this5.trigger({type:"autoplay-success",autoplay:type})}).catch(function(e){_this5.trigger({type:"autoplay-failure",autoplay:type})})}},_proto.updateSourceCaches_=function(srcObj){void 0===srcObj&&(srcObj="");var src=srcObj,type="";"string"!=typeof src&&(src=srcObj.src,type=srcObj.type),this.cache_.source=this.cache_.source||{},this.cache_.sources=this.cache_.sources||[],src&&!type&&(type=findMimetype(this,src)),this.cache_.source=mergeOptions({},srcObj,{src:src,type:type});for(var matchingSources=this.cache_.sources.filter(function(s){return s.src&&s.src===src}),sourceElSources=[],sourceEls=this.$$("source"),matchingSourceEls=[],i=0;i<sourceEls.length;i++){var sourceObj=getAttributes(sourceEls[i]);sourceElSources.push(sourceObj),sourceObj.src&&sourceObj.src===src&&matchingSourceEls.push(sourceObj.src)}matchingSourceEls.length&&!matchingSources.length?this.cache_.sources=sourceElSources:matchingSources.length||(this.cache_.sources=[this.cache_.source]),this.cache_.src=src},_proto.handleTechSourceset_=function(event){var _this6=this;if(!this.changingSrc_){var updateSourceCaches=function(src){return _this6.updateSourceCaches_(src)},playerSrc=this.currentSource().src,eventSrc=event.src;playerSrc&&!/^blob:/.test(playerSrc)&&/^blob:/.test(eventSrc)&&(!this.lastSource_||this.lastSource_.tech!==eventSrc&&this.lastSource_.player!==playerSrc)&&(updateSourceCaches=function(){}),updateSourceCaches(eventSrc),event.src||this.tech_.any(["sourceset","loadstart"],function(e){if("sourceset"!==e.type){var techSrc=_this6.techGet("currentSrc");_this6.lastSource_.tech=techSrc,_this6.updateSourceCaches_(techSrc)}})}this.lastSource_={player:this.currentSource().src,tech:event.src},this.trigger({src:event.src,type:"sourceset"})},_proto.hasStarted=function(request){if(void 0===request)return this.hasStarted_;request!==this.hasStarted_&&(this.hasStarted_=request,this.hasStarted_?(this.addClass("vjs-has-started"),this.trigger("firstplay")):this.removeClass("vjs-has-started"))},_proto.handleTechPlay_=function(){this.removeClass("vjs-ended"),this.removeClass("vjs-paused"),this.addClass("vjs-playing"),this.hasStarted(!0),this.trigger("play")},_proto.handleTechRateChange_=function(){this.tech_.playbackRate()>0&&0===this.cache_.lastPlaybackRate&&(this.queuedCallbacks_.forEach(function(queued){return queued.callback(queued.event)}),this.queuedCallbacks_=[]),this.cache_.lastPlaybackRate=this.tech_.playbackRate(),this.trigger("ratechange")},_proto.handleTechWaiting_=function(){var _this7=this;this.addClass("vjs-waiting"),this.trigger("waiting");var timeWhenWaiting=this.currentTime(),timeUpdateListener=function timeUpdateListener(){timeWhenWaiting!==_this7.currentTime()&&(_this7.removeClass("vjs-waiting"),_this7.off("timeupdate",timeUpdateListener))};this.on("timeupdate",timeUpdateListener)},_proto.handleTechCanPlay_=function(){this.removeClass("vjs-waiting"),this.trigger("canplay")},_proto.handleTechCanPlayThrough_=function(){this.removeClass("vjs-waiting"),this.trigger("canplaythrough")},_proto.handleTechPlaying_=function(){this.removeClass("vjs-waiting"),this.trigger("playing")},_proto.handleTechSeeking_=function(){this.addClass("vjs-seeking"),this.trigger("seeking")},_proto.handleTechSeeked_=function(){this.removeClass("vjs-seeking"),this.removeClass("vjs-ended"),this.trigger("seeked")},_proto.handleTechFirstPlay_=function(){this.options_.starttime&&(log.warn("Passing the `starttime` option to the player will be deprecated in 6.0"),this.currentTime(this.options_.starttime)),this.addClass("vjs-has-started"),this.trigger("firstplay")},_proto.handleTechPause_=function(){this.removeClass("vjs-playing"),this.addClass("vjs-paused"),this.trigger("pause")},_proto.handleTechEnded_=function(){this.addClass("vjs-ended"),this.options_.loop?(this.currentTime(0),this.play()):this.paused()||this.pause(),this.trigger("ended")},_proto.handleTechDurationChange_=function(){this.duration(this.techGet_("duration"))},_proto.handleTechClick_=function(event){isSingleLeftClick(event)&&this.controls_&&(this.paused()?silencePromise(this.play()):this.pause())},_proto.handleTechDoubleClick_=function(event){if(this.controls_){Array.prototype.some.call(this.$$(".vjs-control-bar, .vjs-modal-dialog"),function(el){return el.contains(event.target)})||void 0!==this.options_&&void 0!==this.options_.userActions&&void 0!==this.options_.userActions.doubleClick&&!1===this.options_.userActions.doubleClick||(void 0!==this.options_&&void 0!==this.options_.userActions&&"function"==typeof this.options_.userActions.doubleClick?this.options_.userActions.doubleClick.call(this,event):this.isFullscreen()?this.exitFullscreen():this.requestFullscreen())}},_proto.handleTechTap_=function(){this.userActive(!this.userActive())},_proto.handleTechTouchStart_=function(){this.userWasActive=this.userActive()},_proto.handleTechTouchMove_=function(){this.userWasActive&&this.reportUserActivity()},_proto.handleTechTouchEnd_=function(event){event.preventDefault()},_proto.handleStageClick_=function(){this.reportUserActivity()},_proto.toggleFullscreenClass_=function(){this.isFullscreen()?this.addClass("vjs-fullscreen"):this.removeClass("vjs-fullscreen")},_proto.documentFullscreenChange_=function(e){var el=this.el(),isFs=document[this.fsApi_.fullscreenElement]===el;!isFs&&el.matches?isFs=el.matches(":"+this.fsApi_.fullscreen):!isFs&&el.msMatchesSelector&&(isFs=el.msMatchesSelector(":"+this.fsApi_.fullscreen)),this.isFullscreen(isFs),!1===this.isFullscreen()&&off(document,this.fsApi_.fullscreenchange,this.boundDocumentFullscreenChange_),this.fsApi_.prefixed&&this.trigger("fullscreenchange")},_proto.handleTechFullscreenChange_=function(event,data){data&&this.isFullscreen(data.isFullscreen),this.trigger("fullscreenchange")},_proto.togglePictureInPictureClass_=function(){this.isInPictureInPicture()?this.addClass("vjs-picture-in-picture"):this.removeClass("vjs-picture-in-picture")},_proto.handleTechEnterPictureInPicture_=function(event){this.isInPictureInPicture(!0)},_proto.handleTechLeavePictureInPicture_=function(event){this.isInPictureInPicture(!1)},_proto.handleTechError_=function(){var error=this.tech_.error();this.error(error)},_proto.handleTechTextData_=function(){var data=null;arguments.length>1&&(data=arguments[1]),this.trigger("textdata",data)},_proto.getCache=function(){return this.cache_},_proto.resetCache_=function(){this.cache_={currentTime:0,inactivityTimeout:this.options_.inactivityTimeout,duration:NaN,lastVolume:1,lastPlaybackRate:this.defaultPlaybackRate(),media:null,src:"",source:{},sources:[],volume:1}},_proto.techCall_=function(method,arg){this.ready(function(){if(method in allowedSetters)return set(this.middleware_,this.tech_,method,arg);if(method in allowedMediators)return mediate(this.middleware_,this.tech_,method,arg);try{this.tech_&&this.tech_[method](arg)}catch(e){throw log(e),e}},!0)},_proto.techGet_=function(method){if(this.tech_&&this.tech_.isReady_){if(method in allowedGetters)return get(this.middleware_,this.tech_,method);if(method in allowedMediators)return mediate(this.middleware_,this.tech_,method);try{return this.tech_[method]()}catch(e){if(void 0===this.tech_[method])throw log("Video.js: "+method+" method not defined for "+this.techName_+" playback technology.",e),e;if("TypeError"===e.name)throw log("Video.js: "+method+" unavailable on "+this.techName_+" playback technology element.",e),this.tech_.isReady_=!1,e;throw log(e),e}}},_proto.play=function(){var _this8=this,PromiseClass=this.options_.Promise||window$1.Promise;return PromiseClass?new PromiseClass(function(resolve){_this8.play_(resolve)}):this.play_()},_proto.play_=function(callback){var _this9=this;void 0===callback&&(callback=silencePromise),this.playCallbacks_.push(callback);var isSrcReady=Boolean(!this.changingSrc_&&(this.src()||this.currentSrc()));if(this.waitToPlay_&&(this.off(["ready","loadstart"],this.waitToPlay_),this.waitToPlay_=null),!this.isReady_||!isSrcReady)return this.waitToPlay_=function(e){_this9.play_()},this.one(["ready","loadstart"],this.waitToPlay_),void(isSrcReady||!IS_ANY_SAFARI&&!IS_IOS||this.load());var val=this.techGet_("play");null===val?this.runPlayTerminatedQueue_():this.runPlayCallbacks_(val)},_proto.runPlayTerminatedQueue_=function(){var queue=this.playTerminatedQueue_.slice(0);this.playTerminatedQueue_=[],queue.forEach(function(q){q()})},_proto.runPlayCallbacks_=function(val){var callbacks=this.playCallbacks_.slice(0);this.playCallbacks_=[],this.playTerminatedQueue_=[],callbacks.forEach(function(cb){cb(val)})},_proto.pause=function(){this.techCall_("pause")},_proto.paused=function(){return!1!==this.techGet_("paused")},_proto.played=function(){return this.techGet_("played")||createTimeRanges(0,0)},_proto.scrubbing=function(isScrubbing){if(void 0===isScrubbing)return this.scrubbing_;this.scrubbing_=!!isScrubbing,isScrubbing?this.addClass("vjs-scrubbing"):this.removeClass("vjs-scrubbing")},_proto.currentTime=function(seconds){return void 0!==seconds?(seconds<0&&(seconds=0),void this.techCall_("setCurrentTime",seconds)):(this.cache_.currentTime=this.techGet_("currentTime")||0,this.cache_.currentTime)},_proto.duration=function(seconds){if(void 0===seconds)return void 0!==this.cache_.duration?this.cache_.duration:NaN;seconds=parseFloat(seconds),seconds<0&&(seconds=1/0),seconds!==this.cache_.duration&&(this.cache_.duration=seconds,seconds===1/0?(this.addClass("vjs-live"),this.options_.liveui&&this.player_.liveTracker&&this.addClass("vjs-liveui")):(this.removeClass("vjs-live"),this.removeClass("vjs-liveui")),isNaN(seconds)||this.trigger("durationchange"))},_proto.remainingTime=function(){return this.duration()-this.currentTime()},_proto.remainingTimeDisplay=function(){return Math.floor(this.duration())-Math.floor(this.currentTime())},_proto.buffered=function(){var buffered=this.techGet_("buffered");return buffered&&buffered.length||(buffered=createTimeRanges(0,0)),buffered},_proto.bufferedPercent=function(){return bufferedPercent(this.buffered(),this.duration())},_proto.bufferedEnd=function(){var buffered=this.buffered(),duration=this.duration(),end=buffered.end(buffered.length-1);return end>duration&&(end=duration),end},
_proto.volume=function(percentAsDecimal){var vol;return void 0!==percentAsDecimal?(vol=Math.max(0,Math.min(1,parseFloat(percentAsDecimal))),this.cache_.volume=vol,this.techCall_("setVolume",vol),void(vol>0&&this.lastVolume_(vol))):(vol=parseFloat(this.techGet_("volume")),isNaN(vol)?1:vol)},_proto.muted=function(_muted){return void 0!==_muted?void this.techCall_("setMuted",_muted):this.techGet_("muted")||!1},_proto.defaultMuted=function(_defaultMuted){return void 0!==_defaultMuted?this.techCall_("setDefaultMuted",_defaultMuted):this.techGet_("defaultMuted")||!1},_proto.lastVolume_=function(percentAsDecimal){return void 0!==percentAsDecimal&&0!==percentAsDecimal?void(this.cache_.lastVolume=percentAsDecimal):this.cache_.lastVolume},_proto.supportsFullScreen=function(){return this.techGet_("supportsFullScreen")||!1},_proto.isFullscreen=function(isFS){return void 0!==isFS?(this.isFullscreen_=!!isFS,void this.toggleFullscreenClass_()):!!this.isFullscreen_},_proto.requestFullscreen=function(fullscreenOptions){var fsOptions;this.isFullscreen(!0),this.fsApi_.requestFullscreen?(on(document,this.fsApi_.fullscreenchange,this.boundDocumentFullscreenChange_),this.fsApi_.prefixed||(fsOptions=this.options_.fullscreen&&this.options_.fullscreen.options||{},void 0!==fullscreenOptions&&(fsOptions=fullscreenOptions)),silencePromise(this.el_[this.fsApi_.requestFullscreen](fsOptions))):this.tech_.supportsFullScreen()?this.techCall_("enterFullScreen"):(this.enterFullWindow(),this.trigger("fullscreenchange"))},_proto.exitFullscreen=function(){this.isFullscreen(!1),this.fsApi_.requestFullscreen?silencePromise(document[this.fsApi_.exitFullscreen]()):this.tech_.supportsFullScreen()?this.techCall_("exitFullScreen"):(this.exitFullWindow(),this.trigger("fullscreenchange"))},_proto.enterFullWindow=function(){this.isFullWindow=!0,this.docOrigOverflow=document.documentElement.style.overflow,on(document,"keydown",this.boundFullWindowOnEscKey_),document.documentElement.style.overflow="hidden",addClass(document.body,"vjs-full-window"),this.trigger("enterFullWindow")},_proto.fullWindowOnEscKey=function(event){keycode.isEventKey(event,"Esc")&&(!0===this.isFullscreen()?this.exitFullscreen():this.exitFullWindow())},_proto.exitFullWindow=function(){this.isFullWindow=!1,off(document,"keydown",this.boundFullWindowOnEscKey_),document.documentElement.style.overflow=this.docOrigOverflow,removeClass(document.body,"vjs-full-window"),this.trigger("exitFullWindow")},_proto.isInPictureInPicture=function(isPiP){return void 0!==isPiP?(this.isInPictureInPicture_=!!isPiP,void this.togglePictureInPictureClass_()):!!this.isInPictureInPicture_},_proto.requestPictureInPicture=function(){if("pictureInPictureEnabled"in document)return this.techGet_("requestPictureInPicture")},_proto.exitPictureInPicture=function(){if("pictureInPictureEnabled"in document)return document.exitPictureInPicture()},_proto.handleKeyDown=function(event){var userActions=this.options_.userActions;if(userActions&&userActions.hotkeys){(function(el){var tagName=el.tagName.toLowerCase();if(el.isContentEditable)return!0;var allowedInputTypes=["button","checkbox","hidden","radio","reset","submit"];return"input"===tagName?-1===allowedInputTypes.indexOf(el.type):-1!==["textarea"].indexOf(tagName)})(this.el_.ownerDocument.activeElement)||("function"==typeof userActions.hotkeys?userActions.hotkeys.call(this,event):this.handleHotkeys(event))}},_proto.handleHotkeys=function(event){var hotkeys=this.options_.userActions?this.options_.userActions.hotkeys:{},_hotkeys$fullscreenKe=hotkeys.fullscreenKey,fullscreenKey=void 0===_hotkeys$fullscreenKe?function(keydownEvent){return keycode.isEventKey(keydownEvent,"f")}:_hotkeys$fullscreenKe,_hotkeys$muteKey=hotkeys.muteKey,muteKey=void 0===_hotkeys$muteKey?function(keydownEvent){return keycode.isEventKey(keydownEvent,"m")}:_hotkeys$muteKey,_hotkeys$playPauseKey=hotkeys.playPauseKey,playPauseKey=void 0===_hotkeys$playPauseKey?function(keydownEvent){return keycode.isEventKey(keydownEvent,"k")||keycode.isEventKey(keydownEvent,"Space")}:_hotkeys$playPauseKey;if(fullscreenKey.call(this,event)){event.preventDefault(),event.stopPropagation();var FSToggle=Component.getComponent("FullscreenToggle");!1!==document[this.fsApi_.fullscreenEnabled]&&FSToggle.prototype.handleClick.call(this,event)}else if(muteKey.call(this,event)){event.preventDefault(),event.stopPropagation();var MuteToggle=Component.getComponent("MuteToggle");MuteToggle.prototype.handleClick.call(this,event)}else if(playPauseKey.call(this,event)){event.preventDefault(),event.stopPropagation();var PlayToggle=Component.getComponent("PlayToggle");PlayToggle.prototype.handleClick.call(this,event)}},_proto.canPlayType=function(type){for(var can,i=0,j=this.options_.techOrder;i<j.length;i++){var techName=j[i],tech=Tech.getTech(techName);if(tech||(tech=Component.getComponent(techName)),tech){if(tech.isSupported()&&(can=tech.canPlayType(type)))return can}else log.error('The "'+techName+'" tech is undefined. Skipped browser support check for that tech.')}return""},_proto.selectSource=function(sources){var _this10=this,techs=this.options_.techOrder.map(function(techName){return[techName,Tech.getTech(techName)]}).filter(function(_ref){var techName=_ref[0],tech=_ref[1];return tech?tech.isSupported():(log.error('The "'+techName+'" tech is undefined. Skipped browser support check for that tech.'),!1)}),findFirstPassingTechSourcePair=function(outerArray,innerArray,tester){var found;return outerArray.some(function(outerChoice){return innerArray.some(function(innerChoice){if(found=tester(outerChoice,innerChoice))return!0})}),found},finder=function(_ref2,source){var techName=_ref2[0];if(_ref2[1].canPlaySource(source,_this10.options_[techName.toLowerCase()]))return{source:source,tech:techName}};return(this.options_.sourceOrder?findFirstPassingTechSourcePair(sources,techs,function(fn){return function(a,b){return fn(b,a)}}(finder)):findFirstPassingTechSourcePair(techs,sources,finder))||!1},_proto.src=function(source){var _this11=this;if(void 0===source)return this.cache_.src||"";var sources=filterSource(source);if(!sources.length)return void this.setTimeout(function(){this.error({code:4,message:this.localize(this.options_.notSupportedMessage)})},0);this.changingSrc_=!0,this.cache_.sources=sources,this.updateSourceCaches_(sources[0]),setSource(this,sources[0],function(middlewareSource,mws){if(_this11.middleware_=mws,_this11.cache_.sources=sources,_this11.updateSourceCaches_(middlewareSource),_this11.src_(middlewareSource))return sources.length>1?_this11.src(sources.slice(1)):(_this11.changingSrc_=!1,_this11.setTimeout(function(){this.error({code:4,message:this.localize(this.options_.notSupportedMessage)})},0),void _this11.triggerReady());setTech(mws,_this11.tech_)})},_proto.src_=function(source){var _this12=this,sourceTech=this.selectSource([source]);return!sourceTech||(titleCaseEquals(sourceTech.tech,this.techName_)?(this.ready(function(){this.tech_.constructor.prototype.hasOwnProperty("setSource")?this.techCall_("setSource",source):this.techCall_("src",source.src),this.changingSrc_=!1},!0),!1):(this.changingSrc_=!0,this.loadTech_(sourceTech.tech,sourceTech.source),this.tech_.ready(function(){_this12.changingSrc_=!1}),!1))},_proto.load=function(){this.techCall_("load")},_proto.reset=function(){var _this13=this,PromiseClass=this.options_.Promise||window$1.Promise;if(this.paused()||!PromiseClass)this.doReset_();else{silencePromise(this.play().then(function(){return _this13.doReset_()}))}},_proto.doReset_=function(){this.tech_&&this.tech_.clearTracks("text"),this.resetCache_(),this.poster(""),this.loadTech_(this.options_.techOrder[0],null),this.techCall_("reset"),this.resetControlBarUI_(),isEvented(this)&&this.trigger("playerreset")},_proto.resetControlBarUI_=function(){this.resetProgressBar_(),this.resetPlaybackRate_(),this.resetVolumeBar_()},_proto.resetProgressBar_=function(){this.currentTime(0);var _this$controlBar=this.controlBar,durationDisplay=_this$controlBar.durationDisplay,remainingTimeDisplay=_this$controlBar.remainingTimeDisplay;durationDisplay&&durationDisplay.updateContent(),remainingTimeDisplay&&remainingTimeDisplay.updateContent()},_proto.resetPlaybackRate_=function(){this.playbackRate(this.defaultPlaybackRate()),this.handleTechRateChange_()},_proto.resetVolumeBar_=function(){this.volume(1),this.trigger("volumechange")},_proto.currentSources=function(){var source=this.currentSource(),sources=[];return 0!==Object.keys(source).length&&sources.push(source),this.cache_.sources||sources},_proto.currentSource=function(){return this.cache_.source||{}},_proto.currentSrc=function(){return this.currentSource()&&this.currentSource().src||""},_proto.currentType=function(){return this.currentSource()&&this.currentSource().type||""},_proto.preload=function(value){return void 0!==value?(this.techCall_("setPreload",value),void(this.options_.preload=value)):this.techGet_("preload")},_proto.autoplay=function(value){if(void 0===value)return this.options_.autoplay||!1;var techAutoplay;"string"==typeof value&&/(any|play|muted)/.test(value)?(this.options_.autoplay=value,this.manualAutoplay_(value),techAutoplay=!1):this.options_.autoplay=!!value,techAutoplay=void 0===techAutoplay?this.options_.autoplay:techAutoplay,this.tech_&&this.techCall_("setAutoplay",techAutoplay)},_proto.playsinline=function(value){return void 0!==value?(this.techCall_("setPlaysinline",value),this.options_.playsinline=value,this):this.techGet_("playsinline")},_proto.loop=function(value){return void 0!==value?(this.techCall_("setLoop",value),void(this.options_.loop=value)):this.techGet_("loop")},_proto.poster=function(src){if(void 0===src)return this.poster_;src||(src=""),src!==this.poster_&&(this.poster_=src,this.techCall_("setPoster",src),this.isPosterFromTech_=!1,this.trigger("posterchange"))},_proto.handleTechPosterChange_=function(){if((!this.poster_||this.options_.techCanOverridePoster)&&this.tech_&&this.tech_.poster){var newPoster=this.tech_.poster()||"";newPoster!==this.poster_&&(this.poster_=newPoster,this.isPosterFromTech_=!0,this.trigger("posterchange"))}},_proto.controls=function(bool){if(void 0===bool)return!!this.controls_;bool=!!bool,this.controls_!==bool&&(this.controls_=bool,this.usingNativeControls()&&this.techCall_("setControls",bool),this.controls_?(this.removeClass("vjs-controls-disabled"),this.addClass("vjs-controls-enabled"),this.trigger("controlsenabled"),this.usingNativeControls()||this.addTechControlsListeners_()):(this.removeClass("vjs-controls-enabled"),this.addClass("vjs-controls-disabled"),this.trigger("controlsdisabled"),this.usingNativeControls()||this.removeTechControlsListeners_()))},_proto.usingNativeControls=function(bool){if(void 0===bool)return!!this.usingNativeControls_;bool=!!bool,this.usingNativeControls_!==bool&&(this.usingNativeControls_=bool,this.usingNativeControls_?(this.addClass("vjs-using-native-controls"),this.trigger("usingnativecontrols")):(this.removeClass("vjs-using-native-controls"),this.trigger("usingcustomcontrols")))},_proto.error=function(err){if(void 0===err)return this.error_||null;if(this.options_.suppressNotSupportedError&&err&&err.message&&err.message===this.localize(this.options_.notSupportedMessage)){var triggerSuppressedError=function(){this.error(err)};return this.options_.suppressNotSupportedError=!1,this.any(["click","touchstart"],triggerSuppressedError),void this.one("loadstart",function(){this.off(["click","touchstart"],triggerSuppressedError)})}if(null===err)return this.error_=err,this.removeClass("vjs-error"),void(this.errorDisplay&&this.errorDisplay.close());this.error_=new MediaError(err),this.addClass("vjs-error"),log.error("(CODE:"+this.error_.code+" "+MediaError.errorTypes[this.error_.code]+")",this.error_.message,this.error_),this.trigger("error")},_proto.reportUserActivity=function(event){this.userActivity_=!0},_proto.userActive=function(bool){if(void 0===bool)return this.userActive_;if((bool=!!bool)!==this.userActive_){if(this.userActive_=bool,this.userActive_)return this.userActivity_=!0,this.removeClass("vjs-user-inactive"),this.addClass("vjs-user-active"),void this.trigger("useractive");this.tech_&&this.tech_.one("mousemove",function(e){e.stopPropagation(),e.preventDefault()}),this.userActivity_=!1,this.removeClass("vjs-user-active"),this.addClass("vjs-user-inactive"),this.trigger("userinactive")}},_proto.listenForUserActivity_=function(){var mouseInProgress,lastMoveX,lastMoveY,handleActivity=bind(this,this.reportUserActivity),handleMouseMove=function(e){e.screenX===lastMoveX&&e.screenY===lastMoveY||(lastMoveX=e.screenX,lastMoveY=e.screenY,handleActivity())},handleMouseDown=function(){handleActivity(),this.clearInterval(mouseInProgress),mouseInProgress=this.setInterval(handleActivity,250)},handleMouseUp=function(event){handleActivity(),this.clearInterval(mouseInProgress)};this.on("mousedown",handleMouseDown),this.on("mousemove",handleMouseMove),this.on("mouseup",handleMouseUp);var controlBar=this.getChild("controlBar");!controlBar||IS_IOS||IS_ANDROID||(controlBar.on("mouseenter",function(event){this.player().cache_.inactivityTimeout=this.player().options_.inactivityTimeout,this.player().options_.inactivityTimeout=0}),controlBar.on("mouseleave",function(event){this.player().options_.inactivityTimeout=this.player().cache_.inactivityTimeout})),this.on("keydown",handleActivity),this.on("keyup",handleActivity);var inactivityTimeout;this.setInterval(function(){if(this.userActivity_){this.userActivity_=!1,this.userActive(!0),this.clearTimeout(inactivityTimeout);var timeout=this.options_.inactivityTimeout;timeout<=0||(inactivityTimeout=this.setTimeout(function(){this.userActivity_||this.userActive(!1)},timeout))}},250)},_proto.playbackRate=function(rate){return void 0!==rate?void this.techCall_("setPlaybackRate",rate):this.tech_&&this.tech_.featuresPlaybackRate?this.cache_.lastPlaybackRate||this.techGet_("playbackRate"):1},_proto.defaultPlaybackRate=function(rate){return void 0!==rate?this.techCall_("setDefaultPlaybackRate",rate):this.tech_&&this.tech_.featuresPlaybackRate?this.techGet_("defaultPlaybackRate"):1},_proto.isAudio=function(bool){return void 0!==bool?void(this.isAudio_=!!bool):!!this.isAudio_},_proto.addTextTrack=function(kind,label,language){if(this.tech_)return this.tech_.addTextTrack(kind,label,language)},_proto.addRemoteTextTrack=function(options,manualCleanup){if(this.tech_)return this.tech_.addRemoteTextTrack(options,manualCleanup)},_proto.removeRemoteTextTrack=function(obj){void 0===obj&&(obj={});var _obj=obj,track=_obj.track;if(track||(track=obj),this.tech_)return this.tech_.removeRemoteTextTrack(track)},_proto.getVideoPlaybackQuality=function(){return this.techGet_("getVideoPlaybackQuality")},_proto.videoWidth=function(){return this.tech_&&this.tech_.videoWidth&&this.tech_.videoWidth()||0},_proto.videoHeight=function(){return this.tech_&&this.tech_.videoHeight&&this.tech_.videoHeight()||0},_proto.language=function(code){if(void 0===code)return this.language_;this.language_=String(code).toLowerCase()},_proto.languages=function(){return mergeOptions(Player.prototype.options_.languages,this.languages_)},_proto.toJSON=function(){var options=mergeOptions(this.options_),tracks=options.tracks;options.tracks=[];for(var i=0;i<tracks.length;i++){var track=tracks[i];track=mergeOptions(track),track.player=void 0,options.tracks[i]=track}return options},_proto.createModal=function(content,options){var _this14=this;options=options||{},options.content=content||"";var modal=new ModalDialog(this,options);return this.addChild(modal),modal.on("dispose",function(){_this14.removeChild(modal)}),modal.open(),modal},_proto.updateCurrentBreakpoint_=function(){if(this.responsive())for(var currentBreakpoint=this.currentBreakpoint(),currentWidth=this.currentWidth(),i=0;i<BREAKPOINT_ORDER.length;i++){var candidateBreakpoint=BREAKPOINT_ORDER[i],maxWidth=this.breakpoints_[candidateBreakpoint];if(currentWidth<=maxWidth){if(currentBreakpoint===candidateBreakpoint)return;currentBreakpoint&&this.removeClass(BREAKPOINT_CLASSES[currentBreakpoint]),this.addClass(BREAKPOINT_CLASSES[candidateBreakpoint]),this.breakpoint_=candidateBreakpoint;break}}},_proto.removeCurrentBreakpoint_=function(){var className=this.currentBreakpointClass();this.breakpoint_="",className&&this.removeClass(className)},_proto.breakpoints=function(_breakpoints){return void 0===_breakpoints?assign(this.breakpoints_):(this.breakpoint_="",this.breakpoints_=assign({},DEFAULT_BREAKPOINTS,_breakpoints),this.updateCurrentBreakpoint_(),assign(this.breakpoints_))},_proto.responsive=function(value){return void 0===value?this.responsive_:(value=Boolean(value),value!==this.responsive_?(this.responsive_=value,value?(this.on("playerresize",this.updateCurrentBreakpoint_),this.updateCurrentBreakpoint_()):(this.off("playerresize",this.updateCurrentBreakpoint_),this.removeCurrentBreakpoint_()),value):void 0)},_proto.currentBreakpoint=function(){return this.breakpoint_},_proto.currentBreakpointClass=function(){return BREAKPOINT_CLASSES[this.breakpoint_]||""},_proto.loadMedia=function(media,ready){var _this15=this;if(media&&"object"==typeof media){this.reset(),this.cache_.media=mergeOptions(media);var _this$cache_$media=this.cache_.media,artwork=_this$cache_$media.artwork,poster=_this$cache_$media.poster,src=_this$cache_$media.src,textTracks=_this$cache_$media.textTracks;!artwork&&poster&&(this.cache_.media.artwork=[{src:poster,type:getMimetype(poster)}]),src&&this.src(src),poster&&this.poster(poster),Array.isArray(textTracks)&&textTracks.forEach(function(tt){return _this15.addRemoteTextTrack(tt,!1)}),this.ready(ready)}},_proto.getMedia=function(){if(!this.cache_.media){var poster=this.poster(),src=this.currentSources(),textTracks=Array.prototype.map.call(this.remoteTextTracks(),function(tt){return{kind:tt.kind,label:tt.label,language:tt.language,src:tt.src}}),media={src:src,textTracks:textTracks};return poster&&(media.poster=poster,media.artwork=[{src:media.poster,type:getMimetype(media.poster)}]),media}return mergeOptions(this.cache_.media)},Player.getTagSettings=function(tag){var baseOptions={sources:[],tracks:[]},tagOptions=getAttributes(tag),dataSetup=tagOptions["data-setup"];if(hasClass(tag,"vjs-fill")&&(tagOptions.fill=!0),hasClass(tag,"vjs-fluid")&&(tagOptions.fluid=!0),null!==dataSetup){var _safeParseTuple=tuple(dataSetup||"{}"),err=_safeParseTuple[0],data=_safeParseTuple[1];err&&log.error(err),assign(tagOptions,data)}if(assign(baseOptions,tagOptions),tag.hasChildNodes())for(var children=tag.childNodes,i=0,j=children.length;i<j;i++){var child=children[i],childName=child.nodeName.toLowerCase();"source"===childName?baseOptions.sources.push(getAttributes(child)):"track"===childName&&baseOptions.tracks.push(getAttributes(child))}return baseOptions},_proto.flexNotSupported_=function(){var elem=document.createElement("i");return!("flexBasis"in elem.style||"webkitFlexBasis"in elem.style||"mozFlexBasis"in elem.style||"msFlexBasis"in elem.style||"msFlexOrder"in elem.style)},Player}(Component);ALL.names.forEach(function(name){var props=ALL[name];Player.prototype[props.getterName]=function(){return this.tech_?this.tech_[props.getterName]():(this[props.privateName]=this[props.privateName]||new props.ListClass,this[props.privateName])}}),Player.players={};var navigator=window$1.navigator;Player.prototype.options_={techOrder:Tech.defaultTechOrder_,html5:{},flash:{},inactivityTimeout:2e3,playbackRates:[],liveui:!1,children:["mediaLoader","posterImage","textTrackDisplay","loadingSpinner","bigPlayButton","liveTracker","controlBar","errorDisplay","textTrackSettings","resizeManager"],language:navigator&&(navigator.languages&&navigator.languages[0]||navigator.userLanguage||navigator.language)||"en",languages:{},notSupportedMessage:"No compatible source was found for this media.",fullscreen:{options:{navigationUI:"hide"}},breakpoints:{},responsive:!1},["ended","seeking","seekable","networkState","readyState"].forEach(function(fn){Player.prototype[fn]=function(){return this.techGet_(fn)}}),TECH_EVENTS_RETRIGGER.forEach(function(event){Player.prototype["handleTech"+toTitleCase(event)+"_"]=function(){return this.trigger(event)}}),Component.registerComponent("Player",Player);var pluginStorage={},pluginExists=function(name){return pluginStorage.hasOwnProperty(name)},getPlugin=function(name){return pluginExists(name)?pluginStorage[name]:void 0},markPluginAsActive=function(player,name){player.activePlugins_=player.activePlugins_||{},player.activePlugins_[name]=!0},triggerSetupEvent=function(player,hash,before){var eventName=(before?"before":"")+"pluginsetup";player.trigger(eventName,hash),player.trigger(eventName+":"+hash.name,hash)},createBasicPlugin=function(name,plugin){var basicPluginWrapper=function(){triggerSetupEvent(this,{name:name,plugin:plugin,instance:null},!0);var instance=plugin.apply(this,arguments);return markPluginAsActive(this,name),triggerSetupEvent(this,{name:name,plugin:plugin,instance:instance}),instance};return Object.keys(plugin).forEach(function(prop){basicPluginWrapper[prop]=plugin[prop]}),basicPluginWrapper},createPluginFactory=function(name,PluginSubClass){return PluginSubClass.prototype.name=name,function(){triggerSetupEvent(this,{name:name,plugin:PluginSubClass,instance:null},!0);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];var instance=_construct(PluginSubClass,[this].concat(args));return this[name]=function(){return instance},triggerSetupEvent(this,instance.getEventHash()),instance}},Plugin=function(){function Plugin(player){if(this.constructor===Plugin)throw new Error("Plugin must be sub-classed; not directly instantiated.");this.player=player,evented(this),delete this.trigger,stateful(this,this.constructor.defaultState),markPluginAsActive(player,this.name),this.dispose=bind(this,this.dispose),player.on("dispose",this.dispose)}var _proto=Plugin.prototype;return _proto.version=function(){return this.constructor.VERSION},_proto.getEventHash=function(hash){return void 0===hash&&(hash={}),hash.name=this.name,hash.plugin=this.constructor,hash.instance=this,hash},_proto.trigger=function(event,hash){return void 0===hash&&(hash={}),trigger(this.eventBusEl_,event,this.getEventHash(hash))},_proto.handleStateChanged=function(e){},_proto.dispose=function(){var name=this.name,player=this.player;this.trigger("dispose"),this.off(),player.off("dispose",this.dispose),player.activePlugins_[name]=!1,this.player=this.state=null,player[name]=createPluginFactory(name,pluginStorage[name])},Plugin.isBasic=function(plugin){var p="string"==typeof plugin?getPlugin(plugin):plugin;return"function"==typeof p&&!Plugin.prototype.isPrototypeOf(p.prototype)},Plugin.registerPlugin=function(name,plugin){if("string"!=typeof name)throw new Error('Illegal plugin name, "'+name+'", must be a string, was '+typeof name+".");if(pluginExists(name))log.warn('A plugin named "'+name+'" already exists. You may want to avoid re-registering plugins!');else if(Player.prototype.hasOwnProperty(name))throw new Error('Illegal plugin name, "'+name+'", cannot share a name with an existing player method!');if("function"!=typeof plugin)throw new Error('Illegal plugin for "'+name+'", must be a function, was '+typeof plugin+".");return pluginStorage[name]=plugin,"plugin"!==name&&(Plugin.isBasic(plugin)?Player.prototype[name]=createBasicPlugin(name,plugin):Player.prototype[name]=createPluginFactory(name,plugin)),plugin},Plugin.deregisterPlugin=function(name){if("plugin"===name)throw new Error("Cannot de-register base plugin.");pluginExists(name)&&(delete pluginStorage[name],delete Player.prototype[name])},Plugin.getPlugins=function(names){void 0===names&&(names=Object.keys(pluginStorage));var result;return names.forEach(function(name){var plugin=getPlugin(name);plugin&&(result=result||{},result[name]=plugin)}),result},Plugin.getPluginVersion=function(name){var plugin=getPlugin(name);return plugin&&plugin.VERSION||""},Plugin}();Plugin.getPlugin=getPlugin,Plugin.BASE_PLUGIN_NAME="plugin",Plugin.registerPlugin("plugin",Plugin),Player.prototype.usingPlugin=function(name){return!!this.activePlugins_&&!0===this.activePlugins_[name]},Player.prototype.hasPlugin=function(name){return!!pluginExists(name)};var _inherits=function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(subClass.super_=superClass)},extend$1=function(superClass,subClassMethods){void 0===subClassMethods&&(subClassMethods={});var subClass=function(){superClass.apply(this,arguments)},methods={};"object"==typeof subClassMethods?(subClassMethods.constructor!==Object.prototype.constructor&&(subClass=subClassMethods.constructor),methods=subClassMethods):"function"==typeof subClassMethods&&(subClass=subClassMethods),_inherits(subClass,superClass);for(var name in methods)methods.hasOwnProperty(name)&&(subClass.prototype[name]=methods[name]);return subClass},normalizeId=function(id){return 0===id.indexOf("#")?id.slice(1):id};function videojs$1(id,options,ready){var player=videojs$1.getPlayer(id);if(player)return options&&log.warn('Player "'+id+'" is already initialised. Options will not be applied.'),ready&&player.ready(ready),player;var el="string"==typeof id?$("#"+normalizeId(id)):id;if(!isEl(el))throw new TypeError("The element or ID supplied is not valid. (videojs)");el.ownerDocument.defaultView&&el.ownerDocument.body.contains(el)||log.warn("The element supplied is not included in the DOM"),options=options||{},videojs$1.hooks("beforesetup").forEach(function(hookFunction){var opts=hookFunction(el,mergeOptions(options));if(!isObject(opts)||Array.isArray(opts))return void log.error("please return an object in beforesetup hooks");options=mergeOptions(options,opts)});var PlayerComponent=Component.getComponent("Player");return player=new PlayerComponent(el,options,ready),videojs$1.hooks("setup").forEach(function(hookFunction){return hookFunction(player)}),player}if(videojs$1.hooks_={},videojs$1.hooks=function(type,fn){return videojs$1.hooks_[type]=videojs$1.hooks_[type]||[],fn&&(videojs$1.hooks_[type]=videojs$1.hooks_[type].concat(fn)),videojs$1.hooks_[type]},videojs$1.hook=function(type,fn){videojs$1.hooks(type,fn)},videojs$1.hookOnce=function(type,fn){videojs$1.hooks(type,[].concat(fn).map(function(original){return function wrapper(){return videojs$1.removeHook(type,wrapper),original.apply(void 0,arguments)}}))},videojs$1.removeHook=function(type,fn){var index=videojs$1.hooks(type).indexOf(fn);return!(index<=-1)&&(videojs$1.hooks_[type]=videojs$1.hooks_[type].slice(),videojs$1.hooks_[type].splice(index,1),!0)},!0!==window$1.VIDEOJS_NO_DYNAMIC_STYLE&&isReal()){var style=$(".vjs-styles-defaults");if(!style){style=createStyleElement("vjs-styles-defaults");var head=$("head");head&&head.insertBefore(style,head.firstChild),setTextContent(style,"\n      .video-js {\n        width: 300px;\n        height: 150px;\n      }\n\n      .vjs-fluid {\n        padding-top: 56.25%\n      }\n    ")}}return autoSetupTimeout(1,videojs$1),videojs$1.VERSION=version,videojs$1.options=Player.prototype.options_,videojs$1.getPlayers=function(){return Player.players},videojs$1.getPlayer=function(id){var tag,players=Player.players;if("string"==typeof id){var nId=normalizeId(id),player=players[nId];if(player)return player;tag=$("#"+nId)}else tag=id;if(isEl(tag)){var _tag=tag,_player=_tag.player,playerId=_tag.playerId;if(_player||players[playerId])return _player||players[playerId]}},videojs$1.getAllPlayers=function(){return Object.keys(Player.players).map(function(k){return Player.players[k]}).filter(Boolean)},videojs$1.players=Player.players,videojs$1.getComponent=Component.getComponent,videojs$1.registerComponent=function(name,comp){Tech.isTech(comp)&&log.warn("The "+name+" tech was registered as a component. It should instead be registered using videojs.registerTech(name, tech)"),Component.registerComponent.call(Component,name,comp)},videojs$1.getTech=Tech.getTech,videojs$1.registerTech=Tech.registerTech,videojs$1.use=use,Object.defineProperty(videojs$1,"middleware",{value:{},writeable:!1,enumerable:!0}),Object.defineProperty(videojs$1.middleware,"TERMINATOR",{value:TERMINATOR,writeable:!1,enumerable:!0}),videojs$1.browser=browser,videojs$1.TOUCH_ENABLED=TOUCH_ENABLED,videojs$1.extend=extend$1,videojs$1.mergeOptions=mergeOptions,videojs$1.bind=bind,videojs$1.registerPlugin=Plugin.registerPlugin,videojs$1.deregisterPlugin=Plugin.deregisterPlugin,videojs$1.plugin=function(name,plugin){return log.warn("videojs.plugin() is deprecated; use videojs.registerPlugin() instead"),Plugin.registerPlugin(name,plugin)},videojs$1.getPlugins=Plugin.getPlugins,videojs$1.getPlugin=Plugin.getPlugin,videojs$1.getPluginVersion=Plugin.getPluginVersion,videojs$1.addLanguage=function(code,data){var _mergeOptions;return code=(""+code).toLowerCase(),videojs$1.options.languages=mergeOptions(videojs$1.options.languages,(_mergeOptions={},_mergeOptions[code]=data,_mergeOptions)),videojs$1.options.languages[code]},videojs$1.log=log,videojs$1.createLogger=createLogger$1,videojs$1.createTimeRange=videojs$1.createTimeRanges=createTimeRanges,videojs$1.formatTime=formatTime,videojs$1.setFormatTime=setFormatTime,videojs$1.resetFormatTime=resetFormatTime,videojs$1.parseUrl=parseUrl,videojs$1.isCrossOrigin=isCrossOrigin,videojs$1.EventTarget=EventTarget,videojs$1.on=on,videojs$1.one=one,videojs$1.off=off,videojs$1.trigger=trigger,videojs$1.xhr=xhr,videojs$1.TextTrack=TextTrack,videojs$1.AudioTrack=AudioTrack,videojs$1.VideoTrack=VideoTrack,["isEl","isTextNode","createEl","hasClass","addClass","removeClass","toggleClass","setAttributes","getAttributes","emptyEl","appendContent","insertContent"].forEach(function(k){videojs$1[k]=function(){return log.warn("videojs."+k+"() is deprecated; use videojs.dom."+k+"() instead"),Dom[k].apply(null,arguments)}}),videojs$1.computedStyle=computedStyle,videojs$1.dom=Dom,videojs$1.url=Url,videojs$1}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports,require("video.js")):"function"==typeof define&&define.amd?define(["exports","video.js"],factory):factory(global.videojsHttpStreaming={},global.videojs)}(this,function(exports,videojs){"use strict";videojs=videojs&&videojs.hasOwnProperty("default")?videojs.default:videojs;var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var doccy,minDoc={},topLevel=void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof window?window:{};"undefined"!=typeof document?doccy=document:(doccy=topLevel["__GLOBAL_DOCUMENT_CACHE@4"])||(doccy=topLevel["__GLOBAL_DOCUMENT_CACHE@4"]=minDoc);var win,document_1=doccy,urlToolkit=function(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}(function(module,exports){!function(root){var URL_REGEX=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/?#]*)?((?:[^\/\?#]*\/)*.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,FIRST_SEGMENT_REGEX=/^([^\/?#]*)(.*)$/,SLASH_DOT_REGEX=/(?:\/|^)\.(?=\/)/g,SLASH_DOT_DOT_REGEX=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g,URLToolkit={buildAbsoluteURL:function(baseURL,relativeURL,opts){if(opts=opts||{},baseURL=baseURL.trim(),!(relativeURL=relativeURL.trim())){if(!opts.alwaysNormalize)return baseURL;var basePartsForNormalise=URLToolkit.parseURL(baseURL);if(!basePartsForNormalise)throw new Error("Error trying to parse base URL.");return basePartsForNormalise.path=URLToolkit.normalizePath(basePartsForNormalise.path),URLToolkit.buildURLFromParts(basePartsForNormalise)}var relativeParts=URLToolkit.parseURL(relativeURL);if(!relativeParts)throw new Error("Error trying to parse relative URL.");if(relativeParts.scheme)return opts.alwaysNormalize?(relativeParts.path=URLToolkit.normalizePath(relativeParts.path),
URLToolkit.buildURLFromParts(relativeParts)):relativeURL;var baseParts=URLToolkit.parseURL(baseURL);if(!baseParts)throw new Error("Error trying to parse base URL.");if(!baseParts.netLoc&&baseParts.path&&"/"!==baseParts.path[0]){var pathParts=FIRST_SEGMENT_REGEX.exec(baseParts.path);baseParts.netLoc=pathParts[1],baseParts.path=pathParts[2]}baseParts.netLoc&&!baseParts.path&&(baseParts.path="/");var builtParts={scheme:baseParts.scheme,netLoc:relativeParts.netLoc,path:null,params:relativeParts.params,query:relativeParts.query,fragment:relativeParts.fragment};if(!relativeParts.netLoc&&(builtParts.netLoc=baseParts.netLoc,"/"!==relativeParts.path[0]))if(relativeParts.path){var baseURLPath=baseParts.path,newPath=baseURLPath.substring(0,baseURLPath.lastIndexOf("/")+1)+relativeParts.path;builtParts.path=URLToolkit.normalizePath(newPath)}else builtParts.path=baseParts.path,relativeParts.params||(builtParts.params=baseParts.params,relativeParts.query||(builtParts.query=baseParts.query));return null===builtParts.path&&(builtParts.path=opts.alwaysNormalize?URLToolkit.normalizePath(relativeParts.path):relativeParts.path),URLToolkit.buildURLFromParts(builtParts)},parseURL:function(url){var parts=URL_REGEX.exec(url);return parts?{scheme:parts[1]||"",netLoc:parts[2]||"",path:parts[3]||"",params:parts[4]||"",query:parts[5]||"",fragment:parts[6]||""}:null},normalizePath:function(path){for(path=path.split("").reverse().join("").replace(SLASH_DOT_REGEX,"");path.length!==(path=path.replace(SLASH_DOT_DOT_REGEX,"")).length;);return path.split("").reverse().join("")},buildURLFromParts:function(parts){return parts.scheme+parts.netLoc+parts.path+parts.params+parts.query+parts.fragment}};module.exports=URLToolkit}()});win="undefined"!=typeof window?window:void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:{};var window_1=win,resolveUrl=function(baseURL,relativeURL){return/^[a-z]+:/i.test(relativeURL)?relativeURL:(/\/\//i.test(baseURL)||(baseURL=urlToolkit.buildAbsoluteURL(window_1.location.href,baseURL)),urlToolkit.buildAbsoluteURL(baseURL,relativeURL))},resolveManifestRedirect=function(handleManifestRedirect,url,req){return handleManifestRedirect&&req.responseURL&&url!==req.responseURL?req.responseURL:url};function _extends(){return _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target},_extends.apply(this,arguments)}function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}var Stream=function(){function Stream(){this.listeners={}}var _proto=Stream.prototype;return _proto.on=function(type,listener){this.listeners[type]||(this.listeners[type]=[]),this.listeners[type].push(listener)},_proto.off=function(type,listener){if(!this.listeners[type])return!1;var index=this.listeners[type].indexOf(listener);return this.listeners[type].splice(index,1),index>-1},_proto.trigger=function(type){var i,length,args,callbacks=this.listeners[type];if(callbacks)if(2===arguments.length)for(length=callbacks.length,i=0;i<length;++i)callbacks[i].call(this,arguments[1]);else for(args=Array.prototype.slice.call(arguments,1),length=callbacks.length,i=0;i<length;++i)callbacks[i].apply(this,args)},_proto.dispose=function(){this.listeners={}},_proto.pipe=function(destination){this.on("data",function(data){destination.push(data)})},Stream}(),LineStream=function(_Stream){_inheritsLoose(LineStream,_Stream);function LineStream(){var _this;return _this=_Stream.call(this)||this,_this.buffer="",_this}return LineStream.prototype.push=function(data){var nextNewline;for(this.buffer+=data,nextNewline=this.buffer.indexOf("\n");nextNewline>-1;nextNewline=this.buffer.indexOf("\n"))this.trigger("data",this.buffer.substring(0,nextNewline)),this.buffer=this.buffer.substring(nextNewline+1)},LineStream}(Stream),attributeSeparator=function(){return new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')},parseAttributes=function(attributes){for(var attr,attrs=attributes.split(attributeSeparator()),result={},i=attrs.length;i--;)""!==attrs[i]&&(attr=/([^=]*)=(.*)/.exec(attrs[i]).slice(1),attr[0]=attr[0].replace(/^\s+|\s+$/g,""),attr[1]=attr[1].replace(/^\s+|\s+$/g,""),attr[1]=attr[1].replace(/^['"](.*)['"]$/g,"$1"),result[attr[0]]=attr[1]);return result},ParseStream=function(_Stream){_inheritsLoose(ParseStream,_Stream);function ParseStream(){var _this;return _this=_Stream.call(this)||this,_this.customParsers=[],_this.tagMappers=[],_this}var _proto=ParseStream.prototype;return _proto.push=function(line){var match,event,_this2=this;if(line=line.trim(),0!==line.length){if("#"!==line[0])return void this.trigger("data",{type:"uri",uri:line});this.tagMappers.reduce(function(acc,mapper){var mappedLine=mapper(line);return mappedLine===line?acc:acc.concat([mappedLine])},[line]).forEach(function(newLine){for(var i=0;i<_this2.customParsers.length;i++)if(_this2.customParsers[i].call(_this2,newLine))return;if(0!==newLine.indexOf("#EXT"))return void _this2.trigger("data",{type:"comment",text:newLine.slice(1)});if(newLine=newLine.replace("\r",""),match=/^#EXTM3U/.exec(newLine))return void _this2.trigger("data",{type:"tag",tagType:"m3u"});if(match=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(newLine))return event={type:"tag",tagType:"inf"},match[1]&&(event.duration=parseFloat(match[1])),match[2]&&(event.title=match[2]),void _this2.trigger("data",event);if(match=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(newLine))return event={type:"tag",tagType:"targetduration"},match[1]&&(event.duration=parseInt(match[1],10)),void _this2.trigger("data",event);if(match=/^#ZEN-TOTAL-DURATION:?([0-9.]*)?/.exec(newLine))return event={type:"tag",tagType:"totalduration"},match[1]&&(event.duration=parseInt(match[1],10)),void _this2.trigger("data",event);if(match=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(newLine))return event={type:"tag",tagType:"version"},match[1]&&(event.version=parseInt(match[1],10)),void _this2.trigger("data",event);if(match=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(newLine))return event={type:"tag",tagType:"media-sequence"},match[1]&&(event.number=parseInt(match[1],10)),void _this2.trigger("data",event);if(match=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(newLine))return event={type:"tag",tagType:"discontinuity-sequence"},match[1]&&(event.number=parseInt(match[1],10)),void _this2.trigger("data",event);if(match=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(newLine))return event={type:"tag",tagType:"playlist-type"},match[1]&&(event.playlistType=match[1]),void _this2.trigger("data",event);if(match=/^#EXT-X-BYTERANGE:?([0-9.]*)?@?([0-9.]*)?/.exec(newLine))return event={type:"tag",tagType:"byterange"},match[1]&&(event.length=parseInt(match[1],10)),match[2]&&(event.offset=parseInt(match[2],10)),void _this2.trigger("data",event);if(match=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(newLine))return event={type:"tag",tagType:"allow-cache"},match[1]&&(event.allowed=!/NO/.test(match[1])),void _this2.trigger("data",event);if(match=/^#EXT-X-MAP:?(.*)$/.exec(newLine)){if(event={type:"tag",tagType:"map"},match[1]){var attributes=parseAttributes(match[1]);if(attributes.URI&&(event.uri=attributes.URI),attributes.BYTERANGE){var _attributes$BYTERANGE=attributes.BYTERANGE.split("@"),length=_attributes$BYTERANGE[0],offset=_attributes$BYTERANGE[1];event.byterange={},length&&(event.byterange.length=parseInt(length,10)),offset&&(event.byterange.offset=parseInt(offset,10))}}return void _this2.trigger("data",event)}if(match=/^#EXT-X-STREAM-INF:?(.*)$/.exec(newLine)){if(event={type:"tag",tagType:"stream-inf"},match[1]){if(event.attributes=parseAttributes(match[1]),event.attributes.RESOLUTION){var split=event.attributes.RESOLUTION.split("x"),resolution={};split[0]&&(resolution.width=parseInt(split[0],10)),split[1]&&(resolution.height=parseInt(split[1],10)),event.attributes.RESOLUTION=resolution}event.attributes.BANDWIDTH&&(event.attributes.BANDWIDTH=parseInt(event.attributes.BANDWIDTH,10)),event.attributes["PROGRAM-ID"]&&(event.attributes["PROGRAM-ID"]=parseInt(event.attributes["PROGRAM-ID"],10))}return void _this2.trigger("data",event)}return(match=/^#EXT-X-MEDIA:?(.*)$/.exec(newLine))?(event={type:"tag",tagType:"media"},match[1]&&(event.attributes=parseAttributes(match[1])),void _this2.trigger("data",event)):(match=/^#EXT-X-ENDLIST/.exec(newLine))?void _this2.trigger("data",{type:"tag",tagType:"endlist"}):(match=/^#EXT-X-DISCONTINUITY/.exec(newLine))?void _this2.trigger("data",{type:"tag",tagType:"discontinuity"}):(match=/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/.exec(newLine))?(event={type:"tag",tagType:"program-date-time"},match[1]&&(event.dateTimeString=match[1],event.dateTimeObject=new Date(match[1])),void _this2.trigger("data",event)):(match=/^#EXT-X-KEY:?(.*)$/.exec(newLine))?(event={type:"tag",tagType:"key"},match[1]&&(event.attributes=parseAttributes(match[1]),event.attributes.IV&&("0x"===event.attributes.IV.substring(0,2).toLowerCase()&&(event.attributes.IV=event.attributes.IV.substring(2)),event.attributes.IV=event.attributes.IV.match(/.{8}/g),event.attributes.IV[0]=parseInt(event.attributes.IV[0],16),event.attributes.IV[1]=parseInt(event.attributes.IV[1],16),event.attributes.IV[2]=parseInt(event.attributes.IV[2],16),event.attributes.IV[3]=parseInt(event.attributes.IV[3],16),event.attributes.IV=new Uint32Array(event.attributes.IV))),void _this2.trigger("data",event)):(match=/^#EXT-X-START:?(.*)$/.exec(newLine))?(event={type:"tag",tagType:"start"},match[1]&&(event.attributes=parseAttributes(match[1]),event.attributes["TIME-OFFSET"]=parseFloat(event.attributes["TIME-OFFSET"]),event.attributes.PRECISE=/YES/.test(event.attributes.PRECISE)),void _this2.trigger("data",event)):(match=/^#EXT-X-CUE-OUT-CONT:?(.*)?$/.exec(newLine))?(event={type:"tag",tagType:"cue-out-cont"},match[1]?event.data=match[1]:event.data="",void _this2.trigger("data",event)):(match=/^#EXT-X-CUE-OUT:?(.*)?$/.exec(newLine))?(event={type:"tag",tagType:"cue-out"},match[1]?event.data=match[1]:event.data="",void _this2.trigger("data",event)):(match=/^#EXT-X-CUE-IN:?(.*)?$/.exec(newLine))?(event={type:"tag",tagType:"cue-in"},match[1]?event.data=match[1]:event.data="",void _this2.trigger("data",event)):void _this2.trigger("data",{type:"tag",data:newLine.slice(4)})})}},_proto.addParser=function(_ref){var _this3=this,expression=_ref.expression,customType=_ref.customType,dataParser=_ref.dataParser,segment=_ref.segment;"function"!=typeof dataParser&&(dataParser=function(line){return line}),this.customParsers.push(function(line){if(expression.exec(line))return _this3.trigger("data",{type:"custom",data:dataParser(line),customType:customType,segment:segment}),!0})},_proto.addTagMapper=function(_ref2){var expression=_ref2.expression,map=_ref2.map,mapFn=function(line){return expression.test(line)?map(line):line};this.tagMappers.push(mapFn)},ParseStream}(Stream);function decodeB64ToUint8Array(b64Text){for(var decodedString=window_1.atob(b64Text||""),array=new Uint8Array(decodedString.length),i=0;i<decodedString.length;i++)array[i]=decodedString.charCodeAt(i);return array}var Parser=function(_Stream){_inheritsLoose(Parser,_Stream);function Parser(){var _this;_this=_Stream.call(this)||this,_this.lineStream=new LineStream,_this.parseStream=new ParseStream,_this.lineStream.pipe(_this.parseStream);var currentMap,_key,self=_assertThisInitialized(_this),uris=[],currentUri={},noop=function(){},defaultMediaGroups={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},currentTimeline=0;return _this.manifest={allowCache:!0,discontinuityStarts:[],segments:[]},_this.parseStream.on("data",function(entry){var mediaGroup,rendition;({tag:function(){(({"allow-cache":function(){this.manifest.allowCache=entry.allowed,"allowed"in entry||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange:function(){var byterange={};"length"in entry&&(currentUri.byterange=byterange,byterange.length=entry.length,"offset"in entry||(this.trigger("info",{message:"defaulting offset to zero"}),entry.offset=0)),"offset"in entry&&(currentUri.byterange=byterange,byterange.offset=entry.offset)},endlist:function(){this.manifest.endList=!0},inf:function(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),entry.duration>0&&(currentUri.duration=entry.duration),0===entry.duration&&(currentUri.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=uris},key:function(){if(!entry.attributes)return void this.trigger("warn",{message:"ignoring key declaration without attribute list"});if("NONE"===entry.attributes.METHOD)return void(_key=null);if(!entry.attributes.URI)return void this.trigger("warn",{message:"ignoring key declaration without URI"});if("urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===entry.attributes.KEYFORMAT){return-1===["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(entry.attributes.METHOD)?void this.trigger("warn",{message:"invalid key method provided for Widevine"}):("SAMPLE-AES-CENC"===entry.attributes.METHOD&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),"data:text/plain;base64,"!==entry.attributes.URI.substring(0,23)?void this.trigger("warn",{message:"invalid key URI provided for Widevine"}):entry.attributes.KEYID&&"0x"===entry.attributes.KEYID.substring(0,2)?void(this.manifest.contentProtection={"com.widevine.alpha":{attributes:{schemeIdUri:entry.attributes.KEYFORMAT,keyId:entry.attributes.KEYID.substring(2)},pssh:decodeB64ToUint8Array(entry.attributes.URI.split(",")[1])}}):void this.trigger("warn",{message:"invalid key ID provided for Widevine"}))}entry.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),_key={method:entry.attributes.METHOD||"AES-128",uri:entry.attributes.URI},void 0!==entry.attributes.IV&&(_key.iv=entry.attributes.IV)},"media-sequence":function(){if(!isFinite(entry.number))return void this.trigger("warn",{message:"ignoring invalid media sequence: "+entry.number});this.manifest.mediaSequence=entry.number},"discontinuity-sequence":function(){if(!isFinite(entry.number))return void this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+entry.number});this.manifest.discontinuitySequence=entry.number,currentTimeline=entry.number},"playlist-type":function(){if(!/VOD|EVENT/.test(entry.playlistType))return void this.trigger("warn",{message:"ignoring unknown playlist type: "+entry.playlist});this.manifest.playlistType=entry.playlistType},map:function(){currentMap={},entry.uri&&(currentMap.uri=entry.uri),entry.byterange&&(currentMap.byterange=entry.byterange)},"stream-inf":function(){if(this.manifest.playlists=uris,this.manifest.mediaGroups=this.manifest.mediaGroups||defaultMediaGroups,!entry.attributes)return void this.trigger("warn",{message:"ignoring empty stream-inf attributes"});currentUri.attributes||(currentUri.attributes={}),_extends(currentUri.attributes,entry.attributes)},media:function(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||defaultMediaGroups,!(entry.attributes&&entry.attributes.TYPE&&entry.attributes["GROUP-ID"]&&entry.attributes.NAME))return void this.trigger("warn",{message:"ignoring incomplete or missing media group"});var mediaGroupType=this.manifest.mediaGroups[entry.attributes.TYPE];mediaGroupType[entry.attributes["GROUP-ID"]]=mediaGroupType[entry.attributes["GROUP-ID"]]||{},mediaGroup=mediaGroupType[entry.attributes["GROUP-ID"]],rendition={default:/yes/i.test(entry.attributes.DEFAULT)},rendition.default?rendition.autoselect=!0:rendition.autoselect=/yes/i.test(entry.attributes.AUTOSELECT),entry.attributes.LANGUAGE&&(rendition.language=entry.attributes.LANGUAGE),entry.attributes.URI&&(rendition.uri=entry.attributes.URI),entry.attributes["INSTREAM-ID"]&&(rendition.instreamId=entry.attributes["INSTREAM-ID"]),entry.attributes.CHARACTERISTICS&&(rendition.characteristics=entry.attributes.CHARACTERISTICS),entry.attributes.FORCED&&(rendition.forced=/yes/i.test(entry.attributes.FORCED)),mediaGroup[entry.attributes.NAME]=rendition},discontinuity:function(){currentTimeline+=1,currentUri.discontinuity=!0,this.manifest.discontinuityStarts.push(uris.length)},"program-date-time":function(){void 0===this.manifest.dateTimeString&&(this.manifest.dateTimeString=entry.dateTimeString,this.manifest.dateTimeObject=entry.dateTimeObject),currentUri.dateTimeString=entry.dateTimeString,currentUri.dateTimeObject=entry.dateTimeObject},targetduration:function(){if(!isFinite(entry.duration)||entry.duration<0)return void this.trigger("warn",{message:"ignoring invalid target duration: "+entry.duration});this.manifest.targetDuration=entry.duration},totalduration:function(){if(!isFinite(entry.duration)||entry.duration<0)return void this.trigger("warn",{message:"ignoring invalid total duration: "+entry.duration});this.manifest.totalDuration=entry.duration},start:function(){if(!entry.attributes||isNaN(entry.attributes["TIME-OFFSET"]))return void this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"});this.manifest.start={timeOffset:entry.attributes["TIME-OFFSET"],precise:entry.attributes.PRECISE}},"cue-out":function(){currentUri.cueOut=entry.data},"cue-out-cont":function(){currentUri.cueOutCont=entry.data},"cue-in":function(){currentUri.cueIn=entry.data}})[entry.tagType]||noop).call(self)},uri:function(){currentUri.uri=entry.uri,uris.push(currentUri),!this.manifest.targetDuration||"duration"in currentUri||(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),currentUri.duration=this.manifest.targetDuration),_key&&(currentUri.key=_key),currentUri.timeline=currentTimeline,currentMap&&(currentUri.map=currentMap),currentUri={}},comment:function(){},custom:function(){entry.segment?(currentUri.custom=currentUri.custom||{},currentUri.custom[entry.customType]=entry.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[entry.customType]=entry.data)}})[entry.type].call(self)}),_this}var _proto=Parser.prototype;return _proto.push=function(chunk){this.lineStream.push(chunk)},_proto.end=function(){this.lineStream.push("\n")},_proto.addParser=function(options){this.parseStream.addParser(options)},_proto.addTagMapper=function(options){this.parseStream.addTagMapper(options)},Parser}(Stream),classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),get=function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;if(void 0!==getter)return getter.call(receiver)},inherits=function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)},possibleConstructorReturn=function(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call},slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),mergeOptions=videojs.mergeOptions,EventTarget=videojs.EventTarget,log=videojs.log,forEachMediaGroup=function(master,callback){["AUDIO","SUBTITLES"].forEach(function(mediaType){for(var groupKey in master.mediaGroups[mediaType])for(var labelKey in master.mediaGroups[mediaType][groupKey]){var mediaProperties=master.mediaGroups[mediaType][groupKey][labelKey];callback(mediaProperties,mediaType,groupKey,labelKey)}})},updateSegments=function(original,update,offset){var result=update.slice();offset=offset||0;for(var length=Math.min(original.length,update.length+offset),i=offset;i<length;i++)result[i-offset]=mergeOptions(original[i],result[i-offset]);return result},resolveSegmentUris=function(segment,baseUri){segment.resolvedUri||(segment.resolvedUri=resolveUrl(baseUri,segment.uri)),segment.key&&!segment.key.resolvedUri&&(segment.key.resolvedUri=resolveUrl(baseUri,segment.key.uri)),segment.map&&!segment.map.resolvedUri&&(segment.map.resolvedUri=resolveUrl(baseUri,segment.map.uri))},updateMaster=function(master,media){var result=mergeOptions(master,{}),playlist=result.playlists[media.uri];if(!playlist)return null;if(playlist.segments&&media.segments&&playlist.segments.length===media.segments.length&&playlist.endList===media.endList&&playlist.mediaSequence===media.mediaSequence)return null;var mergedPlaylist=mergeOptions(playlist,media);playlist.segments&&(mergedPlaylist.segments=updateSegments(playlist.segments,media.segments,media.mediaSequence-playlist.mediaSequence)),mergedPlaylist.segments.forEach(function(segment){resolveSegmentUris(segment,mergedPlaylist.resolvedUri)});for(var i=0;i<result.playlists.length;i++)result.playlists[i].uri===media.uri&&(result.playlists[i]=mergedPlaylist);return result.playlists[media.uri]=mergedPlaylist,result},setupMediaPlaylists=function(master){for(var i=master.playlists.length;i--;){var playlist=master.playlists[i];master.playlists[playlist.uri]=playlist,playlist.resolvedUri=resolveUrl(master.uri,playlist.uri),playlist.id=i,playlist.attributes||(playlist.attributes={},log.warn("Invalid playlist STREAM-INF detected. Missing BANDWIDTH attribute."))}},resolveMediaGroupUris=function(master){forEachMediaGroup(master,function(properties){properties.uri&&(properties.resolvedUri=resolveUrl(master.uri,properties.uri))})},refreshDelay=function(media,update){var lastSegment=media.segments[media.segments.length-1];return update&&lastSegment&&lastSegment.duration?1e3*lastSegment.duration:500*(media.targetDuration||10)},PlaylistLoader=function(_EventTarget){inherits(PlaylistLoader,_EventTarget);function PlaylistLoader(srcUrl,hls){var options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};classCallCheck(this,PlaylistLoader);var _this=possibleConstructorReturn(this,(PlaylistLoader.__proto__||Object.getPrototypeOf(PlaylistLoader)).call(this)),_options$withCredenti=options.withCredentials,withCredentials=void 0!==_options$withCredenti&&_options$withCredenti,_options$handleManife=options.handleManifestRedirects,handleManifestRedirects=void 0!==_options$handleManife&&_options$handleManife;_this.srcUrl=srcUrl,_this.hls_=hls,_this.withCredentials=withCredentials,_this.handleManifestRedirects=handleManifestRedirects;var hlsOptions=hls.options_;if(_this.customTagParsers=hlsOptions&&hlsOptions.customTagParsers||[],_this.customTagMappers=hlsOptions&&hlsOptions.customTagMappers||[],!_this.srcUrl)throw new Error("A non-empty playlist URL is required");return _this.state="HAVE_NOTHING",_this.on("mediaupdatetimeout",function(){"HAVE_METADATA"===_this.state&&(_this.state="HAVE_CURRENT_METADATA",_this.request=_this.hls_.xhr({uri:resolveUrl(_this.master.uri,_this.media().uri),withCredentials:_this.withCredentials},function(error,req){if(_this.request)return error?_this.playlistRequestError(_this.request,_this.media().uri,"HAVE_METADATA"):void _this.haveMetadata(_this.request,_this.media().uri)}))}),_this}return createClass(PlaylistLoader,[{key:"playlistRequestError",value:function(xhr,url,startingState){this.request=null,startingState&&(this.state=startingState),this.error={playlist:this.master.playlists[url],status:xhr.status,message:"HLS playlist request error at URL: "+url+".",responseText:xhr.responseText,code:xhr.status>=500?4:2},this.trigger("error")}},{key:"haveMetadata",value:function(xhr,url){var _this2=this;this.request=null,this.state="HAVE_METADATA";var parser=new Parser;this.customTagParsers.forEach(function(customParser){return parser.addParser(customParser)}),this.customTagMappers.forEach(function(mapper){return parser.addTagMapper(mapper)}),parser.push(xhr.responseText),parser.end(),parser.manifest.uri=url,parser.manifest.attributes=parser.manifest.attributes||{};var update=updateMaster(this.master,parser.manifest);this.targetDuration=parser.manifest.targetDuration,update?(this.master=update,this.media_=this.master.playlists[parser.manifest.uri]):this.trigger("playlistunchanged"),this.media().endList||(window_1.clearTimeout(this.mediaUpdateTimeout),this.mediaUpdateTimeout=window_1.setTimeout(function(){_this2.trigger("mediaupdatetimeout")},refreshDelay(this.media(),!!update))),this.trigger("loadedplaylist")}},{key:"dispose",value:function(){this.stopRequest(),window_1.clearTimeout(this.mediaUpdateTimeout),window_1.clearTimeout(this.finalRenditionTimeout)}},{key:"stopRequest",value:function(){if(this.request){var oldRequest=this.request;this.request=null,oldRequest.onreadystatechange=null,oldRequest.abort()}}},{key:"media",value:function(playlist,isFinalRendition){var _this3=this;if(!playlist)return this.media_;if("HAVE_NOTHING"===this.state)throw new Error("Cannot switch media playlist from "+this.state);if("string"==typeof playlist){if(!this.master.playlists[playlist])throw new Error("Unknown playlist URI: "+playlist);playlist=this.master.playlists[playlist]}if(window_1.clearTimeout(this.finalRenditionTimeout),isFinalRendition){var delay=playlist.targetDuration/2*1e3||5e3;return void(this.finalRenditionTimeout=window_1.setTimeout(this.media.bind(this,playlist,!1),delay))}var startingState=this.state,mediaChange=!this.media_||playlist.uri!==this.media_.uri;if(this.master.playlists[playlist.uri].endList)return this.request&&(this.request.onreadystatechange=null,this.request.abort(),this.request=null),this.state="HAVE_METADATA",this.media_=playlist,void(mediaChange&&(this.trigger("mediachanging"),this.trigger("mediachange")));if(mediaChange){if(this.state="SWITCHING_MEDIA",this.request){if(playlist.resolvedUri===this.request.url)return;this.request.onreadystatechange=null,this.request.abort(),this.request=null}this.media_&&this.trigger("mediachanging"),this.request=this.hls_.xhr({uri:playlist.resolvedUri,withCredentials:this.withCredentials},function(error,req){if(_this3.request){if(playlist.resolvedUri=resolveManifestRedirect(_this3.handleManifestRedirects,playlist.resolvedUri,req),error)return _this3.playlistRequestError(_this3.request,playlist.uri,startingState);_this3.haveMetadata(req,playlist.uri),"HAVE_MASTER"===startingState?_this3.trigger("loadedmetadata"):_this3.trigger("mediachange")}})}}},{key:"pause",value:function(){this.stopRequest(),window_1.clearTimeout(this.mediaUpdateTimeout),"HAVE_NOTHING"===this.state&&(this.started=!1),"SWITCHING_MEDIA"===this.state?this.media_?this.state="HAVE_METADATA":this.state="HAVE_MASTER":"HAVE_CURRENT_METADATA"===this.state&&(this.state="HAVE_METADATA")}},{key:"load",value:function(isFinalRendition){var _this4=this;window_1.clearTimeout(this.mediaUpdateTimeout);var media=this.media();if(isFinalRendition){var delay=media?media.targetDuration/2*1e3:5e3;return void(this.mediaUpdateTimeout=window_1.setTimeout(function(){return _this4.load()},delay))}if(!this.started)return void this.start();media&&!media.endList?this.trigger("mediaupdatetimeout"):this.trigger("loadedplaylist")}},{key:"start",value:function(){var _this5=this;this.started=!0,this.request=this.hls_.xhr({uri:this.srcUrl,withCredentials:this.withCredentials},function(error,req){if(_this5.request){if(_this5.request=null,error)return _this5.error={status:req.status,message:"HLS playlist request error at URL: "+_this5.srcUrl+".",responseText:req.responseText,code:2},"HAVE_NOTHING"===_this5.state&&(_this5.started=!1),_this5.trigger("error");var parser=new Parser;return _this5.customTagParsers.forEach(function(customParser){return parser.addParser(customParser)}),(_this5.customTagMappers.forEach(function(mapper){return parser.addTagMapper(mapper)}),parser.push(req.responseText),parser.end(),_this5.state="HAVE_MASTER",_this5.srcUrl=resolveManifestRedirect(_this5.handleManifestRedirects,_this5.srcUrl,req),parser.manifest.uri=_this5.srcUrl,parser.manifest.playlists)?(_this5.master=parser.manifest,setupMediaPlaylists(_this5.master),resolveMediaGroupUris(_this5.master),_this5.trigger("loadedplaylist"),void(_this5.request||_this5.media(parser.manifest.playlists[0]))):(_this5.master={mediaGroups:{AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},uri:window_1.location.href,playlists:[{uri:_this5.srcUrl,id:0,resolvedUri:_this5.srcUrl,attributes:{}}]},_this5.master.playlists[_this5.srcUrl]=_this5.master.playlists[0],_this5.haveMetadata(req,_this5.srcUrl),_this5.trigger("loadedmetadata"))}})}}]),PlaylistLoader}(EventTarget),createTimeRange=videojs.createTimeRange,backwardDuration=function(playlist,endSequence){var result=0,i=endSequence-playlist.mediaSequence,segment=playlist.segments[i];if(segment){if(void 0!==segment.start)return{result:segment.start,precise:!0};if(void 0!==segment.end)return{result:segment.end-segment.duration,precise:!0}}for(;i--;){if(segment=playlist.segments[i],void 0!==segment.end)return{result:result+segment.end,precise:!0};if(result+=segment.duration,void 0!==segment.start)return{result:result+segment.start,precise:!0}}return{result:result,precise:!1}},forwardDuration=function(playlist,endSequence){for(var result=0,segment=void 0,i=endSequence-playlist.mediaSequence;i<playlist.segments.length;i++){if(segment=playlist.segments[i],void 0!==segment.start)return{result:segment.start-result,precise:!0};if(result+=segment.duration,void 0!==segment.end)return{result:segment.end-result,precise:!0}}return{result:-1,precise:!1}},intervalDuration=function(playlist,endSequence,expired){var backward=void 0,forward=void 0;return void 0===endSequence&&(endSequence=playlist.mediaSequence+playlist.segments.length),endSequence<playlist.mediaSequence?0:(backward=backwardDuration(playlist,endSequence),backward.precise?backward.result:(forward=forwardDuration(playlist,endSequence),forward.precise?forward.result:backward.result+expired))},duration=function(playlist,endSequence,expired){if(!playlist)return 0;if("number"!=typeof expired&&(expired=0),void 0===endSequence){if(playlist.totalDuration)return playlist.totalDuration;if(!playlist.endList)return window_1.Infinity}return intervalDuration(playlist,endSequence,expired)},sumDurations=function(playlist,startIndex,endIndex){var durations=0;if(startIndex>endIndex){var _ref=[endIndex,startIndex];startIndex=_ref[0],endIndex=_ref[1]}if(startIndex<0){
for(var i=startIndex;i<Math.min(0,endIndex);i++)durations+=playlist.targetDuration;startIndex=0}for(var _i=startIndex;_i<endIndex;_i++)durations+=playlist.segments[_i].duration;return durations},safeLiveIndex=function(playlist){if(!playlist.segments.length)return 0;for(var i=playlist.segments.length-1,distanceFromEnd=playlist.segments[i].duration||playlist.targetDuration,safeDistance=distanceFromEnd+2*playlist.targetDuration;i--&&!((distanceFromEnd+=playlist.segments[i].duration)>=safeDistance););return Math.max(0,i)},playlistEnd=function(playlist,expired,useSafeLiveEnd){if(!playlist||!playlist.segments)return null;if(playlist.endList)return duration(playlist);if(null===expired)return null;expired=expired||0;var endSequence=useSafeLiveEnd?safeLiveIndex(playlist):playlist.segments.length;return intervalDuration(playlist,playlist.mediaSequence+endSequence,expired)},seekable=function(playlist,expired){var seekableStart=expired||0,seekableEnd=playlistEnd(playlist,expired,!0);return null===seekableEnd?createTimeRange():createTimeRange(seekableStart,seekableEnd)},isWholeNumber=function(num){return num-Math.floor(num)==0},roundSignificantDigit=function(increment,num){if(isWholeNumber(num))return num+.1*increment;for(var numDecimalDigits=num.toString().split(".")[1].length,i=1;i<=numDecimalDigits;i++){var scale=Math.pow(10,i),temp=num*scale;if(isWholeNumber(temp)||i===numDecimalDigits)return(temp+increment)/scale}},ceilLeastSignificantDigit=roundSignificantDigit.bind(null,1),floorLeastSignificantDigit=roundSignificantDigit.bind(null,-1),getMediaInfoForTime=function(playlist,currentTime,startIndex,startTime){var i=void 0,segment=void 0,numSegments=playlist.segments.length,time=currentTime-startTime;if(time<0){if(startIndex>0)for(i=startIndex-1;i>=0;i--)if(segment=playlist.segments[i],(time+=floorLeastSignificantDigit(segment.duration))>0)return{mediaIndex:i,startTime:startTime-sumDurations(playlist,startIndex,i)};return{mediaIndex:0,startTime:currentTime}}if(startIndex<0){for(i=startIndex;i<0;i++)if((time-=playlist.targetDuration)<0)return{mediaIndex:0,startTime:currentTime};startIndex=0}for(i=startIndex;i<numSegments;i++)if(segment=playlist.segments[i],(time-=ceilLeastSignificantDigit(segment.duration))<0)return{mediaIndex:i,startTime:startTime+sumDurations(playlist,startIndex,i)};return{mediaIndex:numSegments-1,startTime:currentTime}},isBlacklisted=function(playlist){return playlist.excludeUntil&&playlist.excludeUntil>Date.now()},isIncompatible=function(playlist){return playlist.excludeUntil&&playlist.excludeUntil===1/0},isEnabled=function(playlist){var blacklisted=isBlacklisted(playlist);return!playlist.disabled&&!blacklisted},isDisabled=function(playlist){return playlist.disabled},isAes=function(media){for(var i=0;i<media.segments.length;i++)if(media.segments[i].key)return!0;return!1},isFmp4=function(media){for(var i=0;i<media.segments.length;i++)if(media.segments[i].map)return!0;return!1},hasAttribute=function(attr,playlist){return playlist.attributes&&playlist.attributes[attr]},estimateSegmentRequestTime=function(segmentDuration,bandwidth,playlist){var bytesReceived=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return hasAttribute("BANDWIDTH",playlist)?(segmentDuration*playlist.attributes.BANDWIDTH-8*bytesReceived)/bandwidth:NaN},isLowestEnabledRendition=function(master,media){if(1===master.playlists.length)return!0;var currentBandwidth=media.attributes.BANDWIDTH||Number.MAX_VALUE;return 0===master.playlists.filter(function(playlist){return!!isEnabled(playlist)&&(playlist.attributes.BANDWIDTH||0)<currentBandwidth}).length},Playlist={duration:duration,seekable:seekable,safeLiveIndex:safeLiveIndex,getMediaInfoForTime:getMediaInfoForTime,isEnabled:isEnabled,isDisabled:isDisabled,isBlacklisted:isBlacklisted,isIncompatible:isIncompatible,playlistEnd:playlistEnd,isAes:isAes,isFmp4:isFmp4,hasAttribute:hasAttribute,estimateSegmentRequestTime:estimateSegmentRequestTime,isLowestEnabledRendition:isLowestEnabledRendition},videojsXHR=videojs.xhr,mergeOptions$1=videojs.mergeOptions,xhrFactory=function(){return function XhrFunction(options,callback){options=mergeOptions$1({timeout:45e3},options);var beforeRequest=XhrFunction.beforeRequest||videojs.Hls.xhr.beforeRequest;if(beforeRequest&&"function"==typeof beforeRequest){var newOptions=beforeRequest(options);newOptions&&(options=newOptions)}var request=videojsXHR(options,function(error,response){var reqResponse=request.response;!error&&reqResponse&&(request.responseTime=Date.now(),request.roundTripTime=request.responseTime-request.requestTime,request.bytesReceived=reqResponse.byteLength||reqResponse.length,request.bandwidth||(request.bandwidth=Math.floor(request.bytesReceived/request.roundTripTime*8*1e3))),response.headers&&(request.responseHeaders=response.headers),error&&"ETIMEDOUT"===error.code&&(request.timedout=!0),error||request.aborted||200===response.statusCode||206===response.statusCode||0===response.statusCode||(error=new Error("XHR Failed with a response of: "+(request&&(reqResponse||request.responseText)))),callback(error,request)}),originalAbort=request.abort;return request.abort=function(){return request.aborted=!0,originalAbort.apply(request,arguments)},request.uri=options.uri,request.requestTime=Date.now(),request}},byterangeStr=function(byterange){var byterangeEnd=void 0;return byterangeEnd=byterange.offset+byterange.length-1,"bytes="+byterange.offset+"-"+byterangeEnd},segmentXhrHeaders=function(segment){var headers={};return segment.byterange&&(headers.Range=byterangeStr(segment.byterange)),headers};function unpad(padded){return padded.subarray(0,padded.byteLength-padded[padded.byteLength-1])}var classCallCheck$1=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass$1=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),inherits$1=function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)},possibleConstructorReturn$1=function(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call},precompute=function(){var tables=[[[],[],[],[],[]],[[],[],[],[],[]]],encTable=tables[0],decTable=tables[1],sbox=encTable[4],sboxInv=decTable[4],i=void 0,x=void 0,xInv=void 0,d=[],th=[],x2=void 0,x4=void 0,x8=void 0,s=void 0,tEnc=void 0,tDec=void 0;for(i=0;i<256;i++)th[(d[i]=i<<1^283*(i>>7))^i]=i;for(x=xInv=0;!sbox[x];x^=x2||1,xInv=th[xInv]||1)for(s=xInv^xInv<<1^xInv<<2^xInv<<3^xInv<<4,s=s>>8^255&s^99,sbox[x]=s,sboxInv[s]=x,x8=d[x4=d[x2=d[x]]],tDec=16843009*x8^65537*x4^257*x2^16843008*x,tEnc=257*d[s]^16843008*s,i=0;i<4;i++)encTable[i][x]=tEnc=tEnc<<24^tEnc>>>8,decTable[i][s]=tDec=tDec<<24^tDec>>>8;for(i=0;i<5;i++)encTable[i]=encTable[i].slice(0),decTable[i]=decTable[i].slice(0);return tables},aesTables=null,AES=function(){function AES(key){classCallCheck$1(this,AES),aesTables||(aesTables=precompute()),this._tables=[[aesTables[0][0].slice(),aesTables[0][1].slice(),aesTables[0][2].slice(),aesTables[0][3].slice(),aesTables[0][4].slice()],[aesTables[1][0].slice(),aesTables[1][1].slice(),aesTables[1][2].slice(),aesTables[1][3].slice(),aesTables[1][4].slice()]];var i=void 0,j=void 0,tmp=void 0,encKey=void 0,decKey=void 0,sbox=this._tables[0][4],decTable=this._tables[1],keyLen=key.length,rcon=1;if(4!==keyLen&&6!==keyLen&&8!==keyLen)throw new Error("Invalid aes key size");for(encKey=key.slice(0),decKey=[],this._key=[encKey,decKey],i=keyLen;i<4*keyLen+28;i++)tmp=encKey[i-1],(i%keyLen==0||8===keyLen&&i%keyLen==4)&&(tmp=sbox[tmp>>>24]<<24^sbox[tmp>>16&255]<<16^sbox[tmp>>8&255]<<8^sbox[255&tmp],i%keyLen==0&&(tmp=tmp<<8^tmp>>>24^rcon<<24,rcon=rcon<<1^283*(rcon>>7))),encKey[i]=encKey[i-keyLen]^tmp;for(j=0;i;j++,i--)tmp=encKey[3&j?i:i-4],decKey[j]=i<=4||j<4?tmp:decTable[0][sbox[tmp>>>24]]^decTable[1][sbox[tmp>>16&255]]^decTable[2][sbox[tmp>>8&255]]^decTable[3][sbox[255&tmp]]}return AES.prototype.decrypt=function(encrypted0,encrypted1,encrypted2,encrypted3,out,offset){var key=this._key[1],a=encrypted0^key[0],b=encrypted3^key[1],c=encrypted2^key[2],d=encrypted1^key[3],a2=void 0,b2=void 0,c2=void 0,nInnerRounds=key.length/4-2,i=void 0,kIndex=4,table=this._tables[1],table0=table[0],table1=table[1],table2=table[2],table3=table[3],sbox=table[4];for(i=0;i<nInnerRounds;i++)a2=table0[a>>>24]^table1[b>>16&255]^table2[c>>8&255]^table3[255&d]^key[kIndex],b2=table0[b>>>24]^table1[c>>16&255]^table2[d>>8&255]^table3[255&a]^key[kIndex+1],c2=table0[c>>>24]^table1[d>>16&255]^table2[a>>8&255]^table3[255&b]^key[kIndex+2],d=table0[d>>>24]^table1[a>>16&255]^table2[b>>8&255]^table3[255&c]^key[kIndex+3],kIndex+=4,a=a2,b=b2,c=c2;for(i=0;i<4;i++)out[(3&-i)+offset]=sbox[a>>>24]<<24^sbox[b>>16&255]<<16^sbox[c>>8&255]<<8^sbox[255&d]^key[kIndex++],a2=a,a=b,b=c,c=d,d=a2},AES}(),Stream$1=function(){function Stream(){classCallCheck$1(this,Stream),this.listeners={}}return Stream.prototype.on=function(type,listener){this.listeners[type]||(this.listeners[type]=[]),this.listeners[type].push(listener)},Stream.prototype.off=function(type,listener){if(!this.listeners[type])return!1;var index=this.listeners[type].indexOf(listener);return this.listeners[type].splice(index,1),index>-1},Stream.prototype.trigger=function(type){var callbacks=this.listeners[type];if(callbacks)if(2===arguments.length)for(var length=callbacks.length,i=0;i<length;++i)callbacks[i].call(this,arguments[1]);else for(var args=Array.prototype.slice.call(arguments,1),_length=callbacks.length,_i=0;_i<_length;++_i)callbacks[_i].apply(this,args)},Stream.prototype.dispose=function(){this.listeners={}},Stream.prototype.pipe=function(destination){this.on("data",function(data){destination.push(data)})},Stream}(),AsyncStream=function(_Stream){inherits$1(AsyncStream,_Stream);function AsyncStream(){classCallCheck$1(this,AsyncStream);var _this=possibleConstructorReturn$1(this,_Stream.call(this,Stream$1));return _this.jobs=[],_this.delay=1,_this.timeout_=null,_this}return AsyncStream.prototype.processJob_=function(){this.jobs.shift()(),this.jobs.length?this.timeout_=setTimeout(this.processJob_.bind(this),this.delay):this.timeout_=null},AsyncStream.prototype.push=function(job){this.jobs.push(job),this.timeout_||(this.timeout_=setTimeout(this.processJob_.bind(this),this.delay))},AsyncStream}(Stream$1),ntoh=function(word){return word<<24|(65280&word)<<8|(16711680&word)>>8|word>>>24},decrypt=function(encrypted,key,initVector){var encrypted32=new Int32Array(encrypted.buffer,encrypted.byteOffset,encrypted.byteLength>>2),decipher=new AES(Array.prototype.slice.call(key)),decrypted=new Uint8Array(encrypted.byteLength),decrypted32=new Int32Array(decrypted.buffer),init0=void 0,init1=void 0,init2=void 0,init3=void 0,encrypted0=void 0,encrypted1=void 0,encrypted2=void 0,encrypted3=void 0,wordIx=void 0;for(init0=initVector[0],init1=initVector[1],init2=initVector[2],init3=initVector[3],wordIx=0;wordIx<encrypted32.length;wordIx+=4)encrypted0=ntoh(encrypted32[wordIx]),encrypted1=ntoh(encrypted32[wordIx+1]),encrypted2=ntoh(encrypted32[wordIx+2]),encrypted3=ntoh(encrypted32[wordIx+3]),decipher.decrypt(encrypted0,encrypted1,encrypted2,encrypted3,decrypted32,wordIx),decrypted32[wordIx]=ntoh(decrypted32[wordIx]^init0),decrypted32[wordIx+1]=ntoh(decrypted32[wordIx+1]^init1),decrypted32[wordIx+2]=ntoh(decrypted32[wordIx+2]^init2),decrypted32[wordIx+3]=ntoh(decrypted32[wordIx+3]^init3),init0=encrypted0,init1=encrypted1,init2=encrypted2,init3=encrypted3;return decrypted},Decrypter=function(){function Decrypter(encrypted,key,initVector,done){classCallCheck$1(this,Decrypter);var step=Decrypter.STEP,encrypted32=new Int32Array(encrypted.buffer),decrypted=new Uint8Array(encrypted.byteLength),i=0;for(this.asyncStream_=new AsyncStream,this.asyncStream_.push(this.decryptChunk_(encrypted32.subarray(i,i+step),key,initVector,decrypted)),i=step;i<encrypted32.length;i+=step)initVector=new Uint32Array([ntoh(encrypted32[i-4]),ntoh(encrypted32[i-3]),ntoh(encrypted32[i-2]),ntoh(encrypted32[i-1])]),this.asyncStream_.push(this.decryptChunk_(encrypted32.subarray(i,i+step),key,initVector,decrypted));this.asyncStream_.push(function(){done(null,unpad(decrypted))})}return Decrypter.prototype.decryptChunk_=function(encrypted,key,initVector,decrypted){return function(){var bytes=decrypt(encrypted,key,initVector);decrypted.set(bytes,encrypted.byteOffset)}},createClass$1(Decrypter,null,[{key:"STEP",get:function(){return 32e3}}]),Decrypter}(),textRange=function(range,i){return range.start(i)+"-"+range.end(i)},formatHexString=function(e,i){var value=e.toString(16);return"00".substring(0,2-value.length)+value+(i%2?" ":"")},formatAsciiString=function(e){return e>=32&&e<126?String.fromCharCode(e):"."},createTransferableMessage=function(message){var transferable={};return Object.keys(message).forEach(function(key){var value=message[key];ArrayBuffer.isView(value)?transferable[key]={bytes:value.buffer,byteOffset:value.byteOffset,byteLength:value.byteLength}:transferable[key]=value}),transferable},initSegmentId=function(initSegment){var byterange=initSegment.byterange||{length:1/0,offset:0};return[byterange.length,byterange.offset,initSegment.resolvedUri].join(",")},segmentKeyId=function(key){return key.resolvedUri},hexDump=function(data){for(var bytes=Array.prototype.slice.call(data),result="",hex=void 0,ascii=void 0,j=0;j<bytes.length/16;j++)hex=bytes.slice(16*j,16*j+16).map(formatHexString).join(""),ascii=bytes.slice(16*j,16*j+16).map(formatAsciiString).join(""),result+=hex+" "+ascii+"\n";return result},tagDump=function(_ref){var bytes=_ref.bytes;return hexDump(bytes)},textRanges=function(ranges){var result="",i=void 0;for(i=0;i<ranges.length;i++)result+=textRange(ranges,i)+" ";return result},utils=Object.freeze({createTransferableMessage:createTransferableMessage,initSegmentId:initSegmentId,segmentKeyId:segmentKeyId,hexDump:hexDump,tagDump:tagDump,textRanges:textRanges}),playerTimeToProgramTime=function(playerTime,segment){if(!segment.dateTimeObject)return null;var transmuxerPrependedSeconds=segment.videoTimingInfo.transmuxerPrependedSeconds,transmuxedStart=segment.videoTimingInfo.transmuxedPresentationStart,startOfSegment=transmuxedStart+transmuxerPrependedSeconds,offsetFromSegmentStart=playerTime-startOfSegment;return new Date(segment.dateTimeObject.getTime()+1e3*offsetFromSegmentStart)},originalSegmentVideoDuration=function(videoTimingInfo){return videoTimingInfo.transmuxedPresentationEnd-videoTimingInfo.transmuxedPresentationStart-videoTimingInfo.transmuxerPrependedSeconds},findSegmentForProgramTime=function(programTime,playlist){var dateTimeObject=void 0;try{dateTimeObject=new Date(programTime)}catch(e){return null}if(!playlist||!playlist.segments||0===playlist.segments.length)return null;var segment=playlist.segments[0];if(dateTimeObject<segment.dateTimeObject)return null;for(var i=0;i<playlist.segments.length-1;i++){segment=playlist.segments[i];if(dateTimeObject<playlist.segments[i+1].dateTimeObject)break}var lastSegment=playlist.segments[playlist.segments.length-1],lastSegmentStart=lastSegment.dateTimeObject,lastSegmentDuration=lastSegment.videoTimingInfo?originalSegmentVideoDuration(lastSegment.videoTimingInfo):lastSegment.duration+.25*lastSegment.duration;return dateTimeObject>new Date(lastSegmentStart.getTime()+1e3*lastSegmentDuration)?null:(dateTimeObject>lastSegmentStart&&(segment=lastSegment),{segment:segment,estimatedStart:segment.videoTimingInfo?segment.videoTimingInfo.transmuxedPresentationStart:Playlist.duration(playlist,playlist.mediaSequence+playlist.segments.indexOf(segment)),type:segment.videoTimingInfo?"accurate":"estimate"})},findSegmentForPlayerTime=function(time,playlist){if(!playlist||!playlist.segments||0===playlist.segments.length)return null;for(var segmentEnd=0,segment=void 0,i=0;i<playlist.segments.length&&(segment=playlist.segments[i],segmentEnd=segment.videoTimingInfo?segment.videoTimingInfo.transmuxedPresentationEnd:segmentEnd+segment.duration,!(time<=segmentEnd));i++);var lastSegment=playlist.segments[playlist.segments.length-1];if(lastSegment.videoTimingInfo&&lastSegment.videoTimingInfo.transmuxedPresentationEnd<time)return null;if(time>segmentEnd){if(time>segmentEnd+.25*lastSegment.duration)return null;segment=lastSegment}return{segment:segment,estimatedStart:segment.videoTimingInfo?segment.videoTimingInfo.transmuxedPresentationStart:segmentEnd-segment.duration,type:segment.videoTimingInfo?"accurate":"estimate"}},getOffsetFromTimestamp=function(comparisonTimeStamp,programTime){var segmentDateTime=void 0,programDateTime=void 0;try{segmentDateTime=new Date(comparisonTimeStamp),programDateTime=new Date(programTime)}catch(e){}var segmentTimeEpoch=segmentDateTime.getTime();return(programDateTime.getTime()-segmentTimeEpoch)/1e3},verifyProgramDateTimeTags=function(playlist){if(!playlist.segments||0===playlist.segments.length)return!1;for(var i=0;i<playlist.segments.length;i++){if(!playlist.segments[i].dateTimeObject)return!1}return!0},getProgramTime=function(_ref){var playlist=_ref.playlist,_ref$time=_ref.time,time=void 0===_ref$time?void 0:_ref$time,callback=_ref.callback;if(!callback)throw new Error("getProgramTime: callback must be provided");if(!playlist||void 0===time)return callback({message:"getProgramTime: playlist and time must be provided"});var matchedSegment=findSegmentForPlayerTime(time,playlist);if(!matchedSegment)return callback({message:"valid programTime was not found"});if("estimate"===matchedSegment.type)return callback({message:"Accurate programTime could not be determined. Please seek to e.seekTime and try again",seekTime:matchedSegment.estimatedStart});var programTimeObject={mediaSeconds:time},programTime=playerTimeToProgramTime(time,matchedSegment.segment);return programTime&&(programTimeObject.programDateTime=programTime.toISOString()),callback(null,programTimeObject)},seekToProgramTime=function seekToProgramTime(_ref2){var programTime=_ref2.programTime,playlist=_ref2.playlist,_ref2$retryCount=_ref2.retryCount,retryCount=void 0===_ref2$retryCount?2:_ref2$retryCount,seekTo=_ref2.seekTo,_ref2$pauseAfterSeek=_ref2.pauseAfterSeek,pauseAfterSeek=void 0===_ref2$pauseAfterSeek||_ref2$pauseAfterSeek,tech=_ref2.tech,callback=_ref2.callback;if(!callback)throw new Error("seekToProgramTime: callback must be provided");if(void 0===programTime||!playlist||!seekTo)return callback({message:"seekToProgramTime: programTime, seekTo and playlist must be provided"});if(!playlist.endList&&!tech.hasStarted_)return callback({message:"player must be playing a live stream to start buffering"});if(!verifyProgramDateTimeTags(playlist))return callback({message:"programDateTime tags must be provided in the manifest "+playlist.resolvedUri});var matchedSegment=findSegmentForProgramTime(programTime,playlist);if(!matchedSegment)return callback({message:programTime+" was not found in the stream"});var segment=matchedSegment.segment,mediaOffset=getOffsetFromTimestamp(segment.dateTimeObject,programTime);if("estimate"===matchedSegment.type)return 0===retryCount?callback({message:programTime+" is not buffered yet. Try again"}):(seekTo(matchedSegment.estimatedStart+mediaOffset),void tech.one("seeked",function(){seekToProgramTime({programTime:programTime,playlist:playlist,retryCount:retryCount-1,seekTo:seekTo,pauseAfterSeek:pauseAfterSeek,tech:tech,callback:callback})}));var seekToTime=segment.start+mediaOffset,seekedCallback=function(){return callback(null,tech.currentTime())};tech.one("seeked",seekedCallback),pauseAfterSeek&&tech.pause(),seekTo(seekToTime)},filterRanges=function(timeRanges,predicate){var results=[],i=void 0;if(timeRanges&&timeRanges.length)for(i=0;i<timeRanges.length;i++)predicate(timeRanges.start(i),timeRanges.end(i))&&results.push([timeRanges.start(i),timeRanges.end(i)]);return videojs.createTimeRanges(results)},findRange=function(buffered,time){return filterRanges(buffered,function(start,end){return start-.1<=time&&end+.1>=time})},findNextRange=function(timeRanges,time){return filterRanges(timeRanges,function(start){return start-1/30>=time})},findGaps=function(buffered){if(buffered.length<2)return videojs.createTimeRanges();for(var ranges=[],i=1;i<buffered.length;i++){var start=buffered.end(i-1),end=buffered.start(i);ranges.push([start,end])}return videojs.createTimeRanges(ranges)},printableRange=function(range){var strArr=[];if(!range||!range.length)return"";for(var i=0;i<range.length;i++)strArr.push(range.start(i)+" => "+range.end(i));return strArr.join(", ")},timeUntilRebuffer=function(buffered,currentTime){var playbackRate=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return((buffered.length?buffered.end(buffered.length-1):0)-currentTime)/playbackRate},timeRangesToArray=function(timeRanges){for(var timeRangesList=[],i=0;i<timeRanges.length;i++)timeRangesList.push({start:timeRanges.start(i),end:timeRanges.end(i)});return timeRangesList},createTextTracksIfNecessary=function(sourceBuffer,mediaSource,segment){var player=mediaSource.player_;if(segment.captions&&segment.captions.length){sourceBuffer.inbandTextTracks_||(sourceBuffer.inbandTextTracks_={});for(var trackId in segment.captionStreams)if(!sourceBuffer.inbandTextTracks_[trackId]){player.tech_.trigger({type:"usage",name:"hls-608"});var track=player.textTracks().getTrackById(trackId);sourceBuffer.inbandTextTracks_[trackId]=track||player.addRemoteTextTrack({kind:"captions",id:trackId,label:trackId},!1).track}}segment.metadata&&segment.metadata.length&&!sourceBuffer.metadataTrack_&&(sourceBuffer.metadataTrack_=player.addRemoteTextTrack({kind:"metadata",label:"Timed Metadata"},!1).track,sourceBuffer.metadataTrack_.inBandMetadataTrackDispatchType=segment.metadata.dispatchType)},removeCuesFromTrack=function(start,end,track){var i=void 0,cue=void 0;if(track&&track.cues)for(i=track.cues.length;i--;)cue=track.cues[i],cue.startTime<=end&&cue.endTime>=start&&track.removeCue(cue)},deprecateOldCue=function(cue){Object.defineProperties(cue.frame,{id:{get:function(){return videojs.log.warn("cue.frame.id is deprecated. Use cue.value.key instead."),cue.value.key}},value:{get:function(){return videojs.log.warn("cue.frame.value is deprecated. Use cue.value.data instead."),cue.value.data}},privateData:{get:function(){return videojs.log.warn("cue.frame.privateData is deprecated. Use cue.value.data instead."),cue.value.data}}})},durationOfVideo=function(duration){return isNaN(duration)||Math.abs(duration)===1/0?Number.MAX_VALUE:duration},addTextTrackData=function(sourceHandler,captionArray,metadataArray){var Cue=window_1.WebKitDataCue||window_1.VTTCue;if(captionArray&&captionArray.forEach(function(caption){var track=caption.stream;this.inbandTextTracks_[track].addCue(new Cue(caption.startTime+this.timestampOffset,caption.endTime+this.timestampOffset,caption.text))},sourceHandler),metadataArray){var videoDuration=durationOfVideo(sourceHandler.mediaSource_.duration);if(metadataArray.forEach(function(metadata){var time=metadata.cueTime+this.timestampOffset;!("number"!=typeof time||window_1.isNaN(time)||time<0)&&time<1/0&&metadata.frames.forEach(function(frame){var cue=new Cue(time,time,frame.value||frame.url||frame.data||"");cue.frame=frame,cue.value=frame,deprecateOldCue(cue),this.metadataTrack_.addCue(cue)},this)},sourceHandler),sourceHandler.metadataTrack_&&sourceHandler.metadataTrack_.cues&&sourceHandler.metadataTrack_.cues.length){for(var cues=sourceHandler.metadataTrack_.cues,cuesArray=[],i=0;i<cues.length;i++)cues[i]&&cuesArray.push(cues[i]);var cuesGroupedByStartTime=cuesArray.reduce(function(obj,cue){var timeSlot=obj[cue.startTime]||[];return timeSlot.push(cue),obj[cue.startTime]=timeSlot,obj},{}),sortedStartTimes=Object.keys(cuesGroupedByStartTime).sort(function(a,b){return Number(a)-Number(b)});sortedStartTimes.forEach(function(startTime,idx){var cueGroup=cuesGroupedByStartTime[startTime],nextTime=Number(sortedStartTimes[idx+1])||videoDuration;cueGroup.forEach(function(cue){cue.endTime=nextTime})})}}},win$1="undefined"!=typeof window?window:{},TARGET="undefined"==typeof Symbol?"__target":Symbol(),SCRIPT_TYPE="application/javascript",BlobBuilder=win$1.BlobBuilder||win$1.WebKitBlobBuilder||win$1.MozBlobBuilder||win$1.MSBlobBuilder,URL=win$1.URL||win$1.webkitURL||URL&&URL.msURL,Worker=win$1.Worker;function shimWorker(filename,fn){return function(forceFallback){var o=this;if(!fn)return new Worker(filename);if(Worker&&!forceFallback){var source=fn.toString().replace(/^function.+?{/,"").slice(0,-1),objURL=createSourceObject(source);return this[TARGET]=new Worker(objURL),wrapTerminate(this[TARGET],objURL),this[TARGET]}var selfShim={postMessage:function(m){o.onmessage&&setTimeout(function(){o.onmessage({data:m,target:selfShim})})}};fn.call(selfShim),this.postMessage=function(m){setTimeout(function(){selfShim.onmessage({data:m,target:o})})},this.isThisThread=!0}}if(Worker){var testWorker,objURL=createSourceObject("self.onmessage = function () {}"),testArray=new Uint8Array(1);try{testWorker=new Worker(objURL),testWorker.postMessage(testArray,[testArray.buffer])}catch(e){Worker=null}finally{URL.revokeObjectURL(objURL),testWorker&&testWorker.terminate()}}function createSourceObject(str){try{return URL.createObjectURL(new Blob([str],{type:SCRIPT_TYPE}))}catch(e){var blob=new BlobBuilder;return blob.append(str),URL.createObjectURL(blob.getBlob(type))}}function wrapTerminate(worker,objURL){if(worker&&objURL){var term=worker.terminate;worker.objURL=objURL,worker.terminate=function(){worker.objURL&&URL.revokeObjectURL(worker.objURL),term.call(worker)}}}var TransmuxWorker=new shimWorker("./transmuxer-worker.worker.js",function(window,document){var self=this;!function(){var Stream=function(){this.init=function(){var listeners={};this.on=function(type,listener){listeners[type]||(listeners[type]=[]),listeners[type]=listeners[type].concat(listener)},this.off=function(type,listener){var index;return!!listeners[type]&&(index=listeners[type].indexOf(listener),listeners[type]=listeners[type].slice(),listeners[type].splice(index,1),index>-1)},this.trigger=function(type){var callbacks,i,length,args;if(callbacks=listeners[type])if(2===arguments.length)for(length=callbacks.length,i=0;i<length;++i)callbacks[i].call(this,arguments[1]);else{for(args=[],i=arguments.length,i=1;i<arguments.length;++i)args.push(arguments[i]);for(length=callbacks.length,i=0;i<length;++i)callbacks[i].apply(this,args)}},this.dispose=function(){listeners={}}}};Stream.prototype.pipe=function(destination){return this.on("data",function(data){destination.push(data)}),this.on("done",function(flushSource){destination.flush(flushSource)}),this.on("partialdone",function(flushSource){destination.partialFlush(flushSource)}),this.on("endedtimeline",function(flushSource){destination.endTimeline(flushSource)}),this.on("reset",function(flushSource){destination.reset(flushSource)}),destination},Stream.prototype.push=function(data){this.trigger("data",data)},Stream.prototype.flush=function(flushSource){this.trigger("done",flushSource)},Stream.prototype.partialFlush=function(flushSource){this.trigger("partialdone",flushSource)},Stream.prototype.endTimeline=function(flushSource){this.trigger("endedtimeline",flushSource)},Stream.prototype.reset=function(flushSource){this.trigger("reset",flushSource)};var box,dinf,esds,ftyp,mdat,mfhd,minf,moof,moov,mvex,mvhd,trak,tkhd,mdia,mdhd,hdlr,sdtp,stbl,stsd,traf,trex,trun,types,MAJOR_BRAND,MINOR_VERSION,AVC1_BRAND,VIDEO_HDLR,AUDIO_HDLR,HDLR_TYPES,VMHD,SMHD,DREF,STCO,STSC,STSZ,STTS,stream=Stream,UINT32_MAX=Math.pow(2,32)-1;!function(){var i;if(types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],pasp:[],sdtp:[],smhd:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],styp:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[]},"undefined"!=typeof Uint8Array){for(i in types)types.hasOwnProperty(i)&&(types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]);MAJOR_BRAND=new Uint8Array(["i".charCodeAt(0),"s".charCodeAt(0),"o".charCodeAt(0),"m".charCodeAt(0)]),AVC1_BRAND=new Uint8Array(["a".charCodeAt(0),"v".charCodeAt(0),"c".charCodeAt(0),"1".charCodeAt(0)]),MINOR_VERSION=new Uint8Array([0,0,0,1]),VIDEO_HDLR=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),AUDIO_HDLR=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]),HDLR_TYPES={video:VIDEO_HDLR,audio:AUDIO_HDLR},DREF=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),STCO=new Uint8Array([0,0,0,0,0,0,0,0]),STSC=STCO,STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),STTS=STCO,VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])}}(),box=function(type){var i,result,view,payload=[],size=0;for(i=1;i<arguments.length;i++)payload.push(arguments[i]);for(i=payload.length;i--;)size+=payload[i].byteLength;for(result=new Uint8Array(size+8),view=new DataView(result.buffer,result.byteOffset,result.byteLength),view.setUint32(0,result.byteLength),result.set(type,4),i=0,size=8;i<payload.length;i++)result.set(payload[i],size),size+=payload[i].byteLength;return result},dinf=function(){return box(types.dinf,box(types.dref,DREF))},esds=function(track){return box(types.esds,new Uint8Array([0,0,0,0,3,25,0,0,0,4,17,64,21,0,6,0,0,0,218,192,0,0,218,192,5,2,track.audioobjecttype<<3|track.samplingfrequencyindex>>>1,track.samplingfrequencyindex<<7|track.channelcount<<3,6,1,2]))},ftyp=function(){return box(types.ftyp,MAJOR_BRAND,MINOR_VERSION,MAJOR_BRAND,AVC1_BRAND)},hdlr=function(type){return box(types.hdlr,HDLR_TYPES[type])},mdat=function(data){return box(types.mdat,data)},mdhd=function(track){var result=new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,0,1,95,144,track.duration>>>24&255,track.duration>>>16&255,track.duration>>>8&255,255&track.duration,85,196,0,0]);return track.samplerate&&(result[12]=track.samplerate>>>24&255,result[13]=track.samplerate>>>16&255,result[14]=track.samplerate>>>8&255,result[15]=255&track.samplerate),box(types.mdhd,result)},mdia=function(track){return box(types.mdia,mdhd(track),hdlr(track.type),minf(track))},mfhd=function(sequenceNumber){return box(types.mfhd,new Uint8Array([0,0,0,0,(4278190080&sequenceNumber)>>24,(16711680&sequenceNumber)>>16,(65280&sequenceNumber)>>8,255&sequenceNumber]))},minf=function(track){return box(types.minf,"video"===track.type?box(types.vmhd,VMHD):box(types.smhd,SMHD),dinf(),stbl(track))},moof=function(sequenceNumber,tracks){for(var trackFragments=[],i=tracks.length;i--;)trackFragments[i]=traf(tracks[i]);return box.apply(null,[types.moof,mfhd(sequenceNumber)].concat(trackFragments))},moov=function(tracks){for(var i=tracks.length,boxes=[];i--;)boxes[i]=trak(tracks[i]);return box.apply(null,[types.moov,mvhd(4294967295)].concat(boxes).concat(mvex(tracks)))},mvex=function(tracks){for(var i=tracks.length,boxes=[];i--;)boxes[i]=trex(tracks[i]);return box.apply(null,[types.mvex].concat(boxes))},mvhd=function(duration){
var bytes=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,0,1,95,144,(4278190080&duration)>>24,(16711680&duration)>>16,(65280&duration)>>8,255&duration,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return box(types.mvhd,bytes)},sdtp=function(track){var flags,i,samples=track.samples||[],bytes=new Uint8Array(4+samples.length);for(i=0;i<samples.length;i++)flags=samples[i].flags,bytes[i+4]=flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy;return box(types.sdtp,bytes)},stbl=function(track){return box(types.stbl,stsd(track),box(types.stts,STTS),box(types.stsc,STSC),box(types.stsz,STSZ),box(types.stco,STCO))},function(){var videoSample,audioSample;stsd=function(track){return box(types.stsd,new Uint8Array([0,0,0,0,0,0,0,1]),"video"===track.type?videoSample(track):audioSample(track))},videoSample=function(track){var i,avc1Box,sps=track.sps||[],pps=track.pps||[],sequenceParameterSets=[],pictureParameterSets=[];for(i=0;i<sps.length;i++)sequenceParameterSets.push((65280&sps[i].byteLength)>>>8),sequenceParameterSets.push(255&sps[i].byteLength),sequenceParameterSets=sequenceParameterSets.concat(Array.prototype.slice.call(sps[i]));for(i=0;i<pps.length;i++)pictureParameterSets.push((65280&pps[i].byteLength)>>>8),pictureParameterSets.push(255&pps[i].byteLength),pictureParameterSets=pictureParameterSets.concat(Array.prototype.slice.call(pps[i]));if(avc1Box=[types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,(65280&track.width)>>8,255&track.width,(65280&track.height)>>8,255&track.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,19,118,105,100,101,111,106,115,45,99,111,110,116,114,105,98,45,104,108,115,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),box(types.avcC,new Uint8Array([1,track.profileIdc,track.profileCompatibility,track.levelIdc,255].concat([sps.length],sequenceParameterSets,[pps.length],pictureParameterSets))),box(types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]))],track.sarRatio){var hSpacing=track.sarRatio[0],vSpacing=track.sarRatio[1];avc1Box.push(box(types.pasp,new Uint8Array([(4278190080&hSpacing)>>24,(16711680&hSpacing)>>16,(65280&hSpacing)>>8,255&hSpacing,(4278190080&vSpacing)>>24,(16711680&vSpacing)>>16,(65280&vSpacing)>>8,255&vSpacing])))}return box.apply(null,avc1Box)},audioSample=function(track){return box(types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,(65280&track.channelcount)>>8,255&track.channelcount,(65280&track.samplesize)>>8,255&track.samplesize,0,0,0,0,(65280&track.samplerate)>>8,255&track.samplerate,0,0]),esds(track))}}(),tkhd=function(track){var result=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,(4278190080&track.id)>>24,(16711680&track.id)>>16,(65280&track.id)>>8,255&track.id,0,0,0,0,(4278190080&track.duration)>>24,(16711680&track.duration)>>16,(65280&track.duration)>>8,255&track.duration,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,(65280&track.width)>>8,255&track.width,0,0,(65280&track.height)>>8,255&track.height,0,0]);return box(types.tkhd,result)},traf=function(track){var trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun,sampleDependencyTable,dataOffset,upperWordBaseMediaDecodeTime,lowerWordBaseMediaDecodeTime;return trackFragmentHeader=box(types.tfhd,new Uint8Array([0,0,0,58,(4278190080&track.id)>>24,(16711680&track.id)>>16,(65280&track.id)>>8,255&track.id,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0])),upperWordBaseMediaDecodeTime=Math.floor(track.baseMediaDecodeTime/(UINT32_MAX+1)),lowerWordBaseMediaDecodeTime=Math.floor(track.baseMediaDecodeTime%(UINT32_MAX+1)),trackFragmentDecodeTime=box(types.tfdt,new Uint8Array([1,0,0,0,upperWordBaseMediaDecodeTime>>>24&255,upperWordBaseMediaDecodeTime>>>16&255,upperWordBaseMediaDecodeTime>>>8&255,255&upperWordBaseMediaDecodeTime,lowerWordBaseMediaDecodeTime>>>24&255,lowerWordBaseMediaDecodeTime>>>16&255,lowerWordBaseMediaDecodeTime>>>8&255,255&lowerWordBaseMediaDecodeTime])),dataOffset=92,"audio"===track.type?(trackFragmentRun=trun(track,dataOffset),box(types.traf,trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun)):(sampleDependencyTable=sdtp(track),trackFragmentRun=trun(track,sampleDependencyTable.length+dataOffset),box(types.traf,trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun,sampleDependencyTable))},trak=function(track){return track.duration=track.duration||4294967295,box(types.trak,tkhd(track),mdia(track))},trex=function(track){var result=new Uint8Array([0,0,0,0,(4278190080&track.id)>>24,(16711680&track.id)>>16,(65280&track.id)>>8,255&track.id,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return"video"!==track.type&&(result[result.length-1]=0),box(types.trex,result)},function(){var audioTrun,videoTrun,trunHeader;trunHeader=function(samples,offset){var durationPresent=0,sizePresent=0,flagsPresent=0,compositionTimeOffset=0;return samples.length&&(void 0!==samples[0].duration&&(durationPresent=1),void 0!==samples[0].size&&(sizePresent=2),void 0!==samples[0].flags&&(flagsPresent=4),void 0!==samples[0].compositionTimeOffset&&(compositionTimeOffset=8)),[0,0,durationPresent|sizePresent|flagsPresent|compositionTimeOffset,1,(4278190080&samples.length)>>>24,(16711680&samples.length)>>>16,(65280&samples.length)>>>8,255&samples.length,(4278190080&offset)>>>24,(16711680&offset)>>>16,(65280&offset)>>>8,255&offset]},videoTrun=function(track,offset){var bytes,samples,sample,i;for(samples=track.samples||[],offset+=20+16*samples.length,bytes=trunHeader(samples,offset),i=0;i<samples.length;i++)sample=samples[i],bytes=bytes.concat([(4278190080&sample.duration)>>>24,(16711680&sample.duration)>>>16,(65280&sample.duration)>>>8,255&sample.duration,(4278190080&sample.size)>>>24,(16711680&sample.size)>>>16,(65280&sample.size)>>>8,255&sample.size,sample.flags.isLeading<<2|sample.flags.dependsOn,sample.flags.isDependedOn<<6|sample.flags.hasRedundancy<<4|sample.flags.paddingValue<<1|sample.flags.isNonSyncSample,61440&sample.flags.degradationPriority,15&sample.flags.degradationPriority,(4278190080&sample.compositionTimeOffset)>>>24,(16711680&sample.compositionTimeOffset)>>>16,(65280&sample.compositionTimeOffset)>>>8,255&sample.compositionTimeOffset]);return box(types.trun,new Uint8Array(bytes))},audioTrun=function(track,offset){var bytes,samples,sample,i;for(samples=track.samples||[],offset+=20+8*samples.length,bytes=trunHeader(samples,offset),i=0;i<samples.length;i++)sample=samples[i],bytes=bytes.concat([(4278190080&sample.duration)>>>24,(16711680&sample.duration)>>>16,(65280&sample.duration)>>>8,255&sample.duration,(4278190080&sample.size)>>>24,(16711680&sample.size)>>>16,(65280&sample.size)>>>8,255&sample.size]);return box(types.trun,new Uint8Array(bytes))},trun=function(track,offset){return"audio"===track.type?audioTrun(track,offset):videoTrun(track,offset)}}();var secondsToVideoTs,secondsToAudioTs,videoTsToSeconds,audioTsToSeconds,audioTsToVideoTs,videoTsToAudioTs,metadataTsToSeconds,mp4Generator={ftyp:ftyp,mdat:mdat,moof:moof,moov:moov,initSegment:function(tracks){var result,fileType=ftyp(),movie=moov(tracks);return result=new Uint8Array(fileType.byteLength+movie.byteLength),result.set(fileType),result.set(movie,fileType.byteLength),result}},groupNalsIntoFrames=function(nalUnits){var i,currentNal,currentFrame=[],frames=[];for(frames.byteLength=0,frames.nalCount=0,frames.duration=0,currentFrame.byteLength=0,i=0;i<nalUnits.length;i++)currentNal=nalUnits[i],"access_unit_delimiter_rbsp"===currentNal.nalUnitType?(currentFrame.length&&(currentFrame.duration=currentNal.dts-currentFrame.dts,frames.byteLength+=currentFrame.byteLength,frames.nalCount+=currentFrame.length,frames.duration+=currentFrame.duration,frames.push(currentFrame)),currentFrame=[currentNal],currentFrame.byteLength=currentNal.data.byteLength,currentFrame.pts=currentNal.pts,currentFrame.dts=currentNal.dts):("slice_layer_without_partitioning_rbsp_idr"===currentNal.nalUnitType&&(currentFrame.keyFrame=!0),currentFrame.duration=currentNal.dts-currentFrame.dts,currentFrame.byteLength+=currentNal.data.byteLength,currentFrame.push(currentNal));return frames.length&&(!currentFrame.duration||currentFrame.duration<=0)&&(currentFrame.duration=frames[frames.length-1].duration),frames.byteLength+=currentFrame.byteLength,frames.nalCount+=currentFrame.length,frames.duration+=currentFrame.duration,frames.push(currentFrame),frames},groupFramesIntoGops=function(frames){var i,currentFrame,currentGop=[],gops=[];for(currentGop.byteLength=0,currentGop.nalCount=0,currentGop.duration=0,currentGop.pts=frames[0].pts,currentGop.dts=frames[0].dts,gops.byteLength=0,gops.nalCount=0,gops.duration=0,gops.pts=frames[0].pts,gops.dts=frames[0].dts,i=0;i<frames.length;i++)currentFrame=frames[i],currentFrame.keyFrame?(currentGop.length&&(gops.push(currentGop),gops.byteLength+=currentGop.byteLength,gops.nalCount+=currentGop.nalCount,gops.duration+=currentGop.duration),currentGop=[currentFrame],currentGop.nalCount=currentFrame.length,currentGop.byteLength=currentFrame.byteLength,currentGop.pts=currentFrame.pts,currentGop.dts=currentFrame.dts,currentGop.duration=currentFrame.duration):(currentGop.duration+=currentFrame.duration,currentGop.nalCount+=currentFrame.length,currentGop.byteLength+=currentFrame.byteLength,currentGop.push(currentFrame));return gops.length&&currentGop.duration<=0&&(currentGop.duration=gops[gops.length-1].duration),gops.byteLength+=currentGop.byteLength,gops.nalCount+=currentGop.nalCount,gops.duration+=currentGop.duration,gops.push(currentGop),gops},extendFirstKeyFrame=function(gops){var currentGop;return!gops[0][0].keyFrame&&gops.length>1&&(currentGop=gops.shift(),gops.byteLength-=currentGop.byteLength,gops.nalCount-=currentGop.nalCount,gops[0][0].dts=currentGop.dts,gops[0][0].pts=currentGop.pts,gops[0][0].duration+=currentGop.duration),gops},createDefaultSample=function(){return{size:0,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,degradationPriority:0,isNonSyncSample:1}}},sampleForFrame=function(frame,dataOffset){var sample=createDefaultSample();return sample.dataOffset=dataOffset,sample.compositionTimeOffset=frame.pts-frame.dts,sample.duration=frame.duration,sample.size=4*frame.length,sample.size+=frame.byteLength,frame.keyFrame&&(sample.flags.dependsOn=2,sample.flags.isNonSyncSample=0),sample},generateSampleTable=function(gops,baseDataOffset){var h,i,sample,currentGop,currentFrame,dataOffset=baseDataOffset||0,samples=[];for(h=0;h<gops.length;h++)for(currentGop=gops[h],i=0;i<currentGop.length;i++)currentFrame=currentGop[i],sample=sampleForFrame(currentFrame,dataOffset),dataOffset+=sample.size,samples.push(sample);return samples},concatenateNalData=function(gops){var h,i,j,currentGop,currentFrame,currentNal,dataOffset=0,nalsByteLength=gops.byteLength,numberOfNals=gops.nalCount,totalByteLength=nalsByteLength+4*numberOfNals,data=new Uint8Array(totalByteLength),view=new DataView(data.buffer);for(h=0;h<gops.length;h++)for(currentGop=gops[h],i=0;i<currentGop.length;i++)for(currentFrame=currentGop[i],j=0;j<currentFrame.length;j++)currentNal=currentFrame[j],view.setUint32(dataOffset,currentNal.data.byteLength),dataOffset+=4,data.set(currentNal.data,dataOffset),dataOffset+=currentNal.data.byteLength;return data},generateSampleTableForFrame=function(frame,baseDataOffset){var sample,dataOffset=baseDataOffset||0,samples=[];return sample=sampleForFrame(frame,dataOffset),samples.push(sample),samples},concatenateNalDataForFrame=function(frame){var i,currentNal,dataOffset=0,nalsByteLength=frame.byteLength,numberOfNals=frame.length,totalByteLength=nalsByteLength+4*numberOfNals,data=new Uint8Array(totalByteLength),view=new DataView(data.buffer);for(i=0;i<frame.length;i++)currentNal=frame[i],view.setUint32(dataOffset,currentNal.data.byteLength),dataOffset+=4,data.set(currentNal.data,dataOffset),dataOffset+=currentNal.data.byteLength;return data},frameUtils={groupNalsIntoFrames:groupNalsIntoFrames,groupFramesIntoGops:groupFramesIntoGops,extendFirstKeyFrame:extendFirstKeyFrame,generateSampleTable:generateSampleTable,concatenateNalData:concatenateNalData,generateSampleTableForFrame:generateSampleTableForFrame,concatenateNalDataForFrame:concatenateNalDataForFrame},highPrefix=[33,16,5,32,164,27],lowPrefix=[33,65,108,84,1,2,4,8,168,2,4,8,17,191,252],zeroFill=function(count){for(var a=[];count--;)a.push(0);return a},coneOfSilence={96e3:[highPrefix,[227,64],zeroFill(154),[56]],88200:[highPrefix,[231],zeroFill(170),[56]],64e3:[highPrefix,[248,192],zeroFill(240),[56]],48e3:[highPrefix,[255,192],zeroFill(268),[55,148,128],zeroFill(54),[112]],44100:[highPrefix,[255,192],zeroFill(268),[55,163,128],zeroFill(84),[112]],32e3:[highPrefix,[255,192],zeroFill(268),[55,234],zeroFill(226),[112]],24e3:[highPrefix,[255,192],zeroFill(268),[55,255,128],zeroFill(268),[111,112],zeroFill(126),[224]],16e3:[highPrefix,[255,192],zeroFill(268),[55,255,128],zeroFill(268),[111,255],zeroFill(269),[223,108],zeroFill(195),[1,192]],12e3:[lowPrefix,zeroFill(268),[3,127,248],zeroFill(268),[6,255,240],zeroFill(268),[13,255,224],zeroFill(268),[27,253,128],zeroFill(259),[56]],11025:[lowPrefix,zeroFill(268),[3,127,248],zeroFill(268),[6,255,240],zeroFill(268),[13,255,224],zeroFill(268),[27,255,192],zeroFill(268),[55,175,128],zeroFill(108),[112]],8e3:[lowPrefix,zeroFill(268),[3,121,16],zeroFill(47),[7]]},silence=function(metaTable){return Object.keys(metaTable).reduce(function(obj,key){return obj[key]=new Uint8Array(metaTable[key].reduce(function(arr,part){return arr.concat(part)},[])),obj},{})}(coneOfSilence);secondsToVideoTs=function(seconds){return 9e4*seconds},secondsToAudioTs=function(seconds,sampleRate){return seconds*sampleRate},videoTsToSeconds=function(timestamp){return timestamp/9e4},audioTsToSeconds=function(timestamp,sampleRate){return timestamp/sampleRate},audioTsToVideoTs=function(timestamp,sampleRate){return secondsToVideoTs(audioTsToSeconds(timestamp,sampleRate))},videoTsToAudioTs=function(timestamp,sampleRate){return secondsToAudioTs(videoTsToSeconds(timestamp),sampleRate)},metadataTsToSeconds=function(timestamp,timelineStartPts,keepOriginalTimestamps){return videoTsToSeconds(keepOriginalTimestamps?timestamp:timestamp-timelineStartPts)};var clock={ONE_SECOND_IN_TS:9e4,secondsToVideoTs:secondsToVideoTs,secondsToAudioTs:secondsToAudioTs,videoTsToSeconds:videoTsToSeconds,audioTsToSeconds:audioTsToSeconds,audioTsToVideoTs:audioTsToVideoTs,videoTsToAudioTs:videoTsToAudioTs,metadataTsToSeconds:metadataTsToSeconds},sumFrameByteLengths=function(array){var i,currentObj,sum=0;for(i=0;i<array.length;i++)currentObj=array[i],sum+=currentObj.data.byteLength;return sum},prefixWithSilence=function(track,frames,audioAppendStartTs,videoBaseMediaDecodeTime){var baseMediaDecodeTimeTs,silentFrame,i,firstFrame,frameDuration=0,audioGapDuration=0,audioFillFrameCount=0,audioFillDuration=0;if(frames.length&&(baseMediaDecodeTimeTs=clock.audioTsToVideoTs(track.baseMediaDecodeTime,track.samplerate),frameDuration=Math.ceil(clock.ONE_SECOND_IN_TS/(track.samplerate/1024)),audioAppendStartTs&&videoBaseMediaDecodeTime&&(audioGapDuration=baseMediaDecodeTimeTs-Math.max(audioAppendStartTs,videoBaseMediaDecodeTime),audioFillFrameCount=Math.floor(audioGapDuration/frameDuration),audioFillDuration=audioFillFrameCount*frameDuration),!(audioFillFrameCount<1||audioFillDuration>clock.ONE_SECOND_IN_TS/2))){for(silentFrame=silence[track.samplerate],silentFrame||(silentFrame=frames[0].data),i=0;i<audioFillFrameCount;i++)firstFrame=frames[0],frames.splice(0,0,{data:silentFrame,dts:firstFrame.dts-frameDuration,pts:firstFrame.pts-frameDuration});track.baseMediaDecodeTime-=Math.floor(clock.videoTsToAudioTs(audioFillDuration,track.samplerate))}},trimAdtsFramesByEarliestDts=function(adtsFrames,track,earliestAllowedDts){return track.minSegmentDts>=earliestAllowedDts?adtsFrames:(track.minSegmentDts=1/0,adtsFrames.filter(function(currentFrame){return currentFrame.dts>=earliestAllowedDts&&(track.minSegmentDts=Math.min(track.minSegmentDts,currentFrame.dts),track.minSegmentPts=track.minSegmentDts,!0)}))},generateSampleTable$1=function(frames){var i,currentFrame,samples=[];for(i=0;i<frames.length;i++)currentFrame=frames[i],samples.push({size:currentFrame.data.byteLength,duration:1024});return samples},concatenateFrameData=function(frames){var i,currentFrame,dataOffset=0,data=new Uint8Array(sumFrameByteLengths(frames));for(i=0;i<frames.length;i++)currentFrame=frames[i],data.set(currentFrame.data,dataOffset),dataOffset+=currentFrame.data.byteLength;return data},audioFrameUtils={prefixWithSilence:prefixWithSilence,trimAdtsFramesByEarliestDts:trimAdtsFramesByEarliestDts,generateSampleTable:generateSampleTable$1,concatenateFrameData:concatenateFrameData},ONE_SECOND_IN_TS$1=clock.ONE_SECOND_IN_TS,collectDtsInfo=function(track,data){"number"==typeof data.pts&&(void 0===track.timelineStartInfo.pts&&(track.timelineStartInfo.pts=data.pts),void 0===track.minSegmentPts?track.minSegmentPts=data.pts:track.minSegmentPts=Math.min(track.minSegmentPts,data.pts),void 0===track.maxSegmentPts?track.maxSegmentPts=data.pts:track.maxSegmentPts=Math.max(track.maxSegmentPts,data.pts)),"number"==typeof data.dts&&(void 0===track.timelineStartInfo.dts&&(track.timelineStartInfo.dts=data.dts),void 0===track.minSegmentDts?track.minSegmentDts=data.dts:track.minSegmentDts=Math.min(track.minSegmentDts,data.dts),void 0===track.maxSegmentDts?track.maxSegmentDts=data.dts:track.maxSegmentDts=Math.max(track.maxSegmentDts,data.dts))},clearDtsInfo=function(track){delete track.minSegmentDts,delete track.maxSegmentDts,delete track.minSegmentPts,delete track.maxSegmentPts},calculateTrackBaseMediaDecodeTime=function(track,keepOriginalTimestamps){var baseMediaDecodeTime,scale,minSegmentDts=track.minSegmentDts;return keepOriginalTimestamps||(minSegmentDts-=track.timelineStartInfo.dts),baseMediaDecodeTime=track.timelineStartInfo.baseMediaDecodeTime,baseMediaDecodeTime+=minSegmentDts,baseMediaDecodeTime=Math.max(0,baseMediaDecodeTime),"audio"===track.type&&(scale=track.samplerate/ONE_SECOND_IN_TS$1,baseMediaDecodeTime*=scale,baseMediaDecodeTime=Math.floor(baseMediaDecodeTime)),baseMediaDecodeTime},trackDecodeInfo={clearDtsInfo:clearDtsInfo,calculateTrackBaseMediaDecodeTime:calculateTrackBaseMediaDecodeTime,collectDtsInfo:collectDtsInfo},parseSei=function(bytes){for(var i=0,result={payloadType:-1,payloadSize:0},payloadType=0,payloadSize=0;i<bytes.byteLength&&128!==bytes[i];){for(;255===bytes[i];)payloadType+=255,i++;for(payloadType+=bytes[i++];255===bytes[i];)payloadSize+=255,i++;if(payloadSize+=bytes[i++],!result.payload&&4===payloadType){result.payloadType=payloadType,result.payloadSize=payloadSize,result.payload=bytes.subarray(i,i+payloadSize);break}i+=payloadSize,payloadType=0,payloadSize=0}return result},parseUserData=function(sei){return 181!==sei.payload[0]?null:49!=(sei.payload[1]<<8|sei.payload[2])?null:"GA94"!==String.fromCharCode(sei.payload[3],sei.payload[4],sei.payload[5],sei.payload[6])?null:3!==sei.payload[7]?null:sei.payload.subarray(8,sei.payload.length-1)},parseCaptionPackets=function(pts,userData){var i,count,offset,data,results=[];if(!(64&userData[0]))return results;for(count=31&userData[0],i=0;i<count;i++)offset=3*i,data={type:3&userData[offset+2],pts:pts},4&userData[offset+2]&&(data.ccData=userData[offset+3]<<8|userData[offset+4],results.push(data));return results},discardEmulationPreventionBytes=function(data){for(var newLength,newData,length=data.byteLength,emulationPreventionBytesPositions=[],i=1;i<length-2;)0===data[i]&&0===data[i+1]&&3===data[i+2]?(emulationPreventionBytesPositions.push(i+2),i+=2):i++;if(0===emulationPreventionBytesPositions.length)return data;newLength=length-emulationPreventionBytesPositions.length,newData=new Uint8Array(newLength);var sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++)sourceIndex===emulationPreventionBytesPositions[0]&&(sourceIndex++,emulationPreventionBytesPositions.shift()),newData[i]=data[sourceIndex];return newData},captionPacketParser={parseSei:parseSei,parseUserData:parseUserData,parseCaptionPackets:parseCaptionPackets,discardEmulationPreventionBytes:discardEmulationPreventionBytes,USER_DATA_REGISTERED_ITU_T_T35:4},CaptionStream=function CaptionStream(){CaptionStream.prototype.init.call(this),this.captionPackets_=[],this.ccStreams_=[new Cea608Stream(0,0),new Cea608Stream(0,1),new Cea608Stream(1,0),new Cea608Stream(1,1)],this.reset(),this.ccStreams_.forEach(function(cc){cc.on("data",this.trigger.bind(this,"data")),cc.on("partialdone",this.trigger.bind(this,"partialdone")),cc.on("done",this.trigger.bind(this,"done"))},this)};CaptionStream.prototype=new stream,CaptionStream.prototype.push=function(event){var sei,userData,newCaptionPackets;if("sei_rbsp"===event.nalUnitType&&(sei=captionPacketParser.parseSei(event.escapedRBSP),sei.payloadType===captionPacketParser.USER_DATA_REGISTERED_ITU_T_T35&&(userData=captionPacketParser.parseUserData(sei)))){if(event.dts<this.latestDts_)return void(this.ignoreNextEqualDts_=!0);if(event.dts===this.latestDts_&&this.ignoreNextEqualDts_)return void(--this.numSameDts_||(this.ignoreNextEqualDts_=!1));newCaptionPackets=captionPacketParser.parseCaptionPackets(event.pts,userData),this.captionPackets_=this.captionPackets_.concat(newCaptionPackets),this.latestDts_!==event.dts&&(this.numSameDts_=0),this.numSameDts_++,this.latestDts_=event.dts}},CaptionStream.prototype.flushCCStreams=function(flushType){this.ccStreams_.forEach(function(cc){return"flush"===flushType?cc.flush():cc.partialFlush()},this)},CaptionStream.prototype.flushStream=function(flushType){if(!this.captionPackets_.length)return void this.flushCCStreams(flushType);this.captionPackets_.forEach(function(elem,idx){elem.presortIndex=idx}),this.captionPackets_.sort(function(a,b){return a.pts===b.pts?a.presortIndex-b.presortIndex:a.pts-b.pts}),this.captionPackets_.forEach(function(packet){packet.type<2&&this.dispatchCea608Packet(packet)},this),this.captionPackets_.length=0,this.flushCCStreams(flushType)},CaptionStream.prototype.flush=function(){return this.flushStream("flush")},CaptionStream.prototype.partialFlush=function(){return this.flushStream("partialFlush")},CaptionStream.prototype.reset=function(){this.latestDts_=null,this.ignoreNextEqualDts_=!1,this.numSameDts_=0,this.activeCea608Channel_=[null,null],this.ccStreams_.forEach(function(ccStream){ccStream.reset()})},CaptionStream.prototype.dispatchCea608Packet=function(packet){this.setsTextOrXDSActive(packet)?this.activeCea608Channel_[packet.type]=null:this.setsChannel1Active(packet)?this.activeCea608Channel_[packet.type]=0:this.setsChannel2Active(packet)&&(this.activeCea608Channel_[packet.type]=1),null!==this.activeCea608Channel_[packet.type]&&this.ccStreams_[(packet.type<<1)+this.activeCea608Channel_[packet.type]].push(packet)},CaptionStream.prototype.setsChannel1Active=function(packet){return 4096==(30720&packet.ccData)},CaptionStream.prototype.setsChannel2Active=function(packet){return 6144==(30720&packet.ccData)},CaptionStream.prototype.setsTextOrXDSActive=function(packet){return 256==(28928&packet.ccData)||4138==(30974&packet.ccData)||6186==(30974&packet.ccData)};var CHARACTER_TRANSLATION={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,304:174,305:176,306:189,307:191,308:8482,309:162,310:163,311:9834,312:224,313:160,314:232,315:226,316:234,317:238,318:244,319:251,544:193,545:201,546:211,547:218,548:220,549:252,550:8216,551:161,552:42,553:39,554:8212,555:169,556:8480,557:8226,558:8220,559:8221,560:192,561:194,562:199,563:200,564:202,565:203,566:235,567:206,568:207,569:239,570:212,571:217,572:249,573:219,574:171,575:187,800:195,801:227,802:205,803:204,804:236,805:210,806:242,807:213,808:245,809:123,810:125,811:92,812:94,813:95,814:124,815:126,816:196,817:228,818:214,819:246,820:223,821:165,822:164,823:9474,824:197,825:229,826:216,827:248,828:9484,829:9488,830:9492,831:9496},getCharFromCode=function(code){return null===code?"":(code=CHARACTER_TRANSLATION[code]||code,String.fromCharCode(code))},ROWS=[4352,4384,4608,4640,5376,5408,5632,5664,5888,5920,4096,4864,4896,5120,5152],createDisplayBuffer=function(){for(var result=[],i=15;i--;)result.push("");return result},Cea608Stream=function Cea608Stream(field,dataChannel){Cea608Stream.prototype.init.call(this),this.field_=field||0,this.dataChannel_=dataChannel||0,this.name_="CC"+(1+(this.field_<<1|this.dataChannel_)),this.setConstants(),this.reset(),this.push=function(packet){var data,swap,char0,char1,text;if((data=32639&packet.ccData)===this.lastControlCode_)return void(this.lastControlCode_=null);if(4096==(61440&data)?this.lastControlCode_=data:data!==this.PADDING_&&(this.lastControlCode_=null),char0=data>>>8,char1=255&data,data!==this.PADDING_)if(data===this.RESUME_CAPTION_LOADING_)this.mode_="popOn";else if(data===this.END_OF_CAPTION_)this.mode_="popOn",this.clearFormatting(packet.pts),this.flushDisplayed(packet.pts),swap=this.displayed_,this.displayed_=this.nonDisplayed_,this.nonDisplayed_=swap,this.startPts_=packet.pts;else if(data===this.ROLL_UP_2_ROWS_)this.rollUpRows_=2,this.setRollUp(packet.pts);else if(data===this.ROLL_UP_3_ROWS_)this.rollUpRows_=3,this.setRollUp(packet.pts);else if(data===this.ROLL_UP_4_ROWS_)this.rollUpRows_=4,this.setRollUp(packet.pts);else if(data===this.CARRIAGE_RETURN_)this.clearFormatting(packet.pts),this.flushDisplayed(packet.pts),this.shiftRowsUp_(),this.startPts_=packet.pts;else if(data===this.BACKSPACE_)"popOn"===this.mode_?this.nonDisplayed_[this.row_]=this.nonDisplayed_[this.row_].slice(0,-1):this.displayed_[this.row_]=this.displayed_[this.row_].slice(0,-1);else if(data===this.ERASE_DISPLAYED_MEMORY_)this.flushDisplayed(packet.pts),this.displayed_=createDisplayBuffer();else if(data===this.ERASE_NON_DISPLAYED_MEMORY_)this.nonDisplayed_=createDisplayBuffer();else if(data===this.RESUME_DIRECT_CAPTIONING_)"paintOn"!==this.mode_&&(this.flushDisplayed(packet.pts),this.displayed_=createDisplayBuffer()),this.mode_="paintOn",this.startPts_=packet.pts;else if(this.isSpecialCharacter(char0,char1))char0=(3&char0)<<8,text=getCharFromCode(char0|char1),this[this.mode_](packet.pts,text),this.column_++;else if(this.isExtCharacter(char0,char1))"popOn"===this.mode_?this.nonDisplayed_[this.row_]=this.nonDisplayed_[this.row_].slice(0,-1):this.displayed_[this.row_]=this.displayed_[this.row_].slice(0,-1),char0=(3&char0)<<8,text=getCharFromCode(char0|char1),this[this.mode_](packet.pts,text),this.column_++;else if(this.isMidRowCode(char0,char1))this.clearFormatting(packet.pts),this[this.mode_](packet.pts," "),this.column_++,14==(14&char1)&&this.addFormatting(packet.pts,["i"]),1==(1&char1)&&this.addFormatting(packet.pts,["u"]);else if(this.isOffsetControlCode(char0,char1))this.column_+=3&char1;else if(this.isPAC(char0,char1)){var row=ROWS.indexOf(7968&data);"rollUp"===this.mode_&&(row-this.rollUpRows_+1<0&&(row=this.rollUpRows_-1),this.setRollUp(packet.pts,row)),row!==this.row_&&(this.clearFormatting(packet.pts),this.row_=row),1&char1&&-1===this.formatting_.indexOf("u")&&this.addFormatting(packet.pts,["u"]),16==(16&data)&&(this.column_=4*((14&data)>>1)),this.isColorPAC(char1)&&14==(14&char1)&&this.addFormatting(packet.pts,["i"])}else this.isNormalChar(char0)&&(0===char1&&(char1=null),text=getCharFromCode(char0),text+=getCharFromCode(char1),this[this.mode_](packet.pts,text),this.column_+=text.length)}};Cea608Stream.prototype=new stream,Cea608Stream.prototype.flushDisplayed=function(pts){var content=this.displayed_.map(function(row){try{return row.trim()}catch(e){return console.error("Skipping malformed caption."),""}}).join("\n").replace(/^\n+|\n+$/g,"");content.length&&this.trigger("data",{startPts:this.startPts_,endPts:pts,text:content,stream:this.name_})},Cea608Stream.prototype.reset=function(){this.mode_="popOn",this.topRow_=0,this.startPts_=0,this.displayed_=createDisplayBuffer(),this.nonDisplayed_=createDisplayBuffer(),this.lastControlCode_=null,this.column_=0,this.row_=14,this.rollUpRows_=2,this.formatting_=[]},Cea608Stream.prototype.setConstants=function(){0===this.dataChannel_?(this.BASE_=16,this.EXT_=17,this.CONTROL_=(20|this.field_)<<8,this.OFFSET_=23):1===this.dataChannel_&&(this.BASE_=24,this.EXT_=25,this.CONTROL_=(28|this.field_)<<8,this.OFFSET_=31),this.PADDING_=0,this.RESUME_CAPTION_LOADING_=32|this.CONTROL_,this.END_OF_CAPTION_=47|this.CONTROL_,this.ROLL_UP_2_ROWS_=37|this.CONTROL_,this.ROLL_UP_3_ROWS_=38|this.CONTROL_,this.ROLL_UP_4_ROWS_=39|this.CONTROL_,this.CARRIAGE_RETURN_=45|this.CONTROL_,this.RESUME_DIRECT_CAPTIONING_=41|this.CONTROL_,this.BACKSPACE_=33|this.CONTROL_,this.ERASE_DISPLAYED_MEMORY_=44|this.CONTROL_,this.ERASE_NON_DISPLAYED_MEMORY_=46|this.CONTROL_},Cea608Stream.prototype.isSpecialCharacter=function(char0,char1){return char0===this.EXT_&&char1>=48&&char1<=63},Cea608Stream.prototype.isExtCharacter=function(char0,char1){return(char0===this.EXT_+1||char0===this.EXT_+2)&&char1>=32&&char1<=63},Cea608Stream.prototype.isMidRowCode=function(char0,char1){return char0===this.EXT_&&char1>=32&&char1<=47},Cea608Stream.prototype.isOffsetControlCode=function(char0,char1){return char0===this.OFFSET_&&char1>=33&&char1<=35},Cea608Stream.prototype.isPAC=function(char0,char1){return char0>=this.BASE_&&char0<this.BASE_+8&&char1>=64&&char1<=127},Cea608Stream.prototype.isColorPAC=function(char1){return char1>=64&&char1<=79||char1>=96&&char1<=127},Cea608Stream.prototype.isNormalChar=function(char){return char>=32&&char<=127},Cea608Stream.prototype.setRollUp=function(pts,newBaseRow){if("rollUp"!==this.mode_&&(this.row_=14,this.mode_="rollUp",this.flushDisplayed(pts),this.nonDisplayed_=createDisplayBuffer(),this.displayed_=createDisplayBuffer()),void 0!==newBaseRow&&newBaseRow!==this.row_)for(var i=0;i<this.rollUpRows_;i++)this.displayed_[newBaseRow-i]=this.displayed_[this.row_-i],this.displayed_[this.row_-i]="";void 0===newBaseRow&&(newBaseRow=this.row_),this.topRow_=newBaseRow-this.rollUpRows_+1},Cea608Stream.prototype.addFormatting=function(pts,format){this.formatting_=this.formatting_.concat(format);var text=format.reduce(function(text,format){return text+"<"+format+">"},"");this[this.mode_](pts,text)},Cea608Stream.prototype.clearFormatting=function(pts){if(this.formatting_.length){var text=this.formatting_.reverse().reduce(function(text,format){return text+"</"+format+">"},"");this.formatting_=[],this[this.mode_](pts,text)}},Cea608Stream.prototype.popOn=function(pts,text){var baseRow=this.nonDisplayed_[this.row_];baseRow+=text,this.nonDisplayed_[this.row_]=baseRow},Cea608Stream.prototype.rollUp=function(pts,text){var baseRow=this.displayed_[this.row_];baseRow+=text,this.displayed_[this.row_]=baseRow},Cea608Stream.prototype.shiftRowsUp_=function(){var i;for(i=0;i<this.topRow_;i++)this.displayed_[i]="";for(i=this.row_+1;i<15;i++)this.displayed_[i]="";for(i=this.topRow_;i<this.row_;i++)this.displayed_[i]=this.displayed_[i+1];this.displayed_[this.row_]=""},Cea608Stream.prototype.paintOn=function(pts,text){var baseRow=this.displayed_[this.row_];baseRow+=text,this.displayed_[this.row_]=baseRow};var captionStream={CaptionStream:CaptionStream,Cea608Stream:Cea608Stream},streamTypes={H264_STREAM_TYPE:27,ADTS_STREAM_TYPE:15,METADATA_STREAM_TYPE:21},handleRollover=function(value,reference){var direction=1;for(value>reference&&(direction=-1);Math.abs(reference-value)>4294967296;)value+=8589934592*direction;return value},TimestampRolloverStream=function TimestampRolloverStream(type){var lastDTS,referenceDTS;TimestampRolloverStream.prototype.init.call(this),this.type_=type||"shared",this.push=function(data){"shared"!==this.type_&&data.type!==this.type_||(void 0===referenceDTS&&(referenceDTS=data.dts),data.dts=handleRollover(data.dts,referenceDTS),data.pts=handleRollover(data.pts,referenceDTS),lastDTS=data.dts,this.trigger("data",data))},this.flush=function(){referenceDTS=lastDTS,this.trigger("done")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline")},this.discontinuity=function(){referenceDTS=void 0,lastDTS=void 0},this.reset=function(){this.discontinuity(),this.trigger("reset")}}
;TimestampRolloverStream.prototype=new stream;var _MetadataStream,timestampRolloverStream={TimestampRolloverStream:TimestampRolloverStream,handleRollover:handleRollover},percentEncode=function(bytes,start,end){var i,result="";for(i=start;i<end;i++)result+="%"+("00"+bytes[i].toString(16)).slice(-2);return result},parseUtf8=function(bytes,start,end){return decodeURIComponent(percentEncode(bytes,start,end))},parseIso88591=function(bytes,start,end){return unescape(percentEncode(bytes,start,end))},parseSyncSafeInteger=function(data){return data[0]<<21|data[1]<<14|data[2]<<7|data[3]},tagParsers={TXXX:function(tag){var i;if(3===tag.data[0]){for(i=1;i<tag.data.length;i++)if(0===tag.data[i]){tag.description=parseUtf8(tag.data,1,i),tag.value=parseUtf8(tag.data,i+1,tag.data.length).replace(/\0*$/,"");break}tag.data=tag.value}},WXXX:function(tag){var i;if(3===tag.data[0])for(i=1;i<tag.data.length;i++)if(0===tag.data[i]){tag.description=parseUtf8(tag.data,1,i),tag.url=parseUtf8(tag.data,i+1,tag.data.length);break}},PRIV:function(tag){var i;for(i=0;i<tag.data.length;i++)if(0===tag.data[i]){tag.owner=parseIso88591(tag.data,0,i);break}tag.privateData=tag.data.subarray(i+1),tag.data=tag.privateData}};_MetadataStream=function(options){var i,settings={debug:!(!options||!options.debug),descriptor:options&&options.descriptor},tagSize=0,buffer=[],bufferSize=0;if(_MetadataStream.prototype.init.call(this),this.dispatchType=streamTypes.METADATA_STREAM_TYPE.toString(16),settings.descriptor)for(i=0;i<settings.descriptor.length;i++)this.dispatchType+=("00"+settings.descriptor[i].toString(16)).slice(-2);this.push=function(chunk){var tag,frameStart,frameSize,frame,i,frameHeader;if("timed-metadata"===chunk.type){if(chunk.dataAlignmentIndicator&&(bufferSize=0,buffer.length=0),0===buffer.length&&(chunk.data.length<10||chunk.data[0]!=="I".charCodeAt(0)||chunk.data[1]!=="D".charCodeAt(0)||chunk.data[2]!=="3".charCodeAt(0)))return void(settings.debug&&console.log("Skipping unrecognized metadata packet"));if(buffer.push(chunk),bufferSize+=chunk.data.byteLength,1===buffer.length&&(tagSize=parseSyncSafeInteger(chunk.data.subarray(6,10)),tagSize+=10),!(bufferSize<tagSize)){for(tag={data:new Uint8Array(tagSize),frames:[],pts:buffer[0].pts,dts:buffer[0].dts},i=0;i<tagSize;)tag.data.set(buffer[0].data.subarray(0,tagSize-i),i),i+=buffer[0].data.byteLength,bufferSize-=buffer[0].data.byteLength,buffer.shift();frameStart=10,64&tag.data[5]&&(frameStart+=4,frameStart+=parseSyncSafeInteger(tag.data.subarray(10,14)),tagSize-=parseSyncSafeInteger(tag.data.subarray(16,20)));do{if((frameSize=parseSyncSafeInteger(tag.data.subarray(frameStart+4,frameStart+8)))<1)return console.log("Malformed ID3 frame encountered. Skipping metadata parsing.");if(frameHeader=String.fromCharCode(tag.data[frameStart],tag.data[frameStart+1],tag.data[frameStart+2],tag.data[frameStart+3]),frame={id:frameHeader,data:tag.data.subarray(frameStart+10,frameStart+frameSize+10)},frame.key=frame.id,tagParsers[frame.id]&&(tagParsers[frame.id](frame),"com.apple.streaming.transportStreamTimestamp"===frame.owner)){var d=frame.data,size=(1&d[3])<<30|d[4]<<22|d[5]<<14|d[6]<<6|d[7]>>>2;size*=4,size+=3&d[7],frame.timeStamp=size,void 0===tag.pts&&void 0===tag.dts&&(tag.pts=frame.timeStamp,tag.dts=frame.timeStamp),this.trigger("timestamp",frame)}tag.frames.push(frame),frameStart+=10,frameStart+=frameSize}while(frameStart<tagSize);this.trigger("data",tag)}}}},_MetadataStream.prototype=new stream;var _TransportPacketStream,_TransportParseStream,_ElementaryStream,metadataStream=_MetadataStream,TimestampRolloverStream$1=timestampRolloverStream.TimestampRolloverStream;_TransportPacketStream=function(){var buffer=new Uint8Array(188),bytesInBuffer=0;_TransportPacketStream.prototype.init.call(this),this.push=function(bytes){var everything,startIndex=0,endIndex=188;for(bytesInBuffer?(everything=new Uint8Array(bytes.byteLength+bytesInBuffer),everything.set(buffer.subarray(0,bytesInBuffer)),everything.set(bytes,bytesInBuffer),bytesInBuffer=0):everything=bytes;endIndex<everything.byteLength;)71!==everything[startIndex]||71!==everything[endIndex]?(startIndex++,endIndex++):(this.trigger("data",everything.subarray(startIndex,endIndex)),startIndex+=188,endIndex+=188);startIndex<everything.byteLength&&(buffer.set(everything.subarray(startIndex),0),bytesInBuffer=everything.byteLength-startIndex)},this.flush=function(){188===bytesInBuffer&&71===buffer[0]&&(this.trigger("data",buffer),bytesInBuffer=0),this.trigger("done")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline")},this.reset=function(){bytesInBuffer=0,this.trigger("reset")}},_TransportPacketStream.prototype=new stream,_TransportParseStream=function(){var parsePsi,parsePat,parsePmt,self;_TransportParseStream.prototype.init.call(this),self=this,this.packetsWaitingForPmt=[],this.programMapTable=void 0,parsePsi=function(payload,psi){var offset=0;psi.payloadUnitStartIndicator&&(offset+=payload[offset]+1),"pat"===psi.type?parsePat(payload.subarray(offset),psi):parsePmt(payload.subarray(offset),psi)},parsePat=function(payload,pat){pat.section_number=payload[7],pat.last_section_number=payload[8],self.pmtPid=(31&payload[10])<<8|payload[11],pat.pmtPid=self.pmtPid},parsePmt=function(payload,pmt){var sectionLength,tableEnd,programInfoLength,offset;if(1&payload[5]){for(self.programMapTable={video:null,audio:null,"timed-metadata":{}},sectionLength=(15&payload[1])<<8|payload[2],tableEnd=3+sectionLength-4,programInfoLength=(15&payload[10])<<8|payload[11],offset=12+programInfoLength;offset<tableEnd;){var streamType=payload[offset],pid=(31&payload[offset+1])<<8|payload[offset+2];streamType===streamTypes.H264_STREAM_TYPE&&null===self.programMapTable.video?self.programMapTable.video=pid:streamType===streamTypes.ADTS_STREAM_TYPE&&null===self.programMapTable.audio?self.programMapTable.audio=pid:streamType===streamTypes.METADATA_STREAM_TYPE&&(self.programMapTable["timed-metadata"][pid]=streamType),offset+=5+((15&payload[offset+3])<<8|payload[offset+4])}pmt.programMapTable=self.programMapTable}},this.push=function(packet){var result={},offset=4;if(result.payloadUnitStartIndicator=!!(64&packet[1]),result.pid=31&packet[1],result.pid<<=8,result.pid|=packet[2],(48&packet[3])>>>4>1&&(offset+=packet[offset]+1),0===result.pid)result.type="pat",parsePsi(packet.subarray(offset),result),this.trigger("data",result);else if(result.pid===this.pmtPid)for(result.type="pmt",parsePsi(packet.subarray(offset),result),this.trigger("data",result);this.packetsWaitingForPmt.length;)this.processPes_.apply(this,this.packetsWaitingForPmt.shift());else void 0===this.programMapTable?this.packetsWaitingForPmt.push([packet,offset,result]):this.processPes_(packet,offset,result)},this.processPes_=function(packet,offset,result){result.pid===this.programMapTable.video?result.streamType=streamTypes.H264_STREAM_TYPE:result.pid===this.programMapTable.audio?result.streamType=streamTypes.ADTS_STREAM_TYPE:result.streamType=this.programMapTable["timed-metadata"][result.pid],result.type="pes",result.data=packet.subarray(offset),this.trigger("data",result)}},_TransportParseStream.prototype=new stream,_TransportParseStream.STREAM_TYPES={h264:27,adts:15},_ElementaryStream=function(){var programMapTable,self=this,video={data:[],size:0},audio={data:[],size:0},timedMetadata={data:[],size:0},parsePes=function(payload,pes){var ptsDtsFlags;pes.packetLength=6+(payload[4]<<8|payload[5]),pes.dataAlignmentIndicator=0!=(4&payload[6]),ptsDtsFlags=payload[7],192&ptsDtsFlags&&(pes.pts=(14&payload[9])<<27|(255&payload[10])<<20|(254&payload[11])<<12|(255&payload[12])<<5|(254&payload[13])>>>3,pes.pts*=4,pes.pts+=(6&payload[13])>>>1,pes.dts=pes.pts,64&ptsDtsFlags&&(pes.dts=(14&payload[14])<<27|(255&payload[15])<<20|(254&payload[16])<<12|(255&payload[17])<<5|(254&payload[18])>>>3,pes.dts*=4,pes.dts+=(6&payload[18])>>>1)),pes.data=payload.subarray(9+payload[8])},flushStream=function(stream$$1,type,forceFlush){var fragment,packetData=new Uint8Array(stream$$1.size),event={type:type},i=0,offset=0,packetFlushable=!1;if(stream$$1.data.length&&!(stream$$1.size<9)){for(event.trackId=stream$$1.data[0].pid,i=0;i<stream$$1.data.length;i++)fragment=stream$$1.data[i],packetData.set(fragment.data,offset),offset+=fragment.data.byteLength;parsePes(packetData,event),packetFlushable="video"===type||event.packetLength<=stream$$1.size,(forceFlush||packetFlushable)&&(stream$$1.size=0,stream$$1.data.length=0),packetFlushable&&self.trigger("data",event)}};_ElementaryStream.prototype.init.call(this),this.push=function(data){({pat:function(){},pes:function(){var stream$$1,streamType;switch(data.streamType){case streamTypes.H264_STREAM_TYPE:case streamTypes.H264_STREAM_TYPE:stream$$1=video,streamType="video";break;case streamTypes.ADTS_STREAM_TYPE:stream$$1=audio,streamType="audio";break;case streamTypes.METADATA_STREAM_TYPE:stream$$1=timedMetadata,streamType="timed-metadata";break;default:return}data.payloadUnitStartIndicator&&flushStream(stream$$1,streamType,!0),stream$$1.data.push(data),stream$$1.size+=data.data.byteLength},pmt:function(){var event={type:"metadata",tracks:[]};programMapTable=data.programMapTable,null!==programMapTable.video&&event.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+programMapTable.video,codec:"avc",type:"video"}),null!==programMapTable.audio&&event.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+programMapTable.audio,codec:"adts",type:"audio"}),self.trigger("data",event)}})[data.type]()},this.reset=function(){video.size=0,video.data.length=0,audio.size=0,audio.data.length=0,this.trigger("reset")},this.flushStreams_=function(){flushStream(video,"video"),flushStream(audio,"audio"),flushStream(timedMetadata,"timed-metadata")},this.flush=function(){this.flushStreams_(),this.trigger("done")}},_ElementaryStream.prototype=new stream;var m2ts={PAT_PID:0,MP2T_PACKET_LENGTH:188,TransportPacketStream:_TransportPacketStream,TransportParseStream:_TransportParseStream,ElementaryStream:_ElementaryStream,TimestampRolloverStream:TimestampRolloverStream$1,CaptionStream:captionStream.CaptionStream,Cea608Stream:captionStream.Cea608Stream,MetadataStream:metadataStream};for(var type in streamTypes)streamTypes.hasOwnProperty(type)&&(m2ts[type]=streamTypes[type]);var _AdtsStream,m2ts_1=m2ts,ONE_SECOND_IN_TS$2=clock.ONE_SECOND_IN_TS,ADTS_SAMPLING_FREQUENCIES=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];_AdtsStream=function(handlePartialSegments){var buffer,frameNum=0;_AdtsStream.prototype.init.call(this),this.push=function(packet){var frameLength,protectionSkipBytes,frameEnd,oldBuffer,sampleCount,adtsFrameDuration,i=0;if(handlePartialSegments||(frameNum=0),"audio"===packet.type)for(buffer?(oldBuffer=buffer,buffer=new Uint8Array(oldBuffer.byteLength+packet.data.byteLength),buffer.set(oldBuffer),buffer.set(packet.data,oldBuffer.byteLength)):buffer=packet.data;i+5<buffer.length;)if(255===buffer[i]&&240==(246&buffer[i+1])){if(protectionSkipBytes=2*(1&~buffer[i+1]),frameLength=(3&buffer[i+3])<<11|buffer[i+4]<<3|(224&buffer[i+5])>>5,sampleCount=1024*(1+(3&buffer[i+6])),adtsFrameDuration=sampleCount*ONE_SECOND_IN_TS$2/ADTS_SAMPLING_FREQUENCIES[(60&buffer[i+2])>>>2],frameEnd=i+frameLength,buffer.byteLength<frameEnd)return;if(this.trigger("data",{pts:packet.pts+frameNum*adtsFrameDuration,dts:packet.dts+frameNum*adtsFrameDuration,sampleCount:sampleCount,audioobjecttype:1+(buffer[i+2]>>>6&3),channelcount:(1&buffer[i+2])<<2|(192&buffer[i+3])>>>6,samplerate:ADTS_SAMPLING_FREQUENCIES[(60&buffer[i+2])>>>2],samplingfrequencyindex:(60&buffer[i+2])>>>2,samplesize:16,data:buffer.subarray(i+7+protectionSkipBytes,frameEnd)}),frameNum++,buffer.byteLength===frameEnd)return void(buffer=void 0);buffer=buffer.subarray(frameEnd)}else i++},this.flush=function(){frameNum=0,this.trigger("done")},this.reset=function(){buffer=void 0,this.trigger("reset")},this.endTimeline=function(){buffer=void 0,this.trigger("endedtimeline")}},_AdtsStream.prototype=new stream;var ExpGolomb,adts=_AdtsStream;ExpGolomb=function(workingData){var workingBytesAvailable=workingData.byteLength,workingWord=0,workingBitsAvailable=0;this.length=function(){return 8*workingBytesAvailable},this.bitsAvailable=function(){return 8*workingBytesAvailable+workingBitsAvailable},this.loadWord=function(){var position=workingData.byteLength-workingBytesAvailable,workingBytes=new Uint8Array(4),availableBytes=Math.min(4,workingBytesAvailable);if(0===availableBytes)throw new Error("no bytes available");workingBytes.set(workingData.subarray(position,position+availableBytes)),workingWord=new DataView(workingBytes.buffer).getUint32(0),workingBitsAvailable=8*availableBytes,workingBytesAvailable-=availableBytes},this.skipBits=function(count){var skipBytes;workingBitsAvailable>count?(workingWord<<=count,workingBitsAvailable-=count):(count-=workingBitsAvailable,skipBytes=Math.floor(count/8),count-=8*skipBytes,workingBytesAvailable-=skipBytes,this.loadWord(),workingWord<<=count,workingBitsAvailable-=count)},this.readBits=function(size){var bits=Math.min(workingBitsAvailable,size),valu=workingWord>>>32-bits;return workingBitsAvailable-=bits,workingBitsAvailable>0?workingWord<<=bits:workingBytesAvailable>0&&this.loadWord(),bits=size-bits,bits>0?valu<<bits|this.readBits(bits):valu},this.skipLeadingZeros=function(){var leadingZeroCount;for(leadingZeroCount=0;leadingZeroCount<workingBitsAvailable;++leadingZeroCount)if(0!=(workingWord&2147483648>>>leadingZeroCount))return workingWord<<=leadingZeroCount,workingBitsAvailable-=leadingZeroCount,leadingZeroCount;return this.loadWord(),leadingZeroCount+this.skipLeadingZeros()},this.skipUnsignedExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())},this.skipExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())},this.readUnsignedExpGolomb=function(){var clz=this.skipLeadingZeros();return this.readBits(clz+1)-1},this.readExpGolomb=function(){var valu=this.readUnsignedExpGolomb();return 1&valu?1+valu>>>1:-1*(valu>>>1)},this.readBoolean=function(){return 1===this.readBits(1)},this.readUnsignedByte=function(){return this.readBits(8)},this.loadWord()};var _H264Stream,_NalByteStream,PROFILES_WITH_OPTIONAL_SPS_DATA,expGolomb=ExpGolomb;_NalByteStream=function(){var i,buffer,syncPoint=0;_NalByteStream.prototype.init.call(this),this.push=function(data){var swapBuffer;buffer?(swapBuffer=new Uint8Array(buffer.byteLength+data.data.byteLength),swapBuffer.set(buffer),swapBuffer.set(data.data,buffer.byteLength),buffer=swapBuffer):buffer=data.data;for(var len=buffer.byteLength;syncPoint<len-3;syncPoint++)if(1===buffer[syncPoint+2]){i=syncPoint+5;break}for(;i<len;)switch(buffer[i]){case 0:if(0!==buffer[i-1]){i+=2;break}if(0!==buffer[i-2]){i++;break}syncPoint+3!==i-2&&this.trigger("data",buffer.subarray(syncPoint+3,i-2));do{i++}while(1!==buffer[i]&&i<len);syncPoint=i-2,i+=3;break;case 1:if(0!==buffer[i-1]||0!==buffer[i-2]){i+=3;break}this.trigger("data",buffer.subarray(syncPoint+3,i-2)),syncPoint=i-2,i+=3;break;default:i+=3}buffer=buffer.subarray(syncPoint),i-=syncPoint,syncPoint=0},this.reset=function(){buffer=null,syncPoint=0,this.trigger("reset")},this.flush=function(){buffer&&buffer.byteLength>3&&this.trigger("data",buffer.subarray(syncPoint+3)),buffer=null,syncPoint=0,this.trigger("done")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline")}},_NalByteStream.prototype=new stream,PROFILES_WITH_OPTIONAL_SPS_DATA={100:!0,110:!0,122:!0,244:!0,44:!0,83:!0,86:!0,118:!0,128:!0,138:!0,139:!0,134:!0},_H264Stream=function(){var self,trackId,currentPts,currentDts,discardEmulationPreventionBytes,readSequenceParameterSet,skipScalingList,nalByteStream=new _NalByteStream;_H264Stream.prototype.init.call(this),self=this,this.push=function(packet){"video"===packet.type&&(trackId=packet.trackId,currentPts=packet.pts,currentDts=packet.dts,nalByteStream.push(packet))},nalByteStream.on("data",function(data){var event={trackId:trackId,pts:currentPts,dts:currentDts,data:data};switch(31&data[0]){case 5:event.nalUnitType="slice_layer_without_partitioning_rbsp_idr";break;case 6:event.nalUnitType="sei_rbsp",event.escapedRBSP=discardEmulationPreventionBytes(data.subarray(1));break;case 7:event.nalUnitType="seq_parameter_set_rbsp",event.escapedRBSP=discardEmulationPreventionBytes(data.subarray(1)),event.config=readSequenceParameterSet(event.escapedRBSP);break;case 8:event.nalUnitType="pic_parameter_set_rbsp";break;case 9:event.nalUnitType="access_unit_delimiter_rbsp"}self.trigger("data",event)}),nalByteStream.on("done",function(){self.trigger("done")}),nalByteStream.on("partialdone",function(){self.trigger("partialdone")}),nalByteStream.on("reset",function(){self.trigger("reset")}),nalByteStream.on("endedtimeline",function(){self.trigger("endedtimeline")}),this.flush=function(){nalByteStream.flush()},this.partialFlush=function(){nalByteStream.partialFlush()},this.reset=function(){nalByteStream.reset()},this.endTimeline=function(){nalByteStream.endTimeline()},skipScalingList=function(count,expGolombDecoder){var j,deltaScale,lastScale=8,nextScale=8;for(j=0;j<count;j++)0!==nextScale&&(deltaScale=expGolombDecoder.readExpGolomb(),nextScale=(lastScale+deltaScale+256)%256),lastScale=0===nextScale?lastScale:nextScale},discardEmulationPreventionBytes=function(data){for(var newLength,newData,length=data.byteLength,emulationPreventionBytesPositions=[],i=1;i<length-2;)0===data[i]&&0===data[i+1]&&3===data[i+2]?(emulationPreventionBytesPositions.push(i+2),i+=2):i++;if(0===emulationPreventionBytesPositions.length)return data;newLength=length-emulationPreventionBytesPositions.length,newData=new Uint8Array(newLength);var sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++)sourceIndex===emulationPreventionBytesPositions[0]&&(sourceIndex++,emulationPreventionBytesPositions.shift()),newData[i]=data[sourceIndex];return newData},readSequenceParameterSet=function(data){var expGolombDecoder,profileIdc,levelIdc,profileCompatibility,chromaFormatIdc,picOrderCntType,numRefFramesInPicOrderCntCycle,picWidthInMbsMinus1,picHeightInMapUnitsMinus1,frameMbsOnlyFlag,scalingListCount,sarRatio,i,frameCropLeftOffset=0,frameCropRightOffset=0,frameCropTopOffset=0,frameCropBottomOffset=0,sarScale=1;if(expGolombDecoder=new expGolomb(data),profileIdc=expGolombDecoder.readUnsignedByte(),profileCompatibility=expGolombDecoder.readUnsignedByte(),levelIdc=expGolombDecoder.readUnsignedByte(),expGolombDecoder.skipUnsignedExpGolomb(),PROFILES_WITH_OPTIONAL_SPS_DATA[profileIdc]&&(chromaFormatIdc=expGolombDecoder.readUnsignedExpGolomb(),3===chromaFormatIdc&&expGolombDecoder.skipBits(1),expGolombDecoder.skipUnsignedExpGolomb(),expGolombDecoder.skipUnsignedExpGolomb(),expGolombDecoder.skipBits(1),expGolombDecoder.readBoolean()))for(scalingListCount=3!==chromaFormatIdc?8:12,i=0;i<scalingListCount;i++)expGolombDecoder.readBoolean()&&(i<6?skipScalingList(16,expGolombDecoder):skipScalingList(64,expGolombDecoder));if(expGolombDecoder.skipUnsignedExpGolomb(),0===(picOrderCntType=expGolombDecoder.readUnsignedExpGolomb()))expGolombDecoder.readUnsignedExpGolomb();else if(1===picOrderCntType)for(expGolombDecoder.skipBits(1),expGolombDecoder.skipExpGolomb(),expGolombDecoder.skipExpGolomb(),numRefFramesInPicOrderCntCycle=expGolombDecoder.readUnsignedExpGolomb(),i=0;i<numRefFramesInPicOrderCntCycle;i++)expGolombDecoder.skipExpGolomb();if(expGolombDecoder.skipUnsignedExpGolomb(),expGolombDecoder.skipBits(1),picWidthInMbsMinus1=expGolombDecoder.readUnsignedExpGolomb(),picHeightInMapUnitsMinus1=expGolombDecoder.readUnsignedExpGolomb(),frameMbsOnlyFlag=expGolombDecoder.readBits(1),0===frameMbsOnlyFlag&&expGolombDecoder.skipBits(1),expGolombDecoder.skipBits(1),expGolombDecoder.readBoolean()&&(frameCropLeftOffset=expGolombDecoder.readUnsignedExpGolomb(),frameCropRightOffset=expGolombDecoder.readUnsignedExpGolomb(),frameCropTopOffset=expGolombDecoder.readUnsignedExpGolomb(),frameCropBottomOffset=expGolombDecoder.readUnsignedExpGolomb()),expGolombDecoder.readBoolean()&&expGolombDecoder.readBoolean()){switch(expGolombDecoder.readUnsignedByte()){case 1:sarRatio=[1,1];break;case 2:sarRatio=[12,11];break;case 3:sarRatio=[10,11];break;case 4:sarRatio=[16,11];break;case 5:sarRatio=[40,33];break;case 6:sarRatio=[24,11];break;case 7:sarRatio=[20,11];break;case 8:sarRatio=[32,11];break;case 9:sarRatio=[80,33];break;case 10:sarRatio=[18,11];break;case 11:sarRatio=[15,11];break;case 12:sarRatio=[64,33];break;case 13:sarRatio=[160,99];break;case 14:sarRatio=[4,3];break;case 15:sarRatio=[3,2];break;case 16:sarRatio=[2,1];break;case 255:sarRatio=[expGolombDecoder.readUnsignedByte()<<8|expGolombDecoder.readUnsignedByte(),expGolombDecoder.readUnsignedByte()<<8|expGolombDecoder.readUnsignedByte()]}sarRatio&&(sarScale=sarRatio[0]/sarRatio[1])}return{profileIdc:profileIdc,levelIdc:levelIdc,profileCompatibility:profileCompatibility,width:Math.ceil((16*(picWidthInMbsMinus1+1)-2*frameCropLeftOffset-2*frameCropRightOffset)*sarScale),height:(2-frameMbsOnlyFlag)*(picHeightInMapUnitsMinus1+1)*16-2*frameCropTopOffset-2*frameCropBottomOffset,sarRatio:sarRatio}}},_H264Stream.prototype=new stream;var _AacStream,h264={H264Stream:_H264Stream,NalByteStream:_NalByteStream},ADTS_SAMPLING_FREQUENCIES$1=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],isLikelyAacData=function(data){return data[0]==="I".charCodeAt(0)&&data[1]==="D".charCodeAt(0)&&data[2]==="3".charCodeAt(0)},parseSyncSafeInteger$1=function(data){return data[0]<<21|data[1]<<14|data[2]<<7|data[3]},percentEncode$1=function(bytes,start,end){var i,result="";for(i=start;i<end;i++)result+="%"+("00"+bytes[i].toString(16)).slice(-2);return result},parseIso88591$1=function(bytes,start,end){return unescape(percentEncode$1(bytes,start,end))},parseId3TagSize=function(header,byteIndex){var returnSize=header[byteIndex+6]<<21|header[byteIndex+7]<<14|header[byteIndex+8]<<7|header[byteIndex+9];return(16&header[byteIndex+5])>>4?returnSize+20:returnSize+10},parseAdtsSize=function(header,byteIndex){var lowThree=(224&header[byteIndex+5])>>5,middle=header[byteIndex+4]<<3;return 6144&header[byteIndex+3]|middle|lowThree},parseType=function(header,byteIndex){return header[byteIndex]==="I".charCodeAt(0)&&header[byteIndex+1]==="D".charCodeAt(0)&&header[byteIndex+2]==="3".charCodeAt(0)?"timed-metadata":!0&header[byteIndex]&&240==(240&header[byteIndex+1])?"audio":null},parseSampleRate=function(packet){for(var i=0;i+5<packet.length;){if(255===packet[i]&&240==(246&packet[i+1]))return ADTS_SAMPLING_FREQUENCIES$1[(60&packet[i+2])>>>2];i++}return null},parseAacTimestamp=function(packet){var frameStart,frameSize,frame;frameStart=10,64&packet[5]&&(frameStart+=4,frameStart+=parseSyncSafeInteger$1(packet.subarray(10,14)));do{if((frameSize=parseSyncSafeInteger$1(packet.subarray(frameStart+4,frameStart+8)))<1)return null;if("PRIV"===String.fromCharCode(packet[frameStart],packet[frameStart+1],packet[frameStart+2],packet[frameStart+3])){frame=packet.subarray(frameStart+10,frameStart+frameSize+10);for(var i=0;i<frame.byteLength;i++)if(0===frame[i]){var owner=parseIso88591$1(frame,0,i);if("com.apple.streaming.transportStreamTimestamp"===owner){var d=frame.subarray(i+1),size=(1&d[3])<<30|d[4]<<22|d[5]<<14|d[6]<<6|d[7]>>>2;return size*=4,size+=3&d[7]}break}}frameStart+=10,frameStart+=frameSize}while(frameStart<packet.byteLength);return null},utils={isLikelyAacData:isLikelyAacData,parseId3TagSize:parseId3TagSize,parseAdtsSize:parseAdtsSize,parseType:parseType,parseSampleRate:parseSampleRate,parseAacTimestamp:parseAacTimestamp};_AacStream=function(){var everything=new Uint8Array,timeStamp=0;_AacStream.prototype.init.call(this),this.setTimestamp=function(timestamp){timeStamp=timestamp},this.push=function(bytes){var bytesLeft,chunk,packet,tempLength,frameSize=0,byteIndex=0;for(everything.length?(tempLength=everything.length,everything=new Uint8Array(bytes.byteLength+tempLength),everything.set(everything.subarray(0,tempLength)),everything.set(bytes,tempLength)):everything=bytes;everything.length-byteIndex>=3;)if(everything[byteIndex]!=="I".charCodeAt(0)||everything[byteIndex+1]!=="D".charCodeAt(0)||everything[byteIndex+2]!=="3".charCodeAt(0))if(255!=(255&everything[byteIndex])||240!=(240&everything[byteIndex+1]))byteIndex++;else{if(everything.length-byteIndex<7)break;if(frameSize=utils.parseAdtsSize(everything,byteIndex),byteIndex+frameSize>everything.length)break;packet={type:"audio",data:everything.subarray(byteIndex,byteIndex+frameSize),pts:timeStamp,dts:timeStamp},this.trigger("data",packet),byteIndex+=frameSize}else{if(everything.length-byteIndex<10)break;if(frameSize=utils.parseId3TagSize(everything,byteIndex),byteIndex+frameSize>everything.length)break;chunk={type:"timed-metadata",data:everything.subarray(byteIndex,byteIndex+frameSize)},this.trigger("data",chunk),byteIndex+=frameSize}bytesLeft=everything.length-byteIndex,everything=bytesLeft>0?everything.subarray(byteIndex):new Uint8Array},this.reset=function(){everything=new Uint8Array,this.trigger("reset")},this.endTimeline=function(){everything=new Uint8Array,this.trigger("endedtimeline")}},_AacStream.prototype=new stream;var _VideoSegmentStream,_AudioSegmentStream,_Transmuxer,_CoalesceStream,aac=_AacStream,H264Stream=h264.H264Stream,isLikelyAacData$1=utils.isLikelyAacData,ONE_SECOND_IN_TS$3=clock.ONE_SECOND_IN_TS,AUDIO_PROPERTIES=["audioobjecttype","channelcount","samplerate","samplingfrequencyindex","samplesize"],VIDEO_PROPERTIES=["width","height","profileIdc","levelIdc","profileCompatibility","sarRatio"],arrayEquals=function(a,b){var i;if(a.length!==b.length)return!1;for(i=0;i<a.length;i++)if(a[i]!==b[i])return!1;return!0},generateVideoSegmentTimingInfo=function(baseMediaDecodeTime,startDts,startPts,endDts,endPts,prependedContentDuration){return{start:{dts:baseMediaDecodeTime,pts:baseMediaDecodeTime+(startPts-startDts)},end:{dts:baseMediaDecodeTime+(endDts-startDts),pts:baseMediaDecodeTime+(endPts-startPts)},prependedContentDuration:prependedContentDuration,baseMediaDecodeTime:baseMediaDecodeTime}};_AudioSegmentStream=function(track,options){var adtsFrames=[],sequenceNumber=0,earliestAllowedDts=0,audioAppendStartTs=0,videoBaseMediaDecodeTime=1/0;options=options||{},_AudioSegmentStream.prototype.init.call(this),this.push=function(data){trackDecodeInfo.collectDtsInfo(track,data),track&&AUDIO_PROPERTIES.forEach(function(prop){track[prop]=data[prop]}),adtsFrames.push(data)},this.setEarliestDts=function(earliestDts){earliestAllowedDts=earliestDts-track.timelineStartInfo.baseMediaDecodeTime},this.setVideoBaseMediaDecodeTime=function(baseMediaDecodeTime){videoBaseMediaDecodeTime=baseMediaDecodeTime},this.setAudioAppendStart=function(timestamp){audioAppendStartTs=timestamp},this.flush=function(){var frames,moof,mdat,boxes,frameDuration;if(0===adtsFrames.length)return void this.trigger("done","AudioSegmentStream");frames=audioFrameUtils.trimAdtsFramesByEarliestDts(adtsFrames,track,earliestAllowedDts),track.baseMediaDecodeTime=trackDecodeInfo.calculateTrackBaseMediaDecodeTime(track,options.keepOriginalTimestamps),audioFrameUtils.prefixWithSilence(track,frames,audioAppendStartTs,videoBaseMediaDecodeTime),track.samples=audioFrameUtils.generateSampleTable(frames),mdat=mp4Generator.mdat(audioFrameUtils.concatenateFrameData(frames)),adtsFrames=[],moof=mp4Generator.moof(sequenceNumber,[track]),boxes=new Uint8Array(moof.byteLength+mdat.byteLength),sequenceNumber++,boxes.set(moof),boxes.set(mdat,moof.byteLength),trackDecodeInfo.clearDtsInfo(track),frameDuration=Math.ceil(1024*ONE_SECOND_IN_TS$3/track.samplerate),frames.length&&this.trigger("timingInfo",{start:frames[0].dts,end:frames[0].dts+frames.length*frameDuration}),this.trigger("data",{track:track,boxes:boxes}),this.trigger("done","AudioSegmentStream")},this.reset=function(){trackDecodeInfo.clearDtsInfo(track),adtsFrames=[],this.trigger("reset")}},_AudioSegmentStream.prototype=new stream,_VideoSegmentStream=function(track,options){var config,pps,sequenceNumber=0,nalUnits=[],gopsToAlignWith=[];options=options||{},_VideoSegmentStream.prototype.init.call(this),delete track.minPTS,this.gopCache_=[],this.push=function(nalUnit){trackDecodeInfo.collectDtsInfo(track,nalUnit),"seq_parameter_set_rbsp"!==nalUnit.nalUnitType||config||(config=nalUnit.config,track.sps=[nalUnit.data],VIDEO_PROPERTIES.forEach(function(prop){track[prop]=config[prop]},this)),"pic_parameter_set_rbsp"!==nalUnit.nalUnitType||pps||(pps=nalUnit.data,track.pps=[nalUnit.data]),nalUnits.push(nalUnit)},this.flush=function(){for(var frames,gopForFusion,gops,moof,mdat,boxes,firstGop,lastGop,prependedContentDuration=0;nalUnits.length&&"access_unit_delimiter_rbsp"!==nalUnits[0].nalUnitType;)nalUnits.shift();if(0===nalUnits.length)return this.resetStream_(),void this.trigger("done","VideoSegmentStream");if(frames=frameUtils.groupNalsIntoFrames(nalUnits),gops=frameUtils.groupFramesIntoGops(frames),gops[0][0].keyFrame||(gopForFusion=this.getGopForFusion_(nalUnits[0],track),gopForFusion?(prependedContentDuration=gopForFusion.duration,gops.unshift(gopForFusion),gops.byteLength+=gopForFusion.byteLength,gops.nalCount+=gopForFusion.nalCount,gops.pts=gopForFusion.pts,gops.dts=gopForFusion.dts,gops.duration+=gopForFusion.duration):gops=frameUtils.extendFirstKeyFrame(gops)),gopsToAlignWith.length){var alignedGops;if(!(alignedGops=options.alignGopsAtEnd?this.alignGopsAtEnd_(gops):this.alignGopsAtStart_(gops)))return this.gopCache_.unshift({gop:gops.pop(),pps:track.pps,sps:track.sps}),this.gopCache_.length=Math.min(6,this.gopCache_.length),nalUnits=[],this.resetStream_(),void this.trigger("done","VideoSegmentStream");trackDecodeInfo.clearDtsInfo(track),gops=alignedGops}trackDecodeInfo.collectDtsInfo(track,gops),track.samples=frameUtils.generateSampleTable(gops),mdat=mp4Generator.mdat(frameUtils.concatenateNalData(gops)),track.baseMediaDecodeTime=trackDecodeInfo.calculateTrackBaseMediaDecodeTime(track,options.keepOriginalTimestamps),this.trigger("processedGopsInfo",gops.map(function(gop){return{pts:gop.pts,dts:gop.dts,byteLength:gop.byteLength}})),firstGop=gops[0],lastGop=gops[gops.length-1],this.trigger("segmentTimingInfo",generateVideoSegmentTimingInfo(track.baseMediaDecodeTime,firstGop.dts,firstGop.pts,lastGop.dts+lastGop.duration,lastGop.pts+lastGop.duration,prependedContentDuration)),this.trigger("timingInfo",{start:gops[0].dts,end:gops[gops.length-1].dts+gops[gops.length-1].duration}),this.gopCache_.unshift({gop:gops.pop(),pps:track.pps,sps:track.sps}),this.gopCache_.length=Math.min(6,this.gopCache_.length),nalUnits=[],this.trigger("baseMediaDecodeTime",track.baseMediaDecodeTime),this.trigger("timelineStartInfo",track.timelineStartInfo),moof=mp4Generator.moof(sequenceNumber,[track]),boxes=new Uint8Array(moof.byteLength+mdat.byteLength),sequenceNumber++,boxes.set(moof),boxes.set(mdat,moof.byteLength),this.trigger("data",{track:track,boxes:boxes}),this.resetStream_(),this.trigger("done","VideoSegmentStream")},this.reset=function(){this.resetStream_(),nalUnits=[],this.gopCache_.length=0,gopsToAlignWith.length=0,this.trigger("reset")},this.resetStream_=function(){trackDecodeInfo.clearDtsInfo(track),config=void 0,pps=void 0},this.getGopForFusion_=function(nalUnit){var dtsDistance,nearestGopObj,currentGop,currentGopObj,i,nearestDistance=1/0;for(i=0;i<this.gopCache_.length;i++)currentGopObj=this.gopCache_[i],currentGop=currentGopObj.gop,track.pps&&arrayEquals(track.pps[0],currentGopObj.pps[0])&&track.sps&&arrayEquals(track.sps[0],currentGopObj.sps[0])&&(currentGop.dts<track.timelineStartInfo.dts||(dtsDistance=nalUnit.dts-currentGop.dts-currentGop.duration)>=-1e4&&dtsDistance<=45e3&&(!nearestGopObj||nearestDistance>dtsDistance)&&(nearestGopObj=currentGopObj,nearestDistance=dtsDistance));return nearestGopObj?nearestGopObj.gop:null},this.alignGopsAtStart_=function(gops){var alignIndex,gopIndex,align,gop,byteLength,nalCount,duration,alignedGops;for(byteLength=gops.byteLength,nalCount=gops.nalCount,duration=gops.duration,alignIndex=gopIndex=0;alignIndex<gopsToAlignWith.length&&gopIndex<gops.length&&(align=gopsToAlignWith[alignIndex],gop=gops[gopIndex],
align.pts!==gop.pts);)gop.pts>align.pts?alignIndex++:(gopIndex++,byteLength-=gop.byteLength,nalCount-=gop.nalCount,duration-=gop.duration);return 0===gopIndex?gops:gopIndex===gops.length?null:(alignedGops=gops.slice(gopIndex),alignedGops.byteLength=byteLength,alignedGops.duration=duration,alignedGops.nalCount=nalCount,alignedGops.pts=alignedGops[0].pts,alignedGops.dts=alignedGops[0].dts,alignedGops)},this.alignGopsAtEnd_=function(gops){var alignIndex,gopIndex,align,gop,alignEndIndex,matchFound;for(alignIndex=gopsToAlignWith.length-1,gopIndex=gops.length-1,alignEndIndex=null,matchFound=!1;alignIndex>=0&&gopIndex>=0;){if(align=gopsToAlignWith[alignIndex],gop=gops[gopIndex],align.pts===gop.pts){matchFound=!0;break}align.pts>gop.pts?alignIndex--:(alignIndex===gopsToAlignWith.length-1&&(alignEndIndex=gopIndex),gopIndex--)}if(!matchFound&&null===alignEndIndex)return null;var trimIndex;if(0===(trimIndex=matchFound?gopIndex:alignEndIndex))return gops;var alignedGops=gops.slice(trimIndex),metadata=alignedGops.reduce(function(total,gop){return total.byteLength+=gop.byteLength,total.duration+=gop.duration,total.nalCount+=gop.nalCount,total},{byteLength:0,duration:0,nalCount:0});return alignedGops.byteLength=metadata.byteLength,alignedGops.duration=metadata.duration,alignedGops.nalCount=metadata.nalCount,alignedGops.pts=alignedGops[0].pts,alignedGops.dts=alignedGops[0].dts,alignedGops},this.alignGopsWith=function(newGopsToAlignWith){gopsToAlignWith=newGopsToAlignWith}},_VideoSegmentStream.prototype=new stream,_CoalesceStream=function(options,metadataStream){this.numberOfTracks=0,this.metadataStream=metadataStream,options=options||{},void 0!==options.remux?this.remuxTracks=!!options.remux:this.remuxTracks=!0,"boolean"==typeof options.keepOriginalTimestamps?this.keepOriginalTimestamps=options.keepOriginalTimestamps:this.keepOriginalTimestamps=!1,this.pendingTracks=[],this.videoTrack=null,this.pendingBoxes=[],this.pendingCaptions=[],this.pendingMetadata=[],this.pendingBytes=0,this.emittedTracks=0,_CoalesceStream.prototype.init.call(this),this.push=function(output){return output.text?this.pendingCaptions.push(output):output.frames?this.pendingMetadata.push(output):(this.pendingTracks.push(output.track),this.pendingBytes+=output.boxes.byteLength,"video"===output.track.type&&(this.videoTrack=output.track,this.pendingBoxes.push(output.boxes)),void("audio"===output.track.type&&(this.audioTrack=output.track,this.pendingBoxes.unshift(output.boxes))))}},_CoalesceStream.prototype=new stream,_CoalesceStream.prototype.flush=function(flushSource){var caption,id3,initSegment,i,offset=0,event={captions:[],captionStreams:{},metadata:[],info:{}},timelineStartPts=0;if(this.pendingTracks.length<this.numberOfTracks){if("VideoSegmentStream"!==flushSource&&"AudioSegmentStream"!==flushSource)return;if(this.remuxTracks)return;if(0===this.pendingTracks.length)return void(++this.emittedTracks>=this.numberOfTracks&&(this.trigger("done"),this.emittedTracks=0))}if(this.videoTrack?(timelineStartPts=this.videoTrack.timelineStartInfo.pts,VIDEO_PROPERTIES.forEach(function(prop){event.info[prop]=this.videoTrack[prop]},this)):this.audioTrack&&(timelineStartPts=this.audioTrack.timelineStartInfo.pts,AUDIO_PROPERTIES.forEach(function(prop){event.info[prop]=this.audioTrack[prop]},this)),this.videoTrack||this.audioTrack){for(1===this.pendingTracks.length?event.type=this.pendingTracks[0].type:event.type="combined",this.emittedTracks+=this.pendingTracks.length,initSegment=mp4Generator.initSegment(this.pendingTracks),event.initSegment=new Uint8Array(initSegment.byteLength),event.initSegment.set(initSegment),event.data=new Uint8Array(this.pendingBytes),i=0;i<this.pendingBoxes.length;i++)event.data.set(this.pendingBoxes[i],offset),offset+=this.pendingBoxes[i].byteLength;for(i=0;i<this.pendingCaptions.length;i++)caption=this.pendingCaptions[i],caption.startTime=clock.metadataTsToSeconds(caption.startPts,timelineStartPts,this.keepOriginalTimestamps),caption.endTime=clock.metadataTsToSeconds(caption.endPts,timelineStartPts,this.keepOriginalTimestamps),event.captionStreams[caption.stream]=!0,event.captions.push(caption);for(i=0;i<this.pendingMetadata.length;i++)id3=this.pendingMetadata[i],id3.cueTime=clock.metadataTsToSeconds(id3.pts,timelineStartPts,this.keepOriginalTimestamps),event.metadata.push(id3);for(event.metadata.dispatchType=this.metadataStream.dispatchType,this.pendingTracks.length=0,this.videoTrack=null,this.pendingBoxes.length=0,this.pendingCaptions.length=0,this.pendingBytes=0,this.pendingMetadata.length=0,this.trigger("data",event),i=0;i<event.captions.length;i++)caption=event.captions[i],this.trigger("caption",caption);for(i=0;i<event.metadata.length;i++)id3=event.metadata[i],this.trigger("id3Frame",id3)}this.emittedTracks>=this.numberOfTracks&&(this.trigger("done"),this.emittedTracks=0)},_CoalesceStream.prototype.setRemux=function(val){this.remuxTracks=val},_Transmuxer=function(options){var videoTrack,audioTrack,self=this,hasFlushed=!0;_Transmuxer.prototype.init.call(this),options=options||{},this.baseMediaDecodeTime=options.baseMediaDecodeTime||0,this.transmuxPipeline_={},this.setupAacPipeline=function(){var pipeline={};this.transmuxPipeline_=pipeline,pipeline.type="aac",pipeline.metadataStream=new m2ts_1.MetadataStream,pipeline.aacStream=new aac,pipeline.audioTimestampRolloverStream=new m2ts_1.TimestampRolloverStream("audio"),pipeline.timedMetadataTimestampRolloverStream=new m2ts_1.TimestampRolloverStream("timed-metadata"),pipeline.adtsStream=new adts,pipeline.coalesceStream=new _CoalesceStream(options,pipeline.metadataStream),pipeline.headOfPipeline=pipeline.aacStream,pipeline.aacStream.pipe(pipeline.audioTimestampRolloverStream).pipe(pipeline.adtsStream),pipeline.aacStream.pipe(pipeline.timedMetadataTimestampRolloverStream).pipe(pipeline.metadataStream).pipe(pipeline.coalesceStream),pipeline.metadataStream.on("timestamp",function(frame){pipeline.aacStream.setTimestamp(frame.timeStamp)}),pipeline.aacStream.on("data",function(data){"timed-metadata"!==data.type||pipeline.audioSegmentStream||(audioTrack=audioTrack||{timelineStartInfo:{baseMediaDecodeTime:self.baseMediaDecodeTime},codec:"adts",type:"audio"},pipeline.coalesceStream.numberOfTracks++,pipeline.audioSegmentStream=new _AudioSegmentStream(audioTrack,options),pipeline.audioSegmentStream.on("timingInfo",self.trigger.bind(self,"audioTimingInfo")),pipeline.adtsStream.pipe(pipeline.audioSegmentStream).pipe(pipeline.coalesceStream)),self.trigger("trackinfo",{hasAudio:!!audioTrack,hasVideo:!!videoTrack})}),pipeline.coalesceStream.on("data",this.trigger.bind(this,"data")),pipeline.coalesceStream.on("done",this.trigger.bind(this,"done"))},this.setupTsPipeline=function(){var pipeline={};this.transmuxPipeline_=pipeline,pipeline.type="ts",pipeline.metadataStream=new m2ts_1.MetadataStream,pipeline.packetStream=new m2ts_1.TransportPacketStream,pipeline.parseStream=new m2ts_1.TransportParseStream,pipeline.elementaryStream=new m2ts_1.ElementaryStream,pipeline.timestampRolloverStream=new m2ts_1.TimestampRolloverStream,pipeline.adtsStream=new adts,pipeline.h264Stream=new H264Stream,pipeline.captionStream=new m2ts_1.CaptionStream,pipeline.coalesceStream=new _CoalesceStream(options,pipeline.metadataStream),pipeline.headOfPipeline=pipeline.packetStream,pipeline.packetStream.pipe(pipeline.parseStream).pipe(pipeline.elementaryStream).pipe(pipeline.timestampRolloverStream),pipeline.timestampRolloverStream.pipe(pipeline.h264Stream),pipeline.timestampRolloverStream.pipe(pipeline.adtsStream),pipeline.timestampRolloverStream.pipe(pipeline.metadataStream).pipe(pipeline.coalesceStream),pipeline.h264Stream.pipe(pipeline.captionStream).pipe(pipeline.coalesceStream),pipeline.elementaryStream.on("data",function(data){var i;if("metadata"===data.type){for(i=data.tracks.length;i--;)videoTrack||"video"!==data.tracks[i].type?audioTrack||"audio"!==data.tracks[i].type||(audioTrack=data.tracks[i],audioTrack.timelineStartInfo.baseMediaDecodeTime=self.baseMediaDecodeTime):(videoTrack=data.tracks[i],videoTrack.timelineStartInfo.baseMediaDecodeTime=self.baseMediaDecodeTime);videoTrack&&!pipeline.videoSegmentStream&&(pipeline.coalesceStream.numberOfTracks++,pipeline.videoSegmentStream=new _VideoSegmentStream(videoTrack,options),pipeline.videoSegmentStream.on("timelineStartInfo",function(timelineStartInfo){audioTrack&&(audioTrack.timelineStartInfo=timelineStartInfo,pipeline.audioSegmentStream.setEarliestDts(timelineStartInfo.dts))}),pipeline.videoSegmentStream.on("processedGopsInfo",self.trigger.bind(self,"gopInfo")),pipeline.videoSegmentStream.on("segmentTimingInfo",self.trigger.bind(self,"videoSegmentTimingInfo")),pipeline.videoSegmentStream.on("baseMediaDecodeTime",function(baseMediaDecodeTime){audioTrack&&pipeline.audioSegmentStream.setVideoBaseMediaDecodeTime(baseMediaDecodeTime)}),pipeline.videoSegmentStream.on("timingInfo",self.trigger.bind(self,"videoTimingInfo")),pipeline.h264Stream.pipe(pipeline.videoSegmentStream).pipe(pipeline.coalesceStream)),audioTrack&&!pipeline.audioSegmentStream&&(pipeline.coalesceStream.numberOfTracks++,pipeline.audioSegmentStream=new _AudioSegmentStream(audioTrack,options),pipeline.audioSegmentStream.on("timingInfo",self.trigger.bind(self,"audioTimingInfo")),pipeline.adtsStream.pipe(pipeline.audioSegmentStream).pipe(pipeline.coalesceStream)),self.trigger("trackinfo",{hasAudio:!!audioTrack,hasVideo:!!videoTrack})}}),pipeline.coalesceStream.on("data",this.trigger.bind(this,"data")),pipeline.coalesceStream.on("id3Frame",function(id3Frame){id3Frame.dispatchType=pipeline.metadataStream.dispatchType,self.trigger("id3Frame",id3Frame)}),pipeline.coalesceStream.on("caption",this.trigger.bind(this,"caption")),pipeline.coalesceStream.on("done",this.trigger.bind(this,"done"))},this.setBaseMediaDecodeTime=function(baseMediaDecodeTime){var pipeline=this.transmuxPipeline_;options.keepOriginalTimestamps||(this.baseMediaDecodeTime=baseMediaDecodeTime),audioTrack&&(audioTrack.timelineStartInfo.dts=void 0,audioTrack.timelineStartInfo.pts=void 0,trackDecodeInfo.clearDtsInfo(audioTrack),options.keepOriginalTimestamps||(audioTrack.timelineStartInfo.baseMediaDecodeTime=baseMediaDecodeTime),pipeline.audioTimestampRolloverStream&&pipeline.audioTimestampRolloverStream.discontinuity()),videoTrack&&(pipeline.videoSegmentStream&&(pipeline.videoSegmentStream.gopCache_=[]),videoTrack.timelineStartInfo.dts=void 0,videoTrack.timelineStartInfo.pts=void 0,trackDecodeInfo.clearDtsInfo(videoTrack),pipeline.captionStream.reset(),options.keepOriginalTimestamps||(videoTrack.timelineStartInfo.baseMediaDecodeTime=baseMediaDecodeTime)),pipeline.timestampRolloverStream&&pipeline.timestampRolloverStream.discontinuity()},this.setAudioAppendStart=function(timestamp){audioTrack&&this.transmuxPipeline_.audioSegmentStream.setAudioAppendStart(timestamp)},this.setRemux=function(val){var pipeline=this.transmuxPipeline_;options.remux=val,pipeline&&pipeline.coalesceStream&&pipeline.coalesceStream.setRemux(val)},this.alignGopsWith=function(gopsToAlignWith){videoTrack&&this.transmuxPipeline_.videoSegmentStream&&this.transmuxPipeline_.videoSegmentStream.alignGopsWith(gopsToAlignWith)},this.push=function(data){if(hasFlushed){var isAac=isLikelyAacData$1(data);isAac&&"aac"!==this.transmuxPipeline_.type?this.setupAacPipeline():isAac||"ts"===this.transmuxPipeline_.type||this.setupTsPipeline(),hasFlushed=!1}this.transmuxPipeline_.headOfPipeline.push(data)},this.flush=function(){hasFlushed=!0,this.transmuxPipeline_.headOfPipeline.flush()},this.endTimeline=function(){this.transmuxPipeline_.headOfPipeline.endTimeline()},this.reset=function(){this.transmuxPipeline_.headOfPipeline&&this.transmuxPipeline_.headOfPipeline.reset()},this.resetCaptions=function(){this.transmuxPipeline_.captionStream&&this.transmuxPipeline_.captionStream.reset()}},_Transmuxer.prototype=new stream;var transmuxer={Transmuxer:_Transmuxer,VideoSegmentStream:_VideoSegmentStream,AudioSegmentStream:_AudioSegmentStream,AUDIO_PROPERTIES:AUDIO_PROPERTIES,VIDEO_PROPERTIES:VIDEO_PROPERTIES,generateVideoSegmentTimingInfo:generateVideoSegmentTimingInfo},classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),wireTransmuxerEvents=function(self,transmuxer$$1){transmuxer$$1.on("data",function(segment){var initArray=segment.initSegment;segment.initSegment={data:initArray.buffer,byteOffset:initArray.byteOffset,byteLength:initArray.byteLength};var typedArray=segment.data;segment.data=typedArray.buffer,self.postMessage({action:"data",segment:segment,byteOffset:typedArray.byteOffset,byteLength:typedArray.byteLength},[segment.data])}),transmuxer$$1.captionStream&&transmuxer$$1.captionStream.on("data",function(caption){self.postMessage({action:"caption",data:caption})}),transmuxer$$1.on("done",function(data){self.postMessage({action:"done"})}),transmuxer$$1.on("gopInfo",function(gopInfo){self.postMessage({action:"gopInfo",gopInfo:gopInfo})}),transmuxer$$1.on("videoSegmentTimingInfo",function(videoSegmentTimingInfo){self.postMessage({action:"videoSegmentTimingInfo",videoSegmentTimingInfo:videoSegmentTimingInfo})})},MessageHandlers=function(){function MessageHandlers(self,options){classCallCheck(this,MessageHandlers),this.options=options||{},this.self=self,this.init()}return createClass(MessageHandlers,[{key:"init",value:function(){this.transmuxer&&this.transmuxer.dispose(),this.transmuxer=new transmuxer.Transmuxer(this.options),wireTransmuxerEvents(this.self,this.transmuxer)}},{key:"push",value:function(data){var segment=new Uint8Array(data.data,data.byteOffset,data.byteLength);this.transmuxer.push(segment)}},{key:"reset",value:function(){this.init()}},{key:"setTimestampOffset",value:function(data){var timestampOffset=data.timestampOffset||0;this.transmuxer.setBaseMediaDecodeTime(Math.round(9e4*timestampOffset))}},{key:"setAudioAppendStart",value:function(data){this.transmuxer.setAudioAppendStart(Math.ceil(9e4*data.appendStart))}},{key:"flush",value:function(data){this.transmuxer.flush()}},{key:"resetCaptions",value:function(){this.transmuxer.resetCaptions()}},{key:"alignGopsWith",value:function(data){this.transmuxer.alignGopsWith(data.gopsToAlignWith.slice())}}]),MessageHandlers}();new function(self){self.onmessage=function(event){if("init"===event.data.action&&event.data.options)return void(this.messageHandlers=new MessageHandlers(self,event.data.options));this.messageHandlers||(this.messageHandlers=new MessageHandlers(self)),event.data&&event.data.action&&"init"!==event.data.action&&this.messageHandlers[event.data.action]&&this.messageHandlers[event.data.action](event.data)}}(self)}()}),defaultCodecs={videoCodec:"avc1",videoObjectTypeIndicator:".4d400d",audioProfile:"2"},translateLegacyCodecs=function(codecs){return codecs.map(function(codec){return codec.replace(/avc1\.(\d+)\.(\d+)/i,function(orig,profile,avcLevel){return"avc1."+("00"+Number(profile).toString(16)).slice(-2)+"00"+("00"+Number(avcLevel).toString(16)).slice(-2)})})},parseCodecs=function(){var codecs=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",result={codecCount:0},parsed=void 0;return result.codecCount=codecs.split(",").length,result.codecCount=result.codecCount||2,parsed=/(^|\s|,)+(avc[13])([^ ,]*)/i.exec(codecs),parsed&&(result.videoCodec=parsed[2],result.videoObjectTypeIndicator=parsed[3]),result.audioProfile=/(^|\s|,)+mp4a.[0-9A-Fa-f]+\.([0-9A-Fa-f]+)/i.exec(codecs),result.audioProfile=result.audioProfile&&result.audioProfile[2],result},mapLegacyAvcCodecs=function(codecString){return codecString.replace(/avc1\.(\d+)\.(\d+)/i,function(match){return translateLegacyCodecs([match])[0]})},makeMimeTypeString=function(type,container,codecs){return type+"/"+container+'; codecs="'+codecs.filter(function(c){return!!c}).join(", ")+'"'},getContainerType=function(media){return media.segments&&media.segments.length&&media.segments[0].map?"mp4":"mp2t"},getCodecs=function(media){var mediaAttributes=media.attributes||{};return mediaAttributes.CODECS?parseCodecs(mediaAttributes.CODECS):defaultCodecs},audioProfileFromDefault=function(master,audioGroupId){if(!master.mediaGroups.AUDIO||!audioGroupId)return null;var audioGroup=master.mediaGroups.AUDIO[audioGroupId];if(!audioGroup)return null;for(var name in audioGroup){var audioType=audioGroup[name];if(audioType.default&&audioType.playlists)return parseCodecs(audioType.playlists[0].attributes.CODECS).audioProfile}return null},mimeTypesForPlaylist=function(master,media){var containerType=getContainerType(media),codecInfo=getCodecs(media),mediaAttributes=media.attributes||{},isMuxed=!0,isMaat=!1;if(!media)return[];if(master.mediaGroups.AUDIO&&mediaAttributes.AUDIO){var audioGroup=master.mediaGroups.AUDIO[mediaAttributes.AUDIO];if(audioGroup){isMaat=!0,isMuxed=!1;for(var groupId in audioGroup)if(!audioGroup[groupId].uri&&!audioGroup[groupId].playlists){isMuxed=!0;break}}}isMaat&&!codecInfo.audioProfile&&(isMuxed||(codecInfo.audioProfile=audioProfileFromDefault(master,mediaAttributes.AUDIO)),codecInfo.audioProfile||(videojs.log.warn("Multiple audio tracks present but no audio codec string is specified. Attempting to use the default audio codec (mp4a.40.2)"),codecInfo.audioProfile=defaultCodecs.audioProfile));var codecStrings={};codecInfo.videoCodec&&(codecStrings.video=""+codecInfo.videoCodec+codecInfo.videoObjectTypeIndicator),codecInfo.audioProfile&&(codecStrings.audio="mp4a.40."+codecInfo.audioProfile);var justAudio=makeMimeTypeString("audio",containerType,[codecStrings.audio]),justVideo=makeMimeTypeString("video",containerType,[codecStrings.video]),bothVideoAudio=makeMimeTypeString("video",containerType,[codecStrings.video,codecStrings.audio]);return isMaat?!isMuxed&&codecStrings.video?[justVideo,justAudio]:isMuxed||codecStrings.video?[bothVideoAudio,justAudio]:[justAudio,justAudio]:codecStrings.video?[bothVideoAudio]:[justAudio]},parseContentType=function(type){var object={type:"",parameters:{}},parameters=type.trim().split(";");return object.type=parameters.shift().trim(),parameters.forEach(function(parameter){var pair=parameter.trim().split("=");if(pair.length>1){var name=pair[0].replace(/"/g,"").trim(),value=pair[1].replace(/"/g,"").trim();object.parameters[name]=value}}),object},isAudioCodec=function(codec){return/mp4a\.\d+.\d+/i.test(codec)},isVideoCodec=function(codec){return/avc1\.[\da-f]+/i.test(codec)},gopsSafeToAlignWith=function(buffer,currentTime,mapping){if(void 0===currentTime||null===currentTime||!buffer.length)return[];var currentTimePts=Math.ceil(9e4*(currentTime-mapping+3)),i=void 0;for(i=0;i<buffer.length&&!(buffer[i].pts>currentTimePts);i++);return buffer.slice(i)},updateGopBuffer=function(buffer,gops,replace){if(!gops.length)return buffer;if(replace)return gops.slice();var start=gops[0].pts,i=0;for(i;i<buffer.length&&!(buffer[i].pts>=start);i++);return buffer.slice(0,i).concat(gops)},removeGopBuffer=function(buffer,start,end,mapping){for(var startPts=Math.ceil(9e4*(start-mapping)),endPts=Math.ceil(9e4*(end-mapping)),updatedBuffer=buffer.slice(),i=buffer.length;i--&&!(buffer[i].pts<=endPts););if(-1===i)return updatedBuffer;for(var j=i+1;j--&&!(buffer[j].pts<=startPts););return j=Math.max(j,0),updatedBuffer.splice(j,i-j+1),updatedBuffer},buffered=function(videoBuffer,audioBuffer,audioDisabled){var start=null,end=null,arity=0,extents=[],ranges=[];if(!videoBuffer&&!audioBuffer)return videojs.createTimeRange();if(!videoBuffer)return audioBuffer.buffered;if(!audioBuffer)return videoBuffer.buffered;if(audioDisabled)return videoBuffer.buffered;if(0===videoBuffer.buffered.length&&0===audioBuffer.buffered.length)return videojs.createTimeRange();for(var videoBuffered=videoBuffer.buffered,audioBuffered=audioBuffer.buffered,count=videoBuffered.length;count--;)extents.push({time:videoBuffered.start(count),type:"start"}),extents.push({time:videoBuffered.end(count),type:"end"});for(count=audioBuffered.length;count--;)extents.push({time:audioBuffered.start(count),type:"start"}),extents.push({time:audioBuffered.end(count),type:"end"});for(extents.sort(function(a,b){return a.time-b.time}),count=0;count<extents.length;count++)"start"===extents[count].type?2===++arity&&(start=extents[count].time):"end"===extents[count].type&&1===--arity&&(end=extents[count].time),null!==start&&null!==end&&(ranges.push([start,end]),start=null,end=null);return videojs.createTimeRanges(ranges)},makeWrappedSourceBuffer=function(mediaSource,mimeType){var sourceBuffer=mediaSource.addSourceBuffer(mimeType),wrapper=Object.create(null);wrapper.updating=!1,wrapper.realBuffer_=sourceBuffer;for(var key in sourceBuffer)!function(key){"function"==typeof sourceBuffer[key]?wrapper[key]=function(){return sourceBuffer[key].apply(sourceBuffer,arguments)}:void 0===wrapper[key]&&Object.defineProperty(wrapper,key,{get:function(){return sourceBuffer[key]},set:function(v){return sourceBuffer[key]=v}})}(key);return wrapper},VirtualSourceBuffer=function(_videojs$EventTarget){inherits(VirtualSourceBuffer,_videojs$EventTarget);function VirtualSourceBuffer(mediaSource,codecs){classCallCheck(this,VirtualSourceBuffer);var _this=possibleConstructorReturn(this,(VirtualSourceBuffer.__proto__||Object.getPrototypeOf(VirtualSourceBuffer)).call(this,videojs.EventTarget));_this.timestampOffset_=0,_this.pendingBuffers_=[],_this.bufferUpdating_=!1,_this.mediaSource_=mediaSource,_this.codecs_=codecs,_this.audioCodec_=null,_this.videoCodec_=null,_this.audioDisabled_=!1,_this.appendAudioInitSegment_=!0,_this.gopBuffer_=[],_this.timeMapping_=0,_this.safeAppend_=videojs.browser.IE_VERSION>=11;var options={remux:!1,alignGopsAtEnd:_this.safeAppend_};return _this.codecs_.forEach(function(codec){isAudioCodec(codec)?_this.audioCodec_=codec:isVideoCodec(codec)&&(_this.videoCodec_=codec)}),_this.transmuxer_=new TransmuxWorker,_this.transmuxer_.postMessage({action:"init",options:options}),_this.transmuxer_.onmessage=function(event){return"data"===event.data.action?_this.data_(event):"done"===event.data.action?_this.done_(event):"gopInfo"===event.data.action?_this.appendGopInfo_(event):"videoSegmentTimingInfo"===event.data.action?_this.videoSegmentTimingInfo_(event.data.videoSegmentTimingInfo):void 0},Object.defineProperty(_this,"timestampOffset",{get:function(){return this.timestampOffset_},set:function(val){"number"==typeof val&&val>=0&&(this.timestampOffset_=val,this.appendAudioInitSegment_=!0,this.gopBuffer_.length=0,this.timeMapping_=0,this.transmuxer_.postMessage({action:"setTimestampOffset",timestampOffset:val}))}}),Object.defineProperty(_this,"appendWindowStart",{get:function(){return(this.videoBuffer_||this.audioBuffer_).appendWindowStart},set:function(start){this.videoBuffer_&&(this.videoBuffer_.appendWindowStart=start),this.audioBuffer_&&(this.audioBuffer_.appendWindowStart=start)}}),Object.defineProperty(_this,"updating",{get:function(){return!!(this.bufferUpdating_||!this.audioDisabled_&&this.audioBuffer_&&this.audioBuffer_.updating||this.videoBuffer_&&this.videoBuffer_.updating)}}),Object.defineProperty(_this,"buffered",{get:function(){return buffered(this.videoBuffer_,this.audioBuffer_,this.audioDisabled_)}}),_this}return createClass(VirtualSourceBuffer,[{key:"data_",value:function(event){var segment=event.data.segment;segment.data=new Uint8Array(segment.data,event.data.byteOffset,event.data.byteLength),segment.initSegment=new Uint8Array(segment.initSegment.data,segment.initSegment.byteOffset,segment.initSegment.byteLength),createTextTracksIfNecessary(this,this.mediaSource_,segment),this.pendingBuffers_.push(segment)}},{key:"done_",value:function(event){if("closed"===this.mediaSource_.readyState)return void(this.pendingBuffers_.length=0);this.processPendingSegments_()}},{key:"videoSegmentTimingInfo_",value:function(timingInfo){var timingInfoInSeconds={start:{decode:timingInfo.start.dts/9e4,presentation:timingInfo.start.pts/9e4},end:{decode:timingInfo.end.dts/9e4,presentation:timingInfo.end.pts/9e4},baseMediaDecodeTime:timingInfo.baseMediaDecodeTime/9e4};timingInfo.prependedContentDuration&&(timingInfoInSeconds.prependedContentDuration=timingInfo.prependedContentDuration/9e4),this.trigger({type:"videoSegmentTimingInfo",videoSegmentTimingInfo:timingInfoInSeconds})}},{key:"createRealSourceBuffers_",value:function(){var _this2=this,types=["audio","video"];types.forEach(function(type){if(_this2[type+"Codec_"]&&!_this2[type+"Buffer_"]){var buffer=null;if(_this2.mediaSource_[type+"Buffer_"])buffer=_this2.mediaSource_[type+"Buffer_"],buffer.updating=!1;else{var codecProperty=type+"Codec_",mimeType=type+'/mp4;codecs="'+_this2[codecProperty]+'"';buffer=makeWrappedSourceBuffer(_this2.mediaSource_.nativeMediaSource_,mimeType),_this2.mediaSource_[type+"Buffer_"]=buffer}_this2[type+"Buffer_"]=buffer,["update","updatestart","updateend"].forEach(function(event){buffer.addEventListener(event,function(){if("audio"!==type||!_this2.audioDisabled_){"updateend"===event&&(_this2[type+"Buffer_"].updating=!1);return types.every(function(t){return!("audio"!==t||!_this2.audioDisabled_)||(type===t||!_this2[t+"Buffer_"]||!_this2[t+"Buffer_"].updating)})?_this2.trigger(event):void 0}})})}})}},{key:"appendBuffer",value:function(segment){if(this.bufferUpdating_=!0,this.audioBuffer_&&this.audioBuffer_.buffered.length){var audioBuffered=this.audioBuffer_.buffered;this.transmuxer_.postMessage({action:"setAudioAppendStart",appendStart:audioBuffered.end(audioBuffered.length-1)})}this.videoBuffer_&&this.transmuxer_.postMessage({action:"alignGopsWith",gopsToAlignWith:gopsSafeToAlignWith(this.gopBuffer_,this.mediaSource_.player_?this.mediaSource_.player_.currentTime():null,this.timeMapping_)}),this.transmuxer_.postMessage({action:"push",data:segment.buffer,byteOffset:segment.byteOffset,byteLength:segment.byteLength},[segment.buffer]),this.transmuxer_.postMessage({action:"flush"})}},{key:"appendGopInfo_",value:function(event){this.gopBuffer_=updateGopBuffer(this.gopBuffer_,event.data.gopInfo,this.safeAppend_)}},{key:"remove",value:function(start,end){if(this.videoBuffer_&&(this.videoBuffer_.updating=!0,this.videoBuffer_.remove(start,end),this.gopBuffer_=removeGopBuffer(this.gopBuffer_,start,end,this.timeMapping_)),!this.audioDisabled_&&this.audioBuffer_&&(this.audioBuffer_.updating=!0,this.audioBuffer_.remove(start,end)),removeCuesFromTrack(start,end,this.metadataTrack_),this.inbandTextTracks_)for(var track in this.inbandTextTracks_)removeCuesFromTrack(start,end,this.inbandTextTracks_[track])}},{key:"processPendingSegments_",value:function(){var sortedSegments={video:{segments:[],bytes:0},audio:{segments:[],bytes:0},captions:[],metadata:[]};if(!this.pendingBuffers_.length)return this.trigger("updateend"),void(this.bufferUpdating_=!1);sortedSegments=this.pendingBuffers_.reduce(function(segmentObj,segment){var type=segment.type,data=segment.data,initSegment=segment.initSegment;return segmentObj[type].segments.push(data),segmentObj[type].bytes+=data.byteLength,segmentObj[type].initSegment=initSegment,segment.captions&&(segmentObj.captions=segmentObj.captions.concat(segment.captions)),segment.info&&(segmentObj[type].info=segment.info),segment.metadata&&(segmentObj.metadata=segmentObj.metadata.concat(segment.metadata)),segmentObj},sortedSegments),this.videoBuffer_||this.audioBuffer_||(0===sortedSegments.video.bytes&&(this.videoCodec_=null),0===sortedSegments.audio.bytes&&(this.audioCodec_=null),this.createRealSourceBuffers_()),sortedSegments.audio.info&&this.mediaSource_.trigger({type:"audioinfo",info:sortedSegments.audio.info}),sortedSegments.video.info&&this.mediaSource_.trigger({type:"videoinfo",info:sortedSegments.video.info}),this.appendAudioInitSegment_&&(!this.audioDisabled_&&this.audioBuffer_&&(sortedSegments.audio.segments.unshift(sortedSegments.audio.initSegment),sortedSegments.audio.bytes+=sortedSegments.audio.initSegment.byteLength),this.appendAudioInitSegment_=!1);var triggerUpdateend=!1;this.videoBuffer_&&sortedSegments.video.bytes?(sortedSegments.video.segments.unshift(sortedSegments.video.initSegment),sortedSegments.video.bytes+=sortedSegments.video.initSegment.byteLength,this.concatAndAppendSegments_(sortedSegments.video,this.videoBuffer_)):!this.videoBuffer_||!this.audioDisabled_&&this.audioBuffer_||(triggerUpdateend=!0),addTextTrackData(this,sortedSegments.captions,sortedSegments.metadata),!this.audioDisabled_&&this.audioBuffer_&&this.concatAndAppendSegments_(sortedSegments.audio,this.audioBuffer_),this.pendingBuffers_.length=0,triggerUpdateend&&this.trigger("updateend"),this.bufferUpdating_=!1}},{key:"concatAndAppendSegments_",value:function(segmentObj,destinationBuffer){var offset=0,tempBuffer=void 0;if(segmentObj.bytes){tempBuffer=new Uint8Array(segmentObj.bytes),segmentObj.segments.forEach(function(segment){tempBuffer.set(segment,offset),offset+=segment.byteLength});try{destinationBuffer.updating=!0,destinationBuffer.appendBuffer(tempBuffer)}catch(error){this.mediaSource_.player_&&this.mediaSource_.player_.error({code:-3,type:"APPEND_BUFFER_ERR",message:error.message,originalError:error})}}}},{key:"abort",value:function(){this.videoBuffer_&&this.videoBuffer_.abort(),!this.audioDisabled_&&this.audioBuffer_&&this.audioBuffer_.abort(),this.transmuxer_&&this.transmuxer_.postMessage({action:"reset"}),this.pendingBuffers_.length=0,this.bufferUpdating_=!1}}]),VirtualSourceBuffer}(videojs.EventTarget),HtmlMediaSource=function(_videojs$EventTarget){inherits(HtmlMediaSource,_videojs$EventTarget);function HtmlMediaSource(){classCallCheck(this,HtmlMediaSource);var _this=possibleConstructorReturn(this,(HtmlMediaSource.__proto__||Object.getPrototypeOf(HtmlMediaSource)).call(this)),property=void 0;_this.nativeMediaSource_=new window_1.MediaSource;for(property in _this.nativeMediaSource_)property in HtmlMediaSource.prototype||"function"!=typeof _this.nativeMediaSource_[property]||(_this[property]=_this.nativeMediaSource_[property].bind(_this.nativeMediaSource_));return _this.duration_=NaN,Object.defineProperty(_this,"duration",{get:function(){return this.duration_===1/0?this.duration_:this.nativeMediaSource_.duration},set:function(duration){if(this.duration_=duration,duration!==1/0)return void(this.nativeMediaSource_.duration=duration)}}),Object.defineProperty(_this,"seekable",{get:function(){return this.duration_===1/0?videojs.createTimeRanges([[0,this.nativeMediaSource_.duration]]):this.nativeMediaSource_.seekable}}),Object.defineProperty(_this,"readyState",{get:function(){return this.nativeMediaSource_.readyState}}),Object.defineProperty(_this,"activeSourceBuffers",{get:function(){return this.activeSourceBuffers_}}),_this.sourceBuffers=[],_this.activeSourceBuffers_=[],_this.updateActiveSourceBuffers_=function(){if(_this.activeSourceBuffers_.length=0,1===_this.sourceBuffers.length){var sourceBuffer=_this.sourceBuffers[0];return sourceBuffer.appendAudioInitSegment_=!0,sourceBuffer.audioDisabled_=!sourceBuffer.audioCodec_,void _this.activeSourceBuffers_.push(sourceBuffer)}for(var disableCombined=!1,disableAudioOnly=!0,i=0;i<_this.player_.audioTracks().length;i++){var track=_this.player_.audioTracks()[i];if(track.enabled&&"main"!==track.kind){disableCombined=!0,disableAudioOnly=!1;break}}_this.sourceBuffers.forEach(function(sourceBuffer,index){if(sourceBuffer.appendAudioInitSegment_=!0,sourceBuffer.videoCodec_&&sourceBuffer.audioCodec_)sourceBuffer.audioDisabled_=disableCombined;else if(sourceBuffer.videoCodec_&&!sourceBuffer.audioCodec_)sourceBuffer.audioDisabled_=!0,
disableAudioOnly=!1;else if(!sourceBuffer.videoCodec_&&sourceBuffer.audioCodec_&&(sourceBuffer.audioDisabled_=index?disableAudioOnly:!disableAudioOnly,sourceBuffer.audioDisabled_))return;_this.activeSourceBuffers_.push(sourceBuffer)})},_this.onPlayerMediachange_=function(){_this.sourceBuffers.forEach(function(sourceBuffer){sourceBuffer.appendAudioInitSegment_=!0})},_this.onHlsReset_=function(){_this.sourceBuffers.forEach(function(sourceBuffer){sourceBuffer.transmuxer_&&sourceBuffer.transmuxer_.postMessage({action:"resetCaptions"})})},_this.onHlsSegmentTimeMapping_=function(event){_this.sourceBuffers.forEach(function(buffer){return buffer.timeMapping_=event.mapping})},["sourceopen","sourceclose","sourceended"].forEach(function(eventName){this.nativeMediaSource_.addEventListener(eventName,this.trigger.bind(this))},_this),_this.on("sourceopen",function(event){var video=document_1.querySelector('[src="'+_this.url_+'"]');video&&(_this.player_=videojs(video.parentNode),_this.player_&&(_this.player_.tech_.on("hls-reset",_this.onHlsReset_),_this.player_.tech_.on("hls-segment-time-mapping",_this.onHlsSegmentTimeMapping_),_this.player_.audioTracks&&_this.player_.audioTracks()&&(_this.player_.audioTracks().on("change",_this.updateActiveSourceBuffers_),_this.player_.audioTracks().on("addtrack",_this.updateActiveSourceBuffers_),_this.player_.audioTracks().on("removetrack",_this.updateActiveSourceBuffers_)),_this.player_.on("mediachange",_this.onPlayerMediachange_)))}),_this.on("sourceended",function(event){for(var duration=durationOfVideo(_this.duration),i=0;i<_this.sourceBuffers.length;i++){var sourcebuffer=_this.sourceBuffers[i],cues=sourcebuffer.metadataTrack_&&sourcebuffer.metadataTrack_.cues;cues&&cues.length&&(cues[cues.length-1].endTime=duration)}}),_this.on("sourceclose",function(event){this.sourceBuffers.forEach(function(sourceBuffer){sourceBuffer.transmuxer_&&sourceBuffer.transmuxer_.terminate()}),this.sourceBuffers.length=0,this.player_&&(this.player_.audioTracks&&this.player_.audioTracks()&&(this.player_.audioTracks().off("change",this.updateActiveSourceBuffers_),this.player_.audioTracks().off("addtrack",this.updateActiveSourceBuffers_),this.player_.audioTracks().off("removetrack",this.updateActiveSourceBuffers_)),this.player_.el_&&this.player_.off("mediachange",this.onPlayerMediachange_),this.player_.tech_&&this.player_.tech_.el_&&(this.player_.tech_.off("hls-reset",this.onHlsReset_),this.player_.tech_.off("hls-segment-time-mapping",this.onHlsSegmentTimeMapping_)))}),_this}return createClass(HtmlMediaSource,[{key:"addSeekableRange_",value:function(start,end){var error=void 0;if(this.duration!==1/0)throw error=new Error("MediaSource.addSeekableRange() can only be invoked when the duration is Infinity"),error.name="InvalidStateError",error.code=11,error;(end>this.nativeMediaSource_.duration||isNaN(this.nativeMediaSource_.duration))&&(this.nativeMediaSource_.duration=end)}},{key:"addSourceBuffer",value:function(type){var buffer=void 0,parsedType=parseContentType(type);if(/^(video|audio)\/mp2t$/i.test(parsedType.type)){var codecs=[];parsedType.parameters&&parsedType.parameters.codecs&&(codecs=parsedType.parameters.codecs.split(","),codecs=translateLegacyCodecs(codecs),codecs=codecs.filter(function(codec){return isAudioCodec(codec)||isVideoCodec(codec)})),0===codecs.length&&(codecs=["avc1.4d400d","mp4a.40.2"]),buffer=new VirtualSourceBuffer(this,codecs),0!==this.sourceBuffers.length&&(this.sourceBuffers[0].createRealSourceBuffers_(),buffer.createRealSourceBuffers_(),this.sourceBuffers[0].audioDisabled_=!0)}else buffer=this.nativeMediaSource_.addSourceBuffer(type);return this.sourceBuffers.push(buffer),buffer}}]),HtmlMediaSource}(videojs.EventTarget),urlCount=0;videojs.mediaSources={};var open=function(msObjectURL,swfId){var mediaSource=videojs.mediaSources[msObjectURL];if(!mediaSource)throw new Error("Media Source not found (Video.js)");mediaSource.trigger({type:"sourceopen",swfId:swfId})},supportsNativeMediaSources=function(){return!!window_1.MediaSource&&!!window_1.MediaSource.isTypeSupported&&window_1.MediaSource.isTypeSupported('video/mp4;codecs="avc1.4d400d,mp4a.40.2"')},MediaSource=function(){if(this.MediaSource={open:open,supportsNativeMediaSources:supportsNativeMediaSources},supportsNativeMediaSources())return new HtmlMediaSource;throw new Error("Cannot use create a virtual MediaSource for this video")};MediaSource.open=open,MediaSource.supportsNativeMediaSources=supportsNativeMediaSources;var URL$1={createObjectURL:function(object){var url=void 0;return object instanceof HtmlMediaSource?(url=window_1.URL.createObjectURL(object.nativeMediaSource_),object.url_=url,url):object instanceof HtmlMediaSource?(url="blob:vjs-media-source/"+urlCount,urlCount++,videojs.mediaSources[url]=object,url):(url=window_1.URL.createObjectURL(object),object.url_=url,url)}};videojs.MediaSource=MediaSource,videojs.URL=URL$1;var isObject=function(obj){return!!obj&&"object"==typeof obj},merge=function merge(){for(var _len=arguments.length,objects=new Array(_len),_key=0;_key<_len;_key++)objects[_key]=arguments[_key];return objects.reduce(function(result,source){return Object.keys(source).forEach(function(key){Array.isArray(result[key])&&Array.isArray(source[key])?result[key]=result[key].concat(source[key]):isObject(result[key])&&isObject(source[key])?result[key]=merge(result[key],source[key]):result[key]=source[key]}),result},{})},values=function(o){return Object.keys(o).map(function(k){return o[k]})},range=function(start,end){for(var result=[],i=start;i<end;i++)result.push(i);return result},flatten=function(lists){return lists.reduce(function(x,y){return x.concat(y)},[])},from=function(list){if(!list.length)return[];for(var result=[],i=0;i<list.length;i++)result.push(list[i]);return result},findIndexes=function(l,key){return l.reduce(function(a,e,i){return e[key]&&a.push(i),a},[])},errors={INVALID_NUMBER_OF_PERIOD:"INVALID_NUMBER_OF_PERIOD",DASH_EMPTY_MANIFEST:"DASH_EMPTY_MANIFEST",DASH_INVALID_XML:"DASH_INVALID_XML",NO_BASE_URL:"NO_BASE_URL",MISSING_SEGMENT_INFORMATION:"MISSING_SEGMENT_INFORMATION",SEGMENT_TIME_UNSPECIFIED:"SEGMENT_TIME_UNSPECIFIED",UNSUPPORTED_UTC_TIMING_SCHEME:"UNSUPPORTED_UTC_TIMING_SCHEME"};"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var urlToolkit$1=function(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}(function(module,exports){!function(root){var URL_REGEX=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/?#]*)?((?:[^\/\?#]*\/)*.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,FIRST_SEGMENT_REGEX=/^([^\/?#]*)(.*)$/,SLASH_DOT_REGEX=/(?:\/|^)\.(?=\/)/g,SLASH_DOT_DOT_REGEX=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g,URLToolkit={buildAbsoluteURL:function(baseURL,relativeURL,opts){if(opts=opts||{},baseURL=baseURL.trim(),!(relativeURL=relativeURL.trim())){if(!opts.alwaysNormalize)return baseURL;var basePartsForNormalise=URLToolkit.parseURL(baseURL);if(!basePartsForNormalise)throw new Error("Error trying to parse base URL.");return basePartsForNormalise.path=URLToolkit.normalizePath(basePartsForNormalise.path),URLToolkit.buildURLFromParts(basePartsForNormalise)}var relativeParts=URLToolkit.parseURL(relativeURL);if(!relativeParts)throw new Error("Error trying to parse relative URL.");if(relativeParts.scheme)return opts.alwaysNormalize?(relativeParts.path=URLToolkit.normalizePath(relativeParts.path),URLToolkit.buildURLFromParts(relativeParts)):relativeURL;var baseParts=URLToolkit.parseURL(baseURL);if(!baseParts)throw new Error("Error trying to parse base URL.");if(!baseParts.netLoc&&baseParts.path&&"/"!==baseParts.path[0]){var pathParts=FIRST_SEGMENT_REGEX.exec(baseParts.path);baseParts.netLoc=pathParts[1],baseParts.path=pathParts[2]}baseParts.netLoc&&!baseParts.path&&(baseParts.path="/");var builtParts={scheme:baseParts.scheme,netLoc:relativeParts.netLoc,path:null,params:relativeParts.params,query:relativeParts.query,fragment:relativeParts.fragment};if(!relativeParts.netLoc&&(builtParts.netLoc=baseParts.netLoc,"/"!==relativeParts.path[0]))if(relativeParts.path){var baseURLPath=baseParts.path,newPath=baseURLPath.substring(0,baseURLPath.lastIndexOf("/")+1)+relativeParts.path;builtParts.path=URLToolkit.normalizePath(newPath)}else builtParts.path=baseParts.path,relativeParts.params||(builtParts.params=baseParts.params,relativeParts.query||(builtParts.query=baseParts.query));return null===builtParts.path&&(builtParts.path=opts.alwaysNormalize?URLToolkit.normalizePath(relativeParts.path):relativeParts.path),URLToolkit.buildURLFromParts(builtParts)},parseURL:function(url){var parts=URL_REGEX.exec(url);return parts?{scheme:parts[1]||"",netLoc:parts[2]||"",path:parts[3]||"",params:parts[4]||"",query:parts[5]||"",fragment:parts[6]||""}:null},normalizePath:function(path){for(path=path.split("").reverse().join("").replace(SLASH_DOT_REGEX,"");path.length!==(path=path.replace(SLASH_DOT_DOT_REGEX,"")).length;);return path.split("").reverse().join("")},buildURLFromParts:function(parts){return parts.scheme+parts.netLoc+parts.path+parts.params+parts.query+parts.fragment}};module.exports=URLToolkit}()}),resolveUrl$1=function(baseUrl,relativeUrl){return/^[a-z]+:/i.test(relativeUrl)?relativeUrl:(/\/\//i.test(baseUrl)||(baseUrl=urlToolkit$1.buildAbsoluteURL(window_1.location.href,baseUrl)),urlToolkit$1.buildAbsoluteURL(baseUrl,relativeUrl))},urlTypeToSegment=function(_ref){var _ref$baseUrl=_ref.baseUrl,baseUrl=void 0===_ref$baseUrl?"":_ref$baseUrl,_ref$source=_ref.source,source=void 0===_ref$source?"":_ref$source,_ref$range=_ref.range,range=void 0===_ref$range?"":_ref$range,_ref$indexRange=_ref.indexRange,indexRange=void 0===_ref$indexRange?"":_ref$indexRange,segment={uri:source,resolvedUri:resolveUrl$1(baseUrl||"",source)};if(range||indexRange){var rangeStr=range||indexRange,ranges=rangeStr.split("-"),startRange=parseInt(ranges[0],10),endRange=parseInt(ranges[1],10);segment.byterange={length:endRange-startRange+1,offset:startRange}}return segment},byteRangeToString=function(byterange){var endRange=byterange.offset+byterange.length-1;return byterange.offset+"-"+endRange},segmentRange={static:function(attributes){var duration=attributes.duration,_attributes$timescale=attributes.timescale,timescale=void 0===_attributes$timescale?1:_attributes$timescale,sourceDuration=attributes.sourceDuration;return{start:0,end:Math.ceil(sourceDuration/(duration/timescale))}},dynamic:function(attributes){var NOW=attributes.NOW,clientOffset=attributes.clientOffset,availabilityStartTime=attributes.availabilityStartTime,_attributes$timescale2=attributes.timescale,timescale=void 0===_attributes$timescale2?1:_attributes$timescale2,duration=attributes.duration,_attributes$start=attributes.start,start=void 0===_attributes$start?0:_attributes$start,_attributes$minimumUp=attributes.minimumUpdatePeriod,minimumUpdatePeriod=void 0===_attributes$minimumUp?0:_attributes$minimumUp,_attributes$timeShift=attributes.timeShiftBufferDepth,timeShiftBufferDepth=void 0===_attributes$timeShift?1/0:_attributes$timeShift,now=(NOW+clientOffset)/1e3,periodStartWC=availabilityStartTime+start,periodEndWC=now+minimumUpdatePeriod,periodDuration=periodEndWC-periodStartWC,segmentCount=Math.ceil(periodDuration*timescale/duration),availableStart=Math.floor((now-periodStartWC-timeShiftBufferDepth)*timescale/duration),availableEnd=Math.floor((now-periodStartWC)*timescale/duration);return{start:Math.max(0,availableStart),end:Math.min(segmentCount,availableEnd)}}},toSegments=function(attributes){return function(number,index){var duration=attributes.duration,_attributes$timescale3=attributes.timescale,timescale=void 0===_attributes$timescale3?1:_attributes$timescale3,periodIndex=attributes.periodIndex,_attributes$startNumb=attributes.startNumber;return{number:(void 0===_attributes$startNumb?1:_attributes$startNumb)+number,duration:duration/timescale,timeline:periodIndex,time:index*duration}}},parseByDuration=function(attributes){var _attributes$type=attributes.type,type=void 0===_attributes$type?"static":_attributes$type,duration=attributes.duration,_attributes$timescale4=attributes.timescale,timescale=void 0===_attributes$timescale4?1:_attributes$timescale4,sourceDuration=attributes.sourceDuration,_segmentRange$type=segmentRange[type](attributes),start=_segmentRange$type.start,end=_segmentRange$type.end,segments=range(start,end).map(toSegments(attributes));if("static"===type){var index=segments.length-1;segments[index].duration=sourceDuration-duration/timescale*index}return segments},segmentsFromBase=function(attributes){var baseUrl=attributes.baseUrl,_attributes$initializ=attributes.initialization,initialization=void 0===_attributes$initializ?{}:_attributes$initializ,sourceDuration=attributes.sourceDuration,_attributes$timescale=attributes.timescale,timescale=void 0===_attributes$timescale?1:_attributes$timescale,_attributes$indexRang=attributes.indexRange,indexRange=void 0===_attributes$indexRang?"":_attributes$indexRang,duration=attributes.duration;if(!baseUrl)throw new Error(errors.NO_BASE_URL);var initSegment=urlTypeToSegment({baseUrl:baseUrl,source:initialization.sourceURL,range:initialization.range}),segment=urlTypeToSegment({baseUrl:baseUrl,source:baseUrl,indexRange:indexRange});if(segment.map=initSegment,duration){var segmentTimeInfo=parseByDuration(attributes);segmentTimeInfo.length&&(segment.duration=segmentTimeInfo[0].duration,segment.timeline=segmentTimeInfo[0].timeline)}else sourceDuration&&(segment.duration=sourceDuration/timescale,segment.timeline=0);return segment.number=0,[segment]},addSegmentsToPlaylist=function(playlist,sidx,baseUrl){for(var initSegment=playlist.sidx.map?playlist.sidx.map:null,sourceDuration=playlist.sidx.duration,timeline=playlist.timeline||0,sidxByteRange=playlist.sidx.byterange,sidxEnd=sidxByteRange.offset+sidxByteRange.length,timescale=sidx.timescale,mediaReferences=sidx.references.filter(function(r){return 1!==r.referenceType}),segments=[],startIndex=sidxEnd+sidx.firstOffset,i=0;i<mediaReferences.length;i++){var reference=sidx.references[i],size=reference.referencedSize,duration=reference.subsegmentDuration,endIndex=startIndex+size-1,indexRange=startIndex+"-"+endIndex,attributes={baseUrl:baseUrl,timescale:timescale,timeline:timeline,periodIndex:timeline,duration:duration,sourceDuration:sourceDuration,indexRange:indexRange},segment=segmentsFromBase(attributes)[0];initSegment&&(segment.map=initSegment),segments.push(segment),startIndex+=size}return playlist.segments=segments,playlist},mergeDiscontiguousPlaylists=function(playlists){return values(playlists.reduce(function(acc,playlist){var name=playlist.attributes.id+(playlist.attributes.lang||"");if(acc[name]){var _acc$name$segments;playlist.segments[0]&&(playlist.segments[0].discontinuity=!0),(_acc$name$segments=acc[name].segments).push.apply(_acc$name$segments,playlist.segments),playlist.attributes.contentProtection&&(acc[name].attributes.contentProtection=playlist.attributes.contentProtection)}else acc[name]=playlist;return acc},{})).map(function(playlist){return playlist.discontinuityStarts=findIndexes(playlist.segments,"discontinuity"),playlist})},addSegmentInfoFromSidx=function(playlists,sidxMapping){if(void 0===sidxMapping&&(sidxMapping={}),!Object.keys(sidxMapping).length)return playlists;for(var i in playlists){var playlist=playlists[i];if(playlist.sidx){var sidxKey=playlist.sidx.uri+"-"+byteRangeToString(playlist.sidx.byterange),sidxMatch=sidxMapping[sidxKey]&&sidxMapping[sidxKey].sidx;playlist.sidx&&sidxMatch&&addSegmentsToPlaylist(playlist,sidxMatch,playlist.sidx.resolvedUri)}}return playlists},formatAudioPlaylist=function(_ref){var _attributes,attributes=_ref.attributes,segments=_ref.segments,sidx=_ref.sidx,playlist={attributes:(_attributes={NAME:attributes.id,BANDWIDTH:attributes.bandwidth,CODECS:attributes.codecs},_attributes["PROGRAM-ID"]=1,_attributes),uri:"",endList:"static"===(attributes.type||"static"),timeline:attributes.periodIndex,resolvedUri:"",targetDuration:attributes.duration,segments:segments,mediaSequence:segments.length?segments[0].number:1};return attributes.contentProtection&&(playlist.contentProtection=attributes.contentProtection),sidx&&(playlist.sidx=sidx),playlist},formatVttPlaylist=function(_ref2){var _attributes2,attributes=_ref2.attributes,segments=_ref2.segments;return void 0===segments&&(segments=[{uri:attributes.baseUrl,timeline:attributes.periodIndex,resolvedUri:attributes.baseUrl||"",duration:attributes.sourceDuration,number:0}],attributes.duration=attributes.sourceDuration),{attributes:(_attributes2={NAME:attributes.id,BANDWIDTH:attributes.bandwidth},_attributes2["PROGRAM-ID"]=1,_attributes2),uri:"",endList:"static"===(attributes.type||"static"),timeline:attributes.periodIndex,resolvedUri:attributes.baseUrl||"",targetDuration:attributes.duration,segments:segments,mediaSequence:segments.length?segments[0].number:1}},organizeAudioPlaylists=function(playlists,sidxMapping){void 0===sidxMapping&&(sidxMapping={});var mainPlaylist,formattedPlaylists=playlists.reduce(function(a,playlist){var role=playlist.attributes.role&&playlist.attributes.role.value||"",language=playlist.attributes.lang||"",label="main";if(language){var roleLabel=role?" ("+role+")":"";label=""+playlist.attributes.lang+roleLabel}return a[label]&&a[label].playlists[0].attributes.BANDWIDTH>playlist.attributes.bandwidth?a:(a[label]={language:language,autoselect:!0,default:"main"===role,playlists:addSegmentInfoFromSidx([formatAudioPlaylist(playlist)],sidxMapping),uri:""},void 0===mainPlaylist&&"main"===role&&(mainPlaylist=playlist,mainPlaylist.default=!0),a)},{});if(!mainPlaylist){formattedPlaylists[Object.keys(formattedPlaylists)[0]].default=!0}return formattedPlaylists},organizeVttPlaylists=function(playlists,sidxMapping){return void 0===sidxMapping&&(sidxMapping={}),playlists.reduce(function(a,playlist){var label=playlist.attributes.lang||"text";return a[label]?a:(a[label]={language:label,default:!1,autoselect:!1,playlists:addSegmentInfoFromSidx([formatVttPlaylist(playlist)],sidxMapping),uri:""},a)},{})},formatVideoPlaylist=function(_ref3){var _attributes3,attributes=_ref3.attributes,segments=_ref3.segments,sidx=_ref3.sidx,playlist={attributes:(_attributes3={NAME:attributes.id,AUDIO:"audio",SUBTITLES:"subs",RESOLUTION:{width:attributes.width,height:attributes.height},CODECS:attributes.codecs,BANDWIDTH:attributes.bandwidth},_attributes3["PROGRAM-ID"]=1,_attributes3),uri:"",endList:"static"===(attributes.type||"static"),timeline:attributes.periodIndex,resolvedUri:"",targetDuration:attributes.duration,segments:segments,mediaSequence:segments.length?segments[0].number:1};return attributes.contentProtection&&(playlist.contentProtection=attributes.contentProtection),sidx&&(playlist.sidx=sidx),playlist},toM3u8=function(dashPlaylists,sidxMapping){var _mediaGroups;if(void 0===sidxMapping&&(sidxMapping={}),!dashPlaylists.length)return{};var _dashPlaylists$0$attr=dashPlaylists[0].attributes,duration=_dashPlaylists$0$attr.sourceDuration,_dashPlaylists$0$attr2=_dashPlaylists$0$attr.minimumUpdatePeriod,minimumUpdatePeriod=void 0===_dashPlaylists$0$attr2?0:_dashPlaylists$0$attr2,videoOnly=function(_ref4){var attributes=_ref4.attributes;return"video/mp4"===attributes.mimeType||"video"===attributes.contentType},audioOnly=function(_ref5){var attributes=_ref5.attributes;return"audio/mp4"===attributes.mimeType||"audio"===attributes.contentType},vttOnly=function(_ref6){var attributes=_ref6.attributes;return"text/vtt"===attributes.mimeType||"text"===attributes.contentType},videoPlaylists=mergeDiscontiguousPlaylists(dashPlaylists.filter(videoOnly)).map(formatVideoPlaylist),audioPlaylists=mergeDiscontiguousPlaylists(dashPlaylists.filter(audioOnly)),vttPlaylists=dashPlaylists.filter(vttOnly),master={allowCache:!0,discontinuityStarts:[],segments:[],endList:!0,mediaGroups:(_mediaGroups={AUDIO:{},VIDEO:{}},_mediaGroups["CLOSED-CAPTIONS"]={},_mediaGroups.SUBTITLES={},_mediaGroups),uri:"",duration:duration,playlists:addSegmentInfoFromSidx(videoPlaylists,sidxMapping),minimumUpdatePeriod:1e3*minimumUpdatePeriod};return audioPlaylists.length&&(master.mediaGroups.AUDIO.audio=organizeAudioPlaylists(audioPlaylists,sidxMapping)),vttPlaylists.length&&(master.mediaGroups.SUBTITLES.subs=organizeVttPlaylists(vttPlaylists,sidxMapping)),master},getLiveRValue=function(attributes,time,duration){var NOW=attributes.NOW,clientOffset=attributes.clientOffset,availabilityStartTime=attributes.availabilityStartTime,_attributes$timescale=attributes.timescale,timescale=void 0===_attributes$timescale?1:_attributes$timescale,_attributes$start=attributes.start,start=void 0===_attributes$start?0:_attributes$start,_attributes$minimumUp=attributes.minimumUpdatePeriod,minimumUpdatePeriod=void 0===_attributes$minimumUp?0:_attributes$minimumUp,now=(NOW+clientOffset)/1e3,periodStartWC=availabilityStartTime+start,periodEndWC=now+minimumUpdatePeriod,periodDuration=periodEndWC-periodStartWC;return Math.ceil((periodDuration*timescale-time)/duration)},parseByTimeline=function(attributes,segmentTimeline){for(var _attributes$type=attributes.type,type=void 0===_attributes$type?"static":_attributes$type,_attributes$minimumUp2=attributes.minimumUpdatePeriod,minimumUpdatePeriod=void 0===_attributes$minimumUp2?0:_attributes$minimumUp2,_attributes$media=attributes.media,media=void 0===_attributes$media?"":_attributes$media,sourceDuration=attributes.sourceDuration,_attributes$timescale2=attributes.timescale,timescale=void 0===_attributes$timescale2?1:_attributes$timescale2,_attributes$startNumb=attributes.startNumber,startNumber=void 0===_attributes$startNumb?1:_attributes$startNumb,timeline=attributes.periodIndex,segments=[],time=-1,sIndex=0;sIndex<segmentTimeline.length;sIndex++){var S=segmentTimeline[sIndex],duration=S.d,repeat=S.r||0,segmentTime=S.t||0;time<0&&(time=segmentTime),segmentTime&&segmentTime>time&&(time=segmentTime);var count=void 0;if(repeat<0){var nextS=sIndex+1;count=nextS===segmentTimeline.length?"dynamic"===type&&minimumUpdatePeriod>0&&media.indexOf("$Number$")>0?getLiveRValue(attributes,time,duration):(sourceDuration*timescale-time)/duration:(segmentTimeline[nextS].t-time)/duration}else count=repeat+1;for(var end=startNumber+segments.length+count,number=startNumber+segments.length;number<end;)segments.push({number:number,duration:duration/timescale,time:time,timeline:timeline}),time+=duration,number++}return segments},identifierPattern=/\$([A-z]*)(?:(%0)([0-9]+)d)?\$/g,identifierReplacement=function(values){return function(match,identifier,format,width){if("$$"===match)return"$";if(void 0===values[identifier])return match;var value=""+values[identifier];return"RepresentationID"===identifier?value:(width=format?parseInt(width,10):1,value.length>=width?value:""+new Array(width-value.length+1).join("0")+value)}},constructTemplateUrl=function(url,values){return url.replace(identifierPattern,identifierReplacement(values))},parseTemplateInfo=function(attributes,segmentTimeline){return attributes.duration||segmentTimeline?attributes.duration?parseByDuration(attributes):parseByTimeline(attributes,segmentTimeline):[{number:attributes.startNumber||1,duration:attributes.sourceDuration,time:0,timeline:attributes.periodIndex}]},segmentsFromTemplate=function(attributes,segmentTimeline){var templateValues={RepresentationID:attributes.id,Bandwidth:attributes.bandwidth||0},_attributes$initializ=attributes.initialization,initialization=void 0===_attributes$initializ?{sourceURL:"",range:""}:_attributes$initializ,mapSegment=urlTypeToSegment({baseUrl:attributes.baseUrl,source:constructTemplateUrl(initialization.sourceURL,templateValues),range:initialization.range});return parseTemplateInfo(attributes,segmentTimeline).map(function(segment){templateValues.Number=segment.number,templateValues.Time=segment.time;var uri=constructTemplateUrl(attributes.media||"",templateValues);return{uri:uri,timeline:segment.timeline,duration:segment.duration,resolvedUri:resolveUrl$1(attributes.baseUrl||"",uri),map:mapSegment,number:segment.number}})},SegmentURLToSegmentObject=function(attributes,segmentUrl){var baseUrl=attributes.baseUrl,_attributes$initializ=attributes.initialization,initialization=void 0===_attributes$initializ?{}:_attributes$initializ,initSegment=urlTypeToSegment({baseUrl:baseUrl,source:initialization.sourceURL,range:initialization.range}),segment=urlTypeToSegment({baseUrl:baseUrl,source:segmentUrl.media,range:segmentUrl.mediaRange});return segment.map=initSegment,segment},segmentsFromList=function(attributes,segmentTimeline){var duration=attributes.duration,_attributes$segmentUr=attributes.segmentUrls,segmentUrls=void 0===_attributes$segmentUr?[]:_attributes$segmentUr;if(!duration&&!segmentTimeline||duration&&segmentTimeline)throw new Error(errors.SEGMENT_TIME_UNSPECIFIED);var segmentTimeInfo,segmentUrlMap=segmentUrls.map(function(segmentUrlObject){return SegmentURLToSegmentObject(attributes,segmentUrlObject)});return duration&&(segmentTimeInfo=parseByDuration(attributes)),segmentTimeline&&(segmentTimeInfo=parseByTimeline(attributes,segmentTimeline)),segmentTimeInfo.map(function(segmentTime,index){if(segmentUrlMap[index]){var segment=segmentUrlMap[index];return segment.timeline=segmentTime.timeline,segment.duration=segmentTime.duration,segment.number=segmentTime.number,segment}}).filter(function(segment){return segment})},generateSegments=function(_ref){var segmentAttributes,segmentsFn,attributes=_ref.attributes,segmentInfo=_ref.segmentInfo;segmentInfo.template?(segmentsFn=segmentsFromTemplate,segmentAttributes=merge(attributes,segmentInfo.template)):segmentInfo.base?(segmentsFn=segmentsFromBase,segmentAttributes=merge(attributes,segmentInfo.base)):segmentInfo.list&&(segmentsFn=segmentsFromList,segmentAttributes=merge(attributes,segmentInfo.list));var segmentsInfo={attributes:attributes};if(!segmentsFn)return segmentsInfo;var segments=segmentsFn(segmentAttributes,segmentInfo.timeline);if(segmentAttributes.duration){var _segmentAttributes=segmentAttributes,duration=_segmentAttributes.duration,_segmentAttributes$ti=_segmentAttributes.timescale,timescale=void 0===_segmentAttributes$ti?1:_segmentAttributes$ti;segmentAttributes.duration=duration/timescale}else segments.length?segmentAttributes.duration=segments.reduce(function(max,segment){return Math.max(max,Math.ceil(segment.duration))},0):segmentAttributes.duration=0;return segmentsInfo.attributes=segmentAttributes,segmentsInfo.segments=segments,segmentInfo.base&&segmentAttributes.indexRange&&(segmentsInfo.sidx=segments[0],segmentsInfo.segments=[]),segmentsInfo},toPlaylists=function(representations){return representations.map(generateSegments)},findChildren=function(element,name){return from(element.childNodes).filter(function(_ref){return _ref.tagName===name})},getContent=function(element){return element.textContent.trim()},parseDuration=function(str){var durationRegex=/P(?:(\d*)Y)?(?:(\d*)M)?(?:(\d*)D)?(?:T(?:(\d*)H)?(?:(\d*)M)?(?:([\d.]*)S)?)?/,match=durationRegex.exec(str);if(!match)return 0;var _match$slice=match.slice(1),year=_match$slice[0],month=_match$slice[1],day=_match$slice[2],hour=_match$slice[3],minute=_match$slice[4],second=_match$slice[5];return 31536e3*parseFloat(year||0)+2592e3*parseFloat(month||0)+86400*parseFloat(day||0)+3600*parseFloat(hour||0)+60*parseFloat(minute||0)+parseFloat(second||0)},parseDate=function(str){return/^\d+-\d+-\d+T\d+:\d+:\d+(\.\d+)?$/.test(str)&&(str+="Z"),Date.parse(str)},parsers={mediaPresentationDuration:function(value){return parseDuration(value)},availabilityStartTime:function(value){return parseDate(value)/1e3},minimumUpdatePeriod:function(value){return parseDuration(value)},timeShiftBufferDepth:function(value){return parseDuration(value)},start:function(value){return parseDuration(value)},width:function(value){return parseInt(value,10)},height:function(value){return parseInt(value,10)},bandwidth:function(value){return parseInt(value,10)},startNumber:function(value){return parseInt(value,10)},timescale:function(value){return parseInt(value,10)},duration:function(value){var parsedValue=parseInt(value,10);return isNaN(parsedValue)?parseDuration(value):parsedValue},d:function(value){return parseInt(value,10)},t:function(value){return parseInt(value,10)},r:function(value){return parseInt(value,10)},DEFAULT:function(value){return value}},parseAttributes$1=function(el){return el&&el.attributes?from(el.attributes).reduce(function(a,e){var parseFn=parsers[e.name]||parsers.DEFAULT;return a[e.name]=parseFn(e.value),a},{}):{}};function decodeB64ToUint8Array$1(b64Text){for(var decodedString=window_1.atob(b64Text),array=new Uint8Array(decodedString.length),i=0;i<decodedString.length;i++)array[i]=decodedString.charCodeAt(i);return array}var inspectMp4,_textifyMp,keySystemsMap={"urn:uuid:1077efec-c0b2-4d02-ace3-3c1e52e2fb4b":"org.w3.clearkey","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed":"com.widevine.alpha","urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95":"com.microsoft.playready","urn:uuid:f239e769-efa3-4850-9c16-a903c6932efb":"com.adobe.primetime"},buildBaseUrls=function(referenceUrls,baseUrlElements){return baseUrlElements.length?flatten(referenceUrls.map(function(reference){return baseUrlElements.map(function(baseUrlElement){return resolveUrl$1(reference,getContent(baseUrlElement))})})):referenceUrls},getSegmentInformation=function(adaptationSet){var segmentTemplate=findChildren(adaptationSet,"SegmentTemplate")[0],segmentList=findChildren(adaptationSet,"SegmentList")[0],segmentUrls=segmentList&&findChildren(segmentList,"SegmentURL").map(function(s){return merge({tag:"SegmentURL"},parseAttributes$1(s))}),segmentBase=findChildren(adaptationSet,"SegmentBase")[0],segmentTimelineParentNode=segmentList||segmentTemplate,segmentTimeline=segmentTimelineParentNode&&findChildren(segmentTimelineParentNode,"SegmentTimeline")[0],segmentInitializationParentNode=segmentList||segmentBase||segmentTemplate,segmentInitialization=segmentInitializationParentNode&&findChildren(segmentInitializationParentNode,"Initialization")[0],template=segmentTemplate&&parseAttributes$1(segmentTemplate);template&&segmentInitialization?template.initialization=segmentInitialization&&parseAttributes$1(segmentInitialization):template&&template.initialization&&(template.initialization={sourceURL:template.initialization});var segmentInfo={template:template,timeline:segmentTimeline&&findChildren(segmentTimeline,"S").map(function(s){return parseAttributes$1(s)}),list:segmentList&&merge(parseAttributes$1(segmentList),{segmentUrls:segmentUrls,initialization:parseAttributes$1(segmentInitialization)}),base:segmentBase&&merge(parseAttributes$1(segmentBase),{initialization:parseAttributes$1(segmentInitialization)})};return Object.keys(segmentInfo).forEach(function(key){segmentInfo[key]||delete segmentInfo[key]}),segmentInfo},inheritBaseUrls=function(adaptationSetAttributes,adaptationSetBaseUrls,adaptationSetSegmentInfo){return function(representation){var repBaseUrlElements=findChildren(representation,"BaseURL"),repBaseUrls=buildBaseUrls(adaptationSetBaseUrls,repBaseUrlElements),attributes=merge(adaptationSetAttributes,parseAttributes$1(representation)),representationSegmentInfo=getSegmentInformation(representation);return repBaseUrls.map(function(baseUrl){return{segmentInfo:merge(adaptationSetSegmentInfo,representationSegmentInfo),attributes:merge(attributes,{baseUrl:baseUrl})}})}},generateKeySystemInformation=function(contentProtectionNodes){return contentProtectionNodes.reduce(function(acc,node){var attributes=parseAttributes$1(node),keySystem=keySystemsMap[attributes.schemeIdUri];if(keySystem){acc[keySystem]={attributes:attributes};var psshNode=findChildren(node,"cenc:pssh")[0];if(psshNode){var pssh=getContent(psshNode),psshBuffer=pssh&&decodeB64ToUint8Array$1(pssh);acc[keySystem].pssh=psshBuffer}}return acc},{})},toRepresentations=function(periodAttributes,periodBaseUrls,periodSegmentInfo){return function(adaptationSet){
var adaptationSetAttributes=parseAttributes$1(adaptationSet),adaptationSetBaseUrls=buildBaseUrls(periodBaseUrls,findChildren(adaptationSet,"BaseURL")),role=findChildren(adaptationSet,"Role")[0],roleAttributes={role:parseAttributes$1(role)},attrs=merge(periodAttributes,adaptationSetAttributes,roleAttributes),contentProtection=generateKeySystemInformation(findChildren(adaptationSet,"ContentProtection"));Object.keys(contentProtection).length&&(attrs=merge(attrs,{contentProtection:contentProtection}));var segmentInfo=getSegmentInformation(adaptationSet),representations=findChildren(adaptationSet,"Representation"),adaptationSetSegmentInfo=merge(periodSegmentInfo,segmentInfo);return flatten(representations.map(inheritBaseUrls(attrs,adaptationSetBaseUrls,adaptationSetSegmentInfo)))}},toAdaptationSets=function(mpdAttributes,mpdBaseUrls){return function(period,index){var periodBaseUrls=buildBaseUrls(mpdBaseUrls,findChildren(period,"BaseURL")),periodAtt=parseAttributes$1(period),parsedPeriodId=parseInt(periodAtt.id,10),periodIndex=window_1.isNaN(parsedPeriodId)?index:parsedPeriodId,periodAttributes=merge(mpdAttributes,{periodIndex:periodIndex}),adaptationSets=findChildren(period,"AdaptationSet"),periodSegmentInfo=getSegmentInformation(period);return flatten(adaptationSets.map(toRepresentations(periodAttributes,periodBaseUrls,periodSegmentInfo)))}},inheritAttributes=function(mpd,options){void 0===options&&(options={});var _options=options,_options$manifestUri=_options.manifestUri,manifestUri=void 0===_options$manifestUri?"":_options$manifestUri,_options$NOW=_options.NOW,NOW=void 0===_options$NOW?Date.now():_options$NOW,_options$clientOffset=_options.clientOffset,clientOffset=void 0===_options$clientOffset?0:_options$clientOffset,periods=findChildren(mpd,"Period");if(!periods.length)throw new Error(errors.INVALID_NUMBER_OF_PERIOD);var mpdAttributes=parseAttributes$1(mpd),mpdBaseUrls=buildBaseUrls([manifestUri],findChildren(mpd,"BaseURL"));return mpdAttributes.sourceDuration=mpdAttributes.mediaPresentationDuration||0,mpdAttributes.NOW=NOW,mpdAttributes.clientOffset=clientOffset,flatten(periods.map(toAdaptationSets(mpdAttributes,mpdBaseUrls)))},stringToMpdXml=function(manifestString){if(""===manifestString)throw new Error(errors.DASH_EMPTY_MANIFEST);var parser=new window_1.DOMParser,xml=parser.parseFromString(manifestString,"application/xml"),mpd=xml&&"MPD"===xml.documentElement.tagName?xml.documentElement:null;if(!mpd||mpd&&mpd.getElementsByTagName("parsererror").length>0)throw new Error(errors.DASH_INVALID_XML);return mpd},parseUTCTimingScheme=function(mpd){var UTCTimingNode=findChildren(mpd,"UTCTiming")[0];if(!UTCTimingNode)return null;var attributes=parseAttributes$1(UTCTimingNode);switch(attributes.schemeIdUri){case"urn:mpeg:dash:utc:http-head:2014":case"urn:mpeg:dash:utc:http-head:2012":attributes.method="HEAD";break;case"urn:mpeg:dash:utc:http-xsdate:2014":case"urn:mpeg:dash:utc:http-iso:2014":case"urn:mpeg:dash:utc:http-xsdate:2012":case"urn:mpeg:dash:utc:http-iso:2012":attributes.method="GET";break;case"urn:mpeg:dash:utc:direct:2014":case"urn:mpeg:dash:utc:direct:2012":attributes.method="DIRECT",attributes.value=Date.parse(attributes.value);break;case"urn:mpeg:dash:utc:http-ntp:2014":case"urn:mpeg:dash:utc:ntp:2014":case"urn:mpeg:dash:utc:sntp:2014":default:throw new Error(errors.UNSUPPORTED_UTC_TIMING_SCHEME)}return attributes},parse=function(manifestString,options){return void 0===options&&(options={}),toM3u8(toPlaylists(inheritAttributes(stringToMpdXml(manifestString),options)),options.sidxMapping)},parseUTCTiming=function(manifestString){return parseUTCTimingScheme(stringToMpdXml(manifestString))},toUnsigned=function(value){return value>>>0},toHexString=function(value){return("00"+value.toString(16)).slice(-2)},bin={toUnsigned:toUnsigned,toHexString:toHexString},toUnsigned$1=bin.toUnsigned,parseMp4Date=function(seconds){return new Date(1e3*seconds-20828448e5)},parseSampleFlags=function(flags){return{isLeading:(12&flags[0])>>>2,dependsOn:3&flags[0],isDependedOn:(192&flags[1])>>>6,hasRedundancy:(48&flags[1])>>>4,paddingValue:(14&flags[1])>>>1,isNonSyncSample:1&flags[1],degradationPriority:flags[2]<<8|flags[3]}},parseType=function(buffer){var result="";return result+=String.fromCharCode(buffer[0]),result+=String.fromCharCode(buffer[1]),result+=String.fromCharCode(buffer[2]),result+=String.fromCharCode(buffer[3])},findBox=function findBox(data,path){var i,size,type,end,subresults,results=[];if(!path.length)return null;for(i=0;i<data.byteLength;)size=toUnsigned$1(data[i]<<24|data[i+1]<<16|data[i+2]<<8|data[i+3]),type=parseType(data.subarray(i+4,i+8)),end=size>1?i+size:data.byteLength,type===path[0]&&(1===path.length?results.push(data.subarray(i+8,end)):(subresults=findBox(data.subarray(i+8,end),path.slice(1)),subresults.length&&(results=results.concat(subresults)))),i=end;return results},nalParse=function(avcStream){var i,length,avcView=new DataView(avcStream.buffer,avcStream.byteOffset,avcStream.byteLength),result=[];for(i=0;i+4<avcStream.length;i+=length)if(length=avcView.getUint32(i),i+=4,length<=0)result.push("<span style='color:red;'>MALFORMED DATA</span>");else switch(31&avcStream[i]){case 1:result.push("slice_layer_without_partitioning_rbsp");break;case 5:result.push("slice_layer_without_partitioning_rbsp_idr");break;case 6:result.push("sei_rbsp");break;case 7:result.push("seq_parameter_set_rbsp");break;case 8:result.push("pic_parameter_set_rbsp");break;case 9:result.push("access_unit_delimiter_rbsp");break;default:result.push("UNKNOWN NAL - "+avcStream[i]&31)}return result},parse$1={avc1:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{dataReferenceIndex:view.getUint16(6),width:view.getUint16(24),height:view.getUint16(26),horizresolution:view.getUint16(28)+view.getUint16(30)/16,vertresolution:view.getUint16(32)+view.getUint16(34)/16,frameCount:view.getUint16(40),depth:view.getUint16(74),config:inspectMp4(data.subarray(78,data.byteLength))}},avcC:function(data){var numOfPictureParameterSets,nalSize,offset,i,view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={configurationVersion:data[0],avcProfileIndication:data[1],profileCompatibility:data[2],avcLevelIndication:data[3],lengthSizeMinusOne:3&data[4],sps:[],pps:[]},numOfSequenceParameterSets=31&data[5];for(offset=6,i=0;i<numOfSequenceParameterSets;i++)nalSize=view.getUint16(offset),offset+=2,result.sps.push(new Uint8Array(data.subarray(offset,offset+nalSize))),offset+=nalSize;for(numOfPictureParameterSets=data[offset],offset++,i=0;i<numOfPictureParameterSets;i++)nalSize=view.getUint16(offset),offset+=2,result.pps.push(new Uint8Array(data.subarray(offset,offset+nalSize))),offset+=nalSize;return result},btrt:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{bufferSizeDB:view.getUint32(0),maxBitrate:view.getUint32(4),avgBitrate:view.getUint32(8)}},esds:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),esId:data[6]<<8|data[7],streamPriority:31&data[8],decoderConfig:{objectProfileIndication:data[11],streamType:data[12]>>>2&63,bufferSize:data[13]<<16|data[14]<<8|data[15],maxBitrate:data[16]<<24|data[17]<<16|data[18]<<8|data[19],avgBitrate:data[20]<<24|data[21]<<16|data[22]<<8|data[23],decoderConfigDescriptor:{tag:data[24],length:data[25],audioObjectType:data[26]>>>3&31,samplingFrequencyIndex:(7&data[26])<<1|data[27]>>>7&1,channelConfiguration:data[27]>>>3&15}}}},ftyp:function(data){for(var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={majorBrand:parseType(data.subarray(0,4)),minorVersion:view.getUint32(4),compatibleBrands:[]},i=8;i<data.byteLength;)result.compatibleBrands.push(parseType(data.subarray(i,i+4))),i+=4;return result},dinf:function(data){return{boxes:inspectMp4(data)}},dref:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),dataReferences:inspectMp4(data.subarray(8))}},hdlr:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4)),handlerType:parseType(data.subarray(8,12)),name:""},i=8;for(i=24;i<data.byteLength;i++){if(0===data[i]){i++;break}result.name+=String.fromCharCode(data[i])}return result.name=decodeURIComponent(escape(result.name)),result},mdat:function(data){return{byteLength:data.byteLength,nals:nalParse(data)}},mdhd:function(data){var language,view=new DataView(data.buffer,data.byteOffset,data.byteLength),i=4,result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4)),language:""};return 1===result.version?(i+=4,result.creationTime=parseMp4Date(view.getUint32(i)),i+=8,result.modificationTime=parseMp4Date(view.getUint32(i)),i+=4,result.timescale=view.getUint32(i),i+=8,result.duration=view.getUint32(i)):(result.creationTime=parseMp4Date(view.getUint32(i)),i+=4,result.modificationTime=parseMp4Date(view.getUint32(i)),i+=4,result.timescale=view.getUint32(i),i+=4,result.duration=view.getUint32(i)),i+=4,language=view.getUint16(i),result.language+=String.fromCharCode(96+(language>>10)),result.language+=String.fromCharCode(96+((992&language)>>5)),result.language+=String.fromCharCode(96+(31&language)),result},mdia:function(data){return{boxes:inspectMp4(data)}},mfhd:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),sequenceNumber:data[4]<<24|data[5]<<16|data[6]<<8|data[7]}},minf:function(data){return{boxes:inspectMp4(data)}},mp4a:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={dataReferenceIndex:view.getUint16(6),channelcount:view.getUint16(16),samplesize:view.getUint16(18),samplerate:view.getUint16(24)+view.getUint16(26)/65536};return data.byteLength>28&&(result.streamDescriptor=inspectMp4(data.subarray(28))[0]),result},moof:function(data){return{boxes:inspectMp4(data)}},moov:function(data){return{boxes:inspectMp4(data)}},mvex:function(data){return{boxes:inspectMp4(data)}},mvhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),i=4,result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4))};return 1===result.version?(i+=4,result.creationTime=parseMp4Date(view.getUint32(i)),i+=8,result.modificationTime=parseMp4Date(view.getUint32(i)),i+=4,result.timescale=view.getUint32(i),i+=8,result.duration=view.getUint32(i)):(result.creationTime=parseMp4Date(view.getUint32(i)),i+=4,result.modificationTime=parseMp4Date(view.getUint32(i)),i+=4,result.timescale=view.getUint32(i),i+=4,result.duration=view.getUint32(i)),i+=4,result.rate=view.getUint16(i)+view.getUint16(i+2)/16,i+=4,result.volume=view.getUint8(i)+view.getUint8(i+1)/8,i+=2,i+=2,i+=8,result.matrix=new Uint32Array(data.subarray(i,i+36)),i+=36,i+=24,result.nextTrackId=view.getUint32(i),result},pdin:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4)),rate:view.getUint32(4),initialDelay:view.getUint32(8)}},sdtp:function(data){var i,result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),samples:[]};for(i=4;i<data.byteLength;i++)result.samples.push({dependsOn:(48&data[i])>>4,isDependedOn:(12&data[i])>>2,hasRedundancy:3&data[i]});return result},sidx:function(data){var i,view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),references:[],referenceId:view.getUint32(4),timescale:view.getUint32(8),earliestPresentationTime:view.getUint32(12),firstOffset:view.getUint32(16)},referenceCount=view.getUint16(22);for(i=24;referenceCount;i+=12,referenceCount--)result.references.push({referenceType:(128&data[i])>>>7,referencedSize:2147483647&view.getUint32(i),subsegmentDuration:view.getUint32(i+4),startsWithSap:!!(128&data[i+8]),sapType:(112&data[i+8])>>>4,sapDeltaTime:268435455&view.getUint32(i+8)});return result},smhd:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),balance:data[4]+data[5]/256}},stbl:function(data){return{boxes:inspectMp4(data)}},stco:function(data){var i,view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),chunkOffsets:[]},entryCount=view.getUint32(4);for(i=8;entryCount;i+=4,entryCount--)result.chunkOffsets.push(view.getUint32(i));return result},stsc:function(data){var i,view=new DataView(data.buffer,data.byteOffset,data.byteLength),entryCount=view.getUint32(4),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),sampleToChunks:[]};for(i=8;entryCount;i+=12,entryCount--)result.sampleToChunks.push({firstChunk:view.getUint32(i),samplesPerChunk:view.getUint32(i+4),sampleDescriptionIndex:view.getUint32(i+8)});return result},stsd:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),sampleDescriptions:inspectMp4(data.subarray(8))}},stsz:function(data){var i,view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),sampleSize:view.getUint32(4),entries:[]};for(i=12;i<data.byteLength;i+=4)result.entries.push(view.getUint32(i));return result},stts:function(data){var i,view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),timeToSamples:[]},entryCount=view.getUint32(4);for(i=8;entryCount;i+=8,entryCount--)result.timeToSamples.push({sampleCount:view.getUint32(i),sampleDelta:view.getUint32(i+4)});return result},styp:function(data){return parse$1.ftyp(data)},tfdt:function(data){var result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),baseMediaDecodeTime:toUnsigned$1(data[4]<<24|data[5]<<16|data[6]<<8|data[7])};return 1===result.version&&(result.baseMediaDecodeTime*=Math.pow(2,32),result.baseMediaDecodeTime+=toUnsigned$1(data[8]<<24|data[9]<<16|data[10]<<8|data[11])),result},tfhd:function(data){var i,view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),trackId:view.getUint32(4)},baseDataOffsetPresent=1&result.flags[2],sampleDescriptionIndexPresent=2&result.flags[2],defaultSampleDurationPresent=8&result.flags[2],defaultSampleSizePresent=16&result.flags[2],defaultSampleFlagsPresent=32&result.flags[2],durationIsEmpty=65536&result.flags[0],defaultBaseIsMoof=131072&result.flags[0];return i=8,baseDataOffsetPresent&&(i+=4,result.baseDataOffset=view.getUint32(12),i+=4),sampleDescriptionIndexPresent&&(result.sampleDescriptionIndex=view.getUint32(i),i+=4),defaultSampleDurationPresent&&(result.defaultSampleDuration=view.getUint32(i),i+=4),defaultSampleSizePresent&&(result.defaultSampleSize=view.getUint32(i),i+=4),defaultSampleFlagsPresent&&(result.defaultSampleFlags=view.getUint32(i)),durationIsEmpty&&(result.durationIsEmpty=!0),!baseDataOffsetPresent&&defaultBaseIsMoof&&(result.baseDataOffsetIsMoof=!0),result},tkhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),i=4,result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4))};return 1===result.version?(i+=4,result.creationTime=parseMp4Date(view.getUint32(i)),i+=8,result.modificationTime=parseMp4Date(view.getUint32(i)),i+=4,result.trackId=view.getUint32(i),i+=4,i+=8,result.duration=view.getUint32(i)):(result.creationTime=parseMp4Date(view.getUint32(i)),i+=4,result.modificationTime=parseMp4Date(view.getUint32(i)),i+=4,result.trackId=view.getUint32(i),i+=4,i+=4,result.duration=view.getUint32(i)),i+=4,i+=8,result.layer=view.getUint16(i),i+=2,result.alternateGroup=view.getUint16(i),i+=2,result.volume=view.getUint8(i)+view.getUint8(i+1)/8,i+=2,i+=2,result.matrix=new Uint32Array(data.subarray(i,i+36)),i+=36,result.width=view.getUint16(i)+view.getUint16(i+2)/16,i+=4,result.height=view.getUint16(i)+view.getUint16(i+2)/16,result},traf:function(data){return{boxes:inspectMp4(data)}},trak:function(data){return{boxes:inspectMp4(data)}},trex:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),trackId:view.getUint32(4),defaultSampleDescriptionIndex:view.getUint32(8),defaultSampleDuration:view.getUint32(12),defaultSampleSize:view.getUint32(16),sampleDependsOn:3&data[20],sampleIsDependedOn:(192&data[21])>>6,sampleHasRedundancy:(48&data[21])>>4,samplePaddingValue:(14&data[21])>>1,sampleIsDifferenceSample:!!(1&data[21]),sampleDegradationPriority:view.getUint16(22)}},trun:function(data){var sample,result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),samples:[]},view=new DataView(data.buffer,data.byteOffset,data.byteLength),dataOffsetPresent=1&result.flags[2],firstSampleFlagsPresent=4&result.flags[2],sampleDurationPresent=1&result.flags[1],sampleSizePresent=2&result.flags[1],sampleFlagsPresent=4&result.flags[1],sampleCompositionTimeOffsetPresent=8&result.flags[1],sampleCount=view.getUint32(4),offset=8;for(dataOffsetPresent&&(result.dataOffset=view.getInt32(offset),offset+=4),firstSampleFlagsPresent&&sampleCount&&(sample={flags:parseSampleFlags(data.subarray(offset,offset+4))},offset+=4,sampleDurationPresent&&(sample.duration=view.getUint32(offset),offset+=4),sampleSizePresent&&(sample.size=view.getUint32(offset),offset+=4),sampleCompositionTimeOffsetPresent&&(sample.compositionTimeOffset=view.getUint32(offset),offset+=4),result.samples.push(sample),sampleCount--);sampleCount--;)sample={},sampleDurationPresent&&(sample.duration=view.getUint32(offset),offset+=4),sampleSizePresent&&(sample.size=view.getUint32(offset),offset+=4),sampleFlagsPresent&&(sample.flags=parseSampleFlags(data.subarray(offset,offset+4)),offset+=4),sampleCompositionTimeOffsetPresent&&(sample.compositionTimeOffset=view.getUint32(offset),offset+=4),result.samples.push(sample);return result},"url ":function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4))}},vmhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),graphicsmode:view.getUint16(4),opcolor:new Uint16Array([view.getUint16(6),view.getUint16(8),view.getUint16(10)])}}};inspectMp4=function(data){for(var view,size,type,end,box,i=0,result=[],ab=new ArrayBuffer(data.length),v=new Uint8Array(ab),z=0;z<data.length;++z)v[z]=data[z];for(view=new DataView(ab);i<data.byteLength;)size=view.getUint32(i),type=parseType(data.subarray(i+4,i+8)),end=size>1?i+size:data.byteLength,box=(parse$1[type]||function(data){return{data:data}})(data.subarray(i+8,end)),box.size=size,box.type=type,result.push(box),i=end;return result},_textifyMp=function(inspectedMp4,depth){var indent;return depth=depth||0,indent=new Array(2*depth+1).join(" "),inspectedMp4.map(function(box,index){return indent+box.type+"\n"+Object.keys(box).filter(function(key){return"type"!==key&&"boxes"!==key}).map(function(key){var prefix=indent+"  "+key+": ",value=box[key];if(value instanceof Uint8Array||value instanceof Uint32Array){var bytes=Array.prototype.slice.call(new Uint8Array(value.buffer,value.byteOffset,value.byteLength)).map(function(byte){return" "+("00"+byte.toString(16)).slice(-2)}).join("").match(/.{1,24}/g);return bytes?1===bytes.length?prefix+"<"+bytes.join("").slice(1)+">":prefix+"<\n"+bytes.map(function(line){return indent+"  "+line}).join("\n")+"\n"+indent+"  >":prefix+"<>"}return prefix+JSON.stringify(value,null,2).split("\n").map(function(line,index){return 0===index?line:indent+"  "+line}).join("\n")}).join("\n")+(box.boxes?"\n"+_textifyMp(box.boxes,depth+1):"")}).join("\n")};var mp4Inspector={inspect:inspectMp4,textify:_textifyMp,parseType:parseType,findBox:findBox,parseTraf:parse$1.traf,parseTfdt:parse$1.tfdt,parseHdlr:parse$1.hdlr,parseTfhd:parse$1.tfhd,parseTrun:parse$1.trun,parseSidx:parse$1.sidx},EventTarget$1=videojs.EventTarget,mergeOptions$2=videojs.mergeOptions,updateMaster$1=function(oldMaster,newMaster){for(var noChanges=void 0,update=mergeOptions$2(oldMaster,{duration:newMaster.duration,minimumUpdatePeriod:newMaster.minimumUpdatePeriod}),i=0;i<newMaster.playlists.length;i++){var playlistUpdate=updateMaster(update,newMaster.playlists[i]);playlistUpdate?update=playlistUpdate:noChanges=!0}return forEachMediaGroup(newMaster,function(properties,type,group,label){if(properties.playlists&&properties.playlists.length){var uri=properties.playlists[0].uri,_playlistUpdate=updateMaster(update,properties.playlists[0]);_playlistUpdate&&(update=_playlistUpdate,update.mediaGroups[type][group][label].playlists[0]=update.playlists[uri],noChanges=!1)}}),noChanges?null:update},generateSidxKey=function(sidxInfo){var sidxByteRangeEnd=sidxInfo.byterange.offset+sidxInfo.byterange.length-1;return sidxInfo.uri+"-"+sidxInfo.byterange.offset+"-"+sidxByteRangeEnd},equivalentSidx=function(a,b){return(Boolean(!a.map&&!b.map)||Boolean(a.map&&b.map&&a.map.byterange.offset===b.map.byterange.offset&&a.map.byterange.length===b.map.byterange.length))&&a.uri===b.uri&&a.byterange.offset===b.byterange.offset&&a.byterange.length===b.byterange.length},compareSidxEntry=function(playlists,oldSidxMapping){var newSidxMapping={};for(var uri in playlists){var playlist=playlists[uri],currentSidxInfo=playlist.sidx;if(currentSidxInfo){var key=generateSidxKey(currentSidxInfo);if(!oldSidxMapping[key])break;var savedSidxInfo=oldSidxMapping[key].sidxInfo;equivalentSidx(savedSidxInfo,currentSidxInfo)&&(newSidxMapping[key]=oldSidxMapping[key])}}return newSidxMapping},filterChangedSidxMappings=function(masterXml,srcUrl,clientOffset,oldSidxMapping){var master=parse(masterXml,{manifestUri:srcUrl,clientOffset:clientOffset}),videoSidx=compareSidxEntry(master.playlists,oldSidxMapping),mediaGroupSidx=videoSidx;return forEachMediaGroup(master,function(properties,mediaType,groupKey,labelKey){if(properties.playlists&&properties.playlists.length){var playlists=properties.playlists;mediaGroupSidx=mergeOptions$2(mediaGroupSidx,compareSidxEntry(playlists,oldSidxMapping))}}),mediaGroupSidx},requestSidx_=function(sidxRange,playlist,xhr,options,finishProcessingFn){var sidxInfo={uri:resolveManifestRedirect(options.handleManifestRedirects,sidxRange.resolvedUri),byterange:sidxRange.byterange,playlist:playlist};return xhr(videojs.mergeOptions(sidxInfo,{responseType:"arraybuffer",headers:segmentXhrHeaders(sidxInfo)}),finishProcessingFn)},DashPlaylistLoader=function(_EventTarget){inherits(DashPlaylistLoader,_EventTarget);function DashPlaylistLoader(srcUrlOrPlaylist,hls){var options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},masterPlaylistLoader=arguments[3];classCallCheck(this,DashPlaylistLoader);var _this=possibleConstructorReturn(this,(DashPlaylistLoader.__proto__||Object.getPrototypeOf(DashPlaylistLoader)).call(this)),_options$withCredenti=options.withCredentials,withCredentials=void 0!==_options$withCredenti&&_options$withCredenti,_options$handleManife=options.handleManifestRedirects,handleManifestRedirects=void 0!==_options$handleManife&&_options$handleManife;if(_this.hls_=hls,_this.withCredentials=withCredentials,_this.handleManifestRedirects=handleManifestRedirects,!srcUrlOrPlaylist)throw new Error("A non-empty playlist URL or playlist is required");return _this.on("minimumUpdatePeriod",function(){_this.refreshXml_()}),_this.on("mediaupdatetimeout",function(){_this.refreshMedia_(_this.media().uri)}),_this.state="HAVE_NOTHING",_this.loadedPlaylists_={},"string"==typeof srcUrlOrPlaylist?(_this.srcUrl=srcUrlOrPlaylist,_this.sidxMapping_={},possibleConstructorReturn(_this)):(_this.setupChildLoader(masterPlaylistLoader,srcUrlOrPlaylist),_this)}return createClass(DashPlaylistLoader,[{key:"setupChildLoader",value:function(masterPlaylistLoader,playlist){this.masterPlaylistLoader_=masterPlaylistLoader,this.childPlaylist_=playlist}},{key:"dispose",value:function(){this.stopRequest(),this.loadedPlaylists_={},window_1.clearTimeout(this.minimumUpdatePeriodTimeout_),window_1.clearTimeout(this.mediaRequest_),window_1.clearTimeout(this.mediaUpdateTimeout)}},{key:"hasPendingRequest",value:function(){return this.request||this.mediaRequest_}},{key:"stopRequest",value:function(){if(this.request){var oldRequest=this.request;this.request=null,oldRequest.onreadystatechange=null,oldRequest.abort()}}},{key:"sidxRequestFinished_",value:function(playlist,master,startingState,doneFn){var _this2=this;return function(err,request){if(_this2.request){if(_this2.request=null,err)return _this2.error={status:request.status,message:"DASH playlist request error at URL: "+playlist.uri,response:request.response,code:2},startingState&&(_this2.state=startingState),_this2.trigger("error"),doneFn(master,null);var bytes=new Uint8Array(request.response),sidx=mp4Inspector.parseSidx(bytes.subarray(8));return doneFn(master,sidx)}}}},{key:"media",value:function(playlist){var _this3=this;if(!playlist)return this.media_;if("HAVE_NOTHING"===this.state)throw new Error("Cannot switch media playlist from "+this.state);var startingState=this.state;if("string"==typeof playlist){if(!this.master.playlists[playlist])throw new Error("Unknown playlist URI: "+playlist);playlist=this.master.playlists[playlist]}var mediaChange=!this.media_||playlist.uri!==this.media_.uri;if(mediaChange&&this.loadedPlaylists_[playlist.uri]&&this.loadedPlaylists_[playlist.uri].endList)return this.state="HAVE_METADATA",this.media_=playlist,void(mediaChange&&(this.trigger("mediachanging"),this.trigger("mediachange")));if(mediaChange){if(this.media_&&this.trigger("mediachanging"),!playlist.sidx)return void(this.mediaRequest_=window_1.setTimeout(this.haveMetadata.bind(this,{startingState:startingState,playlist:playlist}),0));var oldMaster=void 0,sidxMapping=void 0;this.masterPlaylistLoader_?(oldMaster=this.masterPlaylistLoader_.master,sidxMapping=this.masterPlaylistLoader_.sidxMapping_):(oldMaster=this.master,sidxMapping=this.sidxMapping_);var sidxKey=generateSidxKey(playlist.sidx);sidxMapping[sidxKey]={sidxInfo:playlist.sidx},this.request=requestSidx_(playlist.sidx,playlist,this.hls_.xhr,{handleManifestRedirects:this.handleManifestRedirects},this.sidxRequestFinished_(playlist,oldMaster,startingState,function(newMaster,sidx){if(!newMaster||!sidx)throw new Error("failed to request sidx");sidxMapping[sidxKey].sidx=sidx,_this3.haveMetadata({startingState:startingState,playlist:newMaster.playlists[playlist.uri]})}))}}},{key:"haveMetadata",value:function(_ref){var startingState=_ref.startingState,playlist=_ref.playlist;this.state="HAVE_METADATA",this.loadedPlaylists_[playlist.uri]=playlist,this.mediaRequest_=null,this.refreshMedia_(playlist.uri),"HAVE_MASTER"===startingState?this.trigger("loadedmetadata"):this.trigger("mediachange")}},{key:"pause",value:function(){this.stopRequest(),window_1.clearTimeout(this.mediaUpdateTimeout),window_1.clearTimeout(this.minimumUpdatePeriodTimeout_),"HAVE_NOTHING"===this.state&&(this.started=!1)}},{key:"load",value:function(isFinalRendition){var _this4=this;window_1.clearTimeout(this.mediaUpdateTimeout),window_1.clearTimeout(this.minimumUpdatePeriodTimeout_);var media=this.media();if(isFinalRendition){var delay=media?media.targetDuration/2*1e3:5e3;return void(this.mediaUpdateTimeout=window_1.setTimeout(function(){return _this4.load()},delay))}if(!this.started)return void this.start();this.trigger("loadedplaylist")}},{key:"parseMasterXml",value:function(){var master=parse(this.masterXml_,{manifestUri:this.srcUrl,clientOffset:this.clientOffset_,sidxMapping:this.sidxMapping_});master.uri=this.srcUrl;for(var i=0;i<master.playlists.length;i++){var phonyUri="placeholder-uri-"+i;master.playlists[i].uri=phonyUri,master.playlists[phonyUri]=master.playlists[i]}return forEachMediaGroup(master,function(properties,mediaType,groupKey,labelKey){if(properties.playlists&&properties.playlists.length){var _phonyUri="placeholder-uri-"+mediaType+"-"+groupKey+"-"+labelKey;properties.playlists[0].uri=_phonyUri,master.playlists[_phonyUri]=properties.playlists[0]}}),setupMediaPlaylists(master),resolveMediaGroupUris(master),master}},{key:"start",value:function(){var _this5=this;if(this.started=!0,this.masterPlaylistLoader_)return void(this.mediaRequest_=window_1.setTimeout(this.haveMaster_.bind(this),0));this.request=this.hls_.xhr({uri:this.srcUrl,withCredentials:this.withCredentials},function(error,req){if(_this5.request){if(_this5.request=null,error)return _this5.error={status:req.status,message:"DASH playlist request error at URL: "+_this5.srcUrl,responseText:req.responseText,code:2},"HAVE_NOTHING"===_this5.state&&(_this5.started=!1),_this5.trigger("error");_this5.masterXml_=req.responseText,req.responseHeaders&&req.responseHeaders.date?_this5.masterLoaded_=Date.parse(req.responseHeaders.date):_this5.masterLoaded_=Date.now(),_this5.srcUrl=resolveManifestRedirect(_this5.handleManifestRedirects,_this5.srcUrl,req),_this5.syncClientServerClock_(_this5.onClientServerClockSync_.bind(_this5))}})}},{key:"syncClientServerClock_",value:function(done){var _this6=this,utcTiming=parseUTCTiming(this.masterXml_);return null===utcTiming?(this.clientOffset_=this.masterLoaded_-Date.now(),done()):"DIRECT"===utcTiming.method?(this.clientOffset_=utcTiming.value-Date.now(),done()):void(this.request=this.hls_.xhr({uri:resolveUrl(this.srcUrl,utcTiming.value),method:utcTiming.method,withCredentials:this.withCredentials},function(error,req){if(_this6.request){if(error)return _this6.clientOffset_=_this6.masterLoaded_-Date.now(),done();var serverTime=void 0;serverTime="HEAD"===utcTiming.method?req.responseHeaders&&req.responseHeaders.date?Date.parse(req.responseHeaders.date):_this6.masterLoaded_:Date.parse(req.responseText),_this6.clientOffset_=serverTime-Date.now(),done()}}))}},{key:"haveMaster_",value:function(){this.state="HAVE_MASTER",this.mediaRequest_=null,this.masterPlaylistLoader_?this.media_||this.media(this.childPlaylist_):(this.master=this.parseMasterXml(),this.trigger("loadedplaylist"))}},{key:"onClientServerClockSync_",value:function(){var _this7=this;this.haveMaster_(),this.hasPendingRequest()||this.media_||this.media(this.master.playlists[0]),this.master&&this.master.minimumUpdatePeriod&&(this.minimumUpdatePeriodTimeout_=window_1.setTimeout(function(){_this7.trigger("minimumUpdatePeriod")},this.master.minimumUpdatePeriod))}},{key:"refreshXml_",value:function(){var _this8=this;this.request=this.hls_.xhr({uri:this.srcUrl,withCredentials:this.withCredentials},function(error,req){if(_this8.request){if(_this8.request=null,error)return _this8.error={status:req.status,message:"DASH playlist request error at URL: "+_this8.srcUrl,responseText:req.responseText,code:2},"HAVE_NOTHING"===_this8.state&&(_this8.started=!1),_this8.trigger("error");_this8.masterXml_=req.responseText,_this8.sidxMapping_=filterChangedSidxMappings(_this8.masterXml_,_this8.srcUrl,_this8.clientOffset_,_this8.sidxMapping_);var master=_this8.parseMasterXml(),updatedMaster=updateMaster$1(_this8.master,master),currentSidxInfo=_this8.media().sidx;if(updatedMaster)if(currentSidxInfo){var sidxKey=generateSidxKey(currentSidxInfo);if(!_this8.sidxMapping_[sidxKey]){var playlist=_this8.media();_this8.request=requestSidx_(playlist.sidx,playlist,_this8.hls_.xhr,{handleManifestRedirects:_this8.handleManifestRedirects},_this8.sidxRequestFinished_(playlist,master,_this8.state,function(newMaster,sidx){if(!newMaster||!sidx)throw new Error("failed to request sidx on minimumUpdatePeriod");_this8.sidxMapping_[sidxKey].sidx=sidx,_this8.minimumUpdatePeriodTimeout_=window_1.setTimeout(function(){_this8.trigger("minimumUpdatePeriod")},_this8.master.minimumUpdatePeriod),_this8.refreshMedia_(_this8.media().uri)}))}}else _this8.master=updatedMaster;_this8.minimumUpdatePeriodTimeout_=window_1.setTimeout(function(){_this8.trigger("minimumUpdatePeriod")},_this8.master.minimumUpdatePeriod)}})}},{key:"refreshMedia_",value:function(mediaUri){var _this9=this;if(!mediaUri)throw new Error("refreshMedia_ must take a media uri");var oldMaster=void 0,newMaster=void 0;this.masterPlaylistLoader_?(oldMaster=this.masterPlaylistLoader_.master,
newMaster=this.masterPlaylistLoader_.parseMasterXml()):(oldMaster=this.master,newMaster=this.parseMasterXml());var updatedMaster=updateMaster$1(oldMaster,newMaster);updatedMaster?(this.masterPlaylistLoader_?this.masterPlaylistLoader_.master=updatedMaster:this.master=updatedMaster,this.media_=updatedMaster.playlists[mediaUri]):(this.media_=newMaster.playlists[mediaUri],this.trigger("playlistunchanged")),this.media().endList||(this.mediaUpdateTimeout=window_1.setTimeout(function(){_this9.trigger("mediaupdatetimeout")},refreshDelay(this.media(),!!updatedMaster))),this.trigger("loadedplaylist")}}]),DashPlaylistLoader}(EventTarget$1),logger=function(source){return videojs.log.debug?videojs.log.debug.bind(videojs,"VHS:",source+" >"):function(){}};function noop(){}var timescale,startTime,compositionStartTime,getVideoTrackIds,getTracks,SourceUpdater=function(){function SourceUpdater(mediaSource,mimeType,type,sourceBufferEmitter){classCallCheck(this,SourceUpdater),this.callbacks_=[],this.pendingCallback_=null,this.timestampOffset_=0,this.mediaSource=mediaSource,this.processedAppend_=!1,this.type_=type,this.mimeType_=mimeType,this.logger_=logger("SourceUpdater["+type+"]["+mimeType+"]"),"closed"===mediaSource.readyState?mediaSource.addEventListener("sourceopen",this.createSourceBuffer_.bind(this,mimeType,sourceBufferEmitter)):this.createSourceBuffer_(mimeType,sourceBufferEmitter)}return createClass(SourceUpdater,[{key:"createSourceBuffer_",value:function(mimeType,sourceBufferEmitter){var _this=this;if(this.sourceBuffer_=this.mediaSource.addSourceBuffer(mimeType),this.logger_("created SourceBuffer"),sourceBufferEmitter&&(sourceBufferEmitter.trigger("sourcebufferadded"),this.mediaSource.sourceBuffers.length<2))return void sourceBufferEmitter.on("sourcebufferadded",function(){_this.start_()});this.start_()}},{key:"start_",value:function(){var _this2=this;this.started_=!0,this.onUpdateendCallback_=function(){var pendingCallback=_this2.pendingCallback_;_this2.pendingCallback_=null,_this2.sourceBuffer_.removing=!1,_this2.logger_("buffered ["+printableRange(_this2.buffered())+"]"),pendingCallback&&pendingCallback(),_this2.runCallback_()},this.sourceBuffer_.addEventListener("updateend",this.onUpdateendCallback_),this.runCallback_()}},{key:"abort",value:function(done){var _this3=this;this.processedAppend_&&this.queueCallback_(function(){_this3.sourceBuffer_.abort()},done)}},{key:"appendBuffer",value:function(config,done){var _this4=this;this.processedAppend_=!0,this.queueCallback_(function(){config.videoSegmentTimingInfoCallback&&_this4.sourceBuffer_.addEventListener("videoSegmentTimingInfo",config.videoSegmentTimingInfoCallback),_this4.sourceBuffer_.appendBuffer(config.bytes)},function(){config.videoSegmentTimingInfoCallback&&_this4.sourceBuffer_.removeEventListener("videoSegmentTimingInfo",config.videoSegmentTimingInfoCallback),done()})}},{key:"buffered",value:function(){return this.sourceBuffer_?this.sourceBuffer_.buffered:videojs.createTimeRanges()}},{key:"remove",value:function(start,end){var _this5=this,done=arguments.length>2&&void 0!==arguments[2]?arguments[2]:noop;this.processedAppend_&&this.queueCallback_(function(){_this5.logger_("remove ["+start+" => "+end+"]"),_this5.sourceBuffer_.removing=!0,_this5.sourceBuffer_.remove(start,end)},done)}},{key:"updating",value:function(){return!this.sourceBuffer_||this.sourceBuffer_.updating||!!this.pendingCallback_&&this.pendingCallback_!==noop}},{key:"timestampOffset",value:function(offset){var _this6=this;return void 0!==offset&&(this.queueCallback_(function(){_this6.sourceBuffer_.timestampOffset=offset,_this6.runCallback_()}),this.timestampOffset_=offset),this.timestampOffset_}},{key:"queueCallback_",value:function(callback,done){this.callbacks_.push([callback.bind(this),done]),this.runCallback_()}},{key:"runCallback_",value:function(){var callbacks=void 0;!this.updating()&&this.callbacks_.length&&this.started_&&(callbacks=this.callbacks_.shift(),this.pendingCallback_=callbacks[1],callbacks[0]())}},{key:"dispose",value:function(){var _this7=this,disposeFn=function disposeFn(){_this7.sourceBuffer_&&"open"===_this7.mediaSource.readyState&&_this7.sourceBuffer_.abort(),_this7.sourceBuffer_.removeEventListener("updateend",disposeFn)};this.sourceBuffer_.removeEventListener("updateend",this.onUpdateendCallback_),this.sourceBuffer_.removing?this.sourceBuffer_.addEventListener("updateend",disposeFn):disposeFn()}}]),SourceUpdater}(),Config={GOAL_BUFFER_LENGTH:30,MAX_GOAL_BUFFER_LENGTH:60,GOAL_BUFFER_LENGTH_RATE:1,INITIAL_BANDWIDTH:4194304,BANDWIDTH_VARIANCE:1.2,BUFFER_LOW_WATER_LINE:0,MAX_BUFFER_LOW_WATER_LINE:30,BUFFER_LOW_WATER_LINE_RATE:1},toUnsigned$2=bin.toUnsigned,toHexString$1=bin.toHexString;timescale=function(init){var result={};return mp4Inspector.findBox(init,["moov","trak"]).reduce(function(result,trak){var tkhd,version,index,id,mdhd;return(tkhd=mp4Inspector.findBox(trak,["tkhd"])[0])?(version=tkhd[0],index=0===version?12:20,id=toUnsigned$2(tkhd[index]<<24|tkhd[index+1]<<16|tkhd[index+2]<<8|tkhd[index+3]),(mdhd=mp4Inspector.findBox(trak,["mdia","mdhd"])[0])?(version=mdhd[0],index=0===version?12:20,result[id]=toUnsigned$2(mdhd[index]<<24|mdhd[index+1]<<16|mdhd[index+2]<<8|mdhd[index+3]),result):null):null},result)},startTime=function(timescale,fragment){var trafs,baseTimes,result;return trafs=mp4Inspector.findBox(fragment,["moof","traf"]),baseTimes=[].concat.apply([],trafs.map(function(traf){return mp4Inspector.findBox(traf,["tfhd"]).map(function(tfhd){var id,scale,baseTime;return id=toUnsigned$2(tfhd[4]<<24|tfhd[5]<<16|tfhd[6]<<8|tfhd[7]),scale=timescale[id]||9e4,baseTime=mp4Inspector.findBox(traf,["tfdt"]).map(function(tfdt){var version,result;return version=tfdt[0],result=toUnsigned$2(tfdt[4]<<24|tfdt[5]<<16|tfdt[6]<<8|tfdt[7]),1===version&&(result*=Math.pow(2,32),result+=toUnsigned$2(tfdt[8]<<24|tfdt[9]<<16|tfdt[10]<<8|tfdt[11])),result})[0],(baseTime=baseTime||1/0)/scale})})),result=Math.min.apply(null,baseTimes),isFinite(result)?result:0},compositionStartTime=function(timescales,fragment){var trackId,trafBoxes=mp4Inspector.findBox(fragment,["moof","traf"]),baseMediaDecodeTime=0,compositionTimeOffset=0;if(trafBoxes&&trafBoxes.length)for(var parsedTraf=mp4Inspector.parseTraf(trafBoxes[0]),i=0;i<parsedTraf.boxes.length;i++)"tfhd"===parsedTraf.boxes[i].type?trackId=parsedTraf.boxes[i].trackId:"tfdt"===parsedTraf.boxes[i].type?baseMediaDecodeTime=parsedTraf.boxes[i].baseMediaDecodeTime:"trun"===parsedTraf.boxes[i].type&&parsedTraf.boxes[i].samples.length&&(compositionTimeOffset=parsedTraf.boxes[i].samples[0].compositionTimeOffset||0);return(baseMediaDecodeTime+compositionTimeOffset)/(timescales[trackId]||9e4)},getVideoTrackIds=function(init){var traks=mp4Inspector.findBox(init,["moov","trak"]),videoTrackIds=[];return traks.forEach(function(trak){var hdlrs=mp4Inspector.findBox(trak,["mdia","hdlr"]),tkhds=mp4Inspector.findBox(trak,["tkhd"]);hdlrs.forEach(function(hdlr,index){var view,version,trackId,handlerType=mp4Inspector.parseType(hdlr.subarray(8,12)),tkhd=tkhds[index];"vide"===handlerType&&(view=new DataView(tkhd.buffer,tkhd.byteOffset,tkhd.byteLength),version=view.getUint8(0),trackId=0===version?view.getUint32(12):view.getUint32(20),videoTrackIds.push(trackId))})}),videoTrackIds},getTracks=function(init){var traks=mp4Inspector.findBox(init,["moov","trak"]),tracks=[];return traks.forEach(function(trak){var view,version,track={},tkhd=mp4Inspector.findBox(trak,["tkhd"])[0];tkhd&&(view=new DataView(tkhd.buffer,tkhd.byteOffset,tkhd.byteLength),version=view.getUint8(0),track.id=0===version?view.getUint32(12):view.getUint32(20));var hdlr=mp4Inspector.findBox(trak,["mdia","hdlr"])[0];if(hdlr){var type=mp4Inspector.parseType(hdlr.subarray(8,12));track.type="vide"===type?"video":"soun"===type?"audio":type}var stsd=mp4Inspector.findBox(trak,["mdia","minf","stbl","stsd"])[0];if(stsd){var sampleDescriptions=stsd.subarray(8);track.codec=mp4Inspector.parseType(sampleDescriptions.subarray(4,8));var codecConfig,codecConfigType,codecBox=mp4Inspector.findBox(sampleDescriptions,[track.codec])[0];codecBox&&(/^[a-z]vc[1-9]$/i.test(track.codec)?(codecConfig=codecBox.subarray(78),codecConfigType=mp4Inspector.parseType(codecConfig.subarray(4,8)),"avcC"===codecConfigType&&codecConfig.length>11?(track.codec+=".",track.codec+=toHexString$1(codecConfig[9]),track.codec+=toHexString$1(codecConfig[10]),track.codec+=toHexString$1(codecConfig[11])):track.codec="avc1.4d400d"):/^mp4[a,v]$/i.test(track.codec)&&(codecConfig=codecBox.subarray(28),codecConfigType=mp4Inspector.parseType(codecConfig.subarray(4,8)),"esds"===codecConfigType&&codecConfig.length>20&&0!==codecConfig[19]?(track.codec+="."+toHexString$1(codecConfig[19]),track.codec+="."+toHexString$1(codecConfig[20]>>>2&63).replace(/^0/,"")):track.codec="mp4a.40.2"))}var mdhd=mp4Inspector.findBox(trak,["mdia","mdhd"])[0];if(mdhd&&tkhd){var index=0===version?12:20;track.timescale=toUnsigned$2(mdhd[index]<<24|mdhd[index+1]<<16|mdhd[index+2]<<8|mdhd[index+3])}tracks.push(track)}),tracks};var probe={findBox:mp4Inspector.findBox,parseType:mp4Inspector.parseType,timescale:timescale,startTime:startTime,compositionStartTime:compositionStartTime,videoTrackIds:getVideoTrackIds,tracks:getTracks},REQUEST_ERRORS={FAILURE:2,TIMEOUT:-101,ABORTED:-102},abortAll=function(activeXhrs){activeXhrs.forEach(function(xhr){xhr.abort()})},getRequestStats=function(request){return{bandwidth:request.bandwidth,bytesReceived:request.bytesReceived||0,roundTripTime:request.roundTripTime||0}},getProgressStats=function(progressEvent){var request=progressEvent.target,roundTripTime=Date.now()-request.requestTime,stats={bandwidth:1/0,bytesReceived:0,roundTripTime:roundTripTime||0};return stats.bytesReceived=progressEvent.loaded,stats.bandwidth=Math.floor(stats.bytesReceived/stats.roundTripTime*8*1e3),stats},handleErrors=function(error,request){return request.timedout?{status:request.status,message:"HLS request timed-out at URL: "+request.uri,code:REQUEST_ERRORS.TIMEOUT,xhr:request}:request.aborted?{status:request.status,message:"HLS request aborted at URL: "+request.uri,code:REQUEST_ERRORS.ABORTED,xhr:request}:error?{status:request.status,message:"HLS request errored at URL: "+request.uri,code:REQUEST_ERRORS.FAILURE,xhr:request}:null},handleKeyResponse=function(segment,finishProcessingFn){return function(error,request){var response=request.response,errorObj=handleErrors(error,request);if(errorObj)return finishProcessingFn(errorObj,segment);if(16!==response.byteLength)return finishProcessingFn({status:request.status,message:"Invalid HLS key at URL: "+request.uri,code:REQUEST_ERRORS.FAILURE,xhr:request},segment);var view=new DataView(response);return segment.key.bytes=new Uint32Array([view.getUint32(0),view.getUint32(4),view.getUint32(8),view.getUint32(12)]),finishProcessingFn(null,segment)}},handleInitSegmentResponse=function(segment,captionParser,finishProcessingFn){return function(error,request){var response=request.response,errorObj=handleErrors(error,request);return errorObj?finishProcessingFn(errorObj,segment):0===response.byteLength?finishProcessingFn({status:request.status,message:"Empty HLS segment content at URL: "+request.uri,code:REQUEST_ERRORS.FAILURE,xhr:request},segment):(segment.map.bytes=new Uint8Array(request.response),captionParser&&!captionParser.isInitialized()&&captionParser.init(),segment.map.timescales=probe.timescale(segment.map.bytes),segment.map.videoTrackIds=probe.videoTrackIds(segment.map.bytes),finishProcessingFn(null,segment))}},handleSegmentResponse=function(segment,captionParser,finishProcessingFn){return function(error,request){var response=request.response,errorObj=handleErrors(error,request),parsed=void 0;return errorObj?finishProcessingFn(errorObj,segment):0===response.byteLength?finishProcessingFn({status:request.status,message:"Empty HLS segment content at URL: "+request.uri,code:REQUEST_ERRORS.FAILURE,xhr:request},segment):(segment.stats=getRequestStats(request),segment.key?segment.encryptedBytes=new Uint8Array(request.response):segment.bytes=new Uint8Array(request.response),captionParser&&segment.map&&segment.map.bytes&&(captionParser.isInitialized()||captionParser.init(),(parsed=captionParser.parse(segment.bytes,segment.map.videoTrackIds,segment.map.timescales))&&parsed.captions&&(segment.captionStreams=parsed.captionStreams,segment.fmp4Captions=parsed.captions)),finishProcessingFn(null,segment))}},decryptSegment=function(decrypter,segment,doneFn){var decryptionHandler=function decryptionHandler(event){if(event.data.source===segment.requestId){decrypter.removeEventListener("message",decryptionHandler);var decrypted=event.data.decrypted;return segment.bytes=new Uint8Array(decrypted.bytes,decrypted.byteOffset,decrypted.byteLength),doneFn(null,segment)}};decrypter.addEventListener("message",decryptionHandler);var keyBytes=void 0;keyBytes=segment.key.bytes.slice?segment.key.bytes.slice():new Uint32Array(Array.prototype.slice.call(segment.key.bytes)),decrypter.postMessage(createTransferableMessage({source:segment.requestId,encrypted:segment.encryptedBytes,key:keyBytes,iv:segment.key.iv}),[segment.encryptedBytes.buffer,keyBytes.buffer])},waitForCompletion=function(activeXhrs,decrypter,doneFn){var count=0,didError=!1;return function(error,segment){if(!didError)return error?(didError=!0,abortAll(activeXhrs),doneFn(error,segment)):(count+=1,count===activeXhrs.length?(segment.endOfAllRequests=Date.now(),segment.encryptedBytes?decryptSegment(decrypter,segment,doneFn):doneFn(null,segment)):void 0)}},handleProgress=function(segment,progressFn){return function(event){return segment.stats=videojs.mergeOptions(segment.stats,getProgressStats(event)),!segment.stats.firstBytesReceivedAt&&segment.stats.bytesReceived&&(segment.stats.firstBytesReceivedAt=Date.now()),progressFn(event,segment)}},mediaSegmentRequest=function(xhr,xhrOptions,decryptionWorker,captionParser,segment,progressFn,doneFn){var activeXhrs=[],finishProcessingFn=waitForCompletion(activeXhrs,decryptionWorker,doneFn);if(segment.key&&!segment.key.bytes){var keyRequestOptions=videojs.mergeOptions(xhrOptions,{uri:segment.key.resolvedUri,responseType:"arraybuffer"}),keyRequestCallback=handleKeyResponse(segment,finishProcessingFn),keyXhr=xhr(keyRequestOptions,keyRequestCallback);activeXhrs.push(keyXhr)}if(segment.map&&!segment.map.bytes){var initSegmentOptions=videojs.mergeOptions(xhrOptions,{uri:segment.map.resolvedUri,responseType:"arraybuffer",headers:segmentXhrHeaders(segment.map)}),initSegmentRequestCallback=handleInitSegmentResponse(segment,captionParser,finishProcessingFn),initSegmentXhr=xhr(initSegmentOptions,initSegmentRequestCallback);activeXhrs.push(initSegmentXhr)}var segmentRequestOptions=videojs.mergeOptions(xhrOptions,{uri:segment.resolvedUri,responseType:"arraybuffer",headers:segmentXhrHeaders(segment)}),segmentRequestCallback=handleSegmentResponse(segment,captionParser,finishProcessingFn),segmentXhr=xhr(segmentRequestOptions,segmentRequestCallback);return segmentXhr.addEventListener("progress",handleProgress(segment,progressFn)),activeXhrs.push(segmentXhr),function(){return abortAll(activeXhrs)}},safeGetComputedStyle=function(el,property){var result=void 0;return el?(result=window_1.getComputedStyle(el),result?result[property]:""):""},stableSort=function(array,sortFn){var newArray=array.slice();array.sort(function(left,right){var cmp=sortFn(left,right);return 0===cmp?newArray.indexOf(left)-newArray.indexOf(right):cmp})},comparePlaylistBandwidth=function(left,right){var leftBandwidth=void 0,rightBandwidth=void 0;return left.attributes.BANDWIDTH&&(leftBandwidth=left.attributes.BANDWIDTH),leftBandwidth=leftBandwidth||window_1.Number.MAX_VALUE,right.attributes.BANDWIDTH&&(rightBandwidth=right.attributes.BANDWIDTH),rightBandwidth=rightBandwidth||window_1.Number.MAX_VALUE,leftBandwidth-rightBandwidth},comparePlaylistResolution=function(left,right){var leftWidth=void 0,rightWidth=void 0;return left.attributes.RESOLUTION&&left.attributes.RESOLUTION.width&&(leftWidth=left.attributes.RESOLUTION.width),leftWidth=leftWidth||window_1.Number.MAX_VALUE,right.attributes.RESOLUTION&&right.attributes.RESOLUTION.width&&(rightWidth=right.attributes.RESOLUTION.width),rightWidth=rightWidth||window_1.Number.MAX_VALUE,leftWidth===rightWidth&&left.attributes.BANDWIDTH&&right.attributes.BANDWIDTH?left.attributes.BANDWIDTH-right.attributes.BANDWIDTH:leftWidth-rightWidth},simpleSelector=function(master,playerBandwidth,playerWidth,playerHeight,limitRenditionByPlayerDimensions){var sortedPlaylistReps=master.playlists.map(function(playlist){var width=void 0,height=void 0,bandwidth=void 0;return width=playlist.attributes.RESOLUTION&&playlist.attributes.RESOLUTION.width,height=playlist.attributes.RESOLUTION&&playlist.attributes.RESOLUTION.height,bandwidth=playlist.attributes.BANDWIDTH,bandwidth=bandwidth||window_1.Number.MAX_VALUE,{bandwidth:bandwidth,width:width,height:height,playlist:playlist}});stableSort(sortedPlaylistReps,function(left,right){return left.bandwidth-right.bandwidth}),sortedPlaylistReps=sortedPlaylistReps.filter(function(rep){return!Playlist.isIncompatible(rep.playlist)});var enabledPlaylistReps=sortedPlaylistReps.filter(function(rep){return Playlist.isEnabled(rep.playlist)});enabledPlaylistReps.length||(enabledPlaylistReps=sortedPlaylistReps.filter(function(rep){return!Playlist.isDisabled(rep.playlist)}));var bandwidthPlaylistReps=enabledPlaylistReps.filter(function(rep){return rep.bandwidth*Config.BANDWIDTH_VARIANCE<playerBandwidth}),highestRemainingBandwidthRep=bandwidthPlaylistReps[bandwidthPlaylistReps.length-1],bandwidthBestRep=bandwidthPlaylistReps.filter(function(rep){return rep.bandwidth===highestRemainingBandwidthRep.bandwidth})[0];if(!1===limitRenditionByPlayerDimensions){var _chosenRep=bandwidthBestRep||enabledPlaylistReps[0]||sortedPlaylistReps[0];return _chosenRep?_chosenRep.playlist:null}var haveResolution=bandwidthPlaylistReps.filter(function(rep){return rep.width&&rep.height});stableSort(haveResolution,function(left,right){return left.width-right.width});var resolutionBestRepList=haveResolution.filter(function(rep){return rep.width===playerWidth&&rep.height===playerHeight});highestRemainingBandwidthRep=resolutionBestRepList[resolutionBestRepList.length-1];var resolutionBestRep=resolutionBestRepList.filter(function(rep){return rep.bandwidth===highestRemainingBandwidthRep.bandwidth})[0],resolutionPlusOneList=void 0,resolutionPlusOneSmallest=void 0,resolutionPlusOneRep=void 0;resolutionBestRep||(resolutionPlusOneList=haveResolution.filter(function(rep){return rep.width>playerWidth||rep.height>playerHeight}),resolutionPlusOneSmallest=resolutionPlusOneList.filter(function(rep){return rep.width===resolutionPlusOneList[0].width&&rep.height===resolutionPlusOneList[0].height}),highestRemainingBandwidthRep=resolutionPlusOneSmallest[resolutionPlusOneSmallest.length-1],resolutionPlusOneRep=resolutionPlusOneSmallest.filter(function(rep){return rep.bandwidth===highestRemainingBandwidthRep.bandwidth})[0]);var chosenRep=resolutionPlusOneRep||resolutionBestRep||bandwidthBestRep||enabledPlaylistReps[0]||sortedPlaylistReps[0];return chosenRep?chosenRep.playlist:null},lastBandwidthSelector=function(){return simpleSelector(this.playlists.master,this.systemBandwidth,parseInt(safeGetComputedStyle(this.tech_.el(),"width"),10),parseInt(safeGetComputedStyle(this.tech_.el(),"height"),10),this.limitRenditionByPlayerDimensions)},minRebufferMaxBandwidthSelector=function(settings){var master=settings.master,currentTime=settings.currentTime,bandwidth=settings.bandwidth,duration$$1=settings.duration,segmentDuration=settings.segmentDuration,timeUntilRebuffer=settings.timeUntilRebuffer,currentTimeline=settings.currentTimeline,syncController=settings.syncController,compatiblePlaylists=master.playlists.filter(function(playlist){return!Playlist.isIncompatible(playlist)}),enabledPlaylists=compatiblePlaylists.filter(Playlist.isEnabled);enabledPlaylists.length||(enabledPlaylists=compatiblePlaylists.filter(function(playlist){return!Playlist.isDisabled(playlist)}));var bandwidthPlaylists=enabledPlaylists.filter(Playlist.hasAttribute.bind(null,"BANDWIDTH")),rebufferingEstimates=bandwidthPlaylists.map(function(playlist){var syncPoint=syncController.getSyncPoint(playlist,duration$$1,currentTimeline,currentTime),numRequests=syncPoint?1:2;return{playlist:playlist,rebufferingImpact:Playlist.estimateSegmentRequestTime(segmentDuration,bandwidth,playlist)*numRequests-timeUntilRebuffer}}),noRebufferingPlaylists=rebufferingEstimates.filter(function(estimate){return estimate.rebufferingImpact<=0});return stableSort(noRebufferingPlaylists,function(a,b){return comparePlaylistBandwidth(b.playlist,a.playlist)}),noRebufferingPlaylists.length?noRebufferingPlaylists[0]:(stableSort(rebufferingEstimates,function(a,b){return a.rebufferingImpact-b.rebufferingImpact}),rebufferingEstimates[0]||null)},lowestBitrateCompatibleVariantSelector=function(){var playlists=this.playlists.master.playlists.filter(Playlist.isEnabled);return stableSort(playlists,function(a,b){return comparePlaylistBandwidth(a,b)}),playlists.filter(function(playlist){return parseCodecs(playlist.attributes.CODECS).videoCodec})[0]||null},createCaptionsTrackIfNotExists=function(inbandTextTracks,tech,captionStreams){for(var trackId in captionStreams)if(!inbandTextTracks[trackId]){tech.trigger({type:"usage",name:"hls-608"});var track=tech.textTracks().getTrackById(trackId);inbandTextTracks[trackId]=track||tech.addRemoteTextTrack({kind:"captions",id:trackId,label:trackId},!1).track}},addCaptionData=function(_ref){var inbandTextTracks=_ref.inbandTextTracks,captionArray=_ref.captionArray,timestampOffset=_ref.timestampOffset;if(captionArray){var Cue=window.WebKitDataCue||window.VTTCue;captionArray.forEach(function(caption){var track=caption.stream,startTime=caption.startTime,endTime=caption.endTime;inbandTextTracks[track]&&(startTime+=timestampOffset,endTime+=timestampOffset,inbandTextTracks[track].addCue(new Cue(startTime,endTime,caption.text)))})}},parseSei=function(bytes){for(var i=0,result={payloadType:-1,payloadSize:0},payloadType=0,payloadSize=0;i<bytes.byteLength&&128!==bytes[i];){for(;255===bytes[i];)payloadType+=255,i++;for(payloadType+=bytes[i++];255===bytes[i];)payloadSize+=255,i++;if(payloadSize+=bytes[i++],!result.payload&&4===payloadType){result.payloadType=payloadType,result.payloadSize=payloadSize,result.payload=bytes.subarray(i,i+payloadSize);break}i+=payloadSize,payloadType=0,payloadSize=0}return result},parseUserData=function(sei){return 181!==sei.payload[0]?null:49!=(sei.payload[1]<<8|sei.payload[2])?null:"GA94"!==String.fromCharCode(sei.payload[3],sei.payload[4],sei.payload[5],sei.payload[6])?null:3!==sei.payload[7]?null:sei.payload.subarray(8,sei.payload.length-1)},parseCaptionPackets=function(pts,userData){var i,count,offset,data,results=[];if(!(64&userData[0]))return results;for(count=31&userData[0],i=0;i<count;i++)offset=3*i,data={type:3&userData[offset+2],pts:pts},4&userData[offset+2]&&(data.ccData=userData[offset+3]<<8|userData[offset+4],results.push(data));return results},discardEmulationPreventionBytes=function(data){for(var newLength,newData,length=data.byteLength,emulationPreventionBytesPositions=[],i=1;i<length-2;)0===data[i]&&0===data[i+1]&&3===data[i+2]?(emulationPreventionBytesPositions.push(i+2),i+=2):i++;if(0===emulationPreventionBytesPositions.length)return data;newLength=length-emulationPreventionBytesPositions.length,newData=new Uint8Array(newLength);var sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++)sourceIndex===emulationPreventionBytesPositions[0]&&(sourceIndex++,emulationPreventionBytesPositions.shift()),newData[i]=data[sourceIndex];return newData},captionPacketParser={parseSei:parseSei,parseUserData:parseUserData,parseCaptionPackets:parseCaptionPackets,discardEmulationPreventionBytes:discardEmulationPreventionBytes,USER_DATA_REGISTERED_ITU_T_T35:4},Stream$2=function(){this.init=function(){var listeners={};this.on=function(type,listener){listeners[type]||(listeners[type]=[]),listeners[type]=listeners[type].concat(listener)},this.off=function(type,listener){var index;return!!listeners[type]&&(index=listeners[type].indexOf(listener),listeners[type]=listeners[type].slice(),listeners[type].splice(index,1),index>-1)},this.trigger=function(type){var callbacks,i,length,args;if(callbacks=listeners[type])if(2===arguments.length)for(length=callbacks.length,i=0;i<length;++i)callbacks[i].call(this,arguments[1]);else{for(args=[],i=arguments.length,i=1;i<arguments.length;++i)args.push(arguments[i]);for(length=callbacks.length,i=0;i<length;++i)callbacks[i].apply(this,args)}},this.dispose=function(){listeners={}}}};Stream$2.prototype.pipe=function(destination){return this.on("data",function(data){destination.push(data)}),this.on("done",function(flushSource){destination.flush(flushSource)}),this.on("partialdone",function(flushSource){destination.partialFlush(flushSource)}),this.on("endedtimeline",function(flushSource){destination.endTimeline(flushSource)}),this.on("reset",function(flushSource){destination.reset(flushSource)}),destination},Stream$2.prototype.push=function(data){this.trigger("data",data)},Stream$2.prototype.flush=function(flushSource){this.trigger("done",flushSource)},Stream$2.prototype.partialFlush=function(flushSource){this.trigger("partialdone",flushSource)},Stream$2.prototype.endTimeline=function(flushSource){this.trigger("endedtimeline",flushSource)},Stream$2.prototype.reset=function(flushSource){this.trigger("reset",flushSource)};var stream=Stream$2,CaptionStream=function CaptionStream(){CaptionStream.prototype.init.call(this),this.captionPackets_=[],this.ccStreams_=[new Cea608Stream(0,0),new Cea608Stream(0,1),new Cea608Stream(1,0),new Cea608Stream(1,1)],this.reset(),this.ccStreams_.forEach(function(cc){cc.on("data",this.trigger.bind(this,"data")),cc.on("partialdone",this.trigger.bind(this,"partialdone")),cc.on("done",this.trigger.bind(this,"done"))},this)};CaptionStream.prototype=new stream,CaptionStream.prototype.push=function(event){var sei,userData,newCaptionPackets;if("sei_rbsp"===event.nalUnitType&&(sei=captionPacketParser.parseSei(event.escapedRBSP),sei.payloadType===captionPacketParser.USER_DATA_REGISTERED_ITU_T_T35&&(userData=captionPacketParser.parseUserData(sei)))){if(event.dts<this.latestDts_)return void(this.ignoreNextEqualDts_=!0);if(event.dts===this.latestDts_&&this.ignoreNextEqualDts_)return void(--this.numSameDts_||(this.ignoreNextEqualDts_=!1));newCaptionPackets=captionPacketParser.parseCaptionPackets(event.pts,userData),this.captionPackets_=this.captionPackets_.concat(newCaptionPackets),this.latestDts_!==event.dts&&(this.numSameDts_=0),this.numSameDts_++,this.latestDts_=event.dts}},CaptionStream.prototype.flushCCStreams=function(flushType){this.ccStreams_.forEach(function(cc){return"flush"===flushType?cc.flush():cc.partialFlush()},this)},CaptionStream.prototype.flushStream=function(flushType){if(!this.captionPackets_.length)return void this.flushCCStreams(flushType);this.captionPackets_.forEach(function(elem,idx){elem.presortIndex=idx}),this.captionPackets_.sort(function(a,b){return a.pts===b.pts?a.presortIndex-b.presortIndex:a.pts-b.pts}),this.captionPackets_.forEach(function(packet){packet.type<2&&this.dispatchCea608Packet(packet)},this),this.captionPackets_.length=0,this.flushCCStreams(flushType)},CaptionStream.prototype.flush=function(){return this.flushStream("flush")},CaptionStream.prototype.partialFlush=function(){return this.flushStream("partialFlush")},CaptionStream.prototype.reset=function(){this.latestDts_=null,this.ignoreNextEqualDts_=!1,this.numSameDts_=0,this.activeCea608Channel_=[null,null],this.ccStreams_.forEach(function(ccStream){ccStream.reset()})},CaptionStream.prototype.dispatchCea608Packet=function(packet){this.setsTextOrXDSActive(packet)?this.activeCea608Channel_[packet.type]=null:this.setsChannel1Active(packet)?this.activeCea608Channel_[packet.type]=0:this.setsChannel2Active(packet)&&(this.activeCea608Channel_[packet.type]=1),null!==this.activeCea608Channel_[packet.type]&&this.ccStreams_[(packet.type<<1)+this.activeCea608Channel_[packet.type]].push(packet)},CaptionStream.prototype.setsChannel1Active=function(packet){return 4096==(30720&packet.ccData)},CaptionStream.prototype.setsChannel2Active=function(packet){return 6144==(30720&packet.ccData)},CaptionStream.prototype.setsTextOrXDSActive=function(packet){return 256==(28928&packet.ccData)||4138==(30974&packet.ccData)||6186==(30974&packet.ccData)};var CHARACTER_TRANSLATION={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,304:174,305:176,306:189,307:191,308:8482,309:162,310:163,311:9834,312:224,313:160,314:232,315:226,316:234,317:238,318:244,319:251,544:193,545:201,546:211,547:218,548:220,549:252,550:8216,551:161,552:42,553:39,554:8212,555:169,556:8480,557:8226,558:8220,559:8221,560:192,561:194,562:199,563:200,564:202,565:203,566:235,567:206,568:207,569:239,570:212,571:217,572:249,573:219,574:171,575:187,800:195,801:227,802:205,803:204,804:236,805:210,806:242,807:213,808:245,809:123,810:125,811:92,812:94,813:95,814:124,815:126,816:196,817:228,818:214,819:246,820:223,821:165,822:164,823:9474,824:197,825:229,826:216,827:248,828:9484,829:9488,830:9492,831:9496},getCharFromCode=function(code){return null===code?"":(code=CHARACTER_TRANSLATION[code]||code,String.fromCharCode(code))},ROWS=[4352,4384,4608,4640,5376,5408,5632,5664,5888,5920,4096,4864,4896,5120,5152],createDisplayBuffer=function(){for(var result=[],i=15;i--;)result.push("");return result},Cea608Stream=function Cea608Stream(field,dataChannel){Cea608Stream.prototype.init.call(this),this.field_=field||0,this.dataChannel_=dataChannel||0,this.name_="CC"+(1+(this.field_<<1|this.dataChannel_)),this.setConstants(),this.reset(),this.push=function(packet){var data,swap,char0,char1,text;if((data=32639&packet.ccData)===this.lastControlCode_)return void(this.lastControlCode_=null);if(4096==(61440&data)?this.lastControlCode_=data:data!==this.PADDING_&&(this.lastControlCode_=null),char0=data>>>8,char1=255&data,data!==this.PADDING_)if(data===this.RESUME_CAPTION_LOADING_)this.mode_="popOn";else if(data===this.END_OF_CAPTION_)this.mode_="popOn",this.clearFormatting(packet.pts),this.flushDisplayed(packet.pts),swap=this.displayed_,this.displayed_=this.nonDisplayed_,this.nonDisplayed_=swap,this.startPts_=packet.pts;else if(data===this.ROLL_UP_2_ROWS_)this.rollUpRows_=2,this.setRollUp(packet.pts);else if(data===this.ROLL_UP_3_ROWS_)this.rollUpRows_=3,this.setRollUp(packet.pts);else if(data===this.ROLL_UP_4_ROWS_)this.rollUpRows_=4,this.setRollUp(packet.pts);else if(data===this.CARRIAGE_RETURN_)this.clearFormatting(packet.pts),this.flushDisplayed(packet.pts),this.shiftRowsUp_(),this.startPts_=packet.pts;else if(data===this.BACKSPACE_)"popOn"===this.mode_?this.nonDisplayed_[this.row_]=this.nonDisplayed_[this.row_].slice(0,-1):this.displayed_[this.row_]=this.displayed_[this.row_].slice(0,-1);else if(data===this.ERASE_DISPLAYED_MEMORY_)this.flushDisplayed(packet.pts),this.displayed_=createDisplayBuffer();else if(data===this.ERASE_NON_DISPLAYED_MEMORY_)this.nonDisplayed_=createDisplayBuffer();else if(data===this.RESUME_DIRECT_CAPTIONING_)"paintOn"!==this.mode_&&(this.flushDisplayed(packet.pts),this.displayed_=createDisplayBuffer()),this.mode_="paintOn",this.startPts_=packet.pts;else if(this.isSpecialCharacter(char0,char1))char0=(3&char0)<<8,text=getCharFromCode(char0|char1),this[this.mode_](packet.pts,text),this.column_++;else if(this.isExtCharacter(char0,char1))"popOn"===this.mode_?this.nonDisplayed_[this.row_]=this.nonDisplayed_[this.row_].slice(0,-1):this.displayed_[this.row_]=this.displayed_[this.row_].slice(0,-1),char0=(3&char0)<<8,text=getCharFromCode(char0|char1),this[this.mode_](packet.pts,text),this.column_++;else if(this.isMidRowCode(char0,char1))this.clearFormatting(packet.pts),this[this.mode_](packet.pts," "),this.column_++,14==(14&char1)&&this.addFormatting(packet.pts,["i"]),
1==(1&char1)&&this.addFormatting(packet.pts,["u"]);else if(this.isOffsetControlCode(char0,char1))this.column_+=3&char1;else if(this.isPAC(char0,char1)){var row=ROWS.indexOf(7968&data);"rollUp"===this.mode_&&(row-this.rollUpRows_+1<0&&(row=this.rollUpRows_-1),this.setRollUp(packet.pts,row)),row!==this.row_&&(this.clearFormatting(packet.pts),this.row_=row),1&char1&&-1===this.formatting_.indexOf("u")&&this.addFormatting(packet.pts,["u"]),16==(16&data)&&(this.column_=4*((14&data)>>1)),this.isColorPAC(char1)&&14==(14&char1)&&this.addFormatting(packet.pts,["i"])}else this.isNormalChar(char0)&&(0===char1&&(char1=null),text=getCharFromCode(char0),text+=getCharFromCode(char1),this[this.mode_](packet.pts,text),this.column_+=text.length)}};Cea608Stream.prototype=new stream,Cea608Stream.prototype.flushDisplayed=function(pts){var content=this.displayed_.map(function(row){try{return row.trim()}catch(e){return console.error("Skipping malformed caption."),""}}).join("\n").replace(/^\n+|\n+$/g,"");content.length&&this.trigger("data",{startPts:this.startPts_,endPts:pts,text:content,stream:this.name_})},Cea608Stream.prototype.reset=function(){this.mode_="popOn",this.topRow_=0,this.startPts_=0,this.displayed_=createDisplayBuffer(),this.nonDisplayed_=createDisplayBuffer(),this.lastControlCode_=null,this.column_=0,this.row_=14,this.rollUpRows_=2,this.formatting_=[]},Cea608Stream.prototype.setConstants=function(){0===this.dataChannel_?(this.BASE_=16,this.EXT_=17,this.CONTROL_=(20|this.field_)<<8,this.OFFSET_=23):1===this.dataChannel_&&(this.BASE_=24,this.EXT_=25,this.CONTROL_=(28|this.field_)<<8,this.OFFSET_=31),this.PADDING_=0,this.RESUME_CAPTION_LOADING_=32|this.CONTROL_,this.END_OF_CAPTION_=47|this.CONTROL_,this.ROLL_UP_2_ROWS_=37|this.CONTROL_,this.ROLL_UP_3_ROWS_=38|this.CONTROL_,this.ROLL_UP_4_ROWS_=39|this.CONTROL_,this.CARRIAGE_RETURN_=45|this.CONTROL_,this.RESUME_DIRECT_CAPTIONING_=41|this.CONTROL_,this.BACKSPACE_=33|this.CONTROL_,this.ERASE_DISPLAYED_MEMORY_=44|this.CONTROL_,this.ERASE_NON_DISPLAYED_MEMORY_=46|this.CONTROL_},Cea608Stream.prototype.isSpecialCharacter=function(char0,char1){return char0===this.EXT_&&char1>=48&&char1<=63},Cea608Stream.prototype.isExtCharacter=function(char0,char1){return(char0===this.EXT_+1||char0===this.EXT_+2)&&char1>=32&&char1<=63},Cea608Stream.prototype.isMidRowCode=function(char0,char1){return char0===this.EXT_&&char1>=32&&char1<=47},Cea608Stream.prototype.isOffsetControlCode=function(char0,char1){return char0===this.OFFSET_&&char1>=33&&char1<=35},Cea608Stream.prototype.isPAC=function(char0,char1){return char0>=this.BASE_&&char0<this.BASE_+8&&char1>=64&&char1<=127},Cea608Stream.prototype.isColorPAC=function(char1){return char1>=64&&char1<=79||char1>=96&&char1<=127},Cea608Stream.prototype.isNormalChar=function(char){return char>=32&&char<=127},Cea608Stream.prototype.setRollUp=function(pts,newBaseRow){if("rollUp"!==this.mode_&&(this.row_=14,this.mode_="rollUp",this.flushDisplayed(pts),this.nonDisplayed_=createDisplayBuffer(),this.displayed_=createDisplayBuffer()),void 0!==newBaseRow&&newBaseRow!==this.row_)for(var i=0;i<this.rollUpRows_;i++)this.displayed_[newBaseRow-i]=this.displayed_[this.row_-i],this.displayed_[this.row_-i]="";void 0===newBaseRow&&(newBaseRow=this.row_),this.topRow_=newBaseRow-this.rollUpRows_+1},Cea608Stream.prototype.addFormatting=function(pts,format){this.formatting_=this.formatting_.concat(format);var text=format.reduce(function(text,format){return text+"<"+format+">"},"");this[this.mode_](pts,text)},Cea608Stream.prototype.clearFormatting=function(pts){if(this.formatting_.length){var text=this.formatting_.reverse().reduce(function(text,format){return text+"</"+format+">"},"");this.formatting_=[],this[this.mode_](pts,text)}},Cea608Stream.prototype.popOn=function(pts,text){var baseRow=this.nonDisplayed_[this.row_];baseRow+=text,this.nonDisplayed_[this.row_]=baseRow},Cea608Stream.prototype.rollUp=function(pts,text){var baseRow=this.displayed_[this.row_];baseRow+=text,this.displayed_[this.row_]=baseRow},Cea608Stream.prototype.shiftRowsUp_=function(){var i;for(i=0;i<this.topRow_;i++)this.displayed_[i]="";for(i=this.row_+1;i<15;i++)this.displayed_[i]="";for(i=this.topRow_;i<this.row_;i++)this.displayed_[i]=this.displayed_[i+1];this.displayed_[this.row_]=""},Cea608Stream.prototype.paintOn=function(pts,text){var baseRow=this.displayed_[this.row_];baseRow+=text,this.displayed_[this.row_]=baseRow};var captionStream={CaptionStream:CaptionStream,Cea608Stream:Cea608Stream},discardEmulationPreventionBytes$1=captionPacketParser.discardEmulationPreventionBytes,CaptionStream$1=captionStream.CaptionStream,mapToSample=function(offset,samples){for(var approximateOffset=offset,i=0;i<samples.length;i++){var sample=samples[i];if(approximateOffset<sample.size)return sample;approximateOffset-=sample.size}return null},findSeiNals=function(avcStream,samples,trackId){var seiNal,i,length,lastMatchedSample,avcView=new DataView(avcStream.buffer,avcStream.byteOffset,avcStream.byteLength),result=[];for(i=0;i+4<avcStream.length;i+=length)if(length=avcView.getUint32(i),i+=4,!(length<=0))switch(31&avcStream[i]){case 6:var data=avcStream.subarray(i+1,i+1+length),matchingSample=mapToSample(i,samples);seiNal={nalUnitType:"sei_rbsp",size:length,data:data,escapedRBSP:discardEmulationPreventionBytes$1(data),trackId:trackId},matchingSample?(seiNal.pts=matchingSample.pts,seiNal.dts=matchingSample.dts,lastMatchedSample=matchingSample):(seiNal.pts=lastMatchedSample.pts,seiNal.dts=lastMatchedSample.dts),result.push(seiNal)}return result},parseSamples=function(truns,baseMediaDecodeTime,tfhd){var currentDts=baseMediaDecodeTime,defaultSampleDuration=tfhd.defaultSampleDuration||0,defaultSampleSize=tfhd.defaultSampleSize||0,trackId=tfhd.trackId,allSamples=[];return truns.forEach(function(trun){var trackRun=mp4Inspector.parseTrun(trun),samples=trackRun.samples;samples.forEach(function(sample){void 0===sample.duration&&(sample.duration=defaultSampleDuration),void 0===sample.size&&(sample.size=defaultSampleSize),sample.trackId=trackId,sample.dts=currentDts,void 0===sample.compositionTimeOffset&&(sample.compositionTimeOffset=0),sample.pts=currentDts+sample.compositionTimeOffset,currentDts+=sample.duration}),allSamples=allSamples.concat(samples)}),allSamples},parseCaptionNals=function(segment,videoTrackId){var trafs=probe.findBox(segment,["moof","traf"]),mdats=probe.findBox(segment,["mdat"]),captionNals={},mdatTrafPairs=[];return mdats.forEach(function(mdat,index){var matchingTraf=trafs[index];mdatTrafPairs.push({mdat:mdat,traf:matchingTraf})}),mdatTrafPairs.forEach(function(pair){var samples,seiNals,mdat=pair.mdat,traf=pair.traf,tfhd=probe.findBox(traf,["tfhd"]),headerInfo=mp4Inspector.parseTfhd(tfhd[0]),trackId=headerInfo.trackId,tfdt=probe.findBox(traf,["tfdt"]),baseMediaDecodeTime=tfdt.length>0?mp4Inspector.parseTfdt(tfdt[0]).baseMediaDecodeTime:0,truns=probe.findBox(traf,["trun"]);videoTrackId===trackId&&truns.length>0&&(samples=parseSamples(truns,baseMediaDecodeTime,headerInfo),seiNals=findSeiNals(mdat,samples,trackId),captionNals[trackId]||(captionNals[trackId]=[]),captionNals[trackId]=captionNals[trackId].concat(seiNals))}),captionNals},parseEmbeddedCaptions=function(segment,trackId,timescale){var seiNals;return null===trackId?null:(seiNals=parseCaptionNals(segment,trackId),{seiNals:seiNals[trackId],timescale:timescale})},CaptionParser=function(){var captionStream$$1,segmentCache,trackId,timescale,parsedCaptions,parsingPartial,isInitialized=!1;this.isInitialized=function(){return isInitialized},this.init=function(options){captionStream$$1=new CaptionStream$1,isInitialized=!0,parsingPartial=!!options&&options.isPartial,captionStream$$1.on("data",function(event){event.startTime=event.startPts/timescale,event.endTime=event.endPts/timescale,parsedCaptions.captions.push(event),parsedCaptions.captionStreams[event.stream]=!0})},this.isNewInit=function(videoTrackIds,timescales){return!(videoTrackIds&&0===videoTrackIds.length||timescales&&"object"==typeof timescales&&0===Object.keys(timescales).length)&&(trackId!==videoTrackIds[0]||timescale!==timescales[trackId])},this.parse=function(segment,videoTrackIds,timescales){var parsedData;if(!this.isInitialized())return null;if(!videoTrackIds||!timescales)return null;if(this.isNewInit(videoTrackIds,timescales))trackId=videoTrackIds[0],timescale=timescales[trackId];else if(null===trackId||!timescale)return segmentCache.push(segment),null;for(;segmentCache.length>0;){var cachedSegment=segmentCache.shift();this.parse(cachedSegment,videoTrackIds,timescales)}return null!==(parsedData=parseEmbeddedCaptions(segment,trackId,timescale))&&parsedData.seiNals?(this.pushNals(parsedData.seiNals),this.flushStream(),parsedCaptions):null},this.pushNals=function(nals){if(!this.isInitialized()||!nals||0===nals.length)return null;nals.forEach(function(nal){captionStream$$1.push(nal)})},this.flushStream=function(){if(!this.isInitialized())return null;parsingPartial?captionStream$$1.partialFlush():captionStream$$1.flush()},this.clearParsedCaptions=function(){parsedCaptions.captions=[],parsedCaptions.captionStreams={}},this.resetCaptionStream=function(){if(!this.isInitialized())return null;captionStream$$1.reset()},this.clearAllCaptions=function(){this.clearParsedCaptions(),this.resetCaptionStream()},this.reset=function(){segmentCache=[],trackId=null,timescale=null,parsedCaptions?this.clearParsedCaptions():parsedCaptions={captions:[],captionStreams:{}},this.resetCaptionStream()},this.reset()},captionParser=CaptionParser,detectEndOfStream=function(playlist,mediaSource,segmentIndex){if(!playlist||!mediaSource)return!1;var segments=playlist.segments,appendedLastSegment=segmentIndex===segments.length;return playlist.endList&&"open"===mediaSource.readyState&&appendedLastSegment},finite=function(num){return"number"==typeof num&&isFinite(num)},illegalMediaSwitch=function(loaderType,startingMedia,newSegmentMedia){return"main"===loaderType&&startingMedia&&newSegmentMedia?newSegmentMedia.containsAudio||newSegmentMedia.containsVideo?startingMedia.containsVideo&&!newSegmentMedia.containsVideo?"Only audio found in segment when we expected video. We can't switch to audio only from a stream that had video. To get rid of this message, please add codec information to the manifest.":!startingMedia.containsVideo&&newSegmentMedia.containsVideo?"Video found in segment when we expected only audio. We can't switch to a stream with video from an audio only stream. To get rid of this message, please add codec information to the manifest.":null:"Neither audio nor video found in segment.":null},safeBackBufferTrimTime=function(seekable$$1,currentTime,targetDuration){var removeToTime=void 0;return removeToTime=seekable$$1.length&&seekable$$1.start(0)>0&&seekable$$1.start(0)<currentTime?seekable$$1.start(0):currentTime-30,Math.min(removeToTime,currentTime-targetDuration)},segmentInfoString=function(segmentInfo){var _segmentInfo$segment=segmentInfo.segment,start=_segmentInfo$segment.start,end=_segmentInfo$segment.end,_segmentInfo$playlist=segmentInfo.playlist,seq=_segmentInfo$playlist.mediaSequence,id=_segmentInfo$playlist.id,_segmentInfo$playlist2=_segmentInfo$playlist.segments,segments=void 0===_segmentInfo$playlist2?[]:_segmentInfo$playlist2,index=segmentInfo.mediaIndex,timeline=segmentInfo.timeline;return["appending ["+index+"] of ["+seq+", "+(seq+segments.length)+"] from playlist ["+id+"]","["+start+" => "+end+"] in timeline ["+timeline+"]"].join(" ")},SegmentLoader=function(_videojs$EventTarget){inherits(SegmentLoader,_videojs$EventTarget);function SegmentLoader(settings){classCallCheck(this,SegmentLoader);var _this=possibleConstructorReturn(this,(SegmentLoader.__proto__||Object.getPrototypeOf(SegmentLoader)).call(this));if(!settings)throw new TypeError("Initialization settings are required");if("function"!=typeof settings.currentTime)throw new TypeError("No currentTime getter specified");if(!settings.mediaSource)throw new TypeError("No MediaSource specified");return _this.bandwidth=settings.bandwidth,_this.throughput={rate:0,count:0},_this.roundTrip=NaN,_this.resetStats_(),_this.mediaIndex=null,_this.hasPlayed_=settings.hasPlayed,_this.currentTime_=settings.currentTime,_this.seekable_=settings.seekable,_this.seeking_=settings.seeking,_this.duration_=settings.duration,_this.mediaSource_=settings.mediaSource,_this.hls_=settings.hls,_this.loaderType_=settings.loaderType,_this.startingMedia_=void 0,_this.segmentMetadataTrack_=settings.segmentMetadataTrack,_this.goalBufferLength_=settings.goalBufferLength,_this.sourceType_=settings.sourceType,_this.inbandTextTracks_=settings.inbandTextTracks,_this.state_="INIT",_this.checkBufferTimeout_=null,_this.error_=void 0,_this.currentTimeline_=-1,_this.pendingSegment_=null,_this.mimeType_=null,_this.sourceUpdater_=null,_this.xhrOptions_=null,_this.activeInitSegmentId_=null,_this.initSegments_={},_this.cacheEncryptionKeys_=settings.cacheEncryptionKeys,_this.keyCache_={},"main"===_this.loaderType_?_this.captionParser_=new captionParser:_this.captionParser_=null,_this.decrypter_=settings.decrypter,_this.syncController_=settings.syncController,_this.syncPoint_={segmentIndex:0,time:0},_this.syncController_.on("syncinfoupdate",function(){return _this.trigger("syncinfoupdate")}),_this.mediaSource_.addEventListener("sourceopen",function(){return _this.ended_=!1}),_this.fetchAtBuffer_=!1,_this.logger_=logger("SegmentLoader["+_this.loaderType_+"]"),Object.defineProperty(_this,"state",{get:function(){return this.state_},set:function(newState){newState!==this.state_&&(this.logger_(this.state_+" -> "+newState),this.state_=newState)}}),_this}return createClass(SegmentLoader,[{key:"resetStats_",value:function(){this.mediaBytesTransferred=0,this.mediaRequests=0,this.mediaRequestsAborted=0,this.mediaRequestsTimedout=0,this.mediaRequestsErrored=0,this.mediaTransferDuration=0,this.mediaSecondsLoaded=0}},{key:"dispose",value:function(){this.state="DISPOSED",this.pause(),this.abort_(),this.sourceUpdater_&&this.sourceUpdater_.dispose(),this.resetStats_(),this.captionParser_&&this.captionParser_.reset()}},{key:"abort",value:function(){if("WAITING"!==this.state)return void(this.pendingSegment_&&(this.pendingSegment_=null));this.abort_(),this.state="READY",this.paused()||this.monitorBuffer_()}},{key:"abort_",value:function(){this.pendingSegment_&&this.pendingSegment_.abortRequests(),this.pendingSegment_=null}},{key:"error",value:function(_error){return void 0!==_error&&(this.error_=_error),this.pendingSegment_=null,this.error_}},{key:"endOfStream",value:function(){this.ended_=!0,this.pause(),this.trigger("ended")}},{key:"buffered_",value:function(){return this.sourceUpdater_?this.sourceUpdater_.buffered():videojs.createTimeRanges()}},{key:"initSegment",value:function(map){var set$$1=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!map)return null;var id=initSegmentId(map),storedMap=this.initSegments_[id];return set$$1&&!storedMap&&map.bytes&&(this.initSegments_[id]=storedMap={resolvedUri:map.resolvedUri,byterange:map.byterange,bytes:map.bytes,timescales:map.timescales,videoTrackIds:map.videoTrackIds}),storedMap||map}},{key:"segmentKey",value:function(key){var set$$1=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!key)return null;var id=segmentKeyId(key),storedKey=this.keyCache_[id];this.cacheEncryptionKeys_&&set$$1&&!storedKey&&key.bytes&&(this.keyCache_[id]=storedKey={resolvedUri:key.resolvedUri,bytes:key.bytes});var result={resolvedUri:(storedKey||key).resolvedUri};return storedKey&&(result.bytes=storedKey.bytes),result}},{key:"couldBeginLoading_",value:function(){return this.playlist_&&(this.sourceUpdater_||this.mimeType_&&"INIT"===this.state)&&!this.paused()}},{key:"load",value:function(){if(this.monitorBuffer_(),this.playlist_){if(this.syncController_.setDateTimeMapping(this.playlist_),"INIT"===this.state&&this.couldBeginLoading_())return this.init_();!this.couldBeginLoading_()||"READY"!==this.state&&"INIT"!==this.state||(this.state="READY")}}},{key:"init_",value:function(){return this.state="READY",this.sourceUpdater_=new SourceUpdater(this.mediaSource_,this.mimeType_,this.loaderType_,this.sourceBufferEmitter_),this.resetEverything(),this.monitorBuffer_()}},{key:"playlist",value:function(newPlaylist){var options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(newPlaylist){var oldPlaylist=this.playlist_,segmentInfo=this.pendingSegment_;this.playlist_=newPlaylist,this.xhrOptions_=options,this.hasPlayed_()||(newPlaylist.syncInfo={mediaSequence:newPlaylist.mediaSequence,time:0});var oldId=null;if(oldPlaylist&&(oldPlaylist.id?oldId=oldPlaylist.id:oldPlaylist.uri&&(oldId=oldPlaylist.uri)),this.logger_("playlist update ["+oldId+" => "+(newPlaylist.id||newPlaylist.uri)+"]"),this.trigger("syncinfoupdate"),"INIT"===this.state&&this.couldBeginLoading_())return this.init_();if(!oldPlaylist||oldPlaylist.uri!==newPlaylist.uri)return void(null!==this.mediaIndex&&this.resyncLoader());var mediaSequenceDiff=newPlaylist.mediaSequence-oldPlaylist.mediaSequence;this.logger_("live window shift ["+mediaSequenceDiff+"]"),null!==this.mediaIndex&&(this.mediaIndex-=mediaSequenceDiff),segmentInfo&&(segmentInfo.mediaIndex-=mediaSequenceDiff,segmentInfo.mediaIndex>=0&&(segmentInfo.segment=newPlaylist.segments[segmentInfo.mediaIndex])),this.syncController_.saveExpiredSegmentInfo(oldPlaylist,newPlaylist)}}},{key:"pause",value:function(){this.checkBufferTimeout_&&(window_1.clearTimeout(this.checkBufferTimeout_),this.checkBufferTimeout_=null)}},{key:"paused",value:function(){return null===this.checkBufferTimeout_}},{key:"mimeType",value:function(_mimeType,sourceBufferEmitter){this.mimeType_||(this.mimeType_=_mimeType,this.sourceBufferEmitter_=sourceBufferEmitter,"INIT"===this.state&&this.couldBeginLoading_()&&this.init_())}},{key:"resetEverything",value:function(done){this.ended_=!1,this.resetLoader(),this.remove(0,this.duration_(),done),this.captionParser_&&this.captionParser_.clearAllCaptions(),this.trigger("reseteverything")}},{key:"resetLoader",value:function(){this.fetchAtBuffer_=!1,this.resyncLoader()}},{key:"resyncLoader",value:function(){this.mediaIndex=null,this.syncPoint_=null,this.abort()}},{key:"remove",value:function(start,end,done){if(this.sourceUpdater_&&this.sourceUpdater_.remove(start,end,done),removeCuesFromTrack(start,end,this.segmentMetadataTrack_),this.inbandTextTracks_)for(var id in this.inbandTextTracks_)removeCuesFromTrack(start,end,this.inbandTextTracks_[id])}},{key:"monitorBuffer_",value:function(){this.checkBufferTimeout_&&window_1.clearTimeout(this.checkBufferTimeout_),this.checkBufferTimeout_=window_1.setTimeout(this.monitorBufferTick_.bind(this),1)}},{key:"monitorBufferTick_",value:function(){"READY"===this.state&&this.fillBuffer_(),this.checkBufferTimeout_&&window_1.clearTimeout(this.checkBufferTimeout_),this.checkBufferTimeout_=window_1.setTimeout(this.monitorBufferTick_.bind(this),500)}},{key:"fillBuffer_",value:function(){if(!this.sourceUpdater_.updating()){this.syncPoint_||(this.syncPoint_=this.syncController_.getSyncPoint(this.playlist_,this.duration_(),this.currentTimeline_,this.currentTime_()));var segmentInfo=this.checkBuffer_(this.buffered_(),this.playlist_,this.mediaIndex,this.hasPlayed_(),this.currentTime_(),this.syncPoint_);if(segmentInfo)return this.isEndOfStream_(segmentInfo.mediaIndex)?void this.endOfStream():void((segmentInfo.mediaIndex!==this.playlist_.segments.length-1||"ended"!==this.mediaSource_.readyState||this.seeking_())&&(segmentInfo.timeline!==this.currentTimeline_&&(this.syncController_.reset(),segmentInfo.timestampOffset=segmentInfo.startOfSegment,this.captionParser_&&this.captionParser_.clearAllCaptions()),this.loadSegment_(segmentInfo)))}}},{key:"isEndOfStream_",value:function(mediaIndex){var playlist=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.playlist_;return detectEndOfStream(playlist,this.mediaSource_,mediaIndex)&&!this.sourceUpdater_.updating()}},{key:"checkBuffer_",value:function(buffered,playlist,mediaIndex,hasPlayed,currentTime,syncPoint){var lastBufferedEnd=0,startOfSegment=void 0;buffered.length&&(lastBufferedEnd=buffered.end(buffered.length-1));var bufferedTime=Math.max(0,lastBufferedEnd-currentTime);if(!playlist.segments.length)return null;if(bufferedTime>=this.goalBufferLength_())return null;if(!hasPlayed&&bufferedTime>=1)return null;if(null===syncPoint)return mediaIndex=this.getSyncSegmentCandidate_(playlist),this.generateSegmentInfo_(playlist,mediaIndex,null,!0);if(null!==mediaIndex){playlist.segments[mediaIndex];return startOfSegment=lastBufferedEnd,this.generateSegmentInfo_(playlist,mediaIndex+1,startOfSegment,!1)}if(this.fetchAtBuffer_){var mediaSourceInfo=Playlist.getMediaInfoForTime(playlist,lastBufferedEnd,syncPoint.segmentIndex,syncPoint.time);mediaIndex=mediaSourceInfo.mediaIndex,startOfSegment=mediaSourceInfo.startTime}else{var _mediaSourceInfo=Playlist.getMediaInfoForTime(playlist,currentTime,syncPoint.segmentIndex,syncPoint.time);mediaIndex=_mediaSourceInfo.mediaIndex,startOfSegment=_mediaSourceInfo.startTime}return this.generateSegmentInfo_(playlist,mediaIndex,startOfSegment,!1)}},{key:"getSyncSegmentCandidate_",value:function(playlist){var _this2=this;if(-1===this.currentTimeline_)return 0;var segmentIndexArray=playlist.segments.map(function(s,i){return{timeline:s.timeline,segmentIndex:i}}).filter(function(s){return s.timeline===_this2.currentTimeline_});return segmentIndexArray.length?segmentIndexArray[Math.min(segmentIndexArray.length-1,1)].segmentIndex:Math.max(playlist.segments.length-1,0)}},{key:"generateSegmentInfo_",value:function(playlist,mediaIndex,startOfSegment,isSyncRequest){if(mediaIndex<0||mediaIndex>=playlist.segments.length)return null;var segment=playlist.segments[mediaIndex];return{requestId:"segment-loader-"+Math.random(),uri:segment.resolvedUri,mediaIndex:mediaIndex,isSyncRequest:isSyncRequest,startOfSegment:startOfSegment,playlist:playlist,bytes:null,encryptedBytes:null,timestampOffset:null,timeline:segment.timeline,duration:segment.duration,segment:segment}}},{key:"abortRequestEarly_",value:function(stats){if(this.hls_.tech_.paused()||!this.xhrOptions_.timeout||!this.playlist_.attributes.BANDWIDTH)return!1;if(Date.now()-(stats.firstBytesReceivedAt||Date.now())<1e3)return!1;var currentTime=this.currentTime_(),measuredBandwidth=stats.bandwidth,segmentDuration=this.pendingSegment_.duration,requestTimeRemaining=Playlist.estimateSegmentRequestTime(segmentDuration,measuredBandwidth,this.playlist_,stats.bytesReceived),timeUntilRebuffer$$1=timeUntilRebuffer(this.buffered_(),currentTime,this.hls_.tech_.playbackRate())-1;if(requestTimeRemaining<=timeUntilRebuffer$$1)return!1;var switchCandidate=minRebufferMaxBandwidthSelector({master:this.hls_.playlists.master,currentTime:currentTime,bandwidth:measuredBandwidth,duration:this.duration_(),segmentDuration:segmentDuration,timeUntilRebuffer:timeUntilRebuffer$$1,currentTimeline:this.currentTimeline_,syncController:this.syncController_});if(switchCandidate){var rebufferingImpact=requestTimeRemaining-timeUntilRebuffer$$1,timeSavedBySwitching=rebufferingImpact-switchCandidate.rebufferingImpact,minimumTimeSaving=.5;return timeUntilRebuffer$$1<=1/30&&(minimumTimeSaving=1),!switchCandidate.playlist||switchCandidate.playlist.uri===this.playlist_.uri||timeSavedBySwitching<minimumTimeSaving?!1:(this.bandwidth=switchCandidate.playlist.attributes.BANDWIDTH*Config.BANDWIDTH_VARIANCE+1,this.abort(),this.trigger("earlyabort"),!0)}}},{key:"handleProgress_",value:function(event,simpleSegment){this.pendingSegment_&&simpleSegment.requestId===this.pendingSegment_.requestId&&!this.abortRequestEarly_(simpleSegment.stats)&&this.trigger("progress")}},{key:"loadSegment_",value:function(segmentInfo){this.state="WAITING",this.pendingSegment_=segmentInfo,this.trimBackBuffer_(segmentInfo),segmentInfo.abortRequests=mediaSegmentRequest(this.hls_.xhr,this.xhrOptions_,this.decrypter_,this.captionParser_,this.createSimplifiedSegmentObj_(segmentInfo),this.handleProgress_.bind(this),this.segmentRequestFinished_.bind(this))}},{key:"trimBackBuffer_",value:function(segmentInfo){var removeToTime=safeBackBufferTrimTime(this.seekable_(),this.currentTime_(),this.playlist_.targetDuration||10);removeToTime>0&&this.remove(0,removeToTime)}},{key:"createSimplifiedSegmentObj_",value:function(segmentInfo){var segment=segmentInfo.segment,simpleSegment={resolvedUri:segment.resolvedUri,byterange:segment.byterange,requestId:segmentInfo.requestId};if(segment.key){var iv=segment.key.iv||new Uint32Array([0,0,0,segmentInfo.mediaIndex+segmentInfo.playlist.mediaSequence]);simpleSegment.key=this.segmentKey(segment.key),simpleSegment.key.iv=iv}return segment.map&&(simpleSegment.map=this.initSegment(segment.map)),simpleSegment}},{key:"segmentRequestFinished_",value:function(error,simpleSegment){if(this.mediaRequests+=1,simpleSegment.stats&&(this.mediaBytesTransferred+=simpleSegment.stats.bytesReceived,this.mediaTransferDuration+=simpleSegment.stats.roundTripTime),!this.pendingSegment_)return void(this.mediaRequestsAborted+=1);if(simpleSegment.requestId===this.pendingSegment_.requestId){if(error)return this.pendingSegment_=null,this.state="READY",error.code===REQUEST_ERRORS.ABORTED?void(this.mediaRequestsAborted+=1):(this.pause(),error.code===REQUEST_ERRORS.TIMEOUT?(this.mediaRequestsTimedout+=1,this.bandwidth=1,this.roundTrip=NaN,void this.trigger("bandwidthupdate")):(this.mediaRequestsErrored+=1,this.error(error),void this.trigger("error")));this.bandwidth=simpleSegment.stats.bandwidth,this.roundTrip=simpleSegment.stats.roundTripTime,simpleSegment.map&&(simpleSegment.map=this.initSegment(simpleSegment.map,!0)),simpleSegment.key&&this.segmentKey(simpleSegment.key,!0),this.processSegmentResponse_(simpleSegment)}}},{key:"processSegmentResponse_",value:function(simpleSegment){var segmentInfo=this.pendingSegment_;segmentInfo.bytes=simpleSegment.bytes,simpleSegment.map&&(segmentInfo.segment.map.bytes=simpleSegment.map.bytes),segmentInfo.endOfAllRequests=simpleSegment.endOfAllRequests,simpleSegment.fmp4Captions&&(createCaptionsTrackIfNotExists(this.inbandTextTracks_,this.hls_.tech_,simpleSegment.captionStreams),addCaptionData({inbandTextTracks:this.inbandTextTracks_,captionArray:simpleSegment.fmp4Captions,timestampOffset:0}),this.captionParser_&&this.captionParser_.clearParsedCaptions()),this.handleSegment_()}},{key:"handleSegment_",value:function(){var _this3=this;if(!this.pendingSegment_)return void(this.state="READY");var segmentInfo=this.pendingSegment_,segment=segmentInfo.segment,timingInfo=this.syncController_.probeSegmentInfo(segmentInfo);void 0===this.startingMedia_&&timingInfo&&(timingInfo.containsAudio||timingInfo.containsVideo)&&(this.startingMedia_={containsAudio:timingInfo.containsAudio,containsVideo:timingInfo.containsVideo});var illegalMediaSwitchError=illegalMediaSwitch(this.loaderType_,this.startingMedia_,timingInfo);if(illegalMediaSwitchError)return this.error({message:illegalMediaSwitchError,blacklistDuration:1/0}),void this.trigger("error");if(segmentInfo.isSyncRequest)return this.trigger("syncinfoupdate"),this.pendingSegment_=null,void(this.state="READY");if(null!==segmentInfo.timestampOffset&&segmentInfo.timestampOffset!==this.sourceUpdater_.timestampOffset()){if(timingInfo&&timingInfo.segmentTimestampInfo){var ptsStartTime=timingInfo.segmentTimestampInfo[0].ptsTime,dtsStartTime=timingInfo.segmentTimestampInfo[0].dtsTime;segmentInfo.timestampOffset-=ptsStartTime-dtsStartTime}this.sourceUpdater_.timestampOffset(segmentInfo.timestampOffset),this.trigger("timestampoffset")}var timelineMapping=this.syncController_.mappingForTimeline(segmentInfo.timeline);if(null!==timelineMapping&&this.trigger({type:"segmenttimemapping",mapping:timelineMapping}),this.state="APPENDING",segment.map){var initId=initSegmentId(segment.map);if(!this.activeInitSegmentId_||this.activeInitSegmentId_!==initId){var initSegment=this.initSegment(segment.map);this.sourceUpdater_.appendBuffer({bytes:initSegment.bytes},function(){_this3.activeInitSegmentId_=initId})}}segmentInfo.byteLength=segmentInfo.bytes.byteLength,"number"==typeof segment.start&&"number"==typeof segment.end?this.mediaSecondsLoaded+=segment.end-segment.start:this.mediaSecondsLoaded+=segment.duration,this.logger_(segmentInfoString(segmentInfo)),this.sourceUpdater_.appendBuffer({bytes:segmentInfo.bytes,videoSegmentTimingInfoCallback:this.handleVideoSegmentTimingInfo_.bind(this,segmentInfo.requestId)},this.handleUpdateEnd_.bind(this))}},{key:"handleVideoSegmentTimingInfo_",value:function(requestId,event){if(this.pendingSegment_&&requestId===this.pendingSegment_.requestId){var segment=this.pendingSegment_.segment;segment.videoTimingInfo||(segment.videoTimingInfo={}),segment.videoTimingInfo.transmuxerPrependedSeconds=event.videoSegmentTimingInfo.prependedContentDuration||0,segment.videoTimingInfo.transmuxedPresentationStart=event.videoSegmentTimingInfo.start.presentation,segment.videoTimingInfo.transmuxedPresentationEnd=event.videoSegmentTimingInfo.end.presentation,segment.videoTimingInfo.baseMediaDecodeTime=event.videoSegmentTimingInfo.baseMediaDecodeTime}}},{key:"handleUpdateEnd_",value:function(){if(!this.pendingSegment_)return this.state="READY",void(this.paused()||this.monitorBuffer_());var segmentInfo=this.pendingSegment_,segment=segmentInfo.segment,isWalkingForward=null!==this.mediaIndex;if(this.pendingSegment_=null,this.recordThroughput_(segmentInfo),this.addSegmentMetadataCue_(segmentInfo),this.state="READY",this.mediaIndex=segmentInfo.mediaIndex,this.fetchAtBuffer_=!0,this.currentTimeline_=segmentInfo.timeline,this.trigger("syncinfoupdate"),segment.end&&this.currentTime_()-segment.end>3*segmentInfo.playlist.targetDuration)return void this.resetEverything();isWalkingForward&&this.trigger("bandwidthupdate"),this.trigger("progress"),this.isEndOfStream_(segmentInfo.mediaIndex+1,segmentInfo.playlist)&&this.endOfStream(),this.paused()||this.monitorBuffer_()}},{key:"recordThroughput_",value:function(segmentInfo){var rate=this.throughput.rate,segmentProcessingTime=Date.now()-segmentInfo.endOfAllRequests+1,segmentProcessingThroughput=Math.floor(segmentInfo.byteLength/segmentProcessingTime*8*1e3);this.throughput.rate+=(segmentProcessingThroughput-rate)/++this.throughput.count}},{key:"addSegmentMetadataCue_",value:function(segmentInfo){if(this.segmentMetadataTrack_){var segment=segmentInfo.segment,start=segment.start,end=segment.end;if(finite(start)&&finite(end)){removeCuesFromTrack(start,end,this.segmentMetadataTrack_);var Cue=window_1.WebKitDataCue||window_1.VTTCue,value={custom:segment.custom,dateTimeObject:segment.dateTimeObject,dateTimeString:segment.dateTimeString,bandwidth:segmentInfo.playlist.attributes.BANDWIDTH,resolution:segmentInfo.playlist.attributes.RESOLUTION,codecs:segmentInfo.playlist.attributes.CODECS,byteLength:segmentInfo.byteLength,uri:segmentInfo.uri,timeline:segmentInfo.timeline,playlist:segmentInfo.playlist.uri,start:start,end:end},data=JSON.stringify(value),cue=new Cue(start,end,data);cue.value=value,this.segmentMetadataTrack_.addCue(cue)}}}}]),SegmentLoader}(videojs.EventTarget),uint8ToUtf8=function(uintArray){return decodeURIComponent(escape(String.fromCharCode.apply(null,uintArray)))},VTT_LINE_TERMINATORS=new Uint8Array("\n\n".split("").map(function(char){return char.charCodeAt(0)})),VTTSegmentLoader=function(_SegmentLoader){inherits(VTTSegmentLoader,_SegmentLoader);function VTTSegmentLoader(settings){var options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};classCallCheck(this,VTTSegmentLoader);var _this=possibleConstructorReturn(this,(VTTSegmentLoader.__proto__||Object.getPrototypeOf(VTTSegmentLoader)).call(this,settings,options));return _this.mediaSource_=null,_this.subtitlesTrack_=null,_this}return createClass(VTTSegmentLoader,[{key:"buffered_",value:function(){if(!this.subtitlesTrack_||!this.subtitlesTrack_.cues.length)return videojs.createTimeRanges();var cues=this.subtitlesTrack_.cues,start=cues[0].startTime,end=cues[cues.length-1].startTime;return videojs.createTimeRanges([[start,end]])}
},{key:"initSegment",value:function(map){var set$$1=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!map)return null;var id=initSegmentId(map),storedMap=this.initSegments_[id];if(set$$1&&!storedMap&&map.bytes){var combinedByteLength=VTT_LINE_TERMINATORS.byteLength+map.bytes.byteLength,combinedSegment=new Uint8Array(combinedByteLength);combinedSegment.set(map.bytes),combinedSegment.set(VTT_LINE_TERMINATORS,map.bytes.byteLength),this.initSegments_[id]=storedMap={resolvedUri:map.resolvedUri,byterange:map.byterange,bytes:combinedSegment}}return storedMap||map}},{key:"couldBeginLoading_",value:function(){return this.playlist_&&this.subtitlesTrack_&&!this.paused()}},{key:"init_",value:function(){return this.state="READY",this.resetEverything(),this.monitorBuffer_()}},{key:"track",value:function(_track){return void 0===_track?this.subtitlesTrack_:(this.subtitlesTrack_=_track,"INIT"===this.state&&this.couldBeginLoading_()&&this.init_(),this.subtitlesTrack_)}},{key:"remove",value:function(start,end){removeCuesFromTrack(start,end,this.subtitlesTrack_)}},{key:"fillBuffer_",value:function(){var _this2=this;this.syncPoint_||(this.syncPoint_=this.syncController_.getSyncPoint(this.playlist_,this.duration_(),this.currentTimeline_,this.currentTime_()));var segmentInfo=this.checkBuffer_(this.buffered_(),this.playlist_,this.mediaIndex,this.hasPlayed_(),this.currentTime_(),this.syncPoint_);if(segmentInfo=this.skipEmptySegments_(segmentInfo)){if(null===this.syncController_.timestampOffsetForTimeline(segmentInfo.timeline)){var checkTimestampOffset=function(){_this2.state="READY",_this2.paused()||_this2.monitorBuffer_()};return this.syncController_.one("timestampoffset",checkTimestampOffset),void(this.state="WAITING_ON_TIMELINE")}this.loadSegment_(segmentInfo)}}},{key:"skipEmptySegments_",value:function(segmentInfo){for(;segmentInfo&&segmentInfo.segment.empty;)segmentInfo=this.generateSegmentInfo_(segmentInfo.playlist,segmentInfo.mediaIndex+1,segmentInfo.startOfSegment+segmentInfo.duration,segmentInfo.isSyncRequest);return segmentInfo}},{key:"handleSegment_",value:function(){var _this3=this;if(!this.pendingSegment_||!this.subtitlesTrack_)return void(this.state="READY");this.state="APPENDING";var segmentInfo=this.pendingSegment_,segment=segmentInfo.segment;if("function"!=typeof window_1.WebVTT&&this.subtitlesTrack_&&this.subtitlesTrack_.tech_){var loadHandler=void 0,errorHandler=function(){_this3.subtitlesTrack_.tech_.off("vttjsloaded",loadHandler),_this3.error({message:"Error loading vtt.js"}),_this3.state="READY",_this3.pause(),_this3.trigger("error")};return loadHandler=function(){_this3.subtitlesTrack_.tech_.off("vttjserror",errorHandler),_this3.handleSegment_()},this.state="WAITING_ON_VTTJS",this.subtitlesTrack_.tech_.one("vttjsloaded",loadHandler),void this.subtitlesTrack_.tech_.one("vttjserror",errorHandler)}segment.requested=!0;try{this.parseVTTCues_(segmentInfo)}catch(e){return this.error({message:e.message}),this.state="READY",this.pause(),this.trigger("error")}if(this.updateTimeMapping_(segmentInfo,this.syncController_.timelines[segmentInfo.timeline],this.playlist_),segmentInfo.isSyncRequest)return this.trigger("syncinfoupdate"),this.pendingSegment_=null,void(this.state="READY");segmentInfo.byteLength=segmentInfo.bytes.byteLength,this.mediaSecondsLoaded+=segment.duration,segmentInfo.cues.length&&this.remove(segmentInfo.cues[0].endTime,segmentInfo.cues[segmentInfo.cues.length-1].endTime),segmentInfo.cues.forEach(function(cue){_this3.subtitlesTrack_.addCue(cue)}),this.handleUpdateEnd_()}},{key:"parseVTTCues_",value:function(segmentInfo){var decoder=void 0,decodeBytesToString=!1;"function"==typeof window_1.TextDecoder?decoder=new window_1.TextDecoder("utf8"):(decoder=window_1.WebVTT.StringDecoder(),decodeBytesToString=!0);var parser=new window_1.WebVTT.Parser(window_1,window_1.vttjs,decoder);if(segmentInfo.cues=[],segmentInfo.timestampmap={MPEGTS:0,LOCAL:0},parser.oncue=segmentInfo.cues.push.bind(segmentInfo.cues),parser.ontimestampmap=function(map){return segmentInfo.timestampmap=map},parser.onparsingerror=function(error){videojs.log.warn("Error encountered when parsing cues: "+error.message)},segmentInfo.segment.map){var mapData=segmentInfo.segment.map.bytes;decodeBytesToString&&(mapData=uint8ToUtf8(mapData)),parser.parse(mapData)}var segmentData=segmentInfo.bytes;decodeBytesToString&&(segmentData=uint8ToUtf8(segmentData)),parser.parse(segmentData),parser.flush()}},{key:"updateTimeMapping_",value:function(segmentInfo,mappingObj,playlist){var segment=segmentInfo.segment;if(mappingObj){if(!segmentInfo.cues.length)return void(segment.empty=!0);var timestampmap=segmentInfo.timestampmap,diff=timestampmap.MPEGTS/9e4-timestampmap.LOCAL+mappingObj.mapping;if(segmentInfo.cues.forEach(function(cue){cue.startTime+=diff,cue.endTime+=diff}),!playlist.syncInfo){var firstStart=segmentInfo.cues[0].startTime,lastStart=segmentInfo.cues[segmentInfo.cues.length-1].startTime;playlist.syncInfo={mediaSequence:playlist.mediaSequence+segmentInfo.mediaIndex,time:Math.min(firstStart,lastStart-segment.duration)}}}}}]),VTTSegmentLoader}(SegmentLoader),findAdCue=function(track,mediaTime){for(var cues=track.cues,i=0;i<cues.length;i++){var cue=cues[i];if(mediaTime>=cue.adStartTime&&mediaTime<=cue.adEndTime)return cue}return null},updateAdCues=function(media,track){var offset=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(media.segments)for(var mediaTime=offset,cue=void 0,i=0;i<media.segments.length;i++){var segment=media.segments[i];if(cue||(cue=findAdCue(track,mediaTime+segment.duration/2)),cue){if("cueIn"in segment){cue.endTime=mediaTime,cue.adEndTime=mediaTime,mediaTime+=segment.duration,cue=null;continue}if(mediaTime<cue.endTime){mediaTime+=segment.duration;continue}cue.endTime+=segment.duration}else if("cueOut"in segment&&(cue=new window_1.VTTCue(mediaTime,mediaTime+segment.duration,segment.cueOut),cue.adStartTime=mediaTime,cue.adEndTime=mediaTime+parseFloat(segment.cueOut),track.addCue(cue)),"cueOutCont"in segment){var adOffset=void 0,adTotal=void 0,_segment$cueOutCont$s=segment.cueOutCont.split("/").map(parseFloat),_segment$cueOutCont$s2=slicedToArray(_segment$cueOutCont$s,2);adOffset=_segment$cueOutCont$s2[0],adTotal=_segment$cueOutCont$s2[1],cue=new window_1.VTTCue(mediaTime,mediaTime+segment.duration,""),cue.adStartTime=mediaTime-adOffset,cue.adEndTime=cue.adStartTime+adTotal,track.addCue(cue)}mediaTime+=segment.duration}},streamTypes={H264_STREAM_TYPE:27,ADTS_STREAM_TYPE:15,METADATA_STREAM_TYPE:21},handleRollover=function(value,reference){var direction=1;for(value>reference&&(direction=-1);Math.abs(reference-value)>4294967296;)value+=8589934592*direction;return value},TimestampRolloverStream=function TimestampRolloverStream(type){var lastDTS,referenceDTS;TimestampRolloverStream.prototype.init.call(this),this.type_=type||"shared",this.push=function(data){"shared"!==this.type_&&data.type!==this.type_||(void 0===referenceDTS&&(referenceDTS=data.dts),data.dts=handleRollover(data.dts,referenceDTS),data.pts=handleRollover(data.pts,referenceDTS),lastDTS=data.dts,this.trigger("data",data))},this.flush=function(){referenceDTS=lastDTS,this.trigger("done")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline")},this.discontinuity=function(){referenceDTS=void 0,lastDTS=void 0},this.reset=function(){this.discontinuity(),this.trigger("reset")}};TimestampRolloverStream.prototype=new stream;var secondsToVideoTs,secondsToAudioTs,videoTsToSeconds,audioTsToSeconds,audioTsToVideoTs,videoTsToAudioTs,metadataTsToSeconds,timestampRolloverStream={TimestampRolloverStream:TimestampRolloverStream,handleRollover:handleRollover},parsePid=function(packet){var pid=31&packet[1];return pid<<=8,pid|=packet[2]},parsePayloadUnitStartIndicator=function(packet){return!!(64&packet[1])},parseAdaptionField=function(packet){var offset=0;return(48&packet[3])>>>4>1&&(offset+=packet[4]+1),offset},parseType$1=function(packet,pmtPid){var pid=parsePid(packet);return 0===pid?"pat":pid===pmtPid?"pmt":pmtPid?"pes":null},parsePat=function(packet){var pusi=parsePayloadUnitStartIndicator(packet),offset=4+parseAdaptionField(packet);return pusi&&(offset+=packet[offset]+1),(31&packet[offset+10])<<8|packet[offset+11]},parsePmt=function(packet){var programMapTable={},pusi=parsePayloadUnitStartIndicator(packet),payloadOffset=4+parseAdaptionField(packet);if(pusi&&(payloadOffset+=packet[payloadOffset]+1),1&packet[payloadOffset+5]){var sectionLength,tableEnd,programInfoLength;sectionLength=(15&packet[payloadOffset+1])<<8|packet[payloadOffset+2],tableEnd=3+sectionLength-4,programInfoLength=(15&packet[payloadOffset+10])<<8|packet[payloadOffset+11];for(var offset=12+programInfoLength;offset<tableEnd;){var i=payloadOffset+offset;programMapTable[(31&packet[i+1])<<8|packet[i+2]]=packet[i],offset+=5+((15&packet[i+3])<<8|packet[i+4])}return programMapTable}},parsePesType=function(packet,programMapTable){switch(programMapTable[parsePid(packet)]){case streamTypes.H264_STREAM_TYPE:return"video";case streamTypes.ADTS_STREAM_TYPE:return"audio";case streamTypes.METADATA_STREAM_TYPE:return"timed-metadata";default:return null}},parsePesTime=function(packet){if(!parsePayloadUnitStartIndicator(packet))return null;var offset=4+parseAdaptionField(packet);if(offset>=packet.byteLength)return null;var ptsDtsFlags,pes=null;return ptsDtsFlags=packet[offset+7],192&ptsDtsFlags&&(pes={},pes.pts=(14&packet[offset+9])<<27|(255&packet[offset+10])<<20|(254&packet[offset+11])<<12|(255&packet[offset+12])<<5|(254&packet[offset+13])>>>3,pes.pts*=4,pes.pts+=(6&packet[offset+13])>>>1,pes.dts=pes.pts,64&ptsDtsFlags&&(pes.dts=(14&packet[offset+14])<<27|(255&packet[offset+15])<<20|(254&packet[offset+16])<<12|(255&packet[offset+17])<<5|(254&packet[offset+18])>>>3,pes.dts*=4,pes.dts+=(6&packet[offset+18])>>>1)),pes},parseNalUnitType=function(type){switch(type){case 5:return"slice_layer_without_partitioning_rbsp_idr";case 6:return"sei_rbsp";case 7:return"seq_parameter_set_rbsp";case 8:return"pic_parameter_set_rbsp";case 9:return"access_unit_delimiter_rbsp";default:return null}},videoPacketContainsKeyFrame=function(packet){for(var nalType,offset=4+parseAdaptionField(packet),frameBuffer=packet.subarray(offset),frameI=0,frameSyncPoint=0,foundKeyFrame=!1;frameSyncPoint<frameBuffer.byteLength-3;frameSyncPoint++)if(1===frameBuffer[frameSyncPoint+2]){frameI=frameSyncPoint+5;break}for(;frameI<frameBuffer.byteLength;)switch(frameBuffer[frameI]){case 0:if(0!==frameBuffer[frameI-1]){frameI+=2;break}if(0!==frameBuffer[frameI-2]){frameI++;break}frameSyncPoint+3!==frameI-2&&"slice_layer_without_partitioning_rbsp_idr"===(nalType=parseNalUnitType(31&frameBuffer[frameSyncPoint+3]))&&(foundKeyFrame=!0);do{frameI++}while(1!==frameBuffer[frameI]&&frameI<frameBuffer.length);frameSyncPoint=frameI-2,frameI+=3;break;case 1:if(0!==frameBuffer[frameI-1]||0!==frameBuffer[frameI-2]){frameI+=3;break}nalType=parseNalUnitType(31&frameBuffer[frameSyncPoint+3]),"slice_layer_without_partitioning_rbsp_idr"===nalType&&(foundKeyFrame=!0),frameSyncPoint=frameI-2,frameI+=3;break;default:frameI+=3}return frameBuffer=frameBuffer.subarray(frameSyncPoint),frameI-=frameSyncPoint,frameSyncPoint=0,frameBuffer&&frameBuffer.byteLength>3&&"slice_layer_without_partitioning_rbsp_idr"===(nalType=parseNalUnitType(31&frameBuffer[frameSyncPoint+3]))&&(foundKeyFrame=!0),foundKeyFrame},probe$1={parseType:parseType$1,parsePat:parsePat,parsePmt:parsePmt,parsePayloadUnitStartIndicator:parsePayloadUnitStartIndicator,parsePesType:parsePesType,parsePesTime:parsePesTime,videoPacketContainsKeyFrame:videoPacketContainsKeyFrame},ADTS_SAMPLING_FREQUENCIES=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],isLikelyAacData=function(data){return data[0]==="I".charCodeAt(0)&&data[1]==="D".charCodeAt(0)&&data[2]==="3".charCodeAt(0)},parseSyncSafeInteger=function(data){return data[0]<<21|data[1]<<14|data[2]<<7|data[3]},percentEncode=function(bytes,start,end){var i,result="";for(i=start;i<end;i++)result+="%"+("00"+bytes[i].toString(16)).slice(-2);return result},parseIso88591=function(bytes,start,end){return unescape(percentEncode(bytes,start,end))},parseId3TagSize=function(header,byteIndex){var returnSize=header[byteIndex+6]<<21|header[byteIndex+7]<<14|header[byteIndex+8]<<7|header[byteIndex+9];return(16&header[byteIndex+5])>>4?returnSize+20:returnSize+10},parseAdtsSize=function(header,byteIndex){var lowThree=(224&header[byteIndex+5])>>5,middle=header[byteIndex+4]<<3;return 6144&header[byteIndex+3]|middle|lowThree},parseType$2=function(header,byteIndex){return header[byteIndex]==="I".charCodeAt(0)&&header[byteIndex+1]==="D".charCodeAt(0)&&header[byteIndex+2]==="3".charCodeAt(0)?"timed-metadata":!0&header[byteIndex]&&240==(240&header[byteIndex+1])?"audio":null},parseSampleRate=function(packet){for(var i=0;i+5<packet.length;){if(255===packet[i]&&240==(246&packet[i+1]))return ADTS_SAMPLING_FREQUENCIES[(60&packet[i+2])>>>2];i++}return null},parseAacTimestamp=function(packet){var frameStart,frameSize,frame;frameStart=10,64&packet[5]&&(frameStart+=4,frameStart+=parseSyncSafeInteger(packet.subarray(10,14)));do{if((frameSize=parseSyncSafeInteger(packet.subarray(frameStart+4,frameStart+8)))<1)return null;if("PRIV"===String.fromCharCode(packet[frameStart],packet[frameStart+1],packet[frameStart+2],packet[frameStart+3])){frame=packet.subarray(frameStart+10,frameStart+frameSize+10);for(var i=0;i<frame.byteLength;i++)if(0===frame[i]){var owner=parseIso88591(frame,0,i);if("com.apple.streaming.transportStreamTimestamp"===owner){var d=frame.subarray(i+1),size=(1&d[3])<<30|d[4]<<22|d[5]<<14|d[6]<<6|d[7]>>>2;return size*=4,size+=3&d[7]}break}}frameStart+=10,frameStart+=frameSize}while(frameStart<packet.byteLength);return null},utils$1={isLikelyAacData:isLikelyAacData,parseId3TagSize:parseId3TagSize,parseAdtsSize:parseAdtsSize,parseType:parseType$2,parseSampleRate:parseSampleRate,parseAacTimestamp:parseAacTimestamp};secondsToVideoTs=function(seconds){return 9e4*seconds},secondsToAudioTs=function(seconds,sampleRate){return seconds*sampleRate},videoTsToSeconds=function(timestamp){return timestamp/9e4},audioTsToSeconds=function(timestamp,sampleRate){return timestamp/sampleRate},audioTsToVideoTs=function(timestamp,sampleRate){return secondsToVideoTs(audioTsToSeconds(timestamp,sampleRate))},videoTsToAudioTs=function(timestamp,sampleRate){return secondsToAudioTs(videoTsToSeconds(timestamp),sampleRate)},metadataTsToSeconds=function(timestamp,timelineStartPts,keepOriginalTimestamps){return videoTsToSeconds(keepOriginalTimestamps?timestamp:timestamp-timelineStartPts)};var clock={ONE_SECOND_IN_TS:9e4,secondsToVideoTs:secondsToVideoTs,secondsToAudioTs:secondsToAudioTs,videoTsToSeconds:videoTsToSeconds,audioTsToSeconds:audioTsToSeconds,audioTsToVideoTs:audioTsToVideoTs,videoTsToAudioTs:videoTsToAudioTs,metadataTsToSeconds:metadataTsToSeconds},handleRollover$1=timestampRolloverStream.handleRollover,probe$2={};probe$2.ts=probe$1,probe$2.aac=utils$1;var ONE_SECOND_IN_TS$2=clock.ONE_SECOND_IN_TS,parsePsi_=function(bytes,pmt){for(var packet,startIndex=0,endIndex=188;endIndex<bytes.byteLength;)if(71!==bytes[startIndex]||71!==bytes[endIndex])startIndex++,endIndex++;else{switch(packet=bytes.subarray(startIndex,endIndex),probe$2.ts.parseType(packet,pmt.pid)){case"pat":pmt.pid||(pmt.pid=probe$2.ts.parsePat(packet));break;case"pmt":pmt.table||(pmt.table=probe$2.ts.parsePmt(packet))}if(pmt.pid&&pmt.table)return;startIndex+=188,endIndex+=188}},parseAudioPes_=function(bytes,pmt,result){for(var packet,pesType,pusi,parsed,startIndex=0,endIndex=188,endLoop=!1;endIndex<=bytes.byteLength;)if(71!==bytes[startIndex]||71!==bytes[endIndex]&&endIndex!==bytes.byteLength)startIndex++,endIndex++;else{switch(packet=bytes.subarray(startIndex,endIndex),probe$2.ts.parseType(packet,pmt.pid)){case"pes":pesType=probe$2.ts.parsePesType(packet,pmt.table),pusi=probe$2.ts.parsePayloadUnitStartIndicator(packet),"audio"===pesType&&pusi&&(parsed=probe$2.ts.parsePesTime(packet))&&(parsed.type="audio",result.audio.push(parsed),endLoop=!0)}if(endLoop)break;startIndex+=188,endIndex+=188}for(endIndex=bytes.byteLength,startIndex=endIndex-188,endLoop=!1;startIndex>=0;)if(71!==bytes[startIndex]||71!==bytes[endIndex]&&endIndex!==bytes.byteLength)startIndex--,endIndex--;else{switch(packet=bytes.subarray(startIndex,endIndex),probe$2.ts.parseType(packet,pmt.pid)){case"pes":pesType=probe$2.ts.parsePesType(packet,pmt.table),pusi=probe$2.ts.parsePayloadUnitStartIndicator(packet),"audio"===pesType&&pusi&&(parsed=probe$2.ts.parsePesTime(packet))&&(parsed.type="audio",result.audio.push(parsed),endLoop=!0)}if(endLoop)break;startIndex-=188,endIndex-=188}},parseVideoPes_=function(bytes,pmt,result){for(var packet,pesType,pusi,parsed,frame,i,pes,startIndex=0,endIndex=188,endLoop=!1,currentFrame={data:[],size:0};endIndex<bytes.byteLength;)if(71!==bytes[startIndex]||71!==bytes[endIndex])startIndex++,endIndex++;else{switch(packet=bytes.subarray(startIndex,endIndex),probe$2.ts.parseType(packet,pmt.pid)){case"pes":if(pesType=probe$2.ts.parsePesType(packet,pmt.table),pusi=probe$2.ts.parsePayloadUnitStartIndicator(packet),"video"===pesType&&(pusi&&!endLoop&&(parsed=probe$2.ts.parsePesTime(packet))&&(parsed.type="video",result.video.push(parsed),endLoop=!0),!result.firstKeyFrame)){if(pusi&&0!==currentFrame.size){for(frame=new Uint8Array(currentFrame.size),i=0;currentFrame.data.length;)pes=currentFrame.data.shift(),frame.set(pes,i),i+=pes.byteLength;if(probe$2.ts.videoPacketContainsKeyFrame(frame)){var firstKeyFrame=probe$2.ts.parsePesTime(frame);firstKeyFrame?(result.firstKeyFrame=firstKeyFrame,result.firstKeyFrame.type="video"):console.warn("Failed to extract PTS/DTS from PES at first keyframe. This could be an unusual TS segment, or else mux.js did not parse your TS segment correctly. If you know your TS segments do contain PTS/DTS on keyframes please file a bug report! You can try ffprobe to double check for yourself.")}currentFrame.size=0}currentFrame.data.push(packet),currentFrame.size+=packet.byteLength}}if(endLoop&&result.firstKeyFrame)break;startIndex+=188,endIndex+=188}for(endIndex=bytes.byteLength,startIndex=endIndex-188,endLoop=!1;startIndex>=0;)if(71!==bytes[startIndex]||71!==bytes[endIndex])startIndex--,endIndex--;else{switch(packet=bytes.subarray(startIndex,endIndex),probe$2.ts.parseType(packet,pmt.pid)){case"pes":pesType=probe$2.ts.parsePesType(packet,pmt.table),pusi=probe$2.ts.parsePayloadUnitStartIndicator(packet),"video"===pesType&&pusi&&(parsed=probe$2.ts.parsePesTime(packet))&&(parsed.type="video",result.video.push(parsed),endLoop=!0)}if(endLoop)break;startIndex-=188,endIndex-=188}},adjustTimestamp_=function(segmentInfo,baseTimestamp){if(segmentInfo.audio&&segmentInfo.audio.length){var audioBaseTimestamp=baseTimestamp;void 0===audioBaseTimestamp&&(audioBaseTimestamp=segmentInfo.audio[0].dts),segmentInfo.audio.forEach(function(info){info.dts=handleRollover$1(info.dts,audioBaseTimestamp),info.pts=handleRollover$1(info.pts,audioBaseTimestamp),info.dtsTime=info.dts/ONE_SECOND_IN_TS$2,info.ptsTime=info.pts/ONE_SECOND_IN_TS$2})}if(segmentInfo.video&&segmentInfo.video.length){var videoBaseTimestamp=baseTimestamp;if(void 0===videoBaseTimestamp&&(videoBaseTimestamp=segmentInfo.video[0].dts),segmentInfo.video.forEach(function(info){info.dts=handleRollover$1(info.dts,videoBaseTimestamp),info.pts=handleRollover$1(info.pts,videoBaseTimestamp),info.dtsTime=info.dts/ONE_SECOND_IN_TS$2,info.ptsTime=info.pts/ONE_SECOND_IN_TS$2}),segmentInfo.firstKeyFrame){var frame=segmentInfo.firstKeyFrame;frame.dts=handleRollover$1(frame.dts,videoBaseTimestamp),frame.pts=handleRollover$1(frame.pts,videoBaseTimestamp),frame.dtsTime=frame.dts/ONE_SECOND_IN_TS$2,frame.ptsTime=frame.dts/ONE_SECOND_IN_TS$2}}},inspectAac_=function(bytes){for(var packet,endLoop=!1,audioCount=0,sampleRate=null,timestamp=null,frameSize=0,byteIndex=0;bytes.length-byteIndex>=3;){switch(probe$2.aac.parseType(bytes,byteIndex)){case"timed-metadata":if(bytes.length-byteIndex<10){endLoop=!0;break}if((frameSize=probe$2.aac.parseId3TagSize(bytes,byteIndex))>bytes.length){endLoop=!0;break}null===timestamp&&(packet=bytes.subarray(byteIndex,byteIndex+frameSize),timestamp=probe$2.aac.parseAacTimestamp(packet)),byteIndex+=frameSize;break;case"audio":if(bytes.length-byteIndex<7){endLoop=!0;break}if((frameSize=probe$2.aac.parseAdtsSize(bytes,byteIndex))>bytes.length){endLoop=!0;break}null===sampleRate&&(packet=bytes.subarray(byteIndex,byteIndex+frameSize),sampleRate=probe$2.aac.parseSampleRate(packet)),audioCount++,byteIndex+=frameSize;break;default:byteIndex++}if(endLoop)return null}if(null===sampleRate||null===timestamp)return null;var audioTimescale=ONE_SECOND_IN_TS$2/sampleRate;return{audio:[{type:"audio",dts:timestamp,pts:timestamp},{type:"audio",dts:timestamp+1024*audioCount*audioTimescale,pts:timestamp+1024*audioCount*audioTimescale}]}},inspectTs_=function(bytes){var pmt={pid:null,table:null},result={};parsePsi_(bytes,pmt);for(var pid in pmt.table)if(pmt.table.hasOwnProperty(pid)){var type=pmt.table[pid];switch(type){case streamTypes.H264_STREAM_TYPE:result.video=[],parseVideoPes_(bytes,pmt,result),0===result.video.length&&delete result.video;break;case streamTypes.ADTS_STREAM_TYPE:result.audio=[],parseAudioPes_(bytes,pmt,result),0===result.audio.length&&delete result.audio}}return result},inspect=function(bytes,baseTimestamp){var result,isAacData=probe$2.aac.isLikelyAacData(bytes);return(result=isAacData?inspectAac_(bytes):inspectTs_(bytes))&&(result.audio||result.video)?(adjustTimestamp_(result,baseTimestamp),result):null},tsInspector={inspect:inspect,parseAudioPes_:parseAudioPes_},tsprobe=tsInspector.inspect,syncPointStrategies=[{name:"VOD",run:function(syncController,playlist,duration$$1,currentTimeline,currentTime){if(duration$$1!==1/0){return{time:0,segmentIndex:0}}return null}},{name:"ProgramDateTime",run:function(syncController,playlist,duration$$1,currentTimeline,currentTime){if(!syncController.datetimeToDisplayTime)return null;var segments=playlist.segments||[],syncPoint=null,lastDistance=null;currentTime=currentTime||0;for(var i=0;i<segments.length;i++){var segment=segments[i];if(segment.dateTimeObject){var segmentTime=segment.dateTimeObject.getTime()/1e3,segmentStart=segmentTime+syncController.datetimeToDisplayTime,distance=Math.abs(currentTime-segmentStart);if(null!==lastDistance&&(0===distance||lastDistance<distance))break;lastDistance=distance,syncPoint={time:segmentStart,segmentIndex:i}}}return syncPoint}},{name:"Segment",run:function(syncController,playlist,duration$$1,currentTimeline,currentTime){var segments=playlist.segments||[],syncPoint=null,lastDistance=null;currentTime=currentTime||0;for(var i=0;i<segments.length;i++){var segment=segments[i];if(segment.timeline===currentTimeline&&void 0!==segment.start){var distance=Math.abs(currentTime-segment.start);if(null!==lastDistance&&lastDistance<distance)break;(!syncPoint||null===lastDistance||lastDistance>=distance)&&(lastDistance=distance,syncPoint={time:segment.start,segmentIndex:i})}}return syncPoint}},{name:"Discontinuity",run:function(syncController,playlist,duration$$1,currentTimeline,currentTime){var syncPoint=null;if(currentTime=currentTime||0,playlist.discontinuityStarts&&playlist.discontinuityStarts.length)for(var lastDistance=null,i=0;i<playlist.discontinuityStarts.length;i++){var segmentIndex=playlist.discontinuityStarts[i],discontinuity=playlist.discontinuitySequence+i+1,discontinuitySync=syncController.discontinuities[discontinuity];if(discontinuitySync){var distance=Math.abs(currentTime-discontinuitySync.time);if(null!==lastDistance&&lastDistance<distance)break;(!syncPoint||null===lastDistance||lastDistance>=distance)&&(lastDistance=distance,syncPoint={time:discontinuitySync.time,segmentIndex:segmentIndex})}}return syncPoint}},{name:"Playlist",run:function(syncController,playlist,duration$$1,currentTimeline,currentTime){if(playlist.syncInfo){return{time:playlist.syncInfo.time,segmentIndex:playlist.syncInfo.mediaSequence-playlist.mediaSequence}}return null}}],SyncController=function(_videojs$EventTarget){inherits(SyncController,_videojs$EventTarget);function SyncController(){classCallCheck(this,SyncController);var _this=possibleConstructorReturn(this,(SyncController.__proto__||Object.getPrototypeOf(SyncController)).call(this));return _this.inspectCache_=void 0,_this.timelines=[],_this.discontinuities=[],_this.datetimeToDisplayTime=null,_this.logger_=logger("SyncController"),_this}return createClass(SyncController,[{key:"getSyncPoint",value:function(playlist,duration$$1,currentTimeline,currentTime){var syncPoints=this.runStrategies_(playlist,duration$$1,currentTimeline,currentTime);return syncPoints.length?this.selectSyncPoint_(syncPoints,{key:"time",value:currentTime}):null}},{key:"getExpiredTime",value:function(playlist,duration$$1){if(!playlist||!playlist.segments)return null;var syncPoints=this.runStrategies_(playlist,duration$$1,playlist.discontinuitySequence,0);if(!syncPoints.length)return null;var syncPoint=this.selectSyncPoint_(syncPoints,{key:"segmentIndex",value:0});return syncPoint.segmentIndex>0&&(syncPoint.time*=-1),Math.abs(syncPoint.time+sumDurations(playlist,syncPoint.segmentIndex,0))}},{key:"runStrategies_",value:function(playlist,duration$$1,currentTimeline,currentTime){for(var syncPoints=[],i=0;i<syncPointStrategies.length;i++){var strategy=syncPointStrategies[i],syncPoint=strategy.run(this,playlist,duration$$1,currentTimeline,currentTime);syncPoint&&(syncPoint.strategy=strategy.name,syncPoints.push({strategy:strategy.name,syncPoint:syncPoint}))}return syncPoints}},{key:"selectSyncPoint_",value:function(syncPoints,target){for(var bestSyncPoint=syncPoints[0].syncPoint,bestDistance=Math.abs(syncPoints[0].syncPoint[target.key]-target.value),bestStrategy=syncPoints[0].strategy,i=1;i<syncPoints.length;i++){var newDistance=Math.abs(syncPoints[i].syncPoint[target.key]-target.value);newDistance<bestDistance&&(bestDistance=newDistance,bestSyncPoint=syncPoints[i].syncPoint,bestStrategy=syncPoints[i].strategy)}return this.logger_("syncPoint for ["+target.key+": "+target.value+"] chosen with strategy ["+bestStrategy+"]: [time:"+bestSyncPoint.time+", segmentIndex:"+bestSyncPoint.segmentIndex+"]"),bestSyncPoint}},{key:"saveExpiredSegmentInfo",value:function(oldPlaylist,newPlaylist){for(var mediaSequenceDiff=newPlaylist.mediaSequence-oldPlaylist.mediaSequence,i=mediaSequenceDiff-1;i>=0;i--){var lastRemovedSegment=oldPlaylist.segments[i];if(lastRemovedSegment&&void 0!==lastRemovedSegment.start){newPlaylist.syncInfo={mediaSequence:oldPlaylist.mediaSequence+i,time:lastRemovedSegment.start},this.logger_("playlist refresh sync: [time:"+newPlaylist.syncInfo.time+", mediaSequence: "+newPlaylist.syncInfo.mediaSequence+"]"),this.trigger("syncinfoupdate");break}}}},{key:"setDateTimeMapping",value:function(playlist){if(!this.datetimeToDisplayTime&&playlist.segments&&playlist.segments.length&&playlist.segments[0].dateTimeObject){var playlistTimestamp=playlist.segments[0].dateTimeObject.getTime()/1e3;this.datetimeToDisplayTime=-playlistTimestamp}}},{key:"reset",value:function(){this.inspectCache_=void 0}},{key:"probeSegmentInfo",value:function(segmentInfo){var segment=segmentInfo.segment,playlist=segmentInfo.playlist,timingInfo=void 0;return timingInfo=segment.map?this.probeMp4Segment_(segmentInfo):this.probeTsSegment_(segmentInfo),timingInfo&&this.calculateSegmentTimeMapping_(segmentInfo,timingInfo)&&(this.saveDiscontinuitySyncInfo_(segmentInfo),playlist.syncInfo||(playlist.syncInfo={mediaSequence:playlist.mediaSequence+segmentInfo.mediaIndex,time:segment.start})),timingInfo}},{key:"probeMp4Segment_",value:function(segmentInfo){var segment=segmentInfo.segment,timescales=probe.timescale(segment.map.bytes),compositionStartTime=probe.compositionStartTime(timescales,segmentInfo.bytes);return null!==segmentInfo.timestampOffset&&(segmentInfo.timestampOffset-=compositionStartTime),{start:compositionStartTime,end:compositionStartTime+segment.duration}}},{key:"probeTsSegment_",value:function(segmentInfo){var timeInfo=tsprobe(segmentInfo.bytes,this.inspectCache_),segmentStartTime=void 0,segmentEndTime=void 0,segmentTimestampInfo=void 0;return timeInfo?(timeInfo.video&&2===timeInfo.video.length?(this.inspectCache_=timeInfo.video[1].dts,segmentStartTime=timeInfo.video[0].dtsTime,segmentEndTime=timeInfo.video[1].dtsTime,segmentTimestampInfo=timeInfo.video):timeInfo.audio&&2===timeInfo.audio.length&&(this.inspectCache_=timeInfo.audio[1].dts,segmentStartTime=timeInfo.audio[0].dtsTime,segmentEndTime=timeInfo.audio[1].dtsTime,segmentTimestampInfo=timeInfo.audio),{segmentTimestampInfo:segmentTimestampInfo,start:segmentStartTime,end:segmentEndTime,containsVideo:timeInfo.video&&2===timeInfo.video.length,containsAudio:timeInfo.audio&&2===timeInfo.audio.length}):null}},{key:"timestampOffsetForTimeline",value:function(timeline){return void 0===this.timelines[timeline]?null:this.timelines[timeline].time}},{key:"mappingForTimeline",value:function(timeline){return void 0===this.timelines[timeline]?null:this.timelines[timeline].mapping}},{key:"calculateSegmentTimeMapping_",value:function(segmentInfo,timingInfo){var segment=segmentInfo.segment,mappingObj=this.timelines[segmentInfo.timeline];if(null!==segmentInfo.timestampOffset)mappingObj={time:segmentInfo.startOfSegment,mapping:segmentInfo.startOfSegment-timingInfo.start},this.timelines[segmentInfo.timeline]=mappingObj,this.trigger("timestampoffset"),this.logger_("time mapping for timeline "+segmentInfo.timeline+": [time: "+mappingObj.time+"] [mapping: "+mappingObj.mapping+"]"),segment.start=segmentInfo.startOfSegment,segment.end=timingInfo.end+mappingObj.mapping;else{if(!mappingObj)return!1;segment.start=timingInfo.start+mappingObj.mapping,segment.end=timingInfo.end+mappingObj.mapping}return!0}},{key:"saveDiscontinuitySyncInfo_",value:function(segmentInfo){var playlist=segmentInfo.playlist,segment=segmentInfo.segment;if(segment.discontinuity)this.discontinuities[segment.timeline]={time:segment.start,accuracy:0};else if(playlist.discontinuityStarts&&playlist.discontinuityStarts.length)for(var i=0;i<playlist.discontinuityStarts.length;i++){var segmentIndex=playlist.discontinuityStarts[i],discontinuity=playlist.discontinuitySequence+i+1,mediaIndexDiff=segmentIndex-segmentInfo.mediaIndex,accuracy=Math.abs(mediaIndexDiff);if(!this.discontinuities[discontinuity]||this.discontinuities[discontinuity].accuracy>accuracy){var time=void 0;time=mediaIndexDiff<0?segment.start-sumDurations(playlist,segmentInfo.mediaIndex,segmentIndex):segment.end+sumDurations(playlist,segmentInfo.mediaIndex+1,segmentIndex),this.discontinuities[discontinuity]={time:time,accuracy:accuracy}}}}}]),SyncController}(videojs.EventTarget),Decrypter$1=new shimWorker("./decrypter-worker.worker.js",function(window,document){var self=this;!function(){function unpad(padded){return padded.subarray(0,padded.byteLength-padded[padded.byteLength-1])}var classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),inherits=function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)
},possibleConstructorReturn=function(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call},precompute=function(){var tables=[[[],[],[],[],[]],[[],[],[],[],[]]],encTable=tables[0],decTable=tables[1],sbox=encTable[4],sboxInv=decTable[4],i=void 0,x=void 0,xInv=void 0,d=[],th=[],x2=void 0,x4=void 0,x8=void 0,s=void 0,tEnc=void 0,tDec=void 0;for(i=0;i<256;i++)th[(d[i]=i<<1^283*(i>>7))^i]=i;for(x=xInv=0;!sbox[x];x^=x2||1,xInv=th[xInv]||1)for(s=xInv^xInv<<1^xInv<<2^xInv<<3^xInv<<4,s=s>>8^255&s^99,sbox[x]=s,sboxInv[s]=x,x8=d[x4=d[x2=d[x]]],tDec=16843009*x8^65537*x4^257*x2^16843008*x,tEnc=257*d[s]^16843008*s,i=0;i<4;i++)encTable[i][x]=tEnc=tEnc<<24^tEnc>>>8,decTable[i][s]=tDec=tDec<<24^tDec>>>8;for(i=0;i<5;i++)encTable[i]=encTable[i].slice(0),decTable[i]=decTable[i].slice(0);return tables},aesTables=null,AES=function(){function AES(key){classCallCheck(this,AES),aesTables||(aesTables=precompute()),this._tables=[[aesTables[0][0].slice(),aesTables[0][1].slice(),aesTables[0][2].slice(),aesTables[0][3].slice(),aesTables[0][4].slice()],[aesTables[1][0].slice(),aesTables[1][1].slice(),aesTables[1][2].slice(),aesTables[1][3].slice(),aesTables[1][4].slice()]];var i=void 0,j=void 0,tmp=void 0,encKey=void 0,decKey=void 0,sbox=this._tables[0][4],decTable=this._tables[1],keyLen=key.length,rcon=1;if(4!==keyLen&&6!==keyLen&&8!==keyLen)throw new Error("Invalid aes key size");for(encKey=key.slice(0),decKey=[],this._key=[encKey,decKey],i=keyLen;i<4*keyLen+28;i++)tmp=encKey[i-1],(i%keyLen==0||8===keyLen&&i%keyLen==4)&&(tmp=sbox[tmp>>>24]<<24^sbox[tmp>>16&255]<<16^sbox[tmp>>8&255]<<8^sbox[255&tmp],i%keyLen==0&&(tmp=tmp<<8^tmp>>>24^rcon<<24,rcon=rcon<<1^283*(rcon>>7))),encKey[i]=encKey[i-keyLen]^tmp;for(j=0;i;j++,i--)tmp=encKey[3&j?i:i-4],decKey[j]=i<=4||j<4?tmp:decTable[0][sbox[tmp>>>24]]^decTable[1][sbox[tmp>>16&255]]^decTable[2][sbox[tmp>>8&255]]^decTable[3][sbox[255&tmp]]}return AES.prototype.decrypt=function(encrypted0,encrypted1,encrypted2,encrypted3,out,offset){var key=this._key[1],a=encrypted0^key[0],b=encrypted3^key[1],c=encrypted2^key[2],d=encrypted1^key[3],a2=void 0,b2=void 0,c2=void 0,nInnerRounds=key.length/4-2,i=void 0,kIndex=4,table=this._tables[1],table0=table[0],table1=table[1],table2=table[2],table3=table[3],sbox=table[4];for(i=0;i<nInnerRounds;i++)a2=table0[a>>>24]^table1[b>>16&255]^table2[c>>8&255]^table3[255&d]^key[kIndex],b2=table0[b>>>24]^table1[c>>16&255]^table2[d>>8&255]^table3[255&a]^key[kIndex+1],c2=table0[c>>>24]^table1[d>>16&255]^table2[a>>8&255]^table3[255&b]^key[kIndex+2],d=table0[d>>>24]^table1[a>>16&255]^table2[b>>8&255]^table3[255&c]^key[kIndex+3],kIndex+=4,a=a2,b=b2,c=c2;for(i=0;i<4;i++)out[(3&-i)+offset]=sbox[a>>>24]<<24^sbox[b>>16&255]<<16^sbox[c>>8&255]<<8^sbox[255&d]^key[kIndex++],a2=a,a=b,b=c,c=d,d=a2},AES}(),Stream=function(){function Stream(){classCallCheck(this,Stream),this.listeners={}}return Stream.prototype.on=function(type,listener){this.listeners[type]||(this.listeners[type]=[]),this.listeners[type].push(listener)},Stream.prototype.off=function(type,listener){if(!this.listeners[type])return!1;var index=this.listeners[type].indexOf(listener);return this.listeners[type].splice(index,1),index>-1},Stream.prototype.trigger=function(type){var callbacks=this.listeners[type];if(callbacks)if(2===arguments.length)for(var length=callbacks.length,i=0;i<length;++i)callbacks[i].call(this,arguments[1]);else for(var args=Array.prototype.slice.call(arguments,1),_length=callbacks.length,_i=0;_i<_length;++_i)callbacks[_i].apply(this,args)},Stream.prototype.dispose=function(){this.listeners={}},Stream.prototype.pipe=function(destination){this.on("data",function(data){destination.push(data)})},Stream}(),AsyncStream=function(_Stream){inherits(AsyncStream,_Stream);function AsyncStream(){classCallCheck(this,AsyncStream);var _this=possibleConstructorReturn(this,_Stream.call(this,Stream));return _this.jobs=[],_this.delay=1,_this.timeout_=null,_this}return AsyncStream.prototype.processJob_=function(){this.jobs.shift()(),this.jobs.length?this.timeout_=setTimeout(this.processJob_.bind(this),this.delay):this.timeout_=null},AsyncStream.prototype.push=function(job){this.jobs.push(job),this.timeout_||(this.timeout_=setTimeout(this.processJob_.bind(this),this.delay))},AsyncStream}(Stream),ntoh=function(word){return word<<24|(65280&word)<<8|(16711680&word)>>8|word>>>24},decrypt=function(encrypted,key,initVector){var encrypted32=new Int32Array(encrypted.buffer,encrypted.byteOffset,encrypted.byteLength>>2),decipher=new AES(Array.prototype.slice.call(key)),decrypted=new Uint8Array(encrypted.byteLength),decrypted32=new Int32Array(decrypted.buffer),init0=void 0,init1=void 0,init2=void 0,init3=void 0,encrypted0=void 0,encrypted1=void 0,encrypted2=void 0,encrypted3=void 0,wordIx=void 0;for(init0=initVector[0],init1=initVector[1],init2=initVector[2],init3=initVector[3],wordIx=0;wordIx<encrypted32.length;wordIx+=4)encrypted0=ntoh(encrypted32[wordIx]),encrypted1=ntoh(encrypted32[wordIx+1]),encrypted2=ntoh(encrypted32[wordIx+2]),encrypted3=ntoh(encrypted32[wordIx+3]),decipher.decrypt(encrypted0,encrypted1,encrypted2,encrypted3,decrypted32,wordIx),decrypted32[wordIx]=ntoh(decrypted32[wordIx]^init0),decrypted32[wordIx+1]=ntoh(decrypted32[wordIx+1]^init1),decrypted32[wordIx+2]=ntoh(decrypted32[wordIx+2]^init2),decrypted32[wordIx+3]=ntoh(decrypted32[wordIx+3]^init3),init0=encrypted0,init1=encrypted1,init2=encrypted2,init3=encrypted3;return decrypted},Decrypter=function(){function Decrypter(encrypted,key,initVector,done){classCallCheck(this,Decrypter);var step=Decrypter.STEP,encrypted32=new Int32Array(encrypted.buffer),decrypted=new Uint8Array(encrypted.byteLength),i=0;for(this.asyncStream_=new AsyncStream,this.asyncStream_.push(this.decryptChunk_(encrypted32.subarray(i,i+step),key,initVector,decrypted)),i=step;i<encrypted32.length;i+=step)initVector=new Uint32Array([ntoh(encrypted32[i-4]),ntoh(encrypted32[i-3]),ntoh(encrypted32[i-2]),ntoh(encrypted32[i-1])]),this.asyncStream_.push(this.decryptChunk_(encrypted32.subarray(i,i+step),key,initVector,decrypted));this.asyncStream_.push(function(){done(null,unpad(decrypted))})}return Decrypter.prototype.decryptChunk_=function(encrypted,key,initVector,decrypted){return function(){var bytes=decrypt(encrypted,key,initVector);decrypted.set(bytes,encrypted.byteOffset)}},createClass(Decrypter,null,[{key:"STEP",get:function(){return 32e3}}]),Decrypter}(),createTransferableMessage=function(message){var transferable={};return Object.keys(message).forEach(function(key){var value=message[key];ArrayBuffer.isView(value)?transferable[key]={bytes:value.buffer,byteOffset:value.byteOffset,byteLength:value.byteLength}:transferable[key]=value}),transferable};new function(self){self.onmessage=function(event){var data=event.data,encrypted=new Uint8Array(data.encrypted.bytes,data.encrypted.byteOffset,data.encrypted.byteLength),key=new Uint32Array(data.key.bytes,data.key.byteOffset,data.key.byteLength/4),iv=new Uint32Array(data.iv.bytes,data.iv.byteOffset,data.iv.byteLength/4);new Decrypter(encrypted,key,iv,function(err,bytes){self.postMessage(createTransferableMessage({source:data.source,decrypted:bytes}),[bytes.buffer])})}}(self)}()}),audioTrackKind_=function(properties){var kind=properties.default?"main":"alternative";return properties.characteristics&&properties.characteristics.indexOf("public.accessibility.describes-video")>=0&&(kind="main-desc"),kind},stopLoaders=function(segmentLoader,mediaType){segmentLoader.abort(),segmentLoader.pause(),mediaType&&mediaType.activePlaylistLoader&&(mediaType.activePlaylistLoader.pause(),mediaType.activePlaylistLoader=null)},startLoaders=function(playlistLoader,mediaType){mediaType.activePlaylistLoader=playlistLoader,playlistLoader.load()},onGroupChanged=function(type,settings){return function(){var _settings$segmentLoad=settings.segmentLoaders,segmentLoader=_settings$segmentLoad[type],mainSegmentLoader=_settings$segmentLoad.main,mediaType=settings.mediaTypes[type],activeTrack=mediaType.activeTrack(),activeGroup=mediaType.activeGroup(activeTrack),previousActiveLoader=mediaType.activePlaylistLoader;if(stopLoaders(segmentLoader,mediaType),activeGroup){if(!activeGroup.playlistLoader)return void(previousActiveLoader&&mainSegmentLoader.resetEverything());segmentLoader.resyncLoader(),startLoaders(activeGroup.playlistLoader,mediaType)}}},onTrackChanged=function(type,settings){return function(){var _settings$segmentLoad2=settings.segmentLoaders,segmentLoader=_settings$segmentLoad2[type],mainSegmentLoader=_settings$segmentLoad2.main,mediaType=settings.mediaTypes[type],activeTrack=mediaType.activeTrack(),activeGroup=mediaType.activeGroup(activeTrack),previousActiveLoader=mediaType.activePlaylistLoader;if(stopLoaders(segmentLoader,mediaType),activeGroup){if(!activeGroup.playlistLoader)return void mainSegmentLoader.resetEverything();if(previousActiveLoader===activeGroup.playlistLoader)return void startLoaders(activeGroup.playlistLoader,mediaType);segmentLoader.track&&segmentLoader.track(activeTrack),segmentLoader.resetEverything(),startLoaders(activeGroup.playlistLoader,mediaType)}}},onError={AUDIO:function(type,settings){return function(){var segmentLoader=settings.segmentLoaders[type],mediaType=settings.mediaTypes[type],blacklistCurrentPlaylist=settings.blacklistCurrentPlaylist;stopLoaders(segmentLoader,mediaType);var activeTrack=mediaType.activeTrack(),activeGroup=mediaType.activeGroup(),id=(activeGroup.filter(function(group){return group.default})[0]||activeGroup[0]).id,defaultTrack=mediaType.tracks[id];if(activeTrack===defaultTrack)return void blacklistCurrentPlaylist({message:"Problem encountered loading the default audio track."});videojs.log.warn("Problem encountered loading the alternate audio track.Switching back to default.");for(var trackId in mediaType.tracks)mediaType.tracks[trackId].enabled=mediaType.tracks[trackId]===defaultTrack;mediaType.onTrackChanged()}},SUBTITLES:function(type,settings){return function(){var segmentLoader=settings.segmentLoaders[type],mediaType=settings.mediaTypes[type];videojs.log.warn("Problem encountered loading the subtitle track.Disabling subtitle track."),stopLoaders(segmentLoader,mediaType);var track=mediaType.activeTrack();track&&(track.mode="disabled"),mediaType.onTrackChanged()}}},setupListeners={AUDIO:function(type,playlistLoader,settings){if(playlistLoader){var tech=settings.tech,requestOptions=settings.requestOptions,segmentLoader=settings.segmentLoaders[type];playlistLoader.on("loadedmetadata",function(){var media=playlistLoader.media();segmentLoader.playlist(media,requestOptions),(!tech.paused()||media.endList&&"none"!==tech.preload())&&segmentLoader.load()}),playlistLoader.on("loadedplaylist",function(){segmentLoader.playlist(playlistLoader.media(),requestOptions),tech.paused()||segmentLoader.load()}),playlistLoader.on("error",onError[type](type,settings))}},SUBTITLES:function(type,playlistLoader,settings){var tech=settings.tech,requestOptions=settings.requestOptions,segmentLoader=settings.segmentLoaders[type],mediaType=settings.mediaTypes[type];playlistLoader.on("loadedmetadata",function(){var media=playlistLoader.media();segmentLoader.playlist(media,requestOptions),segmentLoader.track(mediaType.activeTrack()),(!tech.paused()||media.endList&&"none"!==tech.preload())&&segmentLoader.load()}),playlistLoader.on("loadedplaylist",function(){segmentLoader.playlist(playlistLoader.media(),requestOptions),tech.paused()||segmentLoader.load()}),playlistLoader.on("error",onError[type](type,settings))}},initialize={AUDIO:function(type,settings){var hls=settings.hls,sourceType=settings.sourceType,segmentLoader=settings.segmentLoaders[type],requestOptions=settings.requestOptions,mediaGroups=settings.master.mediaGroups,_settings$mediaTypes$=settings.mediaTypes[type],groups=_settings$mediaTypes$.groups,tracks=_settings$mediaTypes$.tracks,masterPlaylistLoader=settings.masterPlaylistLoader;mediaGroups[type]&&0!==Object.keys(mediaGroups[type]).length||(mediaGroups[type]={main:{default:{default:!0}}});for(var groupId in mediaGroups[type]){groups[groupId]||(groups[groupId]=[]);for(var variantLabel in mediaGroups[type][groupId]){var properties=mediaGroups[type][groupId][variantLabel],playlistLoader=void 0;if(playlistLoader=properties.resolvedUri?new PlaylistLoader(properties.resolvedUri,hls,requestOptions):properties.playlists&&"dash"===sourceType?new DashPlaylistLoader(properties.playlists[0],hls,requestOptions,masterPlaylistLoader):null,properties=videojs.mergeOptions({id:variantLabel,playlistLoader:playlistLoader},properties),setupListeners[type](type,properties.playlistLoader,settings),groups[groupId].push(properties),void 0===tracks[variantLabel]){var track=new videojs.AudioTrack({id:variantLabel,kind:audioTrackKind_(properties),enabled:!1,language:properties.language,default:properties.default,label:variantLabel});tracks[variantLabel]=track}}}segmentLoader.on("error",onError[type](type,settings))},SUBTITLES:function(type,settings){var tech=settings.tech,hls=settings.hls,sourceType=settings.sourceType,segmentLoader=settings.segmentLoaders[type],requestOptions=settings.requestOptions,mediaGroups=settings.master.mediaGroups,_settings$mediaTypes$2=settings.mediaTypes[type],groups=_settings$mediaTypes$2.groups,tracks=_settings$mediaTypes$2.tracks,masterPlaylistLoader=settings.masterPlaylistLoader;for(var groupId in mediaGroups[type]){groups[groupId]||(groups[groupId]=[]);for(var variantLabel in mediaGroups[type][groupId])if(!mediaGroups[type][groupId][variantLabel].forced){var properties=mediaGroups[type][groupId][variantLabel],playlistLoader=void 0;if("hls"===sourceType?playlistLoader=new PlaylistLoader(properties.resolvedUri,hls,requestOptions):"dash"===sourceType&&(playlistLoader=new DashPlaylistLoader(properties.playlists[0],hls,requestOptions,masterPlaylistLoader)),properties=videojs.mergeOptions({id:variantLabel,playlistLoader:playlistLoader},properties),setupListeners[type](type,properties.playlistLoader,settings),groups[groupId].push(properties),void 0===tracks[variantLabel]){var track=tech.addRemoteTextTrack({id:variantLabel,kind:"subtitles",default:properties.default&&properties.autoselect,language:properties.language,label:variantLabel},!1).track;tracks[variantLabel]=track}}}segmentLoader.on("error",onError[type](type,settings))},"CLOSED-CAPTIONS":function(type,settings){var tech=settings.tech,mediaGroups=settings.master.mediaGroups,_settings$mediaTypes$3=settings.mediaTypes[type],groups=_settings$mediaTypes$3.groups,tracks=_settings$mediaTypes$3.tracks;for(var groupId in mediaGroups[type]){groups[groupId]||(groups[groupId]=[]);for(var variantLabel in mediaGroups[type][groupId]){var properties=mediaGroups[type][groupId][variantLabel];if(properties.instreamId.match(/CC\d/)&&(groups[groupId].push(videojs.mergeOptions({id:variantLabel},properties)),void 0===tracks[variantLabel])){var track=tech.addRemoteTextTrack({id:properties.instreamId,kind:"captions",default:properties.default&&properties.autoselect,language:properties.language,label:variantLabel},!1).track;tracks[variantLabel]=track}}}}},activeGroup=function(type,settings){return function(track){var masterPlaylistLoader=settings.masterPlaylistLoader,groups=settings.mediaTypes[type].groups,media=masterPlaylistLoader.media();if(!media)return null;var variants=null;return media.attributes[type]&&(variants=groups[media.attributes[type]]),variants=variants||groups.main,void 0===track?variants:null===track?null:variants.filter(function(props){return props.id===track.id})[0]||null}},activeTrack={AUDIO:function(type,settings){return function(){var tracks=settings.mediaTypes[type].tracks;for(var id in tracks)if(tracks[id].enabled)return tracks[id];return null}},SUBTITLES:function(type,settings){return function(){var tracks=settings.mediaTypes[type].tracks;for(var id in tracks)if("showing"===tracks[id].mode)return tracks[id];return null}}},setupMediaGroups=function(settings){["AUDIO","SUBTITLES","CLOSED-CAPTIONS"].forEach(function(type){initialize[type](type,settings)});var mediaTypes=settings.mediaTypes,masterPlaylistLoader=settings.masterPlaylistLoader,tech=settings.tech,hls=settings.hls;["AUDIO","SUBTITLES"].forEach(function(type){mediaTypes[type].activeGroup=activeGroup(type,settings),mediaTypes[type].activeTrack=activeTrack[type](type,settings),mediaTypes[type].onGroupChanged=onGroupChanged(type,settings),mediaTypes[type].onTrackChanged=onTrackChanged(type,settings)});var audioGroup=mediaTypes.AUDIO.activeGroup(),groupId=(audioGroup.filter(function(group){return group.default})[0]||audioGroup[0]).id;mediaTypes.AUDIO.tracks[groupId].enabled=!0,mediaTypes.AUDIO.onTrackChanged(),masterPlaylistLoader.on("mediachange",function(){["AUDIO","SUBTITLES"].forEach(function(type){return mediaTypes[type].onGroupChanged()})});var onAudioTrackChanged=function(){mediaTypes.AUDIO.onTrackChanged(),tech.trigger({type:"usage",name:"hls-audio-change"})};tech.audioTracks().addEventListener("change",onAudioTrackChanged),tech.remoteTextTracks().addEventListener("change",mediaTypes.SUBTITLES.onTrackChanged),hls.on("dispose",function(){tech.audioTracks().removeEventListener("change",onAudioTrackChanged),tech.remoteTextTracks().removeEventListener("change",mediaTypes.SUBTITLES.onTrackChanged)}),tech.clearTracks("audio");for(var id in mediaTypes.AUDIO.tracks)tech.audioTracks().addTrack(mediaTypes.AUDIO.tracks[id])},createMediaTypes=function(){var mediaTypes={};return["AUDIO","SUBTITLES","CLOSED-CAPTIONS"].forEach(function(type){mediaTypes[type]={groups:{},tracks:{},activePlaylistLoader:null,activeGroup:noop,activeTrack:noop,onGroupChanged:noop,onTrackChanged:noop}}),mediaTypes},Hls=void 0,loaderStats=["mediaRequests","mediaRequestsAborted","mediaRequestsTimedout","mediaRequestsErrored","mediaTransferDuration","mediaBytesTransferred"],sumLoaderStat=function(stat){return this.audioSegmentLoader_[stat]+this.mainSegmentLoader_[stat]},MasterPlaylistController=function(_videojs$EventTarget){inherits(MasterPlaylistController,_videojs$EventTarget);function MasterPlaylistController(options){classCallCheck(this,MasterPlaylistController);var _this=possibleConstructorReturn(this,(MasterPlaylistController.__proto__||Object.getPrototypeOf(MasterPlaylistController)).call(this)),url=options.url,handleManifestRedirects=options.handleManifestRedirects,withCredentials=options.withCredentials,tech=options.tech,bandwidth=options.bandwidth,externHls=options.externHls,useCueTags=options.useCueTags,blacklistDuration=options.blacklistDuration,enableLowInitialPlaylist=options.enableLowInitialPlaylist,sourceType=options.sourceType,seekTo=options.seekTo,cacheEncryptionKeys=options.cacheEncryptionKeys;if(!url)throw new Error("A non-empty playlist URL is required");Hls=externHls,_this.withCredentials=withCredentials,_this.tech_=tech,_this.hls_=tech.hls,_this.seekTo_=seekTo,_this.sourceType_=sourceType,_this.useCueTags_=useCueTags,_this.blacklistDuration=blacklistDuration,_this.enableLowInitialPlaylist=enableLowInitialPlaylist,_this.useCueTags_&&(_this.cueTagsTrack_=_this.tech_.addTextTrack("metadata","ad-cues"),_this.cueTagsTrack_.inBandMetadataTrackDispatchType=""),_this.requestOptions_={withCredentials:withCredentials,handleManifestRedirects:handleManifestRedirects,timeout:null},_this.mediaTypes_=createMediaTypes(),_this.mediaSource=new videojs.MediaSource,_this.mediaSource.addEventListener("sourceopen",_this.handleSourceOpen_.bind(_this)),_this.seekable_=videojs.createTimeRanges(),_this.hasPlayed_=function(){return!1},_this.syncController_=new SyncController(options),_this.segmentMetadataTrack_=tech.addRemoteTextTrack({kind:"metadata",label:"segment-metadata"},!1).track,_this.decrypter_=new Decrypter$1,_this.inbandTextTracks_={};var segmentLoaderSettings={hls:_this.hls_,mediaSource:_this.mediaSource,currentTime:_this.tech_.currentTime.bind(_this.tech_),seekable:function(){return _this.seekable()},seeking:function(){return _this.tech_.seeking()},duration:function(){return _this.mediaSource.duration},hasPlayed:function(){return _this.hasPlayed_()},goalBufferLength:function(){return _this.goalBufferLength()},bandwidth:bandwidth,syncController:_this.syncController_,decrypter:_this.decrypter_,sourceType:_this.sourceType_,inbandTextTracks:_this.inbandTextTracks_,cacheEncryptionKeys:cacheEncryptionKeys};return _this.masterPlaylistLoader_="dash"===_this.sourceType_?new DashPlaylistLoader(url,_this.hls_,_this.requestOptions_):new PlaylistLoader(url,_this.hls_,_this.requestOptions_),_this.setupMasterPlaylistLoaderListeners_(),_this.mainSegmentLoader_=new SegmentLoader(videojs.mergeOptions(segmentLoaderSettings,{segmentMetadataTrack:_this.segmentMetadataTrack_,loaderType:"main"}),options),_this.audioSegmentLoader_=new SegmentLoader(videojs.mergeOptions(segmentLoaderSettings,{loaderType:"audio"}),options),_this.subtitleSegmentLoader_=new VTTSegmentLoader(videojs.mergeOptions(segmentLoaderSettings,{loaderType:"vtt"}),options),_this.setupSegmentLoaderListeners_(),loaderStats.forEach(function(stat){_this[stat+"_"]=sumLoaderStat.bind(_this,stat)}),_this.logger_=logger("MPC"),_this.masterPlaylistLoader_.load(),_this}return createClass(MasterPlaylistController,[{key:"setupMasterPlaylistLoaderListeners_",value:function(){var _this2=this;this.masterPlaylistLoader_.on("loadedmetadata",function(){var media=_this2.masterPlaylistLoader_.media(),requestTimeout=1.5*media.targetDuration*1e3;isLowestEnabledRendition(_this2.masterPlaylistLoader_.master,_this2.masterPlaylistLoader_.media())?_this2.requestOptions_.timeout=0:_this2.requestOptions_.timeout=requestTimeout,media.endList&&"none"!==_this2.tech_.preload()&&(_this2.mainSegmentLoader_.playlist(media,_this2.requestOptions_),_this2.mainSegmentLoader_.load()),setupMediaGroups({sourceType:_this2.sourceType_,segmentLoaders:{AUDIO:_this2.audioSegmentLoader_,SUBTITLES:_this2.subtitleSegmentLoader_,main:_this2.mainSegmentLoader_},tech:_this2.tech_,requestOptions:_this2.requestOptions_,masterPlaylistLoader:_this2.masterPlaylistLoader_,hls:_this2.hls_,master:_this2.master(),mediaTypes:_this2.mediaTypes_,blacklistCurrentPlaylist:_this2.blacklistCurrentPlaylist.bind(_this2)}),_this2.triggerPresenceUsage_(_this2.master(),media);try{_this2.setupSourceBuffers_()}catch(e){return videojs.log.warn("Failed to create SourceBuffers",e),_this2.mediaSource.endOfStream("decode")}_this2.setupFirstPlay(),!_this2.mediaTypes_.AUDIO.activePlaylistLoader||_this2.mediaTypes_.AUDIO.activePlaylistLoader.media()?_this2.trigger("selectedinitialmedia"):_this2.mediaTypes_.AUDIO.activePlaylistLoader.one("loadedmetadata",function(){_this2.trigger("selectedinitialmedia")})}),this.masterPlaylistLoader_.on("loadedplaylist",function(){var updatedPlaylist=_this2.masterPlaylistLoader_.media();if(!updatedPlaylist){_this2.excludeUnsupportedVariants_();var selectedMedia=void 0;return _this2.enableLowInitialPlaylist&&(selectedMedia=_this2.selectInitialPlaylist()),selectedMedia||(selectedMedia=_this2.selectPlaylist()),_this2.initialMedia_=selectedMedia,void _this2.masterPlaylistLoader_.media(_this2.initialMedia_)}if(_this2.useCueTags_&&_this2.updateAdCues_(updatedPlaylist),_this2.mainSegmentLoader_.playlist(updatedPlaylist,_this2.requestOptions_),_this2.updateDuration(),_this2.tech_.paused()||(_this2.mainSegmentLoader_.load(),_this2.audioSegmentLoader_&&_this2.audioSegmentLoader_.load()),!updatedPlaylist.endList){var addSeekableRange=function(){var seekable$$1=_this2.seekable();0!==seekable$$1.length&&_this2.mediaSource.addSeekableRange_(seekable$$1.start(0),seekable$$1.end(0))};if(_this2.duration()!==1/0){var onDurationchange=function onDurationchange(){_this2.duration()===1/0?addSeekableRange():_this2.tech_.one("durationchange",onDurationchange)};_this2.tech_.one("durationchange",onDurationchange)}else addSeekableRange()}}),this.masterPlaylistLoader_.on("error",function(){_this2.blacklistCurrentPlaylist(_this2.masterPlaylistLoader_.error)}),this.masterPlaylistLoader_.on("mediachanging",function(){_this2.mainSegmentLoader_.abort(),_this2.mainSegmentLoader_.pause()}),this.masterPlaylistLoader_.on("mediachange",function(){var media=_this2.masterPlaylistLoader_.media(),requestTimeout=1.5*media.targetDuration*1e3;isLowestEnabledRendition(_this2.masterPlaylistLoader_.master,_this2.masterPlaylistLoader_.media())?_this2.requestOptions_.timeout=0:_this2.requestOptions_.timeout=requestTimeout,_this2.mainSegmentLoader_.playlist(media,_this2.requestOptions_),_this2.mainSegmentLoader_.load(),_this2.tech_.trigger({type:"mediachange",bubbles:!0})}),this.masterPlaylistLoader_.on("playlistunchanged",function(){var updatedPlaylist=_this2.masterPlaylistLoader_.media();_this2.stuckAtPlaylistEnd_(updatedPlaylist)&&(_this2.blacklistCurrentPlaylist({message:"Playlist no longer updating."}),_this2.tech_.trigger("playliststuck"))}),this.masterPlaylistLoader_.on("renditiondisabled",function(){_this2.tech_.trigger({type:"usage",name:"hls-rendition-disabled"})}),this.masterPlaylistLoader_.on("renditionenabled",function(){_this2.tech_.trigger({type:"usage",name:"hls-rendition-enabled"})})}},{key:"triggerPresenceUsage_",value:function(master,media){var mediaGroups=master.mediaGroups||{},defaultDemuxed=!0,audioGroupKeys=Object.keys(mediaGroups.AUDIO);for(var mediaGroup in mediaGroups.AUDIO)for(var label in mediaGroups.AUDIO[mediaGroup]){var properties=mediaGroups.AUDIO[mediaGroup][label];properties.uri||(defaultDemuxed=!1)}defaultDemuxed&&this.tech_.trigger({type:"usage",name:"hls-demuxed"}),Object.keys(mediaGroups.SUBTITLES).length&&this.tech_.trigger({type:"usage",name:"hls-webvtt"}),Hls.Playlist.isAes(media)&&this.tech_.trigger({type:"usage",name:"hls-aes"}),Hls.Playlist.isFmp4(media)&&this.tech_.trigger({type:"usage",name:"hls-fmp4"}),audioGroupKeys.length&&Object.keys(mediaGroups.AUDIO[audioGroupKeys[0]]).length>1&&this.tech_.trigger({type:"usage",name:"hls-alternate-audio"}),this.useCueTags_&&this.tech_.trigger({type:"usage",name:"hls-playlist-cue-tags"})}},{key:"setupSegmentLoaderListeners_",value:function(){var _this3=this;this.mainSegmentLoader_.on("bandwidthupdate",function(){var nextPlaylist=_this3.selectPlaylist(),currentPlaylist=_this3.masterPlaylistLoader_.media(),buffered=_this3.tech_.buffered(),forwardBuffer=buffered.length?buffered.end(buffered.length-1)-_this3.tech_.currentTime():0,bufferLowWaterLine=_this3.bufferLowWaterLine();(!currentPlaylist.endList||_this3.duration()<Config.MAX_BUFFER_LOW_WATER_LINE||nextPlaylist.attributes.BANDWIDTH<currentPlaylist.attributes.BANDWIDTH||forwardBuffer>=bufferLowWaterLine)&&_this3.masterPlaylistLoader_.media(nextPlaylist),_this3.tech_.trigger("bandwidthupdate")}),this.mainSegmentLoader_.on("progress",function(){_this3.trigger("progress")}),this.mainSegmentLoader_.on("error",function(){_this3.blacklistCurrentPlaylist(_this3.mainSegmentLoader_.error())}),this.mainSegmentLoader_.on("syncinfoupdate",function(){_this3.onSyncInfoUpdate_()}),this.mainSegmentLoader_.on("timestampoffset",function(){_this3.tech_.trigger({type:"usage",name:"hls-timestamp-offset"})}),this.audioSegmentLoader_.on("syncinfoupdate",function(){_this3.onSyncInfoUpdate_()}),this.mainSegmentLoader_.on("ended",function(){_this3.onEndOfStream()}),this.mainSegmentLoader_.on("earlyabort",function(){_this3.blacklistCurrentPlaylist({message:"Aborted early because there isn't enough bandwidth to complete the request without rebuffering."},120)}),this.mainSegmentLoader_.on("reseteverything",function(){_this3.tech_.trigger("hls-reset")}),this.mainSegmentLoader_.on("segmenttimemapping",function(event){_this3.tech_.trigger({type:"hls-segment-time-mapping",mapping:event.mapping})}),this.audioSegmentLoader_.on("ended",function(){_this3.onEndOfStream()})}},{key:"mediaSecondsLoaded_",value:function(){return Math.max(this.audioSegmentLoader_.mediaSecondsLoaded+this.mainSegmentLoader_.mediaSecondsLoaded)}},{key:"load",value:function(){this.mainSegmentLoader_.load(),this.mediaTypes_.AUDIO.activePlaylistLoader&&this.audioSegmentLoader_.load(),this.mediaTypes_.SUBTITLES.activePlaylistLoader&&this.subtitleSegmentLoader_.load()}},{key:"smoothQualityChange_",value:function(){var media=this.selectPlaylist();media!==this.masterPlaylistLoader_.media()&&(this.masterPlaylistLoader_.media(media),this.mainSegmentLoader_.resetLoader())}},{key:"fastQualityChange_",value:function(){var _this4=this,media=this.selectPlaylist();media!==this.masterPlaylistLoader_.media()&&(this.masterPlaylistLoader_.media(media),this.mainSegmentLoader_.resetEverything(function(){videojs.browser.IE_VERSION||videojs.browser.IS_EDGE?_this4.tech_.setCurrentTime(_this4.tech_.currentTime()+.04):_this4.tech_.setCurrentTime(_this4.tech_.currentTime())}))}},{key:"play",value:function(){if(!this.setupFirstPlay()){this.tech_.ended()&&this.seekTo_(0),this.hasPlayed_()&&this.load();var seekable$$1=this.tech_.seekable();return this.tech_.duration()===1/0&&this.tech_.currentTime()<seekable$$1.start(0)?this.seekTo_(seekable$$1.end(seekable$$1.length-1)):void 0}}},{key:"setupFirstPlay",value:function(){var _this5=this,media=this.masterPlaylistLoader_.media();if(!media||this.tech_.paused()||this.hasPlayed_())return!1;if(!media.endList){var seekable$$1=this.seekable();if(!seekable$$1.length)return!1;if(videojs.browser.IE_VERSION&&0===this.tech_.readyState())return this.tech_.one("loadedmetadata",function(){_this5.trigger("firstplay"),_this5.seekTo_(seekable$$1.end(0)),_this5.hasPlayed_=function(){return!0}}),!1;this.trigger("firstplay"),this.seekTo_(seekable$$1.end(0))}return this.hasPlayed_=function(){return!0},this.load(),!0}},{key:"handleSourceOpen_",value:function(){try{this.setupSourceBuffers_()}catch(e){return videojs.log.warn("Failed to create Source Buffers",e),this.mediaSource.endOfStream("decode")}if(this.tech_.autoplay()){var playPromise=this.tech_.play();void 0!==playPromise&&"function"==typeof playPromise.then&&playPromise.then(null,function(e){})}this.trigger("sourceopen")}},{key:"onEndOfStream",value:function(){var isEndOfStream=this.mainSegmentLoader_.ended_;if(this.mediaTypes_.AUDIO.activePlaylistLoader&&(isEndOfStream=!this.mainSegmentLoader_.startingMedia_||this.mainSegmentLoader_.startingMedia_.containsVideo?isEndOfStream&&this.audioSegmentLoader_.ended_:this.audioSegmentLoader_.ended_),isEndOfStream){this.logger_("calling mediaSource.endOfStream()");try{this.mediaSource.endOfStream()}catch(e){videojs.log.warn("Failed to call media source endOfStream",e)}}}},{key:"stuckAtPlaylistEnd_",value:function(playlist){if(!this.seekable().length)return!1;var expired=this.syncController_.getExpiredTime(playlist,this.mediaSource.duration);if(null===expired)return!1;var absolutePlaylistEnd=Hls.Playlist.playlistEnd(playlist,expired),currentTime=this.tech_.currentTime(),buffered=this.tech_.buffered();if(!buffered.length)return absolutePlaylistEnd-currentTime<=.1;var bufferedEnd=buffered.end(buffered.length-1);return bufferedEnd-currentTime<=.1&&absolutePlaylistEnd-bufferedEnd<=.1}},{key:"blacklistCurrentPlaylist",value:function(){var error=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},blacklistDuration=arguments[1],currentPlaylist=void 0,nextPlaylist=void 0;if(currentPlaylist=error.playlist||this.masterPlaylistLoader_.media(),blacklistDuration=blacklistDuration||error.blacklistDuration||this.blacklistDuration,!currentPlaylist){this.error=error;try{return this.mediaSource.endOfStream("network")}catch(e){return this.trigger("error")}}var isFinalRendition=1===this.masterPlaylistLoader_.master.playlists.filter(isEnabled).length,playlists=this.masterPlaylistLoader_.master.playlists;return 1===playlists.length?(videojs.log.warn("Problem encountered with the current HLS playlist. Trying again since it is the only playlist."),this.tech_.trigger("retryplaylist"),this.masterPlaylistLoader_.load(isFinalRendition)):(isFinalRendition&&(videojs.log.warn("Removing all playlists from the blacklist because the last rendition is about to be blacklisted."),playlists.forEach(function(playlist){
playlist.excludeUntil!==1/0&&delete playlist.excludeUntil}),this.tech_.trigger("retryplaylist")),currentPlaylist.excludeUntil=Date.now()+1e3*blacklistDuration,this.tech_.trigger("blacklistplaylist"),this.tech_.trigger({type:"usage",name:"hls-rendition-blacklisted"}),nextPlaylist=this.selectPlaylist(),videojs.log.warn("Problem encountered with the current HLS playlist."+(error.message?" "+error.message:"")+" Switching to another playlist."),this.masterPlaylistLoader_.media(nextPlaylist,isFinalRendition))}},{key:"pauseLoading",value:function(){this.mainSegmentLoader_.pause(),this.mediaTypes_.AUDIO.activePlaylistLoader&&this.audioSegmentLoader_.pause(),this.mediaTypes_.SUBTITLES.activePlaylistLoader&&this.subtitleSegmentLoader_.pause()}},{key:"setCurrentTime",value:function(currentTime){var buffered=findRange(this.tech_.buffered(),currentTime);return this.masterPlaylistLoader_&&this.masterPlaylistLoader_.media()&&this.masterPlaylistLoader_.media().segments?buffered&&buffered.length?currentTime:(this.mainSegmentLoader_.resetEverything(),this.mainSegmentLoader_.abort(),this.mediaTypes_.AUDIO.activePlaylistLoader&&(this.audioSegmentLoader_.resetEverything(),this.audioSegmentLoader_.abort()),this.mediaTypes_.SUBTITLES.activePlaylistLoader&&(this.subtitleSegmentLoader_.resetEverything(),this.subtitleSegmentLoader_.abort()),void this.load()):0}},{key:"duration",value:function(){return this.masterPlaylistLoader_?this.mediaSource?this.mediaSource.duration:Hls.Playlist.duration(this.masterPlaylistLoader_.media()):0}},{key:"seekable",value:function(){return this.seekable_}},{key:"onSyncInfoUpdate_",value:function(){var mainSeekable=void 0,audioSeekable=void 0;if(this.masterPlaylistLoader_){var media=this.masterPlaylistLoader_.media();if(media){var expired=this.syncController_.getExpiredTime(media,this.mediaSource.duration);if(null!==expired&&(mainSeekable=Hls.Playlist.seekable(media,expired),0!==mainSeekable.length)){if(this.mediaTypes_.AUDIO.activePlaylistLoader){if(media=this.mediaTypes_.AUDIO.activePlaylistLoader.media(),null===(expired=this.syncController_.getExpiredTime(media,this.mediaSource.duration)))return;if(audioSeekable=Hls.Playlist.seekable(media,expired),0===audioSeekable.length)return}var oldEnd=void 0,oldStart=void 0;this.seekable_&&this.seekable_.length&&(oldEnd=this.seekable_.end(0),oldStart=this.seekable_.start(0)),audioSeekable?audioSeekable.start(0)>mainSeekable.end(0)||mainSeekable.start(0)>audioSeekable.end(0)?this.seekable_=mainSeekable:this.seekable_=videojs.createTimeRanges([[audioSeekable.start(0)>mainSeekable.start(0)?audioSeekable.start(0):mainSeekable.start(0),audioSeekable.end(0)<mainSeekable.end(0)?audioSeekable.end(0):mainSeekable.end(0)]]):this.seekable_=mainSeekable,this.seekable_&&this.seekable_.length&&this.seekable_.end(0)===oldEnd&&this.seekable_.start(0)===oldStart||(this.logger_("seekable updated ["+printableRange(this.seekable_)+"]"),this.tech_.trigger("seekablechanged"))}}}}},{key:"updateDuration",value:function(){var _this6=this,oldDuration=this.mediaSource.duration,newDuration=Hls.Playlist.duration(this.masterPlaylistLoader_.media()),buffered=this.tech_.buffered(),setDuration=function setDuration(){_this6.logger_("Setting duration from "+_this6.mediaSource.duration+" => "+newDuration);try{_this6.mediaSource.duration=newDuration}catch(e){videojs.log.warn("Failed to set media source duration",e)}_this6.tech_.trigger("durationchange"),_this6.mediaSource.removeEventListener("sourceopen",setDuration)};buffered.length>0&&(newDuration=Math.max(newDuration,buffered.end(buffered.length-1))),oldDuration!==newDuration&&("open"!==this.mediaSource.readyState?this.mediaSource.addEventListener("sourceopen",setDuration):setDuration())}},{key:"dispose",value:function(){var _this7=this;this.decrypter_.terminate(),this.masterPlaylistLoader_.dispose(),this.mainSegmentLoader_.dispose(),["AUDIO","SUBTITLES"].forEach(function(type){var groups=_this7.mediaTypes_[type].groups;for(var id in groups)groups[id].forEach(function(group){group.playlistLoader&&group.playlistLoader.dispose()})}),this.audioSegmentLoader_.dispose(),this.subtitleSegmentLoader_.dispose()}},{key:"master",value:function(){return this.masterPlaylistLoader_.master}},{key:"media",value:function(){return this.masterPlaylistLoader_.media()||this.initialMedia_}},{key:"setupSourceBuffers_",value:function(){var media=this.masterPlaylistLoader_.media(),mimeTypes=void 0;if(media&&"open"===this.mediaSource.readyState){if(mimeTypes=mimeTypesForPlaylist(this.masterPlaylistLoader_.master,media),mimeTypes.length<1)return this.error="No compatible SourceBuffer configuration for the variant stream:"+media.resolvedUri,this.mediaSource.endOfStream("decode");this.configureLoaderMimeTypes_(mimeTypes),this.excludeIncompatibleVariants_(media)}}},{key:"configureLoaderMimeTypes_",value:function(mimeTypes){var sourceBufferEmitter=mimeTypes.length>1&&-1===mimeTypes[0].indexOf(",")&&mimeTypes[0]!==mimeTypes[1]?new videojs.EventTarget:null;this.mainSegmentLoader_.mimeType(mimeTypes[0],sourceBufferEmitter),mimeTypes[1]&&this.audioSegmentLoader_.mimeType(mimeTypes[1],sourceBufferEmitter)}},{key:"excludeUnsupportedVariants_",value:function(){this.master().playlists.forEach(function(variant){variant.attributes.CODECS&&window_1.MediaSource&&window_1.MediaSource.isTypeSupported&&!window_1.MediaSource.isTypeSupported('video/mp4; codecs="'+mapLegacyAvcCodecs(variant.attributes.CODECS)+'"')&&(variant.excludeUntil=1/0)})}},{key:"excludeIncompatibleVariants_",value:function(media){var codecCount=2,videoCodec=null,codecs=void 0;media.attributes.CODECS&&(codecs=parseCodecs(media.attributes.CODECS),videoCodec=codecs.videoCodec,codecCount=codecs.codecCount),this.master().playlists.forEach(function(variant){var variantCodecs={codecCount:2,videoCodec:null};variant.attributes.CODECS&&(variantCodecs=parseCodecs(variant.attributes.CODECS)),variantCodecs.codecCount!==codecCount&&(variant.excludeUntil=1/0),variantCodecs.videoCodec!==videoCodec&&(variant.excludeUntil=1/0)})}},{key:"updateAdCues_",value:function(media){var offset=0,seekable$$1=this.seekable();seekable$$1.length&&(offset=seekable$$1.start(0)),updateAdCues(media,this.cueTagsTrack_,offset)}},{key:"goalBufferLength",value:function(){var currentTime=this.tech_.currentTime(),initial=Config.GOAL_BUFFER_LENGTH,rate=Config.GOAL_BUFFER_LENGTH_RATE,max=Math.max(initial,Config.MAX_GOAL_BUFFER_LENGTH);return Math.min(initial+currentTime*rate,max)}},{key:"bufferLowWaterLine",value:function(){var currentTime=this.tech_.currentTime(),initial=Config.BUFFER_LOW_WATER_LINE,rate=Config.BUFFER_LOW_WATER_LINE_RATE,max=Math.max(initial,Config.MAX_BUFFER_LOW_WATER_LINE);return Math.min(initial+currentTime*rate,max)}}]),MasterPlaylistController}(videojs.EventTarget),enableFunction=function(loader,playlistUri,changePlaylistFn){return function(enable){var playlist=loader.master.playlists[playlistUri],incompatible=isIncompatible(playlist),currentlyEnabled=isEnabled(playlist);return void 0===enable?currentlyEnabled:(enable?delete playlist.disabled:playlist.disabled=!0,enable===currentlyEnabled||incompatible||(changePlaylistFn(),enable?loader.trigger("renditionenabled"):loader.trigger("renditiondisabled")),enable)}},Representation=function Representation(hlsHandler,playlist,id){classCallCheck(this,Representation);var mpc=hlsHandler.masterPlaylistController_,smoothQualityChange=hlsHandler.options_.smoothQualityChange,changeType=smoothQualityChange?"smooth":"fast",qualityChangeFunction=mpc[changeType+"QualityChange_"].bind(mpc);if(playlist.attributes.RESOLUTION){var resolution=playlist.attributes.RESOLUTION;this.width=resolution.width,this.height=resolution.height}this.bandwidth=playlist.attributes.BANDWIDTH,this.id=id,this.enabled=enableFunction(hlsHandler.playlists,playlist.uri,qualityChangeFunction)},renditionSelectionMixin=function(hlsHandler){var playlists=hlsHandler.playlists;hlsHandler.representations=function(){return playlists.master.playlists.filter(function(media){return!isIncompatible(media)}).map(function(e,i){return new Representation(hlsHandler,e,e.uri)})}},timerCancelEvents=["seeking","seeked","pause","playing","error"],PlaybackWatcher=function(){function PlaybackWatcher(options){var _this=this;classCallCheck(this,PlaybackWatcher),this.tech_=options.tech,this.seekable=options.seekable,this.seekTo=options.seekTo,this.allowSeeksWithinUnsafeLiveWindow=options.allowSeeksWithinUnsafeLiveWindow,this.media=options.media,this.consecutiveUpdates=0,this.lastRecordedTime=null,this.timer_=null,this.checkCurrentTimeTimeout_=null,this.logger_=logger("PlaybackWatcher"),this.logger_("initialize");var canPlayHandler=function(){return _this.monitorCurrentTime_()},waitingHandler=function(){return _this.techWaiting_()},cancelTimerHandler=function(){return _this.cancelTimer_()},fixesBadSeeksHandler=function(){return _this.fixesBadSeeks_()};this.tech_.on("seekablechanged",fixesBadSeeksHandler),this.tech_.on("waiting",waitingHandler),this.tech_.on(timerCancelEvents,cancelTimerHandler),this.tech_.on("canplay",canPlayHandler),this.dispose=function(){_this.logger_("dispose"),_this.tech_.off("seekablechanged",fixesBadSeeksHandler),_this.tech_.off("waiting",waitingHandler),_this.tech_.off(timerCancelEvents,cancelTimerHandler),_this.tech_.off("canplay",canPlayHandler),_this.checkCurrentTimeTimeout_&&window_1.clearTimeout(_this.checkCurrentTimeTimeout_),_this.cancelTimer_()}}return createClass(PlaybackWatcher,[{key:"monitorCurrentTime_",value:function(){this.checkCurrentTime_(),this.checkCurrentTimeTimeout_&&window_1.clearTimeout(this.checkCurrentTimeTimeout_),this.checkCurrentTimeTimeout_=window_1.setTimeout(this.monitorCurrentTime_.bind(this),250)}},{key:"checkCurrentTime_",value:function(){if(this.tech_.seeking()&&this.fixesBadSeeks_())return this.consecutiveUpdates=0,void(this.lastRecordedTime=this.tech_.currentTime());if(!this.tech_.paused()&&!this.tech_.seeking()){var currentTime=this.tech_.currentTime(),buffered=this.tech_.buffered();if(this.lastRecordedTime===currentTime&&(!buffered.length||currentTime+.1>=buffered.end(buffered.length-1)))return this.techWaiting_();this.consecutiveUpdates>=5&&currentTime===this.lastRecordedTime?(this.consecutiveUpdates++,this.waiting_()):currentTime===this.lastRecordedTime?this.consecutiveUpdates++:(this.consecutiveUpdates=0,this.lastRecordedTime=currentTime)}}},{key:"cancelTimer_",value:function(){this.consecutiveUpdates=0,this.timer_&&(this.logger_("cancelTimer_"),clearTimeout(this.timer_)),this.timer_=null}},{key:"fixesBadSeeks_",value:function(){if(!this.tech_.seeking())return!1;var seekable=this.seekable(),currentTime=this.tech_.currentTime(),isAfterSeekableRange=this.afterSeekableWindow_(seekable,currentTime,this.media(),this.allowSeeksWithinUnsafeLiveWindow),seekTo=void 0;if(isAfterSeekableRange){seekTo=seekable.end(seekable.length-1)}if(this.beforeSeekableWindow_(seekable,currentTime)){seekTo=seekable.start(0)+.1}return void 0!==seekTo&&(this.logger_("Trying to seek outside of seekable at time "+currentTime+" with seekable range "+printableRange(seekable)+". Seeking to "+seekTo+"."),this.seekTo(seekTo),!0)}},{key:"waiting_",value:function(){if(!this.techWaiting_()){var currentTime=this.tech_.currentTime(),buffered=this.tech_.buffered(),currentRange=findRange(buffered,currentTime);return currentRange.length&&currentTime+3<=currentRange.end(0)?(this.cancelTimer_(),this.seekTo(currentTime),this.logger_("Stopped at "+currentTime+" while inside a buffered region ["+currentRange.start(0)+" -> "+currentRange.end(0)+"]. Attempting to resume playback by seeking to the current time."),void this.tech_.trigger({type:"usage",name:"hls-unknown-waiting"})):void 0}}},{key:"techWaiting_",value:function(){var seekable=this.seekable(),currentTime=this.tech_.currentTime();if(this.tech_.seeking()&&this.fixesBadSeeks_())return!0;if(this.tech_.seeking()||null!==this.timer_)return!0;if(this.beforeSeekableWindow_(seekable,currentTime)){var livePoint=seekable.end(seekable.length-1);return this.logger_("Fell out of live window at time "+currentTime+". Seeking to live point (seekable end) "+livePoint),this.cancelTimer_(),this.seekTo(livePoint),this.tech_.trigger({type:"usage",name:"hls-live-resync"}),!0}var buffered=this.tech_.buffered(),nextRange=findNextRange(buffered,currentTime);if(this.videoUnderflow_(nextRange,buffered,currentTime))return this.cancelTimer_(),this.seekTo(currentTime),this.tech_.trigger({type:"usage",name:"hls-video-underflow"}),!0;if(nextRange.length>0){var difference=nextRange.start(0)-currentTime;return this.logger_("Stopped at "+currentTime+", setting timer for "+difference+", seeking to "+nextRange.start(0)),this.timer_=setTimeout(this.skipTheGap_.bind(this),1e3*difference,currentTime),!0}return!1}},{key:"afterSeekableWindow_",value:function(seekable,currentTime,playlist){var allowSeeksWithinUnsafeLiveWindow=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!seekable.length)return!1;var allowedEnd=seekable.end(seekable.length-1)+.1;return!playlist.endList&&allowSeeksWithinUnsafeLiveWindow&&(allowedEnd=seekable.end(seekable.length-1)+3*playlist.targetDuration),currentTime>allowedEnd}},{key:"beforeSeekableWindow_",value:function(seekable,currentTime){return!!(seekable.length&&seekable.start(0)>0&&currentTime<seekable.start(0)-.1)}},{key:"videoUnderflow_",value:function(nextRange,buffered,currentTime){if(0===nextRange.length){var gap=this.gapFromVideoUnderflow_(buffered,currentTime);if(gap)return this.logger_("Encountered a gap in video from "+gap.start+" to "+gap.end+". Seeking to current time "+currentTime),!0}return!1}},{key:"skipTheGap_",value:function(scheduledCurrentTime){var buffered=this.tech_.buffered(),currentTime=this.tech_.currentTime(),nextRange=findNextRange(buffered,currentTime);this.cancelTimer_(),0!==nextRange.length&&currentTime===scheduledCurrentTime&&(this.logger_("skipTheGap_:","currentTime:",currentTime,"scheduled currentTime:",scheduledCurrentTime,"nextRange start:",nextRange.start(0)),this.seekTo(nextRange.start(0)+1/30),this.tech_.trigger({type:"usage",name:"hls-gap-skip"}))}},{key:"gapFromVideoUnderflow_",value:function(buffered,currentTime){for(var gaps=findGaps(buffered),i=0;i<gaps.length;i++){var start=gaps.start(i),end=gaps.end(i);if(currentTime-start<4&&currentTime-start>2)return{start:start,end:end}}return null}}]),PlaybackWatcher}(),defaultOptions={errorInterval:30,getSource:function(next){return next(this.tech({IWillNotUseThisInPlugins:!0}).currentSource_)}},initPlugin=function initPlugin(player,options){var lastCalled=0,seekTo=0,localOptions=videojs.mergeOptions(defaultOptions,options);player.ready(function(){player.trigger({type:"usage",name:"hls-error-reload-initialized"})});var loadedMetadataHandler=function(){seekTo&&player.currentTime(seekTo)},setSource=function(sourceObj){null!==sourceObj&&void 0!==sourceObj&&(seekTo=player.duration()!==1/0&&player.currentTime()||0,player.one("loadedmetadata",loadedMetadataHandler),player.src(sourceObj),player.trigger({type:"usage",name:"hls-error-reload"}),player.play())},errorHandler=function(){return Date.now()-lastCalled<1e3*localOptions.errorInterval?void player.trigger({type:"usage",name:"hls-error-reload-canceled"}):localOptions.getSource&&"function"==typeof localOptions.getSource?(lastCalled=Date.now(),localOptions.getSource.call(player,setSource)):void videojs.log.error("ERROR: reloadSourceOnError - The option getSource must be a function!")},cleanupEvents=function cleanupEvents(){player.off("loadedmetadata",loadedMetadataHandler),player.off("error",errorHandler),player.off("dispose",cleanupEvents)},reinitPlugin=function(newOptions){cleanupEvents(),initPlugin(player,newOptions)};player.on("error",errorHandler),player.on("dispose",cleanupEvents),player.reloadSourceOnError=reinitPlugin},reloadSourceOnError=function(options){initPlugin(this,options)};videojs.use("*",function(player){return{setSource:function(srcObj,next){next(null,srcObj)},setCurrentTime:function(time){return player.vhs&&player.currentSource().src===player.vhs.source_.src&&player.vhs.setCurrentTime(time),time},play:function(){player.vhs&&player.currentSource().src===player.vhs.source_.src&&player.vhs.setCurrentTime(player.tech_.currentTime())}}});var Hls$1={PlaylistLoader:PlaylistLoader,Playlist:Playlist,Decrypter:Decrypter,AsyncStream:AsyncStream,decrypt:decrypt,utils:utils,STANDARD_PLAYLIST_SELECTOR:lastBandwidthSelector,INITIAL_PLAYLIST_SELECTOR:lowestBitrateCompatibleVariantSelector,comparePlaylistBandwidth:comparePlaylistBandwidth,comparePlaylistResolution:comparePlaylistResolution,xhr:xhrFactory()};["GOAL_BUFFER_LENGTH","MAX_GOAL_BUFFER_LENGTH","GOAL_BUFFER_LENGTH_RATE","BUFFER_LOW_WATER_LINE","MAX_BUFFER_LOW_WATER_LINE","BUFFER_LOW_WATER_LINE_RATE","BANDWIDTH_VARIANCE"].forEach(function(prop){Object.defineProperty(Hls$1,prop,{get:function(){return videojs.log.warn("using Hls."+prop+" is UNSAFE be sure you know what you are doing"),Config[prop]},set:function(value){if(videojs.log.warn("using Hls."+prop+" is UNSAFE be sure you know what you are doing"),"number"!=typeof value||value<0)return void videojs.log.warn("value of Hls."+prop+" must be greater than or equal to 0");Config[prop]=value}})});var simpleTypeFromSourceType=function(type){return/^(audio|video|application)\/(x-|vnd\.apple\.)?mpegurl/i.test(type)?"hls":/^application\/dash\+xml/i.test(type)?"dash":null},handleHlsMediaChange=function(qualityLevels,playlistLoader){for(var newPlaylist=playlistLoader.media(),selectedIndex=-1,i=0;i<qualityLevels.length;i++)if(qualityLevels[i].id===newPlaylist.uri){selectedIndex=i;break}qualityLevels.selectedIndex_=selectedIndex,qualityLevels.trigger({selectedIndex:selectedIndex,type:"change"})},handleHlsLoadedMetadata=function(qualityLevels,hls){hls.representations().forEach(function(rep){qualityLevels.addQualityLevel(rep)}),handleHlsMediaChange(qualityLevels,hls.playlists)};Hls$1.canPlaySource=function(){return videojs.log.warn("HLS is no longer a tech. Please remove it from your player's techOrder.")};var emeKeySystems=function(keySystemOptions,mainSegmentLoader,audioSegmentLoader){if(!keySystemOptions)return keySystemOptions;var videoMimeType=void 0,audioMimeType=void 0;if(audioSegmentLoader.mimeType_)videoMimeType=mainSegmentLoader.mimeType_,audioMimeType=audioSegmentLoader.mimeType_;else{var parsedMimeType=parseContentType(mainSegmentLoader.mimeType_),codecs=parsedMimeType.parameters.codecs.split(","),audioCodec=void 0,videoCodec=void 0;codecs.forEach(function(codec){codec=codec.trim(),isAudioCodec(codec)?audioCodec=codec:isVideoCodec(codec)&&(videoCodec=codec)}),videoMimeType=parsedMimeType.type+'; codecs="'+videoCodec+'"',audioMimeType=parsedMimeType.type.replace("video","audio")+'; codecs="'+audioCodec+'"'}var keySystemContentTypes={},videoPlaylist=mainSegmentLoader.playlist_;for(var keySystem in keySystemOptions)keySystemContentTypes[keySystem]={audioContentType:audioMimeType,videoContentType:videoMimeType},videoPlaylist.contentProtection&&videoPlaylist.contentProtection[keySystem]&&videoPlaylist.contentProtection[keySystem].pssh&&(keySystemContentTypes[keySystem].pssh=videoPlaylist.contentProtection[keySystem].pssh),"string"==typeof keySystemOptions[keySystem]&&(keySystemContentTypes[keySystem].url=keySystemOptions[keySystem]);return videojs.mergeOptions(keySystemOptions,keySystemContentTypes)},setupEmeOptions=function(hlsHandler){var mainSegmentLoader=hlsHandler.masterPlaylistController_.mainSegmentLoader_,audioSegmentLoader=hlsHandler.masterPlaylistController_.audioSegmentLoader_,player=videojs.players[hlsHandler.tech_.options_.playerId];if(player.eme){var sourceOptions=emeKeySystems(hlsHandler.source_.keySystems,mainSegmentLoader,audioSegmentLoader);sourceOptions&&(player.currentSource().keySystems=sourceOptions,11!==videojs.browser.IE_VERSION&&player.eme.initializeMediaKeys&&player.eme.initializeMediaKeys())}},getVhsLocalStorage=function(){if(!window.localStorage)return null;var storedObject=window.localStorage.getItem("videojs-vhs");if(!storedObject)return null;try{return JSON.parse(storedObject)}catch(e){return null}},updateVhsLocalStorage=function(options){if(!window.localStorage)return!1;var objectToStore=getVhsLocalStorage();objectToStore=objectToStore?videojs.mergeOptions(objectToStore,options):options;try{window.localStorage.setItem("videojs-vhs",JSON.stringify(objectToStore))}catch(e){return!1}return objectToStore};Hls$1.supportsNativeHls=function(){var video=document_1.createElement("video");return!!videojs.getTech("Html5").isSupported()&&["application/vnd.apple.mpegurl","audio/mpegurl","audio/x-mpegurl","application/x-mpegurl","video/x-mpegurl","video/mpegurl","application/mpegurl"].some(function(canItPlay){return/maybe|probably/i.test(video.canPlayType(canItPlay))})}(),Hls$1.supportsNativeDash=function(){return!!videojs.getTech("Html5").isSupported()&&/maybe|probably/i.test(document_1.createElement("video").canPlayType("application/dash+xml"))}(),Hls$1.supportsTypeNatively=function(type){return"hls"===type?Hls$1.supportsNativeHls:"dash"===type&&Hls$1.supportsNativeDash},Hls$1.isSupported=function(){return videojs.log.warn("HLS is no longer a tech. Please remove it from your player's techOrder.")};var Component=videojs.getComponent("Component"),HlsHandler=function(_Component){inherits(HlsHandler,_Component);function HlsHandler(source,tech,options){classCallCheck(this,HlsHandler);var _this=possibleConstructorReturn(this,(HlsHandler.__proto__||Object.getPrototypeOf(HlsHandler)).call(this,tech,options.hls));if(tech.options_&&tech.options_.playerId){var _player=videojs(tech.options_.playerId);_player.hasOwnProperty("hls")||Object.defineProperty(_player,"hls",{get:function(){return videojs.log.warn("player.hls is deprecated. Use player.tech().hls instead."),tech.trigger({type:"usage",name:"hls-player-access"}),_this},configurable:!0}),_player.vhs=_this,_player.dash=_this,_this.player_=_player}if(_this.tech_=tech,_this.source_=source,_this.stats={},_this.setOptions_(),_this.options_.overrideNative&&tech.overrideNativeAudioTracks&&tech.overrideNativeVideoTracks)tech.overrideNativeAudioTracks(!0),tech.overrideNativeVideoTracks(!0);else if(_this.options_.overrideNative&&(tech.featuresNativeVideoTracks||tech.featuresNativeAudioTracks))throw new Error("Overriding native HLS requires emulated tracks. See https://git.io/vMpjB");return _this.on(document_1,["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","MSFullscreenChange"],function(event){var fullscreenElement=document_1.fullscreenElement||document_1.webkitFullscreenElement||document_1.mozFullScreenElement||document_1.msFullscreenElement;fullscreenElement&&fullscreenElement.contains(_this.tech_.el())&&_this.masterPlaylistController_.smoothQualityChange_()}),_this.on(_this.tech_,"seeking",function(){0===this.tech_.currentTime()&&this.tech_.player_.loop()&&this.setCurrentTime(0)}),_this.on(_this.tech_,"error",function(){this.masterPlaylistController_&&this.masterPlaylistController_.pauseLoading()}),_this.on(_this.tech_,"play",_this.play),_this}return createClass(HlsHandler,[{key:"setOptions_",value:function(){var _this2=this;if(this.options_.withCredentials=this.options_.withCredentials||!1,this.options_.handleManifestRedirects=this.options_.handleManifestRedirects||!1,this.options_.limitRenditionByPlayerDimensions=!1!==this.options_.limitRenditionByPlayerDimensions,this.options_.smoothQualityChange=this.options_.smoothQualityChange||!1,this.options_.useBandwidthFromLocalStorage=void 0!==this.source_.useBandwidthFromLocalStorage?this.source_.useBandwidthFromLocalStorage:this.options_.useBandwidthFromLocalStorage||!1,this.options_.customTagParsers=this.options_.customTagParsers||[],this.options_.customTagMappers=this.options_.customTagMappers||[],this.options_.cacheEncryptionKeys=this.options_.cacheEncryptionKeys||!1,"number"!=typeof this.options_.blacklistDuration&&(this.options_.blacklistDuration=300),"number"!=typeof this.options_.bandwidth&&this.options_.useBandwidthFromLocalStorage){var storedObject=getVhsLocalStorage();storedObject&&storedObject.bandwidth&&(this.options_.bandwidth=storedObject.bandwidth,this.tech_.trigger({type:"usage",name:"hls-bandwidth-from-local-storage"})),storedObject&&storedObject.throughput&&(this.options_.throughput=storedObject.throughput,this.tech_.trigger({type:"usage",name:"hls-throughput-from-local-storage"}))}"number"!=typeof this.options_.bandwidth&&(this.options_.bandwidth=Config.INITIAL_BANDWIDTH),this.options_.enableLowInitialPlaylist=this.options_.enableLowInitialPlaylist&&this.options_.bandwidth===Config.INITIAL_BANDWIDTH,["withCredentials","limitRenditionByPlayerDimensions","bandwidth","smoothQualityChange","customTagParsers","customTagMappers","handleManifestRedirects","cacheEncryptionKeys"].forEach(function(option){void 0!==_this2.source_[option]&&(_this2.options_[option]=_this2.source_[option])}),this.limitRenditionByPlayerDimensions=this.options_.limitRenditionByPlayerDimensions}},{key:"src",value:function(_src,type){var _this3=this;_src&&(this.setOptions_(),this.options_.url=this.source_.src,this.options_.tech=this.tech_,this.options_.externHls=Hls$1,this.options_.sourceType=simpleTypeFromSourceType(type),this.options_.seekTo=function(time){_this3.tech_.setCurrentTime(time),_this3.setCurrentTime(time)},this.masterPlaylistController_=new MasterPlaylistController(this.options_),this.playbackWatcher_=new PlaybackWatcher(videojs.mergeOptions(this.options_,{seekable:function(){return _this3.seekable()},media:function(){return _this3.masterPlaylistController_.media()}})),this.masterPlaylistController_.on("error",function(){videojs.players[_this3.tech_.options_.playerId].error(_this3.masterPlaylistController_.error)}),this.masterPlaylistController_.selectPlaylist=this.selectPlaylist?this.selectPlaylist.bind(this):Hls$1.STANDARD_PLAYLIST_SELECTOR.bind(this),this.masterPlaylistController_.selectInitialPlaylist=Hls$1.INITIAL_PLAYLIST_SELECTOR.bind(this),this.playlists=this.masterPlaylistController_.masterPlaylistLoader_,this.mediaSource=this.masterPlaylistController_.mediaSource,Object.defineProperties(this,{selectPlaylist:{get:function(){return this.masterPlaylistController_.selectPlaylist},set:function(selectPlaylist){this.masterPlaylistController_.selectPlaylist=selectPlaylist.bind(this)}},throughput:{get:function(){return this.masterPlaylistController_.mainSegmentLoader_.throughput.rate},set:function(throughput){this.masterPlaylistController_.mainSegmentLoader_.throughput.rate=throughput,this.masterPlaylistController_.mainSegmentLoader_.throughput.count=1}},bandwidth:{get:function(){return this.masterPlaylistController_.mainSegmentLoader_.bandwidth},set:function(bandwidth){this.masterPlaylistController_.mainSegmentLoader_.bandwidth=bandwidth,this.masterPlaylistController_.mainSegmentLoader_.throughput={rate:0,count:0}}},systemBandwidth:{get:function(){var invBandwidth=1/(this.bandwidth||1),invThroughput=void 0;return invThroughput=this.throughput>0?1/this.throughput:0,Math.floor(1/(invBandwidth+invThroughput))},set:function(){videojs.log.error('The "systemBandwidth" property is read-only')}}}),this.options_.bandwidth&&(this.bandwidth=this.options_.bandwidth),this.options_.throughput&&(this.throughput=this.options_.throughput),Object.defineProperties(this.stats,{bandwidth:{get:function(){return _this3.bandwidth||0},enumerable:!0},mediaRequests:{get:function(){return _this3.masterPlaylistController_.mediaRequests_()||0},enumerable:!0},mediaRequestsAborted:{get:function(){return _this3.masterPlaylistController_.mediaRequestsAborted_()||0},enumerable:!0},mediaRequestsTimedout:{get:function(){return _this3.masterPlaylistController_.mediaRequestsTimedout_()||0},enumerable:!0},mediaRequestsErrored:{get:function(){return _this3.masterPlaylistController_.mediaRequestsErrored_()||0},enumerable:!0},mediaTransferDuration:{get:function(){return _this3.masterPlaylistController_.mediaTransferDuration_()||0},enumerable:!0},mediaBytesTransferred:{get:function(){return _this3.masterPlaylistController_.mediaBytesTransferred_()||0},enumerable:!0},mediaSecondsLoaded:{get:function(){return _this3.masterPlaylistController_.mediaSecondsLoaded_()||0},enumerable:!0},buffered:{get:function(){return timeRangesToArray(_this3.tech_.buffered())},enumerable:!0},currentTime:{get:function(){return _this3.tech_.currentTime()},enumerable:!0},currentSource:{get:function(){return _this3.tech_.currentSource_},enumerable:!0},currentTech:{get:function(){return _this3.tech_.name_},enumerable:!0},duration:{get:function(){return _this3.tech_.duration()},enumerable:!0},master:{get:function(){return _this3.playlists.master},enumerable:!0},playerDimensions:{get:function(){return _this3.tech_.currentDimensions()},enumerable:!0},seekable:{get:function(){return timeRangesToArray(_this3.tech_.seekable())},enumerable:!0},timestamp:{get:function(){return Date.now()},enumerable:!0},videoPlaybackQuality:{get:function(){return _this3.tech_.getVideoPlaybackQuality()},enumerable:!0}}),this.tech_.one("canplay",this.masterPlaylistController_.setupFirstPlay.bind(this.masterPlaylistController_)),this.tech_.on("bandwidthupdate",function(){_this3.options_.useBandwidthFromLocalStorage&&updateVhsLocalStorage({bandwidth:_this3.bandwidth,throughput:Math.round(_this3.throughput)})}),this.masterPlaylistController_.on("selectedinitialmedia",function(){renditionSelectionMixin(_this3),setupEmeOptions(_this3)}),this.on(this.masterPlaylistController_,"progress",function(){this.tech_.trigger("progress")}),this.tech_.ready(function(){return _this3.setupQualityLevels_()}),this.tech_.el()&&this.tech_.src(videojs.URL.createObjectURL(this.masterPlaylistController_.mediaSource)))}},{key:"setupQualityLevels_",value:function(){var _this4=this,player=videojs.players[this.tech_.options_.playerId];player&&player.qualityLevels&&(this.qualityLevels_=player.qualityLevels(),this.masterPlaylistController_.on("selectedinitialmedia",function(){handleHlsLoadedMetadata(_this4.qualityLevels_,_this4)}),this.playlists.on("mediachange",function(){handleHlsMediaChange(_this4.qualityLevels_,_this4.playlists)}))}},{key:"play",value:function(){this.masterPlaylistController_.play()}},{key:"setCurrentTime",value:function(currentTime){this.masterPlaylistController_.setCurrentTime(currentTime)}},{key:"duration",value:function(){return this.masterPlaylistController_.duration()}},{key:"seekable",value:function(){return this.masterPlaylistController_.seekable()}},{key:"dispose",value:function(){this.playbackWatcher_&&this.playbackWatcher_.dispose(),this.masterPlaylistController_&&this.masterPlaylistController_.dispose(),this.qualityLevels_&&this.qualityLevels_.dispose(),this.player_&&(delete this.player_.vhs,delete this.player_.dash,delete this.player_.hls),this.tech_&&this.tech_.hls&&delete this.tech_.hls,get(HlsHandler.prototype.__proto__||Object.getPrototypeOf(HlsHandler.prototype),"dispose",this).call(this)}},{key:"convertToProgramTime",value:function(time,callback){return getProgramTime({playlist:this.masterPlaylistController_.media(),time:time,callback:callback})}},{key:"seekToProgramTime",value:function(programTime,callback){var pauseAfterSeek=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],retryCount=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;return seekToProgramTime({programTime:programTime,playlist:this.masterPlaylistController_.media(),retryCount:retryCount,pauseAfterSeek:pauseAfterSeek,seekTo:this.options_.seekTo,tech:this.options_.tech,callback:callback})}}]),HlsHandler}(Component),HlsSourceHandler={name:"videojs-http-streaming",VERSION:"1.11.2",canHandleSource:function(srcObj){var options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},localOptions=videojs.mergeOptions(videojs.options,options);return HlsSourceHandler.canPlayType(srcObj.type,localOptions)},handleSource:function(source,tech){var options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},localOptions=videojs.mergeOptions(videojs.options,options);return tech.hls=new HlsHandler(source,tech,localOptions),
tech.hls.xhr=xhrFactory(),tech.hls.src(source.src,source.type),tech.hls},canPlayType:function(type){var options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},_videojs$mergeOptions=videojs.mergeOptions(videojs.options,options),overrideNative=_videojs$mergeOptions.hls.overrideNative,supportedType=simpleTypeFromSourceType(type);return!supportedType||Hls$1.supportsTypeNatively(supportedType)&&!overrideNative?"":"maybe"}};void 0!==videojs.MediaSource&&void 0!==videojs.URL||(videojs.MediaSource=MediaSource,videojs.URL=URL$1),MediaSource.supportsNativeMediaSources()&&videojs.getTech("Html5").registerSourceHandler(HlsSourceHandler,0),videojs.HlsHandler=HlsHandler,videojs.HlsSourceHandler=HlsSourceHandler,videojs.Hls=Hls$1,videojs.use||videojs.registerComponent("Hls",Hls$1),videojs.options.hls=videojs.options.hls||{},videojs.registerPlugin?videojs.registerPlugin("reloadSourceOnError",reloadSourceOnError):videojs.plugin("reloadSourceOnError",reloadSourceOnError),exports.LOCAL_STORAGE_KEY="videojs-vhs",exports.Hls=Hls$1,exports.HlsHandler=HlsHandler,exports.HlsSourceHandler=HlsSourceHandler,exports.emeKeySystems=emeKeySystems,exports.simpleTypeFromSourceType=simpleTypeFromSourceType,Object.defineProperty(exports,"__esModule",{value:!0})}),function(global,factory){if("function"==typeof define&&define.amd)define(["module","exports"],factory);else if("undefined"!=typeof exports)factory(module,exports);else{var mod={exports:{}};factory(mod,mod.exports),global.autosize=mod.exports}}(this,function(module,exports){"use strict";var map="function"==typeof Map?new Map:function(){var keys=[],values=[];return{has:function(key){return keys.indexOf(key)>-1},get:function(key){return values[keys.indexOf(key)]},set:function(key,value){-1===keys.indexOf(key)&&(keys.push(key),values.push(value))},delete:function(key){var index=keys.indexOf(key);index>-1&&(keys.splice(index,1),values.splice(index,1))}}}(),createEvent=function(name){return new Event(name,{bubbles:!0})};try{new Event("test")}catch(e){createEvent=function(name){var evt=document.createEvent("Event");return evt.initEvent(name,!0,!1),evt}}function assign(ta){function changeOverflow(value){var width=ta.style.width;ta.style.width="0px",ta.offsetWidth,ta.style.width=width,ta.style.overflowY=value}function getParentOverflows(el){for(var arr=[];el&&el.parentNode&&el.parentNode instanceof Element;)el.parentNode.scrollTop&&arr.push({node:el.parentNode,scrollTop:el.parentNode.scrollTop}),el=el.parentNode;return arr}function resize(){if(0!==ta.scrollHeight){var overflows=getParentOverflows(ta),docTop=document.documentElement&&document.documentElement.scrollTop;ta.style.height="",ta.style.height=ta.scrollHeight+heightOffset+"px",clientWidth=ta.clientWidth,overflows.forEach(function(el){el.node.scrollTop=el.scrollTop}),docTop&&(document.documentElement.scrollTop=docTop)}}function update(){resize();var styleHeight=Math.round(parseFloat(ta.style.height)),computed=window.getComputedStyle(ta,null),actualHeight="content-box"===computed.boxSizing?Math.round(parseFloat(computed.height)):ta.offsetHeight;if(actualHeight<styleHeight?"hidden"===computed.overflowY&&(changeOverflow("scroll"),resize(),actualHeight="content-box"===computed.boxSizing?Math.round(parseFloat(window.getComputedStyle(ta,null).height)):ta.offsetHeight):"hidden"!==computed.overflowY&&(changeOverflow("hidden"),resize(),actualHeight="content-box"===computed.boxSizing?Math.round(parseFloat(window.getComputedStyle(ta,null).height)):ta.offsetHeight),cachedHeight!==actualHeight){cachedHeight=actualHeight;var evt=createEvent("autosize:resized");try{ta.dispatchEvent(evt)}catch(err){}}}if(ta&&ta.nodeName&&"TEXTAREA"===ta.nodeName&&!map.has(ta)){var heightOffset=null,clientWidth=null,cachedHeight=null,pageResize=function(){ta.clientWidth!==clientWidth&&update()},destroy=function(style){window.removeEventListener("resize",pageResize,!1),ta.removeEventListener("input",update,!1),ta.removeEventListener("keyup",update,!1),ta.removeEventListener("autosize:destroy",destroy,!1),ta.removeEventListener("autosize:update",update,!1),Object.keys(style).forEach(function(key){ta.style[key]=style[key]}),map.delete(ta)}.bind(ta,{height:ta.style.height,resize:ta.style.resize,overflowY:ta.style.overflowY,overflowX:ta.style.overflowX,wordWrap:ta.style.wordWrap});ta.addEventListener("autosize:destroy",destroy,!1),"onpropertychange"in ta&&"oninput"in ta&&ta.addEventListener("keyup",update,!1),window.addEventListener("resize",pageResize,!1),ta.addEventListener("input",update,!1),ta.addEventListener("autosize:update",update,!1),ta.style.overflowX="hidden",ta.style.wordWrap="break-word",map.set(ta,{destroy:destroy,update:update}),function(){var style=window.getComputedStyle(ta,null);"vertical"===style.resize?ta.style.resize="none":"both"===style.resize&&(ta.style.resize="horizontal"),heightOffset="content-box"===style.boxSizing?-(parseFloat(style.paddingTop)+parseFloat(style.paddingBottom)):parseFloat(style.borderTopWidth)+parseFloat(style.borderBottomWidth),isNaN(heightOffset)&&(heightOffset=0),update()}()}}function destroy(ta){var methods=map.get(ta);methods&&methods.destroy()}function update(ta){var methods=map.get(ta);methods&&methods.update()}var autosize=null;"undefined"==typeof window||"function"!=typeof window.getComputedStyle?(autosize=function(el){return el},autosize.destroy=function(el){return el},autosize.update=function(el){return el}):(autosize=function(el,options){return el&&Array.prototype.forEach.call(el.length?el:[el],function(x){return assign(x)}),el},autosize.destroy=function(el){return el&&Array.prototype.forEach.call(el.length?el:[el],destroy),el},autosize.update=function(el){return el&&Array.prototype.forEach.call(el.length?el:[el],update),el}),exports.default=autosize,module.exports=exports.default});function PointerEventsPolyfill(options){if(this.options={selector:"*",cancel:"",mouseEvents:["click","dblclick","mousedown","mouseup"],usePolyfillIf:function(){if("Microsoft Internet Explorer"==navigator.appName){if(null!=navigator.userAgent.match(/MSIE ([0-9]{1,}[\.0-9]{0,})/)){if(parseFloat(RegExp.$1)<11)return!0}}return!1}},options){var obj=this;$.each(options,function(k,v){obj.options[k]=v})}this.options.usePolyfillIf()&&this.register_mouse_events()}PointerEventsPolyfill.initialize=function(options){return null==PointerEventsPolyfill.singleton&&(PointerEventsPolyfill.singleton=new PointerEventsPolyfill(options)),PointerEventsPolyfill.singleton},PointerEventsPolyfill.prototype.register_mouse_events=function(){$(document).on(this.options.mouseEvents.join(" "),this.options.selector,{cancel:this.options.cancel},function(e){if(e.originalEvent&&$(e.originalEvent.srcElement).closest(e.data.cancel).length>0)return!0;if("none"==$(this).css("pointer-events")){var origDisplayAttribute=$(this).css("display");$(this).css("display","none");var underneathElem=document.elementFromPoint(e.clientX,e.clientY);return origDisplayAttribute?$(this).css("display",origDisplayAttribute):$(this).css("display",""),e.target=underneathElem,$(underneathElem).trigger(e),!1}return!0})},function(){if(void 0===window.performance&&(window.performance={}),!window.performance.now){var nowOffset=Date.now();performance.timing&&performance.timing.navigationStart&&(nowOffset=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-nowOffset}}}(),function(){Math.sign=Math.sign||function(x){return x=+x,0===x||isNaN(x)?x:x>0?1:-1}}(),function($){"use strict";var Modal=function(element,options){this.options=options,this.$element=$(element).delegate('[data-dismiss="modal"]',"click.dismiss.modal",$.proxy(this.hide,this)),this.options.remote&&this.$element.find(".modal-body").load(this.options.remote)};Modal.prototype={constructor:Modal,toggle:function(){return this[this.isShown?"hide":"show"]()},show:function(){var that=this,e=$.Event("show");this.$element.trigger(e),this.isShown||e.isDefaultPrevented()||(this.isShown=!0,this.escape(),this.backdrop(function(){var transition=$.support.transition&&that.$element.hasClass("fade");that.$element.parent().length||that.$element.appendTo(document.body),that.$element.show(),transition&&that.$element[0].offsetWidth,that.$element.addClass("in").attr("aria-hidden",!1),that.enforceFocus(),transition?that.$element.one($.support.transition.end,function(){that.$element.focus().trigger("shown")}):that.$element.focus().trigger("shown")}))},hide:function(e){e&&e.preventDefault();e=$.Event("hide"),this.$element.trigger(e),this.isShown&&!e.isDefaultPrevented()&&(this.isShown=!1,this.escape(),$(document).off("focusin.modal"),this.$element.removeClass("in").attr("aria-hidden",!0),$.support.transition&&this.$element.hasClass("fade")?this.hideWithTransition():this.hideModal())},enforceFocus:function(){var that=this;$(document).on("focusin.modal",function(e){that.$element[0]===e.target||that.$element.has(e.target).length||that.$element.focus()})},escape:function(){var that=this;this.isShown&&this.options.keyboard?this.$element.on("keyup.dismiss.modal",function(e){27==e.which&&that.hide()}):this.isShown||this.$element.off("keyup.dismiss.modal")},hideWithTransition:function(){var that=this,timeout=setTimeout(function(){that.$element.off($.support.transition.end),that.hideModal()},500);this.$element.one($.support.transition.end,function(){clearTimeout(timeout),that.hideModal()})},hideModal:function(){var that=this;this.$element.hide(),this.backdrop(function(){that.removeBackdrop(),that.$element.trigger("hidden")})},removeBackdrop:function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},backdrop:function(callback){var animate=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var doAnimate=$.support.transition&&animate;if(this.$backdrop=$('<div class="modal-backdrop '+animate+'" />').appendTo(document.body),this.$backdrop.click("static"==this.options.backdrop?$.proxy(this.$element[0].focus,this.$element[0]):$.proxy(this.hide,this)),doAnimate&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!callback)return;doAnimate?this.$backdrop.one($.support.transition.end,callback):callback()}else!this.isShown&&this.$backdrop?(this.$backdrop.removeClass("in"),$.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one($.support.transition.end,callback):callback()):callback&&callback()}};var old=$.fn.modal;$.fn.modal=function(option){return this.each(function(){var $this=$(this),data=$this.data("modal"),options=$.extend({},$.fn.modal.defaults,$this.data(),"object"==typeof option&&option);data||$this.data("modal",data=new Modal(this,options)),"string"==typeof option?data[option]():options.show&&data.show()})},$.fn.modal.defaults={backdrop:!0,keyboard:!0,show:!0},$.fn.modal.Constructor=Modal,$.fn.modal.noConflict=function(){return $.fn.modal=old,this},$(document).on("click.modal.data-api",'[data-toggle="modal"]',function(e){var $this=$(this),href=$this.attr("href"),$target=$($this.attr("data-target")||href&&href.replace(/.*(?=#[^\s]+$)/,"")),option=$target.data("modal")?"toggle":$.extend({remote:!/#/.test(href)&&href},$target.data(),$this.data());e.preventDefault(),$target.modal(option).one("hide",function(){$this.focus()})})}(window.jQuery),function(a,b,c,d){"use strict";function e(a,b,c){return setTimeout(j(a,c),b)}function f(a,b,c){return!!Array.isArray(a)&&(g(a,c[b],c),!0)}function g(a,b,c){var e;if(a)if(a.forEach)a.forEach(b,c);else if(a.length!==d)for(e=0;e<a.length;)b.call(c,a[e],e,a),e++;else for(e in a)a.hasOwnProperty(e)&&b.call(c,a[e],e,a)}function h(b,c,d){var e="DEPRECATED METHOD: "+c+"\n"+d+" AT \n";return function(){var c=new Error("get-stack-trace"),d=c&&c.stack?c.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",f=a.console&&(a.console.warn||a.console.log);return f&&f.call(a.console,e,d),b.apply(this,arguments)}}function i(a,b,c){var d,e=b.prototype;d=a.prototype=Object.create(e),d.constructor=a,d._super=e,c&&la(d,c)}function j(a,b){return function(){return a.apply(b,arguments)}}function k(a,b){return typeof a==oa?a.apply(b?b[0]||d:d,b):a}function l(a,b){return a===d?b:a}function m(a,b,c){g(q(b),function(b){a.addEventListener(b,c,!1)})}function n(a,b,c){g(q(b),function(b){a.removeEventListener(b,c,!1)})}function o(a,b){for(;a;){if(a==b)return!0;a=a.parentNode}return!1}function p(a,b){return a.indexOf(b)>-1}function q(a){return a.trim().split(/\s+/g)}function r(a,b,c){if(a.indexOf&&!c)return a.indexOf(b);for(var d=0;d<a.length;){if(c&&a[d][c]==b||!c&&a[d]===b)return d;d++}return-1}function s(a){return Array.prototype.slice.call(a,0)}function t(a,b,c){for(var d=[],e=[],f=0;f<a.length;){var g=b?a[f][b]:a[f];r(e,g)<0&&d.push(a[f]),e[f]=g,f++}return c&&(d=b?d.sort(function(a,c){return a[b]>c[b]}):d.sort()),d}function u(a,b){for(var c,e,f=b[0].toUpperCase()+b.slice(1),g=0;g<ma.length;){if(c=ma[g],(e=c?c+f:b)in a)return e;g++}return d}function v(){return ua++}function w(b){var c=b.ownerDocument||b;return c.defaultView||c.parentWindow||a}function x(a,b){var c=this;this.manager=a,this.callback=b,this.element=a.element,this.target=a.options.inputTarget,this.domHandler=function(b){k(a.options.enable,[a])&&c.handler(b)},this.init()}function y(a){var c=a.options.inputClass;return new(c||(xa?M:ya?P:wa?R:L))(a,z)}function z(a,b,c){var d=c.pointers.length,e=c.changedPointers.length,f=b&Ea&&d-e==0,g=b&(Ga|Ha)&&d-e==0;c.isFirst=!!f,c.isFinal=!!g,f&&(a.session={}),c.eventType=b,A(a,c),a.emit("hammer.input",c),a.recognize(c),a.session.prevInput=c}function A(a,b){var c=a.session,d=b.pointers,e=d.length;c.firstInput||(c.firstInput=D(b)),e>1&&!c.firstMultiple?c.firstMultiple=D(b):1===e&&(c.firstMultiple=!1);var f=c.firstInput,g=c.firstMultiple,h=g?g.center:f.center,i=b.center=E(d);b.timeStamp=ra(),b.deltaTime=b.timeStamp-f.timeStamp,b.angle=I(h,i),b.distance=H(h,i),B(c,b),b.offsetDirection=G(b.deltaX,b.deltaY);var j=F(b.deltaTime,b.deltaX,b.deltaY);b.overallVelocityX=j.x,b.overallVelocityY=j.y,b.overallVelocity=qa(j.x)>qa(j.y)?j.x:j.y,b.scale=g?K(g.pointers,d):1,b.rotation=g?J(g.pointers,d):0,b.maxPointers=c.prevInput?b.pointers.length>c.prevInput.maxPointers?b.pointers.length:c.prevInput.maxPointers:b.pointers.length,C(c,b);var k=a.element;o(b.srcEvent.target,k)&&(k=b.srcEvent.target),b.target=k}function B(a,b){var c=b.center,d=a.offsetDelta||{},e=a.prevDelta||{},f=a.prevInput||{};b.eventType!==Ea&&f.eventType!==Ga||(e=a.prevDelta={x:f.deltaX||0,y:f.deltaY||0},d=a.offsetDelta={x:c.x,y:c.y}),b.deltaX=e.x+(c.x-d.x),b.deltaY=e.y+(c.y-d.y)}function C(a,b){var c,e,f,g,h=a.lastInterval||b,i=b.timeStamp-h.timeStamp;if(b.eventType!=Ha&&(i>Da||h.velocity===d)){var j=b.deltaX-h.deltaX,k=b.deltaY-h.deltaY,l=F(i,j,k);e=l.x,f=l.y,c=qa(l.x)>qa(l.y)?l.x:l.y,g=G(j,k),a.lastInterval=b}else c=h.velocity,e=h.velocityX,f=h.velocityY,g=h.direction;b.velocity=c,b.velocityX=e,b.velocityY=f,b.direction=g}function D(a){for(var b=[],c=0;c<a.pointers.length;)b[c]={clientX:pa(a.pointers[c].clientX),clientY:pa(a.pointers[c].clientY)},c++;return{timeStamp:ra(),pointers:b,center:E(b),deltaX:a.deltaX,deltaY:a.deltaY}}function E(a){var b=a.length;if(1===b)return{x:pa(a[0].clientX),y:pa(a[0].clientY)};for(var c=0,d=0,e=0;b>e;)c+=a[e].clientX,d+=a[e].clientY,e++;return{x:pa(c/b),y:pa(d/b)}}function F(a,b,c){return{x:b/a||0,y:c/a||0}}function G(a,b){return a===b?Ia:qa(a)>=qa(b)?0>a?Ja:Ka:0>b?La:Ma}function H(a,b,c){c||(c=Qa);var d=b[c[0]]-a[c[0]],e=b[c[1]]-a[c[1]];return Math.sqrt(d*d+e*e)}function I(a,b,c){c||(c=Qa);var d=b[c[0]]-a[c[0]],e=b[c[1]]-a[c[1]];return 180*Math.atan2(e,d)/Math.PI}function J(a,b){return I(b[1],b[0],Ra)+I(a[1],a[0],Ra)}function K(a,b){return H(b[0],b[1],Ra)/H(a[0],a[1],Ra)}function L(){this.evEl=Ta,this.evWin=Ua,this.pressed=!1,x.apply(this,arguments)}function M(){this.evEl=Xa,this.evWin=Ya,x.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}function N(){this.evTarget=$a,this.evWin=_a,this.started=!1,x.apply(this,arguments)}function O(a,b){var c=s(a.touches),d=s(a.changedTouches);return b&(Ga|Ha)&&(c=t(c.concat(d),"identifier",!0)),[c,d]}function P(){this.evTarget=bb,this.targetIds={},x.apply(this,arguments)}function Q(a,b){var c=s(a.touches),d=this.targetIds;if(b&(Ea|Fa)&&1===c.length)return d[c[0].identifier]=!0,[c,c];var e,f,g=s(a.changedTouches),h=[],i=this.target;if(f=c.filter(function(a){return o(a.target,i)}),b===Ea)for(e=0;e<f.length;)d[f[e].identifier]=!0,e++;for(e=0;e<g.length;)d[g[e].identifier]&&h.push(g[e]),b&(Ga|Ha)&&delete d[g[e].identifier],e++;return h.length?[t(f.concat(h),"identifier",!0),h]:void 0}function R(){x.apply(this,arguments);var a=j(this.handler,this);this.touch=new P(this.manager,a),this.mouse=new L(this.manager,a),this.primaryTouch=null,this.lastTouches=[]}function S(a,b){a&Ea?(this.primaryTouch=b.changedPointers[0].identifier,T.call(this,b)):a&(Ga|Ha)&&T.call(this,b)}function T(a){var b=a.changedPointers[0];if(b.identifier===this.primaryTouch){var c={x:b.clientX,y:b.clientY};this.lastTouches.push(c);var d=this.lastTouches,e=function(){var a=d.indexOf(c);a>-1&&d.splice(a,1)};setTimeout(e,cb)}}function U(a){for(var b=a.srcEvent.clientX,c=a.srcEvent.clientY,d=0;d<this.lastTouches.length;d++){var e=this.lastTouches[d],f=Math.abs(b-e.x),g=Math.abs(c-e.y);if(db>=f&&db>=g)return!0}return!1}function V(a,b){this.manager=a,this.set(b)}function W(a){if(p(a,jb))return jb;var b=p(a,kb),c=p(a,lb);return b&&c?jb:b||c?b?kb:lb:p(a,ib)?ib:hb}function Y(a){this.options=la({},this.defaults,a||{}),this.id=v(),this.manager=null,this.options.enable=l(this.options.enable,!0),this.state=nb,this.simultaneous={},this.requireFail=[]}function Z(a){return a&sb?"cancel":a&qb?"end":a&pb?"move":a&ob?"start":""}function $(a){return a==Ma?"down":a==La?"up":a==Ja?"left":a==Ka?"right":""}function _(a,b){var c=b.manager;return c?c.get(a):a}function aa(){Y.apply(this,arguments)}function ba(){aa.apply(this,arguments),this.pX=null,this.pY=null}function ca(){aa.apply(this,arguments)}function da(){Y.apply(this,arguments),this._timer=null,this._input=null}function ea(){aa.apply(this,arguments)}function fa(){aa.apply(this,arguments)}function ga(){Y.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function ha(a,b){return b=b||{},b.recognizers=l(b.recognizers,ha.defaults.preset),new ia(a,b)}function ia(a,b){this.options=la({},ha.defaults,b||{}),this.options.inputTarget=this.options.inputTarget||a,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=a,this.input=y(this),this.touchAction=new V(this,this.options.touchAction),ja(this,!0),g(this.options.recognizers,function(a){var b=this.add(new a[0](a[1]));a[2]&&b.recognizeWith(a[2]),a[3]&&b.requireFailure(a[3])},this)}function ja(a,b){var c=a.element;if(c.style){var d;g(a.options.cssProps,function(e,f){d=u(c.style,f),b?(a.oldCssProps[d]=c.style[d],c.style[d]=e):c.style[d]=a.oldCssProps[d]||""}),b||(a.oldCssProps={})}}function ka(a,c){var d=b.createEvent("Event");d.initEvent(a,!0,!0),d.gesture=c,c.target.dispatchEvent(d)}var la,ma=["","webkit","Moz","MS","ms","o"],na=b.createElement("div"),oa="function",pa=Math.round,qa=Math.abs,ra=Date.now;la="function"!=typeof Object.assign?function(a){if(a===d||null===a)throw new TypeError("Cannot convert undefined or null to object");for(var b=Object(a),c=1;c<arguments.length;c++){var e=arguments[c];if(e!==d&&null!==e)for(var f in e)e.hasOwnProperty(f)&&(b[f]=e[f])}return b}:Object.assign;var sa=h(function(a,b,c){for(var e=Object.keys(b),f=0;f<e.length;)(!c||c&&a[e[f]]===d)&&(a[e[f]]=b[e[f]]),f++;return a},"extend","Use `assign`."),ta=h(function(a,b){return sa(a,b,!0)},"merge","Use `assign`."),ua=1,va=/mobile|tablet|ip(ad|hone|od)|android/i,wa="ontouchstart"in a,xa=u(a,"PointerEvent")!==d,ya=wa&&va.test(navigator.userAgent),za="touch",Ba="mouse",Da=25,Ea=1,Fa=2,Ga=4,Ha=8,Ia=1,Ja=2,Ka=4,La=8,Ma=16,Na=Ja|Ka,Oa=La|Ma,Pa=Na|Oa,Qa=["x","y"],Ra=["clientX","clientY"];x.prototype={handler:function(){},init:function(){this.evEl&&m(this.element,this.evEl,this.domHandler),this.evTarget&&m(this.target,this.evTarget,this.domHandler),this.evWin&&m(w(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&n(this.element,this.evEl,this.domHandler),this.evTarget&&n(this.target,this.evTarget,this.domHandler),this.evWin&&n(w(this.element),this.evWin,this.domHandler)}};var Sa={mousedown:Ea,mousemove:Fa,mouseup:Ga},Ta="mousedown",Ua="mousemove mouseup";i(L,x,{handler:function(a){var b=Sa[a.type];b&Ea&&0===a.button&&(this.pressed=!0),b&Fa&&1!==a.which&&(b=Ga),this.pressed&&(b&Ga&&(this.pressed=!1),this.callback(this.manager,b,{pointers:[a],changedPointers:[a],pointerType:Ba,srcEvent:a}))}});var Va={pointerdown:Ea,pointermove:Fa,pointerup:Ga,pointercancel:Ha,pointerout:Ha},Wa={2:za,3:"pen",4:Ba,5:"kinect"},Xa="pointerdown",Ya="pointermove pointerup pointercancel";a.MSPointerEvent&&!a.PointerEvent&&(Xa="MSPointerDown",Ya="MSPointerMove MSPointerUp MSPointerCancel"),i(M,x,{handler:function(a){var b=this.store,c=!1,d=a.type.toLowerCase().replace("ms",""),e=Va[d],f=Wa[a.pointerType]||a.pointerType,g=f==za,h=r(b,a.pointerId,"pointerId");e&Ea&&(0===a.button||g)?0>h&&(b.push(a),h=b.length-1):e&(Ga|Ha)&&(c=!0),0>h||(b[h]=a,this.callback(this.manager,e,{pointers:b,changedPointers:[a],pointerType:f,srcEvent:a}),c&&b.splice(h,1))}});var Za={touchstart:Ea,touchmove:Fa,touchend:Ga,touchcancel:Ha},$a="touchstart",_a="touchstart touchmove touchend touchcancel";i(N,x,{handler:function(a){var b=Za[a.type];if(b===Ea&&(this.started=!0),this.started){var c=O.call(this,a,b);b&(Ga|Ha)&&c[0].length-c[1].length==0&&(this.started=!1),this.callback(this.manager,b,{pointers:c[0],changedPointers:c[1],pointerType:za,srcEvent:a})}}});var ab={touchstart:Ea,touchmove:Fa,touchend:Ga,touchcancel:Ha},bb="touchstart touchmove touchend touchcancel";i(P,x,{handler:function(a){var b=ab[a.type],c=Q.call(this,a,b);c&&this.callback(this.manager,b,{pointers:c[0],changedPointers:c[1],pointerType:za,srcEvent:a})}});var cb=2500,db=25;i(R,x,{handler:function(a,b,c){var d=c.pointerType==za,e=c.pointerType==Ba;if(!(e&&c.sourceCapabilities&&c.sourceCapabilities.firesTouchEvents)){if(d)S.call(this,b,c);else if(e&&U.call(this,c))return;this.callback(a,b,c)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var eb=u(na.style,"touchAction"),fb=eb!==d,gb="compute",hb="auto",ib="manipulation",jb="none",kb="pan-x",lb="pan-y",mb=function(){if(!fb)return!1;var b={},c=a.CSS&&a.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(d){b[d]=!c||a.CSS.supports("touch-action",d)}),b}();V.prototype={set:function(a){a==gb&&(a=this.compute()),fb&&this.manager.element.style&&mb[a]&&(this.manager.element.style[eb]=a),this.actions=a.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var a=[];return g(this.manager.recognizers,function(b){k(b.options.enable,[b])&&(a=a.concat(b.getTouchAction()))}),W(a.join(" "))},preventDefaults:function(a){var b=a.srcEvent,c=a.offsetDirection;if(this.manager.session.prevented)return void b.preventDefault();var d=this.actions,e=p(d,jb)&&!mb[jb],f=p(d,lb)&&!mb[lb],g=p(d,kb)&&!mb[kb];if(e){var h=1===a.pointers.length,i=a.distance<2,j=a.deltaTime<250;if(h&&i&&j)return}return g&&f?void 0:e||f&&c&Na||g&&c&Oa?this.preventSrc(b):void 0},preventSrc:function(a){this.manager.session.prevented=!0,a.preventDefault()}};var nb=1,ob=2,pb=4,qb=8,rb=qb,sb=16;Y.prototype={defaults:{},set:function(a){return la(this.options,a),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(a){if(f(a,"recognizeWith",this))return this;var b=this.simultaneous;return a=_(a,this),b[a.id]||(b[a.id]=a,a.recognizeWith(this)),this},dropRecognizeWith:function(a){return f(a,"dropRecognizeWith",this)?this:(a=_(a,this),delete this.simultaneous[a.id],this)},requireFailure:function(a){if(f(a,"requireFailure",this))return this;var b=this.requireFail;return a=_(a,this),-1===r(b,a)&&(b.push(a),a.requireFailure(this)),this},dropRequireFailure:function(a){if(f(a,"dropRequireFailure",this))return this;a=_(a,this);var b=r(this.requireFail,a);return b>-1&&this.requireFail.splice(b,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(a){return!!this.simultaneous[a.id]},emit:function(a){function b(b){c.manager.emit(b,a)}var c=this,d=this.state;qb>d&&b(c.options.event+Z(d)),b(c.options.event),a.additionalEvent&&b(a.additionalEvent),d>=qb&&b(c.options.event+Z(d))},tryEmit:function(a){return this.canEmit()?this.emit(a):void(this.state=32)},canEmit:function(){for(var a=0;a<this.requireFail.length;){if(!(this.requireFail[a].state&(32|nb)))return!1;a++}return!0},recognize:function(a){var b=la({},a);return k(this.options.enable,[this,b])?(this.state&(rb|sb|32)&&(this.state=nb),this.state=this.process(b),void(this.state&(ob|pb|qb|sb)&&this.tryEmit(b))):(this.reset(),void(this.state=32))},process:function(a){},getTouchAction:function(){},reset:function(){}},i(aa,Y,{defaults:{pointers:1},attrTest:function(a){var b=this.options.pointers;return 0===b||a.pointers.length===b},process:function(a){var b=this.state,c=a.eventType,d=b&(ob|pb),e=this.attrTest(a);return d&&(c&Ha||!e)?b|sb:d||e?c&Ga?b|qb:b&ob?b|pb:ob:32}}),i(ba,aa,{defaults:{event:"pan",threshold:10,pointers:1,direction:Pa},getTouchAction:function(){var a=this.options.direction,b=[];return a&Na&&b.push(lb),a&Oa&&b.push(kb),b},directionTest:function(a){var b=this.options,c=!0,d=a.distance,e=a.direction,f=a.deltaX,g=a.deltaY;return e&b.direction||(b.direction&Na?(e=0===f?Ia:0>f?Ja:Ka,c=f!=this.pX,d=Math.abs(a.deltaX)):(e=0===g?Ia:0>g?La:Ma,c=g!=this.pY,d=Math.abs(a.deltaY))),a.direction=e,c&&d>b.threshold&&e&b.direction},attrTest:function(a){return aa.prototype.attrTest.call(this,a)&&(this.state&ob||!(this.state&ob)&&this.directionTest(a))},emit:function(a){this.pX=a.deltaX,this.pY=a.deltaY;var b=$(a.direction);b&&(a.additionalEvent=this.options.event+b),this._super.emit.call(this,a)}}),i(ca,aa,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[jb]},attrTest:function(a){return this._super.attrTest.call(this,a)&&(Math.abs(a.scale-1)>this.options.threshold||this.state&ob)},emit:function(a){if(1!==a.scale){var b=a.scale<1?"in":"out";a.additionalEvent=this.options.event+b}this._super.emit.call(this,a)}}),i(da,Y,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[hb]},process:function(a){var b=this.options,c=a.pointers.length===b.pointers,d=a.distance<b.threshold,f=a.deltaTime>b.time;if(this._input=a,!d||!c||a.eventType&(Ga|Ha)&&!f)this.reset();else if(a.eventType&Ea)this.reset(),this._timer=e(function(){this.state=rb,this.tryEmit()},b.time,this);else if(a.eventType&Ga)return rb;return 32},reset:function(){clearTimeout(this._timer)},emit:function(a){this.state===rb&&(a&&a.eventType&Ga?this.manager.emit(this.options.event+"up",a):(this._input.timeStamp=ra(),this.manager.emit(this.options.event,this._input)))}}),i(ea,aa,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[jb]},attrTest:function(a){return this._super.attrTest.call(this,a)&&(Math.abs(a.rotation)>this.options.threshold||this.state&ob)}}),i(fa,aa,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:Na|Oa,pointers:1},getTouchAction:function(){return ba.prototype.getTouchAction.call(this)},attrTest:function(a){var b,c=this.options.direction;return c&(Na|Oa)?b=a.overallVelocity:c&Na?b=a.overallVelocityX:c&Oa&&(b=a.overallVelocityY),this._super.attrTest.call(this,a)&&c&a.offsetDirection&&a.distance>this.options.threshold&&a.maxPointers==this.options.pointers&&qa(b)>this.options.velocity&&a.eventType&Ga},emit:function(a){var b=$(a.offsetDirection);b&&this.manager.emit(this.options.event+b,a),this.manager.emit(this.options.event,a)}}),i(ga,Y,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[ib]},process:function(a){var b=this.options,c=a.pointers.length===b.pointers,d=a.distance<b.threshold,f=a.deltaTime<b.time;if(this.reset(),a.eventType&Ea&&0===this.count)return this.failTimeout();if(d&&f&&c){if(a.eventType!=Ga)return this.failTimeout();var g=!this.pTime||a.timeStamp-this.pTime<b.interval,h=!this.pCenter||H(this.pCenter,a.center)<b.posThreshold;this.pTime=a.timeStamp,this.pCenter=a.center,h&&g?this.count+=1:this.count=1,this._input=a;if(0===this.count%b.taps)return this.hasRequireFailures()?(this._timer=e(function(){this.state=rb,this.tryEmit()},b.interval,this),ob):rb}return 32},failTimeout:function(){return this._timer=e(function(){this.state=32},this.options.interval,this),32},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==rb&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),ha.VERSION="2.0.8",ha.defaults={domEvents:!1,touchAction:gb,enable:!0,inputTarget:null,inputClass:null,preset:[[ea,{enable:!1}],[ca,{enable:!1},["rotate"]],[fa,{direction:Na}],[ba,{direction:Na},["swipe"]],[ga],[ga,{event:"doubletap",taps:2},["tap"]],[da]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};ia.prototype={set:function(a){return la(this.options,a),a.touchAction&&this.touchAction.update(),a.inputTarget&&(this.input.destroy(),this.input.target=a.inputTarget,this.input.init()),this},stop:function(a){this.session.stopped=a?2:1},recognize:function(a){var b=this.session;if(!b.stopped){this.touchAction.preventDefaults(a);var c,d=this.recognizers,e=b.curRecognizer;(!e||e&&e.state&rb)&&(e=b.curRecognizer=null);for(var f=0;f<d.length;)c=d[f],2===b.stopped||e&&c!=e&&!c.canRecognizeWith(e)?c.reset():c.recognize(a),!e&&c.state&(ob|pb|qb)&&(e=b.curRecognizer=c),f++}},get:function(a){if(a instanceof Y)return a;for(var b=this.recognizers,c=0;c<b.length;c++)if(b[c].options.event==a)return b[c];return null},add:function(a){if(f(a,"add",this))return this;var b=this.get(a.options.event);return b&&this.remove(b),this.recognizers.push(a),a.manager=this,this.touchAction.update(),a},remove:function(a){if(f(a,"remove",this))return this;if(a=this.get(a)){var b=this.recognizers,c=r(b,a);-1!==c&&(b.splice(c,1),this.touchAction.update())}return this},on:function(a,b){if(a!==d&&b!==d){var c=this.handlers;return g(q(a),function(a){c[a]=c[a]||[],c[a].push(b)}),this}},off:function(a,b){if(a!==d){var c=this.handlers;return g(q(a),function(a){b?c[a]&&c[a].splice(r(c[a],b),1):delete c[a]}),this}},emit:function(a,b){this.options.domEvents&&ka(a,b);var c=this.handlers[a]&&this.handlers[a].slice();if(c&&c.length){b.type=a,b.preventDefault=function(){b.srcEvent.preventDefault()};for(var d=0;d<c.length;)c[d](b),d++}},destroy:function(){this.element&&ja(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},la(ha,{INPUT_START:Ea,INPUT_MOVE:Fa,INPUT_END:Ga,INPUT_CANCEL:Ha,STATE_POSSIBLE:nb,STATE_BEGAN:ob,STATE_CHANGED:pb,STATE_ENDED:qb,STATE_RECOGNIZED:rb,STATE_CANCELLED:sb,STATE_FAILED:32,DIRECTION_NONE:Ia,DIRECTION_LEFT:Ja,DIRECTION_RIGHT:Ka,DIRECTION_UP:La,DIRECTION_DOWN:Ma,DIRECTION_HORIZONTAL:Na,DIRECTION_VERTICAL:Oa,DIRECTION_ALL:Pa,Manager:ia,Input:x,TouchAction:V,TouchInput:P,MouseInput:L,PointerEventInput:M,TouchMouseInput:R,SingleTouchInput:N,Recognizer:Y,AttrRecognizer:aa,Tap:ga,Pan:ba,Swipe:fa,Pinch:ca,Rotate:ea,Press:da,on:m,off:n,each:g,merge:ta,extend:sa,assign:la,inherit:i,bindFn:j,prefixed:u}),(void 0!==a?a:"undefined"!=typeof self?self:{}).Hammer=ha,"function"==typeof define&&define.amd?define(function(){return ha}):"undefined"!=typeof module&&module.exports?module.exports=ha:a.Hammer=ha}(window,document),function(factory){"function"==typeof define&&define.amd?define(["jquery","hammerjs"],factory):"object"==typeof exports?factory(require("jquery"),require("hammerjs")):factory(jQuery,Hammer)}(function($,Hammer){function hammerify(el,options){var $el=$(el)
;$el.data("hammer")||$el.data("hammer",new Hammer($el[0],options))}$.fn.hammer=function(options){return this.each(function(){hammerify(this,options)})},Hammer.Manager.prototype.emit=function(originalEmit){return function(type,data){originalEmit.call(this,type,data),$(this.element).trigger({type:type,gesture:data})}}(Hammer.Manager.prototype.emit)}),function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):"object"==typeof exports?module.exports=factory:factory(jQuery)}(function($){var nullLowestDeltaTimeout,lowestDelta,toFix=["wheel","mousewheel","DOMMouseScroll","MozMousePixelScroll"],toBind="onwheel"in document||document.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"],slice=Array.prototype.slice;if($.event.fixHooks)for(var i=toFix.length;i;)$.event.fixHooks[toFix[--i]]=$.event.mouseHooks;var special=$.event.special.mousewheel={version:"3.1.12",setup:function(){if(this.addEventListener)for(var i=toBind.length;i;)this.addEventListener(toBind[--i],handler,!1);else this.onmousewheel=handler;$.data(this,"mousewheel-line-height",special.getLineHeight(this)),$.data(this,"mousewheel-page-height",special.getPageHeight(this))},teardown:function(){if(this.removeEventListener)for(var i=toBind.length;i;)this.removeEventListener(toBind[--i],handler,!1);else this.onmousewheel=null;$.removeData(this,"mousewheel-line-height"),$.removeData(this,"mousewheel-page-height")},getLineHeight:function(elem){var $elem=$(elem),$parent=$elem["offsetParent"in $.fn?"offsetParent":"parent"]();return $parent.length||($parent=$("body")),parseInt($parent.css("fontSize"),10)||parseInt($elem.css("fontSize"),10)||16},getPageHeight:function(elem){return $(elem).height()},settings:{adjustOldDeltas:!0,normalizeOffset:!0}};$.fn.extend({mousewheel:function(fn){return fn?this.bind("mousewheel",fn):this.trigger("mousewheel")},unmousewheel:function(fn){return this.unbind("mousewheel",fn)}});function handler(event){var orgEvent=event||window.event,args=slice.call(arguments,1),delta=0,deltaX=0,deltaY=0,absDelta=0,offsetX=0,offsetY=0;if(event=$.event.fix(orgEvent),event.type="mousewheel","detail"in orgEvent&&(deltaY=-1*orgEvent.detail),"wheelDelta"in orgEvent&&(deltaY=orgEvent.wheelDelta),"wheelDeltaY"in orgEvent&&(deltaY=orgEvent.wheelDeltaY),"wheelDeltaX"in orgEvent&&(deltaX=-1*orgEvent.wheelDeltaX),"axis"in orgEvent&&orgEvent.axis===orgEvent.HORIZONTAL_AXIS&&(deltaX=-1*deltaY,deltaY=0),delta=0===deltaY?deltaX:deltaY,"deltaY"in orgEvent&&(deltaY=-1*orgEvent.deltaY,delta=deltaY),"deltaX"in orgEvent&&(deltaX=orgEvent.deltaX,0===deltaY&&(delta=-1*deltaX)),0!==deltaY||0!==deltaX){if(1===orgEvent.deltaMode){var lineHeight=$.data(this,"mousewheel-line-height");delta*=lineHeight,deltaY*=lineHeight,deltaX*=lineHeight}else if(2===orgEvent.deltaMode){var pageHeight=$.data(this,"mousewheel-page-height");delta*=pageHeight,deltaY*=pageHeight,deltaX*=pageHeight}if(absDelta=Math.max(Math.abs(deltaY),Math.abs(deltaX)),(!lowestDelta||absDelta<lowestDelta)&&(lowestDelta=absDelta,shouldAdjustOldDeltas(orgEvent,absDelta)&&(lowestDelta/=40)),shouldAdjustOldDeltas(orgEvent,absDelta)&&(delta/=40,deltaX/=40,deltaY/=40),delta=Math[delta>=1?"floor":"ceil"](delta/lowestDelta),deltaX=Math[deltaX>=1?"floor":"ceil"](deltaX/lowestDelta),deltaY=Math[deltaY>=1?"floor":"ceil"](deltaY/lowestDelta),special.settings.normalizeOffset&&this.getBoundingClientRect){var boundingRect=this.getBoundingClientRect();offsetX=event.clientX-boundingRect.left,offsetY=event.clientY-boundingRect.top}return event.deltaX=deltaX,event.deltaY=deltaY,event.deltaFactor=lowestDelta,event.offsetX=offsetX,event.offsetY=offsetY,event.deltaMode=0,args.unshift(event,delta,deltaX,deltaY),nullLowestDeltaTimeout&&clearTimeout(nullLowestDeltaTimeout),nullLowestDeltaTimeout=setTimeout(nullLowestDelta,200),($.event.dispatch||$.event.handle).apply(this,args)}}function nullLowestDelta(){lowestDelta=null}function shouldAdjustOldDeltas(orgEvent,absDelta){return special.settings.adjustOldDeltas&&"mousewheel"===orgEvent.type&&absDelta%120==0}}),function(b){var x=/(^|["'(\s]|&lt;)(www\..+?\..+?)((?:[:?]|\.+)?(?:\s|$)|&gt;|[)"',])/g,y=/(^|["'(\s]|&lt;)((?:(?:https?|ftp):\/\/|mailto:).+?)((?:[:?]|\.+)?(?:\s|$)|&gt;|[)"',])/g,z=function(h){return h.replace(x,'$1<a href="<``>://$2">$2</a>$3').replace(y,'$1<a href="$2">$2</a>$3').replace(/"<``>/g,'"http')},s=b.fn.linkify=function(c){b.isPlainObject(c)||(c={use:"string"==typeof c?c:void 0,handleLinks:b.isFunction(c)?c:arguments[1]});var f,d=c.use,k=s.plugins||{},l=[z],m=[],n=c.handleLinks;if(void 0==d||"*"==d)for(var i in k)l.push(k[i]);else{d=b.isArray(d)?d:b.trim(d).split(/ *, */);for(var o,i,p=0,A=d.length;p<A;p++)i=d[p],(o=k[i])&&l.push(o)}return this.each(function(){for(var h=this.childNodes,t=h.length;t--;){var e=h[t];if(3==e.nodeType){var a=e.nodeValue;if(a.length>1&&/\S/.test(a)){var q,r;f=f||b("<div/>")[0],f.innerHTML="",f.appendChild(e.cloneNode(!1));for(var g,u=f.childNodes,v=0;g=l[v];v++)for(var j,w=u.length;w--;)j=u[w],3==j.nodeType&&(a=j.nodeValue,a.length>1&&/\S/.test(a)&&(r=a,a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),a=b.isFunction(g)?g(a):a.replace(g.re,g.tmpl),q=q||r!=a,r!=a&&b(j).after(a).remove()));a=f.innerHTML,n&&(a=b("<div/>").html(a),m=m.concat(a.find("a").toArray().reverse()),a=a.contents()),q&&b(e).after(a).remove()}}else 1!=e.nodeType||/^(a|button|textarea)$/i.test(e.tagName)||arguments.callee.call(e)}}),n&&n(b(m.reverse())),this};s.plugins={mailto:{re:/(^|["'(\s]|&lt;)([^"'(\s&]+?@.+\.[a-z]{2,7})(([:?]|\.+)?(\s|$)|&gt;|[)"',])/gi,tmpl:'$1<a href="mailto:$2">$2</a>$3'}}}(jQuery);function polyfill(){var w=window,d=document;function scrollElement(x,y){this.scrollLeft=x,this.scrollTop=y}function ease(k){return.5*(1-Math.cos(Math.PI*k))}function shouldBailOut(firstArg){if(null===firstArg||"object"!=typeof firstArg||void 0===firstArg.behavior||"auto"===firstArg.behavior||"instant"===firstArg.behavior)return!0;if("object"==typeof firstArg&&"smooth"===firstArg.behavior)return!1;throw new TypeError("behavior member of ScrollOptions "+firstArg.behavior+" is not a valid value for enumeration ScrollBehavior.")}function hasScrollableSpace(el,axis){return"Y"===axis?el.clientHeight+ROUNDING_TOLERANCE<el.scrollHeight:"X"===axis?el.clientWidth+ROUNDING_TOLERANCE<el.scrollWidth:void 0}function canOverflow(el,axis){var overflowValue=w.getComputedStyle(el,null)["overflow"+axis];return"auto"===overflowValue||"scroll"===overflowValue}function isScrollable(el){var isScrollableY=hasScrollableSpace(el,"Y")&&canOverflow(el,"Y"),isScrollableX=hasScrollableSpace(el,"X")&&canOverflow(el,"X");return isScrollableY||isScrollableX}function findScrollableParent(el){var isBody;do{el=el.parentNode,isBody=el===d.body}while(!1===isBody&&!1===isScrollable(el));return isBody=null,el}function step(context){var value,currentX,currentY,time=now(),elapsed=(time-context.startTime)/SCROLL_TIME;elapsed=elapsed>1?1:elapsed,value=ease(elapsed),currentX=context.startX+(context.x-context.startX)*value,currentY=context.startY+(context.y-context.startY)*value,context.method.call(context.scrollable,currentX,currentY),currentX===context.x&&currentY===context.y||w.requestAnimationFrame(step.bind(w,context))}function smoothScroll(el,x,y){var scrollable,startX,startY,method,startTime=now();el===d.body?(scrollable=w,startX=w.scrollX||w.pageXOffset,startY=w.scrollY||w.pageYOffset,method=original.scroll):(scrollable=el,startX=el.scrollLeft,startY=el.scrollTop,method=scrollElement),step({scrollable:scrollable,method:method,startTime:startTime,startX:startX,startY:startY,x:x,y:y})}if(!("scrollBehavior"in d.documentElement.style&&!0!==w.__forceSmoothScrollPolyfill__)){var Element=w.HTMLElement||w.Element,SCROLL_TIME=468,original={scroll:w.scroll||w.scrollTo,scrollBy:w.scrollBy,elementScroll:Element.prototype.scroll||scrollElement,scrollIntoView:Element.prototype.scrollIntoView},now=w.performance&&w.performance.now?w.performance.now.bind(w.performance):Date.now,ROUNDING_TOLERANCE=function(userAgent){var userAgentPatterns=["MSIE ","Trident/","Edge/"];return new RegExp(userAgentPatterns.join("|")).test(userAgent)}(w.navigator.userAgent)?1:0;w.scroll=w.scrollTo=function(){if(void 0!==arguments[0])return!0===shouldBailOut(arguments[0])?void original.scroll.call(w,void 0!==arguments[0].left?arguments[0].left:"object"!=typeof arguments[0]?arguments[0]:w.scrollX||w.pageXOffset,void 0!==arguments[0].top?arguments[0].top:void 0!==arguments[1]?arguments[1]:w.scrollY||w.pageYOffset):void smoothScroll.call(w,d.body,void 0!==arguments[0].left?~~arguments[0].left:w.scrollX||w.pageXOffset,void 0!==arguments[0].top?~~arguments[0].top:w.scrollY||w.pageYOffset)},w.scrollBy=function(){if(void 0!==arguments[0])return shouldBailOut(arguments[0])?void original.scrollBy.call(w,void 0!==arguments[0].left?arguments[0].left:"object"!=typeof arguments[0]?arguments[0]:0,void 0!==arguments[0].top?arguments[0].top:void 0!==arguments[1]?arguments[1]:0):void smoothScroll.call(w,d.body,~~arguments[0].left+(w.scrollX||w.pageXOffset),~~arguments[0].top+(w.scrollY||w.pageYOffset))},Element.prototype.scroll=Element.prototype.scrollTo=function(){if(void 0!==arguments[0]){if(!0===shouldBailOut(arguments[0])){if("number"==typeof arguments[0]&&void 0===arguments[1])throw new SyntaxError("Value could not be converted");return void original.elementScroll.call(this,void 0!==arguments[0].left?~~arguments[0].left:"object"!=typeof arguments[0]?~~arguments[0]:this.scrollLeft,void 0!==arguments[0].top?~~arguments[0].top:void 0!==arguments[1]?~~arguments[1]:this.scrollTop)}var left=arguments[0].left,top=arguments[0].top;smoothScroll.call(this,this,void 0===left?this.scrollLeft:~~left,void 0===top?this.scrollTop:~~top)}},Element.prototype.scrollBy=function(){if(void 0!==arguments[0])return!0===shouldBailOut(arguments[0])?void original.elementScroll.call(this,void 0!==arguments[0].left?~~arguments[0].left+this.scrollLeft:~~arguments[0]+this.scrollLeft,void 0!==arguments[0].top?~~arguments[0].top+this.scrollTop:~~arguments[1]+this.scrollTop):void this.scroll({left:~~arguments[0].left+this.scrollLeft,top:~~arguments[0].top+this.scrollTop,behavior:arguments[0].behavior})},Element.prototype.scrollIntoView=function(){if(!0===shouldBailOut(arguments[0]))return void original.scrollIntoView.call(this,void 0===arguments[0]||arguments[0]);var scrollableParent=findScrollableParent(this),parentRects=scrollableParent.getBoundingClientRect(),clientRects=this.getBoundingClientRect();scrollableParent!==d.body?(smoothScroll.call(this,scrollableParent,scrollableParent.scrollLeft+clientRects.left-parentRects.left,scrollableParent.scrollTop+clientRects.top-parentRects.top),"fixed"!==w.getComputedStyle(scrollableParent).position&&w.scrollBy({left:parentRects.left,top:parentRects.top,behavior:"smooth"})):w.scrollBy({left:clientRects.left,top:clientRects.top,behavior:"smooth"})}}}"object"==typeof exports&&"undefined"!=typeof module?module.exports={polyfill:polyfill}:polyfill(),a5.rootURL=location.pathname.substring(0,location.pathname.lastIndexOf("/")),a5.getURLParameter=function(sParam){return a5.getURLParameterObject()[sParam]},a5.getURLParameterObject=function(){var params=window.location.search.slice(1).split("&");return _.chain(params).compact().invoke("split","=").object().value()},a5.utils.getAbsoluteURL=function(){var a;return function(url){return a||(a=document.createElement("a")),a.href=url,a.href}}(),$(document).ready(function(){PointerEventsPolyfill.initialize({cancel:".sticky-note"})}),a5.sha1hex=function(text){var hashlib=new jsSHA("SHA-1","TEXT");return hashlib.update(text),hashlib.getHash("HEX")},a5.utils.getIdentifier=function(xmlString){var result=/<assessmentItem.*identifier="([\w\s]+:[\w\s]+:[\w\s]+)".*>/.exec(xmlString);return result?result[1]:void 0},a5.utils.hasTag=function(node,tag){return node.get(0).tagName&&node.get(0).tagName.toLowerCase()===tag.toLowerCase()},a5.utils.hasId=function(node,id){return $(node).attr("id")===id},a5.utils.hasClass=function(node,className){return!!$(node).attr("class")&&$(node).attr("class").split(/\s+/).indexOf(className)>-1},a5.utils.tagNameIs=function(node,tagName){var $node=$(node);return!!$node.get(0).tagName&&$node.get(0).tagName.toLowerCase()===tagName.toLowerCase()},a5.utils.copyAttributes=function(target,source){for(var i=0;i<source.attributes.length;i++){var a=source.attributes[i];target.setAttribute(a.name,a.value)}},$.fn.copyAttributes=function($source){return a5.utils.copyAttributes(this[0],$source[0]),this},a5.getScript=function(src,callback,error_callback){var s=document.createElement("script");s.type="text/"+(src.type||"javascript"),s.src=src.src||src,s.async=!1,s.onload=function(){var state=s.readyState;callback.done||state&&!/loaded|complete/.test(state)||(callback.done=!0,callback())},s.onerror=function(){logger.warn("Error loading "+src),error_callback&&!error_callback.done&&(error_callback.done=!0,error_callback())},(document.body||document.head).appendChild(s)},function(){var parseMatrix=function(cssmatrix){var rmatrix=new RegExp("^matrix\\((\\-?[\\d\\.e\\-]+)\\,?\\s*(\\-?[\\d\\.e\\-]+)\\,?\\s*(\\-?[\\d\\.e\\-]+)\\,?\\s*(\\-?[\\d\\.e\\-]+)\\,?\\s*(\\-?[\\d\\.e\\-]+)\\,?\\s*(\\-?[\\d\\.e\\-]+)\\)$"),matrix=rmatrix.exec(cssmatrix);return matrix&&matrix.shift(),matrix||[1,0,0,1,0,0]},_round=function(number,decimals){return parseFloat(number.toFixed(decimals))},Matrix=function(a,b,c,d,e,f,g,h,i){"array"===$.type(a)?this.elements=[_round(+a[0],5),_round(+a[2],5),_round(+a[4],5),_round(+a[1],5),_round(+a[3],5),_round(+a[5],5),0,0,1]:this.elements=[_round(a,5),_round(b,5),_round(c,5),_round(d,5),_round(e,5),_round(f,5),_round(g,5)||0,_round(h,5)||0,_round(i,5)||1]};Matrix.prototype={x:function(matrix){var isVector=matrix instanceof Vector,a=this.elements,b=matrix.elements;return isVector&&3===b.length?new Vector(a[0]*b[0]+a[1]*b[1]+a[2]*b[2],a[3]*b[0]+a[4]*b[1]+a[5]*b[2],a[6]*b[0]+a[7]*b[1]+a[8]*b[2]):b.length===a.length&&new Matrix(a[0]*b[0]+a[1]*b[3]+a[2]*b[6],a[0]*b[1]+a[1]*b[4]+a[2]*b[7],a[0]*b[2]+a[1]*b[5]+a[2]*b[8],a[3]*b[0]+a[4]*b[3]+a[5]*b[6],a[3]*b[1]+a[4]*b[4]+a[5]*b[7],a[3]*b[2]+a[4]*b[5]+a[5]*b[8],a[6]*b[0]+a[7]*b[3]+a[8]*b[6],a[6]*b[1]+a[7]*b[4]+a[8]*b[7],a[6]*b[2]+a[7]*b[5]+a[8]*b[8])},inverse:function(){var d=1/this.determinant(),a=this.elements;return new Matrix(d*(a[8]*a[4]-a[7]*a[5]),d*-(a[8]*a[1]-a[7]*a[2]),d*(a[5]*a[1]-a[4]*a[2]),d*-(a[8]*a[3]-a[6]*a[5]),d*(a[8]*a[0]-a[6]*a[2]),d*-(a[5]*a[0]-a[3]*a[2]),d*(a[7]*a[3]-a[6]*a[4]),d*-(a[7]*a[0]-a[6]*a[1]),d*(a[4]*a[0]-a[3]*a[1]))},determinant:function(){var a=this.elements;return a[0]*(a[8]*a[4]-a[7]*a[5])-a[3]*(a[8]*a[1]-a[7]*a[2])+a[6]*(a[5]*a[1]-a[4]*a[2])},getScale:function(){return this.elements[0]||this.elements[1]},rotate:function(deg){var rad=parseFloat(deg)*(Math.PI/180),costheta=Math.cos(rad),sintheta=Math.sin(rad);return new Matrix(costheta,-sintheta,0,sintheta,costheta,0,0,0,1).x(this)},skew:function(dx,dy){var radX=parseFloat(dx)*(Math.PI/180),radY=parseFloat(dy)*(Math.PI/180),c=Math.tan(radX),b=Math.tan(radY);return new Matrix(1,c,0,b,1,0,0,0,1).x(this)},translate:function(x,y){return new Matrix(1,0,x||0,0,1,y||0,0,0,1).x(this)},scale:function(x,y){return new Matrix(x||0,0,0,0,y||0,0,0,0,1).x(this)},toString:function(){var s="matrix(";return s+=this.elements[0].toFixed(3)+", ",s+=this.elements[3].toFixed(3)+", ",s+=this.elements[1].toFixed(3)+", ",s+=this.elements[4].toFixed(3)+", ",s+=this.elements[2].toFixed(3)+", ",s+=this.elements[5].toFixed(3),s+=")"}};var Vector=function(x,y,z){this.elements=[_round(x,5),_round(y,5),_round(z,5)]};Vector.prototype.e=Matrix.prototype.e=function(i){return void 0!=this.elements[i]?this.elements[i]:this.elements},a5.utils.Matrix=Matrix,a5.utils.Vector=Vector,a5.utils.parseCSSMatrix=parseMatrix,$.fn.transformationMatrix=function(withParents){var matrices=[],$elements=withParents?$(this).parents().toArray():[];return $elements.unshift(this),_($elements).each(function(node){var csstransform=$(node).css("transform");if("none"!==csstransform){var matrix=new Matrix(parseMatrix(csstransform));matrices.unshift(matrix)}}),_(matrices).reduce(function(memo,m){return memo.x(m)},new Matrix([1,0,0,1,0,0]))},$.ui.ddmanager.prepareOffsets=function(t,event){var i,j,m=$.ui.ddmanager.droppables[t.options.scope]||[],type=event?event.type:null,list=(t.currentItem||t.element).find(":data(ui-droppable)").addBack();droppablesLoop:for(i=0;i<m.length;i++)if(!(m[i].options.disabled||t&&!m[i].accept.call(m[i].element[0],t.currentItem||t.element))){for(j=0;j<list.length;j++)if(list[j]===m[i].element[0]){m[i].proportions().height=0;continue droppablesLoop}if(m[i].visible="none"!==m[i].element.css("display"),m[i].visible){"mousedown"===type&&m[i]._activate.call(m[i],event);var scale=m[i].element.transformationMatrix(!0).getScale();m[i].offset=m[i].element.offset(),m[i].proportions({width:m[i].element[0].offsetWidth*scale,height:m[i].element[0].offsetHeight*scale})}}}}(),Object.defineProperty(String.prototype,"hashCode",{enumerable:!1,writeable:!0,value:function(){var hash=0;if(0==this.length)return hash;for(var i=0;i<this.length;i++){hash=(hash<<5)-hash+this.charCodeAt(i),hash&=hash}return hash}});function inverseMap(map){var nmap={};return _.each(map,function(v,key){_.each(v,function(value){nmap[value]||(nmap[value]=[]),nmap[value].push(key)})}),nmap}Function.prototype.bindDD=function(context){var func=this;return function(param1,param2){func.apply(context,[param1,param2,this])}};function htmlEncode(str){return String(str).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/â/g,"&#8217;").replace(/'/g,"&apos;")}function htmlDecode(str){return String(str).replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#8217;/g,"â").replace(/&apos;/g,"'")}a5.utils.singleHtmlDecode=function(str){return String(str).replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#8217;/g,"â").replace(/&apos;/g,"'").replace(/&amp;/g,"&")},function(){if(!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){var dragMouseUp=$.ui.draggable.prototype._mouseUp,clickclickMouseUp=function(event){return void 0===this.click&&(this.click=0),1!=++this.click&&(!0===this.options.iframeFix&&$("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)}),2==this.click&&(this.click=-1),window.$.ui.mouse.prototype._mouseUp.call(this,event))};$.ui.draggable.prototype._mouseUp=function(event){a5.mainBuilder.curInteraction.options.useClickClickIsTrue()?clickclickMouseUp.apply(this,arguments):dragMouseUp.apply(this,arguments)}}}(),function(){function isOverAxis(x,reference,size){return x>reference&&x<reference+size}function isOverAxisWithRadius(x,reference,size,radius){return x>reference-radius&&x<reference+size+radius}logger.log("Using custom jquery-ui droppable with tolerance radius"),$.ui.intersect=function(draggable,droppable,toleranceMode){if(!droppable.offset)return!1;var draggableLeft,draggableTop,x1=(draggable.positionAbs||draggable.position.absolute).left,y1=(draggable.positionAbs||draggable.position.absolute).top,x2=x1+draggable.helperProportions.width,y2=y1+draggable.helperProportions.height,l=droppable.offset.left,t=droppable.offset.top,r=l+droppable.proportions().width,b=t+droppable.proportions().height;switch(toleranceMode){case"fit":return l<=x1&&x2<=r&&t<=y1&&y2<=b;case"intersect":return l<x1+draggable.helperProportions.width/2&&x2-draggable.helperProportions.width/2<r&&t<y1+draggable.helperProportions.height/2&&y2-draggable.helperProportions.height/2<b;case"pointer":return draggableLeft=(draggable.positionAbs||draggable.position.absolute).left+(draggable.clickOffset||draggable.offset.click).left,draggableTop=(draggable.positionAbs||draggable.position.absolute).top+(draggable.clickOffset||draggable.offset.click).top,isOverAxis(draggableTop,t,droppable.proportions().height)&&isOverAxis(draggableLeft,l,droppable.proportions().width);case"radius":return draggableLeft=(draggable.positionAbs||draggable.position.absolute).left+(draggable.clickOffset||draggable.offset.click).left,draggableTop=(draggable.positionAbs||draggable.position.absolute).top+(draggable.clickOffset||draggable.offset.click).top,isOverAxisWithRadius(draggableTop,t,droppable.proportions().height,droppable.options.toleranceRadius)&&isOverAxisWithRadius(draggableLeft,l,droppable.proportions().width,droppable.options.toleranceRadius);case"touch":return(y1>=t&&y1<=b||y2>=t&&y2<=b||y1<t&&y2>b)&&(x1>=l&&x1<=r||x2>=l&&x2<=r||x1<l&&x2>r);case"always":var droppables=$.ui.ddmanager.droppables[droppable.options.scope];return droppables=_.filter(droppables,function(d){return d.isover}),droppables.length<=1;default:return!1}};var cursorX,cursorY,defaultIntersect=$.ui.intersect;$(document).on("mousemove touchmove",function(e){var touch;e.originalEvent.touches?(touch=e.originalEvent.touches[0],cursorX=touch.pageX,cursorY=touch.pageY):(cursorX=e.pageX,cursorY=e.pageY)});function distance(point,rect){var dx,dy,x=point.x,y=point.y;return x<rect.left&&y<rect.top?(dx=rect.left-x,dy=rect.top-y):x<rect.left&&y>=rect.top&&y<=rect.bottom?(dx=rect.left-x,dy=0):x<rect.left&&y>rect.bottom?(dx=rect.left-x,dy=y-rect.bottom):x>=rect.left&&x<=rect.right&&y<rect.top?(dx=0,dy=rect.top-y):x>=rect.left&&x<=rect.right&&y>=rect.top&&y<=rect.bottom?(dx=0,dy=0):x>=rect.left&&x<=rect.right&&y>rect.bottom?(dx=0,dy=y-rect.top):x>rect.right&&y<rect.top?(dx=x-rect.right,dy=y-rect.top):x>rect.right&&y>=rect.top&&y<=rect.bottom?(dx=x-rect.right,dy=0):x>rect.right&&y>rect.bottom&&(dx=x-rect.right,dy=y-rect.bottom),Math.sqrt(dx*dx+dy*dy)}$.ui.intersect=function(draggable,droppable,toleranceMode){if("radius-closest-to-mouse"!==toleranceMode)return defaultIntersect(draggable,droppable,toleranceMode);if(!defaultIntersect(draggable,droppable,"radius"))return!1;var acceptable=_.filter($.ui.ddmanager.droppables[draggable.options.scope],function(d){return defaultIntersect(draggable,d,"radius")}),point={x:cursorX,y:cursorY};return droppable===_.min(acceptable,function(other){var rectangle={top:other.offset.top,left:other.offset.left,bottom:other.offset.top+other.proportions().height,right:other.offset.left+other.proportions().width};return distance(point,rectangle)})}}(),function(){a5.utils.Loader={init:function(){},cachedLoad:function(url){return getAjaxData(url)},ajaxLoad:function(url,dataType){return $.ajax({type:"GET",url:a5.utils.noCache(url),dataType:dataType})},load:function(url){var deferred=$.Deferred();logger.info("LOADING\t"+url);var cached=this.cachedLoad(url);return cached?(logger.info("CACHED\t"+url),deferred.resolve({xml:$.parseXML(cached),text:cached})):this.ajaxLoad(url,"xml").done(function(data,code,response){deferred.resolve({xml:data,text:response.responseText})}).fail(function(data,e1,e2){logger.log(e1,e2,url),deferred.reject(e1+"\n"+e2+"\n"+url,data.readyState)}),deferred.promise()}},Obj.extend("a5.utils.Loader",a5.utils.Loader),a5.utils.buildModel=function(interaction,parent,nodes,forceBuild){var self=interaction;void 0===forceBuild&&(forceBuild=!1),nodes.each(function(index,node){var $node=$(node),found=!1;_.each(a5.model_builder.builders,function(e){e.isResponsible($node,self,forceBuild)&&(found?logger.log("found more than one builder for",$node,e):e.build(self,parent,$node,forceBuild),found=!0)}),found||(logger.log("nothing defined for node",$node),alert("nothing defined for node <"+node.tagName+">"))})},a5.utils.buildContents=function(node,interaction,appendTo){var cn=appendTo||$('<div class="content"></div>');return $(node).contents().each(function(i2,e2){interaction.buildModel(cn,$(e2))}),cn},a5.utils.noCache=function(aURL){return aURL=decodeURI(aURL),-1==aURL.indexOf("?")?aURL+="?no_cache="+Math.round(2e9*Math.random()):aURL+="&no_cache="+Math.round(2e9*Math.random()),aURL},a5.utils.array.Shuffle=function(arr){for(var a=[].concat(arr),newArray=[],aLength=a.length,i=0;i<aLength;i++){var l=Math.floor(Math.random()*a.length);newArray.push(a[l]),a.splice(l,1)}return newArray},a5.utils.array.swap=function(arr,pos1,pos2){var tmp=arr[pos1];arr[pos1]=arr[pos2],arr[pos2]=tmp},a5.utils.array.move=function(arr,pos1,pos2){var tmp=arr.splice(pos1,1)[0];arr.splice(pos2,0,tmp)},a5.utils.array.naturalSortComparator=function(a,b){var oFxNcL,oFyNcL,naturalSortComparator=a5.utils.array.naturalSortComparator,re=/(^([+-]?(?:\d*)(?:\.\d*)?(?:[eE][+-]?\d+)?)?$|^0x[\da-fA-F]+$|\d+)/g,sre=/^\s+|\s+$/g,snre=/\s+/g,dre=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/-]\d{1,4}[\/-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,hre=/^0x[0-9a-f]+$/i,ore=/^0/,i=function(s){return(naturalSortComparator.insensitive&&(""+s).toLowerCase()||""+s).replace(sre,"")},x=i(a)||"",y=i(b)||"",xN=x.replace(re,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),yN=y.replace(re,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),xD=parseInt(x.match(hre),16)||1!==xN.length&&Date.parse(x),yD=parseInt(y.match(hre),16)||xD&&y.match(dre)&&Date.parse(y)||null,normChunk=function(s,l){return(!s.match(ore)||1==l)&&parseFloat(s)||s.replace(snre," ").replace(sre,"")||0};if(yD){if(xD<yD)return-1;if(xD>yD)return 1}for(var cLoc=0,xNl=xN.length,yNl=yN.length,numS=Math.max(xNl,yNl);cLoc<numS;cLoc++){if(oFxNcL=normChunk(xN[cLoc]||"",xNl),oFyNcL=normChunk(yN[cLoc]||"",yNl),isNaN(oFxNcL)!==isNaN(oFyNcL))return isNaN(oFxNcL)?1:-1;if(typeof oFxNcL!=typeof oFyNcL&&(oFxNcL+="",oFyNcL+=""),oFxNcL<oFyNcL)return-1;if(oFxNcL>oFyNcL)return 1}return 0},a5.utils.array.naturalSort=function(arr,predicate,numerical,insensitive){a5.utils.array.naturalSortComparator.insensitive=insensitive;var newArray=_(arr).sortBy(predicate),numericalSort=function(a,b){return a=predicate?predicate(a):a,b=predicate?predicate(b):b,a5.utils.array.naturalSortComparator(a,b)};return numerical&&(newArray=newArray.sort(numericalSort)),newArray},a5.utils.array.sortBy=function(arr,predicate,numerical){var newArray=arr.slice(0),iteratee=_.iteratee(predicate);if(newArray.sort(function(a,b){var aVal=String(iteratee(a)),bVal=iteratee(b);return aVal.localeCompare(bVal)}),numerical){var index0=_(newArray).map(iteratee).indexOf("0"),index9=_(newArray).map(iteratee).indexOf("9");if(index0>=0&&index9>=0){var elem0=newArray[index0],elem9=newArray[index9];newArray.splice(index0,1),index9=_(newArray).indexOf(elem9),newArray.splice(index9,1,elem9,elem0)}var index10=_(newArray).map(iteratee).indexOf("10");if(index9=_(newArray).map(iteratee).indexOf("9"),index10>=0&&index9>=0){var elem10=newArray[index10];elem9=newArray[index9],newArray.splice(index10,1),index9=_(newArray).indexOf(elem9),newArray.splice(index9,1,elem9,elem10)}}return newArray},a5.utils.inRange=function(value,min,size){return value>=min&&value<=min+size},a5.utils.splitAndTrim=function(str,del){void 0===del&&(del="|");var arr=str.split(del),res=[];return arr.forEach(function(e){res.push($.trim(e))}),res},a5.utils.truncate=function(str,maxChars){return isNaN(maxChars)?str:(str.length>maxChars&&(str=$.trim(str).substring(0,maxChars).split(" ").slice(0,-1).join(" ")+"..."),str)},a5.utils.jquerySelectorEscape=function(str){return String(str).replace(/([ #;&,.+*~':"!^$[\]()=>|\/@])/g,"\\$1")},a5.utils.getPlainText=function(str){return str=$("<span>"+str+"</span>").text()},a5.utils.b64DecodeUnicode=function(str){return decodeURIComponent(Array.prototype.map.call(atob(str),function(c){return"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)}).join(""))},a5.utils.imageToBase64=function(original){var deferred=$.Deferred(),image=new Image;return image.crossOrigin="anonymous",image.onload=function(){var w=parseFloat(a5.utils.getStyleValue(original.getAttribute("style"),"width")),h=parseFloat(a5.utils.getStyleValue(original.getAttribute("style"),"height"));w>0&&image.setAttribute("width",w),h>0&&image.setAttribute("height",h);var canvas=document.createElement("canvas");canvas.width=image.width,canvas.height=image.height,canvas.getContext("2d").drawImage(this,0,0,image.width,image.height),deferred.resolve(canvas.toDataURL())},image.onerror=function(){deferred.reject()},image.src=a5.utils.noCache(original.src),deferred.promise()},a5.utils.encodeHTMLSpecialChars=function(str){var lookupTable={};lookupTable["&"]="&#38;",lookupTable["'"]="&#39;",lookupTable['"']="&#34;",lookupTable["<"]="&#60;",lookupTable[">"]="&#62;",lookupTable["Â£"]="&#163;";for(var item in lookupTable){var re=new RegExp(item,"gi");str=str.replace(re,lookupTable[item])}return str},a5.utils.decodeHTMLSpecialChars=function(str){var lookupTable={};lookupTable["&#38;"]="&",lookupTable["&#39;"]="'",lookupTable["&#34;"]='"',lookupTable["&#60;"]="<",lookupTable["&#62;"]=">",lookupTable["&#163;"]="Â£";for(var item in lookupTable){var re=new RegExp(item,"gi");str=str.replace(re,lookupTable[item])}return str},a5.utils.validateUserInput=_.memoize(function(str){var lookupTable={};if(lookupTable[8217]="'",lookupTable[160]=" ",str&&str.length>0)for(var item in lookupTable){var re=new RegExp(String.fromCharCode(item),"gi");str=str.replace(re,lookupTable[item])}return $.trim(str)}),a5.utils.placeLayer=function(element,layer,shift,dir,container){void 0===shift&&(shift=4);var elementPos=($("#content").width(),$("#content").height(),$("#content").position(),$(element).position()),xPos=elementPos.left,yPos=elementPos.top;layer.find("img").css("max-width",container.width()/2+"px"),layer.find("img").css("max-height",container.height()/2+"px"),1==dir&&(yPos=elementPos.top+$(element).height(),yPos+$(layer).height()>container.height()?yPos=elementPos.top-$(layer).height()-shift:yPos+=shift),2==dir&&(xPos=elementPos.left+$(element).width(),xPos+$(layer).width()>container.width()?xPos=elementPos.left-$(layer).width()-shift:xPos+=shift),layer.css("left",xPos+"px"),layer.css("top",yPos+"px")},a5.utils.placeLayerAbsolute=function(element,layer,align,xShift,yShift){void 0===xShift&&(xShift=4),void 0===yShift&&(yShift=4);var contentWidth=$("#content").width(),contentHeight=$("#content").height(),contentPos=$("#content").offset(),elementPos=$(element).offset(),xPos=($(layer).offset(),elementPos.left),yPos=elementPos.top;switch(align){case"left":xPos=elementPos.left-$(layer).width(),xPos<contentPos.left?(xPos=elementPos.left+$(element).width(),xPos+=xShift):xPos-=xShift;break;case"right":xPos=elementPos.left+$(element).width(),xPos+$(layer).width()>contentWidth?(xPos=elementPos.left-$(layer).width(),xPos-=xShift):xPos+=xShift;break;case"bottom":yPos=elementPos.top+$(element).height(),yPos+$(layer).height()>contentHeight?(yPos=elementPos.top-$(layer).height(),yPos-=yShift):yPos+=yShift;break;case"top":default:yPos=elementPos.top-$(layer).height(),yPos<contentPos.top?(yPos=elementPos.top+$(element).height(),yPos+=yShift):yPos-=yShift}layer.css("left",xPos+"px"),layer.css("top",yPos+"px")},a5.utils.secondsToTime=function(secs,paddingZeros){secs=Number(secs);var h=Math.floor(secs/3600),m=Math.floor(secs%3600/60),s=Math.floor(secs%3600%60);return paddingZeros?(h<10?"0":"")+h+":"+(m<10?"0":"")+m+":"+(s<10?"0":"")+s:(h>0?h+":":"")+(m>0?(h>0&&m<10?"0":"")+m+":":"0:")+(s<10?"0":"")+s},a5.utils.timeToSeconds=function(hhmmss){var hours,minutes,seconds,parts=hhmmss.split(":"),time=0;return hours=parts[0],minutes=parts[1],seconds=parts[2],time+=3600*parseFloat(hours),time+=60*parseFloat(minutes),time+=parseFloat(seconds)},a5.utils.secondsToCMITime=function(inputSeconds){var hours,minutes,seconds,inputIsNegative="";inputSeconds<0&&(inputIsNegative="-",inputSeconds=-inputSeconds),hours=Math.floor(inputSeconds/3600)%24,minutes=Math.floor(inputSeconds/60)%60,seconds=Math.floor(inputSeconds%60);var rtnStr=inputIsNegative+"PT";return hours>0&&(rtnStr+=hours+"H"),minutes>0&&(rtnStr+=minutes+"M"),rtnStr+seconds+"S"},a5.utils.getInteractionsGroups=function(list){return _.chain(list).pluck("group").unique().compact().value()},a5.utils.getCurrentCKCount=function(editor,maxLengthType){var txt=$.parseHTML(editor.getData())
;return a5.utils._countWordsOrChars($(txt).text(),maxLengthType)},a5.utils._countWordsOrChars=function(txt,maxLengthType){return"words"==maxLengthType?txt.split(/\s+/).length:txt.length},a5.utils._trimWordsOrChar=function(text,maxLengthType,maxLength){if("chars"!=maxLengthType){var words=text.split(/\s+/);return words=words.slice(0,maxLength),words.join(" ")}return text.substr(0,maxLength)},a5.utils.checkCKLength=function(evt){var maxLengthType=evt.editor.config.MaxLengthType,currentLength=a5.utils.getCurrentCKCount(evt.editor,maxLengthType),maximumLength=350;if(evt.editor.config.MaxLength&&(maximumLength=evt.editor.config.MaxLength),evt.editor.config.LockedInitialized||(evt.editor.config.LockedInitialized=1,evt.editor.config.Locked=0),"chars"!=maxLengthType&&(currentLength-=1),"paste"==evt.name){var html=$.parseHTML(evt.data.dataValue),text=$(html).text();if(currentLength+a5.utils._countWordsOrChars(text,maxLengthType)-1>=maximumLength){var trim_len=maximumLength-currentLength;evt.data.dataValue=a5.utils._trimWordsOrChar(text,maxLengthType,trim_len)}}var disallowed_keys=_.range(48,223);disallowed_keys=_.union([9,13,32],disallowed_keys),currentLength>=maximumLength&&disallowed_keys.indexOf(evt.data.keyCode)>-1&&evt.cancel(),a5.utils.showMaxCharsLabel(evt.editor.container.$,Math.max(0,maximumLength-currentLength))},a5.utils.showMaxCharsLabel=function(toNode,val){var node=$(".label-max-chars");node.length||(node=$("<div class='label-max-chars'></div>"),$("body").append(node));var pos=$(toNode).offset();node.css("left",+pos.left+"px"),node.css("top",+(pos.top-node.height())+"px"),node.text(val),node.show()},a5.utils.hideMaxCharsLabel=function(){$(".label-max-chars").hide()},a5.utils.setTextAreaMaxlength=function($node){var ignore=[8,9,13,33,34,35,36,37,38,39,40,46];$node=$node||$("body"),$node.find("textarea[maxchars], textarea[maxwords], input[maxchars], input[maxwords]").on("keypress input",function(event){var len,self=$(this),maxlength=self.attr("maxchars"),type="chars";void 0===maxlength&&(type="words",maxlength=self.attr("maxwords"));var code=$.data(this,"keycode");if(maxlength&&maxlength>0){if("chars"==type)return len=self.val().length,a5.utils.showMaxCharsLabel(this,Math.max(0,maxlength-len)),len<maxlength||-1!==$.inArray(code,ignore);return len=self.val().split(" ").length,a5.utils.showMaxCharsLabel(this,Math.max(0,maxlength-len)),len<=maxlength||-1!==$.inArray(code,ignore)}}).on("keydown",function(event){$.data(this,"keycode",event.keyCode||event.which)}),$("textarea[maxchars], textarea[maxwords], input[maxchars], input[maxwords]").focusout(function(){a5.utils.hideMaxCharsLabel()})};!function(){var counter=0;a5.utils.createUID=function(){return 1e3*+new Date+counter++}}(),a5.utils.getParents=function(obj){var rightArrowParents=[];return obj.parents().not("html").each(function(){var entry=this.tagName.toLowerCase();this.className&&(entry+="."+this.className.replace(/ /g,".")),rightArrowParents.push(entry)}),rightArrowParents.reverse(),rightArrowParents},a5.utils.removePunctuation=function(text){return text=text.replace(/[(,)(.)(!)(?)(;)(:)'`â?]/gi,"")},a5.utils.removeSpaces=function(text){return text=text.replace(/\s+/g,"")},a5.utils.removeAccents=function(text){for(var result="",lettermap={"Ã":"A","Ã":"A","Ã":"A","Ã":"A","Ã ":"a","Ã¡":"a","Ã¢":"a","Ã¤":"a","Ã":"s","Ã":"C","Ã§":"c","Ã":"E","Ã":"E","Ã":"E","Ã":"E","Ã¨":"e","Ã©":"e","Ãª":"e","Ã«":"e","Ã":"I","Ã":"I","Ã":"I","Ã":"I","Ã¬":"i","Ã­":"i","Ã®":"i","Ã¯":"i","Ã":"N","Ã±":"n","Ã":"O","Ã":"O","Ã":"O","Ã":"O","Ã²":"o","Ã³":"o","Ã´":"o","Ã¶":"o","Ã":"U","Ã":"U","Ã":"U","Ã":"U","Ã¹":"u","Ãº":"u","Ã»":"u","Ã¼":"u"},i=0;i<text.length;i++)void 0!==lettermap[text[i]]?result+=lettermap[text[i]]:result+=text[i];return result},a5.utils.containsAnswer=function(userInput,correctAnswers,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces){return!!_.find(correctAnswers,function(correctAnswer){return a5.utils.checkUserInput(userInput,correctAnswer,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces)})},a5.utils.countAnswer=function(userInput,correctAnswers,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces){return _.filter(correctAnswers,function(correctAnswer){return a5.utils.checkUserInput(userInput,correctAnswer,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces)}).length},a5.utils.indexOf=function(userInput,correctAnswers,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces){var correctIndex=-1;return userInput&&_.each(correctAnswers,function(correctAnswer,index){correctIndex<0&&a5.utils.checkUserInput(userInput,correctAnswer,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces)&&(correctIndex=index)}),correctIndex},a5.utils.checkUserInput=function(userInput,correctAnswer,ignoreCase,ignorePunctuation,ignoreAccents,ignoreSpaces){return userInput=a5.utils.validateUserInput(userInput),correctAnswer=a5.utils.validateUserInput(correctAnswer),"%0"===correctAnswer&&(correctAnswer="",userInput=userInput.trim()),ignoreCase&&(correctAnswer=correctAnswer.toLowerCase(),userInput=userInput.toLowerCase()),ignorePunctuation&&(correctAnswer=window.a5.utils.removePunctuation(correctAnswer),userInput=window.a5.utils.removePunctuation(userInput)),ignoreAccents&&(correctAnswer=window.a5.utils.removeAccents(correctAnswer),userInput=window.a5.utils.removeAccents(userInput)),ignoreSpaces&&(correctAnswer=window.a5.utils.removeSpaces(correctAnswer),userInput=window.a5.utils.removeSpaces(userInput)),correctAnswer==userInput},a5.utils.scramble=function(src){var scrambled=src.match(/\*s\*([\w\s\b])+\*s\*/g);return null!=scrambled&&_.each(scrambled,function(s){var text=s.replace(/\*s\*/g,"");src=src.replace(s,a5.utils.scrambleText(text))}),src},a5.utils.scrambleText=function(text){var sep=" ";return-1===text.indexOf(" ")&&(sep=""),_.shuffle(text.split(sep)).join(sep)},a5.utils.seconds_to_text=function(s){var second=s%60,minute=Math.floor(s/60%60);return _.isNaN(second)&&(second=0),_.isNaN(minute)&&(minute=0),minute<10&&(minute="0"+minute),second<10&&(second="0"+second),minute+":"+second},a5.utils.getStyleValue=function(style,key){";"!==style[style.length-1]&&(style+=";");var pos_1=style.indexOf(key),styleVal="";if(pos_1>-1){var pos_2=style.indexOf(":",pos_1),pos_3=style.indexOf(";",pos_1);styleVal=$.trim(style.substring(pos_2+1,pos_3))}return styleVal},a5.utils.capitalize=function(text){return text.substring(0,1).toUpperCase()+text.substring(1)},a5.utils.firstCharToLowerCase=function(text){return text.substring(0,1).toLowerCase()+text.substring(1)},a5.utils.getCSSAttributeFromCSS=function(parent,className,attr,style){var id=_.uniqueId("tmp_"),ret=$("<div id='"+id+"'></div>").addClass(className).css(style||{});return $(parent).append(ret),ret=$(parent).find("#"+id).css(attr),$(parent).find("#"+id).remove(),ret},a5.utils.bindDoubleClick=function(node,callback){var hammer=new Hammer.Manager(node,{}),doubleTap=new Hammer.Tap({event:"doubletap",taps:2});hammer.add(doubleTap),hammer.on("doubletap",callback)}}(),a5.utils.elementOverlapArea=function(e1,e2){var d0=e1.offset(),d1=e2.offset(),d1x=d0.left,d1y=d0.top,d1xMax=d0.left+e1.width(),d1yMax=d0.top+e1.height(),d2x=d1.left,d2y=d1.top,d2xMax=d1.left+e2.width(),d2yMax=d1.top+e2.height();return Math.max(0,Math.min(d1xMax,d2xMax)-Math.max(d1x,d2x))*Math.max(0,Math.min(d1yMax,d2yMax)-Math.max(d1y,d2y))},a5.utils.elementOverlapAreaPercent=function(e1,e2){return a5.utils.elementOverlapArea(e1,e2)/Math.min(e1.width()*e1.height(),e2.width()*e2.height())},a5.utils.doElementsOverlap=function(e1,e2){return a5.utils.elementOverlapArea(e1,e2)>0},a5.utils.findIndex=function(obj,iterator,context){var result=null;return _.any(obj,function(value,index,list){if(iterator.call(context,value,index,list))return result=index,!0}),result},a5.utils.swap=function(arr,pos1,pos2){var tmp=arr[pos1];arr[pos1]=arr[pos2],arr[pos2]=tmp},$(function(){var dont_hide_td=function(interaction){interaction.$("td.opt-021-hidden").each(function(){var $td=$(this),$wrap=$("<div>",{class:"opt-021-hidden","data-opt-021-prio":$td.attr("data-opt-021-prio")});$td.wrapInner($wrap),$td.removeClass("opt-021-hidden"),$td.removeAttr("data-opt-021-prio")})};a5.hooks.interactionShowed.add(dont_hide_td)}),function($){$.fn.measure=function(attr,appendTo){var element=$(this).clone(!1);element.css("display","absolute"),element.css("visibility","hidden"),element.appendTo(appendTo||document.body);var result=element.css(attr);return element.remove(),result},$.fn.zoom=function(scale){var newCss={zoom:scale};"WebkitTransform"in document.body.style?newCss={"-webkit-transform":"scale("+scale+")","-webkit-transform-origin":"left top"}:"transform"in document.body.style&&(newCss={transform:"scale("+scale+")","transform-origin":"left top"}),$(this).css(newCss)}}(jQuery),a5.utils.startsWith=function(str,prefix){return 0==str.indexOf(prefix)},a5.utils.endsWith=function(str,suffix){return-1!==str.indexOf(suffix,str.length-suffix.length)},a5.utils.splitUnescaped=function(str,separator){var regex=new RegExp("\\"+separator+"(?!\\\\)","g");return _(_.str.reverse(str).split(regex).reverse()).map(function(m){return _.str.reverse(m)})},a5.utils.containsUnescaped=function(str,character){return str.replace("\\"+character,"").indexOf(character)>=0},a5.utils.unescapeReservedSyntaxSymbols=function(str){var reserved=["|","@","#","*","\\","{","}","[","]"];return _(reserved).each(function(c){str=str.replace("\\"+c,c)}),str},a5.utils.supportHTML5Download=function(){return _.has($("<a>")[0],"download")},a5.utils.mergeObjects=function(objects){return objects=[{}].concat(objects),_.extend.apply(_,objects)},a5.utils.asMap=function(items){var nmap={};return _.each(items,function(item){if(2==item.length){var key=item[0],value=item[1];nmap.hasOwnProperty(key)||(nmap[key]=[]),nmap[key].push(value)}}),nmap},a5.utils.asInverseMap=function(items){var nmap={};return _.each(items,function(item){if(2==item.length){var value=item[0],key=item[1];nmap.hasOwnProperty(key)||(nmap[key]=[]),nmap[key].push(value)}}),nmap},a5.utils.getRandomSubstring=function(string,delimeter){return string=string||"",delimeter=delimeter||"|",_.sample(string.split(delimeter))},a5.utils.requestAnimationFrame=function(callback){var f=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)};return _.bind(f,window)}(),a5.utils.postForm=function(url,data){var $form=$('<form method="post" target="_blank"></form>').attr("action",url);_.each(data,function(attr){$('<input type="hidden"/>').appendTo($form).prop("name",attr.name).val(attr.value)},this),$form.submit()},a5.utils.getDraggableOptions=function(interaction){return _.isFunction(a5.dp.config.draggableOptions)?a5.dp.config.draggableOptions(interaction):a5.dp.config.draggableOptions},a5.utils.isNumeric=function(n){return/^([1-9]\d*|0)([.,]\d+)?$/.test(n)},a5.utils.isInteger=function(n){return/^([1-9]\d*|0)$/.test(n)},a5.utils.Timer=function(){var Timer=function(){this._stamp=window.performance.now(),this.running=!0};return _(Timer.prototype).extend({stamp:function(){var new_stamp=window.performance.now(),diff=new_stamp-this._stamp;return this._stamp=new_stamp,this._stopAt=null,this.running=!0,diff},stop:function(){this._stopAt=this._stopAt||window.performance.now(),this.running=!1},isRunning:function(){return this.running},getTime:function(){return(this._stopAt||window.performance.now())-this._stamp},getTimeString:function(time){var t=time||this.getTime();return a5.utils.secondsToTime(Math.round(t/1e3))},getCMITimeString:function(time){var t=time||this.getTime();return a5.utils.secondsToCMITime(Math.round(t/1e3))},stringStamp:function(){return a5.utils.secondsToTime(this.stamp()/1e3)},cmiStringStamp:function(){return a5.utils.secondsToCMITime(this.stamp()/1e3)}}),Timer}(),a5.utils.TimerOut=function(){var TimerOut=function(delay,callback,imediateStart){this.paused=null,this.callback=callback,this.delay=this.remaining=delay,void 0===imediateStart&&(imediateStart=!0),imediateStart&&this.initTimer(this.delay,this.callback)};return _(TimerOut.prototype).extend({initTimer:function(){this.countDownTimer=setTimeout(_.bind(function(){this.paused=this.start=null,this.remaining=0,this.callback.call()},this),this.remaining),this.start=new Date,this.paused=!1},stop:function(){clearTimeout(this.countDownTimer),this.paused=this.start=null},pause:function(){if(this.start&&!1===this.paused){clearTimeout(this.countDownTimer);var now=new Date;this.remaining=this.remaining-(now-this.start),this.paused=!0}},resume:function(){this.start&&!0===this.paused&&(clearTimeout(this.countDownTimer),this.initTimer())},reset:function(){this.remaining=this.delay,clearTimeout(this.countDownTimer),this.initTimer()},isRunning:function(){return!1===this.paused}}),TimerOut}(),a5.utils.TaskTimer=function(){var Timer=function(options){this.options=_.extend({delay:0,duration:0,onStart:_.noop,onEnd:_.noop},options),this.options.duration>0&&(this.options.onStart=_.wrap(this.options.onStart,_.bind(function(fn){fn(),this.timerDelayedEnd=_.delay(this.options.onEnd,this.options.duration)},this)))};return _(Timer.prototype).extend({start:function(){this.timerDelayedStart=_.delay(this.options.onStart,this.options.delay)},stop:function(){this.timerDelayedStart&&clearTimeout(this.timerDelayedStart),this.timerDelayedEnd&&clearTimeout(this.timerDelayedEnd),this.options.onEnd()}}),Timer}(),a5.utils.Lock=function(){var Lock=function(){this.__lock=!1};return _(Lock.prototype).extend({lock:function(){this.__lock=!0},unlock:function(){this.__lock=!1},isLocked:function(){return this.__lock}}),Lock}(),a5.utils.scrollParent=function(node){var $parent=node.scrollParent(),offset=$parent.offset();return $parent.get(0)===document?{top:$(window).scrollTop(),left:$(window).scrollLeft(),width:$(window).width(),height:$(window).height()}:{top:offset.top,left:offset.left,width:$parent.width(),height:$parent.height()}},a5.utils.isVisible=function(node){return a5.utils.isVisibleHorizontally(node)&&a5.utils.isVisibleVertically(node)},a5.utils.isVisibleHorizontally=function(node){var rect=node[0].getBoundingClientRect(),scrollParent=node.scrollParent();if(scrollParent[0]===document)return rect.left>=0&&rect.right<=(window.innerWidth||document.documentElement.clientWidth);var scrollRect=scrollParent[0].getBoundingClientRect();return rect.left>=scrollRect.left&&rect.right<=scrollRect.right},a5.utils.isVisibleVertically=function(node){var rect=node[0].getBoundingClientRect(),scrollParent=node.scrollParent();if(scrollParent[0]===document)return rect.top>=0&&rect.bottom<=(window.innerHeight||document.documentElement.clientHeight)-a5.dp.config.exclusionBottom;var scrollRect=scrollParent[0].getBoundingClientRect();return rect.top>=scrollRect.top&&rect.bottom<=scrollRect.bottom},a5.utils.scrollIntoElementIfNeeded=function(node,options){if(!a5.utils.isVisible(node)){var ua,position=a5.utils.anchoredPosition(node);if(options&&"start"===options.block&&("sticky"===position||"fixed"===position&&(ua=a5.utils.parseUserAgent(),ua.isSafari||ua.isIOS))){var $parent=node.scrollParent();$parent.get(0).scrollBy({top:node.offset().top-$parent.offset().top,behavior:"smooth"})}else node.get(0).scrollIntoView("object"!=typeof options||options)}},a5.utils.anchoredPosition=function(node){var position=node.css("position");return"sticky"===position||"fixed"===position?position:!node.is("html")&&a5.utils.anchoredPosition(node.offsetParent())},a5.utils.setPersistentKey=function(key,value){try{value?sessionStorage.setItem(key,value):sessionStorage.removeItem(key)}catch(e){logger.warn(e)}},a5.utils.getPersistentKey=function(key){var ret;try{ret=sessionStorage.getItem(key)}catch(e){logger.warn(e)}return ret},a5.utils.trignHelper={QUADRANTS:{TOPLEFT:0,TOPRIGHT:1,BOTTOMLEFT:3,BOTTOMRIGHT:2},RECT_ANG:90,QUAD_TO_NAME:function(quad){var whichQuad=_.filter(_.keys(this.QUADRANTS),function(quadName){return a5.utils.trignHelper.QUADRANTS[quadName]===quad});if(whichQuad.length>0)return whichQuad[0]},DEGR_TO_RAD:function(angle){return angle*Math.PI/180},RAD_TO_DEGR:function(radians){return 180*radians/Math.PI},DEGR_TO_QUAD:function(deg){var rad=this.DEGR_TO_RAD(deg);switch(!0){case Math.sin(rad)>=0&&Math.cos(rad)>=0:return this.QUADRANTS.TOPLEFT;case Math.sin(rad)>=0&&Math.cos(rad)<0:return this.QUADRANTS.TOPRIGHT;case Math.sin(rad)<0&&Math.cos(rad)>=0:return this.QUADRANTS.BOTTOMLEFT;case Math.sin(rad)<0&&Math.cos(rad)<0:return this.QUADRANTS.BOTTOMRIGHT}},DESTINATION_FROM_ANGLE:function(ang,speed,orig,dest){var dist,cos=Math.cos(ang),sin=Math.sin(ang),lengthToY=Math.abs(dest.y-orig.y)/Math.abs(sin),lengthToX=Math.abs(dest.x-orig.x)/Math.abs(cos),time=Math.min(lengthToY,lengthToX);if(lengthToY<lengthToX){dist=Math.abs(dest.y-orig.y)/Math.abs(sin),dest.x=orig.x+time*cos}else{dist=Math.abs(dest.x-orig.x)/Math.abs(cos),dest.y=orig.y+time*sin}return dest.time=dist/speed,dest.dist=dist,dest},BOUNCE_ANGLE:function(bounceRect,position,angle){var newAngle=angle,bouncedX=Math.ceil(position.x)>=Math.ceil(bounceRect.right)||Math.ceil(position.x)<=Math.ceil(bounceRect.left),bouncedY=Math.ceil(position.y)>=Math.ceil(bounceRect.bottom)||Math.ceil(position.y)<=Math.ceil(bounceRect.top);if(bouncedX&&bouncedY){var randomRange=5;randomRange=Math.random()*randomRange-randomRange/2,newAngle=(2*this.RECT_ANG+angle)%(4*this.RECT_ANG)+randomRange}else bouncedX?newAngle=2*this.RECT_ANG-angle:bouncedY&&(newAngle=4*this.RECT_ANG-angle);return newAngle},POINT_TO_ANGLE:function(cx,cy,ex,ey){var dy=ey-cy,dx=ex-cx,theta=Math.atan2(dy,dx);return theta*=180/Math.PI}},a5.utils.resizeText=function(nodes){var el,elements,_i,_len,_results;if(elements=$(nodes),!(elements.length<0)){for(_results=[],_i=0,_len=elements.length;_i<_len;_i++)el=elements[_i],_results.push(function(el){var resizeText,_results1;for(resizeText=function(){var elNewFontSize;return elNewFontSize=parseInt($(el).css("font-size").slice(0,-2),10)-1+"px",$(el).css({"font-size":elNewFontSize,"line-height":"normal"})},_results1=[];el.scrollHeight>el.offsetHeight;)_results1.push(resizeText());return _results1}(el));return _results}},a5.utils.getCrosswordCellWidth=function(){var size=window.a5.mainBuilder.layout.getTemplate("crossword-cell-size");size||(size=a5.utils.getCSSAttributeFromCSS(".ic-crossword .cell","cell","width"));var cellWidth=parseFloat(size),cellUnit=size.replace(cellWidth,"").toLowerCase()||"px";return"px"===cellUnit&&(cellWidth-=1),{width:cellWidth,unit:cellUnit}},a5.utils.applySVGClipPathFix=function(html){for(var matches,id=a5.utils.createUID(),ids=[],re=/<clipPath id="([^"]+)"/gi;matches=re.exec(html);)ids.push(matches[1]);return ids.forEach(function(current,i){html=html.replace(new RegExp(current,"gi"),id+"-"+i)}),html},a5.utils.applySVGGradientFix=function(html){for(var matches,id=a5.utils.createUID(),i=0,re=/<linearGradient id="([^"]+)"/gi;matches=re.exec(html);)html=html.replace(new RegExp(matches[1],"gi"),id+"-"+i++);for(re=/<radialGradient id="([^"]+)"/gi;matches=re.exec(html);)html=html.replace(new RegExp(matches[1],"gi"),id+"-"+i++);var ids=[];for(re=/<use [^>]*href="#([^"]+)"/gi;matches=re.exec(html);)ids.push(matches[1]);return ids.forEach(function(current,j){html=html.replace(new RegExp(current,"gi"),id+"-"+(i+j))}),html=html.replace(/svgc/g,"c"+id)},a5.utils.applySVGIE11Fix=function(){(window.ActiveXObject||"ActiveXObject"in window)&&$("use").each(function(){this.href.baseVal=this.href.baseVal})},a5.utils.isDocumentOverMobileBreakpoint=function(){return window.innerWidth>a5.dp.config.mobileBreakpoint},a5.utils.benchmark=function(){var text="Event\tStartTime\tDuration\n";text+=function(){var measure=_.find(performance.getEntriesByType("measure"),function(measure){return measure.name==="render_"+_.first(a5.mainBuilder.intList).url});return"RenderFirstScreen\t0\t"+(measure.startTime+measure.duration)+"\n"}();var measures=performance.getEntriesByType("measure");return _.each(measures,function(measureItem){text+=measureItem.name+"\t"+measureItem.startTime+"\t"+measureItem.duration+"\n"}),text},a5.utils.benchmarkFile=function(){var benchmark=a5.utils.benchmark(),filename="EngineBenchmark_"+(new Date).getTime()+".csv";if(benchmark){var blob=new Blob([benchmark],{type:"text/csv;charset=utf-8"});blob&&window.saveAs(blob,filename)}},a5.utils.serializeXML=function(xml){return(new XMLSerializer).serializeToString(xml)},a5.utils.parseUserAgent=function(){function check(r){return r.test(navigator.userAgent.toLowerCase())}var userAgent={isStrict:"CSS1Compat"==document.compatMode,isOpera:check(/opera/),isChrome:check(/\bchrome\b/),isSafari:check(/safari/),isWebKit:check(/webkit/),isGecko:check(/gecko/),isFirefox:check(/firefox/),isWindows:check(/windows|win32/),isMac:check(/macintosh|mac os x/),isAir:check(/adobeair/),isIE11:check(/trident/)&&check(/rv:11/),isEdge:check(/edge/),isLinux:check(/linux/),isSecure:/^https/i.test(window.location.protocol),isPhantom:check(/phantomjs/),isIpad:check(/ipad/),isAndroid:check(/android/),isIOS:check(/ipad|iphone|ipod/),isQt:check(/qtwebengine/),isIpadOS:"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1};return userAgent.isIpad=userAgent.isIpad||userAgent.isIpadOS,userAgent.isMac=userAgent.isMac&&!userAgent.isIpad,userAgent.isSafari=userAgent.isSafari&&!userAgent.isChrome&&!userAgent.isEdge,userAgent.isChrome=userAgent.isChrome&&!userAgent.isEdge,userAgent.isGecko=userAgent.isGecko&&!userAgent.isWebKit&&!userAgent.isEdge,userAgent},a5.utils.deepClone=function(obj){return JSON.parse(JSON.stringify(obj)||null)},a5.utils.enumText=function(enumString){return $(enumString,{}).text()||enumString},a5.utils.knapsack=function(){return{resolve:function(capacity,items){var itemsFiltered,result=[],leftCap=capacity;if("number"!=typeof capacity)return!1;if(!(items&&items instanceof Array))return!1;var item,itemKey,itemVal,itemObj;itemsFiltered=items.filter(function(value){return itemVal="object"==typeof value?value[Object.keys(value)[0]]:null,!isNaN(itemVal)&&itemVal>0&&itemVal<=capacity}),itemsFiltered.sort(function(a,b){return a[Object.keys(a)[0]]<b[Object.keys(b)[0]]});for(item in itemsFiltered)if(itemsFiltered.hasOwnProperty(item)&&(itemKey=Object.keys(itemsFiltered[item])[0],itemVal=itemsFiltered[item][itemKey],leftCap-itemVal>=0&&(leftCap-=itemVal,itemObj=Object.create(null),itemObj[itemKey]=itemVal,result.push(itemObj),delete itemsFiltered[item],leftCap<=0)))break;return result}}}(),a5.utils.getLabels=function($button,states,options){options=options||{};var ret={},$label=$button.find(".button__label"),defaultLabel=options.noDefaultText?void 0:$label.length?$label.text():$button.text();return _.each(states,function(state){ret[state]=$button.attr(["data",state,"label"].join("-"))||defaultLabel}),ret},a5.utils.setLabel=function($button,text){var $label=$button.find(".button__label");$label.length?$label.text(text):$button.text(text),$button.attr("aria-label",text)},a5.utils.getLabel=function($button){var $label=$button.find(".button__label");return $label.length?$label.text():$button.text()},a5.utils.preloadResource=function(url,type){var link=document.createElement("link");link.href=url,link.rel="preload",link.as=type,document.head.appendChild(link)},a5.utils.preventTextSelection=function(){$(document).on("selectstart.forbidden",function(e){e.preventDefault()})},a5.utils.allowTextSelection=function(){$(document).off("selectstart.forbidden")},a5.utils.convertPTtoPXat96DPI=function(pt){return pt*window.devicePixelRatio*1.33},a5.utils.findInNodes=function(selector,nodes){var $result=$();if(!nodes)return $result;if(_.isArray(nodes)||(nodes=[nodes]),nodes.length){var i=0;do{$result=nodes[i].is(selector)?nodes[i]:nodes[i].find(selector),i++}while(!$result.length&&i<nodes.length)}return $result},a5.utils.setContentInNodes=function(content,selector,nodes){var $target=a5.utils.findInNodes(selector,nodes),$content=$(content);return $target.is(selector)?$target.replaceWith($content):$target.empty().append($content),$content},a5.utils.keyCodes={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},a5.utils.wrapFirstLetter=function($node,$wrap){var text=this.findFirstLetter($node),regex=/^\P{Letter}*\p{Letter}/u;if(text){var match=text.textContent.match(regex);match&&($(text).before($wrap||$('<span class="firstletter">').text(match[0])),text.textContent=text.textContent.replace(regex,""))}},a5.utils.findFirstLetter=function($node){return _.find($node.contents().map(function(_,node){return node.nodeType===Node.TEXT_NODE&&/\w/.test(node.textContent)?node:node.nodeType!==Node.ELEMENT_NODE||"style"!==node.tagName?this.findFirstLetter($(node)):void 0}.bind(this)))},a5.utils.MathParser=function(){"use strict";function peg$SyntaxError(message,expected,found,location){this.message=message,this.expected=expected,this.found=found,this.location=location,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,peg$SyntaxError)}!function(child,parent){function ctor(){this.constructor=child}ctor.prototype=parent.prototype,child.prototype=new ctor}(peg$SyntaxError,Error),peg$SyntaxError.buildMessage=function(expected,found){var DESCRIBE_EXPECTATION_FNS={literal:function(expectation){return'"'+literalEscape(expectation.text)+'"'},class:function(expectation){var i,escapedParts="";for(i=0;i<expectation.parts.length;i++)escapedParts+=expectation.parts[i]instanceof Array?classEscape(expectation.parts[i][0])+"-"+classEscape(expectation.parts[i][1]):classEscape(expectation.parts[i]);return"["+(expectation.inverted?"^":"")+escapedParts+"]"},any:function(expectation){return"any character"},end:function(expectation){return"end of input"},other:function(expectation){return expectation.description}};function hex(ch){return ch.charCodeAt(0).toString(16).toUpperCase()}function literalEscape(s){return s.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(ch){return"\\x0"+hex(ch)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(ch){return"\\x"+hex(ch)})}function classEscape(s){return s.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(ch){return"\\x0"+hex(ch)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(ch){return"\\x"+hex(ch)})}function describeExpectation(expectation){return DESCRIBE_EXPECTATION_FNS[expectation.type](expectation)}return"Expected "+function(expected){var i,j,descriptions=new Array(expected.length);for(i=0;i<expected.length;i++)descriptions[i]=describeExpectation(expected[i]);if(descriptions.sort(),descriptions.length>0){for(i=1,j=1;i<descriptions.length;i++)descriptions[i-1]!==descriptions[i]&&(descriptions[j]=descriptions[i],j++);descriptions.length=j}switch(descriptions.length){case 1:return descriptions[0];case 2:return descriptions[0]+" or "+descriptions[1];default:return descriptions.slice(0,-1).join(", ")+", or "+descriptions[descriptions.length-1]}}(expected)+" but "+function(found){return found?'"'+literalEscape(found)+'"':"end of input"}(found)+" found."};function peg$parse(input,options){options=void 0!==options?options:{};var peg$result,peg$FAILED={},peg$startRuleFunctions={LogicComparisson:peg$parseLogicComparisson},peg$startRuleFunction=peg$parseLogicComparisson,peg$c0="&&",peg$c1=peg$literalExpectation("&&",!1),peg$c2="||",peg$c3=peg$literalExpectation("||",!1),peg$c4=function(head,tail){var i,result=head;for(i=0;i<tail.length;i++)"&&"===tail[i][1]&&(result=result&&tail[i][3]),"||"===tail[i][1]&&(result=result||tail[i][3]);return result},peg$c5="(",peg$c6=peg$literalExpectation("(",!1),peg$c7=")",peg$c8=peg$literalExpectation(")",!1),peg$c9=function(expr){return expr},peg$c10="<=",peg$c11=peg$literalExpectation("<=",!1),peg$c12=">=",peg$c13=peg$literalExpectation(">=",!1),peg$c14="==",peg$c15=peg$literalExpectation("==",!1),peg$c16="!=",peg$c17=peg$literalExpectation("!=",!1),peg$c18="<",peg$c19=peg$literalExpectation("<",!1),peg$c20=">",peg$c21=peg$literalExpectation(">",!1),peg$c22=function(head,tail){var i,result=head;for(i=0;i<tail.length;i++)"<="===tail[i][1]&&(result=result<=tail[i][3]),">="===tail[i][1]&&(result=result>=tail[i][3]),"=="===tail[i][1]&&(result=result==tail[i][3]),"!="===tail[i][1]&&(result=result!=tail[i][3]),">"===tail[i][1]&&(result=result>tail[i][3]),"<"===tail[i][1]&&(result=result<tail[i][3]);return result},peg$c23="+",peg$c24=peg$literalExpectation("+",!1),peg$c25="-",peg$c26=peg$literalExpectation("-",!1),peg$c27=function(head,tail){var i,result=head;for(i=0;i<tail.length;i++)"+"===tail[i][1]&&(result+=tail[i][3]),"-"===tail[i][1]&&(result-=tail[i][3]);return result},peg$c28="*",peg$c29=peg$literalExpectation("*",!1),peg$c30="/",peg$c31=peg$literalExpectation("/",!1),peg$c32=function(head,tail){var i,result=head;for(i=0;i<tail.length;i++)"*"===tail[i][1]&&(result*=tail[i][3]),"/"===tail[i][1]&&(result/=tail[i][3]);return result},peg$c33=peg$otherExpectation("float"),peg$c34=/^[0-9]/,peg$c35=peg$classExpectation([["0","9"]],!1,!1),peg$c36=".",peg$c37=peg$literalExpectation(".",!1),peg$c38="e",peg$c39=peg$literalExpectation("e",!1),peg$c40=function(){return parseFloat(text(),10)},peg$c41=peg$otherExpectation("NaN"),peg$c42="NaN",peg$c43=peg$literalExpectation("NaN",!1),peg$c44=function(){return NaN},peg$c45=peg$otherExpectation("whitespace"),peg$c46=/^[ \t\n\r]/,peg$c47=peg$classExpectation([" ","\t","\n","\r"],!1,!1),peg$currPos=0,peg$savedPos=0,peg$posDetailsCache=[{line:1,column:1}],peg$maxFailPos=0,peg$maxFailExpected=[],peg$silentFails=0;if("startRule"in options){if(!(options.startRule in peg$startRuleFunctions))throw new Error("Can't start parsing from rule \""+options.startRule+'".');peg$startRuleFunction=peg$startRuleFunctions[options.startRule]}function text(){return input.substring(peg$savedPos,peg$currPos)}function peg$literalExpectation(text,ignoreCase){return{type:"literal",text:text,ignoreCase:ignoreCase}}function peg$classExpectation(parts,inverted,ignoreCase){return{type:"class",parts:parts,inverted:inverted,ignoreCase:ignoreCase}}function peg$otherExpectation(description){return{type:"other",description:description}}function peg$computePosDetails(pos){var p,details=peg$posDetailsCache[pos];if(details)return details;for(p=pos-1;!peg$posDetailsCache[p];)p--;for(details=peg$posDetailsCache[p],details={line:details.line,column:details.column};p<pos;)10===input.charCodeAt(p)?(details.line++,details.column=1):details.column++,p++;return peg$posDetailsCache[pos]=details,details}function peg$computeLocation(startPos,endPos){var startPosDetails=peg$computePosDetails(startPos),endPosDetails=peg$computePosDetails(endPos);return{start:{offset:startPos,line:startPosDetails.line,column:startPosDetails.column},end:{offset:endPos,line:endPosDetails.line,column:endPosDetails.column}}}function peg$fail(expected){peg$currPos<peg$maxFailPos||(peg$currPos>peg$maxFailPos&&(peg$maxFailPos=peg$currPos,peg$maxFailExpected=[]),peg$maxFailExpected.push(expected))}function peg$buildStructuredError(expected,found,location){return new peg$SyntaxError(peg$SyntaxError.buildMessage(expected,found),expected,found,location)}function peg$parseLogicComparisson(){var s0,s1,s2,s3,s4,s5,s6,s7;if(s0=peg$currPos,(s1=peg$parseLogicComparator())!==peg$FAILED){for(s2=[],s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(input.substr(peg$currPos,2)===peg$c0?(s5=peg$c0,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c1)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c2?(s5=peg$c2,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c3))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseLogicComparator(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,
s3=peg$FAILED);s3!==peg$FAILED;)s2.push(s3),s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(input.substr(peg$currPos,2)===peg$c0?(s5=peg$c0,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c1)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c2?(s5=peg$c2,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c3))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseLogicComparator(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c4(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseLogicComparator(){var s0,s1,s2,s3,s4,s5;return s0=peg$parseComparison(),s0===peg$FAILED&&(s0=peg$currPos,40===input.charCodeAt(peg$currPos)?(s1=peg$c5,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c6)),s1!==peg$FAILED?(s2=peg$parse_(),s2!==peg$FAILED?(s3=peg$parseLogicComparisson(),s3!==peg$FAILED?(s4=peg$parse_(),s4!==peg$FAILED?(41===input.charCodeAt(peg$currPos)?(s5=peg$c7,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c8)),s5!==peg$FAILED?(peg$savedPos=s0,s1=peg$c9(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)),s0}function peg$parseComparison(){var s0,s1,s2,s3,s4,s5,s6,s7;if(s0=peg$currPos,(s1=peg$parseComparator())!==peg$FAILED){for(s2=[],s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(input.substr(peg$currPos,2)===peg$c10?(s5=peg$c10,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c11)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c12?(s5=peg$c12,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c13)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c14?(s5=peg$c14,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c15)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c16?(s5=peg$c16,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c17)),s5===peg$FAILED&&(60===input.charCodeAt(peg$currPos)?(s5=peg$c18,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c19)),s5===peg$FAILED&&(62===input.charCodeAt(peg$currPos)?(s5=peg$c20,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c21))))))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseComparator(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s3!==peg$FAILED;)s2.push(s3),s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(input.substr(peg$currPos,2)===peg$c10?(s5=peg$c10,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c11)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c12?(s5=peg$c12,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c13)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c14?(s5=peg$c14,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c15)),s5===peg$FAILED&&(input.substr(peg$currPos,2)===peg$c16?(s5=peg$c16,peg$currPos+=2):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c17)),s5===peg$FAILED&&(60===input.charCodeAt(peg$currPos)?(s5=peg$c18,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c19)),s5===peg$FAILED&&(62===input.charCodeAt(peg$currPos)?(s5=peg$c20,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c21))))))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseComparator(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c22(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseComparator(){var s0,s1,s2,s3,s4,s5;return s0=peg$parseExpression(),s0===peg$FAILED&&(s0=peg$currPos,40===input.charCodeAt(peg$currPos)?(s1=peg$c5,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c6)),s1!==peg$FAILED?(s2=peg$parse_(),s2!==peg$FAILED?(s3=peg$parseComparison(),s3!==peg$FAILED?(s4=peg$parse_(),s4!==peg$FAILED?(41===input.charCodeAt(peg$currPos)?(s5=peg$c7,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c8)),s5!==peg$FAILED?(peg$savedPos=s0,s1=peg$c9(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)),s0}function peg$parseExpression(){var s0,s1,s2,s3,s4,s5,s6,s7;if(s0=peg$currPos,(s1=peg$parseTerm())!==peg$FAILED){for(s2=[],s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(43===input.charCodeAt(peg$currPos)?(s5=peg$c23,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c24)),s5===peg$FAILED&&(45===input.charCodeAt(peg$currPos)?(s5=peg$c25,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c26))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseTerm(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s3!==peg$FAILED;)s2.push(s3),s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(43===input.charCodeAt(peg$currPos)?(s5=peg$c23,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c24)),s5===peg$FAILED&&(45===input.charCodeAt(peg$currPos)?(s5=peg$c25,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c26))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseTerm(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c27(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseTerm(){var s0,s1,s2,s3,s4,s5,s6,s7;if(s0=peg$currPos,(s1=peg$parseFactor())!==peg$FAILED){for(s2=[],s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(42===input.charCodeAt(peg$currPos)?(s5=peg$c28,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c29)),s5===peg$FAILED&&(47===input.charCodeAt(peg$currPos)?(s5=peg$c30,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c31))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseFactor(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s3!==peg$FAILED;)s2.push(s3),s3=peg$currPos,s4=peg$parse_(),s4!==peg$FAILED?(42===input.charCodeAt(peg$currPos)?(s5=peg$c28,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c29)),s5===peg$FAILED&&(47===input.charCodeAt(peg$currPos)?(s5=peg$c30,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c31))),s5!==peg$FAILED?(s6=peg$parse_(),s6!==peg$FAILED?(s7=peg$parseFactor(),s7!==peg$FAILED?(s4=[s4,s5,s6,s7],s3=s4):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED)):(peg$currPos=s3,s3=peg$FAILED);s2!==peg$FAILED?(peg$savedPos=s0,s1=peg$c32(s1,s2),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED;return s0}function peg$parseFactor(){var s0,s1,s2,s3,s4,s5;return s0=peg$currPos,40===input.charCodeAt(peg$currPos)?(s1=peg$c5,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c6)),s1!==peg$FAILED?(s2=peg$parse_(),s2!==peg$FAILED?(s3=peg$parseExpression(),s3!==peg$FAILED?(s4=peg$parse_(),s4!==peg$FAILED?(41===input.charCodeAt(peg$currPos)?(s5=peg$c7,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c8)),s5!==peg$FAILED?(peg$savedPos=s0,s1=peg$c9(s3),s0=s1):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED)):(peg$currPos=s0,s0=peg$FAILED),s0===peg$FAILED&&(s0=peg$parseFloat()),s0}function peg$parseFloat(){var s0,s1,s2,s3,s4,s5,s6,s7;for(peg$silentFails++,s0=peg$currPos,s1=[],43===input.charCodeAt(peg$currPos)?(s2=peg$c23,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c24)),s2===peg$FAILED&&(45===input.charCodeAt(peg$currPos)?(s2=peg$c25,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c26)));s2!==peg$FAILED;)s1.push(s2),43===input.charCodeAt(peg$currPos)?(s2=peg$c23,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c24)),s2===peg$FAILED&&(45===input.charCodeAt(peg$currPos)?(s2=peg$c25,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c26)));if(s1!==peg$FAILED){if(s2=[],peg$c34.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35)),s3!==peg$FAILED)for(;s3!==peg$FAILED;)s2.push(s3),peg$c34.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35));else s2=peg$FAILED;if(s2!==peg$FAILED){if(s3=[],s4=peg$currPos,46===input.charCodeAt(peg$currPos)?(s5=peg$c36,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c37)),s5!==peg$FAILED){if(s6=[],peg$c34.test(input.charAt(peg$currPos))?(s7=input.charAt(peg$currPos),peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35)),s7!==peg$FAILED)for(;s7!==peg$FAILED;)s6.push(s7),peg$c34.test(input.charAt(peg$currPos))?(s7=input.charAt(peg$currPos),peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35));else s6=peg$FAILED;s6!==peg$FAILED?(s5=[s5,s6],s4=s5):(peg$currPos=s4,s4=peg$FAILED)}else peg$currPos=s4,s4=peg$FAILED;for(;s4!==peg$FAILED;)if(s3.push(s4),s4=peg$currPos,46===input.charCodeAt(peg$currPos)?(s5=peg$c36,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c37)),s5!==peg$FAILED){if(s6=[],peg$c34.test(input.charAt(peg$currPos))?(s7=input.charAt(peg$currPos),peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35)),s7!==peg$FAILED)for(;s7!==peg$FAILED;)s6.push(s7),peg$c34.test(input.charAt(peg$currPos))?(s7=input.charAt(peg$currPos),peg$currPos++):(s7=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35));else s6=peg$FAILED;s6!==peg$FAILED?(s5=[s5,s6],s4=s5):(peg$currPos=s4,s4=peg$FAILED)}else peg$currPos=s4,s4=peg$FAILED;if(s3===peg$FAILED)if(s3=peg$currPos,101===input.charCodeAt(peg$currPos)?(s4=peg$c38,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c39)),s4!==peg$FAILED){if(s5=[],peg$c34.test(input.charAt(peg$currPos))?(s6=input.charAt(peg$currPos),peg$currPos++):(s6=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35)),s6!==peg$FAILED)for(;s6!==peg$FAILED;)s5.push(s6),peg$c34.test(input.charAt(peg$currPos))?(s6=input.charAt(peg$currPos),peg$currPos++):(s6=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c35));else s5=peg$FAILED;s5!==peg$FAILED?(s4=[s4,s5],s3=s4):(peg$currPos=s3,s3=peg$FAILED)}else peg$currPos=s3,s3=peg$FAILED;s3!==peg$FAILED?(peg$savedPos=s0,s1=peg$c40(),s0=s1):(peg$currPos=s0,s0=peg$FAILED)}else peg$currPos=s0,s0=peg$FAILED}else peg$currPos=s0,s0=peg$FAILED;return s0===peg$FAILED&&(s0=peg$parseNaN()),peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c33)),s0}function peg$parseNaN(){var s0,s1;return peg$silentFails++,s0=peg$currPos,input.substr(peg$currPos,3)===peg$c42?(s1=peg$c42,peg$currPos+=3):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c43)),s1!==peg$FAILED&&(peg$savedPos=s0,s1=peg$c44()),s0=s1,peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c41)),s0}function peg$parse_(){var s0,s1;for(peg$silentFails++,s0=[],peg$c46.test(input.charAt(peg$currPos))?(s1=input.charAt(peg$currPos),peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c47));s1!==peg$FAILED;)s0.push(s1),peg$c46.test(input.charAt(peg$currPos))?(s1=input.charAt(peg$currPos),peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c47));return peg$silentFails--,s0===peg$FAILED&&(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c45)),s0}if((peg$result=peg$startRuleFunction())!==peg$FAILED&&peg$currPos===input.length)return peg$result;throw peg$result!==peg$FAILED&&peg$currPos<input.length&&peg$fail(function(){return{type:"end"}}()),peg$buildStructuredError(peg$maxFailExpected,peg$maxFailPos<input.length?input.charAt(peg$maxFailPos):null,peg$maxFailPos<input.length?peg$computeLocation(peg$maxFailPos,peg$maxFailPos+1):peg$computeLocation(peg$maxFailPos,peg$maxFailPos))}return{SyntaxError:peg$SyntaxError,parse:peg$parse,memoParse:_.memoize(peg$parse)}}(),_.mixin({within:function(val,min,max){return val>=min&&val<=max}});var Point={init:function(left,top){this.left=left,this.top=top},within:function(box,options){return options=_.defaults(options||{},{horizontal:!0,vertical:!0}),(!options.vertical||_.within(this.top,box.top,box.bottom()))&&(!options.horizontal||_.within(this.left,box.left,box.right()))},move:function(dleft,dtop){this.left+=dleft,this.top+=dtop},moveWithin:function(box){this.move(this.rangeDiff(this.horizontalRange(),box.horizontalRange()),this.rangeDiff(this.verticalRange(),box.verticalRange()))},horizontalRange:function(){return{min:this.left,max:this.left}},verticalRange:function(){return{min:this.top,max:this.top}},rangeDiff:function(current,bounding){return current.min<bounding.min?bounding.min-current.min:current.max>bounding.max?bounding.max-current.max:0}};Obj.extend("Point");var Box={init:function(left,top,width,height){this._super(left,top),this.width=width,this.height=height},right:function(){return this.left+this.width},bottom:function(){return this.top+this.height},horizontalRange:function(){return{min:this.left,max:this.right()}},verticalRange:function(){return{min:this.top,max:this.bottom()}}};Point.extend("Box"),function($){$.fn.bBox=function(relative){var pos;return pos=relative?this.position():this.offset(),new Box(pos.left,pos.top,this.outerWidth(!0),this.outerHeight(!0))}}(jQuery);var Line={init:function(p1,p2){this.p1=p1,this.p2=p2}};Obj.extend("Line");var Bezier={init:function(p1,p4){this.p1=p1,this.p4=p4;var delta=(p4.left-p1.left)/2;this.p2=new Point(p1.left+delta,p1.top),this.p3=new Point(p4.left-delta,p4.top)},getCoord:function(t,coord){var values=_.pluck([this.p1,this.p2,this.p3,this.p4],coord);return Math.pow(1-t,3)*values[0]+3*Math.pow(1-t,2)*t*values[1]+3*(1-t)*t*t*values[2]+t*t*t*values[3]},getPoint:function(t){return new Point(this.getCoord(t,"left"),this.getCoord(t,"top"))},approximate:function(){for(var lastPoint=this.p1,lines=[],i=1;i<=8;i++){var point=this.getPoint(i/8);lines.push(new Line(lastPoint,point)),lastPoint=point}return lines}};Obj.extend("Bezier");var LinesBoxIntersection={sinside:0,sleft:1,sright:2,sbottom:4,stop:8,init:function(lines,box){this.lines=lines,this.box=box},intersectAny:function(){return _.any(this.lines,function(line){return 0==(this.section(line.p1)&this.section(line.p2))},this)},section:function(point){var code=this.sinside;return point.left<this.box.left&&(code|=this.sleft),point.left>this.box.right()&&(code|=this.sright),point.top<this.box.top&&(code|=this.stop),point.top>this.box.bottom()&&(code|=this.sbottom),code}};Obj.extend("LinesBoxIntersection"),Obj.extend("a5.InteractionGroup",{init:function(interactions,index){this.interactions=interactions,this.index=index||0}}),a5.Hook={init:function(){this.callbacks=[]},add:function(callback){this.callbacks.push(callback)},remove:function(callback){this.callbacks.remove(callback)},call:function(){var urguments=arguments;_.each(this.callbacks,function(e){e.apply(window,urguments)})}},Obj.extend("a5.Hook"),a5.EngineHooks={init:function(){this.interactionLoaded=new a5.Hook,this.interactionRestored=new a5.Hook,this.interactionShowed=new a5.Hook,this.interactionStatusChanged=new a5.Hook,this.interactionFontUpdated=new a5.Hook,this.ppebookRendered=new a5.Hook,this.ppebookDialogShowed=new a5.Hook,this.ppebookDialogRendered=new a5.Hook,this.ppebookSidebarShowed=new a5.Hook,this.ppebookSidebarRendered=new a5.Hook,this.ppebookHotspotRendered=new a5.Hook,this.ppebookMaskRendered=new a5.Hook,this.ppebookMaskDragging=new a5.Hook,this.ppebookMaskClose=new a5.Hook,this.ppebookInverseMaskRendered=new a5.Hook,this.ppebookInverseMaskDragging=new a5.Hook,this.ppebookInverseMaskClose=new a5.Hook,this.ppebookHistoryUndo=new a5.Hook,this.ppebookHistoryRedo=new a5.Hook,this.layoutStylesLoaded=new a5.Hook,this.countdownSetupRendered=new a5.Hook,this.countdownRendered=new a5.Hook}},Obj.extend("a5.EngineHooks"),a5.hooks=new a5.EngineHooks,Obj.extend("a5.DynamicCallbacks",{init:function(){this.callbacks={}},get:function(key){return _.has(this.callbacks,key)||(this.callbacks[key]=new Obj),this.callbacks[key]}}),a5.callbacks={controls:{pagination:new Obj,bar:new Obj},interaction:new Obj,dialogs:new a5.DynamicCallbacks},a5.eventBus=new Obj,a5.PerformanceBenchmark={init:function(){this.bindGlobalPerformanceEvents()},bindGlobalPerformanceEvents:function(){this._bindPerformanceEvent("engine_overhead","EngineOverhead"),this._bindPerformanceEvent("engine_config_load","EngineConfig"),this._bindPerformanceEvent("engine_dp_load","DesignPackInit"),this._bindPerformanceEvent("engine_layout_load","DesignPackLayout"),this._bindPerformanceEvent("engine_init_load","EngineInit"),this._bindPerformanceEvent("engine_mainbuilder","EngineMainBuilder"),this._bindPerformanceEvent("engine_lmsdata","EngineLMSData"),this._bindPerformanceEvent("engine_load_interactions","LoadAllScreens",!0),this._bindPerformanceEvent("render_LO","RenderAllScreens",!0)},bindInteractionPerformanceEvents:function(interaction){this._bindPerformanceEvent("load_screen_"+interaction.url),this._bindPerformanceEvent("xml_options_"+interaction.url),this._bindPerformanceEvent("xml_preprocessor_"+interaction.url),this._bindPerformanceEvent("render_"+interaction.url)},_bindPerformanceEvent:function(event,name,defer_measure){name||(name=event),a5.eventBus.bind("performance:"+event+":start",function(){this.performanceMarkStart(event)},this),a5.eventBus.bind("performance:"+event+":end",function(){this.performanceMarkEnd(event),defer_measure?_.defer(_.bind(function(){this.performanceMeasure(name,event)},this)):this.performanceMeasure(name,event)},this)},performanceMarkStart:function(name){window.performance&&window.performance.mark&&name&&window.performance.mark(name+"_start")},performanceMarkEnd:function(name){window.performance&&window.performance.mark&&name&&window.performance.mark(name+"_end")},performanceMeasure:function(measurementName,markName){window.performance&&window.performance.measure&&measurementName&&markName&&window.performance.measure(measurementName,markName+"_start",markName+"_end")}},Obj.extend("a5.PerformanceBenchmark"),a5.registry={"book:has-resources":!1,"book:enable-solution-view":!0,"book:hotspots:filter-structure-nodes":function(list){return list},"init-lrs":function(params){if(window.FrontendLRS){var lrs=new window.FrontendLRS.LRS({host:params.endpoint}),env=new window.FrontendLRS.TincanJsShellEnv({lrs:lrs});return $.when(lrs.init(),env.init())}},"init-external-recorder":!1,"init-external-converter":!1,"lo:has-next":!1,"lo:has-prev":!1,"open-attachment":function(html){return html},"open-link":function(getUrl,params){if(params=params||{},"iframe"!==params.target||/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())){var target="_blank";params.target&&"iframe"!==params.target&&(target=params.target);var w=window.open("",target,params.settings);$.when(getUrl).done(function(url){w.location=url,params.focus&&w.focus()}).fail(function(){w.close()})}else $.when(getUrl).done(function(url){var $iframe=params.$iframe||$("#iframe-open-link");$iframe.length>0?$iframe.attr("src",url):$("<iframe>",{id:"iframe-open-link",src:url}).hide().appendTo("body")})},"platform-data":{},"get-toolbelt-token":!1},a5.models.options.BaseOptions={name_map:{"01":"Dictionary","06":"Notes area","09":"Interactive Phonemic Chart","021":"Reveal Object","023":"Pin object","025":"Previous","026":"Forward Button","027":"Enumeration","028":"Enumeration Answers","029":"Prefill","034":"Gaptext audio","038":"Speak learner input","040":"Feedback","043":"Feedback Sound Effects","044":"Sound Effects","045":"Try Again","046":"Score Values","047":"End Result Screen","050":"Progress Bar","051":"Automatic Next","052":"Audio support","054":"Printable","056":"Image As Trigger","072":"Conserve-answers",107:"Add Text Object",109:"Use Click Click",111:"Pool Alignment",112:"Pair alignment",113:"Gaps",114:"Save",118:"Error Correction",119:"Signal Error",120:"Max Length",122:"Multiple Destinations",128:"Drop Indicator",148:"Card Back",149:"Card Layout",150:"Card Format",154:"Linking Lines Sets",158:"Size",160:"Case",162:"Stay in view",300:"Drag Alignment",302:"Hide Radiobuttons",305:"Clue position",306:"Choice Alignment",311:"Check Answers",312:"See Answers",313:"Reset",315:"Submissions",317:"Running score",318:"Show hints",319:"Hints",322:"Delayed Feedback",323:"Case Insensitive",324:"Ignore Punctuation",326:"Randomise answers",327:"Card Per Row",330:"Hide Checkboxes",334:"Show Submit",335:"Finish Submit",336:"Show Forward",337:"Target zones",340:"Validation message",341:"Autosave",342:"Intro Screen",345:"Manual Marking",346:"Feedback Band 1",347:"Feedback Band 2",348:"Feedback Band 3",349:"Feedback Band 4",352:"Special characters - Student",353:"Activity Feedback Band 1",354:"Activity Feedback Band 2",355:"Activity Feedback Band 3",356:"Activity Feedback Band 4",357:"Activity Feedback Thresholds",361:"Spellcheck",362:"Show In Columns",364:"Ignore Accents",367:"Eraser",368:"Annotation Tools",371:"Show info text",372:"Question pool",373:"Continuous Enumeration",375:"LO sections",376:"Question display",378:"End Result Always",379:"Exams Timer",382:"Enumeration internal",383:"Activity pool",384:"Check max attempts",388:"Send scores",390:"Design Pack Substyle",391:"End results return",394:"Score-Values-Per-Block",395:"Export File",396:"Textbox Autogrow",397:"Checkbox Selections",398:"Repeat Answers",399:"Free Drag Location",400:"Pool Stacks",401:"Audio in gap",402:"Order Dependency",403:"Gap Resize",404:"Score calculation",406:"Pool order",407:"Automatic capitalisation",408:"Marking style",412:"Container Style",416:"Answer display",417:"Link behaviour",419:"Restore LO State",421:"Wiki Tool",422:"Operator",425:"Gap characters",426:"Layers",427:"Team scoring",428:"Reference Content",430:"Alternative Text",431:"Audio Playback",432:"LO title display",433:"Activity title display",435:"Number columns",437:"Automatic play",438:"Shuffle control",439:"Additional image control",441:"Audio icon behaviour",442:"User selection",443:"LO fullscreen button",445:"User Visibility",446:"Clues in columns",448:"Try Again Behaviour",449:"See all answers",450:"See next answer",452:"Navigation Menu",453:"Display Settings",454:"Resource Banks",455:"TTS General Rules",456:"TTS LO Rules",457:"TTS Activity Rules",459:"Activity help",462:"Feedback Correct",463:"Feedback Incorrect",465:"Target image",466:"Target Generator image",467:"Target Generator location",469:"Selected Target image",470:"Background image",471:"Scoreboard",472:"Countdown timer",473:"Maximum duration",474:"Maximum items",475:"Movement speed",476:"Generation speed",477:"Game Over message",479:"Solution Hint",480:"Ignore Spaces",483:"Number Input",484:"Copyright Information",485:"Target onscreen duration",487:"Online Check",492:"Signal targets",493:"Check answers instant",495:"Validate dependent gaps",497:"Play all",498:"Download audio",499:"Hide lines",501:"Gapfill behaviour",502:"Group headings",503:"Display as completed",504:"Origin of targets",505:"Translation Block",508:"Flash first answer",509:"Set User Role",510:"Score Rounding",511:"Next button text",512:"Check Answers Display",513:"Original Audio Playback",516:"Number of chances",517:"Keyboard display",518:"Reveal Solution",519:"Hangman Timer",520:"Instruction PopUp",521:"Reset Whole LO",522:"Show Next LO",523:"Show Previous LO",524:"LO Notes Area",525:"Audio speed",527:"SCORM2004 Absolute Values",529:"Highlight selection",531:"Display Recording Test",532:"End Results Button",533:"Time Spent in Sections",535:"Number Of Teams",536:"Number Of Categories",537:"Number Of Questions",538:"Skip",539:"Restart Game",540:"New Game"},value_map:{"01":{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},"06":{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},"09":{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},"021":{Off:{descr:"Off",key:"false"},All:{descr:"All",key:"all"},Progressive:{descr:"Progressive",key:"progressive"},"Progressive plus Hide":{descr:"Progressive plus Hide",key:"progressiveplushide"}},"023":{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},"025":{On:{descr:"on!",key:"true"},Off:{descr:"off!",key:"false"},"After submitted":{descr:"After submitted",key:"afterSubmitted"}},"026":{Next:{descr:"Next",key:"next"},Adaptive:{descr:"Adaptive",key:"adaptive"}},"027":{"No enumeration":{descr:"No enumeration",key:"false"},"1.":{descr:"1. 2. 3.  ...",key:"number"},1:{descr:"1 2 3  ...",key:"number_no_dot"},"a)":{descr:"a) b) c) ...",key:"letter"},"A.":{descr:"A. B. C. ...",key:"capitalletter"},"Bullet points":{descr:"Bullet points",key:"bullet"},Custom:{descr:"",key:"custom"}},"028":{False:{descr:"No enumeration",key:"false"},"1.":{descr:"1. 2. 3.  ...",key:"number"},1:{descr:"1 2 3  ...",key:"number_no_dot"},"a)":{descr:"a) b) c) ...",key:"letter"},"A.":{descr:"A. B. C. ...",key:"capitalletter"},"Bullet points":{descr:"Bullet points",key:"bullet"},Custom:{descr:"",key:"custom"}},"029":{"No prefill":{descr:"No answer items are displayed.",key:"false"},"First gap":{descr:"The first item is displayed.",key:"firstitem"},"First paragraph":{descr:"The answers in the first paragraph are displayed.",key:"firstblock"}},"034":{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},"038":{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},"040":{Normal:{descr:"Normal",key:"normal"},Instant:{descr:"Instant",key:"instant"}},"043":{Off:{descr:"off",key:"off"},Custom:{descr:"custom",key:"custom"}},"044":{None:{descr:"None",key:"none"},"Sound effects":{descr:"Sound effects",key:"sound_effects"}},"045":{Off:{descr:"off",key:"false"},"Keep correct answers":{descr:"Keep correct answers",key:"lock"},"Freeze correct answers":{descr:"Freeze correct answers",key:"frozen"},"Clear all":{descr:"Clear all",key:"clear"},"Keep all":{descr:"Keep all",key:"keepall"}},"046":{"1 point per action":{descr:"",key:"1_point_action"},"1 point per question":{descr:"",key:"1_point_question"}},"047":{Off:{descr:"off!",key:"false"},On:{descr:"on!",key:"true"},"After score":{descr:"After score",key:"buttonAfterScore"}},"050":{On:{descr:"on!",key:"true"},Off:{descr:"off!",key:"false"},Auto:{descr:"auto",key:"auto"},"Screen Selection":{descr:"Screen Selection",key:"screenSelection"}},"051":{Off:{descr:"off!",key:"false"},Questions:{descr:"Go to next page when all questions are answered",key:"questions"},Timer:{descr:"Go to next page after a specified time.",key:"timer"}},"052":{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},"054":{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},"056":{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},"072":{On:{descr:"on!",key:"true"},Off:{descr:"off!",key:"false"}},107:{No:{descr:"No!",key:"false"},Yes:{descr:"Yes",key:"normal"}},109:{Off:{descr:"off!",key:"false"},On:{descr:"on!",key:"true"}},111:{"No pool":{descr:"No pool displayed",key:"none"},Top:{descr:"Pool at the top",key:"top"},Bottom:{descr:"Pool at the bottom",key:"bottom"},Left:{descr:"Pool to the left",key:"left"},Right:{descr:"Pool to the right",key:"right"},Free:{descr:"Pool is user moveable",key:"free"}},112:{"On top":{descr:"On top",key:"ontop"},Horizontal:{descr:"Horizontal",key:"horizontal"},Vertical:{descr:"Vertical",key:"vertical"}},113:{Variable:{descr:"Gaps sized according to size of word",key:"variable"},"Same (longest answer)":{descr:"All gaps the same size, which equals the largest word",key:"samelongest"},Invisible:{descr:"Gaps do not appear until user clicks in space between words",key:"invisible"},Fixed:{descr:"Fixed",key:"fixed"}},114:{Off:{descr:"Off",key:"off"},"Skin Button":{descr:"Skin Button",key:"skinbutton"},"Button only":{descr:"Button only",key:"button_only"}},118:{"Replace the word":{descr:"replace the word",key:"replace"},"End of line":{descr:"end of line",key:"line"},Sentence:{descr:"sentence",key:"sentence"}},119:{Off:{descr:"Off",key:"off"},Highlight:{descr:"Highlight",key:"highlight"},"Button after attempts":{descr:"Button after attempts",key:"buttonAfterAttempts"},"Button always on":{descr:"Button always on",key:"button"}},120:{None:{descr:"none",key:"false"},Words:{descr:"Words",key:"words"}," Characters":{descr:" Characters",key:"chars"}},122:{No:{descr:"No",key:"one"},Unlimited:{descr:"Unlimited",key:"unlimited"},Restricted:{descr:"Restricted",key:"restricted"}},128:{On:{descr:"on!",key:"true"},Off:{descr:"off!",key:"false"}},148:{Default:{descr:"Default",key:"default"},"Default sets":{descr:"Default sets",key:"defaultsets"},Image:{descr:"Image",key:"image"},"Image sets":{descr:"Image sets",key:"imagesets"}},149:{Default:{descr:"Default",key:"default"},Sets:{descr:"Sets",key:"sets"}},150:{Portrait:{descr:"Portrait",key:"portrait"},Landscape:{descr:"Landscape",key:"landscape"},Square:{descr:"Square",key:"square"}},154:{Pairs:{descr:"Two columns",key:"pairs"},Triplets:{descr:"Three columns",key:"triplets"},Quadruples:{descr:"Four columns",key:"quadruples"},Quintuples:{descr:"Five columns",key:"quintuples"}},158:{dummy:{descr:"dummy",key:"dummy"}},160:{Upper:{descr:"Upper",key:"upper"},Lower:{descr:"Lower",key:"lower"}},162:{Off:{descr:"No scroll",key:"false"},On:{descr:"Scroll with page",key:"true"}},300:{Vertical:{descr:"Vertical!",key:"vertical"},Horizontal:{descr:"Horizontal!",key:"horizontal"},"Horizontal (single word)":{descr:"Horizontal (single word)",key:"horizontal_single_word"}},302:{"Don't hide":{descr:"off!",key:"false"},Hide:{descr:"on!",key:"true"},Custom:{descr:"Custom",key:"custom"}},305:{"Inside with mouseover":{descr:"inside",key:"inside"},"Outside the grid":{descr:"outside",key:"outside"}},306:{Vertical:{descr:"vertical",key:"vertical"},Horizontal:{descr:"horizontal",key:"horizontal"},Inline:{descr:"inline",key:"inline"}},311:{Always:{descr:"Always",key:"always"},Off:{descr:"off",key:"false"},"After one answer":{descr:"After one answer",key:"afterOne"},"After all answers":{descr:"After all answers",key:"afterAll"},"Before submitted":{descr:"Before submitted",key:"beforeSubmitted"}},312:{On:{descr:"On",key:"on"},Off:{descr:"Off",key:"off"},"Before Interaction":{descr:"Before Interaction",key:"beforeInteraction"}},313:{On:{descr:"On",key:"on"},Off:{descr:"Off",key:"off"},"Before submitted":{descr:"Before submitted",key:"beforeSubmitted"}},315:{1:{descr:"1",key:"1"},2:{descr:"2",key:"2"},3:{descr:"3",key:"3"},4:{descr:"4",key:"4"},5:{descr:"5",key:"5"},6:{descr:"6",key:"6"},7:{descr:"7",key:"7"},8:{descr:"8",key:"8"},9:{descr:"9",key:"9"},10:{descr:"10",key:"10"},11:{descr:"11",key:"11"},12:{descr:"12",key:"12"},13:{descr:"13",key:"13"},14:{descr:"14",key:"14"},15:{descr:"15",key:"15"},16:{descr:"16",key:"16"},17:{descr:"17",key:"17"},18:{descr:"18",key:"18"},19:{descr:"19",key:"19"},20:{descr:"20",key:"20"},Unlimited:{descr:"Unlimited",key:"unlimited"}},317:{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},318:{Off:{descr:"off",key:"off"},Always:{descr:"Always",key:"always"},"Check Score":{descr:"Check Score",key:"checkScore"}},319:{None:{descr:"None",key:"false"},Custom:{descr:"Custom",key:"custom"}},322:{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"},Custom:{descr:"custom",key:"custom"}},323:{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},324:{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},326:{On:{descr:"on",key:"true"},Off:{descr:"off",key:"false"}},327:{Cards:{descr:"Cards",key:"cards"}
},330:{"Don't hide":{descr:"off!",key:"false"},Hide:{descr:"on!",key:"true"}},334:{Always:{descr:"Always",key:"always"},Off:{descr:"Off",key:"off"},"After one answer":{descr:"After one answer",key:"afterOne"},"After all answers":{descr:"After all answers",key:"afterAll"},"Displayed on each screen":{descr:"Displayed on each screen",key:"eachScreen"}},335:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},336:{Always:{descr:"Always",key:"always"},Off:{descr:"Off",key:"off"},"After one answer":{descr:"After one answer",key:"afterOne"},"After submitted":{descr:"After submitted",key:"afterSubmitted"},"After all answers":{descr:"After all answers",key:"afterAll"},"After Check Answers":{descr:"",key:"afterCheckAnswers"},"After see answers":{descr:"After see answers",key:"afterSeeAnswers"}},337:{Off:{descr:"off",key:"false"},On:{descr:"on",key:"true"}},340:{None:{descr:"None",key:"false"},Custom:{descr:"Custom",key:"custom"}},341:{On:{descr:"On",key:"on"},Off:{descr:"Off",key:"off"}},342:{Off:{descr:"off!",key:"off"},On:{descr:"on!",key:"on"}},345:{Off:{descr:"off",key:"off"},On:{descr:"on",key:"on"}},346:{None:{descr:"None",key:"false"},Custom:{descr:"Custom",key:"custom"}},347:{None:{descr:"None",key:"false"},Custom:{descr:"Custom",key:"custom"}},348:{None:{descr:"None",key:"false"},Custom:{descr:"Custom",key:"custom"}},349:{None:{descr:"None",key:"false"},Custom:{descr:"Custom",key:"custom"}},352:{"Scientific Characters":{descr:"",key:"Scientific_Characters"},"Ancient Greek":{descr:"",key:"Ancient_Greek"},Danish:{descr:"",key:"Danish"},French:{descr:"",key:"French"},German:{descr:"",key:"German"},Polish:{descr:"",key:"Polish"},Spanish:{descr:"",key:"Spanish"},Swedish:{descr:"",key:"Swedish"},Turkish:{descr:"",key:"Turkish"},"Arithmetic Operators":{descr:"",key:"Arithmetic_Operators"}},353:{None:{descr:"None",key:"false"},Custom:{descr:"Custom",key:"custom"}},354:{None:{descr:"None",key:"false"},Custom:{descr:"Custom",key:"custom"}},355:{None:{descr:"None",key:"false"},Custom:{descr:"Custom",key:"custom"}},356:{None:{descr:"None",key:"false"},Custom:{descr:"Custom",key:"custom"}},357:{Custom:{descr:"Custom",key:"custom"}},361:{"Don't spellcheck":{descr:"Off",key:"off"},"Enable spellcheck":{descr:"On",key:"on"}},362:{No:{descr:"No!",key:"false"},Yes:{descr:"Yes",key:"true"}},364:{"Don't ignore accents":{descr:"Off",key:"off"},"Ignore accents":{descr:"On",key:"on"}},367:{"Don't display eraser":{descr:"Off",key:"off"},"Display eraser":{descr:"On",key:"on"}},368:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"},"Only for Teachers":{descr:"Only for Teachers",key:"only_for_teachers"},"Only Supplements":{descr:"Only Supplements",key:"only_supplements"}},371:{Off:{descr:"Off",key:"off"},Tooltip:{descr:"Tooltip",key:"tooltip"},Dialog:{descr:"Dialog",key:"dialog"}},372:{No:{descr:"No",key:"no"},Yes:{descr:"Yes",key:"yes"}},373:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},375:{OFF:{descr:"Off",key:"off"},om:{descr:"1",key:"custom"}},376:{"Show all":{descr:"Show all",key:"all"},"Show active only":{descr:"Show active only",key:"active"},"Show next":{descr:"Show next",key:"show_next"},"Show next and hide current one on click":{descr:"Show next and hide previous",key:"show_next_and_hide_previous"}},378:{Off:{descr:"off!",key:"off"},On:{descr:"on!",key:"on"},"Button after score":{descr:"Button after score",key:"buttonAfterScore"}},379:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},382:{"Show all":{descr:"Show all",key:"all"},"Only Correct":{descr:"Only Correct",key:"correct"}},383:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"},"Randomise All":{descr:"Randomise All",key:"randomiseAll"}},384:{Custom:{descr:"Custom",key:"custom"}},388:{Off:{descr:"Off",key:"off"},Unlimited:{descr:"Unlimited",key:"unlimited"},"1 submission":{descr:"1 submission",key:"1_submission"},"Final Check answers":{descr:"Final Check answers",key:"final_check_answers"}},390:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},391:{"Last activity":{descr:"Last activity",key:"last"},"First activity":{descr:"First activity",key:"first"}},394:{Off:{descr:"Off",key:"off"},Custom:{descr:"Custom",key:"Custom"}},395:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},396:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},397:{"Total Correct":{descr:"Total Correct",key:"total_correct"},All:{descr:"All",key:"all"}},398:{Allow:{descr:"Allow",key:"allow"},Prevent:{descr:"Prevent",key:"prevent"}},399:{Off:{descr:"Off",key:"off"},"Between Words":{descr:"Between Words",key:"between_words"},"Between Letters":{descr:"Between Letters",key:"between_letters"}},400:{Off:{descr:"Off",key:"off"},1:{descr:"1",key:"1"},2:{descr:"1",key:"2"},3:{descr:"3",key:"3"},4:{descr:"4",key:"4"}},401:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},402:{Off:{descr:"Off",key:"off"},"From first answer":{descr:"From first answer",key:"first_answer"},"Longest combination":{descr:"Longest combination",key:"on"}},403:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},404:{"Only correct":{descr:"Only correct",key:"onlyCorrect"},"Subtract incorrect":{descr:"Subtract incorrect",key:"subtractIncorrect"}},406:{Off:{descr:"Off",key:"off"},Alphabetical:{descr:"Alphabetical",key:"alphabetical"},Natural:{descr:"Natural",key:"natural"}},407:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},408:{Highlight:{descr:"Highlight",key:"highlight"},Circle:{descr:"Circle",key:"circle"},Underline:{descr:"Underline",key:"underline"}},412:{Normal:{descr:"Normal",key:"normal"},Custom:{descr:"Custom",key:"custom"}},416:{Columns:{descr:"Columns",key:"columns"},Rows:{descr:"Rows",key:"rows"}},417:{Drag:{descr:"Drag",key:"drag"},Touch:{descr:"Touch",key:"touch"}},419:{On:{descr:"On",key:"on"},Off:{descr:"Off",key:"off"}},421:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},422:{Addition:{descr:"Addition",key:"addition"},Multiplication:{descr:"Multiplication",key:"multiplication"}},425:{"Don't show":{descr:"Don't show",key:"dontshow"},Show:{descr:"Show",key:"show"}},426:{2:{descr:"2",key:"2"},3:{descr:"3",key:"3"},4:{descr:"4",key:"4"},5:{descr:"5",key:"5"},6:{descr:"6",key:"6"}},427:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},428:{Off:{descr:"Off",key:"off"},1:{descr:"1",key:"1"},2:{descr:"2",key:"2"}},430:{Off:{descr:"Off",key:"off"},Alt1:{descr:"Alt1",key:"alt1"},Alt2:{descr:"Alt2",key:"alt2"},Alt3:{descr:"Alt3",key:"alt3"}},431:{Auto:{descr:"Auto",key:"auto"},Manual:{descr:"Manual",key:"manual"},"Before Card Flip":{descr:"Before Card Flip",key:"before_card_flip"}},432:{On:{descr:"On",key:"on"},Off:{descr:"Off",key:"off"}},433:{On:{descr:"On",key:"on"},Off:{descr:"Off",key:"off"}},435:{3:{descr:"3",key:"3"},4:{descr:"4",key:"4"},5:{descr:"5",key:"5"}},437:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"},"On and magnify":{descr:"On and magnify",key:"on_magnify"}},438:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},439:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},441:{Stop:{descr:"Stop",key:"stop"},Pause:{descr:"Pause",key:"pause"}},442:{Off:{descr:"Off",key:"off"},"Select for correct":{descr:"Select for correct",key:"select_for_correct"},"Select for error":{descr:"Select for error",key:"select_for_error"}},443:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},445:{All:{descr:"All",key:"all"},Teacher:{descr:"Teacher",key:"teacher"},Student:{descr:"Student",key:"student"}},446:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},448:{Button:{descr:"Button",key:"button"},Automatic:{descr:"Automatic",key:"automatic"}},449:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},450:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},452:{Off:{descr:"Off",key:"off"},Auto:{descr:"Auto",key:"auto"},Custom:{descr:"Custom",key:"custom"}},453:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},454:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},455:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},456:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},457:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},459:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},462:{No:{descr:"no",key:"no"},Custom:{descr:"custom",key:"custom"}},463:{No:{descr:"no",key:"no"},Custom:{descr:"custom",key:"custom"}},465:{Custom:{descr:"Custom",key:"custom"}},466:{Custom:{descr:"Custom",key:"custom"}},467:{"Bottom Right":{descr:"Bottom Right",key:"bottom_right"},"Bottom Left":{descr:"Bottom Left",key:"bottom_left"},"Top Right":{descr:"Top Right",key:"top_right"},"Top Left":{descr:"Top Left",key:"top_left"}},469:{Custom:{descr:"Custom",key:"custom"}},470:{Custom:{descr:"Custom",key:"custom"}},471:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},472:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},473:{Off:{descr:"off",key:"off"},Custom:{descr:"Custom",key:"custom"}},474:{Off:{descr:"off",key:"off"},Custom:{descr:"Custom",key:"custom"}},475:{Slow:{descr:"Slow",key:"slow"},Medium:{descr:"Medium",key:"medium"},Fast:{descr:"Fast",key:"fast"}},476:{Slow:{descr:"Slow",key:"slow"},Medium:{descr:"Medium",key:"medium"},Fast:{descr:"Fast",key:"fast"}},477:{Custom:{descr:"Custom",key:"custom"}},479:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},480:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},483:{Any:{descr:"Any",key:"any"},Natural:{descr:"Natural",key:"natural"},Integer:{descr:"Integer",key:"integer"}},484:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},485:{Off:{descr:"off",key:"off"},Custom:{descr:"Custom",key:"custom"}},487:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},492:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},493:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},495:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},497:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},498:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},499:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},501:{Drag:{descr:"Drag",key:"drag"},"Tap item":{descr:"Tap item",key:"tap_item"},"Tap target":{descr:"Tap target",key:"tap_target"},"Tap swap":{descr:"Tap swap",key:"tap_swap"}},502:{Off:{descr:"off",key:"off"},Custom:{descr:"custom",key:"custom"}},503:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},504:{Default:{descr:"Default",key:"default"},Custom:{descr:"Custom",key:"custom"}},505:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},508:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},509:{Free:{descr:"Free",key:"Free"},"Role 1":{descr:"Role 1",key:"role_1"},"Role 2":{descr:"Role 2",key:"role_2"}},510:{Float:{descr:"Float",key:"float"},"Round up":{descr:"Round up",key:"roundup"},Round:{descr:"Round",key:"round"},"Round down":{descr:"Round down",key:"rounddown"}},511:{Default:{descr:"Default",key:"default"},Custom:{descr:"Custom",key:"custom"}},512:{"Marking and Feedback":{descr:"Marking and Feedback",key:"marking_and_feedback"},"Marking only":{descr:"Marking only",key:"marking_only"}},513:{"Both roles":{descr:"Both roles",key:"both_roles"},"Non-selected Role Only":{descr:"Non-selected Role Only",key:"non_selected_role_only"}},516:{1:{descr:"1",key:"1"},2:{descr:"2",key:"2"},3:{descr:"3",key:"3"},4:{descr:"4",key:"4"},5:{descr:"5",key:"5"}},517:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},518:{"After final chance":{descr:"After final chance",key:"after_final_chance"},"With button":{descr:"With button",key:"with_button"}},519:{Off:{descr:"Off",key:"off"},Custom:{descr:"Custom",key:"custom"}},520:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},521:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},522:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},523:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},524:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},525:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},527:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},529:{Words:{descr:"Words",key:"words"},Letters:{descr:"Letters",key:"letters"}},531:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},532:{"Every activity":{descr:"Every activity",key:"every"},"Last activity":{descr:"Last activity",key:"last"}},533:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},535:{1:{descr:"1",key:"1"},2:{descr:"2",key:"2"},3:{descr:"3",key:"3"},4:{descr:"4",key:"4"}},536:{Off:{descr:"Off",key:"off"},1:{descr:"1",key:"1"},2:{descr:"2",key:"2"},3:{descr:"3",key:"3"},4:{descr:"4",key:"4"},5:{descr:"5",key:"5"},6:{descr:"6",key:"6"},7:{descr:"7",key:"7"},8:{descr:"8",key:"8"},9:{descr:"9",key:"9"}},537:{Off:{descr:"Off",key:"off"},1:{descr:"1",key:"1"},2:{descr:"2",key:"2"},3:{descr:"3",key:"3"},4:{descr:"4",key:"4"},5:{descr:"5",key:"5"},6:{descr:"6",key:"6"},7:{descr:"7",key:"7"},8:{descr:"8",key:"8"},9:{descr:"9",key:"9"}},538:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},539:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}},540:{Off:{descr:"Off",key:"off"},On:{descr:"On",key:"on"}}},getDictionary:function(){return this.has("01")?this.hasValue("01")?this.getValue("01"):this.get("01"):"false"},dictionaryIsFalse:function(){return!this.has("01")||"false"==this.get("01")},dictionaryIsTrue:function(){return!!this.has("01")&&"true"==this.get("01")},getNotesarea:function(){return this.has("06")?this.hasValue("06")?this.getValue("06"):this.get("06"):"false"},notesareaIsFalse:function(){return!this.has("06")||"false"==this.get("06")},notesareaIsTrue:function(){return!!this.has("06")&&"true"==this.get("06")},getInteractivePhonemicChart:function(){return this.has("09")?this.hasValue("09")?this.getValue("09"):this.get("09"):"false"},interactivePhonemicChartIsFalse:function(){return!this.has("09")||"false"==this.get("09")},interactivePhonemicChartIsTrue:function(){return!!this.has("09")&&"true"==this.get("09")},getRevealObject:function(){return this.has("021")?this.hasValue("021")?this.getValue("021"):this.get("021"):"false"},revealObjectIsFalse:function(){return!this.has("021")||"false"==this.get("021")},revealObjectIsAll:function(){return!!this.has("021")&&"all"==this.get("021")},revealObjectIsProgressive:function(){return!!this.has("021")&&"progressive"==this.get("021")},revealObjectIsProgressiveplushide:function(){return!!this.has("021")&&"progressiveplushide"==this.get("021")},getPinobject:function(){return this.has("023")?this.hasValue("023")?this.getValue("023"):this.get("023"):"false"},pinobjectIsFalse:function(){return!this.has("023")||"false"==this.get("023")},pinobjectIsTrue:function(){return!!this.has("023")&&"true"==this.get("023")},getPrevious:function(){return this.has("025")?this.hasValue("025")?this.getValue("025"):this.get("025"):"true"},previousIsTrue:function(){return!this.has("025")||"true"==this.get("025")},previousIsFalse:function(){return!!this.has("025")&&"false"==this.get("025")},previousIsAfterSubmitted:function(){return!!this.has("025")&&"afterSubmitted"==this.get("025")},getForwardButton:function(){return this.has("026")?this.hasValue("026")?this.getValue("026"):this.get("026"):"next"},forwardButtonIsNext:function(){return!this.has("026")||"next"==this.get("026")},forwardButtonIsAdaptive:function(){return!!this.has("026")&&"adaptive"==this.get("026")},getEnumeration:function(){return this.has("027")?this.hasValue("027")?this.getValue("027"):this.get("027"):"false"},enumerationIsFalse:function(){return!this.has("027")||"false"==this.get("027")},enumerationIsNumber:function(){return!!this.has("027")&&"number"==this.get("027")},enumerationIsNumber_no_dot:function(){return!!this.has("027")&&"number_no_dot"==this.get("027")},enumerationIsLetter:function(){return!!this.has("027")&&"letter"==this.get("027")},enumerationIsCapitalletter:function(){return!!this.has("027")&&"capitalletter"==this.get("027")},enumerationIsBullet:function(){return!!this.has("027")&&"bullet"==this.get("027")},enumerationIsCustom:function(){return!!this.has("027")&&"custom"==this.get("027")},getEnumerationAnswers:function(){return this.has("028")?this.hasValue("028")?this.getValue("028"):this.get("028"):"false"},enumerationAnswersIsFalse:function(){return!this.has("028")||"false"==this.get("028")},enumerationAnswersIsNumber:function(){return!!this.has("028")&&"number"==this.get("028")},enumerationAnswersIsNumber_no_dot:function(){return!!this.has("028")&&"number_no_dot"==this.get("028")},enumerationAnswersIsLetter:function(){return!!this.has("028")&&"letter"==this.get("028")},enumerationAnswersIsCapitalletter:function(){return!!this.has("028")&&"capitalletter"==this.get("028")},enumerationAnswersIsBullet:function(){return!!this.has("028")&&"bullet"==this.get("028")},enumerationAnswersIsCustom:function(){return!!this.has("028")&&"custom"==this.get("028")},getPrefill:function(){return this.has("029")?this.hasValue("029")?this.getValue("029"):this.get("029"):"false"},prefillIsFalse:function(){return!this.has("029")||"false"==this.get("029")},prefillIsFirstitem:function(){return!!this.has("029")&&"firstitem"==this.get("029")},prefillIsFirstblock:function(){return!!this.has("029")&&"firstblock"==this.get("029")},getGaptextaudio:function(){return this.has("034")?this.hasValue("034")?this.getValue("034"):this.get("034"):"false"},gaptextaudioIsFalse:function(){return!this.has("034")||"false"==this.get("034")},gaptextaudioIsTrue:function(){return!!this.has("034")&&"true"==this.get("034")},getSpeaklearnerinput:function(){return this.has("038")?this.hasValue("038")?this.getValue("038"):this.get("038"):"false"},speaklearnerinputIsFalse:function(){return!this.has("038")||"false"==this.get("038")},speaklearnerinputIsTrue:function(){return!!this.has("038")&&"true"==this.get("038")},getFeedback:function(){return this.has("040")?this.hasValue("040")?this.getValue("040"):this.get("040"):"normal"},feedbackIsNormal:function(){return!this.has("040")||"normal"==this.get("040")},feedbackIsInstant:function(){return!!this.has("040")&&"instant"==this.get("040")},getFeedbackSoundEffects:function(){return this.has("043")?this.hasValue("043")?this.getValue("043"):this.get("043"):"off"},feedbackSoundEffectsIsOff:function(){return!this.has("043")||"off"==this.get("043")},feedbackSoundEffectsIsCustom:function(){return!!this.has("043")&&"custom"==this.get("043")},getSoundEffects:function(){return this.has("044")?this.hasValue("044")?this.getValue("044"):this.get("044"):"none"},soundEffectsIsNone:function(){return!this.has("044")||"none"==this.get("044")},soundEffectsIsSound_effects:function(){return!!this.has("044")&&"sound_effects"==this.get("044")},getTryAgain:function(){return this.has("045")?this.hasValue("045")?this.getValue("045"):this.get("045"):"false"},tryAgainIsFalse:function(){return!this.has("045")||"false"==this.get("045")},tryAgainIsLock:function(){return!!this.has("045")&&"lock"==this.get("045")},tryAgainIsFrozen:function(){return!!this.has("045")&&"frozen"==this.get("045")},tryAgainIsClear:function(){return!!this.has("045")&&"clear"==this.get("045")},tryAgainIsKeepall:function(){return!!this.has("045")&&"keepall"==this.get("045")},getScoreValues:function(){return this.has("046")?this.hasValue("046")?this.getValue("046"):this.get("046"):"1_point_action"},scoreValuesIs1_point_action:function(){return!this.has("046")||"1_point_action"==this.get("046")},scoreValuesIs1_point_question:function(){return!!this.has("046")&&"1_point_question"==this.get("046")},getEndResultScreen:function(){return this.has("047")?this.hasValue("047")?this.getValue("047"):this.get("047"):"false"},endResultScreenIsFalse:function(){return!this.has("047")||"false"==this.get("047")},endResultScreenIsTrue:function(){return!!this.has("047")&&"true"==this.get("047")},endResultScreenIsButtonAfterScore:function(){return!!this.has("047")&&"buttonAfterScore"==this.get("047")},getProgressBar:function(){return this.has("050")?this.hasValue("050")?this.getValue("050"):this.get("050"):"true"},progressBarIsTrue:function(){return!this.has("050")||"true"==this.get("050")},progressBarIsFalse:function(){return!!this.has("050")&&"false"==this.get("050")},progressBarIsAuto:function(){return!!this.has("050")&&"auto"==this.get("050")},progressBarIsScreenSelection:function(){return!!this.has("050")&&"screenSelection"==this.get("050")},getAutomaticNext:function(){return this.has("051")?this.hasValue("051")?this.getValue("051"):this.get("051"):"false"},automaticNextIsFalse:function(){return!this.has("051")||"false"==this.get("051")},automaticNextIsQuestions:function(){return!!this.has("051")&&"questions"==this.get("051")},automaticNextIsTimer:function(){return!!this.has("051")&&"timer"==this.get("051")},getAudiosupport:function(){return this.has("052")?this.hasValue("052")?this.getValue("052"):this.get("052"):"false"},audiosupportIsFalse:function(){return!this.has("052")||"false"==this.get("052")},audiosupportIsTrue:function(){return!!this.has("052")&&"true"==this.get("052")},getPrintable:function(){return this.has("054")?this.hasValue("054")?this.getValue("054"):this.get("054"):"false"},printableIsFalse:function(){return!this.has("054")||"false"==this.get("054")},printableIsTrue:function(){return!!this.has("054")&&"true"==this.get("054")},getImageAsTrigger:function(){return this.has("056")?this.hasValue("056")?this.getValue("056"):this.get("056"):"false"},imageAsTriggerIsFalse:function(){return!this.has("056")||"false"==this.get("056")},imageAsTriggerIsTrue:function(){return!!this.has("056")&&"true"==this.get("056")},getConserveanswers:function(){return this.has("072")?this.hasValue("072")?this.getValue("072"):this.get("072"):"true"},conserveanswersIsTrue:function(){return!this.has("072")||"true"==this.get("072")},conserveanswersIsFalse:function(){return!!this.has("072")&&"false"==this.get("072")},getAddTextObject:function(){return this.has("107")?this.hasValue("107")?this.getValue("107"):this.get("107"):"false"},addTextObjectIsFalse:function(){return!this.has("107")||"false"==this.get("107")},addTextObjectIsNormal:function(){return!!this.has("107")&&"normal"==this.get("107")},getUseClickClick:function(){return this.has("109")?this.hasValue("109")?this.getValue("109"):this.get("109"):"false"},useClickClickIsFalse:function(){return!this.has("109")||"false"==this.get("109")},useClickClickIsTrue:function(){return!!this.has("109")&&"true"==this.get("109")},getPoolAlignment:function(){return this.has("111")?this.hasValue("111")?this.getValue("111"):this.get("111"):"none"},poolAlignmentIsNone:function(){return!this.has("111")||"none"==this.get("111")},poolAlignmentIsTop:function(){return!!this.has("111")&&"top"==this.get("111")},poolAlignmentIsBottom:function(){return!!this.has("111")&&"bottom"==this.get("111")},poolAlignmentIsLeft:function(){return!!this.has("111")&&"left"==this.get("111")},poolAlignmentIsRight:function(){return!!this.has("111")&&"right"==this.get("111")},poolAlignmentIsFree:function(){return!!this.has("111")&&"free"==this.get("111")},getPairalignment:function(){return this.has("112")?this.hasValue("112")?this.getValue("112"):this.get("112"):"ontop"},pairalignmentIsOntop:function(){return!this.has("112")||"ontop"==this.get("112")},pairalignmentIsHorizontal:function(){return!!this.has("112")&&"horizontal"==this.get("112")},pairalignmentIsVertical:function(){return!!this.has("112")&&"vertical"==this.get("112")},getGaps:function(){return this.has("113")?this.hasValue("113")?this.getValue("113"):this.get("113"):"variable"},gapsIsVariable:function(){return!this.has("113")||"variable"==this.get("113")},gapsIsSamelongest:function(){return!!this.has("113")&&"samelongest"==this.get("113")},gapsIsInvisible:function(){return!!this.has("113")&&"invisible"==this.get("113")},gapsIsFixed:function(){return!!this.has("113")&&"fixed"==this.get("113")},getSave:function(){return this.has("114")?this.hasValue("114")?this.getValue("114"):this.get("114"):"off"},saveIsOff:function(){return!this.has("114")||"off"==this.get("114")},saveIsSkinbutton:function(){return!!this.has("114")&&"skinbutton"==this.get("114")},saveIsButton_only:function(){return!!this.has("114")&&"button_only"==this.get("114")},getErrorCorrection:function(){return this.has("118")?this.hasValue("118")?this.getValue("118"):this.get("118"):"replace"},errorCorrectionIsReplace:function(){return!this.has("118")||"replace"==this.get("118")},errorCorrectionIsLine:function(){return!!this.has("118")&&"line"==this.get("118")},errorCorrectionIsSentence:function(){return!!this.has("118")&&"sentence"==this.get("118")},getSignalError:function(){return this.has("119")?this.hasValue("119")?this.getValue("119"):this.get("119"):"off"},signalErrorIsOff:function(){return!this.has("119")||"off"==this.get("119")},signalErrorIsHighlight:function(){return!!this.has("119")&&"highlight"==this.get("119")},signalErrorIsButtonAfterAttempts:function(){return!!this.has("119")&&"buttonAfterAttempts"==this.get("119")},signalErrorIsButton:function(){return!!this.has("119")&&"button"==this.get("119")},getMaxLength:function(){return this.has("120")?this.hasValue("120")?this.getValue("120"):this.get("120"):"false"},maxLengthIsFalse:function(){return!this.has("120")||"false"==this.get("120")},maxLengthIsWords:function(){return!!this.has("120")&&"words"==this.get("120")},maxLengthIsChars:function(){return!!this.has("120")&&"chars"==this.get("120")},getMultipleDestinations:function(){return this.has("122")?this.hasValue("122")?this.getValue("122"):this.get("122"):"one"},multipleDestinationsIsOne:function(){return!this.has("122")||"one"==this.get("122")},multipleDestinationsIsUnlimited:function(){return!!this.has("122")&&"unlimited"==this.get("122")},multipleDestinationsIsRestricted:function(){return!!this.has("122")&&"restricted"==this.get("122")},getDropIndicator:function(){return this.has("128")?this.hasValue("128")?this.getValue("128"):this.get("128"):"true"},dropIndicatorIsTrue:function(){return!this.has("128")||"true"==this.get("128")},dropIndicatorIsFalse:function(){return!!this.has("128")&&"false"==this.get("128")},getCardBack:function(){return this.has("148")?this.hasValue("148")?this.getValue("148"):this.get("148"):"default"},cardBackIsDefault:function(){return!this.has("148")||"default"==this.get("148")},cardBackIsDefaultsets:function(){return!!this.has("148")&&"defaultsets"==this.get("148")},cardBackIsImage:function(){return!!this.has("148")&&"image"==this.get("148")},cardBackIsImagesets:function(){return!!this.has("148")&&"imagesets"==this.get("148")},getCardLayout:function(){return this.has("149")?this.hasValue("149")?this.getValue("149"):this.get("149"):"default"},cardLayoutIsDefault:function(){return!this.has("149")||"default"==this.get("149")},cardLayoutIsSets:function(){return!!this.has("149")&&"sets"==this.get("149")},getCardFormat:function(){return this.has("150")?this.hasValue("150")?this.getValue("150"):this.get("150"):"portrait"},cardFormatIsPortrait:function(){return!this.has("150")||"portrait"==this.get("150")},cardFormatIsLandscape:function(){return!!this.has("150")&&"landscape"==this.get("150")},cardFormatIsSquare:function(){return!!this.has("150")&&"square"==this.get("150")},getLinkingLinesSets:function(){return this.has("154")?this.hasValue("154")?this.getValue("154"):this.get("154"):"pairs"},linkingLinesSetsIsPairs:function(){return!this.has("154")||"pairs"==this.get("154")},linkingLinesSetsIsTriplets:function(){return!!this.has("154")&&"triplets"==this.get("154")},linkingLinesSetsIsQuadruples:function(){return!!this.has("154")&&"quadruples"==this.get("154")},linkingLinesSetsIsQuintuples:function(){return!!this.has("154")&&"quintuples"==this.get("154")},getSize:function(){return this.has("158")?this.hasValue("158")?this.getValue("158"):this.get("158"):"dummy"},sizeIsDummy:function(){return!this.has("158")||"dummy"==this.get("158")},getCase:function(){return this.has("160")?this.hasValue("160")?this.getValue("160"):this.get("160"):"upper"},caseIsUpper:function(){return!this.has("160")||"upper"==this.get("160")},caseIsLower:function(){return!!this.has("160")&&"lower"==this.get("160")},getStayinview:function(){return this.has("162")?this.hasValue("162")?this.getValue("162"):this.get("162"):"false"},stayinviewIsFalse:function(){return!this.has("162")||"false"==this.get("162")},stayinviewIsTrue:function(){return!!this.has("162")&&"true"==this.get("162")},getDragAlignment:function(){return this.has("300")?this.hasValue("300")?this.getValue("300"):this.get("300"):"vertical"},dragAlignmentIsVertical:function(){return!this.has("300")||"vertical"==this.get("300")},dragAlignmentIsHorizontal:function(){return!!this.has("300")&&"horizontal"==this.get("300")},dragAlignmentIsHorizontal_single_word:function(){return!!this.has("300")&&"horizontal_single_word"==this.get("300")},getHideRadiobuttons:function(){return this.has("302")?this.hasValue("302")?this.getValue("302"):this.get("302"):"false"},hideRadiobuttonsIsFalse:function(){return!this.has("302")||"false"==this.get("302")},hideRadiobuttonsIsTrue:function(){return!!this.has("302")&&"true"==this.get("302")},hideRadiobuttonsIsCustom:function(){return!!this.has("302")&&"custom"==this.get("302")},getClueposition:function(){return this.has("305")?this.hasValue("305")?this.getValue("305"):this.get("305"):"inside"},cluepositionIsInside:function(){return!this.has("305")||"inside"==this.get("305")},cluepositionIsOutside:function(){return!!this.has("305")&&"outside"==this.get("305")},getChoiceAlignment:function(){return this.has("306")?this.hasValue("306")?this.getValue("306"):this.get("306"):"vertical"},choiceAlignmentIsVertical:function(){return!this.has("306")||"vertical"==this.get("306")},choiceAlignmentIsHorizontal:function(){return!!this.has("306")&&"horizontal"==this.get("306")},choiceAlignmentIsInline:function(){return!!this.has("306")&&"inline"==this.get("306")},getCheckAnswers:function(){return this.has("311")?this.hasValue("311")?this.getValue("311"):this.get("311"):"always"},checkAnswersIsAlways:function(){return!this.has("311")||"always"==this.get("311")},checkAnswersIsFalse:function(){return!!this.has("311")&&"false"==this.get("311")},checkAnswersIsAfterOne:function(){return!!this.has("311")&&"afterOne"==this.get("311")},checkAnswersIsAfterAll:function(){return!!this.has("311")&&"afterAll"==this.get("311")},checkAnswersIsBeforeSubmitted:function(){return!!this.has("311")&&"beforeSubmitted"==this.get("311")},getSeeAnswers:function(){return this.has("312")?this.hasValue("312")?this.getValue("312"):this.get("312"):"on"},seeAnswersIsOn:function(){return!this.has("312")||"on"==this.get("312")},seeAnswersIsOff:function(){return!!this.has("312")&&"off"==this.get("312")},seeAnswersIsBeforeInteraction:function(){return!!this.has("312")&&"beforeInteraction"==this.get("312")},getReset:function(){return this.has("313")?this.hasValue("313")?this.getValue("313"):this.get("313"):"on"},resetIsOn:function(){return!this.has("313")||"on"==this.get("313")},resetIsOff:function(){return!!this.has("313")&&"off"==this.get("313")},resetIsBeforeSubmitted:function(){return!!this.has("313")&&"beforeSubmitted"==this.get("313")},getSubmissions:function(){return this.has("315")?this.hasValue("315")?this.getValue("315"):this.get("315"):"1"},submissionsIs1:function(){return!this.has("315")||"1"==this.get("315")},submissionsIs2:function(){return!!this.has("315")&&"2"==this.get("315")},submissionsIs3:function(){return!!this.has("315")&&"3"==this.get("315")},submissionsIs4:function(){return!!this.has("315")&&"4"==this.get("315")},submissionsIs5:function(){return!!this.has("315")&&"5"==this.get("315")},submissionsIs6:function(){return!!this.has("315")&&"6"==this.get("315")},submissionsIs7:function(){return!!this.has("315")&&"7"==this.get("315")},submissionsIs8:function(){return!!this.has("315")&&"8"==this.get("315")},submissionsIs9:function(){return!!this.has("315")&&"9"==this.get("315")},submissionsIs10:function(){return!!this.has("315")&&"10"==this.get("315")},submissionsIs11:function(){return!!this.has("315")&&"11"==this.get("315")},submissionsIs12:function(){return!!this.has("315")&&"12"==this.get("315")},submissionsIs13:function(){return!!this.has("315")&&"13"==this.get("315")},submissionsIs14:function(){
return!!this.has("315")&&"14"==this.get("315")},submissionsIs15:function(){return!!this.has("315")&&"15"==this.get("315")},submissionsIs16:function(){return!!this.has("315")&&"16"==this.get("315")},submissionsIs17:function(){return!!this.has("315")&&"17"==this.get("315")},submissionsIs18:function(){return!!this.has("315")&&"18"==this.get("315")},submissionsIs19:function(){return!!this.has("315")&&"19"==this.get("315")},submissionsIs20:function(){return!!this.has("315")&&"20"==this.get("315")},submissionsIsUnlimited:function(){return!!this.has("315")&&"unlimited"==this.get("315")},getRunningscore:function(){return this.has("317")?this.hasValue("317")?this.getValue("317"):this.get("317"):"false"},runningscoreIsFalse:function(){return!this.has("317")||"false"==this.get("317")},runningscoreIsTrue:function(){return!!this.has("317")&&"true"==this.get("317")},getShowhints:function(){return this.has("318")?this.hasValue("318")?this.getValue("318"):this.get("318"):"off"},showhintsIsOff:function(){return!this.has("318")||"off"==this.get("318")},showhintsIsAlways:function(){return!!this.has("318")&&"always"==this.get("318")},showhintsIsCheckScore:function(){return!!this.has("318")&&"checkScore"==this.get("318")},getHints:function(){return this.has("319")?this.hasValue("319")?this.getValue("319"):this.get("319"):"false"},hintsIsFalse:function(){return!this.has("319")||"false"==this.get("319")},hintsIsCustom:function(){return!!this.has("319")&&"custom"==this.get("319")},getDelayedFeedback:function(){return this.has("322")?this.hasValue("322")?this.getValue("322"):this.get("322"):"false"},delayedFeedbackIsFalse:function(){return!this.has("322")||"false"==this.get("322")},delayedFeedbackIsTrue:function(){return!!this.has("322")&&"true"==this.get("322")},delayedFeedbackIsCustom:function(){return!!this.has("322")&&"custom"==this.get("322")},getCaseInsensitive:function(){return this.has("323")?this.hasValue("323")?this.getValue("323"):this.get("323"):"false"},caseInsensitiveIsFalse:function(){return!this.has("323")||"false"==this.get("323")},caseInsensitiveIsTrue:function(){return!!this.has("323")&&"true"==this.get("323")},getIgnorePunctuation:function(){return this.has("324")?this.hasValue("324")?this.getValue("324"):this.get("324"):"false"},ignorePunctuationIsFalse:function(){return!this.has("324")||"false"==this.get("324")},ignorePunctuationIsTrue:function(){return!!this.has("324")&&"true"==this.get("324")},getRandomiseanswers:function(){return this.has("326")?this.hasValue("326")?this.getValue("326"):this.get("326"):"true"},randomiseanswersIsTrue:function(){return!this.has("326")||"true"==this.get("326")},randomiseanswersIsFalse:function(){return!!this.has("326")&&"false"==this.get("326")},getCardPerRow:function(){return this.has("327")?this.hasValue("327")?this.getValue("327"):this.get("327"):"cards"},cardPerRowIsCards:function(){return!this.has("327")||"cards"==this.get("327")},getHideCheckboxes:function(){return this.has("330")?this.hasValue("330")?this.getValue("330"):this.get("330"):"false"},hideCheckboxesIsFalse:function(){return!this.has("330")||"false"==this.get("330")},hideCheckboxesIsTrue:function(){return!!this.has("330")&&"true"==this.get("330")},getShowSubmit:function(){return this.has("334")?this.hasValue("334")?this.getValue("334"):this.get("334"):"always"},showSubmitIsAlways:function(){return!this.has("334")||"always"==this.get("334")},showSubmitIsOff:function(){return!!this.has("334")&&"off"==this.get("334")},showSubmitIsAfterOne:function(){return!!this.has("334")&&"afterOne"==this.get("334")},showSubmitIsAfterAll:function(){return!!this.has("334")&&"afterAll"==this.get("334")},showSubmitIsEachScreen:function(){return!!this.has("334")&&"eachScreen"==this.get("334")},getFinishSubmit:function(){return this.has("335")?this.hasValue("335")?this.getValue("335"):this.get("335"):"off"},finishSubmitIsOff:function(){return!this.has("335")||"off"==this.get("335")},finishSubmitIsOn:function(){return!!this.has("335")&&"on"==this.get("335")},getShowForward:function(){return this.has("336")?this.hasValue("336")?this.getValue("336"):this.get("336"):"always"},showForwardIsAlways:function(){return!this.has("336")||"always"==this.get("336")},showForwardIsOff:function(){return!!this.has("336")&&"off"==this.get("336")},showForwardIsAfterOne:function(){return!!this.has("336")&&"afterOne"==this.get("336")},showForwardIsAfterSubmitted:function(){return!!this.has("336")&&"afterSubmitted"==this.get("336")},showForwardIsAfterAll:function(){return!!this.has("336")&&"afterAll"==this.get("336")},showForwardIsAfterCheckAnswers:function(){return!!this.has("336")&&"afterCheckAnswers"==this.get("336")},showForwardIsAfterSeeAnswers:function(){return!!this.has("336")&&"afterSeeAnswers"==this.get("336")},getTargetzones:function(){return this.has("337")?this.hasValue("337")?this.getValue("337"):this.get("337"):"false"},targetzonesIsFalse:function(){return!this.has("337")||"false"==this.get("337")},targetzonesIsTrue:function(){return!!this.has("337")&&"true"==this.get("337")},getValidationmessage:function(){return this.has("340")?this.hasValue("340")?this.getValue("340"):this.get("340"):"false"},validationmessageIsFalse:function(){return!this.has("340")||"false"==this.get("340")},validationmessageIsCustom:function(){return!!this.has("340")&&"custom"==this.get("340")},getAutosave:function(){return this.has("341")?this.hasValue("341")?this.getValue("341"):this.get("341"):"on"},autosaveIsOn:function(){return!this.has("341")||"on"==this.get("341")},autosaveIsOff:function(){return!!this.has("341")&&"off"==this.get("341")},getIntroScreen:function(){return this.has("342")?this.hasValue("342")?this.getValue("342"):this.get("342"):"off"},introScreenIsOff:function(){return!this.has("342")||"off"==this.get("342")},introScreenIsOn:function(){return!!this.has("342")&&"on"==this.get("342")},getManualMarking:function(){return this.has("345")?this.hasValue("345")?this.getValue("345"):this.get("345"):"off"},manualMarkingIsOff:function(){return!this.has("345")||"off"==this.get("345")},manualMarkingIsOn:function(){return!!this.has("345")&&"on"==this.get("345")},getFeedbackBand1:function(){return this.has("346")?this.hasValue("346")?this.getValue("346"):this.get("346"):"false"},feedbackBand1IsFalse:function(){return!this.has("346")||"false"==this.get("346")},feedbackBand1IsCustom:function(){return!!this.has("346")&&"custom"==this.get("346")},getFeedbackBand2:function(){return this.has("347")?this.hasValue("347")?this.getValue("347"):this.get("347"):"false"},feedbackBand2IsFalse:function(){return!this.has("347")||"false"==this.get("347")},feedbackBand2IsCustom:function(){return!!this.has("347")&&"custom"==this.get("347")},getFeedbackBand3:function(){return this.has("348")?this.hasValue("348")?this.getValue("348"):this.get("348"):"false"},feedbackBand3IsFalse:function(){return!this.has("348")||"false"==this.get("348")},feedbackBand3IsCustom:function(){return!!this.has("348")&&"custom"==this.get("348")},getFeedbackBand4:function(){return this.has("349")?this.hasValue("349")?this.getValue("349"):this.get("349"):"false"},feedbackBand4IsFalse:function(){return!this.has("349")||"false"==this.get("349")},feedbackBand4IsCustom:function(){return!!this.has("349")&&"custom"==this.get("349")},getSpecialcharactersStudent:function(){return this.has("352")?this.hasValue("352")?this.getValue("352"):this.get("352"):"Scientific_Characters"},specialcharactersStudentHas:function(val){return!!this.has("352")&&this.contains("352",val)},getSpecialcharactersStudent:function(val){return this.has("352")?this.getFromJSON("352"):[]},specialcharactersStudentHasScientific_Characters:function(){return!!this.has("352")&&this.contains("352","Scientific_Characters")},specialcharactersStudentHasAncient_Greek:function(){return!!this.has("352")&&this.contains("352","Ancient_Greek")},specialcharactersStudentHasDanish:function(){return!!this.has("352")&&this.contains("352","Danish")},specialcharactersStudentHasFrench:function(){return!!this.has("352")&&this.contains("352","French")},specialcharactersStudentHasGerman:function(){return!!this.has("352")&&this.contains("352","German")},specialcharactersStudentHasPolish:function(){return!!this.has("352")&&this.contains("352","Polish")},specialcharactersStudentHasSpanish:function(){return!!this.has("352")&&this.contains("352","Spanish")},specialcharactersStudentHasSwedish:function(){return!!this.has("352")&&this.contains("352","Swedish")},specialcharactersStudentHasTurkish:function(){return!!this.has("352")&&this.contains("352","Turkish")},specialcharactersStudentHasArithmetic_Operators:function(){return!!this.has("352")&&this.contains("352","Arithmetic_Operators")},getActivityFeedbackBand1:function(){return this.has("353")?this.hasValue("353")?this.getValue("353"):this.get("353"):"false"},activityFeedbackBand1IsFalse:function(){return!this.has("353")||"false"==this.get("353")},activityFeedbackBand1IsCustom:function(){return!!this.has("353")&&"custom"==this.get("353")},getActivityFeedbackBand2:function(){return this.has("354")?this.hasValue("354")?this.getValue("354"):this.get("354"):"false"},activityFeedbackBand2IsFalse:function(){return!this.has("354")||"false"==this.get("354")},activityFeedbackBand2IsCustom:function(){return!!this.has("354")&&"custom"==this.get("354")},getActivityFeedbackBand3:function(){return this.has("355")?this.hasValue("355")?this.getValue("355"):this.get("355"):"false"},activityFeedbackBand3IsFalse:function(){return!this.has("355")||"false"==this.get("355")},activityFeedbackBand3IsCustom:function(){return!!this.has("355")&&"custom"==this.get("355")},getActivityFeedbackBand4:function(){return this.has("356")?this.hasValue("356")?this.getValue("356"):this.get("356"):"false"},activityFeedbackBand4IsFalse:function(){return!this.has("356")||"false"==this.get("356")},activityFeedbackBand4IsCustom:function(){return!!this.has("356")&&"custom"==this.get("356")},getActivityFeedbackThresholds:function(){return this.has("357")?this.hasValue("357")?this.getValue("357"):this.get("357"):"custom"},activityFeedbackThresholdsIsCustom:function(){return!this.has("357")||"custom"==this.get("357")},getSpellcheck:function(){return this.has("361")?this.hasValue("361")?this.getValue("361"):this.get("361"):"off"},spellcheckIsOff:function(){return!this.has("361")||"off"==this.get("361")},spellcheckIsOn:function(){return!!this.has("361")&&"on"==this.get("361")},getShowInColumns:function(){return this.has("362")?this.hasValue("362")?this.getValue("362"):this.get("362"):"false"},showInColumnsIsFalse:function(){return!this.has("362")||"false"==this.get("362")},showInColumnsIsTrue:function(){return!!this.has("362")&&"true"==this.get("362")},getIgnoreAccents:function(){return this.has("364")?this.hasValue("364")?this.getValue("364"):this.get("364"):"off"},ignoreAccentsIsOff:function(){return!this.has("364")||"off"==this.get("364")},ignoreAccentsIsOn:function(){return!!this.has("364")&&"on"==this.get("364")},getEraser:function(){return this.has("367")?this.hasValue("367")?this.getValue("367"):this.get("367"):"off"},eraserIsOff:function(){return!this.has("367")||"off"==this.get("367")},eraserIsOn:function(){return!!this.has("367")&&"on"==this.get("367")},getAnnotationTools:function(){return this.has("368")?this.hasValue("368")?this.getValue("368"):this.get("368"):"off"},annotationToolsIsOff:function(){return!this.has("368")||"off"==this.get("368")},annotationToolsIsOn:function(){return!!this.has("368")&&"on"==this.get("368")},annotationToolsIsOnly_for_teachers:function(){return!!this.has("368")&&"only_for_teachers"==this.get("368")},annotationToolsIsOnly_supplements:function(){return!!this.has("368")&&"only_supplements"==this.get("368")},getShowinfotext:function(){return this.has("371")?this.hasValue("371")?this.getValue("371"):this.get("371"):"off"},showinfotextIsOff:function(){return!this.has("371")||"off"==this.get("371")},showinfotextIsTooltip:function(){return!!this.has("371")&&"tooltip"==this.get("371")},showinfotextIsDialog:function(){return!!this.has("371")&&"dialog"==this.get("371")},getQuestionpool:function(){return this.has("372")?this.hasValue("372")?this.getValue("372"):this.get("372"):"no"},questionpoolIsNo:function(){return!this.has("372")||"no"==this.get("372")},questionpoolIsYes:function(){return!!this.has("372")&&"yes"==this.get("372")},getContinuousEnumeration:function(){return this.has("373")?this.hasValue("373")?this.getValue("373"):this.get("373"):"off"},continuousEnumerationIsOff:function(){return!this.has("373")||"off"==this.get("373")},continuousEnumerationIsOn:function(){return!!this.has("373")&&"on"==this.get("373")},getLOsections:function(){return this.has("375")?this.hasValue("375")?this.getValue("375"):this.get("375"):"off"},getQuestiondisplay:function(){return this.has("376")?this.hasValue("376")?this.getValue("376"):this.get("376"):"all"},questiondisplayIsAll:function(){return!this.has("376")||"all"==this.get("376")},questiondisplayIsActive:function(){return!!this.has("376")&&"active"==this.get("376")},questiondisplayIsShow_next:function(){return!!this.has("376")&&"show_next"==this.get("376")},questiondisplayIsShow_next_and_hide_previous:function(){return!!this.has("376")&&"show_next_and_hide_previous"==this.get("376")},getEndResultAlways:function(){return this.has("378")?this.hasValue("378")?this.getValue("378"):this.get("378"):"off"},endResultAlwaysIsOff:function(){return!this.has("378")||"off"==this.get("378")},endResultAlwaysIsOn:function(){return!!this.has("378")&&"on"==this.get("378")},endResultAlwaysIsButtonAfterScore:function(){return!!this.has("378")&&"buttonAfterScore"==this.get("378")},getExamsTimer:function(){return this.has("379")?this.hasValue("379")?this.getValue("379"):this.get("379"):"off"},examsTimerIsOff:function(){return!this.has("379")||"off"==this.get("379")},examsTimerIsOn:function(){return!!this.has("379")&&"on"==this.get("379")},getEnumerationinternal:function(){return this.has("382")?this.hasValue("382")?this.getValue("382"):this.get("382"):"all"},enumerationinternalIsAll:function(){return!this.has("382")||"all"==this.get("382")},enumerationinternalIsCorrect:function(){return!!this.has("382")&&"correct"==this.get("382")},getActivitypool:function(){return this.has("383")?this.hasValue("383")?this.getValue("383"):this.get("383"):"off"},activitypoolIsOff:function(){return!this.has("383")||"off"==this.get("383")},activitypoolIsOn:function(){return!!this.has("383")&&"on"==this.get("383")},activitypoolIsRandomiseAll:function(){return!!this.has("383")&&"randomiseAll"==this.get("383")},getCheckmaxattempts:function(){return this.has("384")?this.hasValue("384")?this.getValue("384"):this.get("384"):"custom"},checkmaxattemptsIsCustom:function(){return!this.has("384")||"custom"==this.get("384")},getSendscores:function(){return this.has("388")?this.hasValue("388")?this.getValue("388"):this.get("388"):"off"},sendscoresIsOff:function(){return!this.has("388")||"off"==this.get("388")},sendscoresIsUnlimited:function(){return!!this.has("388")&&"unlimited"==this.get("388")},sendscoresIs1_submission:function(){return!!this.has("388")&&"1_submission"==this.get("388")},sendscoresIsFinal_check_answers:function(){return!!this.has("388")&&"final_check_answers"==this.get("388")},getDesignPackSubstyle:function(){return this.has("390")?this.hasValue("390")?this.getValue("390"):this.get("390"):"off"},designPackSubstyleIsOff:function(){return!this.has("390")||"off"==this.get("390")},designPackSubstyleIsOn:function(){return!!this.has("390")&&"on"==this.get("390")},getEndresultsreturn:function(){return this.has("391")?this.hasValue("391")?this.getValue("391"):this.get("391"):"last"},endresultsreturnIsLast:function(){return!this.has("391")||"last"==this.get("391")},endresultsreturnIsFirst:function(){return!!this.has("391")&&"first"==this.get("391")},getScoreValuesPerBlock:function(){return this.has("394")?this.hasValue("394")?this.getValue("394"):this.get("394"):"off"},scoreValuesPerBlockIsOff:function(){return!this.has("394")||"off"==this.get("394")},scoreValuesPerBlockIsCustom:function(){return!!this.has("394")&&"Custom"==this.get("394")},getExportFile:function(){return this.has("395")?this.hasValue("395")?this.getValue("395"):this.get("395"):"off"},exportFileIsOff:function(){return!this.has("395")||"off"==this.get("395")},exportFileIsOn:function(){return!!this.has("395")&&"on"==this.get("395")},getTextboxAutogrow:function(){return this.has("396")?this.hasValue("396")?this.getValue("396"):this.get("396"):"off"},textboxAutogrowIsOff:function(){return!this.has("396")||"off"==this.get("396")},textboxAutogrowIsOn:function(){return!!this.has("396")&&"on"==this.get("396")},getCheckboxSelections:function(){return this.has("397")?this.hasValue("397")?this.getValue("397"):this.get("397"):"total_correct"},checkboxSelectionsIsTotal_correct:function(){return!this.has("397")||"total_correct"==this.get("397")},checkboxSelectionsIsAll:function(){return!!this.has("397")&&"all"==this.get("397")},getRepeatAnswers:function(){return this.has("398")?this.hasValue("398")?this.getValue("398"):this.get("398"):"allow"},repeatAnswersIsAllow:function(){return!this.has("398")||"allow"==this.get("398")},repeatAnswersIsPrevent:function(){return!!this.has("398")&&"prevent"==this.get("398")},getFreeDragLocation:function(){return this.has("399")?this.hasValue("399")?this.getValue("399"):this.get("399"):"off"},freeDragLocationIsOff:function(){return!this.has("399")||"off"==this.get("399")},freeDragLocationIsBetween_words:function(){return!!this.has("399")&&"between_words"==this.get("399")},freeDragLocationIsBetween_letters:function(){return!!this.has("399")&&"between_letters"==this.get("399")},getPoolStacks:function(){return this.has("400")?this.hasValue("400")?this.getValue("400"):this.get("400"):"off"},poolStacksIsOff:function(){return!this.has("400")||"off"==this.get("400")},poolStacksIs1:function(){return!!this.has("400")&&"1"==this.get("400")},poolStacksIs2:function(){return!!this.has("400")&&"2"==this.get("400")},poolStacksIs3:function(){return!!this.has("400")&&"3"==this.get("400")},poolStacksIs4:function(){return!!this.has("400")&&"4"==this.get("400")},getAudioingap:function(){return this.has("401")?this.hasValue("401")?this.getValue("401"):this.get("401"):"off"},audioingapIsOff:function(){return!this.has("401")||"off"==this.get("401")},audioingapIsOn:function(){return!!this.has("401")&&"on"==this.get("401")},getOrderDependency:function(){return this.has("402")?this.hasValue("402")?this.getValue("402"):this.get("402"):"off"},orderDependencyIsOff:function(){return!this.has("402")||"off"==this.get("402")},orderDependencyIsFirst_answer:function(){return!!this.has("402")&&"first_answer"==this.get("402")},orderDependencyIsOn:function(){return!!this.has("402")&&"on"==this.get("402")},getGapResize:function(){return this.has("403")?this.hasValue("403")?this.getValue("403"):this.get("403"):"off"},gapResizeIsOff:function(){return!this.has("403")||"off"==this.get("403")},gapResizeIsOn:function(){return!!this.has("403")&&"on"==this.get("403")},getScorecalculation:function(){return this.has("404")?this.hasValue("404")?this.getValue("404"):this.get("404"):"onlyCorrect"},scorecalculationIsOnlyCorrect:function(){return!this.has("404")||"onlyCorrect"==this.get("404")},scorecalculationIsSubtractIncorrect:function(){return!!this.has("404")&&"subtractIncorrect"==this.get("404")},getPoolorder:function(){return this.has("406")?this.hasValue("406")?this.getValue("406"):this.get("406"):"off"},poolorderIsOff:function(){return!this.has("406")||"off"==this.get("406")},poolorderIsAlphabetical:function(){return!!this.has("406")&&"alphabetical"==this.get("406")},poolorderIsNatural:function(){return!!this.has("406")&&"natural"==this.get("406")},getAutomaticcapitalisation:function(){return this.has("407")?this.hasValue("407")?this.getValue("407"):this.get("407"):"off"},automaticcapitalisationIsOff:function(){return!this.has("407")||"off"==this.get("407")},automaticcapitalisationIsOn:function(){return!!this.has("407")&&"on"==this.get("407")},getMarkingstyle:function(){return this.has("408")?this.hasValue("408")?this.getValue("408"):this.get("408"):"highlight"},markingstyleIsHighlight:function(){return!this.has("408")||"highlight"==this.get("408")},markingstyleIsCircle:function(){return!!this.has("408")&&"circle"==this.get("408")},markingstyleIsUnderline:function(){return!!this.has("408")&&"underline"==this.get("408")},getContainerStyle:function(){return this.has("412")?this.hasValue("412")?this.getValue("412"):this.get("412"):"normal"},containerStyleIsNormal:function(){return!this.has("412")||"normal"==this.get("412")},containerStyleIsCustom:function(){return!!this.has("412")&&"custom"==this.get("412")},getAnswerdisplay:function(){return this.has("416")?this.hasValue("416")?this.getValue("416"):this.get("416"):"columns"},answerdisplayIsColumns:function(){return!this.has("416")||"columns"==this.get("416")},answerdisplayIsRows:function(){return!!this.has("416")&&"rows"==this.get("416")},getLinkbehaviour:function(){return this.has("417")?this.hasValue("417")?this.getValue("417"):this.get("417"):"drag"},linkbehaviourIsDrag:function(){return!this.has("417")||"drag"==this.get("417")},linkbehaviourIsTouch:function(){return!!this.has("417")&&"touch"==this.get("417")},getRestoreLOState:function(){return this.has("419")?this.hasValue("419")?this.getValue("419"):this.get("419"):"on"},restoreLOStateIsOn:function(){return!this.has("419")||"on"==this.get("419")},restoreLOStateIsOff:function(){return!!this.has("419")&&"off"==this.get("419")},getWikiTool:function(){return this.has("421")?this.hasValue("421")?this.getValue("421"):this.get("421"):"off"},wikiToolIsOff:function(){return!this.has("421")||"off"==this.get("421")},wikiToolIsOn:function(){return!!this.has("421")&&"on"==this.get("421")},getOperator:function(){return this.has("422")?this.hasValue("422")?this.getValue("422"):this.get("422"):"addition"},operatorIsAddition:function(){return!this.has("422")||"addition"==this.get("422")},operatorIsMultiplication:function(){return!!this.has("422")&&"multiplication"==this.get("422")},getGapcharacters:function(){return this.has("425")?this.hasValue("425")?this.getValue("425"):this.get("425"):"dontshow"},gapcharactersIsDontshow:function(){return!this.has("425")||"dontshow"==this.get("425")},gapcharactersIsShow:function(){return!!this.has("425")&&"show"==this.get("425")},getLayers:function(){return this.has("426")?this.hasValue("426")?this.getValue("426"):this.get("426"):"2"},layersIs2:function(){return!this.has("426")||"2"==this.get("426")},layersIs3:function(){return!!this.has("426")&&"3"==this.get("426")},layersIs4:function(){return!!this.has("426")&&"4"==this.get("426")},layersIs5:function(){return!!this.has("426")&&"5"==this.get("426")},layersIs6:function(){return!!this.has("426")&&"6"==this.get("426")},getTeamscoring:function(){return this.has("427")?this.hasValue("427")?this.getValue("427"):this.get("427"):"off"},teamscoringIsOff:function(){return!this.has("427")||"off"==this.get("427")},teamscoringIsOn:function(){return!!this.has("427")&&"on"==this.get("427")},getReferenceContent:function(){return this.has("428")?this.hasValue("428")?this.getValue("428"):this.get("428"):"off"},referenceContentIsOff:function(){return!this.has("428")||"off"==this.get("428")},referenceContentIs1:function(){return!!this.has("428")&&"1"==this.get("428")},referenceContentIs2:function(){return!!this.has("428")&&"2"==this.get("428")},getAlternativeText:function(){return this.has("430")?this.hasValue("430")?this.getValue("430"):this.get("430"):"off"},alternativeTextIsOff:function(){return!this.has("430")||"off"==this.get("430")},alternativeTextIsAlt1:function(){return!!this.has("430")&&"alt1"==this.get("430")},alternativeTextIsAlt2:function(){return!!this.has("430")&&"alt2"==this.get("430")},alternativeTextIsAlt3:function(){return!!this.has("430")&&"alt3"==this.get("430")},getAudioPlayback:function(){return this.has("431")?this.hasValue("431")?this.getValue("431"):this.get("431"):"auto"},audioPlaybackIsAuto:function(){return!this.has("431")||"auto"==this.get("431")},audioPlaybackIsManual:function(){return!!this.has("431")&&"manual"==this.get("431")},audioPlaybackIsBefore_card_flip:function(){return!!this.has("431")&&"before_card_flip"==this.get("431")},getLOtitledisplay:function(){return this.has("432")?this.hasValue("432")?this.getValue("432"):this.get("432"):"on"},lOtitledisplayIsOn:function(){return!this.has("432")||"on"==this.get("432")},lOtitledisplayIsOff:function(){return!!this.has("432")&&"off"==this.get("432")},getActivitytitledisplay:function(){return this.has("433")?this.hasValue("433")?this.getValue("433"):this.get("433"):"on"},activitytitledisplayIsOn:function(){return!this.has("433")||"on"==this.get("433")},activitytitledisplayIsOff:function(){return!!this.has("433")&&"off"==this.get("433")},getNumbercolumns:function(){return this.has("435")?this.hasValue("435")?this.getValue("435"):this.get("435"):"3"},numbercolumnsIs3:function(){return!this.has("435")||"3"==this.get("435")},numbercolumnsIs4:function(){return!!this.has("435")&&"4"==this.get("435")},numbercolumnsIs5:function(){return!!this.has("435")&&"5"==this.get("435")},getAutomaticplay:function(){return this.has("437")?this.hasValue("437")?this.getValue("437"):this.get("437"):"off"},automaticplayIsOff:function(){return!this.has("437")||"off"==this.get("437")},automaticplayIsOn:function(){return!!this.has("437")&&"on"==this.get("437")},automaticplayIsOn_magnify:function(){return!!this.has("437")&&"on_magnify"==this.get("437")},getShufflecontrol:function(){return this.has("438")?this.hasValue("438")?this.getValue("438"):this.get("438"):"off"},shufflecontrolIsOff:function(){return!this.has("438")||"off"==this.get("438")},shufflecontrolIsOn:function(){return!!this.has("438")&&"on"==this.get("438")},getAdditionalimagecontrol:function(){return this.has("439")?this.hasValue("439")?this.getValue("439"):this.get("439"):"off"},additionalimagecontrolIsOff:function(){return!this.has("439")||"off"==this.get("439")},additionalimagecontrolIsOn:function(){return!!this.has("439")&&"on"==this.get("439")},getAudioiconbehaviour:function(){return this.has("441")?this.hasValue("441")?this.getValue("441"):this.get("441"):"stop"},audioiconbehaviourIsStop:function(){return!this.has("441")||"stop"==this.get("441")},audioiconbehaviourIsPause:function(){return!!this.has("441")&&"pause"==this.get("441")},getUserselection:function(){return this.has("442")?this.hasValue("442")?this.getValue("442"):this.get("442"):"off"},userselectionIsOff:function(){return!this.has("442")||"off"==this.get("442")},userselectionIsSelect_for_correct:function(){return!!this.has("442")&&"select_for_correct"==this.get("442")},userselectionIsSelect_for_error:function(){return!!this.has("442")&&"select_for_error"==this.get("442")},getLOfullscreenbutton:function(){return this.has("443")?this.hasValue("443")?this.getValue("443"):this.get("443"):"off"},lOfullscreenbuttonIsOff:function(){return!this.has("443")||"off"==this.get("443")},lOfullscreenbuttonIsOn:function(){return!!this.has("443")&&"on"==this.get("443")},getUserVisibility:function(){return this.has("445")?this.hasValue("445")?this.getValue("445"):this.get("445"):"all"},userVisibilityIsAll:function(){return!this.has("445")||"all"==this.get("445")},userVisibilityIsTeacher:function(){return!!this.has("445")&&"teacher"==this.get("445")},userVisibilityIsStudent:function(){return!!this.has("445")&&"student"==this.get("445")},getCluesincolumns:function(){return this.has("446")?this.hasValue("446")?this.getValue("446"):this.get("446"):"off"},cluesincolumnsIsOff:function(){return!this.has("446")||"off"==this.get("446")},cluesincolumnsIsOn:function(){return!!this.has("446")&&"on"==this.get("446")},getTryAgainBehaviour:function(){return this.has("448")?this.hasValue("448")?this.getValue("448"):this.get("448"):"button"},tryAgainBehaviourIsButton:function(){return!this.has("448")||"button"==this.get("448")},tryAgainBehaviourIsAutomatic:function(){return!!this.has("448")&&"automatic"==this.get("448")},getSeeallanswers:function(){return this.has("449")?this.hasValue("449")?this.getValue("449"):this.get("449"):"off"},seeallanswersIsOff:function(){return!this.has("449")||"off"==this.get("449")},seeallanswersIsOn:function(){return!!this.has("449")&&"on"==this.get("449")},getSeenextanswer:function(){return this.has("450")?this.hasValue("450")?this.getValue("450"):this.get("450"):"off"},seenextanswerIsOff:function(){return!this.has("450")||"off"==this.get("450")},seenextanswerIsOn:function(){return!!this.has("450")&&"on"==this.get("450")},getNavigationMenu:function(){return this.has("452")?this.hasValue("452")?this.getValue("452"):this.get("452"):"off"},navigationMenuIsOff:function(){return!this.has("452")||"off"==this.get("452")},navigationMenuIsAuto:function(){return!!this.has("452")&&"auto"==this.get("452")},navigationMenuIsCustom:function(){return!!this.has("452")&&"custom"==this.get("452")},getDisplaySettings:function(){return this.has("453")?this.hasValue("453")?this.getValue("453"):this.get("453"):"off"},displaySettingsIsOff:function(){return!this.has("453")||"off"==this.get("453")},displaySettingsIsOn:function(){return!!this.has("453")&&"on"==this.get("453")},getResourceBanks:function(){return this.has("454")?this.hasValue("454")?this.getValue("454"):this.get("454"):"off"},resourceBanksIsOff:function(){return!this.has("454")||"off"==this.get("454")},resourceBanksIsOn:function(){return!!this.has("454")&&"on"==this.get("454")},getTTSGeneralRules:function(){return this.has("455")?this.hasValue("455")?this.getValue("455"):this.get("455"):"off"},tTSGeneralRulesIsOff:function(){return!this.has("455")||"off"==this.get("455")},tTSGeneralRulesIsOn:function(){return!!this.has("455")&&"on"==this.get("455")},getTTSLORules:function(){return this.has("456")?this.hasValue("456")?this.getValue("456"):this.get("456"):"off"},tTSLORulesIsOff:function(){return!this.has("456")||"off"==this.get("456")},tTSLORulesIsOn:function(){return!!this.has("456")&&"on"==this.get("456")},getTTSActivityRules:function(){return this.has("457")?this.hasValue("457")?this.getValue("457"):this.get("457"):"off"},tTSActivityRulesIsOff:function(){return!this.has("457")||"off"==this.get("457")},tTSActivityRulesIsOn:function(){return!!this.has("457")&&"on"==this.get("457")},getActivityhelp:function(){return this.has("459")?this.hasValue("459")?this.getValue("459"):this.get("459"):"off"},activityhelpIsOff:function(){return!this.has("459")||"off"==this.get("459")},activityhelpIsOn:function(){return!!this.has("459")&&"on"==this.get("459")},getFeedbackCorrect:function(){return this.has("462")?this.hasValue("462")?this.getValue("462"):this.get("462"):"no"},feedbackCorrectIsNo:function(){return!this.has("462")||"no"==this.get("462")},feedbackCorrectIsCustom:function(){return!!this.has("462")&&"custom"==this.get("462")},getFeedbackIncorrect:function(){return this.has("463")?this.hasValue("463")?this.getValue("463"):this.get("463"):"no"},feedbackIncorrectIsNo:function(){return!this.has("463")||"no"==this.get("463")},feedbackIncorrectIsCustom:function(){return!!this.has("463")&&"custom"==this.get("463")},getTargetimage:function(){return this.has("465")?this.hasValue("465")?this.getValue("465"):this.get("465"):"custom"},targetimageIsCustom:function(){return!this.has("465")||"custom"==this.get("465")},getTargetGeneratorimage:function(){return this.has("466")?this.hasValue("466")?this.getValue("466"):this.get("466"):"custom"},targetGeneratorimageIsCustom:function(){return!this.has("466")||"custom"==this.get("466")},getTargetGeneratorlocation:function(){return this.has("467")?this.hasValue("467")?this.getValue("467"):this.get("467"):"bottom_right"},targetGeneratorlocationIsBottom_right:function(){return!this.has("467")||"bottom_right"==this.get("467")},targetGeneratorlocationIsBottom_left:function(){return!!this.has("467")&&"bottom_left"==this.get("467")},targetGeneratorlocationIsTop_right:function(){
return!!this.has("467")&&"top_right"==this.get("467")},targetGeneratorlocationIsTop_left:function(){return!!this.has("467")&&"top_left"==this.get("467")},getSelectedTargetimage:function(){return this.has("469")?this.hasValue("469")?this.getValue("469"):this.get("469"):"custom"},selectedTargetimageIsCustom:function(){return!this.has("469")||"custom"==this.get("469")},getBackgroundimage:function(){return this.has("470")?this.hasValue("470")?this.getValue("470"):this.get("470"):"custom"},backgroundimageIsCustom:function(){return!this.has("470")||"custom"==this.get("470")},getScoreboard:function(){return this.has("471")?this.hasValue("471")?this.getValue("471"):this.get("471"):"off"},scoreboardIsOff:function(){return!this.has("471")||"off"==this.get("471")},scoreboardIsOn:function(){return!!this.has("471")&&"on"==this.get("471")},getCountdowntimer:function(){return this.has("472")?this.hasValue("472")?this.getValue("472"):this.get("472"):"off"},countdowntimerIsOff:function(){return!this.has("472")||"off"==this.get("472")},countdowntimerIsOn:function(){return!!this.has("472")&&"on"==this.get("472")},getMaximumduration:function(){return this.has("473")?this.hasValue("473")?this.getValue("473"):this.get("473"):"off"},maximumdurationIsOff:function(){return!this.has("473")||"off"==this.get("473")},maximumdurationIsCustom:function(){return!!this.has("473")&&"custom"==this.get("473")},getMaximumitems:function(){return this.has("474")?this.hasValue("474")?this.getValue("474"):this.get("474"):"off"},maximumitemsIsOff:function(){return!this.has("474")||"off"==this.get("474")},maximumitemsIsCustom:function(){return!!this.has("474")&&"custom"==this.get("474")},getMovementspeed:function(){return this.has("475")?this.hasValue("475")?this.getValue("475"):this.get("475"):"slow"},movementspeedIsSlow:function(){return!this.has("475")||"slow"==this.get("475")},movementspeedIsMedium:function(){return!!this.has("475")&&"medium"==this.get("475")},movementspeedIsFast:function(){return!!this.has("475")&&"fast"==this.get("475")},getGenerationspeed:function(){return this.has("476")?this.hasValue("476")?this.getValue("476"):this.get("476"):"slow"},generationspeedIsSlow:function(){return!this.has("476")||"slow"==this.get("476")},generationspeedIsMedium:function(){return!!this.has("476")&&"medium"==this.get("476")},generationspeedIsFast:function(){return!!this.has("476")&&"fast"==this.get("476")},getGameOvermessage:function(){return this.has("477")?this.hasValue("477")?this.getValue("477"):this.get("477"):"custom"},gameOvermessageIsCustom:function(){return!this.has("477")||"custom"==this.get("477")},getSolutionHint:function(){return this.has("479")?this.hasValue("479")?this.getValue("479"):this.get("479"):"off"},solutionHintIsOff:function(){return!this.has("479")||"off"==this.get("479")},solutionHintIsOn:function(){return!!this.has("479")&&"on"==this.get("479")},getIgnoreSpaces:function(){return this.has("480")?this.hasValue("480")?this.getValue("480"):this.get("480"):"off"},ignoreSpacesIsOff:function(){return!this.has("480")||"off"==this.get("480")},ignoreSpacesIsOn:function(){return!!this.has("480")&&"on"==this.get("480")},getNumberInput:function(){return this.has("483")?this.hasValue("483")?this.getValue("483"):this.get("483"):"any"},numberInputIsAny:function(){return!this.has("483")||"any"==this.get("483")},numberInputIsNatural:function(){return!!this.has("483")&&"natural"==this.get("483")},numberInputIsInteger:function(){return!!this.has("483")&&"integer"==this.get("483")},getCopyrightInformation:function(){return this.has("484")?this.hasValue("484")?this.getValue("484"):this.get("484"):"off"},copyrightInformationIsOff:function(){return!this.has("484")||"off"==this.get("484")},copyrightInformationIsOn:function(){return!!this.has("484")&&"on"==this.get("484")},getTargetonscreenduration:function(){return this.has("485")?this.hasValue("485")?this.getValue("485"):this.get("485"):"off"},targetonscreendurationIsOff:function(){return!this.has("485")||"off"==this.get("485")},targetonscreendurationIsCustom:function(){return!!this.has("485")&&"custom"==this.get("485")},getOnlineCheck:function(){return this.has("487")?this.hasValue("487")?this.getValue("487"):this.get("487"):"off"},onlineCheckIsOff:function(){return!this.has("487")||"off"==this.get("487")},onlineCheckIsOn:function(){return!!this.has("487")&&"on"==this.get("487")},getSignaltargets:function(){return this.has("492")?this.hasValue("492")?this.getValue("492"):this.get("492"):"off"},signaltargetsIsOff:function(){return!this.has("492")||"off"==this.get("492")},signaltargetsIsOn:function(){return!!this.has("492")&&"on"==this.get("492")},getCheckanswersinstant:function(){return this.has("493")?this.hasValue("493")?this.getValue("493"):this.get("493"):"off"},checkanswersinstantIsOff:function(){return!this.has("493")||"off"==this.get("493")},checkanswersinstantIsOn:function(){return!!this.has("493")&&"on"==this.get("493")},getValidatedependentgaps:function(){return this.has("495")?this.hasValue("495")?this.getValue("495"):this.get("495"):"off"},validatedependentgapsIsOff:function(){return!this.has("495")||"off"==this.get("495")},validatedependentgapsIsOn:function(){return!!this.has("495")&&"on"==this.get("495")},getPlayall:function(){return this.has("497")?this.hasValue("497")?this.getValue("497"):this.get("497"):"off"},playallIsOff:function(){return!this.has("497")||"off"==this.get("497")},playallIsOn:function(){return!!this.has("497")&&"on"==this.get("497")},getDownloadaudio:function(){return this.has("498")?this.hasValue("498")?this.getValue("498"):this.get("498"):"off"},downloadaudioIsOff:function(){return!this.has("498")||"off"==this.get("498")},downloadaudioIsOn:function(){return!!this.has("498")&&"on"==this.get("498")},getHidelines:function(){return this.has("499")?this.hasValue("499")?this.getValue("499"):this.get("499"):"off"},hidelinesIsOff:function(){return!this.has("499")||"off"==this.get("499")},hidelinesIsOn:function(){return!!this.has("499")&&"on"==this.get("499")},getGapfillbehaviour:function(){return this.has("501")?this.hasValue("501")?this.getValue("501"):this.get("501"):"drag"},gapfillbehaviourIsDrag:function(){return!this.has("501")||"drag"==this.get("501")},gapfillbehaviourIsTap_item:function(){return!!this.has("501")&&"tap_item"==this.get("501")},gapfillbehaviourIsTap_target:function(){return!!this.has("501")&&"tap_target"==this.get("501")},gapfillbehaviourIsTap_swap:function(){return!!this.has("501")&&"tap_swap"==this.get("501")},getGroupheadings:function(){return this.has("502")?this.hasValue("502")?this.getValue("502"):this.get("502"):"off"},groupheadingsIsOff:function(){return!this.has("502")||"off"==this.get("502")},groupheadingsIsCustom:function(){return!!this.has("502")&&"custom"==this.get("502")},getDisplayascompleted:function(){return this.has("503")?this.hasValue("503")?this.getValue("503"):this.get("503"):"off"},displayascompletedIsOff:function(){return!this.has("503")||"off"==this.get("503")},displayascompletedIsOn:function(){return!!this.has("503")&&"on"==this.get("503")},getOriginoftargets:function(){return this.has("504")?this.hasValue("504")?this.getValue("504"):this.get("504"):"default"},originoftargetsIsDefault:function(){return!this.has("504")||"default"==this.get("504")},originoftargetsIsCustom:function(){return!!this.has("504")&&"custom"==this.get("504")},getTranslationBlock:function(){return this.has("505")?this.hasValue("505")?this.getValue("505"):this.get("505"):"off"},translationBlockIsOff:function(){return!this.has("505")||"off"==this.get("505")},translationBlockIsOn:function(){return!!this.has("505")&&"on"==this.get("505")},getFlashfirstanswer:function(){return this.has("508")?this.hasValue("508")?this.getValue("508"):this.get("508"):"off"},flashfirstanswerIsOff:function(){return!this.has("508")||"off"==this.get("508")},flashfirstanswerIsOn:function(){return!!this.has("508")&&"on"==this.get("508")},getSetUserRole:function(){return this.has("509")?this.hasValue("509")?this.getValue("509"):this.get("509"):"Free"},setUserRoleIsFree:function(){return!this.has("509")||"Free"==this.get("509")},setUserRoleIsRole_1:function(){return!!this.has("509")&&"role_1"==this.get("509")},setUserRoleIsRole_2:function(){return!!this.has("509")&&"role_2"==this.get("509")},getScoreRounding:function(){return this.has("510")?this.hasValue("510")?this.getValue("510"):this.get("510"):"float"},scoreRoundingIsFloat:function(){return!this.has("510")||"float"==this.get("510")},scoreRoundingIsRoundup:function(){return!!this.has("510")&&"roundup"==this.get("510")},scoreRoundingIsRound:function(){return!!this.has("510")&&"round"==this.get("510")},scoreRoundingIsRounddown:function(){return!!this.has("510")&&"rounddown"==this.get("510")},getNextbuttontext:function(){return this.has("511")?this.hasValue("511")?this.getValue("511"):this.get("511"):"default"},nextbuttontextIsDefault:function(){return!this.has("511")||"default"==this.get("511")},nextbuttontextIsCustom:function(){return!!this.has("511")&&"custom"==this.get("511")},getCheckAnswersDisplay:function(){return this.has("512")?this.hasValue("512")?this.getValue("512"):this.get("512"):"marking_and_feedback"},checkAnswersDisplayIsMarking_and_feedback:function(){return!this.has("512")||"marking_and_feedback"==this.get("512")},checkAnswersDisplayIsMarking_only:function(){return!!this.has("512")&&"marking_only"==this.get("512")},getOriginalAudioPlayback:function(){return this.has("513")?this.hasValue("513")?this.getValue("513"):this.get("513"):"both_roles"},originalAudioPlaybackIsBoth_roles:function(){return!this.has("513")||"both_roles"==this.get("513")},originalAudioPlaybackIsNon_selected_role_only:function(){return!!this.has("513")&&"non_selected_role_only"==this.get("513")},getNumberofchances:function(){return this.has("516")?this.hasValue("516")?this.getValue("516"):this.get("516"):"1"},numberofchancesIs1:function(){return!this.has("516")||"1"==this.get("516")},numberofchancesIs2:function(){return!!this.has("516")&&"2"==this.get("516")},numberofchancesIs3:function(){return!!this.has("516")&&"3"==this.get("516")},numberofchancesIs4:function(){return!!this.has("516")&&"4"==this.get("516")},numberofchancesIs5:function(){return!!this.has("516")&&"5"==this.get("516")},getKeyboarddisplay:function(){return this.has("517")?this.hasValue("517")?this.getValue("517"):this.get("517"):"off"},keyboarddisplayIsOff:function(){return!this.has("517")||"off"==this.get("517")},keyboarddisplayIsOn:function(){return!!this.has("517")&&"on"==this.get("517")},getRevealSolution:function(){return this.has("518")?this.hasValue("518")?this.getValue("518"):this.get("518"):"after_final_chance"},revealSolutionIsAfter_final_chance:function(){return!this.has("518")||"after_final_chance"==this.get("518")},revealSolutionIsWith_button:function(){return!!this.has("518")&&"with_button"==this.get("518")},getHangmanTimer:function(){return this.has("519")?this.hasValue("519")?this.getValue("519"):this.get("519"):"off"},hangmanTimerIsOff:function(){return!this.has("519")||"off"==this.get("519")},hangmanTimerIsCustom:function(){return!!this.has("519")&&"custom"==this.get("519")},getInstructionPopUp:function(){return this.has("520")?this.hasValue("520")?this.getValue("520"):this.get("520"):"off"},instructionPopUpIsOff:function(){return!this.has("520")||"off"==this.get("520")},instructionPopUpIsOn:function(){return!!this.has("520")&&"on"==this.get("520")},getResetWholeLO:function(){return this.has("521")?this.hasValue("521")?this.getValue("521"):this.get("521"):"off"},resetWholeLOIsOff:function(){return!this.has("521")||"off"==this.get("521")},resetWholeLOIsOn:function(){return!!this.has("521")&&"on"==this.get("521")},getShowNextLO:function(){return this.has("522")?this.hasValue("522")?this.getValue("522"):this.get("522"):"off"},showNextLOIsOff:function(){return!this.has("522")||"off"==this.get("522")},showNextLOIsOn:function(){return!!this.has("522")&&"on"==this.get("522")},getShowPreviousLO:function(){return this.has("523")?this.hasValue("523")?this.getValue("523"):this.get("523"):"off"},showPreviousLOIsOff:function(){return!this.has("523")||"off"==this.get("523")},showPreviousLOIsOn:function(){return!!this.has("523")&&"on"==this.get("523")},getLONotesArea:function(){return this.has("524")?this.hasValue("524")?this.getValue("524"):this.get("524"):"off"},lONotesAreaIsOff:function(){return!this.has("524")||"off"==this.get("524")},lONotesAreaIsOn:function(){return!!this.has("524")&&"on"==this.get("524")},getAudiospeed:function(){return this.has("525")?this.hasValue("525")?this.getValue("525"):this.get("525"):"off"},audiospeedIsOff:function(){return!this.has("525")||"off"==this.get("525")},audiospeedIsOn:function(){return!!this.has("525")&&"on"==this.get("525")},getSCORM2004AbsoluteValues:function(){return this.has("527")?this.hasValue("527")?this.getValue("527"):this.get("527"):"off"},sCORM2004AbsoluteValuesIsOff:function(){return!this.has("527")||"off"==this.get("527")},sCORM2004AbsoluteValuesIsOn:function(){return!!this.has("527")&&"on"==this.get("527")},getHighlightselection:function(){return this.has("529")?this.hasValue("529")?this.getValue("529"):this.get("529"):"words"},highlightselectionIsWords:function(){return!this.has("529")||"words"==this.get("529")},highlightselectionIsLetters:function(){return!!this.has("529")&&"letters"==this.get("529")},getDisplayRecordingTest:function(){return this.has("531")?this.hasValue("531")?this.getValue("531"):this.get("531"):"off"},displayRecordingTestIsOff:function(){return!this.has("531")||"off"==this.get("531")},displayRecordingTestIsOn:function(){return!!this.has("531")&&"on"==this.get("531")},getEndResultsButton:function(){return this.has("532")?this.hasValue("532")?this.getValue("532"):this.get("532"):"every"},endResultsButtonIsEvery:function(){return!this.has("532")||"every"==this.get("532")},endResultsButtonIsLast:function(){return!!this.has("532")&&"last"==this.get("532")},getTimeSpentinSections:function(){return this.has("533")?this.hasValue("533")?this.getValue("533"):this.get("533"):"off"},timeSpentinSectionsIsOff:function(){return!this.has("533")||"off"==this.get("533")},timeSpentinSectionsIsOn:function(){return!!this.has("533")&&"on"==this.get("533")},getNumberOfTeams:function(){return this.has("535")?this.hasValue("535")?this.getValue("535"):this.get("535"):"1"},numberOfTeamsIs1:function(){return!this.has("535")||"1"==this.get("535")},numberOfTeamsIs2:function(){return!!this.has("535")&&"2"==this.get("535")},numberOfTeamsIs3:function(){return!!this.has("535")&&"3"==this.get("535")},numberOfTeamsIs4:function(){return!!this.has("535")&&"4"==this.get("535")},getNumberOfCategories:function(){return this.has("536")?this.hasValue("536")?this.getValue("536"):this.get("536"):"off"},numberOfCategoriesIsOff:function(){return!this.has("536")||"off"==this.get("536")},numberOfCategoriesIs1:function(){return!!this.has("536")&&"1"==this.get("536")},numberOfCategoriesIs2:function(){return!!this.has("536")&&"2"==this.get("536")},numberOfCategoriesIs3:function(){return!!this.has("536")&&"3"==this.get("536")},numberOfCategoriesIs4:function(){return!!this.has("536")&&"4"==this.get("536")},numberOfCategoriesIs5:function(){return!!this.has("536")&&"5"==this.get("536")},numberOfCategoriesIs6:function(){return!!this.has("536")&&"6"==this.get("536")},numberOfCategoriesIs7:function(){return!!this.has("536")&&"7"==this.get("536")},numberOfCategoriesIs8:function(){return!!this.has("536")&&"8"==this.get("536")},numberOfCategoriesIs9:function(){return!!this.has("536")&&"9"==this.get("536")},getNumberOfQuestions:function(){return this.has("537")?this.hasValue("537")?this.getValue("537"):this.get("537"):"off"},numberOfQuestionsIsOff:function(){return!this.has("537")||"off"==this.get("537")},numberOfQuestionsIs1:function(){return!!this.has("537")&&"1"==this.get("537")},numberOfQuestionsIs2:function(){return!!this.has("537")&&"2"==this.get("537")},numberOfQuestionsIs3:function(){return!!this.has("537")&&"3"==this.get("537")},numberOfQuestionsIs4:function(){return!!this.has("537")&&"4"==this.get("537")},numberOfQuestionsIs5:function(){return!!this.has("537")&&"5"==this.get("537")},numberOfQuestionsIs6:function(){return!!this.has("537")&&"6"==this.get("537")},numberOfQuestionsIs7:function(){return!!this.has("537")&&"7"==this.get("537")},numberOfQuestionsIs8:function(){return!!this.has("537")&&"8"==this.get("537")},numberOfQuestionsIs9:function(){return!!this.has("537")&&"9"==this.get("537")},getSkip:function(){return this.has("538")?this.hasValue("538")?this.getValue("538"):this.get("538"):"off"},skipIsOff:function(){return!this.has("538")||"off"==this.get("538")},skipIsOn:function(){return!!this.has("538")&&"on"==this.get("538")},getRestartGame:function(){return this.has("539")?this.hasValue("539")?this.getValue("539"):this.get("539"):"off"},restartGameIsOff:function(){return!this.has("539")||"off"==this.get("539")},restartGameIsOn:function(){return!!this.has("539")&&"on"==this.get("539")},getNewGame:function(){return this.has("540")?this.hasValue("540")?this.getValue("540"):this.get("540"):"off"},newGameIsOff:function(){return!this.has("540")||"off"==this.get("540")},newGameIsOn:function(){return!!this.has("540")&&"on"==this.get("540")},init:function(){}},Obj.extend("a5.models.options.BaseOptions",a5.models.options.BaseOptions),a5.models.options.Options={init:function(parents){this.parents=parents,this.parents&&this.parents.reverse(),this.options={},this.customOptions={},this.version=0},getVersion:function(){var versions=_.pluck(this.parents,"version");return _.max(versions)},readAll:function(xml){xml=xml.replace(/(<key>|<value>)/g,"$1<![CDATA["),xml=xml.replace(/(<\/key>|<\/value>)/g,"]]>$1");var options=$($.parseXML(xml)).find("options");try{"options-v2"==options.attr("data-author")?this._readAll_v2(options):this._readAll_v1(options)}catch(e){logger.warn("invalid options xml")}},_readAll_v1:function(xml){this.version=1,xml.find("option").each(_.bind(function(index,option){var $option=$(option);"LO_setting"!=$option.attr("key")&&(this.options[$option.attr("id")]=$option.attr("key"),void 0!==$option.attr("value")&&(this.customOptions[$option.attr("id")]=$option.attr("value")))},this))},_readAll_v2:function(xml){this.version=2,xml.find("option").each(_.bind(function(index,option){var $option=$(option),id=$option.attr("id"),key=this._serialize($option.find("key").first()),value=this._serialize($option.find("value").first());"LO_setting"!=key&&(_.isUndefined(key)||(this.options[id]=htmlDecode(key).replace(/&#13;&#10;/g,"\n")),_.isUndefined(value)||(this.customOptions[id]=htmlDecode(value).replace(/&#13;&#10;/g,"\n")))},this))},_serialize:function($node){if($node[0]){var xml=(new XMLSerializer).serializeToString($node[0]);return xml=xml.replace(/^(<key><\/key>|<value><\/value>)$/,""),xml=xml.replace(/^(<key><!\[CDATA\[|<value><!\[CDATA\[)/,""),xml=xml.replace(/(]]><\/key>|]]><\/value>)$/,"")}},readAllFromObject:function(options){_(options).each(function(option,id){"LO_setting"!=option.key&&(this.options[id]=option.key,void 0!==option.value&&(this.customOptions[id]=option.value))},this)},get:function(id){if(this.parents){var found=void 0;return _.each(this.parents,function(e){_.isUndefined(found)&&(found=e.get(id))}),found}if(id in this.options)return this.options[id]},contains:function(id,value){var val=JSON.parse(this.get(id));return _.indexOf(val,value)>-1},exportOptions:function(){for(var result={},i=0;i<1e3;i++){var opt_id=String("000"+i).slice(-3),opt=this.get(opt_id);_.isUndefined(this.name_map[opt_id])||(result[opt_id]={name:this.name_map[opt_id],key:opt,val:this.getValue(opt_id)})}return result},getLOParts:function(){var parts=[],partsValue=this.get("375");return partsValue=$.parseJSON(partsValue),partsValue&&_.each(partsValue.items,function(item){var partNumbers=item.numbers.split("-");partNumbers.length<2&&(partNumbers[1]=partNumbers[0]),parts.push({from:parseInt(partNumbers[0],10),to:parseInt(partNumbers[1],10),label:item.label,recommendedTime:parseInt(item.time,10)||0})},this),parts},getFromJSON:function(id){return JSON.parse(this.get(id))},getValue:function(id){if(this.parents){var found=void 0;return _.each(this.parents,function(e){_.isUndefined(found)&&(found=e.getValue(id))}),found}if(id in this.customOptions)return this.customOptions[id]},has:function(id){return!_.isUndefined(this.get(id))},hasValue:function(id){return!_.isUndefined(this.getValue(id))},hasHints:function(){try{return JSON.parse(_.unescape(this.getHints())).items.length>0}catch(e){return!1}},hasResourceBanks:function(){if(!this.resourceBanksIsOn())return!1;try{return!!JSON.parse(this.getResourceBanks()).items.length}catch(e){return!1}},getFeedbackCorrect:function(){return this.feedbackCorrectIsCustom()?this.getValue("462"):null},getFeedbackIncorrect:function(){return this.feedbackIncorrectIsCustom()?this.getValue("463"):null},getRevealObject:function(){var revealLabel,hideLabel,revealObject=this._super();if(!this.revealObjectIsFalse()){var value=this.getValue("021");if(value){var labels=value.split("|");revealLabel=labels[0]&&labels[0].trim(),hideLabel=labels[1]&&labels[1].trim(),revealObject=this.get("021")}}return{key:revealObject,revealLabel:revealLabel,hideLabel:hideLabel}},getShowSubmit:function(){var showSubmit=this._super(),result={};try{if(showSubmit=$.parseJSON(showSubmit),showSubmit.items&&2==showSubmit.items.length){var texts=showSubmit.items[0].label;if(texts){var matches=/^(#(.*)#)?(.*)$/gi.exec(texts);result.dialogHeadingText=matches[2],result.dialogContentText=matches[3]}var buttons=showSubmit.items[1].label;if(buttons){var labels=buttons.split("|");result.dialogSubmitText=labels[0]&&labels[0].trim(),result.dialogCancelText=labels[1]&&labels[1].trim()}}else{var entries=["submit","dialogHeading","dialogContent","dialogSubmit","dialogCancel"];_.each(showSubmit.items,function(item,i){var data=item.label.split("|");result[entries[i]+"Text"]=data[0],result[entries[i]+"Tooltip"]=data[1]})}}catch(e){}return result},getExamsTimer:function(){var value=this._super(),regex=/^(\d+)\|(\d+)\|(.*)\|(\d+)\|(.*)$/,result=regex.exec(value);if(result)result={time:60*parseInt(result[1],10),first_warning:60*parseInt(result[2],10),first_warning_text:result[3],second_warning:60*parseInt(result[4],10),second_warning_text:result[5],with_hours:parseInt(result[1],10)>=60,timeFormat:"time_left",countIntroScreen:"off",timeoutType:"force_submit"};else try{value=$.parseJSON(value);var entries=["value","timeFormat","countIntroScreen","timeoutType","dialogHeading","dialogContent","dialogSubmitLabel","dialogSubmitTooltip","dialogContinueLabel","dialogContinueTooltip"];result={},_.each(value.items,function(item,i){result[entries[i]]=item.label});var timerData=regex.exec(result.value);timerData?_.extend(result,{time:60*parseInt(timerData[1],10),first_warning:60*parseInt(timerData[2],10),first_warning_text:timerData[3],second_warning:60*parseInt(timerData[4],10),second_warning_text:timerData[5],with_hours:parseInt(timerData[1],10)>=60}):/^(\d+)$/.exec(result.value)?_.extend(result,{time:60*parseInt(result.value,10),with_hours:parseInt(result.value,10)>=60}):result=!1}catch(e){}return result},getReferenceContent:function(){var value=this._super();try{value=$.parseJSON(value);var result=[];return value.items&&value.items[0]&&value.items[0]&&result.push(value.items[0].label),value.items&&value.items[1]&&value.items[1]&&result.push(value.items[1].label),result}catch(e){return"off"===value?[]:[value]}},getEndResultScreen:function(){return!this.endResultScreenIsFalse()&&this.hasValue("047")?_.extend({key:this.get("047")},this._parseEndResultLabelSyntax(this.getValue("047"))):{key:this._super(),canReturn:!0}},getEndResultAlways:function(){return!this.endResultAlwaysIsOff()&&this.hasValue("378")?_.extend({key:this.get("378")},this._parseEndResultLabelSyntax(this.getValue("378"))):{key:this._super(),canReturn:!0}},getNumberOfTeams:function(){var key,value=this._super();try{value=_.first($.parseJSON(value))}catch(e){}return key=this.has("535")?this.get("535"):value,{number:parseInt(key,10),canSelect:"user_choice"===value}},_parseEndResultLabelSyntax:function(syntax){var exercisesLabel,resultsLabel,canReturn=!0;if(syntax){var labels=syntax.split("|");exercisesLabel=labels[0]&&labels[0].trim(),2===labels.length&&(resultsLabel=labels[1]&&labels[1].trim()),resultsLabel||(canReturn=!1)}return{exercisesLabel:exercisesLabel,resultsLabel:resultsLabel,canReturn:canReturn}}},a5.models.options.BaseOptions.extend("a5.models.options.Options",a5.models.options.Options),a5.models.options.Enumeration={init:function(val,wrapPattern){void 0===val|"false"==val&&(val=""),this.value=val,this.wrapPattern='<span class="enum">|</span>',void 0!==wrapPattern&&(this.wrapPattern=wrapPattern),this._ready=$.Deferred(),this._done=$.Deferred()},finish:function(){this._done.resolve()},ready:function(){return this._ready},done:function(){return this._done},start:function(offsetDeferred){$.when(offsetDeferred).then(function(offset){this.offset=offset||0,this.counter=offset||0,this._ready.resolve()}.bind(this))},getCounter:function(){return this.done().then(function(){return this.counter}.bind(this))},getOffset:function(){return this.ready().then(function(){return this.offset}.bind(this))},useEnum:function(){return this.value.length>0},increment:function(){this.counter>26&&("letter"===this.value||"capitalletter"===this.value)&&(this.counter=0),this.counter++},next:function(html){return this.ready().then(function(){this.increment();var res=this.getEnumSymbol(this.counter,html);return this.trigger("next",res),res}.bind(this))},getEnumSymbol:function(i,html,wrapPattern){void 0===html&&(html="");var res,val=this.value;switch(val){case"number":res=i+".";break;case"number_no_dot":res=i;break;case"letter":res=String.fromCharCode(96+i)+")",i>26&&(i=0);break;case"capitalletter":res=String.fromCharCode(64+i)+".",i>26&&(i=0);break;case"bullet":res="&#8226;";break;default:if(""==val)return html;var arr=val.split("|");res=void 0!==arr[i]?arr[i]:""}return res=this.wrap(res,wrapPattern)+html},reset:function(){this.counter=0},wrap:function(str,wrapPattern){return(wrapPattern||this.wrapPattern).replace("|",str)}},Obj.extend("a5.models.options.Enumeration",a5.models.options.Enumeration),a5.models.options.Prefill={init:function(interaction){this.interaction=interaction,this.prefillFirstgap=interaction.options.prefillIsFirstitem(),this.prefillFirstBlock=interaction.options.prefillIsFirstblock(),this.prefillDone=!1,this.blockPrefillDone=!1,this.firstPrefillDone=!1},isPrefill:function(dontResetFirstPrefillDone){var prefillFirstgap=this.prefillFirstgap&&1==this.interaction.items.length()&&!this.firstPrefillDone;dontResetFirstPrefillDone||(this.firstPrefillDone=!0);var prefillFirstBlock=this.prefillFirstBlock&&1==this.interaction.items.length();return(prefillFirstgap||prefillFirstBlock)&&!this.prefillDone},isPrefillFirstBlock:function(){return this.prefillFirstBlock&&1==this.interaction.items.length()&&!this.blockPrefillDone},blockDone:function(){this.blockPrefillDone=!0,this.done()},done:function(){this.prefillDone=!0}},Obj.extend("a5.models.options.Prefill",a5.models.options.Prefill),a5.models.Metadata={init:function(metadata){this.metadata=metadata||{}},load:function($lo){var $metadata=$lo.find("> metadata"),metadata=this._readMetadata($metadata);metadata.screens=[],$lo.find("screens > screen").each(_.bind(function(index,screenNode){var $screenNode=$(screenNode),$screenMetadata=$screenNode.find("metadata"),screenName=$screenNode.find("> name").text();screenName&&metadata.screens.push({name:screenName,metadata:this._readMetadata($screenMetadata)})},this)),this.metadata=metadata},_readMetadata:function($node){var metadata={};return $node.find("group item").each(_.bind(function(index,item){var $item=$(item),group=$item.parent().attr("name"),key=$item.attr("title").toLowerCase(),m={values:this._getValues($item),group:group};metadata[key]=m},this)),metadata},getScreenMetadata:function(name,index){var screens=this.get("screens")||[],screenMetadata=_(screens).find(function(s){return s.name===name});!screenMetadata&&index<screens.length&&(screenMetadata=screens[index]);var metadata=screenMetadata&&screenMetadata.metadata;return new a5.models.Metadata(metadata)},get:function(id){return this.metadata[id.toLowerCase()]},contains:function(id,value){var val=this.get(id);return _.indexOf(val.values,value)>-1},getValues:function(id){var values=[];return this.metadata[id.toLowerCase()]&&(values=this.metadata[id.toLowerCase()].values),values},has:function(id){return!_.isUndefined(this.get(id))},_getValues:function($item){var values=[];return $item.attr("value")?values=[this._getAttrValue($item)]:$item.find("value").length>0&&(values=this._getNestedValues($item)),values},_getNestedValues:function($item){var values=[];return $item.find("value").each(function(index,value){var $value=$(value);values.push({value:$value.attr("key"),description:$value.attr("description")})}),values},_getAttrValue:function($item){return{value:$item.attr("value"),description:$item.attr("title")}}},Obj.extend("a5.models.Metadata",a5.models.Metadata),a5.models.interaction.BlockItems={VALUE_CHANGE_EVENT:"VALUE_CHANGE_EVENT",FILL_CHANGE_EVENT:"FILL_CHANGE_EVENT",STATE_CHANGE_EVENT:"STATE_CHANGE_EVENT",MIN_LENGTH_EVENT:"MIN_LENGTH_EVENT",STATES:{CHECK:"feedback",INPUT:"input",ANSWERS:"answers"},init:function(parameters){parameters=parameters||{},this.itemList=[],this.parent=parameters.parent,this.state=this.STATES.INPUT,this.fillStatus="none"},sample:function(items){this.itemList=items.map(function(i){return this.itemList[i]},this)},add:function(item){this.itemList.push(item),item.bind(item.VALUE_CHANGE_EVENT,function(){this.notifyValueChange()},this),item.bind(item.STATE_CHANGE_EVENT,function(newState){this.notifyStateChange(newState)},this)},notifyValueChange:_.throttle(function(){this.trigger(this.VALUE_CHANGE_EVENT),this.getFillStatus().then(function(fillStatus){this.notifyFillChange(fillStatus)}.bind(this)),this.notifyMinLength(this.meetsMinLength())},100),notifyFillChange:function(fill){fill!==this.fillStatus&&(this.fillStatus=fill,this.trigger(this.FILL_CHANGE_EVENT,this.fillStatus))},notifyStateChange:function(newState){this.trigger(this.STATE_CHANGE_EVENT,newState),this.getFillStatus().then(function(fillStatus){this.notifyFillChange(fillStatus)}.bind(this))},notifyMinLength:function(meetsMinLength){meetsMinLength!==this._meetsMinLength&&(this._meetsMinLength=meetsMinLength,this.trigger(this.MIN_LENGTH_EVENT,this._meetsMinLength))},getFillStatus:function(){return $.when(this.isFilled(),this.areAllFilled()).then(function(someFilled,allFilled){return someFilled?allFilled?"all":"some":"none"}.bind(this))},getItems:function(){return _.chain(this.itemList).invoke("getItems").flatten().value()},acceptedStates:function(){return[this.STATES.INPUT,this.STATES.CHECK,this.STATES.ANSWERS]},getState:function(){return this.state},setState:function(newState){_.contains(this.acceptedStates(),newState)||logger.log("error,",this,".setState has invalid parameter",newState),this.state!==newState&&(this.state=newState,this.notifyStateChange(newState))},setAnswer:function(){var promises=_.invoke(this.itemList,"setAnswer");return $.when.apply($,promises).then(function(){this.setState(this.STATES.CHECK)}.bind(this))},setAnswerInput:function(){var promises=_.invoke(this.itemList,"setAnswerInput");return $.when.apply($,promises).then(function(){}.bind(this))},tryAgain:function(){var promises=_.invoke(this.itemList,"tryAgain");return $.when.apply($,promises).then(function(){this.setState(this.STATES.INPUT)}.bind(this))},showAnswer:function(){var promises=_.invoke(this.itemList,"showAnswer");return $.when.apply($,promises).then(function(){this.setState(this.STATES.ANSWERS)}.bind(this))},signalErrors:function(validate){_.invoke(this.itemList,"signalErrors",validate)},hideSignalErrors:function(validate){_.invoke(this.itemList,"hideSignalErrors",validate)},canShowSolutionHint:function(){
return this.hasCandidatesForSolutionHint()},getCandidatesForSolutionHint:function(){var promises=_.map(this.itemList,function(item){return $.when(item.hasCandidatesForSolutionHint()).then(function(hasCandidatesForSolutionHint){return{item:item,hasCandidatesForSolutionHint:hasCandidatesForSolutionHint}})});return $.when.apply($,promises).then(function(){var items=Array.prototype.slice.call(arguments);return _.chain(items).filter({hasCandidatesForSolutionHint:!0}).pluck("item").value()})},getCandidatesForShowNextAnswer:function(){var promises=_.map(this.itemList,function(item){return $.when(item.hasCandidatesForShowNextAnswer()).then(function(hasCandidatesForShowNextAnswer){return{item:item,hasCandidatesForShowNextAnswer:hasCandidatesForShowNextAnswer}})});return $.when.apply($,promises).then(function(){var items=Array.prototype.slice.call(arguments);return _.chain(items).filter({hasCandidatesForShowNextAnswer:!0}).pluck("item").value()})},getCandidatesForValidation:function(){var promises=_.map(this.itemList,function(item){return $.when(item.hasCandidatesForValidation()).then(function(hasCandidatesForValidation){return{item:item,hasCandidatesForValidation:hasCandidatesForValidation}})});return $.when.apply($,promises).then(function(){var items=Array.prototype.slice.call(arguments);return _.chain(items).filter({hasCandidatesForValidation:!0}).pluck("item").value()})},hasCandidatesForSolutionHint:function(){return this.getCandidatesForSolutionHint().then(function(candidates){return!_.isEmpty(candidates)})},hasCandidatesForShowNextAnswer:function(){return this.getCandidatesForShowNextAnswer().then(function(candidates){return!_.isEmpty(candidates)})},hasCandidatesForValidation:function(){return this.getCandidatesForValidation().then(function(candidates){return!_.isEmpty(candidates)})},hasShownSolutionHint:function(){return this.parent&&this.parent.hasShownSolutionHint()},clearSolutionHint:function(){delete this.state;var promises=_.invoke(this.itemList,"clearSolutionHint");return $.when.apply($,promises)},showSolutionHint:function(){return this.getCandidatesForSolutionHint().then(function(items){var item=items.shift();if(item)return item.showSolutionHint()}).then(function(){return this.hasCandidatesForValidation()}.bind(this)).then(function(hasCandidatesForValidation){hasCandidatesForValidation||this.setState(this.STATES.ANSWERS)}.bind(this))},clearIncorrectAnswers:function(list){_.invoke(list||this.itemList,"clearIncorrectAnswers")},showNextAnswer:function(){return this.getCandidatesForShowNextAnswer().then(function(items){var item=items.shift();if(item){var prevItems=this.itemList.slice(0,this.itemList.indexOf(item));return this.clearIncorrectAnswers(prevItems),item.showNextAnswer()}}.bind(this)).then(function(){return this.hasCandidatesForShowNextAnswer()}.bind(this)).then(function(hasCandidatesForShowNextAnswer){hasCandidatesForShowNextAnswer||(this.clearIncorrectAnswers(),this.setState(this.STATES.ANSWERS))}.bind(this))},showAllAnswer:function(){return this.showNextAnswer().then(function(){return this.hasCandidatesForShowNextAnswer()}.bind(this)).then(function(hasCandidatesForShowNextAnswer){if(hasCandidatesForShowNextAnswer)return this.showAllAnswer()}.bind(this))},getFirstAnswer:function(n){return _.first(this.getAllAnswers(),n)},getAllAnswers:function(){return _.chain(this.itemList).invoke("getAllAnswers").flatten().compact().value()},getItemsByClass:function(classes){return _.chain(this.itemList).invoke("getItemsByClass",classes).flatten().value()},length:function(){return this.itemList.length},store:function(){var promises=_.invoke(this.itemList,"store");return $.when.apply($,promises).then(function(){var items=Array.prototype.slice.call(arguments);if(_.some(items,function(block){return!_.isEmpty(block.items)}))return{items:items}})},restore:function(items){var promises=[];return items&&(promises=_.map(this.itemList,function(item,i){return item.restore(items[i])})),$.when.apply($,promises)},getScores:function(){var promises=_.invoke(this.itemList,"getScores");return $.when.apply($,promises).then(function(){var score=new a5.Score,iScores=Array.prototype.slice.call(arguments);return _.each(iScores,function(iScore){_.isUndefined(iScore.blockScore)?(score.total+=iScore.total,score.correct+=iScore.correct,score.filled+=iScore.filled,score.revealed+=iScore.revealed,score.totalBlocks+=iScore.totalBlocks,score.correctBlocks+=iScore.correctBlocks):(score.total+=iScore.blockScore,score.correct+=iScore.correct*iScore.blockScore/iScore.total,score.filled+=iScore.filled*iScore.blockScore/iScore.total,score.revealed+=iScore.revealed*iScore.blockScore/iScore.total,score.totalBlocks+=iScore.blockScore,score.correctBlocks+=iScore.correctBlocks*iScore.blockScore/iScore.totalBlocks)}),score}).then(function(score){return score.filled>score.total&&(score.filled=score.total),score.correct<0&&(score.correct=0),score.correctBlocks<0&&(score.correctBlocks=0),score})},getMaximumScore:function(){var promises=_.invoke(this.itemList,"getMaximumScore");return $.when.apply($,promises).then(function(){var scores=Array.prototype.slice.call(arguments);return _.reduce(scores,function(memo,maximumScore){return{action:memo.action+maximumScore.action,question:memo.question+maximumScore.question}},{action:0,question:0})})},getTotalFilled:function(){var promises=_.invoke(this.itemList,"getTotalFilled");return $.when.apply($,promises).then(function(){var counts=Array.prototype.slice.call(arguments);return _.reduce(counts,function(memo,count){return memo+count}.bind(this),0)}.bind(this))},meetsMinLength:function(){return _.every(this.itemList,function(item){return!item.meetsMinLength||item.meetsMinLength()})},isFilled:function(){var promises=_.invoke(this.itemList,"isFilled");return $.when.apply($,promises).then(function(){var items=Array.prototype.slice.call(arguments);return _.some(items)})},areAllFilled:function(){var promises=_.invoke(this.itemList,"areAllFilled");return $.when.apply($,promises).then(function(){var items=Array.prototype.slice.call(arguments);return _.every(items)})}},Obj.extend("a5.models.interaction.BlockItems"),a5.models.interaction.QuestionItems={VALUE_CHANGE_EVENT:"VALUE_CHANGE_EVENT",FILL_CHANGE_EVENT:"FILL_CHANGE_EVENT",STATE_CHANGE_EVENT:"STATE_CHANGE_EVENT",MIN_LENGTH_EVENT:"MIN_LENGTH_EVENT",STATES:{CHECK:"feedback",INPUT:"input",ANSWERS:"answers"},init:function(parameters){parameters=parameters||{},this.itemList=[],this.parent=parameters.parent,this.state=this.STATES.INPUT,this.fillStatus="none",this.blockScore=parameters.blockScore},sample:function(items){this.itemList=items.map(function(i){return this.itemList[i]},this)},add:function(item){this.itemList.push(item),item.bind(item.VALUE_CHANGE_EVENT,function(){this.notifyValueChange()},this),item.bind(item.STATE_CHANGE_EVENT,function(newState){this.notifyStateChange(newState)},this)},notifyValueChange:_.throttle(function(){this.trigger(this.VALUE_CHANGE_EVENT),this.getFillStatus().then(function(fillStatus){this.notifyFillChange(fillStatus)}.bind(this)),this.notifyMinLength(this.meetsMinLength())},100),notifyFillChange:function(fill){fill!==this.fillStatus&&(this.fillStatus=fill,this.trigger(this.FILL_CHANGE_EVENT,this.fillStatus))},notifyStateChange:function(newState){this.trigger(this.STATE_CHANGE_EVENT,newState),this.getFillStatus().then(function(fillStatus){this.notifyFillChange(fillStatus)}.bind(this))},notifyMinLength:function(meetsMinLength){meetsMinLength!==this._meetsMinLength&&(this._meetsMinLength=meetsMinLength,this.trigger(this.MIN_LENGTH_EVENT,this._meetsMinLength))},getFillStatus:function(){return $.when(this.isFilled(),this.areAllFilled()).then(function(someFilled,allFilled){return someFilled?allFilled?"all":"some":"none"}.bind(this))},getItems:function(){return this.itemList},acceptedStates:function(){return[this.STATES.INPUT,this.STATES.CHECK,this.STATES.ANSWERS]},getState:function(){return this.state},setState:function(newState){_.contains(this.acceptedStates(),newState)||logger.log("error,",this,".setState has invalid parameter",newState),this.state!==newState&&(this.state=newState,this.notifyStateChange(newState))},setAnswer:function(){var promises=_.invoke(this.itemList,"setAnswer");return $.when.apply($,promises).then(function(){this.setState(this.STATES.CHECK)}.bind(this))},setAnswerInput:function(){var promises=_.invoke(this.itemList,"setAnswerInput");return $.when.apply($,promises).then(function(){}.bind(this))},tryAgain:function(){var promises=_.invoke(this.itemList,"tryAgain");return $.when.apply($,promises).then(function(){this.setState(this.STATES.INPUT)}.bind(this))},showAnswer:function(){var promises=_.invoke(this.itemList,"showAnswer");return $.when.apply($,promises).then(function(){this.setState(this.STATES.ANSWERS)}.bind(this))},signalErrors:function(validate){_.invoke(this.itemList,"signalErrors",validate)},hideSignalErrors:function(validate){_.invoke(this.itemList,"hideSignalErrors",validate)},canShowSolutionHint:function(){return this.hasCandidatesForSolutionHint()},getCandidatesForSolutionHint:function(){var promises=_.map(this.itemList,function(item){return $.when(item.hasCandidatesForSolutionHint()).then(function(hasCandidatesForSolutionHint){return{item:item,hasCandidatesForSolutionHint:hasCandidatesForSolutionHint}})});return $.when.apply($,promises).then(function(){var items=Array.prototype.slice.call(arguments);return _.chain(items).filter({hasCandidatesForSolutionHint:!0}).pluck("item").value()})},getCandidatesForShowNextAnswer:function(){var promises=_.map(this.itemList,function(item){return $.when(item.hasCandidatesForShowNextAnswer()).then(function(hasCandidatesForShowNextAnswer){return{item:item,hasCandidatesForShowNextAnswer:hasCandidatesForShowNextAnswer}})});return $.when.apply($,promises).then(function(){var items=Array.prototype.slice.call(arguments);return _.chain(items).filter({hasCandidatesForShowNextAnswer:!0}).pluck("item").value()})},getCandidatesForValidation:function(){var promises=_.map(this.itemList,function(item){return $.when(item.hasCandidatesForValidation()).then(function(hasCandidatesForValidation){return{item:item,hasCandidatesForValidation:hasCandidatesForValidation}})});return $.when.apply($,promises).then(function(){var items=Array.prototype.slice.call(arguments);return _.chain(items).filter({hasCandidatesForValidation:!0}).pluck("item").value()})},hasCandidatesForSolutionHint:function(){return this.getCandidatesForSolutionHint().then(function(candidates){return!_.isEmpty(candidates)})},hasCandidatesForShowNextAnswer:function(){return this.getCandidatesForShowNextAnswer().then(function(candidates){return!_.isEmpty(candidates)})},hasCandidatesForValidation:function(){return this.getCandidatesForValidation().then(function(candidates){return!_.isEmpty(candidates)})},clearSolutionHint:function(){delete this.state;var promises=_.invoke(this.itemList,"clearSolutionHint");return $.when.apply($,promises)},showSolutionHint:function(){return this.getCandidatesForSolutionHint().then(function(items){var item=items.shift();if(item)return item.showSolutionHint()}).then(function(){return this.hasCandidatesForValidation()}.bind(this)).then(function(hasCandidatesForValidation){hasCandidatesForValidation||this.setState(this.STATES.ANSWERS)}.bind(this))},clearIncorrectAnswers:function(list){_.invoke(list||this.itemList,"clearIncorrectAnswers")},showNextAnswer:function(){return this.getCandidatesForShowNextAnswer().then(function(items){var item=items.shift();if(item){var prevItems=this.itemList.slice(0,this.itemList.indexOf(item));return this.clearIncorrectAnswers(prevItems),item.showNextAnswer()}}.bind(this)).then(function(){return this.hasCandidatesForShowNextAnswer()}.bind(this)).then(function(hasCandidatesForShowNextAnswer){hasCandidatesForShowNextAnswer||(this.clearIncorrectAnswers(),this.setState(this.STATES.ANSWERS))}.bind(this))},showAllAnswer:function(){return this.showNextAnswer().then(function(){return this.hasCandidatesForShowNextAnswer()}.bind(this)).then(function(hasCandidatesForShowNextAnswer){if(hasCandidatesForShowNextAnswer)return this.showAllAnswer()}.bind(this))},getFirstAnswer:function(n){return _.first(this.getAllAnswers(),n)},getAllAnswers:function(){return _.chain(this.itemList).invoke("getAllAnswers").flatten().compact().value()},getItemsByClass:function(classes){var classnames=classes.split(" ");return _.filter(this.itemList,function(item){return _.contains(classnames,item._class_name)})},length:function(){return this.itemList.length},store:function(){var promises=_.invoke(this.itemList,"store");return $.when.apply($,promises).then(function(){return{items:Array.prototype.slice.call(arguments)}})},restore:function(data){var promises=[];return data&&data.items&&(promises=_.map(this.itemList,function(item,i){return item.restore(data.items[i])})),$.when.apply($,promises)},getScores:function(){var promises=_.invoke(this.itemList,"getScores");return $.when.apply($,promises).then(function(){var score=new a5.Score,iScores=Array.prototype.slice.call(arguments);return _.each(iScores,function(iScore){_.isUndefined(iScore.blockScore)?(score.total+=iScore.total,score.correct+=iScore.correct,score.filled+=iScore.filled,score.revealed+=iScore.revealed,score.totalBlocks+=iScore.totalBlocks,score.correctBlocks+=iScore.correctBlocks):(score.total+=iScore.blockScore,score.correct+=iScore.correct*iScore.blockScore/iScore.total,score.filled+=iScore.filled*iScore.blockScore/iScore.total,score.revealed+=iScore.revealed*iScore.blockScore/iScore.total,score.totalBlocks+=iScore.blockScore,score.correctBlocks+=iScore.correctBlocks*iScore.blockScore/iScore.totalBlocks)}),score}).then(function(score){return(score.total>0||this.blockScore>0)&&(0===score.totalBlocks&&(score.totalBlocks=1),score.total>0&&score.correct===score.total-score.revealed&&(score.correctBlocks=score.totalBlocks),0===score.total&&(score.total=this.blockScore),score.blockScore=this.blockScore),score}.bind(this))},getMaximumScore:function(){if(this.blockScore)return{action:this.blockScore,question:this.blockScore};var promises=_.invoke(this.itemList,"getMaximumScore");return $.when.apply($,promises).then(function(){var scores=Array.prototype.slice.call(arguments),maximumScore={action:_.reduce(scores,function(memo,score){return memo+score},0),question:0};return maximumScore.action>0&&(maximumScore.question=1),maximumScore})},getTotalFilled:function(){var promises=_.map(this.itemList,function(item){return $.when(item.getTotalFilled(),item.getMaximumScore()).then(function(filled,total){return{filled:filled,total:total}}.bind(this))}.bind(this));return $.when.apply($,promises).then(function(){var counts=Array.prototype.slice.call(arguments);return _.reduce(counts,function(memo,count){return this.blockScore?memo+=count.filled*this.blockScore/count.total:memo+=count.filled,memo}.bind(this),0)}.bind(this))},meetsMinLength:function(){return _.every(this.itemList,function(item){return!item.meetsMinLength||item.meetsMinLength()})},isFilled:function(){var promises=_.invoke(this.itemList,"isFilled");return $.when.apply($,promises).then(function(){var items=Array.prototype.slice.call(arguments);return _.some(items)})},areAllFilled:function(){var promises=_.invoke(this.itemList,"areAllFilled");return $.when.apply($,promises).then(function(){var items=Array.prototype.slice.call(arguments);return _.every(items)})},isScorable:function(){return Boolean(this.blockScore)}},Obj.extend("a5.models.interaction.QuestionItems"),a5.model_builder.Base={init:function(engine){this.engine=engine},methodToBuild:function(node){var name=$.isXMLDoc(node[0])?node[0].nodeName:node[0].nodeName.toLowerCase();return node[0].nodeType==Node.TEXT_NODE&&(name="textNode"),"build"+a5.utils.capitalize(name)},build:function(interaction,parentNode,node){var name=this.methodToBuild(node);name in this?this[name].call(this,interaction,parentNode,node):logger.warn("no builder method '"+name+"' for ",this)},buildContents:function(node,interaction,appendTo,except){var cn=appendTo||$('<div class="content"></div>');return $(node).contents().each(function(i2,e2){except&&$(e2).is(except)||interaction.buildModel(cn,$(e2))}),cn},fetchChoices:function(interaction,node,selector,shuffling){var choices=node.find(selector);return _.isUndefined(shuffling)?interaction.options.randomiseanswersIsTrue()&&"true"===node.attr("shuffle")&&(choices=_.shuffle(choices)):shuffling&&(choices=_.shuffle(choices)),choices},addWordClasses:function(node,wordSiblings,descendant){var beginning=!1,ending=!1,word='[^\\s.:?!,;"Â¿Â¡âââââââ¹âºÂ«Â»]',previous=$(node.get(0).previousSibling);previous.is("br")||previous.is("*")&&"block"==previous.css("display")||(ending=previous.is(wordSiblings)||RegExp(word+"$").test(previous.text()));var next=$(node.get(0).nextSibling);next.is("br")||next.is("*")&&"block"==next.css("display")||(beginning=next.is(wordSiblings)||RegExp("^"+word).test(next.text())),descendant&&(node=node.find(descendant)),beginning?ending?node.addClass("word-middle"):node.addClass("word-beginning"):ending&&node.addClass("word-ending")}},Obj.extend("a5.model_builder.Base"),a5.model_builder.Comment={isResponsible:function(node){if(void 0!==Node&&node[0].nodeType==Node.COMMENT_NODE)return!0},build:function(){}},a5.model_builder.Element={isResponsible:function(node,interaction){var nodes=["div","p","br","blockquote","span","strong","em","u","table","tbody","th","tr","td","hr","table","thead","prompt","ul","ol","li","b","del","i","h1","h2","h3","h4","h5","h6","s","sup","sub"],exclude=a5.utils.hasId(node,"contentblock")&&"Input:Completion:Text gap"==interaction.identifier&&interaction.options.gapsIsInvisible();return exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Input:Completion:Maths"==interaction.identifier&&interaction.options.gapsIsInvisible(),exclude=exclude||a5.utils.hasId(node,"buddy"),exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Identify:Mark:Marking"==interaction.identifier,exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Identify:Mark:Proofing"==interaction.identifier,exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Identify:Mark:Autocorrect"==interaction.identifier,exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Order:Match:Text gap"==interaction.identifier&&"Trainer"!==LOInfo.mode&&"Exam"!==LOInfo.mode,exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Input:Completion:Text correction"==interaction.identifier,exclude=exclude||(a5.utils.hasId(node,"contentblock")||a5.utils.hasClass(node,"triangle-display-number"))&&"Input:Completion:Number triangle"==interaction.identifier,exclude=exclude||(a5.utils.hasId(node,"contentblock")||a5.utils.hasClass(node,"pyramid-display-number"))&&"Input:Completion:Number pyramid"==interaction.identifier,exclude=exclude||(a5.utils.hasId(node,"contentblock")||a5.utils.hasClass(node,"pyramid-display-number"))&&"Order:Match:Number pyramid"==interaction.identifier,exclude=exclude||(a5.utils.hasId(node,"contentblock")||a5.utils.hasClass(node,"wall-display-number"))&&"Input:Completion:Number wall"==interaction.identifier,exclude=exclude||(a5.utils.hasId(node,"contentblock")||a5.utils.hasClass(node,"layers-display-number"))&&"Input:Completion:Number layers"==interaction.identifier,exclude=exclude||a5.utils.hasId(node,"content"),exclude=exclude||a5.utils.hasId(node,"headerAudio")||a5.utils.hasId(node,"headerVideo"),exclude=exclude||(a5.utils.hasId(node,"slides")||a5.utils.hasId(node,"slide"))&&"Present:Present:Slideshow"===interaction.identifier,exclude=exclude||a5.utils.tagNameIs(node,"br")&&"Order:Match:Text gap"==interaction.identifier&&"Trainer"!==LOInfo.mode&&"Exam"!==LOInfo.mode,exclude=exclude||a5.utils.tagNameIs(node,"p")&&"Order:Match:Text gap"==interaction.identifier&&"Trainer"!==LOInfo.mode&&"Exam"!==LOInfo.mode,exclude=exclude||a5.utils.tagNameIs(node,"br")&&"Order:Match:Number pyramid"==interaction.identifier,exclude=exclude||a5.utils.hasId(node,"contentblock")&&"Input:Creative:Dialogue recording"===interaction.identifier,!!node[0].tagName&&(!exclude&&_.include(nodes,node[0].tagName.toLowerCase()))},build:function(interaction,parent,node,forceBuild){if("Order:Sort:Sorting"!==interaction.identifier||!a5.utils.hasId(node,"contentblock")||0!==node.children().length||!_.isEmpty(node.text().trim())){for(var elementNode=$(document.createElement(node[0].tagName)),attributes=node[0].attributes,i=0;i<attributes.length;i++){var a=attributes[i];"id"==a.nodeName&&"contentblock"==a.nodeValue?elementNode.addClass("contentblock"):"dictionary-selected-entry"===a.nodeName?elementNode.addClass("dictionary-selected-entry"):elementNode.attr(a.nodeName,a.nodeValue)}if(interaction.isMediaRendering){var style=$(node).attr("style"),isFW2Col="Input:Creative:Free writing 2 col"===interaction.identifier;isFW2Col&&elementNode.css("position",""),(isFW2Col||"string"==typeof style&&"true"==a5.utils.getStyleValue(style,"optionexpand"))&&(interaction.hasMediaToExpand=!0,elementNode.addClass("optionexpand"),elementNode.css("height","auto"))}parent.append(elementNode),a5.utils.hasClass(elementNode,"contentblock")&&interaction.enumBlock&&interaction.enumBlock.useEnum()&&(elementNode.append('<span class="enumblock-placeholder"></span>'),interaction.enumBlock.next().then(function(enumSymbol){elementNode.find(".enumblock-placeholder").replaceWith(enumSymbol),elementNode.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}),elementNode.attr("tabindex",-1)),this._buildContents(node,elementNode,interaction,forceBuild),this._fixEmptyParagraphs(interaction,elementNode)}},_buildContents:function(node,elementNode,interaction,forceBuild){node.contents().each(function(index,e){a5.utils.tagNameIs(elementNode,"table")&&e.nodeType===Node.TEXT_NODE||interaction.buildModel(elementNode,$(e),forceBuild)})},_fixEmptyParagraphs:function(interaction,elementNode){a5.utils.hasClass(elementNode,"contentblock")&&(_.contains(["Identify:Mark:Wordsnake","Order:Sort:Sorting"],interaction.identifier)&&elementNode.find("p").each(function(index,p){(0===$(p).children().length&&_.isEmpty($(p).text().trim())||0===$(p).children(":not(span)").length&&_.isEmpty($(p).text().trim()))&&$(p).remove()}),0===elementNode.children().length&&_.isEmpty(elementNode.text().trim())&&elementNode.remove())}},a5.model_builder.Anchor={init:function(engine){this.engine=engine},isResponsible:function(node,interaction){return a5.utils.tagNameIs(node,"a")},build:function(interaction,parentNode,node){for(var link=document.createElement(node[0].tagName),$link=$(link),attributes=node[0].attributes,i=0;i<attributes.length;i++){var a=attributes[i];$link.attr(a.nodeName,a.nodeValue)}node.contents().each(function(index,e){interaction.buildModel($link,$(e))}),$link.on("click",function(ev){ev.preventDefault(),a5.utils.startsWith(node.attr("href"),"#")||this.engine.invoke("open-link",link.href)}.bind(this)),parentNode.append($link)}},a5.model_builder.Text={isResponsible:function(node,interaction,forceBuild){var isText=3==node[0].nodeType,isCDATA=4==node[0].nodeType;if(forceBuild&&(isText||isCDATA))return!0;if(isCDATA)return!0;var ignore=["Identify:Mark:Marking","Input:Completion:Text correction","Identify:Mark:Proofing","Identify:Mark:Autocorrect"];return!_.include(ignore,interaction.identifier)&&isText&&!("Order:Match:Text gap"===interaction.identifier)&&!("Order:Match:Number pyramid"===interaction.identifier)&&!(interaction.options.gapsIsInvisible()&&"Input:Completion:Text gap"==interaction.identifier)&&!(new a5.model_builder.TextWordSnake).isResponsible(node,interaction)},build:function(interaction,parent,node){var txt=node.text();if(interaction.skipNextCharacters>0){var toSkip=interaction.skipNextCharacters;txt.length<toSkip&&(toSkip=txt.length),txt=txt.substring(toSkip),interaction.skipNextCharacters-=toSkip}txt=a5.utils.encodeHTMLSpecialChars(txt),txt=a5.utils.scramble(txt),parent.append(txt)}},a5.model_builder.Img={isResponsible:function(node,interaction){return a5.utils.tagNameIs(node,"img")&&!this._hasOtherBuilder(node,interaction)},_hasOtherBuilder:function(node,interaction){var otherImageBuilders=["Geogebra","MathML","Colouring"];return _.some(otherImageBuilders,function(builderName){return(new a5.model_builder[builderName]).isResponsible(node,interaction)})},build:function(interaction,parentNode,node){var attribs=[],hotspots=[],n=$(node);if("bgimg"==n.attr("class")){var src=A5.ASSET_URL_BUILDER(n.attr("src"));return void $("#content_wrap_"+interaction.index).css("background-image",'url("'+src+'")')}n.attr("data-hotspots")&&(hotspots=$.parseJSON(n.attr("data-hotspots")),hotspots=_(hotspots).map(function(hotspot){return this._buildHotspot(hotspot)},this));for(var val,validAttributes=["do-not-load-src","src","alt","style","title","class","id"],imageAsTrigger=interaction.options.imageAsTriggerIsTrue(),hasTriggerAudio=!1,triggerAudioId=null,i=0;i<validAttributes.length;i++){var attr=validAttributes[i];if(void 0!==n.attr(attr)){if(val=n.attr(attr),"alt"===attr){var trigger=/^#audio:(.*)#(.*)$/.exec(val);trigger&&(imageAsTrigger&&(hasTriggerAudio=!0,triggerAudioId=trigger[1]),val=trigger[2])}"src"!==attr&&"do-not-load-src"!==attr||(val=A5.ASSET_URL_BUILDER(val),"do-not-load-src"===attr&&(attr="src")),attribs.push(attr+'="'+val+'"')}}var img=$("<img "+attribs.join(" ")+"/>");if(imageAsTrigger&&hasTriggerAudio){var imgDiv=$('<div class="image-as-trigger"></div>');imgDiv.css("left",img.css("left")),imgDiv.css("top",img.css("top")),imgDiv.css("width",img.css("width")),imgDiv.css("height",img.css("height")),img.css("left","0px"),img.css("top","0px"),imgDiv.append(img);var $playBtn=$('<div class="play-button stopped inactive"></div>'),UID=triggerAudioId+"_"+a5.utils.createUID();$playBtn.attr("data-audio-uid",UID),img[0].style.zIndex&&$playBtn.css("z-index",img[0].style.zIndex),imgDiv.append($playBtn),parentNode.append(imgDiv),a5.service.media.audio.bind("ready",function(){var viewUpdater=new a5.model_builder.ImageAsTriggerViewUpdater(triggerAudioId,UID,interaction.options.audioiconbehaviourIsPause(),interaction);$playBtn.data("view-updater",viewUpdater),$playBtn.attr("data-has-view-updater","true"),_.defer(_.bind(viewUpdater.ready,viewUpdater))})}else parentNode.append(img);_(hotspots).each(function($hotspot){parentNode.append($hotspot)})},_buildHotspot:function(hotspot){return new a5.views.ImageHotspot(hotspot).render()}},Obj.extend("a5.model_builder.ImageAsTriggerViewUpdater",{init:function(audioID,UID,hasPauseBehaviour,interaction){this.UID=UID,this.hasPauseBehaviour=hasPauseBehaviour,this.status="loading",this.audio=a5.service.media.audio.create(audioID,{preload:!a5.dp.config.audioPreloadDisabled}),a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(this.audio),this.audio.bind("stopped",function(){this.stop()},this),this.audio.bind("paused",function(){hasPauseBehaviour||this.audio.stop()},this)},update:function(){var players=$("[data-audio-uid='"+this.UID+"']");players.off("click"),players.removeClass("playing inactive"),players.addClass("stopped"),players.toggleClass("show-pause-on-playing",this.hasPauseBehaviour),"ready"===this.status?players.on("click",_.bind(this.play,this)):"playing"===this.status?players.on("click",_.bind(this.pause,this)):players.on("click",function(e){e.preventDefault(),e.stopPropagation()}),"playing"===this.status?(players.addClass("playing"),players.removeClass("stopped")):"loading"===this.status&&players.addClass("inactive")},ready:function(){this.status="ready",this.update()},play:function(evt){a5.utils.hasClass(evt.target,".no-play")?$(evt.target).removeClass("no-play"):($(".play-button").removeClass("playing"),$(".play-button").addClass("stopped"),a5.service.media.pauseAllExcept(this.audio),this.audio.play(),this.status="playing",this.update(),evt.stopPropagation(),evt.preventDefault())},pause:function(evt){this.audio.pause(),this.status="ready",this.update(),evt.stopPropagation(),evt.preventDefault()},stop:function(){this.status="ready",this.update()}}),a5.model_builder.ObjectImage={isResponsible:function(node,interaction){return a5.utils.hasTag(node,"object")&&["image/jpeg","image/png"].contains(node.attr("type"))&&"Order:Match:Text gap (Label an object)"!==interaction.identifier&&"Input:Completion:Text gap (Label an object)"!==interaction.identifier},build:function(interaction,parentNode,node){var imgNode=$('<img src="'+A5.ASSET_URL_BUILDER(node.attr("data"))+'" style="'+node.attr("style")+'" id="'+node.attr("id")+'"></img>');parentNode.append(imgNode),node.attr("width")&&imgNode.attr("width",node.attr("width")),node.attr("height")&&imgNode.attr("height",node.attr("height"))}},Obj.extend("a5.model_builder.Element"),Obj.extend("a5.model_builder.Comment"),Obj.extend("a5.model_builder.Text"),Obj.extend("a5.model_builder.Img"),Obj.extend("a5.model_builder.ObjectImage"),Obj.extend("a5.model_builder.Anchor"),a5.model_builder.builders=[new a5.model_builder.Element,new a5.model_builder.Comment,new a5.model_builder.Text,new a5.model_builder.Img,new a5.model_builder.ObjectImage],a5.model_builder.Content={isResponsible:function(node,interaction){return a5.utils.hasId(node,"content")&&"Input:Creative:Free writing 2 col"!==interaction.identifier&&"Identify:Mark:Marking"!==interaction.identifier&&"Identify:Mark:Proofing"!==interaction.identifier&&"Identify:Mark:Autocorrect"!==interaction.identifier&&"Identify:Select:Hangman"!==interaction.identifier&&"Input:Match:Voice"!==interaction.identifier&&"Identify:Select:Radiobutton voice"!==interaction.identifier&&"Present:Present:Quiz"!==interaction.identifier&&("Input:Completion:Text correction"!==interaction.identifier||!interaction.options.errorCorrectionIsReplace())},buildDiv:function(interaction,parentNode,node){this.eachContentBlock(interaction,parentNode,node,function(e){interaction.buildModel(parentNode,e),interaction.postBuildModel(parentNode)})},eachContentBlock:function(interaction,parentNode,node,callback){var contents=node.children();_.each(contents,function(e,i){var blockScore=interaction.options.getScoreValuesPerBlock().split(",");blockScore=parseInt(blockScore[i],10),_.isNaN(blockScore)&&(blockScore=void 0),interaction.blockItems=new a5.models.interaction.QuestionItems({blockScore:blockScore,parent:interaction.items,interaction:interaction}),interaction.items.add(interaction.blockItems),a5.mainBuilder.options(!0).continuousEnumerationIsOn()||interaction.enumAnswers.ready().then(function(){interaction.enumAnswers.reset()}),callback.call(this,$(e))},this)}},a5.model_builder.Base.extend("a5.model_builder.Content"),a5.model_builder.builders.push(new a5.model_builder.Content),a5.model_builder.Geogebra={isResponsible:function(node,interaction){return node.is("img")&&node.attr("data-geogebra")},buildImg:function(interaction,parentNode,node){var img=$("<span>");(new a5.model_builder.Img).build(interaction,img,node),parentNode.append(img),this._drawApplet(interaction,parentNode,node,img)},_drawApplet:function(interaction,parentNode,node,img){var html5CodeBase=A5.GEOGEBRA,parameters=JSON.parse(node.attr("data-author")).ggb,options={width:parameters.width,height:parameters.height,showAlgebraInput:parameters.showAlgebraInput,showResetIcon:parameters.showResetIcon,showToolBar:parameters.showToolBar,showMenuBar:parameters.showMenuBar,borderColor:null,allowStyleBar:!1,enableLabelDrags:!1,enableShiftDragZoom:!0,capturingThreshold:null,showToolBarHelp:!1,errorDialogsActive:!1,showTutorialLink:!1,showLogging:!1,useBrowserForJS:!1,perspective:"G",gridVisible:parameters.gridVisible},$parent=$('<div class="geogebra-wrapper"></div>');parentNode.append($parent),a5.service.Attachment.currentAttachment&&(_.extend(options,{scaleContainerClass:a5.service.Attachment.currentAttachment.getClass()}),a5.service.Attachment.currentAttachment.$.addClass("has-geogebra"));var ggbnode=$parent.get(0);if(parameters.geoGebraObject){var model=new a5.model.Geogebra({data:node.attr("data-geogebra")});interaction.blockItems.add(model),interaction.bind("show:deferred",function(){options.appletOnLoad=function(api){img.remove(),
options.showAlgebraInput&&api.showAlgebraInput(!0),options.showResetIcon&&api.showResetIcon(!0),api.setGridVisible(Boolean(options.gridVisible)),model.setAPI(api)},options.ggbBase64=model.getData();var applet=new GGBApplet(options,"5.0","applet_container_"+a5.utils.createUID(),!0);applet.setHTML5Codebase(html5CodeBase),applet.inject(ggbnode)})}}},a5.model_builder.Base.extend("a5.model_builder.Geogebra"),a5.model_builder.builders.push(new a5.model_builder.Geogebra),jQuery.fn.addInteractionStyle=function(style){this.closest(".interaction").addClass(style)},jQuery.fn.naturalSize=function(css,container){var params=$.extend({width:"auto",height:"auto",display:"inline-block"},css),node=this.first(),clone=node.clone();clone.css(params);var wh=[0,0];if(container){var containerNode=$("<div></div>");node.parent().append(containerNode),containerNode.append(clone),containerNode.css(container),wh=[clone.outerWidth(),clone.outerHeight()],containerNode.remove()}else node.parent().append(clone),wh=[clone.outerWidth(),clone.outerHeight()],clone.remove();return wh},jQuery.fn.boundingBox=function(){var x=0,y=0;return this.children().each(function(i,e){var left=($(e).position(),parseInt($(e).css("left"),10)||0),top=parseInt($(e).css("top"),10)||0,xm=left+$(e).outerWidth(!0),ym=top+$(e).outerHeight(!0);xm>x&&(x=xm),ym>y&&(y=ym)}),"border-box"!=this.css("box-sizing")&&"border-box"!=this.css("-webkit-box-sizing")&&"border-box"!=this.css("-moz-box-sizing")||(x+=parseInt(this.css("borderLeftWidth"),10)+parseInt(this.css("borderRightWidth"),10),y+=parseInt(this.css("borderTopWidth"),10)+parseInt(this.css("borderBottomWidth"),10)),{width:x,height:y}},jQuery.fn.applyBoundingBox=function(){this.css(this.boundingBox())},jQuery.fn.applyBoundingHeight=function(){this.css({height:this.boundingBox().height})},jQuery.fn.inlineOffset=function(){var el=$("<i>a</i>").css("display","inline").insertBefore(this[0]),pos=el.offset();return el.remove(),pos},jQuery.fn.textWidth=function(text){var $input=this.first(),$fakeEl=$("<fake/>");$fakeEl.css({visibility:"hidden",position:"absolute",top:-9999,left:-9999,width:"auto",whiteSpace:"nowrap",fontSize:$input.css("fontSize"),fontFamily:$input.css("fontFamily"),fontWeight:$input.css("fontWeight"),fontVariant:$input.css("fontVariant"),fontStyle:$input.css("fontStyle"),letterSpacing:$input.css("letterSpacing"),paddingLeft:$input.css("paddingLeft"),paddingRight:$input.css("paddingRight"),borderLeftWidth:$input.css("borderLeftWidth"),borderLeftStyle:$input.css("borderLeftStyle"),borderRightWidth:$input.css("borderRightWidth"),borderRightStyle:$input.css("borderRightStyle")});var htmlText=text||$input.val()||$input.text();htmlText=htmlText.replace(/\s/g,"&nbsp;"),$fakeEl.html(htmlText),$fakeEl.insertAfter($input);var width=Math.ceil($fakeEl.width());return($("body.isIE11").length>0||$("body.isIE").length>0||$("body.isEdge").length>0||$("body.isIOS.isSafari").length>0)&&(width+=2),$("body.isEdge").length>0&&(width+=2),$fakeEl.remove(),width},jQuery.fn.delayedTooltip=function(options){this.each(function(index){var $node=$(this).is("input")?$(this).parent():$(this),$tooltip=$node.find(options.selector||".tooltip");if($tooltip.length){var opts={delay:options.delay,duration:options.duration,onStart:function(){$tooltip.addClass("active"),options.start&&options.start($tooltip)},onEnd:function(){$tooltip.removeClass("active"),options.end&&options.end($tooltip)}},tooltipTimer=new a5.utils.TaskTimer(opts);$(this).on("mouseover",function(ev){if(!(options.cancel&&$(this).find(options.cancel).length>0&&($(ev.target).closest(options.cancel).length>0||$(ev.target).is(options.cancel).length>0))){tooltipTimer.start(),$tooltip.removeClass("tooltip-left tooltip-top tooltip-right tooltip-bottom");var tooltipRect=$tooltip.get(0).getBoundingClientRect(),container=_.result(options,"container"),containerRect=container&&container.length&&container.get(0).getBoundingClientRect();(tooltipRect.left<0||containerRect&&tooltipRect.left<containerRect.left)&&$tooltip.addClass("tooltip-left"),(tooltipRect.top<0||containerRect&&tooltipRect.top<containerRect.top)&&$tooltip.addClass("tooltip-top"),(tooltipRect.right>window.innerWidth||containerRect&&tooltipRect.right>containerRect.right)&&$tooltip.addClass("tooltip-right"),(tooltipRect.bottom>window.innerHeight||containerRect&&tooltipRect.bottom>containerRect.bottom)&&$tooltip.addClass("tooltip-bottom"),$(this).one("mouseout click",function(ev){tooltipTimer.stop()})}})}})},function($){var pollingId,$backdrop,$wrap,lastHeight,lastWidth,closed=function(callbacks,e){var $iframe=$(this);if(!0!==$iframe.data("already-closed")){$iframe.data("already-closed",!0),callbacks&&callbacks.close&&callbacks.close.call($iframe),e.preventDefault(),$backdrop.remove(),$wrap.remove();var src=$iframe.attr("src");$iframe.attr("src","about:blank"),$iframe.closest(".neat-ios-fix").remove(),$iframe.attr("src",src),clearInterval(pollingId)}},pageRenderedWithFixedSize=function($iframe,callbacks){callbacks&&callbacks.open&&callbacks.open.call($iframe),_setVisible($iframe)},pageRendered=function($iframe,width,height,callbacks){_setIframeSizes($iframe,width,height),callbacks&&callbacks.open&&callbacks.open.call($iframe),_setVisible($iframe)},pageRendering=function($iframe,$wrap,callbacks){var height=$wrap.outerHeight(!0),width=$wrap.outerWidth(!0);lastHeight==height&&lastWidth==width&&(clearInterval(pollingId),pageRendered($iframe,width,height,callbacks)),lastHeight=height,lastWidth=width},checkIframeContentLoaded=function(callbacks){var $iframe=$(this),$wrap=$iframe.contents().find("#wrap");$wrap.length>0&&pageRendering($iframe,$wrap,callbacks)},_setPageCloseHook=function($iframe,callbacks){$iframe.contents().on("click","#page-close",$.proxy(closed,$iframe[0],callbacks));try{var iframeWindow=$iframe[0].contentWindow;iframeWindow.onbeforeunload=$.proxy(closed,$iframe[0],callbacks),iframeWindow.a5.hooks.layoutStylesLoaded.add(function(){iframeWindow.a5.dp.config.allowLOSelfClosing=!1})}catch(e){}},_setIframeSizes=function($iframe,width,height){var $wrap=$iframe.closest(".neat-ios-fix");$wrap.width(width+"px").css("margin-left",-$wrap.width()/2+"px"),$wrap.height(height+"px").css("margin-top",-$wrap.height()/2+"px")},_setVisible=function($iframe){$iframe.removeClass("invisible")};$.fn.iframeModal=function(callbacks){var $body=$("body"),$iframe=$(this).detach();$iframe.removeData("already-closed"),$backdrop&&$backdrop.remove(),$backdrop=$('<div class="modal-backdrop fade in"><div class="loader"></div></div>').appendTo($body),$backdrop.on("click",$.proxy(closed,this,callbacks)),$wrap&&$wrap.remove(),$wrap=$('<div class="neat-ios-fix"></div>'),$iframe.addClass("modal-content invisible").appendTo($wrap),$wrap.appendTo($body);var onLoad=function(){var hooks=window.A5||{};if(_setPageCloseHook($iframe,callbacks),hooks.LO_IFRAME_SIZE_FIXED)return void pageRenderedWithFixedSize($iframe,callbacks);if(hooks.LO_IFRAME_SIZE){var size=_(hooks).result("LO_IFRAME_SIZE");return void pageRendered($iframe,size[0],size[1],callbacks)}pollingId=setInterval($.proxy(checkIframeContentLoaded,$iframe[0],callbacks),500)};return a5.utils.parseUserAgent().isIE11?$iframe.on("load",onLoad):$($iframe[0].contentWindow).on("DOMContentLoaded",onLoad),$(this)}}(jQuery),a5.AudioEvents={init:function(packageURL,interactionType,interaction){this.packageURL=packageURL,this.interaction=interaction,logger.info("LOADING\t",packageURL+"/audios/"+interactionType+".txt"),$.ajax({url:packageURL+"/audios/"+interactionType+".txt?time="+ +new Date,dataType:"text",success:function(data){this.loaded(data)}.bind(this),error:function(data,e1,e2){logger.log(e1,e2)}.bind(this)}),this.audios={}},loaded:function(data){_.each(data.split("\n"),function(line){if(line.trim().length>0){var parts=line.split(":"),filename=parts[2].trim(),ns=a5.service.media.audio.create("_"+filename,{url:this.packageURL+"audios/"+filename,preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())});this.audios[filename]=ns;$(parts[0].trim()).live(parts[1].trim(),function(e){this.audios[filename].play()}.bind(this))}},this)}},Obj.extend("a5.AudioEvents"),A5.AVATAR={STATIC:"static",RUBRIC:"rubric",HINT:"hint",FEEDBACK:"feedback",SLEEP:"sleep",IDLE:"idle"},a5.service.AvatarEvent=function(avatar,new_state,prev_state){this.avatar=avatar,this.interaction=avatar.interaction,this.new_state=new_state,this.prev_state=prev_state},a5.service.Avatar={WAKEUP_EVENTS:["mousedown","touchstart","mouseup","touchend","touchmove","keydown","keyup","mousemove"],SLEEP_TIMEOUT_MILLISECONDS:5e3,_sleep_disabled:!1,__rubricSkipped:!1,audios:{last_audio:void 0,sound_effect:void 0,rubric_audio:void 0,feedback_band_audio:void 0,feedback_checkmax_audio:void 0,hint_audio:[void 0,void 0,void 0]},init:function(interaction){this.interaction=interaction,this.audios=_.clone(this.audios),this.audios.hint_audio=[],this._audio_history=[],_.bindAll(this,"_triggerIdle"),this.bindEvents(),this._volume=a5.service.media.audio_manager.VOLUME_MAX,this._initialized=!1},bindEvents:function(){this.interaction.bind("show",_.bind(function(){if(0!=this.interaction.index||!a5.dp.config.avatarAutostartDisabled)return this.interaction.isEndResultScreen()&&a5.mainBuilder.getLastFeedbackBand()?void this.interaction.getResultsAsync().then(function(results){this._feedbackBandHandler(results),this.trigger("avatar:feedback_band",results)}.bind(this)):this.interaction.options.showhintsIsOff()&&a5.dp.config.avatarHideWhenHintsOff?void this.trigger("avatar:hide",{dont_trigger_static:!0}):void this.trigger("initialize")},this)),this.interaction.bind("language:change",_.bind(function(lang){this.__getRubricAudio(),this.trigger("avatar:rubric")},this)),this.bind("initialize",_.bind(function(){this._interactionShowHandler(),this._initialized=!0},this)),this.bind("avatar:init",_.bind(function(){this.__getHintAudios(),this.__getRubricAudio(),this.setState(A5.AVATAR.STATIC)},this)),this.bind("avatar:idle",_.bind(function(){this.getState()!=A5.AVATAR.IDLE&&this.setState(A5.AVATAR.IDLE),clearTimeout(this._sleepTimer),this._setupSleepTimer()},this)),this.bind("avatar:sleep",_.bind(function(){this.setState(A5.AVATAR.SLEEP)},this)),this.bind("avatar:rubric",_.bind(this._rubricHandler,this)),this.interaction.bind("interaction:hint:close",this._triggerIdle,{once:!0}),this.interaction.bind("interaction:dialog:close",_.bind(function(){a5.service.media.audio.stopAll(),this._triggerIdle(),this.audios.last_audio=this.audios.rubric_audio,this._last_state=A5.AVATAR.RUBRIC},this)),this.interaction.bind("interaction:feedback_band",_.bind(function(interaction){this.interaction.getResultsAsync().then(function(results){this._feedbackBandHandler(results),this.trigger("avatar:feedback_band",results)}.bind(this))},this)),this.bind("avatar:hide",function(options){options&&options.dont_trigger_static||this.setState(A5.AVATAR.STATIC)}),this.interaction.bind("hide",_.bind(function(){var hintsoff=this.interaction.options.showhintsIsOff()&&a5.dp.config.avatarHideWhenHintsOff;this.trigger("avatar:hide",{dont_trigger_static:hintsoff})},this)),$("body").on(this.WAKEUP_EVENTS.join(" "),_.bind(this._wakeupEventHandler,this)),this.interaction.bind("interaction:hint",_.bind(this._interactionHintHandler,this))},__getFeedbackBand:function(){var band=$("<div>"),feedback=$("<span>"+a5.mainBuilder.getLastFeedbackBand()+"</span>");return this.interaction.buildModel(band,feedback),band},__getMaxAttemptsBand:function(feedback){var band=$("<div>");return this.interaction.buildModel(band,$(feedback)),band},__getHintAudios:function(){if(this.interaction.options.getHints()){var hint1,hint2,hint3,hints=this.interaction.options.getHints();try{JSON.parse(_.unescape(hints))}catch(e){hints=hints.replace(/"/g,'\\"')}try{this._hints=JSON.parse(_.unescape(hints)),hint1=this._hints.items[0],hint2=this._hints.items[1],hint3=this._hints.items[2]}catch(e){}if(hint1&&hint1.label.trim()){var hint1_node=$("<div>");this.interaction.buildModel(hint1_node,$(hint1.label)),this.audios.hint_audio[0]=this.__get_audio_object(hint1_node)}if(hint2&&hint2.label.trim()){var hint2_node=$("<div>");this.interaction.buildModel(hint2_node,$(hint2.label)),this.audios.hint_audio[1]=this.__get_audio_object(hint2_node)}if(hint3&&hint3.label.trim()){var hint3_node=$("<div>");this.interaction.buildModel(hint3_node,$(hint3.label)),this.audios.hint_audio[2]=this.__get_audio_object(hint3_node)}}},__getRubricAudio:function(){this.audios.rubric_audio=this.__get_audio_object(this.interaction.rubricZone)},__get_audio_object:function(node){var audio_node=node.find("*[data-playable-media]").not(".a5-avatar-ignore-audio").first();if(audio_node.length){var audio_id=audio_node.attr("data-playable-media"),audio_object=a5.service.media.by_id[audio_id];return audio_object.volume(this.getVolume()),audio_object}},_interactionShowHandler:function(){this._initialized||this.trigger("avatar:init"),_.defer(_.bind(function(){this.trigger("avatar:show"),this.audios.rubric_audio?this.trigger("avatar:rubric"):this.trigger("avatar:idle")},this))},_sleepHandler:function(){this.getState()==A5.AVATAR.IDLE&&this.trigger("avatar:sleep")},_setupSleepTimer:function(){this._sleep_disabled||(this._sleepTimer=setTimeout(_.bind(this._sleepHandler,this),this.SLEEP_TIMEOUT_MILLISECONDS))},_wakeupEventHandler:function(e){clearTimeout(this._sleepTimer),this._setupSleepTimer(),this.interaction===a5.mainBuilder.curInteraction&&this.getState()===A5.AVATAR.SLEEP&&this._triggerIdle()},_triggerIdle:function(){this.trigger("avatar:idle")},_interactionHintHandler:function(hint_id){this.trigger("avatar:hint",hint_id),_.defer(this._hintHandler.bind(this),hint_id)},_stopOnPauseAll:function(){var lastAudio=this.audios.last_audio;lastAudio.bind("paused",_.bind(function(){lastAudio.stop()},this))},_hintHandler:function(hint_id){this.audios.hint_audio[hint_id]&&(a5.service.media.audio.pauseAllExcept(this.audios.hint_audio[hint_id]),this.audios.hint_audio[hint_id].bind("playing",function(){this.setState(A5.AVATAR.HINT)},this,{once:!0}),this._play(this.audios.hint_audio[hint_id]),this.audios.last_audio=this.audios.hint_audio[hint_id],this._stopOnPauseAll(),this._audio_history.push(this.audios.last_audio),this._idleOnStop(this.audios.hint_audio[hint_id]))},_rubricHandler:function(){this.setState(A5.AVATAR.RUBRIC),this.audios.rubric_audio&&(!a5.service.Avatar.__rubricSkipped&&a5.dp.config.avatarRubricDisabled?(a5.service.Avatar.__rubricSkipped=!0,this._triggerIdle()):(a5.service.media.audio.pauseAllExcept(this.audios.rubric_audio),this._play(this.audios.rubric_audio)),this.audios.last_audio=this.audios.rubric_audio,this._stopOnPauseAll(),this._audio_history.push(this.audios.last_audio),this._idleOnStop(this.audios.rubric_audio))},_feedbackBandHandler:function(results){this.setState(A5.AVATAR.FEEDBACK),this.audios.feedback_band_audio=this.__get_audio_object(this.__getFeedbackBand()),this.audios.feedback_band_audio?(a5.service.media.audio.pauseAllExcept(this.audios.feedback_band_audio),this._play(this.audios.feedback_band_audio),this.audios.last_audio=this.audios.feedback_band_audio,this._stopOnPauseAll(),this._audio_history.push(this.audios.last_audio),this.audios.feedback_band_audio.bind("stopped",_.bind(this._checkAnswerHandler,this))):this._checkAnswerHandler()},_feedbackCheckMaxHandler:function(results){if(results.isPercent100(!0))return this._triggerIdle();a5.service.media.audio.pauseAllExcept(this.audios.feedback_checkmax_audio),this._play(this.audios.feedback_checkmax_audio),this.audios.last_audio=this.audios.feedback_checkmax_audio,this._stopOnPauseAll(),this._audio_history.push(this.audios.last_audio),this._idleOnStop(this.audios.feedback_checkmax_audio),this.interaction.getResultsAsync().then(function(results){this.trigger("avatar:feedback_checkmax",results)}.bind(this))},_checkAnswerHandler:function(options){var feedback="<span>"+a5.mainBuilder.getLastCheckMaxFeedback()+"</span>";this.audios.feedback_checkmax_audio=this.__get_audio_object(this.__getMaxAttemptsBand(feedback)),this.audios.feedback_checkmax_audio?this.interaction.getResultsAsync().then(function(results){this._feedbackCheckMaxHandler(results)}.bind(this)):this.trigger("avatar:idle")},_play:function(audio){this._idleOnStopAudio&&(this._idleOnStopAudio.unbind(this._triggerIdle),delete this._idleOnStopAudio),a5.service.media.audio.pauseAllExcept(audio),audio.play()},_idleOnStop:function(audio){this._idleOnStopAudio=audio,audio.bind("stopped",this._triggerIdle,this,{once:!0})},trigger:function(event_name,data_object){var av_event=new a5.service.AvatarEvent(this,this.getState(),this._last_state);data_object||(data_object=av_event),this._super(event_name,data_object,av_event)},setState:function(state){logger.info("(interaction #"+this.interaction.index+") AVATAR STATE: "+state),state!=A5.AVATAR.SLEEP&&clearTimeout(this.sleepTimer),this._state!=state&&(this._state!=A5.AVATAR.IDLE&&this._state!=A5.AVATAR.SLEEP&&(this._last_state=this._state),this._state=state,this.trigger("avatar:state_change"))},getLastAudio:function(){return{audio:this.audios.last_audio,state:this._last_state}},setLastAudio:function(audio_object,state){this.audios.last_audio=audio_object,this._last_state=state||this._last_state},playLastAudio:function(){var last=this.getLastAudio();last.state&&this.setState(last.state),last.audio&&!last.audio.isPlaying()&&(a5.service.media.audio.pauseAllExcept(last.audio),this._play(last.audio),this._stopOnPauseAll(),this._idleOnStop(last.audio))},playLastNAudios:function(n,options){this._last_state&&this.setState(this._last_state);var audios=_.last(this._audio_history,n);options&&options.reverse&&audios.reverse();function next(){audios.shift(),audios.length?(audios[0].position(0),audios[0].unbind(),a5.service.media.audio.pauseAllExcept(audios[0]),this._play(audios[0]),audios[0].bind("stopped",_.bind(next,this))):this._triggerIdle()}audios.length&&(audios[0].position(0),audios[0].unbind(),a5.service.media.audio.pauseAllExcept(audios[0]),this._play(audios[0]),audios[0].bind("stopped",_.bind(next,this)))},playEffect:function(path,params){var dp_path=a5.mainBuilder.layout.packageURL,buildUrl=a5.dp.config.avatarUrlBuilder||function(id,fmt){return dp_path+id+"."+fmt};return this.audios.sound_effect=a5.service.media.audio.create(path,{buildUrl:buildUrl,preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())}),this.audios.sound_effect.volume(this.getVolume()),this._play(this.audios.sound_effect),params&&params.add_to_history&&(this.audios.last_audio=this.audios.sound_effect),params&&params.loop?this.audios.sound_effect.bind("stopped",_.bind(function(){a5.service.media.audio.pauseAllExcept(this.audios.sound_effect),this._play(this.audios.sound_effect)},this)):this._idleOnStop(this.audios.sound_effect),this.audios.sound_effect},playHint:function(hint_id){this.audios.hint_audio[hint_id]&&this._interactionHintHandler(hint_id||0)},getHints:function(){return _.filter(_.keys(this.audios.hint_audio),function(key){return!!this.audios.hint_audio[key]},this)},pauseEffects:function(){this.audios.sound_effect&&this.audios.sound_effect.pause()},getState:function(state){return this._state},setVolume:function(volume){this._volume=volume;var audios=_.flatten(_.values(this.audios));_.each(audios,function(audio){audio&&audio.volume(volume)}),this.trigger("avatar:volume_change",this.getVolume())},disableSleep:function(){clearTimeout(this._sleepTimer),this._sleep_disabled=!0},enableSleep:function(){this._sleep_disabled=!1},setIdleState:function(){this._triggerIdle()},getVolume:function(volume){return this._volume}},Obj.extend("a5.service.Avatar",a5.service.Avatar),a5.service.Buddy={events:{animate:"buddyAnimate",hide:"buddyHide",removed:"buddyRemoved"},states:{animate:"animated",hide:"hidden",removed:"removed"},init:function(interaction,state,$node,audioID){this.interaction=interaction,this.uid=a5.utils.createUID(),this.$node=$node,this.$node.attr("id","buddy-"+this.uid),this.state=state,this.audioID=audioID,this.currentState,this._addListeners(),interaction.isVisibleAndLoaded()&&this._onInteractionShow()},_addListeners:function(){_.bindAll(this,"_onNodeRemoved","triggerBuddyAnimationEvent","_onInteractionShow","_onInteractionHide"),this.interaction.bind("show",this._onInteractionShow,this),this.interaction.bind("hide",this._onInteractionHide,this),this.$node.on("remove",this._onNodeRemoved)},_removeListenrs:function(){this.interaction.unbind("show",this._onInteractionShow),this.interaction.unbind("hide",this._onInteractionHide),this.$node.off("remove",this._onNodeRemoved)},_onInteractionShow:function(){_.defer(function(buddy){buddy.currentState!==buddy.states.removed&&(buddy.updateCurrentState(buddy.states.animate),buddy.triggerBuddyAnimationEvent(buddy.events.animate))},this)},_onInteractionHide:function(){this.updateCurrentState(this.states.hide),this.triggerBuddyAnimationEvent(this.events.hide)},_onNodeRemoved:function(){this._removeListenrs();var prevState=this.currentState;this.updateCurrentState(this.states.removed),prevState!==this.states.hide&&prevState!==this.states.animate||this.triggerBuddyAnimationEvent(this.events.removed)},updateCurrentState:function(state){this.currentState=state},triggerBuddyAnimationEvent:function(evt){logger.log("#buddy# event:"+evt+", uid: "+this.uid),a5.eventBus.trigger("lo:"+evt,{state:this.state,audio:this.audioID,id:this.uid,interactionIndex:this.interaction.index})},_addDPEmulatorEvents:function(){_.bindAll(this,"_onAudioStop","_onAudioPlay","_onBuddyAnimate","_onBuddyHide","_onBuddyRemove"),a5.eventBus.bind("lo:buddyAnimate",this._onBuddyAnimate,this),a5.eventBus.bind("lo:buddyHide",this._onBuddyHide,this),a5.eventBus.bind("lo:buddyRemoved",this._onBuddyRemove,this)},_onAudioStop:function(e){logger.log("audio has stopped/paused",this.uid,this.audioID)},_onAudioPlay:function(e){logger.log("audio has started",this.uid,this.audioID)},_onBuddyAnimate:function(e){if(e.id===this.uid&&e.audio){logger.log("lo:buddyAnimate",this.uid);var audio=a5.service.media.by_id[e.audio];audio.unbind("start",this._onAudioPlay),audio.unbind("paused",this._onAudioStop),audio.unbind("stopped",this._onAudioStop),audio.bind("start",this._onAudioPlay,this),audio.bind("paused",this._onAudioStop,this),audio.bind("stopped",this._onAudioStop,this),audio.play()}},_onBuddyHide:function(e){e.id===this.uid&&logger.log("lo:buddyHide",this.uid)},_onBuddyRemove:function(e){if(e.id===this.uid&&e.audio){logger.log("lo:buddyRemoved",this.uid);var audio=a5.service.media.by_id[e.audio];audio.unbind("start",this._onAudioPlay),audio.unbind("paused",this._onAudioStop),audio.unbind("stopped",this._onAudioStop),a5.eventBus.unbind("lo:buddyAnimate",this._onBuddyAnimate),a5.eventBus.unbind("lo:buddyHide",this._onBuddyHide),a5.eventBus.unbind("lo:buddyRemoved",this._onBuddyRemove)}}},Obj.extend("a5.service.Buddy",a5.service.Buddy),a5.service.lms.APIFacade={init:function(API,canStore,canRestore){this.API=API,this.canStore=canStore,this.canRestore=canRestore},start:function(){return this.API.start()},setScore:function(score){this.canStore&&this.API.setScore(score.correct(),score.total())},setDetailedScore:function(interactionScores){this.canStore&&this.API.setDetailedScore(interactionScores)},setBookmark:function(page){this.canStore&&this.API.setBookmark(page+"")},getBookmark:function(){var deferred=$.Deferred();return this.canRestore?this.API.getBookmark().always(function(num){num=parseInt(num,10),isNaN(num)?deferred.resolve(null):deferred.resolve(num)}):deferred.resolve(null),deferred.promise()},loadData:function(){var deferred=$.Deferred();return this.canRestore?this.API.getData().always(_.bind(function(data){data&&0!=data.length?(logger.log(data),this.data=_.isString(data)?JSON.parse(data):data):this.data={},deferred.resolve(this.data)},this)):(this.data={},deferred.resolve(this.data)),deferred.promise()},saveData:function(){if(this.canStore){var serializedData=JSON.stringify(this.data);this.lastSavedData&&serializedData===this.lastSavedData||(this.lastSavedData=serializedData,this.API.setData(serializedData,this.data))}},setData:function(name,data){_.isUndefined(this.data)||(this.data[name]=data,this.saveData())},getData:function(name){var deferred=$.Deferred();return this.data?deferred.resolve(_.isUndefined(name)?this.data:this.data[name]):this.loadData().done(function(data){var ret=_.isUndefined(name)?data:data[name];deferred.resolve(ret)}),deferred.promise()},isDataDirty:function(){return this.API.isDataDirty()},clearDataDirty:function(){this.API.clearDataDirty()},setDataDirty:function(){this.API.setDataDirty()},notify:function(interaction){_(this.API.notify).isFunction()&&this.API.notify(interaction)},setProgress:function(progress){if(!_(progress).isNumber()||progress<0||progress>1)throw new Error("progress parameter must be a number 0..1");_(this.API.setProgress).isFunction()&&this.API.setProgress(progress)},close:function(sync){var promise;return this.closed||(this.closed=!0,promise=this.API.close(sync)),$.when(promise)},clear:function(){this.canStore&&(this.data={},this.API.clear())},submit:function(score,duration){var promise;return this.canStore&&(promise=this.API.submit(score,duration)),$.when(promise)},getUserRole:function(){return this.API.getUserRole()},getLockedInteractions:function(){return this.API.getLockedInteractions()},getLOFontSize:function(){return this.API.getLOFontSize()},getRestrictedPages:function(){return this.API.getRestrictedPages()},isTTSDisabled:function(){return this.API.isTTSDisabled()},getUserPollAnswers:function(screenNo,callback){this.API.getUserPollAnswers(screenNo,callback)},setUserPollAnswers:function(screenNo,answers,labels){this.API.setUserPollAnswers(screenNo,answers,labels)},getPollResults:function(screenNo,callback){this.API.getPollResults(screenNo,callback)},getEbookResourcesUrl:function(page,offset,index){return this.API.getEbookResourcesUrl(page,offset,index)},isEbookShowResourcesEnabled:function(){return this.API.isEbookShowResourcesEnabled()},getInteractionIdFor:function(screenName){return this.API.getInteractionIdFor(screenName)},getTeacherAnnotations:function(interactionID,callback){this.API.getTeacherAnnotations(interactionID,callback)}},Obj.extend("a5.service.lms.APIFacade"),a5.service.lms.BaseAPI={init:function(){},start:function(){this.delegateEvents()},delegateEvents:function(){var events=_.result(this,"playerEvents");events&&_.each(events,function(v,k){var method=_.isFunction(v)?v:this[v];method&&a5.eventBus.bind(k,_.bind(method,this))},this)},getUserRole:function(){return"Student"},hasAPI:function(){return!1},getEbookResourcesUrl:function(page,offset,index){var match=/courses\/(\d+)/.exec(window.location.href);if(match)var course=match[1];if(match=/(\d+).html/.exec(window.location.href))var digital_book_id=match[1];var realPage=page-offset+1,pageNumber=realPage<0?0:realPage;return location.protocol+"//"+window.location.hostname+"/app/courses/"+course+"/digital_books/"+digital_book_id+"/page/"+pageNumber},isEbookShowResourcesEnabled:function(){var match=/courses\/(\d+)/.exec(window.location.href);if(match){var course=match[1];return $.get(window.location.protocol+"//"+window.location.hostname+"/api/courses/"+course+"/resources_panel_status")}return!1},setScore:function(score,maxScore){},setDetailedScore:function(interactionScores){},setBookmark:function(page){},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(null),deferred.promise()},setData:function(serializedData,data){},getData:function(){var deferred=$.Deferred();return deferred.resolve(""),deferred.promise()},isDataDirty:function(){return!1},clearDataDirty:function(){},setDataDirty:function(){},notify:function(interaction){},close:function(sync){},clear:function(){},submit:function(score,duration){return!1},getLockedInteractions:function(){return[]},getLOFontSize:function(){return"small"},getRestrictedPages:function(){return[]},isTTSDisabled:function(){return!1},getUserPollAnswers:function(screenNo,callback){callback(null)},setUserPollAnswers:function(screenNo,answers,labels){},getPollResults:function(screenNo,callback){callback({})},getInteractionIdFor:function(screenName){return"interaction_"+screenName.hashCode()},getTeacherAnnotations:function(interactionID,callback){callback([])}},Obj.extend("a5.service.lms.BaseAPI"),a5.service.lms.DummyAPI={init:function(){},hasAPI:function(){return!0},setScore:function(score,maxScore){},setDetailedScore:function(interactionScores){},setBookmark:function(page){},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(null),deferred.promise()},setData:function(serializedData,data){},getData:function(){var deferred=$.Deferred();return deferred.resolve(""),deferred.promise()},notify:function(interaction){},close:function(){},clear:function(){}},a5.service.lms.BaseAPI.extend("a5.service.lms.DummyAPI"),a5.service.lms.ScormAPI={SUSPEND_DATA_LIMIT:4096,init:function(){this.findAPI()},findAPI:function(){this.API=null;for(var current=window;"function"!=typeof current.GetStudentID&&current.parent!=current;)current=current.parent;"function"==typeof current.GetStudentID&&(this.API=current),this.sizeExceeded=!1},hasAPI:function(){return!!this.API},setScore:function(score,maxScore){this.API.SetScore(score,maxScore,0),this.API.SCORM_SetCompleted(),this.API.SetReachedEnd()},setDetailedScore:function(interactionScores){},setBookmark:function(page){this.API.SetBookmark(page)},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(this.API.GetBookmark()),deferred.promise()},setData:function(serializedData,data){serializedData.length>this.SUSPEND_DATA_LIMIT?this.sizeExceeded||(this.sizeExceeded=!0,alert("User input too big to store. Please remove some text.")):this.sizeExceeded&&(this.sizeExceeded=!1,alert("User input small enough to store again.")),this.API.SetDataChunk(serializedData)},getData:function(){var deferred=$.Deferred();return deferred.resolve(this.API.GetDataChunk()),deferred.promise()},notify:function(interaction){},close:function(){this.API.Unload()},clear:function(){}},a5.service.lms.BaseAPI.extend("a5.service.lms.ScormAPI"),a5.service.lms.ScormAVAAPI={SUSPEND_DATA_LIMIT:4096,init:function(){this.findAPI()},findAPI:function(){this.API=null;for(var current=window;!current.scobotAPI&&current.parent!==current;)current=current.parent;current.scobotAPI&&(this.API=current.scobotAPI),this.sizeExceeded=!1},hasAPI:function(){return!!this.API},setScore:function(score,maxScore){var trueRound=function(v,dec){var num=parseFloat(v);return parseFloat(num.toPrecision(dec))};this.API.setvalue("cmi.score.raw",trueRound(score,7)),this.API.setvalue("cmi.score.max",trueRound(maxScore,7)),this.API.setvalue("cmi.score.min",trueRound(0)),this.API.setvalue("cmi.completion_status","completed")},setDetailedScore:function(interactionScores){},setBookmark:function(page){this.API.setBookmark(page)},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(this.API.getBookmark()),deferred.promise()},setData:function(serializedData,data){serializedData.length>this.SUSPEND_DATA_LIMIT?this.sizeExceeded||(this.sizeExceeded=!0,alert("User input too big to store. Please remove some text.")):this.sizeExceeded&&(this.sizeExceeded=!1,alert("User input small enough to store again.")),this.API.setvalue("cmi.suspend_data",serializedData)},getData:function(){var deferred=$.Deferred();return deferred.resolve(this.API.getvalue("cmi.suspend_data")),deferred.promise()},notify:function(interaction){},close:function(){this.API.finish()},clear:function(){}},a5.service.lms.BaseAPI.extend("a5.service.lms.ScormAVAAPI"),a5.service.lms.Scorm2004API={SUSPEND_DATA_LIMIT:64e3,init:function(){this.findAPI()},findAPI:function(){this.API=null;for(var current=window;"function"!=typeof current.GetStudentID&&current.parent!=current;)current=current.parent;"function"==typeof current.GetStudentID&&(this.API=new a5.service.lms.Scorm2004Adapter(current)),this.sizeExceeded=!1},hasAPI:function(){return!!this.API},setScore:function(score,maxScore){
a5.mainBuilder.options(!0).sCORM2004AbsoluteValuesIsOn()?this.API.setScore(score,maxScore):this.API.setScore(score/maxScore*100,100),this.API.setReachedEnd()},setDetailedScore:function(interactionScores){},setBookmark:function(page){this.API.setBookmark(page)},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(this.API.getBookmark()),deferred.promise()},setData:function(serializedData,data){serializedData.length>this.SUSPEND_DATA_LIMIT?this.sizeExceeded||(this.sizeExceeded=!0,alert("User input too big to store. Please remove some text.")):this.sizeExceeded&&(this.sizeExceeded=!1,alert("User input small enough to store again.")),this.API.setDataChunk(serializedData)},getData:function(){var deferred=$.Deferred();return deferred.resolve(this.API.getDataChunk()),deferred.promise()},notify:function(interaction){var klassName=this._extractNotifierKlassNameFromInteraction(interaction);new(a5.service.lms[klassName]||a5.service.lms.Scorm2004Null)(this.API).notify(interaction)},setProgress:function(progress){this.API.setProgress(progress)},close:function(){this.API.unload()},clear:function(){},_extractNotifierKlassNameFromInteraction:function(interaction){var interactionCamelizedName=_.str.camelize(_.str.underscored(interaction.cssIdentifier())),interactionClassName=interactionCamelizedName.substr(0,2).toUpperCase()+interactionCamelizedName.substr(2);return _.str.sprintf("Scorm2004%s",interactionClassName)}},a5.service.lms.BaseAPI.extend("a5.service.lms.Scorm2004API"),a5.service.lms.Scorm2004AVAAPI={SUSPEND_DATA_LIMIT:64e3,init:function(){this.findAPI()},findAPI:function(){this.API=null;for(var current=window;!current.scobotAPI&&current.parent!==current;)current=current.parent;current.scobotAPI&&(this.API=new a5.service.lms.Scorm2004AVAAdapter(current.scobotAPI)),this.sizeExceeded=!1},hasAPI:function(){return!!this.API},setScore:function(score,maxScore){a5.mainBuilder.options(!0).sCORM2004AbsoluteValuesIsOn()?this.API.setScore(score,maxScore):this.API.setScore(score/maxScore*100,100),this.API.setReachedEnd()},setDetailedScore:function(interactionScores){},setBookmark:function(page){this.API.setBookmark(page)},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(this.API.getBookmark()),deferred.promise()},setData:function(serializedData,data){serializedData.length>this.SUSPEND_DATA_LIMIT?this.sizeExceeded||(this.sizeExceeded=!0,alert("User input too big to store. Please remove some text.")):this.sizeExceeded&&(this.sizeExceeded=!1,alert("User input small enough to store again.")),this.API.setDataChunk(serializedData)},getData:function(){var deferred=$.Deferred();return deferred.resolve(this.API.getDataChunk()),deferred.promise()},notify:function(interaction){var klassName=this._extractNotifierKlassNameFromInteraction(interaction);new(a5.service.lms[klassName]||a5.service.lms.Scorm2004Null)(this.API).notify(interaction)},setProgress:function(progress){this.API.setProgress(progress)},close:function(){this.API.finish()},clear:function(){},_extractNotifierKlassNameFromInteraction:function(interaction){var interactionCamelizedName=_.str.camelize(_.str.underscored(interaction.cssIdentifier())),interactionClassName=interactionCamelizedName.substr(0,2).toUpperCase()+interactionCamelizedName.substr(2);return _.str.sprintf("Scorm2004%s",interactionClassName)}},a5.service.lms.BaseAPI.extend("a5.service.lms.Scorm2004AVAAPI"),a5.service.lms.TinCanAPI={VERBS:{lo:["started","terminated","scored","attempted"],interaction:["launched","closed","resumed","suspended","mastered","answered","skipped","acknowledged"]},playerEvents:{"interaction:start":"onInteractionStart","interaction:end":"onInteractionEnd","interaction:reset":"onInteractionReset","interaction:check_answer":"onInteractionCheckAnswer","interaction:see_answer_before_interaction":"onInteractionSeeAnswerBeforeInteraction","interaction:try_again":"onInteractionTryAgain","lo:total_score":"onLOTotalScore","lo:start":"onLOStart","lo:end":"onLOEnd","lo:prev":"onLOPrevious","lo:next":"onLONext","lo:save":"onLOSave","book:show_restricted_page":"onShowRestrictedPage","book:open_external_hotspot":"onOpenExternalHotspot","book:open_structure_hotspot":"onOpenStructureHotspot"},init:function(engineAPI){this.dataDirty=!1,this.launcherAPI=this._findLauncherAPI(),this.launcherAPI&&this.launcherAPI.setEngine&&this.launcherAPI.setEngine(engineAPI),this.options=_.extend({canStore:!A5.LMS_NO_STORE,canRestore:!A5.LMS_NO_RESTORE,actor:A5.LRS_ACTOR,endpoint:A5.LRS_ENDPOINT,auth:A5.LRS_AUTH,fetch:A5.LRS_FETCH,activity_id:A5.LRS_ACTIVITY_ID,registration:A5.LRS_REGISTRATION,callbacks:this.launcherAPI},this._readNonStandardParamsFromURL(),this._readParamsFromURL(),this._readCustomParamsFromURL()),"function"==typeof window.TinCan&&(this.API=new a5.service.lms.TinCanAdapter(this.options))},start:function(){return this.delegateEvents(),this.API.start()},_readParamsFromURL:function(){var params=a5.service.lms.TinCanUtils.getUrlParamObject(),ret={};return params.actor&&(ret.actor=JSON.parse(decodeURIComponent(params.actor))),params.endpoint&&(ret.endpoint=decodeURIComponent(params.endpoint)),params.auth&&(ret.auth=decodeURIComponent(params.auth)),params.fetch&&(ret.fetch=decodeURIComponent(params.fetch)),params.activity_id&&(ret.activity_id=decodeURIComponent(params.activity_id)),params.registration&&(ret.registration=decodeURIComponent(params.registration)),ret},_readCustomParamsFromURL:function(){var params=a5.service.lms.TinCanUtils.getUrlParamObject(),ret={};if(params.context&&(ret.context=JSON.parse(decodeURIComponent(params.context))),params.prefix&&(ret.prefix=decodeURIComponent(params.prefix)),params.LOCloseRedirect&&(ret.on_close_redirect_url=decodeURIComponent(params.LOCloseRedirect)),params.LOFinishRedirect&&(ret.on_finish_redirect_url=decodeURIComponent(params.LOFinishRedirect)),params.ErrorRedirect&&(ret.on_error_redirect_url=decodeURIComponent(params.ErrorRedirect)),params.TimeoutRedirect&&(ret.on_timeout_redirect_url=decodeURIComponent(params.TimeoutRedirect)),ret.filter=this.VERBS.lo.concat(this.VERBS.interaction),params.statements){var filter=decodeURIComponent(params.statements);ret.filter="lo-level"===filter?this.VERBS.lo:filter.split(",")}return ret},_readNonStandardParamsFromURL:function(){var params=a5.service.lms.TinCanUtils.getUrlParamObject(),ret={};if(params.agents){var agents=JSON.parse(decodeURIComponent(params.agents));ret.actor=agents.user}if(params.stores){var stores=JSON.parse(decodeURIComponent(params.stores));ret.endpoint=stores[0].endpoint,ret.auth=stores[0].auth}return params.activityID&&(ret.activity_id=decodeURIComponent(params.activityID)),params.reg&&(ret.registration=decodeURIComponent(params.reg)),ret},_findLauncherAPI:function(){var api=null;try{for(var current=window;"object"!=typeof current.authorAPI&&current.parent!==current;)current=current.parent;"object"==typeof current.authorAPI&&(api=current.authorAPI)}catch(e){logger.warn(e)}return api},hasAPI:function(){return!!this.API},onLOStart:function(e){this.API.onLOStart(e.uid,e.id,e.lo)},onLOEnd:function(e){this.API.onLOEnd(e.lo)},onLONext:function(){this.API.onLONext(),this.options.callbacks&&this.options.callbacks.onLONext&&this.options.callbacks.onLONext()},onLOPrevious:function(){this.API.onLOPrevious(),this.options.callbacks&&this.options.callbacks.onLOPrevious&&this.options.callbacks.onLOPrevious()},onInteractionStart:function(e){this.API.onInteractionStart(e.id,e.interaction)},onInteractionEnd:function(){this.API.onInteractionEnd()},onInteractionCheckAnswer:function(){this.API.onInteractionCheckAnswer()},onInteractionSeeAnswerBeforeInteraction:function(){this.API.onInteractionSeeAnswerBeforeInteraction()},onInteractionReset:function(){this.API.onInteractionReset()},onInteractionTryAgain:function(){this.API.onInteractionTryAgain()},onLOTotalScore:function(e){this.API.onLOTotalScore(e.score)},setScore:function(score,maxScore){},setDetailedScore:function(interactionScores){},setBookmark:function(page){this.API.setBookmark(page)},getBookmark:function(){return this.API.getBookmark()},setData:function(serializedData,data){this.API.setData(serializedData,data).done(function(){this.dataDirty=!1}.bind(this))},getData:function(){return this.API.getData()},isDataDirty:function(){return this.dataDirty},clearDataDirty:function(){this.dataDirty=!1},setDataDirty:function(){this.dataDirty=!0},notify:function(interaction){},setProgress:function(progress){},close:function(sync){return $.when(this.API.onLOClose(sync)).then(function(){this.options.on_close_redirect_url?(a5.dp.config.allowLOSelfClosing=!1,a5.service.lms.TinCanUtils.redirectTo(this.options.on_close_redirect_url)):this.options.callbacks&&this.options.callbacks.onLOClose&&this.options.callbacks.onLOClose()}.bind(this))},clear:function(){},submit:function(score,duration){return $.when(this.API.onLOSubmit(score,duration)).then(function(){var finished=!1;return this.options.on_finish_redirect_url?(finished=!0,a5.dp.config.allowLOSelfClosing=!1,a5.service.lms.TinCanUtils.redirectTo(this.options.on_finish_redirect_url)):this.options.callbacks&&this.options.callbacks.onLOFinish&&(finished=this.options.callbacks.onLOFinish()),finished}.bind(this))},getUserRole:function(){return _.result(this.launcherAPI,"userRole","Student")},getLockedInteractions:function(){return _.result(this.launcherAPI,"disabledScreenList",[])},getLOFontSize:function(){return _.result(this.launcherAPI,"fontSize","small")},getRestrictedPages:function(){return _.result(this.launcherAPI,"restrictedPageList",[])},isTTSDisabled:function(){return _.result(this.launcherAPI,"isTTSDisabled",!1)},onShowRestrictedPage:function(context){this.launcherAPI&&this.launcherAPI.onShowRestrictedPage&&this.launcherAPI.onShowRestrictedPage(context)},onOpenExternalHotspot:function(ref){this.launcherAPI&&this.launcherAPI.onOpenExternalHotspot&&this.launcherAPI.onOpenExternalHotspot(ref)},onOpenStructureHotspot:function(ref){this.launcherAPI&&this.launcherAPI.onOpenStructureHotspot&&this.launcherAPI.onOpenStructureHotspot(ref)},getEbookResourcesUrl:function(page,offset,index){return this.launcherAPI&&this.launcherAPI.resourcesUrl&&this.launcherAPI.resourcesUrl({page:page,offset:offset,index:index})||this._super(page,offset,index)},getUserPollAnswers:function(screenNo,callback){this.launcherAPI&&this.launcherAPI.getUserPollAnswers?this.launcherAPI.getUserPollAnswers(screenNo,callback):callback(null)},setUserPollAnswers:function(screenNo,answers,labels){this.launcherAPI&&this.launcherAPI.setUserPollAnswers&&this.launcherAPI.setUserPollAnswers(screenNo,answers,labels)},getPollResults:function(screenNo,callback){this.launcherAPI&&this.launcherAPI.getPollResults?this.launcherAPI.getPollResults(screenNo,callback):callback({})},isEbookShowResourcesEnabled:function(){return this.launcherAPI&&this.launcherAPI.isResourcesPanelEnabled?this.launcherAPI.isResourcesPanelEnabled():this._super()},getTeacherAnnotations:function(interactionID,callback){this.launcherAPI&&this.launcherAPI.getTeacherAnnotations?this.launcherAPI.getTeacherAnnotations(interactionID,callback):callback([])},onLOSave:function(){this.launcherAPI&&this.launcherAPI.onLOSave&&this.launcherAPI.onLOSave()}},a5.service.lms.BaseAPI.extend("a5.service.lms.TinCanAPI"),a5.service.lms.AuthorAPI={playerEvents:{"book:show_restricted_page":"onShowRestrictedPage","book:open_external_hotspot":"onOpenExternalHotspot","book:open_structure_hotspot":"onOpenStructureHotspot","lo:save":"onLOSave"},init:function(engineAPI){this.API=this.findAPI(),this.API&&this.API.setEngine&&this.API.setEngine(engineAPI)},findAPI:function(){for(var API=null,current=window;"object"!=typeof current.authorAPI&&current.parent!=current;)current=current.parent;return"object"==typeof current.authorAPI&&(API=current.authorAPI),API},hasAPI:function(){return!!this.API},setScore:function(score,maxScore){this.API.set("score",[score,maxScore])},setDetailedScore:function(interactionScores){this.API.set("detailedScore",interactionScores)},setBookmark:function(page){this.API.set("bookmark",page)},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(this.API.get("bookmark")),deferred.promise()},setAnnotations:function(serializedAnnotations){this.lastSavedAnnotations&&serializedAnnotations===this.lastSavedAnnotations||(this.lastSavedAnnotations=serializedAnnotations,this.API.set("annotations",serializedAnnotations))},getAnnotations:function(){var annotations=this.API.get("annotations");return annotations=_.isString(annotations)?JSON.parse(annotations):annotations},setData:function(serializedData,data){data.annotations&&(this.setAnnotations(JSON.stringify(data.annotations)),serializedData=JSON.stringify(_.omit(data,"annotations"))),this.lastSavedData&&serializedData===this.lastSavedData||(this.lastSavedData=serializedData,this.API.set("data",serializedData))},getData:function(){var deferred=$.Deferred(),data=this.API.get("data");return data&&(data=_.isString(data)?JSON.parse(data):data,data.annotations=this.getAnnotations()),deferred.resolve(data),deferred.promise()},isDataDirty:function(){return this.API.get("data_dirty")},clearDataDirty:function(){this.API.set("data_dirty",!1)},setDataDirty:function(){this.API.set("data_dirty",!0)},notify:function(interaction){},close:function(sync){this.API.finish(sync)},clear:function(){},getUserRole:function(){return _.result(this.API,"userRole","Student")},getLockedInteractions:function(){return _.result(this.API,"disabledScreenList",[])},getLOFontSize:function(){return _.result(this.API,"fontSize","small")},getRestrictedPages:function(){return _.result(this.API,"restrictedPageList",[])},isTTSDisabled:function(){return _.result(this.API,"isTTSDisabled",!1)},onShowRestrictedPage:function(context){this.API&&this.API.onShowRestrictedPage&&this.API.onShowRestrictedPage(context)},onOpenExternalHotspot:function(ref){this.API&&this.API.onOpenExternalHotspot&&this.API.onOpenExternalHotspot(ref)},onOpenStructureHotspot:function(ref){this.API&&this.API.onOpenStructureHotspot&&this.API.onOpenStructureHotspot(ref)},getInteractionIdFor:function(screenName){return this.API&&this.API.getScreenIdFor&&this.API.getScreenIdFor(screenName)||this._super(screenName)},getUserPollAnswers:function(screenNo,callback){this.API&&this.API.getUserPollAnswers?this.API.getUserPollAnswers(screenNo,callback):callback(null)},getEbookResourcesUrl:function(page,offset,index){return this.API&&this.API.resourcesUrl&&this.API.resourcesUrl({page:page,offset:offset,index:index})||this._super(page,offset,index)},isEbookShowResourcesEnabled:function(){return this.API&&this.API.isResourcesPanelEnabled?this.API.isResourcesPanelEnabled():this._super()},setUserPollAnswers:function(screenNo,answers,labels){this.API&&this.API.setUserPollAnswers&&this.API.setUserPollAnswers(screenNo,answers,labels)},getPollResults:function(screenNo,callback){this.API&&this.API.getPollResults?this.API.getPollResults(screenNo,callback):callback({})},getTeacherAnnotations:function(interactionID,callback){this.API&&this.API.getTeacherAnnotations?this.API.getTeacherAnnotations(interactionID,callback):callback([])},onLOSave:function(){this.API&&this.API.onLOSave&&this.API.onLOSave()}},a5.service.lms.BaseAPI.extend("a5.service.lms.AuthorAPI"),a5.service.lms.LocalStorageAPI={init:function(){this.findAPI()},findAPI:function(){this.API=null;try{"undefined"!=typeof Storage&&(this.API=localStorage)}catch(e){logger.warn(e)}},hasAPI:function(){return!!this.API},id:function(param){return"lo"+a5.mainBuilder.xmlList.join("").hashCode()+"_"+LOInfo.ID+"_"+param},setScore:function(score,maxScore){this.API[this.id("a5_lms_score")]=score,this.API[this.id("a5_lms_maxScore")]=maxScore},setDetailedScore:function(interactionScores){},setBookmark:function(page){this.API[this.id("a5_lms_bookmark")]=page},getBookmark:function(){var deferred=$.Deferred();return deferred.resolve(this.API[this.id("a5_lms_bookmark")]),deferred.promise()},setData:function(serializedData,data){this.API[this.id("a5_lms_data")]=serializedData},getData:function(){var deferred=$.Deferred();return deferred.resolve(this.API[this.id("a5_lms_data")]),deferred.promise()},notify:function(interaction){},close:function(){},clear:function(){this.API.removeItem(this.id("a5_lms_data"))}},a5.service.lms.BaseAPI.extend("a5.service.lms.LocalStorageAPI"),a5.service.lms.ConsoleAPI={playerEvents:{"interaction:reset":"onInteractionReset","interaction:ready":"onInteractionReady","interaction:value:change":"onInteractionValueChange","interaction:fill:change":"onInteractionFillChange","interaction:state:change":"onInteractionStateChange","interaction:show_next_answer":"onInteractionShowNextAnswer","interaction:show_all_answer":"onInteractionShowAllAnswer","interaction:show_solution_hint":"onInteractionShowSolutionHint","interaction:min_length:change":"onInteractionMinLengthChange","interaction:action:begin":"onInteractionBeginAction","interaction:action:end":"onInteractionEndAction","lo:ready":"onLOReady","lo:start":"onLOStart","lo:end":"onLOEnd","lo:next":"onLONext","lo:prev":"onLOPrevious","lo:action:begin":"onLOBeginAction","lo:action:end":"onLOEndAction","book:show_restricted_page":"onShowRestrictedPage","book:open_external_hotspot":"onOpenExternalHotspot","book:open_structure_hotspot":"onOpenStructureHotspot"},init:function(){this.findAPI()},findAPI:function(){this.API=null,window.console&&(this.API=console)},hasAPI:function(){return!!this.API},setScore:function(score,maxScore){this.API.info("API","setScore",score+"/"+maxScore)},setDetailedScore:function(interactionScores){this.API.info("API","setDetailedScore",interactionScores)},setBookmark:function(page){this.API.info("API","setBookmark",page)},getBookmark:function(){var deferred=$.Deferred();return this.API.info("API","getBookmark"),deferred.resolve(null),deferred.promise()},setData:function(serializedData,data){this.API.info("API","setData",serializedData)},getData:function(){var deferred=$.Deferred();return this.API.info("API","getData"),deferred.resolve(""),deferred.promise()},notify:function(interaction){this.API.info("API","notify",interaction.getID())},setProgress:function(progress){this.API.info("API","progress",100*progress+"%")},close:function(){this.API.info("API","close")},clear:function(){this.API.info("API","clear")},onInteractionReset:function(interaction){this.API.info("EVENT","interaction:reset")},onInteractionReady:function(){this.API.info("EVENT","interaction:ready")},onInteractionValueChange:function(){this.API.info("EVENT","interaction:value:change")},onInteractionFillChange:function(interaction,fill){this.API.info("EVENT","interaction:fill:change",fill)},onInteractionStateChange:function(state){this.API.info("EVENT","interaction:state:change",state)},onInteractionShowNextAnswer:function(){this.API.info("EVENT","interaction:show_next_answer")},onInteractionShowAllAnswer:function(){this.API.info("EVENT","interaction:show_all_answer")},onInteractionShowSolutionHint:function(){this.API.info("EVENT","interaction:show_solution_hint")},onInteractionMinLengthChange:function(interaction,meetsMinLength){this.API.info("EVENT","interaction:min_length:change",meetsMinLength)},onInteractionBeginAction:function(interaction,action){this.API.info("EVENT","interaction:action:begin",action,"for screen "+interaction.index)},onInteractionEndAction:function(interaction,action){this.API.info("EVENT","interaction:action:end",action,"for screen "+interaction.index)},onLOStart:function(){this.API.info("EVENT","lo:start")},onLOEnd:function(){this.API.info("EVENT","lo:end")},onLONext:function(){this.API.info("EVENT","lo:next")},onLOPrevious:function(){this.API.info("EVENT","lo:prev")},onLOReady:function(){this.API.info("EVENT","lo:ready")},onLOBeginAction:function(action){this.API.info("EVENT","lo:action:begin",action)},onLOEndAction:function(action){this.API.info("EVENT","lo:action:end",action)},onShowRestrictedPage:function(context){this.API.info("EVENT","book:show_restricted_page")},onOpenExternalHotspot:function(ref){this.API.info("EVENT","book:open_external_hotspot",ref)},onOpenStructureHotspot:function(ref){this.API.info("EVENT","book:open_structure_hotspot",ref)}},a5.service.lms.BaseAPI.extend("a5.service.lms.ConsoleAPI"),a5.service.lms.ChannelAPI={playerEvents:{"lo:start":"onLOStart","lo:end":"onLOEnd","lo:controls:change":"onLOControlsChange","lo:size":"onLOSize","lo:ready":"onLOReady","lo:total_score":"onLOTotalScore","lo:submit":"onLOSubmit","lo:finish":"onLOFinish","lo:show_external_results":"onLOShowExternalResults","interaction:start":"onInteractionStart","interaction:check_answer":"onInteractionCheckAnswer","interaction:check_answer:submit":"onInteractionCheckAnswerSubmit"},init:function(engine){this.API=engine.channel(),this.engine=engine,this.state=engine.config.get("lms_state")||{},_.bindAll(this,"onReceiveMessageFromContainer")},hasAPI:function(){return!!this.API},start:function(){this.API.bind("receiveMessageFromContainer",this.onReceiveMessageFromContainer),this.delegateEvents()},sendMessageToContainer:function(params){this.API.notify({method:"sendMessageToContainer",params:params})},sendStatements:function(statements){_.isArray(statements)||(statements=[statements]),this.sendMessageToContainer({type:"newStatements",data:statements})},getState:function(){return this.state},setState:function(state){var newState=_.extend(this.getState(),state);this.sendMessageToContainer({type:"newState",data:newState})},getData:function(){return $.when(this.getState().suspend_data)},getBookmark:function(){return $.when(this.getState().bookmark)},setData:function(serializedData,data){this.setState({suspend_data:data})},setBookmark:function(page){this.setState({bookmark:page})},onReceiveMessageFromContainer:function(trans,params){trans.delayReturn(!0);var methodFn=function(method){var fn=_.noop;if(this.engine.isLO()){var lo=this.engine.getLO();lo[method]&&(fn=lo[method].bind(lo,params.args))}return fn}.call(this,params.type);$.when().then(methodFn).then(trans.complete,trans.error)},onLOStart:function(data){var statement=this._loStartedStatement(data.uid);this.sendStatements(statement)},onLOEnd:function(){this.sendMessageToContainer({type:"terminated"})},onLOSize:function(size){this.sendMessageToContainer({type:"size",data:{size:size}})},onLOControlsChange:function(state){var actionsMap={check:{control:"checkAnswers"},forward:{control:"goNext"},previous:{control:"goPrev"},sendscores:{control:"sendScores"},submit:{control:"submit"},exercises:{control:"reviewAnswers"},results:{control:"showResults"},all_answer:{control:"revealAllAnswers"},next_answer:{control:"revealNextAnswer"},reveal:{control:"revealObject"},hide:{control:"hideObject"}},action=actionsMap[state.action];action&&this.sendMessageToContainer({type:"controlsChange",data:{control:action.control,meta:{buttonText:state.label,type:"button"},visible:state.visible,active:state.active}})},onLOReady:function(){this.sendMessageToContainer({type:"ready"})},onLOTotalScore:function(data){var scores=data.score,statement=this._loScoredStatement(scores);this.sendStatements(statement),this.sendMessageToContainer({type:"sendScores",data:{score:{scaled:scores.correct()/scores.total(),max:scores.total(),min:0,raw:scores.correct()}}})},onLOSubmit:function(data){var scores=data.score,statement=this._loScoredStatement(scores);this.sendStatements(statement),this.sendMessageToContainer({type:"submit",data:{score:{scaled:scores.correct()/scores.total(),max:scores.total(),min:0,raw:scores.correct()}}})},onLOFinish:function(){this.sendMessageToContainer({type:"completed"})},onLOShowExternalResults:function(data){this.sendMessageToContainer({type:"showResults",data:data})},onInteractionStart:function(data){var screen=data.interaction.visibleIndex+(a5.mainBuilder.hasIntroScreen()?1:0);this.firstScreenReadySent||(this.firstScreenReadySent=!0,this.sendMessageToContainer({type:"firstScreenReady",data:{screen:screen}}));var statement=this._interactionLaunchedStatement(screen);this.sendStatements(statement)},onInteractionCheckAnswer:function(data){var scores=data.score,screen=data.interaction.visibleIndex+(a5.mainBuilder.hasIntroScreen()?1:0),statement=this._interactionAnsweredStatement(screen,scores);this.sendStatements(statement)},onInteractionCheckAnswerSubmit:function(data){this.onInteractionCheckAnswer(data)},_loStartedStatement:function(){return{verb:{id:"http://activitystrea.ms/schema/1.0/start",display:{und:"started"}},object:{id:A5.LRS_ACTIVITY_ID}}},_interactionLaunchedStatement:function(screen){return{verb:{id:"http://adlnet.gov/expapi/verbs/launched",display:{und:"launched"}},object:{id:A5.LRS_ACTIVITY_ID+"/"+screen},context:{contextActivities:{parent:{id:A5.LRS_ACTIVITY_ID}}}}},_interactionAnsweredStatement:function(screen,scores){return{verb:{id:"http://adlnet.gov/expapi/verbs/answered",display:{und:"answered"}},object:{id:A5.LRS_ACTIVITY_ID+"/"+screen},result:{score:{scaled:scores.correct()/scores.total(),max:scores.total(),min:0,raw:scores.correct()}},context:{contextActivities:{parent:{id:A5.LRS_ACTIVITY_ID}}}}},_loScoredStatement:function(scores){return{verb:{id:"http://adlnet.gov/expapi/verbs/scored",display:{und:"scored"}},object:{id:A5.LRS_ACTIVITY_ID},result:{score:{scaled:scores.correct()/scores.total(),max:scores.total(),min:0,raw:scores.correct()}}}}},a5.service.lms.BaseAPI.extend("a5.service.lms.ChannelAPI"),a5.service.lms.MultiAPI={init:function(APIs){this.APIs=APIs},start:function(){return $.when.apply($,_.invoke(this.APIs,"start"))},hasAPI:function(){return!0},setScore:function(score,maxScore){_.each(this.APIs,function(API){API.setScore(score,maxScore)})},setDetailedScore:function(interactionScores){_.each(this.APIs,function(API){API.setDetailedScore(interactionScores)})},setBookmark:function(page){_.each(this.APIs,function(API){API.setBookmark(page)})},getBookmark:function(){var ret=_.first(this.APIs).getBookmark();return _.each(_.rest(this.APIs),function(API){API.getBookmark()}),ret},setData:function(serializedData,data){_.each(this.APIs,function(API){API.setData(serializedData,data)})},getData:function(){var ret=_.first(this.APIs).getData();return _.each(_.rest(this.APIs),function(API){API.getData()}),ret},isDataDirty:function(){return _.first(this.APIs).isDataDirty()},clearDataDirty:function(){_.each(this.APIs,function(API){API.clearDataDirty()})},setDataDirty:function(){_.each(this.APIs,function(API){API.setDataDirty()})},notify:function(interaction){_.each(this.APIs,function(API){API.notify(interaction)})},setProgress:function(progress){_.each(this.APIs,function(API){_.isFunction(API.setProgress)&&API.setProgress(progress)})},close:function(sync){var ret=_.first(this.APIs).close(sync);return _.each(this.APIs,function(API){API.close(sync)}),ret},clear:function(){_.each(this.APIs,function(API){API.clear()})},submit:function(score,duration){var ret=_.first(this.APIs).submit(score,duration);return _.each(_.rest(this.APIs),function(API){API.submit(score,duration)}),ret},getUserRole:function(){var ret=_.first(this.APIs).getUserRole();return _.each(_.rest(this.APIs),function(API){API.getUserRole()}),ret},getLockedInteractions:function(){var ret=_.first(this.APIs).getLockedInteractions();return _.each(_.rest(this.APIs),function(API){API.getLockedInteractions()}),ret},getLOFontSize:function(){var ret=_.first(this.APIs).getLOFontSize();return _.each(_.rest(this.APIs),function(API){API.getLOFontSize()}),ret},getRestrictedPages:function(){var ret=_.first(this.APIs).getRestrictedPages();return _.each(_.rest(this.APIs),function(API){API.getRestrictedPages()}),ret},isTTSDisabled:function(){var ret=_.first(this.APIs).isTTSDisabled();return _.each(_.rest(this.APIs),function(API){API.isTTSDisabled()}),ret},getUserPollAnswers:function(screenNo,callback){_.each(this.APIs,function(API){API.getUserPollAnswers(screenNo,callback)})},getEbookResourcesUrl:function(page,offset,index){var ret=_.first(this.APIs).getEbookResourcesUrl(page,offset,index);return _.each(this.APIs,function(API){API.getEbookResourcesUrl(page,offset,index)}),ret},isEbookShowResourcesEnabled:function(){return _.first(this.APIs).isEbookShowResourcesEnabled()},setUserPollAnswers:function(screenNo,answers,labels){_.each(this.APIs,function(API){API.setUserPollAnswers(screenNo,answers,labels)})},getPollResults:function(screenNo,callback){_.each(this.APIs,function(API){API.getPollResults(screenNo,callback)})},getInteractionIdFor:function(screenName){var ret=_.first(this.APIs).getInteractionIdFor(screenName);return _.each(_.rest(this.APIs),function(API){API.getInteractionIdFor(screenName)}),ret},getTeacherAnnotations:function(interactionID,callback){_.each(this.APIs,function(API){API.getTeacherAnnotations(interactionID,callback)})}},Obj.extend("a5.service.lms.MultiAPI"),a5.service.lms.Scorm2004Adapter={init:function(driver){this.driver=driver},setBookmark:function(page){this.driver.SetBookmark(page)},getBookmark:function(){return this.driver.GetBookmark()},setScore:function(score,maxScore){this.driver.SetPointBasedScore(score,maxScore,0)},setCompleted:function(){this.driver.SetCompleted()},setReachedEnd:function(){this.driver.SetReachedEnd()},setProgress:function(progress){this.driver.SCORM2004_CallSetValue("cmi.progress_measure",progress)},setDataChunk:function(data){this.driver.SetDataChunk(data)},getDataChunk:function(){return this.driver.GetDataChunk()},commit:function(){this.driver.CommitData()},finish:function(){this.driver.Finish()},unload:function(){this.driver.Unload()},suspend:function(){this.driver.Suspend()},recordMultipleChoiceInteraction:function(id,isCorrect,currentResults,correctResults,type){this._recordInteraction(id,isCorrect,this._convertToCommaSeparated(currentResults),this._convertToCommaSeparated(correctResults),type)},recordFillInInteraction:function(id,isCorrect,currentResults,correctResults,type){this._recordInteraction(id,isCorrect,this._convertToCommaSeparated(currentResults),_.map(correctResults,this._convertToCommaSeparated),type)},recordMatchingInteraction:function(id,isCorrect,currentResults,correctResults,type){this._recordInteraction(id,isCorrect,this._convertToCommaSeparated(_.map(currentResults,this._convertToDotSeparated)),_.map(correctResults,function(results){return this._convertToCommaSeparated(_.map(results,this._convertToDotSeparated))},this),type)},_recordInteraction:function(id,isCorrect,currentResults,correctResults,type){var count;this.driver.ClearErrorInfo(),this._checkLoaded()&&(count=this.driver.SCORM2004_CallGetValue("cmi.interactions._count")||0,this._setInteractionId(count,id),this._setInteractionType(count,type),this._setInteractionLearnerResponse(count,currentResults),this._setInteractionResult(count,isCorrect),this._setInteractionCorrectResults(count,correctResults),this._setInteractionTimestamp(count))},_checkLoaded:function(){return!!this.driver.IsLoaded()||(this.driver.SetErrorInfo(this.driver.ERROR_NOT_LOADED,"Cannot make calls to the LMS before calling Start"),!1)},_setInteractionId:function(count,id){this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.id",count),id)},_setInteractionType:function(count,type){this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.type",count),type)},_setInteractionLearnerResponse:function(count,results){this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.learner_response",count),results)},_setInteractionResult:function(count,isCorrect){_.isBoolean(isCorrect)&&this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.result",count),this._extractInteractionResult(isCorrect))},_setInteractionCorrectResults:function(count,correctResults){correctResults=[].concat(correctResults),_.each(correctResults,function(correctResult,index){this._setInteractionCorrectResult(count,index,correctResult)},this)},_setInteractionCorrectResult:function(count,index,results){this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.correct_responses.%d.pattern",count,index),results)},_setInteractionTimestamp:function(count){
this.driver.SCORM2004_CallSetValue(_.str.sprintf("cmi.interactions.%s.timestamp",count),this.driver.ConvertDateToIso8601TimeStamp(new Date))},_convertToCommaSeparated:function(list){return list.join("[,]")},_convertToDotSeparated:function(pair){return _.str.sprintf("%s.%s",pair.source,pair.target)},_extractInteractionResult:function(isCorrect){var resultStr="";return _.isBoolean(isCorrect)&&(resultStr=isCorrect?this.driver.SCORM2004_RESULT_CORRECT:this.driver.SCORM2004_RESULT_WRONG),resultStr}},Obj.extend("a5.service.lms.Scorm2004Adapter"),a5.service.lms.Scorm2004AVAAdapter={init:function(driver){this.driver=driver},setBookmark:function(page){this.driver.setBookmark(page)},getBookmark:function(){return this.driver.getBookmark()},setScore:function(score,maxScore){var trueRound=function(v,dec){var num=parseFloat(v);return parseFloat(num.toPrecision(dec))},scaled=1;maxScore>0&&(scaled=score/maxScore),this.driver.setvalue("cmi.score.raw",trueRound(score,7)),this.driver.setvalue("cmi.score.max",trueRound(maxScore,7)),this.driver.setvalue("cmi.score.min",trueRound(0)),this.driver.setvalue("cmi.score.scaled",trueRound(scaled,7))},setCompleted:function(){this.driver.setvalue("cmi.completion_status","completed")},setReachedEnd:function(){this.setCompleted()},setProgress:function(progress){this.driver.setvalue("cmi.progress_measure",progress)},setDataChunk:function(data){this.driver.setvalue("cmi.suspend_data",data)},getDataChunk:function(){return this.driver.getvalue("cmi.suspend_data")},commit:function(){this.driver.commit()},finish:function(){this.driver.finish()},suspend:function(){this.driver.suspend()},recordMultipleChoiceInteraction:function(id,isCorrect,currentResults,correctResults,type){this._recordInteraction(id,isCorrect,currentResults,[{pattern:correctResults}],type)},recordFillInInteraction:function(id,isCorrect,currentResults,correctResults,type){this._recordInteraction(id,isCorrect,{words:currentResults},_.map(correctResults,function(result){return{pattern:{words:result}}}),type)},recordMatchingInteraction:function(id,isCorrect,currentResults,correctResults,type){this._recordInteraction(id,isCorrect,_.map(currentResults,function(result){return[result.source,result.target]}),[{pattern:_.map(correctResults,function(result){return[result.source,result.target]})}],type)},_recordInteraction:function(id,isCorrect,currentResults,correctResults,type){this.driver.setInteraction({id:id,type:type,learner_response:currentResults,result:this._extractInteractionResult(isCorrect),correct_responses:correctResults,timestamp:new Date})},_extractInteractionResult:function(isCorrect){var resultStr="";return _.isBoolean(isCorrect)&&(resultStr=isCorrect?"correct":"incorrect"),resultStr}},Obj.extend("a5.service.lms.Scorm2004AVAAdapter"),a5.service.lms.Scorm2004Base={init:function(adapter){this.adapter=adapter},notify:function(interaction){},eachModel:function(interaction,fn,scope){_(interaction.items.itemList).each(function(questionItem,index1){_(questionItem.itemList).each(function(model,index2){fn.call(scope||this,model,index1,index2)},this)},this)},createId:function(interaction,index1,index2){return _.str.sprintf("%s_%d_%d",interaction.getID(),index1,index2)}},Obj.extend("a5.service.lms.Scorm2004Base"),a5.service.lms.Scorm2004Null={notify:function(interaction){logger.warn(interaction.identifier+" not supported for SCORM 2004")}},a5.service.lms.Scorm2004Base.extend("a5.service.lms.Scorm2004Null"),a5.service.lms.Scorm2004ISCheckbox={type:"choice",notify:function(interaction){this.eachModel(interaction,function(model,index1,index2){this.adapter.recordMultipleChoiceInteraction(this.createId(interaction,index1,index2),this._isCorrect(model),this._getCurrentResultsFromModel(model),this._getCorrectResultsFromModel(model),this.type)})},_getCorrectResultsFromModel:function(model){return _(model.choices).reduce(function(result,choice){return!choice.prefill&&choice.correct&&result.push(choice.value),result},[])},_getCurrentResultsFromModel:function(model){return _(model.choices).reduce(function(result,choice){return!choice.prefill&&choice.selected&&result.push(choice.value),result},[])},_isCorrect:function(model){return model.isCorrect()}},a5.service.lms.Scorm2004Base.extend("a5.service.lms.Scorm2004ISCheckbox"),a5.service.lms.Scorm2004ICCrossword={ALIGNMENT:Object.freeze({vertical:"d",horizontal:"a"}),type:"other",notify:function(interaction){this.eachModel(interaction,function(model,index1,index2){this.adapter.recordMatchingInteraction(this.createId(interaction,index1,index2),this._isCorrect(model),this._getCurrentResultsFromModel(model),this._getCorrectResultsFromModel(model),this.type)})},_getCurrentResultsFromModel:function(model){return this._getResultsFromModel(model,function(word){return word.getUserWord()})},_getCorrectResultsFromModel:function(model){return[this._getResultsFromModel(model,function(word){return word.correctText()})]},_isCorrect:function(model){return _(model.words).chain().reject(function(word){return word.prefilled}).every(function(word){return word.isCorrect()}).value()},_getResultsFromModel:function(model,targetFn){return _(model.words).chain().map(function(word){return{source:this._extractSourceLabelFromWord(word),target:targetFn(word)}},this).reject(function(item){return _.isEmpty(item.target)}).value()},_extractSourceLabelFromWord:function(word){return _.str.sprintf("%s%s",word.label,this._mapAlignToIdentifier(word.align))},_mapAlignToIdentifier:function(alignment){return this.ALIGNMENT[alignment]}},a5.service.lms.Scorm2004Base.extend("a5.service.lms.Scorm2004ICCrossword"),a5.service.lms.Scorm2004ICTextGap={type:"fill-in",notify:function(interaction){interaction.options.gapsIsInvisible()||this.eachModel(interaction,function(model,index1,index2){model instanceof a5.models.interaction.ICTextGap&&this.adapter.recordFillInInteraction(this.createId(interaction,index1,index2),this._isCorrect(model),this._getCurrentResultsFromModel(model),this._getCorrectResultsFromModel(model),this.type)},this)},_getCurrentResultsFromModel:function(model){return model.prefill?[]:[model.value]},_getCorrectResultsFromModel:function(model){return model.prefill?[]:_(model.correct).map(function(result){return[result]})},_isCorrect:function(model){return model.isCorrect()}},a5.service.lms.Scorm2004Base.extend("a5.service.lms.Scorm2004ICTextGap"),a5.service.lms.Scorm2004PPPresent={},a5.service.lms.Scorm2004Base.extend("a5.service.lms.Scorm2004PPPresent"),function(lms,_){lms.TinCanUtils={sluggify:function(text){return text.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")},getUrlParamObject:function(){return a5.getURLParameterObject()},redirectTo:function(url){window.location.assign(url)}}}(a5.service.lms,_),function(lms,_){lms.SendQueue=function(){var _queue,_tincan,_callback,_send_timeout=null,SendQueue=function(tincan,callback){_queue=[],_tincan=tincan,_callback=callback||function(){},_perform_send(!0)},_perform_send=function(asynch){var ret;return _queue.length>0&&(ret=_tincan.sendStatements(_queue,asynch?_callback:null),_queue=[]),asynch&&(_send_timeout=setTimeout(_perform_send,500,!0)),ret},_last=function(asynch){var deferred=$.Deferred();return _queue.length>0&&(_tincan.sendStatements(_queue,asynch?function(result){deferred.resolve()}:null),_queue=[]),asynch||deferred.resolve(),deferred.promise()};return _(SendQueue.prototype).extend({add:function(statement,priority){_queue.push(statement)},finish:function(asynch,callback){return clearTimeout(_send_timeout),_last(asynch)},start:function(){_perform_send(!0)}}),SendQueue}(),lms.SendStateQueue=function(){var Queue=function(tincan){this.queue=[],this.tincan=tincan,this.current=null};Queue.prototype={add:function(key,val,cfg){this.queue.push({key:key,val:val,cfg:cfg}),this.current||this.send(!0)},hasPending:function(){return!!this.current},last:function(asynch){this.deferred=$.Deferred();var promise=this.deferred.promise();return this.send(asynch),promise},send:function(asynch){this.current=this.queue.shift();var _this=this;if(this.current){var ret=this.tincan.setState(this.current.key,this.current.val,_.extend(this.current.cfg,{contentType:"application/json",callback:asynch?function(err,result){400===err?_this.retryForLegacyContent(!0):_this.send(!0)}:null}));asynch||(400===ret.err?this.retryForLegacyContent(!1):this.send(!1))}else this.deferred&&(this.deferred.resolve(),this.deferred=null)},retryForLegacyContent:function(asynch){var _this=this;this.current&&(this.current.cfg=_.omit(this.current.cfg,"contentType"),this.tincan.setState(this.current.key,this.current.val,_.extend(this.current.cfg,{callback:asynch?function(err,result){_this.send(!0)}:null})),asynch||this.send(!1))}};var SendQueue=function(tincan){this.queues={},this.tincan=tincan,this.send_timeout=null,_.bindAll(this,"send")};return _(SendQueue.prototype).extend({add:function(key,data,cfg){(this.queues[key]||(this.queues[key]=new Queue(this.tincan))).add(key,data,cfg)},hasPending:function(){for(var key in this.queues)if(this.queues.hasOwnProperty(key)&&this.queues[key].hasPending())return!0;return!1},finish:function(asynch){return clearTimeout(this.send_timeout),this.last(asynch)},start:function(){this.send(!0)},last:function(asynch){var promises=[];for(var key in this.queues)this.queues.hasOwnProperty(key)&&this.queues[key].hasPending()&&promises.push(this.queues[key].last(asynch));return this.queues={},$.when.apply(this,promises)},send:function(asynch){for(var key in this.queues)this.queues.hasOwnProperty(key)&&this.queues[key].hasPending()&&this.queues[key].send(asynch);this.queues={},asynch&&(this.send_timeout=setTimeout(this.send,500,!0))}}),SendQueue}()}(a5.service.lms,_),function(lms,_){lms.TCInteractionCodes={SOLVING:1,ANSWERED:2,SUSPENDED:3},lms.StateMachine=function(){var _head=null,_tail=null,_tincan=null,_states=null,StateMachine=function(tincan){_states=[],_tincan=tincan};return _(StateMachine.prototype).extend({tincan:function(){return _tincan},push:function(new_state){_tail&&(_tail._next_state=new_state),new_state._prev_state=_tail,_tail=new_state,null===_head&&(_head=_tail),_.isFunction(new_state.onEnter)&&new_state.onEnter(this)},pop:function(){var old_state;return!!_tail&&(old_state=_tail,_tail=_tail._prev_state,_tail&&(_tail._next_state=null),_.isFunction(old_state.onFinish)&&old_state.onFinish(this),!0)},currentState:function(){return _tail},invoke:function(func_name){var args,cs=this.currentState();if(cs&&_.isFunction(cs[func_name]))return args=[].splice.call(arguments,1),args.unshift(this),cs[func_name].apply(cs,args)},propagate:function(ev,params){for(var state=this.currentState();state;){if(_.isFunction(state[ev])&&!1===state[ev](this,params))return;state=state._prev_state}},clear:function(){for(;this.pop(););}}),StateMachine}()}(a5.service.lms,_),function(lms,_){lms.InteractionPreviewState=function(){var InteractionPreviewState=function(interaction_id,interaction){this._interaction_id=interaction_id||0,this._interaction=interaction,this._timer=new a5.utils.Timer};return InteractionPreviewState.prototype.onEnter=function(sm){var tincan=sm.tincan();tincan.setInteractionId(this._interaction_id),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("launched"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}}}),this._interaction.isSolvable().then(function(solvable){solvable&&(_.isUndefined(this._interaction.tc_code)||this._interaction.tc_code===lms.TCInteractionCodes.SOLVING?(this._interaction.tc_code=lms.TCInteractionCodes.SOLVING,sm.push(new lms.SolvingState(this._interaction))):this._interaction.tc_code===lms.TCInteractionCodes.SUSPENDED&&sm.push(new lms.ResumedState(this._interaction)))}.bind(this)),this._timer.stamp()},InteractionPreviewState.prototype.onFinish=function(sm){var tincan=sm.tincan();tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("closed"),object:tincan.activity(),result:tincan.result({duration:this._timer.getCMITimeString()})}),tincan.setInteractionId(null)},InteractionPreviewState.prototype.onInteractionEnd=function(sm){var tincan=sm.tincan();this._interaction.getItemsByClass("a5.models.RadioButton a5.models.Checkbox").length>0&&(this._interaction.tc_code=lms.TCInteractionCodes.ANSWERED,$.when(this._interaction.store()).then(function(){tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("acknowledged"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}}})}.bind(this)).then(function(){return lms.API.getData(this._interaction.getID())}.bind(this)).then(function(data){var competencies=this._interaction.activityMetadata.getValues("Competencies"),resultData={response:JSON.stringify(data)};this._addPurposeMetadata(resultData),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("answered"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityParent(competencies)}},result:tincan.result(resultData)})}.bind(this))),sm.pop()},InteractionPreviewState.prototype.onLOSubmit=function(sm){this._interaction.tc_code!==lms.TCInteractionCodes.ANSWERED&&this.onInteractionCheckAnswer(sm),sm.pop()},InteractionPreviewState.prototype.onInteractionStart=function(sm){return!1},InteractionPreviewState.prototype.onInteractionTryAgain=function(sm){sm.push(new lms.SolvingState(this._interaction))},InteractionPreviewState.prototype.onInteractionSeeAnswerBeforeInteraction=function(sm){var tincan=sm.tincan(),duration=this._timer.getCMITimeString();this._interaction.getMaximumScore().then(function(total){tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("skipped"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}},result:tincan.result({duration:duration,score:{scaled:0,max:total,min:0,raw:0}})})}.bind(this)),this._interaction.tc_code=lms.TCInteractionCodes.ANSWERED},InteractionPreviewState.prototype.onInteractionReset=InteractionPreviewState.prototype.onInteractionTryAgain,InteractionPreviewState.prototype.onInteractionCheckAnswer=function(sm){var tincan=sm.tincan();this._interaction.isSolvable().then(function(solvable){if(!solvable){this._interaction.tc_code=lms.TCInteractionCodes.ANSWERED;var promise=$.when(this._interaction.store()).then(function(){tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("acknowledged"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}}})}.bind(this));this._interaction.getItemsByClass("a5.models.RadioButton a5.models.Checkbox").length>0&&promise.then(function(){return lms.API.getData(this._interaction.getID())}.bind(this)).then(function(data){var competencies=this._interaction.activityMetadata.getValues("Competencies"),resultData={response:JSON.stringify(data)};this._addPurposeMetadata(resultData),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("answered"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityParent(competencies)}},result:tincan.result(resultData)})}.bind(this))}}.bind(this))},InteractionPreviewState.prototype._addPurposeMetadata=function(resultData){var purpose=_.first(this._interaction.activityMetadata.getValues("Purpose"));(purpose=!_.isUndefined(purpose)&&(purpose.value||purpose.description))&&_.extend(resultData,{extensions:{"http://id.tincanapi.com/extension/purpose":purpose}})},InteractionPreviewState}()}(a5.service.lms,_),function(lms,_){lms.LOPreviewState=function(){var LOPreviewState=function(lo_id,lo){this.lo_id=lo_id,this.lo_title=lo.LOInfo.title,this.lo=lo,this.timer=lo.loTimer||new a5.utils.Timer};return LOPreviewState.prototype.onEnter=function(sm){var tincan=sm.tincan();tincan.setLearningObjectId(this.lo_id,this.lo_title),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("started"),object:tincan.activity("lo")}),this.timer.stamp()},LOPreviewState.prototype.getBookmark=function(sm){var tincan=sm.tincan(),deferred=$.Deferred(),stateCfg={agent:tincan.agent(),activity:tincan.activity("lo")};return tincan.registration()&&(stateCfg.registration=tincan.registration()),tincan.getState("bookmark",stateCfg).done(function(result){var bookmark;result&&"bookmark"===result.id&&(bookmark=result.contents&&result.contents.page),deferred.resolve(bookmark)}).fail(function(){deferred.resolve(null)}),deferred.promise()},LOPreviewState.prototype.setBookmark=function(sm,page){var tincan=sm.tincan(),stateCfg={agent:tincan.agent(),activity:tincan.activity("lo")};return tincan.registration()&&(stateCfg.registration=tincan.registration()),tincan.setState("bookmark",JSON.stringify({page:page}),stateCfg),!1},LOPreviewState.prototype.getData=function(sm){var tincan=sm.tincan(),deferred=$.Deferred(),stateCfg={agent:tincan.agent(),activity:tincan.activity("lo")};return tincan.registration()&&(stateCfg.registration=tincan.registration()),tincan.getState("suspend_data",stateCfg).done(function(result){var data;result&&"suspend_data"===result.id&&(data=result.contents),deferred.resolve(data)}).fail(function(){deferred.resolve(null)}),deferred.promise()},LOPreviewState.prototype.setData=function(sm,serializedData,data){var tincan=sm.tincan(),stateCfg={agent:tincan.agent(),activity:tincan.activity("lo")};return tincan.registration()&&(stateCfg.registration=tincan.registration()),tincan.setState("suspend_data",serializedData,stateCfg),!1},LOPreviewState.prototype.onLOSubmit=function(sm,params){var tincan=sm.tincan(),scores=params.score,duration=params.duration;return _.each(this.lo.intList,function(interaction,id){interaction.tc_code===lms.TCInteractionCodes.SUSPENDED&&(this.onInteractionStart(sm,{interaction:interaction,interaction_id:interaction.index}),sm.propagate("onInteractionCheckAnswer"),sm.propagate("onInteractionEnd"))},this),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("scored"),object:tincan.activity("lo"),result:tincan.result({score:{scaled:scores.correct()/scores.total(),max:scores.total(),min:0,raw:scores.correct()}})}),tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("attempted"),object:tincan.activity("lo"),result:tincan.result({duration:this.timer.getCMITimeString(duration),score:{max:this.lo.maxAttempts,min:0,raw:this.lo.submitAttempts}})}),!1},LOPreviewState.prototype.onLOTotalScore=function(sm,params){var tincan=sm.tincan(),scores=params.total_score;tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("scored"),object:tincan.activity("lo"),result:tincan.result({score:{scaled:scores.correct()/scores.total(),max:scores.total(),min:0,raw:scores.correct()}})})},LOPreviewState.prototype.onFinish=function(sm){var tincan=sm.tincan();tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("terminated"),object:tincan.activity("lo"),result:tincan.result({duration:this.timer.getCMITimeString(this.lo.sessionLODuration)})}),tincan.setLearningObjectId(null)},LOPreviewState.prototype.onInteractionStart=function(sm,params){sm.push(new lms.InteractionPreviewState(params.interaction_id||0,params.interaction))},LOPreviewState}()}(a5.service.lms,_),function(lms,_){lms.SolvingState=function(){var SolvingState=function(interaction){this._interaction=interaction,this.timer=new a5.utils.Timer};return SolvingState.prototype.onInteractionReset=function(sm){return!1},SolvingState.prototype.onInteractionTryAgain=function(sm){return!1},SolvingState.prototype.onEnter=function(sm){this._interaction.tc_code=lms.TCInteractionCodes.SOLVING,this.timer.stamp()},SolvingState.prototype.onInteractionCheckAnswer=function(sm){var tincan=sm.tincan(),competencies=this._interaction.activityMetadata.getValues("Competencies");competencies=_.map(competencies,function(c){return c.value||c.description}),this._interaction.tc_code=lms.TCInteractionCodes.ANSWERED,$.when(this._interaction.getResultsAsync(),this._interaction.store()).then(function(results){return $.when(results,lms.API.getData(this._interaction.getID()))}.bind(this)).then(function(results,data){tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("answered"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityParent(competencies)}},result:tincan.result({response:JSON.stringify(data),duration:this.timer.getCMITimeString(),score:{scaled:results.correct()/results.total(),max:results.total(),min:0,raw:results.correct()}})}),competencies.length>0&&tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("mastered"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}},result:tincan.result({response:competencies.join(",")})})}.bind(this)),sm.pop()},SolvingState.prototype.onInteractionEnd=function(sm){var tincan=sm.tincan();this._interaction.tc_code=lms.TCInteractionCodes.SUSPENDED,$.when(this._interaction.store()).then(function(){return lms.API.getData(this._interaction.getID())}.bind(this)).then(function(data){data.status="input",tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("suspended"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}},result:tincan.result({response:JSON.stringify(data),duration:this.timer.getCMITimeString()})})}.bind(this)),sm.pop()},SolvingState.prototype.onLOClose=SolvingState.prototype.onInteractionEnd,SolvingState.prototype.onLOSubmit=function(sm){this._interaction.tc_code!==lms.TCInteractionCodes.ANSWERED?this.onInteractionCheckAnswer(sm):sm.pop()},SolvingState.prototype.onLOTotalScore=SolvingState.prototype.onInteractionCheckAnswer,SolvingState.prototype.onInteractionSeeAnswerBeforeInteraction=function(sm){sm.pop()},SolvingState}()}(a5.service.lms,_),function(lms,_){lms.ResumedState=function(){var ResumedState=function(interaction){this._interaction=interaction,this.timer=new a5.utils.Timer};return _(ResumedState.prototype).extend(new lms.SolvingState,{onEnter:function(sm){this._interaction.tc_code=lms.TCInteractionCodes.SOLVING;var tincan=sm.tincan();tincan.sendStatementC({actor:tincan.agent(),verb:tincan.verb("resumed"),object:tincan.activity(),context:{contextActivities:{parent:tincan.activityLearningObjectId()}}}),this.timer.stamp()}}),ResumedState}()}(a5.service.lms,_),function(lms,_){lms.DefaultState=function(){var DefaultState=function(){};return _(DefaultState.prototype).extend({onLOStart:function(sm,params){sm.push(new lms.LOPreviewState(params.lo_id,params.lo))}}),DefaultState}()}(a5.service.lms,_),function(lms,$,_){lms.TinCanWrapper=function(){var _driver,_lo_name,_interaction_name,_send_queue,_send_state_queue,_filter,_activity_prefix="",_actor={},_verbs={},_context={},_tincan=null,_activity_id=null,_lo_id=null,_interaction_id=null,_registration=null,_can_store=!0,_can_restore=!0,process_statement=function(statement){if(_registration)if(statement.context)statement.context.registration=_registration;else{var context=_.extend(_context||{},{registration:_registration});statement.context=new _driver.TinCan.Context(context)}},create_verbs=function(){return{answered:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/answered",display:{und:"answered"}}),attempted:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/attempted",display:{und:"attempted"}}),closed:new _driver.TinCan.Verb({id:"http://activitystrea.ms/schema/1.0/close",display:{und:"closed"}}),launched:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/launched",display:{und:"launched"}}),resumed:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/resumed",display:{und:"resumed"}}),started:new _driver.TinCan.Verb({id:"http://activitystrea.ms/schema/1.0/start",display:{und:"started"}}),suspended:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/suspended",display:{und:"suspended"}}),terminated:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/terminated",display:{und:"terminated"}}),scored:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/scored",display:{und:"scored"}}),mastered:new _driver.TinCan.Verb({id:"http://adlnet.gov/expapi/verbs/mastered",display:{und:"mastered"}}),skipped:new _driver.TinCan.Verb({id:"http://id.tincanapi.com/verb/skipped",display:{und:"skipped"}}),acknowledged:new _driver.TinCan.Verb({id:"http://activitystrea.ms/schema/1.0/acknowledge",display:{und:"acknowledged"}})}},TinCanWrapper=function(driver,parameters,callback){_driver=driver||window,_tincan=new _driver.TinCan({recordStores:[{endpoint:parameters.endpoint,auth:parameters.auth}]}),_activity_prefix=parameters.prefix,_actor=parameters.actor,_context=parameters.context,_verbs=create_verbs(),_send_queue=new lms.SendQueue(_tincan,callback),_send_state_queue=new lms.SendStateQueue(_tincan),_registration=parameters.registration,_activity_id=parameters.activity_id,_filter=_(parameters.filter).map(function(verb){return _verbs[verb]}),_can_store=parameters.canStore,_can_restore=parameters.canRestore};return _(TinCanWrapper.prototype).extend({registration:function(){return _registration},setLearningObjectId:function(lo_id,name){_lo_name=void 0!==name?name:"Learning Object "+lo_id,_lo_id=lo_id},setInteractionId:function(int_id,name){_interaction_name=void 0!==name?name:"Interaction page "+(int_id+1),_interaction_id=int_id},getLearningObjectName:function(){return _lo_name},getInteractionName:function(){return _interaction_name},activityLearningObjectId:function(lo_id){return lo_id=void 0!==lo_id?lo_id:_lo_id,lo_id=_activity_id||(_activity_prefix?_activity_prefix+"/"+lo_id:lo_id)},activityInteractionId:function(interaction_id,lo_id){return interaction_id=void 0!==interaction_id?interaction_id:_interaction_id,this.activityLearningObjectId(lo_id)+"/"+interaction_id},activity:function(type){var id,name=this.getLearningObjectName();return"lo"===type?id=this.activityLearningObjectId():(id=this.activityInteractionId(),name+=", "+this.getInteractionName()),new _driver.TinCan.Activity({id:id,definition:{name:{und:name}}})},activityParent:function(competencies){return _.reduce(competencies,function(memo,competency){return memo.push({objectType:"Activity",id:this.activityLearningObjectId()+"/objectives/"+competency.value,definition:{type:"http://adlnet.gov/expapi/activities/objective",name:{"en-US":competency.description}}}),memo},[{objectType:"Activity",id:this.activityLearningObjectId()}],this)},result:function(cfg){return new _driver.TinCan.Result(cfg)},agent:function(){return new _driver.TinCan.Agent(_actor)},verb:function(name){return _verbs[name]},sendStatementC:function(statement){_.contains(_filter,statement.verb)&&(process_statement(statement),_can_store&&_send_queue.add(statement))},sendStatement:function(statement,callback){if(_.contains(_filter,statement.verb))return process_statement(statement),_can_store&&_tincan.sendStatement(statement,callback)},getStatements:function(cfg){var deferred=$.Deferred();return _can_restore?_tincan.getStatements(_.extend(cfg,{callback:function(err,result){null==err?deferred.resolve(result):deferred.reject(err)}})):deferred.reject(),deferred.promise()},setState:function(key,val,cfg){_can_store&&_send_state_queue.add(key,val,cfg)},getState:function(key,cfg){var deferred=$.Deferred();return _can_restore?_tincan.getState(key,_.extend(cfg,{callback:function(err,result){null==err?deferred.resolve(result):deferred.reject(err)}})):deferred.reject(),deferred.promise()},finish:function(asynch){return $.when(_send_queue.finish(asynch),_send_state_queue.finish(asynch))},start:function(){_send_queue.start(),_send_state_queue.start()}}),_(TinCanWrapper).extend({getInteractionId:function(activity_id,lo_id){var result=activity_id.match(new RegExp(lo_id+"/(.*)"));return result&&result.length>0?result[1]:null}}),TinCanWrapper}()}(a5.service.lms,jQuery,_),function(lms,_){lms.TinCanAdapter=function(){var _sm=null,_tincan=null,_options=null,TinCanAdapter=function(options){_options=options};return _(TinCanAdapter.prototype).extend({start:function(){if(_options.canStore||_options.canRestore){var promise;return _options.fetch&&(promise=$.post(_options.fetch)),$.when(promise).done(function(data){if(data=data||{},data["error-code"])return void logger.error(data["error-text"]);var token=data["auth-token"];token&&(_options.auth="Basic "+token),_tincan=new lms.TinCanWrapper(window,_options,this.onEndPointResponse),_sm=new lms.StateMachine(_tincan),_sm.push(new lms.DefaultState)}.bind(this)).fail(function(xhr,e1,e2){logger.error(e1,e2)})}},onLOStart:function(lo_uid,lo_id,lo){_tincan&&_sm.propagate("onLOStart",{lo_id:lo_uid||lo_id,lo:lo})},onLOEnd:function(lo){_tincan&&_sm.propagate("onLOEnd",{lo:lo})},onLONext:function(){},onLOPrevious:function(){},onInteractionStart:function(interaction_id,interaction){_tincan&&_sm.propagate("onInteractionStart",{interaction_id:interaction_id,interaction:interaction})},onInteractionEnd:function(){_tincan&&_sm.propagate("onInteractionEnd")},onInteractionCheckAnswer:function(){_tincan&&_sm.propagate("onInteractionCheckAnswer")},onInteractionSeeAnswerBeforeInteraction:function(){_tincan&&_sm.propagate("onInteractionSeeAnswerBeforeInteraction")},onInteractionReset:function(){_tincan&&_sm.propagate("onInteractionReset")},onInteractionTryAgain:function(){_tincan&&_sm.propagate("onInteractionTryAgain")},onLOTotalScore:function(score){_tincan&&_sm.propagate("onLOTotalScore",{total_score:score})},onLOSubmit:function(score,duration){if(_tincan)return _sm.propagate("onLOSubmit",{score:score,duration:duration}),_tincan.finish(!0)},setBookmark:function(page){var deferred=$.Deferred();if(!_tincan)return deferred.resolve(),deferred.promise();var promise=_sm.propagate("setBookmark",page);return promise||(deferred.resolve(),deferred.promise())},getBookmark:function(){var deferred=$.Deferred();if(!_tincan)return deferred.resolve(null),deferred.promise();var promise=_sm.invoke("getBookmark");return promise||(deferred.resolve(null),deferred.promise())},getData:function(){var deferred=$.Deferred();if(!_tincan)return deferred.resolve(""),deferred.promise();var promise=_sm.invoke("getData");return promise||(deferred.resolve(""),deferred.promise())},setData:function(serializedData,data){var deferred=$.Deferred();if(!_tincan)return deferred.resolve(),deferred.promise();var promise=_sm.propagate("setData",serializedData,data);return promise||(deferred.resolve(),deferred.promise())},onLOClose:function(sync){if(_tincan)return _sm.propagate("onLOClose"),_sm.clear(),_tincan.finish(sync)},onEndPointResponse:function(result){_(result).each(function(r){return 401===r.err?void(_options.callbacks&&_options.callbacks.onEndpointUnauthorized?_options.callbacks.onEndpointUnauthorized():_options.on_timeout_redirect_url&&lms.TinCanUtils.redirectTo(_options.on_timeout_redirect_url)):500===r.err?void(_options.callbacks&&_options.callbacks.onEndpointError?_options.callbacks.onEndpointError():_options.on_error_redirect_url&&lms.TinCanUtils.redirectTo(_options.on_error_redirect_url)):void 0})}}),TinCanAdapter}()}(a5.service.lms,_),a5.service.InteractionsLoader={init:function(){this.queue=[],this.libraryLoader=a5.service.libraryLoader,this.itemBankManager=new a5.service.ItemBanksManager,this.reactEngineInterface=a5.service.reactEngineInterface,this.needsReact=!1,_.bindAll(this,"onAllInteractionsLoaded")},push:function(interaction){interaction.setLiveCycle("loading"),this.queue.push(interaction),interaction.reset()},start:function(){var promises=_.map(this.queue,function(interaction){return this.load(interaction)},this);return $.when.apply($,promises).then(this.onAllInteractionsLoaded)},onAllInteractionsLoaded:function(){var selected=this.selectInteractions();this.needReact||this.reactEngineInterface.noInteractionWithReact(),this.reactEngineInterface.addToState(a5.service.React.actions.screens.ADD_SCREENS,selected.list),this.trigger("finished",selected.list,selected.userSelectScreen)},reload:function(interaction){return interaction.setLiveCycle("loading"),interaction.reset(),this.load(interaction)},load:function(interaction){return a5.performance.bindInteractionPerformanceEvents(interaction),a5.eventBus.trigger("performance:load_screen_"+interaction.url+":start"),$.when(interaction).then(function(interaction){
return $.when(interaction,this._loadInteractionXML(interaction))}.bind(this)).then(function(interaction,response){return $.when(interaction,response,this._loadItemBanks(interaction,response.xml))}.bind(this)).then(function(interaction,response){return $.when(interaction,response,this._loadReactBuild(interaction,response.xml,response.xmlText),this._loadCKEDITOR(interaction,response.xml,response.xmlText),this._loadPDFJS(interaction,response.xml,response.xmlText),this._loadWiris(interaction,response.xml,response.xmlText),this._loadJSChannel(interaction,response.xml,response.xmlText))}.bind(this)).then(function(interaction,response){this.onInteractionLoaded(interaction,response.xml),a5.eventBus.trigger("performance:load_screen_"+interaction.url+":end")}.bind(this))},onInteractionLoaded:function(interaction,xml){this._initializeInteraction(interaction,xml)},_sanitizeInteraction:function($xml){$xml.find("itemBody").find("#attachments #custom > div").each(function(){var that=$(this),items=that.text().split(/(\]\])(?=>)/);that.empty();for(var text;void 0!==(text=items.shift());)that.append($xml.get(0).createCDATASection(text))})},_initializeInteraction:function(interaction,xml){var $xml=$(xml);this._sanitizeInteraction($xml),interaction.xml=xml,interaction.setTitleAndGroup($xml.find("assessmentItem").attr("title")),interaction.identifier=$xml.find("assessmentItem").attr("identifier"),a5.eventBus.trigger("performance:xml_options_"+interaction.url+":start"),interaction.parseActivityOptions(),a5.eventBus.trigger("performance:xml_options_"+interaction.url+":end"),a5.eventBus.trigger("performance:xml_preprocessor_"+interaction.url+":start"),interaction.xml=a5.preprocessor.applyToXMLNode(xml,interaction,"attachments"),a5.eventBus.trigger("performance:xml_preprocessor_"+interaction.url+":end"),interaction.parseActivityOptions(),interaction.bind("reset",interaction.parseActivityOptions,interaction),interaction.init_enumerations()},_loadInteractionXML:function(interaction){return(new a5.utils.Loader).load(interaction.url).then(function(response){return interaction.source="xml",this.onInteractionXMLLoaded(interaction,response),{xml:response.xml,xmlText:response.text}}.bind(this)).fail(_.partial(this.onInteractionXMLFailed,interaction))},onInteractionXMLLoaded:function(interaction,response){logger.log(interaction.url+" loaded.")},onInteractionXMLFailed:function(interaction,reason,readyState){4===readyState&&(logger.error("Error loading "+interaction.url+": "+reason),alert(reason))},_loadItemBanks:function(interaction,xml){if(this.itemBankManager.hasItemBanks(xml)){var def=$.Deferred(),promise=def.promise();return this.itemBankManager.loadBanks(xml,interaction).done(function(newXml){interaction.source="item-bank",this.onItemBanksLoaded(),def.resolveWith(this,[newXml])}.bind(this)).fail(function(errors){errors&&errors.type&&errors.type===a5.ItemBankErrors.IDS?(this.onItemBanksWarn(errors),interaction.reset(),this._loadItemBanks(interaction,xml).done(function(data){def.resolveWith(this,[data])}).fail(function(data){def.rejectWith(this,[data])})):(this.onItemBanksFailed(errors),def.rejectWith(this,[errors]))}.bind(this)),promise}},onItemBanksLoaded:function(){logger.log("Item banks loaded.")},onItemBanksFailed:function(reason){logger.error("Error loading bank items: "+reason.msg),alert("Error loading bank items")},onItemBanksWarn:function(reason){logger.warn("WARNING loading bank items: "+reason.msg)},_loadReactBuild:function(interaction,xml,xmlText){var interactionNeedReact=this.reactEngineInterface.needReact({interaction:interaction,xml:xml,xmlText:xmlText});if(this.needReact=this.needReact||interactionNeedReact,interactionNeedReact)return $.when(this.reactEngineInterface.loadReactAssets()).then(this.onReactLoaded).fail(this.onReactFailed)},onReactLoaded:function(){logger.log("react assets loaded.")},onReactFailed:function(){logger.error("react assets NOT LOADED. ")},_loadJSChannel:function(interaction,xml,xmlText){var dependencies={interaction:interaction,xml:xml,xmlText:xmlText};if(this.libraryLoader.needLibrary(this.libraryLoader.LIBRARY_FILES.JSCHANNEL,dependencies)){var jschannel=[this.libraryLoader.LIBRARY_FILES.JSCHANNEL];return $.when(this.libraryLoader.load(jschannel)).then(_.partial(this.onJSChannelLoaded,jschannel)).fail(_.partial(this.onJSChannelFailed,jschannel))}},onJSChannelLoaded:function(jschannel){logger.log(jschannel.join(",")+" loaded.")},onJSChannelFailed:function(jschannel){logger.error("couldn't load: "+jschannel.join(","))},_loadPDFJS:function(interaction,xml,xmlText){var dependencies={interaction:interaction,xml:xml,xmlText:xmlText};if(this.libraryLoader.needLibrary(this.libraryLoader.LIBRARY_FILES.PDFJS,dependencies)){var pdfjs=[this.libraryLoader.LIBRARY_FILES.PDFJS];return $.when(this.libraryLoader.load(pdfjs)).then(_.partial(this.onPDFJSLoaded,pdfjs)).fail(_.partial(this.onPDFJSFailed,pdfjs))}},onPDFJSLoaded:function(pdfjs){logger.log(pdfjs.join(",")+" loaded.")},onPDFJSFailed:function(pdfjs){logger.error("couldn't load: "+pdfjs.join(","))},_loadCKEDITOR:function(interaction,xml,xmlText){var dependencies={interaction:interaction,xml:xml,xmlText:xmlText};if(this.libraryLoader.needLibrary(this.libraryLoader.LIBRARY_FILES.CKEDITOR,dependencies)){var ckeditorLibs=[this.libraryLoader.LIBRARY_FILES.CKEDITOR];return $.when(this.libraryLoader.load(ckeditorLibs)).then(_.partial(this.onCKEDITORLoaded,ckeditorLibs)).fail(_.partial(this.onCKEDITORFailed,ckeditorLibs))}},onCKEDITORLoaded:function(ckeditorLibs){logger.log(ckeditorLibs.join(",")+" loaded.")},onCKEDITORFailed:function(ckeditorLibs){logger.error("couldn't load: "+ckeditorLibs.join(","))},_loadWiris:function(interaction,xml,xmlText){var dependencies={interaction:interaction,xml:xml,xmlText:xmlText};if(this.libraryLoader.needLibrary(this.libraryLoader.LIBRARY_FILES.WIRIS_QUIZ,dependencies)){var wirisLibs=[this.libraryLoader.LIBRARY_FILES.WIRIS_QUIZ];return $.when(this.libraryLoader.load(wirisLibs)).then(this.onWirisLoaded.bind(this,wirisLibs)).fail(this.onWirisFailed.bind(this,wirisLibs))}},onWirisLoaded:function(wirisLibs){logger.log(wirisLibs.join(",")+" loaded."),this._initializeWiris()},onWirisFailed:function(wirisLibs){logger.error("couldn't load: "+wirisLibs.join(","))},_initializeWiris:function(){var config=com.wiris.quizzes.api.QuizzesBuilder.getInstance().getConfiguration();config.set(com.wiris.quizzes.api.ConfigurationKeys.RESOURCES_URL,A5.WIRIS_QUIZ_LIBRARY_RESOURCES_URL),_.isEmpty(A5.WIRIS_QUIZ_VALIDATION_SERVICE_URL)||config.set(com.wiris.quizzes.api.ConfigurationKeys.SERVICE_URL,A5.WIRIS_QUIZ_VALIDATION_SERVICE_URL)},selectInteractions:function(){var userSelectScreen=null,intList=this.queue,groups=a5.utils.getInteractionsGroups(intList);return a5.mainBuilder.options().activitypoolIsOn()&&groups.length&&$(intList[0].xml).find("userselection").length?(userSelectScreen=this.poolIntro(intList),intList=_.difference(intList,userSelectScreen)):"Present:Present:Quiz"===intList[0].identifier&&(userSelectScreen=[intList[0]],intList=_.difference(intList,userSelectScreen)),{userSelectScreen:userSelectScreen,list:intList}},poolIntro:function(intList){var introScreen=intList[0],$controls=$("#micro_controls, #macro_controls, #page_controls");return introScreen.bind("show",function(){$controls.hide()}),introScreen.bind("hide",function(){$controls.show()}),[introScreen]}},Obj.extend("a5.service.InteractionsLoader"),a5.service.ItemBanksManager={init:function(){},hasItemBanks:function(xml){return $(xml).find("itembank").length},loadBanks:function(xml,interaction){var $xml=$(xml),deferred=$.Deferred(),itemBankNodes=$xml.find("itembank"),activityType=$xml.find("assessmentItem").attr("identifier"),itbLoader=this.itemBankLoader=new a5.service.ItemBankLoader;return $.when(a5.service.lms.API.getData(interaction.getID())).then(_.bind(function(data){var storedData=data||{};return _.each(itemBankNodes,function(node){itbLoader.push(this.itemBankFromNode(node,activityType,storedData.itemBanks))},this),$.when.apply($,[storedData].concat(this.itemBankLoader.start()))},this)).done(_.bind(function(data){this.replaceItemBankData($xml,data,interaction,Array.prototype.slice.call(arguments,1)),deferred.resolveWith(this,[xml])},this)).fail(function(data){deferred.rejectWith(this,[data])}),deferred.promise()},itemBankFromNode:function(node,aType,storedItems){var $node=$(node),config={node:node,sets:_.compact(($node.attr("sets")||"").split("|")),tags:_.compact(($node.attr("tags")||"").split("|")),amount:parseInt($node.attr("amount"),10),itembankId:$node.attr("id"),activityType:aType};if(storedItems){var storedIds=this.getItemIds(config.itembankId,storedItems);storedIds&&(config.itemIds=storedIds)}return new a5.ItemBank(config,null)},replaceItemBankData:function($xml,storedData,interaction,itembanks){var itemsIds=[];_.each(itembanks,function(itb){this.addItemBankAnswers($xml,itb),this.addItemBankQuestions($xml,itb),itemsIds.push({id:itb.itembankId,itemIds:itb.itemIds});var escapedId=a5.utils.jquerySelectorEscape(itb.itembankId);$xml.find("itembank#"+escapedId).closest("#contentblock").remove()},this),this.updateItembankStoredData(itemsIds,storedData,interaction)},addItemBankAnswers:function($xml,itb){var answersXML=itb.getAnswersResponsesXML(),lastResponseDeclaration=this.getLastResponseDeclaration($xml);lastResponseDeclaration?lastResponseDeclaration.after(answersXML):this.getAssessmentItem($xml).prepend(answersXML)},getLastResponseDeclaration:function($xml){if($xml.find("responseDeclaration").length)return $xml.find("responseDeclaration:last")},getAssessmentItem:function($xml){return $xml.find("assessmentItem")},addItemBankQuestions:function($xml,itb){var questionsXML=itb.getQuestionsXML(),escapedId=a5.utils.jquerySelectorEscape(itb.itembankId);$xml.find("itembank#"+escapedId).closest("#contentblock").after(questionsXML)},getItemIds:function(id,items){var storedItem=_.findWhere(items,{id:id});return storedItem&&storedItem.itemIds},updateItembankStoredData:function(items,storedData,interaction){var storedBanks=storedData.itemBanks||[];if((items||[]).some(function(newItem){var storedItem=_.findWhere(storedBanks,{id:newItem.id});return!storedItem||_.difference(storedItem.itemIds,newItem.itemIds).length>0||_.difference(newItem.itemIds,storedItem.itemIds).length>0})){var ob=_.extend({},storedData,{itemBanks:items});a5.service.lms.API.setData(interaction.getID(),ob),interaction.itemBanks=items}}},Obj.extend("a5.service.ItemBanksManager"),a5.service.ItemBankLoader={init:function(){this.queue=[]},push:function(itemBank){this.queue.push(itemBank),this.queue=_.flatten(this.queue)},start:function(){return _.map(this.queue,function(itembank){var def=$.Deferred();return $.ajax({type:"GET",url:itembank.getUrl(),dataType:"json",data:itembank.getUrlParams()}).done(_.bind(function(data,code,response){var errors=itembank.setData(data);null===errors?def.resolveWith(this,[itembank]):def.rejectWith(this,errors)},this)).fail(function(data,code,response){var responseErrors=[itembank.itembankId,data.status,response].join("|");def.rejectWith(this,[{type:a5.ItemBankErrors.SERVER,msg:responseErrors}])}),def.promise()},this)}},Obj.extend("a5.service.ItemBankLoader"),a5.service.InteractionExporter={template:"a5.view.export.General",extendedWritingTemplate:"a5.view.export.ExtendedWriting",init:function(interaction){this.interaction=interaction},openDialog:function(){this.getInteractionHTMLToConvert().then(function($html){var $dialog=a5.view.dialog.display("a5.view.dialog.ExportAs",{filename:A5.DEFAULT_SAVEAS_FILENAME},{ok:function(){var format=$dialog.find("#export-format option:selected").val(),filename=$dialog.find("#downloadFilename").val();this["exportAs"+format.toUpperCase()].call(this,filename,$html.html())}.bind(this)})}.bind(this))},exportAsPDF:function(filename,html){this.exportTo("pdf",filename,html)},exportAsRTF:function(filename,html){this.exportTo("rtf",filename,html)},exportTo:function(format,filename,html){a5.service.converter.exportTo({formats:format,output:filename,input:html})},_convertTextAreasToText:function($original,$html){var texts=[];$original.find("textarea").each(function(index,textarea){texts.push($(textarea).val().split("\n").join("<br>"))}),$html.find("textarea").each(function(index,textarea){texts[index]&&$(textarea).after('<div class="user-input-export"><p>'+texts[index]+"</p></div>"),$(textarea).remove()})},_convertInputsToText:function($original,$html){var texts=[];$original.find("input:text").each(function(index,input){texts.push($(input).val())}),$html.find("input:text").each(function(index,input){var $input=$(input);if(texts[index])if($input.is(".text-area-content.inline input:text")){var $wrapper=$input.closest(".text-area-content.inline");$wrapper.contents().unwrap(),$input.after('<span class="user-input-export">'+texts[index]+"</span>")}else $input.after('<div class="user-input-export">'+texts[index]+"</div>");$input.remove()})},_convertCKEditorsToText:function($original,$html){window.CKEDITOR&&_.each(window.CKEDITOR.instances,function(ck,id){var sId=_.str.sprintf("[id='cke_%s']",id),$ckeditor=$html.find(sId);ck.getData()&&($ckeditor.after('<div class="user-input-export">'+ck.getData()+"</div>"),$ckeditor.prev(".user-input-export").remove()),$ckeditor.remove()})},_convertImagesToBase64:function($original,$html){var promises=$html.find("img").map(function(index,image){var deferred=$.Deferred(),$image=$(image);return a5.utils.imageToBase64(image).done(function(dataUri){$image.attr("src",dataUri)}).fail(function(){$image.remove()}).always(function(){deferred.resolve()}),deferred.promise()}).toArray();return $.when.apply($,promises)},_removeAudioVideo:function($original,$html){$html.find(".v_a_media, .mediaPlayer").remove()},_removeEmptySpan:function($original,$html){$html.find("span:empty").remove()},_getZones:function($source){var $rubric=$source.find("[data-zone-type='rubric']"),$content=$source.find("[data-zone-type='content']"),$media=$source.find("[data-zone-type='media']");return{rubric:$rubric.html(),content:$content.html(),media:$media.html()}},getInteractionHTMLToConvert:function(){var $original=this.interaction.contentWrap,$html=$original.clone(),template=this.interaction.template;return this._convertTextAreasToText($original,$html),this._convertCKEditorsToText($original,$html),this._convertInputsToText($original,$html),this._removeAudioVideo($original,$html),this._removeEmptySpan($original,$html),this._convertImagesToBase64($original,$html).then(function(){return $html="Input:Creative:Extended writing"===this.interaction.identifier?this.getInteractionHTMLForExtendedWriting($html,template):this.getInteractionHTML($html,template)}.bind(this))},getInteractionHTML:function($source,template){var zones=this._getZones($source);return $(a5.service.templates.render(this.template,_.extend(zones,{template:template})))},getInteractionHTMLForExtendedWriting:function($source,template){for(var $section,zones=this._getZones($source),courseTitle=_.first(this.interaction.activityMetadata.getValues("Course name")),sections=[],index=1;$section=$source.find(".sect-"+index),$section.length;index++){var $userInput=$section.find(".user-input-export");sections.push($userInput.html())}return $(a5.service.templates.render(this.extendedWritingTemplate,_.extend(zones,{courseTitle:courseTitle?courseTitle.value||courseTitle.description:"",sections:sections,template:template})))}},Obj.extend("a5.service.InteractionExporter"),a5.service.PostMessager={listeners:[],init:function(){window.addEventListener("message",_.bind(this.onPostMessageReceived,this),!1)},sendMessage:function(message,args){var messObj={actionCode:message};args&&(messObj=$.extend(args,messObj)),window.parent.postMessage(messObj,"*")},addListener:function(event,cbackFunc){var eventOb=_.findWhere(this.listeners,{event:event});eventOb?eventOb.callbacks=eventOb.callbacks?eventOb.callbacks.concat([cbackFunc]):[cbackFunc]:this.listeners.push({event:event,callbacks:[cbackFunc]})},removeListener:function(event,cbackFunc){var eventOb=_.findWhere(this.listeners,{event:event});eventOb&&(eventOb.callbacks=_.without(eventOb.callbacks,cbackFunc))},onPostMessageReceived:function(evt){if(evt.data.actionCode){logger.log("a5.service.PostMessager:recieve message from: "+evt.origin+" message: "+JSON.stringify(evt.data));var eventOb=_.findWhere(this.listeners,{event:evt.data.actionCode});eventOb&&_.each(eventOb.callbacks,function(cbk){cbk.call()})}}},Obj.extend("a5.service.PostMessager"),a5.service.ExternalLibraryLoader={STATES:{NOT_LOADED:0,LOADING:1,LOADED:2,ERROR:3},libraries:{},LIBRARY_FILES:{CKEDITOR:"ckeditor.bundle.js",WIRIS_QUIZ:"quizzes.js",I18NEXT:"i18next.bundle.js",PDFJS:"pdf.js",JSCHANNEL:"jschannel.js"},load:function(libs){var promise=$.Deferred();return $.when.apply($,_.map(libs,_.bind(function(lib){return this.loadLib(this.prepareLibrary(lib))},this))).done(function(response){promise.resolveWith(this,[response])}).fail(function(response){promise.rejectWith(this,[response])}),promise.promise()},needLibrary:function(lib,parameters){var needed=!1,xml=parameters.xml,xmlText=parameters.xmlText,interaction=parameters.interaction,$xml=$(xml);return lib===this.LIBRARY_FILES.CKEDITOR?needed=xmlText.match(/#(inlineeditor|richtextinput).*#/i)||$xml.find('assessmentItem[identifier="Input:Creative:Extended writing"], assessmentItem[identifier="Present:Present:Ebook"]').length||interaction.options.wikiToolIsOn()&&A5.WIKI&&$xml.find("div#wiki").length||interaction.options.lONotesAreaIsOn():lib===this.LIBRARY_FILES.WIRIS_QUIZ?needed=$xml.find('assessmentItem[identifier="Input:Completion:MathsQuizzes"]').length:lib===this.LIBRARY_FILES.PDFJS?needed=$xml.find('ebook[type="pdf"]').length:lib===this.LIBRARY_FILES.JSCHANNEL&&(needed=$xml.find('assessmentItem[identifier="Present:External:Scorable"]').length),needed},prepareLibrary:function(lib){if(lib===this.LIBRARY_FILES.CKEDITOR){var ckeditor_basepath=A5.ENGINE_ROOT+A5.CKEDITOR_FOLDER_PATH;return A5.CKEDITOR_RELATIVE?window.CKEDITOR_BASEPATH=ckeditor_basepath:window.CKEDITOR_BASEPATH=window.location.protocol+ckeditor_basepath,window.CKEDITOR_BASEPATH+this.LIBRARY_FILES.CKEDITOR}return lib===this.LIBRARY_FILES.WIRIS_QUIZ?($("<link/>",{rel:"stylesheet",type:"text/css",href:A5.WIRIS_QUIZ_LIBRARY_RESOURCES_URL+"/wirisquizzes.css"}).appendTo("head"),A5.WIRIS_QUIZ_LIBRARY_RESOURCES_URL+"/"+this.LIBRARY_FILES.WIRIS_QUIZ):lib===this.LIBRARY_FILES.I18NEXT?A5.ENGINE_ROOT+A5.I18NEXT_FOLDER_PATH+this.LIBRARY_FILES.I18NEXT:lib===this.LIBRARY_FILES.PDFJS?A5.ENGINE_ROOT+A5.PDFJS_FOLDER_PATH+lib:lib===this.LIBRARY_FILES.JSCHANNEL?A5.ENGINE_ROOT+A5.JSCHANNEL_FOLDER_PATH+lib:lib},loadLib:function(lib){var promise;return!lib||this.libraries[lib]&&this.libraries[lib].state===this.STATES.ERROR?(promise=$.Deferred(),promise.rejectWith(this,"error")):this.libraries[lib]&&this.libraries[lib].state!==this.STATES.NOT_LOADED?this.libraries[lib].state===this.STATES.LOADING?promise=this.libraries[lib].promise:this.libraries[lib].state===this.STATES.LOADED&&(promise=$.Deferred(),promise.resolveWith(this,["loaded"])):promise=this.loadLibrary(lib).promise,promise.promise()},loadLibrary:function(lib){var promise=$.Deferred();this.libraries[lib]={state:this.STATES.LOADING,promise:promise};var doneCallback=_.bind(function(data,code,response){this.libraries[lib].state=this.STATES.LOADED,promise.resolveWith(this,["loaded"])},this),errorCallback=_.bind(function(data,code,response){logger.error("error loading script: "+lib),this.libraries[lib].state=this.STATES.ERROR,promise.rejectWith(this,["error"])},this);return a5.getScript(lib,doneCallback,errorCallback),this.libraries[lib]}},Obj.extend("a5.service.ExternalLibraryLoader"),a5.models.interaction.ReactItem={VALUE_CHANGE_EVENT:"VALUE_CHANGE_EVENT",FILL_CHANGE_EVENT:"FILL_CHANGE_EVENT",STATE_CHANGE_EVENT:"STATE_CHANGE_EVENT",SHOW_NEXT_ANSWER_EVENT:"SHOW_NEXT_ANSWER_EVENT",SHOW_ALL_ANSWER_EVENT:"SHOW_ALL_ANSWER_EVENT",SHOW_SOLUTION_HINT_EVENT:"SHOW_SOLUTION_HINT_EVENT",init:function(index,data,solData,userData,interactionId,activityType,verificationService){this.interactionId=interactionId,this.activityId=interactionId+"_"+index,this.verificationService=verificationService||"local",this.activityData=data,this.solutionData="local"===this.verificationService?solData:null,this.activityType=activityType,this.userData=userData,this.setStates()},setStates:function(){var activity={id:this.activityId,screenId:this.interactionId,data:this.activityData,userData:this.userData,validationData:[],uiData:[]};this.solutionData&&(activity.solutionData=this.solutionData),a5.service.reactEngineInterface.addToState(a5.service.React.actions.activities.getActivityAddAction(this.activityType),activity)},meetsMinLength:function(){return!0},isFilled:function(){},hasCandidatesForSolutionHint:function(){},hasCandidatesForShowNextAnswer:function(){},hasCandidatesForValidation:function(){},clearSolutionHint:function(){},showSolutionHint:function(){},showNextAnswer:function(){},showAllAnswer:function(){},getAllAnswers:function(){},getScores:function(){var methodName=a5.service.React.selectors.getActivityScoreDataMethod(this.activityType),data={activityType:this.activityType+"s",activityId:this.activityId,normalized:!0},scoreData=a5.service.reactEngineInterface.getState(methodName,data),score=new a5.Score;return score.incTotal(scoreData.total),score.incCorrect(scoreData.correct),score.incFilled(scoreData.filled),score},setAnswer:function(){var allEntries=this._select("getActivityItemsToValidateMethod");allEntries=this._mapListToUiState(allEntries,"correct","user",!1),a5.service.reactEngineInterface.addToState(a5.service.React.actions.activities.getActivityUIStateChangeAction(this.activityType),{activityId:this.activityId,data:{entries:allEntries}})},setAnswerInput:function(){},tryAgain:function(){_.defer(_.bind(function(){var entriesToClear=this._select("getActivityItemsToClearOnTryAgain");a5.service.reactEngineInterface.addToState(a5.service.React.actions.activities.getActivityClearUserDataAction(this.activityType),{activityId:this.activityId,data:{entries:entriesToClear||[]}});var entriesToFreeze=this._select("getActivityItemsToFreezeOnTryAgain");entriesToFreeze=this._mapListToUiState(entriesToFreeze,!1,"user",!1);var entriesToEnable=this._select("getActivityItemsToEnableOnTryAgain");entriesToEnable=this._mapListToUiState(entriesToEnable,!1,"user",!0),a5.service.reactEngineInterface.addToState(a5.service.React.actions.activities.getActivityUIStateChangeAction(this.activityType),{activityId:this.activityId,data:{entries:entriesToFreeze.concat(entriesToEnable)||[]}})},this))},showAnswer:function(){var allEntries=this._select("getActivityItemsToValidateMethod");allEntries=this._mapListToUiState(allEntries,"filled","solution",!1),a5.service.reactEngineInterface.addToState(a5.service.React.actions.activities.getActivityUIStateChangeAction(this.activityType),{activityId:this.activityId,data:{entries:allEntries}})},store:function(){var methodName=a5.service.React.selectors.getActivityUserDataMethod(this.activityType),data={activityType:this.activityType+"s",activityId:this.activityId,normalized:!0};return a5.service.reactEngineInterface.getState(methodName,data)},restore:function(stored){var data={activityId:this.activityId,data:stored};a5.service.reactEngineInterface.addToState(a5.service.React.actions.activities.getActivityRestoreAction(this.activityType),data)},_selectorData:function(){return{activityType:this.activityType+"s",activityId:this.activityId,normalized:!0}},_selectorName:function(selector){return a5.service.React.selectors[selector](this.activityType)},_select:function(selector){return a5.service.reactEngineInterface.getState(this._selectorName(selector),this._selectorData())},_mapListToUiState:function(list,validate,valueType,enabled){return _.map(list,function(el){return _.extend(el,{validate:validate,valueType:valueType,enabled:enabled})})}},Obj.extend("a5.models.interaction.ReactItem"),a5.service.React=a5.service.React||{},a5.service.React.EngineInterface={reactActivities:["Input:Completion:Crossword"],init:function(){this.actionsQueue=[],this.utils=new a5.service.React.Utils,this.libLoader=a5.service.libraryLoader,this.reactAssetsStates={NOT_LOADED:0,LOADING:1,LOADED:2,ERROR:3,NOT_NEEDED:4},this.reactAssetsState=this.reactAssetsStates.NOT_LOADED,this.config={vendors_lib:A5.REACT_BUNDLE_FOLDER_PATH+"playerVendors.js",dp_bundle:A5.REACT_BUNDLE_FOLDER_PATH+"dp-react-lib.bundle.js",react_bundle:A5.REACT_BUNDLE_FOLDER_PATH+"react-lib.bundle.js"}},getState:function(method,data){if(this.reactAssetsState===this.reactAssetsStates.ERROR||this.reactAssetsState===this.reactAssetsStates.NOT_NEEDED)return!1;var params={method:method,data:data};return this.reactAssetsState===this.reactAssetsStates.LOADED?ReactComponents.getState(params):void 0},addToState:function(action,data){if(this.reactAssetsState===this.reactAssetsStates.ERROR||this.reactAssetsState===this.reactAssetsStates.NOT_NEEDED)return!1;var actions=a5.service.React.actions;switch(action){case actions.lo.SET_LO_OPTIONS:data=this.utils.optionsToState(data);break;case actions.screens.ADD_SCREENS:data=this.utils.interactionToState(data)}var params={action:action,data:data};return this.reactAssetsState===this.reactAssetsStates.LOADED?ReactComponents.updateState(params):this.actionsQueue.push({type:"setState",params:params}),!0},renderElement:function(componentName,props,destination){if(this.reactAssetsState===this.reactAssetsStates.ERROR||this.reactAssetsState===this.reactAssetsStates.NOT_NEEDED)return!1;var params={componentName:componentName,props:props,destination:destination};return this.reactAssetsState===this.reactAssetsStates.LOADED?ReactComponents.renderElement(params):this.actionsQueue.push({type:"render",params:params}),!0},needReact:function(params){var $xml=$(params.xml);return this.isActivityReact($xml.find("assessmentItem").attr("identifier"))},isActivityReact:function(activityType){if(a5.dp.config.reactActivitiesEnabled){var reactActivities=a5.dp.config.reactActivities.filter(function(at){return _.contains(this.reactActivities,at)}.bind(this));return _.contains(reactActivities,activityType)}return!1},noInteractionWithReact:function(){this.reactAssetsState=this.reactAssetsStates.NOT_NEEDED,this.flushActions()},loadReactAssets:function(){var promise=$.Deferred();switch(this.reactAssetsState){case this.reactAssetsStates.NOT_LOADED:this.reactAssetsState=this.reactAssetsStates.LOADING;var reactAssets=[this.config.vendors_lib,this.config.dp_bundle,this.config.react_bundle];return $.when(this.libLoader.load(reactAssets)).done(function(loaded){this.reactAssetsState=this.reactAssetsStates.LOADED,this.flushActions(!0),promise.resolveWith(this,[loaded])}.bind(this)).fail(function(err){this.reactAssetsState=this.reactAssetsStates.ERROR,this.flushActions(!1),promise.rejectWith(this,[err])}.bind(this)),promise.promise();case this.reactAssetsStates.LOADING:case this.reactAssetsStates.LOADED:case this.reactAssetsStates.ERROR:return this.libLoader.load(reactAssets);case this.reactAssetsStates.NOT_NEEDED:return promise.rejectWith(this,["not needed"]),promise.promise()}},flushActions:function(shouldRunElements){shouldRunElements&&this.actionsQueue.forEach(function(action){"render"===action.type?ReactComponents.renderElement(action.params):"setState"===action.type&&ReactComponents.updateState(action.params)}.bind(this)),this.actionsQueue=[]}},Obj.extend("a5.service.React.EngineInterface"),a5.service.React.Utils={interactionToState:function(interactions){return _.map(interactions,function(interaction){return{id:interaction.id,identifier:interaction.identifier,xml:interaction.xml,source:interaction.source,activities:[],options:this.optionsToState(interaction.options)}}.bind(this))},optionsToState:function(options){var optionsHash=this.__mergeOptionsToPriority(options,"options"),customOptionsHash=this.__mergeOptionsToPriority(options,"customOptions");return Object.keys(optionsHash).forEach(function(key){optionsHash[key]={key:optionsHash[key]}}),Object.keys(customOptionsHash).forEach(function(customKey){_.contains(Object.keys(optionsHash),customKey)||(optionsHash[customKey]={}),optionsHash[customKey].value=customOptionsHash[customKey]}),optionsHash=this.__clearOptionsHash(optionsHash)},__mergeOptionsToPriority:function(options,field){var optionsHashList=options.parents.map(function(o){return o[field]});return optionsHashList.push(options[field]),optionsHashList.reverse(),optionsHashList.reduce(function(acumulator,current){return _.extend(acumulator,current)})},__clearOptionsHash:function(optionsHash){for(var ob=_.extend({},optionsHash),hashKeys=Object.keys(ob),i=0;i<hashKeys.length;i++){var curKey=hashKeys[i],clearNumberString=Number(curKey).toString();clearNumberString!==curKey&&(ob[clearNumberString]=ob[curKey],delete ob[curKey])}return ob}},Obj.extend("a5.service.React.Utils"),a5.service.React=a5.service.React||{};var activitiesStr="activities.",activitiesUpperStr="ACTIVITIES.";a5.service.React.actions={lo:{SET_LO_OPTIONS:"LO.SET_LO_OPTIONS"},options:{SET_OPTIONS_LIST:"OPTIONS.SET_OPTIONS_LIST"},screens:{ADD_SCREENS:"SCREENS.ADD_SCREENS"},activities:{getActivityAddAction:function(activityType){return activitiesUpperStr+activityType.toUpperCase()+".ADD_"+activityType.toUpperCase()},getActivityRestoreAction:function(activityType){return activitiesUpperStr+activityType.toUpperCase()+".RESTORE_USER_DATA"},getActivityUIStateChangeAction:function(activityType){return activitiesUpperStr+activityType.toUpperCase()+".UI_STATE_CHANGE"},getActivityClearUserDataAction:function(activityType){return activitiesUpperStr+activityType.toUpperCase()+".CLEAR_USER_DATA"},getAllActivityActionConstants:function(activityType){var retOb={};return retOb[activityType]={},retOb["ADD_"+activityType.toUpperCase()]=a5.service.React.actions.activities.getActivityAddAction(activityType),retOb.RESTORE_USER_DATA=a5.service.React.actions.activities.getActivityRestoreAction(activityType),retOb.UI_STATE_CHANGE=a5.service.React.actions.activities.getActivityUIStateChangeAction(activityType),retOb.CLEAR_USER_DATA=a5.service.React.actions.activities.getActivityClearUserDataAction(activityType),retOb}}},a5.service.React.components={activities:{iccrossword:{ICCrossword:activitiesStr+"iccrossword.ICCrossword"}}},a5.service.React.selectors={getActivityUserDataMethod:function(activityType){return activitiesStr+activityType+".getUserDataForStorage"},getActivityScoreDataMethod:function(activityType){return activitiesStr+activityType+".getScore"},getActivityItemsToValidateMethod:function(activityType){return activitiesStr+activityType+".getItemsToValidate"},getActivityItemsToClearOnTryAgain:function(activityType){return activitiesStr+activityType+".getItemsToClearOnTryAgain"},getActivityItemsToFreezeOnTryAgain:function(activityType){return activitiesStr+activityType+".getItemsToFreezeOnTryAgain"},getActivityItemsToEnableOnTryAgain:function(activityType){return activitiesStr+activityType+".getItemsToEnableOnTryAgain"}},a5.Tasks={init:function(){this.tasks=[],this.runningTask=null,this.continuuu()},push:function(task,immediately){immediately?(task!==this.runningTask&&(this.interruptedTask=this.runningTask),this.tasks.unshift(task),this.runningTask=null,cancelAnimationFrame(this.requestId),this.requestId=null):this.tasks.push(task),this.requestId||this.run()},findNextTask:function(){return this.tasks.shift()},continuuu:function(){this.requestId=requestAnimationFrame(_.bind(this.run,this))},run:function(){if(this.runningTask||(this.runningTask=this.findNextTask(),this.runningTask&&this.runningTask.trigger("start")),this.runningTask){var runningTask=this.runningTask;runningTask.trigger("run");runningTask.run()&&(runningTask.trigger("stop"),runningTask=null,this.runningTask=this.interruptedTask,this.interruptedTask=null)}this.continuuu()},current:function(){return this.runningTask},clear:function(){this.tasks=[],cancelAnimationFrame(this.requestId),this.requestId=null},
clearBy:function(predicate){this.tasks=_.filter(this.tasks,predicate)}},Obj.extend("a5.Tasks"),a5.Task={init:function(){this.events={start:[],stop:[],run:[]},a5.logger.tasks&&(this.bind("start",function(){logger.info("tasks",this.group,"start")},this),this.bind("stop",function(){logger.info("tasks",this.group,"stop")},this))},run:function(){return!0}},Obj.extend("a5.Task"),a5.FunctionTask={init:function(func,context){this._super(),this.func=func,this.context=context||this},run:function(){return this.func.apply(this.context)}},a5.Task.extend("a5.FunctionTask"),a5.TaskGroups={init:function(){this.groups={}},push:function(task,group,immediately){group=group||"default",this.groups[group]=this.groups[group]||new a5.Tasks,task.group=group,this.groups[group].push(task,immediately)},current:function(group){if(group=group||"default",this.groups[group])return this.groups[group].current()},clear:function(group){if(group=group||"default",this.groups[group])return this.groups[group].clear()},clearBy:function(predicate,group){if(group=group||"default",this.groups[group])return this.groups[group].clearBy(predicate)}},Obj.extend("a5.TaskGroups"),a5.tasks=new a5.TaskGroups,Obj.extend("a5.service.Templates",{init:function(parameters){this.dp=parameters.dp,this.globalContext=parameters.globals,this.contentElementTemplates=[],Handlebars.registerHelper("ifsingular",this._ifsingular),Handlebars.registerHelper("ifplural",this._ifplural),Handlebars.registerHelper("ifzero",this._ifzero),Handlebars.registerHelper("loOption",this._loOption),Handlebars.registerHelper("ifEq",this._ifEq),window.i18next&&Handlebars.registerHelper("t",this._i18next),Handlebars.templates={}},loadHandlebarsTemplateFromText:function(text,context){return Handlebars.compile(text)(_.extend(context||{},this.globalContext))||""},loadLayoutTemplate:function(name,success,stringTemplate){stringTemplate&&_.isString(stringTemplate)?success(this.dp.loadLayoutTemplateFromString(_.unescape(stringTemplate))):this.dp.loadLayoutTemplate(name).then(function($template){success($template)})},loadSkinTemplate:function(name,context,success,defaultTemplate){$.when(this._loadSkinTemplate(name,defaultTemplate)).then(function(template){success(template&&template(_.extend(context||{},this.globalContext))||"")})},render:function(name,context,defaultTemplate){return this.loadSkinTemplateSync(name,context,defaultTemplate)},loadSkinTemplateSync:function(name,context,defaultTemplate){var template=this._loadSkinTemplateSync(name,defaultTemplate);return template&&template(_.extend(context||{},this.globalContext))||""},loadContentElementTemplate:function(name,context){if(!name)return"";var template=this._loadContentElementTemplate(name);return _(context).each(function(key,value){this._replaceSubpart(template,key,value)},this),template},_loadSkinTemplateSync:function(name,defaultTemplate){var template;if(name)if(Handlebars.templates&&Handlebars.templates[name])template=Handlebars.templates[name];else{var precompiled=!1;template=this.dp.loadSkinTemplateSync(name),template||(template=this._loadPrecompiledEngineTemplate(name),precompiled=!!template),template||(template=defaultTemplate||""),precompiled||(template=Handlebars.compile(template)),Handlebars.templates[name]=template}else template=Handlebars.compile(defaultTemplate||"");return template},_loadSkinTemplate:function(name,defaultTemplate){return name?Handlebars.templates&&Handlebars.templates[name]?Handlebars.templates[name]:this.dp.loadSkinTemplate(name).then(function(template){var compiledTemplate=Handlebars.compile(template);return Handlebars.templates[name]=compiledTemplate,compiledTemplate},function(){var compiledTemplate=this._loadPrecompiledEngineTemplate(name);return compiledTemplate||(defaultTemplate=defaultTemplate||"",compiledTemplate=Handlebars.compile(defaultTemplate)),Handlebars.templates[name]=compiledTemplate,compiledTemplate}):Handlebars.compile(defaultTemplate||"")},_loadPrecompiledEngineTemplate:function(name){return A5.ENGINE_TEMPLATES&&A5.ENGINE_TEMPLATES[name]},_loadContentElementTemplate:function(tName){var mName="##"+tName+"##";if(void 0!==this.contentElementTemplates[mName])return this.contentElementTemplates[mName];var str=this._getSubpart(this.dp.contentElements,tName);return str=this.loadHandlebarsTemplateFromText(str),this.contentElementTemplates[tName]=str,str},_getSubpart:function(tmpl,tName){tName="##"+tName+"##";var pos_1=tmpl.indexOf(tName);if(-1==pos_1)return"";var pos_2=tmpl.indexOf("--\x3e",pos_1);if(-1==pos_2)return"";var pos_3=tmpl.indexOf(tName,pos_2);if(-1==pos_3)return"";var pos_4=tmpl.indexOf("--\x3e",pos_3);if(-1==pos_4)return"";var str=tmpl.substring(pos_2+3,pos_4);return pos_1=str.lastIndexOf("\x3c!--"),str=str.substring(0,pos_1)},_replaceSubpart:function(tmpl,sMarker,html){sMarker="##"+sMarker+"##";var re=new RegExp("\x3c!--[\\s\\w#]*"+sMarker+"[\\s\\w#]*--\x3e([\\w\\W]*)\x3c!--[\\s\\w#]*"+sMarker+"[\\s\\w#]*--\x3e","gi");return tmpl.replace(re,html)},_ifsingular:function(value,options){if(arguments.length<2)throw new Error("Handlebars Helper ifsingular needs 1 parameter");if(1==value)return options.fn(this)},_ifplural:function(value,options){if(arguments.length<2)throw new Error("Handlebars Helper ifplural needs 1 parameter");if(value>1)return options.fn(this)},_ifzero:function(value,block){if(arguments.length<2)throw new Error("Handlebars Helper ifzero needs 1 parameter");return 0==value?block.fn(this):block.inverse(this)},_loOption:function(value,block){if(arguments.length<2)throw new Error("Handlebars Helper loOption needs 1 parameter");return a5.mainBuilder.options(!0)[value]()?block.fn(this):block.inverse(this)},_ifEq:function(v1,v2,block){return v1===v2?block.fn(this):block.inverse(this)},_i18next:function(key,options){var result=i18next.t(key,options.hash);return new Handlebars.SafeString(result)}});function getAjaxData(param){var param2=param;if(A5&&A5.SKIN_ROOT&&param.substr(0,A5.SKIN_ROOT.length)==A5.SKIN_ROOT&&(param2=param.substr(A5.SKIN_ROOT.length)),A5.TEMPLATES&&A5.TEMPLATES[param])return A5.TEMPLATES[param];if(window.ajaxData&&(ajaxData[param]||ajaxData[param2])){return ajaxData[param]||ajaxData[param2]}}a5.service.Attachment={init:function(label,html,options,interaction,data){data=data||{},this.id=a5.utils.createUID(),this.label=label,this.html=a5.preprocessor.applyToXMLText(html,interaction),this.options=options||{},this.interaction=interaction,this.customType=data.customType||"",this.modes=data.modes||[],this.userVisibility=data.userVisibility||"all",this.pinned=data.pinned||!1,this.attachmentLink=data.attachmentLink,this.showInHeader=!data.attachmentLink||"showInHeader"===data.attachmentLink,this.showAlternativeDisplay="showAsModal"===data.attachmentLink,this._isOpen=!1,this.type=this.getType(),this.pinnedInteractions=[],this.onAttachmentOpenListeners=new Listeners(this),this.$=$("<div>",{class:"attachment-wrapper"}),_.bindAll(this,"onClick","onInteractionReady"),this.render=_.once(this.render),this.onInteractionShowed=this.onInteractionShowed.bind(this)},isOpen:function(){return this._isOpen},pinTo:function(interaction){_.contains(this.pinnedInteractions,interaction)||this.pinnedInteractions.push(interaction),_.isEmpty(this.label)||interaction.$("a[href='#"+this.label+"']").on("click",this.onClick),interaction.bind("reset",this.onInteractionReset,this,{once:!0})},onClick:function(e){e.preventDefault(),$(e.currentTarget).addClass("visited"),e.stopPropagation(),this.open()},onInteractionShowed:function(interaction){this.pinned&&_.contains(this.pinnedInteractions,interaction)||this.close()},onInteractionReady:function(){a5.dp.config.responsiveAttachments&&this._setMediaResponsive()},onInteractionReset:function(interaction){this.close(),this.pinnedInteractions=_.without(this.pinnedInteractions,interaction),_.isEmpty(this.pinnedInteractions)&&(this.remove(),a5.callbacks.interaction.unbind("showed",this.onInteractionShowed))},getClass:function(){var classes=[this._getAttachmentClass(),this._getMediaClass(),"attachmentContent","attachmentContent--type"+_.str.capitalize(_.str.camelize(this.customType)),"attachmentContent--target"+_.str.capitalize(_.str.camelize(this.options.target)),"attachmentContent--"+(this.showInHeader?"showInHeader":"showAsModal")];return"dialog"===this.type&&classes.push(this._getDialogClass()),$.trim(classes.join(" "))},getType:function(){var type="dialog";return this.options.url?type="url":_.isUndefined(this.options.target)||"_blank"!==this.options.target?"platform"===this.options.target?type="platform":!1!==a5.dp.config.appendAttachmentTo&&(type="node"):type="window",type},render:function(){var $html=$("<div>").append(this.html);a5.service.Attachment.currentAttachment=this,this.interaction.buildModels(this.$,$html.contents()),delete a5.service.Attachment.currentAttachment,this.$.find(":first-child").attr("tabindex",0),this.$.addClass(this.getClass());var fn=this["_render"+_.str.capitalize(this.type)];_.isFunction(fn)&&fn.call(this),this.interaction.onInteractionReadyListeners.register(this.onInteractionReady),a5.callbacks.interaction.bind("showed",this.onInteractionShowed)},open:function(){var fn=this["_open"+_.str.capitalize(this.type)];_.isFunction(fn)&&fn.call(this),this.onAttachmentOpenListeners.callEach({})},close:function(){var fn=this["_close"+_.str.capitalize(this.type)];_.isFunction(fn)&&fn.call(this)},remove:function(){var fn=this["_remove"+_.str.capitalize(this.type)];_.isFunction(fn)&&fn.call(this)},_renderDialog:function(){var $dom=this.$,options={dialogClass:this.getClass(),title:this.label,autoOpen:!1,width:602,height:506,close:function(){a5.service.media.pause($dom),this._isOpen=!1,this.trigger("close")}.bind(this)},width=/.*width=(\d+).*/.exec(this.options.popup);width&&(options.width=parseInt(width[1],10));var height=/.*height=(\d+).*/.exec(this.options.popup);height&&(options.height=parseInt(height[1],10)),this.$.dialog(options),"Transcript"===this.label&&this.$.addClass("dialog_transcript"),this.$.dialog("widget").attr("id",this.id)},_renderNode:function(){var $appendTo=$(a5.dp.config.appendAttachmentTo);this.$.hide(),this.$.attr("id",this.id),$appendTo.append(this.$)},_openUrl:function(){a5.mainBuilder.engine.invoke("open-link",this.options.url,this.options.target)},_openWindow:function(){var url=A5.SKIN_URL+"popup.html",html=this.$.html(),label=this.label;window.a5_getPopupContent=function(win){var $body=$($(win.document).find("body")[0]);$body.html(html),$body.html($body.text()),$($(win.document).find("title")[0]).html(label)},a5.mainBuilder.engine.invoke("open-link",url,{target:"popupWin",settings:this.options.popup,focus:!0})},_openPlatform:function(){a5.mainBuilder.engine.invoke("open-attachment",this.$.html())},_openDialog:function(){a5.dp.config.multipleOpenAttachments||(this.interaction.attachments.closeAll(),_.each(this.pinnedInteractions,function(pinnedInteraction){pinnedInteraction.attachments.closeAll()})),this.$.dialog("open"),this.options.top&&this.options.left&&this.$.dialog("widget").css({top:this.options.top+"px",left:this.options.left+"px"}),this._isOpen=!0,this.trigger("open"),a5.mainBuilder.curInteraction.trigger("interaction:dialog:display")},_openNode:function(){a5.dp.config.multipleOpenAttachments||(this.interaction.attachments.closeAll(),_.each(this.pinnedInteractions,function(pinnedInteraction){pinnedInteraction.attachments.closeAll()})),this.$.show(),this._isOpen=!0,this.trigger("open")},_closeDialog:function(){this.$.dialog("close")},_closeNode:function(){a5.service.media.pause(this.$),this.$.hide(),this._isOpen=!1,this.trigger("close")},_removeDialog:function(){this.$.dialog("destroy"),this.$.remove()},_removeNode:function(){this.$.remove()},_isAudioOnly:function(){var $audio=this.$.find(".audio");return 1===$audio.length&&$audio.text().trim()===this.$.text().trim()},_isVideoOnly:function(){var $video=this.$.find(".video");return 1===$video.length&&$video.text().trim()===this.$.text().trim()},_getMediaClass:function(){var mediaClass="";return this._isAudioOnly()?mediaClass="attachment-audio-only":this._isVideoOnly()&&(mediaClass="attachment-video-only"),mediaClass},_getDialogClass:function(){return"attachment-popup"},_getAttachmentClass:function(){return this.options.klass||""},_setMediaResponsive:function(){this.$.find("img, .v_a_media, .the_video, [poster], .image-as-trigger").css("width","").css("height","")}},Obj.extend("a5.service.Attachment"),a5.service.media.by_id={},function(a5,_,$){function findAudiosAndCall(verb){return function($dom){$dom&&(_.each($dom.find("*[data-playable-media]"),function(node){a5.service.media.by_id[$(node).attr("data-playable-media")][verb]()}),_.each($dom.find("*[data-audio-uid]"),function(node){var playable=$(node).data("view-updater");playable&&playable.audio&&playable.audio[verb]()}))}}function findFirstAudio($dom){var $node=$dom.find("*[data-playable-media], *[data-audio-uid]");return a5.service.media.by_id[$node.attr("data-playable-media")]}a5.service.media.stop=findAudiosAndCall("stop"),a5.service.media.play=findAudiosAndCall("play"),a5.service.media.pause=findAudiosAndCall("pause"),a5.service.media.find=findFirstAudio}(a5,_,jQuery),a5.service.media.pauseAll=function(){a5.service.media.audio.pauseAll(),a5.service.media.tts_audio.pauseAll(),_.each(a5.speaking_recording.LNRInstances,function(lnr){lnr.stopAll()}),_.each(a5.speaking_recording.playAllInstances,function(playAll){playAll.stopAll()}),a5.service.media.video.pauseAll()},a5.service.media.pauseAllExcept=function(except){a5.service.media.audio.pauseAllExcept(except),a5.service.media.tts_audio.pauseAllExcept(except),_.each(a5.speaking_recording.LNRInstances,function(lnr){lnr.stopAllExcept(except)}),_.each(a5.speaking_recording.playAllInstances,function(playAll){playAll.stopAllExcept(except)}),a5.service.media.video.pauseAllExcept(except)},a5.service.media.supportsGetUserMedia=function(){return"https:"===window.location.protocol&&!!navigator.mediaDevices&&!!navigator.mediaDevices.getUserMedia},a5.service.media.audio_manager={VOLUME_MAX:1,VOLUME_MIN:0,VOLUME_STEP:.1,SEEK_STEP:5},a5.service.media.audio_manager.Creator={init:function(initParams){if(this.__ready=!1,this._readyDfd=$.Deferred(),this.buildUrl=initParams.urlBuilder||function(x){return x},this.preferOga=initParams.preferOga,this.formats=initParams.formats,$.browser.msie){var _buildUrl=this.buildUrl;this.buildUrl=function(a,b){return _buildUrl.apply(this,arguments)+"?ts="+Number(new Date)}}this._ready()},ready:function(){return this._readyDfd.promise()},_ready:function(){this.__ready=!0,this._readyDfd.resolve(),this.trigger("ready")},create:function(id,params){return params=_.extend({preferOga:this.preferOga,formats:this.formats,preferHtml5:!0,persistVolume:!1},params),params.nativeAudio?new a5.service.media.audio_manager.NativeAudio(id,this,params):new a5.service.media.audio_manager.Audio(id,this,params)},bind:function(name,callback,context,options){_.each(name.split(" "),function(event){"ready"==event&&this.__ready&&callback.apply(context)},this),this._super(name,callback,context,options)},pauseAll:function(){this.trigger("dopause")},pauseAllExcept:function(except){this.trigger("dopause",except)},stopAll:function(){this.trigger("dostop")},stopAllPlaying:function(){this.trigger("dostopplaying")}},Obj.extend("a5.service.media.audio_manager.Creator"),a5.service.media.audio_manager.Audio={init:function(id,creator,params){this.uid="ID_"+id+"_"+Math.floor(1e5*Math.random()),this.creator=creator,params=params||{},params.dontStop&&(this.dontStop=!0),params.type&&(this.type=params.type),this.persistVolume=params.persistVolume;var urls;if(params.url)urls="string"!=typeof params.url?params.url:[params.url];else{urls=[];var formats=params.formats;params.preferOga&&formats.indexOf("oga")>0&&a5.utils.array.move(formats,formats.indexOf("oga"),0),_.each(formats,function(format){params.buildUrl?urls.push(params.buildUrl(id,format)):urls.push(this.creator.buildUrl(id,format))},this)}urls=_(urls).map(function(url){return url.replace(/\.s3-website-[^.]*./i,".s3.")});var soundOptions={src:urls,html5:!!params.preferHtml5,onpause:_.bind(this._paused,this),onplay:_.bind(this._start,this),onplayerror:_.bind(this._onPlayError,this),onload:_.bind(this._loaded,this),onloaderror:_.bind(this._onLoadError,this),onstop:_.bind(this._stopped,this),onend:_.bind(this._ended,this),volume:this._initVolume(),preload:params.preload,format:this.type};this.audioObject=new Howl(soundOptions),this.isLoaded=!(!1===params.preload),this.dontStop||(creator.bind("dopause",_.bind(this.doPause,this)),creator.bind("dostop",_.bind(this.doStop,this)),creator.bind("dostopplaying",_.bind(this.doStopPlaying,this))),a5.service.media.by_id[this.uid]=this},doPause:function(except){except!==this&&this.isLoaded&&this.pause()},doStop:function(){this.isLoaded&&this.stop()},doStopPlaying:function(){this.isLoaded&&this.isPlaying()&&this.stop()},_start:function(){this.isStopped=!1,this.isPaused=!1,this._error=!1,this.trigger("start"),requestAnimationFrame(this._progress.bind(this))},_stopped:function(){this.isStopped||(this.isStopped=!0,this.trigger("stopped")),this.trigger("seeked",0)},_ended:function(){this.isStopped||(this.isStopped=!0,this.trigger("stopped")),this.trigger("seeked",0)},_loaded:function(){this.isLoaded=!0,this.trigger("loadprogress")},_onLoadError:function(){this.audioObject.stop(),this._error=!0,this.trigger("error")},_onPlayError:function(){this.audioObject.stop(),this._error=!0,this.trigger("error")},_progress:function(){if(!this.isStopped){var playLock=this.audioObject._playLock;this.audioObject._playLock=!1;var seek=1e3*this.audioObject.seek()||0;this.audioObject._playLock=playLock,this.trigger("progress",Math.round(seek)),this.isPlaying()&&this.trigger("playing"),this.isPaused||requestAnimationFrame(this._progress.bind(this))}},_paused:function(){this.isPaused=!0,this.trigger("paused")},_initVolume:function(){var volume=a5.service.media.audio_manager.VOLUME_MAX;if(this.persistVolume)try{localStorage&&localStorage.volume&&parseFloat(localStorage.volume)<a5.service.media.audio_manager.VOLUME_MAX&&(volume=parseFloat(localStorage.volume))}catch(e){logger.warn(e)}return volume},load:function(){this.isLoaded||(this.audioObject.load(),this.isLoaded=!0)},play:function(){this.audioObject.play()},rate:function(rate){this.audioObject.rate(rate)},pause:function(){this.audioObject.pause()},position:function(milliseconds){if(_.isUndefined(milliseconds)){var playLock=this.audioObject._playLock;this.audioObject._playLock=!1;var seek=1e3*this.audioObject.seek();return this.audioObject._playLock=playLock,seek}return this.duration()>milliseconds&&(this.audioObject.seek(milliseconds/1e3),this.trigger("seeked",Math.max(milliseconds,0)),!0)},stepForward:function(){this.position(Math.min(this.position()+Math.round(a5.service.media.audio_manager.SEEK_STEP*this.duration()/100),this.duration()))},stepBack:function(){this.position(Math.max(this.position()-Math.round(a5.service.media.audio_manager.SEEK_STEP*this.duration()/100),0))},stop:function(){this.audioObject.stop()},mute:function(){this.audioObject.mute(!0),this.trigger("volume",a5.service.media.audio_manager.VOLUME_MIN)},unmute:function(){this.audioObject.mute(!1),this.trigger("volume",this.audioObject.volume())},isMuted:function(){return"loaded"===this.audioObject.state()&&this.audioObject.mute()},volume:function(value){if(!_.isUndefined(value)){if(this.audioObject.volume(value),this.persistVolume)try{localStorage.setItem("volume",value)}catch(e){logger.warn(e)}this.trigger("volume",this.audioObject.volume())}return this.audioObject.volume()},volumeAsPercentage:function(){return Math.round(100*this.volume()/(a5.service.media.audio_manager.VOLUME_MAX-a5.service.media.audio_manager.VOLUME_MIN))},volumeMin:function(){return a5.service.media.audio_manager.VOLUME_MIN},volumeMax:function(){return a5.service.media.audio_manager.VOLUME_MAX},volumeUp:function(){this.volume(Math.min(this.volume()+a5.service.media.audio_manager.VOLUME_STEP,a5.service.media.audio_manager.VOLUME_MAX))},volumeDown:function(){this.volume(Math.max(this.volume()-a5.service.media.audio_manager.VOLUME_STEP,a5.service.media.audio_manager.VOLUME_MIN))},duration:function(){var duration;return this.audioObject._sounds.length&&(duration=this.audioObject._sounds[0]._node.duration),1e3*(duration||this.audioObject.duration())},append:function($html){},isPlaying:function(){return this.audioObject.playing()},isPaused:function(){return!this.audioObject.playing()&&this.audioObject.seek()>0},hasError:function(){return this._error}},Obj.extend("a5.service.media.audio_manager.Audio"),a5.service.media.audio_manager.NativeAudio={init:function(id,creator,params){this.uid="ID_"+id+"_"+Math.floor(1e5*Math.random()),this.creator=creator,params=params||{},params.dontStop&&(this.dontStop=!0),params.type&&(this.type=params.type);var urls;if(params.url)urls="string"!=typeof params.url?params.url:[params.url];else{urls=[];var formats=params.formats;params.preferOga&&formats.indexOf("oga")>0&&a5.utils.array.move(formats,formats.indexOf("oga"),0),_.each(formats,function(format){params.buildUrl?urls.push(params.buildUrl(id,format)):urls.push(this.creator.buildUrl(id,format))},this)}urls=_(urls).map(function(url){return url.replace(/\.s3-website-[^.]*./i,".s3.")}),this.audioObject=$("<audio controls>"),_.each(urls,function(url){this.audioObject.append("<source src='"+url+"'></source>")},this),this.audioObject.on("play",_.bind(function(){this.trigger("start")},this)),this.audioObject.on("pause",_.bind(function(){this.trigger("stopped")},this)),this.dontStop||(creator.bind("dopause",_.bind(this.doPause,this)),creator.bind("dostop",_.bind(this.doStop,this)),creator.bind("dostopplaying",_.bind(this.doStopPlaying,this))),a5.service.media.by_id[this.uid]=this},pause:function(){this.audioObject.get(0).pause()},doPause:function(except){except!==this&&this.audioObject.get(0).pause()},doStop:function(){this.audioObject.get(0).pause(),this.audioObject.get(0).currentTime=0},isPlaying:function(){return!this.audioObject.get(0).paused},doStopPlaying:function(){this.isLoaded&&this.isPlaying()&&this.doStop()},load:function(){this.audioObject.get(0).load()},play:function(){this.audioObject.get(0).play()}},Obj.extend("a5.service.media.audio_manager.NativeAudio"),a5.service.media.tts_audio_manager={},a5.service.media.tts_audio_manager.Creator={init:function(options){this.buildURL=options.urlBuilder},trim:function(text){return text=$("<span>"+text+"</span>").text().replace(/[\n\s]+/gm," "),text=text.replace(/^[\W]+$/g," "),text.trim()},create:function(text){return""!=(text=this.trim(text))&&(text=this.runTTSMapping(text),logger.info("TTS Create audio:",text),this.url=this.buildURL(text),new a5.service.media.tts_audio_manager.Audio(this.url,this))},runTTSMapping:function(text){var map=this.getTTSMap(),result=text;return _.each(map,function(rule){var type=rule[0],search=rule[1],replacement=rule[2];try{"regex"==type&&(result=result.replace(new RegExp(search,"g"),replacement)),"word"==type&&(result=result.replace(new RegExp("\\b"+search+"\\b","g"),replacement)),"string"==type&&(result=result.replace(new RegExp(search,"g"),replacement))}catch(e){logger.info("Skipped invalid tts rule: "+rule.join("**"))}},this),result},getTTSMap:function(){var options=["455","456","457"],list=[];return _.each(options,function(option){var rules=null;if(rules=a5.mainBuilder.curInteraction.options.getValue(option),"on"==a5.mainBuilder.curInteraction.options.get(option))try{rules&&rules.trim()&&(rules=a5.utils.b64DecodeUnicode(rules).split("\n")),list.push(_.filter(_.map(rules,this.__parseTTSValue)))}catch(e){logger.warn("Error parsing TTS Map from Option: "+option)}},this),list.length&&(list=_.flatten(list,!0),list.reverse(),list=_.uniq(list,function(rule){return rule[1]}),list.reverse()),list},__parseTTSValue:function(ttsRule){var match=ttsRule.match(/(regex|word|string)\*\*(.+)\*\*(.+)/);if(match)return[match[1],match[2],match[3]]},pauseAll:function(){this.trigger("pause")},pauseAllExcept:function(except){this.trigger("pause",except)},stopAll:function(){this.trigger("stop")},stopAllExcept:function(except){this.trigger("stop",except)}},Obj.extend("a5.service.media.tts_audio_manager.Creator"),a5.service.media.tts_audio_manager.Audio={init:function(url,creator){this.url=url,this.creator=creator},_create_element:function(){this.audio_node=document.createElement("audio"),this.audio_node.preload=!1,this.audio_node.src=this.url,this._bind_events()},_bind_events:function(){$(this.audio_node).on("ended",_.bind(function(){this.trigger("playback-end")},this)),$(this.audio_node).on("play",_.bind(function(){this.trigger("playback-start")},this)),$(this.audio_node).on("pause",_.bind(function(){this.trigger("playback-pause")},this)),this.creator.bind("pause",_.bind(function(except){except!==this&&(this.pause(),this.trigger("playback-end"))},this)),this.creator.bind("stop",_.bind(function(except){except!==this&&(this.stop(),this.trigger("playback-end"))},this))},play:function(){_.isUndefined(this.audio_node)&&this._create_element(),this.creator.stopAllExcept(this),this.audio_node.play()},pause:function(){this.audio_node.pause()},stop:function(){this.audio_node.pause(),_.isNaN(this.audio_node.duration)||(this.audio_node.currentTime=0)},position:function(){this.audio_node.played.end()},volume:function(value){this.audio_node.volume=value},duration:function(){return this.audio_node.seekable.end()},append:function($html){}},Obj.extend("a5.service.media.tts_audio_manager.Audio"),a5.service.media.video_manager={VOLUME_MAX:1,VOLUME_MIN:0,VOLUME_STEP:.1,SEEK_STEP:5},a5.service.media.video_manager.Creator={init:function(initParams){this.buildUrl=initParams.urlBuilder||function(x){return x},videojs.options.hls.overrideNative=!0,this.preferWebm=initParams.preferWebm,this.formats=initParams.formats},create:function(id,$target,params){return new a5.service.media.video_manager.Video(id,$target,this,params)},bind:function(name,callback,context,options){_.each(name.split(" "),function(event){"ready"==event&&callback.apply(context)},this),this._super(name,callback,context,options)},pauseAll:function(){this.trigger("dopause")},pauseAllExcept:function(except){this.trigger("dopause",except)}},Obj.extend("a5.service.media.video_manager.Creator"),a5.service.media.video_manager.Video={init:function(id,$target,creator,params){if(this.id=id,this.tagId="element_"+id+"_"+Math.round(999999*Math.random()),this.creator=creator,this.$target=$target,this._onKeyupInFullscreen=this._onKeyupInFullscreen.bind(this),params&&params.url)this.$video=$('<video id="'+this.tagId+'" class="video-js vjs-default-skin" playsinline><source src="'+params.url+'" /></video>');else{var formats=this.creator.formats;/http(s)*:/.test(window.location.protocol)||(formats=_.without(formats,"hls")),this.creator.preferWebm&&formats.indexOf("webm")>0&&a5.utils.array.move(formats,formats.indexOf("webm"),0);var sources=_.map(formats,function(format){return _.str.sprintf('<source src="%s" type="%s" />',this.creator.buildUrl(this.id,format),"hls"===format?"application/x-mpegURL":"video/"+format)},this);sources=_(sources).map(function(source){return source.replace(/\.s3-website-[^.]*./i,".s3.")}),this.$video=$('<video id="'+this.tagId+'" class="video-js vjs-default-skin" playsinline>'+sources.join("")+"</video>")}params&&params.poster&&this.$video.attr("poster",A5.ASSET_URL_BUILDER(params.poster)),this.$target.append(this.$video),this.video=videojs(this.$video.get(0),{controls:!1,preload:$("body").is(".isChrome")?"metadata":"auto",html5:{el:this.$video.get(0)}},_.bind(function(){_.defer(_.bind(function(){this.trigger("ready")},this))},this)),this.video.on("error",_.bind(this._onError,this)),this.video.on("play",_.bind(this._start,this)),this.video.on("pause",_.bind(this._paused,this)),this.video.on("ended",_.bind(this._ended,this)),this.video.on("durationchange",_.bind(this._durationchange,this)),this.video.on("canplaythrough",_.bind(this._canplaythrough,this)),this.video.on("canplay",_.bind(this._canplay,this)),this._bindStartingTime(),this.video.on("progress",_.bind(this._loadprogress,this)),this.video.on("volumechange",_.bind(this._volume,this)),this.video.on("fullscreenchange",_.bind(this._fullscreen,this));var lastMoveX,lastMoveY;this.video.on("mousemove",function(e){e.clientX===lastMoveX&&e.clientY===lastMoveY||(lastMoveX=e.clientX,lastMoveY=e.clientY,this.video.reportUserActivity())}.bind(this)),params&&params.dontStop?this.dontStop=!0:creator.bind("dopause",_.bind(this.doPause,this)),a5.service.media.by_id[this.tagId]=this,this.$target.attr("data-playable-media",this.tagId)},doPause:function(except){except!==this&&this.pause()},_onError:function(event){var player=event.target.player;this.sourceIndex=this.sourceIndex||0;var source=player.currentSources()[++this.sourceIndex];source&&player.src(source)},_bindStartingTime:function(){var ua=a5.utils.parseUserAgent();(ua.isIOS||ua.isIpadOS||ua.isSafari)&&this.bind("canplay",this._cansetstartingtime,this),this.bind("durationchange",this._cansetstartingtime,this)},_onKeydownInFullscreen:function(e){27===e.keyCode&&e.stopPropagation()},_onKeyupInFullscreen:function(e){27===e.keyCode&&(e.stopPropagation(),this.cancelFullscreen())},_fullscreen:function(event){var isFullscreen=screenfull.isFullscreen;isFullscreen?(document.addEventListener("keydown",this._onKeydownInFullscreen,!0),document.addEventListener("keyup",this._onKeyupInFullscreen,!0)):(document.removeEventListener("keydown",this._onKeydownInFullscreen,!0),document.removeEventListener("keyup",this._onKeyupInFullscreen,!0)),this.trigger("fullscreenchange",isFullscreen)},_volume:function(){this.isMuted()?this.trigger("volume",a5.service.media.video_manager.VOLUME_MIN):this.trigger("volume",this.video.volume())},_start:function(){this.trigger("start"),requestAnimationFrame(this._progress.bind(this))},_ended:function(){this.stop(),logger.log("video ended")},_loadprogress:function(){this.trigger("loadprogress")},_progress:function(){if(this.isPlaying()){var seek=1e3*this.video.currentTime()||0;this.trigger("progress",Math.round(seek)),this.trigger("playing"),requestAnimationFrame(this._progress.bind(this))}},_paused:function(){this.trigger("paused")},_durationchange:function(){this.trigger("durationchange")},_canplaythrough:function(){this.trigger("canplaythrough")},_canplay:function(){this.trigger("canplay")},_cansetstartingtime:function(){this.trigger("cansetstartingtime")},load:function(){this.video.load()},play:function(){this.video.play()},pause:function(){this.video.isReady_&&this.video.pause()},position:function(milliseconds){return _.isUndefined(milliseconds)?1e3*this.video.currentTime():this.duration()>milliseconds?(this.video.currentTime(milliseconds/1e3),this.trigger("seeked",Math.max(milliseconds,0)),!0):void 0},stepForward:function(){this.position(Math.min(this.position()+Math.round(a5.service.media.video_manager.SEEK_STEP*this.duration()/100),this.duration()))},stepBack:function(){this.position(Math.max(this.position()-Math.round(a5.service.media.video_manager.SEEK_STEP*this.duration()/100),0))},stop:function(){this.position(0),this.pause()},mute:function(){this.video.muted(!0)},unmute:function(){this.video.muted(!1)},isMuted:function(){return this.video.muted()},volume:function(value){return this.video.volume(value)},volumeAsPercentage:function(){return Math.round(100*this.volume()/(a5.service.media.video_manager.VOLUME_MAX-a5.service.media.video_manager.VOLUME_MIN))},volumeMin:function(){return a5.service.media.video_manager.VOLUME_MIN},volumeMax:function(){return a5.service.media.video_manager.VOLUME_MAX},volumeUp:function(){this.volume(Math.min(this.volume()+a5.service.media.video_manager.VOLUME_STEP,a5.service.media.video_manager.VOLUME_MAX))},volumeDown:function(){this.volume(Math.max(this.volume()-a5.service.media.video_manager.VOLUME_STEP,a5.service.media.video_manager.VOLUME_MIN))},duration:function(){return 1e3*this.video.duration()},fullscreen:function(){this.video.requestFullscreen()},
cancelFullscreen:function(){this.video.exitFullscreen()},append:function($html){$(this.video.el()).append($html)},isFullscreen:function(){return this.video.isFullscreen()},isPlaying:function(){return!this.video.paused()},adjustSize:function(){this.video.dimensions(this.$target.width(),this.$target.height())}},Obj.extend("a5.service.media.video_manager.Video"),a5.service.media.recorder_manager={},a5.service.media.recorder_manager.AudioRecorder={init:function(engine){this.engine=engine},instance:function(){return this.recorder},ready:function(){return this._ready||(this._ready=$.Deferred(),this._initAudioRecorder()),this._ready.promise()},_initAudioRecorder:function(){var externalRecorder=this.engine.invoke("init-external-recorder");externalRecorder?this.recorder=new ExternalAudioRecorder({API:externalRecorder}):a5.service.media.supportsGetUserMedia()?this.recorder=new HTML5AudioRecorder:this.recorder=new DummyAudioRecorder,this._ready.resolve()}},Obj.extend("a5.service.media.recorder_manager.AudioRecorder"),Obj.extend("ExternalAudioRecorder",{errorTemplate:"a5.view.dialog.RecordingError",init:function(parameters){parameters=parameters||{},this.API=parameters.API},record:function(id){return this.currentRecording=new a5.service.recorder.ExternalRecording(this,id),this.currentRecording.bind("error",function(){this.showError()},this),this.currentRecording},createSource:function(url){return this.createLocalSource(url)},createLocalSource:function(url){var audio=a5.service.media.audio.create(a5.utils.createUID(),{url:url});return audio.bind("error",function(){this.showError()},this),audio},showError:function(){this.warningDisplayed||(a5.view.dialog.display(this.errorTemplate,{dialogClass:"recording-error"},{close:function(){this.warningDisplayed=!1}.bind(this)}),this.warningDisplayed=!0)},checkSupport:function(){},checkMic:function(){return!0}}),Obj.extend("a5.service.recorder.ExternalRecording",{init:function(recorder,id){this.id=id,this.recorder=recorder,this.filename=null,this.beep=new Howl({src:A5.ENGINE_ROOT+"audios/beep.wav",html5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())})},start:function(){this.recorder.API.start(this.id,function(err){if(err)return void this.error();this.connected(),this.beep.on("end",_.bind(function(){setTimeout(_.bind(function(){this.recorder.API.record(this.id,function(err){if(err)return void this.error()}.bind(this)),this.recording=!0},this),200)},this)),this.beep.play()}.bind(this))},stop:function(){this.recorder.API.stop(this.id,function(err,url){if(err)return void this.error();this.filename=url,this.recordingDone(),this.recording=!1}.bind(this))},connected:function(){this.trigger("start")},recordingDone:function(){this.trigger("recorded")},error:function(){this.trigger("error")}}),Obj.extend("HTML5AudioRecorder",{micTemplate:"a5.view.dialog.MicNotFound",errorTemplate:"a5.view.dialog.RecordingError",init:function(){this.audios={};try{window.AudioContext=window.AudioContext||window.webkitAudioContext,window.URL=window.URL||window.webkitURL,logger.log("navigator.mediaDevices.getUserMedia "+(navigator.mediaDevices.getUserMedia?"available.":"not present!"))}catch(e){logger.warn("No web audio support in this browser!")}},record:function(){return this.currentRecording=new a5.service.recorder.HTML5Recording(this),this.currentRecording.bind("error",function(){this.showError()},this),this.currentRecording},upload:function(filename){var data=new FormData;data.append("recording",this.audios[filename]);var deferred=$.Deferred();return this.audios[filename]?$.ajax({type:"POST",data:data,contentType:!1,processData:!1,url:A5.TOOLBELT_URL+"/audio-manipulator/upload",success:_.bind(function(data){this.audios[filename]=null,deferred.resolve(data.filename)},this),error:_.bind(function(xhr,ajaxOptions,thrownError){this.showError(),deferred.reject()},this)}):(this.showError(),deferred.reject()),deferred.promise()},createLocalSource:function(filename){var audio=a5.service.media.audio.create(filename,{type:"wav",buildUrl:this.buildLocalUrlForSource.bind(this),preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())});return audio.bind("error",function(){this.showError()},this),audio},createSource:function(filename){var audio=a5.service.media.audio.create("r5_"+filename,{buildUrl:this.buildUrlForSource,preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())});return audio.bind("error",function(){this.showError()},this),audio},buildUrlForSource:function(id){return a5.service.media.audio.buildUrl(id,"mp3")},buildUrl:function(filename){return a5.service.media.audio.buildUrl("r5_"+filename,"mp3")},buildLocalUrlForSource:function(filename){var blob=this.audios[filename];return URL.createObjectURL(blob)},showWarning:function(){this.warningDisplayed||(a5.view.dialog.display(this.micTemplate,{dialogClass:"mic-notfound"},{close:function(){this.warningDisplayed=!1}.bind(this)}),this.warningDisplayed=!0)},showError:function(){this.warningDisplayed||(a5.view.dialog.display(this.errorTemplate,{dialogClass:"recording-error"},{close:function(){this.warningDisplayed=!1}.bind(this)}),this.warningDisplayed=!0)},checkSupport:function(){},checkMic:function(){return navigator.mediaDevices.getUserMedia({audio:!0}).then(function(stream){logger.log("Mic present.")}).catch(function(err){logger.warn("No live audio input: "+err),this.showWarning()}.bind(this))}}),Obj.extend("a5.service.recorder.HTML5Recording",{init:function(parent){this.parent=parent,this.filename=null,this.audioContext=new AudioContext,logger.log("Audio context set up.");var config={bufferLen:4096,numChannels:2,mimeType:"audio/wav",context:this.audioContext};config.processor=(this.audioContext.createScriptProcessor||this.audioContext.createJavaScriptNode).call(this.audioContext,config.bufferLen,config.numChannels,config.numChannels),this.recorder=new Recorder(config),logger.log("Recorder initialised."),this.beep=new Howl({src:A5.ENGINE_ROOT+"audios/beep.wav",html5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())})},gotMicStream:function(stream){this.audioContext.createMediaStreamSource(stream).connect(this.recorder.node),logger.log("Media stream created.")},requestMic:function(){return navigator.mediaDevices.getUserMedia({audio:!0}).then(function(stream){this.gotMicStream(stream)}.bind(this))},encode:function(callback){this.recorder.exportWAV(callback)},start:function(){this.filename=a5.utils.createUID(),this.requestMic().then(function(){this.trigger("start"),this.record()}.bind(this)).catch(function(err){logger.warn("No live audio input: "+err),this.parent.showWarning(),this.trigger("mic_notallowed")}.bind(this))},record:function(){this.beep.on("end",_.bind(function(){setTimeout(_.bind(function(){this.recorder.record(),this.recording=!0},this),200)},this)),this.beep.play()},stop:function(){this.recorder.stop(),this.recording?this.encode(function(blob){this.parent.audios[this.filename]=blob,this.end()}.bind(this)):this.end(),this.recording=!1},end:function(){this.recorder.clear(),"closed"!==this.audioContext.state?this.audioContext.close().then(function(){logger.log("Audio context closed"),this.trigger("recorded")}.bind(this)):this.trigger("recorded")},error:function(){this.trigger("error")}}),Obj.extend("DummyAudioRecorder",{unsupportedTemplate:"a5.view.dialog.UnsupportedDevice",showWarning:function(){this.warningDisplayed||(a5.view.dialog.display(this.unsupportedTemplate,{dialogClass:"unsupported-device-warning"},{close:function(){this.warningDisplayed=!1}.bind(this)}),this.warningDisplayed=!0)},checkSupport:function(){this.showWarning()},checkMic:function(){this.showWarning()},record:function(){this.showWarning()}}),a5.service.media.SpeechToText={init:function(){_.bindAll(this,"_request")},convert:function(inputs,clips){return this._request(inputs,clips)},_request:function(inputs,clips){return $.when(a5.mainBuilder.engine.invoke("get-toolbelt-token")).then(function(token){var data={input:inputs.map(function(input){return a5.utils.startsWith(input,"//")?"http:"+input:input}),clips:clips,language:$(document.documentElement).attr("lang")},ajaxCfg={type:"POST",data:JSON.stringify(data),url:A5.TOOLBELT_URL+"/audio-manipulator/speech-to-text",contentType:"application/json"};return token&&(ajaxCfg.headers={Authorization:["Bearer",token].join(" ")}),$.ajax(ajaxCfg)})}},Obj.extend("a5.service.media.SpeechToText"),function(a5,Obj,$){a5.service.scroll.API={init:function(){this.findAPI()},findAPI:function(){try{var current=window;do{if(current=current.parent,"object"==typeof current.scrollAPI){this.API=current.scrollAPI;break}}while(current.parent!==window.top)}catch(e){}},hasAPI:function(){return!!this.API},getVisibleTop:function(){return this.API.getVisibleTop()},getVisibleLeft:function(){return this.API.getVisibleLeft()},getVisibleBottom:function(){return this.API.getVisibleBottom()},getVisibleRight:function(){return this.API.getVisibleRight()},scrollTopBy:function(top){this.API.scrollTopBy(top)},scrollLeftBy:function(left){this.API.scrollLeftBy(left)}},Obj.extend("a5.service.scroll.API"),a5.service.scroll.APIClient=new a5.service.scroll.API,$.ui.plugin.add("draggable","scroll",{drag:function(event){if(a5.service.scroll.APIClient.hasAPI()){var i=$(this).data("ui-draggable"),o=i.options;if(i.scrollParent[0]!==document&&i.scrollParent[0]!==document.body&&"HTML"!==i.scrollParent[0].tagName)return;o.axis&&"x"===o.axis||(event.pageY-a5.service.scroll.APIClient.getVisibleTop()<o.scrollSensitivity?a5.service.scroll.APIClient.scrollTopBy(-o.scrollSpeed):a5.service.scroll.APIClient.getVisibleBottom()-event.pageY<o.scrollSensitivity&&a5.service.scroll.APIClient.scrollTopBy(o.scrollSpeed)),o.axis&&"y"===o.axis||(event.pageX-a5.service.scroll.APIClient.getVisibleLeft()<o.scrollSensitivity?a5.service.scroll.APIClient.scrollLeftBy(-o.scrollSpeed):a5.service.scroll.APIClient.getVisibleRight()-event.pageX<o.scrollSensitivity&&a5.service.scroll.APIClient.scrollLeftBy(o.scrollSpeed))}}})}(a5,Obj,jQuery),a5.model_builder.Syllabify={isResponsible:function(node,interaction){return node.is("textEntryInteraction")&&"Identify:Mark:Syllabify"==interaction.identifier},buildTextEntryInteraction:function(interaction,parentNode,node){var response=node.attr("responseIdentifier"),syllables=interaction.getAllResponseDeclaration();syllables&&syllables[response]&&(syllables=syllables[response]);var model=new a5.models.interaction.SyllabifyWord({correctResponse:syllables,tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainLock:interaction.options.tryAgainIsLock(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),tts_audio:interaction.options.gaptextaudioIsTrue()});model.assignAnswerFeedback(node),interaction.blockItems.add(model);var view=new a5.view.interaction.Syllabify(model);$(parentNode).append(view.render())}},a5.model_builder.Base.extend("a5.model_builder.Syllabify"),a5.model_builder.builders.push(new a5.model_builder.Syllabify),a5.model_builder.PEScorableBuilder={isResponsible:function(node,interaction){return"Present:External:Scorable"===interaction.identifier&&node.is("object")&&"third_party"===node.attr("type")},buildObject:function(interaction,parentNode,node){var scope=node.attr("uid"),item=new a5.models.interaction.PEScorableItem(interaction,{tryAgain:{keepAll:interaction.options.tryAgainIsKeepall(),frozen:interaction.options.tryAgainIsFrozen(),lock:interaction.options.tryAgainIsLock()},prefill:!interaction.options.prefillIsFalse()},scope,this._buildUrl(node));interaction.blockItems.add(item);var view=new a5.views.interaction.PEScorable(item);parentNode.append(view.render())},_buildUrl:function(node){var url=A5.ASSET_URL_BUILDER(node.attr("src"));return url+="/index.html",url+="?scope="+node.attr("uid")}},a5.model_builder.Base.extend("a5.model_builder.PEScorableBuilder"),a5.model_builder.builders.push(new a5.model_builder.PEScorableBuilder),a5.model_builder.DragDropUtils={isResponsible:function(node,interaction){var isObj=node.is("object[type*=audio]"),omGapText="Order:Match:Text gap"==interaction.identifier&&node.parent().is("gapText"),omPairs="Order:Match:Pairs"==interaction.identifier&&node.parent().is("simpleAssociableChoice"),osSorting="Order:Sort:Sorting"==interaction.identifier&&node.parent().is("simpleAssociableChoice"),osSequence="Order:Sequence:Sequence"==interaction.identifier&&node.parent().is("simpleChoice"),omTextGapLAO="Order:Match:Text gap (Label an object)"==interaction.identifier&&node.parent().is("gapText");return isObj&&(omGapText||omPairs||osSorting||osSequence||omTextGapLAO)},buildObject:function(interaction,parentNode,node){var ID=node.attr("data"),UID=ID+"_"+a5.utils.createUID(),playButton=$('<div class="drag_audio_player inactive" data-audio-uid="'+UID+'"></div>');parentNode.addClass("has_audio_attached"),parentNode.append(playButton);var gapfillBehavior=this.getGapfillBehavior(interaction);a5.service.media.audio.bind("ready",function(){var viewUpdater=new a5.model_builder.dragDropUtils.ViewUpdater(ID,UID,interaction.options.audioiconbehaviourIsPause(),gapfillBehavior,interaction);playButton.data("view-updater",viewUpdater),playButton.attr("data-has-view-updater","true"),_.defer(_.bind(viewUpdater.ready,viewUpdater))},this)},getGapfillBehavior:function(interaction){var behavior=interaction.options.getGapfillbehaviour();return"tap_item"===behavior?behavior="drag":"tap_target"===behavior&&"mobile"===a5.dp.config.gapfillBehaviourApplicable&&a5.utils.isDocumentOverMobileBreakpoint()&&(behavior="drag"),behavior.split("_")[0]}},a5.model_builder.Base.extend("a5.model_builder.DragDropUtils"),a5.model_builder.builders.push(new a5.model_builder.DragDropUtils),Obj.extend("a5.model_builder.dragDropUtils.ViewUpdater",{init:function(ID,UID,hasPauseBehaviour,gapfillBehavior,interaction){this.UID=UID,this.hasPauseBehaviour=hasPauseBehaviour,this.interactionBehavior=gapfillBehavior,this.status="loading",this.audio=a5.service.media.audio.create(ID,{preload:!a5.dp.config.audioPreloadDisabled}),a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(this.audio),this.audio.bind("stopped",function(){this.stop()},this),this.audio.bind("paused",function(){hasPauseBehaviour||this.audio.stop()},this)},update:function(){var players=$("[data-audio-uid='"+this.UID+"']");players.off("click"),players.removeClass("playing inactive"),players.toggleClass("show-pause-on-playing",this.hasPauseBehaviour),"ready"===this.status?players.on("click",_.bind(this.play,this)):"playing"===this.status?players.on("click",_.bind(this.pause,this)):players.on("click",_.bind(function(e){this.stopPropagation(e)},this)),"playing"===this.status?players.addClass("playing"):"loading"===this.status&&players.addClass("inactive")},ready:function(){this.status="ready",this.update()},play:function(evt){$(evt.target).is(".no-play")?$(evt.target).removeClass("no-play"):($(".playbutton").removeClass("playing"),$(".drag_audio_player").removeClass("playing"),a5.service.media.pauseAllExcept(this.audio),this.audio.play(),this.status="playing",this.update()),this.stopPropagation(evt)},pause:function(evt){this.audio.pause(),this.status="ready",this.update(),this.stopPropagation(evt)},stop:function(){this.status="ready",this.update()},stopPropagation:function(evt){"drag"===this.interactionBehavior&&(evt.preventDefault(),evt.stopPropagation())}}),a5.model_builder.OMTextGapBuilder={isResponsible:function(node,interaction){return"Order:Match:Text gap"==interaction.identifier&&"Trainer"!==LOInfo.mode&&"Exam"!==LOInfo.mode&&(node.is("gapMatchInteraction")||node.is("#contentblock")||node.is("gap")&&this.isBuildingGapMatchInteraction||node[0].nodeType==Node.TEXT_NODE||node[0].tagName&&("br"==node[0].tagName.toLowerCase()||"p"==node[0].tagName.toLowerCase()))},buildGapMatchInteraction:function(interaction,parentNode,node){if(this.isBuildingGapMatchInteraction)throw"cannot nest gapMatchInteractions";this.isBuildingGapMatchInteraction=!0,this.contentblockCount=0,this.gapCount=0;var choiceNodes=this.fetchChoices(interaction,node,"> gapText, > gapImg"),gapsToGroup={};_(choiceNodes).each(function(choiceNode){var $choiceNode=$(choiceNode),text=$choiceNode.text(),choiceId=$choiceNode.attr("id"),group=$choiceNode.attr("group")||!1;gapsToGroup[choiceId]=group,!group&&_.str.contains(text,"##")&&(group=text.split("##").pop(),gapsToGroup[choiceId]=group,_(choiceNodes).each(function(choice){$(choice).attr("id")===choiceId&&$(choice).attr("group",group)}),$choiceNode.text(function(){return $(this).text().replace("##"+group,"")}))}),this.choices=_(choiceNodes).map(function(choiceNode){var $choiceNode=$(choiceNode),text=$choiceNode.text();return text=_.first(text.split("##")),text=text||$choiceNode.find("img[data-mathml]").data("mathml")||$choiceNode.find("img[src]").attr("src")||$choiceNode.find('object[type="audio/audio"]').attr("data"),[$choiceNode.attr("identifier"),text]});var gapMatchInteractionModel=new a5.models.interaction.GapMatchInteraction({parent:interaction,responses:interaction.getCorrectResponse(node.attr("responseIdentifier")),answers:this.choices,stacks:parseInt(interaction.options.getPoolStacks(),10),poolAlphabeticalOrder:interaction.options.poolorderIsAlphabetical(),poolAlignment:interaction.options.getPoolAlignment(),freeDragLocation:interaction.options.getFreeDragLocation(),subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),allowRepeat:interaction.options.repeatAnswersIsAllow(),groupsMap:gapsToGroup,gapsOption:interaction.options.getGaps(),multiDest:interaction.options.getMultipleDestinations(),hasOrderedResponses:!interaction.options.orderDependencyIsOff()}),classNames="";this.gapMatchInteractionModel=gapMatchInteractionModel,interaction.options.hasResourceBanks()?classNames=this.buildResourceDragElements(interaction):(_(choiceNodes).each(function(choiceNode,index){this.buildGapTextImage(interaction,choiceNode,gapMatchInteractionModel,gapMatchInteractionModel.getStackFor(index))},this),interaction.options.poolorderIsAlphabetical()&&gapMatchInteractionModel.sortPoolByText(),interaction.options.poolorderIsNatural()&&gapMatchInteractionModel.naturalsortPoolByText(),interaction.options.randomiseanswersIsTrue()&&gapMatchInteractionModel.randomizePool());var gapMatchInteractionView,classes=this._getClasses(interaction,gapMatchInteractionModel);gapMatchInteractionView=new a5.views.interaction[classes.viewClass](gapMatchInteractionModel,null,{interaction:interaction,gapsOption:interaction.options.getGaps(),wordpoolElementClass:classes.wordpoolElementClass,elementClass:this.getElementClass(),classNames:classNames});var $gapMatchInteractionNode=gapMatchInteractionView.render();gapMatchInteractionView.hide(),parentNode.append($gapMatchInteractionNode),parentNode.addInteractionStyle("drag-drop"),interaction.options.displayascompletedIsOn()&&parentNode.addInteractionStyle("display-as-completed"),interaction.options.multipleDestinationsIsOne()||parentNode.addInteractionStyle("multiple-destinations"),this.buildContents(node,interaction,gapMatchInteractionView.wordpool.block,"gapText, gapImg"),gapMatchInteractionModel.targetDropAreas.forEach(function(t){if(t.prefilled){var correct=t.getCorrect(),dragArea=null;_.some(gapMatchInteractionModel.poolDropAreas,function(d){if(d.drag===correct)return dragArea=d,!0}),t.drop(dragArea.drag),dragArea.copyOnDrag||(gapMatchInteractionModel.setPrefilled(dragArea),dragArea.prefilled&&dragArea.undrop())}}),interaction.blockItems.add(gapMatchInteractionModel);var adjustAndShow=function(){gapMatchInteractionView.adjustGapSizes(),gapMatchInteractionView.show()};interaction.bind("show:deferred",adjustAndShow,this);var onWindowResize=_.throttle(function(){gapMatchInteractionView.adjustGapSizes()},300);$(window).on("resize",onWindowResize),interaction.bind("reset",function(){interaction.unbind("show:deferred",adjustAndShow),$(window).off("resize",onWindowResize)},this),this.isBuildingGapMatchInteraction=!1,this.gapMatchInteractionModel=null},_getClasses:function(interaction,gapMatchInteractionModel){var wordpoolClassSufix=this._isInteractionDragAndDrop(interaction)?"":"NoDrop";return interaction.options.hasResourceBanks()?{viewClass:"GapMatchResourcesView",wordpoolElementClass:"GapMatchGapTextNoDropView"}:gapMatchInteractionModel.hasStacks()?{viewClass:"GapMatchWithStacksView",wordpoolElementClass:"GapMatchStack"+wordpoolClassSufix+"View"}:{viewClass:"GapMatchView",wordpoolElementClass:"GapMatchGapText"+wordpoolClassSufix+"View"}},getElementClass:function(){return"om-textgap-element"},buildGapTextImage:function(interaction,node,gapMatchInteractionModel,stackAreaModel){var $choiceNode=$(node),gaptextaudio=interaction.options.gaptextaudioIsTrue()&&!$choiceNode.is("gapImg"),answer=this.buildContents($choiceNode,interaction),dragElementModel=new a5.models.interaction.DragElement({content:answer,identifier:$choiceNode.attr("identifier"),clickclick:interaction.options.useClickClickIsTrue(),gaptextaudio:gaptextaudio,behavior:this._getGapfillBehavior(interaction),overflowOnDrag:interaction.options.freeDragLocationIsBetween_letters()||interaction.options.freeDragLocationIsBetween_words()});if(dragElementModel.assignAnswerFeedback($choiceNode),gapMatchInteractionModel.addDragElement(dragElementModel),!interaction.options.multipleDestinationsIsOne()&&!_.contains(this.gapMatchInteractionModel.getUniqueAnswers(),dragElementModel.identifier)){var uniqueDrag=this.gapMatchInteractionModel.getUniqueDragElement(dragElementModel);return void(dragElementModel.home=uniqueDrag.home)}var dropAreaModel=new a5.models.interaction.DropArea({copyOnDrag:!interaction.options.multipleDestinationsIsOne(),drag:dragElementModel,resident:dragElementModel,dropIndicator:interaction.options.dropIndicatorIsTrue()});interaction.options.multipleDestinationsIsOne()||(dropAreaModel.allowed=[dragElementModel]),dragElementModel.home=dropAreaModel,stackAreaModel&&(dragElementModel.home=stackAreaModel,stackAreaModel.drags.push(dragElementModel)),gapMatchInteractionModel.addPoolDropArea(dropAreaModel)},buildResourceDragElements:function(interaction){var banks=this._getBanks(interaction).getPreselectedBanks();return _.each(banks,function(bank){this._buildResourceBank(bank,interaction)},this),banks.map(function(bank){return"resource-bank-"+bank.id}).join(" ")},_getBanks:function(interaction){var allBanks=_(a5.dp.resourceBanks).map(function(bank){return new a5.model.ResourceBank(bank,this)},this);return new a5.model.ResourceBankList({availableBanks:this._getAvailableBanks(interaction),allBanks:allBanks})},_getAvailableBanks:function(interaction){var availableBanks=[];try{availableBanks=$.parseJSON(interaction.options.getResourceBanks()).items}catch(e){}return availableBanks},_buildResourceBank:function(bank,interaction){_.each(bank.items,function(item){item instanceof a5.model.ResourceBankGroup?this._buildResourceBankGroup(item,interaction):this._buildResourceBankItem(item,interaction,this._buildResourceDragElement)},this)},_buildResourceBankGroup:function(group,interaction){_.each(group.items,function(item){this._buildResourceBankItem(item,interaction,this._buildResourceDragElement)},this)},_buildResourceBankItem:function(item,interaction,onRender){if(item instanceof a5.model.ResourceComposedBankItem)return this._buildResourceComposedBankItem(item);var resourceBankItem=new a5.view.ResourceBankItem({item:item,interaction:interaction});resourceBankItem.bind("render",onRender.bind(this,resourceBankItem)),resourceBankItem.render()},_buildResourceDragElement:function(resource){var dropAudio=resource.item.audio&&this._buildAudio(resource.item.id,resource.item.audio),dragElementModel=new a5.models.interaction.DragElement({content:$('<div class="content">').append(resource.$el),identifier:this._getIdentifierFor(resource.item.name),behavior:"tap_item",dropAudio:dropAudio}),dropAreaModel=new a5.models.interaction.DropArea({copyOnDrag:!0,drag:dragElementModel,resident:dragElementModel});dragElementModel.home=dropAreaModel,this.gapMatchInteractionModel.addDragElement(dragElementModel),this.gapMatchInteractionModel.addPoolDropArea(dropAreaModel)},_buildResourceComposedBankItem:function(item,interaction){var resourceComposedBankItem=new a5.view.ResourceComposedBankItem({item:item,interaction:interaction});resourceComposedBankItem.bind("render",function(){_.each(item.composite,function(child){this._buildResourceBankItem(child,resourceComposedBankItem,function(resource){resourceComposedBankItem.$el.append(resource.$el)})},this),this._buildResourceDragElement(resourceComposedBankItem)},this),resourceComposedBankItem.render()},_getIdentifierFor:function(name){var found=_.find(this.choices,function(choice){return a5.utils.checkUserInput(name,choice[1])});return found?found[0]:name},_buildAudio:function(id,audioURLs){var src;return src="string"==typeof audioURLs?A5.SKIN_URL+audioURLs:_.map(audioURLs,function(src){return A5.SKIN_URL+src}),a5.service.media.audio.create(id,{url:src,preload:!1})},buildGap:function(interaction,parentNode,node){var insertBetweenWords=interaction.options.freeDragLocationIsBetween_words(),gapModel=new a5.models.interaction.Gap({identifier:node.attr("identifier"),enumeration:interaction.enumAnswers.next(),globalEnumeration:a5.mainBuilder.options(!0).continuousEnumerationIsOn(),prefilled:interaction.options.prefillIsFirstitem()&&0==this.gapCount||interaction.options.prefillIsFirstblock()&&0==this.contentblockCount,existing:"home",dropIndicator:interaction.options.dropIndicatorIsTrue(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),allowRepeat:interaction.options.repeatAnswersIsAllow(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),blockNumber:this.contentblockCount,capitalize:interaction.options.automaticcapitalisationIsOn(),hasOrderedResponses:!interaction.options.orderDependencyIsOff(),hasOrderedResponsesFirstAnswer:interaction.options.orderDependencyIsFirst_answer(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),inputStyle:node.attr("style")});this.gapMatchInteractionModel.addTargetDropArea(gapModel);var insertGapAtEnd=!1;this.prevIsGap||this.prevChar&&(this._isPunctuationChar(this.prevChar)||this._isSpaceChar(this.prevChar)?this.glueNode=this._createAndAppendGlueNodeTo(parentNode):insertGapAtEnd=insertBetweenWords&&(!node[0].nextSibling||!$(node[0].nextSibling).is("gap")&&node[0].nextSibling.nodeType!==Node.TEXT_NODE));var viewClass=this._isInteractionDragAndDrop(interaction)?"GapMatchGapView":"GapMatchGapNoDropView",gapView=new a5.views.interaction[viewClass](gapModel,null,{capitalizeGap:this.capitalize,elementClass:this.getElementClass()});this.capitalize=!1,parentNode.find(this.glueNode).length||(this.glueNode=this._createAndAppendGlueNodeTo(parentNode)),this.glueNode.append(gapView.render()),insertGapAtEnd&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode)),this.gapCount+=1,this.prevIsGap=!0,a5.callbacks.interaction.bind("loaded",function(i){i===interaction&&this.addWordClasses(gapView.node,".drop_area")},this)},buildBr:function(interaction,parentNode,node){this._buildBRBr(interaction,parentNode,node)},buildBR:function(interaction,parentNode,node){this._buildBRBr(interaction,parentNode,node)},_buildBRBr:function(interaction,parentNode,node){parentNode.append($("<br>")),this.prevIsGap=!1,this.prevChar=null,this.glueNode=null},buildDiv:function(interaction,parentNode,node){var $contentblock=$('<div class="contentblock"></div>');$contentblock.addClass(node.attr("class")),this._buildEnumBlock(interaction,$contentblock),parentNode.append($contentblock),this.prevIsGap=!1,this.prevChar=null,this.capitalize=!0,this.contentblockCount&&!a5.mainBuilder.options(!0).continuousEnumerationIsOn()&&interaction.enumAnswers.ready().then(function(){interaction.enumAnswers.reset()}),this.buildContents(node,interaction,$contentblock),this.contentblockCount++},buildP:function(interaction,parentNode,node){this.capitalize=!0,(new a5.model_builder.Element).build(interaction,parentNode,node)},_buildEnumBlock:function(interaction,parentNode,node){interaction.enumBlock&&interaction.enumBlock.useEnum()&&(parentNode.append('<span class="enumblock-placeholder"></span>'),parentNode.attr("tabindex",-1),interaction.enumBlock.next().then(function(enumSymbol){parentNode.find(".enumblock-placeholder").replaceWith(enumSymbol),parentNode.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}))},buildTextNode:function(interaction,parentNode,node){var text=node[0].textContent;if(text.replace(/\s+/g," ").trim().length>0&&this.isBuildingGapMatchInteraction&&!node.parents("gapText").length){var chars=_.str.chars(text),initialBlanks=!0;_(chars).each(function(c,index){initialBlanks=initialBlanks&&this._isSpaceChar(c),0===index&&this._buildFirstChar(c,interaction,parentNode),index>0&&(this._buildChar(chars[index-1],c,interaction,parentNode,index),index!==chars.length-1||node[0].nextSibling&&($(node[0].nextSibling).is("gap")||node[0].nextSibling.nodeType===Node.TEXT_NODE)||this._buildLastChar(c,interaction,parentNode)),this.prevChar=c,initialBlanks||(this.prevIsGap=!1)},this)}else parentNode.is("table")||(this.isBuildingGapMatchInteraction&&!node.parents("gapText").length&&(this.prevIsGap=!1,this.prevChar=" ",this.glueNode=null),parentNode.append(text))},_createAndAppendGapTo:function(interaction,parentNode){var gapModel=new a5.models.interaction.OMTextGapSpaceGap({existing:"home",dropIndicator:interaction.options.dropIndicatorIsTrue(),capitalize:interaction.options.automaticcapitalisationIsOn()});this.gapMatchInteractionModel.addTargetDropArea(gapModel);var viewClass=this._isInteractionDragAndDrop(interaction)?"GapMatchGapView":"GapMatchGapNoDropView";parentNode.append(new a5.views.interaction[viewClass](gapModel,null,{capitalizeGap:this.capitalize,elementClass:this.getElementClass()}).render()),this.capitalize=!1},_buildChar:function(prev,cur,interaction,parentNode,index){var glueNode,insertBetweenWords=interaction.options.freeDragLocationIsBetween_words(),insertBetweenLetters=interaction.options.freeDragLocationIsBetween_letters();switch(!0){case this._isSpaceChar(prev)&&this._isSpaceChar(cur):this.glueNode=null;break;case this._isSpaceChar(prev)&&this._isPunctuationChar(cur):insertBetweenWords&&!this.prevIsGap&&(glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,glueNode)),this.glueNode=this._createAndAppendGlueNodeTo(parentNode);break;case this._isSpaceChar(prev)&&this._isWordChar(cur):insertBetweenWords&&(this.prevIsGap||(glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,glueNode)),parentNode.append(" ")),this.glueNode=this._createAndAppendGlueNodeTo(parentNode),insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode);break;case this._isWordChar(prev)&&this._isSpaceChar(cur):insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode),this.glueNode=null;break;case this._isWordChar(prev)&&this._isPunctuationChar(cur):insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode),insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode));break;case this._isWordChar(prev)&&this._isWordChar(cur):insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode);break;case this._isPunctuationChar(prev)&&this._isSpaceChar(cur):this.glueNode=null;break;case this._isPunctuationChar(prev)&&this._isPunctuationChar(cur):this.glueNode=null,insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode));break;case this._isPunctuationChar(prev)&&this._isWordChar(cur):insertBetweenWords&&(glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,glueNode)),this.glueNode=this._createAndAppendGlueNodeTo(parentNode),insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode)}
this.glueNode?this.glueNode.append(cur):parentNode.append(cur),this._isPunctuationChar(cur)&&!this.capitalize?this.capitalize=this._isEndOfSentence(cur):this._isSpaceChar(cur)||this._isPunctuationChar(cur)||(this.capitalize=!1)},_createGlueNode:function(){return $('<span class="glue-wrap"></span>')},_createAndAppendGlueNodeTo:function(parentNode){var glueNode=this._createGlueNode();return parentNode.append(glueNode),glueNode},_createAndPrependGlueNodeTo:function(parentNode){var glueNode=this._createGlueNode();return parentNode.prepend(glueNode),glueNode},_isPunctuationChar:function(c){return/[.,:;?!()"'ââ]/.test(c)},_isSpecialChar:function(c){return/\W/.test(c)&&!this._isSpaceChar(c)&&!this._isPunctuationChar(c)},_isWordChar:function(c){return/\w/.test(c)||this._isSpecialChar(c)},_isSpaceChar:function(c){return/\s/.test(c)},_isEndOfSentence:function(c){return _.contains([".","!","?"],c)},_isStartOfSentence:function(c){return this.capitalize&&_.contains(['"',"'","â","â"],c)},_buildFirstChar:function(cur,interaction,parentNode){var glueNode,insertBetweenWords=interaction.options.freeDragLocationIsBetween_words(),insertBetweenLetters=interaction.options.freeDragLocationIsBetween_letters();switch(!0){case this._isSpaceChar(cur):parentNode.append(cur);break;case this._isPunctuationChar(cur):this.prevIsGap?(this.prevChar&&this._isWordChar(this.prevChar)&&insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode)),parentNode.find(this.glueNode).length||(this.glueNode=this._createAndAppendGlueNodeTo(parentNode)),this.glueNode.append(cur)):(insertBetweenWords&&(!this.prevChar||this._isPunctuationChar(this.prevChar)||this._isWordChar(this.prevChar))&&(glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,glueNode)),parentNode.append(cur));break;case this._isWordChar(cur):this.prevIsGap||(!insertBetweenWords||this.prevChar&&!this._isPunctuationChar(this.prevChar)||(glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,glueNode)),this.glueNode=this._createAndAppendGlueNodeTo(parentNode),insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode)),parentNode.find(this.glueNode).length||(this.glueNode=this._createAndAppendGlueNodeTo(parentNode)),this.glueNode.append(cur)}this._isSpaceChar(cur)||(this.capitalize=this._isEndOfSentence(cur)||this._isStartOfSentence(cur))},_buildLastChar:function(cur,interaction,parentNode){var insertBetweenWords=interaction.options.freeDragLocationIsBetween_words(),insertBetweenLetters=interaction.options.freeDragLocationIsBetween_letters();switch(!0){case this._isSpaceChar(cur):insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode));break;case this._isPunctuationChar(cur):this.capitalize||(this.capitalize=this._isEndOfSentence(cur)),insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode));break;case this._isWordChar(cur):insertBetweenLetters&&this._createAndAppendGapTo(interaction,this.glueNode),insertBetweenWords&&(this.glueNode=this._createAndAppendGlueNodeTo(parentNode),this._createAndAppendGapTo(interaction,this.glueNode))}},_isInteractionDragAndDrop:function(interaction){return"drag"===this._getGapfillBehavior(interaction)},_getGapfillBehavior:function(interaction){if(interaction.options.hasResourceBanks())return"tap_item";var behavior=interaction.options.getGapfillbehaviour();return"tap_item"!==behavior&&"tap_target"!==behavior||"mobile"===a5.dp.config.gapfillBehaviourApplicable&&a5.utils.isDocumentOverMobileBreakpoint()&&(behavior="drag"),behavior}},a5.model_builder.Base.extend("a5.model_builder.OMTextGapBuilder"),a5.model_builder.builders.push(new a5.model_builder.OMTextGapBuilder),a5.model_builder.OMNumberPyramid={isResponsible:function(node,interaction){return"Order:Match:Number pyramid"===interaction.identifier&&(node.is("gapMatchInteraction")||node.is("#contentblock")||node.is("gap")&&this.isBuildingGapMatchInteraction||node.is(".pyramid-display-number")||node[0].nodeType==Node.TEXT_NODE||node[0].tagName&&"br"==node[0].tagName.toLowerCase())},buildDiv:function(interaction,parentNode,node){node.is("#contentblock")?(this.index=0,this._super(interaction,parentNode,node)):this._buildDisplayNumber(interaction,parentNode,node)},_buildDisplayNumber:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-pyramid"));var $display=this.buildContents(node,interaction,$("<span>"));$display.addClass("pyramid-display-number"),$display.addClass(this._indexToPyramidClass(this.index)),parentNode.find(".number-pyramid").append($display),this.index++},_buildGap:function(interaction,parentNode,node){var gapModel=new a5.models.interaction.Gap({identifier:node.attr("identifier"),enumeration:interaction.enumAnswers.next(),globalEnumeration:a5.mainBuilder.options(!0).continuousEnumerationIsOn(),prefilled:interaction.options.prefillIsFirstitem()&&0==this.gapCount||interaction.options.prefillIsFirstblock()&&0==this.contentblockCount,existing:"home",dropIndicator:interaction.options.dropIndicatorIsTrue(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),allowRepeat:interaction.options.repeatAnswersIsAllow(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),blockNumber:this.contentblockCount,capitalize:interaction.options.automaticcapitalisationIsOn(),hasOrderedResponses:interaction.options.orderDependencyIsOn()});this.gapMatchInteractionModel.addTargetDropArea(gapModel);var gapView=new a5.views.interaction.GapMatchGapView(gapModel,null,{elementClass:this.getElementClass()});parentNode.append(gapView.render()),this.gapCount+=1,a5.callbacks.interaction.bind("loaded",function(i){i===interaction&&this.addWordClasses(gapView.node,".drop_area")},this)},buildGap:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-pyramid")),this._buildGap(interaction,parentNode.find(".number-pyramid"),node),parentNode.find(".gap_match_gap_view, .prefilled").last().addClass(this._indexToPyramidClass(this.index)),this.index++},getElementClass:function(){return"om-number-pyramid-element"},_indexToPyramidClass:function(index){return"pyramid-"+["top","left","right","center","bottom-left","bottom","bottom-right"][index]},_createAndAppendGlueNodeTo:function(parentNode){return parentNode}},a5.model_builder.OMTextGapBuilder.extend("a5.model_builder.OMNumberPyramid"),a5.model_builder.builders.push(new a5.model_builder.OMNumberPyramid),a5.model_builder.OMTextGapExamsBuilder={isResponsible:function(node,interaction){return"Order:Match:Text gap"==interaction.identifier&&("Trainer"==LOInfo.mode||"Exam"==LOInfo.mode)&&(node.is("gapMatchInteraction")||node.is("gap")&&this.isBuildingGapMatchInteraction)},buildGap:function(interaction,parentNode,node){var gapModel=new a5.models.interaction.Gap({identifier:node.attr("identifier"),enumeration:interaction.enumAnswers.next(),globalEnumeration:a5.mainBuilder.options(!0).continuousEnumerationIsOn(),prefilled:interaction.options.prefillIsFirstitem()&&0==this.gapCount||interaction.options.prefillIsFirstblock()&&0==this.contentblockCount,existing:"home",dropIndicator:interaction.options.dropIndicatorIsTrue(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect()});this.gapMatchInteractionModel.addTargetDropArea(gapModel);var gapView=new a5.views.interaction.GapMatchGapExamsView(gapModel),$gapViewNode=gapView.render();parentNode.append($gapViewNode),0==interaction.blockItems.length()&&interaction.bind("show:deferred",function(){$gapViewNode.focus()}),interaction.bind("update-status-to-input",function(){gapView.updateToInput()}),this.gapCount+=1},buildGapMatchInteraction:function(interaction,parentNode,node){if(this.isBuildingGapMatchInteraction)throw"cannot nest gapMatchInteractions";this.isBuildingGapMatchInteraction=!0,this.gapCount=0;var choiceNodes=this.fetchChoices(interaction,node,"> gapText, > gapImg"),choices=_(choiceNodes).map(function(choiceNode){var $choiceNode=$(choiceNode),text=$choiceNode.text()||$choiceNode.find("img[data-mathml]").data("mathml")||$choiceNode.find("img[src]").attr("src")||$choiceNode.find('object[type="audio/audio"]').attr("data");return[$choiceNode.attr("identifier"),text]}),gapMatchInteractionModel=new a5.models.interaction.GapMatchInteraction({parent:interaction,responses:interaction.getCorrectResponse(node.attr("responseIdentifier")),answers:choices,poolAlignment:interaction.options.getPoolAlignment()});_(choiceNodes).each(function(choiceNode,index){this.buildGapTextImage(interaction,choiceNode,gapMatchInteractionModel)},this);var gapMatchInteractionView=new a5.views.interaction.GapMatchExamsView(gapMatchInteractionModel,null,interaction.options.getGaps(),interaction.options.gaptextaudioIsTrue()),$gapMatchInteractionNode=gapMatchInteractionView.render();parentNode.append($gapMatchInteractionNode),parentNode.addInteractionStyle("drag-drop"),this.gapMatchInteractionModel=gapMatchInteractionModel,this.buildContents(node,interaction,gapMatchInteractionView.wordpool.block,"gapText, gapImg"),interaction.blockItems.add(gapMatchInteractionModel),interaction.bind("show:deferred",gapMatchInteractionView.adjustGapSizes,gapMatchInteractionView,{once:!0}),this.isBuildingGapMatchInteraction=!1,this.gapMatchInteractionModel=null},buildGapTextImage:function(interaction,node,gapMatchInteractionModel){var $choiceNode=$(node),gaptextaudio=interaction.options.gaptextaudioIsTrue()&&!$choiceNode.is("gapImg"),answer=this.buildContents($choiceNode,interaction),dragElementModel=new a5.models.interaction.DragElement({content:answer,identifier:$choiceNode.attr("identifier"),clickclick:interaction.options.useClickClickIsTrue(),gaptextaudio:gaptextaudio});dragElementModel.assignAnswerFeedback($choiceNode);var dropAreaModel=new a5.models.interaction.DropArea({copyOnDrag:!interaction.options.multipleDestinationsIsOne(),drag:dragElementModel,resident:dragElementModel,dropIndicator:interaction.options.dropIndicatorIsTrue()});dropAreaModel.allowed=[dragElementModel],dragElementModel.home=dropAreaModel,gapMatchInteractionModel.addDragElement(dragElementModel),gapMatchInteractionModel.addPoolDropArea(dropAreaModel)}},a5.model_builder.Base.extend("a5.model_builder.OMTextGapExamsBuilder"),a5.model_builder.builders.push(new a5.model_builder.OMTextGapExamsBuilder),a5.model_builder.GraphicGapMatchInteraction={isResponsible:function(node,interaction){return"Order:Match:Text gap (Label an object)"===interaction.identifier&&(a5.utils.hasTag(node,"graphicGapMatchInteraction")||a5.utils.hasTag(node,"object")&&["image/jpeg","image/png"].contains(node.attr("type")))},buildGraphicGapMatchInteraction:function(interaction,parentNode,node){if(this.isBuildingGraphicGapMatchInteraction)throw"cannot nest gapMatchInteractions";this.isBuildingGraphicGapMatchInteraction=!0,this.gapCount=0;var choiceNodes=this.fetchChoices(interaction,node,"> gapText, > gapImg"),choices=[],choiceNodesWithDistractors=[];_.each(choiceNodes,function(choiceNode,index){var $choiceNode=$(choiceNode).clone(),answer_and_distractors=this._findAnswerAndDistractors($choiceNode);_.each(answer_and_distractors,function($answer,index){index>0&&$answer.attr("identifier",identifier+"-DISTRACTOR-"+index);var identifier=$answer.attr("identifier"),text=$answer.text()||$answer.find("img[data-mathml]").data("mathml")||$answer.find("img[src]").attr("src")||$answer.find('object[type="audio/audio"]').attr("data");choices.push([identifier,text]),choiceNodesWithDistractors.push($answer)})},this),choiceNodes=choiceNodesWithDistractors,this.model=new a5.models.interaction.GraphicGapMatchInteraction({parent:interaction,responses:interaction.getCorrectResponse(node.attr("responseIdentifier")),answers:choices,stacks:parseInt(interaction.options.getPoolStacks(),10),poolAlphabeticalOrder:interaction.options.poolorderIsAlphabetical(),poolAlignment:interaction.options.getPoolAlignment(),poolRandomized:interaction.options.randomiseanswersIsTrue(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()}),_.each(node.children("associableHotspot"),function(associableHotspot){var delimeter,$associableHotspot=$(associableHotspot);$associableHotspot.attr("coords").indexOf(",")>=0&&(delimeter=","),$associableHotspot.attr("coords").indexOf(":")>=0&&(delimeter=":");var gapModel=new a5.models.interaction.Gap({identifier:$associableHotspot.attr("identifier"),enumeration:interaction.enumAnswers.next(),prefilled:interaction.options.prefillIsFirstitem()&&0===this.gapCount,position:$associableHotspot.attr("coords").split(delimeter),existing:"home",dropIndicator:interaction.options.dropIndicatorIsTrue(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),inputStyle:$associableHotspot.attr("style"),arrow:$associableHotspot.attr("arrow")});this.model.addTargetDropArea(gapModel),this.gapCount+=1},this),interaction.options.multipleDestinationsIsOne()||(choiceNodes=_.filter(choiceNodes,function(choiceNode){var answers=this.model.getUniqueAnswers();return _.contains(answers,$(choiceNode).attr("identifier"))},this)),_.each(choiceNodes,function(choiceNode,index){this.buildGapTextImage(interaction,choiceNode,this.model,this.model.getStackFor(index))},this),interaction.options.poolorderIsAlphabetical()&&this.model.sortPoolByText(),interaction.options.poolorderIsNatural()&&this.model.naturalsortPoolByText(),interaction.options.randomiseanswersIsTrue()&&this.model.randomizePool();var viewClass,wordpoolElementClass,wordpoolClassSufix=this._isInteractionDragAndDrop(interaction)?"":"NoDrop";this.model.hasStacks()?(viewClass="GraphicGapMatchWithStacksView",wordpoolElementClass="GapMatchStack"+wordpoolClassSufix+"View"):(viewClass="GraphicGapMatchView",wordpoolElementClass="GapMatchGapText"+wordpoolClassSufix+"View");var blockElementClass="GraphicGapMatchGap"+wordpoolClassSufix+"View";this.view=new a5.views.interaction[viewClass](this.model,null,{wordpoolElementClass:wordpoolElementClass,blockElementClass:blockElementClass,elementClass:this.getElementClass(),gapsOption:interaction.options.getGaps(),autoscaling:a5.dp.config.omTextGapLabelAnObjectAutoscaling}),parentNode.append(this.view.node),this.view.render(),parentNode.addInteractionStyle("drag-drop"),interaction.options.multipleDestinationsIsOne()||parentNode.addInteractionStyle("multiple-destinations"),this.buildContents(node,interaction,this.view.wordpool.block,"gapText, gapImg, associableHotspot"),this.model.targetDropAreas.forEach(function(t){if(t.prefilled){var correct=t.getCorrect(),dragArea=null;_.some(this.model.poolDropAreas,function(d){if(d.drag===correct)return dragArea=d,!0}),t.drop(dragArea.drag),dragArea.copyOnDrag||dragArea.drag.copyOnDrag||(dragArea.undrop(),dragArea.setPrefilled())}}.bind(this)),interaction.blockItems.add(this.model),this.isBuildingGraphicGapMatchInteraction=!1},buildObject:function(interaction,parentNode,node){if((new a5.model_builder.ObjectImage).build(interaction,parentNode,node),this.isBuildingGraphicGapMatchInteraction){var styles=node.attr("style")||"",size={width:parseFloat(a5.utils.getStyleValue(styles,"width")),height:parseFloat(a5.utils.getStyleValue(styles,"height"))};this.model.setImageSize(size),this.view.setImage()}},getElementClass:function(){return"om-textgap-label-an-object-element"},buildGapTextImage:function(interaction,node,graphicGapMatchInteractionModel,stackAreaModel){var $choiceNode=$(node),answer=this.buildContents($choiceNode,interaction),gaptextaudio=interaction.options.gaptextaudioIsTrue()&&!$choiceNode.is("gapImg"),dragElementModel=new a5.models.interaction.DragElement({content:answer,gaptextaudio:gaptextaudio,behavior:this._getGapfillBehavior(interaction),identifier:$choiceNode.attr("identifier"),clickclick:interaction.options.useClickClickIsTrue()});dragElementModel.assignAnswerFeedback($choiceNode);var dropAreaModel=new a5.models.interaction.DropArea({copyOnDrag:!interaction.options.multipleDestinationsIsOne(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),drag:dragElementModel,resident:dragElementModel,dropIndicator:interaction.options.dropIndicatorIsTrue()});interaction.options.multipleDestinationsIsOne()||(dropAreaModel.allowed=[dragElementModel]),dragElementModel.home=dropAreaModel,stackAreaModel&&(dragElementModel.home=stackAreaModel,stackAreaModel.drags.push(dragElementModel)),graphicGapMatchInteractionModel.addDragElement(dragElementModel),graphicGapMatchInteractionModel.addPoolDropArea(dropAreaModel)},_findAnswerAndDistractors:function($node){if(!$node.text().match(/.*\*\*.*/))return[$node];var ret=[],$answer=$node.clone().empty(),$distractor=$node.clone().empty(),found=!1;return $node.contents().each(function(){if(this.nodeType===Node.TEXT_NODE&&this.textContent.indexOf("**")>=0){var first=_.first(this.textContent.split("**")),rest=_(this.textContent.split("**")).chain().rest().compact().value();found?($distractor.append(first),ret.push($distractor),$distractor=$node.clone().empty()):($answer.append(first),ret.push($answer)),_(rest).each(function(distractor){$distractor.append(distractor),ret.push($distractor),$distractor=$node.clone().empty()}),found=!0}else found?$distractor.append($(this)):$answer.append($(this))}),$distractor.contents().length>0&&ret.push($distractor),ret},_isInteractionDragAndDrop:function(interaction){return"drag"===this._getGapfillBehavior(interaction)},_getGapfillBehavior:function(interaction){var behavior=interaction.options.getGapfillbehaviour();return"tap_item"!==behavior&&"tap_target"!==behavior||"mobile"===a5.dp.config.gapfillBehaviourApplicable&&a5.utils.isDocumentOverMobileBreakpoint()&&(behavior="drag"),behavior}},a5.model_builder.Base.extend("a5.model_builder.GraphicGapMatchInteraction"),a5.model_builder.builders.push(new a5.model_builder.GraphicGapMatchInteraction),a5.model_builder.OMPairsInteraction={isResponsible:function(node,interaction){return a5.dp.config.ompairsNew&&"Order:Match:Pairs"==interaction.identifier&&node.is("matchInteraction")},_hasGaptextAudio:function(interaction,$content){return interaction.options.gaptextaudioIsTrue()&&$content.text().trim().length>0&&!$content.hasClass("has_audio_attached")},buildMatchInteraction:function(interaction,parentNode,node){var ompairsInteraction=new a5.models.interaction.OMPairsInteraction({interactionIndex:interaction.index,behaviour:this._getGapfillBehaviour(interaction),poolAlignment:interaction.options.getPoolAlignment(),pairAlignment:interaction.options.getPairalignment()}),responses=interaction.getCorrectResponse(node.attr("responseIdentifier")),gaps=node.find("#contentblock simpleAssociableChoice"),gapsModels=_.map(gaps,function(gap){var content=this.buildContents($(gap),interaction);return new a5.models.interaction.OMPairsGap({identifier:$(gap).attr("identifier"),correctResponse:$(gap).attr("identifier"),content:content,parent:ompairsInteraction,enumeration:interaction.enumAnswers.next(),tryAgainBehaviour:this.getTryAgainBehaviour(interaction),gaptextaudio:this._hasGaptextAudio(interaction,$(content)),dropIndicator:interaction.options.dropIndicatorIsTrue()})},this),answers=this.fetchChoices(interaction,node,"> simpleMatchSet > simpleAssociableChoice"),answerModels=_.map(answers,function(answer){var content=this.buildContents($(answer),interaction);return new a5.models.interaction.OMPairsResponse({identifier:$(answer).attr("identifier"),correctGap:_.first(responses.asMap([$(answer).attr("identifier")])),content:content,parent:ompairsInteraction,gaptextaudio:this._hasGaptextAudio(interaction,$(content))})},this);if(interaction.options.prefillIsFirstitem()){var prefilledGap=_.first(gapsModels),prefilledResponse=_.findWhere(answerModels,{identifier:prefilledGap.correctResponse});prefilledGap.prefilled=prefilledResponse.prefilled=!0}ompairsInteraction.addResponses(answerModels),ompairsInteraction.addGaps(gapsModels),interaction.blockItems.add(ompairsInteraction);var view=new a5.views.OMPairsInteraction(ompairsInteraction,null,interaction);parentNode.append(view.render()),parentNode.addInteractionStyle("drag-drop");var otherContent=node.find("#contentblock").children().filter(":not(:has(simpleAssociableChoice))");this.buildContents(otherContent,interaction,parentNode)},_getGapfillBehaviour:function(interaction){var behaviour=interaction.options.getGapfillbehaviour();return"tap_item"!==behaviour&&"tap_target"!==behaviour||"mobile"===a5.dp.config.gapfillBehaviourApplicable&&a5.utils.isDocumentOverMobileBreakpoint()&&(behaviour="drag"),behaviour},getTryAgainBehaviour:function(interaction){var tryAgainBehaviour={keep:"none",lock:!1};return interaction.options.tryAgainIsLock()||interaction.options.tryAgainIsFrozen()?(tryAgainBehaviour.keep="correct",tryAgainBehaviour.lock=interaction.options.tryAgainIsFrozen()):interaction.options.tryAgainIsKeepall()&&(tryAgainBehaviour.keep="all"),tryAgainBehaviour}},a5.model_builder.Base.extend("a5.model_builder.OMPairsInteraction"),a5.model_builder.builders.push(new a5.model_builder.OMPairsInteraction),a5.model_builder.OMPairsInteractionLegacy={isResponsible:function(node,interaction){return!a5.dp.config.ompairsNew&&"Order:Match:Pairs"==interaction.identifier&&node.is("matchInteraction, simpleAssociableChoice")},buildSimpleAssociableChoice:function(interaction,parentNode,node){this.buildContents(node,interaction,parentNode)},buildMatchInteraction:function(interaction,parentNode,node){parentNode.closest(".interaction").addClass("drag-drop"),this.responses=interaction.getCorrectResponse(node.attr("responseIdentifier")).asMap();var targetIds=_.uniq(_.map(this.responses,function(r){return _.first(r)})),poolIds=_.map(this.responses,function(v,k){return k}),enumAnswers=interaction.enumAnswers,distractors=_.map(node.find("simpleAssociableChoice"),function(m){var container=$("<div>");return this.buildContents(m,interaction,container),[$(m).attr("identifier"),container.html()]},this),targetPools={};_.each(this.responses,function(v,k){_.isUndefined(targetPools[_.first(v)])&&(targetPools[_.first(v)]=[]),targetPools[_.first(v)].push(k)});var poolTarget={};_.each(this.responses,function(v,k){poolTarget[k]=_.first(v)});var mode="false"!=interaction.options.getEnumerationAnswers()?"single":"multiple";interaction.options.targetzonesIsTrue()&&(mode="single");var model=new a5.models.interaction.OMPairsModel({},{targetIds:targetIds,poolIds:poolIds,targetPools:targetPools,poolTarget:poolTarget,mode:mode,correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()},interaction),gaptextaudio=interaction.options.gaptextaudioIsTrue(),viewpool=new a5.views.OMPairsViewPool(model,node,parentNode,poolIds,distractors,targetIds,gaptextaudio),viewtarget=new a5.views.OMPairsViewTarget(model,node,parentNode,targetIds,""!=enumAnswers.values,interaction.options.getPairalignment(),gaptextaudio);interaction.blockItems.add(model),interaction.model=model,parentNode.append(viewpool.render()),parentNode.append(viewtarget.render()),interaction.onInteractionReadyListeners.register(viewtarget.events.bindTo(viewtarget)),interaction.onInteractionRestoreListeners.register(viewtarget.events.bindTo(viewtarget)),new a5.views.OMPairsViewOptions(model,interaction.options,interaction.targetPools,targetIds);var otherContent=node.find("#contentblock").children().filter(":not(:has(simpleAssociableChoice))");this.buildContents(otherContent,interaction,parentNode)}},a5.model_builder.Base.extend("a5.model_builder.OMPairsInteractionLegacy"),a5.model_builder.builders.push(new a5.model_builder.OMPairsInteractionLegacy),a5.model_builder.ICTextGapLabelAnObject={isResponsible:function(node,interaction){return"Input:Completion:Text gap (Label an object)"===interaction.identifier&&(a5.utils.hasTag(node,"graphicGapMatchInteraction")||this.isBuildingGraphicGapMatchInteraction&&(a5.utils.hasTag(node,"associableHotspot")||a5.utils.hasTag(node,"object")&&["image/jpeg","image/png"].contains(node.attr("type"))))},buildGraphicGapMatchInteraction:function(interaction,parentNode,node){if(this.isBuildingGraphicGapMatchInteraction)throw"cannot nest gapMatchInteractions";this.isBuildingGraphicGapMatchInteraction=!0,this.gapCount=0,this.correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")).asMap(),this.model=new a5.models.interaction.ICTextGapLabelAnObjectBlock({poolAlignment:interaction.options.getPoolAlignment(),poolWords:this._extractPoolWords(interaction,node),tts_audio:interaction.options.gaptextaudioIsTrue(),parent:interaction}),this.view=new a5.views.interaction.ICTextGapLabelAnObjectBlock(this.model),parentNode.append(this.view.node),this.buildContents(node,interaction,this.view.wordpool.block,"gapText"),this.view.render(),this.isBuildingGraphicGapMatchInteraction=!1},buildAssociableHotspot:function(interaction,parentNode,node){var delimeter,response=this._processResponses(this.correctResponse[node.attr("identifier")],node,interaction);node.attr("coords").indexOf(",")>=0&&(delimeter=","),node.attr("coords").indexOf(":")>=0&&(delimeter=":");var model=new a5.models.interaction.ICTextGapLabelAnObject({enumeration:interaction.enumAnswers.next(),global_enumeration:a5.mainBuilder.options(!0).continuousEnumerationIsOn(),prefill:interaction.options.prefillIsFirstitem()&&0===this.gapCount,correct:response.correct,distractors:response.distractors,display_words:response.display_words,hintLetters:response.hints,tryAgainKeep:interaction.options.tryAgainIsKeepall(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreSpaces:interaction.options.ignoreSpacesIsOn(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),spellcheck:interaction.options.spellcheckIsOn(),parent:this.model,resizeGaps:interaction.options.gapResizeIsOn()||interaction.options.gapcharactersIsShow(),charactersNumber:interaction.options.gapcharactersIsShow(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),inputStyle:node.attr("style"),position:node.attr("coords").split(delimeter)});model.assignAnswerFeedback(node),this.model.add(model);var view=new a5.views.interaction.ICTextGapLabelAnObject(model,this.view);this.view.add(view),parentNode.append(view.render()),interaction.blockItems.add(model),this.gapCount+=1},buildObject:function(interaction,parentNode,node){var styles=node.attr("style"),size={width:parseFloat(a5.utils.getStyleValue(styles,"width")),height:parseFloat(a5.utils.getStyleValue(styles,"height"))};(new a5.model_builder.ObjectImage).build(interaction,parentNode,node),this.model.setImageSize(size),this.view.setImage()},_buildHintLetters:function(interaction,answers){var hints=[];return interaction.options.gapcharactersIsShow()&&_.each(answers,function(answer,index){if(a5.utils.containsUnescaped(answer,"{")&&a5.utils.containsUnescaped(answer,"}")){var parts=_.str.reverse(answer).split(/(\}(?!\\).+?\{(?!\\))/).reverse(),word="";_.each(parts,function(part){var str=_.str.reverse(part);a5.utils.startsWith(str,"{")&&a5.utils.endsWith(str,"}")&&(str=str.substring(1,str.length-1),hints.push({str:str,from:word.length,to:word.length+str.length-1})),word+=str}),answers[index]=word}}),hints},_processResponses:function(responses,node,interaction){var correct=[],distractors=[],display_words=[];_.each(responses,function(cident){var correct_and_distractors=node.parent().find("gapText[identifier='"+cident+"']").text().split("**");correct_and_distractors.length>1&&distractors.push(correct_and_distractors[1]),correct.push(a5.utils.splitUnescaped(correct_and_distractors[0],"*"))}),correct=_.chain(correct).compact().flatten().value(),display_words=_.filter(correct,function(answer){return a5.utils.containsUnescaped(answer,"|")}).map(function(answer){return a5.utils.splitUnescaped(answer,"|").pop()}),correct=_.map(correct,function(word){return _.first(a5.utils.splitUnescaped(word,"|"))});var hints=this._buildHintLetters(interaction,correct);return correct=_.map(correct,function(word){return a5.utils.unescapeReservedSyntaxSymbols(word)}),display_words=_.map(display_words,function(word){return a5.utils.unescapeReservedSyntaxSymbols(word)}),{correct:correct,display_words:display_words,distractors:distractors,hints:hints}},_extractPoolWords:function(interaction,node){var poolWords=[];_.each(node.children("gapText"),function(e){poolWords=_.union(poolWords,$(e).text().split("**")),poolWords=_.union(poolWords,_.tail($(e).text().split("**")))}),poolWords=_.uniq(poolWords);var displayWords=_.filter(poolWords,function(word){return a5.utils.containsUnescaped(word,"|")}),restWords=_.difference(poolWords,displayWords);return displayWords=_.map(displayWords,function(word){return a5.utils.splitUnescaped(word,"|").pop()}),displayWords=_.map(displayWords,function(word){return a5.utils.splitUnescaped(word,"*").shift()}),restWords=_.flatten(_.map(restWords,function(word){return a5.utils.splitUnescaped(word,"*")})),poolWords=_.union(displayWords,restWords),interaction.options.gapcharactersIsShow()&&(poolWords=_.map(poolWords,function(word){return word=_.str.reverse(word),word=word.replace(/[{}](?!\\)/g,""),word=_.str.reverse(word)})),poolWords=_.filter(poolWords,function(word){return"%0"!==word}),poolWords=_.map(poolWords,function(word){return a5.utils.unescapeReservedSyntaxSymbols(word)}),interaction.options.randomiseanswersIsTrue()?poolWords=_.shuffle(poolWords):interaction.options.poolorderIsAlphabetical()?poolWords=a5.utils.array.sortBy(poolWords,null,!0):interaction.options.poolorderIsNatural()&&(poolWords=a5.utils.array.naturalSort(poolWords,null,!0,!0)),poolWords}},a5.model_builder.Base.extend("a5.model_builder.ICTextGapLabelAnObject"),a5.model_builder.builders.push(new a5.model_builder.ICTextGapLabelAnObject),a5.model_builder.interaction.IMWordsearch={isResponsible:function(node,interaction){return"Identify:Mark:Wordsearch"==interaction.identifier&&node.is('graphicOrderInteraction, hotspotChoice, object[type="none/none"]')},buildHotspotChoice:function(interaction,parentNode,node){var id=node.attr("identifier"),word=void 0===this.responses[id]?this.responsesReverse[id][0]:this.responses[id][0],params=node.attr("coords").split(",");this.model.addWord({word:word,start:new Vec2(parseInt(params[0],10),parseInt(params[1],10)),directionIndex:parseInt(params[2],10)})},buildGraphicOrderInteraction:function(interaction,parentNode,node){var gridSize=parseInt(interaction.options.getSize(),10)||10;this.model=new a5.model.interaction.IMWordsearch({parent:interaction,width:gridSize,height:gridSize,tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainLock:interaction.options.tryAgainIsLock(),tryAgainFrozen:interaction.options.tryAgainIsFrozen(),hasPrefill:interaction.options.prefillIsFirstitem()}),this.responses=interaction.getCorrectResponse(node.attr("responseIdentifier")).asMap(),this.responsesReverse=interaction.getCorrectResponse(node.attr("responseIdentifier")).asInverseMap(),this.buildContents(node,interaction),this.model.initState();var view=new a5.view.interaction.IMWordsearch(this.model,null,interaction.options.caseIsUpper());parentNode.append(view.node),view.render(),interaction.blockItems.add(this.model),this.model=null;var template=a5.service.templates.render("a5.view.toolbar.erase");_.defer(function(){interaction.toolbar.addToggleButton({label:$(template).text()||"Erase",title:$(template).attr("title"),classes:["erase"],on:function(){view.enableDelete()},off:function(){view.disableDelete()}})})},buildObject:function(){}},a5.model_builder.Base.extend("a5.model_builder.interaction.IMWordsearch"),
a5.model_builder.builders.push(new a5.model_builder.interaction.IMWordsearch),a5.model_builder.LLInteraction={isResponsible:function(node,interaction){return"Identify:Select:Linking lines"==interaction.identifier&&node.is("associateInteraction")},buildSimpleAssociableChoice:function(interaction,node){var cn,cnt=this.buildContents(node,interaction),sets=this.model.sets,pos=this.totalElements/sets;pos=Math.floor(this.model.elements.length/pos),_.isUndefined(interaction.enumSets[pos])||(_.isEmpty(this.model.enumSets[pos])&&(this.model.enumSets[pos]=[]),this.model.enumSets[pos].push(interaction.enumSets[pos].next())),a5.dp.config.linkingLinesTouchDirection[interaction.options.answerdisplayIsRows()?1:0]?(cn=1,pos==sets-1?cn=-1:pos>0&&(cn=0)):(cn=-1,pos==sets-1?cn=1:pos>0&&(cn=0));var model=new a5.models.interaction.LLElementModel({content:cnt,position:cn,identifier:node.attr("identifier"),parent:this.model,tts_audio:interaction.options.gaptextaudioIsTrue(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()});model.assignAnswerFeedback(node),this.model.elements.push(model)},buildAssociateInteraction:function(interaction,parentNode,node){var interactionIndex=interaction.items.length()-1,self=this,answers=interaction.getCorrectResponse(node.attr("responseIdentifier")).values,answerMap={};if(_.each(answers,function(e){var s=e.split(" ");answerMap[s[0]]=_.tail(s)}),interaction.enumSets={},interaction.options.enumerationAnswersIsCustom()){var enumArray=interaction.options.getEnumerationAnswers().split(",");_(enumArray).each(function(enumeration){var syntax=enumeration.split("*"),k=parseInt(syntax[0],10)-1,v=syntax[1];interaction.enumSets[k]=new a5.models.options.Enumeration(v,'<span class="enum-answers">|</span>'),interaction.enumSets[k].start(-1)},this)}else interaction.options.enumerationAnswersIsFalse()||(interaction.enumSets[0]=interaction.enumAnswers);this.model=new a5.models.interaction.LLModel({sets:interaction.options.linkingLinesSetsIsPairs()?2:interaction.options.linkingLinesSetsIsTriplets()?3:interaction.options.linkingLinesSetsIsQuadruples()?4:5,displayInRows:interaction.options.answerdisplayIsRows(),answers:answerMap,tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),parent:interaction,behaviourIsTouch:interaction.options.linkbehaviourIsTouch(),headings:this._extractGroupHeadings(interaction)}),this.totalElements=node.children("simpleAssociableChoice").length,_.each(this.flip(node.children("simpleAssociableChoice"),this.model.sets),function(e){self.buildSimpleAssociableChoice(interaction,$(e))}),interaction.options.prefillIsFirstitem()&&0==interactionIndex&&this.model.setPrefill(),interaction.options.multipleDestinationsIsOne()||parentNode.addInteractionStyle("multiple-destinations"),interaction.options.randomiseanswersIsTrue()?this.model.shuffleAll():this.model.shuffleRest();var view=new a5.views.interaction.LLView(this.model);parentNode.append(view.render()),interaction.blockItems.add(this.model),this.model=null},flip:function(list,width){for(var result=[],height=list.length/width,x=0;x<width;x++)for(var y=0;y<height;y++)result.push(list[y*width+x]);return result},_extractGroupHeadings:function(interaction){var headings=[];return interaction.options.groupheadingsIsOff()||(headings=a5.utils.splitAndTrim(interaction.options.getGroupheadings(),"*")),headings}},a5.model_builder.Base.extend("a5.model_builder.LLInteraction"),a5.model_builder.builders.push(new a5.model_builder.LLInteraction),a5.model_builder.ISCatchBuilder={catchGames:[],isResponsible:function(node,interaction){return"Identify:Select:Catch"===interaction.identifier&&node.is("choiceInteraction")},buildChoiceInteraction:function(interaction,parentNode,node){_.isUndefined(this.catchGames[interaction.index])&&(this.catchGames[interaction.index]={questions:[],view:void 0});var thisGame=this.catchGames[interaction.index];interaction.bind("reset",function(){this.catchGames[interaction.index].questions=[],this.catchGames[interaction.index].view=void 0},this),parentNode.addClass("is-catch-game-view-container");var targets=node.find("simpleChoice"),responseId=node.attr("responseIdentifier"),correctTargets=interaction.getAllResponseDeclaration()[responseId].values;targets=_.map(targets,_.bind(function(target){return{id:target.getAttribute("identifier"),value:$((new XMLSerializer).serializeToString(target)).html(),isCorrect:correctTargets.indexOf(target.getAttribute("identifier"))>=0}},this)),"true"===interaction.options.getRandomiseanswers().toLowerCase()&&(targets=_.shuffle(targets));var model=new a5.models.interaction.ISCatchQuestionModel({targets:targets,question:node.find("p")[0],substractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()},void 0,interaction);if(thisGame.questions.push(model),thisGame.questions.length>=_.keys(interaction.getAllResponseDeclaration()).length){var game=new a5.models.interaction.ISCatchGameModel({models:thisGame.questions,stageConfiguration:this.getStageConfiguration(interaction),targetsConfiguration:this.getTargetsConfiguration(interaction)},void 0,interaction);interaction.visibleQuestion=0,thisGame.view=new a5.views.interaction.ISCatchView(game,null,interaction),thisGame.view.bind("question_finished",_.bind(function(){interaction.visibleQuestion<game.models.length-1&&(interaction.visibleQuestion++,this.appendToContentBlockDiv(interaction,interaction.visibleQuestion,thisGame.view.node))},this)),this.appendToContentBlockDiv(interaction,interaction.visibleQuestion,thisGame.view.render()),interaction.blockItems.add(game)}},appendToContentBlockDiv:function(interaction,index,node){interaction.$(".contentblock").length>index&&(interaction.$(".contentblock").addClass("contentblock--hidden"),$(interaction.$(".contentblock")[index]).removeClass("contentblock--hidden").find(".is-catch-game-view-container").append(node))},getTargetsConfiguration:function(interaction){var maxItems=parseInt(interaction.options.getMaximumitems(),10);(interaction.options.maximumitemsIsOff()||isNaN(maxItems)||maxItems<=0)&&(maxItems=null);var targetDuration=parseInt(interaction.options.getTargetonscreenduration(),10);(interaction.options.targetonscreendurationIsOff()||isNaN(targetDuration)||targetDuration<=0)&&(targetDuration=null);var targetImage=interaction.options.getTargetimage();(interaction.options.targetimageIsCustom()||_.isEmpty(targetImage))&&(targetImage=null);var selectedTargetImage=interaction.options.getSelectedTargetimage();(interaction.options.selectedTargetimageIsCustom()||_.isEmpty(selectedTargetImage))&&(selectedTargetImage=null);var bkgimage=interaction.options.getBackgroundimage();(interaction.options.backgroundimageIsCustom()||_.isEmpty(bkgimage))&&(bkgimage=null);var targetGeneratorImage=interaction.options.getTargetGeneratorimage();(interaction.options.targetGeneratorimageIsCustom()||_.isEmpty(targetGeneratorImage))&&(targetGeneratorImage=null);var targetGeneratorLocation=interaction.options.getTargetGeneratorlocation(),targetGeneratorOrigin=interaction.options.getOriginoftargets();return(interaction.options.originoftargetsIsDefault()||_.isEmpty(targetGeneratorOrigin))&&(targetGeneratorOrigin=null),{maxItems:maxItems,targetDuration:targetDuration,movementSpeed:interaction.options.getMovementspeed(),targetImage:targetImage,selectedTargetImage:selectedTargetImage,generationSpeed:interaction.options.getGenerationspeed(),targetGeneratorY:targetGeneratorLocation.toLowerCase().indexOf("top")>=0?"top":"bottom",targetGeneratorX:targetGeneratorLocation.toLowerCase().indexOf("left")>=0?"left":"right",targetGeneratorOrigin:targetGeneratorOrigin,targetGeneratorImage:targetGeneratorImage,backgroundImage:bkgimage}},getStageConfiguration:function(interaction){var maxDuration=parseInt(interaction.options.getMaximumduration(),10);return(isNaN(maxDuration)||maxDuration<=0||interaction.options.maximumdurationIsOff())&&(maxDuration=null),{maxDuration:maxDuration,countdownTimer:interaction.options.countdowntimerIsOn()&&null!==maxDuration,scoreboard:interaction.options.scoreboardIsOn(),gameOverMessage:interaction.options.gameOvermessageIsCustom()?null:interaction.options.getGameOvermessage()}}},a5.model_builder.Base.extend("a5.model_builder.ISCatchBuilder"),a5.model_builder.builders.push(new a5.model_builder.ISCatchBuilder),a5.model_builder.LLInteraction={isResponsible:function(node,interaction){return"Identify:Select:Linking multiple lines"==interaction.identifier&&node.is("associateInteraction")},buildAssociateInteraction:function(interaction,parentNode,node){var answers=interaction.getCorrectResponse(node.attr("responseIdentifier")).values;answers=_.map(answers,function(answer){return answer.split(" ")});var model=new a5.models.interaction.LinkingMultipleLines({answers:answers,parent:interaction,tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),behaviourIsTouch:interaction.options.linkbehaviourIsTouch(),displayInRows:interaction.options.answerdisplayIsRows()}),view=new a5.views.interaction.LinkingMultipleLines(model);_.each(node.children("simpleAssociableChoice"),function(e){var $e=$(e),content=this.buildContents($e,interaction);view.append($e.attr("matchGroup"),$e.attr("identifier"),!1,content)},this),interaction.options.prefillIsFirstitem()?model.prefillFirstLine():interaction.options.prefillIsFirstblock()&&(model.prefillFirstItem(),view.children[0].children[0].prefilled=!0),view.appendHandles(),"true"==node.attr("shuffle")?view.shuffle():view.shuffleRest(),parentNode.append(view.render()),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.LLInteraction"),a5.model_builder.builders.push(new a5.model_builder.LLInteraction),a5.model_builder.ShuffleBuilder={isResponsible:function(node,interaction){return node.is("orderInteraction")&&"Order:Sequence:Sequence"===interaction.identifier},buildOrderInteraction:function(interaction,parentNode,node){var firstBlock=interaction.items.length()-1==0,tryAgainIsFrozen=interaction.options.tryAgainIsFrozen(),alignment=interaction.options.getDragAlignment(),correctFeedback=interaction.options.getFeedbackCorrect(),incorrectFeedback=interaction.options.getFeedbackIncorrect(),prefillFirstBlock=interaction.options.prefillIsFirstblock(),prefillFirstItem=interaction.options.prefillIsFirstitem(),gapFillBehaviourTapSwap=interaction.options.gapfillbehaviourIsTap_swap(),gaptextaudio=interaction.options.gaptextaudioIsTrue(),capitalize=interaction.options.automaticcapitalisationIsOn(),horizontal=interaction.options.dragAlignmentIsHorizontal()||interaction.options.dragAlignmentIsHorizontal_single_word(),clickclick=interaction.options.useClickClickIsTrue(),dropIndicator=interaction.options.dropIndicatorIsTrue(),responses=interaction.getCorrectResponse(node.attr("responseIdentifier")).values;responses=_.map(responses,function(e){return e.split(" ")});var model=new a5.models.interaction.ShuffleModel({correct:responses,alignment:alignment,tryAgainIsFrozen:tryAgainIsFrozen,interaction:interaction});_.each(node.children("simpleChoice"),function(e,index){var $e=$(e),$contents=this.buildContents($e,interaction),text=$contents.html();a5.utils.wrapFirstLetter($contents);var element=new a5.models.interaction.ShuffleElement({parent:model,text:text,content:$contents,identifier:$e.attr("identifier"),fixed:"true"==$e.attr("fixed"),alignment:alignment,correctFeedback:correctFeedback,incorrectFeedback:incorrectFeedback,tryAgainIsFrozen:tryAgainIsFrozen});element.assignAnswerFeedback($e),firstBlock&&(prefillFirstBlock||prefillFirstItem&&0===index)&&(element.fixed=!0,element.prefilled=!0),model.push(element)},this),model.shuffle();var className="OSSequenceView";gapFillBehaviourTapSwap&&(className+="Swap");var view=new a5.views.interaction[className](model,horizontal,clickclick,dropIndicator,gaptextaudio,capitalize);parentNode.addInteractionStyle("drag-drop"),parentNode.replaceWith($("<p></p>").append(view.render())),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.ShuffleBuilder"),a5.model_builder.builders.push(new a5.model_builder.ShuffleBuilder),a5.model_builder.OSBoxDropBuilder={isResponsible:function(node,interaction){return"Order:Sort:Box drop"===interaction.identifier&&node.is("matchInteraction")},buildMatchInteraction:function(interaction,parentNode,node){var targets=_.filter(node.find("simpleAssociableChoice"),function(choice){return a5.utils.startsWith($(choice).attr("identifier"),"T")}),choices=_.filter(node.find("simpleAssociableChoice"),function(choice){return a5.utils.startsWith($(choice).attr("identifier"),"C")});choices=_.shuffle(choices);var responses=_.flatten(_.map(interaction.getAllResponseDeclaration(),function(rD){return rD.values}));responses=_.object(_.map(responses,function(response){return response.split(" ").reverse()}));var model=new a5.models.interaction.OSBoxDropModel({targets:targets,choices:choices,response:responses},void 0,interaction);interaction.bind("boxdrop",function(){model.dropChoice()}),interaction.bind("pause-boxdrop",function(){model.stopped?model.startCategoriesMovement():model.stopCategoriesMovement()});var view=new a5.views.interaction.OSBoxDropView(model);parentNode.append(view.render()),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.OSBoxDropBuilder"),a5.model_builder.builders.push(new a5.model_builder.OSBoxDropBuilder),a5.model_builder.ICCrossword={isResponsible:function(node,interaction){return!a5.service.reactEngineInterface.isActivityReact(interaction.identifier)&&"Input:Completion:Crossword"===interaction.identifier&&(node.is("orderInteraction")||node.is("simpleChoice"))},buildOrderInteraction:function(interaction,parentNode,node){var model=new a5.model.interaction.ICCrossword({parent:interaction,tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),cluesInColumns:interaction.options.cluesincolumnsIsOn()}),XML=$.parseXML(node.find("prompt").text());_.each($(XML).find("hint"),function(hint,index){var wordModel=new a5.model.interaction.ICCrosswordWord({x:$(hint).parent().prevAll().length,y:$(hint).parent().parent().prevAll().length,word:$(hint).attr("word"),align:"2"==$(hint).attr("align")?"vertical":"horizontal",parent:model,prefilled:!interaction.options.prefillIsFalse()&&0==index,correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn()});model.addWord(wordModel)}),model.initializeWords(),this.model=model,this.buildContents(node,interaction);var view=new a5.view.interaction.ICCrossword(model,null,interaction.options.caseIsUpper(),interaction.options.getClueposition());parentNode.append(view.node),view.render(),interaction.blockItems.add(model),this.model=null},buildSimpleChoice:function(interaction,parentNode,node){var word=this.model.findWord(node.attr("identifier"));word&&(word.content=this.buildContents(node,interaction))}},a5.model_builder.Base.extend("a5.model_builder.ICCrossword"),a5.model_builder.builders.push(new a5.model_builder.ICCrossword),a5.model_builder.ICCrosswordReact={isResponsible:function(node,interaction){return a5.service.reactEngineInterface.isActivityReact(interaction.identifier)&&"Input:Completion:Crossword"===interaction.identifier&&(node.is("orderInteraction")||node.is("simpleChoice"))},buildOrderInteraction:function(interaction,parentNode,node){var XML=$.parseXML(node.find("prompt").text()),clueNodes=node.find("simpleChoice"),wordsObject=this._xmlToWords($(XML).find("hint"),clueNodes,interaction);this.htmlContents={},this.buildContents(node,interaction);var blockItem=new a5.models.interaction.ReactItem(interaction.blockItems.length(),{words:this.processWords(wordsObject.words,this.htmlContents),cells:wordsObject.cells,rowSize:wordsObject.maxX,colSize:wordsObject.maxY},wordsObject.solution,[],interaction.id,"iccrossword");interaction.blockItems.add(blockItem),this.htmlContents={};var reactViewParent=$("<div id="+blockItem.activityId+" />");parentNode.append(reactViewParent),a5.service.reactEngineInterface.renderElement(a5.service.React.components.activities.iccrossword.ICCrossword,{activityId:blockItem.activityId},reactViewParent[0])},processWords:function(words,contents){return _.map(words,function(w){var content=contents[w.word];return content&&(w.clue=content),delete w.word,w})},buildSimpleChoice:function(interaction,parentNode,node){var word=node.attr("identifier"),prevAudioEvents=a5.model_builder.Audio.documentEvents;a5.model_builder.Audio.documentEvents=!0;var content=this.buildContents(node,interaction);a5.model_builder.Audio.documentEvents=prevAudioEvents,this.htmlContents[word]=content.html().trim()},_xmlToWords:function(nodes,clueNodes,interaction){var minX=null,minY=null,maxX=0,maxY=0,cells=[],solutionCells=[],words=_.chain(nodes).map(function(hint,index){var prefilled=0===index&&!interaction.options.prefillIsFalse(),word=$(hint).attr("word");return{x:$(hint).parent().prevAll().length,y:$(hint).parent().parent().prevAll().length,word:word,align:"2"==$(hint).attr("align")?"v":"h",index:index,prefilled:prefilled}}).each(function(w){minY=null!==minY?Math.min(minY,w.y):w.y,minX=null!==minX?Math.min(minX,w.x):w.x,maxX=Math.max(maxX,"h"===w.align?w.x+w.word.length:w.x+1),maxY=Math.max(maxY,"v"===w.align?w.y+w.word.length:w.y+1)}).map(function(w){return w.x-=minX,w.y-=minY,w}).value();maxX-=minX,maxY-=minY;var label=1;return _.each(words,function(w){var chars=Array.from(w.word);w.cells=_.map(chars,function(char,index){var x="h"===w.align?w.x+index:w.x,y="v"===w.align?w.y+index:w.y,cell=_.findWhere(cells,{x:x,y:y});if(cell)return 0===index&&(words[cell.words[0]].cells[0]===cell?w.label=words[cell.words[0]].label:w.label=label++),cell.words.push(w.index),cell;0===index&&(w.label=label++),cell={x:x,y:y,value:char,words:[w.index]},solutionCells.push(cell);var cellOb=_.extend({},cell);return delete cellOb.value,cells.push(cellOb),cellOb})}),{solution:solutionCells,words:words,cells:cells,maxX:maxX,maxY:maxY}}},a5.model_builder.Base.extend("a5.model_builder.ICCrosswordReact"),a5.model_builder.builders.push(new a5.model_builder.ICCrosswordReact),a5.model_builder.TextWordSnake={isResponsible:function(node,interaction){return"Identify:Mark:Wordsnake"==interaction.identifier&&3==node[0].nodeType&&node.closest("#content").length>0},build:function(interaction,parent,node){void 0===interaction.t&&(interaction.t=""),interaction.t+=$.trim(node.text())}},a5.model_builder.WordSnake={isResponsible:function(node,interaction){var isResponsible=node.is("textEntryInteraction")&&"Identify:Mark:Wordsnake"==interaction.identifier;return isResponsible&&1==interaction.clean&&(interaction.words=[],interaction.t="",interaction.selections=[],interaction.answers={},interaction.clean=!1),isResponsible},build:function(interaction,parentNode,node){var model=new a5.models.item.interaction.WordSnake({interaction:interaction,responseIdentifier:node.attr("responseIdentifier")});interaction.words=interaction.words||[],_.isUndefined(interaction.t)&&(interaction.t=""),interaction.selections=interaction.selections||[],interaction.answers=interaction.answers||{};var correctResponse=interaction.getCorrectResponse(model.responseIdentifier),word=$.trim(correctResponse.values[0]);if(interaction.words.push([word,interaction.t.length]),interaction.t+=word,interaction.answers[model.responseIdentifier]=word,!interaction.firstCall){var view=new a5.views.interaction.Wordsnake(model);parentNode.parent().prepend(view.render()),interaction.blockItems.add(model),interaction.firstCall=!0}}},Obj.extend("a5.model_builder.TextWordSnake",a5.model_builder.TextWordSnake),Obj.extend("a5.model_builder.WordSnake",a5.model_builder.WordSnake),a5.model_builder.builders.push(new a5.model_builder.TextWordSnake),a5.model_builder.builders.push(new a5.model_builder.WordSnake),a5.model_builder.Colouring={isResponsible:function(node,interaction){return"Identify:Mark:Colouring"===interaction.identifier&&(node.is("gapMatchInteraction")||node.is("gap")||node.is("img"))},buildGap:function(interaction,parentNode,node){},buildImg:function(interaction,parentNode,node){if(!this.isBuildingGapMatchInteraction)return void(new a5.model_builder.Img).build(interaction,parentNode,node);var styles=node.attr("style")||"",size={width:parseFloat(a5.utils.getStyleValue(styles,"width")),height:parseFloat(a5.utils.getStyleValue(styles,"height"))};(new a5.model_builder.Img).build(interaction,parentNode,node),this.model.setImageSize(size),this.view.setImage()},buildGapMatchInteraction:function(interaction,parentNode,node){if(this.isBuildingGapMatchInteraction)throw"cannot nest gapMatchInteractions";this.isBuildingGapMatchInteraction=!0;var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")),answers={};_.each(correctResponse.values,function(response){var responseArray=response.split(" ");_.each(responseArray.slice(1),function(item){answers[item]=responseArray[0]})}),this.model=new a5.models.item.interaction.Colouring({interaction:interaction,tryAgainKeep:interaction.options.tryAgainIsKeepall(),answers:answers,maxOpacity:a5.dp.config.colouringOpacity,poolAlign:interaction.options.getPoolAlignment(),subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()}),interaction.blockItems.add(this.model),this.view=new a5.views.interaction.ColouringView(this.model),parentNode.append(this.view.node),node.find("gap").each(function(j,gap){gap=$(gap);var idAttr=gap.attr("id")||"";if(a5.utils.startsWith(idAttr,"dis")){var colourModel=new a5.models.item.interaction.ColouringInteractionColour({identifier:gap.attr("identifier"),label:gap.attr("label"),idAttr:idAttr,color:$("<div/>").css("background-color",gap.attr("style")).css("background-color")});this.model.addDistractorColour(colourModel)}}.bind(this)),node.contents().each(function(i,el){if($(el).is("gapText")){var gapText=$(el);if(!_.find(correctResponse.values,function(item){return item.indexOf(gapText.attr("identifier"))>-1})){var child=new a5.models.item.interaction.ColouringInteractionGapText({identifier:gapText.attr("identifier"),label:"",areas:gapText.text(),correctColor:null,parent:this.model,distractor:!0});this.model.addItem(child.identifier,child)}else node.find("gap").each(function(j,gap){gap=$(gap);var ident=gapText.attr("identifier")+" "+gap.attr("identifier");if(_.include(correctResponse.values,ident)){var child=new a5.models.item.interaction.ColouringInteractionGapText({identifier:gap.attr("identifier"),label:gap.attr("label"),areas:gapText.text(),correctColor:$("<div/>").css("background-color",gapText.attr("style")).css("background-color"),prefilled:0==j&&interaction.options.prefillIsFirstitem(),parent:this.model});this.model.addItem(child.identifier,child)}}.bind(this))}else $(el).is("gap")||interaction.buildModel(this.view.contentBlock,$(el))}.bind(this)),this.view.render(),parentNode.addClass("toolbar"),this.isBuildingGapMatchInteraction=!1}},a5.model_builder.Base.extend("a5.model_builder.Colouring"),a5.model_builder.builders.push(new a5.model_builder.Colouring),a5.model_builder.ISRadiobuttonBuilder={views:[],isResponsible:function(node,interaction){return node.is("choiceInteraction")&&"Identify:Select:Radiobutton"==interaction.identifier},buildChoiceInteraction:function(interaction,parentNode,node){var shuffle,view,label="",answers=[],showInColumns=interaction.options.showInColumnsIsTrue(),response=$(node).attr("responseIdentifier").replace("RESPONSE",""),isFirstChoiceInteraction=0==parseInt(response,10),randomizeAnswers=interaction.options.randomiseanswersIsTrue(),correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")).values,isFirstBlock=1===interaction.items.length(),isFirstItem=isFirstBlock&&0===interaction.blockItems.length(),hasItemsRef=interaction.options.orderDependencyIsFirst_answer()||!interaction.options.questiondisplayIsAll(),prefilled=isFirstBlock&&interaction.options.prefillIsFirstblock()||isFirstItem&&interaction.options.prefillIsFirstitem(),isFirstInteractive=!prefilled&&(!this.views.length||_.last(this.views).model.prefilled),isOpened=interaction.options.questiondisplayIsAll()||prefilled||isFirstInteractive||isFirstBlock,model=new a5.models.interaction.ISRadiobuttonModel({alignment:interaction.options.getChoiceAlignment(),prefilled:prefilled,tryAgainKeep:interaction.options.tryAgainIsKeepall(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),gaptextaudio:interaction.options.gaptextaudioIsTrue(),orderDependency:interaction.options.orderDependencyIsFirst_answer(),display:interaction.options.getQuestiondisplay(),blockId:interaction.items.length()-1,attempts:interaction.checkAttempts,tryAgainIsClear:interaction.options.tryAgainIsClear()});interaction.blockItems.add(model),showInColumns&&(shuffle=!1,correctResponse=_.filter(correctResponse,function(e){return!a5.utils.endsWith(e,"_0")})),_.each(this.fetchChoices(interaction,node,"simpleChoice",shuffle),function(e,index){var enumeration,$content=this.buildContents(e,interaction);if(showInColumns&&a5.utils.endsWith($(e).attr("identifier"),"_0"))label=$content.prepend('<span class="enum-placeholder"></span>'),interaction.enumAnswers.next().then(function(enumSymbol){$content.find(".enum-placeholder").replaceWith(enumSymbol)});else{showInColumns||interaction.options.enumerationinternalIsCorrect()||(enumeration=interaction.enumAnswers.next());var choiceModel=new a5.models.interaction.ISRadiobuttonChoiceModel({content:$content,parent:model,interaction:interaction,hasRadiobutton:!interaction.options.hideRadiobuttonsIsTrue(),enumeration:enumeration,tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),correct:_.contains(correctResponse,$(e).attr("identifier")),value:$(e).attr("identifier"),label:label});choiceModel.assignAnswerFeedback($(e)),model.add(choiceModel),answers.push($content),_.contains(correctResponse,choiceModel.value)&&(model.correct=choiceModel)}},this),showInColumns&&isFirstChoiceInteraction&&(this.header_node=new a5.views.interaction.ISRadiobuttonHeader(answers).render());var autoOpenFeedback=a5.dp.config.specificFeedbackAuto;if(view=interaction.options.questiondisplayIsActive()?new a5.views.interaction.ISRadiobuttonViewDisplayActive(model,parentNode,isFirstInteractive,isFirstChoiceInteraction,autoOpenFeedback,interaction.options.hideCheckboxesIsTrue(),showInColumns,label,interaction):interaction.options.questiondisplayIsAll()?new a5.views.interaction.ISRadiobuttonViewDisplayAll(model,parentNode,isFirstInteractive,isOpened,autoOpenFeedback,interaction.options.hideCheckboxesIsTrue(),showInColumns,label,interaction):new a5.views.interaction.ISRadiobuttonViewDefault(model,parentNode,isFirstInteractive,isOpened,autoOpenFeedback,interaction.options.hideCheckboxesIsTrue(),showInColumns,label,interaction),this.views.push(view),node.is(_.last(interaction.xml.querySelectorAll("choiceInteraction")))){if(hasItemsRef){var filteredViews=_.reject(this.views,function(view){return view.model.prefilled}),models=_.pluck(filteredViews,"model");_.each(filteredViews,function(view,index){view.model.blockItems=models,view.model.questionIndex=index,view.addSiblingsListeners()})}this.views=[]}interaction.bind("reset",function(){this.views=[]},this,{once:!0}),this._appendToDOM(view.render(),parentNode,randomizeAnswers&&showInColumns),interaction.options.questiondisplayIsActive()&&parentNode.addClass("expandableQuestion__content"),showInColumns&&parentNode.prepend(this.header_node),"Exam"!==LOInfo.mode&&"Trainer"!==LOInfo.mode||interaction.bind("show update-status-to-answers update-status-to-corrected",_.bind(function(){("Exam"===LOInfo.mode&&"corrected"===interaction.getStatus()||"answers"===interaction.getStatus())&&view.showFirstAnswerFeedback()},this))},_appendToDOM:function($node,parentNode,random){var len=parentNode.find(".choice_interaction").length;random&&len?this._insertRandom($node,parentNode,len):parentNode.append($node)},_insertRandom:function($node,parentNode,len){if(len){var index=Math.floor(Math.random()*len);Boolean(Math.floor(2*Math.random()))?$node.insertBefore(parentNode.find(".choice_interaction:eq("+index+")")):$node.insertAfter(parentNode.find(".choice_interaction:eq("+index+")"))}}},a5.model_builder.Base.extend("a5.model_builder.ISRadiobuttonBuilder"),a5.model_builder.builders.push(new a5.model_builder.ISRadiobuttonBuilder),a5.model_builder.ISRadiobuttonColumnsBuilder={isResponsible:function(node,interaction){return node.is("choiceInteraction")&&"Identify:Select:Radiobutton columns"==interaction.identifier},buildChoiceInteraction:function(interaction,parentNode,node){var enumeration,self=this,label="",answers=[],model=new a5.models.interaction.ISRadiobuttonModel({alignment:interaction.options.getChoiceAlignment(),prefilled:(interaction.options.prefillIsFirstblock()||interaction.options.prefillIsFirstitem())&&0==interaction.blockItems.length(),correctFeedback:interaction.options.getFeedbackCorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),incorrectFeedback:interaction.options.getFeedbackIncorrect()}),correctResponse=_.filter(interaction.getCorrectResponse(node.attr("responseIdentifier")).values,function(e){return!a5.utils.endsWith(e,"_0")});_.each(this.fetchChoices(interaction,node,"simpleChoice",!1),function(e,index){if(a5.utils.endsWith($(e).attr("identifier"),"_0"))enumeration=interaction.enumAnswers.next(),label=enumeration.then(function(enumSymbol){return(interaction.enumAnswers.useEnum()?'<span class="enum">'+enumSymbol+"</span>":"")+$(e).text()});else{var choiceModel=new a5.models.interaction.ISRadiobuttonChoiceModel({content:self.buildContents(e,interaction),parent:model,interaction:interaction,hasRadiobutton:!interaction.options.hideRadiobuttonsIsTrue(),radiobuttonIsCustom:interaction.options.hideRadiobuttonsIsCustom(),correct:_.contains(correctResponse,$(e).attr("identifier")),value:$(e).attr("identifier"),label:label});choiceModel.assignAnswerFeedback($(e)),model.add(choiceModel),answers.push($(e).text()),_.contains(correctResponse,choiceModel.value)&&(model.correct=choiceModel)}});var responses=node.parent().find("choiceInteraction").length;parseInt($(node).attr("responseIdentifier").replace("RESPONSE",""),10)%responses==0&&parentNode.append(new a5.views.interaction.ISRadiobuttonColumnsHeader(answers).render());var view=new a5.views.interaction.ISRadiobuttonColumnsView(model,model.prefilled,interaction.options.hideCheckboxesIsTrue(),label,enumeration),rendered=view.render();parentNode.append(rendered),0==interaction.blockItems.length()&&interaction.bind("show:deferred",function(){rendered.focus()}),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.ISRadiobuttonColumnsBuilder"),a5.model_builder.builders.push(new a5.model_builder.ISRadiobuttonColumnsBuilder),a5.model_builder.ISRadioDynamic={isResponsible:function(node,interaction){return node.is("dynamicRadio")},build:function(interaction,parentNode,node){var answersWithModel={items:[]};interaction.bind("show",_.bind(function(){parentNode.empty(),interaction.blockItems.itemList=[],this._build(interaction,parentNode,node,answersWithModel)},this))},_build:function(interaction,parentNode,node,answersWithModel){var screenNum=parseInt(node.attr("screen"),10)-1,answerNum=parseInt(node.attr("id"),10)-1,columns=node.attr("columns").split(",");this.header_node=new a5.views.interaction.ISRadiobuttonHeader(columns).render();var parent_interaction=a5.mainBuilder.intList[screenNum],answers=_.filter(parent_interaction.blockItems.itemList,function(item){return item.selected&&item.selected.value==item.choices[answerNum].value});answersWithModel.items=_(answersWithModel.items).filter(function(item){return _(answers).contains(item.answer)}),parentNode.append(this.header_node);var tempAnswersWithModel=[]
;_.each(answers,function(answer){var model,last=_(answersWithModel.items).find(function(item){return item.answer==answer}),label=answer.correct.label.clone();last?model=last.model:(model=new a5.models.interaction.ISRadiobuttonModel({alignment:parent_interaction.options.getChoiceAlignment(),prefilled:(parent_interaction.options.prefillIsFirstblock()||parent_interaction.options.prefillIsFirstitem())&&1==parent_interaction.items.length()}),_.each(columns,function(column,i){var choiceModel=new a5.models.interaction.ISRadiobuttonChoiceModel({content:$("<div>"),parent:model,interaction:interaction,hasRadiobutton:!parent_interaction.options.hideRadiobuttonsIsTrue(),enumeration:interaction.enumAnswers.next(),value:i.toString(),label:label});model.add(choiceModel)})),tempAnswersWithModel.push({answer:answer,model:model});var view=new a5.views.interaction.ISRadiobuttonView(model,answer.prefilled,parent_interaction.options.hideCheckboxesIsTrue(),parent_interaction.options.showInColumnsIsTrue(),label);parentNode.append(view.render()),interaction.blockItems.add(model)},this),answersWithModel.items=tempAnswersWithModel}},a5.model_builder.Base.extend("a5.model_builder.ISRadioDynamic"),a5.model_builder.builders.push(new a5.model_builder.ISRadioDynamic),a5.model_builder.ISCheckboxDynamic={isResponsible:function(node,interaction){return node.is("dynamicCheckbox")},build:function(interaction,parentNode,node){var answersWithModel={items:[]};interaction.bind("show",_.bind(function(){parentNode.empty(),interaction.blockItems.itemList=[],this._build(interaction,parentNode,node,answersWithModel)},this))},_build:function(interaction,parentNode,node,answersWithModel){var screenNum=parseInt(node.attr("screen"),10)-1,answerNum=parseInt(node.attr("id"),10)-1,columns=node.attr("columns").split(",");this.header_node=new a5.views.interaction.ISCheckboxHeader(columns).render();var parent_interaction=a5.mainBuilder.intList[screenNum],answers=_.filter(parent_interaction.blockItems.itemList,function(item){return item.choices[answerNum]&&item.choices[answerNum].selected});answersWithModel.items=_(answersWithModel.items).filter(function(item){return _(answers).contains(item.answer)}),parentNode.append(this.header_node);var tempAnswersWithModel=[];_.each(answers,function(answer){var model,last=_(answersWithModel.items).find(function(item){return item.answer==answer}),label=answer.choices[answerNum].label.clone();last?model=last.model:(model=new a5.models.interaction.ISCheckboxModel({alignment:parent_interaction.options.getChoiceAlignment()}),_.each(columns,function(column,i){var choiceModel=new a5.models.interaction.ISCheckboxChoiceModel({content:$("<div>"),parent:model,interaction:interaction,hasCheckbox:!parent_interaction.options.hideCheckboxesIsTrue(),enumeration:interaction.enumAnswers.next(),value:i.toString(),correct:!0,label:label});model.add(choiceModel)})),tempAnswersWithModel.push({answer:answer,model:model});var view=new a5.views.interaction.ISCheckboxView(model,!1,parent_interaction.options.hideCheckboxesIsTrue(),parent_interaction.options.showInColumnsIsTrue(),label);parentNode.append(view.render()),interaction.blockItems.add(model)},this),answersWithModel.items=tempAnswersWithModel}},a5.model_builder.Base.extend("a5.model_builder.ISCheckboxDynamic"),a5.model_builder.builders.push(new a5.model_builder.ISCheckboxDynamic),a5.model_builder.TargetGame={isResponsible:function(node,interaction){return node.is("choiceInteraction")&&"Identify:Select:Target game"==interaction.identifier},build:function(interaction,parentNode,node){var self=this;void 0===interaction.steps&&(interaction.steps=-1),interaction.steps++,interaction.curstep=0,this.interaction=interaction,parentNode.parent().addClass("tgm"),parentNode.parent().addClass("tgm_"+interaction.steps),this.correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")),_.each(_.shuffle($(node).find("simpleChoice")),function(n,index){var card=new a5.models.item.interaction.TargetGame(node),view=new a5.views.interaction.TargetGameView(n,index,self,interaction);card.isCorrect=view.isCorrect(),card.dom=$(view.render()),parentNode.append(view.render()),interaction.blockItems.add(card)}),setTimeout(function(){$(".tgm").hide(),$(".tgm_0").show(),$(".tgm").css("padding-left","10px")},100),interaction.firstCall||(interaction.firstCall=!0,interaction.onInteractionReadyListeners.register(this.attachEvents.bindTo(this)))},attachEvents:function(){var self=this;$(".tgm .click").on("click",function(){window.a5.mainBuilder.curInteraction.interactionDone||($(this).hasClass("click_correct")?$(this).addClass("clicked_correct tada").delay(1500).queue(function(next){self.interaction.curstep<self.interaction.steps&&$(".tgm_"+self.interaction.curstep).addClass("animated fadeOutDownBig").delay(500).queue(function(){$(".tgm").hide(),self.interaction.curstep++,$(".tgm_"+self.interaction.curstep).show(),$(".tgm_"+self.interaction.curstep).addClass("animated fadeIn"),next()})}):$(this).addClass("clicked_incorrect flap"))})}},Obj.extend("a5.model_builder.TargetGame",a5.model_builder.TargetGame),a5.model_builder.builders.push(new a5.model_builder.TargetGame),a5.model_builder.ISRadiobuttonVoiceBuilder={isResponsible:function(node,interaction){return(node.is("choiceInteraction")||a5.utils.hasId(node,"content"))&&"Identify:Select:Radiobutton voice"===interaction.identifier},buildDiv:function(interaction,parentNode,node){if(interaction.options.displayRecordingTestIsOn()){var dialog=a5.view.dialog.SpeakingRecordingTest.getInstance();dialog.render(),dialog.autoOpen(interaction)}this._super(interaction,parentNode,node)},buildChoiceInteraction:function(interaction,parentNode,node){var timelimit,correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")).values,isFirstBlock=1===interaction.items.length(),isFirstItem=isFirstBlock&&0===interaction.blockItems.length(),data=node.attr("data-author");try{timelimit=JSON.parse(data).timelimit}catch(e){}var model=new a5.models.interaction.ISRadiobuttonVoice({interaction:interaction,prefilled:isFirstBlock&&interaction.options.prefillIsFirstblock()||isFirstItem&&interaction.options.prefillIsFirstitem(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),correctFeedback:interaction.options.getFeedbackCorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),timelimit:timelimit});_.each(this.fetchChoices(interaction,node,"simpleChoice"),function(choice,index){var $choice=$(choice),choiceModel=new a5.models.interaction.ISRadiobuttonVoiceChoiceModel({content:$choice.clone(),text:$choice.text().trim(),parent:model,interaction:interaction,correct:_.contains(correctResponse,$choice.attr("identifier")),value:$choice.attr("identifier"),enumeration:interaction.enumAnswers.next()});choiceModel.assignAnswerFeedback($choice),model.addChoice(choiceModel)},this);interaction.blockItems.add(model);var view=new a5.views.interaction.ISRadiobuttonVoice(model);parentNode.append(view.node),view.render()}},a5.model_builder.Content.extend("a5.model_builder.ISRadiobuttonVoiceBuilder"),a5.model_builder.builders.push(new a5.model_builder.ISRadiobuttonVoiceBuilder),Obj.extend("a5.components.header_media.HeaderMediaBuilder",{HEADERMEDIA_SELECTOR:".headerMedia",seen:function(mediaID,pages){if(this.map=this.map||{},this.map[mediaID]=this.map[mediaID]||{},this.map[mediaID][pages])return!0;this.map[mediaID][pages]=!0},_displayedIn:function(currentInteraction,parentInteraction,pages){return _.isNumber(pages)?currentInteraction.index>=parentInteraction.index&&currentInteraction.index<parentInteraction.index+pages:_.some(pages.split(","),function(page){var range=page.split("-");return 1===range.length?parseInt(range[0],10)===currentInteraction.visibleIndex:parseInt(range[0],10)<=currentInteraction.visibleIndex&&currentInteraction.visibleIndex<=parseInt(range[1],10)})},_attachNode:function(interaction,parentNode,node){var $found=interaction.contentWrap.find(this.HEADERMEDIA_SELECTOR);$found.length||($found=$(this.HEADERMEDIA_SELECTOR)),$found.length||($found=parentNode),node.appendTo($found)}}),a5.components.header_media.HeaderMediaBuilder.extend("a5.components.header_media.HeaderAudioBuilder",{isResponsible:function(node,interaction){return node.is("div#headerAudio")},build:function(interaction,parentNode,node){var data=$.parseJSON(node.attr("data-author"));if(!this.seen(data.mediaID,data.pages)){var $headerAudioContainer=$('<div class="headerAudio headerAudio_'+interaction.index+'"></div>'),playing=null,playedFully=!1;this._attachNode(interaction,parentNode,$headerAudioContainer);var $html=$(window.a5.mainBuilder.layout.getTemplate("audio_widget")),$inlineTranscript=$(window.a5.mainBuilder.layout.getTemplate("media_transcript"));$html.attr("style",node.attr("style")),$html.css("height",""),$html.find(".transcript_button").data("isAudio",!0),$html.find(".the_audio").hide(),$html.toggleClass("with-speed",interaction.options.audiospeedIsOn()),$headerAudioContainer.append($inlineTranscript.length?$('<div class="transcript-wrap audio">').append($html).append($inlineTranscript):$html),$headerAudioContainer.hide(),a5.service.media.audio.bind("ready",function(){playing=a5.service.media.audio.create(data.mediaID,{dontStop:!0,preload:!a5.dp.config.audioPreloadDisabled,persistVolume:a5.dp.config.audioVolumeStore}),$html.attr("data-playable-media",playing.uid),a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(playing),playing.bind("stopped",function(){playedFully=!0}),a5.model_builder.audioVideoUtils.addAudioPlayerEvents(playing,$html),a5.model_builder.audioVideoUtils.linkSubtitles(data.mediaID,interaction,$html,playing),a5.model_builder.audioVideoUtils.linkTranscript(data.mediaID,interaction,$html,playing,$inlineTranscript),a5.model_builder.audioVideoUtils.linkKaraoke(data.mediaID,interaction,$html,playing)});var self=this,updateAudioWhenReady=function(currentInteraction){playing?updateAudio(currentInteraction):_.delay(_.bind(updateAudioWhenReady,this,currentInteraction),10)},updateRubricWithAudioWhenReady=function(currentInteraction){playing?updateRubricWithAudio(currentInteraction):_.delay(_.bind(updateRubricWithAudioWhenReady,this,currentInteraction),10)},updateAudio=function(currentInteraction){self._displayedIn(currentInteraction,interaction,data.pages)?("Exam"==LOInfo.mode&&"input"==currentInteraction.getStatus()&&(playedFully||playing.isPlaying()||playing.play()),self._attachNode(currentInteraction,parentNode,$headerAudioContainer),$headerAudioContainer.show()):(playing.isPlaying()&&playing.pause(),$headerAudioContainer.hide()),$("body").toggleClass("body--headerAudio",!!currentInteraction.hasHeaderAudio)},updateRubricWithAudio=function(currentInteraction){self._displayedIn(currentInteraction,interaction,data.pages)&&(currentInteraction.hasHeaderAudio=!0,currentInteraction.rubricZone.addClass("withHeaderAudio")),currentInteraction!==interaction&&a5.model_builder.audioVideoUtils.linkKaraoke(data.mediaID,currentInteraction,$html,playing)};a5.callbacks.interaction.bind("loaded",updateRubricWithAudioWhenReady),a5.callbacks.interaction.bind("showed",updateAudioWhenReady),updateAudioWhenReady(a5.mainBuilder.curInteraction)}}}),a5.model_builder.builders.push(new a5.components.header_media.HeaderAudioBuilder),a5.components.header_media.HeaderMediaBuilder.extend("a5.components.header_media.HeaderVideoBuilder",{isResponsible:function(node,interaction){return node.is("div#headerVideo")},build:function(interaction,parentNode,node){var data=$.parseJSON(node.attr("data-author"));if(!this.seen(data.mediaID,data.pages)){var $headerVideoContainer=$('<div class="headerVideo headerVideo_'+interaction.index+'"></div>'),playing=null;this._attachNode(interaction,parentNode,$headerVideoContainer);var object=$("<object>");object.attr("type","video/video"),object.attr("id",data.ID),object.attr("startingtime",data.startingtime),data.autoplay&&"false"!=data.autoplay&&object.attr("autoplay",data.autoplay),object.attr("dontstop","true"),object.attr("style",data.style),object.css("width",data.width),object.css("height",data.height);var poster=data.poster&&data.poster.match(/S3_.+?\./);poster&&poster[0]?object.attr("poster",poster[0].replace(".","")):object.attr("poster",data.poster);var source=data.mediaID.match(/S3_.+?\./);source&&source[0]?(source=source[0].replace(".",""),object.attr("data",source)):object.attr("data",data.mediaID),interaction.buildModel($headerVideoContainer,object),object.remove(),interaction.onInteractionReadyListeners.register(function(){a5.service.media.video.bind("ready",function(){playing=a5.service.media.by_id[$headerVideoContainer.find("[data-playable-media]").attr("data-playable-media")]})});var self=this,updateVideoWhenReady=function(currentInteraction){playing?updateVideo(currentInteraction):_.delay(_.bind(updateVideoWhenReady,this,currentInteraction),10)},updateVideo=function(currentInteraction){self._displayedIn(currentInteraction,interaction,data.pages)?(self._attachNode(currentInteraction,parentNode,$headerVideoContainer),$headerVideoContainer.show()):(playing.isPlaying()&&playing.pause(),$headerVideoContainer.hide()),$("body").toggleClass("body--headerVideo",!!currentInteraction.hasHeaderVideo)},addClasses=function(currentInteraction){self._displayedIn(currentInteraction,interaction,data.pages)&&(currentInteraction.hasHeaderVideo=!0)};a5.callbacks.interaction.bind("loaded",addClasses),a5.callbacks.interaction.bind("showed",updateVideoWhenReady),updateVideoWhenReady(a5.mainBuilder.curInteraction)}}}),a5.model_builder.builders.push(new a5.components.header_media.HeaderVideoBuilder),a5.model_builder.audioVideoUtils={},a5.model_builder.audioVideoUtils.closeTranscripts=function(transcripts){_.each(transcripts,function($transcript){$transcript.dialog("instance")?$transcript.dialog("close"):$transcript.find(".close").trigger("click")})},a5.model_builder.audioVideoUtils.linkTranscript=function(id_or_$node,interaction,$html,player,$inlineTranscript){var $node="string"==typeof id_or_$node?$(interaction.xml).find("#transcript #"+a5.utils.jquerySelectorEscape(id_or_$node)):id_or_$node,transcriptHTML=$node.text();interaction.transcriptDialogs||(interaction.transcriptDialogs=[],a5.eventBus.bind("transcript:close",function(){this.closeTranscripts(interaction.transcriptDialogs)},this));var transcriptString=transcriptHTML.replace(/&#62;/g,">").replace(/<\/p>/g,"").replace(/<p>/g,"").replace(/&#xd;/g,""),testRegexp=/\s?1\s?\n\s?\d\d:\d\d:\d\d(,\d\d\d)?\s*-->\s*\d\d:\d\d:\d\d(,\d\d\d)?/,$transcript=$inlineTranscript.length?$inlineTranscript.find(".transcript"):$html.find(".transcript"),$container=$html.closest(".is-content-zone");transcriptString.match(testRegexp)?a5.model_builder.audioVideoUtils.linkSrtTranscript($node,$transcript,interaction,$html,player):a5.model_builder.audioVideoUtils.linkRteTranscript($node,$transcript,interaction,$html,player),$html.find(".transcript_button").removeClass("inactive transcript_button_clicked"),$inlineTranscript.length?a5.model_builder.audioVideoUtils.setupTranscriptInline($inlineTranscript,$html):a5.model_builder.audioVideoUtils.setupTranscriptDialog($transcript,$container,interaction,$html,player)},a5.model_builder.audioVideoUtils.setupTranscriptInline=function($inlineTranscript,$html){$html.find(".transcript_button").on("click",function(e){var $button=$(this);$button.hasClass("transcript_button_clicked")?($inlineTranscript.removeClass("active"),$button.removeClass("transcript_button_clicked")):($inlineTranscript.addClass("active"),a5.utils.scrollIntoElementIfNeeded($inlineTranscript,{behavior:"smooth",block:"start",inline:"nearest"}),$button.addClass("transcript_button_clicked"))}),$inlineTranscript.find(".close").on("click",function(e){$inlineTranscript.removeClass("active"),$html.find(".transcript_button").removeClass("transcript_button_clicked")})},a5.model_builder.audioVideoUtils.setupTranscriptDialog=function($transcript,$container,interaction,$html,player){$transcript.dialog({autoOpen:!1,dialogClass:"transcript-dialog",height:300,close:function(e,ui){$html.find(".transcript_button").removeClass("inactive transcript_button_clicked")},open:function(e,ui){$html.find(".transcript_button").addClass("inactive transcript_button_clicked")}});var _transcriptPosition=function(){var position={};if($container.length>0){var playerHeight=$html.outerHeight(),containerHeight=$container.height(),playerTop=$html.offset().top,containerTop=$container.offset().top,containerBottom=containerTop+containerHeight,playerBottom=playerTop+playerHeight,overflowBottom=playerBottom+300>containerBottom;position=overflowBottom?{my:"right bottom",at:"right top",of:$html.find(".media-footer")}:{my:"right top",at:"right bottom",of:$html.find(".media-footer")}}else position={my:"right top",at:"right bottom",of:$html.find(".media-footer")};return position};interaction.bind("show hide",function(){$transcript.dialog("close")}),$html.find(".transcript_button").on("click",function(e){$transcript.dialog("isOpen")?$transcript.dialog("close"):(this.closeTranscripts(interaction.transcriptDialogs),a5.dp.config.positionedTranscript&&$transcript.dialog("option","position",_transcriptPosition()),$transcript.dialog("open")),e.stopPropagation()}.bind(this));var $transcriptParent;player.bind("fullscreenchange",function(isFullscreen){_.delay(function(){var $transcriptDialog=$transcript.dialog("widget");isFullscreen?($transcriptParent=$transcriptDialog.parent(),player.append($transcriptDialog)):$transcriptParent.append($transcriptDialog),a5.dp.config.positionedTranscript?$transcript.dialog("option","position",_transcriptPosition()):$transcript.dialog("option","position",_.extend({collision:"fit"},$transcript.dialog("option","position")))},100)})},a5.model_builder.audioVideoUtils.linkSrtTranscript=function($node,$transcript,interaction,$html,player){var transcript=new a5.models.SubtitlesModel;transcript.loadSRT($node.text()),transcript.empty()?$html.find(".transcript_button").hide():($html.addClass("with-transcript"),interaction.transcriptDialogs.push($transcript),_.each(transcript.all(),function(t){var $p=$('<p class="transcript-segment">'+t.text+"</p>");$transcript.append($p),$p.on("click",function(){player.position(1e3*t.from),player.isPlaying()||(a5.service.media.pauseAllExcept(player),player.play())})}),player.bind("progress seeked",function(pos){if($transcript.length>0){var previous=$transcript.children(".selected").removeClass("selected").index(),current=transcript.getCurrentIndex(pos/1e3);if(-1!==current){var $current=$transcript.children(".transcript-segment").eq(current);$current.addClass("selected"),current!==previous&&a5.utils.scrollIntoElementIfNeeded($current,{behavior:"smooth",block:"start",inline:"nearest"})}}}))},a5.model_builder.audioVideoUtils.linkRteTranscript=function($node,$transcript,interaction,$html,player){var transcriptHTML=$node.text();transcriptHTML&&0!=transcriptHTML.trim().length?($html.addClass("with-transcript"),interaction.transcriptDialogs.push($transcript),$transcript.append(transcriptHTML)):$html.find(".transcript_button").hide()},a5.model_builder.audioVideoUtils.linkSubtitles=function(id_or_$node,interaction,$html,player){var subtitles=new a5.models.SubtitlesModel,subtitlesEnabled=!1;id_or_$node.length>0&&subtitles.loadSRT("string"==typeof id_or_$node?$(interaction.xml).find("#subtitle #"+a5.utils.jquerySelectorEscape(id_or_$node)).text():id_or_$node.text());var $subtitles=$html.find(".subtitles");player.append($subtitles),$subtitles.hide(),subtitles.empty()?$html.find(".subtitles_button").hide():($html.addClass("with-subtitles"),$html.find(".subtitles_button").on("click",function(e){subtitlesEnabled?(subtitlesEnabled=!1,$(this).removeClass("inactive subtitles_button_clicked"),$subtitles.hide()):(subtitlesEnabled=!0,$(this).addClass("inactive subtitles_button_clicked"),$subtitles.show()),e.stopPropagation()}),player.bind("progress seeked",function(pos){var current=subtitles.getCurrent(pos/1e3),srt="";!_.isUndefined(current)&&current.text&&(srt=current.text.trim()),$subtitles.html(srt.split("\n").join("<br>"))}),$("body").is(".isIOS")&&this.linkSubtitlesForIOS(subtitles,player))},a5.model_builder.audioVideoUtils.linkSubtitlesForIOS=function(subtitles,player){if(player.video){var track=player.video.tag.addTextTrack("subtitles","English","en"),cues=subtitles.getVTTCues();_(cues).each(function(cue){track.addCue(cue)}),player.$video.attr("playsinline","playsinline"),player.bind("fullscreenchange",function(fullscreen){fullscreen||(track.mode="hidden")}.bind(this))}},a5.model_builder.audioVideoUtils.linkKaraoke=function(id,interaction,$html,player){$(interaction.xml).find('karaoke[audio="'+id+'"]').length&&(player.bind("stopped",function(){interaction.$(".karaoke-playing").removeClass("karaoke-playing")}),player.bind("progress seeked",function(pos){if(interaction.karaoke){var karaoke=interaction.karaoke[id],current=karaoke&&karaoke.getCurrent(pos/1e3);!_.isUndefined(current)&&current.node.length>0?current.node.hasClass("karaoke-playing")||(interaction.$(".karaoke-playing").removeClass("karaoke-playing"),current.node.addClass("karaoke-playing"),a5.utils.scrollIntoElementIfNeeded(current.node,{behavior:"smooth",block:"start",inline:"nearest"})):interaction.$(".karaoke-playing").removeClass("karaoke-playing")}}))},a5.model_builder.audioVideoUtils.addInterfaceEvents=function($html,player){if(player.bind("progress seeked",function(pos){$html.trigger("progress",[pos,player.duration()])}),player.bind("volume",function(vol){_.isUndefined(vol)&&(vol=player.volume()),$html.trigger("volume",vol)}),this.addProgressBarEvents($html,player),this.addVolumeBarEvents($html,player),this.addToggleEvents($html,player),$html.on("click",".play",function(e){player.isPlaying()||(a5.service.media.pauseAllExcept(player),player.play()),e.stopPropagation()}),$html.on("click",".pause",function(e){player.pause(),e.stopPropagation()}),$html.find(".back").on("click",function(e){player.position(0)}),$html.find(".stop").on("click",function(e){player.stop()}),player.video){var isActive=!1,keepActive=!1,markInactiveAfterTimeout=_.debounce(function(){isActive=!1,keepActive=!1,$html.addClass("mediaPlayer--inactive")},a5.dp.config.videoActivityTimeout),markActive=function(){keepActive||(markInactiveAfterTimeout(),isActive||(isActive=!0,$html.removeClass("mediaPlayer--inactive")))},markActiveForever=function(){markActive.call(),markInactiveAfterTimeout.cancel(),keepActive=!0};$html.on("click mousemove touchstart touchmove",markActive),$html.on("seek:start volume:start",markActiveForever),$html.on("seek:stop volume:stop",markInactiveAfterTimeout)}},a5.model_builder.audioVideoUtils.removeInterfaceEvents=function($html){$html.off(),$html.find(".volume_area").off(),$html.find("[data-speed]").off(),$html.find(".volume .mute_button").off(),$html.find(".volume li").off(),$html.find(".back").off(),$html.find(".stop").off(),$html.find(".progress_toggle").off(),$html.find(".volume_toggle").off(),$html.find(".volume").off(),$html.find(".progress_area").off()},a5.model_builder.audioVideoUtils.addAudioPlayerEvents=function(audio,$html){var playButtonLabels=a5.utils.getLabels($html.find(".play, .pause"),["play","pause"],{noDefaultText:!0});audio.bind("progress seeked",function(pos){$html.find(".current_time").html(a5.utils.seconds_to_text(Math.floor(pos/1e3)));var progress=Math.round(pos/audio.duration()*1e4)/100;$html.find(".progress_played").css("width",progress+"%")}),audio.bind("loadprogress",function(pos){$html.find(".duration").html(a5.utils.seconds_to_text(Math.floor(audio.duration()/1e3)))}),audio.bind("stopped paused",function(){var $button=$html.find(".pause");$button.removeClass("pause").addClass("play"),a5.utils.setLabel($button,playButtonLabels.play)}),audio.bind("start",function(){var $button=$html.find(".play");$button.removeClass("play").addClass("pause"),a5.utils.setLabel($button,playButtonLabels.pause)}),audio.bind("volume",function(vol){_.isUndefined(vol)&&(vol=audio.volume());var vi=10-Math.round(10*vol),$volume=$html.find(".volume"),$volumeLevels=$html.find(".volume li"),$mute=$html.find(".volume .mute_button");$volumeLevels.removeClass("volume-bar-active"),$volumeLevels.addClass(function(index){if(index>=vi)return"volume-bar-active"}),$mute.toggleClass("volume_button",!audio.isMuted()&&vol>audio.volumeMin());var volPercentage=audio.volumeAsPercentage();$volume.attr("aria-valuenow",volPercentage),$volume.attr("aria-valuetext",volPercentage+"%")}),audio.trigger("volume"),a5.model_builder.audioVideoUtils.addInterfaceEvents($html,audio),a5.model_builder.audioVideoUtils.addAudioPlaybackConfigEvents($html,audio)},a5.model_builder.audioVideoUtils.addVideoPlayerEvents=function(video,$html){var playButtonLabels=a5.utils.getLabels($html.find(".play, .pause"),["play","pause"],{noDefaultText:!0});video.append($html.find("#close-fullscreen-video")),video.bind("ready",function(){video.trigger("volume"),a5.model_builder.audioVideoUtils.addInterfaceEvents($html,video),$html.addClass("with-fullscreen"),$html.find(".full_screen").on("click",function(){video.isFullscreen()?video.cancelFullscreen():video.fullscreen()}),$html.find("#close-fullscreen-video").on("click",function(){video.cancelFullscreen()})}),video.bind("progress seeked",function(pos){$html.find(".current_time").html(a5.utils.seconds_to_text(Math.floor(pos/1e3)));var progress=Math.round(pos/video.duration()*1e4)/100;$html.find(".progress_played").css("width",progress+"%")}),video.bind("loadprogress durationchange",function(){$html.find(".duration").html(a5.utils.seconds_to_text(Math.floor(video.duration()/1e3)))}),video.bind("stopped paused",function(){var $button=$html.find(".pause");$button.removeClass("pause").addClass("play"),a5.utils.setLabel($button,playButtonLabels.play),$html.removeClass("playing")}),video.bind("start",function(){var $button=$html.find(".play");$button.removeClass("play").addClass("pause"),a5.utils.setLabel($button,playButtonLabels.pause),$html.addClass("playing")}),video.bind("volume",function(vol){_.isUndefined(vol)&&(vol=video.volume());var vi=10-Math.round(10*vol),$volume=$html.find(".volume"),$volumeLevels=$html.find(".volume li"),$mute=$html.find(".volume .mute_button");$volumeLevels.removeClass("volume-bar-active"),$volumeLevels.addClass(function(index){if(index>=vi)return"volume-bar-active"}),$mute.toggleClass("volume_button",!video.isMuted()&&vol>video.volumeMin());var volPercentage=video.volumeAsPercentage();$volume.attr("aria-valuemin",0),$volume.attr("aria-valuemax",100),$volume.attr("aria-valuenow",volPercentage),$volume.attr("aria-valuetext",volPercentage+"%")});var $footer=$html.find(".video_footer");video.bind("fullscreenchange",function(fullscreen){fullscreen?(video.append($footer),$("body").addClass("isFullScreen"),$html.find(".video_wrapper").addClass("full_screen")):($html.find(".the_video").after($footer),$html.find(".video_wrapper").removeClass("full_screen"),$("body").removeClass("isFullScreen"))}),video.video.on("loadedmetadata",function(){if(video.video.tech().hls){a5.model_builder.audioVideoUtils.addVideoPlaybackConfigEvents($html,video),$html.addClass("mediaPlayer--quality");var $popup=$html.find(".mediaPlayer__qualityList");video.video.tech().hls.representations().forEach(function(repr,i){var entry=a5.mainBuilder.layout.getTemplate("quality-setting");entry=entry.replace("##label##",repr.height+"p"),entry=entry.replace("##index##",i);var $entry=$(entry);$entry.data("repr",repr.id),$popup.append($entry)});var $auto=$(a5.mainBuilder.layout.getTemplate("quality-auto"));$auto.is("[data-index]")?$auto.addClass("active"):$auto.find("[data-index]").addClass("active"),$auto.addClass("mediaPlayer__qualityListItem--selected"),$popup.append($auto)}})},a5.model_builder.audioVideoUtils.addToggleEvents=function($html,player){function addToggle(toggle,node){var $toggle=$html.find(toggle),$node=$html.find(node);$html.find(toggle).on("click",function(e){$node.is(":visible")?($node.hide(),$toggle.removeClass("active")):($node.show(),$toggle.addClass("active"))})}addToggle(".progress_toggle",".progress_wrap"),addToggle(".volume_toggle",".volume_wrap")},a5.model_builder.audioVideoUtils.addVolumeBarEvents=function($html,player){var $volumeArea=$html.find(".volume_area"),$volume=$html.find(".volume"),$volumeLevels=$html.find(".volume li"),$mute=$html.find(".volume .mute_button"),doVol=!1;function adjustVolume(event){if(doVol){var x=event.clientX||event.originalEvent.touches&&event.originalEvent.touches[0].clientX,rect=this.getBoundingClientRect(),pos=x-rect.left,size=rect.width,level=Math.max(Math.min(pos/size,1),0);$html.find(".volume_level").css("width",100*level+"%"),player.volume(level)}}$volumeArea.on("touchstart mousedown",function(e){doVol=!0,$html.addClass("media-adjusting-volume"),$html.trigger("volume:start")}).on("touchmove mousemove",function(e){e.preventDefault(),adjustVolume.call(this,e)}),$("body").on("touchend mouseup",function(e){adjustVolume.call($html.find(".volume_area").get(0),e),doVol=!1,$html.removeClass("media-adjusting-volume"),$html.trigger("volume:stop")}),$mute.on("click",function(e){player.isMuted()?player.unmute():player.volume()===player.volumeMin()?player.volume((player.volumeMax()-player.volumeMin())/2):player.mute(),e.stopPropagation()}),$volumeLevels.on("click",function(e){var vol=(10-$(this).index())/10;player.volume(vol),player.isMuted()&&player.unmute(),e.stopPropagation()}),$volume.on("keydown",function(e){var key=e.which;key===a5.utils.keyCodes.HOME?(e.stopPropagation(),e.preventDefault(),player.volume(player.volumeMin())):key===a5.utils.keyCodes.END?(e.stopPropagation(),e.preventDefault(),player.volume(player.volumeMax())):key===a5.utils.keyCodes.UP||key===a5.utils.keyCodes.RIGHT?(e.stopPropagation(),e.preventDefault(),player.volumeUp()):key!==a5.utils.keyCodes.DOWN&&key!==a5.utils.keyCodes.LEFT||(e.stopPropagation(),e.preventDefault(),player.volumeDown())})},a5.model_builder.audioVideoUtils.addAudioPlaybackConfigEvents=function($html,player){var $speedButtons=$html.find("[data-speed]");$speedButtons.filter("[data-speed=1]").addClass("mediaPlayer__speed--selected"),$speedButtons.on("click",function(e){var $currentTarget=$(e.currentTarget);$currentTarget.hasClass("mediaPlayer__speed--selected")||($speedButtons.filter(".mediaPlayer__speed--selected").removeClass("mediaPlayer__speed--selected"),$currentTarget.addClass("mediaPlayer__speed--selected"),player.rate(parseFloat($currentTarget.data("speed"))))})},a5.model_builder.audioVideoUtils.addVideoPlaybackConfigEvents=function($html,player){var $qualityList=$html.find(".mediaPlayer__qualityList");$qualityList.on("click",">*",function(e){var $delegateTarget=$(e.delegateTarget),$currentTarget=$(e.currentTarget),selectedReprId=$currentTarget.data("repr"),selectedAuto=!selectedReprId;$delegateTarget.find("[data-index]").removeClass("active"),$(e.target).addClass("active"),$delegateTarget.find(".mediaPlayer__qualityListItem--selected").removeClass("mediaPlayer__qualityListItem--selected"),$currentTarget.addClass("mediaPlayer__qualityListItem--selected"),player.video.tech().hls.representations().forEach(function(repr,i){repr.enabled(selectedAuto||repr.id===selectedReprId)})});var $button=$html.find("[data-event=toggle-qualitylist],.mediaPlayer__qualityButton,.mediaPlayer__control--quality");if($button.length){var $quality=$html.find(".mediaPlayer__toggleableMenu--quality");$button.on("click",function(e){$quality.toggleClass("mediaPlayer__toggleableMenu--enabled")}),$(document).on("click",function(e){$(e.target).closest($button).length||$quality.removeClass("mediaPlayer__toggleableMenu--enabled")})}var previousRepr,metadata=_.find(player.video.textTracks(),{label:"segment-metadata"}),markActiveQuality=function(repr,height){$html.find(".mediaPlayer__qualityListCurrent").text(height+"p"),$qualityList.children().removeClass("mediaPlayer__qualityListItem--autoSelected").filter(function(){return $(this).data("repr")===repr
}).addClass("mediaPlayer__qualityListItem--autoSelected")};metadata&&metadata.on?metadata.on("cuechange",function(){var activeCue=metadata.activeCues[0];if(activeCue){var repr=activeCue.value.playlist;if(previousRepr!==repr){var height=activeCue.value.resolution.height;markActiveQuality(repr,height),previousRepr=repr}}}):player.bind("progress seeked",_.throttle(function(){var hls=player.video.tech().hls;if(hls){var media=hls.playlists.media(),repr=media.uri;if(previousRepr!==repr){var height=media.attributes.RESOLUTION.height;markActiveQuality(repr,height),previousRepr=repr}}},300))},a5.model_builder.audioVideoUtils.addProgressBarEvents=function($html,player){var seekBar=new a5.model_builder.audioVideoUtils.AudioVideoSlider({$el:$html.find(".progress_area"),$current:$html.find(".current_time"),player:player});seekBar.bind("start",function(){$html.addClass("media-seeking"),$html.trigger("seek:start")}),seekBar.bind("end",function(){$html.removeClass("media-seeking"),$html.trigger("seek:end")}),seekBar.render();var currentSeekbar=$html.data("seekBar");currentSeekbar&&currentSeekbar.unbindEvents(),seekBar.bindEvents(),$html.data("seekBar",seekBar)},a5.model_builder.audioVideoUtils.AudioVideoSlider={TEMPLATE:'<div class="progress_area"><div class="progress_downloaded" style="width: 100%;"></div><div class="progress_played" style="width: 0%;"></div></div>',init:function(parameters){this.$el=parameters.$el||$(this.TEMPLATE),this.$played=this.$el.find(".progress_played"),this.$downloaded=this.$el.find(".progress_downloaded"),this.$current=parameters.$current,this.player=parameters.player,_.bindAll(this,"onStart","onMove","onEnd","onClick","onKeydown","calculateOffset"),this.calculateOffsetOnce=_.once(this.calculateOffset)},bindEvents:function(){this.$el.on("mousedown touchstart",this.onStart),this.$el.on("click",this.onClick),this.$el.on("keydown",this.onKeydown),this.player.bind("progress seeked",this.onPlayerProgress,this),this.player.bind("loadprogress durationchange",this.onPlayerDurationLoaded,this)},unbindEvents:function(){this.$el.off("mousedown touchstart",this.onStart),this.$el.off("click",this.onClick),this.$el.off("keydown",this.onKeydown),this.player.unbind("progress seeked",this.onPlayerProgress),this.player.unbind("loadprogress durationchange",this.onPlayerDurationLoaded)},onStart:function(e){e.preventDefault(),a5.utils.preventTextSelection(),this.$el.focus(),$(document).on("mousemove touchmove",this.onMove),$(document).on("mouseup touchend",this.onEnd),this.onMove(e),this.trigger("start")},onMove:function(e){var newTime=this.calculateDistance(e)*this.player.duration();newTime===this.player.duration()&&(newTime-=100),this.$current.html(a5.utils.seconds_to_text(Math.floor(newTime/1e3))),this.player.position(newTime)},onEnd:function(e){a5.utils.allowTextSelection(),$(document).off("mousemove touchmove",this.onMove),$(document).off("mouseup touchend",this.onEnd),this.resetOffset(),this.trigger("end")},onClick:function(e){e.stopImmediatePropagation(),e.preventDefault()},onKeydown:function(e){var key=e.which;key===a5.utils.keyCodes.UP||key===a5.utils.keyCodes.RIGHT?(e.stopPropagation(),e.preventDefault(),this.stepForward()):key!==a5.utils.keyCodes.DOWN&&key!==a5.utils.keyCodes.LEFT||(e.stopPropagation(),e.preventDefault(),this.stepBack())},onPlayerProgress:function(pos){this.update(pos)},onPlayerDurationLoaded:function(){this.$el.attr("aria-valuemin",0),this.$el.attr("aria-valuemax",Math.round(this.player.duration()/1e3))},render:function(){return this.$el},update:function(pos){var progress=this.percent(pos);isNaN(progress)&&(progress=0),this.$played.css("width",progress+"%"),this.$el.attr("aria-valuenow",Math.round(pos/1e3)),this.$el.attr("aria-valuetext",a5.utils.seconds_to_text(Math.floor(pos/1e3)))},calculateDistance:function(event){var pageX,total=this.$el.get(0).getBoundingClientRect(),played=this.$played.get(0).getBoundingClientRect(),handleW=parseInt(window.getComputedStyle(this.$played.get(0),":after").getPropertyValue("width"),10),handleX=played.right-handleW/2;return pageX=event.originalEvent.changedTouches?event.originalEvent.changedTouches[0].pageX:event.pageX,pageX-=this.calculateOffsetOnce(pageX,handleX,handleW),Math.max(0,Math.min(1,(pageX-total.left)/total.width))},calculateOffset:function(pageX,handleX,handleW){var offset=0;return pageX>handleX&&pageX<handleX+handleW&&(offset=pageX-handleX-handleW/2),offset},resetOffset:function(){this.calculateOffsetOnce=_.once(this.calculateOffset)},percent:function(pos){return _.isUndefined(pos)&&(pos=this.player.position()),Math.round(pos/this.player.duration()*1e4)/100},stepForward:function(){this.player.stepForward()},stepBack:function(){this.player.stepBack()}},Obj.extend("a5.model_builder.audioVideoUtils.AudioVideoSlider"),a5.model_builder.Audio={documentEvents:!1,isResponsible:function(node,interaction){var responsible=node.is("object[type='audio/audio']");return responsible=responsible&&!(new a5.model_builder.DragDropUtils).isResponsible(node,interaction)},build:function(interaction,parentNode,node){var tinyplayer=parentNode.closest(".contentblock").length>0||node.closest("#contentblock").length>0;0==(node.attr("alt")||"").indexOf("player:")&&(tinyplayer=!1),0==(node.attr("alt")||"").indexOf("icon:")&&(tinyplayer=!0);var $rendered;$rendered=tinyplayer?this.buildTinyPlayer(interaction,parentNode,node):a5.dp.config.audioUseNativeControls?this.buildNativePlayer(interaction,parentNode,node):this.buildFullPlayer(interaction,parentNode,node),interaction.options.audioingapIsOn()&&(node.next().find("textEntryInteraction").andSelf().is("textEntryInteraction")||node.next().find("inlineChoiceInteraction").andSelf().is("inlineChoiceInteraction"))&&($rendered=$('<span class="audio-gap">').append($rendered)),parentNode.append($rendered)},buildNativePlayer:function(interaction,parentNode,node){var $html=$("<div class='mediaPlayer mediaPlayer--audio mediaPlayer--native'></div>");a5.service.media.audio.bind("ready",function(){var playing=a5.service.media.audio.create(node.attr("data"),{preload:!a5.dp.config.audioPreloadDisabled,persistVolume:a5.dp.config.audioVolumeStore,nativeAudio:!0});$html.attr("data-playable-media",playing.uid);var $audio=$(playing.audioObject);playing.bind("start",function(){a5.service.media.pauseAllExcept(playing)}),$html.append($audio)}),parentNode.append($html)},buildFullPlayer:function(interaction,parentNode,node){var $html=$(window.a5.mainBuilder.layout.getTemplate("audio_widget")),$inlineTranscript=$(window.a5.mainBuilder.layout.getTemplate("media_transcript"));return $html.attr("style",node.attr("style")),$html.css("height",""),$html.find(".transcript_button").data("isAudio",!0),$html.find(".the_audio").hide(),$html.toggleClass("with-speed",interaction.options.audiospeedIsOn()),a5.service.media.audio.bind("ready",function(){var playing=a5.service.media.audio.create(node.attr("data"),{preload:!a5.dp.config.audioPreloadDisabled,persistVolume:a5.dp.config.audioVolumeStore});$html.attr("data-playable-media",playing.uid),a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(playing),a5.model_builder.audioVideoUtils.addAudioPlayerEvents(playing,$html),a5.model_builder.audioVideoUtils.linkSubtitles(node.attr("data"),interaction,$html,playing),a5.model_builder.audioVideoUtils.linkTranscript(node.attr("data"),interaction,$html,playing,$inlineTranscript),a5.model_builder.audioVideoUtils.linkKaraoke(node.attr("data"),interaction,$html,playing)}),node.attr("style")&&node.attr("style").match(/option023/i)&&$html.attr("data-option023",!0),$inlineTranscript.length?$('<div class="transcript-wrap audio">').append($html).append($inlineTranscript):$html},buildTinyPlayer:function(interaction,parentNode,node){var hasPauseBehaviour=interaction.options.audioiconbehaviourIsPause(),seed=Math.floor(1e5*Math.random()),playerId="playbutton-"+seed,speedId="playspeed-"+seed,playerSelector="#"+playerId,speedSelector="#"+speedId,$tp=$("<span role='button' tabindex='0' class='playbutton inactive' id='"+playerId+"'></span>");$tp.toggleClass("show-pause-on-playing",hasPauseBehaviour);var $playspeed;interaction.options.audiospeedIsOn()&&($playspeed=$("<span role='button' tabindex='0' id='"+speedId+"' class='playbutton playspeed'></span>")),a5.service.media.audio.bind("ready",function(){var playing=!1,tinyAudio=a5.service.media.audio.create(node.attr("data"),{preload:!a5.dp.config.audioPreloadDisabled});$tp.attr("data-playable-media",tinyAudio.uid),a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(tinyAudio),tinyAudio.bind("paused stopped",function(){$(playerSelector).removeClass("playing"),playing=!1}),tinyAudio.bind("start",function(){$(playerSelector).addClass("playing"),playing=!0});var togglePlay=function(){playing?hasPauseBehaviour?tinyAudio.pause():tinyAudio.stop():(a5.service.media.pauseAllExcept(tinyAudio),tinyAudio.play())},onPlayerClick=function(e){togglePlay(),$(playerSelector).trigger("tp:click"),e.stopPropagation()},onPlayerKeydown=function(e){var KEYS=(e.currentTarget,a5.utils.keyCodes);switch(e.keyCode){case KEYS.SPACE:case KEYS.ENTER:togglePlay();break;default:return}e.stopPropagation(),e.preventDefault()};if(a5.model_builder.Audio.documentEvents?($(document).on("click",playerSelector,onPlayerClick),$(document).on("keydown",playerSelector,onPlayerClick)):($tp.on("click",onPlayerClick),$tp.on("keydown",onPlayerKeydown)),$playspeed){var togglePlaySpeed=function(){$(speedSelector).is(".active")?($(speedSelector).removeClass("active"),tinyAudio.rate(1)):($(speedSelector).addClass("active"),tinyAudio.rate(a5.dp.config.audioTinyPlayerPlayspeedButton))},onSpeedClick=function(e){togglePlaySpeed(),e.stopPropagation()},onSpeedKeydown=function(e){var KEYS=(e.currentTarget,a5.utils.keyCodes);switch(e.keyCode){case KEYS.SPACE:case KEYS.ENTER:togglePlaySpeed();break;default:return}e.stopPropagation(),e.preventDefault()};a5.model_builder.Audio.documentEvents?($(document).on("click",speedSelector,onSpeedClick),$(document).on("keydown",speedSelector,onSpeedKeydown)):($playspeed.on("click",onSpeedClick),$playspeed.on("keydown",onSpeedKeydown))}$tp.removeClass("inactive"),a5.model_builder.audioVideoUtils.linkKaraoke(node.attr("data"),interaction,$tp,tinyAudio)});var $node,width=parseInt($tp.measure("width")||0,10)+parseInt($tp.measure("border-width")||0,10),height=parseInt($tp.measure("height")||0,10)+parseInt($tp.measure("border-width")||0,10),style=node.attr("style");return $playspeed?($node=$("<span class='playbutton-wrap'>"),$node.attr("style",style),$node.css("width",""),$node.css("height",""),$node.append($tp),$node.append($playspeed)):($tp.attr("style",style),$node=$tp),width>0&&$tp.css("width",width),height>0&&$tp.css("height",height),style&&style.match(/option023/i)&&$node.attr("data-option023",!0),$node}},Obj.extend("a5.model_builder.Audio",a5.model_builder.Audio),a5.model_builder.builders.push(new a5.model_builder.Audio),a5.model_builder.Video={isResponsible:function(node,interaction){return node.is("object[type='video/video']")||node.is("video")},build:function(interaction,parentNode,node){this.original_node=node,node.is("object")?a5.dp.config.videoUseNativeControls?this.buildNative(interaction,parentNode,node):this.buildObject(interaction,parentNode,node):node.is("video")&&this.buildVideo(interaction,parentNode,node)},buildVideo:function(interaction,parentNode,node){var object=$("<object>");object.attr("type","video/video"),object.attr("id",node.attr("id")),object.attr("startingtime",node.attr("startingtime")),node.attr("autoplay")&&"false"!=node.attr("autoplay")?object.attr("autoplay",node.attr("autoplay")):node.data("autoplay")&&"false"!=node.data("autoplay")&&object.attr("autoplay",node.data("autoplay")),object.attr("dontstop",node.attr("dontstop")),object.attr("style",node.attr("style")),object.css("width",node.attr("width")),object.css("height",node.attr("height")),object.attr("poster",node.attr("poster"));var source=node.find("source"),data=source.attr("src");(data=data.match(/S3_.+?\./))&&data[0]&&(data=data[0].replace(".",""),object.attr("data",data),a5.dp.config.videoUseNativeControls?this.buildNative(interaction,parentNode,$(object)):this.buildObject(interaction,parentNode,$(object)))},getDimensions:function(node){var tempNode=$("<div></div>").attr("style",node.attr("style"));return{width:parseInt(tempNode.css("width"),10),height:parseInt(tempNode.css("height"),10)}},getAutoplay:function(node){return node.attr("autoplay")&&"false"!=node.attr("autoplay")},getSetupAutoplay:function(interaction,node){var setupAutoplay=_.noop;if(this.getAutoplay(node))if(a5.service.Attachment.currentAttachment){var attachment=a5.service.Attachment.currentAttachment;setupAutoplay=function(video){attachment.onAttachmentOpenListeners.register(function(){video.play()})}}else setupAutoplay=function(video){interaction.bind("show:deferred",function(){_.defer(function(){video.play()})})};return setupAutoplay},getVideoTemplate:function(node){var $html=$(window.a5.mainBuilder.layout.getTemplate("video_widget"));$html.attr("style",node.attr("style")),$html.attr("class","video v_a_media"),_.isUndefined(node.attr("class"))||$html.addClass(node.attr("class")),navigator.userAgent.match(/(iPad|iPod|iPhone)/)&&$html.find(".volume").hide();var aspectRatio=this._extractAspectRatio(node);return aspectRatio&&$html.attr("data-aspect-ratio",aspectRatio),$html},getInlineTranscript:function(){return $(window.a5.mainBuilder.layout.getTemplate("media_transcript"))},buildNative:function(interaction,parentNode,node){var $target=$('<div class="mediaPlayer mediaPlayer--video mediaPlayer--native"></div>'),videoSize=this.getDimensions(node);$target.css({width:videoSize.width,height:videoSize.height});var video=a5.service.media.video.create(node.attr("data"),$target,{dontStop:node.attr("dontstop")&&"false"!==node.attr("dontstop"),poster:node.attr("poster")});this.getSetupAutoplay(interaction,node)(video),this.setupStartingTime(video,parseInt(node.attr("startingtime"),10)),video.$video.attr("controls",!0),parentNode.append($target)},setupStartingTime:function(video,startingtime){if(startingtime){video.bind("cansetstartingtime",function(){video.position(1e3*startingtime)});a5.utils.parseUserAgent().isIOS&&video.bind("ready",function(){video.video.tech().hls||video.load()},this,{once:!0})}},buildObject:function(interaction,parentNode,node){var videoSize=this.getDimensions(node),$html=this.getVideoTemplate(node),$inlineTranscript=this.getInlineTranscript();parentNode.append($inlineTranscript.length?$('<div class="transcript-wrap video">').append($html).append($inlineTranscript):$html);var $target=$html.find(".the_video");node.attr("style")&&node.attr("style").match(/option023/i)&&$target.attr("data-option023",!0),this.original_node.is("object")?videoSize.height&&($target.css({width:videoSize.width,height:videoSize.height-107}),$html.height($html.find(".video_wrapper").height())):$target.css({width:videoSize.width,height:videoSize.height});var setupAutoplay=this.getSetupAutoplay(interaction,node),setupStartingTime=this.setupStartingTime;interaction.onInteractionReadyListeners.register(function(options){if(!options.tryAgain){var video=a5.service.media.video.create(node.attr("data"),$target,{dontStop:node.attr("dontstop")&&"false"!==node.attr("dontstop"),poster:node.attr("poster")});setupAutoplay(video),setupStartingTime(video,parseInt(node.attr("startingtime"),10)),a5.model_builder.audioVideoUtils.addVideoPlayerEvents(video,$html),a5.model_builder.audioVideoUtils.linkSubtitles(node.attr("data"),interaction,$html,video),a5.model_builder.audioVideoUtils.linkTranscript(node.attr("data"),interaction,$html,video,$inlineTranscript)}})},_extractAspectRatio:function(node){var style=node.attr("style");if(!style)return null;var w=parseFloat(a5.utils.getStyleValue(style,"width")),h=parseFloat(a5.utils.getStyleValue(style,"height"));return Math.round(1e3*w/h)/1e3}},Obj.extend("a5.model_builder.Video",a5.model_builder.Video),a5.model_builder.builders.push(new a5.model_builder.Video),a5.model_builder.ExamTimer={WARNING_DURATION:10,init:function(args){_.extend(this,args),this.elapsed=0,this.elapsedExtra=0,this._onExtraTime=!1,this._lastTick,this._lastElapsedTriggered,this.view=new a5.view.ExamTimer(this),a5.callbacks.controls.bar.bind("added",this.onControlsAdded,this)},render:function(){$("#timer").append(this.view.render())},getElapsedTime:function(){return this.elapsed+this.elapsedExtra},isOnExtraTime:function(){return this._onExtraTime},startOnShow:function(interactions){_.isUndefined(this.lo.examTimeOnExtraTime)||(this._onExtraTime=this.lo.examTimeOnExtraTime),_.isUndefined(this.lo.examTimeElapsed)||(this.elapsed=Math.min(this.time,this.lo.examTimeElapsed),this.elapsedExtra=this.lo.examTimeElapsed-this.elapsed),_.each(interactions,function(interaction){interaction.bind("show:deferred",function(){!this.lo.canSubmit||!this.lo.hasMoreSubmitAttempts()||"on"!==this.countIntroScreen&&interaction.isIntroScreen()||this.start()},this,{once:!0})},this)},start:function(){this._lastTick||(this.trigger("start"),this._lastTick=Math.floor(+new Date/1e3),this._checkTimeout()||(this.tick(),this.interval=setInterval(_.bind(function(){this.tick()},this),1e3)))},startExtraTime:function(){this._lastTick=null,this._onExtraTime=!0,clearInterval(this.interval),this.start()},tick:function(){var newTick=Math.floor(+new Date/1e3);this._onExtraTime?(this.elapsedExtra+=newTick-this._lastTick,"allow_to_continue_negative"===this.timeoutType&&this.trigger("update",this.getElapsedTime())):(this.elapsed+=newTick-this._lastTick,this._checkFirstWarning(),this._checkSecondWarning(),this._checkTimeout(),this._lastElapsedTriggered!==this.elapsed&&(this.trigger("update",this.elapsed),this._lastElapsedTriggered=this.elapsed)),this._lastTick=newTick},stop:function(){this.interval&&clearInterval(this.interval),this.view.remove()},getTime:function(){return _.max([this.time-this.elapsed,0])},getTimeString:function(seconds){var data="H:MM:SS"===this.timeFormat?this._hmmssFormat(seconds):this._floorTimeFormat(seconds);return a5.service.templates.render("a5.view.ExamTimerTime",data)},getTimeoutString:function(seconds){var data="H:MM:SS"===this.timeFormat?this._hmmssFormat(seconds):this._ceilTimeFormat(seconds);return a5.service.templates.render("a5.view.ExamTimerTime",data)},onControlsAdded:function(){this.render()},_checkTimeout:function(){if(this.time-this.elapsed<=0&&!this._onExtraTime)return this.interval&&clearInterval(this.interval),this.elapsed=this.time,this.trigger("timeout"),!0},_checkFirstWarning:function(){!this._onExtraTime&&this.first_warning&&(this.time-this.elapsed===this.first_warning?this.trigger("first_warning",this.first_warning_text):this.time-this.elapsed==this.first_warning-this.WARNING_DURATION&&this.trigger("first_warning_end"))},_checkSecondWarning:function(){!this._onExtraTime&&this.second_warning&&(this.time-this.elapsed===this.second_warning?this.trigger("second_warning",this.second_warning_text):this.time-this.elapsed==this.second_warning-this.WARNING_DURATION&&this.trigger("second_warning_end"))},_floorTimeFormat:function(seconds){var m,s,minutes=Math.floor(Math.abs(seconds)/60),sec=Math.abs(seconds-60*minutes);return sec<10&&(sec="0"+sec),0===minutes?s=""+sec:m=""+minutes,{m:m,s:s,onlySeconds:0===minutes,negative:seconds<0,format:"time"}},_ceilTimeFormat:function(seconds){var m,s,minutes=Math.floor(Math.abs(seconds)/60),sec=Math.abs(seconds-60*minutes);return sec<10&&(sec="0"+sec),minutes>0&&seconds>0?m=""+("00"===sec?minutes:minutes+1):0===minutes?s=""+sec:m=""+minutes,{m:m,s:s,onlySeconds:0===minutes,negative:seconds<0,format:"countdown"}},_hmmssFormat:function(seconds){var h=Math.floor(Math.abs(seconds)/3600),m=Math.floor(Math.abs(seconds)%3600/60),s=Math.floor(Math.abs(seconds)%3600%60);return{h:""+h,m:("00"+m).slice(-2),s:("00"+s).slice(-2),withHours:this.with_hours,negative:seconds<0,format:"hmmss"}}},Obj.extend("a5.model_builder.ExamTimer"),a5.view.ExamTimer={template:"a5.view.ExamTimer",init:function(parent){var html=a5.service.templates.render(this.template);this.node=$(html),this.node.hide(),this.node.find(".time").html(" "),this.parent=parent,this.parent.bind("start",this.onStart,this),this.parent.bind("first_warning",this.onFirstWarning,this),this.parent.bind("second_warning",this.onSecondWarning,this),this.parent.bind("first_warning_end",this.onFirstWarningEnd,this),this.parent.bind("second_warning_end",this.onSecondWarningEnd,this),this.parent.bind("update",this.onUpdate,this),this.parent.bind("timeout",this.onTimeout,this),_.bindAll(this,"onSubmit","onContinue")},onStart:function(){a5.mainBuilder.$body.addClass("body--loTimerEnabled"),a5.mainBuilder.$body.removeClass("body--loTimerTimeout"),this.node.removeClass("loTimer--timeout"),this.node.addClass("loTimer--running"),this.node.show()},onTimeout:function(){this.dialog=new a5.view.Dialog;var beforeCloseFn;"force_submit"===this.parent.timeoutType?beforeCloseFn=this.onSubmit:"allow_to_continue"!==this.parent.timeoutType&&"allow_to_continue_negative"!==this.parent.timeoutType||(beforeCloseFn=this.onContinue),this.dialog.display("a5.view.dialog.TimeOut",{dialogClass:"timer-finished",heading:this.parent.dialogHeading,text:this.parent.dialogContent,submitLabel:this.parent.dialogSubmitLabel,continueLabel:this.parent.dialogContinueLabel,submitTooltip:this.parent.dialogSubmitTooltip,continueTooltip:this.parent.dialogContinueTooltip,allowContinue:"allow_to_continue"===this.parent.timeoutType||"allow_to_continue_negative"===this.parent.timeoutType},{submit:this.onSubmit,cancel:this.onContinue},beforeCloseFn),a5.mainBuilder.$body.addClass("body--loTimerTimeout"),this.node.addClass("loTimer--timeout"),this.node.removeClass("loTimer--running"),a5.mainBuilder.$body.addClass("dialog-no-overlay")},onSubmit:function(){a5.mainBuilder.$body.removeClass("dialog-no-overlay"),this.submit()},onContinue:function(){a5.mainBuilder.$body.removeClass("dialog-no-overlay"),this.parent.startExtraTime()},onFirstWarning:function(text){this.node.addClass("warning"),this.node.addClass("loTimer--warning"),text&&""!==text.trim()&&(text=text.replace(/(\d+)/,"<span class='number'>$1</span>"),this.node.find(".timer-message").html(text))},onSecondWarning:function(text){this.node.addClass("warning"),this.node.addClass("loTimer--secondWarning"),text&&""!==text.trim()&&(text=text.replace(/(\d+)/,"<span class='number'>$1</span>"),this.node.find(".timer-message").html(text))},onFirstWarningEnd:function(){this.node.removeClass("warning"),this.node.removeClass("loTimer--warning")},onSecondWarningEnd:function(){this.node.removeClass("warning"),this.node.removeClass("loTimer--secondWarning")},onUpdate:function(elapsed){this.update(elapsed)},submit:function(){this.submitted||(this.submitted=!0,this.parent.lo.hasMoreSubmitAttempts()&&this.parent.lo.submit(!0))},update:function(elapsed){var time=this.parent.time-elapsed,html=this.humanize_seconds(time);this.node.find(".time").html(html);var percentage=Math.round(100*time/this.parent.time);percentage>=0&&(this.node.find(".loTimer__progress").attr("value",percentage),this.node.attr("style","--progress:"+percentage))},render:function(){return this.node},remove:function(){a5.mainBuilder.$body.removeClass("body--loTimerEnabled"),a5.mainBuilder.$body.removeClass("body--loTimerTimeout"),this.node.remove()},humanize_seconds:function(seconds){return this.parent.getTimeoutString(seconds)}},Obj.extend("a5.view.ExamTimer"),a5.model_builder.Clock={isResponsible:function(node,interaction){return node.is("clock")},buildClock:function(interaction,parentNode,node){var model=new a5.model.Clock({startTime:node.text(),className:node.attr("class"),locked:(node.attr("options")||"").match(/\block\b/)});parentNode.append(new a5.view.Clock(model).render())}},a5.model_builder.Base.extend("a5.model_builder.Clock"),a5.model_builder.builders.push(new a5.model_builder.Clock),a5.model_builder.ISDropdownBuilder={isResponsible:function(node,interaction){return node.is("inlineChoiceInteraction")&&"Identify:Select:Dropdown"==interaction.identifier},buildInlineChoiceInteraction:function(interaction,parentNode,node){var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")).values,model=new a5.models.interaction.ISDropdownModel({prefill:interaction.prefill.isPrefill(),placeholder:node.attr("data-author"),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),parent:interaction.blockItems,allowRepeat:interaction.options.repeatAnswersIsAllow(),hasOrderedResponses:interaction.options.orderDependencyIsOn(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),labelStyle:node.attr("style")}),hasImages=!!node.find("inlineChoice img").length;_.each(this.fetchChoices(interaction,node,"inlineChoice"),function(e,index){var $contentNode=$(e),$content=null;if(0==$contentNode.children().length){var text=$contentNode.text();text.indexOf(">")>-1&&text.indexOf("<")>-1&&($content=$(text))}null==$content&&($content=$("<div></div>"),interaction.buildModels($content,$contentNode.contents()),$content=$content.contents());var choiceModel=new a5.models.interaction.ISDropdownChoiceModel({content:$content,key:$(e).attr("identifier"),parent:model,correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect()});choiceModel.assignAnswerFeedback($(e)),model.add(choiceModel),_(correctResponse).contains($(e).attr("identifier"))&&(model.setCorrect(choiceModel),choiceModel.setCorrectIndex(_(correctResponse).indexOf($(e).attr("identifier"))))});var view;interaction.options.choiceAlignmentIsHorizontal()?view=new a5.views.interaction.ISHorizontalSelect(model):(view=a5.dp.config.dropdownNativeSelect&&!hasImages?new a5.views.interaction.ISNativeDropdownView(model):new a5.views.interaction.ISRichDropdownView(model),a5.callbacks.interaction.bind("loaded",function(i){i===interaction&&this.addWordClasses(view.node,".wrapper-dropdown")},this));var rendered=view.render();interaction.bind("show:deferred",function(){interaction.options.gapsIsSamelongest()&&view.adjustSameLongestWidth(),view.show()}),view.hide(),interaction.options.audioingapIsOn()?parentNode.is(".element-wrap")&&node.closest(".element-wrap").prev().is("object[type='audio/audio']")?(parentNode.append(rendered),parentNode.siblings(".audio-gap").last().append(parentNode)):node.prev().is("object[type='audio/audio']")?parentNode.find(".audio-gap").last().append(rendered):parentNode.append(rendered):parentNode.append(rendered);var enumeration=interaction.enumAnswers.next();enumeration&&enumeration.then(function(enumSymbol){rendered.before(enumSymbol),rendered.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}),"Exam"!==LOInfo.mode&&"Trainer"!==LOInfo.mode||0==interaction.blockItems.length()&&interaction.bind("show:deferred",function(){rendered.focus()}),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.ISDropdownBuilder"),a5.model_builder.builders.push(new a5.model_builder.ISDropdownBuilder),a5.model_builder.ICTextGap={isResponsible:function(node,interaction){return node.is("textEntryInteraction")&&"Input:Completion:Text gap"==interaction.identifier&&!interaction.options.gapsIsInvisible()},_buildWordpool:function(interaction,parentNode){var alignment=interaction.options.getPoolAlignment();if(parentNode.find(".wordpool").length)return{pool:parentNode.find(".pool").first(),block:parentNode.find(".block").first()};var wordpool=new a5.views.WordPool(alignment,!1,interaction),words=_.map(interaction.getAllResponseDeclaration(),function(rD){return rD.values});return words=_.map(words,function(answers){return a5.utils.containsUnescaped(answers.join(""),"|")?_.filter(answers,function(answer){return a5.utils.containsUnescaped(answer,"|")||a5.utils.startsWith(answer,"**")}):answers}),words=_.map(_.flatten(words),function(word){return a5.utils.startsWith(word,"**")&&(word=word.replace("**","")),word=word.split("##").shift(),interaction.options.gapcharactersIsShow()&&(word=_.str.reverse(word),word=word.replace(/[{}](?!\\)/g,""),word=_.str.reverse(word)),word}),words=_(words).uniq(),words=_.map(words,function(word){return a5.utils.splitUnescaped(word,"|").pop()}),words=_(words).filter(function(word){return"%0"!==word}),words=_(words).map(function(word){return a5.utils.unescapeReservedSyntaxSymbols(word)}),interaction.options.randomiseanswersIsTrue()?words=_.shuffle(words):interaction.options.poolorderIsAlphabetical()?words=a5.utils.array.sortBy(words,null,!0):interaction.options.poolorderIsNatural()&&(words=a5.utils.array.naturalSort(words,null,!0,!0)),_.each(words,function(word){wordpool.append(word,interaction.options.gaptextaudioIsTrue())},this),parentNode.append(wordpool.render()),{pool:parentNode.find(".pool").first(),block:parentNode.find(".block").first()}},_buildHintLetters:function(interaction,answers){var hints=[];return interaction.options.gapcharactersIsShow()&&_.each(answers,function(answer,index){if(a5.utils.containsUnescaped(answer,"{")&&a5.utils.containsUnescaped(answer,"}")){var parts=_.str.reverse(answer).split(/(\}(?!\\).+?\{(?!\\))/).reverse(),word="";_.each(parts,function(part){var str=_.str.reverse(part);a5.utils.startsWith(str,"{")&&a5.utils.endsWith(str,"}")&&(str=str.substring(1,str.length-1),hints.push({str:str,from:word.length,to:word.length+str.length-1})),word+=str}),answers[index]=word}}),hints},buildTextEntryInteraction:function(interaction,parentNode,node){var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")),answers=_.map(correctResponse.values,function(val){return htmlDecode(val)}),wordpool=this._buildWordpool(interaction,interaction.$(".interaction")),areaSize=null;interaction.$(".contentblock").appendTo(wordpool.block),node.attr("height")&&node.attr("width")&&(areaSize=[node.attr("width"),node.attr("height")]);var display_words=_.chain(answers).filter(function(answer){return a5.utils.containsUnescaped(answer,"|")}).map(function(answer){return a5.utils.splitUnescaped(answer,"|").pop()}).value();answers=_.map(answers,function(answer){return _.first(a5.utils.splitUnescaped(answer,"|"))});var distractors=[];answers=_(answers).reject(function(answer){return!!_.str.startsWith(answer,"**")&&(distractors.push(answer.replace("**","")),!0)});var answerWithGroup=_(answers).find(function(answer){return _.str.contains(answer,"##")}),group=answerWithGroup&&answerWithGroup.split("##").pop();answers=_(answers).map(function(answer){return _.first(answer.split("##"))});var hints=this._buildHintLetters(interaction,answers);answers=_(answers).map(function(answer){return a5.utils.unescapeReservedSyntaxSymbols(answer)}),display_words=_(display_words).map(function(answer){return a5.utils.unescapeReservedSyntaxSymbols(answer)});var enumeration=interaction.enumAnswers.next();if(!interaction.blockItems.gapCollectionModel&&(interaction.blockItems.gapCollectionModel=new a5.models.interaction.ICTextGapCollection({parent:interaction.blockItems,ignoreCase:interaction.options.caseInsensitiveIsTrue(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),hasOrderedResponsesFirstAnswer:interaction.options.orderDependencyIsFirst_answer()}),!interaction.options.orderDependencyIsOff())){var interactionBlock=interaction.blockItems,oldFn=interactionBlock.getScores;interactionBlock.getScores=_.bind(function(){return group?interactionBlock.gapCollectionModel.updateOrderDependencyGroups():interactionBlock.gapCollectionModel.updateOrderDependency(),oldFn.apply(interactionBlock)},this)}var model=new a5.models.interaction.ICTextGap({enumeration:enumeration,global_enumeration:a5.mainBuilder.options(!0).continuousEnumerationIsOn(),prefill:!_.isEmpty(answers)&&interaction.prefill.isPrefill(),correct:answers,distractors:distractors,display_words:display_words,hintLetters:hints,tryAgainKeep:interaction.options.tryAgainIsKeepall(),
ignoreCase:interaction.options.caseInsensitiveIsTrue(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreSpaces:interaction.options.ignoreSpacesIsOn(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),spellcheck:interaction.options.spellcheckIsOn(),parent:interaction.blockItems.gapCollectionModel,resizeGaps:interaction.options.gapResizeIsOn()||interaction.options.gapcharactersIsShow(),charactersNumber:interaction.options.gapcharactersIsShow(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),inputStyle:node.attr("style"),area:areaSize,wordpool:wordpool,allowRepeat:interaction.options.repeatAnswersIsAllow(),hasOrderedResponses:!interaction.options.orderDependencyIsOff(),group:group,blockNumber:interaction.items.length()});model.assignAnswerFeedback(node);var view=new a5.views.interaction.ICTextGap(model),rendered=view.render();if(interaction.options.audioingapIsOn()?parentNode.is(".element-wrap")&&node.closest(".element-wrap").prev().is("object[type='audio/audio']")?(parentNode.append(rendered),parentNode.siblings(".audio-gap").last().append(parentNode)):node.prev().is("object[type='audio/audio']")?parentNode.find(".audio-gap").last().append(rendered):parentNode.append(rendered):parentNode.append(rendered),interaction.bind("show:deferred",function(){view.onInteractionShow()}),interaction.blockItems.add(model),1==interaction.items.length()&&1==interaction.blockItems.length()&&a5.dp.config.ICTextgapActive&&interaction.bind("show:deferred",function(){rendered.children().focus()}),!areaSize&&!model.prefill){var adjustGapSize=function(){a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.removeBodySubstyle(),interaction.addBodySubstyle();var firstInput=interaction.$(".input-text input").first();interaction.options.gapsIsSamelongest()?view.adjustGapSizeToLongestResponse(interaction.viewData.getLongestAllResponses(interaction.index,firstInput)):view.adjustGapSizeToLongestCorrect(interaction.viewData.getLongestResponse(node.attr("responseIdentifier"),firstInput)),interaction.removeBodySubstyle(),a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.addBodySubstyle()};interaction.bind("rendered",function(){adjustGapSize()},this,{once:!0}),a5.hooks.interactionFontUpdated.add(function(){interaction.runOutOfFlow(adjustGapSize)}),a5.hooks.layoutStylesLoaded.add(function(){interaction.runOutOfFlow(adjustGapSize)})}a5.callbacks.interaction.bind("loaded",function(i){if(i===interaction&&"Input:Completion:Text gap"==interaction.identifier){this.addWordClasses(view.node,".input-text");var textBeforeGap=view.node.get(0).previousSibling;textBeforeGap&&view.node.find(".enum-answers:last").after(textBeforeGap)}},this)}},a5.model_builder.Base.extend("a5.model_builder.ICTextGap"),a5.model_builder.builders.push(new a5.model_builder.ICTextGap),a5.model_builder.ICNumberTriangle={isResponsible:function(node,interaction){return"Input:Completion:Number triangle"===interaction.identifier&&(node.is("#contentblock")||node.is("textEntryInteraction")||node.is(".triangle-display-number"))},buildDiv:function(interaction,parentNode,node){node.is("#contentblock")?this._buildContentBlock(interaction,parentNode,node):this._buildDisplayNumber(interaction,parentNode,node)},_buildContentBlock:function(interaction,parentNode,node){this.index=0,(new a5.model_builder.Element).build(interaction,parentNode,node)},_buildDisplayNumber:function(interaction,parentNode,node){this._buildMainNode(interaction,parentNode);var $display=this.buildContents(node,interaction,$("<span>"));$display.addClass("triangle-display-number"),$display.addClass(this._indexToTriangleClass(this.index)),parentNode.find(".number-triangle").append($display),this.index++},buildTextEntryInteraction:function(interaction,parentNode,node){this._buildMainNode(interaction,parentNode),this._super(interaction,parentNode.find(".number-triangle"),node),parentNode.find(".input-text:last, .prefill:last").addClass(this._indexToTriangleClass(this.index)),this.index++},_buildMainNode:function(interaction,parentNode){0===this.index&&parentNode.append($("<div>").addClass("number-triangle").toggleClass("multiplication",interaction.options.operatorIsMultiplication()))},_indexToTriangleClass:function(index){return"triangle-"+["top-left","top","top-right","left","right","bottom"][index]}},a5.model_builder.ICTextGap.extend("a5.model_builder.ICNumberTriangle"),a5.model_builder.builders.push(new a5.model_builder.ICNumberTriangle),a5.model_builder.ICNumberPyramid={isResponsible:function(node,interaction){return"Input:Completion:Number pyramid"===interaction.identifier&&(node.is("#contentblock")||node.is("textEntryInteraction")||node.is(".pyramid-display-number"))},buildDiv:function(interaction,parentNode,node){node.is("#contentblock")?this._buildContentBlock(interaction,parentNode,node):this._buildDisplayNumber(interaction,parentNode,node)},_buildContentBlock:function(interaction,parentNode,node){this.index=0,(new a5.model_builder.Element).build(interaction,parentNode,node)},_buildDisplayNumber:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-pyramid"));var $display=this.buildContents(node,interaction,$("<span>"));$display.addClass("pyramid-display-number"),$display.addClass(this._indexToPyramidClass(this.index)),parentNode.find(".number-pyramid").append($display),this.index++},buildTextEntryInteraction:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-pyramid")),this._super(interaction,parentNode.find(".number-pyramid"),node),parentNode.find(".input-text:last, .prefill:last").addClass(this._indexToPyramidClass(this.index)),this.index++},_indexToPyramidClass:function(index){return"pyramid-"+["top","left","right","center","bottom-left","bottom","bottom-right"][index]}},a5.model_builder.ICTextGap.extend("a5.model_builder.ICNumberPyramid"),a5.model_builder.builders.push(new a5.model_builder.ICNumberPyramid),a5.model_builder.ICNumberWall={isResponsible:function(node,interaction){return"Input:Completion:Number wall"===interaction.identifier&&(node.is("#contentblock")||node.is("textEntryInteraction")||node.is(".wall-display-number"))},buildDiv:function(interaction,parentNode,node){node.is("#contentblock")?this._buildContentBlock(interaction,parentNode,node):this._buildDisplayNumber(interaction,parentNode,node)},_buildContentBlock:function(interaction,parentNode,node){this.index=0,(new a5.model_builder.Element).build(interaction,parentNode,node)},_buildDisplayNumber:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-wall"));var $display=this.buildContents(node,interaction,$("<span>"));$display.addClass("wall-display-number"),$display.appendTo(this._getLevelContainer(parentNode)),this.index++},buildTextEntryInteraction:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-wall")),this._super(interaction,$('<div class="wall-input-text">').appendTo(this._getLevelContainer(parentNode)),node),this.index++},_indexToWallClass:function(index){return"wall-level-"+(Math.floor(-.5+Math.sqrt(.25+2*index))+1)},_getLevelContainer:function(parentNode){var className=this._indexToWallClass(this.index),$wall=parentNode.find(".number-wall"),$found=$wall.children("."+className);return $found.length?$found:$("<div>").addClass("wall-level "+className).appendTo($wall)}},a5.model_builder.ICTextGap.extend("a5.model_builder.ICNumberWall"),a5.model_builder.builders.push(new a5.model_builder.ICNumberWall),a5.model_builder.ICNumberLayers={isResponsible:function(node,interaction){return"Input:Completion:Number layers"===interaction.identifier&&(node.is("#contentblock")||node.is("textEntryInteraction")||node.is(".layers-display-number"))},buildDiv:function(interaction,parentNode,node){node.is("#contentblock")?this._buildContentBlock(interaction,parentNode,node):this._buildDisplayNumber(interaction,parentNode,node)},_buildContentBlock:function(interaction,parentNode,node){this.index=0,this.numberColumns=interaction.options.getNumbercolumns(),(new a5.model_builder.Element).build(interaction,parentNode,node)},_buildDisplayNumber:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-layers"));var $display=this.buildContents(node,interaction,$("<span>"));$display.addClass("layers-display-number"),$display.appendTo(this._getLevelContainer(parentNode)),this.index++},buildTextEntryInteraction:function(interaction,parentNode,node){0===this.index&&parentNode.append($("<div>").addClass("number-layers")),this._super(interaction,$('<div class="layers-input-text">').appendTo(this._getLevelContainer(parentNode)),node),this.index++},_indexToLayersClass:function(index){for(var level=0;index>0;level++)index-=Math.pow(2,level)*this.numberColumns;return"layer-"+level},_getLevelContainer:function(parentNode){var className=this._indexToLayersClass(this.index),$layers=parentNode.find(".number-layers"),$found=$layers.children("."+className);return $found.length?$found:$("<div>").addClass("layer "+className).appendTo($layers)}},a5.model_builder.ICTextGap.extend("a5.model_builder.ICNumberLayers"),a5.model_builder.builders.push(new a5.model_builder.ICNumberLayers),a5.model_builder.ICMath={isResponsible:function(node,interaction){return node.is("textEntryInteraction")&&"Input:Completion:Maths"===interaction.identifier&&!interaction.options.gapsIsInvisible()},buildTextEntryInteraction:function(interaction,parentNode,node){var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")),answers=htmlDecode(correctResponse.values.join("*")),answerIsFormula=!1;0===answers.indexOf("=")?(answers=answers.slice(1),answerIsFormula=!0):answers=this.transformValToExpression(answers);var defaultValue=correctResponse.defaultValue||!answerIsFormula&&correctResponse.values[0],enumeration=interaction.enumAnswers.next(),expression=answers,defaultAnswer=defaultValue||null;interaction.items.gapCollectionModel||(interaction.items.gapCollectionModel=new a5.models.interaction.ICMathCollection({parent:interaction.items,showAnswerBehaviour:!a5.mainBuilder.options().seeAnswersIsOff()}));var model=new a5.models.interaction.ICMath({enumeration:enumeration,global_enumeration:a5.mainBuilder.options(!0).continuousEnumerationIsOn(),prefill:!_.isEmpty(answers)&&interaction.prefill.isPrefill(),formula:expression,defaultValue:defaultAnswer,tryAgainKeep:interaction.options.tryAgainIsKeepall(),ignoreSpaces:interaction.options.ignoreSpacesIsOn(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),parent:interaction.items.gapCollectionModel,preventRepeat:interaction.options.repeatAnswersIsPrevent(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen(),numberInput:interaction.options.getNumberInput(),referenceDependency:interaction.options.validatedependentgapsIsOn(),inputStyle:node.attr("style")});model.assignAnswerFeedback(node);var view=new a5.views.interaction.ICMath(model,null,interaction,{resize:interaction.options.gapResizeIsOn(),defaultSize:this.getDefaultSize(defaultValue),index:interaction.blockItems.length()});interaction.items.gapViews||(interaction.items.gapViews=[]),interaction.items.gapViews.push(view);var rendered=view.render();parentNode.append(rendered),interaction.blockItems.add(model),interaction.items.gapCollectionModel.itemList().length===_.keys(interaction.getAllResponseDeclaration()).length&&(interaction.items.gapCollectionModel.updateDependency(),this.updateViewsSizes(interaction))},updateViewsSizes:function(interaction){if(interaction.options.gapsIsSamelongest()){var maxWidth,defaultAnswers=_.chain(interaction.items.gapViews).map(function(view){return view.options.defaultSize}).where({measure:"answer"}).value();if(defaultAnswers&&defaultAnswers.length){var input=interaction.$(".input-text input").first();maxWidth=_.chain(defaultAnswers).map(function(da){return input.textWidth(da.value)}).max().value()}else maxWidth=a5.dp.config.mathsGapDefaultWidth;_.each(interaction.items.gapViews,function(view){view.options.defaultSize={value:maxWidth,measure:"px"},/[\s;]*width:/gi.test(view.model.inputStyle)&&(view.options.defaultSize.value=view.input.width())})}_.invoke(interaction.items.gapViews,"adjustGapSizeToDefault"),interaction.items.gapViews=null},getDefaultSize:function(defaultValue){return defaultValue?{value:defaultValue,measure:"answer"}:{value:a5.dp.config.mathsGapDefaultWidth,measure:"px"}},transformValToExpression:function(val){return val.split("*").map(function(item){return"x=="+item}).join("||")}},a5.model_builder.Base.extend("a5.model_builder.ICMath"),a5.model_builder.builders.push(new a5.model_builder.ICMath),a5.model_builder.ICMathQuizz={isResponsible:function(node,interaction){return node.is("textEntryInteraction, responseConfiguration")&&"Input:Completion:MathsQuizzes"==interaction.identifier},buildTextEntryInteraction:function(interaction,parentNode,node){var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier"));if(correctResponse.values.length>0){var html=(new DOMParser).parseFromString(correctResponse.values[0],"text/html"),xml=html.body.firstChild.getAttribute("data-wirisquiz"),model=new a5.models.interaction.ICMathQuizz({xml:xml}),view=new a5.views.interaction.ICMathQuizz({model:model});parentNode.append(view.node),view.render(),interaction.blockItems.add(model)}}},a5.model_builder.Base.extend("a5.model_builder.ICMathQuizz"),a5.model_builder.builders.push(new a5.model_builder.ICMathQuizz),a5.model_builder.ICTextGapInvisible={isResponsible:function(node,interaction){return"Input:Completion:Text gap"==interaction.identifier&&interaction.options.gapsIsInvisible()&&(node.is("#contentblock, textEntryInteraction")||node[0].nodeType==Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){if(this.model=new a5.models.interaction.ICTextGapInvisible({}),this.buildContents(node,interaction),1==interaction.items.length())if(interaction.options.prefillIsFirstblock())_.each(this.model.nodes,function(child){child.prefill=!0});else if(interaction.options.prefillIsFirstitem()&&this.model.nodes.length>0){var prefilled=_.find(this.model.nodes,function(e){return e.isInput()&&e.hasAnswer()});prefilled.prefill=!0}interaction.blockItems.add(this.model);var view=new a5.views.interaction.ICTextGapInvisible(this.model,interaction.enumBlock.next());parentNode.append(view.render()),this.model=null},buildTextNode:function(interaction,parentNode,node){var text=node[0].textContent,self=this;if(this.model){var words=text.replace(/\s+/g," ").trim().split(" ");_.each(words,function(e){(self.model.peek()._instance_of("Obj")||self.model.peek()._instance_of("a5.models.interaction.ICTextGapInvisibleText"))&&self.model.push(new a5.models.interaction.ICTextGapInvisibleGap({parent:self.model})),self.model.push(new a5.models.interaction.ICTextGapInvisibleText({parent:self.model,word:e}))})}else parentNode.append(text)},buildTextEntryInteraction:function(interaction,parentNode,node){var answers=interaction.getCorrectResponse(node.attr("responseIdentifier")).values;this.model.push(new a5.models.interaction.ICTextGapInvisibleGap({parent:this.model,answers:answers}))}},a5.model_builder.Base.extend("a5.model_builder.ICTextGapInvisible"),a5.model_builder.builders.push(new a5.model_builder.ICTextGapInvisible),a5.model_builder.ICTextCorrectionReplace={isResponsible:function(node,interaction){return"Input:Completion:Text correction"==interaction.identifier&&interaction.options.errorCorrectionIsReplace()&&(node.is("#content, #contentblock, inlineChoiceInteraction")||node[0].nodeType==Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){node.is("#content")?(this.sharedObject={},this._super(interaction,parentNode,node)):this.buildContentblock(interaction,parentNode,node)},buildContentblock:function(interaction,parentNode,node){var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next()),this.model=new a5.model.interaction.ICTextCorrectionReplace({blockEnumeration:blockEnumeration,signalErrorsAlways:interaction.options.signalErrorIsHighlight(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainLock:interaction.options.tryAgainIsLock(),tryAgainFrozen:interaction.options.tryAgainIsFrozen(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),sharedObject:this.sharedObject,userSelection:interaction.options.getUserselection(),parent:interaction.blockItems}),this.view=new a5.view.interaction.ICTextCorrectionReplace(this.model,interaction,node.attr("class")),this.buildContents(node,interaction,this.view.node),parentNode.append(this.view.render()),interaction.blockItems.add(this.model),this.model=null,this.view=null},buildTextNode:function(interaction,parentNode,node){var model,view;this.model?_.each($(node).text().match(/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$|\S+(?=[.,:;]+$)|\S+(?=[.,:;]+\s)|\S+/g),function(str){/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$/.test(str)||interaction.options.prefillIsFirstblock()&&1==interaction.items.length()?(model=new a5.model.interaction.ICTextCorrectionReplacePlain({text:str}),this.model.push(model),view=new a5.view.interaction.ICTextCorrectionReplacePlain(model,this.view),this.view.push(view)):(model=new a5.model.interaction.ICTextCorrectionReplaceText({text:str,parent:this.model,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()}),this.model.push(model),view=new a5.view.interaction.ICTextCorrectionReplaceText(model,this.view),this.view.push(view)),parentNode.append(view.render())},this):parentNode.append($(node).text())},buildInlineChoiceInteraction:function(interaction,parentNode,node){var values=_.map(node.children(),function(n){return htmlDecode($(n).text())}),wrong=values.shift(),prefill=interaction.options.prefillIsFirstitem()&&1==interaction.items.length()&&0==this.model.countWrongWords();prefill=prefill||interaction.options.prefillIsFirstblock()&&1==interaction.items.length();var model=new a5.model.interaction.ICTextCorrectionReplaceText({parent:this.model,text:wrong,answers:values,prefill:prefill,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()});model.assignAnswerFeedback(node.children("[answerfeedback]")),this.model.push(model);var view=new a5.view.interaction.ICTextCorrectionReplaceText(model,this.view);this.view.push(view),parentNode.append(view.render()),a5.callbacks.interaction.bind("loaded",function(i){i===interaction&&this.addWordClasses(view.node,".input-text")},this)}},a5.model_builder.Content.extend("a5.model_builder.ICTextCorrectionReplace"),a5.model_builder.builders.push(new a5.model_builder.ICTextCorrectionReplace),a5.model_builder.ICTextCorrectionLine={isResponsible:function(node,interaction){return"Input:Completion:Text correction"===interaction.identifier&&interaction.options.errorCorrectionIsLine()&&(node.is("#contentblock, inlineChoiceInteraction")||node[0].nodeType===Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){this.isBuildingContentblock=!0;var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next());var prefilled=(interaction.options.prefillIsFirstitem()||interaction.options.prefillIsFirstblock())&&1===interaction.items.length();this.model=new a5.models.interaction.ICTextCorrectionLine({blockEnumeration:blockEnumeration,prefilled:prefilled,signalErrorsAlways:interaction.options.signalErrorIsHighlight(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainLock:interaction.options.tryAgainIsLock(),tryAgainFrozen:interaction.options.tryAgainIsFrozen(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),userSelection:interaction.options.getUserselection()}),this.buildContents(node,interaction);var view=new a5.views.interaction.ICTextCorrectionLine(this.model);parentNode.append(view.render()),interaction.blockItems.add(this.model),this.model=null,this.isBuildingContentblock=!1},buildTextNode:function(interaction,parentNode,node){if(this.isBuildingContentblock){var model=new a5.models.interaction.ICTextCorrectionLineText({parent:this.model,text:node.text()});this.model.push(model)}else(new a5.model_builder.Text).build(interaction,parentNode,node)},buildInlineChoiceInteraction:function(interaction,parentNode,node){var values=_.map(node.children(),function(n){return htmlDecode($(n).text())}),wrong=values.shift(),model=new a5.models.interaction.ICTextCorrectionLineText({parent:this.model,text:wrong,wrong:!0});model.assignAnswerFeedback(node.children("[answerfeedback]")),this.model.push(model),this.model.answers=values}},a5.model_builder.Base.extend("a5.model_builder.ICTextCorrectionLine"),a5.model_builder.builders.push(new a5.model_builder.ICTextCorrectionLine),a5.model_builder.ICTextCorrectionSentence={isResponsible:function(node,interaction){return"Input:Completion:Text correction"==interaction.identifier&&interaction.options.errorCorrectionIsSentence()&&(node.is("#contentblock, inlineChoiceInteraction")||node[0].nodeType==Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next()),this.model=new a5.models.interaction.ICTextCorrectionSentence({blockEnumeration:blockEnumeration,prefilled:(interaction.options.prefillIsFirstitem()||interaction.options.prefillIsFirstblock())&&1==interaction.items.length(),signalErrorsAlways:interaction.options.signalErrorIsHighlight(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn(),subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),userSelection:interaction.options.getUserselection()}),this.buildContents(node,interaction);var view=new a5.views.interaction.ICTextCorrectionSentence(this.model);parentNode.append(view.render()),interaction.blockItems.add(this.model),this.model.setInitialValue(),this.model=null},buildTextNode:function(interaction,parentNode,node){var text=node[0].textContent,self=this;this.model?self.model.push(new a5.models.interaction.ICTextCorrectionSentenceText({parent:self.model,text:text})):parentNode.append(text)},buildInlineChoiceInteraction:function(interaction,parentNode,node){var values=_.map(node.children(),function(n){return htmlDecode($(n).text())}),wrong=values.shift(),model=new a5.models.interaction.ICTextCorrectionSentenceText({parent:this.model,text:wrong,answers:values});model.assignAnswerFeedback(node.children("[answerfeedback]")),this.model.push(model)}},a5.model_builder.Base.extend("a5.model_builder.ICTextCorrectionSentence"),a5.model_builder.builders.push(new a5.model_builder.ICTextCorrectionSentence),a5.model_builder.IMVoice={isResponsible:function(node,interaction){return(node.is("recorder")||a5.utils.hasId(node,"content"))&&"Input:Match:Voice"===interaction.identifier},buildDiv:function(interaction,parentNode,node){if(interaction.options.displayRecordingTestIsOn()){var dialog=a5.view.dialog.SpeakingRecordingTest.getInstance();dialog.render(),dialog.autoOpen(interaction)}this._super(interaction,parentNode,node)},buildRecorder:function(interaction,parentNode,node){var model=new a5.models.interaction.IMVoice({interaction:interaction,text:node.text(),timelimit:parseInt(node.attr("timelimit"),10)||void 0,scorable:interaction.blockItems.isScorable()}),view=new a5.views.interaction.IMVoice(model);parentNode.append(view.render()),interaction.blockItems.add(model)}},a5.model_builder.Content.extend("a5.model_builder.IMVoice"),a5.model_builder.builders.push(new a5.model_builder.IMVoice),a5.model_builder.FreeWriting={isResponsible:function(node,interaction){return node.is("textinput, richtextinput")&&"Input:Creative:Extended writing"===interaction.identifier},buildTextinput:function(interaction,parentNode,node){var width=node.attr("width"),height=node.attr("height"),max=node.attr("max")||"",size=_([width,height,max]).compact(),txt=_.str.sprintf("[**@%s@%s]",size.join(":"),this._toPlainText(node));parentNode.append(txt)},buildRichtextinput:function(interaction,parentNode,node){var width=node.attr("width"),height=node.attr("height"),max=node.attr("max")||"",size=_([width,height,max]).compact(),txt=_.str.sprintf("[***@%s@%s]",size.join(":"),this._toPlainText(node));parentNode.append(txt)},_toPlainText:function(node){var str="";return _(node.contents()).each(function(c){c.tagName&&"br"===c.tagName.toLowerCase()?str+="\n":str+=$(c).text().replace(/\t/g,"").replace(/\n/g,"")}),str}},a5.model_builder.Base.extend("a5.model_builder.FreeWriting"),a5.model_builder.builders.push(new a5.model_builder.FreeWriting),a5.model_postBuilder.FreeWriting={isResponsible:function(node,interaction){return"Input:Creative:Extended writing"==interaction.identifier},init:function(){},build:function(interaction,parent){var model=new a5.models.interaction.ICExtendedWriting;interaction.blockItems.add(model),new a5.view.interaction.ICExtendedWriting(model,null,parent,interaction)}},Obj.extend("a5.model_postBuilder.FreeWriting");a5.model_postBuilder.builders=[new a5.model_postBuilder.FreeWriting],a5.model_builder.IMMarkingBuilder={markingForWordsRegex:/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$|\S+(?=[.,:;]+$)|\S+(?=[.,:;]+\s)|\S+/g,markingForLettersRegex:/\s+|\S+/g,whitespaceRegex:/\s+/,punctuationRegex:/[.,:;]+(?=[\s]+)|[.,:;]+$/,isResponsible:function(node,interaction){return"Identify:Mark:Marking"===interaction.identifier&&(node.is("gapMatchInteraction")||node.is("#content")||node.is("#contentblock")||node.is("gapText")||node.is("gap")&&this.isBuildingContentblock||3===node[0].nodeType)},buildDiv:function(interaction,parentNode,node){node.is("#content")?this.buildContents(node,interaction,parentNode):(this.isBuildingContentblock=!0,this._buildContentblock(interaction,parentNode,node),this.isBuildingContentblock=!1)},_buildContentblock:function(interaction,parentNode,node){var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next()),this.vent=new Obj,this.model=new a5.model.interaction.IMMarking({blockEnumeration:blockEnumeration,prefilled:interaction.options.prefillIsFirstblock()&&0==this.blockCounter,tryAgainKeep:interaction.options.tryAgainIsKeepall(),tryAgainLock:interaction.options.tryAgainIsLock(),tryAgainFrozen:interaction.options.tryAgainIsFrozen(),markingStyle:interaction.options.getMarkingstyle(),scoreValueIs1PerQuestion:interaction.options.scoreValuesIs1_point_question(),subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),interaction:interaction});var blockScore=interaction.options.getScoreValuesPerBlock().split(",");blockScore=parseInt(blockScore[this.blockCounter],10),_.isNaN(blockScore)&&(blockScore=void 0),interaction.blockItems=new a5.models.interaction.QuestionItems({blockScore:blockScore,parent:interaction.items,interaction:interaction}),interaction.items.add(interaction.blockItems),interaction.blockItems.add(this.model);var $generated=this.buildContents(node,interaction),view=new a5.view.interaction.IMMarking(this.model,interaction,node.attr("class"),this.vent);view.appendDOM($generated),parentNode.append(view.render()),this.model=null,this.blockCounter++},_buildMarkingElementForWords:function(interaction,parentNode,node){var views=[];_.each(node.text().match(this.markingForWordsRegex),function(str){var n=null;this.whitespaceRegex.test(str)||this.punctuationRegex.test(str)?(n=new a5.model.interaction.IMMarkingText({text:str}),views.push(new a5.view.interaction.IMMarkingText(n,null)),this.model.push(n)):(n=new a5.model.interaction.IMMarkingElement({text:str,parent:this.model,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect()}),views.push(new a5.view.interaction.IMMarkingElement(n,null,this.vent)),this.model.push(n))},this),parentNode.append(_.invoke(views,"render"))},_buildMarkingElementForLetters:function(interaction,parentNode,node){var views=[];_.each(node.text().match(this.markingForLettersRegex),function(str){var n=null;this.whitespaceRegex.test(str)?(n=new a5.model.interaction.IMMarkingText({text:str}),views.push(new a5.view.interaction.IMMarkingText(n,null)),this.model.push(n)):_.each(str,function(letter){n=new a5.model.interaction.IMMarkingElement({text:letter,parent:this.model,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect()}),views.push(new a5.view.interaction.IMMarkingElement(n,null,this.vent)),this.model.push(n)},this)},this),parentNode.append(_.invoke(views,"render"))},buildTextNode:function(interaction,parentNode,node){this.isBuildingContentblock&&!this.isBuildingGapContent?interaction.options.highlightselectionIsLetters()?this._buildMarkingElementForLetters(interaction,parentNode,node):this._buildMarkingElementForWords(interaction,parentNode,node):parentNode.append(node.text())},buildGap:function(interaction,parentNode,node){var correct=inverseMap(interaction.getCorrectResponse(node.closest("gapMatchInteraction").attr("responseIdentifier")).asMapMulti());this.isBuildingGapContent=!0;var $xml=$($.parseXML("<root>"+node.attr("label")+"</root>")),$text=this.buildContents($xml.children(),interaction);this.isBuildingGapContent=!1;var model=new a5.model.interaction.IMMarkingElement({correct:correct[node.attr("identifier")],text:$text.contents(),parent:this.model,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()});model.assignAnswerFeedback(node),model.isDistractor()||((interaction.options.prefillIsFirstitem()&&0==this.gapCounter||interaction.options.prefillIsFirstblock()&&0==this.blockCounter)&&model.setPrefilled(),this.gapCounter++);var view=new a5.view.interaction.IMMarkingElement(model,null,this.vent);parentNode.append(view.render()),this.model.push(model),interaction.model=this.model},buildGapMatchInteraction:function(interaction,parentNode,node){interaction.iMMarkingCursor=!1,interaction.iMMarkingColors=[],interaction.iMMarkingColorsDefault=void 0,this.blockCounter=0,this.gapCounter=0,this.buildContents(node,interaction,parentNode),interaction.options.randomiseanswersIsTrue()&&interaction.toolbar.shuffleButtons(),this.setFirstColorActive(interaction),this.addEraseFunctionality(interaction)},buildGapText:function(interaction,parentNode,node){var markStyle,colors;if(_.isUndefined(interaction.iMMarkingColorsDefault)&&(interaction.iMMarkingColorsDefault=a5.utils.deepClone(a5.dp.config.markingDefaultColors)),node.attr("style")?markStyle=node.attr("style").toLowerCase():(colors=interaction.iMMarkingColorsDefault,markStyle=colors[node.text().trim()],_.isUndefined(markStyle)&&(markStyle=colors.$default.length>1?colors.$default.shift():colors.$default[0])),interaction.iMMarkingColors[node.attr("identifier")]=markStyle,!a5.dp.config.hideSingleColorMarkButtons||interaction.getAllResponseDeclaration().RESPONSE.values.length>1){var colValue=markStyle.replace(/#/g,"");interaction.toolbar.addToggleButton({label:node.text(),group:"colors",classes:["color","color-"+colValue],on:function(){interaction.iMMarkingCursor=node.attr("identifier")},
tts_audio:interaction.options.gaptextaudioIsTrue()});var style="<style type='text/css'> .button.color-"+colValue+":before{  background-color:"+markStyle+";}</style>";$(style).appendTo($("head"))}},setFirstColorActive:function(interaction){interaction.toolbar.buttons.length?interaction.toolbar.buttons[0].setPressed(!0):interaction.iMMarkingCursor=_.chain(interaction.iMMarkingColors).keys().first().value()},addEraseFunctionality:function(interaction){if(!a5.dp.config.hideSingleColorMarkButtons||interaction.getAllResponseDeclaration().RESPONSE.values.length>1){var template=a5.service.templates.render("a5.view.toolbar.erase");interaction.toolbar.addToggleButton({label:$(template).text()||"Erase",title:$(template).attr("title"),group:"colors",classes:["erase"],on:function(){interaction.iMMarkingCursor=!1,$("body").addClass("erasing")},off:function(){$("body").removeClass("erasing")}}),interaction.bind("hide",function(){$("body").removeClass("erasing")}),interaction.bind("show",function(){$("body").toggleClass("erasing",this.$(".toolbar .erase").is(".activated"))},interaction)}}},a5.model_builder.Base.extend("a5.model_builder.IMMarkingBuilder"),a5.model_builder.builders.push(new a5.model_builder.IMMarkingBuilder),a5.model_builder.IMProofingBuilder={NO_MARKABLE_REGEX:/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$/,TOKEN_REGEX:/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$|\S+(?=[.,:;]+$)|\S+(?=[.,:;]+\s)|\S+/g,isResponsible:function(node,interaction){return"Identify:Mark:Proofing"===interaction.identifier&&(node.is("#content, #contentblock, inlineChoiceInteraction")||node[0].nodeType===Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){node.is("#content")?(this.blockCounter=0,this.vent=new Obj,this.mainView=new a5.view.IMProofing({vent:this.vent,interaction:interaction}),this._super(interaction,this.mainView.$el,node),this.mainView.render()):this.buildContentblock(interaction,parentNode,node)},buildContentblock:function(interaction,parentNode,node){this.isBuildingContentblock=!0;var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next()),this.blockModel=new a5.model.interaction.IMProofingBlock({blockEnumeration:blockEnumeration,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()});var blockScore=interaction.options.getScoreValuesPerBlock().split(",");blockScore=parseInt(blockScore[this.blockCounter],10),_.isNaN(blockScore)&&(blockScore=void 0),interaction.blockItems=new a5.models.interaction.QuestionItems({blockScore:blockScore,parent:interaction.items,interaction:interaction}),interaction.items.add(interaction.blockItems),interaction.blockItems.add(this.blockModel),this.blockView=new a5.view.interaction.IMProofingBlock(this.blockModel,interaction),parentNode.append(this.blockView.node),this.buildContents(node,interaction,this.blockView.node),this.blockView.render(),this.isBuildingContentblock=!1,this.blockCounter++},buildTextNode:function(interaction,parentNode,node){var model,view;this.isBuildingContentblock?_.each($(node).text().match(this.TOKEN_REGEX),function(str){this.NO_MARKABLE_REGEX.test(str)||interaction.options.prefillIsFirstblock()&&1==interaction.items.length()?(model=new a5.model.interaction.IMProofingText({text:str,parent:this.blockModel}),view=new a5.view.interaction.IMProofingText(model,this.blockView)):(model=new a5.model.interaction.IMProofingElement({text:str,parent:this.blockModel,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall()}),this.blockModel.add(model),view=new a5.view.interaction.IMProofingElement(model,this.blockView,this.vent),this.blockView.add(view)),parentNode.append(view.node),view.render()},this):parentNode.append($(node).text())},buildInlineChoiceInteraction:function(interaction,parentNode,node){var inlineChoices=_.map(node.children(),function(inlineChoice){return htmlDecode($(inlineChoice).text())}),firstChoice=inlineChoices.shift(),markerAndText=firstChoice.split("|"),marker=markerAndText[0],text=markerAndText[1],correct={marker:marker,answers:inlineChoices},prefill=interaction.options.prefillIsFirstitem()&&1===interaction.items.length()&&0===this.blockModel.countWrongWords();prefill=prefill||interaction.options.prefillIsFirstblock()&&1===interaction.items.length();var model=new a5.model.interaction.IMProofingElement({text:text,correct:correct,parent:this.blockModel,prefill:prefill,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),ignoreCase:interaction.options.caseInsensitiveIsTrue(),ignorePunctuation:interaction.options.ignorePunctuationIsTrue(),ignoreAccents:interaction.options.ignoreAccentsIsOn()});this.blockModel.add(model);var view=new a5.view.interaction.IMProofingElement(model,this.blockView,this.vent);this.blockView.add(view),parentNode.append(view.node),view.render(),this.mainView.add(view)}},a5.model_builder.Content.extend("a5.model_builder.IMProofingBuilder"),a5.model_builder.builders.push(new a5.model_builder.IMProofingBuilder),a5.model_builder.IMAutocorrectBuilder={NO_MARKABLE_REGEX:/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$/,TOKEN_REGEX:/\s+|[.,:;]+(?=[\s]+)|[.,:;]+$|\S+(?=[.,:;]+$)|\S+(?=[.,:;]+\s)|\S+/g,isResponsible:function(node,interaction){return"Identify:Mark:Autocorrect"===interaction.identifier&&(node.is("#content, #contentblock, inlineChoiceInteraction")||node[0].nodeType===Node.TEXT_NODE)},buildDiv:function(interaction,parentNode,node){node.is("#content")?(this.blockCounter=0,this.mainView=new a5.view.IMAutocorrect({interaction:interaction}),this._super(interaction,this.mainView.$el,node),this.mainView.render()):this.buildContentblock(interaction,parentNode,node)},buildContentblock:function(interaction,parentNode,node){this.isBuildingContentblock=!0;var blockEnumeration=null;interaction.enumBlock&&interaction.enumBlock.useEnum()&&(blockEnumeration=interaction.enumBlock.next()),this.blockModel=new a5.model.interaction.IMAutocorrectBlock({blockEnumeration:blockEnumeration,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect()});var blockScore=interaction.options.getScoreValuesPerBlock().split(",");blockScore=parseInt(blockScore[this.blockCounter],10),_.isNaN(blockScore)&&(blockScore=void 0),interaction.blockItems=new a5.models.interaction.QuestionItems({blockScore:blockScore,parent:interaction.items,interaction:interaction}),interaction.items.add(interaction.blockItems),interaction.blockItems.add(this.blockModel),this.blockView=new a5.view.interaction.IMAutocorrectBlock(this.blockModel,interaction),parentNode.append(this.blockView.node),this.buildContents(node,interaction,this.blockView.node),this.blockView.render(),this.isBuildingContentblock=!1,this.blockCounter++},buildTextNode:function(interaction,parentNode,node){var model,view;this.isBuildingContentblock?_.each($(node).text().match(this.TOKEN_REGEX),function(str){this.NO_MARKABLE_REGEX.test(str)||interaction.options.prefillIsFirstblock()&&1===interaction.items.length()?(model=new a5.model.interaction.IMAutocorrectText({text:str,parent:this.blockModel}),view=new a5.view.interaction.IMAutocorrectText(model,this.blockView)):(model=new a5.model.interaction.IMAutocorrectElement({text:str,parent:this.blockModel,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall()}),this.blockModel.add(model),view=new a5.view.interaction.IMAutocorrectElement(model,this.blockView),this.blockView.add(view),this.mainView.add(view)),parentNode.append(view.node),view.render()},this):parentNode.append($(node).text())},buildInlineChoiceInteraction:function(interaction,parentNode,node){var inlineChoices=_.map(node.children(),function(inlineChoice){return htmlDecode($(inlineChoice).text())}),text=inlineChoices.shift(),correct=inlineChoices,prefill=interaction.options.prefillIsFirstitem()&&1===interaction.items.length()&&0===this.blockModel.countWrongWords();prefill=prefill||interaction.options.prefillIsFirstblock()&&1===interaction.items.length();var model=new a5.model.interaction.IMAutocorrectElement({text:text,correct:correct,parent:this.blockModel,prefill:prefill,subtractIncorrect:interaction.options.scorecalculationIsSubtractIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall()});this.blockModel.add(model);var view=new a5.view.interaction.IMAutocorrectElement(model,this.blockView);parentNode.append(view.node),view.render(),this.mainView.add(view)}},a5.model_builder.Content.extend("a5.model_builder.IMAutocorrectBuilder"),a5.model_builder.builders.push(new a5.model_builder.IMAutocorrectBuilder),a5.model_builder.ISCheckboxBuilder={isResponsible:function(node,interaction){return node.is("choiceInteraction")&&"Identify:Select:Checkbox"==interaction.identifier},buildChoiceInteraction:function(interaction,parentNode,node){var prefillBlock,self=this,correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")).values,model=new a5.models.interaction.ISCheckboxModel({alignment:interaction.options.getChoiceAlignment(),correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),allowSelectAll:interaction.options.checkboxSelectionsIsAll(),gaptextaudio:interaction.options.gaptextaudioIsTrue(),display:interaction.options.getQuestiondisplay(),attempts:interaction.checkAttempts}),shuffle=void 0,label="",answers=[];interaction.options.showInColumnsIsTrue()&&(shuffle=!1,correctResponse=_.filter(correctResponse,function(e){return!a5.utils.endsWith(e,"_0")}));var last_enum=void 0;if(_.each(this.fetchChoices(interaction,node,"simpleChoice",shuffle),function(e,index){var enumeration,$content=self.buildContents(e,interaction);if(interaction.options.showInColumnsIsTrue()&&a5.utils.endsWith($(e).attr("identifier"),"_0"))enumeration=interaction.enumAnswers.next(),label=$content.prepend('<span class="enum-placeholder"></span>'),enumeration.then(function(enumSymbol){$content.find(".enum-placeholder").replaceWith(enumSymbol)});else{interaction.options.showInColumnsIsTrue()?prefillBlock=0===interaction.blockItems.length()&&interaction.options.prefillIsFirstitem()||1===interaction.items.length()&&interaction.options.prefillIsFirstblock():(prefillBlock=1===interaction.items.length()&&interaction.options.prefillIsFirstblock(),interaction.options.enumerationinternalIsCorrect()||(enumeration=interaction.enumAnswers.next()));var correct=_.contains(correctResponse,$(e).attr("identifier"));correct&&interaction.options.enumerationinternalIsCorrect()&&interaction.enumAnswers.next().then(function(enumSymbol){var node=$("<span class='enum enum-per-question'>"+enumSymbol+"</span>");last_enum?node.insertAfter(last_enum):(parentNode.parents(".contentblock").attr("id","enumeration-"+a5.utils.enumText(enumSymbol)),parentNode.parents(".contentblock").attr("tabindex",-1),parentNode.parents(".contentblock").append(node)),last_enum=node,model.addEnumeration(parseInt(last_enum.text(),10))}.bind(this));var choiceModel=new a5.models.interaction.ISCheckboxChoiceModel({content:$content,parent:model,interaction:interaction,enumeration:enumeration,hasCheckbox:!interaction.options.hideCheckboxesIsTrue(),correct:correct,prefill:prefillBlock,value:$(e).attr("identifier"),label:label,tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()});choiceModel.assignAnswerFeedback($(e)),model.add(choiceModel),answers.push($content)}}),interaction.options.prefillIsFirstitem()){0===interaction.getActivityModels().length&&model.makeOnePrefilled()}interaction.options.showInColumnsIsTrue()&&!a5.utils.hasClass(parentNode,"checkbox-wrapper-show-in-columns")&&(this.header_node=new a5.views.interaction.ISCheckboxHeader(answers).render(),parentNode.addClass("checkbox-wrapper-show-in-columns"),parentNode.prepend(this.header_node));var isVisible=1===interaction.items.length()&&0===interaction.blockItems.length(),cblock=parentNode.is(".contentblock")?parentNode:parentNode.parents(".contentblock"),view=new a5.views.interaction.ISCheckboxView(model,prefillBlock,interaction.options.hideCheckboxesIsTrue(),interaction.options.showInColumnsIsTrue(),label,isVisible,cblock,interaction),random=interaction.options.randomiseanswersIsTrue()&&interaction.options.showInColumnsIsTrue();this._appendToDOM(view.render(),parentNode,random),interaction.options.questiondisplayIsActive()&&parentNode.addClass("expandableQuestion__content"),interaction.blockItems.add(model)},_appendToDOM:function($node,parentNode,random){var len=parentNode.find(".choice_interaction").length;random&&len?this._insertRandom($node,parentNode,len):parentNode.append($node)},_insertRandom:function($node,parentNode,len){if(len){var index=Math.floor(Math.random()*len);Boolean(Math.floor(2*Math.random()))?$node.insertBefore(parentNode.find(".choice_interaction:eq("+index+")")):$node.insertAfter(parentNode.find(".choice_interaction:eq("+index+")"))}}},a5.model_builder.Base.extend("a5.model_builder.ISCheckboxBuilder"),a5.model_builder.builders.push(new a5.model_builder.ISCheckboxBuilder),a5.model_builder.PPFlashcards={isResponsible:function(node,interaction){return node.is("matchInteraction")&&"Present:Present:Flashcards"==interaction.identifier},_serializeXML:function(node){return(new XMLSerializer).serializeToString(node)},_processPipeSyntax:function(node){var contents=node.contents().map(function(i,e){return this._serializeXML(e)}.bind(this)).get().join(""),fields=contents.split("|");return fields.length>1&&(fields=_.map(fields,function(field,index){return'<div class="card-content-'+index+'">'+field+"</div>"})),$($.parseXML("<root><div>"+fields.join("")+"</div></root>")).children("root").contents().get(0)},buildMatchInteraction:function(interaction,parentNode,node){var correct=interaction.getCorrectResponse(node.attr("responseIdentifier")).asInverseMap(),model=new a5.model.interaction.PPFlashcards({autoAudioPlayback:interaction.options.audioPlaybackIsAuto(),beforeFlipAudioPlayback:interaction.options.audioPlaybackIsBefore_card_flip()});_.each(node.find("simpleMatchSet:nth-child(2) > simpleAssociableChoice"),function(frontNode){frontNode=$(frontNode);var identifier=frontNode.attr("identifier"),backIdentifier=correct[identifier][0],backNode=node.find("simpleAssociableChoice[identifier="+backIdentifier+"]");model.addCard({front:this.buildContents(this._processPipeSyntax(frontNode),interaction),back:this.buildContents(this._processPipeSyntax(backNode),interaction)})},this);var view=new a5.view.interaction.PPFlashcards(model,parent,interaction.options.getCardFormat());interaction.blockItems.add(model),parentNode.append(view.render());var contentblock=node.find("#contentblock");contentblock.length&&parentNode.append(this._serializeXML(contentblock[0]))}},a5.model_builder.Base.extend("a5.model_builder.PPFlashcards"),a5.model_builder.builders.push(new a5.model_builder.PPFlashcards),a5.model_builder.PPSlideshow={isResponsible:function(node,interaction){return node.is("#slides")&&"Present:Present:Slideshow"==interaction.identifier},buildDiv:function(interaction,parentNode,node){var model=new a5.model.interaction.PPSlideshow({parent:interaction,shuffle:interaction.options.randomiseanswersIsTrue(),automaticControl:!interaction.options.automaticplayIsOff(),magnifySlides:interaction.options.automaticplayIsOn_magnify(),shuffleControl:interaction.options.shufflecontrolIsOn(),additionalImageControl:interaction.options.additionalimagecontrolIsOn(),step:a5.dp.config.ppslideshowStep,delay:a5.dp.config.ppslideshowDelay,magnifyStart:a5.dp.config.ppslideshowMagnifyStart,magnifyEnd:a5.dp.config.ppslideshowMagnifyEnd,minTime:a5.dp.config.ppslideshowMinTime,maxTime:a5.dp.config.ppslideshowMaxTime,endingTime:a5.dp.config.ppslideshowEndingTime});_(node.find("#slide")).each(function(slideNode){var slide={},$slide=this.buildContents(slideNode,interaction,null,"#decodeimage");slide.content=$slide.contents();var decodeNode=$(slideNode).find("#decodeimage");if(decodeNode.length>0){var $decode=this.buildContents(decodeNode,interaction);slide.decode=$decode.contents()}model.addSlide(slide)},this);var view=new a5.view.interaction.PPSlideshow(model);parentNode.append(view.render())}},a5.model_builder.Base.extend("a5.model_builder.PPSlideshow"),a5.model_builder.builders.push(new a5.model_builder.PPSlideshow),a5.model_builder.IdentifySelectMaze={isResponsible:function(node,interaction){return node.is("choiceInteraction")&&"Identify:Select:Maze"==interaction.identifier},build:function(interaction,parentNode,node){this.interaction=interaction,interaction.hasReadyListener||interaction.interactionDone||(interaction.hasReadyListener=!0,interaction.onInteractionRestoreListeners.register(this.attachEvents.bindTo(this))),interaction.started=!1,parentNode.prepend().prepend("<div class='padding'></div>"),parentNode.addClass("dir2_view notdone"),parentNode.css("clear","none");var correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier")),str=window.a5.mainBuilder.layout.getTemplate("maze");_.each($(node).find("simpleChoice"),function(n){var node=$("<span></span>");if(interaction.buildModelExludeNode(node,n,!0),"audio"==_.first($(n).attr("identifier"),5).join(""))parentNode.append("<span class='audio'>"+$(n).find("object:first").attr("data")+"</span> ");else{var s_1=window.a5.mainBuilder.layout.replaceSubpart(str,"maze_front",node.html()),obj=$(window.a5.mainBuilder.layout.replaceSubpart(s_1,"maze_back","<img src='images/maze-icon.jpg'>")),identifier=$(n).attr("identifier");_.include(correctResponse.values,identifier)&&obj.attr("id",identifier),parentNode.append(obj)}parentNode.parent().css("border","none")}),interaction.firstCall||(parentNode.parent().prepend("<div class='dir2_view'><div class='padding'></div><div class='button'><a href='#' class='start'>Start</a></div></div>"),interaction.ism=new a5.models.interaction.IdentifySelectMaze({node:parentNode.parent().parent()}),interaction.blockItems.add(interaction.ism),interaction.firstCall=!0,interaction.bind("show",_.bind(this.attachEvents,this)),interaction.bind("rendered",this.attachEvents,this),interaction.onInteractionReadyListeners.register(this.onInteractionReady.bindTo(this))),setTimeout(function(){_.each($("#content-"+interaction.index+" .contentblock"),function(cb){0==$(cb).find("p").children().length&&$(cb).remove()}),_.each($("#content-"+interaction.index+" .is-maze .contentblock"),function(cb){$(cb).find("br").remove()})},100),$("#content-"+interaction.index+" p.dir2_view").css("margin","0"),$("#content-"+interaction.index+" .is-maze .contentblock").css("float","left")},onInteractionReady:function(){var interaction=window.a5.mainBuilder.curInteraction;$("#content-"+interaction.index+" .contentblock p").length},updateState:function(){},attachEvents:function(){var self=this,interaction=window.a5.mainBuilder.curInteraction,audio=$("#content-"+interaction.index+" .dir2_view.active:first > span.audio:first").html(),audioPlayer=a5.service.media.audio.create(audio,{preload:!a5.dp.config.audioPreloadDisabled});a5.dp.config.audioPreloadDisabled&&interaction.preloadAudio(audioPlayer);var prefill=interaction.options.prefillIsFirstblock()||interaction.options.prefillIsFirstitem();$("#content-"+interaction.index+" a.start").die("click"),$("#content-"+interaction.index+" a.start").live("click",function(){$("#content-"+interaction.index+" .dir2_view.notdone:first").addClass("active").removeClass("notdone"),interaction.ism.step++,self.interaction.started=!0,a5.service.media.pauseAllExcept(audioPlayer),audioPlayer.play()}),$("#content-"+interaction.index+" .dir2_view.active > .panel").die("click"),$("#content-"+interaction.index+" .dir2_view.active > .panel").live("click",function(){if(!self.interaction.interactionDone)if($(this).addClass("checked"),$(this).attr("id"))$(this).addClass("flip"),$(this).parent().removeClass("active").addClass("done"),$("#content-"+interaction.index+" .dir2_view.notdone:first").removeClass("notdone").addClass("active"),interaction.ism.step++,audioPlayer.stop();else{var t=$(this);$(this).addClass("flip"),setTimeout(function(){t.removeClass("flip")},1e3)}interaction.ism.notifyValueChange()});var t=setInterval(function(){var h=$("#content-"+interaction.index+" .dir2_view:last").css("height");if("0px"!=h){clearInterval(t),prefill&&0==$("#content-"+interaction.index+" .dir2_view.active").length&&($("#content-"+interaction.index+" .dir2_view.notdone:first").removeClass("notdone").addClass("done"),interaction.ism.step++,$("#content-"+interaction.index+" .dir2_view.done:first > .image-choice").each(function(e,el){var $el=$(el);$el.attr("id")&&setTimeout(function(){$el.addClass("flip")},2e3)})),$("#content-"+interaction.index+" .dir2_view").css("height",parseInt(h,10)+30+"px"),$("#content-"+interaction.index+" .dir2_view").css("margin-bottom","20px");var pos=0;$("#content-"+interaction.index+" .dir2_view").each(function(e,div){var innerHeight=0;$(div).find(".image-choice").each(function(s,span){innerHeight+=parseInt($(span).css("height"),10)}),$(div).find(".padding").css("padding-top",(parseInt(h,10)-innerHeight)/2-20+"px");var $choices=$(div).find(".image-choice");if($choices.length>0){var target=$choices.filter("[id]").get(0);$choices=_.shuffle($choices);var newpos=_.indexOf($choices,target);pos+=Math.round(Math.random()),a5.utils.array.swap($choices,pos,newpos),$(div).find(".image-choice").remove(),$(div).append($choices)}$("#content-"+interaction.index+" .dir2_view").show()})}},0)}},a5.model_builder.Base.extend("a5.model_builder.IdentifySelectMaze"),a5.model_builder.builders.push(new a5.model_builder.IdentifySelectMaze),a5.model_builder.Pelmanism={isResponsible:function(node,interaction){return node.is("matchInteraction")&&"Identify:Select:Pelmanism"==interaction.identifier},build:function(interaction,parentNode,node){var answers={},correctResponse=interaction.getCorrectResponse(node.attr("responseIdentifier"));_.each(correctResponse.values,function(v){v=v.split(" "),answers[v[0]]=v[1],answers[v[1]]=v[0]});var container,model=new a5.model.interaction.ISPelmanismBoard({cardFormat:interaction.options.getCardFormat(),cardLayout:interaction.options.getCardLayout(),cardBack:interaction.options.getCardBack(),hasPrefill:interaction.options.prefillIsFirstitem(),scorable:interaction.blockItems.isScorable(),autoAudioPlayback:interaction.options.audioPlaybackIsAuto(),beforeFlipAudioPlayback:interaction.options.audioPlaybackIsBefore_card_flip(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()}),modeImg=interaction.options.cardBackIsImage(),modeImgSet=interaction.options.cardBackIsImagesets(),backimg_1="",backimg_2="",images=[];_.each(node.children("simpleMatchSet"),function(n){_.each($(n).find("simpleAssociableChoice"),function(s){if("OPTION148"===$(s).attr("identifier"))return void(images=$(s).find("img"))})}),(modeImg||modeImgSet)&&images.length>0&&(container=$("<div></div>"),interaction.buildModel(container,$(images[0]),!0),backimg_1=$(container).html(),backimg_2=backimg_1),modeImgSet&&images.length>1&&(container=$("<div></div>"),interaction.buildModel(container,$(images[1]),!0),backimg_2=$(container).html());var num=0;_.each(node.children("simpleMatchSet"),function(n){num++,_.each($(n).find("simpleAssociableChoice"),function(s){var identifier=$(s).attr("identifier");if("OPTION148"!==identifier){container=$("<span></span>"),interaction.buildModelExludeNode(container,s,!0);var backCard="";modeImg&&(backCard=backimg_1),modeImgSet&&(backCard=1===num?backimg_1:backimg_2),model.addCard({identifier:identifier,html:container,pair:answers[identifier],back:backCard,setNum:num})}},this)},this),interaction.blockItems.add(model);var view=new a5.views.interaction.ISPelmanism(model);parentNode.append(view.node),view.render(),container=$("<div></div>"),_.each(node.find(".contentblock"),function(s){var classes=$(s).attr("class").split(/\s+/).filter(function(klass){return"contentblock"!==klass}).join(" ");view.node.addClass(classes),interaction.buildModelExludeNode(container,s,!0)}),parentNode.append(container),parentNode.addClass("pmn_view");var otherContent=node.children(":not(simplematchset)");this.buildContents(otherContent,interaction,parentNode)}},a5.model_builder.Base.extend("a5.model_builder.Pelmanism"),a5.model_builder.builders.push(new a5.model_builder.Pelmanism),a5.model_builder.RadioAccordion={isResponsible:function(node,interaction){return node.is("#content")&&"Input:Creative:Free writing 2 col"==interaction.identifier},buildDiv:function(interaction,parentNode,node){var model=new a5.models.interaction.RadioAccordion,view=new a5.views.interaction.RadioAccordion(model);interaction.mediaZone.prepend('<div class="radio-accordion-open-alert"></div>'),this.eachContentBlock(interaction,parentNode,node,function(childNode){var childView=this.buildChildView(interaction,$(childNode));model.append(childView.model),view.append(childView)}),interaction.items.add(model),parentNode.append(view.render())},buildChildView:function(interaction,node){var model=new a5.models.interaction.RadioAccordionElement({content:this.buildContents(node,interaction).html(),enumeration:interaction.enumBlock.next(),alertNode:interaction.mediaZone.children(".radio-accordion-open-alert")});return new a5.views.interaction.RadioAccordionElement(model,node.attr("class"))}},a5.model_builder.Content.extend("a5.model_builder.RadioAccordion"),a5.model_builder.builders.push(new a5.model_builder.RadioAccordion),a5.model_builder.EndResult={SCORE_DEBOUNCE_TIMER:50,isResponsible:function(node,interaction){return this.methodToBuild(node)in this},build:function(interaction,parentNode,node){interaction.isEndResultScreen()&&0===interaction.blockItems.length()&&interaction.blockItems.add(a5.mainBuilder.resultsGenerator.model),this[this.methodToBuild(node)].call(this,interaction,parentNode,node)},buildBandFeedback:function(interaction,parentNode,node){var bands=_.map(node.attr("values").split("*"),function(x){return parseFloat(x)});this.addDeferredContent(parentNode,interaction,function(){var html=a5.service.templates.render("a5.view.EndResultBandFeedback"),$html=$(html);return $html.append(a5.mainBuilder.resultsGenerator.getBandFeedback(interaction,bands)),$html})},buildIndex:function(interaction,parentNode,node){if(this.currentInteraction){var html=a5.service.templates.render("a5.view.EndResultIndex",{index:this.currentInteractionLabel});parentNode.append(html)}},buildMetadata:function(interaction,parentNode,node){if(this.currentInteraction){var html=a5.service.templates.render("a5.view.EndResultMetadata",{metadata:this.currentInteractionLabel});parentNode.append(html)}},buildManuallyMarked:function(interaction,parentNode,node){var html=a5.service.templates.render("a5.view.EndResultManuallyMarked"),$html=html?$(html):parentNode;html&&parentNode.append($html),this.removeWhenReadyUnless(function(currentInteraction){return a5.mainBuilder.resultsGenerator.someManuallyMarked(currentInteraction)},function(){this.buildContents(node,interaction,$html)},$html,this.currentInteraction)},buildAutomaticMarked:function(interaction,parentNode,node){var html=a5.service.templates.render("a5.view.EndResultAutomaticMarked"),$html=html?$(html):parentNode;html&&parentNode.append($html),this.removeWhenReadyUnless(function(currentInteraction){return a5.mainBuilder.resultsGenerator.someAutomaticMarked(currentInteraction)},function(){this.buildContents(node,interaction,$html)},$html,this.currentInteraction)},buildLOMode:function(interaction,parentNode,node){if(node.attr("mode")==LOInfo.mode){var html=a5.service.templates.render("a5.view.EndResultLOMode"),$html=html?$(html):parentNode;html&&parentNode.append($html),this.buildContents(node,interaction,$html)}},buildForEachSection:function(interaction,parentNode,node){var html=a5.service.templates.render("a5.view.EndResultForEachSection"),$html=html?$(html):parentNode;html&&parentNode.append($html);var loParts=a5.mainBuilder.options(!0).getLOParts();_.each(loParts,function(part,index){var section=a5.service.templates.render("a5.view.EndResultForEachSectionItem",{section:part}),$section=section?$(section):$html;section&&$html.append($section);var interactions=[];_.each(_.range(part.from-1,part.to),function(index){var interaction=a5.mainBuilder.getInteractionFromIndex(index);interaction.isIntroScreen()||interactions.push(interaction)},this),this.currentInteraction=new a5.InteractionGroup(interactions,index),this.currentInteractionLabel=part.label,this.currentInteractionGroup="sections",this.buildContents(node,interaction,$section),this.currentInteractionGroup=null,this.currentInteraction=null},this)},buildForEachInteraction:function(interaction,parentNode,node){var html=a5.service.templates.render("a5.view.EndResultForEachInteraction"),$html=html?$(html):parentNode;html&&parentNode.append($html),_.each(_.initial(a5.mainBuilder.intList),function(i){var item=a5.service.templates.render("a5.view.EndResultForEachInteractionItem",{label:i.index+1}),$item=item?$(item):$html;item&&$html.append($item),this.removeWhenReadyUnless(function(){return i&&(a5.mainBuilder.resultsGenerator.someAutomaticMarked(i)||a5.mainBuilder.resultsGenerator.someManuallyMarked(i))},function(){this.currentInteraction=i,this.currentInteractionLabel=""+(this.currentInteraction.index+1),this.currentInteractionGroup="interactions",this.buildContents(node,interaction,$item),this.currentInteractionGroup=null,this.currentInteraction=null},$html,i,$item)},this)},buildForEachMetadata:function(interaction,parentNode,node){var values=node.attr("values")&&node.attr("values").split("*")||[],item=node.attr("item");values=_.map(values,function(v){var names=a5.utils.splitUnescaped(v,"|");return{key:names[0],alternative:names.length>1&&names[1]||""}});var getDescriptionFor=function(metadata){var syntax=_.find(values,function(v){return v.key===metadata.value});return syntax&&syntax.alternative||metadata.description},mapMetadataInteractions=_.chain(a5.mainBuilder.intList).initial().reduce(function(memo,i){return _.each(i.activityMetadata.getValues(item),function(v){var key=v.value;(_.isEmpty(values)||_.contains(_.pluck(values,"key"),key))&&(_.isEmpty(memo[key])&&(memo[key]={description:getDescriptionFor(v),interactions:[]}),memo[key].interactions.push(i))}),memo},{}).value(),html=a5.service.templates.render("a5.view.EndResultForEachMetadata"),$html=html?$(html):parentNode;html&&parentNode.append($html);var index=0;_.each(mapMetadataInteractions,function(value,key){var item=a5.service.templates.render("a5.view.EndResultForEachMetadataItem",{label:value.description}),$item=item?$(item):$html;item&&$html.append($item),this.currentInteraction=new a5.InteractionGroup(value.interactions,index++),this.currentInteractionLabel=value.description,this.currentInteractionGroup="metadata",this.buildContents(node,interaction,$item),this.currentInteractionGroup=null,this.currentInteraction=null},this)},buildScore:function(interaction,parentNode){this.addDeferredText(parentNode,interaction,function(currentInteraction,group){return $(a5.service.templates.render("a5.view.EndResultScore",{score:a5.mainBuilder.resultsGenerator.getScore(currentInteraction,group)}))})},buildScorevisual:function(interaction,parentNode){this.addDeferredText(parentNode,interaction,function(currentInteraction,group){return $(a5.service.templates.render("a5.view.EndResultScoreVisual",{total:a5.mainBuilder.resultsGenerator.getTotalquestions(currentInteraction,group),correct:a5.mainBuilder.resultsGenerator.getCorrectanswers(currentInteraction,group)}))})},buildTotalquestions:function(interaction,parentNode){this.addDeferredText(parentNode,interaction,function(currentInteraction,group){return $(a5.service.templates.render("a5.view.EndResultTotalQuestions",{total:a5.mainBuilder.resultsGenerator.getTotalquestions(currentInteraction,group)}))})},buildCorrectanswers:function(interaction,parentNode){this.addDeferredText(parentNode,interaction,function(currentInteraction,group){
return $(a5.service.templates.render("a5.view.EndResultCorrectAnswers",{correct:a5.mainBuilder.resultsGenerator.getCorrectanswers(currentInteraction,group)}))})},buildIncorrectanswers:function(interaction,parentNode){this.addDeferredText(parentNode,interaction,function(currentInteraction,group){return $(a5.service.templates.render("a5.view.EndResultIncorrectAnswers",{incorrect:a5.mainBuilder.resultsGenerator.getIncorrectanswers(currentInteraction,group)}))})},buildTimetaken:function(interaction,parentNode){this.addDeferredText(parentNode,interaction,function(currentInteraction){return $(a5.service.templates.render("a5.view.EndResultTimeTaken",{time:a5.mainBuilder.resultsGenerator.getTimetaken(currentInteraction)}))})},buildTimeout:function(interaction,parentNode){this.addDeferredText(parentNode,interaction,function(){return $(a5.service.templates.render("a5.view.EndResultTimeout",{time:a5.mainBuilder.resultsGenerator.getTimeout()}))})},buildDate:function(interaction,parentNode){this.addDeferredText(parentNode,interaction,function(){return $(a5.service.templates.render("a5.view.EndResultDate",{date:a5.mainBuilder.resultsGenerator.getDateString()}))})},buildAttempts:function(interaction,parentNode){this.addDeferredText(parentNode,interaction,function(){return $(a5.service.templates.render("a5.view.EndResultAttempts",{attempt:a5.mainBuilder.resultsGenerator.getAttempts()}))})},buildAllCorrectAttempt:function(interaction,parentNode,node){var attempt=parseInt($(node).attr("attempt"),10);this.addDeferredText(parentNode,interaction,function(){return $(a5.service.templates.render("a5.view.EndResultAllCorrectAttempt",{total:a5.mainBuilder.resultsGenerator.getAllCorrectAttempt(attempt),attempt:attempt}))})},buildUnsolved:function(interaction,parentNode,node){var threshold=parseInt($(node).attr("threshold"),10);this.addDeferredText(parentNode,interaction,function(){return $(a5.service.templates.render("a5.view.EndResultUnsolved",{unsolved:a5.mainBuilder.resultsGenerator.getUnsolved(threshold),threshold:threshold}))})},buildSolved:function(interaction,parentNode,node){var threshold=parseInt($(node).attr("threshold"),10);this.addDeferredText(parentNode,interaction,function(){return $(a5.service.templates.render("a5.view.EndResultSolved",{solved:a5.mainBuilder.resultsGenerator.getSolved(threshold),threshold:threshold}))})},buildNotAttempted:function(interaction,parentNode){this.addDeferredText(parentNode,interaction,function(){return $(a5.service.templates.render("a5.view.EndResultNotAttempted",{notattempted:a5.mainBuilder.resultsGenerator.getNotAttempted()}))})},removeWhenReadyUnless:function(condition,callback,parentNode,interaction,childNode){var begin=parentNode.contents().length;if((!interaction||interaction.isLiveCycle("loaded")&&!condition(interaction))&&(interaction||a5.mainBuilder.ready&&!condition())||callback.call(this),!interaction||!interaction.isLiveCycle("loaded")||a5.mainBuilder.ready){var nodes=parentNode.contents().slice(begin);a5.eventBus.bind("lo:ready",function(){condition(interaction)||(nodes.remove(),childNode&&childNode.remove())})}},addDeferredText:function(parentNode,interaction,callback){var $placeholder=$('<span class="endResult__placeholder"></span>');parentNode.append($placeholder),callback=_.partial(callback,this.currentInteraction,this.currentInteractionGroup),window.a5.mainBuilder.bind("score_update",function(){$placeholder=this.replacePlaceholder(callback,$placeholder)},this),interaction.bind("show",function(){$placeholder=this.replacePlaceholder(callback,$placeholder)},this)},addDeferredContent:function(parentNode,interaction,callback){var $placeholder=$('<span class="endResult__placeholder"></span>');parentNode.append($placeholder),callback=_.partial(callback,this.currentInteraction,this.currentInteractionGroup),interaction.bind("show",function(){if(window.a5.mainBuilder.restoring){var restoredListener=function(){a5.eventBus.unbind("lo:restored",restoredListener),$placeholder=this.replacePlaceholder(callback,$placeholder)};a5.eventBus.bind("lo:restored",restoredListener,this)}else $placeholder=this.replacePlaceholder(callback,$placeholder)},this)},replacePlaceholder:function(callback,$placeholder){var $content=callback.apply(window.a5.mainBuilder);return $placeholder.replaceWith($content),$content}},a5.model_builder.Base.extend("a5.model_builder.EndResult"),a5.model_builder.builders.push(new a5.model_builder.EndResult),a5.model_postBuilder.EndResult={isResponsible:function(node,interaction){return"Present:Present:Present"==interaction.identifier},build:function(interaction,parentNode){new a5.views.LONavigation(a5.mainBuilder,parentNode.find(".lo-navigation")).render()}},Obj.extend("a5.model_postBuilder.EndResult"),a5.model_postBuilder.builders.push(new a5.model_postBuilder.EndResult),a5.model_builder.EndResultsGenerator={init:function(){this.model=new a5.models.EndResult,this._cache={}},initCache:function(interaction){this._cache[interaction.id]={solvable:!1,automaticMarked:!1,manuallyMarked:!1,results:new a5.EmptyResult,score:new a5.Score,maximumScore:0}},cacheSolvable:function(interaction){return this._cache[interaction.id]||this.initCache(interaction),$.when(interaction.isSolvable()).then(function(solvable){_.extend(this._cache[interaction.id],{solvable:solvable,automaticMarked:interaction.options.manualMarkingIsOff()&&solvable,manuallyMarked:interaction.options.manualMarkingIsOn()})}.bind(this))},cacheScores:function(){var promises=_.map(a5.mainBuilder.intList,function(interaction){return this._cache[interaction.id]||this.initCache(interaction),$.when(interaction.getScoresAsync(),interaction.getMaximumScore()).then(function(score,maximumScore){"input"===interaction.getStatus()&&(score.correct=0,score.correctBlocks=0),_.extend(this._cache[interaction.id],{results:new a5.Results(score,interaction.options),score:score,maximumScore:maximumScore})}.bind(this))},this);return $.when(promises)},getCachedResults:function(interaction){var interactions;interactions=interaction?interaction instanceof a5.InteractionGroup?interaction.interactions:[interaction]:a5.mainBuilder.getAdaptiveInteractions();var resultList=new a5.ResultList;return _.each(interactions,function(i){var interactionData=this._cache[i.id];interactionData&&resultList.push(interactionData.results)},this),resultList},getScore:function(interaction,group){if(group=group||(interaction instanceof a5.InteractionGroup?"sections":"interactions"),a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored){var results=this.getCachedResults(interaction);this.model.set(interaction,"score",results.human().percent(),group)}return this.model.get(interaction,"score",group)},getTotalquestions:function(interaction,group){if(group=group||(interaction instanceof a5.InteractionGroup?"sections":"interactions"),a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored){var results=this.getCachedResults(interaction);this.model.set(interaction,"total",results.human().total(),group)}return this.model.get(interaction,"total",group)},getCorrectanswers:function(interaction,group){if(group=group||(interaction instanceof a5.InteractionGroup?"sections":"interactions"),a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored){var results=this.getCachedResults(interaction);this.model.set(interaction,"correct",results.human().correct(),group)}return interaction&&"input"===interaction.status?"-":this.model.get(interaction,"correct",group)},getIncorrectanswers:function(interaction,group){if(group=group||(interaction instanceof a5.InteractionGroup?"sections":"interactions"),a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored){var results=this.getCachedResults(interaction);this.model.set(interaction,"incorrect",results.human().incorrect(),group)}return this.model.get(interaction,"incorrect",group)},getTimetaken:function(interaction){var timetaken="-";return interaction&&interaction.activityDuration?timetaken=interaction.activityTimer.getTimeString(interaction.activityDuration):a5.mainBuilder.timer?timetaken=a5.mainBuilder.timer.getTimeString(a5.mainBuilder.timer.getElapsedTime()):a5.mainBuilder.aggregatedLODuration&&(timetaken=a5.mainBuilder.loTimer.getTimeString(a5.mainBuilder.aggregatedLODuration)),timetaken},getTimeout:function(){var timeout="-";return a5.mainBuilder.timer&&(timeout=a5.mainBuilder.timer.getTimeString(a5.mainBuilder.timer.originalTime)),timeout},getDateString:function(){return(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored)&&this.model.set(null,"date",(new Date).toLocaleDateString()),this.model.get(null,"date")},getAttempts:function(){var ret=0;return a5.mainBuilder.canSubmit?ret=a5.mainBuilder.submitAttempts:a5.mainBuilder.canSendScores&&(ret=a5.mainBuilder.sendScoreAttempts),ret},getSolvableInteractions:function(){return _.filter(a5.mainBuilder.getInteractionsWithoutEndResult(),function(interaction){var interactionData=this._cache[interaction.id];return interactionData&&interactionData.solvable},this)},getUnsolvedInteractions:function(threshold){var intList=this.getSolvableInteractions();return _.filter(intList,function(interaction){var interactionData=this._cache[interaction.id];return interactionData&&interaction.manualCheckAttempts>0&&interactionData.results.percent()<threshold},this)},getSolvedInteractions:function(threshold){var intList=this.getSolvableInteractions();return _.filter(intList,function(interaction){var interactionData=this._cache[interaction.id];return interactionData&&interaction.manualCheckAttempts>0&&interactionData.results.percent()>=threshold},this)},getNotAttemptedInteractions:function(){var intList=a5.mainBuilder.getInteractionsWithoutEndResult();return _.filter(intList,function(interaction){return 0===interaction.manualCheckAttempts},this)},getAllCorrectAttemptInteractions:function(attempt){var intList=this.getSolvableInteractions();return _.filter(intList,function(interaction){var interactionData=this._cache[interaction.id];return interactionData&&interaction.manualCheckAttempts===attempt&&interactionData.results.isPercent100()},this)},getAllCorrectAttempt:function(attempt){return(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored)&&(this.model.allcorrectbyattempt[attempt]=this.getAllCorrectAttemptInteractions(attempt).length),this.model.allcorrectbyattempt[attempt]},getUnsolved:function(threshold){return(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored)&&(this.model.unsolved=this.getUnsolvedInteractions(threshold).length),this.model.unsolved},getSolved:function(threshold){return(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored)&&(this.model.solved=this.getSolvedInteractions(threshold).length),this.model.solved},getNotAttempted:function(){return(a5.mainBuilder.justSubmitted||a5.mainBuilder.justScoresSent||!this.model.isRestored)&&(this.model.notattempted=this.getNotAttemptedInteractions().length),this.model.notattempted},getBandFeedback:function(interaction,bands){for(;bands.length<3;)bands.unshift(0);var results=this.getCachedResults(),percent=results.percent(),band=3;percent<bands[2]&&(band=2),percent<bands[1]&&(band=1),percent<bands[0]&&(band=0);var bandID=["349","348","347","346"][band],feedback="";if(interaction.options.has(bandID)&&"false"!=interaction.options.get(bandID)){feedback=_.unescape(interaction.options.getValue(bandID)),feedback=a5.preprocessor.apply(feedback,interaction),a5.mainBuilder.setLastFeedbackBand(feedback);feedback=a5.utils.buildContents($("<span>"+feedback+"</span>"),interaction,$("<div>"))}return feedback},getBandFeedbackString:function(interaction,bands){var band=this.getBandFeedback(interaction,bands);return band?band.html():""},someManuallyMarked:function(interaction){var interactions;return interactions=interaction?interaction instanceof a5.InteractionGroup?interaction.interactions:[interaction]:a5.mainBuilder.getAdaptiveInteractions(),_.some(interactions,function(interaction){var interactionData=this._cache[interaction.id];return interactionData&&interactionData.manuallyMarked},this)},someAutomaticMarked:function(interaction){var interactions;return interactions=interaction?interaction instanceof a5.InteractionGroup?interaction.interactions:[interaction]:a5.mainBuilder.getAdaptiveInteractions(),_.some(interactions,function(interaction){var interactionData=this._cache[interaction.id];return interactionData&&interactionData.automaticMarked},this)}},Obj.extend("a5.model_builder.EndResultsGenerator"),a5.model_builder.PPQuiz={isResponsible:function(node,interaction){return a5.utils.hasId(node,"content")&&"Present:Present:Quiz"===interaction.identifier},buildDiv:function(interaction,parentNode,node){if(this._super(interaction,parentNode,node),a5.utils.hasId(node,"content")){var config=this._getGameConfiguration(interaction);a5.mainBuilder.intList=[interaction].concat(config.list),_.each(a5.mainBuilder.intList,function(i,index){i!==interaction&&(i.parent=interaction,i.index=index,i.visibleIndex=index+1)},this);new a5.view.PPQuiz({$el:interaction.$(".interaction"),interaction:interaction,config:config}).render()}},_getGameConfiguration:function(interaction){var numberOfCategories=parseInt(interaction.options.getNumberOfCategories(),10)||0,numberOfQuestions=parseInt(interaction.options.getNumberOfQuestions(),10)||0,numberOfTeams=interaction.options.getNumberOfTeams().number,allowUserSelection=interaction.options.getNumberOfTeams().canSelect,allowSkip=interaction.options.skipIsOn(),allowRestart=interaction.options.restartGameIsOn(),allowNewGame=interaction.options.newGameIsOn(),interactions=_.without(a5.mainBuilder.allInteractionsList,interaction),groups=this._filter(interactions,numberOfCategories,numberOfQuestions),list=this._flat(groups),maxDuration=parseInt(interaction.options.getMaximumduration(),10);(isNaN(maxDuration)||maxDuration<=0||interaction.options.maximumdurationIsOff())&&(maxDuration=null);var alarm,countdownTimer=interaction.options.countdowntimerIsOn()&&null!==maxDuration;return countdownTimer&&(alarm=interaction.options.getCountdowntimer()),{numberOfTeams:numberOfTeams,numberOfCategories:numberOfCategories,numberOfQuestions:numberOfQuestions,allowUserSelection:allowUserSelection,allowSkip:allowSkip,allowRestart:allowRestart,allowNewGame:allowNewGame,attempts:a5.mainBuilder.getCheckMaxAttemptsNumber(),maxDuration:maxDuration,countdownTimer:countdownTimer,alarm:alarm,groups:groups,list:list}},_filterByScore:function(list,numberOfQuestions){return numberOfQuestions=numberOfQuestions||1,_.chain(list).groupBy(function(interaction){var score=_.first(interaction.activityMetadata.getValues("maximum_score"));return score=!_.isUndefined(score)&&(score.value||score.description),parseInt(score,10)||0}).mapObject(function(group){return _.sample(group,numberOfQuestions)}).pairs().map(function(p){return _.map(p[1],function(interaction){return{score:p[0],interaction:interaction}})}).flatten().sortBy("score").value()},_filterByCategory:function(list,numberOfCategories,numberOfQuestions){var groups=_.groupBy(list,"group"),categories=_.chain(groups).keys().sample(numberOfCategories).value();return _.chain(groups).pick(categories).mapObject(function(group){return this._filterByScore(group,numberOfQuestions)},this).pairs().map(function(p){return{title:p[0],questions:p[1]}}).value()},_filter:function(list,numberOfCategories,numberOfQuestions){return numberOfCategories?this._filterByCategory(list,numberOfCategories,numberOfQuestions):[{id:null,questions:this._filterByScore(list,numberOfQuestions)}]},_flat:function(groups){return _.chain(groups).pluck("questions").flatten().pluck("interaction").value()}},a5.model_builder.Content.extend("a5.model_builder.PPQuiz"),a5.model_builder.builders.push(new a5.model_builder.PPQuiz),a5.model_builder.ClueLink={isResponsible:function(node,interaction){return node.is("clueLink, clueTarget, clueLabel")},buildClueLink:function(interaction,parentNode,node){var clueLink=$('<span class="clue-link"></span>');this.buildContents(node,interaction,clueLink),clueLink.find(":first").show();var index=0,lIndex=0,cids=node.attr("cid").split("*");clueLink.on("click",_.bind(function(e){var labels=interaction.$(".clue-label[data-clue-id='"+node.attr("cid")+"']");lIndex%2==0?(this._toggleHighlight(interaction,e.currentTarget,[cids[index]],!0),index=(index+1)%cids.length):(this._toggleHighlight(interaction,e.currentTarget,cids,!1),index=0),0===index&&(lIndex=(lIndex+1)%(labels.length||2),labels.hide(),$(labels[lIndex]).show())},this)),parentNode.append(clueLink)},_toggleHighlight:function(interaction,clueLink,clueTargetIds,highlight){$(clueLink).toggleClass("highlighted",highlight),_(clueTargetIds).each(function(cid){var targets=interaction.$(".clue-area[data-clue-id='"+cid+"']");_.each(targets,function(target){$(target).toggleClass("highlighted",highlight),$(target).css(highlight?{backgroundColor:"#"+$(target).attr("data-clue-color")}:{backgroundColor:""})})})},buildClueTarget:function(interaction,parentNode,node){var clueArea=$('<span class="clue-area" data-clue-id="'+node.attr("cid")+'" data-clue-color="'+node.attr("color")+'"></span>');this.buildContents(node,interaction,clueArea),parentNode.append(clueArea)},buildClueLabel:function(interaction,parentNode,node){var clueLabel=$('<span class="clue-label" data-clue-id="'+node.attr("cid")+'" style="display:none;"></span>');this.buildContents(node,interaction,clueLabel),parentNode.append(clueLabel)}},a5.model_builder.Base.extend("a5.model_builder.ClueLink"),a5.model_builder.builders.push(new a5.model_builder.ClueLink),a5.model_builder.Hidden={isResponsible:function(node,interaction){return node.is("hidden")},build:function(interaction,parentNode,node){interaction.options.revealObjectIsFalse()||(parentNode.addClass("opt-021-hidden"),parentNode.attr("data-opt-021-prio",node.attr("prio")))}},a5.model_builder.Base.extend("a5.model_builder.Hidden"),a5.model_builder.builders.push(new a5.model_builder.Hidden),a5.model_builder.TextToggle={isResponsible:function(node,interaction){return node.is("toggletext")||node.is("togglingtext")},buildToggletext:function(interaction,parentNode,node){var $node=$('<div class="toggle-text">'+node.text()+"</div>");$node.click(function(){0==$(this).next().find("span.tT").length?$(this).next().toggle():$(this).next().find("span.tT").toggle()}),$node.disableSelection(),parentNode.before($node)},buildTogglingtext:function(interaction,parentNode,node){parentNode.append($('<span class="tT">'+node.text()+"</span>"))}},a5.model_builder.Base.extend("a5.model_builder.TextToggle"),a5.model_builder.builders.push(new a5.model_builder.TextToggle),a5.model_builder.TextToggle={isResponsible:function(node,interaction){return node.is("triggerWord")||node.is("triggerText")},_initTriggerWords:function(){this.triggerWords={};var intList=_([a5.mainBuilder.introScreen,a5.mainBuilder.intList]).chain().flatten().compact().value();_.each(intList,function(interaction){this.triggerWords[interaction.index]={},interaction.bind("reset",function(){this.triggerWords[interaction.index]={}},this)},this)},_serializeXML:function(node){return(new XMLSerializer).serializeToString(node)},_sanitizeImages:function(node){var imgs=node.find("[src]");$.each(imgs,function(index,img){var src=A5.ASSET_URL_BUILDER($(img).attr("src"));$(img).attr("src",src)})},buildTriggerWord:function(interaction,parentNode,node){this._sanitizeImages(node);var model=new a5.models.TriggerWord({identifier:node.attr("id"),content:this._serializeXML(node[0]),showonce:node.attr("once"),simultaneous:node.attr("simultaneous"),displayword:"display"==node.attr("display")}),view=new a5.views.TriggerWord(model,null,interaction),id=node.attr("id").toLowerCase();_.isUndefined(this.triggerWords)&&this._initTriggerWords();var word=this.triggerWords[interaction.index][id];word instanceof Array&&_(word).each(function(w){view.addTrigText(w)}),this.triggerWords[interaction.index][id]=view,parentNode.append(view.render())},buildTriggerText:function(interaction,parentNode,node){var $node=$('<div class="trigger-text"></div>');$node.attr("id",node.attr("id")),this.buildContents(node,interaction,$node),$node.find(".trigtext-paragraph-placeholder").remove(),$node.hide();var id=node.attr("id").toLowerCase();_.isUndefined(this.triggerWords)&&this._initTriggerWords();var word=this.triggerWords[interaction.index][id];word?word instanceof a5.views.TriggerWord?word.addTrigText($node):this.triggerWords[interaction.index][id].push($node):this.triggerWords[interaction.index][id]=[$node],parentNode.append($node)}},a5.model_builder.Base.extend("a5.model_builder.TextToggle"),a5.model_builder.builders.push(new a5.model_builder.TextToggle),a5.model_builder.FeedbackText={isResponsible:function(node,interaction){return node.is("feedbackText")},_serializeToString:function(node){return(new XMLSerializer).serializeToString(node).replace(/<feedbackText[^>]*>/gi,"").replace(/<\/feedbackText>/gi,"")},buildFeedbackText:function(interaction,parentNode,node){interaction.feedbackText[node.attr("id")]=this._serializeToString(node[0])}},a5.model_builder.Base.extend("a5.model_builder.FeedbackText"),a5.model_builder.builders.push(new a5.model_builder.FeedbackText),a5.model_builder.BuddyBuilder={isResponsible:function(node,interaction){return a5.utils.hasId(node,"buddy")},buildDiv:function(interaction,parentNode,node){var $appendTo=$('<div class="buddy"></div>');parentNode.append(a5.utils.buildContents(node,interaction,$appendTo));var state,audioID;if($appendTo.find(".buddyAudioContainer").length>0){audioID=$appendTo.find(".buddyAudioContainer").first().find("[data-playable-media]").first().attr("data-playable-media")}node.attr("data-state")&&(state=node.attr("data-state")),new a5.service.Buddy(interaction,state,$appendTo,audioID)}},a5.model_builder.Base.extend("a5.model_builder.BuddyBuilder"),a5.model_builder.builders.push(new a5.model_builder.BuddyBuilder),a5.model_builder.InlineEditor={isResponsible:function(node,interaction){return node.is("inlineEditor")},_serializeXML:function(node){return(new XMLSerializer).serializeToString(node)},buildInlineEditor:function(interaction,parentNode,node){var prefill=(a5.model_builder.InlineEditor.GUID(),this._serializeXML(node[0])),$node=$("<div class='a5-inlineeditor' contenteditable=true>"+prefill+"</div>");try{var ck=$node.ckeditor({toolbar:[["Bold","Italic","Underline","Superscript","Subscript","-","NumberedList","BulletedList"]],customConfig:"",styleSet:!1,enterMode:CKEDITOR.ENTER_BR});if(_.isUndefined(ck.editor))throw TypeError;var model=new a5.models.InlineEditor({editor:ck.editor,prefill:prefill});interaction.blockItems.add(model),ck.editor.on("instanceReady",function(){ck.editor.setReadOnly(!1)}),model.bind("update",function(data){$node.editor.setData(data.text)})}catch(e){model.bind("update",function(data){$node.html(data.text)})}parentNode.append($node)}},a5.model_builder.Base.extend("a5.model_builder.InlineEditor"),a5.model_builder.builders.push(new a5.model_builder.InlineEditor),a5.model_builder.InlineEditor.GUID=function(){var guid=0;return function(){return guid++}}(),a5.model_builder.TextToSpeechPlayer={isResponsible:function(node,interaction){return node.is("texttospeechplayer")},build:function(interaction,parentNode,node){if(interaction.options.audiosupportIsTrue()&&(!interaction.options.choiceAlignmentIsHorizontal()||!parentNode.children(".choice_interaction").length)&&(!interaction.options.choiceAlignmentIsVertical()||!parentNode.children(".choice_interaction").length)&&!parentNode.children(".ll_view").length&&!parentNode.children(".syllabify-word").length&&!parentNode.children(".gap_match_view").length&&(parentNode.children(".trigger-text").length&&(parentNode=parentNode.find(".trigger-text")),interaction.options.audiosupportIsTrue()&&this._hasTextContent(parentNode)&&!this._hasTTSPlayer(parentNode))){var text=this._nodeToText(parentNode,interaction);if(parentNode.is("tr")&&parentNode.find("td").length&&(parentNode=parentNode.find("td, th").first(),parentNode.children("table").length||parentNode.children("p").length))return;if(parentNode.is("tr")&&parentNode.find("th").length&&(parentNode=parentNode.find("th, td").first(),parentNode.children("table").length||parentNode.children("p").length))return;parentNode.prepend(this.createTTSAudio(text).render()),parentNode.addClass("a5_tts_enabled")}},_hasTextContent:function(node){var hasImgAlt=node.find("img[alt][alt!='']").length>0,hasText=""!==node.text().trim()&&!node.text().trim().match(/^\s*\.+\s*$/);return hasImgAlt||hasText},_hasTTSPlayer:function(node){return node.parents(".a5_tts_audio_element").length>0},createTTSAudio:function(text){return new a5.views.TTS_Player(text)},_nodeToText:function(node,interaction){var clone=$(node).clone(!0);return clone.find(".a5_tts_enabled").remove(),$(clone).find("*").each(function(i){$(this).is("input")||$(this).is("textarea")?interaction.options.speaklearnerinputIsTrue()?$(this).replaceWith("<span>"+$(this).val()+"</span>"):$(this).replaceWith("<span> ... </span>"):$(this).is(".enum-answers")?$(this).replaceWith(""):$(this).is(".drag_holder")?interaction.options.speaklearnerinputIsTrue()?$(this).replaceWith("<span>"+$(this).val()+"</span>"):$(this).replaceWith("<span> ... </span>"):$(this).is("td")||$(this).is("th")?$(this).append("<span>; </span>"):$(this).is(".wrapper-dropdown")?$(this).replaceWith("<span> ... </span>"):$(this).is("img")&&$(this).attr("alt")&&$(this).replaceWith("<span>"+$(this).attr("alt")+"</span>")}),clone.text()}},a5.model_builder.Base.extend("a5.model_builder.TextToSpeechPlayer"),a5.model_builder.builders.push(new a5.model_builder.TextToSpeechPlayer),a5.model_builder.ShowAnswer={isResponsible:function(node,interaction){return node.is("answer")},build:function(interaction,parentNode,node){var answerNum=parseInt(node.attr("id"),10)-1,screenNum=parseInt(node.attr("screen"),10)-1;interaction.bind("show",_.bind(function(){var selected_interaction=a5.mainBuilder.intList[screenNum],answers=[];switch(selected_interaction.identifier){case"Identify:Select:Radiobutton":selected_interaction.options.showInColumnsIsTrue()&&(answers=this.buildRadioColumnMode(selected_interaction,parentNode,screenNum,answerNum));break;case"Identify:Select:Checkbox":selected_interaction.options.showInColumnsIsTrue()&&(answers=this.buildCheckboxColumnMode(selected_interaction,parentNode,screenNum,answerNum));break;case"Present:Present:Present":if(0==selected_interaction.blockItems.itemList.length)break;selected_interaction.blockItems.itemList[0]._class_name.indexOf("ISRadiobuttonModel")>=0&&(answers=this.buildRadioColumnMode(selected_interaction,parentNode,screenNum,answerNum));break;default:logger.warn("ShowAnswer not implemented for "+selected_interaction.identifier)}_.each(answers,function(answer){parentNode.append(answer)}),interaction.bind("hide",function(){$(".show-answer").remove()})},this))},buildRadioColumnMode:function(interaction,parentNode,screenNum,answerNum){var results=[],answers=[],items=interaction.blockItems.itemList;return _.each(items,function(item){item.selected&&item.selected.value==item.choices[answerNum].value&&results.push(item.selected.label)}),_.each(results,function(answer,i){answer.addClass("show-answer"),answer.addClass("show-answer-"+screenNum+"-"+answerNum),answer.addClass("answer-column-"+answerNum+"-"+i),answers.push(answer)}),answers},buildCheckboxColumnMode:function(interaction,parentNode,screenNum,answerNum){var results=[],answers=[],items=interaction.blockItems.itemList;return _.each(items,function(item,i){item.choices[answerNum]&&item.choices[answerNum].selected&&results.push(item.choices[answerNum].label)}),_.each(results,function(answer,i){answer.addClass("show-answer"),answer.addClass("show-answer-"+screenNum+"-"+answerNum),answer.addClass("answer-column-"+answerNum),answers.push(answer)}),answers}},a5.model_builder.Base.extend("a5.model_builder.ShowAnswer"),a5.model_builder.builders.push(new a5.model_builder.ShowAnswer),a5.model_builder.Scramble={isResponsible:function(node,interaction){return node.is("scramble")},build:function(interaction,parentNode,node){parentNode.append(a5.utils.scrambleText(node.text()))}},a5.model_builder.Base.extend("a5.model_builder.Scramble"),a5.model_builder.builders.push(new a5.model_builder.Scramble),a5.model_builder.RadioCheck={isResponsible:function(node,interaction){return node.is("radio")||node.is("checkbox")},buildRadio:function(interaction,parentNode,node){var model=this.createModel(node,interaction,a5.models.RadioButton,a5.models.RadioButtonChoice,{enableToggle:!1});this.createView(parentNode,model,a5.views.NoValidateRadiobuttonChoiceView)},buildCheckbox:function(interaction,parentNode,node){var model=this.createModel(node,interaction,a5.models.Checkbox,a5.models.CheckboxChoice);this.createView(parentNode,model,a5.views.NoValidateCheckboxChoiceView)},createModel:function(node,interaction,groupClass,modelClass,extraOptions){var groupName=node.attr("group"),selected=!!node.attr("selected"),group=_.find(interaction.blockItems.itemList,function(group){return group.name===groupName});group||(group=new groupClass({name:groupName}),interaction.blockItems.add(group));var radio=new modelClass(_.extend(extraOptions||{},{value:node.attr("value"),parent:group,interaction:interaction,selected:selected}));return group.add(radio),radio},createView:function(parentNode,model,viewClass){var view=new viewClass(model);parentNode.is("p")&&parentNode.addClass("selectable-syntax-group"),parentNode.append(view.addInput().updateSelected().node)}},a5.model_builder.Base.extend("a5.model_builder.RadioCheck"),a5.model_builder.builders.push(new a5.model_builder.RadioCheck),a5.model_builder.Save={isResponsible:function(node,interaction){return node.is("save")},build:function(interaction,parentNode,node){var button=new a5.views.SaveButton(interaction,node.attr("image"));parentNode.append(button.render().$node)}},a5.model_builder.Base.extend("a5.model_builder.Save"),a5.model_builder.builders.push(new a5.model_builder.Save),a5.model_builder.TextArea={isResponsible:function(node,interaction){return node.is("textinput, richtextinput, inlinetextinput")&&"Input:Creative:Extended writing"!==interaction.identifier},buildTextinput:function(interaction,parentNode,node){var view=this.buildView(interaction,parentNode,node,!node.attr("width")||node.attr("height")?a5.views.TextArea:a5.views.TextInput);this._showtext(node,view,interaction)},buildRichtextinput:function(interaction,parentNode,node){var view=this.buildView(interaction,parentNode,node,a5.views.RichTextArea);view.initCK(),this._showtext(node,view,interaction)},buildInlinetextinput:function(interaction,parentNode,node){var view=this.buildView(interaction,parentNode,node,a5.views.TextInput);this._showtext(node,view,interaction)},buildView:function(interaction,parentNode,node,viewClass){var max,options={width:node.attr("width"),height:node.attr("height"),count:node.attr("count"),maxLength:interaction.options.getMaxLength(),maxType:interaction.options.get("120"),autogrow:interaction.options.textboxAutogrowIsOn(),inline:node.is("inlinetextinput")};node.attr("max")&&(max=node.attr("max").split(" "),options.maxLength=parseInt(max[0],10),options.maxType=max[1],node.attr("hidemax")&&(options.hidemax=!0)),node.attr("min")&&(max=node.attr("min").split(" "),options.minLength=parseInt(max[0],10),options.minType=max[1],node.attr("hidemin")&&(options.hidemin=!0)),options.spellcheck=interaction.options.spellcheckIsOn();var model=new a5.models.TextArea({content:this._toPlainText(node),scorable:interaction.blockItems.isScorable(),interaction:interaction,maxLength:options.maxLength,minLength:options.minLength,maxType:options.maxType,minType:options.minType});interaction.blockItems.add(model);var view=new viewClass(model,options),$node=view.render();return parentNode.append($node),view},_showtext:function(node,view,interaction){
if(node.attr("showtext")){var showtext=node.attr("showtext").split(","),intIndex=parseInt(showtext[0],10)-1,inputIndex=parseInt(showtext[1],10)-1,parentInt=a5.mainBuilder.getInteractionFromIndex(intIndex);if(parentInt.isLiveCycle("loaded")){var textarea=parentInt.getItemsByClass("a5.models.TextArea")[inputIndex];view.model.restore(textarea.store())}else parentInt.bind("rendered",function(){var textarea=parentInt.getItemsByClass("a5.models.TextArea")[inputIndex];view.model.restore(textarea.store())});interaction.bind("show",function(){if(parentInt.isLiveCycle("loaded")){var textarea=parentInt.getItemsByClass("a5.models.TextArea")[inputIndex];view.model.restore(textarea.store())}})}},_toPlainText:function(node){var str="";return _(node.contents()).each(function(c){c.tagName&&"br"===c.tagName.toLowerCase()?str+="\n":str+=$(c).text().replace(/\t/g,"").replace(/\n/g,"")}),str}},a5.model_builder.Base.extend("a5.model_builder.TextArea"),a5.model_builder.builders.push(new a5.model_builder.TextArea),a5.model_builder.TextArea={isResponsible:function(node,interaction){return node.is("showtext")},buildShowtext:function(interaction,parentNode,node){var inputIndex,interactionIndex=0;a5.utils.isInteger(node.attr("screen"))&&(interactionIndex=parseInt(node.attr("screen"),10)-1),a5.utils.isInteger(node.attr("input"))&&(inputIndex=parseInt(node.attr("input"),10)-1);var parentInt=a5.mainBuilder.getInteractionFromIndex(interactionIndex),views=[],findModels=function(){var models=parentInt.getItemsByClass("a5.models.TextArea");return _.isUndefined(inputIndex)?models:[models[inputIndex]]},createViews=function(){views=_.map(findModels(),function(model){var view=new a5.views.ShowText(model);return parentNode.append(view.render()),view})};parentInt.isLiveCycle("loaded")?createViews():parentInt.bind("rendered",createViews,this),a5.mainBuilder.bind("reset",function(){interaction.bind("show",_.once(function(){var models=findModels();_.each(views,function(view,i){view.updateModel(models[i]),view.updateContent()})}))}),interaction.bind("show",function(){_.each(views,function(view){view.updateContent()})},this)}},a5.model_builder.Base.extend("a5.model_builder.TextArea"),a5.model_builder.builders.push(new a5.model_builder.TextArea),a5.model_builder.Confidence={isResponsible:function(node,interaction){return this.methodToBuild(node)in this},buildConfidenceSelector:function(interaction,parentNode,node){var data={text:node.text()};_.each(node[0].attributes,function(x){data[x.name]=x.value,data[x.name+"_selected"]=x.name==a5.mainBuilder.confidenceLevel[0]});var $node=$(a5.service.templates.render("a5.view.ConfidenceSelector",data));parentNode.append($node),a5.mainBuilder.confidenceLevel[1]=a5.mainBuilder.confidenceLevel[1]||"Nothing selected",$node.on("click","div > div",_.bind(function(n){$node.find("div > div").removeClass("selected"),$(n.target).addClass("selected");var id=$(n.target).attr("data-level");a5.mainBuilder.confidenceLevel=[id,data[id]],a5.service.lms.API.setData("confidenceLevel",a5.mainBuilder.confidenceLevel),a5.mainBuilder.updateControls()},this)),interaction.bind("show",function(){a5.mainBuilder.canSubmit&&!a5.mainBuilder.hasMoreSubmitAttempts()&&$node.off("click","div > div")})},buildConfidenceDisplay:function(interaction,parentNode,node){var $node=$(a5.service.templates.render("a5.view.ConfidenceDisplay",{}));parentNode.append($node),a5.mainBuilder.bind("score_update",function(){var cn=$node.find("[data-confidence]");cn.text(a5.mainBuilder.confidenceLevel[1]),cn.removeClass("level-v0 level-v1 level-v2"),cn.addClass("level-"+a5.mainBuilder.confidenceLevel[0])})}},a5.model_builder.Base.extend("a5.model_builder.Confidence"),a5.model_builder.builders.push(new a5.model_builder.Confidence),a5.model_builder.MathML={mathMLList:[],mathMLLoadStates:{NOT_LOADED:0,LOADING:1,LOADED:2},mathMLState:0,isResponsible:function(node,interaction){return node.is("img[data-mathml][data-author]")&&this._mathMLDisplay(node.attr("data-author"))},_mathMLDisplay:function(jsonStr){if(_.isEmpty(jsonStr))return!1;try{return JSON.parse(htmlDecode(jsonStr)).mathMLDisplay}catch(e){return logger.warn("MathML Builder: data-author wrongly formatted: "+jsonStr),!1}},build:function(interaction,parentNode,node){var spanEl=this._appendMathMLNode(node);parentNode.append(spanEl),this.mathMLState===this.mathMLLoadStates.LOADED?this._formatMathML(spanEl):(this.mathMLList.push(spanEl),this.mathMLState===this.mathMLLoadStates.NOT_LOADED&&(this.mathMLState=this.mathMLLoadStates.LOADING,window.MathJax={root:A5.MATHJAX},$.getScript(A5.MATHJAX+"/MathJax.js?config=TeX-MML-AM_CHTML").done(_.bind(this._mathMLLoaded,this))))},_mathMLLoaded:function(script,status){this.mathMLState=this.mathMLLoadStates.LOADED,_.each(this.mathMLList,this._formatMathML,this),this.mathMLList=[],MathJax.Hub.Register.MessageHook("Math Processing Error",function(message){logger.error(message[2])})},_appendMathMLNode:function(node){var mathMLContent=htmlDecode(node.attr("data-mathml")),$span=$('<div class="has-mathml"></div>'),spanEl=$span[0];return spanEl.style.visibility="hidden",spanEl.innerHTML=mathMLContent,spanEl},_formatMathML:function(spanEl){MathJax.Hub.Queue(["Typeset",MathJax.Hub,spanEl],["_mathMLRendered",this,spanEl])},_mathMLRendered:function(spanEl){spanEl.style.visibility=""}},a5.model_builder.Base.extend("a5.model_builder.MathML"),a5.model_builder.builders.push(new a5.model_builder.MathML),a5.model_builder.Alert={isResponsible:function(node,interaction){return node.is("alert")},build:function(interaction,parentNode,node){var $alert=$('<span class="alert alert-'+node.attr("type")+'"></span>');parentNode.append($alert)}},a5.model_builder.Base.extend("a5.model_builder.Alert"),a5.model_builder.builders.push(new a5.model_builder.Alert),a5.model_builder.Navbutton={isResponsible:function(node,interaction){return node.is("navbutton")},build:function(interaction,parentNode,node){var screen=parseInt(node.attr("screen"),10)-1,$button=$('<a href="#" class="nav-button"></span>');$button.text(node.text()),$button.attr("data-screen",screen),$button.click(function(e){e.preventDefault(),a5.mainBuilder.goTo(screen)}),a5.hooks.interactionShowed.add(function(interaction){var history=_.pluck(a5.mainBuilder.navigationHistory.getHistory(),"index");$button.toggleClass("visited",_.contains(history,screen)),$button.toggleClass("current",_.last(history)==screen)}),parentNode.append($button)}},a5.model_builder.Base.extend("a5.model_builder.Navbutton"),a5.model_builder.builders.push(new a5.model_builder.Navbutton),a5.model_builder.InfoText={isResponsible:function(node,interaction){return node.is("infotext")},buildInfotext:function(interaction,parentNode,node){if(!interaction.options.showinfotextIsOff()){var dictionary=interaction.options.referenceContentIsOff()?"":interaction.options.getReferenceContent(),xml=a5.utils.serializeXML(node[0]);xml=this._wrapIntoCDATA(xml);var $xml=$($.parseXML(xml)).find("infotext"),view=new a5.views.InfoText({icon:$xml.attr("icon"),content:$xml.text(),className:$xml.attr("class"),reference:dictionary,behaviour:interaction.options.getShowinfotext()});parentNode.append(view.render())}},_wrapIntoCDATA:function(xml){var ret=xml;return ret=ret.replace(/(<infotext [^>]*>)/gi,"$1<![CDATA["),ret=ret.replace(/(<\/infotext>)/gi,"]]>$1")}},a5.model_builder.Base.extend("a5.model_builder.InfoText"),a5.model_builder.builders.push(new a5.model_builder.InfoText),a5.model_builder.UserSelection={isResponsible:function(node,interaction){return node.is("userselection")},buildUserselection:function(interaction,parentNode,node){var multiple="true"===(node.attr("multiple")||"").toLowerCase(),view=new a5.views.UserSelection(a5.mainBuilder,parseInt(node.attr("step"),10),parseInt(node.attr("max"),10),multiple);parentNode.append(view.render())}},a5.model_builder.Base.extend("a5.model_builder.UserSelection"),a5.model_builder.builders.push(new a5.model_builder.UserSelection),a5.model_builder.AlternativeText={isResponsible:function(node,interaction){return node.is("alternativeText")},build:function(interaction,parentNode,node){if(!interaction.options.alternativeTextIsOff()){var altNode=node.find("#"+interaction.options.getAlternativeText());this.buildContents(altNode,interaction,parentNode)}}},a5.model_builder.Base.extend("a5.model_builder.AlternativeText"),a5.model_builder.builders.push(new a5.model_builder.AlternativeText),a5.model_builder.TranslationBlock={isResponsible:function(node,interaction){return node.is("translationBlock")||node.is("language")},buildTranslationBlock:function(interaction,parentNode,node){var $node=$("<div class='translation-block'>");$node.append(node.clone(!0).contents()),a5.utils.buildModel(interaction,parentNode,$node)},buildTranslationblock:function(interaction,parentNode,node){this.buildTranslationBlock(interaction,parentNode,node)},buildLanguage:function(interaction,parentNode,node){var $node=$("<div class='language-block'>"),langcode=interaction.registerLanguage(node.attr("lang"));$node.attr("data-lang",langcode),$node.append(node.clone(!0).contents()),interaction.getLanguage()==langcode?$node.show():$node.hide(),a5.utils.buildModel(interaction,parentNode,$node),interaction.bind("language:change",function(lang){var blocks=parentNode.find("div[data-lang]");_.each(blocks,function(block){$(block).attr("data-lang")===lang?($(block).show(),$(block).find("*[data-playable-media]").removeClass("a5-avatar-ignore-audio")):($(block).hide(),$(block).find("*[data-playable-media]").addClass("a5-avatar-ignore-audio"))})})}},a5.model_builder.Base.extend("a5.model_builder.TranslationBlock"),a5.model_builder.builders.push(new a5.model_builder.TranslationBlock),a5.model_builder.Karaoke={isResponsible:function(node,interaction){return node.is("karaoke")},buildKaraoke:function(interaction,parentNode,node){var $karaoke=$(_.str.sprintf('<span class="karaoke" data-from="%1$s" data-to="%2$s"></span>',node.attr("from"),node.attr("to")));interaction.karaoke=interaction.karaoke||{},interaction.karaoke[node.attr("audio")]=interaction.karaoke[node.attr("audio")]||new a5.models.Karaoke,interaction.karaoke[node.attr("audio")].add($karaoke),this.buildContents(node,interaction,$karaoke),parentNode.append($karaoke)}},a5.model_builder.Base.extend("a5.model_builder.Karaoke"),a5.model_builder.builders.push(new a5.model_builder.Karaoke),a5.model_builder.Poll={isResponsible:function(node,interaction){return node.is("poll")},buildPoll:function(interaction,parentNode,node){var options=node.children("option"),choiceIds=_.pluck(options,"id"),choiceTexts=_.pluck(options,"innerHTML"),sets=node.children("set"),setIds=_.pluck(sets,"id"),setNames=_.pluck(sets,"textContent"),type=node.attr("type"),className=a5.utils.capitalize(type)+"Poll",modelClass=a5.models[className],viewClass=a5.views[className],model=new modelClass({ids:choiceIds,options:choiceTexts,setIds:setIds,sets:setNames,screenNo:interaction.index,interaction:interaction}),view=new viewClass(model);parentNode.append(view.render())}},a5.model_builder.Base.extend("a5.model_builder.Poll"),a5.model_builder.builders.push(new a5.model_builder.Poll),a5.model_builder.PollResults={NODE_HTML:'<table class="poll-results"><tbody><tr><th class="choice"></th><th class="count"></th></tbody></table>',CHOICE_HTML:'<tr><td class="choice"></td><td class="count"></td></tr>',isResponsible:function(node,interaction){return node.is("pollresults")},buildPollresults:function(interaction,parentNode,node){var screenNo=parseInt(node.attr("screen"),10),pollInteraction=a5.mainBuilder.intList[screenNo-1],poll=$("poll",pollInteraction.xml),choiceIds=_.pluck(poll.children(),"id"),choiceTexts=_.pluck(poll.children(),"innerHTML"),html=$(this.NODE_HTML),body=html.find("tbody");parentNode.append(html),interaction.bind("show",function(){this._updatePollresults(pollInteraction,body,choiceIds,choiceTexts)},this)},_updatePollresults:function(pollInteraction,parentNode,choiceIds,choiceTexts){a5.service.lms.API.getPollResults(pollInteraction.index,function(results){this._clean(parentNode),_.each(choiceIds,function(id,i){parentNode.append($(this.CHOICE_HTML).find(".choice").text(choiceTexts[i]).end().find(".count").text(results[id]||0).end())},this)}.bindTo(this))},_clean:function(parentNode){parentNode.children().slice(1).remove()}},a5.model_builder.Base.extend("a5.model_builder.PollResults"),a5.model_builder.builders.push(new a5.model_builder.PollResults),a5.model_builder.ContentMessage={isResponsible:function(node,interaction){return node.is("contentmessage")},buildContentmessage:function(interaction,parentNode,node){var message=[],rawMessage=node.attr("message");rawMessage&&(message=rawMessage.split("|"));var view=new a5.views.ContentMessage(message,rawMessage);parentNode.append(view.$el),this.buildContents(node,interaction,view.$el),view.render()}},a5.model_builder.Base.extend("a5.model_builder.ContentMessage"),a5.model_builder.builders.push(new a5.model_builder.ContentMessage),a5.ViewData={init:function(){},setXML:function(dom){var self=this;this.variables={},_.each($(dom).find("assessmentItem > responseDeclaration"),function(e){self.variables[$(e).attr("identifier")]=new a5.models.item.response.declaration.ResponseDeclaration($(e))})},getVariable:function(id){return void 0===this.variables[id]?null:this.variables[id]},getLongestResponse:function(id,$node){var maxAnswer,maxWidth=0,answers=_.map(this.variables[id].values,function(val){return htmlDecode(val)});answers=_(answers).reject(function(answer){return _.str.startsWith(answer,"**")||a5.utils.containsUnescaped(answer,"@")}),answers=_(answers).map(function(answer){return _.first(a5.utils.splitUnescaped(answer,"|"))}),answers=_(answers).map(function(answer){return answer.split("##").shift()}),answers=_.map(answers,function(answer){return answer=_.str.reverse(answer),answer=answer.replace(/[{}](?!\\)/g,""),_.str.reverse(answer)}),answers=_(answers).map(function(answer){return a5.utils.unescapeReservedSyntaxSymbols(answer)});var answer=_.first(answers),width=$node.textWidth(answer);return width>maxWidth&&(maxWidth=width,maxAnswer=answer),{answer:maxAnswer,width:maxWidth}},getLongestAllResponses:_.memoize(function(key,$node){var maxAnswer,maxWidth=0;return _.each(this.variables,function(rD,variable){var longest=this.getLongestResponse(variable,$node);longest.width>maxWidth&&(maxWidth=longest.width,maxAnswer=longest.answer)},this),{answer:maxAnswer,width:maxWidth}})},Obj.extend("a5.ViewData",a5.ViewData),a5.models.item.response.declaration.ResponseDeclaration={correctResponse:null,init:function(node){this.values=_.map(node.find("correctResponse > value"),function(val){return $(val).text()});var defaultValues=_.map(node.find("defaultValue > value"),function(val){return $(val).text()});this.defaultValue=defaultValues.length?defaultValues[0]:null},asMap:function(){var map={};return this.values.forEach(function(e){e=e.split(" "),2==e.length&&(e[1]in map||(map[e[1]]=[]),map[e[1]].push(e[0]))}),map},asMapMulti:function(){var map={};return _.each(this.values,function(e){var vals=e.split(" ");map[vals[0]]=_.rest(vals)}),map},asInverseMap:function(){var map={};return this.values.forEach(function(e){e=e.split(" "),2==e.length&&(e[0]in map||(map[e[0]]=[]),map[e[0]].push(e[1]))}),map}},Obj.extend("a5.models.item.response.declaration.ResponseDeclaration"),a5.models.interaction.BaseModel={VALUE_CHANGE_EVENT:"VALUE_CHANGE_EVENT",FILL_CHANGE_EVENT:"FILL_CHANGE_EVENT",STATE_CHANGE_EVENT:"STATE_CHANGE_EVENT",STATES:{CHECK:"feedback",INPUT:"input",ANSWERS:"answers"},init:function(parameters,defaults){defaults=defaults||{},defaults=$.extend({parent:null,engine:null,correctFeedback:null,incorrectFeedback:null,tryAgainLock:!1,tryAgainClear:!1,tryAgainFrozen:!1,tryAgainKeep:!1},defaults),parameters=parameters||{},parameters=$.extend({},defaults,parameters);for(var newProp in parameters)newProp in defaults||logger.raise("Parameter",newProp,"not supported for",this);$.extend(this,parameters),this.id=a5.utils.createUID(),this.state=this.STATES.INPUT},views:function(){var views=[];return $("*[data-model-id='"+this.id+"']").each(function(i,e){views.push($(e).data("mvc-view"))}),views},callViews:function(name,params){params=params||[],this.views().forEach(function(e){name in e?e[name].apply(e,params):logger.warn("no method "+name+" for view ",e._class_name)})},acceptedStates:function(){return[this.STATES.INPUT,this.STATES.CHECK,this.STATES.ANSWERS]},isRevealedBySeeNext:function(){return this._is_see_next},setRevealedBySeeNext:function(){this._is_see_next=!0},clearRevealedBySeeNext:function(){this._is_see_next=!1},isRevealedBySolutionHint:function(){return this._is_solution_hint},setRevealedBySolutionHint:function(){this._is_solution_hint=!0},clearRevealedBySolutionHint:function(){this._is_solution_hint=!1},isRevealed:function(){return this.isRevealedBySeeNext()||this.isRevealedBySolutionHint()},clearRevealed:function(){this.clearRevealedBySeeNext(),this.clearRevealedBySolutionHint()},notifyValueChange:_.throttle(function(){this.trigger(this.VALUE_CHANGE_EVENT)},100),notifyFillChange:function(fill){this.trigger(this.FILL_CHANGE_EVENT,fill)},notifyStateChange:function(newState){this.trigger(this.STATE_CHANGE_EVENT,newState)},areAllFilled:function(){return this.getScores().areAllFilled()},isFilled:function(){return!1},isPrefilled:function(){return this.prefill||this.prefilled},setState:function(newState){_.contains(this.acceptedStates(),newState)||logger.log("error,",this,".setState has invalid parameter",newState),this.state=newState,this.trigger("state_update:"+newState),this.trigger("state_update")},setAnswer:function(){this.setState(this.STATES.CHECK)},setAnswerNewLogic:function(){var allItems=this.getAllItems();this.setEnabledFor(allItems,!1),this.setState(this.STATES.CHECK)},setAnswerInput:function(){this.trigger("input_update:setAnswer")},showAnswer:function(){this.setState(this.STATES.ANSWERS)},showAnswerNewLogic:function(){var allItems=this.getAllItems();this.setEnabledFor(allItems,!1),this.setState(this.STATES.ANSWERS)},showNextAnswer:function(){this.setRevealedBySeeNext(),this.showAnswer(),this.trigger("next_answer")},showSolutionHint:function(){this.setRevealedBySolutionHint(),this.showAnswer(),this.trigger("next_answer")},tryAgain:function(){this.clearRevealed(),this.setState(this.STATES.INPUT)},tryAgainNewLogic:function(){var correctItems=this.getCorrectItems(),incorrectItems=this.getIncorrectItems(),allItems=this.getAllItems(),itemsToDelete=[],itemsToDisable=this.tryAgainFrozen?correctItems:[],itemsToEnable=_.difference(allItems,itemsToDisable);(this.tryAgainFrozen||this.tryAgainLock)&&(itemsToDelete=incorrectItems),this.clearUserDataFor(itemsToDelete),this.setEnabledFor(itemsToEnable,!0),this.setEnabledFor(itemsToDisable,!1),this.clearValidationFor(allItems),this.setState(this.STATES.INPUT),this.clearRevealed()},assignAnswerFeedback:function(node){var answerFeedback=node.attr("answerfeedback");if(answerFeedback){answerFeedback=answerFeedback.replace(/src=(['"])http(s)*:/gi,"src=$1");var match=answerFeedback.match(/#view:(\w+)#/);match?this.answerFeedbackId=match[1]:this.answerFeedback=answerFeedback}},getAnswerFeedback:function(){return this.isCorrect()?this.processFeedback(this.correctFeedback)||this.answerFeedback:this.processFeedback(this.incorrectFeedback)||this.answerFeedback},processFeedback:function(feedback){return feedback?(feedback=feedback.replace("#correct_answer#",_.bind(function(){return this.correctText()},this)),feedback=feedback.replace("#wrong_answer#",_.bind(function(){return this.wrongText()},this))):null},getScores:function(){return new a5.Score},getMaximumScore:function(){return this.getScores().total},getTotalFilled:function(){return this.getScores().filled},store:function(){return{}},restore:function(data){},hasCandidatesForSolutionHint:function(){return this.state!==this.STATES.ANSWERS&&!this.isPrefilled()&&!this.isFilled()},hasCandidatesForShowNextAnswer:function(){return this.state!==this.STATES.ANSWERS&&!this.isPrefilled()&&!this.isCorrect()},hasCandidatesForValidation:function(){return this.state!==this.STATES.ANSWERS&&!this.isPrefilled()},clearSolutionHint:function(){},clearIncorrectAnswers:function(){},getAllAnswers:function(){return!this.isPrefilled()&&_.isFunction(this.getAnswers)&&this.getAnswers()},getAllItems:function(){return this.isPrefilled()?[]:[this]},getCorrectItems:function(){return!this.isPrefilled()&&this.isCorrect()?[this]:[]},getIncorrectItems:function(){return this.isPrefilled()||this.isCorrect()?[]:[this]},clearUserData:function(){this.trigger("clearUserData")},clearValidation:function(){this.trigger("clearValidation")},setEnabled:function(enabled){this.trigger("setEnabled",enabled)},clearUserDataFor:function(items){_.contains(items,this)&&this.clearUserData()},clearValidationFor:function(items){_.contains(items,this)&&this.clearValidation()},setEnabledFor:function(items,enabled){_.contains(items,this)&&this.setEnabled(enabled)}},Obj.extend("a5.models.interaction.BaseModel"),a5.models.interaction.DragElement={init:function(parameters,defaults){this._super(parameters,$.extend({identifier:"",copyOnDrag:!1,content:null,home:null,existing:null,correct:[],prefilled:!1,clickclick:!1,gaptextaudio:!1,overflowOnDrag:!1,selected:!1,behavior:"drop",dropAudio:null},defaults))},disable:function(){this.callViews("disable")},enable:function(){this.callViews("enable")},isDrag:function(){return"drag"===this.behavior},isTapItem:function(){return"tap_item"===this.behavior},isTapTarget:function(){return"tap_target"===this.behavior}},a5.models.interaction.BaseModel.extend("a5.models.interaction.DragElement"),a5.models.interaction.DropArea={init:function(parameters,defaults){this._super(parameters,$.extend({allowed:null,identifier:"",drag:null,copyOnDrag:!1,enumeration:null,globalEnumeration:!1,content:null,position:null,arrow:null,prefilled:!1,resident:null,existing:null,dropIndicator:!1,allowRepeat:!0,dependOn:null,tryAgainKeep:!1,blockNumber:0,capitalize:!1},defaults))},canDrop:function(model){var existing=this.existing||model.existing||"no";return(!this.drag||"swap"==existing||"home"==existing||this.copyOnDrag)&&(null==this.allowed||this.allowed.contains(model))&&!this.prefilled&&!this.isRevealed()},drop:function(drag){this.drag=drag,this.callViews("updateDrag"),this.trigger("drop"),drag.trigger("drop"),this.parent.notifyValueChange()},undrop:function(drag){this.drag=null,this.callViews("updateDrag"),this.trigger("undrop"),this.parent.notifyValueChange()},isFilled:function(){return!!this.drag},isCorrect:function(){return!1},isCorrectable:function(){return!1},isScorable:function(){return!1},isDistractor:function(){return!1},wrongDrag:function(){return!1},setPrefilled:function(){this.prefilled=!0,this.callViews("updateDrag")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.DropArea"),a5.models.interaction.StackDropArea={init:function(parameters,defaults){this._super(parameters,$.extend({},defaults)),this.drags=[]},canDrop:function(model){return null==this.allowed||this.allowed.contains(model)},drop:function(drag){if(!drag)throw"null not allowed for dropping into stack drop areas";this.drags.push(drag),this.callViews("updateDrags"),drag.trigger("drop")},undrop:function(drag){this.drags.remove(drag),this.callViews("updateDrags")},isHead:function(drag){return drag&&drag===_.last(this.drags)},isCorrectable:function(){return!1},isCorrect:function(){return!1},wrongDrag:function(){return!1}},a5.models.interaction.DropArea.extend("a5.models.interaction.StackDropArea"),a5.model.InteractionToolbar={init:function(parameters,defaults){this._super(parameters,$.extend({},defaults)),this.buttons=[]},addToggleButton:function(parameters){var button=new a5.model.InteractionToolbarToggleButton($.extend(parameters,{parent:this}));return this.buttons.push(button),this.callViews("update"),button},resetToggleGroup:function(group){_.each(this.buttons,function(button){button.group==group&&button.setPressed(!1)})},isEnable:function(){return _.all(this.buttons,function(button){return button.isEnable()})},setEnableButtonsStatus:function(status){_.each(this.buttons,function(button){button.setStatus(status)})},shuffleButtons:function(){this.buttons=_.shuffle(this.buttons),this.trigger("reorder")}},a5.models.interaction.BaseModel.extend("a5.model.InteractionToolbar"),a5.model.InteractionToolbarToggleButton={init:function(parameters,defaults){this._super(parameters,$.extend({label:"label",title:"",css:{},classes:[],on:function(){},off:function(){},enable:!0,tts_audio:!1,pressed:!1,group:!1},defaults))},isPressed:function(){return this.pressed},getCss:function(){return this.css},setStatus:function(status){this.enable=status,this.callViews("update")},isEnable:function(){return this.enable},getClasses:function(){return this.classes},click:function(){this.enable&&(this.group?this.setPressed(!0):this.setPressed(!this.isPressed()))},setPressed:function(pressed){this.pressed!=pressed&&(pressed&&this.group&&this.parent.resetToggleGroup(this.group),this.pressed=pressed,this.callViews("update"),this.pressed?this.on():this.off())}},a5.models.interaction.BaseModel.extend("a5.model.InteractionToolbarToggleButton"),a5.model.NavigationHistory={init:function(){this._stack=[]},addNavigationAction:function(interaction){this._stack.push(interaction),logger.info("Showing interaction #"+interaction.index)},getHistory:function(){return _.clone(this._stack)},clearHistory:function(){this._stack=[]}},Obj.extend("a5.model.NavigationHistory"),a5.models.PollBase={init:function(parameters,defaults){this._super(parameters,$.extend({ids:[],options:[],setIds:[],sets:[],screenNo:0,interaction:null},defaults)),this.selected=[],this.interaction.bind("show",this._getSelected,this,{once:!0}),a5.eventBus.bind("lo:submit",this._setSelected,this)},_getSelected:function(){a5.service.lms.API.getUserPollAnswers(this.screenNo,function(answers){_.each(answers,function(answer){this.select(answer)},this),this.trigger("update")}.bindTo(this))},_setSelected:function(){this.selected.length&&a5.service.lms.API.setUserPollAnswers(this.screenNo,this.selected,this.options)}},a5.models.interaction.BaseModel.extend("a5.models.PollBase"),a5.models.RadioPoll={select:function(id){this.selected=[id]},deselect:function(id){this.selected[0]===id&&(this.selected=[])}},a5.models.PollBase.extend("a5.models.RadioPoll"),a5.models.CheckboxPoll={select:function(id){_.contains(this.selected,id)||this.selected.push(id)},deselect:function(id){this.selected=_.without(this.selected,id)}},a5.models.PollBase.extend("a5.models.CheckboxPoll"),a5.models.RadiosetPoll={select:function(id){var alt=id.slice(id.indexOf("-"));this.selected=_.reject(this.selected,function(id){return a5.utils.endsWith(id,alt)}),this._super(id)}},a5.models.CheckboxPoll.extend("a5.models.RadiosetPoll"),a5.models.CheckboxsetPoll={},a5.models.CheckboxPoll.extend("a5.models.CheckboxsetPoll"),a5.models.Selectable={init:function(parameters,defaults){this._super(parameters,$.extend(defaults,{name:null,gaptextaudio:!1})),this.choices=[],this.state="input"},getAnswers:function(){return _.pluck(this._getAnswerModels(),"text")},add:function(choiceModel){this.choices.push(choiceModel)},getScores:function(){return new a5.Score},tryAgain:function(){this.unselect(),this._super()},showNextAnswer:function(){_.invoke(this._getAnswerModels(),"showNextAnswer"),this._super()},setState:function(newState){_.invoke(this.choices,"setState",newState),this._super(newState)},_getAnswerModels:function(){return _.filter(this.choices,function(choice){return choice.correct&&!choice.prefill&&!choice.prefilled})}},a5.models.interaction.BaseModel.extend("a5.models.Selectable"),a5.models.RadioButton={init:function(parameters,defaults){this._super(parameters,$.extend(defaults,{selected:null}))},setSelected:function(choice){choice!=this.selected&&(this.selected=choice,this.trigger("change"),this.notifyValueChange())},isFilled:function(){return!!this.selected},isCorrect:function(){return!0},unselect:function(){this.setSelected(null)},store:function(){var data={};return this.selected?data.selected=this.selected.value:data.selected=null,data},restore:function(data){var selected=_.find(this.choices,function(choice){return choice.value==data.selected});this.setSelected(selected)}},a5.models.Selectable.extend("a5.models.RadioButton"),a5.models.RadioButtonChoice={init:function(parameters,defaults){this._super(parameters,$.extend(defaults,{value:null,interaction:null,selected:!1,enableToggle:!0})),this.selected&&this.select()},isCorrectAnswer:function(){return!0},isSelectedAnswer:function(){return this.parent.selected==this},clicked:function(){this.enableToggle?this.toggle():this.select()},select:function(){this.isSelectedAnswer()||this.parent.setSelected(this)},unselect:function(){this.isSelectedAnswer()&&this.parent.setSelected(null)},toggle:function(){this.isSelectedAnswer()?this.unselect():this.select()}},a5.models.interaction.BaseModel.extend("a5.models.RadioButtonChoice"),a5.models.Checkbox={unselect:function(){_.invoke(this.choices,"unselect")},store:function(){var choices={};return _.map(this.choices,function(choice){choices[choice.value]=choice.store()}),{choices:choices}},restore:function(data){_.each(this.choices,function(choice,i){choice.restore(data.choices[choice.value])})}},a5.models.Selectable.extend("a5.models.Checkbox"),a5.models.CheckboxChoice={init:function(parameters,defaults){this._super(parameters,$.extend({value:null,interaction:null,selected:!1},defaults))},isCorrect:function(){return!0},isSelectedAnswer:function(){return this.selected},clicked:function(){this.toggle()},select:function(){this.selected||(this.selected=!0,this.trigger("change"),this.parent.notifyValueChange())},unselect:function(){this.selected&&(this.selected=!1,this.trigger("change"),this.parent.notifyValueChange())},toggle:function(){this.isSelectedAnswer()?this.unselect():this.select()},store:function(){return{selected:this.selected}},restore:function(data){this.selected!==Boolean(data.selected)&&this.toggle()}},a5.models.interaction.BaseModel.extend("a5.models.CheckboxChoice"),a5.models.TextArea={init:function(attributes){this._super(attributes,{content:null,scorable:!1,interaction:null,maxLength:!1,minLength:!1,maxType:!1,minType:!1}),this.data=this.content},store:function(){return this.cke?this.cke.getData():this.data},getScores:function(){var score=new a5.Score;return this.isScorable()&&(score.incTotal(),this.isFilled()&&score.incFilled()),score},wordCount:function(){if(!this.data)return 0;var match=this.data.match(/[a-zA-Z0-9][a-zA-Z0-9\-']*/g);return match?match.length:0},meetsMinLength:function(){return"chars"===this.minType&&this.minLength>0?this.data.length>=this.minLength:!("words"===this.minType&&this.minLength>0)||this.wordCount()>=this.minLength},restore:function(data){this.data=data,this.trigger("change")},isScorable:function(){return this.scorable},isFilled:function(){return this.data&&this.data.length>0}},a5.models.interaction.BaseModel.extend("a5.models.TextArea"),a5.models.TriggerWord={init:function(attributes){this._super(attributes,{identifier:"",content:null,displayword:!1,showonce:!1,simultaneous:!1})}},a5.models.interaction.BaseModel.extend("a5.models.TriggerWord"),a5.models.InlineEditor={init:function(parameters,defaults){this._super(parameters,$.extend(defaults,{editor:null,prefill:""}))},store:function(){return{text:this.editor.getData()}},restore:function(data){this.text=data.text,this.trigger("update",data)},getScores:function(){var score=new a5.Score;return score.incTotal(),score}},a5.models.interaction.BaseModel.extend("a5.models.InlineEditor"),a5.model.Clock={init:function(parameters,defaults){if(this._super(parameters,$.extend({className:"",startTime:null,locked:!1,running:!1},defaults)),this.startTime){var match=this.startTime.match(/(\d?\d):(\d?\d)/);if(match){var hour=match[1],minute=match[2];this.startTime=new Date,this.startTime.setHours(hour),this.startTime.setMinutes(minute),this.startTime.setSeconds(0),this.startTime.setMilliseconds(0)
}else logger.error("Wrong time format: "+this.startTime)}_.isObject(this.startTime)||(this.startTime=new Date,this.startTime.setHours(12),this.startTime.setMinutes(0),this.startTime.setSeconds(0),this.startTime.setMilliseconds(0)),this.running?(this.timeGap=this.startTime-new Date,setInterval(_.bind(this._eachMinute,this),6e4)):this.timeGap=0},getTime:function(){return this.running?new Date(Date.now()+this.timeGap):new Date(this.startTime.getTime()+this.timeGap)},addTime:function(gap){this.timeGap=this.timeGap+gap},_eachMinute:function(){this.callViews("update")}},a5.models.interaction.BaseModel.extend("a5.model.Clock"),a5.models.Countdown={init:function(options){this.totalTime=options.total,this.elapsedTime=0,_.bindAll(this,"onTick")},start:function(){this.startTime=this._current(),this.timer=setInterval(this.onTick,100),this.trigger("start")},pause:function(){clearInterval(this.timer),this.elapsedTime+=this._current()-this.startTime,this.trigger("pause")},stop:function(){clearInterval(this.timer),this.trigger("stop")},end:function(){this.stop(),this.trigger("end")},reset:function(){clearInterval(this.timer),this.elapsedTime=0,this.trigger("reset",this.totalTime)},_current:function(){return window.performance.now()/1e3},onTick:function(){var seconds=Math.ceil(this.totalTime-this.elapsedTime+this.startTime-this._current());seconds<0&&(seconds=0),this.trigger("progress",seconds,Math.round(100*(1-seconds/this.totalTime))),0===seconds&&this.end()}},Obj.extend("a5.models.Countdown"),a5.model.Geogebra={init:function(parameters){this._super(parameters,{data:""}),_.bindAll(this,"onChange")},getData:function(){return this.data},setAPI:function(API){this.API=API,this.API.registerAddListener(this.onChange),this.API.registerRemoveListener(this.onChange),this.API.registerRenameListener(this.onChange),this.API.registerClearListener(this.onChange),this.API.registerUpdateListener(this.onChange)},store:function(){return{ggbBase64:this.data}},restore:function(data){data&&data.ggbBase64&&(this.data=data.ggbBase64)},onChange:function(){this.API.getBase64(function(data){this.data=data}.bind(this))}},a5.models.interaction.BaseModel.extend("a5.model.Geogebra"),a5.models.interaction.GapMatchInteraction={init:function(parameters,defaults){this._super(parameters,$.extend({answers:[],responses:[],stacks:0,poolAlignment:null,poolRandomized:!1,poolAlphabeticalOrder:!1,freeDragLocation:null,subtractIncorrect:!1,allowRepeat:!0,groupsMap:{},tts_audio:!1,gapsOption:null,multiDest:"one",hasOrderedResponses:!1,tryAgainIsFrozen:!1},defaults)),this.hasStacks()&&(this.stackAreas=this._createStacks()),this.mapAnswerToGap=this.responses.asInverseMap(),this.mapGapToAnswer=this.responses.asMap(),this.mapAnswerToText=_.mapObject(a5.utils.asMap(this.answers),_.first),this.mapTextToAnswer=a5.utils.asInverseMap(this.answers),this.mapAnswerToUnique=_.chain(this.mapTextToAnswer).values().reduce(function(memo,list){var reference=_.first(list);return _.reduce(list,function(obj,identifier){return obj[identifier]=reference,obj},memo,this)},{},this).value(),this.dragElements=[],this.poolDropAreas=[],this.targetDropAreas=[],this.revealedElements=[],this.nextCorrectIndex={},this.interaction=this.parent,"restricted"===this.multiDest&&this.interaction.bind("show",function(){this.updatePoolDropAreasMultidest()},this)},getAnswers:function(){var targets=_.filter(this.targetDropAreas,function(target){return target.isCorrectable()});return _.map(targets,function(target){return target.getCorrect().content.html()})},getUniqueAnswers:function(){return _.chain(this.mapTextToAnswer).values().map(_.first).value()},getUniqueDragElement:function(drag){var uniqueIdentifier=this.mapAnswerToUnique[drag.identifier];return this.getDragByIdentifier(uniqueIdentifier)},getStackFor:function(index){return this.stackAreas&&this.stackAreas[index%this.stacks]},sortPoolByText:function(){this.poolDropAreas=a5.utils.array.sortBy(this.poolDropAreas,function(dropArea){return dropArea.drag?dropArea.drag.content.text():""},!0)},naturalsortPoolByText:function(){this.poolDropAreas=a5.utils.array.naturalSort(this.poolDropAreas,function(dt){return dt.drag?dt.drag.content.text():""},!0,!0)},getAvailablePoolAreas:function(){return this.hasStacks()?this.stackAreas:_.filter(this.poolDropAreas,function(pa){return!pa.isFilled()&&!pa.prefilled})},getAvailableFillAreas:function(){return _.filter(this.targetDropAreas,function(tda){return!(tda.isFilled()||tda.isRevealed())})},randomizePool:function(){this.poolDropAreas=_.shuffle(this.poolDropAreas)},hasStacks:function(){return _.isNumber(this.stacks)&&!_.isNaN(this.stacks)&&this.stacks>0},addDragElement:function(dragElement){dragElement.parent=this,this.dragElements.push(dragElement),dragElement.bind("drop",this._onChange,this)},addPoolDropArea:function(dropArea){dropArea.parent=this,this.poolDropAreas.push(dropArea)},addTargetDropArea:function(dropArea){dropArea.parent=this,dropArea.group=this.groupsMap[dropArea.identifier],this.targetDropAreas.push(dropArea)},_onChange:function(){"restricted"===this.multiDest&&this.updatePoolDropAreasMultidest()},setPrefilled:function(dropArea){"restricted"===this.multiDest?0===this.dragElementsCount[dropArea.drag.identifier]&&dropArea.setPrefilled():dropArea.setPrefilled()},updatePoolDropAreasMultidest:function(){this.hasOrderedResponses&&!this.mapTextToCount&&(this.mapTextToCount=_.chain(this.targetDropAreas).map(function(target){return target.correct()}).unzip().map(function(correct){return _.countBy(correct)}).value()),this.dragElementsCount={},_.each(this.dragElements,function(drag){this.isDistractor(drag)||(this.dragElementsCount[drag.identifier]=this.getNumberOfCorrectRepetitions(drag))},this),_.each(this.targetDropAreas,function(target){if(target.drag&&!this.isDistractor(target.drag)){var count=this.dragElementsCount[target.drag.identifier];this.dragElementsCount[target.drag.identifier]=_.max([count-1,0])}},this),_.each(this.revealedElements,function(drag){var uniqueId=this.mapAnswerToUnique[drag.identifier],count=this.dragElementsCount[uniqueId];this.dragElementsCount[uniqueId]=_.max([count-1,0])},this),_.each(this.poolDropAreas,function(pool){pool.drag&&!this.isDistractor(pool.drag)&&(pool.copyOnDrag=this.dragElementsCount[pool.drag.identifier]>1)},this)},getNumberOfCorrectRepetitions:function(drag){if(this.hasOrderedResponses&&"restricted"===this.multiDest){var text=this.mapAnswerToText[drag.identifier];return _.max(this.mapTextToCount,function(count){return count[text]})[text]}return this.mapAnswerToGap[drag.identifier].length},_createStacks:function(){var stackAreas=[];return _.each(_.range(0,this.stacks),function(){var stack=new a5.models.interaction.StackDropArea({parent:this,dropIndicator:this.parent.options.dropIndicatorIsTrue(),copyOnDrag:!1});stackAreas.push(stack)},this),stackAreas},isFreeDragLocation:function(){return"between_letters"===this.freeDragLocation||"between_words"===this.freeDragLocation},getScores:function(){var groups=_.groupBy(this.targetDropAreas,function(target){return target.blockNumber}),groupScores=_.map(groups,function(targets,group){var blockScore=this.interaction.options.getScoreValuesPerBlock().split(",");blockScore=parseInt(blockScore[group],10),_.isNaN(blockScore)&&(blockScore=void 0);var score=new a5.Score;return _.each(targets,function(target){target.isCorrectable()&&(target.isScorable()&&score.incTotal(),null!=target.drag&&(score.incFilled(),target.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect()))},this),score.filled>score.total&&(score.filled=score.total),score.correct<0&&(score.correct=0),(score.total>0||blockScore>0)&&(score.totalBlocks=1,score.total>0&&score.correct==score.total?score.correctBlocks=1:this.subtractIncorrect&&score.total>0&&score.filled>0&&score.correct<score.total&&(score.correctBlocks=-1),0===score.total&&(score.total=blockScore),score.blockScore=blockScore),score},this),score=new a5.Score;return _.each(groupScores,function(qiScore){_.isUndefined(qiScore.blockScore)?(score.total+=qiScore.total,score.correct+=qiScore.correct,score.filled+=qiScore.filled,score.totalBlocks+=qiScore.totalBlocks,score.correctBlocks+=qiScore.correctBlocks):(score.total+=qiScore.blockScore,score.correct+=qiScore.correct*qiScore.blockScore/qiScore.total,score.filled+=qiScore.filled*qiScore.blockScore/qiScore.total,score.totalBlocks+=qiScore.blockScore,score.correctBlocks+=qiScore.correctBlocks*qiScore.blockScore/qiScore.totalBlocks)},this),score},isCorrect:function(){return _.every(this.targetDropAreas,function(target){return target.prefilled||target.isCorrect()})},isFilled:function(){return _.some(this.targetDropAreas,function(target){return!target.prefilled&&target.isFilled()})},areAllFilled:function(){return _.all(this.targetDropAreas,function(target){return target.prefilled||target.isFilled()})},getCandidatesForSolutionHint:function(){return _.filter(this.targetDropAreas,function(item){return"answers"!==item.state&&item.isCorrectable()&&!item.isFilled()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.targetDropAreas,function(item){return"answers"!==item.state&&item.isCorrectable()&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForValidation:function(){return _.filter(this.targetDropAreas,function(item){return"answers"!==item.state&&item.isCorrectable()&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},clearRevealed:function(){this._super(),this.revealedElements=[]},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();if(question){var drag=question.drag;question.undrop(),question.showNextAnswer(),drag&&drag.home.drop(drag);var revealed=question.getCurrentCorrectDrag(),revealedId=revealed.identifier,uniqueId="one"===this.multiDest?revealedId:this.mapAnswerToUnique[revealed.identifier],revealedInPool=_.find(this.poolDropAreas,function(poolItem){return!!poolItem.drag&&poolItem.drag.identifier==uniqueId});if(revealedInPool)revealedInPool.copyOnDrag||revealedInPool.drag.home.undrop();else{var revealedInTarget=_.find(this.targetDropAreas,function(targetItem){return!!targetItem.drag&&this.mapAnswerToUnique[targetItem.drag.identifier]===revealedId&&!targetItem.isCorrect()},this);revealedInTarget.copyOnDrag||revealedInTarget.undrop()}"restricted"===this.multiDest&&(this.revealedElements.push(revealed),this.updatePoolDropAreasMultidest())}return 0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();if(question){question.showSolutionHint();var correct=question.getCurrentCorrectDrag(),correctId=correct.identifier,pool=_.find(this.poolDropAreas,function(poolItem){return!!poolItem.drag&&poolItem.drag.identifier==correctId});pool&&!pool.copyOnDrag&&pool.drag.home.callViews("updateToThisDrag",[null])}return this.hasCandidatesForValidation()||(this.state="answers"),question},disableDrags:function(){_.invoke(this.dragElements,"disable")},enableDrags:function(){_.invoke(this.dragElements,"enable")},setAnswer:function(){_.each(this.targetDropAreas,function(targetItem,index){!targetItem.isCorrectable()||this.isFreeDragLocation()&&!targetItem.drag||targetItem.setAnswer()},this),this.disableDrags()},setAnswerInput:function(){_.each(this.targetDropAreas,function(targetItem){!targetItem.isCorrectable()||this.isFreeDragLocation()&&!targetItem.drag||targetItem.setAnswerInput()},this)},showAnswer:function(){_.each(this.targetDropAreas,function(targetItem,index){if(targetItem.isCorrectable()){targetItem.showAnswer();var drag=targetItem.drag;if(drag&&drag.home.callViews("updateToThisDrag",[null]),!targetItem.isCorrect()){this.isDistractor(drag)&&drag.home.callViews("updateToThisDrag",[drag]);var correct=targetItem.getCorrect();correct&&targetItem.callViews("updateToThisDrag",[correct])}}},this),_.each(this.poolDropAreas,function(targetItem,index){var drag=targetItem.drag;!this.isDistractor(drag)&&drag?drag.home.callViews("updateToThisDrag",[null]):this.isDistractor(drag)&&drag.home.callViews("updateToThisDrag",[drag])},this),this.disableDrags()},tryAgain:function(){this.clearRevealed();var poolDrags=[];if(this.hasStacks()){var drags=_.flatten(_.pluck(this.stackAreas,"drags"));_.each(drags,function(drag){poolDrags.push(drag),drag.home.undrop(drag)})}else _.each(this.poolDropAreas,function(targetItem){targetItem.drag&&(poolDrags.push(targetItem.drag),targetItem.undrop())});_.each(poolDrags,function(drag,index){drag.home.drop(drag)}),_.each(this.targetDropAreas,function(targetItem,index){targetItem.isCorrectable()&&targetItem.tryAgain()}),this.enableDrags(),_.invoke(this.dragElements,"tryAgain")},isDistractor:function(drag){return drag&&!this.mapAnswerToGap[drag.identifier]},getSelectedDragElement:function(){return _.filter(this.dragElements,function(drag){return drag.selected})},getDragByIdentifier:function(identifier){return _.find(this.dragElements,function(drag){return drag.identifier==identifier})},getDragByText:function(text){return _.find(this.dragElements,function(drag){return drag.identifier in this.mapAnswerToText&&this.mapAnswerToText[drag.identifier]===text},this)},getDragByID:function(id){return _.find(this.dragElements,function(drag){return drag.id===id})},store:function(){var targets=[];_.each(this.targetDropAreas,function(target,indx){targets.push(target.drag?target.drag.identifier:"")});var sources=_.map(this.poolDropAreas,function(target,indx){return target.resident.identifier}),stacks=_.map(this.stackAreas,function(stack){return _.map(stack.drags,function(drag){return drag.identifier})});return{targets:targets,sources:sources,stacks:stacks}},restore:function(params){this.poolDropAreas=_.sortBy(this.poolDropAreas,function(source){return _.indexOf(params.sources,source.resident.identifier)},this),_.each(params.stacks,function(stack,position){_.each(stack,function(dragID){var drag=this.getDragByIdentifier(dragID)||this.getDragByText(this.mapAnswerToText[dragID]);drag&&(drag.home.undrop(drag),this.stackAreas[position].drop(drag))},this)},this),_.each(params.targets,function(dragID,position){var drag=this.getDragByIdentifier(dragID)||this.getDragByText(this.mapAnswerToText[dragID]);drag&&(drag.copyOnDrag||!drag.home||drag.home.copyOnDrag||drag.home.undrop(drag),this.targetDropAreas[position].drop(drag))},this)}},a5.models.interaction.BaseModel.extend("a5.models.interaction.GapMatchInteraction"),a5.models.interaction.Gap={init:function(parameters,defaults){this._super(parameters,$.extend({group:!1,identifier:"",allowRepeat:!0,tryAgainKeep:!1,blockNumber:0,hasOrderedResponses:!1,hasOrderedResponsesFirstAnswer:!1,tryAgainIsFrozen:!1,inputStyle:null},defaults))},correct:function(){var correct=this.parent.mapGapToAnswer[this.identifier]||[];return correct=_.filter(correct,function(choice){return choice==="GT"+this.identifier||0===choice.indexOf("GT"+this.identifier+"_")},this),correct=_.map(correct,function(choice){return this.parent.mapAnswerToText[choice]},this)},value:function(){var value="";return this.drag&&(value=this.parent.mapAnswerToText[this.drag.identifier]),value},nextDrag:function(text){var drags=_.filter(this.parent.dragElements,function(drag){return!this.parent.isDistractor(drag)&&this._isValidNextDrag(drag,text)},this);_.isUndefined(this.parent.nextCorrectIndex[text])&&(this.parent.nextCorrectIndex[text]=0);var rt=drags[this.parent.nextCorrectIndex[text]];return this.parent.nextCorrectIndex[text]=(this.parent.nextCorrectIndex[text]+1)%drags.length,this.currentCorrectDrag=rt,rt},_isValidNextDrag:function(drag,text){var ret=!1;if(a5.utils.containsAnswer(this.parent.mapAnswerToText[drag.identifier],[text]))if(!drag.home||drag.home.copyOnDrag)ret=!0;else{var correctCount=this.parent.getNumberOfCorrectRepetitions(drag),alreadyUsedCount=_.filter(this.parent.targetDropAreas,function(dropArea){return dropArea.isCorrect()&&dropArea.drag.identifier===drag.identifier}).length;ret=alreadyUsedCount<correctCount}return ret},getCurrentCorrectDrag:function(){return this.currentCorrectDrag},isCorrect:function(){var items;return this.group&&this.hasOrderedResponses?this._isCorrectWithOrderDependencyGroups(this.parent.targetDropAreas):this.group&&!this.allowRepeat?(items=_.filter(this.parent.targetDropAreas,function(dropArea){return dropArea.blockNumber===this.blockNumber&&dropArea.group===this.group},this),this._isCorrectWithRepeatPrevent(items)):this.hasOrderedResponses?(items=_.filter(this.parent.targetDropAreas,function(dropArea){return dropArea.blockNumber===this.blockNumber},this),this._isCorrectWithOrderDependency(items)):this.allowRepeat?this._isCorrect():(items=_.filter(this.parent.targetDropAreas,function(dropArea){return dropArea.blockNumber===this.blockNumber},this),this._isCorrectWithRepeatPrevent(items))},_isCorrect:function(){return this.isFilled()&&a5.utils.containsAnswer(this.value(),this.correct(),this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},_isCorrectWithOrderDependency:function(items){return this.hasOrderedResponsesFirstAnswer?this._isCorrectWithOrderDependencyFirstAnswer(items):this._isCorrectWithOrderDependencyLongestCombination(items)},_isCorrectWithOrderDependencyLongestCombination:function(items){var longestCombination=this._longestCombination(items);return a5.utils.checkUserInput(this.value(),this.correct()[longestCombination.position],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},_isCorrectWithOrderDependencyFirstAnswer:function(items){var longestCombination=this._longestCombinationFirstAnswer(items);return _.size(longestCombination.elements)>0&&longestCombination.position>=0&&a5.utils.checkUserInput(this.value(),this.correct()[longestCombination.position],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},_isCorrectWithRepeatPrevent:function(items){var totalCorrectInAnswer=a5.utils.countAnswer(this.value(),this.correct(),this.ignoreCase,this.ignorePunctuation,this.ignoreAccents),totalCorrect=this.correct().length,checkUntilIndex=_.indexOf(items,this),correctAnswers=_.chain(items).first(checkUntilIndex+1).filter(function(item){return item._isCorrect()&&a5.utils.containsAnswer(this.value(),[item.value()],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},this).value();return this._isCorrect()&&(totalCorrectInAnswer===totalCorrect||correctAnswers.length<=totalCorrectInAnswer)},_isCorrectWithOrderDependencyGroups:function(items){var groups=_.chain(items).groupBy("group").omit(!1).value(),groupItems=groups[this.group],groupIsCorrect=_.all(groupItems,function(item){return item._isCorrectWithOrderDependency(groupItems)});groups=_.omit(groups,function(group,key){return _.some(group,function(item){return!item._isCorrectWithOrderDependency(group)})},this);var groupCorrectIndexes=_.mapObject(groups,function(group){var longestCombination;return longestCombination=this.hasOrderedResponsesFirstAnswer?this._longestCombinationFirstAnswer(group):this._longestCombination(group),longestCombination.position},this),groupCorrectIndexesPairs=_.pairs(groupCorrectIndexes),checkUntilIndex=_.findIndex(groupCorrectIndexesPairs,function(g){return _.first(g)===this.group},this),groupIsRepeat=_.chain(groupCorrectIndexesPairs).first(checkUntilIndex+1).some(function(g){return _.first(g)!==this.group&&_.last(g)===groupCorrectIndexes[this.group]},this).value();return groupIsCorrect&&!groupIsRepeat},_longestCombination:function(items){var possibleChoices=_.map(items,function(item){return item.correct()}),choices=_.map(items,function(item){return item.value()}),flipedChoices=_.unzip(possibleChoices);flipedChoices=_.map(flipedChoices,function(c){return _.chain(c).zip(choices).filter(function(d){return a5.utils.checkUserInput(d[1],d[0],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)}).value()},this);var elements=_.max(flipedChoices,_.size);return{elements:elements,position:_.indexOf(flipedChoices,elements)}},_longestCombinationFirstAnswer:function(items){var firstAnswer=_.first(items),possibleChoices=_.map(items,function(item){return item.correct()}),choices=_.map(items,function(item){return item.value()}),flipedChoices=_.unzip(possibleChoices),firstValue=firstAnswer.value();firstValue&&(flipedChoices=_.map(flipedChoices,function(c){return a5.utils.checkUserInput(_.first(c),firstValue,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)?c:[]},this)),flipedChoices=_.map(flipedChoices,function(c){return _.chain(c).zip(choices).filter(function(d){return a5.utils.checkUserInput(d[1],d[0],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)}).value()},this);var elements=_.max(flipedChoices,_.size);return{elements:elements,position:_.indexOf(flipedChoices,elements)}},getCorrect:function(){return this.isCorrect()?this.drag:this.nextDrag(this._findCorrect())},_findCorrect:function(){var items;return this.group&&this.hasOrderedResponses?this._getCorrectWithOrderDependencyGroups(this.parent.targetDropAreas):this.group&&!this.allowRepeat?(items=_.filter(this.parent.targetDropAreas,function(dropArea){return dropArea.blockNumber===this.blockNumber&&dropArea.group===this.group},this),this._getCorrectWithRepeatPrevent(items)):this.hasOrderedResponses?(items=_.filter(this.parent.targetDropAreas,function(dropArea){return dropArea.blockNumber===this.blockNumber},this),this._getCorrectWithOrderDependency(items)):this.allowRepeat?this._getCorrect():(items=_.filter(this.parent.targetDropAreas,function(item){return item.blockNumber===this.blockNumber},this),this._getCorrectWithRepeatPrevent(items))},_getCorrect:function(index){return this.correct().length>0&&this.correct()[index||0]||""},_getCorrectWithOrderDependency:function(items,firstAnswerMode){return firstAnswerMode?this._getCorrectWithOrderDependencyFirstAnswer(items):this._getCorrectWithOrderDependencyLongestCombination(items)},_getCorrectWithOrderDependencyLongestCombination:function(items){var longestCombination=this._longestCombination(items);return this._getCorrect(longestCombination.position)},_getCorrectWithOrderDependencyFirstAnswer:function(items){var firstAnswer=_.first(items),position=_.max([firstAnswer.correct().indexOf(firstAnswer.value()),0]);return this._getCorrect(position)},_getCorrectWithRepeatPrevent:function(items){var correct=this.correct().slice(0);return correct.length>1&&(items=_.without(items,this),_.each(items,function(item){var answer=item.isCorrect()?item.value():item.correctAnswer,correctIndex=a5.utils.indexOf(answer,correct,!0,item.ignorePunctuation,item.ignoreAccents);correctIndex>=0&&correct.splice(correctIndex,1)},this)),this.correctAnswer=_.first(correct)||_.first(this.correct()),this.correctAnswer},_getCorrectWithOrderDependencyGroups:function(items){var groups=_.groupBy(items,function(g){return g.group}),correct=this.correct().slice(0);correct.length>1&&(items=_.chain(groups).mapObject(function(group){return _.first(group)}).values().value(),_.each(items,function(item){if(item.group!==this.group){var answer=item.isCorrect()?item.value():item.correctAnswer,itemCorrectIndex=a5.utils.indexOf(answer,item.correct(),!0,item.ignorePunctuation,item.ignoreAccents),correctIndex=a5.utils.indexOf(this.correct()[itemCorrectIndex],correct,!0,this.ignorePunctuation,this.ignoreAccents);correctIndex>=0&&correct.splice(correctIndex,1)}},this)),this.correctAnswer=this.correctAnswer||_.first(correct)||_.first(this.correct());var index=a5.utils.indexOf(this.correctAnswer,this.correct(),this.ignoreCase,this.ignorePunctuation,this.ignoreAccents);return _.each(groups[this.group],function(item){item.correctAnswer=item._getCorrect(index)}),this.correctAnswer},correctText:function(){return this.correct().join(", ")},wrongText:function(){return this.value()},getAnswerFeedback:function(model){return this.isCorrect()?this.processFeedback(this.correctFeedback)||model&&model.answerFeedback:this.processFeedback(this.incorrectFeedback)||model&&model.answerFeedback},wrongDrag:function(){return this.drag&&!this.isCorrect()&&this.isCorrectable()},setAnswer:function(){this._super(),this.isCorrectable()&&this.callViews("setAnswer")},showAnswer:function(){this._super(),this.isCorrectable()&&this.callViews("showAnswer")},showNextAnswer:function(){this._super(),this.isCorrectable()&&this.callViews("showNextAnswer")},showSolutionHint:function(){this._super(),this.isCorrectable()&&this.callViews("showSolutionHint")},tryAgain:function(){if(this._super(),this.isCorrectable())if(this.callViews("tryAgain"),this.isCorrect()||this.tryAgainKeep)this.callViews("updateToThisDrag",[this.drag]);else{var drag=this.drag;this.undrop(),drag&&drag.home.drop(drag)}},getScores:function(){var score=new a5.Score;return this.isCorrectable()&&(score.incTotal(),this.isCorrect()&&score.incCorrect(),null!=this.drag&&score.incFilled()),score},isCorrectable:function(){return!this.isDistractor()&&!this.prefilled},isScorable:function(){return this.isCorrectable()},isDistractor:function(){return _.isEmpty(this.correct())}},a5.models.interaction.DropArea.extend("a5.models.interaction.Gap"),a5.models.interaction.OMTextGapSpaceGap={isCorrect:function(){return!1},getCorrect:function(){return null},isCorrectable:function(){return!!this.drag},isScorable:function(){return!1},isDistractor:function(){return!1}},a5.models.interaction.Gap.extend("a5.models.interaction.OMTextGapSpaceGap"),a5.models.interaction.GraphicGapMatchInteraction={setImageSize:function(size){size&&size.width&&size.height&&(this.originalSize=size)}},a5.models.interaction.GapMatchInteraction.extend("a5.models.interaction.GraphicGapMatchInteraction"),a5.models.interaction.OMPairsInteraction={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({behaviour:"drop",interactionIndex:null,responses:[],gaps:[],poolAlignment:"",pairAlignment:""},defaults))},isDrag:function(){return"drag"===this.behaviour},isTapItem:function(){return"tap_item"===this.behaviour},isTapTarget:function(){return"tap_target"===this.behaviour},addGaps:function(gaps){this.gaps=this.gaps.concat(gaps)},addResponses:function(responses){this.responses=this.responses.concat(responses)},isFilled:function(){return _.some(this.gaps,function(gap){return gap.isFilled()})},isCorrect:function(){return _.all(this.gaps,function(gap){return gap.isCorrect()})},getScores:function(){var score=new a5.Score;return _.each(this.gaps,function(gap){gap.isPrefilled()||(score.incTotal(),gap.isCorrect()&&score.incCorrect(),gap.isFilled()&&score.incFilled())}),score},store:function(){return _.pluck(this.gaps,"value")},restore:function(data){_.each(this.gaps,function(gap,index){gap.updateValue({identifier:data[index]}),gap.setState("input")},this)},setAnswer:function(){this._super(),_.invoke(this.responses,"setAnswer"),_.invoke(this.gaps,"setAnswer")},tryAgain:function(){this._super(),_.invoke(this.responses,"tryAgain"),_.invoke(this.gaps,"tryAgain")},showAnswer:function(){this._super(),_.invoke(this.responses,"showAnswer"),_.invoke(this.gaps,"showAnswer")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OMPairsInteraction"),a5.models.interaction.OMPairsGap={init:function(parameters,defaults){this._super(parameters,$.extend({identifier:"",correctResponse:null,content:"",value:null,prefilled:!1,enumeration:"",tryAgainBehaviour:{},dropIndicator:!1,gaptextaudio:!1},defaults))},updateValue:function(response){this.value=response?response.identifier:null,this.parent.notifyValueChange()},isCorrect:function(){return this.value===this.correctResponse},isFilled:function(){return Boolean(this.value)},isPrefilled:function(){return this.prefilled},tryAgain:function(){this.keepAnswer()||(this.value=null),this._super()},keepAnswer:function(){return"correct"===this.tryAgainBehaviour.keep?this.isCorrect():"all"===this.tryAgainBehaviour.keep},lockAnswer:function(){return this.tryAgainBehaviour.lock}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OMPairsGap"),a5.models.interaction.OMPairsResponse={init:function(parameters,defaults){this._super(parameters,$.extend({identifier:"",correctGap:null,content:"",isCorrect:!1,prefilled:!1,gaptextaudio:!1},defaults))},isDistractor:function(){return Boolean(this.correctGap)},isPrefilled:function(){return this.prefilled},isInPool:function(){return!_.contains(_.pluck(this.parent.gaps,"value"),this.identifier)},isInGap:function(){return!this.isInPool()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OMPairsResponse"),a5.models.interaction.OMPairsModel={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({},defaults)),this.interaction=interaction,this.items={},this.badAnswers={},this.goodAnswers={},this.prefilled=[]},draggedItem:function(drag,target){var self=this;_.each(this.items,function(v,k){_.include(v,drag)&&(self.items[k]=_.without(self.items[k],drag))}),_.isUndefined(target)||(_.isUndefined(self.items[target])&&(self.items[target]=[]),this.items[target].push(drag)),this.notifyValueChange()},removeItem:function(item){var self=this;_.each(this.items,function(v,k){self.items[k]=_.without(self.items[k],item)}),this.notifyValueChange()},addPrefill:function(id){this.prefilled.push(id)},isFilled:function(){_.some(this.items,function(v,k){return v.length>0})},getScores:function(){var score=new a5.Score,self=this;return _.each(self.targetPools,function(v,k){_.each(v,function(item){_.include(self.prefilled,item)||(score.incTotal(),self.items[k]&&_.include(self.items[k],item)&&score.incCorrect())})}),_.each(self.items,function(v,k){_.each(v,function(item){_.include(self.prefilled,item)||score.incFilled()})}),score.numberOfCorrectItems<0&&(score.numberOfCorrectItems=0),score},setAnswer:function(){this._updateAnswers(),this.callViews("setAnswer")},tryAgain:function(){this.callViews("tryAgain")},showAnswer:function(){this._updateAnswers(),this.callViews("showAnswer")},_updateAnswers:function(){this.goodAnswers={},this.badAnswers={},_.each(this.targetPools,function(v,k){_.each(v,function(item){this.items[k]&&_.include(this.items[k],item)?this.goodAnswers[item]=k:this.badAnswers[item]=k},this)},this);try{var expected_items=_.flatten(_.values(this.targetPools));_.each(this.items,function(v,k){_.each(v,function(item){_.include(expected_items,item)||(this.badAnswers[item]=k)},this)},this)}catch(e){}},store:function(){return{items:this.items,badAnswers:this.badAnswers,goodAnswers:this.goodAnswers,prefilled:this.prefilled}},restore:function(hash){hash.items&&(this.items=hash.items),hash.badAnswers&&(this.badAnswers=hash.badAnswers),hash.goodAnswers&&(this.goodAnswers=hash.goodAnswers),hash.prefilled&&(this.prefilled=hash.prefilled),this.callViews("updateState")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OMPairsModel"),a5.models.interaction.ICTextGapLabelAnObjectBlock={init:function(parameters,defaults){this._super(parameters,$.extend({poolAlignment:"none",poolWords:[],tts_audio:!1},defaults)),this.gaps=[]},add:function(gap){this.gaps.push(gap)},setImageSize:function(size){this.originalSize=size}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapLabelAnObjectBlock"),a5.models.interaction.ICTextGapLabelAnObject={init:function(parameters,defaults){this._super(parameters,$.extend({prefill:!1,value:"",correct:[],position:null,identifier:null,ignorePunctuation:!1,ignoreCase:!1,ignoreSpaces:!1,ignoreAccents:!1,enumeration:null,display_words:[],distractors:[],hintLetters:[],global_enumeration:!1,length:10,tryAgainKeep:!1,spellcheck:!1,resizeGaps:!1,charactersNumber:!1,tryAgainIsFrozen:!1,inputStyle:null},defaults)),this.state="input"},isCorrect:function(){return a5.utils.containsAnswer(this.value,this.correct,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces)},getCorrect:function(){var correct
;return correct=this.value&&this.isCorrect()?this.value:this._findCorrect(),this._replaceSyntax(correct)},_replaceSyntax:function(correct){return correct.replace("%0"," ")},_findCorrect:function(){return this._getCorrect()},_getCorrect:function(index){return this.correct.length>0&&this.correct[index||0]||""},getMaskPattern:function(){var correct=this.getCorrect(),ret="*";return correct&&(ret=correct.replace(/\S/g,"*"),_.each(this.hintLetters,function(hint){ret=ret.slice(0,hint.from)+hint.str+ret.slice(hint.to+1)})),ret},correctText:function(){return this.correct.join(", ")},wrongText:function(){return this.value},setValue:function(value){value!==this.value&&(this.value=value,this.notifyValueChange())},isFilled:function(){return!_.isUndefined(this.value)&&this.value.trim().length>0},isCorrectable:function(){return!this.isDistractor()&&!this.prefill},isDistractor:function(){return _.isEmpty(this.correct)},store:function(){return this.value},restore:function(data){this.value="",_.isString(data)&&(this.value=data),this.setState("input")},getScores:function(){var score=new a5.Score;return this.isCorrectable()&&(score.incTotal(),this.isFilled()&&score.incFilled(),this.isCorrect()&&score.incCorrect()),score},tryAgain:function(){this.isCorrect()||this.tryAgainKeep||(this.value=""),this._super()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapLabelAnObject"),a5.model.interaction.IMWordsearch={directions:[new Vec2(0,-1),new Vec2(1,-1),new Vec2(1,0),new Vec2(1,1),new Vec2(0,1),new Vec2(-1,1),new Vec2(-1,0),new Vec2(-1,-1)],init:function(parameters,defaults){this._super(parameters,$.extend({width:10,height:10,hasPrefill:!1},defaults)),this.cells=new Array(this.width*this.height),this.words=[],this.markings=[]},addWord:function(params){this.words.push(new a5.model.interaction.IMWordsearchWord($.extend({parent:this},params)))},addMarking:function(marking){this.markings.push(new a5.model.interaction.IMWordsearchMarking({start:marking[0],end:marking[1],parent:this})),this.notifyValueChange()},removeMarkingsAt:function(position){this.markings=_.filter(this.markings,function(marking){return!marking.contains(position)}),this.notifyValueChange()},removeEnabledMarkingsAt:function(position){this.markings=_.reject(this.markings,function(marking){return marking.isEnabled()&&marking.contains(position)}),this.notifyValueChange()},getMarkingsAt:function(position){return _.filter(this.markings,function(marking){return marking.contains(position)})},getEnabledMarkingsAt:function(position){return _.filter(this.markings,function(marking){return marking.isEnabled()&&marking.contains(position)})},initState:function(){_.each(this.words,function(word,index){for(var start=word.start,c=0;c<word.word.length;c++){var cell=this.getCell(start);cell||(cell=new a5.model.interaction.IMWordsearchCell({position:start,letter:word.word.substr(c,1)}),cell.id=[this.id,start.y*this.width+start.x].join(""),this.setCell(start,cell)),this.hasPrefill&&0==index&&(cell.prefilled=!0,this.prefilled_word=word),start=start.addV(word.direction),word.cells.push(cell)}},this);for(var y=0;y<this.height;y++)for(var x=0;x<this.width;x++){var pos=new Vec2(x,y),cell=this.getCell(pos);cell||(cell=new a5.model.interaction.IMWordsearchCell({position:pos,letter:String.fromCharCode(97+Math.floor(26*Math.random()))}),cell.id=[this.id,pos.y*this.width+pos.x].join(""),this.setCell(pos,cell))}this.hasPrefill&&(this.words=_.rest(this.words))},getCell:function(position){return this.cells[position.y*this.width+position.x]},setCell:function(position,cell){this.cells[position.y*this.width+position.x]=cell},store:function(){var data=[];return _.each(this.markings,function(marking){data.push(marking.asList())}),data},restore:function(data){var scope=this;_.each(data,function(marking){var mark=_.map(marking,function(mark){return new Vec2(mark.x,mark.y)});scope.addMarking(mark)}),this.setState("input")},isCorrect:function(){return _.every(this.words,function(word){return word.isCorrect()})},isFilled:function(){return this.markings.length>0},areAllFilled:function(){return this.getScores().areAllFilled()},getCandidatesForSolutionHint:function(){return _.filter(this.words,function(item){return item.state!==item.STATES.ANSWERS&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.words,function(item){return!(item.isRevealed()||item.isCorrect()||item.prefill||item.prefilled)})},getCandidatesForValidation:function(){return _.filter(this.words,function(item){return item.state!==item.STATES.ANSWERS&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},clearIncorrectAnswers:function(){var incorrect=_.filter(this.markings,function(mark){return!mark.isCorrect()});this.markings=_.difference(this.markings,incorrect),this.trigger("clear-incorrect")},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return this.setRevealedBySeeNext(),question&&question.showNextAnswer(),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state=this.STATES.ANSWERS),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return this.setRevealedBySolutionHint(),question&&question.showSolutionHint(),this.hasCandidatesForValidation()||(this.state=this.STATES.ANSWERS),question},getScores:function(){var score=new a5.Score;return _.each(this.words,function(word){word.isPrefilled()||(score.incTotal(),score.incCorrect(word.isCorrect()))}),score.filled=this.markings.length,score.filled>score.total&&(score.filled=score.total),score},showAnswer:function(){this.setEnabledFor(this.words,!1),this.showAnswerNewLogic()},setAnswer:function(){this.setAnswerNewLogic()},tryAgain:function(){this.tryAgainNewLogic()},getAllItems:function(){return this.markings},getCorrectItems:function(){return _.filter(this.markings,function(mark){return mark.isCorrect()})},getIncorrectItems:function(){return _.filter(this.markings,function(mark){return!mark.isCorrect()})},clearUserDataFor:function(items){this.markings=_.difference(this.markings,items)},clearValidationFor:function(items){_.invoke(items,"clearValidation")},setEnabledFor:function(items,enabled){_.invoke(items,"setEnabled",enabled)}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMWordsearch"),a5.model.interaction.IMWordsearchWord={init:function(parameters,defaults){this._super(parameters,$.extend({word:"empty",start:new Vec2(0,0),directionIndex:0},defaults)),this.word=this.word.toLowerCase(),this.direction=this.parent.directions[this.directionIndex];var diff=this.direction.mulS(this.word.length-1);this.end=this.start.addV(diff),this.cells=[]},isPrefilled:function(){return!1},asList:function(){return[this.start,this.end]},isCorrect:function(){return _.any(this.parent.markings,function(m){return this.matches(m)},this)},matches:function(marking){return this.start.equals(marking.start)&&this.end.equals(marking.end)||this.start.equals(marking.end)&&this.end.equals(marking.start)},setEnabled:function(enabled){_.invoke(this.cells,"setEnabled",enabled)},showNextAnswer:function(){this.setRevealedBySeeNext(),this.setEnabled(!1),this.state=this.STATES.ANSWERS,this.parent.trigger("show-next",this)},showSolutionHint:function(){this.setRevealedBySolutionHint(),this.setEnabled(!1),this.state=this.STATES.ANSWERS,this.parent.trigger("show-next",this)}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMWordsearchWord"),a5.model.interaction.IMWordsearchCell={init:function(parameters,defaults){this._super(parameters,$.extend({letter:"x",position:new Vec2(0,0),prefilled:!1},defaults))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMWordsearchCell"),a5.model.interaction.IMWordsearchMarking={init:function(parameters,defaults){this._super(parameters,$.extend({start:null,end:null,enabled:!0},defaults)),this.direction=this._initDirection(),this.cells=this._initCells()},asList:function(){return[this.start,this.end]},isEnabled:function(){return this.enabled},isCorrect:function(){var self=this;return _.any(this.parent.words,function(word){return word.matches(self)})},contains:function(position){var start=this.start,step=this.end.subV(this.start),length=Math.max(Math.abs(step.x),Math.abs(step.y));step.normalize();for(var cnt=0;cnt<=length;cnt++){if(start.equals(position))return!0;start=start.addV(step),start.round()}},matches:function(marking){return this.start.equals(marking.start)&&this.end.equals(marking.end)||this.start.equals(marking.end)&&this.end.equals(marking.start)},setEnabled:function(enabled){this.enabled=enabled,_.invoke(this.cells,"setEnabled",enabled)},_initCells:function(){for(var cells=[],i=this.start;!i.equals(this.end.addV(this.direction));)cells.push(this.parent.getCell(i)),i=i.addV(this.direction);return cells},_initDirection:function(){return new Vec2(Math.sign(this.end.x-this.start.x),Math.sign(this.end.y-this.start.y))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMWordsearchMarking"),a5.models.interaction.LLModel={init:function(parameters,defaults){this._super(parameters,$.extend({sets:2,displayInRows:!1,tryAgainKeep:!1,tryAgainIsFrozen:!1,answers:{},behaviourIsTouch:!1,headings:[]},defaults)),this.elements=[],this.lines=[],this.prevAnswers=[],this.prefilledLines=[],this.enumSets={},this.state="input"},correctModels:function(){var lines=[],self=this;return _.each(this.answers,function(vals,key){var start=self.getById(key);_.each(vals,function(v){var end=self.getById(v);lines.push([start,end]),start=end})}),lines},setPrefill:function(){var self=this,current=this.elements[0],correct=this.answers[current.identifier];current.prefilled=!0,_.each(correct,function(e2){self.prefilledLines.push([current,self.getById(e2)]),current=self.getById(e2),current.prefilled=!0})},getById:function(id){for(var cnt=0;cnt<this.elements.length;cnt++)if(this.elements[cnt].identifier==id)return this.elements[cnt]},clear:function(element,isEnd){this.lines=_.filter(this.lines,function(e){return isEnd?(e[0]==element&&this.callViews("removeLinkClasses",[e[0],e[1]]),e[0]!=element):(e[1]==element&&this.callViews("removeLinkClasses",[e[0],e[1]]),e[1]!=element)},this),this.notifyValueChange()},lineIsValid:function(input,output){var from=input[0],to=input[1];if(null===from||null===to)return!1;if(to.prefilled)return!1;var fi=this.elements.indexOf(from),ti=this.elements.indexOf(to);if(fi>ti){var t=fi;fi=ti,ti=t,from=input[1],to=input[0]}var fu=Math.floor(fi/(this.elements.length/this.sets));return Math.floor(ti/(this.elements.length/this.sets))-fu==1&&(output.push(from,to),!0)},addLine:function(from,to){var line=[];return!!this.lineIsValid([from,to],line)&&(this.filterLines(line[0],line[1]),this.lines.push(line),this.callViews("repaintCanvas"),this.notifyValueChange(),!0)},filterLines:function(from,to){this.lines=_.filter(this.lines,function(e){return e[0]!=from&&e[1]!=to||this.callViews("removeLinkClasses",[e[0],e[1]]),!(e[0]==from||e[1]==to)},this),this.notifyValueChange()},shuffleAll:function(){this.elements=_.chain(this.sets).range().map(function(set,index){return this.getElementsBySet(set,!0)},this).flatten().value()},shuffleRest:function(){this.elements=_.chain(this.sets).range().map(function(set,index){return this.getElementsBySet(set,index>0)},this).flatten().value()},getElementsBySet:function(set,shuffle){var ipc=this.elements.length/this.sets,elements=this.elements.slice(set*ipc,(set+1)*ipc);return shuffle&&(elements=_.shuffle(elements)),elements},getLinked:function(current,lines){lines=lines||this.lines;for(var cnt=0;cnt<lines.length;cnt++){var e=lines[cnt];if(e[0]===current)return e[1]}},getPrevLinked:function(current){for(var cnt=0;cnt<this.lines.length;cnt++){var e=this.lines[cnt];if(e[1]===current)return e[0]}},getFirst:function(element){for(;this.getPrevLinked(element);)element=this.getPrevLinked(element);return element},isCorrect:function(element){if(_.isUndefined(element))return this.isAllCorrect();element=this.getFirst(element);var self=this,correct=this.answers[element.identifier],isCorrect=!0;if(void 0===correct)return!1;var current=element;return _.each(correct,function(e2){(current=self.getLinked(current))&&current.identifier==e2||(isCorrect=!1)}),isCorrect},isAllCorrect:function(){var elements=_.filter(this.elements,function(el){return!el.prefilled});return _.every(elements,function(element){return this.isCorrect(element)},this)},isFilled:function(){return _.some(this.elements,function(element){return this.isLinked(element)},this)},areAllFilled:function(){return this.getScores().areAllFilled()},isLinked:function(element){element=this.getFirst(element);for(var c=element,number=0;c;)c=this.getLinked(c),number+=1;return number==this.sets},getScores:function(){for(var score=new a5.Score,cnt=0;cnt<this.elements.length/this.sets;cnt++)if(!this.elements[cnt].prefilled){score.incTotal();var correct=this.isCorrect(this.elements[cnt]);correct&&score.incCorrect(),this.isLinked(this.elements[cnt])&&score.incFilled()}return score},store:function(){var self=this,data=[];return _.each(this.elements,function(element){var left=self.getPrevLinked(element);left&&(left=left.identifier);var right=self.getLinked(element);right&&(right=right.identifier),(left||right)&&data.push({id:element.identifier,left:left,right:right})}),data},restore:function(data){var self=this;_.each(data,function(element){var el=self.getById(element.id);element.left&&self.addLine(el,self.getById(element.left)),element.right&&self.addLine(el,self.getById(element.right))})},setAnswer:function(){_.invoke(this.elements,"setAnswer"),this.tryAgainIsFrozen&&a5.dp.config.linkingLinesPreserveColorAfterCorrect&&_.each(this.lines,function(line){this._setLineChecked(line)},this);for(var cnt=0;cnt<this.elements.length;cnt++){!(this.elements.length-cnt<=this.elements.length/this.sets)||a5.dp.config.linkingSelectionAreaEnabled&&!this.elements[cnt].isFilled()?this.elements[cnt].callViews("setFeedbackState"):this.elements[cnt].callViews("setAnswer")}this.setState("feedback")},showAnswer:function(){_.invoke(this.elements,"showAnswer");for(var cnt=0;cnt<this.elements.length;cnt++){!(this.elements.length-cnt<=this.elements.length/this.sets)||a5.dp.config.linkingSelectionAreaEnabled&&!this.elements[cnt].isFilled()?this.elements[cnt].callViews("setFeedbackState"):(this.elements[cnt].callViews("removeAnswer"),this.elements[cnt].callViews("showAnswer"))}this.setState("answers")},getCandidatesForSolutionHint:function(){return _.filter(this.elements,function(item){return"answers"!==item.state&&-1===item.position&&!item.isFilled()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.elements,function(item){return"answers"!==item.state&&-1===item.position&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForValidation:function(){return _.filter(this.elements,function(item){return"answers"!==item.state&&-1===item.position&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();if(question){question.showNextAnswer();for(var correct=this.correctModels(),element=question;element;){var path=_.find(correct,function(model){return!_.contains(this.lines,model)&&!_.contains(this.prevAnswers,model)&&_.contains(_.pluck(model,"identifier"),element.identifier)},this);path&&(this.filterLines(path[0],path[1]),this.prevAnswers.push(path));var linked=this.getLinked(element,this.prevAnswers);linked&&linked.showNextAnswer(),element=linked}this.trigger("show_next")}return 0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();if(question){question.showSolutionHint();for(var correct=this.correctModels(),element=question;element;){var path=_.find(correct,function(model){return!_.contains(this.lines,model)&&!_.contains(this.prevAnswers,model)&&_.contains(_.pluck(model,"identifier"),element.identifier)},this);path&&(this.filterLines(path[0],path[1]),this.prevAnswers.push(path));var linked=this.getLinked(element,this.prevAnswers);linked&&linked.showSolutionHint(),element=linked}this.trigger("show_next")}return this.hasCandidatesForValidation()||(this.state="answers"),question},tryAgain:function(){_.invoke(this.elements,"tryAgain");var self=this;this.tryAgainKeep||(this.lines=_.filter(this.lines,function(line){return self.isCorrect(line[0])}));for(var cnt=0;cnt<this.elements.length;cnt++){this.elements.length-cnt<=this.elements.length/this.sets?this.elements[cnt].callViews("removeAnswer"):this.elements[cnt].callViews("setFeedbackState")}this.setState("input")},_setLineChecked:function(line){line.checked=!0}},a5.models.interaction.BaseModel.extend("a5.models.interaction.LLModel"),a5.models.interaction.LLElementModel={init:function(parameters,defaults){this._super(parameters,$.extend({content:null,position:0,identifier:null,prefilled:!1,tts_audio:!1,tryAgainIsFrozen:!1},defaults))},isCorrect:function(){return this.parent.isCorrect(this)},isFilled:function(){return this.parent.isLinked(this)},showNextAnswer:function(){this.setRevealedBySeeNext(),this.showAnswer(),this.callViews("removeAnswer"),this.callViews("showAnswer")},showSolutionHint:function(){this.setRevealedBySolutionHint(),this.showAnswer(),this.callViews("removeAnswer"),this.callViews("showAnswer")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.LLElementModel");a5.models.interaction.LinkingMultipleLines={init:function(parameters,defaults){this._super(parameters,$.extend({answers:[],tryAgainKeep:!1,tryAgainIsFrozen:!1,behaviourIsTouch:!1,displayInRows:!1},defaults)),this._prevAnswers=[],this.answers=new a5.models.interaction.LinkingMultipleLinesCollection({parent:this,children:this.answers}),this.lines=new a5.models.interaction.LinkingMultipleLinesCollection({parent:this}),this.prefilledLines=new a5.models.interaction.LinkingMultipleLinesCollection({parent:this}),this.state="input"},prefillFirstLine:function(){this.prefilledLines.append(this.answers.children[0])},prefillFirstItem:function(){var from=this.answers.children[0].from;this.answers.each(function(line){from==line.from&&this.prefilledLines.append(line)},this)},addLine:function(from,to){var line=new a5.models.interaction.LinkingMultipleLinesLine(from,to),allLines=this.prefilledLines.concat(this.lines);allLines.include(line)||allLines.countFrom(from)>=this.answers.countFrom(from)||this.lines.append(line)},getScores:function(){var score=new a5.Score;return score.total=this.answers.size()-this.prefilledLines.size(),score.filled=this.lines.size(),this.lines.each(function(line){this.answers.include(line)&&score.incCorrect()},this),score},isCorrect:function(){return _.filter(this.lines,function(line){return this.answers.include(line)},this).length==this.answers.size()},isFilled:function(){return this.lines.size()>0},areAllFilled:function(){return this.getScores().areAllFilled()},getCandidatesForSolutionHint:function(){var items=_.difference(this.answers.children,this._prevAnswers);return _.filter(items,function(item){return"answers"!==item.state&&!this.lines.include(item)&&!this.prefilledLines.include(item)},this)},getCandidatesForShowNextAnswer:function(){var items=_.difference(this.answers.children,this._prevAnswers);return _.filter(items,function(item){return"answers"!==item.state&&!this.lines.include(item)&&!this.prefilledLines.include(item)},this)},getCandidatesForValidation:function(){var items=_.difference(this.answers.children,this._prevAnswers);return _.filter(items,function(item){return"answers"!==item.state&&!this.prefilledLines.include(item)},this)},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return this.setRevealedBySeeNext(),question&&(this._prevAnswers.push(question),this.trigger("next_answer")),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return this.setRevealedBySolutionHint(),question&&(this._prevAnswers.push(question),question.revealedBySolutionHint=!0,this.trigger("next_answer")),this.hasCandidatesForValidation()||(this.state="answers"),question},clearSolutionHint:function(){this._prevAnswers=_.reject(this._prevAnswers,function(question){return question.revealedBySolutionHint},this)},store:function(){var data=[];return this.lines.each(function(line){data.push([line.from,line.to])},this),data},restore:function(data){_.each(data,function(line){this.addLine(line[0],line[1])},this)},setAnswer:function(){this.tryAgainIsFrozen&&a5.dp.config.linkingMultipleLinesPreserveColorAfterCorrect&&this.lines.setChecked(),this._super()},tryAgain:function(){this.tryAgainKeep||(this.lines.children=_.select(this.lines.children,function(line){return this.answers.include(line)},this)),this._super()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.LinkingMultipleLines"),a5.models.interaction.LinkingMultipleLinesCollection={init:function(params){params=params||{},this.parent=params.parent,this.children=[],_.each(params.children,function(line){this.add(line[0],line[1])},this)},add:function(from,to){return this.append(new a5.models.interaction.LinkingMultipleLinesLine(from,to))},append:function(line){this.children.push(line),this.parent.notifyValueChange()},size:function(){return this.children.length},countFrom:function(id){return _.select(this.children,function(line){return id==line.from}).length},setChecked:function(){this.each(function(line){line.setChecked()})},include:function(line){return!!_.find(this.children,function(child){return child.eql(line)})},remove:function(line){this.children=_.without(this.children,line),this.parent.notifyValueChange()},clear:function(fromto){this.children=_.reject(this.children,function(line){return fromto===line.from||fromto===line.to}),this.parent.notifyValueChange()},each:function(callback,context){_.each(this.children,callback,context)},concat:function(lines){var result=new a5.models.interaction.LinkingMultipleLinesCollection({parent:this.parent});return this.each(function(child){result.append(child)}),lines.each(function(child){result.append(child)}),result},union:function(lines){var result=new a5.models.interaction.LinkingMultipleLinesCollection({parent:this.parent});return this.each(function(child){result.append(child)}),lines.each(function(child){result.include(child)||result.append(child)}),result}},Obj.extend("a5.models.interaction.LinkingMultipleLinesCollection"),a5.models.interaction.LinkingMultipleLinesLine={init:function(from,to){this.from=from,this.to=to},eql:function(other){return this.from==other.from&&this.to==other.to},setChecked:function(){this.checked=!0}},Obj.extend("a5.models.interaction.LinkingMultipleLinesLine"),a5.models.interaction.ShuffleModel={init:function(parameters,defaults){this._super(parameters,$.extend({correct:[],alignment:"horizontal",tryAgainIsFrozen:!1,interaction:null},defaults)),this.elements=[],this.actionsDone=0},push:function(element){this.elements.push(element)},shuffle:function(iter){var indexes=[];_.each(this.elements,function(e,index){e.fixed||indexes.push(index)},this),this.elements=_.map(this.elements,function(e){if(e.fixed)return e;var i=Math.floor(Math.random()*indexes.length);return this.elements[indexes.splice(i,1)[0]]},this),this.isCorrect()&&(_.isUndefined(iter)&&(iter=0),iter<10&&this.shuffle(++iter))},isCorrect:function(){var correct=!0;return _.each(this.elements,function(e,index){_.include(this.correct[index],e.identifier)||(correct=!1)},this),correct},isCorrectable:function(){return _.some(this.elements,function(e){return!e.fixed})},isFilled:function(){return this.actionsDone>0},store:function(){return _.map(this.elements,function(e){return e.identifier})},restore:function(data){data&&_.each(data,function(id,i){var needle=_.find(this.elements,function(el){return el.identifier==id}),from=_.indexOf(this.elements,needle);this.moveTo(from,i)},this)},getScores:function(){var score=new a5.Score;return _.each(this.elements,function(e,i){e.fixed||(score.incTotal(),!e.isRevealed()&&_.include(this.correct[i],e.identifier)&&score.incCorrect(),this.isFilled()&&score.incFilled())},this),score},useSwap:function(){var i,fixedPositions=[];for(_.each(this.elements,function(e,i){e.fixed&&fixedPositions.push(i)}),i=0;i<this.elements.length&&fixedPositions[0]===i;i++)fixedPositions.shift();for(i=this.elements.length-1;i>=0&&fixedPositions[fixedPositions.length-1]===i;i--)fixedPositions.pop();return fixedPositions.length>0},moveTo:function(oldPos,newPos){a5.utils.array.move(this.elements,oldPos,newPos),this.registerAction()},swap:function(oldPos,newPos){a5.utils.array.swap(this.elements,oldPos,newPos),this.trigger("swapped",{from:this.elements[oldPos],to:this.elements[newPos]}),this.registerAction(!0)},getCandidatesForSolutionHint:function(){return _.filter(this.availableElements||this.elements.slice(0),function(item){return!(item.isRevealed()||item.fixed||item.isCorrect()||item.prefill||item.prefilled)})},getCandidatesForShowNextAnswer:function(){return _.filter(this.availableElements||this.elements.slice(0),function(item){return!(item.isRevealed()||item.fixed||item.isCorrect()||item.prefill||item.prefilled)})},getCandidatesForValidation:function(){return _.filter(this.availableElements||this.elements.slice(0),function(item){return"answers"!==item.state&&!item.fixed&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){this.availableElements=this.elements.slice(0);var items=this.getCandidatesForShowNextAnswer(),question=items.shift();if(question){var correct=this.getCorrectFor(question.index());a5.utils.array.swap(this.elements,question.index(),correct.index()),this.registerAction(),correct.showNextAnswer(),"feedback"===question.state&&(question.movedAfterCheckAnswer=!0,question.isCorrect()&&question.showNextAnswer())}return items.length<=1&&(!this.hasCandidatesForShowNextAnswer()||this._isOrderedCorrectly())&&(this.state="answers"),this.trigger("next_answer"),question},showSolutionHint:function(){this.availableElements=this.elements.slice(0);var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&question.showSolutionHint(),items.length<=1&&(!this.hasCandidatesForValidation()||this._isOrderedCorrectly())&&(this.state="answers"),this.trigger("next_answer"),question},insert:function(elem,to,movableElements){movableElements.splice(to,0,elem),this.elements=_.map(this.elements,function(e){var view=_.find(e.views());return e.fixed||this.tryAgainIsFrozen&&view.node.hasClass("checked-correct-locked")?e:movableElements.shift()},this),this.registerAction()},registerAction:function(isSwap){this.trigger("update-element-order",isSwap),this.actionsDone+=1,this.notifyValueChange()},setAnswer:function(){this._super(),_.invoke(this.elements,"setAnswer")},setAnswerInput:function(){this._super(),_.invoke(this.elements,"setAnswerInput")},showAnswer:function(){this._super(),this.availableElements=this.elements.slice(0),_.invoke(this.elements,"showAnswer")},tryAgain:function(){this._super(),_.invoke(this.elements,"tryAgain")},getCorrectFor:function(position){var element=_.find(this.availableElements,function(e){return!e.fixed&&!e.isCorrect()&&_.include(this.correct[position],e.identifier)},this);return this.availableElements=_.without(this.availableElements,element),element},_isOrderedCorrectly:function(){var current=_.map(this.elements,function(e){return e.getCurrentIdentifier()});return _.isEqual(current,_.flatten(this.correct))}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ShuffleModel"),a5.models.interaction.ShuffleElement={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",identifier:null,fixed:!1,alignment:"horizontal",content:null,tryAgainIsFrozen:!1},defaults))},index:function(){return _.indexOf(this.parent.elements,this)},getCorrect:function(){return this.parent.getCorrectFor(this.index())},isCorrect:function(){return _.include(this.parent.correct[this.index()],this.identifier)},isFilled:function(){return this.parent.isFilled()},wrongText:function(){return this.text},correctText:function(){return this.getCorrect().text},setCurrentIdentifier:function(identifier){this._currentIdentifier=identifier},getCurrentIdentifier:function(){return this._currentIdentifier||this.identifier},tryAgain:function(){this.movedAfterCheckAnswer=!1,this._super()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ShuffleElement"),a5.models.interaction.OSBoxDropModel={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({choices:!1,targets:!1,response:!1,current_choice:null,current_category:null,stopped:!1,current_category_index:0,category_move_timeout:2500,direction:1},defaults)),this.tryAgainIsFrozen=interaction.options.tryAgainIsFrozen(),this.interaction=interaction,this.choices=_.map(this.choices,function(choice){var $choice=$(choice);return new a5.models.interaction.OSBoxDropModelChoice({choice_id:$choice.attr("id"),identifier:$choice.attr("identifier"),correctTargetIdentifier:this.response[$choice.attr("identifier")],matchMax:$choice.attr("matchMax"),contents:this._serializeToString($choice),parent:this})},this),this.targets=_.map(this.targets,function(target,index){var $target=$(target);return new a5.models.interaction.OSBoxDropModelTarget({target_id:$target.attr("id"),identifier:$target.attr("identifier"),matchMax:$target.attr("matchMax"),contents:this._serializeToString($target),index:index,parent:this})},this),this.all_choices=_.clone(this.choices),_.each(this.all_choices,function(choice){var correct=_.find(this.targets,function(target){var match=target.identifier==choice.correctTargetIdentifier;return match&&target.correctChoices.push(choice),match});choice.correctTargetModel=correct},this),interaction.bind("show",_.bind(function(){this.setCurrentCategory(0),this.startCategoriesMovement()},this)),interaction.bind("hide",_.bind(function(){this.stopCategoriesMovement()},this))},_serializeToString:function(node){var xml=a5.utils.serializeXML(node[0]);return xml=this._wrapIntoCDATA(xml),$($.parseXML(xml)).find("simpleAssociableChoice").text()},_wrapIntoCDATA:function(xml){var ret=xml;return ret=ret.replace(/(<simpleAssociableChoice [^>]*>)/gi,"$1<![CDATA["),ret=ret.replace(/(<\/simpleAssociableChoice>)/gi,"]]>$1")},setState:function(newState){_.invoke(this.targets,"setState",newState),_.invoke(this.choices,"setState",newState),this._super(newState)},showAnswer:function(){this._super(),this.stopCategoriesMovement();var pos=a5.dp.config.boxdropAnswersPosition;_.isNumber(pos)&&this.setCurrentCategory(pos)},setAnswer:function(){this._super(),this.stopCategoriesMovement();var pos=a5.dp.config.boxdropAnswersPosition;_.isNumber(pos)&&this.setCurrentCategory(pos)},tryAgain:function(){
this.interaction.options.tryAgainIsClear()?this._clearAll():this._clearWrong(),this.startCategoriesMovement(),this._super()},setCurrentCategory:function(index){this.targets[index]&&(this.current_category=this.targets[index],this.current_category_index=index,this.trigger("change:category",index))},startCategoriesMovement:function(){this.stopped=!1,_.isUndefined(this._first_time)&&(this._first_time=!0),this._movement=setInterval(_.bind(this._movementTick,this),this.category_move_timeout)},_movementTick:function(){var category_max=this.targets.length-1,current=this.current_category_index;(current==category_max||0==current&&!this._first_time)&&(this._first_time=!1,this.direction=-this.direction),this.setCurrentCategory(this.current_category_index+this.direction)},stopCategoriesMovement:function(){this.stopped=!0,clearInterval(this._movement)},dropChoice:function(){if("input"==this.state){var choice=this.choices.shift();choice&&this.current_category.appendChoice(choice)}},getScores:function(){var score=new a5.Score;return _.each(this.all_choices,function(choice){score.incTotal(),choice.isCorrect()&&score.incCorrect(),choice.current_target&&score.incFilled()}),score},isFilled:function(){return _.some(this.targets,function(target){return target.isFilled()})},_clearAll:function(){_.invoke(this.targets,"clearAll")},_clearWrong:function(){_.invoke(this.targets,"clearWrong")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSBoxDropModel"),a5.models.interaction.OSBoxDropModelChoice={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({contents:"",choice_id:"",identifier:"",correctTargetIdentifier:"",matchMax:""},defaults)),this.tryAgainIsFrozen=this.parent.tryAgainIsFrozen,this.current_target=null},dropTo:function(target){this.current_target=target,this.trigger("dropped",target)},undrop:function(){this.current_target=null,this.trigger("undropped",this.parent)},isCorrect:function(){return!!this.current_target&&this.correctTargetIdentifier===this.current_target.getIdentifier()},isFilled:function(){return Boolean(this.current_target)}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSBoxDropModelChoice"),a5.models.interaction.OSBoxDropModelTarget={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({contents:"",target_id:!1,identifier:!1,matchMax:"",index:NaN},defaults)),this.tryAgainIsFrozen=this.parent.tryAgainIsFrozen,this.choices=[],this.correctChoices=[]},appendChoice:function(choice){this.choices.push(choice),choice.dropTo(this),this.parent.notifyValueChange()},getIdentifier:function(){return this.identifier},setState:function(newState){_.invoke(this.choices,"setState",newState),this._super(newState)},clearAll:function(){_.each(this.choices,function(choice){choice.undrop(),this.parent.choices.push(choice)},this),this.choices=[],this.parent.notifyValueChange()},clearWrong:function(){_.each(this.choices,function(choice){choice.isCorrect()||(choice.undrop(),this.parent.choices.push(choice))},this),this.choices=_.intersection(this.choices,this.correctChoices),this.parent.notifyValueChange()},isFilled:function(){return this.choices.length>0}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSBoxDropModelTarget"),a5.model.interaction.ICCrossword={init:function(parameters,defaults){this._super(parameters,$.extend({tryAgainKeep:!1,tryAgainIsFrozen:!1,cluesInColumns:!1},defaults)),this.words=[],this.cells=[],this.width=0,this.height=0},setState:function(state){_.invoke(this.cells,"setState",state),this._super(state)},store:function(){var data=[];return _.each(this.cells,function(cell){cell.value&&data.push({v:cell.value,p:cell.x+":"+cell.y})}),data},restore:function(data){_.each(data,function(obj){var coords=obj.p.split(":"),cell=this.getCellAt(coords[0],coords[1]);!1!==cell&&cell.setValue(obj.v,!0)},this),this.setState("input")},indexOf:function(element){return _.indexOf(this.words,element)},getScores:function(){var score=new a5.Score;return _.each(this.words,function(word){word.prefilled||(score.incTotal(),score.incCorrect(word.isCorrect()),score.incFilled(word.isFilled()))}),score},getMaximumScore:function(){return _.reject(this.words,"prefilled").length},isCorrect:function(){return _.every(this.words,function(word){return word.prefilled||word.isCorrect()})},isFilled:function(){return _.some(this.words,function(word){return!word.prefilled&&word.isFilled()})},areAllFilled:function(){return _.every(this.words,function(word){return word.prefilled||word.isFilled()})},getCandidatesForSolutionHint:function(){return _.filter(this.words,function(item){return item.isRevealedBySolutionHint()?item:"answers"!==item.state&&!item.isFilled()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.words,function(item){return"answers"!==item.state&&!item.prefill&&!item.prefilled&&!item.isCorrect()})},getCandidatesForValidation:function(){return _.filter(this.words,function(item){return"answers"!==item.state&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&question.showNextAnswer(),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&question.showSolutionHint(),this.hasCandidatesForValidation()||(this.state="answers"),question},tryAgain:function(){_.invoke(this.cells,"tryAgain"),this._super()},addWord:function(word){this.words.push(word)},findWord:function(id){for(var c=0;c<this.words.length;c++)if(this.words[c].word==id.toLowerCase())return this.words[c]},filterWords:function(params,sort){params=params||{},sort=sort||"id";var dummy=new a5.model.interaction.ICCrosswordWord,props=_.pick(params,function(value,key){return void 0!==dummy[key]});return sort=dummy.hasOwnProperty(sort)?sort:"id",_.chain(this.words).filter(function(word){return _.every(props,function(prop,key){return _.result(word,key)===prop})}).sortBy(sort).value()},getCellAt:function(x,y){for(var c=0;c<this.cells.length;c++)if(x==this.cells[c].x&&y==this.cells[c].y)return this.cells[c];return!1},initializeWords:function(){this.pack(),this.createCells()},createCells:function(){var tag,index=0;this.size=[0,0],_.each(this.words,function(word){for(var sx=word.x,sy=word.y,c=0;c<word.word.length;c++){var cell=this.getCellAt(sx,sy);cell||(cell=new a5.model.interaction.ICCrosswordCell({x:sx,y:sy,letter:word.word[c],tryAgainIsFrozen:this.tryAgainIsFrozen,tryAgainKeep:this.tryAgainKeep,parent:this}),cell.bind("change",this.onCellValueChange,this),this.cells.push(cell)),0===c&&(cell.label||(index++,cell.label=""+index),tag=(word.isHorizontal()?"a":"d")+index,word.label=cell.label,cell.words.push(word)),cell.tags.push(tag),word.tag=tag,cell.allWords.push(word),word.cells[c]=cell,sx+=word.isHorizontal()?1:0,sy+=word.isVertical()?1:0,this.size[0]=Math.max(this.size[0],sx),this.size[1]=Math.max(this.size[1],sy)}},this)},pack:function(){var minX=1e4,minY=1e4,maxX=0,maxY=0;_.each(this.words,function(word){minX=Math.min(minX,word.x),minY=Math.min(minY,word.y),word.isHorizontal()?(maxX=Math.max(maxX,word.x+word.word.length),maxY=Math.max(maxY,word.y+1)):(maxY=Math.max(maxY,word.y+word.word.length),maxX=Math.max(maxX,word.x+1))}),_.each(this.words,function(word){word.x-=minX,word.y-=minY}),this.width=maxX-minX,this.height=maxY-minY},onCellValueChange:function(){this.notifyValueChange()}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICCrossword"),a5.model.interaction.ICCrosswordWord={init:function(parameters,defaults){this._super(parameters,$.extend({align:"vertical",word:"word",x:0,y:0,label:!1,prefilled:!1,ignoreCase:!1,ignorePunctuation:!1,ignoreAccents:!1},defaults)),this.word=this.word.toLowerCase(),this.cells=new Array(this.word.length)},getUserWord:function(){return _.map(this.cells,function(cell){return cell.isPrefilled()?cell.letter:cell.value}).join("")},showSolutionHint:function(){this.state="answers",_.invoke(this.cells,"showSolutionHintFor",this)},showNextAnswer:function(){this.state="answers",_.invoke(this.cells,"showNextAnswerFor",this)},isPrefilled:function(){return this.prefilled},isRevealedBySolutionHint:function(){return _.all(this.cells,function(cell){return cell.isRevealedBySolutionHint()})},isFrozen:function(){return _.all(this.cells,function(cell){return cell.isFrozen()})},isEditable:function(){return!this.isPrefilled()&&!this.isFrozen()},isCorrect:function(){return a5.utils.checkUserInput(this.getUserWord(),this.word,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents)},isFilled:function(){return!_.some(this.cells,function(cell){return 0===cell.value.length&&!cell.isPrefilled()})},isVertical:function(){return"vertical"==this.align},isHorizontal:function(){return"horizontal"==this.align},wrongText:function(){return this.getUserWord()},correctText:function(){return this.word},getFirstCell:function(){return this.cells[0]},getLastCell:function(){return this.cells[this.cells.length-1]}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICCrosswordWord"),a5.model.interaction.ICCrosswordCell={init:function(parameters,defaults){this._super(parameters,$.extend({letter:"x",x:0,y:0,label:!1,words:[],allWords:[],tryAgainIsFrozen:!1,tryAgainKeep:!1,frozen:!1},defaults)),this.value="",this.tags=[]},isEditable:function(){return!this.isPrefilled()&&!this.isFrozen()},isPrefilled:function(){return _.any(this.allWords,function(w){return w.isPrefilled()})},isEmpty:function(){return!this.value&&!this.isPrefilled()},isFrozen:function(){return this.frozen},showSolutionHintFor:function(word){this.state="answers",this.setRevealedBySolutionHint(),this.trigger("next_answer",word)},showNextAnswerFor:function(word){this.state="answers",this.setRevealedBySeeNext(),this.trigger("next_answer",word)},tryAgain:function(){this.someWordCorrect()||this.tryAgainKeep||this.setValue("",!0),this._super()},isCorrect:function(){return this.letter==this.value},someWordCorrect:function(){return _.some(this.allWords,function(w){return w.isCorrect()})},updateFreeze:function(){this.frozen=this.tryAgainIsFrozen&&this.someWordCorrect()},setValue:function(val,silent){this.value=val.toLowerCase(),silent||this.callViews("updateValue",[this.value]),this.trigger("change")},focus:function(){this.callViews("focus")}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICCrosswordCell"),a5.models.interaction.ICExtendedWriting={init:function(parameters,defaults){this._super(parameters,$.extend({},defaults)),this.ckes={},this.textgaps={}},updateCKEditor:function(identifier,value){this.ckes[identifier]=value,this.notifyValueChange()},updateTextgap:function(identifier,value){this.textgaps[identifier]=value,this.notifyValueChange()},updateView:function(){this.trigger("change")},store:function(){var data={ckes:this.ckes,textareas:this.textgaps};return(!_.isEmpty(data.ckes)||!_.isEmpty(data.textareas))&&data},restore:function(data){_.each(data.ckes,function(value,name){this.updateCKEditor(name,value)},this),_.each(data.textareas,function(value,name){this.updateTextgap(name,value)},this),this.updateView()},getScores:function(){var score=new a5.Score;return score.incTotal(),this.isFilled()&&score.incFilled(),score},isFilled:function(){return _.some(this.ckes)||_.some(this.textgaps)}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICExtendedWriting"),a5.models.interaction.ISRadiobuttonModel={init:function(parameters,defaults){this._super(parameters,$.extend({alignment:"horizontal",prefilled:!1,tryAgainKeep:!1,tryAgainIsFrozen:!1,correct:null,blockItems:[],questionIndex:null,orderDependency:!1,affectedBy:null,affects:null,result:!1,display:"",blockId:null,attempts:0,tryAgainIsClear:!1},defaults)),this.bind("state_update:input",function(){},this),this.bind("change:result",function(){this.updateResultOfAffected()},this)},clearIncorrectAnswers:function(){_.each(this.choices,function(choice){choice.isCorrectAnswer()||choice.clear()},this)},tryAgain:function(){this.tryAgainKeep||this.isCorrect()||this.unselect(),this.clearRevealed(),this.setState("input")},setSelected:function(choice){this._super(choice),this.updateResult()},getAffects:function(){return this.affects||(this.orderDependency?this.affects=_.filter(this.blockItems,function(el){return el.questionIndex>this.questionIndex},this):this.affects=[]),this.affects},getAffectedBy:function(){return this.affectedBy||(this.orderDependency?this.affectedBy=_.filter(this.blockItems,function(el){return el.questionIndex<this.questionIndex},this):this.affectedBy=[]),this.affectedBy},correctText:function(){return this.correct.text},wrongText:function(){return this.selected?this.selected.text:""},isSelectionCorrect:function(){return this.selected===this.correct},isCorrect:function(){return this.result},updateResult:function(){var result=!1,prevResult=this.result;if(this.selected===this.correct){var list=this.getAffectedBy();result=_.every(list,function(el){return el.isCorrect()})}this.result=result,prevResult!==result&&this.trigger("change:result")},updateResultOfAffected:function(){_.invoke(this.getAffects(),"updateResult")},isFilled:function(){return this.selected},getScores:function(){var score=new a5.Score;return this.prefilled||(score.incTotal(),score.incCorrect(this.isCorrect()),score.incFilled(this.isFilled())),score},isDisplayShowNext:function(){return"show_next"===this.display},isDisplayShowNextHidePrev:function(){return"show_next_and_hide_previous"===this.display},isDisplayActive:function(){return"active"===this.display}},a5.models.RadioButton.extend("a5.models.interaction.ISRadiobuttonModel"),a5.models.interaction.ISRadiobuttonChoiceModel={init:function(parameters,defaults){this._super(parameters,$.extend({label:"text",content:"text",correct:!1,hasRadiobutton:!1,radiobuttonIsCustom:!1,enumeration:"",tryAgainIsFrozen:!1,interaction:null},defaults)),this.text=this.content.text(),this.content.find("img").length&&(this.text=this.content.find("img")[0].outerHTML)},isCorrectAnswer:function(){return this.parent.correct===this},clear:function(){this.unselect(),this.trigger("clear")}},a5.models.RadioButtonChoice.extend("a5.models.interaction.ISRadiobuttonChoiceModel"),a5.models.item.interaction.WordSnake={CHECK_LEFT_OFFSET:0,CHECK_TOP_OFFSET:-20,init:function(parameters,defaults){this._super(parameters,$.extend({responseIdentifier:"",interaction:null},defaults)),this.__index=0},getScores:function(){var interaction=this.interaction,score=new a5.Score,answers=interaction.words,letters=interaction.letters;if(interaction.options.prefillIsFirstitem()){var firstAnswer=_.first(answers);answers=_.rest(answers),letters=_.rest(letters,firstAnswer[0].length)}return _.each(answers,function(val){score.incTotal(),this.isAnswerSelected(val,interaction.selections)&&score.incCorrect()},this),_.each(interaction.selections,function(sel){score.incFilled()}),score.filled>score.total&&(score.filled=score.total),letters&&letters.length==_.map(interaction.selections,function(s){return s[0]}).join("").length&&(score.filled=score.total),score},wordInCollection:function(word,collection){return word&&_.some(collection,function(item){return word[0]===item[0]&&word[1]===item[1]})},isAnswerSelected:function(answer,selections){return this.wordInCollection(answer,selections)},isSelectionCorrect:function(selection,answers){return this.wordInCollection(selection,answers)},isCorrect:function(){var answers=this.interaction.words;return this.interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),_.all(answers,function(answer){return this.isAnswerSelected(answer,this.interaction.selections)},this)},isFilled:function(){return this.interaction.selections&&!_.isEmpty(this.interaction.selections)},areAllFilled:function(){return this.getScores().areAllFilled()},getCandidatesForSolutionHint:function(skipCorrect){var answers=this.interaction.words;if(this.interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),skipCorrect)for(;this.isAnswerSelected(answers[this.__index],this.interaction.selections);)this.__index++;return answers[this.__index]?[answers[this.__index]]:[]},getCandidatesForShowNextAnswer:function(skipCorrect){var answers=this.interaction.words;if(this.interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),skipCorrect)for(;this.isAnswerSelected(answers[this.__index],this.interaction.selections);)this.__index++;return answers[this.__index]?[answers[this.__index]]:[]},getCandidatesForValidation:function(){var answers=this.interaction.words;return this.interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),answers},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(!0),question=items.shift();return question&&(this.isCorrect()||(this.showOneAnswer(question,this.__index),this.__index++)),!this.isCorrect()&&this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(!0),question=items.shift();return question&&(this.isCorrect()||(this.showOneAnswer(question,this.__index),this.__index++)),!this.isCorrect()&&this.hasCandidatesForValidation()||(this.state="answers"),question},setAnswer:function(){this._super();var interaction=this.interaction;$("#IWT-"+interaction.index).find(".check").remove();var answers=interaction.words;interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),_.each(answers,function(val){if(!this.isAnswerSelected(val,interaction.selections)){var lastLetter=interaction.letters[val[1]+val[0].length-1];this._addCheck(lastLetter.attrs.x+this.CHECK_LEFT_OFFSET,lastLetter.attrs.y+this.CHECK_TOP_OFFSET,"wrong",$("#IWT-"+interaction.index),val[0])}},this),_.each(interaction.selections,function(sel){this.isSelectionCorrect(sel,answers)?this._addCheck(interaction.letters[sel[1]+sel[0].length-1].attrs.x+this.CHECK_LEFT_OFFSET,interaction.letters[sel[1]+sel[0].length-1].attrs.y+this.CHECK_TOP_OFFSET,"correct",$("#IWT-"+interaction.index)):this._addCheck(interaction.letters[sel[1]+sel[0].length-1].attrs.x+this.CHECK_LEFT_OFFSET,interaction.letters[sel[1]+sel[0].length-1].attrs.y+this.CHECK_TOP_OFFSET,"wrong",$("#IWT-"+interaction.index),sel[0])},this)},showAnswer:function(){this._super();var interaction=this.interaction;interaction.paper.forEach(function(el){"image"==el.type&&el.hide()}),$("#IWT-"+interaction.index).find(".check").remove();var answers=interaction.words;interaction.options.prefillIsFirstitem()&&(answers=_.rest(answers)),_.each(answers,this.showOneAnswer,this)},showOneAnswer:function(val,index){var interaction=this.interaction,startAnswer=val[1],endAnswer=startAnswer+val[0].length-1,lastLetter=interaction.letters[endAnswer];this.isAnswerSelected(val,interaction.selections)?this._addCheck(lastLetter.attrs.x+this.CHECK_LEFT_OFFSET,lastLetter.attrs.y+this.CHECK_TOP_OFFSET,"correct",$("#IWT-"+interaction.index)):_(interaction.letters.slice(startAnswer,endAnswer+1)).some(_.property("selected"))?this._addCheck(lastLetter.attrs.x+this.CHECK_LEFT_OFFSET,lastLetter.attrs.y+this.CHECK_TOP_OFFSET,"wrong",$("#IWT-"+interaction.index)):this._addCheck(lastLetter.attrs.x+this.CHECK_LEFT_OFFSET,lastLetter.attrs.y+this.CHECK_TOP_OFFSET,"wrong_2",$("#IWT-"+interaction.index));for(var i=0;i<val[0].length;i++)interaction.letters[startAnswer+i].attr({fill:interaction.colors[index%interaction.colors.length]}),interaction.letters[startAnswer+i].node.setAttribute("class",interaction.colorClasses[index%interaction.colors.length])},tryAgain:function(){this._super();var interaction=this.interaction;$("#IWT-"+interaction.index).find(".check").remove(),_.each(interaction.selections,function(val){_.include(_.values(interaction.answers),val[0])||(interaction.selections=_.filter(interaction.selections,function(item){return item[0]!=val[0]}))}),this.interaction.paper=void 0,this.callViews("drawSVG",[this.interaction.index,this.interaction,!1])},store:function(){return this.interaction.selections},restore:function(selections){_.isArray(selections)&&(this.interaction.selections=selections),this.interaction.paper=void 0,this.callViews("drawSVG",[this.interaction.index,this.interaction,!0])},_addCheck:function(x,y,klass,parentNode,title){var $check=$('<div class="check"></div>');$check.addClass(klass),$check.attr("title",title),$check.css("position","absolute"),$check.css("left",x),$check.css("top",y),parentNode.append($check)}},a5.models.interaction.BaseModel.extend("a5.models.item.interaction.WordSnake"),a5.models.interaction.SyllabifyWord={init:function(parameters,defaults){this._super(parameters,$.extend({correctResponse:null,tryAgainKeep:!1,tryAgainLock:!1,tryAgainIsFrozen:!1,tts_audio:!1},defaults)),this.choices=[]},store:function(){return{choices:this.getChoices()}},restore:function(data){this.setChoices(data.choices),this.setState("input")},getScores:function(){var score=new a5.Score,correct=this.getCorrectResponse(),response=this.getChoices();return _.each(correct,function(syllable){score.incTotal()}),_.each(response,function(syllable){score.total>score.filled&&score.incFilled(),_.contains(correct,syllable)&&(score.incCorrect(),correct.splice(correct.indexOf(syllable),1))}),score},setChoices:function(choice){this.choices=choice,this.notifyValueChange()},getChoices:function(){return this.choices.slice(0)},getCorrectResponse:function(){return this.correctResponse.values.slice(0)},getFeedbackAt:function(i){try{var feedback=jQuery.parseJSON(this.answerFeedback)}catch(e){}if(feedback)return feedback[i]},clear:function(){this.choices=[]},clearWrong:function(){var tmp="";this.choices=_.reduce(this.getCorrectResponse(),function(memo,syllable,i,correct){return _.contains(this.choices,syllable)?(tmp&&(memo.push(tmp),tmp=""),memo.push(syllable)):(tmp+=syllable,i===correct.length-1&&memo.length&&memo.push(tmp)),memo},[],this)},isFilled:function(){return!!this.choices.length},isCorrect:function(){return this.choices.join("$")==this.getCorrectResponse().join("$")},tryAgain:function(){this.isCorrect()||(this.tryAgainLock||this.tryAgainIsFrozen?this.clearWrong():this.tryAgainKeepall||this.clear()),this._super()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.SyllabifyWord"),a5.models.interaction.PEScorableItemContent={TIMEOUT:"TIMEOUT",TIMEOUT_DELAY:2e3,VALUE_CHANGE_EVENT:"VALUE_CHANGE_EVENT",CONTENT_RESIZE_EVENT:"CONTENT_RESIZE_EVENT",channelMessageOut:{SET_ENABLED:"SET_ENABLED",SET_DATATYPE:"SET_DATATYPE",SET_VALIDATIONTYPE:"SET_VALIDATIONTYPE",SET_USERDATA:"SET_USERDATA",CLEAR_USERDATA:"CLEAR_USERDATA",CLEAR_VALIDATION:"CLEAR_VALIDATION",BEGIN_ACTION:"BEGIN_ACTION",END_ACTION:"END_ACTION"},channelQueryOut:{GET_ALL_ITEMS:"GET_ALL_ITEMS",GET_MAXIMUM_SCORE:"GET_MAXIMUM_SCORE",HAS_SCORABLE_ITEMS:"HAS_SCORABLE_ITEMS",GET_SCORABLE_ITEMS:"GET_SCORABLE_ITEMS",GET_FILLED:"GET_FILLED",GET_CORRECT:"GET_CORRECT",GET_INCORRECT:"GET_INCORRECT",GET_ITEMS_TO_VALIDATE:"GET_ITEMS_TO_VALIDATE",GET_USERDATA:"GET_USERDATA",GET_ITEMS_BY_ENABLED:"GET_ITEMS_BY_ENABLED",GET_ITEMS_BY_DATATYPE:"GET_ITEMS_BY_DATATYPE",GET_ITEMS_BY_VALIDATIONTYPE:"GET_ITEMS_BY_VALIDATIONTYPE",VALIDATE:"VALIDATE"},channelNotificationIn:{READY:"READY",VALUE_CHANGE:"VALUE_CHANGE",CONTENT_RESIZE:"CONTENT_RESIZE"},UI:{VALIDATION_TYPE:{CORRECT_INCORRECT:"correct_incorrect",CORRECT_INCORRECT_EMPTY:"correct_incorrect_empty"},DATA_TYPE:{USER:"user",SOLUTION:"solution"}},init:function(scope){this.channel=null,this.scope=scope,this.iframe=null,this.ready=$.Deferred()},isReady:function(){return this.ready.promise()},initialize:function(iframe){this.iframe=iframe;var timeout=setTimeout(_.bind(function(){this.ready.reject(this.TIMEOUT,"initialize")},this),this.TIMEOUT_DELAY);this.channel=Channel.build({origin:"*",scope:this.scope,window:this.iframe.contentWindow,onReady:_.bind(function(channel){logger.log("PEScorableItemContent: channel ready"),channel.bind(this.channelNotificationIn.READY,_.bind(function(){clearTimeout(timeout),this.ready.resolve()},this)),channel.bind(this.channelNotificationIn.VALUE_CHANGE,_.bind(function(trans,value){this.trigger(this.VALUE_CHANGE_EVENT,value)},this)),channel.bind(this.channelNotificationIn.CONTENT_RESIZE,_.bind(function(trans,value){this.trigger(this.CONTENT_RESIZE_EVENT,value)},this))},this),error:_.bind(function(error){clearTimeout(timeout),logger.error("PEScorableItemContent: error building channel",error),this.ready.reject(error)},this)})},getAllItems:function(){return this._call(this.channelQueryOut.GET_ALL_ITEMS)},getMaximumScore:function(){return this._call(this.channelQueryOut.GET_MAXIMUM_SCORE)},hasScorableItems:function(query){return this._call(this.channelQueryOut.HAS_SCORABLE_ITEMS,query)},getScorableItems:function(query){return this._call(this.channelQueryOut.GET_SCORABLE_ITEMS,query)},getFilled:function(){return this._call(this.channelQueryOut.GET_FILLED)},getCorrect:function(){return this._call(this.channelQueryOut.GET_CORRECT)},getIncorrect:function(){return this._call(this.channelQueryOut.GET_INCORRECT)},getItemsToValidate:function(query){return this._call(this.channelQueryOut.GET_ITEMS_TO_VALIDATE,query)},getUserData:function(ids){return this._call(this.channelQueryOut.GET_USERDATA,ids)},getItemsByEnabled:function(enabled){return this._call(this.channelQueryOut.GET_ITEMS_BY_ENABLED,enabled)},getItemsByDataType:function(dataType){return this._call(this.channelQueryOut.GET_ITEMS_BY_DATATYPE,dataType)},getItemsByValidationType:function(validationType){return this._call(this.channelQueryOut.GET_ITEMS_BY_VALIDATIONTYPE,validationType)},setEnabled:function(ids,enabled){return this._call(this.channelMessageOut.SET_ENABLED,{ids:ids,enabled:enabled})},setDataType:function(ids,dataType){return this._call(this.channelMessageOut.SET_DATATYPE,{ids:ids,dataType:dataType})},setValidationType:function(ids,validationType){return this._call(this.channelMessageOut.SET_VALIDATIONTYPE,{ids:ids,validationType:validationType})},setUserData:function(data){return this._call(this.channelMessageOut.SET_USERDATA,data)},validate:function(ids){return this._call(this.channelQueryOut.VALIDATE,ids)},clearUserData:function(ids){return this._call(this.channelMessageOut.CLEAR_USERDATA,ids)},clearValidation:function(ids){return this._call(this.channelMessageOut.CLEAR_VALIDATION,ids)},beginAction:function(action){return this._call(this.channelMessageOut.BEGIN_ACTION,action)},endAction:function(action){return this._call(this.channelMessageOut.END_ACTION,action)},_message:function(method,params){this.channel.notify({method:method,params:params,error:function(error){logger.error("notification error",error)}})},_call:function(method,params){var deferred=$.Deferred(),timeout=setTimeout(function(){deferred.reject(this.TIMEOUT)},this.TIMEOUT_DELAY);return this.channel.call({method:method,params:params,success:function(value){deferred.resolve(value),clearTimeout(timeout)},error:function(error){clearTimeout(timeout);var message="PEScorableItemContent: Failed calling channel method "+method;params&&(message+=" with params "+JSON.stringify(params)),message+=" : "+error,logger.error(message),deferred.reject(method+": "+error)}}),deferred.promise()}},Obj.extend("a5.models.interaction.PEScorableItemContent"),a5.models.interaction.PEScorableItem={VALUE_CHANGE_EVENT:"VALUE_CHANGE_EVENT",CONTENT_RESIZE_EVENT:"CONTENT_RESIZE_EVENT",FILL_CHANGE_EVENT:"FILL_CHANGE_EVENT",STATE_CHANGE_EVENT:"STATE_CHANGE_EVENT",STATES:{CHECK:"feedback",INPUT:"input",ANSWERS:"answers"},init:function(interaction,options,scope,src){return this.interaction=interaction,this.scope=scope,this.content=new a5.models.interaction.PEScorableItemContent(scope),this.state=this.STATES.INPUT,this.options=options,this.solutionHintElement=!1,this.revealedElements=[],this.prefilledElement=null,this.ready=null,this.src=src,this.content.bind(this.content.VALUE_CHANGE_EVENT,this.__onValueChange,this),this.content.bind(this.content.CONTENT_RESIZE_EVENT,this.__onContentResized,this),this.interaction.bind("reset",this.__onInteractionReset,this),a5.eventBus.bind("lo:action:begin",this.__onActionBegin,this),a5.eventBus.bind("lo:action:end",this.__onActionEnd,this),this.__init()},setIframe:function(iframe){this.content.initialize(iframe)},__init:function(){var deferred=$.Deferred();return this.isReady().then(_.bind(function(){return!this.options.prefill||this.prefill()},this)).then(function(){deferred.resolve(!0)}).fail(function(error){deferred.resolve(!1),logger.error("PEScorableItem.__init: "+error)}),deferred.promise()},isReady:function(){return this.ready||this.__setReady(),this.ready},prefill:function(){var deferred=$.Deferred(),returnVal=!0;return $.when(this.isReady()).then(_.bind(function(){return this.__queryContent("getScorableItems",[{amount:1}])},this)).then(_.bind(function(scorable_items){if(scorable_items.length)return this.prefilledElement=_.first(scorable_items),$.when(this.__notifyContent("setDataType",[[this.prefilledElement],this.content.UI.DATA_TYPE.SOLUTION]),this.__notifyContent("setEnabled",[[this.prefilledElement],!1]));logger.warn("PEScorableItem.prefill: no items to prefill")},this)).fail(function(error){logger.error("PEScorableItem.prefill: "+error),returnVal=!1}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},isPrefilled:function(){return!_.isNull(this.prefilledElement)},getMaximumScore:function(){return this.__getMaximumScore()},isFilled:function(){var deferred=$.Deferred(),returnVal=!1;return $.when(this.isReady()).then(_.bind(function(){return this.__queryContent("getFilled")},this)).then(function(filled){returnVal=filled.length>0}).fail(function(error){logger.error("PEScorableItem.isFilled: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},getTotalFilled:function(){var deferred=$.Deferred(),returnVal=0;return $.when(this.isReady()).then(_.bind(function(){return this.__queryContent("getFilled")},this)).then(function(filled){returnVal=filled.length}).fail(function(error){logger.error("PEScorableItem.getTotalFilled: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},areAllFilled:function(){var deferred=$.Deferred(),returnVal=!1;return $.when(this.isReady()).then(_.bind(function(){return $.when(this.__queryContent("getFilled"),this.__getMaxFillable())},this)).then(function(filled,max){returnVal=filled.length>=max}).fail(function(error){logger.error("PEScorableItem.areAllFilled: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},meetsMinLength:function(){return!0},hasCandidatesForSolutionHint:function(){var deferred=$.Deferred(),returnVal=!1;return $.when(this.isReady()).then(_.bind(function(){return this.__queryContent("hasScorableItems",[this.__getFilters({validation:{_ne:"correct"},uiData:{dataType:this.content.UI.DATA_TYPE.USER,enabled:!0}})])},this)).then(_.bind(function(response){returnVal=response&&!this.solutionHintElement},this)).fail(function(error){logger.error("PEScorableItem.hasCandidatesForSolutionHint: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},hasCandidatesForShowNextAnswer:function(){var deferred=$.Deferred(),returnVal=!1;return $.when(this.isReady()).then(_.bind(function(){return this.__notifyContent("hasScorableItems",[this.__getFilters({validation:{_ne:"correct"},uiData:{dataType:this.content.UI.DATA_TYPE.USER,enabled:!0}})])},this)).then(function(hasScorableItems){
returnVal=hasScorableItems}).fail(function(error){logger.error("PEScorableItem.hasCandidatesForShowNextAnswer: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},hasCandidatesForValidation:function(){return this.state===this.STATES.INPUT&&this.hasCandidatesForShowNextAnswer()},clearSolutionHint:function(){var deferred=$.Deferred(),returnVal=!1;return this.solutionHintElement?$.when(this.isReady()).then(_.bind(function(){var solElId=[this.solutionHintElement];return $.when(this.__notifyContent("setEnabled",[solElId,!0]),this.__notifyContent("setDataType",[solElId,this.content.UI.DATA_TYPE.USER]),this.__notifyContent("setValidationType",[solElId,null]))},this)).then(_.bind(function(val){this.solutionHintElement=null,returnVal=val},this)).fail(function(error){logger.error("PEScorableItem.clearSolutionHint: "+error)}).always(function(){deferred.resolve(returnVal)}):deferred.resolve(!0),deferred.promise()},clearIncorrectAnswers:function(){var deferred=$.Deferred(),returnVal=!0;return $.when(this.isReady()).then(_.bind(function(){return this.__queryContent("getItemsToValidate",this.__getFilters())},this)).then(_.bind(function(itemsToValidate){return this.__notifyContent("validate",[itemsToValidate])},this)).then(_.bind(function(el){return this.__queryContent("getIncorrect")},this)).then(_.bind(function(incorrect){var incorrectNotRevealed=_.difference(incorrect,this.__getRevealedElements());return $.when(this.__notifyContent("clearUserData",[incorrectNotRevealed]),this.__notifyContent("clearValidation",[incorrectNotRevealed]),this.__notifyContent("setEnabled",[incorrectNotRevealed,!1]),this.__notifyContent("setDataType",[incorrectNotRevealed,this.content.UI.DATA_TYPE.SOLUTION]),this.__notifyContent("setValidationType",[incorrectNotRevealed,this.content.UI.VALIDATION_TYPE.CORRECT_INCORRECT_EMPTY]))},this)).fail(function(error){logger.error("PEScorableItem.clearIncorrectAnswers: "+error),returnVal=!1}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},showSolutionHint:function(){var shouldChangeState,elementsPreviousToSolutionHint,allElementsUntilSolutionHint,deferred=$.Deferred(),returnVal=!1;return this.solutionHintElement?(logger.error("PEScorableItem.showSolutionHint: solution hint has been already pressed"),deferred.reject()):$.when(this.isReady()).then(_.bind(function(){return $.when(this.__queryContent("getScorableItems",[this.__getFilters({validation:{_ne:"correct"},uiData:{dataType:this.content.UI.DATA_TYPE.USER,enabled:!0},limit:1})]),this.__getAllElements())},this)).then(_.bind(function(solutionHintCandidates,all){if(solutionHintCandidates.length){var solutionHintElement=_.first(solutionHintCandidates);elementsPreviousToSolutionHint=all.slice(0,all.indexOf(solutionHintElement)),allElementsUntilSolutionHint=elementsPreviousToSolutionHint.concat([solutionHintElement]);var elementsToValidate=_.difference(allElementsUntilSolutionHint,this.__getRevealedElements());return this.solutionHintElement=solutionHintElement,this.__notifyContent("validate",[elementsToValidate])}return!1},this)).then(_.bind(function(){return $.when(this.__queryContent("getIncorrect"),this.hasCandidatesForValidation())},this)).then(_.bind(function(incorrect,hasCandidate){if(!_.isNumber(this.solutionHintElement))return!1;var elementsToClear=_.chain(incorrect).intersection(elementsPreviousToSolutionHint).difference(this.__getRevealedElements()).value();$.when(this.__notifyContent("clearUserData",[elementsToClear]),this.__notifyContent("clearValidation",[elementsToClear]),this.__notifyContent("setEnabled",[allElementsUntilSolutionHint,!1]),this.__notifyContent("setDataType",[allElementsUntilSolutionHint,this.content.UI.DATA_TYPE.SOLUTION]),this.__notifyContent("setValidationType",[allElementsUntilSolutionHint,this.content.UI.VALIDATION_TYPE.CORRECT_INCORRECT_EMPTY])),shouldChangeState=!hasCandidate},this)).then(_.bind(function(val){shouldChangeState&&(this.state=this.STATES.ANSWERS),returnVal=val},this)).fail(function(error){logger.error("PEScorableItem.showSolutionHint: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},showNextAnswer:function(){var showNextElement,shouldChangeState,elementsPreviousToShowNext,allElementsUntilShowNext,deferred=$.Deferred(),returnVal=!1;return $.when(this.isReady()).then(_.bind(function(){return $.when(this.__queryContent("getScorableItems",[this.__getFilters({validation:{_ne:"correct"},uiData:{dataType:this.content.UI.DATA_TYPE.USER,enabled:!0},limit:1})]),this.__getAllElements())},this)).then(_.bind(function(shownextCandidates,all){if(shownextCandidates.length){showNextElement=_.first(shownextCandidates),elementsPreviousToShowNext=all.slice(0,all.indexOf(showNextElement)),allElementsUntilShowNext=elementsPreviousToShowNext.concat([showNextElement]);var elementsToValidate=_.difference(allElementsUntilShowNext,this.__getRevealedElements());return this.revealedElements.push(showNextElement),this.__notifyContent("validate",[elementsToValidate])}return!1},this)).then(_.bind(function(){return $.when(this.__queryContent("getIncorrect"),this.hasCandidatesForShowNextAnswer())},this)).then(_.bind(function(incorrect,hasCandidate){if(!_.isNumber(showNextElement))return!1;var elementsToClear=_.chain(incorrect).intersection(elementsPreviousToShowNext).difference(this.__getRevealedElements()).value();$.when(this.__notifyContent("clearUserData",[elementsToClear]),this.__notifyContent("clearValidation",[elementsToClear]),this.__notifyContent("setEnabled",[allElementsUntilShowNext,!1]),this.__notifyContent("setDataType",[allElementsUntilShowNext,this.content.UI.DATA_TYPE.SOLUTION]),this.__notifyContent("setValidationType",[allElementsUntilShowNext,this.content.UI.VALIDATION_TYPE.CORRECT_INCORRECT_EMPTY])),shouldChangeState=!hasCandidate},this)).then(_.bind(function(val){shouldChangeState&&(this.state=this.STATES.ANSWERS),returnVal=val},this)).fail(function(error){logger.error("PEScorableItem.showNextAnswer: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},showAllAnswer:function(){var showNextElements,allElements,deferred=$.Deferred(),returnVal=!1;return $.when(this.isReady()).then(_.bind(function(){return $.when(this.__queryContent("getScorableItems",[this.__getFilters({validation:{_ne:"correct"}})]),this.__getAllElements())},this)).then(_.bind(function(shownextCandidates,all){return!!shownextCandidates.length&&(showNextElements=shownextCandidates,allElements=all,this.revealedElements=this.revealedElements.concat(showNextElements),this.__notifyContent("validate",[all]))},this)).then(_.bind(function(){return this.__queryContent("getIncorrect")},this)).then(_.bind(function(incorrect){if(showNextElements.length){var elementsToClear=_.difference(incorrect,this.__getRevealedElements());return $.when(this.__notifyContent("clearUserData",[elementsToClear]),this.__notifyContent("clearValidation",[elementsToClear]),this.__notifyContent("setDataType",[allElements,this.content.UI.DATA_TYPE.SOLUTION]),this.__notifyContent("setEnabled",[allElements,!1]),this.__notifyContent("setValidationType",[allElements,this.content.UI.VALIDATION_TYPE.CORRECT_INCORRECT_EMPTY]))}return!1},this)).then(_.bind(function(val){this.state=this.STATES.ANSWERS,returnVal=val},this)).fail(function(error){logger.error("PEScorableItem.showAllAnswer: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},getScores:function(){var deferred=$.Deferred(),score=new a5.Score;return $.when(this.isReady()).then(_.bind(function(){return $.when(this.__getMaximumScore(),this.__queryContent("getCorrect"),this.__queryContent("getFilled"))},this)).then(_.bind(function(total,correct,filled){score.incTotal(total),score.incCorrect(correct.length),score.incFilled(filled.length),score.incRevealed(this.solutionHintElement?1:0)},this)).fail(function(error){logger.error("PEScorableItem.getScores: "+error)}).always(function(){deferred.resolve(score)}),deferred.promise()},setAnswer:function(){var deferred=$.Deferred(),returnVal=!1;return $.when(this.isReady()).then(_.bind(function(){return this.__queryContent("getItemsToValidate",this.__getFilters())},this)).then(_.bind(function(ids){return this.__notifyContent("validate",[ids])},this)).then(_.bind(function(){return $.when(this.__queryContent("getCorrect"),this.__queryContent("getIncorrect"),this.__queryContent("getAllItems"))},this)).then(_.bind(function(correct,incorrect,all){var elementsToChange=_.difference(correct.concat(incorrect),this.__getRevealedElements());return $.when(this.__notifyContent("setEnabled",[all,!1]),this.__notifyContent("setValidationType",[elementsToChange,this.content.UI.VALIDATION_TYPE.CORRECT_INCORRECT]))},this)).then(_.bind(function(){this.state=this.STATES.CHECK,returnVal=!0},this)).fail(function(error){logger.error("PEScorableItem.setAnswers: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},tryAgain:function(){var incorrectItems,correctItems,allItems,deferred=$.Deferred(),returnVal=!1;return $.when(this.isReady()).then(_.bind(function(){return $.when(this.__queryContent("getCorrect"),this.__queryContent("getIncorrect"),this.__getAllElements())},this)).then(_.bind(function(correct,incorrect,all){incorrectItems=incorrect,correctItems=correct,allItems=all;var itemsToDelete=[];return(this.options.tryAgain.lock||this.options.tryAgain.frozen)&&(itemsToDelete=incorrectItems),this.__queryContent("clearUserData",[itemsToDelete])},this)).then(_.bind(function(){var itemsToEnable=this.options.tryAgain.frozen?_.difference(allItems,correctItems):allItems;return $.when(this.__notifyContent("setEnabled",[itemsToEnable,!0]),this.__notifyContent("setValidationType",[allItems,null]),this.__notifyContent("setDataType",[allItems,this.content.UI.DATA_TYPE.USER]))},this)).then(_.bind(function(el){return this.__notifyContent("clearValidation",[allItems])},this)).then(_.bind(function(val){this.state=this.STATES.INPUT,this.revealedElements=[],this.solutionHintElement=null,returnVal=val},this)).fail(function(error){logger.error("PEScorableItem.setAnswers: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},showAnswer:function(){var items,allItems,deferred=$.Deferred(),returnVal=!1;return $.when(this.isReady()).then(_.bind(function(){return $.when(this.__queryContent("getItemsToValidate"),this.__queryContent("getScorableItems"),this.__getAllElements())},this)).then(_.bind(function(toValidate,scorable,all){return items=toValidate.concat(scorable),items=_.chain(items).uniq().without(this.prefilledElement).value(),allItems=all,this.content.validate(items)},this)).then(_.bind(function(){return $.when(this.__queryContent("setEnabled",[allItems,!1]),this.__queryContent("setDataType",[allItems,this.content.UI.DATA_TYPE.SOLUTION]),this.__queryContent("setValidationType",[allItems,this.content.UI.VALIDATION_TYPE.CORRECT_INCORRECT_EMPTY]))},this)).then(_.bind(function(){this.state=this.STATES.ANSWERS,returnVal=!0},this)).fail(function(error){logger.error("PEScorableItem.showAnswer: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},store:function(){var deferred=$.Deferred(),returnVal={};return $.when(this.isReady()).then(_.bind(function(){return this.__queryContent("getUserData")},this)).then(function(userData){returnVal=userData}).fail(function(error){logger.error("PEScorableItem.store: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},restore:function(stored){var deferred=$.Deferred(),returnVal=!1;return $.when(this.isReady()).then(_.bind(function(){return this.__notifyContent("setUserData",[stored])},this)).then(function(val){returnVal=val}).fail(function(error){logger.error("PEScorableItem.restore: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},__queryContent:function(method,params){try{return this.content[method].apply(this.content,params)}catch(e){logger.error(e,method,params)}},__notifyContent:function(method,params){return this.__queryContent(method,params)},__getRevealedElements:function(){return _.uniq(_.filter(this.revealedElements.concat([this.prefilledElement,this.solutionHintElement]),function(el){return!_.isNull(el)&&!_.isUndefined(el)&&!1!==el}))},__getMaximumScore:function(){var deferred=$.Deferred(),returnVal=0;return $.when(this.isReady()).then(_.bind(function(){return this.__queryContent("getMaximumScore")},this)).then(_.bind(function(val){var max=this.prefilledElement?val-1:val;returnVal=max},this)).fail(function(error){logger.error("PEScorableItem.__getMaximumScore: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},__getAllElements:function(){var deferred=$.Deferred(),returnVal=[];return $.when(this.isReady()).then(_.bind(function(){return this.__queryContent("getAllItems")},this)).then(_.bind(function(val){returnVal=_.without(val,this.prefilledElement)},this)).fail(function(error){logger.error("PEScorableItem.__getAllElements: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},__getMaxFillable:function(){var deferred=$.Deferred(),returnVal=0;return $.when(this.isReady()).then(_.bind(function(){return this.__queryContent("getMaximumScore")},this)).then(_.bind(function(val){returnVal=val-this.__getRevealedElements().length},this)).fail(function(error){logger.error("PEScorableItem.__getMaxFillable: "+error)}).always(function(){deferred.resolve(returnVal)}),deferred.promise()},__setReady:function(){this.ready=this.content.isReady()},__onValueChange:function(){this.trigger(this.VALUE_CHANGE_EVENT)},__onContentResized:function(data){this.trigger(this.CONTENT_RESIZE_EVENT,data)},__onInteractionReset:function(){a5.eventBus.unbind("lo:action:begin",this.__onActionBegin),a5.eventBus.unbind("lo:action:end",this.__onActionEnd),this.interaction.unbind("reset",this.__onInteractionReset)},__onActionBegin:function(action){this.actionInProgress||(this.actionInProgress=action,this.__notifyContent("beginAction",[action]))},__onActionEnd:function(action){action===this.actionInProgress&&(this.actionInProgress=null,this.__notifyContent("endAction",[action]))},__getFilters:function(query){query=query||{};var filters=[];this.state===this.STATES.CHECK?query.validation&&filters.push({validation:query.validation}):query.uiData&&(query.uiData.dataType&&filters.push({dataType:query.uiData.dataType}),query.uiData.enabled&&filters.push({enabled:query.uiData.enabled}));var excludeIds=this.__getRevealedElements();excludeIds.length&&filters.push({id:{_nin:excludeIds}});var q={where:{and:filters}};return query.limit&&(q._limit=query.limit),q}},Obj.extend("a5.models.interaction.PEScorableItem"),a5.models.item.interaction.Colouring={init:function(parameters,defaults){this._super(parameters,$.extend({items:{},answers:{},interaction:null,tryAgainKeep:!1,subtractIncorrect:!1,poolAlign:"",maxOpacity:1},defaults)),this.color="white",this.OPACITY_FILL=this.maxOpacity,this.OPACITY_EMPTY=0,this.opacity=this.OPACITY_FILL,this.distractorColors=[]},setImageSize:function(size){size&&size.width&&size.height&&(this.originalSize=size)},addDistractorColour:function(item){item.distractor=!0,this.distractorColors.push(item)},addItem:function(name,item){this.items[name]=item},store:function(){var data=[];return _.each(this.items,function(item,name){item.prefilled||data.push({name:name,color:item.color,opacity:item.opacity})}),data},restore:function(data){_.each(data,function(chunk){this.items[chunk.name].color=chunk.color,this.items[chunk.name].opacity=chunk.opacity},this),this.callViews("updateState")},isCorrect:function(){return _.every(this.items,function(item){return item.prefilled||item.isCorrect()})},isFilled:function(){return _.some(this.items,function(item){return!item.prefilled&&item.isFilled()})},areAllFilled:function(){return this.getScores().areAllFilled()},getCandidatesForSolutionHint:function(){return _.filter(this.items,function(item){return"answers"!==item.state&&!item.isFilled()&&!item.prefill&&!item.prefilled})},getCandidatesForShowNextAnswer:function(){return _.filter(this.items,function(item){return"answers"!==item.state&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForValidation:function(){return _.filter(this.items,function(item){return"answers"!==item.state&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&question.showNextAnswer(),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&question.showSolutionHint(),this.hasCandidatesForValidation()||(this.state="answers"),question},getScores:function(){var score=new a5.Score;return _.each(this.items,function(item){item.prefilled||(item.distractor||(score.incTotal(),item.isCorrect()&&score.incCorrect()),item.isFilled()&&(score.incFilled(),!item.isCorrect()&&this.subtractIncorrect&&score.decCorrect()))},this),score.correct<0&&(score.correct=0),score}},a5.models.interaction.BaseModel.extend("a5.models.item.interaction.Colouring",a5.models.item.interaction.Colouring),a5.models.item.interaction.ColouringInteractionGapText={init:function(parameters,defaults){this._super(parameters,$.extend({identifier:"",label:"",color:"white",opacity:0,areas:"",correctColor:"",prefilled:!1,distractor:!1},defaults)),this.prefilled?(this.color=this.correctColor,this.opacity=this.parent.OPACITY_FILL):this.opacity=this.parent.OPACITY_EMPTY},isCorrect:function(){return this.opacity==this.parent.OPACITY_FILL&&this.color==this.correctColor||this.distractor&&this.opacity!=this.parent.OPACITY_FILL},isFilled:function(){return this.opacity==this.parent.OPACITY_FILL},showNextAnswer:function(){this.state="answers",this.parent.trigger("show-next",this)},showSolutionHint:function(){this.state="answers",this.parent.trigger("show-next",this)}},a5.models.interaction.BaseModel.extend("a5.models.item.interaction.ColouringInteractionGapText"),a5.models.item.interaction.ColouringInteractionColour={init:function(parameters,defaults){this._super(parameters,$.extend({identifier:"",idAttr:"",label:"",color:"distractor",opacity:0,areas:"",distractor:!1},defaults))}},a5.models.interaction.BaseModel.extend("a5.models.item.interaction.ColouringInteractionColour"),a5.models.interaction.ISCatchGameModel={init:function(parameters,defaults){this._super(parameters,$.extend({models:[],stageConfiguration:{},targetsConfiguration:{}},defaults)),_.bindAll(this,"_bindQuestionScore","_scoreIncrease","_scoreDecrease"),_.each(this.models,this._bindQuestionScore),this._initScore()},_initScore:function(){var score=new a5.Score;_.chain(this.models).invoke("correct").each(function(totalCorrect){score.incTotal(totalCorrect.length)}),this.score=score},_bindQuestionScore:function(question){question.unbind("scoreIncrease",this._scoreIncrease),question.bind("scoreIncrease",this._scoreIncrease),question.unbind("scoreDecrease",this._scoreDecrease),question.bind("scoreDecrease",this._scoreDecrease)},_scoreIncrease:function(){this.score.incCorrect()},_scoreDecrease:function(){this.score.correct>0&&this.score.decCorrect()},tryAgain:function(){this._super(),_.invoke(this.models,"initState"),this._initScore()},allTargets:function(){return _.chain(this.models).map(function(question){return question.targets}).flatten().value()},unstagedQuestions:function(){return _.filter(this.models,function(question){return"init"===question.state})},getScores:function(){return this.score}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISCatchGameModel"),a5.models.interaction.ISCatchQuestionModel={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({targets:!1,question:"",substractIncorrect:!1},defaults)),_.bindAll(this,"getTarget","onTargetResponded"),this.targets=_.map(this.targets,this.getTarget),this.state="init"},getTarget:function(targetObj){var target=new a5.models.interaction.ISCatchTargetModel(targetObj);return target.bind("state_update:feedback",function(evt){this.onTargetResponded(target)},this),target},onTargetResponded:function(target){target.isCorrect?this.trigger("scoreIncrease"):this.substractIncorrect&&this.trigger("scoreDecrease")},initState:function(){this.state="init",_.invoke(this.targets,"initState"),this.trigger("state_update:init")},inputState:function(){this.tryAgain()},setAnswer:function(){this._super()},showAnswer:function(){this._super(),_.invoke(this.targets,"showAnswer")},tryAgain:function(){this._super(),_.invoke(this.targets,"initState")},correct:function(){return this._filteredElements({isCorrect:!0})},tobeDisplayedCorrect:function(){return this._filteredElements({isCorrect:!0,state:"init"})},tobeDisplayed:function(){return this._filteredElements({state:"init"})},displayingCorrect:function(){return this._filteredElements({state:"input",isCorrect:!0})},_filteredElements:function(params,sort){params=params||{};var dummy=new a5.models.interaction.ISCatchTargetModel,props=_.pick(params,function(value,key){return void 0!==dummy[key]}),response=_.filter(this.targets,function(target){return _.every(props,function(prop,key){return _.result(target,key)===prop})});return dummy.hasOwnProperty(sort)&&(response=_.sortBy(response,sort)),response}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISCatchQuestionModel"),a5.models.interaction.ISCatchTargetModel={init:function(parameters,defaults){this._super(parameters,$.extend({id:null,value:"",isCorrect:!1},defaults)),this.state="init"},display:function(){this.tryAgain()},acceptedStates:function(){var states=this._super();return states.push("init","expired"),states},initState:function(){this.setState("init")},expire:function(){this.setState("expired")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISCatchTargetModel"),a5.models.item.interaction.TargetGame={init:function(node){this.node=node,this.responseIdentifier=node.attr("responseIdentifier")},getScores:function(){var score=new a5.Score;return this.isCorrect?(score.incTotal(),this.dom.find(".clicked_correct").length>0&&score.incCorrect()):this.dom.find(".clicked_incorrect").length>0&&score.decCorrect(),score},setAnswer:function(){$(".tgm").show(),this.isCorrect?this.dom.find(".click").addClass("clicked_correct"):this.dom.find(".click").addClass("clicked_incorrect")}},Obj.extend("a5.models.item.interaction.TargetGame",a5.models.item.interaction.TargetGame),a5.models.interaction.ISDropdownModel={init:function(parameters,defaults){this._super(parameters,$.extend({prefill:!1,selected:null,correct:[],allowRepeat:!0,tryAgainKeep:!1,hasOrderedResponses:!1,tryAgainIsFrozen:!1,labelStyle:null,placeholder:null},defaults)),this.choices=[],this.setState("input")},add:function(choiceModel){this.choices.push(choiceModel)},store:function(){return this.selected?this.selected.key:null},restore:function(selectedKey){var selected=_.find(this.choices,function(choice){return choice.key===selectedKey});this.setSelected(selected)},setCorrect:function(correct){this.correct.push(correct)},getDependentModel:function(){return _.first(this.parent.itemList)},setSelected:function(selected){"number"==typeof selected&&(selected=this.choices[selected]),selected&&this.selected==selected||(this.selected=selected,this.trigger("update-selected"),this.notifyValueChange())},resetSelected:function(){this.setSelected(null)},isCorrect:function(){return this.hasOrderedResponses?this.isCorrectOrdered():_.indexOf(this.correct,this.selected)>-1&&(this.allowRepeat||!this.isRepeated())},isCorrectOrdered:function(){if(this.getDependentModel().selected){var correctIndex=this.getDependentModel().selected.correctIndex;return this.selected&&_.indexOf(this.correct,this.selected)>-1&&this.selected.correctIndex===correctIndex}return!1},isFilled:function(){return Boolean(this.selected)},getCorrect:function(){var correctIndex=0;return this.hasOrderedResponses&&this.getDependentModel().selected&&(correctIndex=this.getDependentModel().selected.correctIndex||0),_(this.correct).find(function(c){return c.correctIndex===correctIndex})},markRepeatedDropdowns:function(){var repeated=[];_.each(this.parent.itemList,function(dropdown){if(dropdown.repeated=!1,dropdown.selected&&_(dropdown.correct).contains(dropdown.selected)){_(repeated).filter(function(text){return text===dropdown.selected.content.text()}).length<_(dropdown.correct).filter(function(choice){return choice.content.text()===dropdown.selected.content.text()}).length?repeated.push(dropdown.selected.content.text()):dropdown.repeated=dropdown.correct.length>1}})},getAnswers:function(){return this.prefill?[]:_.map(this.correct,function(item){return _.map(item.content,function(node){return node.outerHTML||node.textContent}).join("")})},findNextCorrect:function(){if(this.isCorrect())return this.selected;var correct=this.correct.slice(0);if(correct.length>1){var dropdowns=_(this.parent.itemList).without(this);_(dropdowns).each(function(d){var choice=d.isCorrect()?d.selected:d.correctChoice,correctIndex=correct.indexOf(_(correct).find(function(c){return choice&&c.content.text()===choice.content.text()}));correctIndex>=0&&correct.splice(correctIndex,1)},this)}return this.correctChoice=_(correct).first()||_(this.correct).first(),this.correctChoice},isRepeated:function(){return this.markRepeatedDropdowns(),this.repeated},correctText:function(){return this.correct[0].content},wrongText:function(){return this.selected?this.selected.content:""},getScores:function(){var score=new a5.Score;return this.prefill||(score.incTotal(),null!=this.selected&&score.incFilled(),this.isCorrect()&&score.incCorrect(!0)),score},getMaximumScore:function(){var score=1;return this.prefill&&(score=0),score},tryAgain:function(){this.tryAgainKeep||this.isCorrect()||this.resetSelected(),this._super()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISDropdownModel"),a5.models.interaction.ISDropdownChoiceModel={init:function(parameters,defaults){this._super(parameters,$.extend({content:"text",key:null},defaults))},setCorrectIndex:function(index){this.correctIndex=index},isCorrect:function(){return this.parent.isCorrect()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISDropdownChoiceModel"),a5.model.interaction.IMMarking={init:function(parameters,defaults){this._super(parameters,$.extend({blockEnumeration:null,prefilled:!1,markingStyle:"",scoreValueIs1PerQuestion:!1,subtractIncorrect:!1,interaction:null},defaults)),this.nodes=[]},setState:function(newState){this._super(newState),this.interaction.toolbar.setEnableButtonsStatus(newState===this.STATES.INPUT),_.invoke(this.nodes,"setState",newState)},push:function(node){this.nodes.push(node)},peek:function(peek){return 0===this.nodes.length?new Obj:this.nodes[this.nodes.length-1]},getScores:function(){var score=new a5.Score;return _.each(this.nodes,function(node){"text"!==node.type&&node.getScores(score)}),this.scoreValueIs1PerQuestion&&this.subtractIncorrect&&(this.isPrefilled()||(score.totalBlocks=1,score.correctBlocks=score.total?score.correct/score.total:1),score.filled>score.total&&(score.filled=score.total),score.correct<0&&(score.correct=0),score.correctBlocks<0&&(score.correctBlocks=0)),score},isCorrect:function(){var targets=_.filter(this.nodes,function(node){return"text"!==node.type&&node.hasCorrectAnswer()});return _.every(targets,function(node){return node.isCorrect()||node.isPrefilled()})},isFilled:function(){return _.some(this.nodes,function(n){return"text"!==n.type&&n.isFilled()})},areAllFilled:function(){return this.getScores().areAllFilled()},getCandidatesForSolutionHint:function(){return _.filter(this.nodes,function(item){return"text"!==item.type&&!item.isRevealed()&&item.hasCorrectAnswer()&&!item.isPrefilled()&&!item.isFilled()})},getCandidatesForShowNextAnswer:function(){return _.filter(this.nodes,function(item){return"text"!==item.type&&!item.isRevealed()&&item.hasCorrectAnswer()&&!item.isPrefilled()&&!item.isCorrect()})},getCandidatesForValidation:function(){return _.filter(this.nodes,function(item){return"text"!==item.type&&!item.isRevealed()&&item.hasCorrectAnswer()&&!item.isPrefilled()})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},clearAnswersBefore:function(before){for(var index=this.nodes.indexOf(before),i=0;i<=index;i++){var node=this.nodes[i];node.marked&&!node.isCorrect()&&node.setMarked(!1)}},clearIncorrectAnswers:function(){_.each(this.nodes,function(node){node.marked&&!node.isCorrect()&&node.setMarked(!1)},this)},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer();this.setRevealedBySeeNext();var question=items.shift();return this.clearAnswersBefore(question),question&&question.showNextAnswer(),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state=this.STATES.ANSWERS,this.clearIncorrectAnswers(),_.defer(function(){this.interaction.items.state===this.interaction.items.STATES.ANSWERS&&this.interaction.toolbar.setEnableButtonsStatus(!1)}.bind(this))),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint();this.setRevealedBySolutionHint();var question=items.shift();return question&&question.showSolutionHint(),this.hasCandidatesForValidation()||(this.state=this.STATES.ANSWERS,_.defer(function(){this.interaction.items.state===this.interaction.items.STATES.ANSWERS&&this.interaction.toolbar.setEnableButtonsStatus(!1)}.bind(this))),question},setAnswerInput:function(){this._super(),_.invoke(this.nodes,"setAnswerInput")},showAnswer:function(){this.showAnswerNewLogic()},setAnswer:function(){this.setAnswerNewLogic()},tryAgain:function(){this.tryAgainNewLogic()},clearRevealed:function(){this._super(),_.invoke(this.nodes,"clearRevealed")},getAllItems:function(){return _.filter(this.nodes,function(item){return"text"!==item.type&&!item.isPrefilled()&&!item.isRevealed()&&item.isFilled()})},getCorrectItems:function(){return _.filter(this.nodes,function(item){return"text"!==item.type&&!item.isPrefilled()&&!item.isRevealed()&&item.isCorrect()})},getIncorrectItems:function(){return _.filter(this.nodes,function(item){return"text"!==item.type&&!item.isPrefilled()&&!item.isRevealed()&&item.isFilled()&&!item.isCorrect()})},clearUserDataFor:function(items){_.invoke(items,"clearUserData")},clearValidationFor:function(items){_.invoke(items,"clearValidation")},setEnabledFor:function(items,enabled){_.invoke(items,"setEnabled",enabled)},store:function(){return _.invoke(this.nodes,"store")},restore:function(data){_.isUndefined(data)||_.each(this.nodes,function(node,i){node.restore(data[i])})},getMarkStyleProperty:function(){return"highlight"===this.markingStyle?"background-color":"border-color"}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMMarking"),a5.model.interaction.IMMarkingElement={init:function(parameters,defaults){this._super(parameters,$.extend({correct:[],text:"",prefilled:!1,subtractIncorrect:!1,enabled:!0},defaults)),this.marked=!1,this.type="element"},setMarked:function(color){this.marked=color,this.trigger("change"),this.parent.notifyValueChange()},setPrefilled:function(){this.prefilled=!0},setEnabled:function(enabled){this.enabled=enabled,this._super(enabled)},clearUserData:function(){this.marked=!1,this._super()},isEnabled:function(){return this.enabled},isMarked:function(){return!!this.marked},getColor:function(){return this.parent.interaction.iMMarkingColors[this.marked]},getCorrectColor:function(){
return this.parent.interaction.iMMarkingColors[this.correct[0]]},isFilled:function(){return!!this.marked},isDistractor:function(){return!this.correct.length},hasCorrectAnswer:function(){return!this.isDistractor()&&!this.isPrefilled()},isCorrect:function(){return _.include(this.correct,this.marked)},getScores:function(score){score.incFilled(this.isFilled()),this.hasCorrectAnswer()&&(score.incCorrect(this.isCorrect()),score.incTotal()),this.subtractIncorrect&&this.isFilled()&&!this.isCorrect()&&score.decCorrect()},store:function(){return this.marked?{type:"element",params:{marked:this.marked}}:0},restore:function(data){data&&data.params&&(this.marked=data.params.marked,this.trigger("restore"))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMMarkingElement"),a5.model.interaction.IMMarkingText={init:function(parameters,defaults){this._super(parameters,$.extend({text:""},defaults)),this.type="text"},store:function(){return 0}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMMarkingText"),a5.model.interaction.IMProofingBlock={init:function(parameters,defaults){this._super(parameters,$.extend({blockEnumeration:null,state:"input",subtractIncorrect:!1},defaults)),this.nodes=[]},isPrefilled:function(){return _.any(this.nodes,function(node){return node.isPrefilled()})},countWrongWords:function(){return _.filter(this.nodes,function(n){return n.needsAnswer()}).length},add:function(node){this.nodes.push(node)},store:function(){var data=[];return _.each(this.nodes,function(node,index){node.isFilled()&&data.push(_.extend(node.store(),{index:index}))}),data},restore:function(data){_.each(data,function(item){_.find(this.nodes,function(node,index){return item.index===index}).restore(item)},this)},getScores:function(){var score=new a5.Score;return _.each(this.nodes,function(node){node.getScores(score)}),score},isCorrect:function(){var nodes=_.filter(this.nodes,function(n){return n instanceof a5.model.interaction.IMProofingElement});return _.every(nodes,function(n){return n.isCorrect()})},isFilled:function(){var nodes=_.filter(this.nodes,function(n){return n instanceof a5.model.interaction.IMProofingElement});return _.some(nodes,function(n){return n.isFilled()})},tryAgain:function(){_.each(this.nodes,function(node){node.tryAgain()}),this._super()},setAnswer:function(){_.each(this.nodes,function(node){node.setAnswer()}),this._super()},showAnswer:function(){_.each(this.nodes,function(node){node.showAnswer()}),this._super()}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMProofingBlock"),a5.model.interaction.IMProofingElement={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",marker:null,prefill:!1,correct:null,subtractIncorrect:!1,tryAgainKeep:!1,ignoreAccents:!1,ignorePunctuation:!1,ignoreCase:!1},defaults))},setMarker:function(marker){this.marker=marker,this.trigger("change"),this.parent.notifyValueChange()},getMarker:function(){return this.marker},getText:function(){return this.text},setText:function(text){this.text=text},getCorrect:function(){var correct;if(this.needsAnswer()){var text;this.correct.answers.length>0&&(text=this.correct.answers[0]),correct={marker:this.correct.marker,text:text}}return correct},needsAnswer:function(){return!!this.correct&&!this.isPrefilled()},isFilled:function(){return!!this.marker},isPrefilled:function(){return this.prefill},isCorrect:function(){return this.needsAnswer()&&this.isFilled()&&this.hasCorrectMarker()},hasCorrectMarker:function(){return this.marker.marker===this.correct.marker&&(!this.correct.answers.length||a5.utils.containsAnswer(this.marker.text,this.correct.answers,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents))},getScores:function(score){this.isFilled()&&score.incFilled(),this.needsAnswer()&&score.incTotal(),this.isCorrect()&&score.incCorrect(),this.subtractIncorrect&&this.isFilled()&&!this.isCorrect()&&score.decCorrect()},store:function(){return this.marker},restore:function(data){data&&(this.marker={marker:data.marker,text:data.text},this.trigger("restore"))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMProofingElement"),a5.model.interaction.IMProofingText={init:function(parameters,defaults){this._super(parameters,$.extend({text:""},defaults))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMProofingText"),a5.model.interaction.IMAutocorrectBlock={init:function(parameters,defaults){this._super(parameters,$.extend({blockEnumeration:null,state:"input",subtractIncorrect:!1},defaults)),this.nodes=[]},isPrefilled:function(){return _.any(this.nodes,function(node){return node.isPrefilled()})},countWrongWords:function(){return _.filter(this.nodes,function(n){return n.needsAnswer()}).length},add:function(node){this.nodes.push(node)},store:function(){var data=[];return _.each(this.nodes,function(node,index){node.isFilled()&&data.push(index)}),data},restore:function(data){_.each(data,function(item){_.find(this.nodes,function(node,index){return item===index}).restore()},this)},getScores:function(){var score=new a5.Score;return _.each(this.nodes,function(node){node.getScores(score)}),score},isCorrect:function(){var nodes=_.filter(this.nodes,function(n){return n instanceof a5.model.interaction.IMAutocorrectElement});return _.every(nodes,function(n){return n.isCorrect()})},isFilled:function(){var nodes=_.filter(this.nodes,function(n){return n instanceof a5.model.interaction.IMAutocorrectElement});return _.some(nodes,function(n){return n.isFilled()})},tryAgain:function(){_.each(this.nodes,function(node){node.tryAgain()}),this._super()},setAnswer:function(){_.each(this.nodes,function(node){node.setAnswer()}),this._super()},showAnswer:function(){_.each(this.nodes,function(node){node.showAnswer()}),this._super()}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMAutocorrectBlock"),a5.model.interaction.IMAutocorrectElement={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",marked:!1,prefill:!1,correct:null,subtractIncorrect:!1,tryAgainKeep:!1},defaults)),this.correctText=this.getCorrect()||""},setMarked:function(){this.marked||(this.marked=!0,this.trigger("change"),this.parent.notifyValueChange())},unsetMarked:function(){this.marked&&(this.marked=!1,this.trigger("change"),this.parent.notifyValueChange())},getCorrect:function(){if(this.needsAnswer())return this.correct[0]},needsAnswer:function(){return!_.isEmpty(this.correct)&&!this.isPrefilled()},isFilled:function(){return!!this.marked},isPrefilled:function(){return this.prefill},isCorrect:function(){return this.needsAnswer()&&this.isFilled()},getScores:function(score){this.isFilled()&&score.incFilled(),this.needsAnswer()&&score.incTotal(),this.isCorrect()&&score.incCorrect(),this.subtractIncorrect&&this.isFilled()&&!this.isCorrect()&&score.decCorrect()},store:function(){},restore:function(){this.marked=!0,this.trigger("restore")}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMAutocorrectElement"),a5.model.interaction.IMAutocorrectText={init:function(parameters,defaults){this._super(parameters,$.extend({text:""},defaults))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMAutocorrectText"),a5.models.interaction.ISCheckboxModel={init:function(parameters,defaults){this._super(parameters,$.extend({alignment:"horizontal",enumeration_internal:[],tryAgainKeep:!1,allowSelectAll:!1,attempts:0,display:""},defaults))},restore:function(data){this._super(data),this.checkMaxSelections(!0)},correctCount:function(){return _.filter(this.choices,function(choice){return choice.correct}).length},totalSelected:function(){return _.reduce(this.choices,function(i,e){return i+(!e.prefill&&"answers"!==e.state&&e.selected?1:0)},0)},totalCorrect:function(){return _.reduce(this.choices,function(i,e){return i+(!e.prefill&&"answers"!==e.state&&e.correct?1:0)},0)},addEnumeration:function(num){this.enumeration_internal.push(num)},makeOnePrefilled:function(){_.some(this.choices,function(e){if(e.correct)return e.prefill=!0,!0})},getScores:function(){var score=new a5.Score;return _.each(this.choices,function(e){e.prefill||(score.incTotal(e.correct),e.selected&&score.incFilled(),score.incCorrect(e.isCorrect()),this.allowSelectAll&&score.decCorrect(!e.correct&&e.selected))},this),score.correct<0&&(score.correct=0),score.filled>score.total&&(score.filled=score.total),score},unselect:function(){_.each(this.choices,function(choice){choice.isCorrect()||choice.unselect()})},tryAgain:function(){this.tryAgainKeep||this.unselect(),this.clearRevealed(),this.setState("input")},correctText:function(){return this.choicesText(function(choice){return choice.correct})},wrongText:function(){return this.choicesText(function(choice){return!choice.correct})},choicesText:function(iterator){return _.pluck(_.select(this.choices,iterator),"text").join(", ")},isCorrect:function(){return _.all(this.choices,function(choice){return choice.correct==choice.selected})},isFilled:function(){return _.some(this.choices,function(choice){return choice.isFilled()})},areAllFilled:function(){return this.getScores().areAllFilled()},checkMaxSelections:function(lastSelected){var maxSelected=this.totalCorrect()-this.totalSelected();lastSelected&&maxSelected<=0?this.trigger("max-selections",!0):lastSelected||1!=maxSelected||this.trigger("max-selections",!1)},isDisplayShowNext:function(){return"show_next"===this.display},isDisplayShowNextHidePrev:function(){return"show_next_and_hide_previous"===this.display},isDisplayActive:function(){return"active"===this.display},isDisplayAll:function(){return"all"===this.display},getCandidatesForSolutionHint:function(){if(!this.allowSelectAll&&this.totalSelected()>=this.totalCorrect())return[];var candidates=_.filter(this.choices,function(item){return"answers"!==item.state&&item.hasCorrectAnswer()&&!item.isFilled()&&!item.prefill&&!item.prefilled});return 0===candidates.length&&(candidates=_.filter(this.choices,function(item){return"answers"!==item.state&&item.hasCorrectAnswer()&&!item.prefill&&!item.prefilled})),candidates},getCandidatesForShowNextAnswer:function(){return _.filter(this.choices,function(item){return!item.isRevealed()&&item.hasCorrectAnswer()&&!item.isCorrect()&&!item.prefill&&!item.prefilled})},getCandidatesForValidation:function(){return _.filter(this.choices,function(item){return"answers"!==item.state&&item.hasCorrectAnswer()&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},clearIncorrectBefore:function(choice){var index=this.choices.indexOf(choice);_.each(this.choices.slice(0,index),function(ch){!ch.isFilled()||ch.isCorrect()||ch.isRevealedBySeeNext()||ch.clear()})},clearIncorrectAnswers:function(){_.each(this.choices,function(choice){!choice.isFilled()||choice.isCorrect()||choice.isRevealedBySeeNext()||choice.clear()})},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(this.clearIncorrectBefore(question),question.showNextAnswer()),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.clearIncorrectAnswers(),this.state="answers"),this.checkMaxSelections(!0),this.trigger("next_answer"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&question.showSolutionHint(),this.hasCandidatesForValidation()||(this.state="answers"),this.checkMaxSelections(!0),question}},a5.models.Checkbox.extend("a5.models.interaction.ISCheckboxModel"),a5.models.interaction.ISCheckboxChoiceModel={init:function(parameters,defaults){this._super(parameters,$.extend({label:"text",content:"text",correct:!1,hasCheckbox:!1,enumeration:"",prefill:!1,tryAgainIsFrozen:!1,interaction:null},defaults)),this.text=this.content.text(),this.content.find("img").length&&(this.text=this.content.find("img")[0].outerHTML)},isCorrect:function(){if(!this.prefill)return this.correct&&this.selected},isFilled:function(){return this.selected},hasCorrectAnswer:function(){return this.correct},select:function(){if(!this.parent.allowSelectAll&&this.parent.totalSelected()>=this.parent.totalCorrect())return void this.trigger("change");this._super(),this.parent.checkMaxSelections(!0)},unselect:function(){this._super(),this.parent.checkMaxSelections(!1)},clear:function(){this.unselect(),this.trigger("clear")}},a5.models.CheckboxChoice.extend("a5.models.interaction.ISCheckboxChoiceModel"),a5.models.interaction.ICTextGapCollection={init:function(parameters,defaults){this._super(parameters,$.extend({ignorePunctuation:!1,ignoreCase:!1,ignoreAccents:!1,ignoreSpaces:!1,hasOrderedResponsesFirstAnswer:!1},defaults)),this.itemList=this.parent.itemList,this.position=0,this.groups={}},_longestCombination:function(items){var possibleChoices=_.map(items,function(item){return item.correct}),choices=_.map(items,function(item){return item.value}),flipedChoices=_.unzip(possibleChoices);flipedChoices=_.map(flipedChoices,function(c){return _.chain(c).zip(choices).filter(function(d){return a5.utils.checkUserInput(d[1],d[0],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces)}).value()},this);var elements=_.max(flipedChoices,_.size);return{elements:elements,position:_.indexOf(flipedChoices,elements)}},_longestCombinationFirstAnswer:function(items){var firstAnswer=_.first(items),possibleChoices=_.map(items,function(item){return item.correct}),choices=_.map(items,function(item){return item.value}),flipedChoices=_.unzip(possibleChoices),firstValue=firstAnswer.value;firstValue&&(flipedChoices=_.map(flipedChoices,function(c){return a5.utils.checkUserInput(_.first(c),firstValue,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces)?c:[]},this)),flipedChoices=_.map(flipedChoices,function(c){return _.chain(c).zip(choices).filter(function(d){return a5.utils.checkUserInput(d[1],d[0],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces)}).value()},this);var elements=_.max(flipedChoices,_.size);return{elements:elements,position:_.indexOf(flipedChoices,elements)}},updateOrderDependency:function(items){this.hasOrderedResponsesFirstAnswer?this.updateOrderDependencyFirstAnswer(items):this.updateOrderDependencyLongestCombination(items)},updateOrderDependencyFirstAnswer:function(items){items=items||this.parent.itemList;var longestCombination=this._longestCombinationFirstAnswer(items);this.position=_.max([longestCombination.position,0])},updateOrderDependencyLongestCombination:function(items){items=items||this.parent.itemList;var longestCombination=this._longestCombination(items);this.position=_.max([longestCombination.position,0])},updateOrderDependencyGroups:function(){var groups=_.chain(this.parent.itemList).groupBy("group").omit(!1).value(),groupCorrectIndexes=(_.omit(groups,function(group,key){return this.updateOrderDependency(group),_.some(group,function(item){return!item._isCorrectWithOrderDependency()})},this),_.mapObject(groups,function(group){var longestCombination;return longestCombination=this.hasOrderedResponsesFirstAnswer?this._longestCombinationFirstAnswer(group):this._longestCombination(group),longestCombination.position},this)),groupCorrectIndexesPairs=_.pairs(groupCorrectIndexes);_.each(groups,function(groupItems,groupName){this.updateOrderDependency(groupItems);var groupIsCorrect=_.all(groupItems,function(item){return item._isCorrectWithOrderDependency()},this),checkUntilIndex=_.findIndex(groupCorrectIndexesPairs,function(g){return _.first(g)===groupName},this),groupIsRepeat=_.chain(groupCorrectIndexesPairs).first(checkUntilIndex+1).some(function(g){return _.first(g)!==groupName&&_.last(g)===groupCorrectIndexes[groupName]},this).value();this.groups[groupName]=groupIsCorrect&&!groupIsRepeat},this)}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapCollection"),a5.models.interaction.ICTextGap={init:function(parameters,defaults){this._super(parameters,$.extend({prefill:!1,value:"",correct:[],ignorePunctuation:!1,ignoreCase:!1,ignoreSpaces:!1,ignoreAccents:!1,allowRepeat:!0,hasOrderedResponses:!1,group:!1,blockNumber:0,enumeration:null,display_words:[],distractors:[],hintLetters:[],wordpool:{},global_enumeration:!1,length:10,tryAgainKeep:!1,area:null,spellcheck:!1,resizeGaps:!1,charactersNumber:!1,tryAgainIsFrozen:!1,inputStyle:null},defaults)),this.state="input"},isCorrect:function(){var items;return this.group&&this.hasOrderedResponses?this._isCorrectWithOrderDependencyGroups():this.group&&!this.allowRepeat?(items=_.filter(this.parent.itemList,function(item){return item.blockNumber===this.blockNumber&&item.group===this.group},this),this._isCorrectWithRepeatPrevent(items)):this.hasOrderedResponses?this._isCorrectWithOrderDependency():this.allowRepeat?this._isCorrect():(items=_.filter(this.parent.itemList,function(item){return item.blockNumber===this.blockNumber},this),this._isCorrectWithRepeatPrevent(items))},_isCorrect:function(){return a5.utils.containsAnswer(this.value,this.correct,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces)},_isCorrectWithOrderDependency:function(){return this.parent.position>=0&&a5.utils.checkUserInput(this.value,this.correct[this.parent.position],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces)},_isCorrectWithRepeatPrevent:function(items){var totalCorrectInAnswer=a5.utils.countAnswer(this.value,this.correct,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces),totalCorrect=this.correct.length,checkUntilIndex=_.indexOf(items,this),correctAnswers=_.chain(items).first(checkUntilIndex+1).filter(function(item){return item._isCorrect()&&a5.utils.containsAnswer(this.value,[item.value],this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces)},this).value();return this._isCorrect()&&(totalCorrectInAnswer===totalCorrect||correctAnswers.length<=totalCorrectInAnswer)},_isCorrectWithOrderDependencyGroups:function(){return this.parent.groups[this.group]},getCorrect:function(){var correct;return correct=this.value&&this.isCorrect()?this.value:this._findCorrect(),this._replaceSyntax(correct)},getAnswers:function(){return this.getCorrect()},_replaceSyntax:function(correct){return correct.replace("%0"," ")},_findCorrect:function(){var items;return this.group&&this.hasOrderedResponses?this._getCorrectWithOrderDependencyGroups(this.parent.itemList):this.group&&!this.allowRepeat?(items=_.filter(this.parent.itemList,function(item){return item.blockNumber===this.blockNumber&&item.group===this.group},this),this._getCorrectWithRepeatPrevent(items)):this.hasOrderedResponses?this._getCorrectWithOrderDependency():this.allowRepeat?this._getCorrect():(items=_.filter(this.parent.itemList,function(item){return item.blockNumber===this.blockNumber},this),this._getCorrectWithRepeatPrevent(items))},_getCorrect:function(index){return this.correct.length>0&&this.correct[index||0]||""},getMaskPattern:function(){var correct=this.getCorrect(),ret="*";return correct&&(ret=correct.replace(/\S/g,"*"),_.each(this.hintLetters,function(hint){ret=ret.slice(0,hint.from)+hint.str+ret.slice(hint.to+1)})),ret},_getCorrectWithOrderDependency:function(){return this._getCorrect(this.parent.position)},_getCorrectWithRepeatPrevent:function(items){var correct=this.correct.slice(0);return correct.length>1&&(items=_.without(items,this),_.each(items,function(item){var answer=item.isCorrect()?item.value:item.correctAnswer,correctIndex=a5.utils.indexOf(answer,correct,!0,item.ignorePunctuation,item.ignoreAccents,item.ignoreSpaces);correctIndex>=0&&correct.splice(correctIndex,1)},this)),this.correctAnswer=_.first(correct)||_.first(this.correct),this.correctAnswer},_getCorrectWithOrderDependencyGroups:function(items){var groups=_.groupBy(items,function(g){return g.group}),correct=this.correct.slice(0);correct.length>1&&(items=_.chain(groups).mapObject(function(group){return _.first(group)}).values().value(),_.each(items,function(item){if(item.group!==this.group){var answer=item.isCorrect()?item.value:item.correctAnswer,itemCorrectIndex=a5.utils.indexOf(answer,item.correct,!0,item.ignorePunctuation,item.ignoreAccents,item.ignoreSpaces),correctIndex=a5.utils.indexOf(this.correct[itemCorrectIndex],correct,!0,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces);correctIndex>=0&&correct.splice(correctIndex,1)}},this)),this.correctAnswer=this.correctAnswer||_.first(correct)||_.first(this.correct);var index=a5.utils.indexOf(this.correctAnswer,this.correct,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents,this.ignoreSpaces);return _.each(groups[this.group],function(item){item.correctAnswer=item._getCorrect(index)}),this.correctAnswer},correctText:function(){return this.correct.join(", ")},wrongText:function(){return this.value},setValue:function(value){value!==this.value&&(this.value=value,this.notifyValueChange())},isFilled:function(){return!_.isUndefined(this.value)&&this.value.trim().length>0},isCorrectable:function(){return!this.isDistractor()&&!this.prefill},isDistractor:function(){return _.isEmpty(this.correct)},store:function(){return this.value},restore:function(data){this.value="",_.isString(data)&&(this.value=data),this.setState("input")},getScores:function(){var score=new a5.Score;return this.isCorrectable()&&(score.incTotal(),this.isFilled()&&score.incFilled(),this.isCorrect()&&score.incCorrect()),score},tryAgain:function(){this.isCorrect()||this.tryAgainKeep||(this.value=""),this._super()},setAnswer:function(){this.hasOrderedResponses&&(this.group?this.parent.updateOrderDependencyGroups():this.parent.updateOrderDependency()),this._super()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGap"),a5.models.interaction.ICMathCollection={init:function(parameters,defaults){this._super(parameters,$.extend({showAnswerBehaviour:!1},defaults)),this.items=this.parent.itemList,this.position=0,_.bindAll(this,"getItemFromIndex")},showAnswers:function(){return this.showAnswerBehaviour&&_.every(this.itemList(),function(item){return null!==item.defaultValue})},itemList:function(){return _.chain(this.items).pluck("itemList").flatten().value()},getItemFromIndex:function(index){return this.itemList()[index]},getItemsFromBlockIndex:function(index){return this.items[index].itemList},currentBlockIndex:function(index){return this.items.length-1},checkForCrossReference:function(index,indexes){var item=this.getItemFromIndex(index);if(_.intersection(item.directlyAffectedBy,indexes).length){var refs=_.chain([indexes,index]).flatten().without(void 0,null).value();throw Error("circular dependency on between "+refs.join(", "))}return!1},updateDependency:function(){_.chain(this.itemList()).each(function(item){item.updateDirectlyAffectedBy()}).each(function(item){item.updateAffectedBy()}).each(function(item){item.affectedBy=_.unique(item.affectedBy.reverse())}).each(function(item){item.updateAffects()})}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICMathCollection"),a5.models.interaction.ICMath={CELL_REGEXPS:{ANY:/^[-]?([0-9]*(\.|,)[0-9]+|[0-9]+)$/g,INTEGER:/^[-]?[0-9]*$/g,NATURAL:/^[0-9]*$/g},init:function(parameters,defaults){this._super(parameters,$.extend({prefill:!1,value:"",formula:"",ignoreSpaces:!1,preventRepeat:!0,enumeration:null,global_enumeration:!1,defaultValue:null,numberInput:null,tryAgainKeep:!1,tryAgainIsFrozen:!1,result:!1,affectedBy:null,affects:[],referenceDependency:!1,inputStyle:null},defaults)),_.bindAll(this,"_isAffectedByMe","_dependencySorting"),this.index=this.parent.itemList().length,this.blockIndex=this.parent.currentBlockIndex(),this.state="input",this.regexp=this._correctRegExp(this.numberInput)},updateDirectlyAffectedBy:function(){for(var group,regexp=/(x)(\d+)/g,list=[];null!==(group=regexp.exec(this.formula));)list.push(parseInt(group[2],10)-1);this.preventRepeat&&(list=list.concat(_.pluck(this.previousItemsInMyBlock(),"index"))),this.directlyAffectedBy=_.unique(list)},previousItemsInMyBlock:function(){return _.filter(this.parent.getItemsFromBlockIndex(this.blockIndex),function(el){return el.index<this.index},this)},updateAffectedBy:function(origin){var affectedBy=this.directlyAffectedBy;return this.referenceDependency?this.affectedBy=_.chain(affectedBy).map(_.bind(function(index){if(!this.parent.checkForCrossReference(index,[this.item,origin])){var item=this.parent.getItemFromIndex(index);return[index].concat(item.affectedBy||item.updateAffectedBy(origin||this.index))}},this)).flatten().without(void 0,null).value():this.affectedBy=affectedBy},updateAffects:function(){this.affects=_.chain(this.parent.itemList()).filter(this._isAffectedByMe).pluck("index").value().sort(this._dependencySorting)},_isAffectedByMe:function(item){return _.contains(item.affectedBy,this.index)},_dependencySorting:function(index1,index2){var item1=this.parent.getItemFromIndex(index1),item2=this.parent.getItemFromIndex(index2),dist1=item1.affectedBy.length-item1.affectedBy.indexOf(this.index)-1,dist2=item2.affectedBy.length-item2.affectedBy.indexOf(this.index)-1;return dist1<dist2?-1:dist2<dist1?1:0},isCorrect:function(){return this.result},_correctRegExp:function(inputType){var upperCase=inputType.toUpperCase(),type=_.chain(this.CELL_REGEXPS).keys().contains(upperCase).value()?upperCase:"NATURAL";return this.CELL_REGEXPS[type]},getCorrect:function(){return this.isCorrect()?this.value:this.defaultValue||""},setValue:function(value){this.value!==value&&(this.value=value,this.updateResult(),this.updateResultOfAffected(),this.notifyValueChange())},updateResult:function(){var result=!1;if(this.value){var rightFormat=0!==_.compact(this.value.match(this.regexp)).length,repeated=this.preventRepeat&&this.isRepeated();if(rightFormat&&!repeated){var expression=this.formula.replace(/x(?!\d+)/g,"x"+(this.index+1)),itemsToReplace=_.uniq(expression.match(/x\d+/g))||[];_.each(itemsToReplace,_.bind(function(variab){var varIndex=parseInt(variab.replace("x",""),10),item=this.parent.getItemFromIndex(varIndex-1),value=item.value?item.getValue().replace(",","."):NaN.toString();(value&&item===this||!this.referenceDependency||item.result)&&(expression=expression.replace(new RegExp("x"+varIndex+"(?!\\d)","g"),value))},this)),-1===expression.indexOf("x")&&(result=this.runMathExpression(expression))}}this.result=result},runMathExpression:function(expression){try{return a5.utils.MathParser.memoParse(expression.trim())}catch(e){logger.warn("Syntax error in expression: ",expression)}},isRepeated:function(){return _.chain(this.previousItemsInMyBlock()).pluck("value").compact().contains(this.value).value()},updateResultOfAffected:function(){_.chain(this.affects).map(this.parent.getItemFromIndex).invoke("updateResult")},getValue:function(){return this.ignoreSpaces?a5.utils.removeSpaces(this.value):this.value},isFilled:function(){return!_.isUndefined(this.value)&&this.value.trim().length>0},store:function(){return this.value},getScores:function(){var score=new a5.Score;return this.prefill||(score.incTotal(),this.isFilled()&&score.incFilled(),this.isCorrect()&&score.incCorrect()),score},tryAgain:function(){this.isCorrect()||this.tryAgainKeep||(this.value=""),this._super()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICMath"),a5.models.interaction.ICMathQuizz={init:function(parameters,defaults){this._super(parameters,$.extend({xml:"",questionObject:{},questionInstance:{},answerObject:{}},defaults)),this.wirisBuilder=com.wiris.quizzes.api.QuizzesBuilder.getInstance(),this.questionObject=this.wirisBuilder.readQuestion(this.xml),this.questionInstance=this.wirisBuilder.newQuestionInstance(this.questionObject)},setValue:function(value){this.value=value,this.notifyValueChange()},isCorrectable:function(){return!_.isEmpty(this.questionObject)},isFilled:function(){if(!_.isEmpty(this.value))try{var xml=$($.parseXML(this.value)).text();return!(_.isEmpty(xml)||"[]"===xml)}catch(e){return!0}return!1},isCorrect:function(){return this.isFilled()&&this._isCorrect(this.value,this.getCorrect())},_isCorrect:_.memoize(function(studentAnswer,correctAnswer){var request=this.wirisBuilder.newEvalRequest(correctAnswer,studentAnswer,this.questionObject,this.questionInstance),service=this.wirisBuilder.getQuizzesService(),response=service.execute(request);return this.questionInstance.update(response),1===this.questionInstance.getAnswerGrade(0,0,this.questionObject)},function(studentAnswer,correctAnswer){return JSON.stringify([studentAnswer,correctAnswer])}),getScores:function(){var score=new a5.Score;return this.isCorrectable()&&(score.incTotal(),this.isFilled()&&score.incFilled(),this.isCorrect()&&score.incCorrect()),score},getCorrect:function(){return this.questionObject.getCorrectAnswer(0)},store:function(){return this.value},restore:function(data){_.isString(data)&&this.setValue(data),this.setState("input")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICMathQuizz"),a5.models.interaction.ICTextGapInvisible={init:function(parameters,defaults){this._super(parameters,$.extend({},defaults)),this.state="input",this.nodes=[]},push:function(node){this.nodes.push(node)},peek:function(peek){return 0==this.nodes.length?new Obj:this.nodes[this.nodes.length-1]},setState:function(state){this.state=state,_.each(this.nodes,function(node){node.callViews("updateState")})},getScores:function(){var score=new a5.Score;return _.each(this.nodes,function(node){node.getScores(score)}),score},setAnswer:function(){this.setState("feedback")},showAnswer:function(){this.setState("answers")},tryAgain:function(){_.each(this.nodes,function(node){node.isInput()&&!node.isCorrect()&&node.setValue("")}),this.setState("input")},store:function(){var items=[];return _.each(this.nodes,function(node,i){node._instance_of("a5.models.interaction.ICTextGapInvisibleGap")&&""!=node.value&&(items[i]=node.value)}),items},restore:function(data){_.each(this.nodes,function(node,i){node._instance_of("a5.models.interaction.ICTextGapInvisibleGap")&&data[i]&&node.setValue(data[i])})}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapInvisible"),a5.models.interaction.ICTextGapInvisibleText={init:function(parameters,defaults){this._super(parameters,$.extend({word:"word"},defaults))},getScores:function(){},isInput:function(){return!1}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapInvisibleText"),a5.models.interaction.ICTextGapInvisibleGap={init:function(parameters,defaults){this._super(parameters,$.extend({value:"",answers:[]},defaults))},isInput:function(){return!0},setValue:function(value){this.value=value,this.callViews("updateValue"),this.parent.notifyValueChange()},isCorrect:function(){return a5.utils.containsAnswer(this.value,this.answers)},isFilled:function(){return this.value.length>0},hasAnswer:function(){return this.answers.length>0},getScores:function(score){this.prefill||(this.hasAnswer()&&(score.incTotal(),this.isCorrect()&&score.incCorrect()),this.isFilled()&&score.incFilled())}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextGapInvisibleGap"),a5.models.interaction.ICTextCorrectionLine={init:function(parameters,defaults){this._super(parameters,$.extend({answers:[],blockEnumeration:null,prefilled:!1,signalErrorsEnabled:!1,signalErrorsAlways:!1,ignoreCase:!1,ignorePunctuation:!1,ignoreAccents:!1,subtractIncorrect:!1,userSelection:!1,checkboxUserAction:!1,inputUserAction:!1,enabled:!0},defaults)),this.nodes=[],this.checked=!1,this.value="",this.gotSignaled=!1,this.userSelection&&"off"!==this.userSelection||(this.userSelection="select_for_error")},signalErrors:function(validate){validate&&(this.isCheckCorrect()||(this.gotSignaled=!0)),this.signalErrorsEnabled=!0,_.each(this.nodes,function(node){node.callViews("updateState")}),this.callViews("updateState")},hideSignalErrors:function(validate){validate&&(this.isCheckCorrect()||(this.gotSignaled=!1)),
this.signalErrorsEnabled=!1,_.each(this.nodes,function(node){node.callViews("updateState")}),this.callViews("updateState")},push:function(node){this.nodes.push(node)},peek:function(peek){return 0===this.nodes.length?new Obj:this.nodes[this.nodes.length-1]},setChecked:function(checked){this.checked=checked,this.checkboxUserAction=!0,this.notifyValueChange()},setValue:function(value){this.value=value,this.notifyValueChange()},setState:function(state){this._super(state),_.each(this.nodes,function(node){node.setState(state)})},isCheckCorrect:function(){return!("select_for_error"!==this.userSelection||!this.checked||!this.hasAnswer())||("select_for_error"===this.userSelection&&!this.checked&&!this.hasAnswer()||(!("select_for_correct"!==this.userSelection||!this.checked||this.hasAnswer())||(!("select_for_correct"!==this.userSelection||this.checked||!this.hasAnswer())||void 0)))},isCorrect:function(){var containsAnswer=a5.utils.containsAnswer(this.value,this.answers,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents);return!!("select_for_error"===this.userSelection&&this.checked&&this.hasAnswer()&&containsAnswer)||("select_for_error"===this.userSelection&&!this.checked&&!this.hasAnswer()&&0===this.value.length||(!("select_for_correct"!==this.userSelection||!this.checked||this.hasAnswer()||0!==this.value.length)||(!("select_for_correct"!==this.userSelection||this.checked||!this.hasAnswer()||!containsAnswer)||void 0)))},isFilled:function(){return this.checked&&this.value.length>0},hasAnswer:function(){return this.answers.length>0&&!this.isPrefilled()},getScores:function(){var score=new a5.Score;return"select_for_error"===this.userSelection&&this.hasAnswer()&&(this.signalErrorsAlways?(score.incTotal(),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect()):(score.incTotal(2),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect(),this.isCheckCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect())),"select_for_correct"===this.userSelection&&(score.incTotal(),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect(),this.value.length&&!this.isPrefilled()&&score.incFilled(),!this.hasAnswer()&&this.signalErrorsAlways&&score.decTotal(),!this.hasAnswer()&&this.signalErrorsAlways&&score.decCorrect()),this.isFilled()&&score.incFilled(),this.checked&&!this.signalErrorsAlways&&score.incFilled(),this.isPrefilled()&&score.decTotal(),score},showAnswer:function(){this.showAnswerNewLogic()},setAnswer:function(){this.setAnswerNewLogic()},tryAgain:function(){this.tryAgainNewLogic()},showNextAnswer:function(){this.showAnswer(),this.trigger("next-answer")},store:function(){return{value:this.value,checked:this.checked,checkboxUserAction:this.checkboxUserAction,inputUserAction:this.inputUserAction}},restore:function(data){this.value=data.value,this.checked=data.checked,this.checkboxUserAction=data.checkboxUserAction,this.inputUserAction=data.inputUserAction},getAllItems:function(){return this.isPrefilled()?[]:[this]},getCorrectItems:function(){if(!this.isPrefilled()){var containsAnswer=a5.utils.containsAnswer(this.value,this.answers,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents);if("select_for_error"===this.userSelection&&this.checked&&this.hasAnswer()&&containsAnswer)return[this];if("select_for_correct"===this.userSelection&&this.checked&&!this.hasAnswer()&&0===this.value.length)return[this]}return[]},getIncorrectItems:function(){return this.isPrefilled()||this.isCorrect()?[]:[this]},isEnabled:function(){return this.enabled},setEnabled:function(enabled){this.enabled=enabled,this._super(enabled)},clearUserData:function(){this.value="",this.checked=!1,this.checkboxUserAction=!1,this.inputUserAction=!1,this._super()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextCorrectionLine"),a5.models.interaction.ICTextCorrectionLineText={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",highlighted:!1,wrong:!1,subtractIncorrect:!1},defaults))},isMarked:function(){return this.highlighted},unmark:function(){this.highlighted=!1,this.trigger("change")},mark:function(){this.highlighted=!0,this.trigger("change")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextCorrectionLineText"),a5.models.interaction.ICTextCorrectionSentence={init:function(parameters,defaults){this._super(parameters,$.extend({},defaults))},hasAnswer:function(){return _.any(this.nodes,function(n){return n.hasAnswer()&&!this.prefilled})},isFilled:function(){return this.value!==this.getInitialValue()},setInitialValue:function(){this.value=this.getInitialValue()},getInitialValue:function(){return _.chain(this.nodes).map(function(n){return n.text.trim()}).filter().value().join(" ")},getPermutations:function(start,position){start=start||"",position=position||0;var self=this;if(position<this.nodes.length){var node=this.nodes[position],ret=[];return node.hasAnswer()?_.each(node.answers,function(e){ret=_.union(ret,self.getPermutations(start+e,position+1))}):ret=this.getPermutations(start+node.text,position+1),ret}return[start.replace(/\s+/g," ").trim()]},getScores:function(){var score=new a5.Score;return"select_for_error"==this.userSelection&&this.hasAnswer()&&(this.signalErrorsAlways?(score.incTotal(),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect()):(score.incTotal(2),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect(),this.isCheckCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect())),"select_for_correct"==this.userSelection&&(score.incTotal(),this.isCorrect()?score.incCorrect():this.subtractIncorrect&&score.decCorrect(),!this.hasAnswer()&&this.signalErrorsAlways&&score.decTotal(),!this.hasAnswer()&&this.signalErrorsAlways&&score.decCorrect()),this.isFilled()&&score.incFilled(),this.checked&&!this.signalErrorsAlways&&score.incFilled(),this.prefilled&&score.decTotal(),score},getMaxTextRows:function(){return _.max(this.getPermutations().concat(this.getInitialValue()).map(function(text){return text.trim().split("\n").length}))},tryAgain:function(){this.tryAgainKeep||this.isCorrect()||this.setInitialValue(),this.tryAgainKeep||this.isCheckCorrect()||this.setChecked(!1),this.setState("input")},isCorrect:function(){var permutations=this.getPermutations("",0),isCorrectSentence=a5.utils.containsAnswer(this.value,permutations,this.ignoreCase,this.ignorePunctuation,this.ignoreAccents);return this.isCheckCorrect()&&(isCorrectSentence||!this.hasAnswer()&&!this.isFilled())}},a5.models.interaction.ICTextCorrectionLine.extend("a5.models.interaction.ICTextCorrectionSentence"),a5.models.interaction.ICTextCorrectionSentenceText={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",answers:[]},defaults))},hasAnswer:function(){return this.answers.length>0},setState:function(state){this._super(state),this.callViews("updateState")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ICTextCorrectionSentenceText"),a5.model.interaction.ICTextCorrectionReplace={init:function(parameters,defaults){this._super(parameters,$.extend({blockEnumeration:null,signalErrorsEnabled:!1,signalErrorsAlways:!1,ignoreCase:!1,ignorePunctuation:!1,ignoreAccents:!1,subtractIncorrect:!1,sharedObject:{},userSelection:!1,checkboxChanged:!1,checkboxEnabled:!0,prefilled:!1},defaults)),this.nodes=[],this.checked=!1},isPrefilled:function(){return _.any(this.nodes,function(node){return node.isPrefilled()})},countWrongWords:function(){return _.filter(this.nodes,function(n){return n.needsAnswer()}).length},signalErrors:function(validate){validate&&_.each(this.nodes,function(node){node.answers&&node.needsAnswer()&&!node.isFilled()&&(node.markedBySignal=!0)}),this.signalErrorsEnabled=!0,_.each(this.nodes,function(node){node.callViews("updateState")}),this.callViews("updateState")},hideSignalErrors:function(validate){validate&&_.each(this.nodes,function(node){node.answers&&node.needsAnswer()&&!node.isFilled()&&(node.markedBySignal=!1)}),this.signalErrorsEnabled=!1,_.each(this.nodes,function(node){node.callViews("updateState")}),this.callViews("updateState")},push:function(node){this.nodes.push(node),this.prefilled=this.prefilled||node.prefill},peek:function(peek){return 0===this.nodes.length?new Obj:this.nodes[this.nodes.length-1]},store:function(){var data=[];return _.each(this.nodes,function(node,index){node instanceof a5.model.interaction.ICTextCorrectionReplaceText&&node.isFilled()&&data.push({text:node.text,value:node.value,index:index})}),data},restore:function(data){_.each(data,function(data_item){_.find(this.nodes,function(node,index){return node.text==data_item.text&&data_item.index===index}).setValue(data_item.value)},this),this.setState(this.STATES.INPUT)},setChecked:function(checked){this.checked=checked,this.checkboxChanged=!0,this.notifyValueChange()},setState:function(state){this._super(state),_.each(this.nodes,function(node){node.setState(state)})},hasAnswer:function(){return!_.all(this.nodes,function(node){return _.isUndefined(node.answers)||_.isEmpty(node.answers)})},isCheckCorrect:function(){return!("select_for_error"!==this.userSelection||!this.checked||!this.hasAnswer())||("select_for_error"===this.userSelection&&!this.checked&&!this.hasAnswer()||(!("select_for_correct"!==this.userSelection||!this.checked||this.hasAnswer())||(!("select_for_correct"!==this.userSelection||this.checked||!this.hasAnswer())||void 0)))},getScores:function(){var score=new a5.Score;return _.each(this.nodes,function(node){node.prefill||(node instanceof a5.model.interaction.ICTextCorrectionReplaceText&&score.incFilled(node.isFilled()),node.answers&&(score.incTotal(node.needsAnswer()),"select_for_error"===this.userSelection?score.incCorrect(node.isCorrect()&&node.needsAnswer()):"select_for_correct"===this.userSelection?score.incCorrect(node.isCorrect()&&node.needsAnswer()):(score.incTotal(node.needsAnswer()&&!this.signalErrorsAlways),score.incCorrect(node.isCorrect()),score.incCorrect(node.isFilled()&&node.needsAnswer()&&!(node.markedBySignal||this.signalErrorsAlways))),score.decCorrect(this.subtractIncorrect&&node.isFilled()&&!node.isCorrect())))},this),this.isPrefilled()||this.signalErrorsAlways||this.signalErrorsEnabled||("select_for_correct"===this.userSelection&&(this.hasAnswer()||(score.incTotal(),this.checkboxChanged&&score.incFilled()),this.isCheckCorrect()&&!this.hasAnswer()&&score.incCorrect(),this.isCheckCorrect()||this.hasAnswer()||!this.subtractIncorrect||score.decCorrect()),"select_for_error"===this.userSelection&&(this.hasAnswer()&&score.incTotal(),this.checkboxChanged&&score.incFilled(),this.isCheckCorrect()&&this.hasAnswer()&&score.incCorrect(),!this.isCheckCorrect()&&this.hasAnswer()&&this.subtractIncorrect&&score.decCorrect())),this.hasShownSolutionHint()&&score.incRevealed(),"select_for_error"===this.userSelection||"select_for_correct"===this.userSelection||this.signalErrorsAlways||this.signalErrorsEnabled||(score.filled=2*score.filled,score.revealed=2*score.revealed),score.correct<0&&(score.correct=0),score},isCorrect:function(){var nodes=_.filter(this.nodes,function(n){return n instanceof a5.model.interaction.ICTextCorrectionReplaceText}),answerable=_.filter(nodes,function(n){return n.needsAnswer()}),correct_answer=_.every(answerable,function(n){return n.isCorrect()})||!this.hasAnswer();return"select_for_correct"===this.userSelection||"select_for_error"===this.userSelection?correct_answer&&this.isCheckCorrect():correct_answer},isFilled:function(){var isFilled=_.some(this.nodes,function(node){return node.isFilled()});return this.isPrefilled()||this.signalErrorsAlways||this.signalErrorsEnabled||("select_for_correct"===this.userSelection&&(this.hasAnswer()||(isFilled=isFilled||this.checkboxChanged)),"select_for_error"===this.userSelection&&(isFilled=isFilled||this.checkboxChanged)),isFilled},areAllFilled:function(){return this.getScores().areAllFilled()},getCandidatesForSolutionHint:function(){return _.filter(this.nodes,function(item){return!item.isRevealed()&&item.needsAnswer()&&!item.isFilled()&&!item.isPrefilled()})},getCandidatesForShowNextAnswer:function(){return _.filter(this.nodes,function(item){return!item.isRevealed()&&item.needsAnswer()&&!item.isCorrect()&&!item.isPrefilled()})},getCandidatesForValidation:function(){return _.filter(this.nodes,function(item){return!item.isRevealed()&&item.needsAnswer()&&!item.isPrefilled()})},hasCandidatesForSolutionHint:function(){return!(_.isEmpty(this.getCandidatesForSolutionHint())&&(this.isFilled()||this.prefilled||this.signalErrorsAlways||this.signalErrorsEnabled||"select_for_correct"!==this.userSelection&&"select_for_error"!==this.userSelection))},hasCandidatesForShowNextAnswer:function(){return!(_.isEmpty(this.getCandidatesForShowNextAnswer())&&(this.prefilled||this.isCheckCorrect()||this.signalErrorsAlways||this.signalErrorsEnabled||"select_for_correct"!==this.userSelection&&"select_for_error"!==this.userSelection))},hasCandidatesForValidation:function(){return!(_.isEmpty(this.getCandidatesForValidation())&&(this.prefilled||this.signalErrorsAlways||this.signalErrorsEnabled||"select_for_correct"!==this.userSelection&&"select_for_error"!==this.userSelection))},clearIncorrectAnswersBefore:function(question){var nodes=this.nodes.slice(0,this.nodes.indexOf(question));_.each(nodes,function(node){node instanceof a5.model.interaction.ICTextCorrectionReplaceText&&!node.isCorrect()&&!node.isRevealedBySeeNext()&&node.clear()})},clearIncorrectAnswers:function(){_.each(this.nodes,function(node){node instanceof a5.model.interaction.ICTextCorrectionReplaceText&&!node.isCorrect()&&!node.isRevealedBySeeNext()&&node.clear()})},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();if(this.setRevealedBySeeNext(),this.clearIncorrectAnswersBefore(question),question)question.showNextAnswer();else if(this.hasCandidatesForShowNextAnswer())return this.showAnswer(),void this.trigger("next-answer");this.hasCandidatesForShowNextAnswer()||(this.state=this.STATES.ANSWERS,this.trigger("next-answer"))},hasShownSolutionHint:function(){return this.__showingSolutionHint},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();this.setRevealedBySolutionHint(),question?(question.showSolutionHint(),this.__showingSolutionHint=!0):this.hasCandidatesForSolutionHint()&&(this.showAnswer(),this.trigger("next-answer"),this.__showingSolutionHint=!0),this.hasCandidatesForValidation()||(this.state=this.STATES.ANSWERS,this.trigger("next-answer"))},clearRevealed:function(){this._super(),_.invoke(this.nodes,"clearRevealed")},showAnswer:function(){this.showAnswerNewLogic()},setAnswer:function(){this.setAnswerNewLogic()},tryAgain:function(){this.tryAgainNewLogic()},getAllItems:function(){var items=_.filter(this.nodes,function(item){return item instanceof a5.model.interaction.ICTextCorrectionReplaceText&&!item.isPrefilled()});return("select_for_correct"===this.userSelection||"select_for_error"===this.userSelection&&this.checked)&&items.push(this),items},getCorrectItems:function(){var items=_.filter(this.nodes,function(item){return item instanceof a5.model.interaction.ICTextCorrectionReplaceText&&!item.isPrefilled()&&!item.isRevealed()&&item.isCorrect()});return"select_for_error"===this.userSelection&&this.checked&&this.hasAnswer()?items.push(this):"select_for_correct"===this.userSelection&&this.checked&&!this.hasAnswer()&&items.push(this),items},getIncorrectItems:function(){var items=_.filter(this.nodes,function(item){return item instanceof a5.model.interaction.ICTextCorrectionReplaceText&&!item.isPrefilled()&&!item.isRevealed()&&item.isFilled()&&!item.isCorrect()});return"select_for_error"===this.userSelection&&this.checked&&!this.hasAnswer()?items.push(this):"select_for_correct"===this.userSelection&&this.checked&&this.hasAnswer()&&items.push(this),items},clearUserDataFor:function(items){_.invoke(items,"clearUserData")},clearValidationFor:function(items){_.invoke(items,"clearValidation")},setEnabledFor:function(items,enabled){_.invoke(items,"setEnabled",enabled)},isCheckboxEnabled:function(){return this.checkboxEnabled},setCheckboxEnabled:function(enabled){this.checkboxEnabled=enabled},setEnabled:function(enabled){this.setCheckboxEnabled(enabled),this._super(enabled)},clearUserData:function(){this.checked=!1,this._super()}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICTextCorrectionReplace"),a5.model.interaction.ICTextCorrectionReplaceText={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",prefill:!1,answers:[],markedBySignal:!1,subtractIncorrect:!1,enabled:!0},defaults)),this.value=this.text},setValue:function(value){this.value=value,this.callViews("updateValue"),this.parent.notifyValueChange()},needsAnswer:function(){return this.answers.length>0},isFilled:function(){return this.value.trim()!==this.text.trim()},isCorrect:function(){return a5.utils.containsAnswer(this.value,this.answers,this.parent.ignoreCase,this.parent.ignorePunctuation,this.parent.ignoreAccents)},isMarkedCorrect:function(){return this.isFilled()&&this.needsAnswer()},clear:function(){this.value=this.text,this.callViews("updateState"),this.parent.notifyValueChange()},clearUserData:function(){this.value=this.text,this._super()},isEnabled:function(){return this.enabled},setEnabled:function(enabled){this.enabled=enabled,this._super(enabled)},showAnswer:function(){this.showAnswerNewLogic()}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICTextCorrectionReplaceText"),a5.model.interaction.ICTextCorrectionReplacePlain={init:function(parameters,defaults){this._super(parameters,$.extend({text:""},defaults))},needsAnswer:function(){return!1},isFilled:function(){return!1}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ICTextCorrectionReplacePlain"),a5.model.interaction.ISPelmanismBoard={init:function(parameters){this._super(parameters,{cards:[],found:[],current:[],cardFormat:"portrait",cardLayout:"default",cardBack:"default",hasPrefill:!1,scorable:!1,autoAudioPlayback:!1,beforeFlipAudioPlayback:!1,tryAgainIsFrozen:!1})},shuffle:function(){this.cards=_(this.cards).shuffle()},addCard:function(parameters){var card=new a5.model.interaction.ISPelmanismCard({content:parameters.html,identifier:parameters.identifier,pair:parameters.pair,back:parameters.back,setNum:parameters.setNum,board:this,autoAudioPlayback:this.autoAudioPlayback,beforeFlipAudioPlayback:this.beforeFlipAudioPlayback,tryAgainIsFrozen:this.tryAgainIsFrozen});card.bind("position:change",this.onChangeCard,this),this.cards.push(card)},onChangeCard:function(position,card,silent){if(this.notifyValueChange(),card.isFaceUp()){if(this.current.push(card),2===this.current.length){var pair=new a5.model.interaction.ISPelmanismPair({card1:this.current[0],card2:this.current[1]});pair.isCorrect()?(this.found.push(pair),this.current=[],this.scorable&&(this.notifyValueChange(),!silent&&this.isCorrect()&&a5.mainBuilder.checkAnswerWithFeedbackAllCorrect())):this.scorable&&!silent&&this.notifyValueChange(),pair.setAnswer(),this.trigger("pair:match",{correct:pair.isCorrect(),card1:pair.card1.identifier,card2:pair.card2.identifier})}}else this.current=[]},canFlip:function(){return"input"!==this.state||this.current.length<2},setVisualOrder:function(cards){this._visualOrderCards=cards},getCandidatesForSolutionHint:function(){return _.filter(this.findMissingPairs(),function(item){return!("answers"===item.card1.state||item.card1.prefill||item.card1.prefilled||"answers"===item.card2.state||item.card2.prefill||item.card2.prefilled)})},getCandidatesForShowNextAnswer:function(){return _.filter(this.findMissingPairs(),function(item){return!("answers"===item.card1.state||item.card1.prefill||item.card1.prefilled||"answers"===item.card2.state||item.card2.prefill||item.card2.prefilled)})},getCandidatesForValidation:function(){return _.filter(this.findMissingPairs(),function(item){return!("answers"===item.card1.state||item.card1.prefill||item.card1.prefilled||"answers"===item.card2.state||item.card2.prefill||item.card2.prefilled)})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},cancelAnimations:function(){this.trigger("cancelAnimations")},showNextAnswer:function(){this.cancelAnimations();var items=this.getCandidatesForShowNextAnswer(),question=items.shift();return question&&(question.showNextAnswer(),this.current[0]!==question.card1&&this.current[0]!==question.card2||(this.current=[])),0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){this.cancelAnimations();var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&(question.showSolutionHint(),this.current[0]!==question.card1&&this.current[0]!==question.card2||(this.current=[])),this.hasCandidatesForValidation()||(this.state="answers"),question},showAnswer:function(){var missingPairs=this.findMissingPairs();_(missingPairs).each(function(pair,index){setTimeout(function(){pair.showAnswer()},a5.dp.config.pelmanismShowAnswerDelay*index)});var missingCards=_(missingPairs).chain().map(function(p){return[p.card1,p.card2]}).flatten().value(),correctCards=_(this.cards).difference(missingCards);_(correctCards).invoke("showAnswer"),this._super()},findMissingPairs:function(){var pairs={},cards=_(this._visualOrderCards||this.cards).reject(function(card){return _(this.found).some(function(pair){return pair.contains(card)})},this);return _(cards).each(function(card1){var card2Identifier=card1.pair,card2=this.getCardByIdentifier(card2Identifier),id=_([card2Identifier,card1.identifier]).sortBy(function(id){return id}).join("-");_.isEmpty(pairs[id])&&card1&&card2&&(pairs[id]=new a5.model.interaction.ISPelmanismPair({card1:card1,card2:card2})),pairs[id].setMissing()},this),_(pairs).values()},getScores:function(){var score=new a5.Score;if(this.scorable){var totalPairs=this.cards.length/2;_(totalPairs).times(function(){score.incTotal()});var totalFound=this.found.length;if(_(totalFound).times(function(){score.incCorrect(),score.incFilled()}),2===this.current.length){var lastFound=_.last(this.found);lastFound&&lastFound.card1===this.current[0]&&lastFound.card2===this.current[1]||score.incFilled()}}return score},isCorrect:function(){return this.found.length>=this.cards.length/2},isFilled:function(){return this.found.length>0},areAllFilled:function(){return this.found.length>=this.cards.length/2},store:function(){return{found:_.map(this.found,function(pair,i){return pair.card1.identifier})}},restore:function(data){this.found=[];var found=data.found;_.each(found,function(identifier){var card1=this.getCardByIdentifier(identifier),card2=card1.findPair();new a5.model.interaction.ISPelmanismPair({card1:card1,card2:card2}).flip(!0)},this)},getCardByIdentifier:function(identifier){return _(this.cards).find(function(card){return card.identifier===identifier})},isMissing:function(card){return _(this.found).some(function(pair){return pair.contains(card)})},setPrefill:function(){if(this.hasPrefill){var card1=_(this.cards).first(),card2=card1.findPair();card1.setPrefill(),card2.setPrefill()}}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ISPelmanismBoard"),a5.model.interaction.ISPelmanismPair={card1:null,card2:null,init:function(parameters){_.extend(this,parameters||{}),this.card1.setPair(this),this.card2.setPair(this)},flip:function(silent){this.card1.flip(silent),this.card2.flip(silent)},flop:function(){this.card1.flop(),this.card2.flop()},isPaired:function(){return this.card1.identifier===this.card2.pair},isFaceUp:function(){return this.card1.isFaceUp()&&this.card2.isFaceUp()},isCorrect:function(){return this.isFaceUp()&&this.isPaired()},isFilled:function(){return this.isFaceUp()},addFirst:function(card){this.card1=card},addSecond:function(card){this.card2=card},contains:function(card){return _.isEqual(this.card1,card)||_.isEqual(this.card2,card)},setAnswer:function(){this.card1.setAnswer(),this.card2.setAnswer()},showAnswer:function(){this.card1.showAnswer(),this.card2.showAnswer()},showNextAnswer:function(){this.card1.showNextAnswer(),this.card2.showNextAnswer()},showSolutionHint:function(){this.card1.showSolutionHint(),this.card2.showSolutionHint()},setMissing:function(){this.card1.setMissing(),this.card2.setMissing()}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ISPelmanismPair"),a5.model.interaction.ISPelmanismCard={init:function(parameters){this._super(parameters,{position:"facedown",content:null,identifier:null,pair:null,currentPair:null,board:null,setNum:0,back:null,prefill:!1,autoAudioPlayback:!1,beforeFlipAudioPlayback:!1,tryAgainIsFrozen:!1})},flip:function(silent){this.board.canFlip()&&this._setPosition("faceup",silent)},flop:function(){this.currentPair=null,this._setPosition("facedown")},isFaceDown:function(){return"facedown"===this.position},isFaceUp:function(){return"faceup"===this.position},findPair:function(){return this.board.getCardByIdentifier(this.pair)},setPair:function(pair){this.currentPair=pair},setMissing:function(){this.currentPair=null},isCorrect:function(){return this.currentPair&&this.currentPair.isCorrect()},isFilled:function(){return this.currentPair&&this.currentPair.isFilled()},setAnwer:function(){this.position="faceup",this._super()},tryAgain:function(){this.position="facedown",this.currentPair=null,this.board.current=[],this._super()},showAnswer:function(){this.position="faceup",this._super()},setPrefill:function(){this.prefill=!0},_setPosition:function(position,silent){this.position!==position&&(this.position=position,this.trigger("position:change",position,this,silent))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ISPelmanismCard"),a5.model.interaction.PPFlashcards={init:function(parameters,defaults){this._super(parameters,$.extend({autoAudioPlayback:!1,beforeFlipAudioPlayback:!1},defaults)),this.cards=[]},addCard:function(params){var card=new a5.model.interaction.PPFlashcardsCard($.extend(params,{parent:this,autoAudioPlayback:this.autoAudioPlayback,beforeFlipAudioPlayback:this.beforeFlipAudioPlayback}));this.cards.push(card)},store:function(){return _.invoke(this.cards,"store")},restore:function(params){_.each(this.cards,function(card,index){params[index]&&card.restore(params[index])},this)},isFilled:function(){return _.some(this.cards,function(card){return card.isFilled()})},areAllFilled:function(){return _.every(this.cards,function(card){return card.isFilled()})}},a5.models.interaction.BaseModel.extend("a5.model.interaction.PPFlashcards"),a5.model.interaction.PPFlashcardsCard={init:function(parameters,defaults){this._super(parameters,$.extend({front:$("front"),back:$("back"),flipped:!1,autoAudioPlayback:!1,beforeFlipAudioPlayback:!1},defaults)),this.flipCount=0},flip:function(){this.flipped=!this.flipped,this.flipCount++,this.trigger("flipped"),this.notifyValueChange()},setFlipped:function(flipped){this.flipped=flipped,this.trigger("update_flipped")},store:function(){return{count:this.flipCount,flipped:this.flipped}},restore:function(param){this.flipCount=param.count,this.setFlipped(param.flipped),this.notifyValueChange()},isFilled:function(){return this.flipCount>0}},a5.models.interaction.BaseModel.extend("a5.model.interaction.PPFlashcardsCard"),a5.model.interaction.PPSlideshow={init:function(parameters,defaults){this._super(parameters,$.extend({step:1,magnifyStart:"70%",magnifyEnd:"90%",delay:2,minTime:2,maxTime:10,shuffle:!1,automaticControl:!1,magnifySlides:!1,shuffleControl:!1,additionalImageControl:!1,endingTime:.4},defaults)),this.slides=[],this.delay=_.min([this.delay,this.maxTime]),this.delay=_.max([this.delay,this.minTime])},addSlide:function(params){this.slides.push(new a5.model.interaction.PPSlideshowSlide($.extend(params,{parent:this})))},goFirst:function(){this.goTo(0)},goLast:function(){this.goTo(this.slides.length-1)},goNext:function(){this.goTo(this.curSlide+1)},goPrev:function(){this.goTo(this.curSlide-1)},goTo:function(index){if(index>=0&&index<this.slides.length){var oldSlide=this.slides[this.curSlide];this.curSlide=index,this.trigger("change:slide",oldSlide,this.slides[index])}},play:function(silent){this.playing=!0,this.magnifySlides&&(this.stopMagnifyAll(),this.startMagnify()),this.timer=setInterval(_.bind(function(){this.trigger("slide:ending",this.slides[this.curSlide]),_.delay(_.bind(function(){this.curSlide===this.slides.length-1?(this.goFirst(),this.pause()):(this.goNext(),this.magnifySlides&&this.startMagnify())},this),1e3*this.endingTime)},this),1e3*(this.delay-this.endingTime)),silent||this.trigger("slide:playing")},pause:function(silent){this.playing=!1,clearInterval(this.timer),silent||this.trigger("slide:paused")},interrupt:function(){this.pause(!0),this.play(!0)},incDelay:function(){this.setDelay(_.min([this.delay+this.step,this.maxTime]))},decDelay:function(){this.setDelay(_.max([this.delay-this.step,this.minTime]))},setDelay:function(delay){delay>0&&(this.delay=delay,this.trigger("change:delay",this.delay))},shuffleOrder:function(){this.originalSlides=this.slides,this.slides=_(this.slides).shuffle(),this.goTo(this.curSlide)},defaultOrder:function(){this.slides=this.originalSlides||this.slides,this.goTo(this.curSlide)},startMagnify:function(){var magnifyStart=this._parseTime(this.magnifyStart,this.delay);_.delay(_.bind(this.magnify,this),1e3*magnifyStart)},stopMagnify:function(){this.playing&&this.trigger("slide:magnify:stop",this.slides[this.curSlide])},stopMagnifyAll:function(){_(this.slides).each(function(slide){this.trigger("slide:magnify:stop",slide)},this)},magnify:function(){if(this.playing){this.trigger("slide:magnify:start",this.slides[this.curSlide]);var magnifyStart=this._parseTime(this.magnifyStart,this.delay),magnifyEnd=this._parseTime(this.magnifyEnd,this.delay);_.delay(_.bind(this.stopMagnify,this),1e3*(magnifyEnd-magnifyStart))}},_parseTime:function(time,ref){return/^\d+%$/.test(time)?ref*parseInt(time,10)/100:time}},a5.models.interaction.BaseModel.extend("a5.model.interaction.PPSlideshow"),a5.model.interaction.PPSlideshowSlide={init:function(parameters,defaults){this._super(parameters,$.extend({content:"",decode:""},defaults))}},a5.models.interaction.BaseModel.extend("a5.model.interaction.PPSlideshowSlide"),a5.models.interaction.RadioAccordion={init:function(parameters,defaults){this._super(parameters,$.extend({alignment:"horizontal"},defaults)),this.children=[]},append:function(child){this.children.push(child)},getScores:function(){return new a5.Score},store:function(){var data={children:[]};return _.each(this.children,function(child){data.children.push(child.store())},this),data},restore:function(data){data&&data.children&&_.each(this.children,function(child,i){child.restore(data.children[i])},this)}},a5.models.interaction.BaseModel.extend("a5.models.interaction.RadioAccordion"),a5.models.interaction.RadioAccordionElement={init:function(parameters,defaults){this._super(parameters,$.extend({selected:!1,content:null,alertNode:null,enumeration:null},defaults))},activate:function(){this.trigger("before_activate"),this.active=!0,this.trigger("change:active")},deactivate:function(){this.active=!1,this.trigger("change:active")},store:function(){return{active:this.active}},restore:function(data){data&&data.active&&this.activate()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.RadioAccordionElement"),a5.models.interaction.IMVoice={TIMELIMIT:30,textRegex:/\s+|[.,:;?]+(?=[\s]+)|[.,:;?]+$|\S+(?=[.,:;?]+$)|\S+(?=[.,:;?]+\s)|\S+/g,whitespaceRegex:/\s+/,punctuationRegex:/[.,:;?]+(?=[\s]+)|[.,:;?]+$/,init:function(parameters){this._super(parameters,{interaction:null,text:"",timelimit:this.TIMELIMIT,scorable:!1}),this.timelimit=_.min([this.timelimit,a5.dp.config.imVoiceTimelimit,this.TIMELIMIT]),
this.alternatives=a5.utils.splitUnescaped(this.text,"|"),this.text=_.first(this.alternatives),this.children=this._splitText(),this._initElements(),this.recording=new a5.models.interaction.SpeakingRecording({parent:this.interaction,downloadEnabled:!1,listenEnabled:!1,nopause:!0,timelimit:this.timelimit,scorable:this.scorable}),_.bindAll(this,"_getSTT","_onSuccess","_onFail")},setMatched:function(element){element.match(),this.completed=!0},setMatchedByText:function(text){var words=text.split(" ");_.chain(words).uniq().each(function(word){_.each(this.elements,function(element){element.test(word)&&this.setMatched(element)},this)},this),this.trigger("change")},store:function(){return{recording:this.recording.store(),children:_.invoke(this.elements,"store")}},restore:function(data){data.recording&&this.recording.restore(data.recording),data.children&&_.each(this.elements,function(element,index){element.restore(data.children[index])}),this.trigger("restore")},getScores:function(){var score=this.recording.getScores();return this.scorable&&!this.interaction.isManuallyMarked()&&this.isCorrect()&&score.incCorrect(),score},isFilled:function(){return this.recording.isFilled()},isCorrect:function(){return this.isFilled()},tryAgain:function(){this.clear(),this._super()},setAnswer:function(){this.scorable&&(this.isFilled()?this.speechToText().always(function(){this.setState("feedback")}.bind(this)):this._super())},clear:function(){this.completed=!1,this.recording.clear(),_.invoke(this.elements,"clear"),this.trigger("clear")},validate:function(data){if(data&&data.results){var result=_.first(data.results);_.each(result.alternatives,function(result){logger.info("speech-to-text: ["+result.transcript+"] with confidence "+result.confidence),this.setMatchedByText(result.transcript)},this)}},speechToText:function(){this.trigger("speech:start");var inputs=[],clips=[];return _.each(this.recording.records[0],function(snippet){inputs.push(a5.service.media.audio_recorder.instance().buildUrl(snippet)),clips.push({input:inputs.length-1})}),this._getSTT(inputs,clips).done(this._onSuccess).fail(this._onFail)},_getSTT:function(inputs,clips){return a5.service.media.stt.convert(inputs,clips)},_onSuccess:function(data){this.validate(data),this.trigger("speech:result",data)},_onFail:function(){logger.error("speech-to-text: failed"),this.trigger("speech:error")},_splitText:function(){var splitText=[];return _.each(this.text.match(this.textRegex),function(str){this.whitespaceRegex.test(str)||this.punctuationRegex.test(str)?splitText.push(new a5.model.interaction.IMVoiceText({text:str})):splitText.push(new a5.model.interaction.IMVoiceElement({text:str}))},this),splitText},_initElements:function(){this.elements=_.filter(this.children,function(child){return"element"===child.type})}},a5.models.interaction.BaseModel.extend("a5.models.interaction.IMVoice"),a5.model.interaction.IMVoiceElement={type:"element",init:function(parameters){this._super(parameters,{text:""}),this.matched=!1},match:function(){this.matched=!0,this.trigger("change")},clear:function(){this.matched=!1,this.trigger("change")},isMatched:function(){return this.matched},test:function(str){return a5.utils.containsAnswer(this.text,[str],!0,!0,!0,!0)},store:function(){return{matched:this.matched}},restore:function(data){data.matched&&this.match()}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMVoiceElement"),a5.model.interaction.IMVoiceText={type:"text",init:function(parameters){this._super(parameters,{text:""})}},a5.models.interaction.BaseModel.extend("a5.model.interaction.IMVoiceText"),a5.models.interaction.ISRadiobuttonVoice={TIMELIMIT:30,init:function(parameters){this._super(parameters,{interaction:null,prefilled:!1,tryAgainKeep:!1,tryAgainIsFrozen:!1,timelimit:this.TIMELIMIT}),this.timelimit=_.min([this.timelimit,a5.dp.config.isRadiobuttonVoiceTimelimit,this.TIMELIMIT]),this.choices=[],this.isCorrectable()&&(this.recording=new a5.models.interaction.SpeakingRecording({parent:this.interaction,downloadEnabled:!1,listenEnabled:!1,nopause:!0,timelimit:this.timelimit})),_.bindAll(this,"_getSTT","_onSuccess","_onFail")},addChoice:function(choice){this.choices.push(choice),choice.correct&&(this.correct=choice)},setSelected:function(choice){choice!==this.selected&&(_.invoke(this.choices,"unselect"),this.selected=choice,this.selected&&this.selected.select(),this.trigger("change"))},setSelectedByText:function(text){var selected=_.find(this.choices,function(choice){return choice.match(text)});this.setSelected(selected)},store:function(){if(this.isPrefilled())return{};var data={};return this.selected?data.selected=this.selected.value:data.selected=null,data.recording=this.recording.store(),data},restore:function(data){if(data.recording&&this.recording.restore(data.recording),data.selected){var selected=_.find(this.choices,function(choice){return choice.value===data.selected});selected&&this.setSelected(selected)}},getScores:function(){var score=new a5.Score;return this.isCorrectable()&&(score.incTotal(),score.incCorrect(this.isCorrect()),score.incFilled(this.isFilled())),score},isCorrectable:function(){return!this.isPrefilled()},isPrefilled:function(){return this.prefilled},isFilled:function(){return!this.isCorrectable()||this.recording.isFilled()},isCorrect:function(){return this.selected===this.correct},getCorrect:function(){return this.correct},tryAgain:function(){this.tryAgainIsFrozen||this.tryAgainKeep||this.clear(),this._super()},clearIncorrectAnswers:function(){_.each(this.choices,function(choice){choice!==this.correct&&choice.unselect()},this)},clear:function(){this.recording.clear(),this.setSelected(),this.trigger("clear")},validate:function(data){if(data&&data.results){var result=_.first(data.results);_.each(result.alternatives,function(result){logger.info("speech-to-text: ["+result.transcript+"] with confidence "+result.confidence),this.selected||this.setSelectedByText(result.transcript)},this)}},speechToText:function(){this.trigger("speech:start");var inputs=[],clips=[];return _.each(this.recording.records[0],function(snippet){inputs.push(a5.service.media.audio_recorder.instance().buildUrl(snippet)),clips.push({input:inputs.length-1})}),this._getSTT(inputs,clips).done(this._onSuccess).fail(this._onFail)},_getSTT:function(inputs,clips){return a5.service.media.stt.convert(inputs,clips)},_onSuccess:function(data){this.validate(data),this.trigger("speech:result",data)},_onFail:function(){logger.error("speech-to-text: failed"),this.trigger("speech:error")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISRadiobuttonVoice"),a5.models.interaction.ISRadiobuttonVoiceChoiceModel={init:function(parameters){this._super(parameters,{audio:null,text:"",content:null,interaction:null,correct:!1,value:null,enumeration:""}),this.alternatives=a5.utils.splitUnescaped(this.text,"|"),this.text=_.chain(this.alternatives).compact().first().value(),this._removeAlternativesFromContent(this.content)},match:function(text){return a5.utils.containsAnswer(text,this.alternatives,!0,!0,!0,!0)},select:function(){this.selected=!0,this.trigger("change")},unselect:function(){this.selected=!1,this.trigger("change")},isSelected:function(){return this.selected},_removeAlternativesFromContent:function($root){$root.contents().each(function(index,node){if(node.nodeType===Node.TEXT_NODE){var alternatives=_.compact(a5.utils.splitUnescaped(node.textContent,"|"));alternatives.length>1&&(node.textContent=_.first(alternatives))}else node.nodeType===Node.ELEMENT_NODE&&this._removeAlternativesFromContent($(node))}.bind(this))}},a5.models.interaction.BaseModel.extend("a5.models.interaction.ISRadiobuttonVoiceChoiceModel"),a5.models.EndResult={init:function(parameters,defaults){this._super(parameters,$.extend({allcorrectbyattempt:{},unsolved:0,solved:0,notattempted:0,sections:[],interactions:[],metadata:[]},defaults)),this.loData=new a5.models.EndResultData},get:function(interaction,key,group){var collection=this[group];return interaction?collection[interaction.index]?collection[interaction.index][key]:void 0:this.loData[key]},set:function(interaction,key,value,group){if(interaction){var collection=this[group];collection[interaction.index]||(collection[interaction.index]=new a5.models.EndResultData),collection[interaction.index][key]=value}else this.loData[key]=value},store:function(){var data={allcorrectbyattempt:this.allcorrectbyattempt,unsolved:this.unsolved,solved:this.solved,notattempted:this.notattempted};return data.loData=this.loData.store(),_.each(this.interactions,function(interaction){data.interactions||(data.interactions=[]),data.interactions.push(interaction&&interaction.store())}),_.each(this.sections,function(section){data.sections||(data.sections=[]),data.sections.push(section&&section.store())}),_.each(this.metadata,function(metadata){data.metadata||(data.metadata=[]),data.metadata.push(metadata&&metadata.store())}),data},restore:function(data){_.isEmpty(data)||(this.allcorrectbyattempt=data.allcorrectbyattempt,this.unsolved=data.unsolved,this.solved=data.solved,this.notattempted=data.notattempted,this.loData=new a5.models.EndResultData(data.loData),this.interactions=[],_.each(data.interactions,function(interaction){this.interactions.push(interaction&&new a5.models.EndResultData(interaction))},this),this.sections=[],_.each(data.sections,function(section){this.sections.push(section&&new a5.models.EndResultData(section))},this),this.metadata=[],_.each(data.metadata,function(metadata){this.metadata.push(metadata&&new a5.models.EndResultData(metadata))},this),this.isRestored=!0)}},a5.models.interaction.BaseModel.extend("a5.models.EndResult"),a5.models.EndResultData={init:function(parameters,defaults){this._super(parameters,$.extend({score:0,total:0,correct:0,incorrect:0,date:""},defaults))},store:function(){return{score:this.score,total:this.total,correct:this.correct,incorrect:this.incorrect,date:this.date}},restore:function(data){this.score=data.score,this.total=data.total,this.correct=data.correct,this.incorrect=data.incorrect,this.date=data.date}},a5.models.interaction.BaseModel.extend("a5.models.EndResultData"),a5.models.NotesModel={init:function(){this.notes=[],this.nextNoteNumber=1},store:function(){var data=[];return _.each(this.notes,function(n){data.push([n.title,n.text,n.date])}),data},restore:function(data){data&&_.each(data,function(e){this.addNote(e[0],e[1])},this)},addNote:function(title,text){title=title||"Untitled note "+this.nextNoteNumber++;var note=new a5.models.NoteModel(this);this.notes.push(note),this.trigger("add",this.notes.length-1),note.setTitle(title),note.setText(text)},removeAll:function(){for(;this.notes.length>0;)this.notes[this.notes.length-1].remove()}},a5.models.interaction.BaseModel.extend("a5.models.NotesModel"),a5.models.NoteModel={init:function(notes){this.notes=notes,this.title="",this.text="",this.date=+new Date},setTitle:function(title,silent){this.title=title,silent||this.notes.trigger("update",_.indexOf(this.notes.notes,this))},setText:function(text){this.text=text||"",this.notes.trigger("update",_.indexOf(this.notes.notes,this))},remove:function(){var index=_.indexOf(this.notes.notes,this);this.notes.notes.splice(index,1),this.notes.trigger("remove",index)}},a5.models.interaction.BaseModel.extend("a5.models.NoteModel"),a5.models.SubtitlesModel={init:function(){this.subtitles=[]},loadSRT:function(string){string=string.replace(/&#62;/g,">"),string=string.replace(/<\/p>/g,""),string=string.replace(/<p>/g,""),string=string.replace(/&#xd;/g,"");var item={};_.each(string.split("\n"),function(line){""==line.trim()?_.isEmpty(item)||(this.subtitles.push(item),item={}):_.isUndefined(item.nb)?item.nb=parseInt(line.trim(),10):_.isUndefined(item.from)?line.indexOf("--\x3e")>=0&&(item.from=this.stringToSeconds(line.split("--\x3e")[0].trim()),item.to=this.stringToSeconds(line.split("--\x3e")[1].trim())):(_.isUndefined(item.text)&&(item.text=""),item.text+=line+"\n")},this),_.isEmpty(item)||4!=_.size(item)||this.subtitles.push(item)},empty:function(){return 0==this.subtitles.length},all:function(){return this.subtitles},stringToSeconds:function(string){var date=_.map(string.split(":"),function(e){return parseFloat(e.replace(",","."))});return 60*date[0]*60+60*date[1]+date[2]},getCurrent:function(time){return _.first(_.compact(_.map(this.subtitles,function(e){if(e.from<=time&&e.to>=time)return e})))},getCurrentIndex:function(time){return _.indexOf(this.subtitles,this.getCurrent(time))},getVTTCues:function(){return _(this.subtitles).map(function(subtitle){return new VTTCue(subtitle.from,subtitle.to,subtitle.text||"")})}},a5.models.interaction.BaseModel.extend("a5.models.SubtitlesModel"),a5.models.Karaoke={init:function(){this.items=[]},add:function($karaoke){this.items.push({from:parseFloat($karaoke.attr("data-from")),to:parseFloat($karaoke.attr("data-to")),node:$karaoke})},empty:function(){return 0===this.items.length},all:function(){return this.items},getCurrent:function(time){return _.first(_.compact(_.map(this.items,function(e){if(e.from<=time&&e.to>=time)return e})))},getCurrentIndex:function(time){return _.indexOf(this.items,this.getCurrent(time))}},a5.models.interaction.BaseModel.extend("a5.models.Karaoke"),a5.models.interaction.IdentifySelectMaze={init:function(parameters,defaults){this._super(parameters,_.defaults(defaults||{},{node:null,step:-1}))},getScores:function(){var score=new a5.Score;score.incTotal();var filter=_.filter($(".image-choice"),function(i){return!_.isUndefined($(i).attr("id"))&&!_.isEmpty($(i).attr("id"))&&$(i).hasClass("checked")});return $(".dir2_view").length-1==filter.length&&(score.incCorrect(),score.incFilled()),score},setAnswer:function(){var node;$(".image-choice").each(function(e,el){void 0!==$(el).attr("id")?$(el).hasClass("checked")?(node=$('<span class="check correct"></span>'),$(el).append(node)):(node=$('<span class="check wrong_2"></span>'),$(el).append(node)):$(el).hasClass("checked")&&(node=$('<span class="check wrong"></span>'),$(el).append(node))})},showAnswer:function(){},tryAgain:function(){},store:function(){return this.step},restore:function(step){this.step=step;var $steps=this.node.find(".dir2_view.notdone");_.each($steps,function(e,index){if(index<=step){var $e=$(e);$e.removeClass("notdone"),index<step?($e.addClass("done"),$e.find(".panel[id]").addClass("flip")):$e.addClass("active")}})}},a5.models.interaction.BaseModel.extend("a5.models.interaction.IdentifySelectMaze"),a5.model.TeamScoring={init:function(team){this.team=team,this.points=0,this.active=!1},inc:function(){this.points++},setActive:function(active){this.active=active}},Obj.extend("a5.model.TeamScoring"),a5.model.Moderator={init:function(teams,interaction){this.interaction=interaction,this.teamScores=_.map(teams,function(team){return new a5.model.TeamScoring(team)}),this.turn=0,this.current().setActive(!0),this.lastFilled=0,this.lastCorrect=0,a5.eventBus.bind("interaction:value:change",this.onValueChange,this),a5.mainBuilder.bind("reset",this.onReset,this,{once:!0})},unbindEvents:function(){a5.eventBus.unbind("interaction:value:change",this.onValueChange),a5.mainBuilder.unbind("reset",this.onReset)},onReset:function(){this.unbindEvents()},onValueChange:function(interaction){this.interaction===interaction&&$.when(this.interaction.getTotalFilled(),this.interaction.areAllFilled(),this.interaction.getResultsAsync()).then(function(filled,allFilled,results){var correct=results.correct();filled>this.lastFilled&&(correct>this.lastCorrect&&this.current().inc(),allFilled?this.trigger("interaction:teams:finalscore",this.teamScores):this.trigger("interaction:teams:score",this.current()),this.next()),this.lastCorrect=correct,this.lastFilled=filled}.bind(this))},next:function(){var last=this.current();this.turn=(this.turn+1)%this.teamScores.length;var current=this.current();this.trigger("interaction:teams:turn:change",last,current)},current:function(){return this.teamScores[this.turn]},winners:function(){if(!this.teamScores.length)return[];var winnerPoints=_(this.teamScores).max(function(t){return t.points}).points,winners=_(this.teamScores).filter(function(t){return t.points===winnerPoints});return winners.length===this.teamScores.length&&(winners=[]),winners}},Obj.extend("a5.model.Moderator"),a5.CombinedUndoRedoManager={init:function(parameters){this.undoHistory=[],this.redoHistory=[],this.maxLevels=parameters.maxLevels||1,this.annotations=parameters.annotations,this.stage=parameters.stage,this.annotations.bind("change:history",this._onAnnotationsChangeHistory,this),this.stage.bind("change:history",this._onStageChangeHistory,this)},undo:function(){this.canUndo()&&(this.redoHistory.push(this.getState()),this.setState(this.undoHistory.pop()),this.trigger("change:history"))},redo:function(){this.canRedo()&&(this.undoHistory.push(this.getState()),this.setState(this.redoHistory.pop()),this.trigger("change:history"))},setState:function(state){this.fromObject(state),this.trigger("change:state")},getState:function(){return this.serialize()},savePoint:function(){this.undoHistory.push(this.getState()),this.redoHistory=[],this.undoHistory.length>this.maxLevels&&this.undoHistory.splice(0,1),this.trigger("change:history")},canUndo:function(){return this.undoHistory.length>0},canRedo:function(){return this.redoHistory.length>0},serialize:function(){return{annotations:this.annotations.children.slice(0),stage:this.stage.serialize()}},fromObject:function(object){object.stage&&this.stage.setState(object.stage),object.annotations&&this.annotations.setChildren(object.annotations)},_onAnnotationsChangeHistory:function(){this.savePoint()},_onStageChangeHistory:function(){this.savePoint()}},Obj.extend("a5.CombinedUndoRedoManager"),a5.model.ResourcesStage={init:function(parameters){parameters=parameters||{},this.undoHistory=[],this.redoHistory=[],this.maxLevels=parameters.maxLevels||1,this.items=parameters.items||[],this.banks=parameters.banks},add:function(item){this.items.push(item),this.trigger("change")},remove:function(item){var index=this.items.indexOf(item);index>=0&&(this.items.splice(index,1),this.trigger("change"))},empty:function(){this.items=[],this.trigger("change")},getItems:function(){return this.items},getItemById:function(id){return _(this.items).find(function(item){return item.id===id})},getItemsByType:function(type){return _(this.items).filter(function(item){return item.type===type})},getItemsByBankItemId:function(bankItemId){return _(this.items).filter(function(item){return item.bankItemId===bankItemId})},setGrids:function(grids){this.clickToAddGrid=grids.clickToAdd,this.generalGrid=grids.general},resetGrids:function(){this.clickToAddGrid&&this.clickToAddGrid.reset()},undo:function(){this.canUndo()&&(this.redoHistory.push(this.getState()),this.setState(this.undoHistory.pop()),this.trigger("change:history"))},redo:function(){this.canRedo()&&(this.undoHistory.push(this.getState()),this.setState(this.redoHistory.pop()),this.trigger("change:history"))},setState:function(state){this.fromObject(state),this.trigger("change:state")},getState:function(){return this.serialize()},savePoint:function(){this.undoHistory.push(this.getState()),this.redoHistory=[],this.undoHistory.length>this.maxLevels&&this.undoHistory.splice(0,1),this.trigger("change:history")},canUndo:function(){return this.undoHistory.length>0},canRedo:function(){return this.redoHistory.length>0},fromObject:function(object){this.empty(),_(object.items).each(function(item){var bankItem=this.banks.findItemById(item.bankItemId);bankItem&&"keypad"!==item.type&&(item.inline=bankItem.inline);var stageItem;stageItem="numeral-cards"===item.type?new a5.model.CardStageItem(item):new a5.model.ResourceStageItem(item),this.add(stageItem)},this),this.clickToAddGrid.fromObject(object.clickToAddGrid)},serialize:function(){return{items:_(this.items).invoke("serialize"),clickToAddGrid:this.clickToAddGrid.serialize()}}},Obj.extend("a5.model.ResourcesStage"),a5.model.ResourceStageItem={init:function(parameters){var defaults={x:0,y:0,transform:"matrix(1, 0, 0, 1, 0, 0)",path:null,inline:null,type:null,value:0,bankItemId:null};this.id=a5.utils.createUID(),this.fromObject(_.extend(defaults,parameters))},flipHorizontal:function(origin,size){if(origin){var x1=this.x-origin.x,y1=this.y-origin.y,x2=-x1,y2=y1;this.x+=x2-x1-size.width,this.y+=y2-y1}this.matrix=this.matrix.scale(-1,1),this._adjustSubpixel()},flipVertical:function(origin,size){if(origin){var x1=this.x-origin.x,y1=this.y-origin.y,x2=x1,y2=-y1;this.x+=x2-x1,this.y+=y2-y1-size.height}this.matrix=this.matrix.scale(1,-1),this._adjustSubpixel()},rotate:function(origin,size,anticlockwise){var coef=anticlockwise?-1:1;if(origin){var x1=this.x-origin.x,y1=this.y-origin.y,x2=-y1*coef,y2=x1*coef;this.x+=Math.round(10*(x2-x1-(size.height*coef+size.width)/2))/10,this.y+=Math.round(10*(y2-y1-(size.height-size.width*coef)/2))/10}this.matrix=this.matrix.rotate(90*coef),this._adjustSubpixel()},moveTo:function(x,y){this.x=x,this.y=y,this._adjustSubpixel()},fromObject:function(object){_.extend(this,object),this.matrix=new a5.utils.Matrix(a5.utils.parseCSSMatrix(this.transform))},serialize:function(){var data={x:this.x,y:this.y,transform:this.matrix.toString(),path:this.path,type:this.type,bankItemId:this.bankItemId,value:this.value};return"keypad"===this.type&&(data.inline=$("[data-item-id="+this.id+"]").html()),data},getTransformMatrix:function(){return this.matrix.x(this.cssmatrix)},getValue:function(){return this.value},_adjustSubpixel:function(){var translateX=0,translateY=0;Math.floor(this.x)!==Math.round(this.x)&&(translateX=-.5),Math.floor(this.y)!==Math.round(this.y)&&(translateY=-.5),this.x-=translateX,this.y-=translateY,this.matrix=this.matrix.translate(translateX,translateY)}},Obj.extend("a5.model.ResourceStageItem"),a5.model.CardStageItem={faceUp:function(){this.face="up"},faceDown:function(){this.face="down"},isFaceUp:function(){return"up"===this.face},isFaceDown:function(){return"down"===this.face},serialize:function(){return _.extend(this._super(),{face:this.face})}},a5.model.ResourceStageItem.extend("a5.model.CardStageItem"),a5.model.ResourceBankList={init:function(parameters){var availableBanks=parameters.availableBanks,allBanks=parameters.allBanks;this._initBanks(availableBanks,allBanks)},getPreselectedBanks:function(){return _(this.banks).filter(function(bank){return bank.preselected})},getLastPreselectedBank:function(){var banks=this.getPreselectedBanks();return _(banks).last()},getIndexOfSelectedBank:function(banks){banks=banks||this.banks;var index=_(banks).findIndex(function(bank){return bank.selected});return _.max([0,index])},getBankByName:function(name){return _(this.banks).find(function(bank){return bank.name===name})},getBankById:function(id){return _(this.banks).find(function(bank){return bank.id===id})},getBankByIndex:function(index){return this.banks[index]},findItemById:function(itemId){var found;return _(this.banks).each(function(bank){found||(found=bank.findItemById(itemId))}),found},getBanks:function(){return this.banks},updateSelection:function(selection){_(selection).each(function(bank){var b=this.getBankById(bank.id);b.preselected=bank.active,b.selected=!1},this);var bank=this.getLastPreselectedBank();bank&&(bank.selected=!0)},_initBanks:function(availableBanks,allBanks){this.banks=[],_(availableBanks).each(function(availableBank){var bank=_(allBanks).find(function(bank){return bank.name.toLowerCase()===availableBank.name.toLowerCase()});bank&&(bank.selected=availableBank.default_,bank.preselected=availableBank.preSelected,this.banks.push(bank))},this)}},Obj.extend("a5.model.ResourceBankList"),a5.model.ResourceBank={init:function(bank,parent){this.id=_.str.slugify(bank.name),this.name=bank.name,this.parent=parent,this.selected=!1,this.preselected=!1,this._initItems(bank.items)},findItemByName:function(name){var found;return _(this.items).each(function(item){found||(item instanceof a5.model.ResourceBankGroup?found=item.findItemByName(name):item.name===name&&(found=item))}),found},findItemById:function(id){var found;return _(this.items).each(function(item){found||(item instanceof a5.model.ResourceBankGroup?found=item.findItemById(id):item.id===id&&(found=item))}),found},getItems:function(){var items=[];return _(this.items).each(function(item){item instanceof a5.model.ResourceBankGroup?items=items.concat(item.getItems()):items.push(item)},this),items},_initItems:function(items){this.items=[],_(items).each(function(item){"group"===item.type?this.items.push(new a5.model.ResourceBankGroup(item,this,this)):"composite-item"===item.type?this.items.push(new a5.model.ResourceComposedBankItem(item,this,this)):this.items.push(new a5.model.ResourceBankItem(item,this,this))},this)}},Obj.extend("a5.model.ResourceBank"),a5.model.ResourceBankItem={init:function(item,parent,bank){_.extend(this,item),this.id=parent.id+"-"+_.str.slugify(item.name),this.parent=parent,this.bank=bank}},Obj.extend("a5.model.ResourceBankItem"),a5.model.ResourceComposedBankItem={init:function(item,parent,bank){this.id=parent.id+"-"+_.str.slugify(item.name),this.name=item.name,this.value=item.value,this.parent=parent,this.composite=this._initItems(item.composite,bank),this.bank=bank},_initItems:function(names,bank){return _(names).map(function(name){return bank.findItemByName(name)})}},Obj.extend("a5.model.ResourceComposedBankItem"),a5.model.ResourceBankGroup={init:function(group,parent,bank){this.id=parent.id+"-"+_.str.slugify(group.name),this.name=group.name,this.parent=parent,this.bank=bank,this._initItems(group.items)},findItemByName:function(name){return _(this.items).find(function(item){return item.name===name})},findItemById:function(id){return _(this.items).find(function(item){return item.id===id})},getItems:function(){return this.items},_initItems:function(items){this.items=[],_(items).map(function(item){"composite-item"===item.type?this.items.push(new a5.model.ResourceComposedBankItem(item,this,this.bank)):this.items.push(new a5.model.ResourceBankItem(item,this,this.bank))},this)}},Obj.extend("a5.model.ResourceBankGroup"),a5.ResourcesStageGrid={cellSize:7,snap:function(box,center){var offset={x:Math.floor(box.x/this.cellSize)*this.cellSize,y:Math.floor(box.y/this.cellSize)*this.cellSize},dx=(box.x-offset.x)/this.cellSize,dy=(box.y-offset.y)/this.cellSize;return.5===dx&&center&&(dx=box.x<center.x?1:0),.5===dy&&center&&(dy=box.y<center.y?1:0),{x:Math.round(dx)*this.cellSize+offset.x,y:Math.round(dy)*this.cellSize+offset.y,fit:!0}},serialize:function(){},fromObject:function(object){}},Obj.extend("a5.ResourcesStageGrid"),a5.ResourcesStageClickToAddGrid={init:function(parameters){var defaults={cellSize:7,$grid:null,rowHeight:0};_.extend(this,defaults,parameters),this.bounds=this._getBoundingBox(),this.cursor={x:this.bounds.left,y:this.bounds.bottom}},snap:function(box){var current={};return this.cursor.x+box.width>this.bounds.right&&(this.cursor.x=this.bounds.left,this.cursor.y=this.cursor.y-this.rowHeight,this.rowHeight=0),this.cursor.y-box.height<=this.bounds.top&&(this.cursor.y=this.bounds.bottom,this.cursor.x=this.bounds.left,this.rowHeight=0),current.x=this.cursor.x,current.y=this.cursor.y-box.height,current.fit=current.y>=this.bounds.top,current.fit&&(this.cursor.x=current.x+box.width,box.height>this.rowHeight&&(this.rowHeight=box.height)),current},serialize:function(){return{x:this.cursor.x,y:this.cursor.y,rowHeight:this.rowHeight}},fromObject:function(object){this.cursor={x:object.x,y:object.y},this.rowHeight=object.rowHeight},refreshDimensions:function(){this.bounds=this._getBoundingBox()},reset:function(){this.cursor={x:this.bounds.left,y:this.bounds.bottom},this.rowHeight=0},relativeTo:function($parent){var box=this.$grid[0].getBoundingClientRect(),parent=$parent[0].getBoundingClientRect();return{left:box.left-parent.left,top:box.top-parent.top}},_getBoundingBox:function(){return{left:0,top:0,bottom:this.$grid.height(),right:this.$grid.width()}}},Obj.extend("a5.ResourcesStageClickToAddGrid"),a5.views.interaction.BaseView={checkTemplate:"a5.view.Check",init:function(model,parent,node){this.model=model,this.parent=parent,this.node=node,this.model&&(this.node.attr("data-model-id",this.model.id),this.model.bind&&(this.model.bind("state_update:input",this.unbindAnswerFeedback,this),this.model.bind("setEnabled",this.onSetEnabled,this),this.model.bind("clearValidation",this.onClearValidation,this),this.model.bind("clearUserData",this.onClearUserData,this))),this.node.data("mvc-view",this)},$:function(selector){return _.isUndefined(selector)?this.node:this.node.find(selector)},render:function(){return this.node},detachChildren:function(children){_(children||this.children).each(function(child){child.node&&child.node.detach()})},renderChildren:function($target){$target=$target||this.node,_.isString($target)&&($target=this.$($target));var fragment=document.createDocumentFragment();_.each(this.children,function(child){var $node=child.render&&child.render()||child.node;$node&&fragment.appendChild($node[0])}),$target.append(fragment)},addCheck:function(params){var correct=params.correct||!1,width=params.width||200,node=params.parent||this.node,empty=params.empty||!1,tooltip=params.tooltip||!1,interaction=this.getInteractionObject(node)||a5.mainBuilder.curInteraction,hasFeedbackSyntax=!!tooltip&&!!this._getFeedbackTextTooltip(tooltip,correct,interaction),correctTooltip=params.correctTooltip||hasFeedbackSyntax,over=params.over||!1,out=params.out||!1,classes=params.classes||[],$check=$(a5.service.templates.render(this.checkTemplate,{classes:classes,correct:correct,empty:empty}));return node.append($check),correct||empty||(over&&$check.on("mouseover",over),out&&$check.on("mouseout",out)),!correct||correctTooltip?this.appendTooltip(tooltip,$check,width):a5.dp.config.displayFeedbackAfterSeeAnswer&&this._isStateAnswers()&&this.appendTooltip(tooltip,$check,width),$check},_isStateAnswers:function(){return"answers"===this.model.state||!!$(this.node).attr("class").match(/solution/)},_getFeedbackTextTooltip:function(tooltip,correct,interaction){var tootltipStr=_.isString(tooltip)?tooltip:tooltip.text(),regex=/(#feedback:)(.+)(#)/gm,tooltipIds=tootltipStr.replace(regex,"$2");if(tooltipIds!==tootltipStr){var feedbackId=this._getCorrectFeedbackId(tooltipIds,correct,interaction);return interaction.feedbackText[feedbackId]}},_getCorrectFeedbackId:function(ids,correct,interaction){var allIdentifiers,correctFeedbackIds,incorrectFeedbackIds,seeAnswerFeedbackId;if(allIdentifiers=ids.split("|"),correct?correctFeedbackIds=allIdentifiers[0]:allIdentifiers.length>1?(correctFeedbackIds=allIdentifiers[0],incorrectFeedbackIds=allIdentifiers[1]):incorrectFeedbackIds=allIdentifiers[0],this._isStateAnswers()){var correctSeeAnswerFeedback=this._getSeeAnswerFeedbackId(correctFeedbackIds),incorrectSeeAnswerFeedback=this._getSeeAnswerFeedbackId(incorrectFeedbackIds);if(seeAnswerFeedbackId=correct?correctSeeAnswerFeedback:incorrectSeeAnswerFeedback||correctSeeAnswerFeedback)return seeAnswerFeedbackId}var index=this._isStateAnswers()?Math.max(0,interaction.checkAttempts-1):interaction.checkAttempts;return this._processIdentifierList(correct?correctFeedbackIds:incorrectFeedbackIds,index)},_getSeeAnswerFeedbackId:function(ids){if(ids&&_.isString(ids)){var listofIds=ids.split(",");return listofIds.length>1?listofIds[1]:void 0}},_processIdentifierList:function(idList,index){var identifierList=idList.split(",")[0].split("*");return index=Math.min(identifierList.length-1,index),identifierList[index]},getInteractionObject:function(parentnode){var wrap=(parentnode||this.node,this.node.parents(".content-wrap"));if(wrap.length)return _.find(a5.mainBuilder.intList,function(interaction){return interaction.contentWrap.is(wrap)})},appendTooltip:function(tooltip,$check,width){if(tooltip){width=width||200;var interaction=this.getInteractionObject(this.node)||a5.mainBuilder.curInteraction,feedbackText=this._getFeedbackTextTooltip(tooltip,$check.hasClass("correct"),interaction);if(feedbackText)$check.addClass("has-feedback"),
$check.on("click",function(e){e.stopPropagation(),e.preventDefault();var $node=$("<div>");a5.utils.buildModel(interaction,$node,$(feedbackText),!0),this._renderFeedbackText($node,$check,interaction)}.bind(this));else{var toti=$('<div class="tooltip"></div>');$check.append(toti),toti.append(tooltip);var adjustTooltipSize=_.bind(function(){if($check.is(":visible")){var size=toti.naturalSize({position:"relative"},{width:width}),scrollParent=a5.utils.scrollParent(toti);toti.removeClass("left-tooltip right-tooltip above-tooltip below-tooltip"),$check.offset().top+size[1]<scrollParent.top+scrollParent.height?toti.addClass("below-tooltip"):$check.offset().top-size[1]>scrollParent.top?toti.addClass("above-tooltip"):toti.addClass("below-tooltip"),$check.offset().left+size[0]<scrollParent.left+scrollParent.width?toti.addClass("right-tooltip"):$check.offset().left-size[0]>scrollParent.left?toti.addClass("left-tooltip"):toti.addClass("right-tooltip"),a5.callbacks.interaction.unbind("showed",adjustTooltipSize)}},this);a5.callbacks.interaction.bind("showed",adjustTooltipSize,this),_.defer(adjustTooltipSize)}}},_getCheckStateClass:function($check,blockClass){var ret=blockClass;return $check.hasClass("correct")?ret+="--correct":$check.hasClass("wrong")?ret+="--incorrect":ret+="--empty",ret},_renderFeedbackText:function($node,$check,interaction){this._clearFeedbackText(!0),a5.dp.config.specificFeedbackDiv?this._renderFeedbackTextDiv($node,$check):this._renderFeedbackTextDialog($node,$check),interaction.bind("reset",this._onInteractionReset,this),interaction.bind("hide",this._onInteractionHide,this),interaction.displaySpecificFeedback(!0)},_renderFeedbackTextDialog:function($node,$check){$node.dialog({modal:!0,dialogClass:"no-title feedback-text-popup "+this._getCheckStateClass($check,"feedback-text-popup")}).on("dialogclose",this.onFeedbackDialogClose.bind(this))},_renderFeedbackTextDiv:function($node,$check){$node.addClass("feedback-text").addClass(this._getCheckStateClass($check,"feedback-text")),$(a5.dp.config.specificFeedbackDiv).append($node)},_clearFeedbackText:function(dispatch){var interaction=this.getInteractionObject(this.node)||a5.mainBuilder.curInteraction;a5.dp.config.specificFeedbackDiv?this._clearFeedbackTextDiv($(a5.dp.config.specificFeedbackDiv)):this._clearFeedbackTextDialog($("body")),interaction.unbind("reset",this._onInteractionReset,this),interaction.unbind("hide",this._onInteractionHide,this),dispatch&&interaction.displaySpecificFeedback(!1)},_clearFeedbackTextDiv:function($parent){$parent.length>0&&(a5.service.media.pause($parent),$parent.empty())},_clearFeedbackTextDialog:function($parent){var $dialog=$parent.find(".feedback-text-popup");$dialog.length>0&&(a5.service.media.pause($dialog),$dialog.dialog("instance")&&$dialog.dialog("destroy"),$dialog.remove())},_onInteractionReset:function(ev){this._clearFeedbackText(!0)},_onInteractionHide:function(ev){this._clearFeedbackText(!0)},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},onFeedbackDialogClose:function(ev){this._clearFeedbackText(!0)},onSetEnabled:function(enabled){this.node.toggleClass("item--disabled",!enabled)},onClearValidation:function(){this.removeCheck(!0)},onClearUserData:function(){},removeCheck:function(clear){this.node.find(".check").remove(),clear&&this._clearFeedbackText(!0)},bindAnswerFeedback:function(model,opts){opts=opts||{},model=model||{},(model.answerFeedbackId||model.answerFeedback)&&(this.node.addClass("with-view-text"),this.node.find(".check").addClass("has-feedback"),this.showAnswerFeedback=_.bind(function(){$(".view-text").hide(),$(".view-text-active").removeClass("view-text-active"),opts.showWhenCorrect||!opts.correct||this._isStateAnswers()&&a5.dp.config.displayFeedbackAfterSeeAnswer?(model.answerFeedbackId&&$("#view-text-"+model.answerFeedbackId).show().focus(),this.node.addClass("view-text-active"),$("#answer-feedback").html(model.answerFeedback||"").trigger("update")):$("#answer-feedback").empty().trigger("update")},this),this.node.on("click",this.showAnswerFeedback))},hideAnswerFeedback:function(){$(".view-text").hide(),$(".view-text-active").removeClass("view-text-active")},unbindAnswerFeedback:function(){this.showAnswerFeedback&&($(".view-text").hide(),$(".view-text-active").removeClass("view-text-active"),this.node.off("click",this.showAnswerFeedback),this.showAnswerFeedback=null)},updateFeedbackState:function(nodes){if(!this.model.isPrefilled()){this.checkLocked(nodes),nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct solution-revealed");var type;if(this.model.state===this.model.STATES.CHECK)type="checked";else{if(this.model.state!==this.model.STATES.ANSWERS)return;type="solution"}if(this.model.isRevealedBySeeNext())return void nodes.addClass("solution-revealed");this.model.isCorrect()?nodes.addClass([type,"correct"].join("-")):this.model.isFilled()?nodes.addClass([type,"incorrect"].join("-")):nodes.addClass([type,"empty"].join("-"))}},checkLocked:function(node){(this.model.tryAgainBehaviour?this.model.tryAgainBehaviour.lock:this.model.tryAgainIsFrozen)&&((node||this.node).filter(".checked-correct").addClass("checked-correct-locked"),(node||this.node).filter(":not(.checked-correct)").removeClass("checked-correct-locked"))},isLocked:function(node){return(node||this.node).hasClass("checked-correct-locked")},delegateEvents:function(){var events=_.result(this,"domEvents"),eventSplitter=/^(\S+)\s*(.*)$/;events&&_.each(events,function(v,k){var method=_.isFunction(v)?v:this[v];if(method){var match=k.match(eventSplitter),eventName=match[1],selector=match[2];method=_.bind(method,this),_.isEmpty(selector)?this.$().on(eventName,method):this.$().on(eventName,selector,method)}},this)},util:{maxViewSizeOfModel:function(model,minWidthHeight){var self=this,min=[];return minWidthHeight.length>1?min.push(minWidthHeight[0],minWidthHeight[1]):min.push(0,0),$.isArray(model)?_.each(model,function(m){min=self.maxViewSizeOfModel(m,min)}):_.each(model.views(),function(v){var wh=v.contentSize();wh[0]>min[0]&&(min[0]=wh[0]),wh[1]>min[1]&&(min[1]=wh[1])}),min}}},Obj.extend("a5.views.interaction.BaseView"),a5.view.Dialog={display:function(template,model,callbacks,beforeClose,buildModels,appendTo){return this._skipDialog(template,model,callbacks)?$(appendTo):(this.$node&&!this.$node.is(":empty")&&this.close(),this.removeOnClose=!1,this.callbacks=callbacks||{},this.$content=$(a5.service.templates.render(template,model)),0!=this.$content.length?(this.$node=$(appendTo),this.$node.length?this.displayAsNode(buildModels):(this.$node=$("<div>"),this.removeOnClose=!0,this.displayAsDialog(buildModels,model.dialogClass,beforeClose,this._isModal(template))),a5.mainBuilder.curInteraction.bind("hide",this.close,this,{once:!0}),a5.mainBuilder.curInteraction.bind("reset",this.close,this,{once:!0}),a5.callbacks.dialogs.get(template).trigger("showed",this.$node,model),a5.mainBuilder.curInteraction.trigger("interaction:dialog:display"),this.$node):void 0)},_skipDialog:function(template,model,callbacks){if(_.contains(a5.dp.config.skipDialogs,template)||!0===a5.dp.config.skipDialogs)return callbacks&&callbacks.ok?callbacks.ok():callbacks&&callbacks.close?callbacks.close():callbacks&&callbacks.cancel&&callbacks.cancel(),!0},_isModal:function(template){return!_.contains(a5.dp.config.nonModalDialogs,template)},_appendContent:function(buildModels){this.$node.empty(),buildModels?a5.utils.buildModel(a5.mainBuilder.curInteraction,this.$node,this.$content,!0):this.$node.append(this.$content)},_createButtons:function(){_.each(this.$node.find("a[data-button]"),function(button){$(button).button(),$(button).on("click",_.bind(function(e){e.preventDefault();var event=$(button).attr("data-button");this.okClicked="ok"===event,this.close(),event in this.callbacks&&"close"!==event&&this.callbacks[event]()},this))},this)},_createDialog:function(dialogClass,beforeCloseFn,closeFn,modal){this.$node.find("img[class*=bgimg]").length>0&&(dialogClass+=" dialog-with-background-image"),_.isFunction(beforeCloseFn)||(beforeCloseFn=function(){return!0}),this.$node.dialog({modal:modal,dialogClass:dialogClass,beforeClose:beforeCloseFn,close:closeFn,resize:function(){var $dialog=$(this).closest(".ui-dialog"),$titlebar=$dialog.find(".ui-dialog-titlebar"),$content=$(this),height=$titlebar.outerHeight()+$content.outerHeight();$dialog.height(height);var width=$content.outerWidth();$dialog.width(width)}})},displayAsDialog:function(buildModels,dialogClass,beforeCloseFn,modal){this.$node.attr("title",this.$content.attr("title")),this.$content.removeAttr("title"),$("body").append(this.$node),this._appendContent(buildModels),this._createButtons();var onCloseDialogFn=_.bind(function(event,ui){a5.mainBuilder.curInteraction.trigger("interaction:dialog:close"),"beforeclose"in this.callbacks&&this.callbacks.beforeclose(),this._clear(),"close"in this.callbacks&&(this.callbacks.close(this.okClicked),this.okClicked=!1)},this);this._createDialog(dialogClass,beforeCloseFn,onCloseDialogFn,modal)},displayAsNode:function(buildModels){this._appendContent(buildModels),this._createButtons()},close:function(){this.$node&&this.$node.is(":ui-dialog")?this.$node.dialog("close"):("beforeclose"in this.callbacks&&this.callbacks.beforeclose(),this._clear(),"close"in this.callbacks&&(this.callbacks.close(this.okClicked),this.okClicked=!1))},_clear:function(){a5.mainBuilder.curInteraction.unbind("hide",this.close),a5.mainBuilder.curInteraction.unbind("reset",this.close),this.removeOnClose?(this.$node&&this.$node.remove(),delete this.$node):this.$node.empty()}},Obj.extend("a5.view.Dialog"),a5.view.dialog=new a5.view.Dialog,a5.view.feedback=a5.view.dialog,a5.view.Alert={init:function(parameters){_.extend(this,parameters||{}),this.$el=$("<div>",{class:"a5-alert"}),_.bindAll(this,"onClickClose"),this.$el.on("click",".close",this.onClickClose)},render:function(){var html=a5.service.templates.render(this.template,this.data),$html=$(html);this.$el.html($html.html());var duration=parseInt($html.attr("data-duration"),10);duration&&(this.duration=duration),this.$el.addClass(this.alertClass)},show:function(){this.$root.append(this.$el),this.render(),this.duration&&setTimeout(function(){this.close()}.bind(this),1e3*this.duration)},close:function(){this.$el.remove()},onClickClose:function(e){e.preventDefault(),this.close()}},Obj.extend("a5.view.Alert"),a5.views.interaction.ModelTextView={init:function(modelText,interaction){this.modelText=modelText,this.interaction=interaction},render:function(){var self=this;if(0!=this.modelText.length){var button=new a5.views.Toolbar.ModelTextButton("Model-Text");this.modelText.each(function(index,e){var div=$(e).find("div")[0],label=a5.utils.truncate($(div).attr("label"),24);label=$(div).attr("label");var mtNode=$("<div>"+$(div).text()+"</div>"),node=$("<div></div>");self.interaction.buildModelExludeNode(node,mtNode,!0),button.addItem(label,node.html())}),self.interaction.referenceToolbar.addButton(button)}}},Obj.extend("a5.views.interaction.ModelTextView"),a5.views.interaction.CustomTextView={init:function(customAttachments,interaction){this.customAttachments=customAttachments,this.interaction=interaction,this.attachments=this._createAttachments()},render:function(){this.btnList={},this._renderAttachments()},find:function(attachment){return _.find(this.attachments,function(at){return at.pinned&&at.label===attachment.label&&at.html===attachment.html},this)},closeAll:function(){_.invoke(this.attachments,"close")},_findPinnedAttachment:function(attachment){var found,interactions=a5.mainBuilder.getInteractionsWithAttachments();return _.each(interactions,function(interaction){found||(found=interaction!==this.interaction&&interaction.attachments.find(attachment))},this),found},_sanitizeAttachment:function(node){var nodeText=node.text().replace(/src=(['"])http(s)*:/gi,"src=$1");return nodeText=nodeText.replace(/<img[^>]+src=([^>]*flashIcon\.png[^>]*URL=)/gi,"<img do-not-load-src=$1"),logger.log("Sanitized attachment assets to avoid mixed content warnings."),nodeText=nodeText.replace(/(<video[^>]+)(autoplay=['"][^'"]*['"])/gi,"$1data-$2")},_parseAttachment:function(node){var $attachment=node.find("div"),sanitizedContent=this._sanitizeAttachment($attachment),$sanitizedContent=$(sanitizedContent),modes=_.map($sanitizedContent.find("loModes > string"),function(loMode){return $(loMode).text()}),userVisibility=$sanitizedContent.find("userVisibility").text()||"all";return{html:$sanitizedContent.find("text").text(),label:$attachment.attr("label"),customType:$sanitizedContent.find("customtype").text(),attachmentLink:$sanitizedContent.find("attachmentLink").text(),userVisibility:userVisibility,modes:modes,pinned:this._isPinned(node),options:{klass:$attachment.attr("class"),target:$.trim($sanitizedContent.find("target").text()),popup:$.trim($sanitizedContent.find("windowopen").text()),url:$.trim($sanitizedContent.find("URL").text()),top:$.trim($sanitizedContent.find("windowTop").text()),left:$.trim($sanitizedContent.find("windowLeft").text())}}},_createAttachments:function(){return this.customAttachments.map(function(index,node){var $node=$(node);return this._createAttachment($node)}.bind(this)).get()},_createAttachment:function(node){var attachmentData=this._parseAttachment(node),attachment=new a5.service.Attachment(attachmentData.label,attachmentData.html,attachmentData.options,this.interaction,attachmentData);if(attachment.pinned){var pinned=this._findPinnedAttachment(attachment);pinned&&(attachment=pinned)}return attachment},_renderAttachments:function(){_.each(this.attachments,function(attachment){this._renderAttachment(attachment)},this)},_renderAttachment:function(attachment){attachment.render(),attachment.pinTo(this.interaction),attachment.showInHeader?this._renderAttachmentInHeader(attachment):attachment.showAlternativeDisplay&&this._renderAttachmentInAlternativePlace(attachment)},_createHeaderButton:function(attachment){var button;""===attachment.customType?(button=new a5.views.Toolbar.DropDownItem(attachment.label,attachment),button.main=!0,this.interaction.referenceToolbar.addButton(button)):(button=this.btnList[attachment.customType],button||(button=new a5.views.Toolbar.DropDownButton(attachment.customType),this.interaction.referenceToolbar.addButton(button),this.btnList[attachment.customType]=button),button&&button.addItem(attachment.label,attachment))},_createAlternativeButton:function(attachment){var button=new a5.views.interaction.AttachmentButton({label:attachment.label,attachment:attachment,interaction:this.interaction});a5.mainBuilder.$body.find("#attachmentsAlternative").append(button.$el),button.render()},_renderAttachmentInAlternativePlace:function(attachment){this._isAttachmentVisible(attachment)&&this._createAlternativeButton(attachment)},_renderAttachmentInHeader:function(attachment){this._isAttachmentVisible(attachment)&&this._createHeaderButton(attachment)},_isAttachmentVisible:function(attachment){return!("Normal"!==LOInfo.mode&&attachment.modes.length>0&&!_.contains(attachment.modes,LOInfo.mode))&&("all"===attachment.userVisibility.toLowerCase()||attachment.userVisibility.toLowerCase()===a5.service.lms.API.getUserRole().toLowerCase())},_isPinned:function(node){return node.attr("style")&&node.attr("style").match(/option023/i)}},Obj.extend("a5.views.interaction.CustomTextView"),a5.views.interaction.AttachmentButton={template:"a5.view.AttachmentButton",init:function(parameters){parameters=parameters||{},this.label=parameters.label,this.attachment=parameters.attachment,this.interaction=parameters.interaction;var html=a5.service.templates.render(this.template,{label:this.label});this.$el=$(html),_.bindAll(this,"_onClick"),this.$el.on("click",this._onClick),this.attachment.bind("open",this._onAttachmentOpened,this),this.attachment.bind("close",this._onAttachmentClosed,this),this.interaction.bind("show",this._onInteractionShow,this),this.interaction.bind("hide",this._onInteractionHide,this)},render:function(){this.$el.addClass("button--hidden"),this.$el.toggleClass("button--enabled",this.attachment.isOpen()),this.$el.addClass("attachmentButton--type"+_.str.capitalize(_.str.camelize(this.attachment.customType))),this.$el.addClass("attachmentButton--target"+_.str.capitalize(_.str.camelize(this.attachment.options.target))),this.$el.attr("aria-controls",this.attachment.id)},_onClick:function(e){e.preventDefault(),this.$el.hasClass("button--enabled")?this._close():this._open()},_open:function(){this.attachment.open()},_close:function(){this.attachment.close()},_onAttachmentOpened:function(){this.$el.addClass("button--enabled")},_onAttachmentClosed:function(){this.$el.removeClass("button--enabled")},_onInteractionHide:function(){this.$el.addClass("button--hidden")},_onInteractionShow:function(){this.$el.removeClass("button--hidden")}},Obj.extend("a5.views.interaction.AttachmentButton"),a5.views.WordPool={POOL_HANDLE_TEMPLATE:"a5.view.WordpoolDragHandle",init:function(alignment,forcePool,interaction,droppable){if(this.children=[],this.interaction=interaction,"none"===alignment&&forcePool&&(alignment="top"),this.$wordpool=$('<div class="wordpool"></div>'),this.pool=$('<div class="pool"></div>'),this.block=$('<div class="block"></div>'),"none"!==alignment&&this.$wordpool.append(this.pool),this.$wordpool.append(this.block),this.$wordpool.addClass("alignment_"+alignment),"top"!==alignment&&"bottom"!==alignment||this.$wordpool.addClass("alignment_horizontal"),"left"!==alignment&&"right"!==alignment||this.$wordpool.addClass("alignment_vertical"),"bottom"===alignment&&this.$wordpool.append(this.pool),"free"===alignment){var html=a5.service.templates.render(this.POOL_HANDLE_TEMPLATE),$free=$(html);this.pool.append($free),this.$resetPosition=$free.find(".reset_position"),this.$resetPosition.on("click",this.onResetPosition.bindTo(this)),this.pool.draggable({start:this.onStart.bindTo(this),stop:this.onStop.bindTo(this),drag:this.onDrag.bindTo(this),handle:".drag-handle",cancel:".reset_position"})}droppable&&this.pool.droppable({accept:".drag_element",drop:this.onDrop.bindTo(this),tolerance:"pointer",scope:"screen-"+this.interaction.index}),this.interaction.bind("show:deferred",_.bind(this.onShowInteraction,this),{once:!0})},addChild:function(child){this.children.push(child),this._bindChildEvents(child)},_bindChildEvents:function(child){child.model.bind("undrop",function(){this.interaction.trigger("pool:changed",child.node)},this),child.model.bind("drop",function(){this.interaction.trigger("pool:changed",child.node)},this)},render:function(){return _.each(this.children,function(child){this.pool.append(child.render())},this),this.$wordpool},onResetPosition:function(){this.$resetPosition.addClass("hidden"),this.pool.css("position","relative").css("top","0").css("left","0")},onDrag:function(event,ui){var newScrollSensitivity,currentScrollSensitivity=this.pool.draggable("option","scrollSensitivity");this.prevY&&event.pageY>this.prevY?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&this.pool.draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&this.pool.draggable("option","scrollSensitivity",newScrollSensitivity)),this.prevY=event.pageY,ui.helper.css("zIndex",2701)},onStop:function(event,ui){ui.helper.css("zIndex",2699)},onStart:function(event,ui){this.$resetPosition.removeClass("hidden").show(),this.$wordpool.closest(".interaction").css({"margin-top":"0"})},clear:function(){this.pool.children(".static_word").remove()},append:function(text,gaptextaudio){if(text&&text.trim()){var word=$('<div class="static_word"></div>').append(text);gaptextaudio&&word.prepend(this.createTTSAudio(text).render()),this.pool.append(word)}},createTTSAudio:function(text){return new a5.views.TTS_Player(text)},onShowInteraction:function(){this.pool.is(".ui-draggable")&&this.pool.draggable("option","containment",this.interaction.contentWrap),this.$wordpool.closest(".interaction").addClass("wordpool")},onDrop:function(event,ui){var drag,dropView=_(this.children).find(function(child){return drag=drag||child.model.parent.getDragByID(parseInt(ui.draggable.attr("data-model-id"),10)),child.model.drag===drag});_.isUndefined(dropView)&&(dropView=_(this.children).find(function(child){return drag=drag||child.model.parent.getDragByID(parseInt(ui.draggable.attr("data-model-id"),10)),child.model.resident===drag&&!child.model.isFilled()})),_.isUndefined(dropView)&&(dropView=_(this.children).find(function(child){return drag=drag||child.model.parent.getDragByID(parseInt(ui.draggable.attr("data-model-id"),10)),!child.model.isFilled()})),_.isUndefined(drag)||(drag.lastTarget.undrop(drag),dropView&&(drag.lastTarget=dropView.model)),_.isUndefined(dropView)?ui.helper.remove():dropView.model.drop(drag)}},Obj.extend("a5.views.WordPool"),a5.views.interaction.DropArea={preserveSize:!1,init:function(model,parent){this._super(model,parent,$(a5.mainBuilder.layout.getTemplate("drop_area"))),this.node.addClass("drop_area"),this.interaction=model.parent.parent,this.dragHolder=this.$(".drag_holder"),this.placeholderContent="&#160;",this.model.content&&this.node.prepend(this.model.content),this.contentHolder=this.$(".content"),this.model.enumeration&&(this.model.globalEnumeration&&a5.dp.config.continuousEnumerationInsideGaps?this.placeholderContent='<span class="enum-placeholder"></span>':this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.model.globalEnumeration&&a5.dp.config.continuousEnumerationInsideGaps&&(this.placeholderContent=enumSymbol),this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),this.model.arrow&&this.node.addClass("arrow_"+this.model.arrow),this.updateDrag(),this.model.prefilled?this.node.addClass("prefilled"):this.dragHolder.droppable({accept:_.bind(function(draggable){var drag=this.model.parent.getDragByID(parseInt(draggable.attr("data-model-id"),10));return drag&&draggable.is(".drag_element")&&this.model.canDrop(drag)},this),over:this.onOver.bindTo(this),out:this.onOut.bindTo(this),drop:this.onDrop.bindTo(this),tolerance:"radius-closest-to-mouse",toleranceRadius:a5.dp.config.droppableToleranceRadius,greedy:!0,scope:"screen-"+this.interaction.index}),this.model.isDistractor()&&this.node.addClass("distractor-gap")},enable:function(){this.model.prefilled||this.dragHolder.droppable("enable")},disable:function(){this.model.prefilled||this.dragHolder.droppable("disable")},onOver:function(event,ui){this.model.dropIndicator&&(this.node.addClass("is-active-target"),this.node.addClass("drop-indicator"),ui.helper.addClass("is-active-target-source"))},onOut:function(event,ui){this.node.removeClass("is-active-target"),this.node.removeClass("drop-indicator"),ui.helper.removeClass("is-active-target-source")},onDrop:function(event,ui){var drag=this.model.parent.getDragByID(parseInt(ui.draggable.attr("data-model-id"),10));if(drag.lastTarget.copyOnDrag||drag.lastTarget.undrop(drag),this.model.drag!==drag||"restricted"===this.model.parent.multiDest){if("home"==(drag.existing||this.model.existing||"no")&&this.model.drag&&this.model.drag.home){var toBeDropped;this.model.drag.home.drag&&"one"===this.model.parent.multiDest&&(toBeDropped=_.first(this.model.parent.getAvailablePoolAreas())),toBeDropped=toBeDropped||this.model.drag.home,toBeDropped.drop(this.model.drag)}this.model.drop(drag)}else ui.helper.remove();this.node.removeClass("is-active-target"),this.node.removeClass("drop-indicator"),ui.helper.removeClass("is-active-target-source")},createViewFor:function(model){logger.error("please override me")},updateDrag:function(){this.updateToThisDrag(this.model.drag)},updateToThisDrag:function(drag){if(this.dragHolder.empty(),null!=drag){this.node.addClass("has_drag");var view=this.createViewFor(drag);this.dragHolder.append(view.render())}else this.node.removeClass("has_drag"),this.dragHolder.append($('<div class="place_holder">'+this.placeholderContent+"</div>")),this.model.prefilled&&this.node.addClass("prefilled");this.updateSize()},contentSize:function(){return this.contentHolder.naturalSize()},setNodeSize:function(w,h){var padx=this.node.outerWidth()-this.node.width(),pady=this.node.outerHeight()-this.node.height();this.node.css({minWidth:w-padx,minHeight:h-pady})},setHolderSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.dragHolder.outerWidth()-this.dragHolder.width(),pady=this.dragHolder.outerHeight()-this.dragHolder.height()),this.dragHolder.css({minWidth:w-padx,minHeight:h-pady}),this.minWidth=w-padx,this.minHeight=h-pady,this.updateSize()},setContentSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.contentHolder.outerWidth()-this.contentHolder.width(),pady=this.contentHolder.outerHeight()-this.contentHolder.height()),this.contentHolder.css({minWidth:w-padx,minHeight:h-pady})},updateSize:function(){!this.preserveSize&&this.node.hasClass("has_drag")?(this.dragHolder.css("minHeight",""),this.dragHolder.css("minWidth","")):(this.dragHolder.css("minHeight",this.minHeight),this.dragHolder.css("minWidth",this.minWidth))}},a5.views.interaction.BaseView.extend("a5.views.interaction.DropArea"),a5.views.interaction.StackDropArea={init:function(model,parent){this._super(model,parent,$('<div class="drop_area stack_drop_area"><div class="width-measure"></div></div>')),this.interaction=model.parent.parent,this.model.content&&this.node.append(this.model.content),this.dragHolder=$('<div class="drag_holder"></div>'),this.node.append(this.dragHolder),this.model.enumeration&&(this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),this.updateDrags(),this.dragHolder.droppable({accept:".drag_element",over:this.onOver.bindTo(this),out:this.onOut.bindTo(this),drop:this.onDrop.bindTo(this),tolerance:"pointer",greedy:!0,scope:"screen-"+this.interaction.index})},setHolderSize:function(w,h){this.dragHolder.css({width:w,height:h})},onOver:a5.views.interaction.DropArea.prototype.onOver,onOut:a5.views.interaction.DropArea.prototype.onOut,onDrop:a5.views.interaction.DropArea.prototype.onDrop,createViewFor:function(model){logger.error("please override me")},updateDrags:function(){this.dragHolder.empty(),this.node.toggleClass("has_drag",this.model.drags.length>0),_(this.model.drags).each(function(drag){var view=this.createViewFor(drag);this.dragHolder.append(view.render())},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.StackDropArea"),a5.views.interaction.DragElement={init:function(model,parent){if(this._super(model,parent,$('<div class="drag_element"></div>')),this.interaction=model.parent.parent,this.model.content){this.node.append(this.model.content.clone(!0));var updateContent=this.model.content;_.defer(function(){var viewUpdaters=updateContent.find("[data-has-view-updater]");_.each(viewUpdaters,function(e){$(e).data("view-updater").update()})})}this.draggableOptions=a5.utils.getDraggableOptions(this.interaction),parent.model.prefilled?this.node.addClass("prefilled"):(this.node.draggable($.extend({start:this.onStart.bindTo(this),stop:this.onStop.bindTo(this),drag:this.onDrag.bindTo(this),revert:"invalid",revertDuration:350,disabled:!0,helper:this.createHelper.bind(this),scope:"screen-"+this.interaction.index,cancel:".checked-correct-locked",containment:"document"},this.draggableOptions)),this.enable()),this.interaction.isLiveCycle("loaded")&&this.interaction.index===a5.mainBuilder.curInteraction.index?this.applyContainment():this.interaction.bind("show:deferred",_.bind(this.applyContainment,this),{once:!0}),model.bind("state_update:input",this.onStateInput,this),model.bind("drop",function(){this.node.trigger("dragstop")},this)},render:function(){if(this.model.gaptextaudio){var text=this.node.text();this.$(".content").prepend(this.createTTSAudio(text).render())}return this.node.find(".has_audio_attached").toggleClass("no-label",!this.node.text()),this.interaction.trigger("drag:render",this.node),this.node},onStateInput:function(){this.isLocked(this.parent.dragHolder)&&this.disable()},onStart:function(event,ui){this.model.lastTarget=this.parent.model,this.interaction.$(".drop_area").css("zIndex",""),this.interaction.$(".drag_element").css("zIndex",""),ui.helper.css("zIndex",2700),ui.helper.closest(".drop_area").css("zIndex",2700),this.parent.model.copyOnDrag||this.node.css("visibility","hidden")},onStop:function(event,ui){this.interaction.$(".drop_area").css("zIndex",""),this.interaction.$(".drag_element").css("zIndex",""),this.parent.model.copyOnDrag||this.node.css("visibility","visible")},onDrag:function(event,ui){var newScrollSensitivity,currentScrollSensitivity=this.node.draggable("option","scrollSensitivity");this.prevY&&event.pageY>this.prevY?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&this.node.draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&this.node.draggable("option","scrollSensitivity",newScrollSensitivity)),this.prevY=event.pageY},createHelper:function(){var $clone=this.node.clone().removeAttr("id");return $clone.css("width",Math.ceil(this.node.get(0).getBoundingClientRect().width)),$clone},disable:function(){if(this.node.is(".ui-draggable")){try{this.node.draggable("disable")}catch(e){}this.node.addClass("ui-disabled")}},enable:function(){if(this.node.is(".ui-draggable")){this.node.removeClass("ui-disabled");try{this.node.draggable("enable")}catch(e){}}},createTTSAudio:function(text){return new a5.views.TTS_Player(text)},contentSize:function(){return this.node.naturalSize()},setSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.node.outerWidth()-this.node.width(),pady=this.node.outerHeight()-this.node.height()),this.node.css({minWidth:w-padx,minHeight:h-pady})},applyContainment:function(){if(!("containment"in this.draggableOptions)&&this.node.is(".ui-draggable")&&a5.dp.config.keepDragElementInsideContentZone){var $container=this.interaction.contentZone,x1=$container.offset().left-this.node.width(),x2=$container.offset().left+$container.width(),y2=$(document).height();this.node.draggable("option","containment",[x1,0,x2,y2])}}},a5.views.interaction.BaseView.extend("a5.views.interaction.DragElement"),a5.views.WordPoolSimple={POOL_HANDLE_TEMPLATE:"a5.view.WordpoolDragHandle",init:function(alignment,parent,forcePool,model,droppable){this.parent=parent,this.children=[],"none"===alignment&&forcePool&&(alignment="top"),this.$wordpool=$('<div class="wordpool"></div>'),this.pool=$('<div class="pool"></div>'),this.block=$('<div class="block"></div>'),this._setPoolAlignment(alignment,model),"none"!==alignment&&this.$wordpool.append(this.pool),this.$wordpool.append(this.block),this.$wordpool.addClass(alignment),droppable&&this.pool.droppable({accept:".drag_element",drop:this.onDrop.bindTo(this),tolerance:"pointer",scope:"screen-"+model.index})},_setPoolAlignment:function(alignment,model){if("none"!==alignment&&this.$wordpool.append(this.pool),"free"===alignment){var html=a5.service.templates.render(this.POOL_HANDLE_TEMPLATE),$free=$(html);this.pool.append($free),this.$resetPosition=$free.find(".reset_position"),this.$resetPosition.on("click",this.onResetPosition.bindTo(this)),model.bind("show:deferred",_.bind(function(){this.pool.draggable({start:this.onStart.bindTo(this),stop:this.onStop.bindTo(this),drag:this.onDrag.bindTo(this),containment:model.contentWrap,handle:".drag-handle",cancel:".reset_position"})},this),{once:!0})}},addChild:function(child){this.children.push(child)},render:function(){return _.each(this.children,function(child){this.pool.append(child.render())},this),this.$wordpool},onResetPosition:function(){
this.$resetPosition.addClass("hidden"),this.pool.css("position","relative").css("top","0").css("left","0")},getDragViewById:function(id){return this.parent.getDragViewById(id)},getAvailablePoolAreas:function(){return _.filter(this.children,function(dropArea){return null===dropArea.drag})},onDrag:function(event,ui){var newScrollSensitivity,currentScrollSensitivity=this.pool.draggable("option","scrollSensitivity");this.prevY&&event.pageY>this.prevY?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&this.pool.draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&this.pool.draggable("option","scrollSensitivity",newScrollSensitivity)),this.prevY=event.pageY,ui.helper.css("zIndex",2701)},onStop:function(event,ui){ui.helper.css("zIndex",2699)},onStart:function(event,ui){this.$resetPosition.removeClass("hidden").show(),this.$wordpool.closest(".interaction").css({"margin-top":"0"})},clear:function(){this.pool.children(".static_word").remove()},onDrop:function(event,ui){var drag=this.getDragViewById(ui.draggable.attr("data-model-id"));if(drag&&!drag.parent.isPoolArea()){var availableDropView=_.first(this.getAvailablePoolAreas());availableDropView&&availableDropView.drop(drag)}},moveDragViewToPool:function(drag){var destination;(destination=drag.lastPoolArea&&!drag.lastPoolArea.drag?drag.lastPoolArea:_.first(this.getAvailablePoolAreas()))&&destination.drop(drag)}},Obj.extend("a5.views.WordPoolSimple"),a5.views.interaction.SimpleDropArea={PLACEHOLDER_TEMPLATE:'<div class="place_holder">&nbsp;</div>',preserveSize:!1,isPoolArea:function(){return this.parent instanceof a5.views.WordPoolSimple},init:function(model,parent,interaction){this._super(model,parent,$('<div class="drop_area"/>')),this.interaction=interaction,this.dragHolder=$("<div/>").addClass("drag_holder"),this.node.append(this.dragHolder),this.placeholderContent="&nbsp;",this.model&&this.model.content&&this.node.prepend(this.model.content),this.drag&&this.drag.model.prefilled?this.node.addClass("prefilled"):this._setDroppable(interaction),this.updateAudio(),this.drag&&this.drag.model.isDistractor()&&this.node.addClass("distractor-gap")},_setDroppable:function(interaction){this.dragHolder.droppable({accept:_.bind(function(draggable){var canDrop=!this.drag||!this.isPoolArea();return draggable.is(".drag_element")&&canDrop},this),over:this.onOver.bindTo(this),out:this.onOut.bindTo(this),drop:this.onDrop.bindTo(this),tolerance:"radius-closest-to-mouse",toleranceRadius:a5.dp.config.droppableToleranceRadius,greedy:!0,scope:"screen-"+interaction.index})},disable:function(){this.dragHolder.droppable("option","disabled",!0)},enable:function(){this.dragHolder.droppable("option","disabled",!1)},onOver:function(event,ui){this.node.addClass("hovered")},onOut:function(event,ui){this.node.removeClass("hovered")},updateAudio:function(){var text=this.node.text();if(this.model&&this.model.gaptextaudio){var tts=new a5.views.TTS_Player(text);this.node.find(".content").prepend(tts.render())}this.node.find(".has_audio_attached").toggleClass("no-label",text)},onDrop:function(event,ui){this.node.removeClass("hovered");var drag=this.parent.getDragViewById(ui.draggable.attr("data-model-id"));drag&&this.drag!==drag&&(this.drag&&this.drag!==drag&&!this.isPoolArea()?this.parent.moveDragViewToPool(this.drag):ui.helper.remove(),this.drop(drag))},drop:function(drag){drag.parent.undrop(),this.setDrag(drag),this.trigger("drop"),this.isPoolArea()&&this.interaction.trigger("pool:changed",this.node)},undrop:function(){this.drag&&(this.drag.detach(),this.drag.updateParent(null)),this.setDrag(null),this.trigger("undrop"),this.isPoolArea()&&this.interaction.trigger("pool:changed",this.node)},updateDrag:function(){this.updateToThisDrag(this.model.drag)},setDrag:function(drag){this.drag=drag,this.dragHolder.empty(),null!==this.drag?(this.node.addClass("has_drag"),this.node.removeAttr("tabindex"),this.dragHolder.append(this.drag.render()),this.drag.updateParent(this),this.drag.model.prefilled&&this.node.addClass("prefilled")):(this.node.removeClass("has_drag"),this.node.attr("tabindex",0),this.dragHolder.append(this.PLACEHOLDER_TEMPLATE))}},a5.views.interaction.BaseView.extend("a5.views.interaction.SimpleDropArea");a5.views.interaction.SimpleDragElement={init:function(model,parent,interaction){this._super(model,parent,$('<div class="drag_element"/>')),this.model.content&&this.node.append(this.model.content.clone(!0)),this.draggableOptions=a5.utils.getDraggableOptions(interaction),this.model.isPrefilled()?this.node.addClass("prefilled"):this.setDraggable(interaction.index),this.updateAudio()},setDraggable:function(index){this.node.draggable($.extend({start:this.onStart.bindTo(this),stop:this.onStop.bindTo(this),drag:this.onDrag.bindTo(this),revert:"invalid",revertDuration:350,helper:"clone",scope:"screen-"+index,cancel:".checked-correct-locked"},this.draggableOptions))},detach:function(){this.node.detach()},updateParent:function(drop){drop&&drop.isPoolArea()&&(this.lastPoolArea=drop),this.parent=drop},updateAudio:function(){var text=this.node.text();if(this.model&&this.model.gaptextaudio){var tts=new a5.views.TTS_Player(text);this.node.find(".content").prepend(tts.render())}this.node.find(".has_audio_attached").toggleClass("no-label",text)},onStart:function(event,ui){ui.helper.css("width",this.node[0].getBoundingClientRect().width),this.model.copyOnDrag||this.node.css("visibility","hidden")},onStop:function(event,ui){this.model.copyOnDrag||this.node.css("visibility","visible")},onDrag:function(event,ui){var newScrollSensitivity,currentScrollSensitivity=this.node.draggable("option","scrollSensitivity");this.prevY&&event.pageY>this.prevY?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&this.node.draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&this.node.draggable("option","scrollSensitivity",newScrollSensitivity)),this.prevY=event.pageY},disableDraggable:function(){try{this.node.draggable("disable")}catch(e){}},enableDraggable:function(){try{this.node.draggable("enable")}catch(e){}},disable:function(){this.node.is(".ui-draggable")&&(this.disableDraggable(),this.node.addClass("ui-disabled"))},enable:function(){this.node.is(".ui-draggable")&&(this.enableDraggable(),this.node.removeClass("ui-disabled"))}},a5.views.interaction.BaseView.extend("a5.views.interaction.SimpleDragElement"),a5.views.interaction.FillArea={preserveSize:!1,init:function(model,parent){this._super(model,parent,$(a5.mainBuilder.layout.getTemplate("drop_area"))),this.node.addClass("drop_area"),_.bindAll(this,"onClick","onKeydown"),this.interaction=model.parent.parent,this.dragHolder=this.$(".drag_holder"),this.placeholderContent="&#160;",this.model.content&&this.node.prepend(this.model.content),this.contentHolder=this.$(".content"),this.model.enumeration&&(this.model.globalEnumeration&&a5.dp.config.continuousEnumerationInsideGaps?this.placeholderContent='<span class="enum-placeholder"></span>':this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.model.globalEnumeration&&a5.dp.config.continuousEnumerationInsideGaps&&(this.placeholderContent=enumSymbol),this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),this.model.arrow&&this.node.addClass("arrow_"+this.model.arrow),this.updateDrag(),this.model.isDistractor()&&this.node.addClass("distractor-gap"),this.enable()},enable:function(){this.model.prefilled?this.node.addClass("prefilled"):(this.node.on("click",this.onClick),this.node.on("keydown",this.onKeydown))},disable:function(){this.node.off("click",this.onClick),this.node.off("keydown",this.onKeydown)},onClick:function(){this.fillGap()},onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.fillGap()},fillGap:function(){var selectedElements=this.model.parent.getSelectedDragElement(),drag=selectedElements.length&&selectedElements[0];!this.model.isFilled()&&drag&&(drag.lastTarget.copyOnDrag||drag.lastTarget.undrop(drag),this.model.drop(drag))},createViewFor:function(model){logger.error("please override me")},updateDrag:function(){this.updateToThisDrag(this.model.drag)},updateToThisDrag:function(drag){if(this.dragHolder.empty(),null!=drag){this.node.addClass("has_drag"),this.node.removeAttr("tabindex");var view=this.createViewFor(drag);this.dragHolder.append(view.render())}else this.node.removeClass("has_drag"),this.dragHolder.append($('<div class="place_holder">'+this.placeholderContent+"</div>")),this.model.prefilled?(this.node.addClass("prefilled"),this.node.removeAttr("tabindex")):this.node.attr("tabindex",0);this.updateSize()},contentSize:function(){return this.contentHolder.naturalSize()},setNodeSize:function(w,h){var padx=this.node.outerWidth()-this.node.width(),pady=this.node.outerHeight()-this.node.height();this.node.css({minWidth:w-padx,minHeight:h-pady})},setHolderSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.dragHolder.outerWidth()-this.dragHolder.width(),pady=this.dragHolder.outerHeight()-this.dragHolder.height()),this.dragHolder.css({minWidth:w-padx,minHeight:h-pady}),this.minWidth=w-padx,this.minHeight=h-pady,this.updateSize()},setContentSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.contentHolder.outerWidth()-this.contentHolder.width(),pady=this.contentHolder.outerHeight()-this.contentHolder.height()),this.contentHolder.css({minWidth:w-padx,minHeight:h-pady})},updateSize:function(){!this.preserveSize&&this.node.hasClass("has_drag")?(this.dragHolder.css("minHeight",""),this.dragHolder.css("minWidth","")):(this.dragHolder.css("minHeight",this.minHeight),this.dragHolder.css("minWidth",this.minWidth))}},a5.views.interaction.BaseView.extend("a5.views.interaction.FillArea"),a5.views.interaction.StackFillArea={isPoolArea:!0,init:function(model,parent){this._super(model,parent,$('<div class="drop_area stack_drop_area"><div class="width-measure"></div></div>')),_.bindAll(this,"onClick"),this.interaction=model.parent.parent,this.model.content&&this.node.append(this.model.content),this.dragHolder=$('<div class="drag_holder"></div>'),this.node.append(this.dragHolder),this.model.enumeration&&(this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),this.updateDrags(),this.node.on("click",this.onClick),this.node.attr("tabindex",0)},onClick:function(){this.fillGap()},fillGap:function(ev){var allSelectedDrags=this.model.parent.getSelectedDragElement(),mySelectedDrags=_.intersection(allSelectedDrags,this.model.drags),externalSelectedDrags=_.difference(allSelectedDrags,mySelectedDrags),drag=externalSelectedDrags.length&&externalSelectedDrags[0];drag&&(mySelectedDrags.length&&_.invoke(this.getTileViewsByModels(mySelectedDrags),"select",!1),drag.lastTarget.copyOnDrag||drag.lastTarget.undrop(drag),this.model.drop(drag))},getTileViewsByModels:function(tiles){return _.filter(this.tileViews,function(tView){return _.contains(tiles,tView.model)})},setHolderSize:function(w,h){this.dragHolder.css({width:w,height:h})},createViewFor:function(model){logger.error("please override me")},updateDrags:function(){this.dragHolder.empty(),this.tileViews=[],_(this.model.drags).each(function(drag){this.tileViews.push(this.createViewFor(drag)),this.dragHolder.append(_.last(this.tileViews).render())},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.StackFillArea"),a5.views.interaction.TileElement={init:function(model,parent){if(this._super(model,parent,$('<div class="drag_element"></div>')),this.interaction=model.parent.parent,_.bindAll(this,"onClick","onDoubleTap","onDocumentClick","onDocumentMousedown","onDocumentMousemove","onKeydown","onDocumentKeydown"),this.model.content){this.node.append(this.model.content.clone(!0));var updateContent=this.model.content;_.defer(function(){var viewUpdaters=updateContent.find("[data-has-view-updater]");_.each(viewUpdaters,function(e){$(e).data("view-updater").update()})})}this.enable(),model.bind("state_update:input",this.onStateInput,this)},setSelected:function(ev){this.model.lastTarget=this.parent.model,this.select(!0)},moveToEmptyGap:function(ev){var emptyTargetAreas=this.parent.model.parent.getAvailableFillAreas();if(emptyTargetAreas.length){var emptyTarget=_.first(emptyTargetAreas);this.model.lastTarget=this.parent.model,emptyTarget.drop(this.model),this.parent.model.copyOnDrag||this.parent.model.undrop(this.model)}this.select(!1)},onDocumentClick:function(ev){this.node.find(ev.target).length||(this.select(!1),this.removeClickMoveEventListeners())},onDocumentMousedown:function(){document.addEventListener("click",this.onDocumentClick),document.addEventListener("mousemove",this.onDocumentMousemove)},onDocumentMousemove:function(){this.removeClickMoveEventListeners()},removeClickMoveEventListeners:function(){document.removeEventListener("click",this.onDocumentClick),document.removeEventListener("mousemove",this.onDocumentMousemove)},onDocumentKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.ESCAPE&&(this.node[0]===ev.target||key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER)||this.select(!1)},select:function(select){if(select!==this.model.selected){this.model.selected=select,this.node.toggleClass("selected",this.model.selected);var method=select?"addEventListener":"removeEventListener";document[method]("mousedown",this.onDocumentMousedown),document[method]("keydown",this.onDocumentKeydown)}},moveToEmptyPool:function(evt){var emptyPoolAreas=this.parent.model.parent.getAvailablePoolAreas();if(emptyPoolAreas.length){var emptyPool=_.first(emptyPoolAreas);this.model.lastTarget=this.parent.model,emptyPool.drop(this.model)}this.parent.model.copyOnDrag||this.parent.model.undrop(this.model),this.select(!1)},render:function(){if(this.model.gaptextaudio){var text=this.node.text();this.$(".content").prepend(this.createTTSAudio(text).render())}return this.node.find(".has_audio_attached").toggleClass("no-label",!this.node.text()),this.interaction.trigger("drag:render",this.node),this.node},onStateInput:function(){this.isLocked(this.parent.dragHolder)&&this.disable()},disable:function(){this.removeListeners(),this.node.toggleClass("ui-disabled",!0).removeAttr("tabindex")},enable:function(){this.parent.model.prefilled?this.node.addClass("prefilled"):(this.addListeners(),this.node.toggleClass("ui-disabled",!1).attr("tabindex",0))},removeListeners:function(){this.node.off("click",this.onClick),this.node.off("keydown",this.onKeydown),this.node.off("doubletap",this.onDoubleTap)},addListeners:function(){this.removeListeners();var hammer=new Hammer.Manager(this.node[0],{}),doubleTap=new Hammer.Tap({event:"doubletap",taps:2});hammer.add(doubleTap),this.node.on("click",this.onClick),this.node.on("keydown",this.onKeydown),!this.parent.isPoolArea&&this.model.isTapTarget()&&this.node.on("doubletap",this.onDoubleTap)},onClick:function(){this.activate()},onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.activate()},activate:function(){this.parent.isPoolArea?this.model.isTapTarget()?this.setSelected():(this.moveToEmptyGap(),this.model.dropAudio&&(a5.service.media.pauseAllExcept(this.model.dropAudio),this.model.dropAudio.play())):this.model.isTapTarget()?this.setSelected():this.moveToEmptyPool()},onDoubleTap:function(){this.moveToEmptyPool()},createTTSAudio:function(text){return new a5.views.TTS_Player(text)},contentSize:function(){return this.node.naturalSize()},setSize:function(w,h,noPadding){var padx=0,pady=0;noPadding||(padx=this.node.outerWidth()-this.node.width(),pady=this.node.outerHeight()-this.node.height()),this.node.css({minWidth:w-padx,minHeight:h-pady})}},a5.views.interaction.BaseView.extend("a5.views.interaction.TileElement"),a5.view.Video={videoTemplate:"video_widget",inlineTranscriptTemplate:"media_transcript",init:function(parameters){parameters=parameters||{},this.layout=parameters.layout,this.$subtitles=$("<div subtitles-wrapper></div>").html(parameters.subtitles),this.$transcript=$("<div transcript-wrapper></div>").html(parameters.transcript),this.ref=parameters.ref,this.$video=$(this.layout.getTemplate(this.videoTemplate)),this.$inlineTranscript=$(this.layout.getTemplate(this.inlineTranscriptTemplate)),this.$inlineTranscript.length?this.$el=this.$video.wrap('<div class="transcript-wrap video"></div>').append(this.$inlineTranscript):this.$el=this.$video},render:function(){var $target=this.$el.find(".the_video"),video=a5.service.media.video.create(this.ref,$target),dummyInteraction=new Obj;return a5.model_builder.audioVideoUtils.addVideoPlayerEvents(video,this.$el),a5.model_builder.audioVideoUtils.linkSubtitles(this.$subtitles||$(),dummyInteraction,this.$el,video),a5.model_builder.audioVideoUtils.linkTranscript(this.$transcript||$(),dummyInteraction,this.$el,video,this.$inlineTranscript),this.trigger("ready"),this.$el}},Obj.extend("a5.view.Video"),a5.view.Audio={audioTemplate:"audio_widget",inlineTranscriptTemplate:"media_transcript",init:function(parameters){parameters=parameters||{},this.layout=parameters.layout,this.$subtitles=$("<div subtitles-wrapper></div>").append(parameters.subtitles),this.$transcript=$("<div transcript-wrapper></div>").append(parameters.transcript),this.ref=parameters.ref,this.$audio=$(this.layout.getTemplate(this.audioTemplate)),this.$inlineTranscript=$(this.layout.getTemplate(this.inlineTranscriptTemplate)),this.$inlineTranscript.length?this.$el=this.$audio.wrap('<div class="transcript-wrap audio"></div>').append(this.$inlineTranscript):this.$el=this.$audio},render:function(){return this.$el.find(".the_audio").hide(),a5.service.media.audio.bind("ready",function(){var audio=a5.service.media.audio.create(this.ref),dummyInteraction=new Obj;this.$el.attr("data-playable-media",audio.uid),a5.model_builder.audioVideoUtils.addAudioPlayerEvents(audio,this.$el),a5.model_builder.audioVideoUtils.linkSubtitles(this.$subtitles||$(),dummyInteraction,this.$el,audio),a5.model_builder.audioVideoUtils.linkTranscript(this.$transcript||$(),dummyInteraction,this.$el,audio,this.$inlineTranscript),this.trigger("ready")}.bind(this)),this.$el}},Obj.extend("a5.view.Audio"),a5.view.BSModal={init:function(options){this.$el=$("<div>",{class:"modal hide fade",tabindex:"-1",role:"dialog"}),this.options=_.extend({backdrop:!0},options),_.bindAll(this,"_onClickClose","onHidden","onShown","onHide","onShow"),this.$el.on("click",".close",this._onClickClose),this.$el.on("hidden.bs.modal",this.onHidden),this.$el.on("shown.bs.modal",this.onShown),this.$el.on("hide.bs.modal",this.onHide),this.$el.on("show.bs.modal",this.onShow)},render:function(){return this.$el.html(a5.mainBuilder.layout.getTemplate(_.result(this,"template"))),this.renderContent(),this.trigger("render"),this.$el},renderContent:function(){},close:function(){this.$el.data("modal")&&this.$el.modal("hide")},open:function(){var backdrop=this.options.backdrop;this.$el.modal({backdrop:backdrop}),backdrop&&$(".modal-backdrop").insertAfter(this.$el)},toggle:function(){this.$el.hasClass("opened")?this.close():this.open()},_onClickClose:function(ev){ev.preventDefault(),this.close()},onHidden:function(){this.$el.removeClass("opened"),this.$el.addClass("closed"),this.trigger("close")},onShown:function(){this.$el.removeClass("closed"),this.$el.addClass("opened"),this.trigger("open")},onHide:function(){},onShow:function(){this.$el.removeClass("hide")}},Obj.extend("a5.view.BSModal"),$.fn.modal.Constructor.prototype.enforceFocus=function(){},a5.view.JQDialog={init:function(options){this.$el=$(a5.service.templates.render(this.template,this.serializeData())),this.options=_.extend({modal:!0},options),_.bindAll(this,"_onClickClose","onHidden","onShown","onHide"),this.$el.on("click",".close",this._onClickClose),this.$el.on("dialogbeforeclose",this.onHide),this.$el.on("dialogclose",this.onHidden),this.$el.on("dialogopen",this.onShown)},render:function(){return this.renderContent(),this.$el.find("a[data-button]").button(),this.$el.dialog({autoOpen:!1,modal:this.options.modal,dialogClass:this.options.dialogClass}),this.trigger("render"),this.$el},renderContent:function(){},serializeData:function(){},close:function(){this.$el.dialog("close")},open:function(){this.onShow(),this.$el.dialog("open")},toggle:function(){this.$el.dialog("isOpen")?this.close():this.open()},_onClickClose:function(ev){ev.preventDefault(),this.close()},onHidden:function(ev){this.$el.removeClass("opened"),this.$el.addClass("closed"),this.trigger("close")},onShown:function(ev){this.$el.removeClass("closed"),this.$el.addClass("opened"),this.trigger("open")},onShow:function(){},onHide:function(){}},Obj.extend("a5.view.JQDialog"),a5.view.Sidebar={init:function(options){this.$el=$("<div>",{class:"sidebar-panel closed"}),this.options=_.extend({},options),_.bindAll(this,"_onClickClose"),this.$el.on("click",".close",this._onClickClose)},render:function(){return this.$el.html(a5.mainBuilder.layout.getTemplate(_.result(this,"template"))),this.renderContent(),this.trigger("render"),this.$el},renderContent:function(){},close:function(){this.$el.removeClass("opened"),this.$el.addClass("closed"),this.trigger("close")},open:function(){this.$el.removeClass("closed"),this.$el.addClass("opened"),this.trigger("open")},toggle:function(){this.$el.hasClass("opened")?this.close():this.open()},_onClickClose:function(ev){ev.preventDefault(),this.close()}},Obj.extend("a5.view.Sidebar"),a5.view.Notebook={template:"a5.view.Notebook",exportTemplate:"a5.view.NotebookExport",defaultExportTemplate:"<h1>Notes</h1>{{#each pages as |page|}}<h2>Page {{page.number}}</h2><p>{{{page.note}}}</p>{{/each}}",init:function(model,options){this.model=model,this.vent=new Obj,this.notes=[],this.options=_.extend({offset:1,editorSettings:{}},options),this.$el=$("<div>",{class:"notebook-wrapper"}),_.bindAll(this,"_onClickPrev","_onClickNext"),this.$el.on("click",".btn-prev",this._onClickPrev),this.$el.on("click",".btn-next",this._onClickNext),this.vent.bind("page-number:click",this._onClickPageNumber,this),this.vent.bind("notebook-page:change",this._onNotebookPageChange,this),this.vent.bind("notebook-tab:click",this._onNotebookTabClick,this),this.vent.bind("notebook-tab:submit",this._onNotebookTabSubmit,this),this.vent.bind("note:change",this._onNoteChange,this),this.vent.bind("note:reset",this._onNoteReset,this)},render:function(){var html=a5.service.templates.render(this.template,{title:this.getTitle()});return this.$el.html(html),this.exportFormatSelect=new a5.view.ExportFormatSelect({$button:this.$el.find(".btn-export")}),this.exportFormatSelect.bind("submit",this._onExport,this),this.$tabs=this.$el.find(".notebook-tabs"),this.$notes=this.$el.find(".notebook-notes"),this.$pagination=this.$el.find(".notebook-pagination"),this.trigger("render"),this.$el},refresh:function(){this.render()},append:function(note){this.notes.push(note)},updateNotes:function(){var pages=this.getCurrentPages();_.each(pages,function(page,index){var note=new a5.view.NotebookNote({vent:this.vent,page:page,editorSettings:this.options.editorSettings}),tab=new a5.view.NotebookTab({vent:this.vent,page:page,note:note});0===index&&(tab.activate(),note.activate()),this.append({note:note,tab:tab}),this.$tabs.append(tab.$el),this.$notes.append(note.$el),tab.render(),note.render()},this),this.$pagination.find(".notebook__currentRange").html(this.getCurrentPageText()),this.flag()},flag:function(){this.$el.toggleClass("no-prev",!this.hasPrev()).toggleClass("no-next",!this.hasNext())},reportChange:function(hasChanges){this.hasChanges=!!hasChanges,this.$el.toggleClass("hasChanges",this.hasChanges),this.hasChanges&&this.save()},checkChanges:function(){this.hasChanges?this.save():this.reset()},focus:function(){_.first(this.notes).note.focus()},save:function(){this._eachNote("save"),this.reportChange(!1)},reset:function(){this._eachNote("reset")},setup:function(){this._eachNote("editable")},teardown:function(){this._eachNote("cleanup"),this.$tabs.empty(),this.$notes.empty(),this.exportFormatSelect.close(),this.notes=[],this.reportChange(!1)},exportTo:function(formats){var html=a5.service.templates.render(this.exportTemplate,{pages:this.getPagesWithNotes(),title:this.getTitle()},this.defaultExportTemplate);a5.service.converter.exportTo({formats:formats,input:html,output:"notes"})},goPrev:function(){this.goTo(this.page-this.getPagesPerScreen())},goNext:function(){this.goTo(this.page+this.getPagesPerScreen())},goFirst:function(){this.goTo(0)},goLast:function(){this.goTo(this.getTotalPages()-1)},goTo:function(pageIndex,silent){this.page=this.getCurrent(pageIndex),silent||this.vent.trigger("notebook-page:change")},hasNext:function(){return this.page<this.getTotalPages()-this.getPagesPerScreen()},hasPrev:function(){return this.page>0},getCurrentPages:function(){return this.getPages().slice(this.page,Math.min(this.page+this.getPagesPerScreen(),this.getTotalPages()))},getPagesWithNotes:function(){return _.filter(this.getPages(),function(page){return _.result(page,"hasNotes")})},getPages:function(){return[]},getTotalPages:function(){return 0},getPagesPerScreen:function(){return 1},getTitle:function(){return"Notes"},getCurrentPageText:function(){return""},getCurrent:function(pageIndex){var pagesPerScreen=this.getPagesPerScreen(),pageFrom=Math.floor(pageIndex/pagesPerScreen)*pagesPerScreen;return pageFrom=Math.min(Math.max(pageFrom,0),this.getTotalPages()-1)},printedPageToPageIndex:function(pageNumber){return pageNumber+this.options.offset-1},_onExport:function(formats){this.exportTo(formats)},_onNotebookPageChange:function(){this.checkChanges(),this.teardown(),this.updateNotes(),this.setup()},_onNotebookTabClick:function(tab){this.$tabs.find(".note-tab.active").removeClass("active"),this._eachNote("deactivate"),tab.activate(),tab.note.activate()},_onNotebookTabSubmit:function(pageNumber){var page=this.printedPageToPageIndex(pageNumber);this.goTo(page)},_onClickPrev:function(e){e.preventDefault(),this.goPrev()},_onClickNext:function(e){e.preventDefault(),this.goNext()},_onClickPageNumber:function(pageNumber){this.trigger("page-number:click",pageNumber)},_onNoteChange:function(){this.reportChange(!0)},_onNoteReset:function(){this.reportChange(!1)},_eachNote:function(handler,notes){notes=notes||_.pluck(this.notes,"note"),_.each(notes,function(note){return"string"==typeof handler?note[handler].apply(note):handler(note)})}},Obj.extend("a5.view.Notebook"),a5.view.NotebookTab={template:"a5.view.NotebookTab",init:function(parameters){this.vent=parameters.vent,this.page=parameters.page,this.note=parameters.note,this.$el=$("<li>",{class:"note-tab"}),_.bindAll(this,"_onClick","_onSubmit"),this.$el.on("click",this._onClick),this.$el.on("submit",".go-note-page",this._onSubmit)},render:function(){this.$el.addClass("note-tab-"+this.page.index);var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html(html),this.$el},serializeData:function(){var page=this.page.number;return page<0&&(page=""),{page:page}},activate:function(){this.$el.addClass("active")},deactivate:function(){this.$el.removeClass("active")},_onClick:function(e){e.preventDefault(),this.vent.trigger("notebook-tab:click",this)},_onSubmit:function(e){e.preventDefault();var $currentPage=this.$el.find(".current-note-page"),page=_.isNaN(parseInt($currentPage.val(),10))?0:parseInt($currentPage.val(),10);this.vent.trigger("notebook-tab:submit",page)}},Obj.extend("a5.view.NotebookTab"),a5.view.NotebookNote={init:function(parameters){this.page=parameters.page,this.vent=parameters.vent,this.editorSettings=parameters.editorSettings,this.$el=$("<div>",{class:"notebook-note"}),this.$el.addClass("note-"+this.page.index),this.$el.toggleClass("cover",this.page.cover),this.noteText=new a5.view.NotebookNoteText({text:this.page.note,vent:this.vent,parent:this,editorSettings:this.editorSettings}),this.pageNumber=new a5.view.NotebookNotePageNumber({number:this.page.number,vent:this.vent})},render:function(){return this.$el.empty(),this.$el.append(this.noteText.$el),this.$el.append(this.pageNumber.$el),this.noteText.render(),this.pageNumber.render(),this.$el},activate:function(){this.$el.addClass("active")},deactivate:function(){this.$el.removeClass("active")},editable:function(){this.noteText.editable()},cleanup:function(){this.noteText.cleanup()},reset:function(){this.noteText.reset()},save:function(){this.page.note=this.noteText.save()},focus:function(){this.noteText.focus()}},Obj.extend("a5.view.NotebookNote"),a5.view.NotebookNoteText={init:function(parameters){this.text=parameters.text,this.parent=parameters.parent,this.vent=parameters.vent,this.editorSettings=parameters.editorSettings,this.$el=$("<div>",{class:"note-text"}),_.bindAll(this,"compare","destroy","_onClick"),this.$el.on("click",this._onClick)},render:function(){return this.$el.html(this.text),this.$el},editable:function(){this.$el.attr("contenteditable",!0),this.editor=CKEDITOR.inline(this.$el[0],_.extend({toolbar:[["Bold","Italic","BulletedList"]],extraPlugins:"sharedspace",sharedSpaces:{top:this.parent.$el[0]}},this.editorSettings)),this.editor.on("key",this._onEditorKey,this),this.editor.on("change",this._onEditorChange,this)},cleanup:function(){_.defer(this.destroy)},destroy:function(){this.editor&&(this.editor.destroy(),this.editor=null)},reset:function(){this.cleanup(),this.$el.html(this.text),this.vent.trigger("note:reset")},compare:function(){this.text!==this.editor.getData()&&this.vent.trigger("note:change")},save:function(){return this.editor.getData()},focus:function(){this.$el.focus()},_onEditorChange:function(e){_.defer(this.compare)},_onEditorKey:function(e){_.defer(this.compare),e.stop(),e.data.domEvent.stopPropagation()},_onClick:function(e){var href=$(e.target).attr("href");href&&(e.preventDefault(),a5.mainBuilder.engine.invoke("open-link",href))}},Obj.extend("a5.view.NotebookNoteText"),a5.view.NotebookNotePageNumber={init:function(parameters){this.vent=parameters.vent,this.number=parameters.number,this.$el=$("<div>",{class:"page-number"}),_.bindAll(this,"_onClick"),this.$el.on("click",this._onClick)},render:function(){return this.number>0&&this.$el.html(this.number),this.$el},_onClick:function(e){e.preventDefault(),this.vent.trigger("page-number:click",this.number)}},Obj.extend("a5.view.NotebookNotePageNumber"),a5.view.LONotesDialog={template:"a5.view.dialog.Notebook",init:function(lo){this._super({dialogClass:"notes-popup"}),this.notes=new a5.view.LONotebook(lo),this.lo=lo,this.notes.bind("page-number:click",this._onClickPageNumber,this)},renderContent:function(){var $notes=this.notes.render();this.$el.html($notes)},onShown:function(){this.notes.setup(),this._super()},onHidden:function(){this.notes.checkChanges(),this._super()},onShow:function(){this.notes.teardown(),this.notes.goTo(0,!0),this.notes.updateNotes(),this._super()},onHide:function(){this.notes.teardown(),this._super()},_onClickPageNumber:function(){this.close()}},a5.view.JQDialog.extend("a5.view.LONotesDialog"),a5.view.LONotebook={init:function(model){this._super(model,{editorSettings:_.result(a5.dp.config,"loNotesEditor")})},getTitle:function(){return this.model.LOInfo.title},getPages:function(){return this.pages||(this.pages=[{note:this.model.note,index:0,number:1,cover:!1,hasNotes:!0}]),this.pages},getTotalPages:function(){return 1},getPagesPerScreen:function(){return 1},getCurrentPageText:function(){return"1"},save:function(){this._super(),this.model.updateNotes(this.pages[0].note),this.model.saveNotes()}},a5.view.Notebook.extend("a5.view.LONotebook"),a5.view.InteractionToolbar={init:function(model,parent){this._super(model,parent,$('<div class="toolbar"></div>')),this.views=[],
model.bind("reorder",_.bind(this.updateOrder,this))},updateOrder:function(){this.views=[],this.node.empty(),_.each(this.model.buttons,function(button){this._addButton(button)},this)},update:function(){_.each(this.model.buttons,function(button){_.includes(_.pluck(this.views,"model"),button)?button.callViews("update"):this._addButton(button)},this)},_addButton:function(button){var view=new a5.view.InteractionToolbarToggleButton(button);this.views.push(view),this.node.append(view.render()),view.update()}},a5.views.interaction.BaseView.extend("a5.view.InteractionToolbar"),a5.view.InteractionToolbarToggleButton={init:function(model,parent){this._super(model,parent,$('<div class="button toggle"></div>')),this.update()},update:function(){this.node.unbind(),this.model.isPressed()?this.node.addClass("activated"):this.node.removeClass("activated"),this.node.text(this.model.label),this.node.css(this.model.getCss()),this.node.addClass(this.model.getClasses().join(" ")),this.model.title&&this.node.attr("title",this.model.title),this.model.tts_audio&&(this.tts_player=new a5.views.TTS_Player(this.model.label),this.tts_player.render().prependTo(this.node));var model=this.model;this.node.click(function(e){model.click()}),this.node.on("keydown",function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||model.click()}),this.model.isEnable()?this.node.removeClass("disabled"):(this.node.removeClass("activated"),this.node.addClass("disabled"))}},a5.views.interaction.BaseView.extend("a5.view.InteractionToolbarToggleButton"),a5.views.MultiselectCheck={template:"a5.view.multiselectCheck",listElementSelector:".multiselectCheckList",init:function(choices){_.bindAll(this,"onSelectionChange"),this.choices=choices,this.$node=$(a5.service.templates.render(this.template,{})),this.choicesViews=_.map(this.choices,function(choice){return new a5.views.MultiselectCheckChoice(choice)}),this.bindEvents()},bindEvents:function(){_.each(this.choicesViews,function(choiceView){choiceView.bind("changed",this.onSelectionChange)},this)},onSelectionChange:function(data,selected){this.trigger("change",this.value())},render:function(){return this.$node.find(this.listElementSelector).empty(),this.$node.append(_.invoke(this.choicesViews,"render")),this.$node},value:function(){return _.chain(this.choicesViews).where({selected:!0}).pluck("data").value()}},Obj.extend("a5.views.MultiselectCheck"),a5.views.MultiselectCheckChoice={template:"a5.view.multiselectCheckChoice",checkboxElementName:'input[type="checkbox"].formCheck__input',init:function(data){this.data=data,this.$node=$(a5.service.templates.render(this.template,{data:this.data})),_.bindAll(this,"onToggleSelect"),this.bindEvents()},getCheckboxElement:function(){return this.$node.find(this.checkboxElementName)},render:function(){return this.$node},bindEvents:function(){this.getCheckboxElement().on("click",this.onToggleSelect)},onToggleSelect:function(el){this.selected=el.currentTarget.checked,this.trigger("changed",this.data,this.selected)}},Obj.extend("a5.views.MultiselectCheckChoice"),a5.views.PollBaseView={CHOICE_HTML:'<div class="choice"></div>',init:function(model,parent){this._super(model,parent,$(this.NODE_HTML)),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("update",this.onUpdate,this),_.bindAll(this,"onClick")},render:function(){return this._super(),_.each(this.model.ids,function(id,i){this.node.append($(this.CHOICE_HTML).attr("id",id).text(this.model.options[i]))},this),this.bindEvents(),this.node},bindEvents:function(){this.node.children().on("click",this.onClick)},unbindEvents:function(){this.node.children().off("click",this.onClick)},onStateUpdate:function(){this.unbindEvents(),"input"===this.model.state&&this.bindEvents()},onClick:function(ev){var $target=$(ev.target),id=$target.attr("id");$target.is(".selected")?(this.model.deselect(id),this.deselect(id)):(this.model.select(id),this.select(id))},onUpdate:function(){this.node.children().removeClass("selected"),_.each(this.model.selected,function(id){this.select(id)},this)},select:function(id){this.node.find("#"+id).addClass("selected")},deselect:function(id){this.node.find("#"+id).removeClass("selected")}},a5.views.interaction.BaseView.extend("a5.views.PollBaseView"),a5.views.RadioPoll={NODE_HTML:'<div class="poll single"></div>',select:function(id){this.node.children().removeClass("selected"),this._super(id)}},a5.views.PollBaseView.extend("a5.views.RadioPoll"),a5.views.CheckboxPoll={NODE_HTML:'<div class="poll multiple"></div>'},a5.views.PollBaseView.extend("a5.views.CheckboxPoll"),a5.views.PollsetBaseView={render:function(){var head=_.reduce(this.model.sets,function(memo,set){return memo.add($("<th></th>",{text:set}))},$("<th></th>")).wrapAll("<thead><tr></tr></thead>").eq(0).parent().parent(),body=_.reduce(this.model.ids,function(memo,id,i){return memo.add(_.reduce(this.model.setIds,function(memo,setId){return memo.add($(this.CHOICE_HTML).attr("id",setId+"-"+id).wrap("<td></td>").parent())},$("<th></th>",{text:this.model.options[i]}),this).wrapAll("<tr></tr>").eq(0).parent())},$([]),this).wrapAll("<tbody></tbody>").eq(0).parent();return this.node.append(head,body),this.bindEvents(),this.node},bindEvents:function(){this.node.find(".choice").on("click",this.onClick)},unbindEvents:function(){this.node.find(".choice").off("click",this.onClick)}},a5.views.PollBaseView.extend("a5.views.PollsetBaseView"),a5.views.RadiosetPoll={NODE_HTML:'<table class="pollset single"></table>',select:function(id){this.node.find("#"+id).parent().parent().find(".choice").removeClass("selected"),this._super(id)}},a5.views.PollsetBaseView.extend("a5.views.RadiosetPoll"),a5.views.CheckboxsetPoll={NODE_HTML:'<table class="pollset multiple"></table>'},a5.views.PollsetBaseView.extend("a5.views.CheckboxsetPoll"),a5.views.Toolbar={DEFAULT_TEMPLATE:'<div class="buttons"></div>',init:function(parameters){this.lo=parameters.lo,this.interaction=parameters.interaction,this.$node=parameters.$el,this.buttons=[],this.buttonTemplate=a5.mainBuilder.layout.getTemplate("toolbar_buttons")||this.DEFAULT_TEMPLATE},reset:function(){_.each(this.buttons,function(button){button.reset&&button.reset()},this)},clear:function(){this.$node.empty().html(this.buttonTemplate)},addButton:function(button){this.buttons.push(button)},render:function(){this.clear();var container=this.$node.children(".buttons");_.each(this.buttons,function(button){var parent;this.interaction.toolbarZone.length>0?parent=container:button.parentSelector?(parent=container.children(button.parentSelector),0===parent.length&&(parent=container)):parent=container,button.render(parent)},this)}},Obj.extend("a5.views.Toolbar"),a5.views.Toolbar.Button={init:function(){this.$node=$(window.a5.mainBuilder.layout.getTemplate(this.template))},reset:function(){}},Obj.extend("a5.views.Toolbar.Button"),a5.views.Toolbar.TrayButton={init:function(){this.$content=$(window.a5.mainBuilder.layout.getTemplate(this.contentTemplate)),this._super()},render:function($parent){var $node=this.$node,$content=this.$content;$node.off("click").on("click",_.bind(function(){var show=!$node.hasClass("tray_open");$parent.children(".tray_open").removeClass("tray_open"),$parent.siblings(".toolbar_tray").not(".no-slide").not($content).slideUp(),$parent.siblings(".toolbar_tray.no-slide").not($content).hide();var duration=$content.hasClass("no-slide")?{duration:0}:{};show?($node.addClass("tray_open"),$content.slideDown($.extend({complete:_.bind(this.onShow,this)},duration))):$content.slideUp($.extend({complete:_.bind(this.onHide,this)},duration))},this)),$node.removeClass("tray_open"),this.$content.hide(),$parent.append($node),$parent.after($content)}},a5.views.Toolbar.Button.extend("a5.views.Toolbar.TrayButton"),a5.views.Toolbar.DictionaryButton={parentSelector:"#dictionary",template:"dictionary_searchbar",render:function($parent){var $node=this.$node;$node.click(function(){$node.hasClass("dictionary_searchbar_active")||($node.find(".hideonload").show($node.is(".no-slide")?void 0:"slide"),$node.addClass("dictionary_searchbar_active"))}),$node.delegate("a","click",function(e){e.preventDefault(),e.stopPropagation(),$node.find(".hideonload").hide($node.is(".no-slide")?void 0:"slide"),$node.removeClass("dictionary_searchbar_active")}),$parent.append($node)}},a5.views.Toolbar.Button.extend("a5.views.Toolbar.DictionaryButton"),a5.views.Toolbar.NotesButton={parentSelector:"#notes",template:"notes_area",contentTemplate:"notes_box",init:function(notes,interaction){this._super(),this.noteView=new a5.views.Toolbar.Notes(notes,a5.mainBuilder,interaction,this.$content)},render:function($parent){this._super($parent),this.noteView.render()},reset:function(){this.noteView.unbindEvents()},onShow:function(){this.trigger("notes:show")},onHide:function(){this.trigger("notes:hide")}},a5.views.Toolbar.TrayButton.extend("a5.views.Toolbar.NotesButton"),a5.views.Toolbar.LanguageSwitcher={template:"language_switcher",lang_label:'<span class="label language_label"></span>',init:function(interaction){this._super(),this.interaction=interaction,interaction.bind("language:change",this.onLangChange,this),this._original_language_label=this.$node.find(".label").text()},bindEvents:function(){this.$node.on("click",_.bind(this.onClick,this)),this.dropdown&&this.dropdown.node.remove(),this.dropdown=new a5.views.Toolbar.LanguageSwitcherDropdown(this.interaction),this.dropdown.hide(),this.$node.append(this.dropdown.render())},onLangChange:function(lang){var label=this.interaction.getLanguageLabel(lang);label?this.$node.find(".label").html(label):this.$node.find(".label").html(this._original_language_label)},onClick:function(){this.dropdown.toggle()},render:function($parent){this.$node.appendTo($parent),this.bindEvents()},reset:function(){}},a5.views.Toolbar.Button.extend("a5.views.Toolbar.LanguageSwitcher"),a5.views.Toolbar.LanguageSwitcherDropdown={NODE_TEMPLATE:"<div class='dropdown-slider'></div>",ELEMENT_TEMPLATE:"<a href='#' class='ddm' tabindex='-1'></a>",init:function(interaction){this._super({},null,$(this.NODE_TEMPLATE)),this.interaction=interaction,_.each(interaction.getRegisteredLanguages(),function(lang){var $element=$(this.ELEMENT_TEMPLATE);$element.html(lang),$element.attr("data-lang",lang),lang===interaction.getLanguage()&&$element.addClass("active"),$element.click(_.bind(this.setLanguage,this)),this.node.append($element)},this),interaction.bind("language:change",_.bind(this.onLangChange,this))},onLangChange:function(lang){this.node.find(".active").removeClass("active"),this.node.find("a[data-lang="+lang+"]").addClass("active")},toggle:function(){this.node.slideToggle()},hide:function(){this.node.hide()},show:function(){this.node.show(!0)},setLanguage:function(e){this.interaction.setLanguage($(e.target).attr("data-lang"))}},a5.views.interaction.BaseView.extend("a5.views.Toolbar.LanguageSwitcherDropdown"),a5.views.Toolbar.Notes={init:function(model,lo,interaction,$root){this.noteModel=model,this.lo=lo,this.$root=$root,this.interaction=interaction,_.isUndefined(interaction.xml)?this.loTitle="Notes":this.loTitle=interaction.xml.title,this._hideAllNotesControls(),this.bindEvents()},reset:function(){this.unbindEvents()},bindEvents:function(){this.noteModel.bind("add",this.add,this),this.noteModel.bind("update",this.update,this),this.noteModel.bind("remove",this.remove,this)},unbindEvents:function(){this.noteModel.unbind("add",this.add),this.noteModel.unbind("update",this.update),this.noteModel.unbind("remove",this.remove)},render:function(){this._uiEvents(),this._removeAllQuick(),_.each(this.noteModel.notes,function(n,index){this.add(index),this.update(index)},this),this.noteModel.notes.length>0&&this.$root.removeClass("no-notes")},_uiEvents:function(){this.find(".add_new_note").off("click").on("click",_.bind(function(){this.noteModel.addNote()},this)),this.find(".send_all_notes").off("click").on("click",_.bind(this._sendAllNotes,this)),this.find(".erase_all_notes").off("click").on("click",_.bind(function(){this.find(".erase_all_notes").addClass("erase_all_notes_selected"),this.find(".erase_all_check").show()},this)),this.find(".erase_all_yes").off("click").on("click",_.bind(function(){$(".erase_all_notes").removeClass("erase_all_notes_selected"),$(".erase_all_check").hide(),this.noteModel.removeAll()},this)),this.find(".erase_all_no").off("click").on("click",_.bind(function(){$(".erase_all_notes").removeClass("erase_all_notes_selected"),$(".erase_all_check").hide()},this)),this.find(".print_all_notes").off("click").on("click",_.bind(function(){var printPopup=window.open("","Print Notes Listing","menubar=0,location=0,height=400,width=500");try{printPopup.history.pushState(null,null,window.location.href)}catch(e){logger.error(e)}var html="<h1>"+this.loTitle+"</h1><h2>Notes List</h2><hr/><dl>";_.each(this.noteModel.notes,function(n,index){var date=new Date(n.date);html+="<dt>"+n.title+"</dt>",html+="<dd>"+n.text.replace(/\r\n|\r|\n/gm,"<br/>")+"<br/><i>"+date+"</i></dd>"}),html+="</dl>",printPopup.document.body.innerHTML=html,printPopup.print()},this))},_addAllNotesControls:function(){this.find(".send_all_notes").show(),this.find(".print_all_notes").show(),this.find(".erase_all_notes").show(),this.find(".no_notes_message").hide()},_hideAllNotesControls:function(){this.find(".send_all_notes").hide(),this.find(".print_all_notes").hide(),this.find(".erase_all_notes").hide(),this.find(".no_notes_message").show()},_sendAllNotes:function(){var body="Notes listing%0D%0A%0D%0A";_.each(this.noteModel.notes,function(n,index){var date=new Date(n.date);body+=date+" : "+n.title+"%0D%0A---------------------------------------------------------------------------------------------%0D%0A",body+=n.text.replace(/\r\n|\r|\n/gm,"%0D%0A")+"%0D%0A---------------------------------------------------------------------------------------------%0D%0A%0D%0A"},this);var title="Notes from "+self.loTitle;window.location.href="mailto:?body="+body+"&subject="+title},_indexOf:function($note){return this.find(".the_notes").children(".a_note").length-1-$note.index()},_removeAllQuick:function(){this.find(".the_notes").children(".a_note").remove()},find:function(selector){return this.$root.find(selector)},add:function(index){var $note=$(this.lo.layout.getTemplate("one_note")),$textarea=$note.find(".note_text_edit"),$heading=$note.find(".note_heading_input"),$options=$note.find(".note_options"),$menu=$note.find(".a_note_menu"),$erase=$note.find(".erase_note"),$print=$note.find(".print_note"),$send=$note.find(".send_note");this.find(".the_notes").prepend($note),$textarea.off("keyup").on("keyup",_.bind(function(){var caretPosition={selectionStart:$textarea.prop("selectionStart"),selectionEnd:$textarea.prop("selectionEnd")};this.noteModel.notes[this._indexOf($note)].setText($textarea.val()),$textarea.prop(caretPosition)},this)),$heading.off("keyup").on("keyup",_.bind(function(){this.noteModel.notes[this._indexOf($note)].setTitle($heading.val(),!0)},this)),$options.off("click").on("click",_.bind(function(){$options.toggleClass("note_options_selected").hasClass("note_options_selected")?$menu.slideDown():$menu.slideUp()},this)),$erase.off("click").on("click",_.bind(function(){this.noteModel.notes[this._indexOf($note)].remove()},this)),$print.off("click").on("click",_.bind(function(){var note=this.noteModel.notes[this._indexOf($note)],printPopup=window.open("","Print Note "+(index+1),"menubar=0,location=0,height=200,width=500");try{printPopup.history.pushState(null,null,window.location.href)}catch(e){logger.error(e)}var html="<h1>"+this.loTitle+"</h1><h2>"+note.title+"</h2><hr/>",date=new Date(note.date);html+="<p>"+note.text.replace(/\r\n|\r|\n/gm,"<br/>")+"<br/><i>"+date+"</i></p>",printPopup.document.body.innerHTML=html,printPopup.print()},this)),$send.off("click").on("click",_.bind(function(){var note=this.noteModel.notes[this._indexOf($note)];window.location.href="mailto:?body="+note.text.replace(/\r\n|\r|\n/gm,"%0D%0A")+"&subject="+note.title},this)),0==index&&this._addAllNotesControls()},update:function(index){var note=this.noteModel.notes[index],$notes=this.find(".the_notes").children(".a_note"),$note=$($notes[$notes.length-index-1]);$note.find(".note_heading").text(note.title),$note.find(".note_heading_input").val(note.title);var date=new Date(note.date);$note.find(".note_text_edit").val(note.text),$note.find(".saveDate").text(""+date)},remove:function(index){var notes=this.find(".the_notes").children(".a_note");$(notes[notes.length-index-1]).remove(),0==this.noteModel.notes.length&&(this._hideAllNotesControls(),this.$root.addClass("no-notes"))}},a5.views.interaction.BaseView.extend("a5.views.Toolbar.Notes"),a5.views.Toolbar.SoundButton={parentSelector:"#soundchart",template:"phoneme_button",contentTemplate:"phoneme_button_box",render:function($parent){this.$content.delegate(".tile","click",function(){var $tile=$(this),str=$tile.prop("class"),pos_1=str.indexOf("tile_"),pos_2=str.indexOf(" ",pos_1);str.substring(pos_1+5,pos_2)}),this._super($parent)}},a5.views.Toolbar.TrayButton.extend("a5.views.Toolbar.SoundButton"),a5.views.Toolbar.DropDownItem={parentSelector:"#attachments",template:"a5.view.DropDownItem",init:function(label,attachment){this.label=label,this.attachment=attachment,this.main=!1},render:function($parent){var html=a5.service.templates.render(this.template,{main:this.main,label:this.label});this.$node=$(html),this.$node.toggleClass("active",this.attachment.isOpen()),this.$node.addClass("attachmentButton--type"+_.str.capitalize(_.str.camelize(this.attachment.customType))),this.$node.addClass("attachmentButton--target"+_.str.capitalize(_.str.camelize(this.attachment.options.target))),this.$node.attr("aria-controls",this.attachment.id),this.bindEvents(),$parent.append(this.$node)},bindEvents:function(){this.$node.on("click",_.bind(this._onClick,this)),this.attachment.bind("open",this._onAttachmentOpened,this),this.attachment.bind("close",this._onAttachmentClosed,this)},_onClick:function(event){event.preventDefault(),this.$node.hasClass("active")?this._close():this._open()},_open:function(){this.attachment.open()},_close:function(){this.attachment.close()},_onAttachmentOpened:function(){this.$node.addClass("active")},_onAttachmentClosed:function(){this.$node.removeClass("active")}},Obj.extend("a5.views.Toolbar.DropDownItem"),a5.views.Toolbar.DropDownButton={parentSelector:"#attachments",template:"a5.view.DropDownButton",init:function(label){this.label=label,this.items=[]},addItem:function(label,attachment){this.items.push(new a5.views.Toolbar.DropDownItem(label,attachment))},render:function($parent){var html=a5.service.templates.render(this.template,{label:this.label});this.$node=$(html);var $button=this.$node.find(".act_head_button"),$toggle=this.$node.find(".toggle"),lastClick=!1;$button.addClass("attachmentDropdown--type"+_.str.capitalize(_.str.camelize(this.label))),$button.on("mousedown touchstart",function(e){lastClick=!0}),$button.on("click",function(e){e.preventDefault(),e.stopPropagation(),$toggle.hasClass("active")?($popup.delay(100).slideUp(function(){$button.removeClass("active")}),$toggle.removeClass("active")):($popup.slideDown("fast"),$toggle.addClass("active"),$button.addClass("active"))}),$button.focus(function(e){e.stopPropagation(),lastClick||$toggle.hasClass("active")||($popup.slideDown("fast"),$toggle.addClass("active"),$button.addClass("active")),lastClick=!1}),$button.blur(function(e){e.stopPropagation(),$toggle.hasClass("active")&&($popup.delay(100).slideUp(function(){$button.removeClass("active")}),$toggle.removeClass("active"))});var $popup=this.$node.find(".dropdown-slider");_.each(this.items,function(item){item.render($popup)},this),$popup.css("minwidth","130px"),_.defer(function(){$popup.hide()}),$parent.append(this.$node)}},Obj.extend("a5.views.Toolbar.DropDownButton"),a5.views.Toolbar.ModelTextButton={parentSelector:"#attachments",render:function($parent){if(1==this.items.length){var item=this.items[0];item.label=this.label,item.main=!0,item.render($parent)}else this._super($parent)}},a5.views.Toolbar.DropDownButton.extend("a5.views.Toolbar.ModelTextButton"),a5.views.Toolbar.PrintButton={parentSelector:"#print",init:function(){if(window.matchMedia){window.matchMedia("print").addListener(_.bind(function(mql){mql.matches&&$(window).resize()},this))}$(window).on("beforeprint",function(ev){$(window).resize()})},render:function($parent){this.$node=$('<a href="#" class="act_head_button"><span class="label">Print</span></a>'),this.$node.click(function(){window.print()}),$parent.append(this.$node)}},Obj.extend("a5.views.Toolbar.PrintButton"),a5.views.Selectable={init:function(model,prefill,hideCheckboxes){this._super(model,null,$('<div class="choice_interaction"></div>')),this.prefill=prefill,this.hideCheckboxes=hideCheckboxes,this.children=[],_.each(this.model.choices,function(choice){var view=this.createViewFor(choice);this.append(view)},this)},append:function(child){this.children.push(child)},createViewFor:function(model){},render:function(){var html=a5.service.templates.render(this.template),$html=$(html);return this.node.html($html.html()),this.node.copyAttributes($html),this.node.append(_.invoke(this.children,"render")),this.node.addClass("algn-"+this.model.alignment.substr(0,3)),this.prefill&&this.node.addClass("prefill"),this.hideCheckboxes?this.node.addClass("no-input"):this.node.addClass("has-input"),this.node}},a5.views.interaction.BaseView.extend("a5.views.Selectable"),a5.views.SelectableChoiceView={DEFAULT_TEMPLATE:'<span class="item"></span>',init:function(model,parent){this._super(model,parent,$('<div class="input-'+this.type+' no-input"></div>'));var html=a5.service.templates.render(this.template,{},"<div></div>"),$html=$(html);this.node.html($html.html()),this.node.copyAttributes($html),this.nodeId="input-"+this.type+"-s"+this.model.interaction.index+"-"+_.str.slugify(this.model.value),this.node.attr("id",this.nodeId),this.contentNode=$(a5.service.templates.render(this.contentTemplate,{showInColumns:this.showInColumns,inputId:this.nodeId},this.DEFAULT_TEMPLATE)),this.node.append(this.contentNode),this.node.addClass("input-"+this.type+"-choice-"+_.str.slugify(this.model.value)),this.model.parent.gaptextaudio&&this.addTTSPlayer()},render:function(){this._super(),this.node.toggleClass("has-image",!!this.node.find("img").length),this.node.toggleClass("no-label",!this.node.text())},addInput:function(){return this.input=$('<input aria-hidden="true" type="'+this.type+'" />'),this.node.prepend(this.input).removeClass("no-input").addClass("has-input"),this},addTTSPlayer:function(){this.tts_player=new a5.views.TTS_Player($(this.model.content).text()),$(this.node).prepend(this.tts_player.render())},updateSelected:function(){var checkedClass="input-"+this.type+"-checked",hoverClass="input-"+this.type+"-hover";this.input&&this.input.attr("checked",this.model.isSelectedAnswer()),this.model.isSelectedAnswer()?(this.node.addClass(checkedClass),this.input||this.node.addClass("clickedanswer"),this.node.attr("aria-checked",!0)):(this.node.removeClass("clickedanswer"),this.node.removeClass(checkedClass),this.node.attr("aria-checked",!1)),this.node.unbind();var self=this;return"input"===this.model.parent.state&&"answers"!==this.model.state?this.model.tryAgainIsFrozen&&this.isLocked()||(this.node.click(function(){self.model.clicked()}),this.node.on("keydown",function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||self.model.clicked()}),this.node.mouseover(function(){self.node.addClass(hoverClass),self.input||self.node.addClass("input-noradio-hover")}),this.node.mouseout(function(){self.node.removeClass(hoverClass),self.node.removeClass("input-noradio-hover")})):"answers"!==this.model.parent.state&&"answers"!==this.model.state||this.model.correct&&(_.isUndefined(this.input)||this.input.attr("checked",!0)),this.input&&this.input.attr("disabled","input"!==this.model.parent.state||"answers"===this.model.state),this}},a5.views.interaction.BaseView.extend("a5.views.SelectableChoiceView"),a5.views.Radiobutton={init:function(model,prefill,hideRadios){this._super(model,prefill,hideRadios),this.node.attr("role","radiogroup"),this.firstRadioButton=_.first(this.children),this.lastRadioButton=_.last(this.children),this.firstRadioButton.node.attr("tabindex",0),_.bindAll(this,"onChoiceBlur"),this.node.on("focusout",this.onChoiceBlur)},selectChoice:function(choice){_.chain(this.children).without(choice).invoke("unselect"),choice.model.enableToggle?choice.toggle():choice.select()},selectPreviousChoice:function(current){var index,prev;current===this.firstRadioButton?prev=this.lastRadioButton:(index=this.children.indexOf(current),prev=this.children[index-1]),current.unselect(),prev.select(),prev.node.focus()},selectNextChoice:function(current){var index,next;current===this.lastRadioButton?next=this.firstRadioButton:(index=this.children.indexOf(current),next=this.children[index+1]),current.unselect(),next.select(),next.node.focus()},onChoiceBlur:function(){0===this.node.find("[tabindex=0]").length&&this.firstRadioButton.node.attr("tabindex",0)}},a5.views.Selectable.extend("a5.views.Radiobutton"),a5.views.RadiobuttonChoiceView={type:"radio",init:function(model,parent){this._super(model,parent),this.radioGroup=parent,_.bindAll(this,"onFocus","onBlur","onKeydown","onClick","onMouseOver","onMouseOut"),this.node.attr("role","radio"),this.unselect()},toggle:function(){this.selected?this.unselect():this.select()},select:function(){this.node.attr("tabindex",0),this.node.attr("aria-checked",!0),this.selected=!0},unselect:function(){this.node.attr("tabindex",-1),this.node.attr("aria-checked",!1),this.selected=!1},enable:function(){this.unbindEvents(),this.bindEvents()},disable:function(){this.unbindEvents()},unbindEvents:function(){this.node.off("focus",this.onFocus),this.node.off("blur",this.onBlur),this.node.off("keydown",this.onKeydown),this.node.off("click",this.onClick),this.node.off("mouseover",this.onMouseOver),this.node.off("mouseout",this.onMouseOut)},bindEvents:function(){this.node.on("focus",this.onFocus),this.node.on("blur",this.onBlur),this.node.on("keydown",this.onKeydown),this.node.on("click",this.onClick),this.node.on("mouseover",this.onMouseOver),this.node.on("mouseout",this.onMouseOut)},onFocus:function(e){},onBlur:function(e){},onKeydown:function(e){var KEYS=(e.currentTarget,a5.utils.keyCodes);switch(e.keyCode){case KEYS.SPACE:case KEYS.ENTER:this.radioGroup.selectChoice(this),this.node.focus();break;case KEYS.UP:this.radioGroup.selectPreviousChoice(this);break;case KEYS.DOWN:this.radioGroup.selectNextChoice(this);break;case KEYS.LEFT:this.radioGroup.selectPreviousChoice(this);break;case KEYS.RIGHT:this.radioGroup.selectNextChoice(this);break;default:return}e.stopPropagation(),e.preventDefault()},onClick:function(e){this.radioGroup.selectChoice(this),this.node.focus()},onMouseOver:function(e){},onMouseOut:function(e){}},a5.views.SelectableChoiceView.extend("a5.views.RadiobuttonChoiceView"),a5.views.NoValidateRadiobuttonChoiceView={type:"radio",init:function(model,parent){this._super(model,parent),this.model.parent.bind("change",this.onChange,this),this.model.parent.bind("state_update",this.onStateUpdate,this)},addInput:function(){return this._super(),this.node.attr("tabindex","0"),this},onChange:function(){this.updateSelected()},onStateUpdate:function(){this.updateSelected()}},a5.views.SelectableChoiceView.extend("a5.views.NoValidateRadiobuttonChoiceView"),a5.views.Checkbox={init:function(model,prefill,hideCheckboxes){this._super(model,prefill,hideCheckboxes),this.node.attr("role","group")}},a5.views.Selectable.extend("a5.views.Checkbox"),a5.views.CheckboxChoiceView={type:"checkbox",init:function(model,parent){this._super(model,parent),_.bindAll(this,"onFocus","onBlur","onKeydown","onClick","onMouseOver","onMouseOut"),this.node.attr("role","checkbox"),this.node.attr("tabindex",0),this.unselect()},toggle:function(){this.selected?this.unselect():this.select()},select:function(){this.node.attr("aria-checked",!0),this.selected=!0},unselect:function(){this.node.attr("aria-checked",!1),this.selected=!1},enable:function(){this.unbindEvents(),this.bindEvents()},disable:function(){this.unbindEvents()},unbindEvents:function(){this.node.off("focus",this.onFocus),this.node.off("blur",this.onBlur),this.node.off("keydown",this.onKeydown),this.node.off("click",this.onClick),this.node.off("mouseover",this.onMouseOver),this.node.off("mouseout",this.onMouseOut)},bindEvents:function(){this.node.on("focus",this.onFocus),this.node.on("blur",this.onBlur),this.node.on("keydown",this.onKeydown),this.node.on("click",this.onClick),this.node.on("mouseover",this.onMouseOver),this.node.on("mouseout",this.onMouseOut)},onFocus:function(e){},onBlur:function(e){},onKeydown:function(e){var KEYS=(e.currentTarget,a5.utils.keyCodes);switch(e.keyCode){case KEYS.SPACE:case KEYS.ENTER:this.toggle(),this.node.focus();break;default:return}e.stopPropagation(),e.preventDefault()},onClick:function(e){this.toggle(),this.node.focus()},onMouseOver:function(e){},onMouseOut:function(e){}},a5.views.SelectableChoiceView.extend("a5.views.CheckboxChoiceView"),a5.views.NoValidateCheckboxChoiceView={type:"checkbox",init:function(model,parent){this._super(model,parent),this.model.bind("change",this.onChange,this),this.model.parent.bind("state_update",this.onStateUpdate,this)},onChange:function(){this.updateSelected()},onStateUpdate:function(){this.updateSelected()}},a5.views.SelectableChoiceView.extend("a5.views.NoValidateCheckboxChoiceView"),a5.views.SaveButton={init:function(interaction,imageId){this.interaction=interaction,this.imageId=imageId},render:function(){return this.$node=$('<a href="#"></a>'),this.imageId?(this.$node.addClass("save-interaction-image"),this.$node.html('<img src="'+a5_makeMediaURL(this.imageId)+'"/>')):(this.$node.addClass("save-interaction"),this.$node.text("Save")),this.$node.click(function(e){e.preventDefault(),this.interaction.store(!0)}.bindTo(this)),this}},Obj.extend("a5.views.SaveButton"),a5.views.TinyPlayer={NODE_TEMPLATE:"<span class='playbutton'></span>",init:function(){this.$node=$(this.NODE_TEMPLATE)},render:function(){return this.bindEvents(),this.$node},bindEvents:function(){this.$node.on("mousedown",this.onMouseDown.bindTo(this)),this.$node.on("click",this.onClick.bindTo(this))},onMouseDown:function(e){return this.playing?this.pause():this.play(),!1},onClick:function(e){return!1},pause:function(){this.playing=!1,this.trigger("pause"),this.$node.removeClass("playing")},play:function(){this.playing=!0,this.trigger("play"),this.$node.addClass("playing")}},Obj.extend("a5.views.TinyPlayer"),a5.views.TriggerWord={init:function(model,parent,interaction){this._super(model,parent,$('<span class="trigger-word">')),this.node.html(model.content),this.triggerTexts=[],this.visible=this.model.displayword,this.interaction=interaction},addTrigText:function(node){this.model.displayword&&node.show(),this.triggerTexts.push(node)},bindEvents:function(){this.node.on("click",_.bind(function(e){e.preventDefault(),this.toggleTexts(),this.interaction.trigger("interaction:trigword:clicked",this)},this)),this.interaction.bind("interaction:trigword:clicked",function(view){this!==view&&this.hideTexts(!0)},this)},_hide:function(){this.visible=!1,this.node.removeClass("current")},_show:function(){this.visible=!0,this.node.addClass("current")},toggleTexts:function(){this.visible&&!this.model.showonce?this.hideTexts():this.showTexts()},hideTexts:function(from_event){_.each(this.triggerTexts,function(text){this.model.simultaneous&&from_event||($(text).hide(),this._hide(),a5.service.media.pause($(text)))},this)},showTexts:function(){_.each(this.triggerTexts,function(text){$(text).show(),this._show()},this)},render:function(){var node=this._super();return this.model.displayword&&this.node.addClass("current"),this.model.showonce&&this.node.addClass("trigger-once"),this.bindEvents(),node}},a5.views.interaction.BaseView.extend("a5.views.TriggerWord"),
a5.views.TTS_Player={init:function(text){this._super(),this.$node.addClass("tts_audio"),this.text=text,a5.service.media.tts_audio.trim(this.text)||this.$node.hide()},bindEvents:function(){this._super(),this.bind("play",this.onPlay.bindTo(this)),this.bind("pause",this.onPause.bindTo(this)),this.$node.on("click",function(e){e.preventDefault(),e.stopPropagation()})},onPlay:function(){_.isUndefined(this.audio)&&(this.audio=a5.service.media.tts_audio.create(this.text)),this.audio&&(this.audio.play(),this.audio.bind("playback-end",this.onPlaybackEnd.bindTo(this)))},onPause:function(){this.audio&&this.audio.pause()},onPlaybackEnd:function(){this.pause()}},a5.views.TinyPlayer.extend("a5.views.TTS_Player"),a5.views.TextArea={ignoredKeys:[0,8,13,33,34,35,36,37,38,39,40,45,46],width:"100%",height:"40px",maxLength:350,spellcheck:!1,inline:!1,init:function(model,options){this._super(model,null,$('<div class="text-area-content"></div>')),_.each(options,function(value,key){value&&(this[key]=value)},this),this.model.bind("change",this.updateContent,this),this.model.bind("state_update",this.updateState,this),_.bindAll(this,"addTypingFlag","checkMaxLength","hideCharCountLabel","hideMaxCharsLabel","hideMinLabel","hideWordCountLabel","removeTypingFlag","showCharCountLabel","showMaxCharsLabel","showMinLabel","showWordCountLabel")},buildInput:function(){return $("<textarea></textarea>")},render:function(){return this._super(),this.$input=this.buildInput().val(this.model.content),this.width&&this.$input.css("width",this.width),this.height&&this.$input.css({height:this.height,minHeight:a5.utils.endsWith(this.height,"%")?this.height:this.height+"px"}),this.$input.on("blur keyup",_.bind(this.updateModel,this)),this.addMaxLength(),this.node.append(this.$input),this.node.addClass("a5-textinput"),this.node.toggleClass("with-counter",!!this.count),this.$input.attr("spellcheck",this.spellcheck),this.$input.on("paste",_.bind(function(e){this.checkMaxLength(e),this._trimMaxLength()},this)),this.$input.on("input",_.bind(function(e){this._trimMaxLength()},this)),this.autogrow&&autosize(this.$input),this.updateState(),this.node},updateModel:function(){this.model.data=this.$input.val(),this.model.notifyValueChange()},updateContent:function(){this.$input.val(this.model.data)},updateState:function(){this.$input.attr("readonly","readonly"),"input"==this.model.state&&this.$input.removeAttr("readonly")},_trimMaxLength:function(){var text;"chars"==this.maxType&&this.maxLength?text=this.$input.val().substr(0,this.maxLength):"words"==this.maxType&&this.maxLength&&(text=this.$input.val(),text=text.replace(/(\s+)/g,"$1|&del!m&|"),text=text.split("|&del!m&|"),text=text.splice(0,this.maxLength).join("")),text&&text.length>=this.maxLength&&(this.$input.val(text),this.updateModel())},addMaxLength:function(){this.$input.on("keypress",this.checkMaxLength),this.$input.on("keydown",this.addTypingFlag),this.$input.on("blur",this.removeTypingFlag),"chars"===this.count&&(this.$input.on("keyup",this.showCharCountLabel),this.model.bind("change",this.showCharCountLabel),this.showCharCountLabel()),this.hidemax&&"words"!==this.count||(this.$input.on("keyup",this.showWordCountLabel),this.model.bind("change",this.showWordCountLabel),this.showWordCountLabel(),"words"!==this.count&&this.$input.on("blur",this.hideWordCountLabel)),!this.hidemax&&this.maxType&&this.$input.on("keyup",this.showMaxCharsLabel).on("blur",this.hideMaxCharsLabel),this.hidemin||this.$input.on("keyup",this.showMinLabel).on("blur",this.hideMinLabel)},wordCount:function(text){if(!text)return 0;var match=text.match(/[a-zA-Z0-9][a-zA-Z0-9\-']*/g);return match?match.length:0},getContent:function(){return this.$input.val()},currentLength:function(type){var text=this.getContent();return type=type||this.maxType,"chars"===type?text.length:this.wordCount(text)},currentMinLength:function(){var text=this.getContent();return"chars"==this.minType?text.length:this.wordCount(text)},checkMaxLength:function(e){var currentLength=this.currentLength();"chars"!=this.maxType?currentLength>=this.maxLength&&!_.include(this.ignoredKeys,e.which)&&this.checkWordCount(e.which)&&e.preventDefault():currentLength>=this.maxLength&&!_.include(this.ignoredKeys,e.which)&&e.preventDefault()},caret:function(){return this.$input.caret()},checkWordCount:function(charCode){var val=this.getContent(),caret=this.caret(),text=val.slice(0,caret.begin)+String.fromCharCode(charCode)+val.slice(caret.end);return this.wordCount(text)>this.maxLength},showMaxCharsLabel:function(){this.createOrSetLabel("label-max-chars",Math.max(0,this.maxLength-this.currentLength()))},showWordCountLabel:function(){this.createOrSetLabel("label-word-count",this.currentLength("words"))},showCharCountLabel:function(){this.createOrSetLabel("label-char-count",this.currentLength("chars"))},showMinLabel:function(){var charLength=Math.max(0,this.minLength-this.currentMinLength());"chars"==this.minType?this.createOrSetLabel("label-min-chars",charLength):"words"==this.minType&&this.createOrSetLabel("label-min-word-count",charLength)},createOrSetLabel:function(cls,text){var template=this._renderTemplate();template?this._createOrSetLabel_template(cls,text,template):this._createOrSetLabel_legacy(cls,text)},_renderTemplate:_.once(function(){return a5.service.templates.render("a5.view.TextInput.count")}),_createOrSetLabel_template:function(cls,text,template){var $label=this.$("."+cls);$label.length||$(template).prependTo(this.node),$label.text(text)},_createOrSetLabel_legacy:function(cls,text){var $label=this.$("."+cls);0==$label.length&&($label=$('<div class="'+cls+'"></div>"').prependTo(this.node)),$label.text(text)},hideMaxCharsLabel:function(){this.$(".label-max-chars").remove()},hideWordCountLabel:function(){this.$(".label-word-count").remove()},hideCharCountLabel:function(){this.$(".label-char-count").remove()},hideMinLabel:function(){this.$(".label-min-chars, .label-min-word-count").remove()},addTypingFlag:function(){this.node.addClass("typing")},removeTypingFlag:function(){this.node.removeClass("typing")}},a5.views.interaction.BaseView.extend("a5.views.TextArea"),a5.views.TextInput={ignoredKeys:[0,8,13,33,34,35,36,37,38,39,40,45,46],height:null,inline:!1,buildInput:function(){return $('<input type="text" />')},render:function(){return this._super(),this.node.toggleClass("inline",this.inline),this.node.addClass("a5-textinput"),this.node.find("input").css("resize","none"),this.node}},a5.views.TextArea.extend("a5.views.TextInput"),a5.views.ShowText={init:function(model){this._super(model,null,$('<span class="show-text"></span>')),this.model.bind("change",this.updateContent,this)},render:function(){return this._super(),this.updateContent(),this.node},updateModel:function(model){this.model=model,this.model.bind("change",this.updateContent,this)},updateContent:function(){this.model.cke?this.node.html(this.model.cke.getData()):this.node.html(_.escape(this.model.data).replace(/\n/g,"<br />"))}},a5.views.interaction.BaseView.extend("a5.views.ShowText"),a5.views.RichTextArea={initCK:function(){this.node.removeClass("a5-textinput"),this.node.addClass("a5-richtextinput"),this.richtext=!0;var toolbar=[["Bold","Italic","Underline","Superscript","Subscript","-","NumberedList","BulletedList"]],opts=a5.mainBuilder.options(),all=[["French","French"],["Spanish","Spanish"],["German","German"],["Danish","Danish"],["Polish","Polish"],["Swedish","Swedish"],["Turkish","Turkish"],["Ancient Greek","Ancient_Greek"],["Scientific Characters","Scientific_Characters"]],csconfig=[];_.each(all,function(k){opts.specialcharactersStudentHas(k[1])&&csconfig.push(k)}),csconfig.length>0&&toolbar[0].push("SpecialCharsButton");var config={width:this.width,height:this.height,toolbar:toolbar,customConfig:"",stylesSet:[],contentsCss:[CKEDITOR.getUrl("contents.css"),A5.SKIN_URL+"css/ckeditor.css"]};config.specialCharSetsNames=csconfig,config.extraPlugins="avaspecialchar,resize,focusfix",opts.textboxAutogrowIsOn()?(config.autoGrow_minHeight=50|this.height,config.extraPlugins+=",autogrow"):(config.removePlugins="autogrow",config.resize_enabled=!0,config.resize_dir="both",$(this.node,this.model.interaction.contentZone).length&&(this.model.interaction.onInteractionShowedListeners.register(_.partial(_.defer,this.updateResizeConfig.bindTo(this))),$(window).resize(this.updateResizeConfig.bindTo(this)))),_.bindAll(this,"ckeInitialized","onContentDom","onFontChange"),this.$input.ckeditor(this.ckeInitialized,config),this.model.cke=this.cke=this.$input.ckeditorGet(),this.cke.on("contentDom",this.onContentDom)},onContentDom:function(e){this.addMaxLength()},onFontChange:function(){this.updateFont()},updateResizeConfig:function(){if(this.model.interaction===a5.mainBuilder.curInteraction){var editor=this.$input.ckeditorGet(),maxWidth=this.model.interaction.contentZone.width()+this.model.interaction.contentZone.offset().left-this.node.offset().left,dom=editor.getResizable();dom&&dom.$.offsetWidth>maxWidth&&editor.resize(maxWidth),editor.config.resize_maxWidth=maxWidth}},ckeInitialized:function(){this.model.bind("state_update",this.updateState,this),this.updateState(),a5.hooks.interactionFontUpdated.add(this.onFontChange),this.updateFont()},updateState:function(){this.cke&&"ready"==this.cke.status&&("input"==this.model.state&&this.cke.readOnly?this.cke.setReadOnly(!1):"input"==this.model.state||this.cke.readOnly||this.cke.setReadOnly(!0),this.cke.on("change",_.bind(function(){this.cke.updateElement(),this.updateModel()},this)))},updateContent:function(){this.cke.setData(this.model.data)},updateFont:function(){var editor=this.$input.ckeditorGet(),fontClasses=a5.mainBuilder.getCurrentFontClasses(),regex=a5.mainBuilder.getFontClassesRegex(),ckeDocument=editor.document,ckeHtml=ckeDocument.getDocumentElement(),$ckeHtml=$(ckeHtml.$,ckeDocument.$);$ckeHtml.removeClass(function(index,className){return className.split(/\s+/).filter(function(c){return c.match(regex)}).join(" ")}),$ckeHtml.addClass(fontClasses.join(" "))},getContent:function(){var body=this.cke.document.getBody();return body.$?body.getText():""},addMaxLength:function(){if(this.cke){var editable=this.cke.editable();editable.attachListener(editable,"key",this.checkMaxLength),editable.attachListener(editable,"blur",this.removeTypingFlag),editable.attachListener(this.cke.document,"keyup",this.addTypingFlag),"chars"===this.count&&(editable.attachListener(this.cke.document,"keyup",this.showCharCountLabel),this.model.unbind("change",this.showCharCountLabel),this.model.bind("change",this.showCharCountLabel),this.showCharCountLabel()),this.hidemax&&"words"!==this.count||("words"!==this.count&&editable.attachListener(editable,"blur",this.hideWordCountLabel),editable.attachListener(this.cke.document,"keyup",this.showWordCountLabel),this.model.unbind("change",this.showWordCountLabel),this.model.bind("change",this.showWordCountLabel),this.showWordCountLabel()),!this.hidemax&&this.maxType&&(editable.attachListener(editable,"blur",this.hideMaxCharsLabel),editable.attachListener(this.cke.document,"keyup",this.showMaxCharsLabel)),this.hidemin||(editable.attachListener(editable,"blur",this.hideMinLabel),editable.attachListener(this.cke.document,"keyup",this.showMinLabel))}},checkMaxLength:function(e){var nativeEvent={which:e.data.keyCode,preventDefault:function(){e.cancel()}};this._super(nativeEvent)},caret:function(){var ranges=this.cke.getSelection().getRanges();return ranges.length?{begin:ranges[0].startOffset,end:ranges[0].endOffset}:{begin:0,end:0}}},a5.views.TextArea.extend("a5.views.RichTextArea"),a5.views.InfoText={dialogTemplate:"a5.view.InfoTextDialog",tooltipTemplate:"a5.view.InfoTextTooltip",dictionaryTemplate:"a5.view.InfoTextDictionary",referenceTemplate:"a5.view.InfoTextReference",init:function(parameters){this.icon=parameters.icon||"",this.content=parameters.content,this.contentText=$("<div/>").html(this.content).text(),this.klass=parameters.className,this.reference=parameters.reference,this.behaviour=parameters.behaviour,this.$body=$(document.body);var html=a5.service.templates.render(this._getTemplate(),this._serializeData()),$html=$(html);this._super(null,null,$html),this.$content=this.node.find(".infotext__content"),_.bindAll(this,"_onHoverIn","_onHoverOut","_onTouchEnd","_onBodyTouchEnd","_onClick","_onClickClose","_onClickReference","_onClickDictionary")},render:function(){return this._hasDictionaryAttached()?this._renderDictionary():this._hasReferenceAttached()?this._renderReference():"tooltip"===this.behaviour?this._renderTooltip():"dialog"===this.behaviour&&this._renderDialog(),this.klass&&(this.node.addClass(this.klass),this.node.addClass("infotext--icon"+_.str.capitalize(this.klass))),this.node},open:function(){var fn=this["_open"+_.str.capitalize(this.behaviour)];_.isFunction(fn)&&fn.call(this)},openReference:function(ref){_.result(a5.dp.config,"referenceOpenInTab")?window.open(this.url,"reference"):this.$iframe.iframeModal({open:function(){a5.eventBus.trigger(ref+":open",this)},close:function(){a5.eventBus.trigger(ref+":close",this)}})},close:function(){var fn=this["_close"+_.str.capitalize(this.behaviour)];_.isFunction(fn)&&fn.call(this)},_getTemplate:function(){var template;return this._hasDictionaryAttached()?template=this.dictionaryTemplate:this._hasReferenceAttached()?template=this.referenceTemplate:"tooltip"===this.behaviour?template=this.tooltipTemplate:"dialog"===this.behaviour&&(template=this.dialogTemplate),template},_serializeData:function(){var data={content:this.content};return"/"===this.icon.substr(0,1)?data.handle='<img src="'+A5.SKIN_URL+"images/icons"+this.icon+'"/>':data.handle=this.icon,data},_adjustContentWidth:function(){var wh=this.$content.naturalSize({padding:0},{width:"2000px"});this.$content.width(wh[0]+1)},_adjustContentPosition:function(){this.$content.removeClass("from-right from-below overflows-left overflows-right"),this.node.removeClass("infotext--top infotext--bottom infotext--right infotext--left");var scrollParent=a5.utils.scrollParent(this.$content),fromRight=this.node.offset().left>scrollParent.left+scrollParent.width/2,overflowsBottom=this.$content.offset().top+this.$content.outerHeight()>scrollParent.top+scrollParent.height-a5.dp.config.exclusionBottom,overflowsLeft=this.$content.offset().left<scrollParent.left,overflowsRight=this.$content.offset().left+this.$content.outerWidth()>scrollParent.left+scrollParent.width,overflowsTop=this.$content.offset().top<scrollParent.top+a5.dp.config.exclusionTop,overflowsVertical=this.$content.outerHeight()>scrollParent.height-a5.dp.config.exclusionBottom-a5.dp.config.exclusionTop,overflowsHorizontal=this.$content.outerWidth()>scrollParent.width;this.$content.toggleClass("from-right",fromRight),this.$content.toggleClass("from-below",overflowsBottom),this.$content.toggleClass("overflows-left",overflowsLeft),this.$content.toggleClass("overflows-right",overflowsRight),this.node.toggleClass("infotext--bottom",overflowsTop||overflowsVertical),this.node.toggleClass("infotext--top",overflowsBottom&&!overflowsVertical),this.node.toggleClass("infotext--right",overflowsLeft||overflowsHorizontal),this.node.toggleClass("infotext--left",overflowsRight&&!overflowsHorizontal)},_bindTooltipEvents:function(){this.node.hover(this._onHoverIn,this._onHoverOut),this.node.on("touchend",this._onTouchEnd),$("body").on("touchend",this._onBodyTouchEnd)},_bindDialogEvents:function(){this.node.on("click",this._onClick),this.node.on("click","[data-event=close]",this._onClickClose)},_openDialog:function(){this.$content.css("visibility","hidden"),this.node.addClass("infotext--show"),this.$body.addClass("body--infotextShow"),this._adjustContentPosition(),this.$content.css("visibility",""),this.opened=!0},_openTooltip:function(){this.$content.css("visibility","hidden"),this.$content.addClass("active"),this.node.addClass("infotext--show"),"true"===this.node.attr("data-force-width")&&this._adjustContentWidth(),this._adjustContentPosition(),this.$content.css("visibility",""),this.opened=!0},_closeDialog:function(){this.node.removeClass("infotext--show"),this.$body.removeClass("body--infotextShow"),this.opened=!1},_closeTooltip:function(){this.$content.removeClass("active"),this.node.removeClass("infotext--show"),this.opened=!1},_renderDialog:function(){this._bindDialogEvents()},_renderTooltip:function(){this._bindTooltipEvents()},_renderDictionary:function(){var ref=this.contentText.replace(/^dict:/gi,"");this.url=this._buildDictionaryUrl(ref),this.$iframe=$('<iframe frameborder="0" allowfullscreen="true" class="dictionary">').attr("src",this.url),this.node.on("click",this._onClickDictionary)},_renderReference:function(){var text=this.contentText,match=this._matchReference(text),index=parseInt(match&&match[1],10)-1,page=match&&match[2];this.url=this._buildReferenceUrl(index,page),this.$iframe=$('<iframe frameborder="0" allowfullscreen="true" class="reference">').attr("src",this.url),this.node.on("click",this._onClickReference)},_hasDictionaryAttached:function(){return!!this.reference&&!!this.contentText.match(/^dict:/gi)},_hasReferenceAttached:function(){return!!this.reference&&!!this._matchReference(this.contentText)},_matchReference:function(text){return/^ref\s*(\d+)(?::(?:page)?\s*(\d+))?/i.exec(text)},_onHoverIn:function(e){this.opened||this.open()},_onTouchEnd:function(e){this.opened||this.open()},_onHoverOut:function(e){this.close()},_onBodyTouchEnd:function(e){$.contains(this.node[0],e.target)||this.close()},_onClick:function(e){$(e.target).closest(this.$content).length||(this.opened?this.close():this.open())},_onClickClose:function(e){this.close()},_onClickReference:function(e){this.openReference("reference")},_onClickDictionary:function(e){this.openReference("dictionary")},_buildDictionaryUrl:function(ref){return this._addQueryStringSeparator(this.reference[0])+"a5_dictionary_ref="+encodeURIComponent(ref)+"&a5_store=false&a5_restore=false&a5_lms_close=false"},_buildReferenceUrl:function(index,page){return this._addQueryStringSeparator(this.reference[index])+"page="+encodeURIComponent(page)+"&a5_store=false&a5_restore=false&a5_lms_close=false&a5_book_pages_per_screen=1"},_addQueryStringSeparator:function(url){return url.indexOf("?")>=0?url+"&":a5.utils.endsWith(url,"/")?url+"?":url+"/?"}},a5.views.interaction.BaseView.extend("a5.views.InfoText"),a5.views.UserSelection={init:function(model,step,max,multiple){this._super(model,null,$('<div class="user-selection interaction is-dropdown"></div>')),this.step=step,this.max=max,this.multiple=multiple,this.choices=this.createTemplateModel(),this.displayCategories=this.choices.groups.length>1,this.multiple?this.initMultipleCategory(this.choices.groups):this.initSingleCategory(this.choices.groups),this.range_model=new a5.models.interaction.ISDropdownModel({prefill:!1,correctFeedback:!1,incorrectFeedback:!1}),_.each(this.choices.ranges,_.bind(function(choice,i){var choiceModel=new a5.models.interaction.ISDropdownChoiceModel({content:$("<span>").html(choice),key:i});this.range_model.add(choiceModel)},this))},initMultipleCategory:function(groups){this.group_model=groups},initSingleCategory:function(groups){this.group_model=new a5.models.interaction.ISDropdownModel({prefill:!1,correctFeedback:!1,incorrectFeedback:!1}),_.each(groups,_.bind(function(choice,i){var choiceModel=new a5.models.interaction.ISDropdownChoiceModel({content:$("<span>").html(choice),key:i});this.group_model.add(choiceModel)},this))},createTemplateModel:function(){for(var model={groups:this.model.getAllInteractionsGroups(),ranges:[]},i=this.step;i<=this.max;i+=this.step)model.ranges.push(i);return model},render:function(){return this._super(),this.node.html(a5.service.templates.render("a5.view.UserSelection",{hideGroups:!this.displayCategories})),this.groupSelectView=this.initGroupSelectView(),this.dropdownRangeView=new a5.views.interaction.ISRichDropdownView(this.range_model),this.node.find(".user-selection-range").html(this.dropdownRangeView.render()).removeClass("user-selection-range"),this.displayCategories&&this.node.find(".user-selection-group").html(this.groupSelectView.render()).removeClass("user-selection-group"),this.node.on("click",".user-selection-confirm",_.bind(this.onClick,this)),this.node},onClick:function(){if(this.model.options().activitypoolIsOn()){var groups=this.getSelectedGroups(),count=this.getCount();groups.length&&!_.isNaN(count)&&(this.model.initIntList({allowIntroScreen:!1,shuffle:!0,groups:groups,count:count}),this.model.loadScreensOnDemand?this.model.goTo(0):this.model.openIntList(this.model.intList,0))}},getSelectedGroups:function(){if(this.displayCategories){if(this.multiple)return this.groupSelectView.value();var selected=this.group_model.selected&&this.group_model.selected.content.text();return _.compact([selected])}return this.choices.groups},getCount:function(){var count=this.range_model.selected&&this.range_model.selected.content.text();return parseInt(count,10)},initGroupSelectView:function(){return this.multiple?new a5.views.MultiselectCheck(this.group_model):new a5.views.interaction.ISRichDropdownView(this.group_model)}},a5.views.interaction.BaseView.extend("a5.views.UserSelection"),a5.view.Clock={init:function(model,parent){this._super(model,parent,$('<div class="clock"><div class="minutes hand" /><div class="hours hand" /></div>')),this.node.addClass(model.className)},render:function(){return this._super(),this.update(),this.model.locked?this.node.addClass("locked"):this._bindEvents(),this.node},update:function(){var time=this.model.getTime(),mins=time.getMinutes();_.each({".hours":30*time.getHours()+mins/2,".minutes":6*mins},function(angle,hand){this.$(hand).css("transform","rotate("+angle+"deg)")},this)},_bindEvents:function(){var isHourDrag,dragCenter,dragAngle,self=this,dragging=!1;this.$(".hand").on("mousedown touchstart",function(e){if("touchstart"==e.type||1==e.which){dragging=!0,self.node.addClass("clock-dragging"),isHourDrag=$(this).is(".hours");var increment=isHourDrag?30:6,bBox=self.node.bBox();dragCenter=[bBox.left+bBox.width/2,bBox.top+bBox.height/2],dragAngle=Math.round(self._angle(dragCenter,self._getEventPoint(e))/increment)*increment}}).on("dragstart",function(e){e.preventDefault()}),$(document).on("mousemove touchmove",function(e){dragging&&(dragAngle=self._moveHand(dragCenter,dragAngle,isHourDrag,self._getEventPoint(e)),e.preventDefault())}).on("mouseup touchend",function(e){dragging=!1,self.node.removeClass("clock-dragging")})},_getEventPoint:function(e){return[e.pageX||e.originalEvent.touches&&e.originalEvent.touches[0].pageX,e.pageY||e.originalEvent.touches&&e.originalEvent.touches[0].pageY]},_moveHand:function(center,oldAngle,isHourDrag,point){var increment=isHourDrag?30:6,angle=Math.round(this._angle(center,point)/increment)*increment;if(oldAngle===angle||_.isNaN(angle))return oldAngle;var multiplier=isHourDrag?12e4:1e4,diff=(angle-oldAngle)%360;return Math.abs(diff)>180&&(diff+=-360*Math.sign(diff)),this.model.addTime(multiplier*diff),this.update(),angle},_angle:function(center,point){var vfrom=[100,0],vto=[point[0]-center[0],point[1]-center[1]],dot=vfrom[0]*vto[0]+vfrom[1]*vto[1],cross=vfrom[0]*vto[1]-vfrom[1]*vto[0];return 180*Math.atan2(cross,dot)/Math.PI}},a5.views.interaction.BaseView.extend("a5.view.Clock"),a5.views.ContentMessage={init:function(message,rawMessage){this.message=message,this.$el=$("<div>",{class:"content-message-link","data-message":rawMessage}),_.bindAll(this,"_onClick"),this.$el.on("click",this._onClick)},render:function(){return this.$el},send:function(){a5.service.postMessager.sendMessage("contentmessage",{arguments:this.message})},_onClick:function(e){e.preventDefault(),this.send()}},Obj.extend("a5.views.ContentMessage"),a5.views.ImageHotspot={NODE_TEMPLATE:'<div class="hotspot image-hotspot"><div class="hotspot-content"></div></div>',width:0,height:0,top:0,left:0,visited:!1,visible:!1,init:function(model){this._super(model,null,$(this.NODE_TEMPLATE))},render:function(){var styles=_(this.model.style.split(";")).compact(),ignoredStyles=["background-color","opacity"];return styles=_(styles).reject(function(style){var rule=style.split(":");return _(ignoredStyles).contains(rule[0].trim())}),this.node.attr("style",styles.join(";")),this.node.on("click",this.toggle.bindTo(this)),this.$content=this.node.find(".hotspot-content"),this.$content.append(this.model.text),this.$content.hide(),this.node},toggle:function(){this.visited=!0,this.visible=!this.visible,this.node.toggleClass("visited",this.visited),this.node.toggleClass("active",this.visible),this.visible?this.$content.show():this.$content.hide()}},a5.views.interaction.BaseView.extend("a5.views.ImageHotspot"),a5.view.TeamScoring={TEMPLATE:'<div class="team-score"><div class="team"></div><div class="score"></div></div>',init:function(model){this.model=model,this.$el=$(window.a5.mainBuilder.layout.getTemplate("team_score")||this.TEMPLATE)},render:function(){return this.$team=this.$el.find(".team"),this.$score=this.$el.find(".score"),this.$team.empty().append(this.model.team),this.$score.empty().append(this.model.points),this.$el.toggleClass("active",this.model.active),this.$el}},Obj.extend("a5.view.TeamScoring"),a5.view.Moderator={DELAY:2e3,TEMPLATE:'<div class="teams-scoring"></div>',init:function(model){this.model=model,this.children=_(model.teamScores).map(function(teamScore){return new a5.view.TeamScoring(teamScore)},this),_.bindAll(this,"onTurnChange","onScore","onFinalScore","showScoreboard","showFinalScoreboard","onCloseScoreboard"),this.model.bind("interaction:teams:turn:change",this.onTurnChange),this.model.bind("interaction:teams:finalscore",this.onFinalScore),this.model.bind("interaction:teams:score",this.onScore),this.$el=$(this.TEMPLATE),this.scoreBoardVisible=!1,this.DELAY=a5.dp.config.teamScoringDelay||this.DELAY},onTurnChange:function(last,current){last.setActive(!1),current.setActive(!0)},onFinalScore:function(teamScores){_.delay(this.showFinalScoreboard,this.DELAY)},onScore:function(teamScore){_.delay(this.showScoreboard,this.DELAY,teamScore)},showScoreboard:function(current){this.scoreBoardVisible||(this.scoreBoardVisible=!0,a5.view.dialog.display("a5.view.dialog.TeamsScoreboard",{dialogClass:"dialog-teams-scoreboard",teams:_(this.model.teamScores).map(function(t){return{team:t.team,points:t.points,active:current==t?"active":""}})},{close:this.onCloseScoreboard},void 0,void 0,a5.dp.config.appendTeamScoreTo))},showFinalScoreboard:function(){var result,winners=this.model.winners();0===winners.length&&(result="draw"),a5.view.dialog.display("a5.view.dialog.TeamsFinalScoreboard",{dialogClass:"dialog-teams-finalscoreboard",teams:_(this.model.teamScores).map(function(t){return{team:t.team,points:t.points,result:result||(_(this.model.winners()).contains(t)?"winner":"")}},this)},{})},onCloseScoreboard:function(){this.scoreBoardVisible=!1,this.render()},render:function(){return this.$el.empty(),_(this.children).each(function(child){this.$el.append(child.render())},this),this.$el}},Obj.extend("a5.view.Moderator"),function(a5,$,_){a5.views.LONavigation={TEMPLATE:'<div class="lo-navigation-toolbar"><a class="lo-navigation-btn previous">Prev</a><a class="lo-navigation-btn next">Next</a><a class="lo-navigation-btn toc">TOC</a></div>',init:function(model,$el){_.bindAll(this,"onClickNext","onClickPrev","onClickTOC"),this.$el=$el,this.model=model},render:function(){return this.$el.show(),this.$el.on("click","a.lo-navigation-btn.previous",this.onClickPrev),this.$el.on("click","a.lo-navigation-btn.next",this.onClickNext),this.$el.on("click","a.lo-navigation-btn.toc",this.onClickTOC),this.$el},onClickPrev:function(e){e.preventDefault(),this.model.goToPrevLO()},onClickNext:function(e){e.preventDefault(),this.model.goToNextLO()},onClickTOC:function(e){e.preventDefault(),this.model.close()}},Obj.extend("a5.views.LONavigation")}(a5,jQuery,_),a5.views.LinkingLinesInputHandler={init:function($node,childrenSelector){this.$node=$node,this.childrenSelector=childrenSelector,this.erasing=!1,this.linking=!1},setErasing:function(erasing){this.erasing=erasing},isErasing:function(){return this.erasing}},Obj.extend("a5.views.LinkingLinesInputHandler"),a5.views.LinkingLinesDragHandler={init:function($node,childrenSelector,$container){this._super($node,childrenSelector),_.bindAll(this,"onMove","onFinish","onChildSelect"),this.$container=$container||$(document.body)},bindEvents:function(){this.unbindEvents(),this.$container.on("mousemove touchmove",this.onMove).on("mouseup touchend",this.onFinish),this.$node.find(this.childrenSelector).on("mousedown touchstart",this.onChildSelect)},unbindEvents:function(){this.$container.off("mousemove touchmove",this.onMove).off("mouseup touchend",this.onFinish),this.$node.find(this.childrenSelector).off("mousedown touchstart",this.onChildSelect)},onMove:function(ev){if(this.linking){var myEv=ev.originalEvent.touches?ev.originalEvent.touches[0]:ev,pos=_.pick(myEv,"pageX","pageY","clientX","clientY");this.trigger("linking",pos,this.$container),ev.preventDefault()}},onFinish:function(ev){if(this.linking){var myEv=ev.originalEvent.changedTouches?ev.originalEvent.changedTouches[0]:ev,pos=_.pick(myEv,"pageX","pageY","clientX","clientY"),children=this.$node.find(this.childrenSelector),element=document.elementFromPoint(pos.clientX,pos.clientY),$element=children.is(element)?element:children.has(element).get(0);this.linking=!1,this.trigger("finish",pos,$element,this.$container)}},onChildSelect:function(ev){var myEv=ev.originalEvent.touches?ev.originalEvent.touches[0]:ev,pos=_.pick(myEv,"pageX","pageY","clientX","clientY");this.erasing?this.trigger("erase",pos,ev.currentTarget):(this.linking=!0,this.trigger("start",pos,ev.currentTarget)),$(ev.target).is(".playbutton, .play-button")||ev.preventDefault()}},a5.views.LinkingLinesInputHandler.extend("a5.views.LinkingLinesDragHandler"),a5.views.LinkingLinesTouchHandler={init:function($node,childrenSelector,$container){this._super($node,childrenSelector),_.bindAll(this,"onMove","onChildSelect"),this.$container=$container||$(document.body)},bindEvents:function(){this.unbindEvents(),this.$container.on("mousemove",this.onMove),this.$node.find(this.childrenSelector).on("click",this.onChildSelect)},unbindEvents:function(){this.$container.off("mousemove",this.onMove),this.$node.find(this.childrenSelector).off("click",this.onChildSelect)},onMove:function(ev){if(this.linking){var pos=_.pick(ev,"pageX","pageY","clientX","clientY");this.trigger("linking",pos,this.$container)}},onChildSelect:function(ev){ev.preventDefault();var myEv=ev.originalEvent.touches?ev.originalEvent.touches[0]:ev,pos=_.pick(myEv,"pageX","pageY","clientX","clientY");this.erasing?this.trigger("erase",pos,ev.currentTarget):this.linking?(this.linking=!1,this.trigger("finish",pos,ev.currentTarget)):(this.linking=!0,this.trigger("start",pos,ev.currentTarget))}},a5.views.LinkingLinesInputHandler.extend("a5.views.LinkingLinesTouchHandler"),a5.views.Countdown={template:"a5.view.dialog.Countdown",init:function(model,parent,options){this._super(model,parent,$(a5.service.templates.render(this.template))),this.options=options||{},this.model.bind("progress",this.onProgress,this),this.model.bind("start",this.onStart,this),this.model.bind("stop",this.onStop,this),this.model.bind("end",this.onEnd,this),this.model.bind("reset",this.onReset,this),_.bindAll(this,"onClickPlay","onClickPause","onClickClose","onClickReset","onClickAlarm"),this.options.alarm&&(this.alarmAudio=a5.service.media.audio.create("_"+this.options.alarm,{url:this.options.alarm}))},render:function(){return this.node.off(),this.$(".pause").hide(),this._setDisplayTime(a5.utils.secondsToTime(this.model.totalTime,"paddingZeros")),this.node.on("click",".close",this.onClickClose),this.node.on("click",".play",this.onClickPlay),this.node.on("click",".reset",this.onClickReset),this.node.on("click",".pause",this.onClickPause),this.node.draggable({containment:"window"}),this.parent.$(".countdown").addClass("disabled"),this.options.alarm&&(this.node.addClass("alarm-on"),
this.node.on("click",".alarm",this.onClickAlarm)),a5.hooks.countdownRendered.call(this),this.node},onClickPlay:function(e){this.model.start(),e.preventDefault(),e.stopPropagation()},onClickPause:function(e){this.model.pause(),this.$(".pause").hide(),this.$(".play").show(),e.preventDefault(),e.stopPropagation()},onClickReset:function(e){this.model.reset(),this.$(".play").show(),this.$(".pause").hide(),e.preventDefault(),e.stopPropagation()},onClickAlarm:function(e){this.node.toggleClass("alarm-on"),e.preventDefault(),e.stopPropagation()},onClickClose:function(e){this.model.stop(),this.node.remove(),this.alarmAudio&&this.alarmAudio.stop(),e.preventDefault(),e.stopPropagation(),this.parent.$(".countdown").removeClass("disabled")},onProgress:function(seconds,percentage){this._setDisplayTime(a5.utils.secondsToTime(seconds,"paddingZeros")),this.$(".progress").data("progress",percentage),this.$(".progress").trigger("countdown:tick",[percentage,seconds])},onStop:function(){this.$(".play").hide(),this.$(".pause").hide()},onStart:function(){this.$(".play").hide(),this.$(".pause").show()},onEnd:function(){this.alarmAudio&&this.node.hasClass("alarm-on")&&(this.alarmAudio.play(),logger.log("Playing alarm: ",this.options.alarm))},onReset:function(seconds){this._setDisplayTime(a5.utils.secondsToTime(seconds,"paddingZeros")),this.$(".progress").data("progress",0),this.$(".progress").trigger("countdown:reset")},_setDisplayTime:function(hhmmss){var parts=hhmmss.split(":");this.$(".hours").html(parts[0]),this.$(".minutes").html(parts[1]),this.$(".seconds").html(parts[2])}},a5.views.interaction.BaseView.extend("a5.views.Countdown"),a5.views.CountdownSetup={template:"a5.view.dialog.CountdownSetup",init:function(model,parent,options){this._super(model,parent,$(a5.service.templates.render(this.template))),this.defaultTime=this._isValidTime(a5.dp.config.bookCountdownTime)&&a5.dp.config.bookCountdownTime||"00:00:00",this.options=options||{},this.countdownSetupAlarm=new a5.view.CountdownSetupAlarm,this.countdownSetupAlarm.bind("alarm:off",this.onAlarmOff,this),this.countdownSetupAlarm.bind("alarm:on",this.onAlarmOn,this),_.bindAll(this,"onClickStart","onClickClose","onClickReset","onClickAlarm","onInputFocus","onInputBlur","onInputKeydown","onInputKeyup","onInputChanged")},render:function(){return this.node.off(),this.$hours=this.$(".hours input"),this.$minutes=this.$(".minutes input"),this.$seconds=this.$(".seconds input"),this._setDisplayTime(this.defaultTime),this.refreshStartButton(),this.node.on("click",".close",this.onClickClose),this.node.on("click",".start",this.onClickStart),this.node.on("click",".reset",this.onClickReset),this.node.on("click",".alarm",this.onClickAlarm),this.$("input").on("focus",this.onInputFocus),this.$("input").on("blur",this.onInputBlur),this.$("input").on("keydown",this.onInputKeydown),this.$("input").on("keyup",this.onInputKeyup),this.$("input").on("change",this.onInputChanged),this.node.find(".alarm-options").append(this.countdownSetupAlarm.$el),this.countdownSetupAlarm.render(),this.node.show(),a5.hooks.countdownSetupRendered.call(this),this.node},close:function(){_.isFunction(this.options.onClose)&&this.options.onClose(),this.node.hide()},start:function(hhmmss){var model=new a5.models.Countdown({total:a5.utils.timeToSeconds(hhmmss)}),view=new a5.views.Countdown(model,this.parent,{alarm:this.countdownSetupAlarm.getCurrentSoundUrl()});view.node.appendTo(a5.dp.config.appendCountdownTo||this.parent.node),view.render(),model.start()},onClickClose:function(e){this.close(),e.preventDefault(),e.stopPropagation()},onClickReset:function(e){this._setDisplayTime(this.defaultTime),e.preventDefault(),e.stopPropagation()},onClickStart:function(e){this._sanitizeInput();var hhmmss=this._getDisplayTime();this.close(),this.start(hhmmss),e.preventDefault(),e.stopPropagation()},onClickAlarm:function(e){this.countdownSetupAlarm.show()},onInputFocus:function(e){e.target.select()},onInputBlur:function(e){var $input=$(e.target);1===$input.val().length&&$input.val("0"+$input.val()),0===$input.val().length&&$input.val("00")},onInputKeydown:function(e){var key=e.which;_.includes([46,8,9,27,13,110,190],key)||65==key&&!0===e.ctrlKey||key>=35&&key<=40||(e.shiftKey||key<48||key>57)&&(key<96||key>105)&&e.preventDefault()},onInputKeyup:function(e){this._sanitizeInput(),this.onInputChanged()},onInputChanged:function(){this.refreshStartButton()},onAlarmOn:function(){this.node.addClass("alarm-on")},onAlarmOff:function(){this.node.removeClass("alarm-on")},refreshStartButton:function(){!this._isValidTime(this._getDisplayTime())||0===parseInt(this.$hours.val(),10)&&0===parseInt(this.$minutes.val(),10)&&0===parseInt(this.$seconds.val(),10)?this.$(".start").attr("disabled",!0):this.$(".start").attr("disabled",!1)},_sanitizeInput:function(){var hours=this.$hours.val(),minutes=this.$minutes.val(),seconds=this.$seconds.val();hours>23&&this.$hours.val("00"),minutes>59&&this.$minutes.val("00"),seconds>59&&this.$seconds.val("00")},_setDisplayTime:function(hhmmss){var parts=hhmmss.split(":");this.$hours.val(parts[0]).trigger("change"),this.$minutes.val(parts[1]).trigger("change"),this.$seconds.val(parts[2]).trigger("change")},_getDisplayTime:function(){var hours=this.$hours.val(),mins=this.$minutes.val(),secs=this.$seconds.val();return hours.length<2&&(hours=("00"+hours).slice(-2)),mins.length<2&&(mins=("00"+mins).slice(-2)),secs.length<2&&(secs=("00"+secs).slice(-2)),[hours,mins,secs].join(":")},_isValidTime:function(hhmmss){return/^([01]\d|2[0-3]):[0-5]\d:[0-5]\d$/.test(hhmmss)}},a5.views.interaction.BaseView.extend("a5.views.CountdownSetup"),a5.view.CountdownSetupAlarm={template:"a5.view.dialog.CountdownSetupAlarm",DEFAULT_SOUND:"audios/beep.wav",init:function(){this.currentSound=null,this.$el=$("<div>",{class:"countdown-setup-alarm"}),_.bindAll(this,"onClickNone","onClickSound","onClickClose"),this.$el.on("click",".no-sound-item",this.onClickNone),this.$el.on("click",".sound-item",this.onClickSound),this.$el.on("click",".close",this.onClickClose)},show:function(){this.$el.html().trim()||(this.currentSound=null,this.alarm=!0,this.trigger("alarm:on")),this.$el.show()},close:function(){this.$el.html().trim()||(this.currentSound=null,this.alarm=!1,this.trigger("alarm:off")),this.$el.hide()},render:function(){var html=a5.service.templates.render(this.template),$html=$(html);return this.$el.html($html.html()),this.$el.find(".no-sound-item").addClass("active"),this.currentSound&&(this.$el.find(".sound-item").removeClass("active"),this.$el.find(".no-sound-item").removeClass("active"),this.$el.find("[data-sound="+a5.utils.jquerySelectorEscape(this.currentSound)+"]").addClass("active"),this.alarm=!0,this.trigger("alarm:on")),this.trigger("render"),this.$el},onClickSound:function(e){e.preventDefault(),this.$el.find(".sound-item").removeClass("active"),this.$el.find(".no-sound-item").removeClass("active"),$(e.currentTarget).addClass("active"),this.currentSound=$(e.currentTarget).attr("data-sound"),this.alarm=!0,this.trigger("alarm:on")},onClickNone:function(e){e.preventDefault(),this.$el.find(".sound-item").removeClass("active"),$(e.currentTarget).addClass("active"),this.alarm=!1,this.currentSound=null,this.trigger("alarm:off")},onClickClose:function(e){e.preventDefault(),e.stopPropagation(),this.close()},getSoundUrl:function(audio){return A5.SKIN_URL+audio},getDefaultSoundUrl:function(){return A5.ENGINE_ROOT+this.DEFAULT_SOUND},getCurrentSoundUrl:function(){if(this.alarm)return this.currentSound?this.getSoundUrl(this.currentSound):this.getDefaultSoundUrl()}},Obj.extend("a5.view.CountdownSetupAlarm"),a5.view.Toc={template:"a5.view.dialog.TableOfContents",init:function(parameters){this.lo=parameters.lo,this.options=this.lo.options(!0),this.toc=this._getTocEntries(),this.$el=$("<div>",{title:"Table of contents"}),_.bindAll(this,"onClickEntry","onClickOk","onClickCancel","onClose"),this.$el.on("click",".toc-entry",this.onClickEntry),this.$el.on("click",".btn-ok",this.onClickOk),this.$el.on("click",".btn-cancel",this.onClickCancel)},show:function(){this.$dialog=this.render().dialog({modal:!0,dialogClass:"toc-dialog"}),this.$dialog.on("dialogclose",this.onClose)},close:function(){this.$dialog.dialog("close")},render:function(){var html=a5.service.templates.render(this.template,this.serializeData()),$html=$(html);return this.$el.attr("title",$html.attr("title")),this.$el.html($html.html()),a5.callbacks.dialogs.get(this.template).trigger("showed",this.$el),this.$el},serializeData:function(){return _(this.toc).each(function(entry){"section"!==entry.type?entry.selected=entry.page===this.lo.curTask+1:_(entry.tocEntries).each(function(subentry){subentry.selected=subentry.page===this.lo.curTask+1,subentry.selected&&(entry.selected=!0)},this)},this),{entries:this.toc}},onClickEntry:function(e){e.preventDefault(),this.$el.find(".toc-entry").removeClass("selected"),$(e.currentTarget).addClass("selected")},onClose:function(e){e.preventDefault(),this.$dialog.dialog("destroy")},onClickCancel:function(e){e.preventDefault(),this.close()},onClickOk:function(e){e.preventDefault();var page=parseInt(this.$el.find(".toc-entry.selected").attr("data-page"),10)-1||0;this.lo.goTo(page),this.close()},_getTocEntries:function(){return this.toc||(this.toc=this.options.navigationMenuIsCustom()?this._getCustomEntries():this._getAutoEntries()),this.toc},_getCustomEntries:function(){var parser=new a5.parsers.TocParser,entries=parser.parse(this.options.getNavigationMenu());return _(entries).each(function(entry){var interaction=this.lo.getInteractionFromIndex(entry.page-1);entry.thumbnail=interaction&&interaction.preview},this),entries},_getAutoEntries:function(){var interactions=_([this.lo.introScreen,this.lo.intList]).chain().flatten().compact().value();return _(interactions).map(function(interaction){return{page:interaction.visibleIndex,title:interaction.title,thumbnail:interaction.preview}})}},a5.views.interaction.BaseView.extend("a5.view.Toc"),a5.view.DisplaySettings={template:"a5.view.dialog.DisplaySettings",init:function(parameters){this.lo=parameters.lo,this.$el=$("<div>",{title:"Options"}),_.bindAll(this,"onClickPattern","onClickBackground","onClose","onClickOk","onClickCancel"),this.$el.on("click",".pattern",this.onClickPattern),this.$el.on("click",".background",this.onClickBackground),this.$el.on("click",".btn-ok",this.onClickOk),this.$el.on("click",".btn-cancel",this.onClickCancel)},show:function(){this.$dialog=this.render().dialog({modal:!0,dialogClass:"opt-dialog"}),this.$dialog.on("dialogclose",this.onClose)},close:function(){this.$dialog.dialog("close")},render:function(){var html=a5.service.templates.render(this.template),$html=$(html);return this.$el.attr("title",$html.attr("title")),this.$el.html($html.html()),this.lo.currentDisplayPattern&&(this.$el.find(".pattern").removeClass("active"),this.$el.find("[data-pattern="+this.lo.currentDisplayPattern+"]").addClass("active")),this.lo.currentDisplayBackground&&(this.$el.find(".background").removeClass("active"),this.$el.find("[data-background="+this.lo.currentDisplayBackground+"]").addClass("active")),this.trigger("render"),this.$el},onClickPattern:function(e){e.preventDefault(),this.$el.find(".pattern").removeClass("active"),$(e.currentTarget).addClass("active")},onClickBackground:function(e){e.preventDefault(),this.$el.find(".background").removeClass("active"),$(e.currentTarget).addClass("active")},onClose:function(e){e.preventDefault(),this.$dialog.dialog("destroy")},onClickOk:function(e){e.preventDefault(),$("body").removeClass(this.lo.currentDisplayPattern),this.lo.currentDisplayPattern=this.$el.find(".pattern.active").attr("data-pattern"),$("body").addClass(this.lo.currentDisplayPattern),$("body").removeClass(this.lo.currentDisplayBackground),this.lo.currentDisplayBackground=this.$el.find(".background.active").attr("data-background"),$("body").addClass(this.lo.currentDisplayBackground),this.close()},onClickCancel:function(e){e.preventDefault(),this.close()}},Obj.extend("a5.view.DisplaySettings"),a5.view.dialog.DeleteAll={template:"a5.view.dialog.DeleteAll",init:function(parameters){this.$el=$("<div>",{title:"Delete all"}),_.bindAll(this,"onClose","onClickOk","onClickCancel"),this.$el.on("click",".btn-ok",this.onClickOk),this.$el.on("click",".btn-cancel",this.onClickCancel)},show:function(){this.$dialog=this.render().dialog({modal:!0,dialogClass:"delete-all-dialog"}),this.$dialog.on("dialogclose",this.onClose)},close:function(){this.$dialog.dialog("close")},render:function(){var html=a5.service.templates.render(this.template),$html=$(html);return this.$el.attr("title",$html.attr("title")),this.$el.html($html.html()),this.trigger("render"),this.$el},onClose:function(e){e.preventDefault(),this.$dialog.dialog("destroy")},onClickOk:function(e){e.preventDefault(),this.trigger("submit"),this.close()},onClickCancel:function(e){e.preventDefault(),this.close()}},Obj.extend("a5.view.dialog.DeleteAll"),a5.view.dialog.ResourceBanksSelect={template:"a5.view.dialog.ResourceBanksSelect",init:function(parameters){this.banks=parameters.banks,this.$el=$("<div>",{title:"Select resource banks"}),_.bindAll(this,"onClickEntry","onClickOk","onClickCancel","onClose"),this.$el.on("click",".resource-bank",this.onClickEntry),this.$el.on("click",".btn-ok",this.onClickOk),this.$el.on("click",".btn-cancel",this.onClickCancel)},show:function(){this.$dialog=this.render().dialog({modal:!0,dialogClass:"resource-banks-dialog"}),this.$dialog.on("dialogclose",this.onClose)},close:function(){this.$dialog.dialog("close")},render:function(){var html=a5.service.templates.render(this.template,this.serializeData()),$html=$(html);return this.$el.attr("title",$html.attr("title")),this.$el.html($html.html()),this.trigger("render"),this.$el},serializeData:function(){return{banks:_(this.banks.getBanks()).map(function(bank){return{id:bank.id,name:bank.name,active:bank.preselected}})}},onClickEntry:function(e){e.preventDefault(),$(e.currentTarget).toggleClass("active"),this.$el.off("click",".btn-ok"),this.$el.find(".resource-bank.active").length>0?(this.$el.on("click",".btn-ok",this.onClickOk),this.$el.find(".btn-ok").removeClass("inactive")):this.$el.find(".btn-ok").addClass("inactive")},onClose:function(e){e.preventDefault(),this.$dialog.dialog("destroy")},onClickCancel:function(e){e.preventDefault(),this.close()},onClickOk:function(e){e.preventDefault(),this.trigger("submit",this._getCurrentSelection()),this.close()},_getCurrentSelection:function(){var selection=[];return this.$el.find("[data-bank]").each(function(index,bank){selection.push({id:$(bank).attr("data-bank"),active:$(bank).is(".active")})}),selection}},Obj.extend("a5.view.dialog.ResourceBanksSelect"),a5.view.ResourcesStage={init:function(parameters){this.interaction=parameters.interaction,this.model=parameters.model,this.$el=parameters.$el,this.$el.attr("id","resources-stage-"+this.interaction.index),this.$el.addClass("resources-stage"),_.bindAll(this,"onDrop","onItemDragStart","onItemDrag","onItemDragStop","onItemClick","onItemSelectedStart","onItemUnselected","onItemUnselecting"),this.$el.on("drop",this.onDrop),this.$el.on("dragstart","> .resource-stage-item",this.onItemDragStart),this.$el.on("drag","> .resource-stage-item",this.onItemDrag),this.$el.on("dragstop","> .resource-stage-item",this.onItemDragStop),this.$el.on("click","> .resource-stage-item",this.onItemClick),this.$el.on("selectablestart",this.onItemSelectedStart),this.$el.on("selectableunselected",this.onItemUnselected),this.$el.on("selectableunselecting",this.onItemUnselecting),this.model.bind("change:state",this.onStateChange,this),this.model.bind("change",this.onChange,this),this.children=[]},render:function(){return this.makeDroppable(),this.makeSelectable(),_.each(this.model.getItems(),function(item){this.addItem(item)},this),this._createGrids(),this.trigger("render"),this.$el},refresh:function(){_.invoke(this.children,"remove"),this.children=[],_.each(this.model.getItems(),function(item){this.addItem(item)},this),this.trigger("refresh")},region:function(){return this.$el},makeDroppable:function(){this.$el.droppable({scope:"resources-"+this.interaction.index,accept:".resource-item, .pan-balance .resource-stage-item",tolerance:"touch"})},makeSelectable:function(){this.$el.selectable({filter:"> .resource-stage-item",cancel:".resource-stage-item"}),this.originalSelectableRefreshFn=this.$el.data("uiSelectable").refresh},addItem:function(item){var resourceStageItem;return resourceStageItem=item instanceof a5.model.CardStageItem?new a5.view.CardStageItem({item:item,interaction:this.interaction,generalGrid:this.model.generalGrid}):new a5.view.ResourceStageItem({item:item,interaction:this.interaction,generalGrid:this.model.generalGrid}),this.region().append(resourceStageItem.$el),item.cssmatrix=resourceStageItem.$el.transformationMatrix(),resourceStageItem.render(),this.children.push(resourceStageItem),resourceStageItem},removeItem:function(itemView){itemView.remove();var index=this.children.indexOf(itemView);index>=0&&this.children.splice(index,1),this.model.remove(itemView.item)},removeItemById:function(id){var itemView=this._getItemById(id);itemView&&this.removeItem(itemView)},flipSelectedItemsOnlyCards:function(){var flippedCards=[],selectedCards=this._getSelectedCardItems();_.each(selectedCards,function(card){card.bind("commit:action",function(){flippedCards.push(card),flippedCards.length===selectedCards.length&&this.trigger("action:end")},this),card.flip()},this)},flipHorizontalSelectedItems:function(){var items,selectedCards=this._getSelectedCardItems(),selectedItems=this._getSelectedItems();items=_.difference(selectedItems,selectedCards);var selection=new a5.view.SelectedResourceStageItems({children:items});this.region().append(selection.$el),selection.render();var flippedItems=[];items=_.flatten([selectedCards,selection]),_.each(items,function(item){item.bind("commit:action",function(){flippedItems.push(item),flippedItems.length===items.length&&this.trigger("action:end")},this),item.flipHorizontal()},this)},flipVerticalSelectedItems:function(){var items,selectedCards=this._getSelectedCardItems(),selectedItems=this._getSelectedItems();items=_.difference(selectedItems,selectedCards);var selection=new a5.view.SelectedResourceStageItems({children:items});this.region().append(selection.$el),selection.render();var flippedItems=[];items=_.flatten([selectedCards,selection]),_.each(items,function(item){item.bind("commit:action",function(){flippedItems.push(item),flippedItems.length===items.length&&this.trigger("action:end")},this),item.flipVertical()},this)},rotateSelectedItems:function(anticlockwise){var selectedItems=this._getSelectedItems(),selection=new a5.view.SelectedResourceStageItems({children:selectedItems});selection.bind("commit:action",function(){this._repositionOffScreenItems(selectedItems).done(function(){this.trigger("action:end")}.bind(this))},this),this.region().append(selection.$el),selection.render(),selection.rotate(anticlockwise)},deleteSelectedItems:function(){_(this._getSelectedItems()).each(function(itemView){this.model.remove(itemView.item),itemView.remove();var index=this.children.indexOf(itemView);index>=0&&this.children.splice(index,1)},this)},deleteAllItems:function(){this.model.empty(),this.model.resetGrids(),_.invoke(this.children,"remove"),this.children=[]},selectItem:function(item){item.$el.addClass("ui-selecting"),this.$el.selectable("refresh"),this.$el.data("uiSelectable")._mouseStop(null)},deselectAll:function(){this.$el.find(".ui-selected").removeClass("ui-selected").addClass("ui-unselecting"),this.$el.selectable("refresh"),this.$el.data("uiSelectable")._mouseStop(null)},onStateChange:function(){this.refresh()},onChange:function(){this.trigger("resources-stage:change")},onDrop:function(e,ui){this.trigger("resource-item:drop",ui.helper)},onItemSelectedStart:function(e,ui){var self=this;this.$el.data("uiSelectable").refresh=function(){self.originalSelectableRefreshFn.apply(this,arguments),this.selectees.each(function(){var $this=$(this),pos=$this.offset(),data=$.data(this,"selectable-item");data&&(data.right=pos.left+$this[0].getBoundingClientRect().width,data.bottom=pos.top+$this[0].getBoundingClientRect().height)})}},onItemUnselecting:function(e,ui){var $transitionNode=$(ui.unselecting).find(".transition-running");$transitionNode.length>0?$transitionNode.one("transitionend",function(){this.region().append($(ui.unselecting)),a5.utils.applySVGIE11Fix()}.bind(this)):(this.region().append($(ui.unselecting)),a5.utils.applySVGIE11Fix())},onItemUnselected:function(e,ui){var $transitionNode=$(ui.unselected).find(".transition-running");$transitionNode.length>0?$transitionNode.one("transitionend",function(){this.region().append($(ui.unselected)),a5.utils.applySVGIE11Fix()}.bind(this)):(this.region().append($(ui.unselected)),a5.utils.applySVGIE11Fix());var resourceStageItem=this._getItemById($(ui.unselected).attr("data-item-id")),box=resourceStageItem.getBoundingBox(),snap=this.model.generalGrid.snap({x:box.left,y:box.top}),dx=snap.x-box.left,dy=snap.y-box.top;resourceStageItem.moveEnd({x:dx,y:dy})},onItemClick:function(e){var $item=$(e.currentTarget);$item.hasClass("ui-selected")?$item.removeClass("ui-selected").addClass("ui-unselecting"):$item.addClass("ui-selecting"),e.metaKey||e.ctrlKey||this.$el.find(".ui-selected").removeClass("ui-selected").addClass("ui-unselecting"),this.$el.selectable("refresh"),this.$el.data("uiSelectable")._mouseStop(null)},onItemDragStart:function(e,ui){this.matrix=this.$el.transformationMatrix(!0),this.scale=this.matrix.getScale(),this.origin={sx:ui.position.left,sy:ui.position.top,x:ui.position.left/this.scale,y:ui.position.top/this.scale},this.origin.ox=(parseFloat(ui.helper.css("left"))||0)-this.origin.x,this.origin.oy=(parseFloat(ui.helper.css("top"))||0)-this.origin.y,this.origin.sox=this.origin.ox*this.scale,this.origin.soy=this.origin.oy*this.scale,ui.helper.hasClass("ui-selected")||this.$el.find(".ui-selected").removeClass("ui-selected").addClass("ui-unselecting"),ui.helper.addClass("ui-selecting"),this.$el.selectable("refresh"),this.$el.data("uiSelectable")._mouseStop(null),this.trigger("resource-stage-item:drag");var selectedItems=this._getSelectedItems();_.each(selectedItems,function(itemView){itemView.$el.addClass("ui-draggable-dragging")},this),this.group=this._getContainmentOfSelectedItems(selectedItems)},onItemDrag:function(e,ui){this.dx=ui.position.left/this.scale-this.origin.x,this.dy=ui.position.top/this.scale-this.origin.y;var group=this.group,bounds=this._getBoundingBox();group.left+this.dx<bounds.left&&(this.dx=bounds.left-group.left),group.right+this.dx>bounds.right&&(this.dx=bounds.right-group.right),group.top+this.dy<bounds.top&&(this.dy=bounds.top-group.top),group.bottom+this.dy>bounds.bottom&&(this.dy=bounds.bottom-group.bottom),ui.position.left=this.origin.x+this.dx+this.origin.ox,ui.position.top=this.origin.y+this.dy+this.origin.oy,_(this._getSelectedItems()).invoke("move",{x:this.dx,y:this.dy})},onItemDragStop:function(e,ui){var snap=this.model.generalGrid.snap({x:this.dx,y:this.dy}),selectedItems=this._getSelectedItems();_.each(selectedItems,function(itemView){itemView.$el.removeClass("ui-draggable-dragging"),itemView.moveEnd(snap)},this)},_getItemById:function(id){return _(this.children).find(function(child){return child.hasId(id)})},_getSelectedItems:function(){return _(this.children).filter(function(child){return child.isSelected()})},_repositionOffScreenItems:function(items){items=items||this._getSelectedItems();var promise,bounds=this._getBoundingBox(),selectionBounds=this._getContainmentOfSelectedItems(items);return selectionBounds.width>bounds.width?promise=this._fitX(items,bounds.width/selectionBounds.width,selectionBounds):selectionBounds.left<bounds.left?promise=this._pushX(items,bounds.left-selectionBounds.left):selectionBounds.right>bounds.right&&(promise=this._pushX(items,bounds.right-selectionBounds.right)),selectionBounds.height>bounds.height?promise=this._fitY(items,bounds.height/selectionBounds.height,selectionBounds):selectionBounds.top<bounds.top?promise=this._pushY(items,bounds.top-selectionBounds.top):selectionBounds.bottom>bounds.bottom&&(promise=this._pushY(items,bounds.bottom-selectionBounds.bottom)),promise||(promise=$.Deferred().resolve().promise()),promise},_pushX:function(items,dx){var promises=[];return _(items).each(function(item){var snap=this.model.generalGrid.snap({x:dx,y:0});snap.x&&(item.$el.addClass("fitX"),promises.push(item.moveWithTransition(snap,"fitX")))},this),$.when.apply(this,promises)},_pushY:function(items,dy){var promises=[];return _(items).each(function(item){var snap=this.model.generalGrid.snap({x:0,y:dy});snap.y&&(item.$el.addClass("fitY"),promises.push(item.moveWithTransition(snap,"fitY")))},this),$.when.apply(this,promises)},_fitX:function(items,scale,bounds){var promises=[];return _(items).each(function(item){var dx,box=item.getBoundingBox();dx=box.left-bounds.left<bounds.width/2?(box.left-bounds.left)*scale-box.left:box.right-bounds.left>bounds.width/2?(box.right-bounds.left)*scale-box.left-box.width:(box.left-bounds.left)*scale-box.left-box.width/2;var snap=this.model.generalGrid.snap({x:dx,y:0});item.$el.addClass("fitX"),promises.push(item.moveWithTransition(snap,"fitX"))},this),$.when.apply(this,promises)},_fitY:function(items,scale,bounds){var promises=[];return _(items).each(function(item){var dy,box=item.getBoundingBox();dy=box.top-bounds.top<bounds.height/2?(box.top-bounds.top)*scale-box.top:box.bottom-bounds.top>bounds.height/2?(box.bottom-bounds.top)*scale-box.top-box.height:(box.top-bounds.top)*scale-box.top-box.height/2;var snap=this.model.generalGrid.snap({x:0,y:dy});item.$el.addClass("fitY"),promises.push(item.moveWithTransition(snap,"fitY"))},this),$.when.apply(this,promises)},_getSelectedCardItems:function(){return _.filter(this.children,function(child){return child instanceof a5.view.CardStageItem&&child.isSelected()})},_getBoundingBox:function(){var box=this.$el[0].getBoundingClientRect();return{left:0,top:0,bottom:this.$el.height(),right:this.$el.width(),width:this.$el.width(),height:this.$el.height(),tleft:0,ttop:0,tbottom:box.height,tright:box.width,twidth:box.width,theight:box.height}},_getContainmentOfSelectedItems:function(items){items=items||this._getSelectedItems();var boxes=_(items).map(function(itemView){return itemView.getBoundingBox()}),maxRight=_(boxes).max(function(box){return box.tright}),minLeft=_(boxes).min(function(box){return box.tleft}),maxBottom=_(boxes).max(function(box){return box.tbottom}),minTop=_(boxes).min(function(box){return box.ttop});return{csstop:minTop.csstop,cssleft:minLeft.cssleft,cssright:maxRight.cssright,cssbottom:maxBottom.cssbottom,top:minTop.top,left:minLeft.left,right:maxRight.right,bottom:maxBottom.bottom,ttop:minTop.ttop,tleft:minLeft.tleft,tright:maxRight.tright,tbottom:maxBottom.tbottom,width:maxRight.right-minLeft.left,height:maxBottom.bottom-minTop.top,twidth:maxRight.tright-minLeft.tleft,theight:maxBottom.tbottom-minTop.ttop}},_createGrids:function(){var resourcesStageGrid=new a5.ResourcesStageGrid({$grid:this.interaction.$(".general-grid")}),resourcesStageClickToAddGrid=new a5.ResourcesStageClickToAddGrid({$grid:this.interaction.$(".click-to-add-grid")});this.model.setGrids({general:resourcesStageGrid,clickToAdd:resourcesStageClickToAddGrid})}},Obj.extend("a5.view.ResourcesStage"),a5.view.SelectedResourceStageItems={init:function(parameters){this.$el=$("<div>",{class:"selected-resource-stage-items"}),this.children=this._initSelectedChildren(parameters.children),this.children=_.sortBy(this.children,function(child){return child.item.$el.index()})},render:function(){var box=this._getBoundingBox();return this.$el.css({left:box.left,top:box.top,width:box.right-box.left,height:box.bottom-box.top}),this._renderChildren(),this.trigger("render"),this.$el},center:function(){var box=this._getBoundingBox();return{x:(box.left+box.right)/2,y:(box.top+box.bottom)/2}},rotate:function(anticlockwise){var klass=anticlockwise?"anticlockwise-rotated":"rotated";this._hasTransition()?(this.$el.one("transitionend",function(){this._commitAction("rotate",{anticlockwise:anticlockwise})}.bind(this)),this.$el.addClass(klass)):(this.$el.addClass(klass),this._commitAction("rotate",{anticlockwise:anticlockwise}))},flipHorizontal:function(){this._hasTransition()?(this.$el.one("transitionend",function(){this._commitAction("flipHorizontal")}.bind(this)),this.$el.addClass("flipped-hor")):(this.$el.addClass("flipped-hor"),this._commitAction("flipHorizontal"))},flipVertical:function(){this._hasTransition()?(this.$el.one("transitionend",function(){this._commitAction("flipVertical")}.bind(this)),this.$el.addClass("flipped-ver")):(this.$el.addClass("flipped-ver"),this._commitAction("flipVertical"))},_hasTransition:function(){return"0s"!==this.$el.css("transitionDuration")},_commitAction:function(action,params){this._removeChildren(),_(this.children).each(function(item){item.item[action](this.center(),params)},this),this.$el.remove(),this.trigger("commit:action")},_renderChildren:function(){_(this.children).each(function(child){child.item.$el.css({left:child.original.cssleft-parseFloat(this.$el.css("left")),top:child.original.csstop-parseFloat(this.$el.css("top"))}),this.$el.append(child.item.$el)},this),a5.utils.applySVGIE11Fix()},_removeChildren:function(){_(this.children).each(function(child){child.item.$el.css({left:child.original.cssleft,top:child.original.csstop}),this.$el.parent().append(child.item.$el)},this)},_initSelectedChildren:function(items){return _(items).chain().filter(function(item){return item.isSelected()}).map(function(item){return{item:item,original:item.getBoundingBox()}}).value()},_getBoundingBox:function(){var boxes=_(this.children).map(function(item){return item.original}),maxRight=_(boxes).max(function(box){return box.tright}),minLeft=_(boxes).min(function(box){return box.tleft}),maxBottom=_(boxes).max(function(box){return box.tbottom}),minTop=_(boxes).min(function(box){return box.ttop});return{top:minTop.top,left:minLeft.left,right:maxRight.right,bottom:maxBottom.bottom,ttop:minTop.ttop,tleft:minLeft.tleft,tright:maxRight.tright,tbottom:maxBottom.tbottom,width:maxRight.right-minLeft.left,height:maxBottom.bottom-minTop.top,twidth:maxRight.tright-minLeft.tleft,theight:maxBottom.tbottom-minTop.ttop}}},Obj.extend("a5.view.SelectedResourceStageItems"),a5.view.ResourceStageItem={template:"a5.view.ResourceStageItem",init:function(parameters){this.item=parameters.item,this.interaction=parameters.interaction,this.generalGrid=parameters.generalGrid,this.$el=$("<div>",{class:"resource-stage-item"}),this.$el.addClass(this.item.type),this.$el.attr("data-item-id",this.item.id),this.$el.attr("data-bank-item-id",this.item.bankItemId)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());this.$el.html(html),this.$el.toggleClass("inline-svg",!!this.item.inline);var matrix=this.item.getTransformMatrix();return this.translateX=0,this.translateY=0,Math.floor(this.item.x)===this.item.x-.5&&(this.translateX=-.5),Math.floor(this.item.y)===this.item.y-.5&&(this.translateY=-.5),matrix=matrix.translate(this.translateX,this.translateY),this.$el.css({left:this.item.x,top:this.item.y,transform:matrix.toString()}),this.makeDraggable(),this.trigger("render"),this.$el},refresh:function(){var matrix=this.item.getTransformMatrix();Math.floor(this.item.x)===this.item.x-.5+this.translateX&&(this.translateX=-.5),Math.floor(this.item.y)===this.item.y-.5+this.translateY&&(this.translateY=-.5),matrix=matrix.translate(this.translateX,this.translateY),this.$el.css({left:this.item.x,top:this.item.y,transform:matrix.toString()}),this.trigger("refresh")},makeDraggable:function(){this.$el.draggable({scope:"resources-"+this.interaction.index})},flipHorizontal:function(origin){this.item.flipHorizontal(origin,{width:this.$el.outerWidth(),height:this.$el.outerHeight()}),this.refresh(),a5.utils.applySVGIE11Fix()},
flipVertical:function(origin){this.item.flipVertical(origin,{width:this.$el.outerWidth(),height:this.$el.outerHeight()}),this.refresh(),a5.utils.applySVGIE11Fix()},rotate:function(origin,params){this.item.rotate(origin,{width:this.$el.outerWidth(),height:this.$el.outerHeight()},params.anticlockwise),this.refresh(),a5.utils.applySVGIE11Fix()},move:function(delta){this.$el.css({left:this.item.x+delta.x,top:this.item.y+delta.y})},moveEnd:function(delta){this.item.moveTo(this.item.x+delta.x,this.item.y+delta.y),this.refresh(),a5.utils.applySVGIE11Fix()},moveWithTransition:function(delta,transition){var deferred=$.Deferred();return this._hasTransition()?(this.$el[0].offsetWidth,this.$el.one("transitionend",function(){this.$el.removeClass(transition),this.moveEnd(delta),deferred.resolve()}.bind(this)),this.move(delta)):(this.$el.removeClass(transition),this.moveEnd(delta),deferred.resolve()),deferred.promise()},moveTo:function(x,y){this.item.moveTo(x,y),this.refresh()},remove:function(){this.$el.remove()},getBoundingBox:function(){var bounds=this.$el.parent()[0].getBoundingClientRect(),box=this.$el[0].getBoundingClientRect(),scale=this.$el.parent().transformationMatrix(!0).getScale(),tleft=box.left-bounds.left,ttop=box.top-bounds.top,tbottom=box.bottom-bounds.top,tright=box.right-bounds.left,left=Math.round(10*tleft/scale)/10,top=Math.round(10*ttop/scale)/10,bottom=Math.round(10*tbottom/scale)/10,right=Math.round(10*tright/scale)/10;return{cssleft:this.item.x,csstop:this.item.y,cssbottom:this.item.y+this.$el.outerHeight(),cssright:this.item.x+this.$el.outerWidth(),left:left,top:top,bottom:bottom,right:right,tleft:tleft,ttop:ttop,tbottom:tbottom,tright:tright,width:right-left,height:bottom-top,twidth:tright-tleft,theight:tbottom-ttop}},getSize:function(){return{width:this.$el.outerWidth(),height:this.$el.outerHeight()}},serializeData:function(){var item={path:A5.SKIN_URL+this.item.path,inline:this.item.inline};return item.inline&&(item.inline=a5.utils.applySVGGradientFix(item.inline)),{item:item}},isSelected:function(){return this.$el.is(".ui-selected")},hasId:function(id){return this.$el.attr("data-item-id")==id},_hasTransition:function(){return"0s"!==this.$el.css("transitionDuration")}},Obj.extend("a5.view.ResourceStageItem"),a5.view.CardStageItem={template:"a5.view.CardStageItem",init:function(parameters){this._super(parameters),_.bindAll(this,"_onClickFlip"),this.$el.on("click",".btn-flip",this._onClickFlip)},render:function(){return this.$el.toggleClass("face-down",this.item.isFaceDown()),this.$el.toggleClass("face-up",this.item.isFaceUp()),this._super(),this.trigger("render"),this.$el},faceUp:function(){this.item.faceUp(),this.$el.removeClass("face-down").addClass("face-up")},faceDown:function(){this.item.faceDown(),this.$el.removeClass("face-up").addClass("face-down")},flip:function(){this._hasTransition()?(this.$el.one("transitionend",function(){this.trigger("commit:action")}.bind(this)),this.item.isFaceUp()?this.faceDown():this.faceUp()):(this.item.isFaceUp()?this.faceDown():this.faceUp(),this.trigger("commit:action"))},flipHorizontal:function(){this.flip()},flipVertical:function(){this.flip()},_onClickFlip:function(e){e.preventDefault(),e.stopPropagation(),this.flip()},_hasTransition:function(){return"0s"!==this.$el.css("transitionDuration")}},a5.view.ResourceStageItem.extend("a5.view.CardStageItem"),a5.view.ResourcesTabPanel={template:"a5.view.ResourcesTabPanel",init:function(parameters){this.banks=parameters.banks,this.addBy=1,this.maxAddBy=parameters.maxAddBy,this.addByEnabled=!0,this.interaction=parameters.interaction,this.children=[],this.$el=$("<div>",{class:"resources-wrapper"}),_.bindAll(this,"onClickMoreResources","onClickTogglePanel","onClickResourceBankItem","onClickRotate","onClickFlipHorizontal","onClickDeleteSelected","onClickDeleteAll","onClickUndo","onClickMinus","onClickAdd","onClickFullscreen","onClickAnticlockwiseRotate","onClickAddAll","onClickAddRandom","onClickAddRandomSelection","onClickReset","onTabActivate","onClickSave","onClickFlipVertical"),this.$el.on("click",".add-resource-button",this.onClickMoreResources),this.$el.on("click",".toggle-button",this.onClickTogglePanel),this.$el.on("click",".items > .resource-item, .resource-group > .resource-item",this.onClickResourceBankItem),this.$el.on("click",".btn-rotate",this.onClickRotate),this.$el.on("click",".btn-anticlockwise-rotate",this.onClickAnticlockwiseRotate),this.$el.on("click",".btn-flip-hor",this.onClickFlipHorizontal),this.$el.on("click",".btn-flip-ver",this.onClickFlipVertical),this.$el.on("click",".btn-delete-selected",this.onClickDeleteSelected),this.$el.on("click",".btn-delete-all",this.onClickDeleteAll),this.$el.on("click",".btn-undo",this.onClickUndo),this.$el.on("click",".btn-minus",this.onClickMinus),this.$el.on("click",".btn-add",this.onClickAdd),this.$el.on("click",".btn-fullscreen",this.onClickFullscreen),this.$el.on("click",".btn-save",this.onClickSave),this.$el.on("click",".btn-add-all",this.onClickAddAll),this.$el.on("click",".btn-add-random",this.onClickAddRandom),this.$el.on("click",".btn-add-random-selection",this.onClickAddRandomSelection),this.$el.on("click",".btn-reset",this.onClickReset)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData()),$root=$("<div>");$root.html(html);var $toolbar=this.$el.find(".resources-toolbar");$toolbar.length>0&&($root.find(".resources-toolbar").remove(),$root.append($toolbar)),this.$el.html($root.html());var banks=this.banks.getPreselectedBanks();_.each(banks,function(bank){var resourceBank=this._renderResourceBank(bank);this.addBank(resourceBank)},this);var indexSelectedBank=this.banks.getIndexOfSelectedBank(banks),bank=banks[indexSelectedBank];return this.$el.find(".resource-tabs").tabs({activate:this.onTabActivate,active:indexSelectedBank}),this.trigger("resource-bank:activate",bank),this.trigger("render"),this.$el},serializeData:function(){return{banks:_(this.banks.getPreselectedBanks()).map(function(bank){return{id:bank.id,name:bank.name,selected:bank.selected}}),addBy:this.addBy}},refresh:function(){this.children=[],this.render()},regionResourceBanks:function(){return this.$el.find(".resource-banks")},addBank:function(bank){this.children.push(bank)},getCurrentResourceBank:function(){return _(this.children).find(function(bankView){return bankView.$el.is(":visible")},this)},getBankById:function(id){return _(this.children).find(function(bankView){return bankView.bank.id===id},this)},resetAddBy:function(){this.addBy=1,this.$el.find(".adder .number").text(this.addBy)},disableAddBy:function(){this.addByEnabled=!1,this.resetAddBy(),this.$el.find(".adder").addClass("disabled")},enableAddBy:function(){this.addByEnabled=!0,this.$el.find(".adder").removeClass("disabled")},isStageEnabled:function(){return!this.regionResourceBanks().hasClass("stage-disabled")},onClickMoreResources:function(e){e.preventDefault(),this.trigger("more-resources:show")},onClickTogglePanel:function(e){e.preventDefault(),this.$el.find(".resources-panel").toggleClass("closed")},onClickResourceBankItem:function(e){e.preventDefault(),this.trigger("resource-bank-item:click",$(e.currentTarget))},onClickFlipHorizontal:function(e){e.preventDefault(),this.trigger("resources-toolbar:flip-horizontal")},onClickFlipVertical:function(e){e.preventDefault(),this.trigger("resources-toolbar:flip-vertical")},onClickRotate:function(e){e.preventDefault(),this.trigger("resources-toolbar:rotate")},onClickAnticlockwiseRotate:function(e){e.preventDefault(),this.trigger("resources-toolbar:rotate",!0)},onClickDeleteSelected:function(e){e.preventDefault(),this.trigger("resources-toolbar:delete-selected")},onClickDeleteAll:function(e){e.preventDefault(),this.trigger("resources-toolbar:delete-all")},onClickUndo:function(e){e.preventDefault(),this.trigger("resources-toolbar:undo")},onClickMinus:function(e){e.preventDefault(),this.addByEnabled&&(this.addBy=_.max([1,this.addBy-1]),this.$el.find(".adder .number").text(this.addBy))},onClickAdd:function(e){e.preventDefault(),this.addByEnabled&&(this.addBy=_.min([this.maxAddBy,this.addBy+1]),this.$el.find(".adder .number").text(this.addBy))},onClickFullscreen:function(e){e.preventDefault()},onClickSave:function(e){e.preventDefault(),this.trigger("resources-toolbar:save")},onClickAddAll:function(e){e.preventDefault(),this.trigger("resources-toolbar:add-all")},onClickAddRandom:function(e){e.preventDefault(),this.trigger("resources-toolbar:add-random")},onClickAddRandomSelection:function(e){e.preventDefault(),this.trigger("resources-toolbar:add-random-selection")},onClickReset:function(e){e.preventDefault(),this.trigger("resources-toolbar:reset")},onTabActivate:function(e,ui){var bankId=ui.newPanel.attr("id"),bank=this.banks.getBankById(bankId);this.trigger("resource-bank:activate",bank)},_renderResourceBank:function(bank){var resourceBank=new a5.view.ResourceBank({bank:bank});return this.regionResourceBanks().append(resourceBank.$el),resourceBank.bind("render",function(){_.each(bank.items,function(item){if(item instanceof a5.model.ResourceBankGroup)this._renderResourceBankGroup(item,resourceBank);else{var resourceBankItem=this._renderResourceBankItem(item,resourceBank);resourceBank.addItem(resourceBankItem)}},this),resourceBank.makeItemsDraggables(this._resourceBankItemHelperFn())},this),resourceBank.render(),resourceBank},_resourceBankItemHelperFn:function(){var self=this;return function(e){for(var $container=$('<div class="resource-item">'),i=0;i<self.addBy;i++){var $svg=$(this).clone(!0).removeAttr("id");$svg.html(a5.utils.applySVGGradientFix($svg.html())),$svg.appendTo($container),0===i&&$container.data("ui-draggable",$(this).data("ui-draggable"))}return $container}},_renderResourceBankGroup:function(group,parent){var resourceBankGroup=new a5.view.ResourceBankGroup({group:group});return parent.regionItems().append(resourceBankGroup.$el),resourceBankGroup.bind("render",function(){_.each(group.items,function(item){var resourceBankItem=this._renderResourceBankItem(item,resourceBankGroup);parent.addItem(resourceBankItem)},this)},this),resourceBankGroup.render(),resourceBankGroup},_renderResourceComposedBankItem:function(item,parent){var resourceComposedBankItem=new a5.view.ResourceComposedBankItem({item:item,interaction:this.interaction});return parent.regionItems().append(resourceComposedBankItem.$el),resourceComposedBankItem.bind("render",function(){_.each(item.composite,function(child){this._renderResourceBankItem(child,resourceComposedBankItem)},this)},this),resourceComposedBankItem.render(),resourceComposedBankItem},_renderResourceBankItem:function(item,parent){if(item instanceof a5.model.ResourceComposedBankItem)return this._renderResourceComposedBankItem(item,parent);var resourceBankItem=new a5.view.ResourceBankItem({item:item,interaction:this.interaction});return parent.regionItems().append(resourceBankItem.$el),resourceBankItem.bind("render",function(){},this),resourceBankItem.render(),resourceBankItem}},Obj.extend("a5.view.ResourcesTabPanel"),a5.view.ResourceBankItem={template:"a5.view.ResourceBankItem",init:function(parameters){this.item=parameters.item,this.interaction=parameters.interaction,this.$el=$("<div>",{class:"resource-item"}),this.$el.attr("data-item-id",this.item.id),this.$el.attr("data-bank-item-id",this.item.id)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html(html),this.trigger("render"),this.$el},makeDraggable:function(helper,appendTo){this.$el.draggable({appendTo:appendTo,helper:helper,revert:"invalid",scope:"resources-"+this.interaction.index,distance:20})},serializeData:function(){var item={path:A5.SKIN_URL+this.item.path,inline:this.item.inline};return item.inline&&(item.inline=a5.utils.applySVGClipPathFix(item.inline),item.inline=a5.utils.applySVGGradientFix(item.inline)),{item:item}}},Obj.extend("a5.view.ResourceBankItem"),a5.view.ResourceComposedBankItem={init:function(parameters){this.interaction=parameters.interaction,this.item=parameters.item,this.$el=$("<div>",{class:"resource-item resource-item-composed"}),this.$el.attr("data-item-id",this.item.id)},render:function(){return this.$el.empty(),this.trigger("render"),this.$el},regionItems:function(){return this.$el},makeDraggable:function(helper,appendTo){this.$el.draggable({appendTo:appendTo,helper:helper,revert:"invalid",scope:"resources-"+this.interaction.index,distance:20})}},Obj.extend("a5.view.ResourceComposedBankItem"),a5.view.ResourceBankGroup={init:function(parameters){this.group=parameters.group,this.$el=$("<div>",{class:"resource-group"}),this.$el.addClass("resource-group-"+this.group.id)},render:function(){return this.$el.empty(),this.trigger("render"),this.$el},regionItems:function(){return this.$el}},Obj.extend("a5.view.ResourceBankGroup"),a5.view.ResourceBank={template:"a5.view.ResourceBank",init:function(parameters){this.bank=parameters.bank,this.addFaceMode="down",this.$el=$("<div>",{class:"resource-bank",id:this.bank.id}),this.$el.addClass("resource-bank-"+this.bank.id),_.bindAll(this,"onItemDragStart","onItemDrag","onItemDragStop","onClickFaceUpMode","onClickFaceDownMode"),this.$el.on("dragstart",".resource-item",this.onItemDragStart),this.$el.on("drag",".resource-item",this.onItemDrag),this.$el.on("dragstop",".resource-item",this.onItemDragStop),this.$el.on("click",".btn-face-up-mode",this.onClickFaceUpMode),this.$el.on("click",".btn-face-down-mode",this.onClickFaceDownMode),this.children=[]},render:function(){var template=this.template+_.str.classify(this.bank.name),html=a5.service.templates.render(template,this.serializeData());return""===html&&(html=a5.service.templates.render(this.template,this.serializeData())),this.$el.html(html),this.trigger("render"),this.$el},regionItems:function(){return this.$el.find(".items")},addItem:function(item){this.children.push(item)},getItems:function(){return this.children},getItemsBySelector:function(selector){return _(this.children).filter(function(child){return child.$el.is(selector)})},makeItemsDraggables:function(helper){_(this.children).invoke("makeDraggable",helper,this.$el)},serializeData:function(){return{bank:{name:this.bank.name,items:this.bank.items}}},onItemDragStart:function(e,ui){this.matrix=this.$el.transformationMatrix(!0),this.scale=this.matrix.getScale(),this.origin={sx:ui.offset.left,sy:ui.offset.top},"numeral-cards"===this.bank.id&&ui.helper.addClass("face-"+this.addFaceMode);var pX=100*e.offsetX/ui.helper.width(),pY=100*e.offsetY/ui.helper.height();ui.helper.css("transform-origin",pX+"% "+pY+"%")},onItemDrag:function(e,ui){var bounds=$("#activity")[0].getBoundingClientRect(),elem=ui.helper[0].getBoundingClientRect(),sdx=ui.offset.left-this.origin.sx,sdy=ui.offset.top-this.origin.sy;ui.offset.left<bounds.left?sdx=sdx+bounds.left-ui.offset.left:ui.offset.left>bounds.right-elem.width&&(sdx+=bounds.right-elem.width-ui.offset.left),ui.offset.top<bounds.top?sdy=sdy+bounds.top-ui.offset.top:ui.offset.top>bounds.bottom-elem.height&&(sdy=sdy+bounds.bottom-elem.height-ui.offset.top),ui.position.left=(this.origin.sx+sdx-this.$el.parents(".resources-panel").offset().left)/this.scale,ui.position.top=(this.origin.sy+sdy-this.$el.parents(".resources-panel").offset().top)/this.scale},onItemDragStop:function(e,ui){},onClickFaceDownMode:function(e){this.addFaceMode="down"},onClickFaceUpMode:function(e){this.addFaceMode="up"}},Obj.extend("a5.view.ResourceBank"),a5.view.RightsView={template:"a5.view.dialog.Rights",init:function(params){this.resources=params.resources,this.$el=$("<div>",{title:"Rights"})},show:function(){a5.view.dialog.display("a5.view.dialog.Rights",this._serializeData())},_serializeData:function(){return{dialogClass:"rights-dialog",resources:_.filter(this.resources,function(res){return!!res.rights})}}},Obj.extend("a5.view.RightsView"),a5.view.ExportFormatSelect={template:"a5.view.dialog.ExportFormatSelect",init:function(parameters){this.$button=parameters.$button,this.formats=this._getFormats(),this.$el=$("<div>",{class:"export-format-select"}),_.bindAll(this,"onClickDownload","onClickItem","onClickButton"),this.$el.on("click",".btn-download",this.onClickDownload),this.$el.on("click",".export-format",this.onClickItem),this.$button.on("click",this.onClickButton)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html(html),this.trigger("render"),this.$el},open:function(){0===this.$el.parent().length&&(this.$button.after(this.$el),this.render()),this.$el.show(),this.$button.attr("aria-expanded",!0),this.visible=!0},close:function(){this.$el.hide(),this.$button.attr("aria-expanded",!1),this.visible=!1},serializeData:function(){return{formats:this.formats}},onClickDownload:function(e){e.stopPropagation(),e.preventDefault();var formats=this._getSelectedFormats();formats.length>0&&(this.trigger("submit",formats),this.close())},onClickButton:function(e){e.preventDefault(),this.formats.length>1?this.visible?this.close():this.open():this.trigger("submit",this.formats)},onClickItem:function(e){this.$el.find(".active").removeClass("active"),$(e.currentTarget).addClass("active")},_getFormats:function(){var formats=a5.dp.config.bookNotesExportFormats;return formats=formats.split(","),formats=_(formats).invoke("trim")},_getSelectedFormats:function(){return this.$el.find(".export-format.active").map(function(){return $(this).attr("data-format")}).toArray()}},Obj.extend("a5.view.ExportFormatSelect"),a5.view.PPQuiz={init:function(parameters){this.interaction=parameters.interaction,this._super(this.interaction,null,parameters.$el),this.config=parameters.config,this.globalScore=0,this._ready=a5.mainBuilder.renderInteractionsDelayed(this.config.list,"pp-quiz").then(function(){a5.tasks.clear("pp-quiz")}),this.initQuestions(),this.config.countdownTimer&&this.initCountdownTimer(),this.config.allowUserSelection?(this.teamSelector=new a5.view.PPQuizTeamSelect({max:this.config.numberOfTeams,interaction:this.interaction,autoOpen:!0}),this.config.numberOfTeams=this.teamSelector.value(),this.teamSelector.bind("submit",function(){this.config.numberOfTeams=this.teamSelector.value()},this),this.teamSelector.bind("close",this.onTeamSelection,this)):(this.initTeams(),this.initTurn(),this.initBoard()),this.bindEvents()},bindEvents:function(){this.unbindEvents(),this.interaction.bind("pp-quiz:new",this.onNewGame,this),this.interaction.bind("pp-quiz:restart",this.onRestartGame,this),a5.eventBus.bind("interaction:check_answer",this.onCheckAnswer,this)},unbindEvents:function(){this.interaction.unbind("pp-quiz:new",this.onNewGame),this.interaction.unbind("pp-quiz:restart",this.onRestartGame),a5.eventBus.unbind("interaction:check_answer",this.onCheckAnswer)},render:function(){return this.node.addClass("ppquiz--loading"),this._ready.done(function(){this.node.removeClass("ppquiz--loading")}.bind(this)),this.teamSelector?this.teamSelector.render():this.renderBoard(),a5.mainBuilder.$body.addClass("body--ppquiz"),this.node},renderBoard:function(){this.node.append(this.board.render())},checkGameOver:function(){if(this.completed=_.all(this.questions,function(question){return question.completed}),this.completed&&this.teams.length){var maxScore=_.max(this.teams,function(team){return team.score}).score;this.winners=_.filter(this.teams,function(team){return team.score===maxScore})}},nextTurn:function(){if(this.teams.length){this.currentTeam.active=!1;var index=this.teams.indexOf(this.currentTeam),next=(index+1)%this.teams.length;this.currentTeam=this.teams[next],this.currentTeam.active=!0}},updateScores:function(){var promise;if(this.teams.length){var promises=_.map(this.teams,function(team){return this.getScoresByTeam(team).then(function(results){team.score=results.human().correct()}.bind(this))},this);promise=$.when.apply($,promises)}else promise=this.getScores().then(function(results){this.globalScore=results.human().correct()}.bind(this));return promise},refresh:function(){this.board.refresh()},initBoard:function(){this.board=new a5.view.PPQuizBoard({parent:this})},initTeams:function(){this.teams=[],this.config.numberOfTeams>1&&(this.teams=_.times(this.config.numberOfTeams,function(team){return{id:team+1,active:!1,score:0}},this))},initTurn:function(){this.teams.length&&(this.currentTeam=_.first(this.teams),this.currentTeam.active=!0)},initQuestions:function(){var questions=[],categories=this.config.groups,first=_.first(categories);1===categories.length&&_.isNull(first.id)?(categories=[],questions=first.questions):questions=_.chain(categories).pluck("questions").flatten().value(),this.questions=_.map(questions,function(question){return{interaction:question.interaction,team:null,total:question.score,score:null,completed:!1}})},initCountdownTimer:function(){this.countdownTimer=new a5.view.PPQuizTimerManager({maxDuration:this.config.maxDuration,alarm:this.config.alarm})},getScores:function(){var promises=_.map(this.questions,function(question){return question.interaction.getResultsAsync()},this);return $.when.apply($,promises).then(function(){var resultList=new a5.ResultList,results=Array.prototype.slice.call(arguments);return _.each(results,function(result){resultList.push(result)},this),resultList}.bind(this))},getScoresByTeam:function(team){var promises=_.chain(this.questions).where({team:team}).map(function(question){return question.interaction.getResultsAsync()},this).value();return $.when.apply($,promises).then(function(){var resultList=new a5.ResultList,results=Array.prototype.slice.call(arguments);return _.each(results,function(result){resultList.push(result)},this),resultList}.bind(this))},getQuestionFromInteraction:function(index){return _.find(this.questions,function(question){return question.interaction.index===index})},onNewGame:function(){this.unbindEvents(),this.board.clear(),a5.mainBuilder.resetAll()},onRestartGame:function(){this.completed=!1,this.globalScore=0,_.each(this.questions,function(question){question.team=null,question.score=null,question.completed=!1}),_.each(this.teams,function(team){team.active=!1,team.score=0}),this.initTurn(),this.board.clear(),this.countdownTimer&&this.countdownTimer.stop(),this.refresh()},onCheckAnswer:function(){this.countdownTimer&&this.countdownTimer.stop()},onTeamSelection:function(){this.initTeams(),this.initTurn(),this.initBoard(),this.renderBoard()}},a5.views.interaction.BaseView.extend("a5.view.PPQuiz"),a5.view.PPQuizBoard={template:"a5.view.PPQuizBoard",gameOverTemplate:"a5.view.PPQuizGameOver",init:function(parameters){this.quiz=parameters.parent;var html=a5.service.templates.render(this.template,this.serializeData());this._super(null,this.quiz,$(html)),this.buttons=[]},render:function(){return _.each(this.node.find("[data-interaction]"),function(e){this.buttons.push(new a5.view.PPQuizQuestionButton({quiz:this.quiz,$el:$(e)}))},this),this.refresh(),this.node},refresh:function(){if(this.node.find(".ppquiz__score").html(this.quiz.globalScore),_.each(this.quiz.teams,function(team){var $team=this.node.find("[data-team="+team.id+"]");$team.find(".ppquiz__teamScore").html(team.score),$team.toggleClass("ppquiz__team--active",Boolean(team.active))},this),this.quiz.node.toggleClass("ppquiz--completed",Boolean(this.quiz.completed)),this.quiz.completed){var html=a5.service.templates.render(this.gameOverTemplate,{winners:this.quiz.winners,draw:this.quiz.winners.length>0&&this.quiz.winners.length===this.quiz.teams.length});this.node.find(".ppquiz__gameover").replaceWith(html)}},clear:function(){_.invoke(this.buttons,"clear")},serializeData:function(){var config=this.quiz.config,questions=[],categories=config.groups,first=_.first(categories);return 1===categories.length&&_.isNull(first.id)&&(categories=[],questions=first.questions),{teams:this.quiz.teams,categories:categories,questions:questions}}},a5.views.interaction.BaseView.extend("a5.view.PPQuizBoard"),a5.view.PPQuizTeamSelect={DEFAULT_MAX_TEAMS:4,DEFAULT_MIN_TEAMS:1,DEFAULT_TEAMS:2,template:"a5.view.dialog.PPQuizTeamSelect",init:function(parameters){this.MAX_TEAMS=_.min([parameters.max,this.DEFAULT_MAX_TEAMS]),this.MIN_TEAMS=this.DEFAULT_MIN_TEAMS,this.teams=this.DEFAULT_TEAMS,this.interaction=parameters.interaction,this._super({dialogClass:"ppquiz__teamSelectDialog"}),this.$el.on("click",".ppquiz__submit",function(){this.teams=this.$el.find(":selected").val(),this.trigger("submit"),this.close()}.bind(this)),parameters.autoOpen&&this.autoOpen()},serializeData:function(){return{choices:_.range(this.MIN_TEAMS,this.MAX_TEAMS+1)}},value:function(){return parseInt(this.teams,10)},autoOpen:function(){this.interaction.bind("show",function(){this.open()},this,{once:!0})}},a5.view.JQDialog.extend("a5.view.PPQuizTeamSelect"),a5.view.PPQuizQuestionButton={teamTemplate:"a5.view.PPQuizTeam",activityCategoryTemplate:"a5.view.PPQuizActivityCategory",activityMaximumScoreTemplate:"a5.view.PPQuizActivityMaximumScore",init:function(parameters){this.quiz=parameters.quiz,this._super(null,this.quiz,parameters.$el),this.index=parseInt(this.node.attr("data-interaction"),10),this.question=this.quiz.getQuestionFromInteraction(this.index),this.interaction=this.question.interaction,this.curAttempt=this.interaction.checkAttempts,_.bindAll(this,"onClick"),this.bindEvents()},bindEvents:function(){this.unbindEvents(),this.node.on("click",this.onClick),this.interaction.bind("show",this.onInteractionShow,this),this.interaction.bind("hide",this.onInteractionHide,this),this.interaction.bind("pp-quiz:skip",this.onSkip,this),this.interaction.bind("pp-quiz:back",this.onBack,this)},unbindEvents:function(){this.node.off("click",this.onClick),this.interaction.unbind("show",this.onInteractionShow),this.interaction.unbind("hide",this.onInteractionHide),this.interaction.unbind("pp-quiz:skip",this.onSkip),this.interaction.unbind("pp-quiz:back",this.onBack)},clear:function(){this.interaction.reload({skipRestore:!0}),this.curAttempt=this.interaction.checkAttempts,this.refresh()},refresh:function(){this.bindEvents(),this.node.removeAttr("data-last-team"),this.node.toggleClass("ppquiz__question--completed",Boolean(this.question.completed)),this.node.toggleClass("ppquiz__question--correct",Boolean(this.question.score)&&this.question.score.isPercent100()),this.node.toggleClass("ppquiz__question--incorrect",Boolean(this.question.score)&&!this.question.score.isPercent100()),this.question.team&&this.node.attr("data-last-team",this.question.team.id)},attempt:function(){this.interaction.getResultsAsync().then(function(results){this.question.score=results,this.question.team=this.quiz.currentTeam}.bind(this)).then(function(){if(this.question.score.isPercent100())return this.quiz.updateScores()}.bind(this)).then(function(){this.question.completed?this.quiz.nextTurn():(this.question.completed=!this.interaction.hasMoreCheckAttempts()||this.question.score.isPercent100(),this.quiz.checkGameOver(),this.quiz.completed||this.quiz.nextTurn())}.bind(this)).then(function(){this.refresh(),this.quiz.refresh()}.bind(this))},onClick:function(e){var team,html;this.question.completed?team=this.question.team:(team=this.quiz.currentTeam,this.curAttempt&&this.interaction.tryAgain(),this.quiz.countdownTimer&&this.quiz.countdownTimer.start(this.interaction)),team&&(html=a5.service.templates.render(this.teamTemplate,{id:team.id}),a5.utils.setContentInNodes(html,".ppquizTeam",[this.interaction.contentWrap,a5.mainBuilder.$body])),html=a5.service.templates.render(this.activityCategoryTemplate,{category:this.interaction.group}),a5.utils.setContentInNodes(html,".activityCategory",[this.interaction.contentWrap,a5.mainBuilder.$body]),html=a5.service.templates.render(this.activityMaximumScoreTemplate,{score:this.question.total}),a5.utils.setContentInNodes(html,".activityMaximumScore",[this.interaction.contentWrap,a5.mainBuilder.$body]),a5.mainBuilder.goTo(this.index)},onSkip:function(){this.quiz.countdownTimer&&this.quiz.countdownTimer.stop(),a5.mainBuilder.goFirst(),this.quiz.nextTurn(),this.quiz.refresh()},onBack:function(){this.quiz.countdownTimer&&this.quiz.countdownTimer.stop(),a5.mainBuilder.goFirst(),this.curAttempt!==this.interaction.checkAttempts&&(this.attempt(),this.curAttempt=this.interaction.checkAttempts)},onInteractionShow:function(){a5.mainBuilder.$body.addClass("body--ppquizQuestion")},onInteractionHide:function(){a5.mainBuilder.$body.removeClass("body--ppquizQuestion")}},a5.views.interaction.BaseView.extend("a5.view.PPQuizQuestionButton"),a5.view.PPQuizTimerManager={template:"a5.view.PPQuizTimer",init:function(parameters){this.maxDuration=parameters.maxDuration,this.alarm=parameters.alarm,this.alarmAudio=a5.service.media.audio.create(this.alarm)},start:function(interaction){this.$el=a5.utils.findInNodes(".ppquizTimer",[interaction.contentWrap,a5.mainBuilder.$body]),this.currentSecond=this.maxDuration,this.renderTime(),this.timer=new a5.utils.TimerOut(1e3,this.onSecondChanged.bind(this))},renderTime:function(){var html=a5.service.templates.render(this.template,{time:a5.utils.secondsToTime(this.currentSecond,!0)});this.$el=a5.utils.setContentInNodes(html,".ppquizTimer",this.$el)},onSecondChanged:function(){this.currentSecond--,this.renderTime(),0===this.currentSecond?this.end():this.timer.reset()},stop:function(){this.timer&&this.timer.stop(),this.alarmAudio.stop(),this.$el.removeClass("ppquizTimer--timeout"),a5.mainBuilder.$body.removeClass("body--ppquizTimerTimeout")},end:function(){this.$el.addClass("ppquizTimer--timeout"),a5.mainBuilder.$body.addClass("body--ppquizTimerTimeout"),this.alarmAudio.play(),this.trigger("timer:end")}},Obj.extend("a5.view.PPQuizTimerManager"),a5.view.AutoEndResults={init:function(){this.model=a5.mainBuilder.resultsGenerator,this.helpers=this._getHelpers()},display:function(){Handlebars.registerHelper(this.helpers),a5.view.dialog.display("a5.view.AutoEndResults",{dialogClass:"autoendresults-dialog"}),_.keys(this.helpers,function(key){Handlebars.unregisterHelper(key)})},_getHelpers:function(){var self=this;return{score:function(options){return self.model.getScore.call(self.model,options.data.currentInteraction,options.data.currentInteractionGroup)},totalquestions:function(options){return self.model.getTotalquestions.call(self.model,options.data.currentInteraction,options.data.currentInteractionGroup)},correctanswers:function(options){return self.model.getCorrectanswers.call(self.model,options.data.currentInteraction,options.data.currentInteractionGroup)},incorrectanswers:function(options){return self.model.getIncorrectanswers.call(self.model,options.data.currentInteraction,options.data.currentInteractionGroup)},timetaken:function(){return self.model.getTimetaken.call(self.model)},timeout:function(){return self.model.getTimeout.call(self.model)},date:function(){return self.model.getDateString.call(self.model)},attempts:function(){return self.model.getAttempts.call(self.model)},allcorrectattempt:function(attempt){return self.model.getAllCorrectAttempt.call(self.model,parseInt(attempt,10))},unsolved:function(threshold){return self.model.getUnsolved.call(self.model,parseInt(threshold,10))},solved:function(threshold){return self.model.getSolved.call(self.model,parseInt(threshold,10))},notattempted:function(){return self.model.getNotAttempted.call(self.model)},bandfeedback:function(){_.last(arguments);return self.model.getBandFeedbackString.call(self.model,self.model.interaction,_.map([].slice.call(arguments,0,arguments.length-1),function(arg){return parseInt(arg,10)}))},foreachinteraction:function(options){return options.data&&(options.data=Handlebars.createFrame(options.data)),_.chain(a5.mainBuilder.intList).filter(function(i){return this.model.someAutomaticMarked(i)||this.model.someManuallyMarked(i)},this).map(function(i){return options.data.currentInteraction=i,options.data.currentInteractionLabel=""+(i.index+1),options.data.index=i.index+1,options.fn(this,{data:options.data})},this).value().join("")},automaticmarked:function(options){return this.model.someAutomaticMarked(options.data.currentInteraction)?options.fn(this,{data:options.data
}):""}}}},Obj.extend("a5.view.AutoEndResults"),a5.views.interaction.GapMatchView={init:function(model,parent,options){options=options||{},this._super(model,parent,options.node||$('<div class="gap_match_view"></div>')),this.gapsOption=options.gapsOption,this.wordpoolElementClass=options.wordpoolElementClass,this.elementClass=options.elementClass,this.renderWordpool()},renderWordpool:function(){this.wordpool=new a5.views.WordPool(this.model.poolAlignment,!0,this.model.parent,!0),_.each(this.model.poolDropAreas,function(dropArea){this.wordpool.addChild(new a5.views.interaction[this.wordpoolElementClass](dropArea,null,{elementClass:this.elementClass}))},this),this.node.append(this.wordpool.render())},show:function(){this.node.css("visibility","")},hide:function(){this.node.css("visibility","hidden")},adjustGapSize:function(e,size){size&&size.length>=2&&_.each(e.views(),function(v){v.setHolderSize?v.setHolderSize(size[0],size[1]):v.setSize(size[0],size[1])})},adjustGapSizes:function(){_.isUndefined(this.gapsOption)&&(this.gapsOption="samelongest"),this.node.closest(".interaction").addClass(this.gapsOption+"-gaps");var sizes={};if(_.each(this.model.poolDropAreas,function(dropArea){var size,dropAreaView=dropArea.views()[0],$wm=dropAreaView.$(".width-measure");if($wm.length>0){var removeClass=!1,addPrefilled=!1;dropAreaView.node.hasClass("has_drag")||(dropAreaView.node.addClass("has_drag"),removeClass=!0),dropAreaView.node.hasClass("prefilled")&&(dropAreaView.node.removeClass("prefilled"),addPrefilled=!0),$wm.show(),dropAreaView.$wmContent=$wm.find(".content"),size=[dropAreaView.$wmContent.outerWidth(),dropAreaView.$wmContent.outerHeight()],dropAreaView.$wmContent=dropAreaView.$wmContent.clone(),$wm.hide(),removeClass&&dropAreaView.node.removeClass("has_drag"),addPrefilled&&dropAreaView.node.addClass("prefilled")}sizes[dropArea.resident.identifier]=size}),"fixed"!==this.gapsOption){if("between_letters"===this.model.freeDragLocation||"between_words"===this.model.freeDragLocation)return void this.node.closest(".interaction").addClass("gaps_"+this.model.freeDragLocation);if("samelongest"==this.gapsOption||"invisible"==this.gapsOption){var size=[0,0];_.each(sizes,function(e){e[0]>size[0]&&(size[0]=e[0]),e[1]>size[1]&&(size[1]=e[1])}),"samelongest"==this.gapsOption&&_.each(this.model.targetDropAreas,function(dropArea,i){this.adjustGapSize(dropArea,size)},this),_.each(this.model.poolDropAreas,function(dropArea,i){this.adjustGapSize(dropArea,size),dropArea.drag&&this.adjustGapSize(dropArea.drag,size)},this)}"variable"==this.gapsOption&&(_.each(this.model.poolDropAreas,function(dropArea){this.adjustGapSize(dropArea,sizes[dropArea.resident.identifier])},this),_.each(this.model.targetDropAreas,function(dropArea){var size=null;_.each(this.model.mapGapToAnswer[dropArea.identifier],function(cid){cid in sizes&&(size=sizes[cid])}),this.adjustGapSize(dropArea,size)},this)),"invisible"==this.gapsOption&&(this.node.closest(".interaction").addClass("invisible"),_.each(this.node.find(".contentblock > p"),function(cb){var elements=$("<div></div>");_.each($(cb).contents(),function(el){if($(el)[0].nodeType==Node.TEXT_NODE){elements.append($(el).text().trim().split(" ").join(' <div class="drop_area gap_match_gap_view" data-model-id=""><div class="width-measure"></div><div class="drag_holder"><div class="place_holder">&nbsp;</div></div></div> '))}else elements.append(" "),elements.append(el),elements.append(" ")}),$(cb).html(elements)}))}}},a5.views.interaction.BaseView.extend("a5.views.interaction.GapMatchView"),a5.views.interaction.GapMatchWithStacksView={renderWordpool:function(){this.wordpool=new a5.views.WordPool(this.model.poolAlignment,!0,this.model.parent),_.each(this.model.stackAreas,function(stackArea){this.wordpool.addChild(new a5.views.interaction[this.wordpoolElementClass](stackArea,null,{elementClass:this.elementClass}))},this),this.node.append(this.wordpool.render())},adjustGapSizes:function(){_.isUndefined(this.gapsOption)&&(this.gapsOption="samelongest"),this.node.closest(".interaction").addClass(this.gapsOption+"-gaps");var sizes={};if(_.each(this.model.stackAreas,function(stackArea){var size,stackAreaView=stackArea.views()[0],$wm=stackAreaView.$(".width-measure");if($wm.length>0){var removeClass=!1;stackAreaView.node.hasClass("has_drag")||(stackAreaView.node.addClass("has_drag"),removeClass=!0),$wm.show(),stackAreaView.$wmContent=$wm.find(".content"),size=[stackAreaView.$wmContent.outerWidth(),stackAreaView.$wmContent.outerHeight()],stackAreaView.$wmContent=stackAreaView.$wmContent.clone(),$wm.hide(),removeClass&&stackAreaView.node.removeClass("has_drag")}_.each(stackArea.drags,function(drag){sizes[drag.identifier]=size},this)},this),"fixed"!==this.gapsOption){if("between_letters"===this.model.freeDragLocation||"between_words"===this.model.freeDragLocation)return void this.node.closest(".interaction").addClass("gaps_"+this.model.freeDragLocation);if("samelongest"==this.gapsOption||"invisible"==this.gapsOption){var size=[0,0];_.each(sizes,function(e){e[0]>size[0]&&(size[0]=e[0]),e[1]>size[1]&&(size[1]=e[1])}),"samelongest"==this.gapsOption&&_.each(this.model.targetDropAreas,function(dropArea,i){this.adjustGapSize(dropArea,size)},this),_.each(this.model.poolDropAreas,function(dropArea,i){this.adjustGapSize(dropArea,size),dropArea.drag&&this.adjustGapSize(dropArea.drag,size)},this)}"variable"==this.gapsOption&&(_.each(this.model.poolDropAreas,function(dropArea){this.adjustGapSize(dropArea,sizes[dropArea.resident.identifier])},this),_.each(this.model.targetDropAreas,function(dropArea){var size=null;_.each(this.model.mapGapToAnswer[dropArea.identifier],function(cid){cid in sizes&&(size=sizes[cid])}),this.adjustGapSize(dropArea,size)},this)),"invisible"==this.gapsOption&&(this.node.closest(".interaction").addClass("invisible"),_.each(this.node.find(".contentblock > p"),function(cb){var elements=$("<div></div>");_.each($(cb).contents(),function(el){if($(el)[0].nodeType==Node.TEXT_NODE){elements.append($(el).text().trim().split(" ").join(' <div class="drop_area gap_match_gap_view" data-model-id=""><div class="width-measure"></div><div class="drag_holder"><div class="place_holder">&nbsp;</div></div></div> '))}else elements.append(" "),elements.append(el),elements.append(" ")}),$(cb).html(elements)}))}}},a5.views.interaction.GapMatchView.extend("a5.views.interaction.GapMatchWithStacksView"),a5.views.interaction.GapMatchResourcesView={init:function(model,parent,options){var node=$('<div class="gap_match_view with-resources"></div>').addClass(options.classNames),optionsWithNode=_.extend({},options,{node:node});this._super(model,parent,optionsWithNode)}},a5.views.interaction.GapMatchView.extend("a5.views.interaction.GapMatchResourcesView"),a5.views.interaction.GapMatchGapView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_gap_view"),this.node.toggleClass("text-capitalize",model.capitalize&&options.capitalizeGap),!$.support.touch||"between_words"!==this.model.parent.freeDragLocation&&"between_letters"!==this.model.parent.freeDragLocation||this.dragHolder.addClass("touch_drag_holder"),"between_words"!==this.model.parent.freeDragLocation&&"between_letters"!==this.model.parent.freeDragLocation||this.setHolderSize(0,0,!0),this.model.bind("input_update:setAnswer",this.setAnswerInput,this)},updateToThisDrag:function(drag){this._super(drag);var $contentblock=this.node.closest(".contentblock");$contentblock.find(".gap_match_gap_view.has_drag").length===$contentblock.find(".gap_match_gap_view").length?$contentblock.addClass("all-filled"):$contentblock.removeClass("all-filled")},createViewFor:function(model){var view=new a5.views.interaction.GapMatchDragView(model,this,{elementClass:this.elementClass});return this.model.isRevealed()&&view.disable(),view},onDrop:function(event,ui){this._super(event,ui),this.interaction.$(".is-active-target").removeClass("is-active-target")},setAnswer:function(){var setCheck=this.model.isCorrectable();this.setAnswerCheck(setCheck),this.disable()},setAnswerInput:function(){var setCheck=this.model.isCorrectable()&&this.model.isFilled();this.setAnswerCheck(setCheck),this.updateAnswerInputState(setCheck)},setAnswerCheck:function(check){this.$(".check").remove(),check&&(this.updateFeedbackState(this.dragHolder),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(this.model.getCorrect())}),this.bindAnswerFeedback(this.model.getCorrect(),{correct:this.model.isCorrect()}))},showAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.updateToThisDrag(this.model.getCorrect()),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.drag,tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getAnswerFeedback(this.model.getCorrect()):this.model.drag&&this.model.drag.content.clone(!0)})),this.disable()},showNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},showSolutionHint:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},tryAgain:function(){this.$(".check").remove(),this.model.isCorrectable()?(this.updateFeedbackState(this.dragHolder),this.isLocked(this.dragHolder)?this.disable():this.enable()):this.enable()},updateFeedbackState:function(nodes){nodes.removeClass("input-checked-correct input-checked-incorrect input-checked-empty"),this._super(nodes)},updateAnswerInputState:function(check){check&&(this.model.isCorrect()?this.dragHolder.addClass("input-checked-correct"):this.model.isFilled()?this.dragHolder.addClass("input-checked-incorrect"):this.dragHolder.addClass("input-checked-empty"))}},a5.views.interaction.DropArea.extend("a5.views.interaction.GapMatchGapView"),a5.views.interaction.GapMatchGapTextView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_gap_text_view"),this.preserveSize=!0},createViewFor:function(model){var child=new a5.views.interaction.GapMatchDragView(model,this,{elementClass:this.elementClass});return this.$(".width-measure").empty().append(child.node.clone().removeAttr("data-model-id").find("clipPath,linearGradient,radialGradient").removeAttr("id").end()),child}},a5.views.interaction.DropArea.extend("a5.views.interaction.GapMatchGapTextView"),a5.views.interaction.GapMatchStackView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_stack_view"),this.preserveSize=!0},createViewFor:function(model){var child=new a5.views.interaction.GapMatchDragView(model,this,{elementClass:this.elementClass});return this.$(".width-measure").empty().append(child.node.clone().removeAttr("data-model-id").find("clipPath,linearGradient,radialGradient").removeAttr("id").end()),this.model.isHead(model)?(child.enable(),child.node.addClass("gap_match_drag_stack_head")):(child.disable(),child.node.removeClass("gap_match_drag_stack_head")),child}},a5.views.interaction.StackDropArea.extend("a5.views.interaction.GapMatchStackView"),a5.views.interaction.GapMatchDragView={init:function(model,parent,options){this._super(model,parent),this.node.addClass("gap_match_drag"),options.elementClass&&this.node.addClass(options.elementClass),a5.utils.wrapFirstLetter(this.$(".content")),this.node.find("div:not(.image-as-trigger) > img").parent().addClass("image-div"),this.node.find("div > .image-as-trigger").parent().addClass("image-div"),this.model.parent.tts_audio&&this.addTTSPlayer(),this.parent&&this.parent.model.inputStyle&&this.node.attr("style",this.parent.model.inputStyle)},addTTSPlayer:function(){this.tts_player=new a5.views.TTS_Player($(this.model.content).text()),$(this.node.find(".content")).prepend(this.tts_player.render())},onDrag:function(event,ui){this._super(event,ui)}},a5.views.interaction.DragElement.extend("a5.views.interaction.GapMatchDragView"),a5.views.interaction.GapMatchGapNoDropView={init:function(model,parent,options){this._super(model,parent),this.node.addClass("gap_match_gap_view"),this.node.toggleClass("text-capitalize",model.capitalize&&options.capitalizeGap),!$.support.touch||"between_words"!==this.model.parent.freeDragLocation&&"between_letters"!==this.model.parent.freeDragLocation||this.dragHolder.addClass("touch_drag_holder"),this.model.bind("input_update:setAnswer",this.setAnswerInput,this)},updateToThisDrag:function(drag){this._super(drag);var $contentblock=this.node.closest(".contentblock");$contentblock.find(".gap_match_gap_view.has_drag").length===$contentblock.find(".gap_match_gap_view").length?$contentblock.addClass("all-filled"):$contentblock.removeClass("all-filled")},createViewFor:function(model){var view=new a5.views.interaction.GapMatchTileView(model,this);return this.model.isRevealed()&&view.disable(),view},setAnswer:function(){var setCheck=this.model.isCorrectable();this.setAnswerCheck(setCheck),this.disable()},setAnswerInput:function(){var setCheck=this.model.isCorrectable()&&this.model.isFilled();this.setAnswerCheck(setCheck),this.updateAnswerInputState(setCheck)},setAnswerCheck:function(check){this.$(".check").remove(),check&&(this.updateFeedbackState(this.dragHolder),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(this.model.getCorrect())}),this.bindAnswerFeedback(this.model.getCorrect(),{correct:this.model.isCorrect()}))},showAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.updateToThisDrag(this.model.getCorrect()),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.drag,tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getAnswerFeedback(this.model.getCorrect()):this.model.drag&&this.model.drag.content.clone(!0)})),this.disable()},showNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},showSolutionHint:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},tryAgain:function(){this.$(".check").remove(),this.model.isCorrectable()?(this.updateFeedbackState(this.dragHolder),this.isLocked(this.dragHolder)?this.disable():this.enable()):this.enable()},updateFeedbackState:function(nodes){nodes.removeClass("input-checked-correct input-checked-incorrect input-checked-empty"),this._super(nodes)},updateAnswerInputState:function(check){check&&(this.model.isCorrect()?this.dragHolder.addClass("input-checked-correct"):this.model.isFilled()?this.dragHolder.addClass("input-checked-incorrect"):this.dragHolder.addClass("input-checked-empty"))}},a5.views.interaction.FillArea.extend("a5.views.interaction.GapMatchGapNoDropView"),a5.views.interaction.GapMatchGapTextNoDropView={isPoolArea:!0,init:function(model,parent){this._super(model,parent),this.node.addClass("gap_match_gap_text_view"),this.preserveSize=!0},createViewFor:function(model){var child=new a5.views.interaction.GapMatchTileView(model,this);return this.$(".width-measure").empty().append(child.node.clone().removeAttr("data-model-id").find("clipPath,linearGradient,radialGradient").removeAttr("id").end()),child}},a5.views.interaction.FillArea.extend("a5.views.interaction.GapMatchGapTextNoDropView"),a5.views.interaction.GapMatchStackNoDropView={isPoolArea:!0,init:function(model,parent){this._super(model,parent),this.node.addClass("gap_match_stack_view"),this.preserveSize=!0},createViewFor:function(model){var child=new a5.views.interaction.GapMatchTileView(model,this);return this.$(".width-measure").empty().append(child.node.clone().removeAttr("data-model-id").find("clipPath,linearGradient,radialGradient").removeAttr("id").end()),this.model.isHead(model)?(child.enable(),child.node.addClass("gap_match_drag_stack_head")):(child.disable(),child.node.removeClass("gap_match_drag_stack_head")),child}},a5.views.interaction.StackFillArea.extend("a5.views.interaction.GapMatchStackNoDropView");a5.views.interaction.GapMatchTileView={init:function(model,parent){this._super(model,parent),this.isPoolArea=!1,this.node.addClass("gap_match_drag"),a5.utils.wrapFirstLetter(this.$(".content")),this.node.find("div:not(.image-as-trigger) > img").parent().addClass("image-div"),this.node.find("div > .image-as-trigger").parent().addClass("image-div"),this.model.parent.tts_audio&&this.addTTSPlayer()},addTTSPlayer:function(){this.tts_player=new a5.views.TTS_Player($(this.model.content).text()),$(this.node.find(".content")).prepend(this.tts_player.render())}},a5.views.interaction.TileElement.extend("a5.views.interaction.GapMatchTileView"),a5.views.interaction.GapMatchExamsView={init:function(model,parent,gapsOption){this._super(model,parent,$('<div class="gap_match_view"></div>')),this.gapsOption=gapsOption,this.wordpool=new a5.views.WordPool(this.model.poolAlignment,!0,this.model.parent,!0),_.each(this.model.poolDropAreas,function(dropArea){this.wordpool.addChild(new a5.views.interaction.GapMatchGapTextExamsView(dropArea))},this),this.node.append(this.wordpool.render())},adjustGapSize:function(e,size){_.each(e.views(),function(v){v.setHolderSize?v.setHolderSize(size[0],size[1]):v.setSize(size[0],size[1])})},adjustGapSizes:function(){var sizes={};_.each(this.model.poolDropAreas,function(dropArea){var $wm=dropArea.views()[0].$(".width-measure"),$wmContent=$wm.find(".content"),size=[$wmContent.outerWidth(),$wmContent.outerHeight()];$wm.remove(),sizes[dropArea.resident.identifier]=size});var size=[0,0];_.each(sizes,function(e){e[0]>size[0]&&(size[0]=e[0]),e[1]>size[1]&&(size[1]=e[1])}),_.each(this.model.poolDropAreas,function(dropArea,i){var height=sizes[dropArea.resident.identifier][1];this.adjustGapSize(dropArea,[size[0],height])},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.GapMatchExamsView"),a5.views.interaction.GapMatchGapExamsView={init:function(model,parent){this._super(model,parent),this.node.addClass("gap_match_gap_view"),this.model.enumeration&&this.model.enumeration.then(function(enumSymbol){this.node.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}.bind(this)),this.node.attr("tabindex","-1")},updateToInput:function(){this.hideAnswerFeedback()},createViewFor:function(model){return new a5.views.interaction.GapMatchDragExamsView(model,this)},setAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(this.model.getCorrect())}),this.bindAnswerFeedback(this.model.getCorrect(),{correct:this.model.isCorrect()})),this.updateToThisDrag(this.model.drag)},showAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.updateToThisDrag(this.model.getCorrect()),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.drag,tooltip:this.model.drag&&this.model.drag.content.clone(!0)}))},tryAgain:function(){this.$(".check").remove(),this.model.isCorrectable()&&this.updateFeedbackState(this.dragHolder)}},a5.views.interaction.DropArea.extend("a5.views.interaction.GapMatchGapExamsView"),a5.views.interaction.GapMatchGapTextExamsView={init:function(model,parent){this._super(model,parent),this.node.addClass("gap_match_gap_text_view"),this.preserveSize=!0},createViewFor:function(model){var child=new a5.views.interaction.GapMatchDragExamsView(model,this);return this.$(".width-measure").empty().append(child.node.clone().removeAttr("data-model-id").find("clipPath,linearGradient,radialGradient").removeAttr("id").end()),child}},a5.views.interaction.DropArea.extend("a5.views.interaction.GapMatchGapTextExamsView"),a5.views.interaction.GapMatchDragExamsView={init:function(model,parent){this._super(model,parent),this.node.addClass("gap_match_drag gap_match_drag_exams")}},a5.views.interaction.DragElement.extend("a5.views.interaction.GapMatchDragExamsView"),a5.views.interaction.GraphicGapMatchView={init:function(model,parent,options){this._super(model,parent,options),this.node.addClass("graphic_gap_match_view"),this.targetViews=_.map(this.model.targetDropAreas,function(dropArea){return new a5.views.interaction[options.blockElementClass](dropArea,this,{elementClass:options.elementClass})},this),this.interaction=this.model.parent,this._scale=1,this.onWindowResizeThrottleFn=_.throttle(this.onWindowResize,300),_.bindAll(this,"onFontUpdated","onStylesLoaded","onWindowResize","onWindowResizeThrottleFn","onImageLoaded"),this.interaction.bind("rendered",this.onInteractionRendered,this),this.interaction.bind("reset",this.onInteractionReset,this),a5.hooks.interactionFontUpdated.add(this.onFontUpdated),a5.hooks.layoutStylesLoaded.add(this.onStylesLoaded),$(window).on("resize",this.onWindowResizeThrottleFn)},render:function(){return this.wordpool.block.append(_.invoke(this.targetViews,"render")),this.node},onInteractionReset:function(){$(window).off("resize",this.onWindowResizeThrottleFn),a5.hooks.interactionFontUpdated.remove(this.onFontUpdated),a5.hooks.layoutStylesLoaded.remove(this.onStylesLoaded),this.interaction.unbind("rendered",this.onInteractionRendered),this.interaction.unbind("reset",this.onInteractionReset)},onImageLoaded:function(){this.adjustGapSizes()},onInteractionRendered:function(){this.adjustGapSizes()},onFontUpdated:function(){this.adjustGapSizes()},onStylesLoaded:function(){this.adjustGapSizes()},onWindowResize:function(){this.adjustGapSizes()},getScale:function(){return this._scale},setScale:function(){if(this.$image.length){var originalSize=this.originalSize(),currentSize=this.currentSize();this._scale=currentSize.width/originalSize.width}},setImage:function(){this.$image=this.node.find(".block > img").first(),this.$image.length&&(this.image=this.$image.get(0),this.image.complete?this.onImageLoaded():this.$image.on("load",this.onImageLoaded))},adjustGapSize:function(e,size){var scale=this.getScale();size&&size.length>=2&&this._super(e,[size[0]*scale,size[1]*scale])},adjustGapSizes:function(){this.image.complete&&this.interaction.runOutOfFlow(function(){a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.removeBodySubstyle(),this.interaction.addBodySubstyle(),this.setScale(),this._super(),this.adjustBlock(),this.interaction.removeBodySubstyle(),a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.addBodySubstyle()}.bind(this))},adjustBlock:function(){var prevSize=this.curSize;this.curSize=this.currentSize(),this.curSize&&prevSize&&this.curSize.width===prevSize.width&&this.curSize.height===prevSize.height||(this.adjustGapPositions(),this.adjustBlockSize())},adjustBlockSize:function(){_.defer(_.bind(this.wordpool.block.applyBoundingHeight,this.wordpool.block))},adjustGapPositions:function(){_.invoke(this.targetViews,"adjustPosition")},currentSize:function(){return{width:this.$image.width(),height:this.$image.height()}},originalSize:function(){return this.model.originalSize||{width:this.$image[0].naturalWidth,height:this.$image[0].naturalHeight}}},a5.views.interaction.GapMatchView.extend("a5.views.interaction.GraphicGapMatchView"),a5.views.interaction.GraphicGapMatchWithStacksView={init:function(model,parent,options){this._super(model,parent,options),this.node.addClass("graphic_gap_match_view"),this.targetViews=_.map(this.model.targetDropAreas,function(dropArea){return new a5.views.interaction[options.blockElementClass](dropArea,this,{elementClass:options.elementClass})},this),this.interaction=this.model.parent,this._scale=1,this.onWindowResizeThrottleFn=_.throttle(this.onWindowResize,300),_.bindAll(this,"onFontUpdated","onStylesLoaded","onWindowResize","onWindowResizeThrottleFn","onImageLoaded"),this.interaction.bind("rendered",this.onInteractionRendered,this),this.interaction.bind("reset",this.onInteractionReset,this),a5.hooks.interactionFontUpdated.add(this.onFontUpdated),a5.hooks.layoutStylesLoaded.add(this.onStylesLoaded),$(window).on("resize",this.onWindowResizeThrottleFn)},render:function(){return this.wordpool.block.append(_.invoke(this.targetViews,"render")),this.node},onInteractionReset:function(){$(window).off("resize",this.onWindowResizeThrottleFn),a5.hooks.interactionFontUpdated.remove(this.onFontUpdated),a5.hooks.layoutStylesLoaded.remove(this.onStylesLoaded),this.interaction.unbind("rendered",this.onInteractionRendered),this.interaction.unbind("reset",this.onInteractionReset)},onImageLoaded:function(){this.adjustGapSizes()},onInteractionRendered:function(){this.adjustGapSizes()},onFontUpdated:function(){this.adjustGapSizes()},onStylesLoaded:function(){this.adjustGapSizes()},onWindowResize:function(){this.adjustGapSizes()},getScale:function(){return this._scale},setScale:function(){if(this.$image.length){var originalSize=this.originalSize(),currentSize=this.currentSize();this._scale=currentSize.width/originalSize.width}},setImage:function(){this.$image=this.node.find("img").first(),this.$image.length&&(this.image=this.$image.get(0),this.image.complete?this.onImageLoaded():this.$image.on("load",this.onImageLoaded))},adjustGapSizes:function(){this.interaction.runOutOfFlow(function(){a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.removeBodySubstyle(),this.interaction.addBodySubstyle(),this.setScale(),this._super(),this.adjustBlock(),this.interaction.removeBodySubstyle(),a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.addBodySubstyle()}.bind(this))},adjustBlock:function(){var prevSize=this.curSize;this.curSize=this.currentSize(),this.curSize&&prevSize&&this.curSize.width===prevSize.width&&this.curSize.height===prevSize.height||(this.adjustGapPositions(),this.adjustBlockSize())},adjustBlockSize:function(){_.defer(_.bind(this.wordpool.block.applyBoundingHeight,this.wordpool.block))},adjustGapPositions:function(){_.invoke(this.targetViews,"adjustPosition")},currentSize:function(){return{width:this.$image.width(),height:this.$image.height()}},originalSize:function(){return this.model.originalSize||{width:this.$image[0].naturalWidth,height:this.$image[0].naturalHeight}}},a5.views.interaction.GapMatchWithStacksView.extend("a5.views.interaction.GraphicGapMatchWithStacksView"),a5.views.interaction.GraphicGapMatchGapView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_gap_view"),this.$reference=$('<div class="labelAnObject__reference">'),this.$nodes=$(this.node).add(this.$reference),this.preserveSize=!0,this.model.bind("input_update:setAnswer",this.setAnswerInput,this)},render:function(){return this._super(),this.$nodes},adjustPosition:function(){var oLeft=this.model.position[0],oTop=this.model.position[1],newTop=oTop*this.parent.getScale(),newLeft=oLeft*this.parent.getScale();this.$nodes.css({left:newLeft+"px",top:newTop+"px"})},createViewFor:function(model){var view=new a5.views.interaction.GapMatchDragView(model,this,{elementClass:this.elementClass});return this.model.isRevealed()&&view.disable(),view},updateToThisDrag:function(drag){this._super(drag),this.node.toggleClass("labelAnObject__item--withImage",this.node.find(".image-div").length>0)},setAnswer:function(){var setCheck=this.model.isCorrectable();this.setAnswerCheck(setCheck),this.disable()},setAnswerInput:function(){var setCheck=this.model.isCorrectable()&&this.model.isFilled();this.setAnswerCheck(setCheck)},setAnswerCheck:function(check){this.$(".check").remove(),check&&(this.updateFeedbackState(this.dragHolder),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(this.model.getCorrect())}),this.bindAnswerFeedback(this.model.getCorrect(),{correct:this.model.isCorrect()}))},showAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.updateToThisDrag(this.model.getCorrect()),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.drag,tooltip:this.model.drag&&this.model.drag.content.clone(!0)})),this.disable()},showNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},showSolutionHint:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},tryAgain:function(){this.$(".check").remove(),this.model.isCorrectable()?(this.updateFeedbackState(this.dragHolder),this.isLocked(this.dragHolder)?this.disable():this.enable()):this.enable()}},a5.views.interaction.DropArea.extend("a5.views.interaction.GraphicGapMatchGapView"),a5.views.interaction.GraphicGapMatchStackView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_stack_view"),this.preserveSize=!0},createViewFor:function(model){return new a5.views.interaction.GapMatchDragView(model,this,{elementClass:this.elementClass})}},a5.views.interaction.StackDropArea.extend("a5.views.interaction.GraphicGapMatchStackView"),a5.views.interaction.GraphicGapMatchGapNoDropView={init:function(model,parent,options){this.elementClass=options.elementClass,this._super(model,parent),this.node.addClass("gap_match_gap_view"),this.$reference=$('<div class="labelAnObject__reference">'),this.$nodes=$(this.node).add(this.$reference),this.preserveSize=!0,this.model.bind("input_update:setAnswer",this.setAnswerInput,this)},render:function(){return this._super(),this.$nodes},adjustPosition:function(){var oLeft=this.model.position[0],oTop=this.model.position[1],newTop=oTop*this.parent.getScale(),newLeft=oLeft*this.parent.getScale();this.$nodes.css({left:newLeft+"px",top:newTop+"px"})},createViewFor:function(model){var view=new a5.views.interaction.GapMatchTileView(model,this,{elementClass:this.elementClass});return this.model.isRevealed()&&view.disable(),view},updateToThisDrag:function(drag){this._super(drag),this.node.toggleClass("labelAnObject__item--withImage",this.node.find(".image-div").length>0)},onOver:function(event,ui){0==this.node.closest(".pool").length&&this._super(event,ui)},setAnswer:function(){var setCheck=this.model.isCorrectable();this.setAnswerCheck(setCheck),this.disable()},setAnswerInput:function(){var setCheck=this.model.isCorrectable()&&this.model.isFilled();this.setAnswerCheck(setCheck)},setAnswerCheck:function(check){this.$(".check").remove(),check&&(this.updateFeedbackState(this.dragHolder),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(this.model.getCorrect())}),this.bindAnswerFeedback(this.model.getCorrect(),{correct:this.model.isCorrect()}))},showAnswer:function(){this.$(".check").remove(),this.model.isCorrectable()&&(this.updateFeedbackState(this.dragHolder),this.updateToThisDrag(this.model.getCorrect()),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.drag,tooltip:this.model.drag&&this.model.drag.content.clone(!0)})),this.disable()},showNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},showSolutionHint:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},tryAgain:function(){this.$(".check").remove(),this.model.isCorrectable()&&this.updateFeedbackState(this.dragHolder),this.enable()}},a5.views.interaction.FillArea.extend("a5.views.interaction.GraphicGapMatchGapNoDropView"),a5.views.OMPairsInteraction={NODE_TEMPLATE:'<div class="pairs_view"></div>',init:function(model,parent,interaction){this._super(model,parent,$(this.NODE_TEMPLATE)),this.createWordPoolAndDrags(this.model.responses,interaction),"bottom"===this.model.poolAlignment?(this.node.append(this.createGaps(interaction)),this.node.append(this.wordpool.render())):(this.node.append(this.wordpool.render()),this.node.append(this.createGaps(interaction))),this.model.isTapTarget()&&$(document).on("touchend",_.bind(this.onBodyClick,this))},onBodyClick:function(e){0===$(e.target).parents(".drag_holder").length&&0===$(e.target).parents(".drag_element").length&&this.selected&&this.setSelected(!1)},createWordPoolAndDrags:function(responses,interaction){var wordpool=new a5.views.WordPoolSimple(this.model.poolAlignment,this,!0,interaction,!0),drags=[];_.each(responses,function(response){var dragElement=new a5.views.OMPairsDragElement(response,null,interaction,this);if(drags.push(dragElement),!response.isPrefilled()){
var dropPoolElement=new a5.views.interaction.SimpleDropArea(null,wordpool,interaction);dropPoolElement.setDrag(dragElement),this.model.isTapTarget()&&this._bindPoolTapTargetDropEvent(dropPoolElement),wordpool.addChild(dropPoolElement)}},this),this.wordpool=wordpool,this.drags=drags},_bindPoolTapTargetDropEvent:function(dropPoolElement){var mainView=this;dropPoolElement.node.click(_.bind(function(){mainView.selected&&!this.drag&&(this.drop(mainView.selected),mainView.setSelected(!1))},dropPoolElement))},createGaps:function(interaction){var gapsContainer=$("<div/>");gapsContainer.addClass("gaps_container "+this.model.pairAlignment);var views=_.map(this.model.gaps,function(gap){var view=new a5.views.OMPairsTextgap(gap,this,interaction),drag=gap.isPrefilled()?this.getDragViewByIdentifier(gap.correctResponse):null;return view.setDrag(drag),gapsContainer.append(view.render()),view},this);return this.views=views,gapsContainer},getDragViewById:function(id){return _.find(this.drags,function(el){return el.node.attr("data-model-id")===id})},getDragViewByIdentifier:function(id){return _.find(this.drags,function(el){return el.model.identifier===id})},getAvailablePoolAreas:function(){return this.wordpool.getAvailablePoolAreas()},getAvailableViews:function(){return _.filter(this.views,function(area){return null===area.drag})},setSelected:function(view){(this.selected||this.selected===view)&&this.selected.deselect(),view&&this.selected!==view?(this.selected=view,this.selected.select()):this.selected=void 0},moveDragViewToPool:function(drag){this.wordpool.moveDragViewToPool(drag)}},a5.views.interaction.BaseView.extend("a5.views.OMPairsInteraction"),a5.views.OMPairsTextgap={init:function(model,parent,interaction){this._super(model,parent,interaction),this.node.addClass("ompairs_gap"),this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this)),this.node.toggleClass("drop-indicator",this.model.dropIndicator),_.bindAll(this,"onShowAnswers","onFeedback","onInput","onClick","onKeydown"),this.model.bind("state_update:answers",this.onShowAnswers),this.model.bind("state_update:feedback",this.onFeedback),this.model.bind("state_update:input",this.onInput),this.enable()},onClick:function(){this.tapTarget()},onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.tapTarget()},tapTarget:function(){this.parent.selected&&!this.model.value&&(this.drop(this.parent.selected),this.parent.setSelected(!1))},drop:function(drag){this._super(drag),"input"===this.model.state&&this.model.updateValue(drag.model)},undrop:function(){this._super(),"input"===this.model.state&&this.model.updateValue(null)},onInput:function(){if(!this.model.isPrefilled()){this.$(".check").remove(),this.updateFeedbackState(this.node);var value=this.model.value;if(this.drag&&this.parent.moveDragViewToPool(this.drag),this.enable(),value){var drag=this.parent.getDragViewByIdentifier(value);this.drop(drag),this.model.lockAnswer()&&(this.disable(),this.drag.disable())}}},onFeedback:function(){this.model.isPrefilled()||(this.$(".check").remove(),this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect()}),this.disable())},onShowAnswers:function(){if(!this.model.isPrefilled()){this.$(".check").remove(),this.drag&&this.parent.moveDragViewToPool(this.drag);var drag=this.parent.getDragViewByIdentifier(this.model.correctResponse);this.drop(drag),this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.isFilled()}),this.disable()}},disable:function(){this._super(),this.model.parent.isTapTarget()&&!this.model.isPrefilled()&&(this.node.off("click",this.onClick),this.node.off("keydown",this.onKeydown))},enable:function(){this._super(),this.model.parent.isTapTarget()&&!this.model.isPrefilled()&&(this.node.on("click",this.onClick),this.node.on("keydown",this.onKeydown))}},a5.views.interaction.SimpleDropArea.extend("a5.views.OMPairsTextgap"),a5.views.OMPairsDragElement={init:function(model,parent,interaction,mainView){this._super(model,parent,interaction),this.node.addClass("om-pairs-element"),_.bindAll(this,"disable","onInput","onClick","onDoubleTap","onKeydown"),this.model.bind("state_update:answers",this.disable),this.model.bind("state_update:feedback",this.disable),this.model.bind("state_update:input",this.onInput),this.enable(),this.mainView=mainView},_bindDoubleTap:function(){this.hammer=new Hammer.Manager(this.node[0],{});var doubleTap=new Hammer.Tap({event:"doubletap",taps:2});this.hammer.add(doubleTap),this.hammer.on("doubletap",this.onDoubleTap)},_unbindDoubleTap:function(){this.hammer&&this.hammer.off("doubletap",this.onDoubleTap)},activate:function(moveToPool){this.model.parent.isTapItem()?this.model.isInPool()?this.tapItem():moveToPool&&this.moveDragToPool():this.model.parent.isTapTarget()&&this.selectTarget()},select:function(){this.node.addClass("selected")},deselect:function(){this.node.removeClass("selected")},selectTarget:function(e){this.mainView.selected!==this&&this.mainView.setSelected(this)},tapItem:function(e){if(this.model.isInPool()&&"input"===this.model.state){var view=_.first(this.mainView.getAvailableViews());view&&view.drop(this)}},onClick:function(){this.activate(!1)},onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.activate(!0)},onDoubleTap:function(e){this.moveDragToPool()},moveDragToPool:function(){this.model.isInGap()&&"input"===this.model.state&&(this.parent.parent.moveDragViewToPool(this),this.mainView.selected==this&&this.mainView.setSelected(!1))},onInput:function(){this.model.isPrefilled()||this.enable()},enable:function(){this._super(),this.model.isPrefilled()||!this.model.parent.isTapItem()&&!this.model.parent.isTapTarget()||(this.disableDraggable(),this.node.on("click",this.onClick),this.node.on("keydown",this.onKeydown),this.node.attr("tabindex",0),this._bindDoubleTap())},disable:function(){this._super(),this.model.isPrefilled()||!this.model.parent.isTapItem()&&!this.model.parent.isTapTarget()||(this.node.off("click",this.onClick),this.node.off("keydown",this.onKeydown),this._unbindDoubleTap(),this.mainView.setSelected(!1))}},a5.views.interaction.SimpleDragElement.extend("a5.views.OMPairsDragElement"),a5.views.OMPairsViewDD={init:function(model,parent,node){this._super(model,parent,node)},reUp:function(event,ui){var interaction=window.a5.mainBuilder.curInteraction;$("#content-"+interaction.index+" .wordpool .drop_item_zone").droppable("disable"),_.each($("#content-"+interaction.index+" .wordpool .drop_item_zone"),function(w){0==$(w).children().length&&$(w).droppable("enable")}),$(this).parent().removeClass("hovered hwb"),$("#content-"+interaction.index).removeClass("drop_indicator");var evtTarget=event.srcElement||event.originalEvent.target;($(evtTarget).is(".drag_audio_player")||$(evtTarget).is(".image-as-trigger .play-button"))&&$(evtTarget).addClass("no-play"),ui.helper.draggable("option","scroll",!1)},fixBorder:function(event,ui){var interaction=window.a5.mainBuilder.curInteraction;$("#content-"+interaction.index+" .ui-draggable-dragging").removeClass("dragging_over");var evtTarget=event.srcElement||event.originalEvent.target;($(evtTarget).is(".drag_audio_player")||$(evtTarget).is(".image-as-trigger .play-button"))&&$(evtTarget).removeClass("no-play")},showOver:function(event,ui){var interaction=window.a5.mainBuilder.curInteraction,self=this;$("#content-"+interaction.index+".ui-draggable-dragging").addClass("dragging_over"),self.model.interaction.options.dropIndicatorIsTrue()?($("#content-"+interaction.index).addClass("drop_indicator"),$(this).addClass("hovered")):$(this).addClass("hwb")},removeOver:function(event,ui){var interaction=window.a5.mainBuilder.curInteraction;$("#content-"+interaction.index+".ui-draggable-dragging").removeClass("dragging_over"),$("#content-"+interaction.index).removeClass("drop_indicator"),$(this).removeClass("hovered hwb")},handleCardDropOnWordpool:function(event,ui,c){var interaction=window.a5.mainBuilder.curInteraction,free=_.first(_.filter($(c).find("> .drop_item_zone"),function(el){return 0==el.children.length}));interaction.model.removeItem(ui.draggable.attr("id").split("-")[1]),this.resize(ui.draggable.parent(),ui.draggable),$("#content-"+interaction.index+" .ui-draggable-dragging").removeClass("dragging_over"),$("#content-"+interaction.index).removeClass("drop_indicator"),ui.draggable.parent().removeClass("has_drag_item"),ui.draggable.parents(".drop_zone").removeClass("hovered hwb"),ui.draggable.appendTo($(free)),this.resize($(free),ui.draggable),ui.draggable.css({position:"relative",top:"0px",left:"0px"}),$(free).parent().removeClass("hovered hwb"),$("#content-"+interaction.index+" .drop_item_zone").droppable("enable")},handleCardDrop:function(event,ui,c){var interaction=window.a5.mainBuilder.curInteraction,id=_.isUndefined($(c).attr("id"))?$(c).parent().attr("id"):$(c).attr("id");_.each(interaction.model.items[id.split("-")[1]],function(item){interaction.model.removeItem(item),$(c).find(".drag_item").appendTo($("#content-"+interaction.index).find(".drop_item_zone:empty:first"))},this),"OR"==id.split("-")[0]?interaction.model.removeItem(ui.draggable.attr("id").split("-")[1]):interaction.model.draggedItem(ui.draggable.attr("id").split("-")[1],id.split("-")[1]),this.resize(ui.draggable.parent(),ui.draggable),$("#content-"+interaction.index+".ui-draggable-dragging").removeClass("dragging_over"),$("#content-"+interaction.index).removeClass("drop_indicator"),ui.draggable.parent().removeClass("has_drag_item"),ui.draggable.parents(".drop_zone").removeClass("hovered hwb"),ui.draggable.appendTo(c),this.resize($(c),ui.draggable),ui.draggable.css({position:"relative",top:"0px",left:"0px"}),$(c).parent().removeClass("hovered hwb"),$(c).addClass("has_drag_item"),$("#content-"+interaction.index+".drop_item_zone").droppable("enable"),this.applyContainment(ui.draggable)},wordpoolMove:function(event,ui){var interaction=window.a5.mainBuilder.curInteraction;$("#content-"+interaction.index).css({"margin-top":"0"}),$("#content-"+interaction.index+" .reset_position").removeClass("hidden").show()},resize:function($zone,$item){if($zone.hasClass("drop_item_zone")){$zone.css({width:"auto",height:"auto"});var width=$item.width(),height=$item.height();$zone.css({width:width+12,height:height})}},applyContainment:function($drag){if(!("containment"in this.draggableOptions)){var interaction=window.a5.mainBuilder.curInteraction,$container=$("#content-"+interaction.index),x1=$container.offset().left-$drag.width(),x2=$container.offset().left+$container.width(),y2=$(document).height();$drag.draggable("option","containment",[x1,0,x2,y2])}},applyAllContainments:function(){if(!("containment"in this.draggableOptions)){var interaction=window.a5.mainBuilder.curInteraction,dragItems=$("#content-"+interaction.index+" .drag_item");_(dragItems).each(function(dragItem){this.applyContainment($(dragItem))},this)}}},a5.views.interaction.BaseView.extend("a5.views.OMPairsViewDD"),a5.views.OMPairsViewPool={POOL_HANDLE_TEMPLATE:"a5.view.WordpoolDragHandle",init:function(model,node,parentNode,poolIds,distractors,targetIds,gaptextaudio){this.gaptextaudio=gaptextaudio,this.node=$('<div class="ddm_wordpool_view"></div>'),this.model=model;var wordpool=$("<div class='wordpool'></div>"),html=a5.service.templates.render(this.POOL_HANDLE_TEMPLATE),$free=$(html);wordpool.append($free);var pools=[];_.each(poolIds,function(id){var contentNode=$(node).find("simpleAssociableChoice[identifier='"+id+"']").first(),cn=$("<div></div>");model.interaction.buildModel(cn,$(contentNode));var html=$('<div class="drop_item_zone has_drag_item orig_'+id+'" id="OR-'+id+'"><div class="drag_item om-pairs-element" id="DI-'+id+'"></div></div>');html.find(".drag_item").append(cn),pools.push(html)}),_.each(distractors,function(d,index){var id=d[0],label=d[1];_.include(poolIds,id)||_.include(targetIds,id)||pools.push('<div class="drop_item_zone has_drag_item orig_D'+index+'" id="OR-D'+index+'"><div class="drag_item om-pairs-element" id="DI-D'+index+'"><div>'+label+"</div></div></div>")}),this.render_tts_to_wordpool(pools),_.each(_.shuffle(pools),function(drag){wordpool.append(drag)}),this.node.append(wordpool)},render_tts_to_wordpool:function(wordpool){if(this.gaptextaudio)for(var i=0;i<wordpool.length;i++){wordpool[i]=$(wordpool[i]);var text=wordpool[i].find(".drag_item").not(".hidden").text(),player=new a5.views.TTS_Player(text);wordpool[i].find(".drag_item div").prepend(player.render())}},events:function(){},render:function(){return this.node}},a5.views.OMPairsViewDD.extend("a5.views.OMPairsViewPool"),a5.views.OMPairsViewTarget={init:function(model,node,parentNode,targetIds,enumAnswer,pairAlignment,gaptextaudio){this.gaptextaudio=gaptextaudio,this._super(model,parentNode,$('<div class="ddm_target_view '+pairAlignment+'" data-index="'+model.interaction.index+'"></div>')),this.model=model,this.nodeObj=node,this.enumAnswer=enumAnswer,this.pairAlignment=pairAlignment,this.loadUI()},loadUI:function(){var self=this;this.node.find(".content_sub").remove();var target=$('<div class="content_sub"></div');_.each(self.model.targetIds,function(id){var label=_.select($(self.nodeObj).find("#contentblock simpleAssociableChoice"),function(s){return $(s).attr("identifier")==id}),cn=$("<div></div>");$(_.first(label)).children();self.model.interaction.buildModel(cn,$(label));for(var enumAnswers=self.model.interaction.enumAnswers,html='<div class="drop_zone" id="DZ'+self.model.interaction.index+"-"+id+'">',i=0;i<self.model.targetPools[id].length;i++)self.enumAnswer&&(html+='<div class="enumanswer"></div>');html+="<h1></h1></div>",html=$(html),enumAnswers.next().then(function(enum_str){html.find(".enumanswer").html(enum_str)}),self.render_tts_player(cn),html.find("h1").append(cn),target.append(html)}),this.node.append(target)},render_tts_player:function(target){if(this.gaptextaudio){var text=$(target).text(),player=new a5.views.TTS_Player(text);target.prepend(player.render())}},events:function(){var prevY,self=this;this.draggableOptions=a5.utils.getDraggableOptions(this.model.interaction),$("#content-"+self.model.interaction.index+" .drag_item").draggable($.extend({start:this.reUp.bindDD(this),stop:this.fixBorder.bindDD(this),drag:function(e,ui){var newScrollSensitivity,currentScrollSensitivity=$(this).draggable("option","scrollSensitivity");prevY&&e.pageY>prevY&&e.clientY>20+a5.dp.config.exclusionBottom?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&$(this).draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&$(this).draggable("option","scrollSensitivity",newScrollSensitivity)),prevY=e.pageY,e.clientY>20+a5.dp.config.exclusionTop&&e.clientY<$(window).height()-20-a5.dp.config.exclusionBottom&&$(this).draggable("option","scroll",!0)},snap:!1,stack:".drag_item",revert:"invalid",revertDuration:350,zIndex:2700,cancel:".checked-correct-locked"},this.draggableOptions)),self.model.interaction.bind("show:deferred",_.bind(self.applyAllContainments,self),{once:!0}),self.model.interaction.bind("screen_transition:end",_.bind(this.applyAllContainments,this),{once:!0}),$("#content-"+self.model.interaction.index+" .drag_item").draggable("enable");var hc=self.model.interaction.options.dropIndicatorIsTrue()?"hovered":"hwb";$("#content-"+self.model.interaction.index+" .drop_zone").droppable({accept:".drag_item",hoverClass:hc,over:this.showOver.bindDD(this),out:this.removeOver.bindDD(this),drop:this.handleCardDrop.bindDD(this),tolerance:"pointer"}),$("#content-"+self.model.interaction.index+" .wordpool .drop_item_zone").droppable({accept:".drag_item",hoverClass:hc,over:this.showOver.bindDD(this),out:this.removeOver.bindDD(this),drop:this.handleCardDrop.bindDD(this),tolerance:"pointer",greedy:!0}),$("#content-"+self.model.interaction.index+" .wordpool").droppable({accept:".drag_item",hoverClass:hc,drop:this.handleCardDropOnWordpool.bindDD(this),tolerance:"pointer"}),self.model.interaction.options.poolAlignmentIsFree()&&($("#content-"+self.model.interaction.index+" .wordpool").draggable({start:this.wordpoolMove.bindDD(this),drag:function(e,ui){var newScrollSensitivity,currentScrollSensitivity=$(this).draggable("option","scrollSensitivity");prevY&&e.pageY>prevY?(newScrollSensitivity=20+a5.dp.config.exclusionBottom,currentScrollSensitivity!==newScrollSensitivity&&$(this).draggable("option","scrollSensitivity",newScrollSensitivity)):(newScrollSensitivity=20+a5.dp.config.exclusionTop,currentScrollSensitivity!==newScrollSensitivity&&$(this).draggable("option","scrollSensitivity",newScrollSensitivity)),prevY=e.pageY},handle:".drag-handle",stack:".drag_item",containment:self.model.interaction.contentWrap,cancel:".reset_position"}),$("#content-"+self.model.interaction.index+" .reset_position").click(function(){$("#content-"+self.model.interaction.index+" .reset_position").addClass("hidden"),$("#content-"+self.model.interaction.index+" .wordpool").css("position","relative"),$("#content-"+self.model.interaction.index+" .wordpool").css("top","0"),$("#content-"+self.model.interaction.index+" .wordpool").css("left","0")})),$("#content-"+self.model.interaction.index+" .drag_item.prefilled").draggable("disable")},updateState:function(){this.initPool(),_.each(this.model.items,function(v,k){if(1==v.length){var item=$("#content-"+this.model.interaction.index+" #DI-"+v[0])[0].outerHTML,$dragitem=$("#content-"+this.model.interaction.index+" #DI-"+v[0]);$dragitem.parent().removeClass("has_drag_item"),$dragitem.remove();var filled=!1;_.each($("#content-"+this.model.interaction.index+" #DZ"+this.model.interaction.index+"-"+k),function(diz){0!=$(diz).find(".drag_item").length||filled||($(diz).append(item).addClass("has_drag_item"),filled=!0)})}},this),this.events()},initPool:function(){var self=this;_.each(this.model.badAnswers,function(v,k){if($("#content-"+self.model.interaction.index+" .drop_zone #DI-"+k).length>0){var item=$("#content-"+self.model.interaction.index+" #DI-"+k)[0].outerHTML;$("#content-"+self.model.interaction.index+" #DI-"+k).remove();var filled=!1;_.each($("#content-"+self.model.interaction.index+" .wordpool .drop_item_zone"),function(diz){0!=$(diz).children().length||filled||($(diz).append(item),filled=!0)})}})},setAnswer:function(){var self=this;$("#content-"+self.model.interaction.index+" .check").remove(),$("#content-"+self.model.interaction.index+" .drag_item").draggable("disable"),this.checkLocked($("#content-"+this.model.interaction.index+" .drop_zone")),$("#content-"+self.model.interaction.index+" .drop_zone").droppable("disable").removeClass("checked-empty checked-incorrect checked-correct").removeClass("solution-empty solution-incorrect solution-correct"),_.each(this.model.badAnswers,function(v,k){if(!$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v+" .drag_item").hasClass("prefilled")){var $dz=$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v);_.isUndefined(self.model.items[k])||_.isEmpty(self.model.items[k])?$dz.addClass("checked-empty"):$dz.addClass("checked-incorrect"),this.addCheck({tooltip:this.model.incorrectFeedback,parent:$dz})}},this),_.each(this.model.goodAnswers,function(v,k){if(!$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v+" .drag_item").hasClass("prefilled")){var $dz=$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v);$dz.addClass("checked-correct"),this.addCheck({correct:!0,tooltip:this.model.correctFeedback,correctTooltip:!0,parent:$dz})}},this)},tryAgain:function(){$("#content-"+this.model.interaction.index+" .drop_zone").droppable("enable"),this.checkLocked($("#content-"+this.model.interaction.index+" .drop_zone")),$("#content-"+this.model.interaction.index+" .drop_zone").removeClass("checked-empty checked-incorrect checked-correct").removeClass("solution-empty solution-incorrect solution-correct"),this.model.interaction.options.tryAgainIsKeepall()||(_(this.model.badAnswers).chain().pairs().shuffle().object().each(function(v,k){if($("#content-"+this.model.interaction.index+" .drop_zone #DI-"+k).length>0){var audioViewUpdater=$("#content-"+this.model.interaction.index+" #DI-"+k+" [data-has-view-updater=true]").data("view-updater"),item=$("#content-"+this.model.interaction.index+" #DI-"+k)[0].outerHTML;$("#content-"+this.model.interaction.index+" #DI-"+k).parent().removeClass("has_drag_item"),$("#content-"+this.model.interaction.index+" #DI-"+k).remove(),this.model.removeItem(k);var filled=!1;_.each($("#content-"+this.model.interaction.index+" .wordpool .drop_item_zone"),function(diz){0!=$(diz).children().length||filled||($(diz).append(item),$(diz).find("[data-has-view-updater=true]").data("view-updater",audioViewUpdater),audioViewUpdater&&audioViewUpdater.update(),filled=!0,this.resize($(diz),$(diz).children()))},this)}},this),this.model.tryAgainIsFrozen&&_(this.model.goodAnswers).chain().pairs().shuffle().object().each(function(v,k){$("#content-"+this.model.interaction.index+" #DZ"+this.model.interaction.index+"-"+v).droppable("option","disabled",!0)},this)),$("#content-"+this.model.interaction.index+" .check").remove(),this.events()},showAnswer:function(){var self=this;$("#content-"+self.model.interaction.index+" .drag_item").draggable("disable"),$("#content-"+self.model.interaction.index+" .drop_zone").droppable("disable").removeClass("checked-empty checked-incorrect checked-correct").removeClass("solution-empty solution-incorrect solution-correct"),$("#content-"+self.model.interaction.index+" .check").remove(),_.each(this.model.badAnswers,function(v,k){if($("#content-"+self.model.interaction.index+" .drop_zone #DI-"+k).length>0){var item=$("#content-"+self.model.interaction.index+" #DI-"+k)[0].outerHTML,audioViewUpdater=$("#content-"+self.model.interaction.index+" #DI-"+k+" [data-has-view-updater=true]").data("view-updater"),draggableData=$("#content-"+self.model.interaction.index+" #DI-"+k).data("ui-draggable");$("#content-"+self.model.interaction.index+" #DI-"+k).remove();var filled=!1;_.each($("#content-"+self.model.interaction.index+" .wordpool .drop_item_zone"),function(diz){0!=$(diz).children().length||filled||($(diz).append(item).addClass("has_drag_item"),filled=!0)}),$("#content-"+self.model.interaction.index+" #DI-"+k).find("[data-has-view-updater=true]").data("view-updater",audioViewUpdater),audioViewUpdater&&audioViewUpdater.update(),$("#content-"+self.model.interaction.index+" #DI-"+k).data("ui-draggable",draggableData)}});var expected_items=_.flatten(_.values(this.model.targetPools));_.each(this.model.badAnswers,function(v,k){if(_.include(expected_items,k)){var item=$("#content-"+self.model.interaction.index+" #DI-"+k)[0].outerHTML,zIndex=$("#content-"+self.model.interaction.index+" #DI-"+k).css("z-index"),audioViewUpdater=$("#content-"+self.model.interaction.index+" #DI-"+k+" [data-has-view-updater=true]").data("view-updater"),draggableData=$("#content-"+self.model.interaction.index+" #DI-"+k).data("ui-draggable");$("#content-"+self.model.interaction.index+" #DI-"+k).remove();var filled=!1;_.each($("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+self.model.poolTarget[k]),function(diz){if(0===$(diz).find(".drag_item").length&&!filled){var $item=$(item);$item.css("z-index",zIndex),$(diz).addClass("has_drag_item"),$(diz).append($item),filled=!0}(_.isUndefined(self.model.items[k])||_.isEmpty(self.model.items[k]))&&(this.addCheck({empty:!0,parent:$(diz)}),$(diz).addClass("solution-empty")),_.isUndefined(self.model.items[k])||_.isEmpty(self.model.items[k])||(this.addCheck({parent:$(diz)}),$(diz).addClass("solution-incorrect"))},this),$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+self.model.poolTarget[k]+" #DI-"+k).parents(".drop_zone, .drop_item_zone").find("[data-has-view-updater=true]").data("view-updater",audioViewUpdater),audioViewUpdater&&audioViewUpdater.update(),$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+self.model.poolTarget[k]+" #DI-"+k).parents(".drop_zone, .drop_item_zone").find(".ui-draggable").data("ui-draggable",draggableData)}},this),_.each(this.model.goodAnswers,function(v,k){if(!$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v+" .drag_item").hasClass("prefilled")){var $dz=$("#content-"+self.model.interaction.index+" #DZ"+self.model.interaction.index+"-"+v);$dz.addClass("solution-correct"),this.addCheck({correct:!0,tooltip:this.model.correctFeedback,correctTooltip:!0,parent:$dz})}},this)},render:function(){return this.node},adjustHeights:function(){var self=this;$("#content-"+self.model.interaction.index+" .drop_zone").css("height",""),$("#content-"+self.model.interaction.index+" .drop_zone").height(_.max(_.map($("#content-"+self.model.interaction.index+" .drop_zone"),function(dz){return $(dz).height()})))}},a5.views.OMPairsViewDD.extend("a5.views.OMPairsViewTarget"),a5.views.OMPairsViewOptions={init:function(model,options,targetPools,targetIds){if(options.poolAlignmentIsRight()&&$("#content-"+model.interaction.index+" .wordpool").addClass("right"),options.poolAlignmentIsLeft()&&$("#content-"+model.interaction.index+" .wordpool").addClass("left"),options.poolAlignmentIsBottom()&&($("#content-"+model.interaction.index+" .ddm_wordpool_view").next().after($("#content-"+model.interaction.index+" .ddm_wordpool_view")),$("#content-"+model.interaction.index+" .ddm_wordpool_view").addClass("bottom"),$("#content-"+model.interaction.index+" .ddm_wordpool_view").css("clear","both")),options.poolAlignmentIsFree()||$("#content-"+model.interaction.index+" .wordpool > .drag-handle").addClass("hidden"),options.prefillIsFirstitem()){var target=_.first(targetIds),id=_.first(model.targetPools[target]),$content=$("#content-"+model.interaction.index+" #DI-"+id),$target=$("#content-"+model.interaction.index+" #DZ"+model.interaction.index+"-"+target);$content.detach(),$target.append($content),$content.addClass("prefilled"),$target.addClass("has-prefill"),model.draggedItem(id,target),model.addPrefill(id)}options.prefillIsFirstblock()&&_.each(model.targetPools[_.first(targetIds)],function(id,index){var $content=$("#content-"+model.interaction.index+" #DI-"+id),$dzone=$($("#content-"+model.interaction.index+" #DZ"+model.interaction.index+"-"+_.first(targetIds)).find(".drop_item_zone")[index]);$dzone.append($content),$dzone.droppable("disable"),$content.addClass("prefilled"),$dzone.addClass("has-prefill"),model.draggedItem(id,target),model.addPrefill(id)}),_.each($("#content-"+model.interaction.index+" .wordpool .drop_item_zone"),function(diz){0==$(diz).find(".drag_item:not(.hidden)").length&&$(diz).remove()})}},a5.views.interaction.BaseView.extend("a5.views.OMPairsViewOptions"),a5.views.interaction.ICTextGapLabelAnObjectBlock={init:function(model,parent){this._super(model,parent,$('<div class="tehs_block"></div>')),this.wordpool=new a5.views.WordPool(this.model.poolAlignment,!1,this.model.parent),_.each(this.model.poolWords,function(word){this.wordpool.append(word,this.model.tts_audio)},this),this.node.append(this.wordpool.render()),this.children=[],this.interaction=this.model.parent,this.onWindowResizeThrottleFn=_.throttle(this.onWindowResize,300),_.bindAll(this,"onFontUpdated","onStylesLoaded","onWindowResize","onWindowResizeThrottleFn","onImageLoaded"),this.interaction.bind("rendered",this.onInteractionRendered,this),this.interaction.bind("reset",this.onInteractionReset,this),a5.hooks.interactionFontUpdated.add(this.onFontUpdated),a5.hooks.layoutStylesLoaded.add(this.onStylesLoaded),$(window).on("resize",this.onWindowResizeThrottleFn)},onInteractionReset:function(){$(window).off("resize",this.onWindowResizeThrottleFn),a5.hooks.interactionFontUpdated.remove(this.onFontUpdated),a5.hooks.layoutStylesLoaded.remove(this.onStylesLoaded),this.interaction.unbind("rendered",this.onInteractionRendered),this.interaction.unbind("reset",this.onInteractionReset)},onImageLoaded:function(){this.adjustGapSizes()},onInteractionRendered:function(){this.adjustGapSizes()},onFontUpdated:function(){this.adjustGapSizes()},onStylesLoaded:function(){this.adjustGapSizes()},onWindowResize:function(){this.adjustGapSizes()},setImage:function(){this.$image=this.node.find("img").first(),this.$image.on("load",this.onImageLoaded)},adjustGapSizes:function(){this.interaction.runOutOfFlow(function(){a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.removeBodySubstyle(),this.interaction.addBodySubstyle(),this.interaction.options.gapsIsSamelongest()?this.adjustGapSizeToLongestResponse():this.adjustGapSizeToLongestCorrect(),this.adjustBlock(),this.interaction.removeBodySubstyle(),a5.mainBuilder.curInteraction&&a5.mainBuilder.curInteraction.addBodySubstyle()}.bind(this))},adjustBlock:function(){var prevSize=this.curSize;this.curSize=this.currentSize(),this.curSize&&prevSize&&this.curSize.width===prevSize.width&&this.curSize.height===prevSize.height||(this.adjustGapPositions(),this.adjustBlockSize())},adjustBlockSize:function(){this.node.closest(".interaction").addClass("wordpool"),_.defer(_.bind(this.wordpool.block.applyBoundingHeight,this.wordpool.block))},adjustGapPositions:function(){_.invoke(this.children,"adjustPosition")},adjustGapSizeToLongestResponse:function(){var responses=_.flatten(_.map(this.model.gaps,function(e){return e.correct}));_.each(this.children,function(child){child.adjustGapSizeToLongestResponse(responses)})},adjustGapSizeToLongestCorrect:function(){_.each(this.children,function(child){child.adjustGapSizeToLongestCorrect(child.model.correct)})},add:function(child){this.children.push(child)},currentSize:function(){return{width:this.$image.width(),height:this.$image.height()}},originalSize:function(){return this.model.originalSize}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGapLabelAnObjectBlock"),a5.views.interaction.ICTextGapLabelAnObject={TEXT_PLACEHOLDER:"_",init:function(model,parent){this._super(model,parent,$('<div class="tehs_view"></div>')),this.$reference=$('<div class="labelAnObject__reference">'),this.$nodes=$(this.node).add(this.$reference),this.pool_word=this._getPoolWord(),this.node.addClass("has-input"),this.input=this._createTextInput(),this.model.prefill&&(this.node.addClass("prefilled"),this.input.val(this.model.getCorrect()),this.input.attr("disabled",!0)),this.node.append(this.input),this.bindEvents(),this._canShowCharactersInGap()&&(this.node.addClass("characters-in-gap"),this._initCharactersInGap()),this.model.enumeration&&(this.model.global_enumeration&&!this.model.charactersNumber&&a5.dp.config.continuousEnumerationInsideGaps?this.show_global_enumeration(!0):(this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this)))),this.model.isDistractor()&&this.node.addClass("distractor-gap")},render:function(){return this._super(),this.$nodes},adjustPosition:function(){var oLeft=this.model.position[0],oTop=this.model.position[1],oSize=this.parent.originalSize(),cSize=this.parent.currentSize(),newTop=oTop*cSize.height/oSize.height,newLeft=oLeft*cSize.width/oSize.width;this.$nodes.css({left:newLeft+"px",top:newTop+"px"})},inputValue:function(){return!this.input||this.input.is(".continuous-enumeration")?"":this.model.charactersNumber&&""===this.input.val().replace(new RegExp(this.TEXT_PLACEHOLDER,"g"),"").trim()?"":this.input.val()},bindEvents:function(){_.bindAll(this,"onInputChange","onInputClick","onInputFocus","onInputBlur","onInputMouseOver","onInputMouseOut"),this.input.on("change input",this.onInputChange),this.input.on("click",this.onInputClick),this.input.on("focus",this.onInputFocus),
this.input.on("blur",this.onInputBlur),this.input.on("mouseover",this.onInputMouseOver),this.input.on("mouseout",this.onInputMouseOut),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("state_update:input",this.onStateInput,this),this.model.bind("state_update:feedback",this.onStateFeedback,this),this.model.bind("state_update:answers",this.onStateAnswers,this),this.model.bind("input_update:setAnswer",this.onStateInputFeedback,this),this.model.bind("next_answer",this.onNextAnswer,this)},onInputChange:function(e){this.model.setValue(this.inputValue()),this._setFilled(),this.adjustGapSizeAfterEvent("input:change")},onInputClick:function(e){},onInputFocus:function(e){this.node.addClass("focused");var originalWidth=this.originalInput&&this._getMaxWidthFor(this.originalInput)||0;this.initialWidth=_.min([this.input.width(),originalWidth]),this.adjustGapSizeAfterEvent("input:focus")},onInputBlur:function(e){this.node.removeClass("focused mouseover"),this.adjustGapSizeAfterEvent("input:blur")},onInputMouseOver:function(e){this.node.addClass("mouseover")},onInputMouseOut:function(e){this.node.removeClass("mouseover")},onStateUpdate:function(){this.adjustGapSizeAfterEvent("model:state_update")},onStateInput:function(){this.setInput()},onStateFeedback:function(){this.setAnswer()},onStateAnswers:function(){this.showAnswer(),this.adjustGapSizeAfterEvent("model:state_update:answers")},onStateInputFeedback:function(){this.setAnswerInput()},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},show_global_enumeration:function(bind_events){""!=this.inputValue()||this.model.charactersNumber||this.model.enumeration.then(function(enumSymbol){var enumText=a5.utils.enumText(this.model.enumSymbol);this.input.addClass("continuous-enumeration"),this.input.attr("id","enumeration-"+enumText),this.input.val(enumText)}.bind(this)),bind_events&&(this.input.on("focus",_.bind(this.hide_global_enumeration,this)),this.input.on("blur",_.bind(this.show_global_enumeration,this)))},hide_global_enumeration:function(){""!=this.inputValue()||this.model.charactersNumber||(this.input.removeClass("continuous-enumeration"),this.input.val(""))},setInput:function(){this.model.prefill||(this.model.isCorrectable()&&this.updateFeedbackState(this.node),this.input.val(this.model.value),this._canShowCharactersInGap()&&this._initCharactersInGap(),this.node.find(".check").remove(),this.input.attr("disabled",this.isLocked()),this.model.enumeration&&this.model.global_enumeration&&a5.dp.config.continuousEnumerationInsideGaps&&this.show_global_enumeration(),this.model.isFilled()||this.node.removeClass("filled"))},setAnswer:function(){if(!this.model.prefill){this.input.attr("disabled",!0),this.model.isRevealed()||this.input.val(this.model.value);var setCheck=this.model.isCorrectable();this.setAnswerCheck(setCheck)}},setAnswerInput:function(){if(!this.model.prefill){var setCheck=this.model.isCorrectable()&&this.model.isFilled();this.setAnswerCheck(setCheck),this.updateAnswerInputState(setCheck)}},setAnswerCheck:function(check){this.node.find(".check").remove(),check&&(this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))},showAnswer:function(){if(!this.model.prefill&&(this.input.attr("disabled",!0),this.input.val(this.model.value),this.node.find(".check").remove(),this.model.isCorrectable())){this.updateFeedbackState(this.node);var correct=this.model.getCorrect();this.input.val(correct),this.node.addClass("filled"),this.model.isCorrect()?this.model.isCorrect()&&this.addCheck({correct:!0,tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getAnswerFeedback():this.model.value}):this.addCheck({empty:!this.model.isFilled(),tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getAnswerFeedback():this.model.value}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})}},updateFeedbackState:function(nodes){nodes.removeClass("input-checked-correct input-checked-incorrect input-checked-empty"),this._super(nodes)},updateAnswerInputState:function(check){check&&(this.model.isCorrect()?this.node.addClass("input-checked-correct"):this.model.isFilled()?this.node.addClass("input-checked-incorrect"):this.node.addClass("input-checked-empty"))},adjustGapSize:function(){if(this.inputValue()){var textWidth=this.input.textWidth();this.input.width(textWidth)}else this.adjustGapSizeToOriginal()},adjustGapSizeOnInput:function(){if(this.inputValue()){var textWidth=this.input.textWidth();textWidth>this.initialWidth||this.model.charactersNumber?this.input.width(textWidth):this.input.width(this.initialWidth)}else this.initialWidth=this.originalInput&&this._getMaxWidthFor(this.originalInput)||0,this.adjustGapSizeToOriginal()},adjustGapSizeAfterEvent:function(eventType){if(this.model.resizeGaps)return void("input:change"===eventType?this.adjustGapSizeOnInput():this.adjustGapSize());this.adjustGapSizeToOriginal()},adjustGapSizeToOriginal:function(){if(this.originalInput){var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)}},getLongestResponse:function(responses){var maxAnswer,maxWidth=0;return _.each(responses,function(response){var width=this.input.textWidth(response);width>maxWidth&&(maxWidth=width,maxAnswer=response)},this),{answer:maxAnswer,width:maxWidth}},adjustGapSizeToLongestCorrect:function(responses){var response=this.getLongestResponse(responses);if(this.originalInput={answer:response.answer,width:response.width},/[\s;]*width:/gi.test(this.model.inputStyle))return void _.extend(this.originalInput,{width:this.input.width()});var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)},adjustGapSizeToLongestResponse:function(responses){var response=this.getLongestResponse(responses);if(this.originalInput={answer:response.answer,width:response.width},/[\s;]*width:/gi.test(this.model.inputStyle))return void _.extend(this.originalInput,{width:this.input.width()});var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)},_createTextInput:function(){var correct_and_distractors=_(this.model.correct).without("%0").concat(this.model.distractors),$input=this.model.charactersNumber||_.isEmpty(correct_and_distractors)||!_.all(correct_and_distractors,a5.utils.isInteger)?$('<input type="text" />'):$('<input type="number" />');return $input.attr("size",this.model.length),$input.attr("style",this.model.inputStyle),$input.attr("spellcheck",this.model.spellcheck),$input.attr("autocapitalize","off"),$input.attr("autocorrect","off"),$input.attr("autocomplete",$("body").is(".isChrome")?"none":"off"),$input.attr("aria-label","Blank input"),$input},_canShowCharactersInGap:function(){return!this.model.prefill&&!this.model.isDistractor()&&this.model.charactersNumber&&this.model.getMaskPattern().trim()},_initCharactersInGap:function(){$.mask.definitions={"*":new RegExp("[^\\s"+this.TEXT_PLACEHOLDER+"]")},this.input.mask(this.model.getMaskPattern(),{autoclear:!1,allowpartial:!0,onInput:this.onInputChange}),this.input.attr("placeholder",this.model.getMaskPattern().replace(/\*/g,this.TEXT_PLACEHOLDER))},_getMaxWidthFor:function(response){if(/[\s;]*width:/gi.test(this.model.inputStyle))return response.width;var width=this.input.textWidth(response.answer);if(this.model.charactersNumber)if(0===response.width)width=this.input.textWidth(this.TEXT_PLACEHOLDER);else{var placeholderText=response.answer.replace(/\S/g,this.TEXT_PLACEHOLDER);width=this.input.textWidth(placeholderText)}return width},_setFilled:function(){this.model.isFilled()?(this.node.addClass("filled"),this.pool_word&&$(this.pool_word).addClass("gap-filled")):(this.pool_word&&$(this.pool_word).removeClass("gap-filled"),this.node.removeClass("filled"))},_getPoolWord:function(){var result,pool_words;return this.model.display_words.length>0&&this.parent.wordpool?(pool_words=this.parent.wordpool.pool.find(".static_word").not(".display-word"),result=_.find(pool_words,function(word){return _.contains(this.model.display_words,$(word).text())},this),$(result).addClass("display-word")):this.parent.wordpool&&(pool_words=this.parent.wordpool.pool.find(".static_word"),result=_.find(pool_words,function(word){return _.contains(this.model.correct,$(word).text())},this)),result}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGapLabelAnObject"),a5.view.interaction.IMWordsearch={DEFAULT_TEMPLATE:'<div class="wordsearch_view"><div class="grid"></div><canvas></canvas></div>',DEFAULT_MARKER_WIDTH:2,init:function(model,parent,uppercase){this._super(model,parent,$(this.DEFAULT_TEMPLATE)),this.uppercase=uppercase,this.deleteEnabled=!1,this.currentLine=!1,this.cellSize=32,this.interaction=this.model.parent,this.cell_views=[],this.canvas=this.node.find("canvas"),this.$grid=this.node.find(".grid"),_.each(this.model.cells,function(cell){var view=new a5.view.interaction.IMWordsearchCell(cell,this);this.cell_views.push(view)},this),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("show-next",this.onShowNext,this),this.model.bind("clear-incorrect",this.onClearIncorrect,this),_.bindAll(this,"onFontChange","onClick","onMouseMove","onTouchStart","onTouchMove","onTouchEnd"),this.interaction.bind("reset",this.onReset,this),a5.hooks.interactionFontUpdated.add(this.onFontChange),this.updateState()},hideAnswers:function(){this.model.markings=_.filter(this.model.markings,function(marking){return marking.isCorrect()}),this.updateState()},render:function(){return _.each(this.cell_views,function(view){this.$grid.append(view.node),view.render()},this),this.adjustSize(),this.node},adjustSize:function(){_.each(this.cell_views,function(view,index){view.adjustPosition(),0===index&&(this.cellSize=view.width)},this),this.node.css({width:this.model.width*this.cellSize,height:this.model.height*this.cellSize}),this.canvas.attr("height",this.node.height()),this.canvas.attr("width",this.node.width()),this.redrawCanvas()},enableDelete:function(){this.deleteEnabled=!0,this.currentLine=!1,this.updateState()},disableDelete:function(){this.deleteEnabled=!1,this.highlighted=!1,this.updateState()},onStateUpdate:function(){this.updateState()},onClearIncorrect:function(){this.updateState()},onShowNext:function(word){this.updateState();var element=this.model.getCell(word.start).views()[0].node;this.model.hasCandidatesForValidation()||this.hideAnswers(),a5.utils.scrollIntoElementIfNeeded(element)},onFontChange:function(){this.interaction.runOutOfFlow(this.adjustSize.bind(this))},onReset:function(){a5.hooks.interactionFontUpdated.remove(this.onFontChange),this.interaction.unbind("reset",this.onReset)},onClick:function(e){var position=this.toGridCoordinates(e.pageX,e.pageY);this.deleteEnabled?this.erase(position):this.mark(position)},onMouseMove:function(e){var position=this.toGridCoordinates(e.pageX,e.pageY);this.deleteEnabled?this.highlight(position):this.markTo(position)},onTouchStart:function(e){if(e.preventDefault(),e.originalEvent.touches[0]){var position=this.toGridCoordinates(e.originalEvent.touches[0].pageX,e.originalEvent.touches[0].pageY);this.deleteEnabled?(this.highlight(position),this.erase(position)):this.mark(position)}},onTouchEnd:function(e){if(e.preventDefault(),e.originalEvent.touches[0]){var position=this.toGridCoordinates(e.originalEvent.touches[0].pageX,e.originalEvent.touches[0].pageY);this.deleteEnabled||this.mark(position)}},onTouchMove:function(e){if(e.preventDefault(),e.originalEvent.touches[0]){var position=this.toGridCoordinates(e.originalEvent.touches[0].pageX,e.originalEvent.touches[0].pageY);this.deleteEnabled?this.highlight(position):this.markTo(position)}},highlight:function(position){this.highlighted=this.model.getEnabledMarkingsAt(position),this.redrawCanvas()},markTo:function(position){this.currentLine&&(position.x<0&&(position.x=0),position.y<0&&(position.y=0),position.x>=this.model.width&&(position.x=this.model.width-1),position.y>=this.model.height&&(position.y=this.model.height-1),this.currentLine[1]=position,this.redrawCanvas())},mark:function(position){this.currentLine?(this.isLineValid(this.currentLine)&&this.model.addMarking(this.currentLine),this.currentLine=!1):this.currentLine=[position,position],this.redrawCanvas()},erase:function(position){this.model.removeEnabledMarkingsAt(position),this.redrawCanvas()},updateState:function(){this.updateFeedbackState(),this.node.off(),this.node.toggleClass("erase",this.deleteEnabled),this.model.state===this.model.STATES.INPUT&&(this.node.on("click",this.onClick),this.node.on("mousemove",this.onMouseMove),this.node.on("touchstart",this.onTouchStart),this.node.on("touchend",this.onTouchEnd),this.node.on("touchmove",this.onTouchMove)),this.redrawCanvas()},updateFeedbackState:function(){this.$(".cell").removeClass("checked-empty checked-incorrect checked-correct"),this.$(".cell").removeClass("solution-empty solution-incorrect solution-correct solution-revealed"),this.$(".cell .check").remove();var type;this.model.state===this.model.STATES.CHECK?type="checked":this.model.state===this.model.STATES.ANSWERS&&(type="solution"),this.model.state!==this.model.STATES.INPUT&&_.each(this.model.markings,function(marking){var classname=[type,marking.isCorrect()?"correct":"incorrect"].join("-"),direction=this.getDirection(marking);if(a5.dp.config.wordsearchCheckmarks&&!marking.isCorrect()){var cell=2===a5.dp.config.wordsearchCheckmarks?marking.end:marking.start,check=this.addCheck({parent:this.model.getCell(cell).views()[0].node});this.addCheckDirectionClasses(check,direction)}for(var i=marking.start;this.model.getCell(i).views()[0].node.addClass(classname),!i.equals(marking.end);i=i.addV(direction));},this),_.each(this.model.words,function(word){var i,check,classname=[type,word.isCorrect()?"correct":"empty"].join("-"),direction=this.getDirection(word),cell=2===a5.dp.config.wordsearchCheckmarks?word.end:word.start;if(word.isRevealedBySeeNext())for(classname="solution-revealed",a5.dp.config.wordsearchCheckmarks&&(check=this.addCheck({parent:this.model.getCell(cell).views()[0].node,empty:this.model.state!==this.model.STATES.CHECK}),this.addCheckDirectionClasses(check,direction)),i=word.start;this.model.getCell(i).views()[0].node.addClass(classname),!i.equals(word.end);i=i.addV(direction));else if(this.model.state!==this.model.STATES.INPUT)for(a5.dp.config.wordsearchCheckmarks&&(word.isCorrect()||this.model.state===this.model.STATES.ANSWERS)&&(check=this.addCheck({parent:this.model.getCell(cell).views()[0].node,correct:word.isCorrect(),empty:!word.isCorrect()}),this.addCheckDirectionClasses(check,direction)),i=word.start;this.model.getCell(i).views()[0].node.addClass(classname),!i.equals(word.end);i=i.addV(direction));},this)},addCheckDirectionClasses:function(node,direction){var classname="direction";1===direction.x?classname+="-right":-1===direction.x&&(classname+="-left"),1===direction.y?classname+="-bottom":-1===direction.y&&(classname+="-top"),node.addClass(classname)},getDirection:function(word){return new Vec2(Math.sign(word.end.x-word.start.x),Math.sign(word.end.y-word.start.y))},toGridCoordinates:function(pageX,pageY){var offset=this.node.offset(),position=new Vec2(pageX-offset.left,pageY-offset.top);return new Vec2(Math.floor(position.x/this.cellSize),Math.floor(position.y/this.cellSize))},toScreenCoordinates:function(position){return new Vec2((position.x+.5)*this.cellSize+.5,(position.y+.5)*this.cellSize+.5)},toScreenLine:function(line){return[this.toScreenCoordinates(line[0]),this.toScreenCoordinates(line[1])]},isLineValid:function(line){var diff=line[0].subV(line[1]).abs(),directionIsValid=0==diff.x||0==diff.y||diff.x==diff.y,notAlreadyMarked=_.every(this.model.markings,function(marking){return!(marking.start.equals(line[0])&&marking.end.equals(line[1])||marking.start.equals(line[1])&&marking.end.equals(line[0]))});return directionIsValid&&notAlreadyMarked},redrawCanvas:function(){var ctx=this.canvas[0].getContext("2d");ctx.clearRect(0,0,this.canvas[0].width,this.canvas[0].height);var c1=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","color1","color"),c2=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","color2","color"),width1=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","color1","border-width"),width2=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","color2","border-width"),colorPrefill=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","prefill-style","color"),widthPrefill=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","prefill-style","border-width"),fillStylePrefill=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","prefill-style","background-color"),fillStyle1=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","color1","background-color"),fillStyle2=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","color2","background-color"),wa=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","wrong-answer","color"),widthWa=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","wrong-answer","border-width"),fillStyleWa=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","wrong-answer","background-color"),ca=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","correct-answer","color"),widthCa=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","correct-answer","border-width"),fillStyleCa=a5.utils.getCSSAttributeFromCSS(".im-wordsearch","correct-answer","background-color"),radius=this.cellSize/2-1;this.currentLine&&this.isLineValid(this.currentLine)&&this.drawMarker(ctx,this.toScreenLine(this.currentLine),!0,radius,width1,c1,fillStyle1),_.each(this.model.markings,function(marker){this.model.state===this.model.STATES.INPUT?this.highlighted&&_.any(this.highlighted,function(w){return w.matches(marker)})?this.drawMarker(ctx,this.toScreenLine(marker.asList()),!1,radius,width1,c2,fillStyle2):this.drawMarker(ctx,this.toScreenLine(marker.asList()),!1,radius,width2,c1,fillStyle1):this.model.state===this.model.STATES.CHECK?this.drawMarker(ctx,this.toScreenLine(marker.asList()),!1,radius,marker.isCorrect()?widthCa:widthWa,marker.isCorrect()?ca:wa,marker.isCorrect()?fillStyleCa:fillStyleWa):this.model.state===this.model.STATES.ANSWERS&&this.drawMarker(ctx,this.toScreenLine(marker.asList()),!1,radius,marker.isCorrect()?widthCa:widthWa,marker.isCorrect()?ca:wa,marker.isCorrect()?fillStyleCa:fillStyleWa)},this),this.model.state==this.model.STATES.ANSWERS?_.each(this.model.words,function(word){word.isCorrect()||this.drawMarker(ctx,this.toScreenLine(word.asList()),!1,radius,width1,c1,fillStyle1)},this):_.each(this.model.words,function(word){word.state==word.STATES.ANSWERS&&this.drawMarker(ctx,this.toScreenLine(word.asList()),!1,radius,width1,c1,fillStyle1)},this),this.model.prefilled_word&&this.drawMarker(ctx,this.toScreenLine(this.model.prefilled_word.asList()),!1,radius,widthPrefill,colorPrefill,fillStylePrefill)},drawMarker:function(ctx,list,circles,radius,width,color,fillStyle,borderWidth){_.isString(width)&&0===(width=parseInt(width,10))&&(width=this.DEFAULT_MARKER_WIDTH);var diff=list[1].subV(list[0]),ortho=new Vec2(-diff.y,diff.x);ortho.normalize(),ortho=ortho.mulS(radius),ctx.beginPath(),ctx.strokeStyle=color,ctx.lineWidth=width,circles||list[0].equals(list[1])?(this.drawCircle(ctx,list[0],radius),this.drawCircle(ctx,list[1],radius)):(this.drawArc(ctx,list[0],radius,ortho),this.drawArc(ctx,list[1],radius,ortho.mulS(-1))),ctx.stroke(),ctx.closePath(),ctx.fillStyle=fillStyle,ctx.fill(),this.drawLines(ctx,list,ortho,fillStyle)},drawArc:function(ctx,pos,radius,ortho){var startPos=pos.addV(ortho),angle=ortho.angle();ctx.moveTo(startPos.x,startPos.y),ctx.arc(pos.x,pos.y,radius,angle,angle+Math.PI,!1)},drawCircle:function(ctx,pos,radius){ctx.moveTo(pos.x+radius,pos.y),ctx.arc(pos.x,pos.y,radius,0,2*Math.PI,!1)},drawLines:function(ctx,list,translation,width,color,fillStyle){ctx.beginPath();var start=list[0],end=list[1],translation2=translation.mulS(-1),p1=start.addV(translation2),p2=end.addV(translation2),p3=start.addV(translation),p4=end.addV(translation);this.drawLine(ctx,p2,p1),this.drawLine(ctx,p3,p4),ctx.stroke(),ctx.closePath(),this.drawPolygon(ctx,p1,p2,p4,p3),ctx.fillStyle=fillStyle,ctx.fill()},drawPolygon:function(ctx,p1,p2,p3,p4){ctx.beginPath(),ctx.moveTo(p1.x,p1.y),ctx.lineTo(p2.x,p2.y),ctx.lineTo(p3.x,p3.y),ctx.lineTo(p4.x,p4.y),ctx.closePath()},drawLine:function(ctx,p1,p2){ctx.moveTo(p1.x,p1.y),ctx.lineTo(p2.x,p2.y)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMWordsearch"),a5.view.interaction.IMWordsearchCell={DEFAULT_TEMPLATE:'<div class="cell"></div>',init:function(model,parent){this._super(model,parent,$(this.DEFAULT_TEMPLATE)),this.width=0},render:function(){this.model.isPrefilled()&&(this.node.addClass("prefilled"),this.model.setEnabled(!1));var letter=this.model.letter;return this.parent.uppercase&&(letter=this.model.letter.toUpperCase()),this.node.append(letter),this.adjustPosition(),this.node},adjustPosition:function(){this.node.css({left:"",top:""});var size=a5.dp.config.wordsearchCellSize;size&&this.node.css({width:size,height:size}),this.width=Math.round(this.node.width()),this.node.css({left:this.width*this.model.position.x,top:this.width*this.model.position.y})}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMWordsearchCell"),a5.views.interaction.LLView={SCROLL_SENSITIVITY:10,SCROLL_SPEED:20,NODE_HTML:'<div class="ll_view"></div>',ERASER_TEMPLATE:'<span title="Eraser">Erase</span>',init:function(model,parent){this._super(model,parent,$(this.NODE_HTML).addClass(model.displayInRows?"rows":"columns").addClass(model.behaviourIsTouch?"touch":"drag")),this.interaction=model.parent,this.modelViewMapping=[],this.children=[],this.interaction.options.eraserIsOn()&&this.createEraser(),this.getLinkConfig(),this.appendTable(),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("input_update:setAnswer",this.onSetAnswerInput,this),this.model.bind("show_next",this.repaintCanvas,this),this.interaction.bind("hide",this.onInteractionHide,this),this.interaction.bind("show",this.onInteractionShow,this),this.interaction.bind("show:deferred",this.createRepaintCanvas,this),this.interaction.bind("reset",this.onInteractionReset,this,{once:!0}),a5.dp.config.linkingLinesContainedEvents&&(this.dragContainer=this.interaction.$(".interaction")),this.inputHandler=this.model.behaviourIsTouch?new a5.views.LinkingLinesTouchHandler(this.node,".ll_element_view:not(.checked-correct-locked)"):new a5.views.LinkingLinesDragHandler(this.node,".ll_element_view:not(.checked-correct-locked)",this.dragContainer),this.inputHandler.bind("erase",this.onErase,this),this.inputHandler.bind("start",this.onStart,this),this.inputHandler.bind("linking",this.onLinking,this),this.inputHandler.bind("finish",this.onFinish,this)},onSetAnswerInput:function(){_.invoke(this.children,"setAnswerInput")},onInteractionHide:function(){this.inputHandler.unbindEvents(),$("body").removeClass("erasing")},onInteractionShow:function(){this.updateInputHandlerState(),this.getLinkConfig(),$("body").toggleClass("erasing",this.inputHandler.isErasing())},onInteractionReset:function(){this.interaction.unbind("show",this.onInteractionShow),this.interaction.unbind("hide",this.onInteractionHide),this.inputHandler.unbindEvents()},onStateUpdate:function(){this.render(),a5.mainBuilder.curInteraction===this.model.parent&&this.updateInputHandlerState()},setAnswer:function(){this.eraserButton&&this.eraserButton.setPressed(!1)},updateInputHandlerState:function(){"input"===this.model.state?(this.node.find(".check").remove(),this.inputHandler.bindEvents()):this.inputHandler.unbindEvents()},render:function(){return this._super(),this.repaintCanvas(),this.node},getLinkConfig:function(){this.prefillColor=a5.dp.config.linkingLinesPrefillColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","prefill-answer","background-color"),this.prefillStyle=a5.dp.config.linkingLinesPrefillStyle,this.answersWrongColor=a5.dp.config.linkingLinesAnswersWrongColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","wrong-answer","background-color"),this.answersWrongStyle=a5.dp.config.linkingLinesAnswersWrongStyle,this.answersCorrectColor=a5.dp.config.linkingLinesAnswersCorrectColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","correct-answer","background-color"),this.answersCorrectStyle=a5.dp.config.linkingLinesAnswersCorrectStyle,this.feedbackWrongColor=a5.dp.config.linkingLinesFeedbackWrongColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","wrong-answer","background-color"),this.feedbackWrongStyle=a5.dp.config.linkingLinesFeedbackWrongStyle,this.feedbackCorrectColor=a5.dp.config.linkingLinesFeedbackCorrectColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","correct-answer","background-color"),this.feedbackCorrectStyle=a5.dp.config.linkingLinesFeedbackCorrectStyle,this.defaultColor=a5.dp.config.linkingLinesDefaultColor||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","fill-color","background-color"),this.unattemptedColor=a5.dp.config.linkingLinesUnattemptedColor||this.answersCorrectColor,this.unattemptedStyle=a5.dp.config.linkingLinesUnattemptedStyle,this.lineWidth=a5.dp.config.linkingLinesLineWidth||a5.utils.getCSSAttributeFromCSS(".is-linking-lines","line-width","max-width"),this.lineWidth=parseInt(this.lineWidth,10),_.isNaN(this.lineWidth)&&(this.lineWidth=4)},appendTable:function(){this.model.displayInRows?this.appendRowsTable():this.appendColumnsTable()},appendColumnsTable:function(){var $row,ccnt,$table=$("<table></table>");this.node.append($table);for(var rows=this.model.elements.length/this.model.sets,cnt=0;cnt<rows;cnt++)for($row=$('<tr class="element-row"></tr>'),$table.append($row),ccnt=0;ccnt<this.model.sets;ccnt++){this.model.enumSets[ccnt]&&this.model.enumSets[ccnt][cnt]&&ccnt<this.model.sets-1&&($row.append('<td class="ll-enum ll-enum-set-'+(ccnt+1)+'"><span class="enum-placeholder"></span></td>'),this.model.enumSets[ccnt][cnt].then(function(enumSymbol){$row.find(".enum-placeholder").replaceWith(enumSymbol)}));var $td=$('<td class="element"></td>');$row.append($td);var model=this.model.elements[(a5.dp.config.linkingLinesTouchDirection[0]?this.model.sets-ccnt-1:ccnt)*rows+cnt],view=this.createElementView(model);this.children.push(view),$td.append(view.render()),this.modelViewMapping[model.identifier]=view,this.model.enumSets[ccnt]&&this.model.enumSets[ccnt][cnt]&&ccnt==this.model.sets-1&&($row.append('<td class="ll-enum ll-enum-set-'+(ccnt+1)+'"><span class="enum-placeholder"></span></td>'),this.model.enumSets[ccnt][cnt].then(function(enumSymbol){$row.find(".enum-placeholder").replaceWith(enumSymbol)}))}if(!_.isEmpty(this.model.headings))for($row=$('<tr class="element-row"></tr>'),$table.prepend($row),ccnt=0;ccnt<this.model.sets;ccnt++){this.model.enumSets[ccnt]&&this.model.enumSets[ccnt].length>0&&ccnt<this.model.sets-1&&$row.append("<th></th>");var $th=$('<th class="element-heading"></th>');$th.html(this.model.headings[ccnt]),$row.append($th)}},appendRowsTable:function(){var $row,rowIt,colIt,$table=$("<table></table>");this.node.append($table);var columns=this.model.elements.length/this.model.sets;for(rowIt=0;rowIt<this.model.sets;rowIt++){if(this.model.enumSets[rowIt]&&this.model.enumSets[rowIt][0]&&rowIt<this.model.sets-1){for($row=$("<tr></tr>").appendTo($table),colIt=0;colIt<columns;colIt++)$row.append('<td class="ll-enum ll-enum-set-'+(rowIt+1)+'"><span class="enum-placeholder"></span></td>'),this.model.enumSets[rowIt][colIt].then(function(enumSymbol){$row.find(".enum-placeholder").replaceWith(enumSymbol)});_.isEmpty(this.model.headings)||$row.prepend("<th></th>")}for($row=$('<tr class="element-row"></tr>').appendTo($table),colIt=0;colIt<columns;colIt++){var $td=$('<td class="element"></td>');$row.append($td);var model=this.model.elements[(a5.dp.config.linkingLinesTouchDirection[1]?this.model.sets-rowIt-1:rowIt)*columns+colIt],view=this.createElementView(model);this.children.push(view),$td.append(view.render()),this.modelViewMapping[model.identifier]=view}if(!_.isEmpty(this.model.headings)){var $th=$('<th class="element-heading"></th>');$th.html(this.model.headings[rowIt]),$row.prepend($th)}if(this.model.enumSets[rowIt]&&this.model.enumSets[rowIt][0]&&rowIt==this.model.sets-1){for($row=$("<tr></tr>").appendTo($table),colIt=0;colIt<columns;colIt++)$row.append('<td class="ll-enum ll-enum-set-'+(rowIt+1)+'"><span class="enum-placeholder"></span></td>'),this.model.enumSets[rowIt][colIt].then(function(enumSymbol){$row.find(".enum-placeholder").replaceWith(enumSymbol)});_.isEmpty(this.model.headings)||$row.prepend("<th></th>")}}},createElementView:function(model,parent){return new a5.views.interaction.LLElementView(model,this)},createEraser:function(){var template=a5.service.templates.render("a5.view.toolbar.erase")||this.ERASER_TEMPLATE;this.eraserButton=this.interaction.toolbar.addToggleButton({label:$(template).text()||"Erase",title:$(template).attr("title"),classes:["erase"],on:_.bind(function(){$("body").addClass("erasing"),this.inputHandler.setErasing(!0)},this),off:_.bind(function(){$("body").removeClass("erasing"),this.inputHandler.setErasing(!1)},this)})},onErase:function(pos,node){var element=$(node).data("mvc-view");this.clear(element.model,element.isEnd(pos))},onStart:function(pos,node){var element=$(node).data("mvc-view"),isEnd=element.isEnd(pos);element.node.find(isEnd?".right_handle, .bottom_handle":".left_handle, .top_handle").addClass("handle-hover"),element.model.prefilled||this.start(element.model,element.getLineEndpoint(isEnd))},onLinking:function(pos,$container){if(!this.model.behaviourIsTouch||!a5.dp.config.drawRectLinkLines){var tl=this.node.offset();tl.left=pos.pageX-tl.left,tl.top=pos.pageY-tl.top,this.current(tl)}this.startModel&&(this.dragContainer&&this.dragContainer.length>0?this.dragContainer.trigger("linking-lines-dragging",[pos.pageX,pos.pageY,this.SCROLL_SENSITIVITY,this.SCROLL_SPEED]):this.updateScrollY(pos.pageY,this.SCROLL_SENSITIVITY,this.SCROLL_SPEED))},onFinish:function(pos,node,$container){var element=$(node).data("mvc-view");this.end(element&&element.model),this.repaintCanvas(),this.$(".handle-hover").removeClass("handle-hover"),this.dragContainer&&this.dragContainer.length>0&&this.dragContainer.trigger("linking-lines-dragged",[pos.pageX,pos.pageY,this.SCROLL_SENSITIVITY,this.SCROLL_SPEED])},updateScrollY:function(y,scrollSensitivity,scrollSpeed){var scrollParent=this.node.scrollParent();scrollParent[0]===document?y-$(document).scrollTop()<scrollSensitivity+a5.dp.config.exclusionTop?$(document).scrollTop($(document).scrollTop()-scrollSpeed):$(window).height()-(y-$(document).scrollTop())<scrollSensitivity+a5.dp.config.exclusionBottom&&$(document).scrollTop($(document).scrollTop()+scrollSpeed):y-scrollParent.offset().top<scrollSensitivity?scrollParent.scrollTop(scrollParent.scrollTop()-scrollSpeed):scrollParent.offset().top+scrollParent.outerHeight()-y<scrollSensitivity&&scrollParent.scrollTop(scrollParent.scrollTop()+scrollSpeed)},createRepaintCanvas:function(){this.canvas?this.canvas.$.remove():$(window).on("resize",_.throttle(this.resizeCanvas.bindTo(this),500));var w=this.node.width(),h=this.node.height();this.canvas=this.model.behaviourIsTouch?new a5.views.interaction.LLTouchCanvas(w,h,this.model.displayInRows):new a5.views.interaction.LLCanvas(w,h,this.model.displayInRows),this.node.prepend(this.canvas.render()),this.node.find("img").on("load",this.resizeCanvas.bind(this)),a5.hooks.interactionFontUpdated.add(this.resizeCanvas.bind(this)),this.repaintCanvas()},resizeCanvas:function(){this.interaction.isVisibleAndLoaded()&&(this.node.find("canvas, svg").attr({width:this.node.width(),height:this.node.height()}),this.repaintCanvas())},clear:function(element,isEnd){var reverse=a5.dp.config.linkingLinesTouchDirection[this.model.displayInRows?1:0];this.model.clear(element,reverse?!isEnd:isEnd),this.repaintCanvas()},removeLinkClasses:function(m1,m2){
var v1=this.modelViewMapping[m1.identifier],v2=this.modelViewMapping[m2.identifier];v1.$(".right_handle, .bottom_handle").removeClass(function(){return _.filter($(this).attr("class").split(/\s+/),function(c){return"linked"==c||0===c.indexOf("color")}).join(" ")}),v2.$(".left_handle, .top_handle").removeClass(function(){return _.filter($(this).attr("class").split(/\s+/),function(c){return"linked"==c||0===c.indexOf("color")}).join(" ")})},start:function(model,position){this.startModel=model,this.startPosition=position,this.currentPosition=position,this.repaintCanvas()},end:function(model){this.model.behaviourIsTouch?this.createTouchLine(this.startModel,model):this.model.addLine(this.startModel,model)&&(this.modelViewMapping[this.startModel.identifier].$(".handle").addClass("linked"),this.modelViewMapping[model.identifier].$(".handle").addClass("linked")),this.startModel=null},createTouchLine:function(from,to){var line=[];if(this.model.lineIsValid([from,to],line)){var i,color,self=this,v1=this.modelViewMapping[line[0].identifier],v2=this.modelViewMapping[line[1].identifier],isEnd=!a5.dp.config.linkingLinesTouchDirection[this.model.displayInRows?1:0],p1=v1.getLineEndpoint(isEnd),p2=v2.getLineEndpoint(!isEnd);i=this.model.displayInRows?(a5.dp.config.linkingLinesTouchDirection[1]?v2:v1).node.closest("td").index():(a5.dp.config.linkingLinesTouchDirection[0]?v2:v1).node.closest("tr").index(),color=(a5.dp.config.linkingLinesColors||[])[i]||this.defaultColor,this.model.filterLines(line[0],line[1]),this.canvas.animateLine(p1,p2,i+1,color,"white",this.lineWidth,Date.now(),_.bind(this.repaintCanvas,this),function(){self.model.addLine(from,to),v1.$(".right_handle, .bottom_handle").addClass("linked color"+(i+1)),v2.$(".left_handle, .top_handle").addClass("linked color"+(i+1))})}},current:function(position){this.currentPosition=position,this.repaintCanvas()},repaintCanvas:function(){this.canvas&&(this.canvas.clear(),this.$(".handle").removeClass("linked"),_.each(this.model.prefilledLines,function(line){this.drawLine(line,this.prefillColor,"white",this.lineWidth,this.prefillStyle)},this),this.drawNextAnswer(),"feedback"===this.model.state?this.drawFeedbackLines():"answers"===this.model.state?this.drawAnswersLines():this.drawInputLines(),this.startModel&&"a5.views.interaction.LLView"===this._class_name&&this.canvas.drawLine(this.startPosition,this.currentPosition,this.defaultColor,"white",this.lineWidth))},drawFeedbackLines:function(){_.each(this.model.lines,function(line){line[0].isCorrect()?this.drawLine(line,this.feedbackCorrectColor,"white",this.lineWidth,this.feedbackCorrectStyle):this.drawLine(line,this.feedbackWrongColor,"white",this.lineWidth,this.feedbackWrongStyle)},this)},drawAnswersLines:function(){_.each(this.model.lines,function(line){line[0].isCorrect()||this.drawLine(line,this.answersWrongColor,"white",this.lineWidth,this.answersWrongStyle)},this),_.each(this.model.correctModels(),function(line){line[0].prefilled||(line[0].isCorrect()?this.drawLine(line,this.answersCorrectColor,"white",this.lineWidth,this.answersCorrectStyle):this.drawLine(line,this.unattemptedColor,"white",this.lineWidth,this.unattemptedStyle))},this)},drawNextAnswer:function(){_.each(this.model.prevAnswers,function(line){this.drawLine(line,this.defaultColor,"white",this.lineWidth)},this)},drawInputLines:function(){_.each(this.model.lines,function(line){this.model.tryAgainIsFrozen&&line.checked?this.drawLine(line,this.feedbackCorrectColor,"white",this.lineWidth,this.feedbackCorrectStyle):this.drawLine(line,this.defaultColor,"white",this.lineWidth)},this)},drawLine:function(line,color,sColor,lineWidth,lineStyle){var m1=this.modelViewMapping[line[0].identifier],m2=this.modelViewMapping[line[1].identifier],isEnd=!a5.dp.config.linkingLinesTouchDirection[this.model.displayInRows?1:0],p1=m1.getLineEndpoint(isEnd),p2=m2.getLineEndpoint(!isEnd);if(this.model.behaviourIsTouch){var i;i=this.model.displayInRows?(a5.dp.config.linkingLinesTouchDirection[1]?m2:m1).node.closest("td").index():(a5.dp.config.linkingLinesTouchDirection[0]?m2:m1).node.closest("tr").index(),this.removeLinkClasses(line[0],line[1]),m1.$(".handle").addClass("linked color"+(i+1)),m2.$(".handle").addClass("linked color"+(i+1)),color=(a5.dp.config.linkingLinesColors||[])[i]||color}else m1.$(".handle").addClass("linked"),m2.$(".handle").addClass("linked");this.canvas.drawLine(p1,p2,color,sColor,lineWidth,lineStyle)}},a5.views.interaction.BaseView.extend("a5.views.interaction.LLView"),a5.views.interaction.LLElementView={NODE_HTML:'<div class="ll_element_view"></div>',TOP_HANDLE_HTML:'<div class="handle top_handle"></div>',LEFT_HANDLE_HTML:'<div class="handle left_handle"></div>',BOTTOM_HANDLE_HTML:'<div class="handle bottom_handle"></div>',RIGHT_HANDLE_HTML:'<div class="handle right_handle"></div>',SELECTION_AREA_HTML:'<span class="selection_area"></span>',init:function(model,parent){this._super(model,parent,$(this.NODE_HTML)),this.node.addClass(this.getClassName()),-1!==this.model.position&&this.node.append(this.getBeginningHandle()),1!==this.model.position&&this.node.append(this.getEndHandle()),this.model.prefilled&&(this.node.addClass("prefill"),this.$(".handle").addClass("linked")),this.model.content&&this.node.append(this.model.content),this.model.tts_audio&&this.addTTSPlayer(),a5.dp.config.linkingSelectionAreaEnabled&&("right"===this.getClassName()?this.node.find(".content").prepend(this.SELECTION_AREA_HTML):this.node.find(".content").append(this.SELECTION_AREA_HTML))},addTTSPlayer:function(){this.tts_player=new a5.views.TTS_Player($(this.model.content).text()),$(this.node).prepend(this.tts_player.render())},getClassName:function(position){switch(this.model.position){case-1:return this.model.parent.displayInRows?"top":"left";case 1:return this.model.parent.displayInRows?"bottom":"right";default:return"center"}},getBeginningHandle:function(){return this.model.parent.displayInRows?this.TOP_HANDLE_HTML:this.LEFT_HANDLE_HTML},getEndHandle:function(){return this.model.parent.displayInRows?this.BOTTOM_HANDLE_HTML:this.RIGHT_HANDLE_HTML},isEnd:function(pos){return-1===this.model.position||1!==this.model.position&&(this.model.parent.displayInRows?pos.pageY>this.node.offset().top+this.node.outerHeight()/2:pos.pageX>this.node.offset().left+this.node.outerWidth()/2)},getLineEndpoint:function(isEnd){var rh=this.node.find(isEnd?".right_handle, .bottom_handle":".left_handle, .top_handle");rh.length||(rh=this.node.find(".handle"));var p=rh.offset(),tl=this.parent.node.offset();return p.left-=tl.left-rh.outerWidth()/2,p.top-=tl.top-rh.outerHeight()/2,p},setAnswer:function(){var setCheck=!this.model.prefilled&&this.model.isFilled();this.setAnswerCheck(setCheck)},setAnswerInput:function(){var setCheck=!this.model.prefilled&&this.model.isFilled();this.setAnswerCheck(setCheck)},addCheck:function(params){if(a5.dp.config.linkingSelectionAreaEnabled){this.node.find(".check").remove();var area=this.node.find(".selection_area");this.model.isFilled()&&area.addClass("selected"),area.removeClass("correct wrong"),area.addClass(this.model.isCorrect()?"correct":"wrong"),params.parent=area}this._super(params)},setAnswerCheck:function(check){this.node.find(".check").remove(),check&&(this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})),this.setFeedbackState()},showAnswer:function(){this.node.find(".check").remove(),this.model.prefilled||(this.model.isCorrect()?(this.addCheck({correct:!0,tooltip:this.model.getAnswerFeedback()}),this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})):(this.addCheck({empty:!this.model.isFilled(),tooltip:this.model.getAnswerFeedback()}),this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))),this.setFeedbackState()},removeAnswer:function(){this.node.find(".check").remove(),this.setFeedbackState()},setFeedbackState:function(){this.updateFeedbackState(this.node.find(".handle").addBack())}},a5.views.interaction.BaseView.extend("a5.views.interaction.LLElementView"),Obj.extend("a5.views.interaction.LLCanvas",{init:function(w,h,displayInRows){this.$=$('<canvas width="'+w+'" height="'+h+'"></canvas>'),this.displayInRows=displayInRows},clear:function(){this.$[0].getContext("2d").clearRect(0,0,this.$[0].width,this.$[0].height)},drawLine:function(p1,p2,color,sColor,lineWidth,lineStyle){var delta,co=this.$[0].getContext("2d");co.shadowBlur=3,co.shadowColor=sColor,co.lineWidth=lineWidth,co.lineJoin="round",co.strokeStyle=color,co.beginPath(),co.setLineDash(this.getLineDash(lineStyle,lineWidth)),co.moveTo(p1.left,p1.top),this.displayInRows?(delta=(p2.top-p1.top)/2,co.bezierCurveTo(p1.left,p1.top+delta,p2.left,p2.top-delta,p2.left,p2.top)):(delta=(p2.left-p1.left)/2,co.bezierCurveTo(p1.left+delta,p1.top,p2.left-delta,p2.top,p2.left,p2.top)),co.stroke()},getLineDash:function(style,lineWidth){var dash=[];return"dotted"===style?dash=[lineWidth,lineWidth]:"dashed"===style&&(dash=[3*lineWidth,lineWidth]),dash},render:function(){return this.$}}),a5.views.interaction.LLTouchCanvas={CONNECTOR_HTML:'<div class="connector">',getIntermediatePosition:function(x1,x2){var gap,p1,p2;if(this.displayInRows){x1.top>x2.top?(p1=x2,p2=x1):(p1=x1,p2=x2),gap=p2.top-p1.top;var width=this.$.width(),center=width/2,adjustedLeft=p1.left+(center-p1.left)/2;return p1.top+gap*adjustedLeft/width}x1.left>x2.left?(p1=x2,p2=x1):(p1=x1,p2=x2),gap=p2.left-p1.left;var height=this.$.height(),middle=height/2,adjustedTop=p1.top+(middle-p1.top)/2;return p1.left+gap*adjustedTop/height},drawLine:function(p1,p2,color,sColor,lineWidth,lineStyle){a5.dp.config.drawRectLinkLines?this.drawRectLine(p1,p2,color,sColor,lineWidth,lineStyle):this._super(p1,p2,color,sColor,lineWidth,lineStyle)},drawRectLine:function(p1,p2,color,sColor,lineWidth,lineStyle){var co=this.$[0].getContext("2d");if(co.shadowBlur=3,co.shadowColor=sColor,co.lineWidth=lineWidth,co.lineJoin="round",co.strokeStyle=color,co.beginPath(),co.setLineDash(this.getLineDash(lineStyle,lineWidth)),this.displayInRows){var intermediateTop=this.getIntermediatePosition(p1,p2);co.moveTo(p1.left,p1.top),co.lineTo(p1.left,intermediateTop),co.lineTo(p2.left,intermediateTop),co.lineTo(p2.left,p2.top),co.stroke()}else{var intermediateLeft=this.getIntermediatePosition(p1,p2);co.moveTo(p1.left,p1.top),co.lineTo(intermediateLeft,p1.top),co.lineTo(intermediateLeft,p2.top),co.lineTo(p2.left,p2.top),co.stroke()}},animateLine:function(p1,p2,index,color,sColor,lineWidth,startTime,repaintCanvas,callback){var angle,time=Date.now()-startTime,length=Math.abs(p2.left-p1.left)+Math.abs(p2.top-p1.top),paintedDistance=length*time/a5.dp.config.linkingLinesTouchDuration,points=[],distance=0,finished=!1;if(this.displayInRows){angle=a5.dp.config.linkingLinesTouchDirection[1]?-90:90;var intermediateTop=this.getIntermediatePosition(p1,p2);Math.abs(p1.top-intermediateTop)>=paintedDistance?points.push([p1.left,-90===angle?p1.top-paintedDistance:p1.top+paintedDistance]):(points.push([p1.left,intermediateTop]),distance+=Math.abs(p1.top-intermediateTop),distance+Math.abs(p2.left-p1.left)>=paintedDistance?p2.left>p1.left?(points.push([p1.left+paintedDistance-distance,intermediateTop]),angle=0):(points.push([p1.left-paintedDistance+distance,intermediateTop]),angle=180):(points.push([p2.left,intermediateTop]),distance+=Math.abs(p2.left-p1.left),distance+Math.abs(intermediateTop-p2.top)>=paintedDistance?points.push([p2.left,-90===angle?intermediateTop-paintedDistance+distance:intermediateTop+paintedDistance-distance]):(points.push([p2.left,p2.top]),finished=!0)))}else{angle=a5.dp.config.linkingLinesTouchDirection[0]?180:0;var intermediateLeft=this.getIntermediatePosition(p1,p2);Math.abs(intermediateLeft-p1.left)>=paintedDistance?points.push([0===angle?p1.left+paintedDistance:p1.left-paintedDistance,p1.top]):(points.push([intermediateLeft,p1.top]),distance+=Math.abs(intermediateLeft-p1.left),distance+Math.abs(p2.top-p1.top)>=paintedDistance?p2.top>p1.top?(points.push([intermediateLeft,p1.top+paintedDistance-distance]),angle=90):(points.push([intermediateLeft,p1.top-paintedDistance+distance]),angle=-90):(points.push([intermediateLeft,p2.top]),distance+=Math.abs(p2.top-p1.top),distance+Math.abs(p2.left-intermediateLeft)>=paintedDistance?points.push([0===angle?intermediateLeft+paintedDistance-distance:intermediateLeft-paintedDistance+distance,p2.top]):(points.push([p2.left,p2.top]),finished=!0)))}if(finished)this.$.siblings(".connector").remove(),callback.call();else{repaintCanvas();var co=this.$[0].getContext("2d");co.shadowBlur=3,co.shadowColor=sColor,co.lineWidth=lineWidth,co.lineJoin="round",co.strokeStyle=color,co.beginPath(),co.moveTo(p1.left,p1.top),_.each(points,function(p){co.lineTo(p[0],p[1])}),co.stroke();var connector=this.$.siblings(".connector");connector.length||(connector=$(this.CONNECTOR_HTML).addClass("color"+index).appendTo(this.$.parent())),connector.css({position:"absolute",transform:"rotate("+angle+"deg)",left:_.last(points)[0]-connector.outerWidth()/2,top:_.last(points)[1]-connector.outerHeight()/2});var self=this;a5.utils.requestAnimationFrame(function(){self.animateLine(p1,p2,index,color,sColor,lineWidth,startTime,repaintCanvas,callback)})}}},a5.views.interaction.LLCanvas.extend("a5.views.interaction.LLTouchCanvas"),a5.views.interaction.LinkingMultipleLines={SCROLL_SENSITIVITY:10,SCROLL_SPEED:20,eraserRect:null,collidingLine:null,NODE_TEMPLATE:'<div class="ll_view multiple"></div>',ERASER_TEMPLATE:'<span title="Eraser">Erase</span>',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE).addClass(model.displayInRows?"display-in-rows":"display-in-columns").addClass(model.behaviourIsTouch?"touch":"drag")),this.interaction=model.parent,this.toolbarNode=this.interaction.toolbar.views()[0].node,this._renderEnumOnce=_.once(this.renderEnum,this),this.children=[],this.columns={},this.elements={},this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("state_update:feedback",this.setAnswer,this),this.interaction.options.eraserIsOn()&&this.createEraser(),this.getLinkConfig(),this.interaction.bind("hide",this.onInteractionHide,this),this.interaction.bind("show",this.onInteractionShow,this),this.interaction.bind("show:deferred",this.createRepaintCanvas,this),this.interaction.bind("reset",this.onInteractionReset,this,{once:!0}),this.inputHandler=this.model.behaviourIsTouch?new a5.views.LinkingLinesTouchHandler(this.node,".ll_element_view"):new a5.views.LinkingLinesDragHandler(this.node,".ll_element_view"),this.inputHandler.bind("erase",this.onErase,this),this.inputHandler.bind("start",this.onStart,this),this.inputHandler.bind("linking",this.onLinking,this),this.inputHandler.bind("finish",this.onFinish,this),this.startSide=this.model.displayInRows?"bottom":"right",this.endSide=this.model.displayInRows?"top":"left",this.tableKeyForSeeAnswers=new a5.views.interaction.LinkingMultipleLinesKeyTable,this.tableKeyForSeeAnswers.addEntry(this.lineWidth,this.prefillColor,this.prefillStyle,"prefill"),this.tableKeyForSeeAnswers.addEntry(this.lineWidth,this.answersCorrectColor,this.answersCorrectStyle,"correct"),this.tableKeyForSeeAnswers.addEntry(this.lineWidth,this.answersWrongColor,this.answersWrongStyle,"wrong"),this.tableKeyForSeeAnswers.addEntry(this.lineWidth,this.unattemptedColor,this.unattemptedStyle,"missing"),this.tableKeyForCheckAnswers=new a5.views.interaction.LinkingMultipleLinesKeyTable,this.tableKeyForCheckAnswers.addEntry(this.lineWidth,this.prefillColor,this.prefillStyle,"prefill"),this.tableKeyForCheckAnswers.addEntry(this.lineWidth,this.feedbackCorrectColor,this.feedbackCorrectStyle,"correct"),this.tableKeyForCheckAnswers.addEntry(this.lineWidth,this.feedbackWrongColor,this.feedbackWrongStyle,"wrong"),this.model.bind("next_answer",this.onNextAnswer,this),_.bindAll(this,"onMove")},_getColor:function(classname,type,attribute){var color=a5.utils.getCSSAttributeFromCSS(classname,type,attribute),default_color=a5.utils.getCSSAttributeFromCSS(".is-linking-multiple-lines","fill-color","background-color");return color==a5.utils.getCSSAttributeFromCSS(".is-linking-multiple-lines",null,"background-color",{background:"none"})&&(color=default_color),color},append:function(columnId,id,prefilled,content){var column=this.columns[columnId];column||(column=new a5.views.interaction.LinkingMultipleLinesColumn,this.columns[columnId]=column,this.children.push(column));var element=new a5.views.interaction.LinkingMultipleLinesElement(this.model,id,prefilled,content,this);column.children.push(element),this.elements[element.id]=element},prependEnumColumn:function(enumerator,rows){var $column=$('<div class="ll_enum_column"></div>');_(rows).times(function(){var $element=$('<div class="ll_element_view"><span class="enum-placeholder"></span></div>');enumerator.next().then(function(enumSymbol){$element.find(".enum-placeholder").replaceWith(enumSymbol)}),$column.append($element)},this),this.node.prepend($column)},prependEnumRow:function(enumerator,columns){this.node.find(".ll_column:first .ll_element_view").each(function(index,elem){$(elem).prepend('<span class="enum-placeholder"></span>'),enumerator.next().then(function(enumSymbol){$(elem).find(".enum-placeholder").replaceWith(enumSymbol)})})},renderEnum:function(){this.model.displayInRows?this.prependEnumRow(this.interaction.enumAnswers,this.model.answers.size()):this.prependEnumColumn(this.interaction.enumAnswers,this.model.answers.size())},render:function(){return this._super(),this.node.off(),this.node.on("mousemove touchmove",this.onMove),this.renderChildren(),this.interaction.options.enumerationAnswersIsFalse()||this._renderEnumOnce(),this.repaintCanvas(),this.renderKeyTable(),this.node},renderKeyTable:function(){this.toolbarNode.siblings(".llm-key-table").remove(),"true"!==a5.utils.getPersistentKey("llm_hide_keys")&&("feedback"==this.model.state?this.toolbarNode.after(this.tableKeyForCheckAnswers.render()):"answers"===this.model.state&&this.toolbarNode.after(this.tableKeyForSeeAnswers.render()))},getLinkConfig:function(){this.prefillColor=a5.dp.config.linkingMultipleLinesPrefillColor||this._getColor(".is-linking-multiple-lines","prefill-answer","background-color"),this.prefillStyle=a5.dp.config.linkingMultipleLinesPrefillStyle,this.answersWrongColor=a5.dp.config.linkingMultipleLinesAnswersWrongColor||this._getColor(".is-linking-multiple-lines","wrong-answer","background-color"),this.answersWrongStyle=a5.dp.config.linkingMultipleLinesAnswersWrongStyle,this.answersCorrectColor=a5.dp.config.linkingMultipleLinesAnswersCorrectColor||this._getColor(".is-linking-multiple-lines","correct-answer","background-color"),this.answersCorrectStyle=a5.dp.config.linkingMultipleLinesAnswersCorrectStyle,this.feedbackWrongColor=a5.dp.config.linkingMultipleLinesFeedbackWrongColor||this._getColor(".is-linking-multiple-lines","wrong-answer","background-color"),this.feedbackWrongStyle=a5.dp.config.linkingMultipleLinesFeedbackWrongStyle,this.feedbackCorrectColor=a5.dp.config.linkingMultipleLinesFeedbackCorrectColor||this._getColor(".is-linking-multiple-lines","correct-answer","background-color"),this.feedbackCorrectStyle=a5.dp.config.linkingMultipleLinesFeedbackCorrectStyle,this.hoverColor=a5.dp.config.linkingMultipleLinesHoverColor||this._getColor(".is-linking-multiple-lines","hover-color","background-color"),this.seeNextAnswerColor=a5.dp.config.linkingMultipleLinesSeeNextAnswerColor||this.feedbackCorrectColor,this.seeNextAnswerStyle=this.seeNextAnswerStyle||a5.dp.config.linkingMultipleLinesSeeNextAnswerStyle||this.feedbackCorrectColor,this.defaultColor=a5.dp.config.linkingMultipleLinesDefaultColor||this._getColor(".is-linking-multiple-lines","fill-color","background-color"),this.unattemptedColor=a5.dp.config.linkingMultipleLinesUnattemptedColor||this.defaultColor,this.unattemptedStyle=a5.dp.config.linkingMultipleLinesUnattemptedStyle,this.lineWidth=a5.dp.config.linkingMultipleLinesLineWidth||a5.utils.getCSSAttributeFromCSS(".is-linking-multiple-lines","line-width","max-width"),this.lineWidth=parseInt(this.lineWidth,10),_.isNaN(this.lineWidth)&&(this.lineWidth=4)},onInteractionHide:function(){this.inputHandler.unbindEvents(),$("body").removeClass("erasing")},onInteractionShow:function(){this.updateInputHandlerState(),this.getLinkConfig(),$("body").toggleClass("erasing",this.inputHandler.isErasing())},onInteractionReset:function(){this.interaction.unbind("show",this.onInteractionShow),this.interaction.unbind("hide",this.onInteractionHide),this.inputHandler.unbindEvents()},onStateUpdate:function(){var handles=this.node.find(".handle"),nodes=handles.add(handles.parent());this.checkLocked(nodes),nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct"),this.renderKeyTable(),this.repaintCanvas(),a5.mainBuilder.curInteraction===this.model.parent&&this.updateInputHandlerState()},setAnswer:function(){this.eraserButton&&this.eraserButton.setPressed(!1)},updateInputHandlerState:function(){"input"===this.model.state?this.inputHandler.bindEvents():this.inputHandler.unbindEvents()},createEraser:function(){var template=a5.service.templates.render("a5.view.toolbar.erase")||this.ERASER_TEMPLATE;this.eraserButton=this.interaction.toolbar.addToggleButton({label:$(template).text()||"Erase",title:$(template).attr("title"),classes:["erase"],on:_.bind(function(){this.eraserRect||this.createEraserRect(),$("body").addClass("erasing"),this.inputHandler.setErasing(!0)},this),off:_.bind(function(){this.eraserRect||this.createEraserRect(),$("body").removeClass("erasing"),this.inputHandler.setErasing(!1)},this)})},createEraserRect:function(){this.eraserRect={width:parseInt(a5.utils.getCSSAttributeFromCSS(".is-linking-multiple-lines","eraser","width"),10),height:parseInt(a5.utils.getCSSAttributeFromCSS(".is-linking-multiple-lines","eraser","height"),10)}},onErase:function(pos,node){var element=$(node).data("mvc-view");this.model.lines.clear(element.id),this.repaintCanvas()},onStart:function(pos,node){var element=$(node).data("mvc-view");if(element){var center=element.getCenter(pos.pageX-this.node.offset().left,pos.pageY-this.node.offset().top,this.model.displayInRows,this.startSide,this.endSide),position=this.toRelative(center.left,center.top);element.$(".handle").addClass("handle-hover"),this.startElement=element,this.startPosition=position,this.currentPosition=position,this.repaintCanvas()}},onLinking:function(pos){var coords=this.toRelative(pos.pageX,pos.pageY);this.current(coords),this.startElement&&this.updateScrollY(pos.pageY,this.SCROLL_SENSITIVITY,this.SCROLL_SPEED)},onMove:function(ev){if(!this.inputHandler.linking&&!this.inputHandler.erasing){var myEv=ev.originalEvent.touches?ev.originalEvent.touches[0]:ev,pos=_.pick(myEv,"pageX","pageY","clientX","clientY"),coords=this.toRelative(pos.pageX,pos.pageY);this.collidingLine=this.findCollidingLine(coords),this.repaintCanvas()}},onFinish:function(pos,node){this.end($(node).data("mvc-view"))},onNextAnswer:function(){var line=_.last(this.model._prevAnswers);this.model.hasCandidatesForShowNextAnswer()||this.drawCorrectAnswers(),_.defer(_.bind(function(){this.repaintCanvas()},this)),a5.utils.scrollIntoElementIfNeeded(this.elements[line.from].node)},findCollidingLine:function(cursor){var lines=this.model.lines.union(this.model.prefilledLines);"answers"===this.model.state&&(lines=lines.union(this.model.answers)),lines=lines.children;for(var i=lines.length-1;i>=0;i--){var approx=this.lineToBezier(lines[i]).approximate(),selectBox=new Box(cursor.left-this.lineWidth/2,cursor.top-this.lineWidth/2,this.lineWidth,this.lineWidth);if(new LinesBoxIntersection(approx,selectBox).intersectAny())return lines[i]}return null},toRelative:function(left,top){var offset=this.node.offset();return left-=offset.left,top-=offset.top,new Point(left,top)},updateScrollY:function(y,scrollSensitivity,scrollSpeed){var scrollParent=this.node.scrollParent();scrollParent[0]===document?y-$(document).scrollTop()<scrollSensitivity+a5.dp.config.exclusionTop?$(document).scrollTop($(document).scrollTop()-scrollSpeed):$(window).height()-(y-$(document).scrollTop())<scrollSensitivity+a5.dp.config.exclusionBottom&&$(document).scrollTop($(document).scrollTop()+scrollSpeed):y-scrollParent.offset().top<scrollSensitivity?scrollParent.scrollTop(scrollParent.scrollTop()-scrollSpeed):scrollParent.offset().top+scrollParent.outerHeight()-y<scrollSensitivity&&scrollParent.scrollTop(scrollParent.scrollTop()+scrollSpeed)},createRepaintCanvas:function(){if(!this.canvas){var w=this.node.width(),h=this.node.height();this.canvas=new a5.views.interaction.LinkingMultipleLinesCanvas(w,h),this.node.prepend(this.canvas.render()),$(window).on("resize",_.throttle(this.resizeCanvas.bindTo(this),500)),this.node.find("img").on("load",this.resizeCanvas.bind(this)),a5.hooks.interactionFontUpdated.add(this.resizeCanvas.bind(this))}this.repaintCanvas()},resizeCanvas:function(){this.interaction.isVisibleAndLoaded()&&(this.node.find("canvas").attr({width:this.node.width(),height:this.node.height()}),this.repaintCanvas())},appendHandles:function(){_.each(this.children,function(column,i){0!==i&&column.appendHandles(this.endSide),i!==this.children.length-1&&column.appendHandles(this.startSide)},this)},findColumn:function(element){return _.find(this.children,function(child){return _.include(child.children,element)})},shuffle:function(){_.each(this.columns,function(column){column.children=_.shuffle(column.children)},this)},shuffleRest:function(){_(this.columns).chain().values().rest().each(function(column){column.children=_.shuffle(column.children)},this)},current:function(position){this.currentPosition=position,this.repaintCanvas()},end:function(element){element&&this.startElement&&this.addLine(this.startElement,element),this.startElement=null,this.repaintCanvas(),this.$(".handle-hover").removeClass("handle-hover")},addLine:function(from,to){var column1=this.findColumn(from),column2=this.findColumn(to);if(column1!==column2){if(_.indexOf(this.children,column1)>_.indexOf(this.children,column2)){var tmp=from;from=to,to=tmp}this.model.addLine(from.id,to.id)}},repaintCanvas:function(){this.canvas&&(this.$(".handle").removeClass("linked"),this.canvas.clear(),this.model.prefilledLines.each(function(line){this.drawLine(line,this.prefillColor,this.lineWidth)},this),this.drawNextAnswer(),"feedback"==this.model.state?this.drawFeedbackLines():"answers"==this.model.state?this.model.isRevealedBySeeNext()?this.drawCorrectAnswers():this.drawAnswersLines():this.drawInputLines(),this.startElement&&this.canvas.drawLine(new Bezier(this.startPosition,this.currentPosition),this.defaultColor,this.lineWidth))},drawFeedbackLines:function(){this.model.answers.each(function(line){this.model.prefilledLines.include(line)||this.model.lines.include(line)||(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("checked-empty"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("checked-empty"))},this),this.model.lines.each(function(line){this.model.answers.include(line)?(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("checked-correct"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("checked-correct"),this.drawLine(line,this.feedbackCorrectColor,this.lineWidth,this.feedbackCorrectStyle)):(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("checked-incorrect"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("checked-incorrect"),this.drawLine(line,this.feedbackWrongColor,this.lineWidth,this.feedbackWrongStyle))},this)},drawCorrectAnswers:function(){this.model.lines.each(function(line){this.model.answers.include(line)&&(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("solution-correct"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("solution-correct"),this.drawLine(line,this.answersCorrectColor,this.lineWidth,this.answersCorrectStyle))},this)},drawAnswersLines:function(){this.model.answers.each(function(line){this.model.prefilledLines.include(line)||this.model.lines.include(line)||(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("solution-empty"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("solution-empty"),this.drawLine(line,this.unattemptedColor,this.lineWidth,this.unattemptedStyle))},this),this.model.lines.each(function(line){this._isRevealedBySeeNext(line)||(this.model.answers.include(line)?(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("solution-correct"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("solution-correct"),this.drawLine(line,this.answersCorrectColor,this.lineWidth,this.answersCorrectStyle)):(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("solution-incorrect"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("solution-incorrect"),this.drawLine(line,this.answersWrongColor,this.lineWidth,this.answersWrongStyle)))},this)},drawNextAnswer:function(){_.each(this.model._prevAnswers,function(line){this.model.isRevealedBySeeNext()&&(this.elements[line.from].getHandle(this.startSide).parent().addBack().addClass("solution-revealed"),this.elements[line.to].getHandle(this.endSide).parent().addBack().addClass("solution-revealed")),this.drawLine(line,this.seeNextAnswerColor,this.lineWidth,this.seeNextAnswerStyle)},this)},drawInputLines:function(){this.model.lines.each(function(line){this._isRevealedBySeeNext(line)||this.drawLine(line,line.checked?this.feedbackCorrectColor:this.defaultColor,this.lineWidth)},this)},_isRevealedBySeeNext:function(line){return _.contains(this.model._prevAnswers,line)},lineToBezier:function(line){var p1=this.elements[line.from].getCenterByHandle(this.startSide),p2=this.elements[line.to].getCenterByHandle(this.endSide);return new Bezier(this.toRelative(p1.left,p1.top),this.toRelative(p2.left,p2.top))},drawLine:function(line,color,lineWidth,lineStyle){var lineMuted;this.collidingLine==line?lineMuted=!1:this.collidingLine&&(lineMuted=!0),this.canvas.drawLine(this.lineToBezier(line),color,lineWidth,lineStyle,lineMuted),this.setHandlesLinked(line)},setHandlesLinked:function(line){this.elements[line.from].setHandleLinked(this.startSide),this.elements[line.to].setHandleLinked(this.endSide)}},a5.views.interaction.BaseView.extend("a5.views.interaction.LinkingMultipleLines"),a5.views.interaction.LinkingMultipleLinesColumn={init:function(){this._super(null,null,$('<div class="ll_column"></div>')),this.children=[]},render:function(){return this._super(),this.renderChildren(),this.node},appendHandles:function(side){_.each(this.children,function(child){child.handles.push(side)},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.LinkingMultipleLinesColumn"),a5.views.interaction.LinkingMultipleLinesElement={init:function(model,id,prefilled,content,parent){this._super(model,parent,$('<div class="ll_element_view"></div>')),this.id=id,this.prefilled=prefilled,this.content=content,this.handles=[]},render:function(){return this._super(),this.node.off(),this.node.html(this.content.detach()),_.each(this.handles,function(side){var handle='<div class="handle '+side+'_handle"></div>';"top"===side?this.node.prepend(handle):this.node.append(handle)},this),this.prefilled&&this.node.addClass("prefill"),this.node},getCenter:function(x,y,displayInRows,startSide,endSide){var handle,ref=displayInRows?x:y,dimension=displayInRows?"width":"height";return handle=this.handles.length>1?ref>this.node[dimension]()/2?startSide:endSide:this.handles[0],this.getCenterByHandle(handle)},getCenterByHandle:function(handle){var $handle=this.getHandle(handle),center=$handle.offset();return center.left+=$handle.outerWidth()/2,center.top+=$handle.outerHeight()/2,center},getHandle:function(handle){return this.$("."+handle+"_handle")},
setHandleLinked:function(handle){this.getHandle(handle).addClass("linked")}},a5.views.interaction.BaseView.extend("a5.views.interaction.LinkingMultipleLinesElement"),a5.views.interaction.LinkingMultipleLinesCanvas={init:function(width,height){this._super(null,null,$('<canvas width="'+width+'" height="'+height+'"></canvas>'))},drawLine:function(bezier,color,lineWidth,lineStyle,lineMuted){var co=this.getContext();co.shadowBlur=3,co.shadowColor="white",co.lineWidth=lineWidth,co.lineJoin="round",co.strokeStyle=color,co.globalAlpha=1,lineMuted?co.globalAlpha=.2:_.isUndefined(lineMuted)||(co.lineWidth=1.5*lineWidth),co.beginPath(),co.setLineDash(this._getLineDash(lineStyle,lineWidth)),co.moveTo(bezier.p1.left,bezier.p1.top),co.bezierCurveTo(bezier.p2.left,bezier.p2.top,bezier.p3.left,bezier.p3.top,bezier.p4.left,bezier.p4.top),co.stroke()},clear:function(){this.getContext().clearRect(0,0,this.node[0].width,this.node[0].height)},getContext:function(){return this.node[0].getContext("2d")},_getLineDash:function(style,lineWidth){var dash=[];return"dotted"===style?dash=[lineWidth,lineWidth]:"dashed"===style&&(dash=[3*lineWidth,lineWidth]),dash}},a5.views.interaction.BaseView.extend("a5.views.interaction.LinkingMultipleLinesCanvas"),a5.views.interaction.LinkingMultipleLinesKeyTable={TEMPLATE:'<button type="button" class="close" /><table><tr class="llm-key llm-key-prefill"><td><canvas width="80"></canvas></td><td><span>Prefilled</span></td></tr><tr class="llm-key llm-key-correct"><td><canvas width="80"></canvas></td><td><span>Correct</span></td></tr><tr class="llm-key llm-key-wrong"><td><canvas width="80"></canvas></td><td><span>Wrong</span></td></tr><tr class="llm-key llm-key-missing"><td><canvas width="80"></canvas></td><td><span>Missing</span></td></tr></table><div class="last-time"><input type="checkbox" /><span>Do not display again</span></div>',init:function(){this._super(null,null,$('<div class="llm-key-table"></div>')),this.entries=[],_.bindAll(this,"onClickClose","onClickLastTime")},render:function(){var template=a5.service.templates.render("a5.view.LinkingMultipleLinesKeyTable")||this.TEMPLATE,$template=$(template);return this.node.empty(),this.node.append($template),this.node.draggable(),this.node.find(".last-time").on("click",this.onClickLastTime),this.node.find(".close").on("click",this.onClickClose),$template.find(".llm-key").hide(),_(this.entries).each(function(entry){this.renderEntry(entry).show()},this),this.node},onClickLastTime:function(ev){var $input=this.node.find(".last-time input");$(ev.target).is("input")||$input.prop("checked",!$input.prop("checked")),$input.is(":checked")?a5.utils.setPersistentKey("llm_hide_keys",!0):a5.utils.setPersistentKey("llm_hide_keys",!1)},onClickClose:function(ev){this.node.remove()},addEntry:function(lineWidth,lineColor,lineStyle,lineType){this.entries.push({lineWidth:lineWidth,lineColor:lineColor,lineStyle:lineStyle,lineType:lineType})},renderEntry:function(entry){var $entry=this.node.find(".llm-key-"+entry.lineType),$canvas=$entry.find("canvas");$canvas.attr("height",entry.lineWidth);var co=$canvas.get(0).getContext("2d");return co.beginPath(),co.lineWidth=entry.lineWidth,co.strokeStyle=entry.lineColor,co.setLineDash(this._getLineDash(entry.lineStyle,entry.lineWidth)),co.moveTo(0,0),co.lineTo(80,0),co.stroke(),$entry},_getLineDash:function(style,lineWidth){var dash=[0];return"dotted"===style?dash=[lineWidth,lineWidth]:"dashed"===style&&(dash=[3*lineWidth,lineWidth]),dash}},a5.views.interaction.BaseView.extend("a5.views.interaction.LinkingMultipleLinesKeyTable"),a5.views.interaction.OSSequenceView={NODE_TEMPLATE:"<div class='shuffle_interaction'></div>",LINE_TEMPLATE:"<div class='line ui-helper-clearfix'></div>",DROP_PLACEHOLDER_TEMPLATE:"<div class='drop drop-placeholder'>&nbsp;</div>",DRAG_OVERLAP_PERCENT:.3,init:function(model,horizontal,clickclick,dropIndicator,gaptextaudio,capitalize){this._super(model,null,$(this.NODE_TEMPLATE)),this.gaptextaudio=gaptextaudio,this.isHorizontal=horizontal,this.clickclick=clickclick,this.dropIndicator=dropIndicator,this.capitalize=capitalize,this.elements=[],this.lastcursor=!1},render:function(){return this.$node=this._super(),this.$node.addClass(this.isHorizontal?"horizontal":"vertical"),"horizontal_single_word"===this.model.alignment&&this.$node.addClass("single-word"),this.$line=$(this.LINE_TEMPLATE),_.each(this.model.elements,function(e,index){this.appendElement(e).$node.toggleClass("text-capitalize",this.capitalize&&0===index)},this),this.$node.append(this.$line),this.bindEvents(),this.$node},bindEvents:function(){this.model.bind("update-element-order",this.updateElementOrder,this)},appendElement:function(model){var view=new a5.views.interaction.OSSequenceElement(model,null,this.clickclick,this.$line,this.isHorizontal,this.gaptextaudio,this.dropIndicator);return view.bind("dragstart",this.dragStartEvent,this),view.bind("dragend",this.dragEndEvent,this),view.bind("drag",this.dragEvent,this),this.$line.append(view.render()),this.elements.push(view),view},updateElementOrder:function(skipReattach){this.elements=_.map(this.model.elements,function(model){return _.find(this.elements,function(v){return v.model==model})},this),_.each(this.elements,function(v,index){v.$node.toggleClass("text-capitalize",this.capitalize&&0===index),skipReattach||v.$node.detach().appendTo(this.$line)},this)},updateModel:function(elementViews){var elements=_.pluck(elementViews,"model"),index=0;this.model.elements=_.map(this.model.elements,function(e){return _.contains(elements,e)?elements[index++]:e}),this.model.registerAction()},allMovablesExcept:function(child){return _.select(this.elements,function(e){return!(e===child||e.model.fixed||this.model.tryAgainIsFrozen&&$(e.node).hasClass("checked-correct-locked"))},this)},allMovables:function(){return _.select(this.elements,function(e){return!(e.model.fixed||this.model.tryAgainIsFrozen&&$(e.node).hasClass("checked-correct-locked"))},this)},dragStartEvent:function(child){this.movableElements=this.allMovablesExcept(child),this.allMovableElements=this.allMovables()},dragEvent:function(child){if(this.target=_.detect(this.movableElements,function(element){return a5.utils.elementOverlapAreaPercent(element.$node,child.$helper)>=this.DRAG_OVERLAP_PERCENT},this),this.target&&this.lasttarget!==this.target){var target_i=this.allMovableElements.indexOf(this.target),child_i=this.allMovableElements.indexOf(child),elementsBetween=[];target_i<child_i?(elementsBetween=this._getElementsBetween(this.target,child),this.target.$node.insertAfter(child.$node),_.each(elementsBetween,function(element){element.$node.insertBefore(this.target.$node)},this)):(elementsBetween=this._getElementsBetween(child,this.target),this.target.$node.insertBefore(child.$node),_.each(elementsBetween,function(element){element.$node.insertBefore(child.$node)},this)),a5.utils.array.swap(this.elements,this.elements.indexOf(this.target),this.elements.indexOf(child)),a5.utils.array.swap(this.allMovableElements,target_i,child_i)}this.lasttarget=this.target},dragEndEvent:function(child){this.updateModel(this.allMovableElements),this.movableElements=[],this.allMovableElements=[]},_getElementsBetween:function(a,b){var elements=this.elements.slice(this.elements.indexOf(a),this.elements.indexOf(b));return elements.shift(),elements}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSequenceView"),a5.views.interaction.OSSequenceElement={NODE_TEMPLATE:"<div></div>",init:function(model,parent,clickclick,$line,isHorizontal,gaptextaudio,dropindicator){this._super(model,parent,$(this.NODE_TEMPLATE)),this.gaptextaudio=gaptextaudio,this.$line=$line,this.clickclick=clickclick,this.isHorizontal=isHorizontal,this.dropIndicator=dropindicator},_setDraggable:function(){this.$node.draggable($.extend({start:this.dragStartEvent.bindDD(this),stop:this.dragStopEvent.bindDD(this),drag:this.dragEvent.bindDD(this),addClasses:!1,disabled:!0,containment:"parent",revert:!1,helper:"clone",cancel:".checked-correct-locked"},a5.utils.getDraggableOptions(this.model.parent.interaction)))},render:function(){this.$node=this._super(),this.$node.attr("data-id",this.model.identifier);var $content=this.model.content;return $content.text()||$content.addClass("no-label"),this.$node.append($content),this.$helper=$(this.NODE_TEMPLATE),this.gaptextaudio&&(this.tts_audio=new a5.views.TTS_Player(this.model.text),$content.prepend(this.tts_audio.render())),this._setDraggable(),this.$node.addClass("os-sequence-element"),this.model.fixed?(this.$node.addClass("oss-fixed"),this.$node.removeClass("element")):(this.$node.addClass("element"),this.enable()),this.isHorizontal?this.$node.addClass("horizontal").css("display","inline-block"):this.$node.css("display","block"),this.model.prefilled&&this.$node.addClass("prefill"),this.bindEvents(),this.$node},bindEvents:function(){this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.tryAgain,this),this.model.bind("input_update:setAnswer",this.setAnswerInput,this)},setAnswer:function(){this.updateFeedbackState(this.$node),this.disable(),this.setAnswerCheck(!this.model.fixed)},setAnswerInput:function(){this.updateFeedbackState(this.$node),this.setAnswerCheck(!this.model.fixed&&this.model.parent.actionsDone>0)},setAnswerCheck:function(check){check&&(this.$node.find(".check").remove(),this.addCheck({correct:this.model.isCorrect()&&!this.model.isRevealedBySeeNext(),tooltip:this.model.getAnswerFeedback()}),this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))},showAnswer:function(){if(this.updateFeedbackState(this.$node),this.disable(),!this.model.fixed){if(this.$node.find(".check").remove(),this.movedAfterCheckAnswer||!this.model.isCorrect()){var correct=this.model.getCorrect(),parent=correct.content.parent();parent&&this.$node.find(".content").appendTo(parent),this.$node.append(correct.content),this.model.setCurrentIdentifier(correct.identifier),this.addCheck({correct:!1,tooltip:this.model.text,width:1e3})}else this.model.isRevealed()?this.addCheck({correct:!1,tooltip:this.model.text,width:1e3}):(this.$node.append(this.model.content),this.addCheck({correct:!0,tooltip:this.model.text,width:1e3}));var ol=this.$node.offset();ol.top+=this.$node.height();var oc=this.$node.find(".check").offset(),diff={left:ol.left-oc.left,top:ol.top-oc.top};this.$node.find(".tooltip").css(diff)}},tryAgain:function(){this.updateFeedbackState(this.$node),this.removeAnswer(),this.$node.append(this.model.content),this.enable()},removeAnswer:function(){this.$node.find(".check").remove(),this.model.content.closest(this.$node).length>0&&(this.model.content=this.model.content.detach()),this.$node.empty()},disable:function(){this.model.fixed||this.$node.draggable("disable")},dragStartEvent:function(e,data){this.startPosition=this.$node.position(),data.helper.addClass("dragged"),this.$helper=data.helper,this.$helper.width(this.$node.width()+1),this.$node.addClass("drop drop-placeholder").css("color","transparent"),this.$node.toggleClass("drop-indicator",this.dropIndicator),this.trigger("dragstart",this)},dragStopEvent:function(e,data){this.$node.removeClass("dragged").css({left:"",top:"",position:""}),this.trigger("dragend",this),this.$node.removeClass("drop drop-placeholder drop-indicator").width("auto").css("color","inherit")},dragEvent:function(e,data){var cursor=new Point(data.offset.left,data.offset.top);this.trigger("drag",this,cursor,this.$node)},enable:function(){this.model.fixed||this.$node.draggable("enable")},boundaries:function(n,min,max){return n<min?min:n>max?max:n}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSequenceElement"),a5.views.interaction.OSSequenceViewSwap={bindEvents:function(){this.model.bind("next_answer",this.deselect,this),this.model.bind("swapped",this.swap,this),this.model.bind("state_update",this.deselect,this),this.model.bind("update-element-order",this.updateElementOrder,this),$(document).data("hammer")||$(document).hammer(),$(document).on("tap",_.bind(function(e){this.$node.find(".element *").is(e.gesture.target)||this.deselect()},this)),$(document).on("keydown",_.bind(function(e){e.which===a5.utils.keyCodes.ESCAPE&&this.deselect()},this))},updateElementOrder:function(isSwap){this._super(isSwap),isSwap||_.each(this.elements,function(v,index){v.updateButtons()},this)},appendElement:function(model){var view=new a5.views.interaction.OSSequenceElementSwap(model,this,this.clickclick,this.$line,this.isHorizontal,this.gaptextaudio,this.dropIndicator);return this.$line.append(view.render()),this.elements.push(view),view},deselect:function(){this.selected&&(this.selected.deselect(),this.selected=void 0)},setSelected:function(element){this.selected&&this.selected.deselect(),this.selected=element,this.selected.select()},swap:function(data){var from=_.findWhere(this.elements,{model:data.from}),to=_.findWhere(this.elements,{model:data.to}),fromPlaceholder=$(this.DROP_PLACEHOLDER_TEMPLATE),toPlaceholder=$(this.DROP_PLACEHOLDER_TEMPLATE);from.$node.before(fromPlaceholder),to.$node.before(toPlaceholder),from.$node.removeClass("transition-in"),to.$node.removeClass("transition-in"),from.$node.addClass("transition-out"),to.$node.addClass("transition-out"),from.enabled=!1,to.enabled=!1,this._runDelayedTransition(from,to,fromPlaceholder,toPlaceholder)},_runDelayedTransition:function(from,to,fromPlaceholder,toPlaceholder){_.delay(function(){var $focused=$(":focus");from.$node.removeClass("transition-out"),to.$node.removeClass("transition-out"),from.$node.detach(),to.$node.detach(),toPlaceholder.after(from.$node),fromPlaceholder.after(to.$node),($focused.closest(from.$node).length||$focused.closest(to.$node).length)&&$focused.focus(),fromPlaceholder.remove(),toPlaceholder.remove(),from.trigger("swapped"),to.trigger("swapped"),from.$node.addClass("transition-in"),to.$node.addClass("transition-in"),from.enabled=!0,to.enabled=!0},a5.dp.config.ossequenceTransitionDelay)}},a5.views.interaction.OSSequenceView.extend("a5.views.interaction.OSSequenceViewSwap"),a5.views.interaction.OSSequenceElementSwap={SWAP_NEXT_TEMPLATE:"<div class='btn swap-next' tabindex='0'></div>",SWAP_PREV_TEMPLATE:"<div class='btn swap-prev' tabindex='0'></div>",_setDraggable:function(){},bindEvents:function(){this._super(),this.bind("swapped",this.updateButtons,this)},updateButtons:function(){this.$swap_next.removeClass("btn-disable"),this.$swap_prev.removeClass("btn-disable");var i=this.model.parent.elements.indexOf(this.model),next=this._getNextNonFixedElementIndex(i),prev=this._getPrevNonFixedElementIndex(i);i>next&&this.$swap_next.addClass("btn-disable"),i<prev&&this.$swap_prev.addClass("btn-disable")},render:function(){return this.$node=this._super(),this.$node.addClass("tap-to-swap"),this.$node.attr("data-id",this.model.identifier),this.$node.attr("tabindex",0),this.$node.find(".content").click(_.bind(this.setSelected,this)),this.$node.on("keydown",_.bind(this.onKeydown,this)),this.$node},tryAgain:function(){this._super(),this.$swap_next.remove(),this.$swap_prev.remove(),this.addButtons()},addButtons:function(){this.$swap_next=$(this.SWAP_NEXT_TEMPLATE),this.$swap_prev=$(this.SWAP_PREV_TEMPLATE),this.$swap_next.click(_.bind(this.swapNext,this)),this.$swap_next.on("keydown",_.bind(this.onKeydownNext,this)),this.$swap_prev.click(_.bind(this.swapPrev,this)),this.$swap_prev.on("keydown",_.bind(this.onKeydownPrev,this)),this.$node.append(this.$swap_next),this.$node.prepend(this.$swap_prev),this.updateButtons()},removeButtons:function(){this.$swap_next&&(this.$swap_next.remove(),this.$swap_next=null),this.$swap_prev&&(this.$swap_prev.remove(),this.$swap_prev=null)},onKeydown:function(e){if(this.enabled){var key=e.which;key===a5.utils.keyCodes.SPACE||key===a5.utils.keyCodes.ENTER?this.parent.selected===this?this.parent.deselect():this.parent.setSelected(this):key===a5.utils.keyCodes.DOWN||key===a5.utils.keyCodes.RIGHT?this.swapNext():key!==a5.utils.keyCodes.UP&&key!==a5.utils.keyCodes.LEFT||this.swapPrev()}},onKeydownNext:function(e){var key=e.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.swapNext()},onKeydownPrev:function(e){var key=e.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.swapPrev()},setSelected:function(){this.enabled&&this.parent.setSelected(this)},select:function(){this.$node.addClass("os-sequence-selected"),_.defer(_.bind(function(){this.$node.addClass("button-transition")},this))},deselect:function(){this.$node.removeClass("os-sequence-selected"),this.$node.removeClass("button-transition")},swapNext:function(){if(this.enabled){var i=this.model.parent.elements.indexOf(this.model),next=this._getNextNonFixedElementIndex(i);this.model.parent.swap(i,next)}},_getNextNonFixedElementIndex:function(curIndex){for(var len=this.model.parent.elements.length,i=curIndex+1;i%len!==curIndex;i+=1){if(!this.model.parent.elements[i%len].fixed)return i%len}},_getPrevNonFixedElementIndex:function(curIndex){for(var len=this.model.parent.elements.length,i=curIndex-1;i!==curIndex;i-=1){i<0&&(i=len-1);if(!this.model.parent.elements[i].fixed)return i}},swapPrev:function(){if(this.enabled){var i=this.model.parent.elements.indexOf(this.model),prev=this._getPrevNonFixedElementIndex(i);this.model.parent.swap(i,prev)}},enable:function(){this.enabled=!0,this.addButtons()},disable:function(){this.enabled=!1,this.removeButtons()}},a5.views.interaction.OSSequenceElement.extend("a5.views.interaction.OSSequenceElementSwap"),a5.views.interaction.OSBoxDropView={NODE_TEMPLATE:"<div class='os-boxdrop-wrapper'></div>",CONTROLS_TEMPLATE:"<div class='os-boxdrop-controls'></div>",BUTTON_TEMPLATE:"<button class='boxdrop-button'></button>",init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.crane=new a5.views.interaction.OSBoxDropCrane(this.model,this),this.contGroup=new a5.views.interaction.OSBoxDropContainerGroup(this.model,this),this.node.append(this.crane.render()),this.node.append(this.contGroup.render())}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSBoxDropView"),a5.views.interaction.OSBoxDropCrane={NODE_TEMPLATE:"<div class='crane-wrapper'><ol class='crane-items'></ol></div>",init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.parent=parent,this.choices=_.map(model.choices,function(choice){var choice_view=new a5.views.interaction.OSBoxDropChoice(choice,this);return this.appendChoice(choice_view),choice_view},this)},appendChoice:function(choice){this.node.find(".crane-items").append(choice.render())}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSBoxDropCrane"),a5.views.interaction.OSBoxDropChoice={NODE_TEMPLATE:"<li class='boxdrop-item'></div>",ANIMATION_EVENT:"animationstart MSAnimationStart webkitAnimationStart",init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE));var content=$($.parseHTML(model.contents));content.is("object[type='audio/audio']")?this.renderAudioPlayer(content):content.is("img")?(this.node.addClass("has-img"),a5.utils.buildModel(a5.mainBuilder.curInteraction,this.node,content,!0)):this.node.html(model.contents),this.parent=parent,this.interaction=this.model.interaction,this.model.bind("dropped",_.bind(this.dropHandler,this)),this.bottom=0},renderAudioPlayer:function(audionode){a5.service.media.audio.bind("ready",_.bind(function(){this.audio=a5.service.media.audio.create($(audionode).attr("data"),{preload:!a5.dp.config.audioPreloadDisabled}),a5.dp.config.audioPreloadDisabled&&this.interaction.preloadAudio(this.audio),this.tinyplayer=new a5.views.TinyPlayer,this.node.addClass("has-audio"),this.node.append(this.tinyplayer.render()),this.tinyplayer.bind("play",_.bind(function(){this.audio.play()},this)),this.tinyplayer.bind("pause",_.bind(function(){this.audio.pause()},this)),this.audio.bind("stopped",_.bind(function(){this.tinyplayer.pause()},this))},this))},checkLocked:function(node){this.model.tryAgainIsFrozen&&((node||this.node).filter(".checked-correct, .solution-correct").addClass("checked-correct-locked"),(node||this.node).filter(":not(.checked-correct, .solution-correct)").removeClass("checked-correct-locked"))},updateFeedbackState:function(nodes){this.checkLocked(nodes),nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct");var type;type="answers"==this.model.state?"solution":"checked",this.model.isCorrect()?nodes.addClass([type,"correct"].join("-")):this.model.isFilled()?nodes.addClass([type,"incorrect"].join("-")):nodes.addClass([type,"empty"].join("-"))},showAnswer:function(stack_after){this.node.addClass("dropped"),this.bottom=0,this.stackAfter(stack_after?stack_after.model:void 0),this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect()})},tryAgain:function(stack_after){this.bottom=0,this.updateFeedbackState(this.node),this.model.current_target?(this.node.addClass("dropped"),this.stackAfter(stack_after?stack_after.model:void 0)):(this.node.find(".check").remove(),this.node.removeAttr("style"),this.node.removeClass("dropped"),this.parent.appendChoice(this))},stackAfter:function(after){if(!after)return this.node.css("bottom",0);var view=_.find(this.parent.choices,function(choice){return choice.model.id==after.id});return this.bottom=view.node.outerHeight(!0)+view.bottom,this.node.css("bottom",this.bottom)},dropHandler:function(target){this.clone=this.node.clone(),this.clone.insertBefore(this.node),this.getCategoryView(target).appendChoice(this.node),this.node.on(this.ANIMATION_EVENT,_.bind(this.dropTransition,this));this.clone.on("transitionend webkitTransitionEnd",_.bind(function(e){this.clone.remove()},this))},dropTransition:function(e){this.clone.addClass("dropped"),this.node.addClass("dropped");var choices=_.reject(this.model.current_target.choices,_.bind(function(choice){return choice.id==this.model.id},this));this.stackAfter(_.last(choices)),this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect()}),this.node.off(this.ANIMATION_EVENT),a5.eventBus.trigger("os-boxdrop:item:dropped",this.node)},getCategoryView:function(target){var base_view=this.parent.parent;return _.find(base_view.contGroup.containers,function(view){return view.model.id==target.id})}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSBoxDropChoice"),a5.views.interaction.OSBoxDropContainerGroup={NODE_TEMPLATE:"<div class='boxdrop-container-group'></div>",init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.containers=_.map(model.targets,function(target){var target_view=new a5.views.interaction.OSBoxDropContainer(target,this);return this.node.append(target_view.render()),target_view},this),this.model.bind("change:category",_.bind(function(index){this._updatePosition(model.targets.length-1-index)},this))},_updatePosition:function(position){this.node.removeClass(function(index,className){return(className.match(/(^|\s)position-\d+/g)||[]).join(" ")}),this.node.addClass("position-"+position)}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSBoxDropContainerGroup"),a5.views.interaction.OSBoxDropContainer={NODE_TEMPLATE:"<div class='boxdrop-container'><ol class='dropped-items'></ol><h1 class='boxdrop-label'></h1></div>",init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.node.find(".boxdrop-label").html(model.contents),model.parent.bind("change:category",_.bind(function(index){this.model=model,this.node.toggleClass("current",this.model.index==index)},this)),this.model.parent.bind("state_update:answers",_.bind(this.showAnswer,this)),this.model.parent.bind("state_update:input",_.bind(this.tryAgain,this))},appendChoice:function(choice){this.node.find(".dropped-items").append(choice)},showAnswer:function(){_.each(this.model.correctChoices,function(choice,index){var current_view=this.getChoiceView(choice),prev_view=this.getChoiceView(this.model.correctChoices[index-1]);this.appendChoice(current_view.node),current_view.showAnswer(prev_view)},this)},tryAgain:function(){this.node.find(".dropped-items .boxdrop-item").detach(),_.each(this.model.choices,function(choice,index){var current_view=this.getChoiceView(choice),prev_view=this.getChoiceView(this.model.choices[index-1]);this.appendChoice(current_view.node),current_view.tryAgain(prev_view)},this),_.each(this.model.parent.choices,function(choice){this.getChoiceView(choice).tryAgain()},this)},getChoiceView:function(needle){if(needle)return _.find(this.parent.parent.crane.choices,function(choice){return choice.model.id==needle.id})}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSBoxDropContainer"),a5.view.interaction.ICCrossword={DEFAULT_TEMPLATE:'<div class="crossword_view"><div class="grid"></div></div>',init:function(model,parent,uppercase,cluePosition){this._super(model,parent,$(this.DEFAULT_TEMPLATE)),this.uppercase=uppercase,this.cluePosition=cluePosition,this.interaction=this.model.parent,this.cell_views=[],this.clue_cells=[],_.each(this.model.cells,function(cell){var view=new a5.view.interaction.ICCrosswordCell(cell,this);this.cell_views.push(view)},this),"inside"===this.cluePosition&&_.each(this.model.words,function(word){var view=new a5.view.interaction.ICCrosswordWordClue(word,this);this.clue_cells.push(view)},this),a5.hooks.interactionFontUpdated.add(function(){this.interaction.runOutOfFlow(this.adjustSize.bind(this))}.bind(this))},render:function(){if(this.$grid=this.node.find(".grid"),_.each(this.cell_views,function(view){this.$grid.append(view.node),view.render()},this),"outside"===this.cluePosition){this.node.addClass("clues-outside");var clues=new a5.view.interaction.ICCrosswordClues(this.model,this);this.node.append(clues.node),clues.render()}else this.node.addClass("clues-inside"),_.each(this.clue_cells,function(view){this.$grid.append(view.node),view.render()},this);return this.adjustSize(),this.node},adjustSize:function(){var width=0,height=0;"inside"===this.cluePosition&&_.each(this.clue_cells,function(view){view.adjustPosition()},this),_.each(this.cell_views,function(view){view.adjustPosition(),width=Math.max(width,view.left),height=Math.max(height,view.top)},this);var cellWidth=a5.utils.getCrosswordCellWidth();width+=cellWidth.width+("px"===cellWidth.unit?2:0),height+=cellWidth.width+("px"===cellWidth.unit?2:0),this.$grid.width(width+cellWidth.unit).height(height+cellWidth.unit)}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICCrossword"),a5.view.interaction.ICCrosswordClues={template:"a5.view.ic_crosswords",DEFAULT_TEMPLATE:'<div class="clues"><div class="clue-list-hor"><h2>Across</h2></div><div class="clue-list-ver"><h2>Down</h2></div></div>',init:function(model,parent){this._super(model,parent,$('<div class="clue-list"></div>'))},render:function(){var html=a5.service.templates.render(this.template,{},this.DEFAULT_TEMPLATE),$html=$(html),$horizontalClues=$html.find(".clue-list-hor"),$verticalClues=$html.find(".clue-list-ver"),horizontalWords=_.filter(this.model.words,function(word){return"horizontal"===word.align}),verticalWords=_.filter(this.model.words,function(word){return"vertical"===word.align});return _.each(horizontalWords,function(word){var view=new a5.view.interaction.ICCrosswordClue(word,this);$horizontalClues.append(view.node),view.render()},this),_.each(verticalWords,function(word){var view=new a5.view.interaction.ICCrosswordClue(word,this);$verticalClues.append(view.node),view.render()},this),this.node.append($html),this.node.toggleClass("clues-in-columns",this.model.cluesInColumns),this.node}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICCrosswordClues"),a5.view.interaction.ICCrosswordClue={DEFAULT_TEMPLATE:'<div><div class="clue-enum"></div><div class="clue-content"></div></div>',init:function(model,parent){this._super(model,parent,$(this.DEFAULT_TEMPLATE)),this.crossword=this.parent.parent,_.bindAll(this,"_onMouseOver","_onMouseOut"),this.node.on("mouseover",this._onMouseOver),this.node.on("mouseout",this._onMouseOut)},render:function(){return this.node.find(".clue-enum").append(this.model.label),this.node.find(".clue-content").append(this.model.content.contents()),this.node},_onMouseOver:function(e){this.crossword.$('.cell[data-label ~= "'+this.model.tag+'"]').addClass("highlighted")},_onMouseOut:function(e){this.crossword.$('.cell[data-label ~= "'+this.model.tag+'"]').removeClass("highlighted")}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICCrosswordClue"),a5.view.interaction.ICCrosswordWordClue={DEFAULT_TEMPLATE:'<div class="cell chint"></div>',init:function(model,parent){this._super(model,parent,$(this.DEFAULT_TEMPLATE)),this.interaction=this.model.parent.parent,this.crossword=this.parent,_.bindAll(this,"_onMouseOver","_onMouseOut"),this.node.on("mouseover",this._onMouseOver),this.node.on("mouseout",this._onMouseOut),this.tooltip=$('<div class="clue"></div>'),this.interaction.bind("show:defered rendered:defered",function(){var size=this.tooltip.naturalSize({},{width:200});this.tooltip.css({width:size[0]})},this)},render:function(){return this.node.addClass("hint-"+this.model.align.substring(0,3)),this.node.append(this.tooltip),this.tooltip.append(this.model.content.contents()),this.adjustPosition(),this.node},adjustPosition:function(){var cellWidth=a5.utils.getCrosswordCellWidth(),borderOffset="px"===cellWidth.unit?1:0;this.node.css("width",_.values(cellWidth).join("")),this.node.css("height",_.values(cellWidth).join("")),this.node.css({left:(this.model.x+(this.model.isVertical()?1:0))*(cellWidth.width+borderOffset)+cellWidth.unit,top:(this.model.y+(this.model.isHorizontal()?1:0))*(cellWidth.width+borderOffset)+cellWidth.unit})},_onMouseOver:function(e){this.crossword.$('.cell[data-label ~= "'+this.model.tag+'"]').addClass("highlighted")},_onMouseOut:function(e){this.crossword.$('.cell[data-label ~= "'+this.model.tag+'"]').removeClass("highlighted")}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICCrosswordWordClue"),a5.view.interaction.ICCrosswordCell={template:"a5.view.interaction.ICCrosswordCell",init:function(model,parent){this._super(model,parent,$("<div>",{class:"cell","data-label":model.tags.join(" ")})),_.bindAll(this,"_onInputSpecialCharInserted","_onInputChanged","_onInputKeyPressed","_onInputKeyDown","_onInputKeyUp","_onInputClick"),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.setInput,this),this.model.bind("next_answer",this.showNextAnswer,this)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.node.html($(html).html()),this.node.toggleClass("prefilled",this.model.isPrefilled()),this.input=this.node.find("input"),this.setInput(),this.adjustPosition(),this.includeClasses(),this.node},adjustPosition:function(){var cellWidth=a5.utils.getCrosswordCellWidth(),borderOffset="px"===cellWidth.unit?1:0;this.node.css("width",_.values(cellWidth).join("")),this.node.css("height",_.values(cellWidth).join("")),this.left=(this.model.x+("inside"===this.parent.cluePosition?1:0))*(cellWidth.width+borderOffset),this.top=(this.model.y+("inside"===this.parent.cluePosition?1:0))*(cellWidth.width+borderOffset),this.node.css({left:this.left+cellWidth.unit,top:this.top+cellWidth.unit})},serializeData:function(){var word1=this.model.allWords[0],word2=this.model.allWords[1];word1&&(word1={cell:word1.cells.indexOf(this.model)+1,index:word1.label,isVertical:word1.isVertical()}),word2&&(word2={cell:word2.cells.indexOf(this.model)+1,index:word2.label,isVertical:word2.isVertical()});var data={word1:word1,word2:word2,tabIndex:this._tabIndexForTags(this.model.tags)};return this.model.label&&"outside"===this.parent.cluePosition&&(data.enumLabel=this.model.label),data},includeClasses:function(){var listOfClasses=_.chain(this.model.allWords).map(function(word){
var list=[],sufix=word.isHorizontal()?"Horizontal":"Vertical",prefix="crossword__cell--";return word.getFirstCell()===this.model?list.push(prefix+"first"+sufix):word.getLastCell()===this.model?list.push(prefix+"last"+sufix):list.push(prefix+"middle"+sufix),list},this).flatten().value();this.node.toggleClass(listOfClasses.join(" "),!0)},setInput:function(){this.input.attr("disabled",!0),this.input.unbind(),this.node.find(".check").remove(),this.checkLocked(),this.model.isPrefilled()?this.updateValue(this.model.letter):this.updateValue(this.model.value),this.model.isEditable()&&this.bindEvents(),this._wordStateChange()},checkLocked:function(){this._super(),this.model.updateFreeze()},setAnswer:function(){this.input.attr("disabled",!0),this.input.unbind(),this.node.find(".check").remove(),_.each(this.model.words,_.bind(function(word){word.prefilled||this.addCheck({correct:word.isCorrect(),classes:[word.align],tooltip:word.getAnswerFeedback(),correctTooltip:!0})},this)),this._wordStateChange()},showAnswer:function(){this.input.attr("disabled",!0),this.input.unbind(),this.node.find(".check").remove(),_.each(this.model.words,function(word){word.isCorrect()||word.prefilled?word.isCorrect()&&!word.prefilled&&this.addCheck({correct:word.isCorrect(),classes:[word.align],tooltip:word.getAnswerFeedback(),correctTooltip:!0}):this.addCheck({empty:!word.isFilled(),classes:[word.align],tooltip:this.parent.uppercase?word.getUserWord().toUpperCase():word.getUserWord()})},this),this.updateValue(this.model.letter),this._wordStateChange()},showNextAnswer:function(word){this.input.attr("disabled",!0),this.input.unbind(),_.contains(this.model.words,word)&&this.addCheck({correct:!1,empty:!0,classes:[word.align],tooltip:word.getAnswerFeedback(),correctTooltip:!0}),this.updateValue(this.model.letter),this._wordStateChange(),_.first(word.cells)===this.model&&a5.utils.scrollIntoElementIfNeeded(this.node)},_tabIndexForTags:function(tags){var downTag=_.find(tags,{0:"d"});return downTag?parseInt(downTag.slice(1),10):1},_onInputSpecialCharInserted:function(e){this.goToNextField(1)},_onInputChanged:function(e){this.model.setValue($(e.target).val())},_onInputKeyPressed:function(e){e.preventDefault();var code=e.which;(45===code||code>=48&&code<=57||code>=65&&code<=90||code>=97&&code<=122||code>=128&&code<=1273)&&(this.model.setValue(String.fromCharCode(code)),this.goToNextField(1))},_onInputKeyDown:function(e){9===e.keyCode&&this.goToNextField(e.shiftKey?-1:1)&&e.preventDefault()},_onInputKeyUp:function(e){e.preventDefault();var code=e.keyCode,backSpace=8==code,arrKeys=code>=37&&code<=40;if(backSpace&&this.model.setValue(""),229==code&&(1==this.input.val().length?this.model.setValue(this.input.val()):this.model.setValue(_.last(this.input.val())),this.goToNextField(1)),arrKeys){var xpos=this.model.x,ypos=this.model.y;do{xpos+=[0,-1,0,1][e.keyCode%4],ypos+=[1,0,-1,0][e.keyCode%4];var targetCell=this.model.parent.getCellAt(xpos,ypos);if(targetCell&&!$("div[data-model-id="+targetCell.id+"] input").is(":disabled")){targetCell.focus();break}}while(xpos>=0&&xpos<=this.model.parent.size[0]&&ypos>=0&&ypos<=this.model.parent.size[1]);this.parent.oldDirection=["vertical","horizontal"][e.keyCode%2]}else backSpace&&this.goToNextField(-1)},_onInputClick:function(e){this.parent.oldDirection=null},bindEvents:function(){this.input.attr("disabled",!1),this.input.on("specialchar:inserted",this._onInputSpecialCharInserted),this.input.on("change",this._onInputChanged),this.input.on("keypress",this._onInputKeyPressed),this.input.on("keydown",this._onInputKeyDown),this.input.on("keyup",this._onInputKeyUp),this.input.on("click",this._onInputClick)},_wordStateChange:function(){this.node.removeClass("checked-incorrect checked-correct checked-empty"),this.node.removeClass("solution-incorrect solution-correct solution-empty solution-revealed");var mode="";if("feedback"===this.model.state)mode="checked";else{if("answers"!==this.model.state)return;mode="solution"}if(this.model.isRevealedBySeeNext())return void this.node.addClass("solution-revealed");this.model.isEmpty()?this.node.addClass(mode+"-empty"):this.model.isPrefilled()||_.each(this.model.allWords,function(word){var state=word.isCorrect()?"correct":"incorrect";this.node.addClass(mode+"-"+state)},this)},goToNextField:function(pos){function getCell(model,x,y){var cell=model.parent.getCellAt(model.x+x,model.y+y);return cell&&!cell.isEditable()&&(cell=model.parent.getCellAt(model.x+2*x,model.y+2*y)),cell}var direction=this.parent.oldDirection,cellRight=getCell(this.model,pos,0),cellBottom=getCell(this.model,0,pos);getCell(this.model,-pos,0),getCell(this.model,0,-pos);direction||(direction=!cellRight&&cellBottom?"vertical":"horizontal");var found=!1;return"horizontal"===direction&&cellRight?(cellRight.focus(),found=!0):"vertical"===direction&&cellBottom?(cellBottom.focus(),found=!0):(direction=this._focusNextWordCell(this.model,direction,pos),direction?found=!0:direction="horizontal"),this.parent.oldDirection=direction,found},_getNextCell:function(direction,words,currentTag,pos){var orderedWords=_.sortBy(words,function(word){return[word.tag[0],parseInt(word.label,10)]}),currentWord=_.findWhere(orderedWords,{tag:currentTag}),nextIndex=_.indexOf(orderedWords,currentWord)+1,nextWord=orderedWords[nextIndex],cell=nextWord&&nextWord.cells[pos>0?0:nextWord.cells.length-1];return direction=nextWord&&nextWord.align,[cell,direction]},_focusNextWordCell:function(model,direction,pos){var tag=_(model.tags).find(function(tag){return a5.utils.startsWith(tag,"vertical"===direction?"d":"a")})||model.tags[0],editableWords=model.parent.filterWords({isEditable:!0}),cellAndDirection=this._getNextCell("a"===tag[0]?"horizontal":"vertical",editableWords,tag,pos),cell=cellAndDirection[0];return direction=cellAndDirection[1],cell&&cell.focus(),direction},focus:function(){this.input.focus()},updateValue:function(letter){letter=this.parent.uppercase&&1===letter.toUpperCase().length?letter.toUpperCase():letter,this.input.val(letter),letter.length>0?this.input.addClass("input-filled"):this.input.removeClass("input-filled")}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICCrosswordCell"),a5.views.interaction.ISRadiobuttonView={template:"a5.view.interaction.ISRadioButton",init:function(model,prefill,hideRadios,showInColumns,label){this.showInColumns=showInColumns,this._super(model,prefill,hideRadios),showInColumns&&(this.label=new a5.views.interaction.ISRadiobuttonLabel(label)),this.model.bind("state_update:feedback",this.setAnswer,this)},createViewFor:function(model){return new a5.views.interaction.ISRadiobuttonChoiceView(model,this.showInColumns,this)},setAnswer:function(){this.bindAnswerFeedback(this.model.selected||this.model.correct)},render:function(){return this._super(),this.showInColumns&&(_.first(this.children).node.before(this.label.$node),this.label.render(),this.node.addClass("radiobutton-show-in-columns")),this.node}},a5.views.Radiobutton.extend("a5.views.interaction.ISRadiobuttonView"),a5.views.interaction.ISRadiobuttonChoiceView={contentTemplate:"a5.view.interaction.ISRadioButtonChoice",template:"a5.view.interaction.ISRadioButtonChoiceWrapper",init:function(model,showInColumns,parent){this.showInColumns=showInColumns,this._super(model,parent),this.parent=parent,showInColumns||this.contentNode.find(".is-radiobutton-choice-text").append(model.content.contents()),model.enumeration&&(this.contentNode.prepend('<span class="enum-placeholder"></span>'),model.enumeration.then(function(enumSymbol){this.contentNode.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),model.hasRadiobutton?this.addInput():this.node.addClass("input-noradio"),this.model.parent.prefilled&&(this.disable(),this.model.isCorrectAnswer()&&this.select(!0)),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.tryAgain,this),this.model.bind("clear",this.onClear,this),this.model.parent.bind("input_update:setAnswer",this.setAnswerInput,this),this.model.parent.bind("change",this.onChange,this),this.model.parent.bind("state_update",this.onStateUpdate,this),this.updateSelected()},render:function(){return this._super(),this.showInColumns&&this.node.wrapInner("<div class='input-wrapper'></div>"),this.node},select:function(silent){this._super(),this.node.addClass("input-radio-checked"),silent||this.model.select(),this.input?this.input.attr("checked",!0):this.model.isSelectedAnswer()&&this.node.addClass("clickedanswer")},unselect:function(silent){this._super(),this.input&&this.input.attr("checked",!1),this.node.removeClass("clickedanswer"),this.node.removeClass("input-radio-checked"),silent||this.model.unselect()},disable:function(){this._super(),this.input&&this.input.attr("disabled",!0)},enable:function(){this._super(),this.input&&this.input.attr("disabled",!1)},onChange:function(){this.updateSelected()},onStateUpdate:function(){this.updateFeedbackState(),this.updateSelected()},onClear:function(){this.removeCheck(!this.parent.autoOpenFeedback),this.clearFeedbackState()},onMouseOver:function(e){this._super(),this.node.addClass("input-radio-hover"),this.input||this.node.addClass("input-noradio-hover")},onMouseOut:function(e){this._super(),this.node.removeClass("input-radio-hover"),this.node.removeClass("input-noradio-hover")},addCheck:function(options){var node=this.node;this.node.find(".input-wrapper").length&&(this.node=this.node.find(".input-wrapper"));var check=this._super(options);if(this.node=node,options.autoOpen){var interaction=this.getInteractionObject(this.node)||a5.mainBuilder.curInteraction;_.defer(function(inter){inter.isVisibleAndLoaded()&&check.click()},interaction)}},setAnswer:function(){var setCheck=!this.model.parent.prefilled;this.setAnswerCheck(setCheck)},setAnswerInput:function(){this.removeCheck(!this.parent.autoOpenFeedback);var setCheck=!this.model.parent.prefilled&&this.model.parent.isFilled();this.setAnswerCheck(setCheck)},setAnswerCheck:function(check){if(check){this.removeCheck(!this.parent.autoOpenFeedback);var tooltip=this._getFeedbackForTooltip();this.node.toggleClass("has-feedback",!!tooltip),this.parent.node.addClass("active"),this.model.isRevealedBySeeNext()?this.addCheck({correct:!1,tooltip:tooltip,autoOpen:!1}):this.model.isSelectedAnswer()&&this.addCheck({correct:this.model.parent.isSelectionCorrect(),tooltip:tooltip,correctTooltip:!0,autoOpen:this.parent.isFirstInteractive&&this.parent.autoOpenFeedback})}},showAnswer:function(){if(!this.model.parent.prefilled){var tooltip=this._getFeedbackForTooltip();this.node.toggleClass("has-feedback",!!tooltip),this.parent.node.addClass("active"),this.removeCheck(!this.parent.autoOpenFeedback),this.model.isRevealedBySeeNext()?"input"===this.model.parent.state?this.addCheck({empty:!0,tooltip:tooltip,state:"answers",autoOpen:this.parent.isFirstInteractive&&this.parent.autoOpenFeedback}):this.addCheck({correct:!1,tooltip:tooltip,state:"answers",autoOpen:!1}):this.model.parent.isSelectionCorrect()?this.model==this.model.parent.selected&&this.addCheck({correct:!0,tooltip:tooltip,correctTooltip:!0,state:"answers",autoOpen:this.parent.isFirstInteractive&&this.parent.autoOpenFeedback}):this.model.isCorrectAnswer()?this.addCheck({empty:!0,tooltip:tooltip,state:"answers",autoOpen:this.parent.isFirstInteractive&&this.parent.autoOpenFeedback}):this.model.isSelectedAnswer()&&this.addCheck({correct:!1,tooltip:tooltip,state:"answers",autoOpen:!1})}},tryAgain:function(){this.parent.node.removeClass("active"),this.node.removeClass("has-feedback"),this.removeCheck(!0)},isLocked:function(node){return(node||this.node).siblings().andSelf().filter(".checked-correct-locked").length>0},updateSelected:function(){if(!this.model.parent.prefilled)return this.model.parent.isRevealedBySeeNext()?(this.disable(),void(this.model.isRevealed()?this.select(!0):this.unselect(!0))):(this.model.isSelectedAnswer()?this.select(!0):this.unselect(!0),this.disable(),"input"===this.model.parent.state&&"answers"!==this.model.state&&(this.model.tryAgainIsFrozen&&this.isLocked()||this.enable()),"answers"!==this.model.parent.state&&"answers"!==this.model.state||this.model.isCorrectAnswer()&&this.select(!0),this)},clearFeedbackState:function(){this.node.removeClass("checked-empty checked-incorrect checked-correct"),this.node.removeClass("solution-empty solution-incorrect solution-correct solution-revealed")},updateFeedbackState:function(){this.checkLocked(),this.clearFeedbackState();var type;if("feedback"==this.model.parent.state)type="checked";else{if("answers"!=this.model.parent.state)return;type="solution"}if(this.model.isRevealedBySeeNext())return void this.node.addClass("solution-revealed");this.model.parent.isRevealedBySeeNext()||(this.model.parent.isCorrect()?this.model.isSelectedAnswer()&&this.node.addClass([type,"correct"].join("-")):!this.model.correct&&this.model.isSelectedAnswer()?this.node.addClass([type,"incorrect"].join("-")):this.model.isSelectedAnswer()||("checked"===type?this.node.addClass("checked-empty"):"solution"===type&&this.model.correct&&this.node.addClass("solution-empty")))},_getFeedbackForTooltip:function(){return this.model.answerFeedback||this.model.parent.getAnswerFeedback()}},a5.views.RadiobuttonChoiceView.extend("a5.views.interaction.ISRadiobuttonChoiceView"),a5.views.interaction.ISRadiobuttonViewDefault={init:function(model,$radio,isFirstInteractive,isFirst,autoOpenSF,hideRadios,showInColumns,label,interaction){this.$radio=$radio,this.model=model,this.isFirst=isFirst,this.hideRadios=hideRadios,this.showInColumns=showInColumns,this.label=label,this.isFirstInteractive=isFirstInteractive,this.autoOpenFeedback=autoOpenSF,this._addModelEvents(),this._addInteractionEvents(interaction)},_addInteractionEvents:function(interaction){interaction.bind("attemptsChanged",_.bind(this._onAttemptsChanged,this)),interaction.bind("restored",_.bind(this._onInteractionRestored,this))},_onAttemptsChanged:function(attempts){this.model.attempts=attempts.checkAttempts},_onInteractionRestored:function(interaction){this.model.attempts>0&&this._onDisplayAnswer()},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.$radio,{behavior:"smooth",block:"start"})},_addModelEvents:function(){this.model.bind("state_update:feedback",_.bind(this._onDisplayAnswer,this)),this.model.bind("state_update:answers",_.bind(this._onDisplayAnswer,this)),this.model.bind("state_update:input",_.bind(this._onDisplayAnswer,this)),this.model.bind("next_answer",this.onNextAnswer,this)},_onDisplayAnswer:function(){this.$contentblock.removeClass("contentblock--hidden")},addSiblingsListeners:function(){var prevModel=this.isFirst?null:this.model.blockItems[this.model.questionIndex-1],nextModel=this.model.questionIndex<this.model.blockItems.length-1?this.model.blockItems[this.model.questionIndex+1]:null;prevModel&&prevModel.blockId<this.model.blockId&&prevModel.bind("change next_answer",_.bind(this.onPreviousModelChanged,this)),this.model.isDisplayShowNextHidePrev()&&nextModel&&nextModel.blockId>this.model.blockId&&this.model.bind("change next_answer",_.bind(this.onModelChanged,this))},_displayShowHideBehavior:function(){return(this.model.isDisplayShowNext()||this.model.isDisplayShowNextHidePrev())&&0===this.model.attempts},onPreviousModelChanged:function(){this._displayShowHideBehavior()&&!this.$contentblock.is(":visible")&&(this.$contentblock.removeClass("contentblock--hidden"),a5.utils.scrollIntoElementIfNeeded(this.$radio,{behavior:"smooth"}))},onModelChanged:function(){this._displayShowHideBehavior()&&this.$contentblock.addClass("contentblock--hidden")},render:function(){return this.$contentblock=this.$radio.is(".contentblock")?this.$radio:this.$radio.parents(".contentblock"),this.$question=this.$contentblock.find("p").first(),this.$wrapperQuestion=this.$question.parent(),this._createRadiobuttonView(),this.setActiveRadio(),this.bindEvents(),this.radioView.render()},bindEvents:function(){},setActiveRadio:function(){this.isFirst&&this.$question.addClass("active");var displayNode=this.isFirst||!this.model.isDisplayShowNext()&&!this.model.isDisplayShowNextHidePrev();this.$contentblock.toggleClass("contentblock--hidden",!displayNode)},showFirstAnswerFeedback:function(){this.isFirst&&this.radioView.showAnswerFeedback&&this.radioView.showAnswerFeedback()},_createRadiobuttonView:function(){this.radioView=new a5.views.interaction.ISRadiobuttonView(this.model,this.model.prefilled,this.hideRadios,this.showInColumns,this.label),this.radioView.isFirstInteractive=this.isFirstInteractive,this.radioView.autoOpenFeedback=this.autoOpenFeedback}},Obj.extend("a5.views.interaction.ISRadiobuttonViewDefault"),a5.views.interaction.ISRadiobuttonViewDisplayAll={bindEvents:function(){this.$contentblock.on("click",_.bind(this._onClick,this))},_onClick:function(){this.$contentblock.siblings().children(".active").removeClass("active"),this.$question.addClass("active")}},a5.views.interaction.ISRadiobuttonViewDefault.extend("a5.views.interaction.ISRadiobuttonViewDisplayAll"),a5.views.interaction.ISRadiobuttonViewDisplayActive={render:function(){var node=this._super();return this.$question.addClass("expandable-question"),this.$question.addClass("expandableQuestion__title"),this.$wrapperQuestion.addClass("has-expandable-question"),this.$wrapperQuestion.addClass("expandableQuestion"),this.$question.prepend(this.$question.siblings("span.enum")),node},setActiveRadio:function(){this._super(),this.isFirst&&this.$wrapperQuestion.addClass("expandableQuestion--active")},bindEvents:function(){this.$contentblock.on("click",".expandable-question",_.bind(this._onClickQuestion,this)),this.$contentblock.on("expandable-hide",_.bind(this._onCollapse,this))},showFirstAnswerFeedback:function(){this.isFirst&&this.radioView.showAnswerFeedback&&(this.$contentblock.hasClass("active")||this._show(),this.radioView.showAnswerFeedback())},setAnswer:function(){this.radioView.setAnswer();var $check=this.$radio.find(".check:first").clone();$check.off("click").on("click",_.bind(function(){this.$contentblock.hasClass("active")||this._show(),this.radioView.showAnswerFeedback()},this)),this.$contentblock.append($check)},setInput:function(){this.$contentblock.find(".check").remove()},_onClickQuestion:function(e){this.$question.hasClass("active")?this._hide():this._show()},_onCollapse:function(){this._hide()},_hide:function(){this.$question.removeClass("active"),this.$contentblock.find(".view-text-active").removeClass("view-text-active"),this.$contentblock.find(".view-text").hide(),this.$wrapperQuestion.removeClass("expandableQuestion--active")},_show:function(){this._hideSiblings(),this.$question.addClass("active"),this.$wrapperQuestion.addClass("expandableQuestion--active")},_hideSiblings:function(){this.$contentblock.siblings(":has(.active)").trigger("expandable-hide")}},a5.views.interaction.ISRadiobuttonViewDefault.extend("a5.views.interaction.ISRadiobuttonViewDisplayActive"),a5.views.interaction.ISRadiobuttonLabel={init:function(label){this.$node=$("<div class='radiobutton-column-label'></div>").append(label)},render:function(){return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRadiobuttonLabel"),a5.views.interaction.ISRadiobuttonHeader={init:function(answers){this.$node=$("<div class='radiobutton-column-header'><div class='header-spacer'></div></div>"),this.answers=answers},render:function(){for(var i=0;i<this.answers.length;i++){var $answerCell=$("<div class='answer-cell'></div>").append(this.answers[i]);this.$node.append($answerCell)}return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRadiobuttonHeader"),a5.views.interaction.ISRadiobuttonColumnsLabel={init:function(label){this.$node=$("<div class='radiobutton-column-header'><div class='header-spacer'></div><div class='label-placeholder'></div></div>"),label.then(function(label){this.$node.find(".label-placeholder").replaceWith(label)}.bind(this))},render:function(){return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRadiobuttonColumnsLabel"),a5.views.interaction.ISRadiobuttonColumnsHeader={init:function(answers){this.$node=$("<div class='radiobutton-column-label'><div class='answer-label'>&nbsp;</div></div>"),this.answers=answers},render:function(){for(var i=0;i<this.answers.length;i++)this.$node.append("<div class='answer-cell'>"+this.answers[i]+"</div>");return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRadiobuttonColumnsHeader"),a5.views.interaction.ISRadiobuttonColumnsView={template:"a5.view.interaction.ISRadioButtonColumns",init:function(model,prefill,hideRadios,label,enumeration){this._super(model,prefill,hideRadios),this.enumeration=enumeration,this.children.unshift(new a5.views.interaction.ISRadiobuttonColumnsLabel(label)),a5.callbacks.interaction.bind("showed",this.adjustSize,this),this.bindEvents()},render:function(){return this._super(),this.enumeration&&this.enumeration.then(function(enumSymbol){this.node.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}.bind(this)),this.node},bindEvents:function(){this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:input",this.setInput,this),this.node.on("click focus",_.bind(this._onClick,this))},adjustSize:function(){var labels=this.node.siblings(".radiobutton-column-label").find(".answer-cell"),cells=this.node.find(".input-radio");_.each(cells,function(cell,index){$(cell).height($(labels[index]).height())})},createViewFor:function(model){return new a5.views.interaction.ISRadiobuttonColumnsChoiceView(model,this)},setInput:function(){this.node.find(".check").remove()},setAnswer:function(){this.model.selected||this.model.prefilled||this.addCheck({correct:!1}),this.bindAnswerFeedback(this.model.selected||this.model.correct)},_onClick:function(e){$(".clicked-question").removeClass("clicked-question"),this.node.addClass("clicked-question")}},a5.views.Selectable.extend("a5.views.interaction.ISRadiobuttonColumnsView"),a5.views.interaction.ISRadiobuttonColumnsChoiceView={contentTemplate:"a5.view.interaction.ISRadioButtonColumnsChoice",template:"a5.view.interaction.ISRadioButtonColumnsChoiceWrapper",init:function(model,parent){this._super(model,parent),this.parent=parent,model.hasRadiobutton?(this.addInput(),this.model.parent.prefilled&&(this.input.attr("disabled",!0),this.model.isCorrectAnswer()&&(this.input.attr("checked",!0),this.node.attr("aria-checked",!0)))):(this.node.addClass("input-noradio"),this.model.parent.prefilled&&this.model.isCorrectAnswer()&&this.node.addClass("clickedanswer")),model.radiobuttonIsCustom&&this.node.addClass("input-radio-custom"),this.model.parent.bind("state_update:feedback",this.setAnswer,this),this.model.parent.bind("state_update:answers",this.showAnswer,this),this.model.parent.bind("state_update:input",this.tryAgain,this),this.model.parent.bind("change",this.onChange,this),this.model.parent.bind("state_update",this.onStateUpdate,this),this.updateSelected()},render:function(){return this._super(),this.node.wrapInner("<div class='input-wrapper'></div>"),this.node},onChange:function(){this.updateSelected()},onStateUpdate:function(){this.updateSelected(),this.updateFeedbackState()},addFeedbackCheck:function(){this.addCheck({correct:this.model.parent.isCorrect(),tooltip:this.model.parent.getAnswerFeedback(),correctTooltip:!0})},setAnswer:function(){this.model.parent.prefilled||(this.parent.node.addClass("active"),this.model.isCorrectAnswer()&&this.model.parent.isCorrect()&&this.addFeedbackCheck(),this.model.isSelectedAnswer()&&!this.model.parent.isCorrect()&&this.addFeedbackCheck())},showAnswer:function(){this.model.parent.prefilled||(this.parent.node.addClass("active"),this.node.find(".check").remove(),this.model.parent.isCorrect()?this.model.isSelectedAnswer()&&this.model.parent.isCorrect()&&this.addCheck({correct:!0}):this.model.isCorrectAnswer()?this.addCheck({empty:!0}):this.model.isSelectedAnswer()&&this.addCheck({correct:!1}))},tryAgain:function(){this.parent.node.removeClass("active"),this.node.find(".check").remove()},updateSelected:function(){this.model.parent.prefilled||this._super()},updateFeedbackState:function(){this.node.removeClass("checked-empty checked-incorrect checked-correct"),this.node.removeClass("solution-empty solution-incorrect solution-correct solution-revealed");var type;if("feedback"==this.model.parent.state)type="checked";else{if("answers"!=this.model.parent.state)return;type="solution"}if(this.model.isRevealedBySeeNext())return void this.node.addClass("solution-revealed");this.model.parent.isCorrect()?this.model.isSelectedAnswer()&&this.node.addClass([type,"correct"].join("-")):!this.model.correct&&this.model.isSelectedAnswer()?this.node.addClass([type,"incorrect"].join("-")):this.model.isSelectedAnswer()||("checked"===type?this.node.addClass("checked-empty"):"solution"===type&&this.model.correct&&this.node.addClass("solution-empty"))}},a5.views.RadiobuttonChoiceView.extend("a5.views.interaction.ISRadiobuttonColumnsChoiceView"),a5.views.interaction.ColouringView={init:function(model,parent){this._super(model,parent,$('<div class="iwt"/>'));var container=$('<div class="colouring_view" id="colouring_view'+model.interaction.index+'"/>').appendTo(this.node);this.contentBlock=$('<div class="block"/>').appendTo(container),this.canvasId="colouring"+this.model.interaction.index,_.bindAll(this,"onImageLoaded","onCanvasKeydown"),this._bindEvents()},setImage:function(){this.$image=this.$("img:first"),this.image=this.$image.get(0),this.node.css("visibility","hidden"),this.image.complete?this.onImageLoaded():this.$image.on("load",this.onImageLoaded)},originalSize:function(){return this.model.originalSize||{width:this.image.naturalWidth,height:this.image.naturalHeight}},render:function(){return this.toolbar=new a5.views.interaction.ColouringToolbar(this.model,this),"bottom"===this.model.poolAlign?this.node.children(".colouring_view").append(this.toolbar.render()):this.node.prepend(this.toolbar.render()),this.node.addClass(this.toolbar.getAlignmentClass()),this.node},onImageLoaded:function(){this.paper||this._drawSVG(),this.node.css("visibility","")},onCanvasKeydown:function(ev){var key=ev.which;if(key===a5.utils.keyCodes.SPACE||key===a5.utils.keyCodes.ENTER){var identifier=$(ev.target).data("identifier"),item=_.find(this.model.items,{identifier:identifier});item&&"answers"!==item.state&&this._colorizeGroup(identifier)}},updateState:function(){this.paper?_.each(this.model.items,function(item,name){this._fill(item.set,item.color,item.opacity)},this):this._drawSVG()},setAnswer:function(){this.node.find(".eraser.highlighter_selected").length&&this.node.find(".highlighter:eq(0)").click(),_.each(this.model.items,function(item){this._addChecksForItem(item,!0)},this)},showAnswer:function(){_.each(this.model.items,function(item){this._addChecksForItem(item),this._showAnswerForItem(item)},this)},showNext:function(item){this._addChecksForItem(item),this._showAnswerForItem(item);var bb=item.set.getBBox();window.scrollTo(0,bb.y)},_addChecksForItem:function(item,skipUnfilled){if(!item.prefilled){var check,bb=item.set.getBBox(),x=(bb.x+bb.x2)/2,y=(bb.y+bb.y2)/2;if(item.distractor?item.isFilled()&&(check=this.addCheck({parent:this.canvas,correct:!1,classes:["dst"]})):skipUnfilled&&!item.isFilled()||(check=this.addCheck({parent:this.canvas,correct:item.isCorrect(),empty:!item.isFilled(),classes:["ans"]})),check){var size=this.originalSize();check.css({left:"calc("+100*x/size.width+"% - "+check.outerWidth()/2+"px)",top:"calc("+100*y/size.height+"% - "+check.outerHeight()/2+"px)"})}}},_showAnswerForItem:function(item){item.distractor?this._fill(item.set,"white",this.model.OPACITY_EMPTY):this._fill(item.set,item.correctColor,1)},tryAgain:function(){_.each(this.model.items,function(item){this.model.tryAgainKeep||item.isCorrect()||(item.color="white",item.opacity=this.model.OPACITY_EMPTY,this._fill(item.set,"white",this.model.OPACITY_EMPTY))},this),this.canvas.find(".check").remove()},_bindEvents:function(){this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.tryAgain,this),this.model.bind("show-next",this.showNext,this)},_drawSVG:function(){this._addSVG(),_.each(this.model.items,function(item){var set=this.paper.set(),shapes=$(a5.utils.decodeHTMLSpecialChars(item.areas)),self=this;item.set=set,shapes.each(function(i,shape){set.push(self._setupShape(shape,item.prefilled,item.identifier))}),item.color&&item.opacity==item.parent.OPACITY_FILL&&this._fill(set,item.color,item.opacity),item.prefilled||set.click(function(){"answers"!==item.state&&self._colorizeGroup(item.identifier)})},this)},_addSVG:function(){var size=this.originalSize();this.canvas=$('<div class="canvas" id="'+this.canvasId+'"/>').insertBefore(this.$image),this.canvas.on("keydown",this.onCanvasKeydown),this.paper=Raphael(this.canvasId,size.width,size.height),this.paper.setViewBox(0,0,size.width,size.height),this.paper.canvas.removeAttribute("height"),this.$image.css("height",""),this.contentBlock.width(size.width)},_setupShape:function(shape,prefilled,identifier){var method,params,res,coords=$(shape).attr("coords").split(",");switch($(shape).attr("shape")){case"rect":params=this._coordRect(coords[0],coords[1],coords[2],coords[3]),method=this.paper.rect;break;case"circle":params=coords,method=this.paper.circle;break;case"poly":var pathString="M";_.each(coords,function(v,index){index%2==0&&index>0&&(pathString+="L"),pathString+=v+" "}),pathString+="L"+coords[0]+" "+coords[1],params=[pathString],method=this.paper.path}return res=method.apply(this.paper,params).attr({stroke:"none",fill:"white",opacity:this.model.OPACITY_EMPTY,cursor:prefilled?"":"pointer"}),$(res[0]).data("identifier",identifier),prefilled&&res.node.setAttribute("class","prefilled"),res},_fill:function(set,color,opacity){set.attr({fill:color,opacity:opacity})},_colorizeGroup:function(code){this.model.interaction.interactionDone||(this._fill(this.model.items[code].set,this.model.color,this.model.opacity),this.model.items[code].opacity=this.model.opacity,this.model.items[code].color=this.model.color,this.model.notifyValueChange())},_coordRect:function(x,y,x2,y2){return[x,y,x2-x,y2-y]}},a5.views.interaction.BaseView.extend("a5.views.interaction.ColouringView"),a5.views.interaction.ColouringToolbar={init:function(model,parent){var toolbarTmpl=window.a5.mainBuilder.layout.getTemplate("highlighter_toolbar");this._super(model,parent,$(a5.mainBuilder.layout.replaceSubpart(toolbarTmpl,"highlighter_toolbar_item",'<div id="itemWrapper"></div>'))),this.buttons=[],this._bindEvents(),this.node.addClass(this.getAlignmentClass())},render:function(){var colors=[],items=_.filter(this.model.items,function(item){return!item.distractor});return items=_.values(items).concat(this.model.distractorColors),items=_.sortBy(items,"identifier"),_.each(items,function(item){_.include(colors,item.correctColor)||item.distractor||(colors.push(item.correctColor),this.buttons.push(new a5.views.interaction.ColouringToolbarItem(item,this,item.correctColor).render())),item.distractor&&this.buttons.push(new a5.views.interaction.ColouringToolbarItem(item,this,item.color).render())},this),this.buttons.push(new a5.views.interaction.ColouringToolbarItem(null,this,"").render()),this.$("#itemWrapper").append(this.buttons).children().unwrap(),this.$(".highlighter:first").click(),this.node},getAlignmentClass:function(){return"align-"+this.model.poolAlign},updateState:function(){},_bindEvents:function(){var self=this;this.node.on("click",".highlighter",function(){self.model.interaction.interactionDone||(self.$(".highlighter").removeClass("highlighter_selected"),$(this).addClass("highlighter_selected"),self.model.color=$(this).data("color"),$(this).is(".eraser")?(self.model.opacity=self.model.OPACITY_EMPTY,$("body").addClass("erasing")):(self.model.opacity=self.model.OPACITY_FILL,
$("body").removeClass("erasing")))}),this.node.on("keydown",".highlighter",function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||$(this).click()}),this.model.interaction.bind("hide",function(){$("body").removeClass("erasing")}),this.model.interaction.bind("show",function(){$("body").toggleClass("erasing",this.$(".toolbar .eraser").is(".highlighter_selected"))},this.model.interaction)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ColouringToolbar"),a5.views.interaction.ColouringToolbarItem={init:function(model,parent,color){var toolbarTmpl=a5.mainBuilder.layout.getTemplate("highlighter_toolbar"),itemTmpl=a5.mainBuilder.layout.getSubpart(toolbarTmpl,"highlighter_toolbar_item"),eraserTmpl=a5.service.templates.render("a5.view.toolbar.erase");null!=model?(this.model=model,this._super(model,parent,$(a5.mainBuilder.layout.replaceSubpart(itemTmpl,"highlighter_toolbar_item_caption",model.label))),this.node.data("color",color).find("span").css({backgroundColor:color})):(this._super(model,parent,$(a5.mainBuilder.layout.replaceSubpart(itemTmpl,"highlighter_toolbar_item_caption",$(eraserTmpl).text()||"Erase"))),this.node.data("color","white").addClass("eraser").find("span").css({backgroundColor:"white"}),this.node.attr("title",$(eraserTmpl).attr("title")))}},a5.views.interaction.BaseView.extend("a5.views.interaction.ColouringToolbarItem"),a5.views.interaction.TargetGameView={init:function(obj,index,builder,interaction){this.identifier=$(obj).attr("identifier"),this.correctResponse=builder.correctResponse.values[0];var str=window.a5.mainBuilder.layout.getTemplate("tgm_panel");this.model=obj,this.step=builder.step,this.node=$("<div/>"),this.node.append(str),this.node.addClass("card"),this.node.addClass("card_"+index),this.node.find(".front td p").html($(obj).text()),builder.correctResponse.values[0]==$(obj).attr("identifier")&&this.node.find(".click").addClass("click_correct")},render:function(){return this.node},isCorrect:function(){return this.correctResponse==this.identifier}},Obj.extend("a5.views.interaction.TargetGameView"),a5.views.interaction.ISCatchView={NODE_TEMPLATE:"<div class='is-catch-wrapper custom-image'><div class='is-catch-target-wrapper'><div class='is-catch-gameover'/><div class='is-catch-board'/><div class='is-catch-target-generator custom-image'/></div></div>",THROTTLE_WAIT:300,activeModel:null,init:function(model,parent,interaction){this.activeModelIndex=0,this._super(model,parent,$(this.NODE_TEMPLATE)),interaction.bind("show:deferred",this.onStart,this,{once:!0}),interaction.bind("show:deferred interaction:dialog:close",this.resume,this),interaction.bind("hide interaction:dialog:display",this.pause,this),interaction.bind("reset",this.onReset,this),this.interaction=interaction},bindMethods:function(){_.bindAll(this,"onFinishQuestion","onEndGameByTimer","onAnimationFrame","resume","onFeedback","pause","onStageResized"),this.model.bind("state_update:feedback",this.onFeedback),this._animation=a5.utils.requestAnimationFrame(this.onAnimationFrame)},onAnimationFrame:function(time){a5.utils.requestAnimationFrame(this.onAnimationFrame),TWEEN.update(time)},renderStage:function(){this.renderBackground(),this.renderTargetGenerator(),this.renderBoard()},renderBackground:function(){this.model.targetsConfiguration.backgroundImage?this.node.css("background-image","url("+A5.ASSET_URL_BUILDER(this.model.targetsConfiguration.backgroundImage)+")"):this.node.removeClass("custom-image")},renderTargetGenerator:function(){var generator=this.node.find(".is-catch-target-generator");if(this.model.targetsConfiguration.targetGeneratorImage){var css={};css["background-image"]="url("+A5.ASSET_URL_BUILDER(this.model.targetsConfiguration.targetGeneratorImage)+")",generator.css(css)}else generator.removeClass("custom-image");var className="generator-"+this.model.targetsConfiguration.targetGeneratorX+"-"+this.model.targetsConfiguration.targetGeneratorY;this.node.addClass(className);var offsetX=0,offsetY=0;if(this.model.targetsConfiguration.targetGeneratorOrigin){var offset=a5.utils.splitAndTrim(this.model.targetsConfiguration.targetGeneratorOrigin,",");offsetX=parseFloat(offset[0]),offsetY=parseFloat(offset[1])}this.model.targetsConfiguration.origin={offsetX:offsetX,offsetY:offsetY},this.setOriginPositionSize(),$(window).on("resize",_.throttle(this.onStageResized,this.THROTTLE_WAIT))},setOriginPositionSize:function(){var origin=this.model.targetsConfiguration.origin,$node=this.node.find(".is-catch-target-generator");origin.left=$node.position().left,origin.top=$node.position().top,origin.width=$node.width(),origin.height=$node.height()},renderBoard:function(){if(this.model.stageConfiguration.countdownTimer||this.model.stageConfiguration.scoreboard){var boardTemplate=a5.service.templates.render("a5.view.is_catch_ScoreBoard",{score:this.model.stageConfiguration.scoreboard,timer:this.model.stageConfiguration.countdownTimer});this.node.find(".is-catch-board").append(boardTemplate).show()}else this.node.find(".is-catch-board").hide()},renderGameOver:function(reason){var messageText,template,dialogClass;switch(reason){case"time":template="a5.view.is_catch_TimeUp",dialogClass="time-up-dialog";break;default:template="a5.view.is_catch_GameOver",messageText=this.model.stageConfiguration.gameOverMessage,dialogClass="game-over-dialog"}a5.view.dialog.display(template,{text:messageText,dialogClass:dialogClass})},initQuestion:function(){this.renderTargetManager(),this.targetsManager.initTargets()},renderTargetManager:function(){this.targetsManager=new a5.views.interaction.ISCatchTargetManager(this.getActiveModel(),this,this.model.targetsConfiguration),this.node.find(".is-catch-target-wrapper").prepend(this.targetsManager.render()),this.getActiveModel().inputState(),this.getActiveModel().bind("state_update:feedback",this.onFinishQuestion)},initCountdown:function(){if(this.model.stageConfiguration.maxDuration){if(this.countdownTimer=new a5.views.interaction.ISCatchTimerManager(this.model,this),this.countdownTimer.bind("timer:end",this.onEndGameByTimer),this.model.stageConfiguration.countdownTimer){var node=this.node.find(".is-catch-board").find(".is_catch_board_timer")[0]||this.node.find(".is-catch-board");$(node).append(this.countdownTimer.render())}this.countdownTimer.initCountdown()}},initScore:function(){if(this.model.stageConfiguration.scoreboard){this.scoreManager=new a5.views.interaction.ISCatchScoreManager(this.model,this);var node=this.node.find(".is-catch-board").find(".is_catch_board_score")[0]||this.node.find(".is-catch-board");$(node).append(this.scoreManager.render()),this.scoreManager.initScore()}},onStart:function(){this.bindMethods(),this.renderStage(),this.initQuestion(),this.initCountdown(),this.initScore(),this.interaction.activityTimer.stamp(),this._updateActivityDurationOnce=_.once(_.bind(this.interaction.updateActivityDuration,this.interaction))},onFinishQuestion:function(){this.trigger("question_finished"),this.setNextActiveModel()?this.initQuestion():this.finishInteraction("answers")},onFeedback:function(evt){this.finishInteraction()},onReset:function(){this.finishInteraction()},onEndGameByTimer:function(){_.each(this.model.unstagedQuestions(),function(model){model.setAnswer()}),this.finishInteraction("time")},onStageResized:function(){this.paused||this.setOriginPositionSize()},finishInteraction:function(reason){this.killAll(),reason&&(this.renderGameOver(reason),this.model.setAnswer())},killAll:function(){this.getActiveModel().unbind("state_update:feedback",this.onFinishQuestion),this.targetsManager.finishQuestion(),this.countdownTimer&&this.countdownTimer.stop(),this.scoreManager&&this.scoreManager.stopScore(),this._updateActivityDurationOnce()},pause:function(){this.paused||(this.paused=!0,this.targetsManager&&this.targetsManager.pause(),this.countdownTimer&&this.countdownTimer.pause())},resume:function(){this.paused&&(this.paused=!1,this.onStageResized(),this.targetsManager&&this.targetsManager.resume(),this.countdownTimer&&this.countdownTimer.resume())},getActiveModel:function(){return this.model.models[this.activeModelIndex]},setNextActiveModel:function(){return this.getActiveModel().unbind("state_update:feedback"),!!(this.activeModelIndex<this.model.models.length-1&&this.model.unstagedQuestions().length)&&(this.activeModelIndex++,!0)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchView"),a5.views.interaction.ISCatchMessage={NODE_TEMPLATE:"a5.view.iscatchMessage",init:function(model,parent,message){this._super(model,parent)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchMessage"),a5.views.interaction.ISCatchTimerManager={NODE_TEMPLATE:'<div class="is-catch-timer"/>',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.bindMethods()},bindMethods:function(){_.bindAll(this,"onSecondChanged","onTimerEnd")},initCountdown:function(){var timerCallback,remaining;this.model.stageConfiguration.countdownTimer?(this.currentSecond=this.model.stageConfiguration.maxDuration,timerCallback=this.onSecondChanged,remaining=1e3,this.renderTime()):(timerCallback=this.onTimerEnd,remaining=1e3*this.model.stageConfiguration.maxDuration),this.timer=new a5.utils.TimerOut(remaining,timerCallback)},renderTime:function(){this.node.html(a5.utils.secondsToTime(this.currentSecond,!0))},onSecondChanged:function(){this.currentSecond--,this.renderTime(),0===this.currentSecond?this.onTimerEnd():this.timer.reset()},onTimerEnd:function(){this.start=null,this.trigger("timer:end")},stop:function(){this.timer.stop()},pause:function(){this.timer.pause()},resume:function(){this.timer.resume()}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchTimerManager"),a5.views.interaction.ISCatchScoreManager={NODE_TEMPLATE:'<div class="is-catch-score"/>',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.updateScore(),this.bindMethods()},bindMethods:function(){_.bindAll(this,"updateScore","setTargetListener","removeTargetListener")},initScore:function(){_.each(this.model.allTargets(),this.setTargetListener)},setTargetListener:function(target){target.bind("state_update:feedback",this.updateScore)},updateScore:function(){var currScore=this.model.getScores();this.node.html(currScore.correct+"/"+currScore.total)},stopScore:function(){_.each(this.model.allTargets(),this.removeTargetListener)},removeTargetListener:function(target){target.unbind("state_update:feedback",this.updateScore)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchScoreManager"),a5.views.interaction.ISCatchTargetManager={THROTTLE_WAIT:a5.views.interaction.ISCatchView.prototype.THROTTLE_WAIT,init:function(model,parent,options){this._super(model,parent,$('<div class="is-catch-target-container"></div>')),this.parent=parent,this.config=this.prepareOptions(options),this.bindMethods(),this.model.bind("state_update:input",this.onInput),this.timer=new a5.utils.TimerOut(this.generationSpeed(!0),this.initTargets,!1)},bindMethods:function(){_.bindAll(this,"onInput","initTargets","onViewExploded","onStageResized")},prepareOptions:function(options){return options.maxItems=options.maxItems||this.model.targets.length,options.maxItems=Math.min(options.maxItems,this.model.targets.length),options},render:function(){return $(window).on("resize",_.throttle(this.onStageResized,this.THROTTLE_WAIT)),this._super()},initTargets:function(){if(!this.timer.isRunning()){var nextTarget=this.getNextViableTarget();nextTarget&&(this.createTarget(nextTarget),nextTarget.display(),this.timer.reset())}},createTarget:function(target){0===this.node.width()||0===this.node.height()?_.defer(_.bind(function(){this.createTarget(target)},this)):this.renderTarget(target)},renderTarget:function(target){var origin=this.config.targetGeneratorY+this.config.targetGeneratorX,config={stageWidth:this.node.width(),stageHeight:this.node.height(),speed:this.config.movementSpeed,targetImage:this.config.targetImage,selectedTargetImage:this.config.selectedTargetImage,targetDuration:this.config.targetDuration,origin:this.config.origin},targetView=new a5.views.interaction.ISCatchTargetView(target,this,config,origin),node=targetView.render();targetView.bind("exploded",this.onViewExploded),this.node.append(node),targetView.initTween(),this.targetViews.push(targetView),a5.eventBus.trigger("is-catch:target:rendered",node)},getNextViableTarget:function(){var tobeDisplayed=this.model.tobeDisplayed(),leftToDisplayAmount=this.config.maxItems-this.targetViews.length,displayingCorrect=this.model.displayingCorrect(),tobeDisplayedCorrect=this.model.tobeDisplayedCorrect(),displayingAmount=this.targetViews.length;if(this.config.maxItems>displayingAmount){if(1===leftToDisplayAmount&&0===displayingCorrect.length&&tobeDisplayedCorrect.length)return tobeDisplayedCorrect[0];if(tobeDisplayed.length)return tobeDisplayed[0]}else;},generationSpeed:function(miliseconds){var offset=4;switch(this.config.generationSpeed){case"slow":offset=7;break;case"medium":offset=4;break;case"fast":offset=1}var seconds=2*Math.random()+offset;return miliseconds&&(seconds*=1e3),seconds},onStageResized:function(evt){if(!this.parent.paused){var width=this.node.width(),height=this.node.height();_.each(this.targetViews,function(targetView){targetView.onStageResized(width,height)})}},onInput:function(){_.invoke(this.targetViews,"resetView"),this.targetViews=[]},onViewExploded:function(targetView){var index=this.targetViews.indexOf(targetView);index<0||(this.targetViews.splice(index,1),targetView.unbind("exploded"),this.model.tobeDisplayedCorrect().length+this.model.displayingCorrect().length===0?this.finishQuestion():(this.targetViews.length||this.timer.stop(),this.initTargets()))},pause:function(){_.invoke(this.targetViews,"pause"),this.timer.pause()},resume:function(){this.onStageResized(),_.invoke(this.targetViews,"resume"),this.timer.resume()},finishQuestion:function(){_.invoke(this.targetViews,"unbind"),_.invoke(this.targetViews,"onFeedback"),this.model.setAnswer(),this.node.remove(),this.timer.stop()}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchTargetManager"),a5.views.interaction.ISCatchTargetView={init:function(model,parent,config,origin){this._super(model,parent,$('<div class="is-catch-target"><div class="is-catch-target-content"/></div>')),this.parent=parent,this.config=config,this.setRandomAngle(origin),this.setRandomSpeed(),this.renderBackground(),this.renderContent(),this.bindMethods(),this.createTimer(),this.node.unbind("click"),this.node.on("click",this.onClick),this.model.bind("state_update:feedback",this.onFeedback),this.model.bind("state_update:expired",this.onExpired)},bindMethods:function(){_.bindAll(this,"onFeedback","onExpired","expire","onBounce","onClick")},createTimer:function(){this.config.targetDuration&&(this.timer=new a5.utils.TimerOut(1e3*this.config.targetDuration,this.expire))},renderBackground:function(){this.config.targetImage&&(this.node.css("background-image","url("+A5.ASSET_URL_BUILDER(this.config.targetImage)+")"),this.node.addClass("custom-image"))},renderSelectedBackground:function(){this.config.selectedTargetImage&&(this.node.css("background-image","url("+A5.ASSET_URL_BUILDER(this.config.selectedTargetImage)+")"),this.node.addClass("custom-image"))},renderContent:function(){var $content=$($.parseHTML(this.model.value));$content.is("img")?(this.node.addClass("has-img"),a5.utils.buildModel(a5.mainBuilder.curInteraction,this.node.find(".is-catch-target-content"),$content,!0)):this.node.find(".is-catch-target-content").text(this.model.value),_.defer(_.bind(function(){this.node.addClass("spawn"),this.resizeTextAndCenter(this.node.find(".is-catch-target-content"))},this))},resizeTextAndCenter:function(node){var parentW=node.parent().width(),parentH=node.parent().height(),scale=Math.min(parentH/node.height(),parentW/node.width());scale<1?node.zoom(scale):scale=1;var left=(parentW-scale*node.width())/2,top=(parentH-scale*node.height())/2;node.css({top:top,left:left})},initTween:function(){0===this.node.width()||0===this.node.height()?_.defer(_.bind(function(){this.initTween()},this)):this.positionAndTween()},positionAndTween:function(){this.setBounceRectangle();var top=(this.config.origin.height-this.node.height())/2+this.config.origin.offsetY,left=(this.config.origin.width-this.node.width())/2+this.config.origin.offsetX;top+=this.config.origin.top,left+=this.config.origin.left,this.node.css({top:top,left:left}),this.createMovementTween({y:top,x:left})},createMovementTween:function(from){if(!_.isUndefined(this.angle)){var dest={x:this.directionQuad("left")?this.bounceRectangle.right:this.bounceRectangle.left,y:this.directionQuad("top")?this.bounceRectangle.bottom:this.bounceRectangle.top};this.position={x:from&&from.x||this.node.position().left,y:from&&from.y||this.node.position().top};var speed;speed=a5.dp.config.catchGameMovementSpeed?1e3*a5.dp.config.catchGameMovementSpeed/Math.pow(2,this.speed):this.getBounceArea()/(100*Math.pow(2,this.speed)),dest=a5.utils.trignHelper.DESTINATION_FROM_ANGLE(this.radAngle(),speed,this.position,dest);var node=this.node;this._tween=new TWEEN.Tween(this.position).to(dest,1e3*dest.time).onUpdate(function(){$(node).css({left:this.x,top:this.y})}).onComplete(this.onBounce).start()}},onBounce:function(){this.angle=a5.utils.trignHelper.BOUNCE_ANGLE(this.bounceRectangle,this.position,this.angle),this.createMovementTween()},onClick:function(){this.model.setAnswer(),this._triggerEventBus()},expire:function(){this.model.expire()},killTweens:function(){this._tween&&this._tween.stop()},onFeedback:function(){var classToAdd=this.model.isCorrect?"correct":"wrong";this.node.addClass(classToAdd),this.die()},_triggerEventBus:function(){this.model.isCorrect?a5.eventBus.trigger("is-catch:success"):a5.eventBus.trigger("is-catch:failure")},onExpired:function(){this.node.addClass("expired"),this.die()},die:function(){this.node.addClass("popped"),this.renderSelectedBackground(),this.killTweens(),this.trigger("exploded",this),this.node.off("click",this.onClick),this.timer&&this.timer.stop(),this.node.bind("webkitTransitionEnd transitionend",function(evt){$(evt.currentTarget).remove()})},onStageResized:function(stW,stH){this.config.stageWidth=stW,this.config.stageHeight=stH,this.setBounceRectangle(),this.killTweens(),this.position.x=Math.min(this.position.x,stW-this.node.width()),this.position.y=Math.min(this.position.y,stH-this.node.height()),this.createMovementTween({x:this.position.x,y:this.position.y})},resetView:function(){this.model.initState(),this.node.remove()},pause:function(){this.killTweens(),this.timer&&this.timer.pause()},resume:function(){this._tween?(this.killTweens(),this.createMovementTween()):this.initTween(),this.timer&&this.timer.resume()},setRandomAngle:function(origin){var offset=(a5.utils.trignHelper.RECT_ANG-70)/2,quad=a5.utils.trignHelper.QUADRANTS[origin.toUpperCase()];this.angle=Math.round(70*Math.random())+offset+quad*a5.utils.trignHelper.RECT_ANG},setRandomSpeed:function(){var offset,range;switch(this.config.speed){case"slow":offset=5,range=.5;break;case"medium":offset=4.5,range=.3;break;case"fast":offset=4,range=.1}this.speed=Math.ceil(Math.random()*range)+offset+range/2},setBounceRectangle:function(){var w=this.node.width(),h=this.node.height();this.bounceRectangle={top:0,left:0,bottom:this.config.stageHeight-h,right:this.config.stageWidth-w}},radAngle:function(){return a5.utils.trignHelper.DEGR_TO_RAD(this.angle)},quad:function(){return a5.utils.trignHelper.DEGR_TO_QUAD(this.angle)},directionQuad:function(type){var quadName=a5.utils.trignHelper.QUAD_TO_NAME(this.quad());if(quadName)return quadName.toLowerCase().indexOf(type.toLowerCase())>=0},getBounceArea:function(){return this.config.stageWidth*this.config.stageHeight}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCatchTargetView"),a5.views.interaction.BaseDropdownView={PREFILL_TEMPLATE:'<span class="prefill drop-label"></span>',init:function(model,parent){this._super(model,parent,$('<div class="wrapper-dropdown"></div>')),this.model.bind("update-selected",_.bind(this.updateSelection,this))},render:function(){return this.model.prefill?(this.$dropdown=$(this.PREFILL_TEMPLATE),this.$dropdown.append(this._getPrefill())):(this.$dropdown=$(this.DROPDOWN_TEMPLATE),this.$label=this.$dropdown.find("span:first"),this.$popup=this.$dropdown.find(".popup"),this.$close=this.$popup.find("span.popup-close"),this.$label.attr("style",this.model.labelStyle),this.model.placeholder&&this.$label.html(this.model.placeholder),this.bindEvents()),this.node.append(this.$dropdown),this.node},adjustSameLongestWidth:function(){},bindEvents:function(){this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswers,this),this.model.bind("state_update:input",this.setInput,this),this.model.bind("input_update:setAnswer",this.setAnswerInput,this),this.model.bind("next_answer",this.onNextAnswer,this)},updateSelection:function(){this.model.prefill||(this.$label.empty(),this.model.selected?(this.$label.append(this.model.selected.content.clone()),this.node.addClass("filled")):(this.model.placeholder?this.$label.html(this.model.placeholder):this.$label.html("&nbsp;"),this.node.removeClass("filled")))},hide:function(){this.node.css("visibility","hidden")},show:function(){this.node.css("visibility","")},setAnswer:function(){var setCheck=!this.model.prefill;this.setAnswerCheck(setCheck)},setAnswerInput:function(){var setCheck=!this.model.prefill&&this.model.selected;this.setAnswerCheck(setCheck)},setAnswerCheck:function(check){this.node.find(".check").remove(),this.updateFeedbackState(this.$dropdown),check&&(this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.selected?this.model.selected.getAnswerFeedback():this.model.getAnswerFeedback(),correctTooltip:!0}),this.bindAnswerFeedback(this.model.selected))},showAnswers:function(){if(this.node.find(".check").remove(),this.updateFeedbackState(this.$dropdown),!this.model.prefill){var correct=this.model.allowRepeat?this.model.getCorrect():this.model.findNextCorrect();this.model.selected?this.model.isCorrect()?this.model.isCorrect()&&(this.addCheck({correct:!0,tooltip:!!a5.dp.config.displayFeedbackAfterSeeAnswer&&this.model.getCorrect().getAnswerFeedback()}),correct=this.model.selected):this.addCheck({wrong:!0,tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getCorrect().getAnswerFeedback():this.model.selected.content}):this.addCheck({empty:!0,tooltip:!!a5.dp.config.displayFeedbackAfterSeeAnswer&&this.model.getCorrect().getAnswerFeedback()}),this.$label.html(correct.content.clone()),this.bindAnswerFeedback(correct)}},setInput:function(){this.node.find(".check").remove(),this.updateFeedbackState(this.$dropdown)},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},_getPrefill:function(){return this.model.getCorrect().content}},a5.views.interaction.BaseView.extend("a5.views.interaction.BaseDropdownView"),a5.views.interaction.ISNativeDropdownView={DROPDOWN_TEMPLATE:'<div class="rich-dropdown" tabindex="0"><select class="mobile-native-select"><option value="" hidden selected disabled></option><optgroup label=""></optgroup></select><span class="label drop-label">&nbsp;</span></div>',render:function(){return this._super(),this.model.prefill||(this.$select=this.$dropdown.find(".mobile-native-select"),_.each(this.model.choices,function(choice){var $option=$("<option>"+choice.content.text()+"</option>");$option.attr("value",choice.id),this.$select.append($option)},this),this.bindNativeEvents()),this.node},bindNativeEvents:function(){this.$select.on("input",_.bind(this.onNativeChange,this))},onNativeChange:function(e){var id=this.$select.val(),choice=_.find(this.model.choices,function(model){return model.id==id});this.model.setSelected(choice)},setAnswer:function(){this._super(),this.$select.hide()},showAnswers:function(){this._super(),this.$select.hide()},setInput:function(){this._super(),this.$select.show(),this.model.selected||this.$select.val("")}},a5.views.interaction.BaseDropdownView.extend("a5.views.interaction.ISNativeDropdownView"),a5.views.interaction.ISRichDropdownView={DROPDOWN_TEMPLATE:'<div class="rich-dropdown" tabindex="0"><span class="label drop-label">&nbsp;</span><div class="popup"><span class="popup-close">x</span><ul></ul></div></div>',init:function(model,parent){this._super(model,parent),a5.callbacks.interaction.bind("showed",this.adjustLayout,this),$(window).on("resize",_.throttle(this.onWindowResize.bind(this),300)),a5.hooks.interactionFontUpdated.add(this.adjustLayout.bind(this)),this.choices=this._initChoices(),_.bindAll(this,"onClick","onSelect","onClose","onKeydown","onBlur")},adjustLayout:function(){var $popup=this.node.find(".popup");$popup.show(),this._adjustWidth(),$popup.hide()},_adjustWidth:function(){var size,maxWidth=0,$label=this.node.find(".label");_.each(this.node.find("li"),function(li){size=$(li).naturalSize({padding:0},{width:"2000px"}),size[0]>maxWidth&&(maxWidth=size[0])}),/[\s;]*width:/gi.test(this.model.labelStyle)||$label.css("width",maxWidth+1)},_adjustPopupPosition:function(){var $popup=this.node.find(".popup"),$footer=$("#activity_controls"),$content=this.node.closest(".content-wrap"),viewport={bottom:$(window).height()};$footer.offset().top>this.node.offset().top&&(viewport.bottom=$footer.offset().top),$popup.css("max-height",""),$popup.css("overflow",""),this.$popup.offset().top<this.node.offset().top&&this.$popup.css("top","");var availableSpaceDown=viewport.bottom-this.node.offset().top-this.node.outerHeight();if($popup.outerHeight()>=availableSpaceDown){if(this.node.addClass("popup-above"),$content.length>0){var availableSpaceUp=this.node.offset().top-$content.offset().top;$popup.outerHeight()>availableSpaceUp&&(this.node.removeClass("popup-above").addClass("popup-below"),$popup.css("top",""),$popup.css("max-height",availableSpaceDown-10),$popup.css("overflow","scroll"))}}else this.node.addClass("popup-below")},render:function(){this._super(),this.model.prefill||(this.$list=this.$popup.find("ul"),_.each(this.choices,function(choiceView){this.$list.append(choiceView.render())},this),this.close());var promises=[];return this.$("img").each(function(index,img){var deferred=$.Deferred();img.onload=img.onerror=function(){deferred.resolve()},promises.push(deferred.promise())}),$.when.apply(this,promises).done(_.bind(function(){this.adjustLayout()},this)),this.node},bindEvents:function(){this._super(),this.$dropdown.on("click",this.onClick),this.$dropdown.on("select",this.onSelect),this.$dropdown.on("keydown",this.onKeydown),this.$dropdown.on("blur",this.onBlur),this.$close.on("click",this.onClose)},onKeydown:function(e){var key=e.which;key===a5.utils.keyCodes.SPACE||key===a5.utils.keyCodes.ENTER?(e.stopPropagation(),e.preventDefault(),this.hoveredChoice?this.hoveredChoice.select():this.toggle()):key===a5.utils.keyCodes.DOWN?(e.stopPropagation(),e.preventDefault(),this.next(),this.visible||this.hoveredChoice.select()):key===a5.utils.keyCodes.UP?(e.stopPropagation(),e.preventDefault(),this.prev(),this.visible||this.hoveredChoice.select()):key===a5.utils.keyCodes.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.close())},onClick:function(e){"input"!=this.model.state||this.model.tryAgainIsFrozen&&this.$dropdown.hasClass("checked-correct-locked")||this.toggle()},onClose:function(e){e.stopPropagation(),this.close()},onSelect:function(e,choice){e.stopPropagation(),this.model.setSelected(choice),this.close(),this.$dropdown.trigger("change")},onBlur:function(e){($(e.target).is(this.$dropdown)||0===$(e.target).closest(this.$dropdown).length)&&this.close()},onWindowResize:function(e){this.adjustLayout(),this.visible&&requestAnimationFrame(function(){this.close(),this.open()}.bind(this))},close:function(){_.invoke(this.choices,"unhover"),this.hoveredChoice=null,this.$dropdown.removeClass("opened"),this.node.removeClass("popup-above popup-below"),this.$popup.hide(),this.visible=!1},open:function(){this.$dropdown.addClass("opened"),this.$popup.show(),this.node.removeClass("popup-above popup-below"),this._adjustPopupPosition(),this.visible=!0},toggle:function(){this.visible?this.close():_.defer(_.bind(this.open,this))},next:function(){if(this.hoveredChoice||this.model.selected){this.hoveredChoice||(this.hoveredChoice=_.find(this.choices,{model:this.model.selected}));var currentIndex=this.choices.indexOf(this.hoveredChoice),nextIndex=(currentIndex+1)%this.choices.length;this.hoveredChoice=this.choices[nextIndex]}else this.hoveredChoice=_.first(this.choices);this.hoveredChoice.hover()},prev:function(){if(this.hoveredChoice||this.model.selected){this.hoveredChoice||(this.hoveredChoice=_.find(this.choices,{model:this.model.selected}));var currentIndex=this.choices.indexOf(this.hoveredChoice),prevIndex=currentIndex?currentIndex-1:this.choices.length-1;this.hoveredChoice=this.choices[prevIndex]}else this.hoveredChoice=_.last(this.choices);this.hoveredChoice.hover()},setInput:function(){this._super(),this.model.selected||this.$list.children().removeClass("active")},_initChoices:function(){return _.map(this.model.choices,function(choice){return new a5.views.interaction.ISRichDropdownChoiceView(choice,this)},this)}},a5.views.interaction.BaseDropdownView.extend("a5.views.interaction.ISRichDropdownView"),a5.views.interaction.ISRichDropdownChoiceView={HOVER_CLASS:"hovered",init:function(model,parent){this._super(model,parent,$("<li></li>")),_.bindAll(this,"onClick")},render:function(){return this.node.empty(),this.node.append(this.model.content.clone()),this.bindEvents(),this.node},bindEvents:function(){this.node.on("click",this.onClick)},onClick:function(e){e.stopPropagation(),this.select()},select:function(){this.node.trigger("select",this.model),this.node.siblings("li").removeClass("active"),this.node.addClass("active")},hover:function(){this.node.siblings("li").removeClass(this.HOVER_CLASS),this.node.addClass(this.HOVER_CLASS)},unhover:function(){this.node.removeClass(this.HOVER_CLASS)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRichDropdownChoiceView"),a5.views.interaction.ISHorizontalSelect={NODE_TEMPLATE:'<span tabindex=0 class="input-select-horizontal"><span class="content"></span></span>',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.popup=new a5.views.interaction.ISHorizontalSelectPopup(model.choices,this),model.prefill&&this.model.setSelected(this.model.correct[0]),_.bindAll(this,"_onBlur","_onClick","_onKeydown"),this.update(),this.model.prefill||this.bindEvents()},bindEvents:function(){this.model.bind("update-selected",_.bind(this.update,this)),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswers,this),this.model.bind("state_update:input",this.setInput,this),this.model.bind("input_update:setAnswer",this.setAnswerInput,this),this.model.bind("next_answer",this.onNextAnswer,this),this.node.on("click",this._onClick),this.node.on("keydown",this._onKeydown),this.node.on("blur",this._onBlur),this.popup.bind("hidden",this._onPopupHidden,this),this.popup.bind("shown",this._onPopupShown,this)},showAnswers:function(){this.node.find(".check").remove(),this.updateFeedbackState(this.node),this.model.selected?this.model.isCorrect()?this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback(),correctTooltip:!0}):this.addCheck({wrong:!0,tooltip:this.model.selected.content}):this.addCheck({empty:!0}),this.node.find(".content").html(this.model.correct[0].content.clone()),this.bindAnswerFeedback(this.model.selected||this.model.correct[0])},setAnswer:function(){var setCheck=!this.model.prefill;this.setAnswerCheck(setCheck)},setAnswerInput:function(){var setCheck=!this.model.prefill&&this.model.selected;this.setAnswerCheck(setCheck)},setAnswerCheck:function(check){this.node.find(".check").remove(),this.updateFeedbackState(this.node),check&&this.addCheck({correct:this.model.isCorrect(),
tooltip:this.model.selected?this.model.selected.getAnswerFeedback():this.model.getAnswerFeedback(),correctTooltip:!0}),this.bindAnswerFeedback(this.model.selected||this.model.correct[0])},setInput:function(){this.node.find(".check").remove(),this.updateFeedbackState(this.node),this.update()},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},update:function(){var selected="";this.model.selected?(selected=this.model.selected.content.clone(),this.model.prefill?this.node.addClass("prefill"):this.node.addClass("filled")):this.node.removeClass("filled"),this.node.find(".content").html(selected)},adjustSameLongestWidth:function(){var interaction=this.node.parents(".interaction"),choices=interaction.find(".input-select-horizontal .popup-choice"),gaps=interaction.find(".input-select-horizontal span.content"),longest=_.max(choices,function(el){return $(el).text().length}),offdom=interaction.find(".input-select-horizontal").first().clone();offdom.text($(longest).text()),gaps.css("width",offdom.measure("width")).css("display","inline-block")},render:function(){return this._super(),this.node.append(this.popup.render()),this.node},checkOpen:function(){this.model.prefill||"input"!=this.model.state||this.popup.show()},hide:function(){this.node.css("visibility","hidden")},show:function(){this.node.css("visibility","")},_onClick:function(){this.checkOpen()},_onBlur:function(){this.popup.hide()},_onKeydown:function(ev){var key=ev.which;key===a5.utils.keyCodes.SPACE||key===a5.utils.keyCodes.ENTER?this.popup.hoveredChoice?this.popup.selectHovered():this.checkOpen():key===a5.utils.keyCodes.ESCAPE?this.popup.hide():key===a5.utils.keyCodes.LEFT||key===a5.utils.keyCodes.UP?(this.popup.prev(),this.popup.isVisible()||this.popup.selectHovered()):key!==a5.utils.keyCodes.RIGHT&&key!==a5.utils.keyCodes.DOWN||(this.popup.next(),this.popup.isVisible()||this.popup.selectHovered())},_onPopupHidden:function(){this.node.removeClass("opened")},_onPopupShown:function(){this.node.addClass("opened")}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISHorizontalSelect"),a5.views.interaction.ISHorizontalSelectPopup={NODE_TEMPLATE:'<div style="position: absolute" class="popup"></div>',CLOSE_TEMPLATE:'<span class="popup-close"></span>',init:function(choices,parent){this._super(choices,parent,$(this.NODE_TEMPLATE)),this.close=$(this.CLOSE_TEMPLATE),this.node.append(this.close),this.hide(),this.choices=[],_.each(choices,this.add_choice,this)},bindEvents:function(){this.close.on("mousedown touchstart",_.bind(function(e){e.stopPropagation(),e.preventDefault(),this.node.hide()},this))},render:function(){return this._super(),this.bindEvents(),this.node},add_choice:function(choice){var $choice=new a5.views.interaction.ISHorizontalSelectChoice(choice,this);this.choices.push($choice),this.node.append($choice.render())},prev:function(){if(this.hoveredChoice||this.parent.model.selected){this.hoveredChoice||(this.hoveredChoice=_.find(this.choices,{model:this.parent.model.selected}));var currentIndex=this.choices.indexOf(this.hoveredChoice),prevIndex=currentIndex?currentIndex-1:this.choices.length-1;this.hoveredChoice=this.choices[prevIndex]}else this.hoveredChoice=_.last(this.choices);this.hoveredChoice.hover()},next:function(){if(this.hoveredChoice||this.parent.model.selected){this.hoveredChoice||(this.hoveredChoice=_.find(this.choices,{model:this.parent.model.selected}));var currentIndex=this.choices.indexOf(this.hoveredChoice),nextIndex=(currentIndex+1)%this.choices.length;this.hoveredChoice=this.choices[nextIndex]}else this.hoveredChoice=_.first(this.choices);this.hoveredChoice.hover()},selectHovered:function(){this.hoveredChoice.select(),delete this.hoveredChoice},reposition:function(){var activity=this.node.closest(".interaction"),gap=this.parent.node,popup=this.node,gapCenter=gap.offset().left+gap.width()/2-activity.offset().left,overflowLeft=popup.outerWidth()/2-gapCenter,overflowRight=gapCenter+popup.outerWidth()/2-activity.width(),left=gap.width()/2-popup.outerWidth()/2;overflowLeft>0?left+=overflowLeft:overflowRight>0&&(left-=overflowRight),popup.css("top",-gap.height()),popup.css("left",left),_.defer(_.bind(function(){try{this.node.parents(".mCustomScrollbar").mCustomScrollbar("scrollTo",this.node.parent().position().top)}catch(e){}},this))},show:function(){this.reposition(),this.node.show(),a5.utils.isVisibleHorizontally(this.node)||this.node.addClass("horizontalDropdown__popup--longList"),this.trigger("shown")},hide:function(){this.node.removeClass("horizontalDropdown__popup--longList"),this.node.hide(),this.trigger("hidden")},isVisible:function(){return this.node.is(":visible")}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISHorizontalSelectPopup"),a5.views.interaction.ISHorizontalSelectChoice={NODE_TEMPLATE:'<span class="popup-choice"></span>',HOVER_CLASS:"hovered",init:function(choice,parent){this._super(choice,parent,$(this.NODE_TEMPLATE)),this.node.empty(),this.node.append(choice.content.clone()),this.node.on("mousedown touchstart",_.bind(function(e){e.stopPropagation(),e.preventDefault(),this.select()},this))},hover:function(){this.node.siblings().removeClass(this.HOVER_CLASS),this.node.addClass(this.HOVER_CLASS)},select:function(){this.parent.parent.model.setSelected(this.model),this.node.siblings().removeClass("active"),this.node.addClass("active"),this.parent.hide(),this.parent.parent.update()}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISHorizontalSelectChoice"),a5.view.interaction.IMMarking={init:function(model,parent,classes,vent){this._super(model,parent,$('<div class="contentblock"></div>')),this.authorClasses=classes,this.vent=vent,model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),this.model.bind("state_update:feedback",this.setAnswer,this),this.vent.bind("element:mark",this.onElementMarked,this)},render:function(){return this.node.addClass(this.authorClasses),this.model.isPrefilled()&&(this.node.addClass("prefilled"),this.model.setEnabled(!1)),this.node.addClass("style-"+this.model.markingStyle),this.node},appendDOM:function($dom){this.node.append($dom)},setAnswer:function(){$("body").is(".erasing")&&this.setFirstColorActive()},setFirstColorActive:function(){var toolbar=this.model.interaction.toolbar;toolbar.buttons.length&&toolbar.buttons[0].setPressed(!0)},onElementMarked:function(element){if(this.isMarkingLetterDialogEnabled()){var $dialogLetter=this.$selectLetterDialog&&this.getDialogLetter(element.model.id);$dialogLetter?this.markDialogLetter($dialogLetter,element.model.isMarked()):this.buildMarkingLetterDialog(element)}},isMarkingLetterDialogEnabled:function(){return this.model.interaction.options.highlightselectionIsLetters()&&a5.dp.config.markingLetterDialogEnabled},buildMarkingLetterDialog:function(element){var $letters=$.merge(element.node.prevUntil(".not-markable").add(element.node),element.node.nextUntil(".not-markable")),property=this.model.getMarkStyleProperty(),lettersTemplateModel=_.map($letters,function(letter){var $letter=$(letter);return{id:$letter.attr("data-model-id"),text:$letter.text(),marked:$letter.hasClass("marked"),property:property,color:$letter.hasClass("marked")?letter.style[property]:""}});this.showMarkingLetterDialog(lettersTemplateModel)},showMarkingLetterDialog:function(lettersTemplateModel){this.$selectLetterDialog=a5.view.dialog.display("a5.view.dialog.IMMarkingLettersSelect",{dialogClass:"markingLettersSelect",letters:lettersTemplateModel},{close:function(){this.$selectLetterDialog=null}.bind(this)}),this.applyStyleDialogLetters(lettersTemplateModel),this.$selectLetterDialog.on("click",".markingLettersSelect__letter",this.onClickDialogLetter.bind(this))},applyStyleDialogLetters:function(lettersModel){_.each(lettersModel,function(letter){if(letter.marked){this.getDialogLetter(letter.id).css(letter.property,letter.color)}}.bind(this))},onClickDialogLetter:function(ev){var newMarkedValue,$letter=$(ev.currentTarget),letterId=$letter.data().letterId,markingElement=_.find(this.model.nodes,function(node){return node.id===letterId});newMarkedValue=a5.dp.config.markableActsAsToggle?!$letter.hasClass("marked"):!!a5.mainBuilder.curInteraction.iMMarkingCursor,newMarkedValue?markingElement.setMarked(a5.mainBuilder.curInteraction.iMMarkingCursor):markingElement.setMarked(!1),this.markDialogLetter($letter,newMarkedValue)},markDialogLetter:function($letter,marked){var property=this.model.getMarkStyleProperty(),color=marked?this.model.interaction.iMMarkingColors[a5.mainBuilder.curInteraction.iMMarkingCursor]:null;$letter.toggleClass("marked",marked),$letter.css(property,color||"")},getDialogLetter:function(id){var $letter=this.$selectLetterDialog.find("[data-letter-id='"+id+"']");return $letter.length>0?$letter:null}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMMarking"),a5.view.interaction.IMMarkingElement={init:function(model,parent,vent){this._super(model,parent,$('<span class="markable"></span>')),this.vent=vent,_.bindAll(this,"onClick","onKeydown"),this.model.bind("change",this.onChange,this),this.model.bind("restore",this.onRestore,this),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("input_update:setAnswer",this.onStateInputFeedback,this),this.model.bind("next_answer",this.onNextAnswer,this),this.updateStatus()},render:function(){return this.node.html(this.model.text),this.model.isPrefilled()&&(this.node.addClass("prefilled"),this.model.setEnabled(!1)),this.node},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},onClick:function(){this.mark()},onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.mark()},onRestore:function(){this.updateStatus()},onChange:function(){this.updateStatus()},onStateUpdate:function(){this.updateStatus()},onStateInputFeedback:function(){this.checkAnswerInput()},updateMark:function(color,isMarked){var property=this.model.parent.getMarkStyleProperty();this.node.css(property,color||""),_.isUndefined(isMarked)||this.node.toggleClass("marked",isMarked)},mark:function(){a5.mainBuilder.curInteraction.toolbar.isEnable()&&(a5.dp.config.markableActsAsToggle&&this.model.isMarked()&&this.model.marked===a5.mainBuilder.curInteraction.iMMarkingCursor?this.model.setMarked(!1):this.model.setMarked(a5.mainBuilder.curInteraction.iMMarkingCursor),this.vent.trigger("element:mark",this))},checkAnswerInput:function(){this.removeCheck(),this.updateFeedbackState(this.node),this.model.isFilled()&&(this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))},removeCheck:function(){this._super(),this.node.removeClass("has_check")},updateStatus:function(){if(this.node.off(),this.removeCheck(),this.updateFeedbackState(this.node),this.node.removeClass("has-solution"),this.model.isPrefilled())return void this.updateMark(this.model.getCorrectColor());this.model.state!==this.model.STATES.INPUT||this.model.parent.isPrefilled()?this.model.state===this.model.STATES.CHECK?this.model.isRevealedBySeeNext()?(this.updateMark(this.model.getCorrectColor()),this.addCheck({correct:!1})):(this.updateMark(this.model.getColor(),this.model.isMarked()),this.model.isFilled()&&(this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))):this.model.state===this.model.STATES.ANSWERS&&(this.updateMark(this.model.getCorrectColor()),this.model.hasCorrectAnswer()&&(this.node.addClass("has-solution"),this.addCheck({correct:this.model.isCorrect(),empty:!this.model.isFilled()&&!this.model.isCorrect(),tooltip:!!a5.dp.config.displayFeedbackAfterSeeAnswer&&this.model.getAnswerFeedback()})),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})):(this.updateMark(this.model.getColor(),this.model.isMarked()),this.model.isEnabled()&&(this.node.on("click",this.onClick),this.node.on("keydown",this.onKeydown)))},addCheck:function(params){if(this.node.addClass("has_check"),this.checkParent)return this._super($.extend(params,{parent:this.checkParent}));var check=this._super(params);if("static"===check.css("position")){var next,lastLeaf=this.node.contents();for(lastLeaf=lastLeaf.eq(lastLeaf.length-2);next=lastLeaf.contents().last(),next.length;lastLeaf=next);if(lastLeaf[0].nodeType===Node.TEXT_NODE){var match=lastLeaf[0].textContent.match(/(.*?)(\S*\s*$)/);lastLeaf[0].textContent=match[1],lastLeaf.after($('<span class="element-wrap">').text(match[2])),match[1]||lastLeaf.remove()}else lastLeaf.wrap('<span class="element-wrap">');return this.checkParent=this.node.find(".element-wrap"),check.appendTo(this.checkParent)}}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMMarkingElement"),a5.view.interaction.IMMarkingText={init:function(model,parent){this._super(model,parent,$('<span class="not-markable"></span>'))},render:function(){return this.node.text(this.model.text),this.node}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMMarkingText"),a5.view.IMProofing={init:function(parameters){this.vent=parameters.vent,this.interaction=parameters.interaction,this.currentMarker=!1,this.$el=this.interaction.$(".interaction"),this.errorCounter=new a5.view.IMProofingErrorCounter({vent:this.vent,interaction:this.interaction}),this.toolbar=new a5.view.IMProofingToolbar({vent:this.vent,interaction:this.interaction}),this.children=[],this.vent.bind("click:marker",this._onClickMarker,this),this.vent.bind("click:erase",this._onClickErase,this),this.vent.bind("click:element",this._onClickElement,this),this.interaction.bind("im-proofing-hint",this._onClickHint,this),this.interaction.bind("show",this._onInteractionShow,this,{once:!0}),a5.mainBuilder.bind("reset",this._onReset,this,{once:!0})},unbindEvents:function(){this.interaction.unbind("show",this._onInteractionShow),a5.mainBuilder.unbind("reset",this._onReset),this.interaction.unbind("im-proofing-hint",this._onClickHint)},render:function(){return this.$el.prepend(this.toolbar.$el),this.toolbar.render(),this.toolbar.$el.append(this.errorCounter.$el),this.errorCounter.render(),this.$el},add:function(view){this.children.push(view)},_onReset:function(){this.unbindEvents()},_onInteractionShow:function(){this.vent.trigger("interaction:show",this.interaction)},_onClickHint:function(){var elementView=this._getRandomElementView(),element=elementView.model;_.each(this.children,function(childView){childView.node.removeClass("highlight")}),elementView.node.addClass("highlight"),setTimeout(function(){elementView.node.removeClass("highlight")},a5.dp.config.IMProofingSignalDuration),this.vent.trigger("element:signal",{marker:element.correct.marker})},_onClickMarker:function(marker){this.$el.removeClass("erase"),this.$el.removeClass("marker-"+this.currentMarker),this.$el.addClass("marker-"+marker),this.currentMarker=marker},_onClickErase:function(){this.$el.removeClass("marker-"+this.currentMarker),this.$el.addClass("erase"),this.currentMarker=!1},_onClickElement:function(elementView){var element=elementView.model,oldMarker=element.getMarker(),newMarker=this.currentMarker;oldMarker&&oldMarker.marker===newMarker?elementView.resetMarker():newMarker?(elementView.resetMarker(),this.editingMarker&&this.editingMarker.reset(),elementView.setMarker(newMarker,this).always(function(){this.editingMarker=null}.bind(this))):elementView.resetMarker()},_getRandomElementView:function(){this.highlightCandidates&&!_.isEmpty(this.highlightCandidates)||(this.highlightCandidates=this.children.filter(function(child){return!child.model.isPrefilled()}));var selected=_.sample(this.highlightCandidates);return this.highlightCandidates=_.without(this.highlightCandidates,selected),selected}},Obj.extend("a5.view.IMProofing"),a5.view.interaction.IMProofingBlock={init:function(model,parent){this._super(model,parent,$('<div class="contentblock"></div>')),this.model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),this.model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),this.model.isPrefilled()&&this.node.addClass("prefilled"),this.nodes=[]},add:function(child){this.nodes.push(child)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMProofingBlock"),a5.view.IMProofingToolbar={template:"a5.view.IMProofingToolbar",init:function(parameters){this.vent=parameters.vent,this.interaction=parameters.interaction,this.$el=$('<div class="toolbar"></div>'),_.bindAll(this,"_onClickCapital","_onClickSmall","_onClickAdd","_onClickDelete","_onClickSpelling","_onClickGrammar","_onClickFullstop","_onClickPara","_onClickIndent","_onClickErase"),this.$el.on("click",".btn-capital",this._onClickCapital),this.$el.on("click",".btn-small",this._onClickSmall),this.$el.on("click",".btn-add",this._onClickAdd),this.$el.on("click",".btn-delete",this._onClickDelete),this.$el.on("click",".btn-spelling",this._onClickSpelling),this.$el.on("click",".btn-grammar",this._onClickGrammar),this.$el.on("click",".btn-fullstop",this._onClickFullstop),this.$el.on("click",".btn-para",this._onClickPara),this.$el.on("click",".btn-indent",this._onClickIndent),this.$el.on("click",".btn-erase",this._onClickErase),this.vent.bind("element:signal",this._onElementSignal,this)},render:function(){var html=a5.service.templates.render(this.template);return this.$el.html(html),this.$el},_onElementSignal:function(element){this.$el.find(".highlight").removeClass("highlight");var $btn=this.$el.find(".btn-"+element.marker);$btn.addClass("highlight"),setTimeout(function(){$btn.removeClass("highlight")},a5.dp.config.IMProofingSignalDuration)},_onClickCapital:function(e){e.preventDefault(),this.vent.trigger("click:marker","capital")},_onClickSmall:function(e){e.preventDefault(),this.vent.trigger("click:marker","small")},_onClickAdd:function(e){e.preventDefault(),this.vent.trigger("click:marker","add")},_onClickDelete:function(e){e.preventDefault(),this.vent.trigger("click:marker","delete")},_onClickSpelling:function(e){e.preventDefault(),this.vent.trigger("click:marker","spelling")},_onClickGrammar:function(e){e.preventDefault(),this.vent.trigger("click:marker","grammar")},_onClickFullstop:function(e){e.preventDefault(),this.vent.trigger("click:marker","fullstop")},_onClickPara:function(e){e.preventDefault(),this.vent.trigger("click:marker","para")},_onClickIndent:function(e){e.preventDefault(),this.vent.trigger("click:marker","indent")},_onClickErase:function(e){e.preventDefault(),this.vent.trigger("click:erase")}},Obj.extend("a5.view.IMProofingToolbar"),a5.view.IMProofingErrorCounter={template:"a5.view.IMProofingErrorCounter",init:function(parameters){this.interaction=parameters.interaction,this.vent=parameters.vent,this.total=0,this.correct=0,this.$el=$('<div class="error-counter"></div>'),this.vent.bind("element:change",this._onElementChange,this),this.vent.bind("interaction:show",this._onInteractionShow,this)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html(html),this.$el},refresh:function(){this.render()},serializeData:function(){return{total:this.total,correct:this.correct}},_onElementChange:function(){this.interaction.getResultsAsync().then(function(results){this.total=results.total(),this.correct=results.correct(),this.refresh()}.bind(this))},_onInteractionShow:function(){this.interaction.getResultsAsync().then(function(results){this.total=results.total(),this.correct=results.correct(),this.refresh()}.bind(this))}},Obj.extend("a5.view.IMProofingErrorCounter"),a5.view.interaction.IMProofingElement={init:function(model,parent,vent){this.vent=vent,this._super(model,parent,$('<span class="markable"><span class="text"></span></span>')),_.bindAll(this,"_onClick"),this.model.bind("state_update:input",this.setInput,this),this.model.bind("state_update:feedback",this.setFeedback,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("change",this._onChange,this),this.model.bind("restore",this._onRestore,this),this.setInput()},render:function(){return this.node.find(".text").text(this.model.text),this.node},refresh:function(){this.render()},append:function($marker){this.node.append($marker)},getText:function(){return this.model.getText()},setText:function(text){this.node.find(".text").text(text)},setInput:function(){if(this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.model.isPrefilled()){var correct=this.model.getCorrect();return void(correct&&this.presetMarker(correct))}this.node.on("click",this._onClick),this.model.tryAgainKeep||this.model.isCorrect()?(this.resetMarker(!0),this.presetMarker(this.model.marker)):this.resetMarker()},setFeedback:function(){this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.model.isFilled()&&this.addCheck({correct:this.model.isCorrect()})},showAnswer:function(){this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.resetMarker(!0);var correct=this.model.getCorrect();correct&&this.presetMarker(correct),!this.model.isCorrect()&&this.model.needsAnswer()?this.addCheck({empty:!this.model.isFilled()}):this.model.isCorrect()&&this.addCheck({correct:!0})},updateFeedbackState:function(nodes){if(!this.model.isPrefilled()){nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct");var type;if("feedback"===this.model.state)type="checked";else{if("answers"!==this.model.state)return;type="solution"}this.model.isCorrect()?nodes.addClass([type,"correct"].join("-")):this.model.isFilled()?nodes.addClass([type,"incorrect"].join("-")):this.model.needsAnswer()&&nodes.addClass([type,"empty"].join("-"))}},getMarker:function(){return this.marker},resetMarker:function(silent){this.marker&&(this.marker.reset(),this.marker=null,silent||this.model.setMarker(!1))},setMarker:function(marker,parent){var klass="IMProofingPlacementMarker";return _.contains(["grammar","spelling","add"],marker)&&(klass="IMProofingCorrectionMarker"),this.marker=new a5.view.interaction[klass](this,marker),parent.editingMarker=this.marker,$.when(this.marker.set()).then(function(text){this.model.setMarker({marker:marker,text:text})}.bind(this),function(){this.marker.reset()}.bind(this))},presetMarker:function(marker){if(marker){var klass="IMProofingPlacementMarker";_.contains(["grammar","spelling","add"],marker.marker)&&(klass="IMProofingCorrectionMarker"),this.marker=new a5.view.interaction[klass](this,marker.marker),this.marker.preset(marker.text)}},_onChange:function(){this.vent.trigger("element:change")},_onRestore:function(){this.presetMarker(this.model.marker)},_onClick:function(e){e.preventDefault(),this.vent.trigger("click:element",this)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMProofingElement"),a5.view.interaction.IMProofingText={init:function(model,parent){this._super(model,parent,$('<span class="not-markable"></span>')),this.node.text(model.text)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMProofingText"),a5.view.interaction.IMProofingCorrectionMarker={POPUP_TEMPLATE:'<div class="editing-popup"><a href="#" class="btn-close">CLOSE</a><div class="dialog-title"><h1></h1></div><div class="dialog-content"><input type="text" autocapitalize="off" autocorrect="off" autocomplete="off"/><div class="dialog-buttons"><a class="btn-submit" href="#">OK</a></div></div></div>',init:function(target,type){this.target=target,this.type=type,this.$el=$('<div class="marker"></div>');var html=a5.service.templates.render("a5.view.im_proofing.CorrectionPopup",this.serializeData(),this.POPUP_TEMPLATE);this.$popup=$(html),this.$popup.addClass(type+"-marker-popup"),_.bindAll(this,"_onClickClose","_onClickSubmit","_onKeypress"),this.$popup.on("click",".btn-close",this._onClickClose),this.$popup.on("click",".btn-submit",this._onClickSubmit),this.$popup.on("keypress","input",this._onKeypress)},serializeData:function(){return{word:this.target.getText(),marker:this.type}},preset:function(text){this.$el.text(text),this.target.append(this.$el),this.target.node.addClass("mark-"+this.type)},set:function(){return this.deferred=$.Deferred(),this.target.parent.node.append(this.$popup),this.$popup.css(this._getPosition()),this.target.append(this.$el),this.target.node.addClass("editing"),this.target.node.addClass("mark-"+this.type),this.$popup.find("input").focus(),this.deferred.promise()},reset:function(){this.$popup.remove(),this.$el.remove(),this.target.node.removeClass("mark-"+this.type),this.target.node.removeClass("editing")},getText:function(){return this.$el.text()},setText:function(text){this.$el.text(text)},_onClickClose:function(e){e.preventDefault(),this.$popup.remove(),this.target.node.removeClass("editing"),this.deferred.reject()},_onClickSubmit:function(e){e.preventDefault(),this._submitValue(),this.$popup.remove(),this.target.node.removeClass("editing");var text=this.getText();text?this.deferred.resolve(text):this.deferred.reject()},_onKeypress:function(e){if(13===e.keyCode){this._submitValue(),this.$popup.remove(),this.target.node.removeClass("editing");var text=this.getText();text?this.deferred.resolve(text):this.deferred.reject()}},_submitValue:function(){this.setText(this.$popup.find("input").val().trim())},_getPosition:function(){var containerWidth=this.target.parent.node.width(),viewportBottom=$(window).scrollTop()+$(window).height()-a5.dp.config.exclusionBottom,wordPosition=this.target.node.offset(),pushLeft=this.target.node.position().left+this.$popup.outerWidth()-containerWidth;pushLeft=pushLeft<0?0:pushLeft;var pushUp=wordPosition.top+30+this.$popup.height()-viewportBottom;return pushUp=pushUp<0?0:this.$popup.height()+30,{left:wordPosition.left-this.target.parent.node.offset().left-pushLeft,top:wordPosition.top-this.target.parent.node.offset().top+30-pushUp}}},Obj.extend("a5.view.interaction.IMProofingCorrectionMarker"),a5.view.interaction.IMProofingPlacementMarker={init:function(target,type){this.$el=$('<div class="marker"></div>'),this.target=target,this.type=type},preset:function(){this.set()},set:function(){this.target.append(this.$el),this.target.node.addClass("mark-"+this.type)},reset:function(){this.$el.remove(),this.target.node.removeClass("mark-"+this.type)}},Obj.extend("a5.view.interaction.IMProofingPlacementMarker"),a5.views.interaction.Wordsnake={init:function(model,parent){this._super(model,parent,$('<div class="wt9"><div class="iwt9_canvas" id="IWT-'+model.interaction.index+'"></div></div>')),this._bindEvents()},_bindEvents:function(){this.model.interaction.bind("rendered",_.bind(this.drawSVG,this,this.model.interaction.index,this.model.interaction,!0)),this.model.interaction.bind("show",_.bind(this.drawSVG,this,this.model.interaction.index,this.model.interaction,!0))},drawSVG:function(index,interaction,loadBadAnswers){var self=this;if("input"==this.model.state){this.node.find("#IWT-"+index).html("");var uuid,i2,from,to,selectedWord,letters=[],pos1=null,pos2=null,foundWords=0,colors=["lightblue","lightgreen","pink","orange","brown"],colorClasses=["snk-selection-1","snk-selection-2","snk-selection-3","snk-selection-4","snk-selection-5"],t=interaction.t,firstAnswer=_.first(_(interaction.answers).values());if(!_.isUndefined(t)){var space=a5.dp.config.snakeSpace,clickableArea={width:a5.dp.config.snakeWidth,height:a5.dp.config.snakeHeight},paper=new Raphael("IWT-"+index,space*t.length,100);paper.label="IWT-"+index;for(var rPath=this._calculateRPath(a5.dp.config.snakeVerticalMax,a5.dp.config.snakeVerticalMin,a5.dp.config.snakeHorizontalSpread,space*t.length),path=paper.path("M10,10"+rPath).attr({stroke:"none"}),i=0;i<t.length;i++){var character=paper.text(path.getPointAtLength(i*space).x+clickableArea.width/2,path.getPointAtLength(i*space).y+clickableArea.height/2,t[i]).attr({font:a5.dp.config.snakeFont}),rect=paper.rect(path.getPointAtLength(i*space).x,path.getPointAtLength(i*space).y,clickableArea.width,clickableArea.height);rect.attr({fill:"red",opacity:0}),clickableArea.width*clickableArea.height==0&&(rect=character),rect.character=character,letters.push(character),character.pos=i;var angle=path.getPointAtLength(i*space).alpha;interaction.options.prefillIsFirstitem()&&i>=0&&i<firstAnswer.length?(character.attr({fill:"cyan"}),character.node.setAttribute("class","snk-selected")):(rect.click(function(){if(1==this.character.selected){var test=!0,tmp=this.character.pos;for(uuid=this.character.uuid,selectedWord="";test;)tmp>t.length-1||1!=letters[tmp].selected||letters[tmp].uuid!=uuid?test=!1:(letters[tmp].attr({fill:"black"}),letters[tmp].node.removeAttribute("class"),letters[tmp].selected=!1,letters[tmp].uuid=null,selectedWord+=letters[tmp].attrs.text,tmp++);for(test=!0,tmp=this.character.pos-1;test;)tmp<0||1!=letters[tmp].selected||letters[tmp].uuid!=uuid?test=!1:(letters[tmp].attr({fill:"black"}),letters[tmp].node.removeAttribute("class"),letters[tmp].selected=!1,letters[tmp].uuid=null,selectedWord=letters[tmp].attrs.text+selectedWord,tmp--);interaction.selections=_.filter(interaction.selections,function(item){return item[0]!=selectedWord})}else if(this.character.attr({fill:"cyan"}),this.character.node.setAttribute("class","snk-selected"),null!=pos1&&null==pos2){pos2=this.character.pos;var ok=!0;for(from=pos1,to=pos2,pos1>pos2&&(from=pos2,to=pos1),i2=from;i2<to;i2++)1==letters[i2].selected&&(ok=!1);if(ok){for(uuid=Raphael.createUUID(),selectedWord="",i2=0;i2<t.length;i2++){from=pos1,to=pos2,pos1>pos2&&(from=pos2,to=pos1);var nonAdjacentColors=self._getNonAdjacentColors(colors,from,to,letters),selectedColorIndex=colors.indexOf(nonAdjacentColors[foundWords%nonAdjacentColors.length]);i2>=from&&i2<=to&&(letters[i2].attr({fill:colors[selectedColorIndex]}),letters[i2].node.setAttribute("class",colorClasses[selectedColorIndex]),letters[i2].selected=!0,letters[i2].uuid=uuid,selectedWord+=letters[i2].attrs.text)}interaction.selections.push([selectedWord,from,colors[foundWords%colors.length],colorClasses[foundWords%colors.length]]),foundWords++}else letters[pos1].attr({fill:"black"}),letters[pos1].node.removeAttribute("class"),letters[pos2].attr({fill:"black"}),letters[pos2].node.removeAttribute("class");pos1=null,pos2=null}else null==pos1&&(pos1=this.character.pos);self.model.notifyValueChange()}),rect.hover(function(){this.attr({cursor:"pointer"})})),angle<180&&(angle+=180),rect!==character&&rect.rotate(angle),character.rotate(angle)}rect&&paper.setSize(rect.attrs.x+rect.attrs.width+10,paper.height),_.each(interaction.selections,function(val){if(1==loadBadAnswers)for(uuid=Raphael.createUUID(),i=val[1];i<val[1]+val[0].length;i++)letters[i].attr({fill:val[2]}),letters[i].node.setAttribute("class",val[3]),letters[i].selected=!0,letters[i].uuid=uuid;else if(_.include(_.values(interaction.answers),val[0]))for(uuid=Raphael.createUUID(),i=val[1];i<val[1]+val[0].length;i++)letters[i].attr({fill:val[2]}),letters[i].node.setAttribute("class",val[3]),letters[i].selected=!0,letters[i].uuid=uuid}),interaction.letters=letters,interaction.paper=paper,interaction.path=path,interaction.colors=colors,interaction.colorClasses=colorClasses,interaction.clean=!0,$("a#btn_answers").length>0&&$("a#btn_answers").is(":visible")&&!$("a#btn_answers").hasClass("inactive_button")&&self.ws.setAnswer()}}},_getNonAdjacentColors:function(colors,from,to,text){var prev,next;from>0&&(prev=text[from-1].attr("fill")),to<text.length-1&&(next=text[to+1].attr("fill"));var adjacentColors=_([prev,next]).compact();return _(colors).difference(adjacentColors)},_calculateRPath:function(y0,y1,incX,maxX){for(var path=[],i=100,j=0;i<maxX+incX;i+=incX,
j++)path.push([i,j%2?y1:y0].join(","));return"R"+path.join(" ")}},a5.views.interaction.BaseView.extend("a5.views.interaction.Wordsnake"),a5.view.IMAutocorrect={init:function(parameters){this.vent=new Obj,this.interaction=parameters.interaction,this.$el=this.interaction.$(".interaction"),this.interaction.options.scorecalculationIsOnlyCorrect()&&(this.errorCounter=new a5.view.IMAutocorrectErrorCounter({vent:this.vent,interaction:this.interaction})),this.children=[],this.interaction.bind("show",this._onInteractionShow,this,{once:!0})},render:function(){return this.errorCounter&&(this.$el.append(this.errorCounter.$el),this.errorCounter.render()),this.$el},add:function(elementView){this.children.push(elementView),elementView.bind("click:element",this._onClickElement,this),elementView.bind("element:change",this._onElementChange,this)},_onClickElement:function(elementView){this._canMark()&&elementView.setMarked()},_onElementChange:function(){this.vent.trigger("element:change")},_onInteractionShow:function(){this.vent.trigger("interaction:show",this.interaction)},_canMark:function(){if(this.interaction.options.scorecalculationIsSubtractIncorrect())return!0;var total=0,filled=0;return _.each(this.children,function(elementView){var model=elementView.model;model.needsAnswer()&&total++,model.isFilled()&&filled++}),filled<total}},Obj.extend("a5.view.IMAutocorrect"),a5.view.interaction.IMAutocorrectBlock={init:function(model,parent){this._super(model,parent,$('<div class="contentblock"></div>')),this.model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),this.model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),this.model.isPrefilled()&&this.node.addClass("prefilled"),this.nodes=[]},add:function(child){this.nodes.push(child)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMAutocorrectBlock"),a5.view.interaction.IMAutocorrectElement={init:function(model,parent){this._super(model,parent,$('<span class="markable"><span class="text"></span></span>')),_.bindAll(this,"_onClick"),this.model.bind("state_update:input",this.setInput,this),this.model.bind("state_update:feedback",this.setFeedback,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("input_update:setAnswer",this.checkAnswerInput,this),this.model.bind("change",this._onChange,this),this.model.bind("restore",this._onRestore,this),this.setInput()},render:function(){return this.node.find(".text").text(this.model.text),this.node},refresh:function(){this.render()},setText:function(text){this.node.find(".text").text(text)},setInput:function(){if(this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.model.isPrefilled()){return void(this.model.getCorrect()&&this.setMarked(!0))}this.node.on("click",this._onClick),this.model.tryAgainKeep||this.model.isCorrect()||this.resetMarked()},setFeedback:function(){this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.model.isFilled()&&this.addCheck({correct:this.model.isCorrect()})},checkAnswerInput:function(){this.node.find(".check").remove(),this.model.isFilled()&&(this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))},showAnswer:function(){this.node.find(".check").remove(),this.node.off("click"),this.updateFeedbackState(this.node),this.resetMarked(!0),this.model.getCorrect()&&this.setMarked(!0),!this.model.isCorrect()&&this.model.needsAnswer()?this.addCheck({empty:!this.model.isFilled()}):this.model.isCorrect()&&this.addCheck({correct:!0})},updateFeedbackState:function(nodes){if(!this.model.isPrefilled()){nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct");var type;if("feedback"===this.model.state)type="checked";else{if("answers"!==this.model.state)return;type="solution"}this.model.isCorrect()?nodes.addClass([type,"correct"].join("-")):this.model.isFilled()?nodes.addClass([type,"incorrect"].join("-")):this.model.needsAnswer()&&nodes.addClass([type,"empty"].join("-"))}},resetMarked:function(silent){this.node.removeClass("marked"),this.node.removeClass("correct incorrect"),this.setText(this.model.text),silent||this.model.unsetMarked()},setMarked:function(silent){this.node.addClass("marked"),this.model.needsAnswer()?(this.node.addClass("correct"),this.setText(this.model.correctText)):(this.node.addClass("incorrect"),this.setText(this.model.text)),silent||this.model.setMarked()},_onChange:function(){this.trigger("element:change",this)},_onRestore:function(){this.setMarked(!0)},_onClick:function(e){e.preventDefault(),this.trigger("click:element",this)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMAutocorrectElement"),a5.view.interaction.IMAutocorrectText={init:function(model,parent){this._super(model,parent,$('<span class="not-markable"></span>')),this.node.text(model.text)}},a5.views.interaction.BaseView.extend("a5.view.interaction.IMAutocorrectText"),a5.view.IMAutocorrectErrorCounter={template:"a5.view.IMAutocorrectErrorCounter",init:function(parameters){this.interaction=parameters.interaction,this.vent=parameters.vent,this.total=0,this.correct=0,this.$el=$('<div class="error-counter"></div>'),this.vent.bind("element:change",this._onElementChange,this),this.vent.bind("interaction:show",this._onInteractionShow,this)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html(html),this.$el},refresh:function(){this.render()},serializeData:function(){return{total:this.total,correct:this.correct}},_onElementChange:function(){this.interaction.getResultsAsync().then(function(results){this.total=results.total(),this.correct=results.correct(),this.refresh()}.bind(this))},_onInteractionShow:function(){this.interaction.getResultsAsync().then(function(results){this.total=results.total(),this.correct=results.correct(),this.refresh()}.bind(this))}},Obj.extend("a5.view.IMAutocorrectErrorCounter"),a5.views.interaction.ISCheckboxView={template:"a5.view.interaction.ISCheckbox",init:function(model,prefill,hideCheckboxes,showInColumns,label,isVisible,cblock,interaction){this.showInColumns=showInColumns,this._super(model,prefill,hideCheckboxes),showInColumns&&(this.label=new a5.views.interaction.ISCheckboxLabel(label)),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this._onDisplayAnswer,this),this.model.bind("state_update:input",this.setInput,this),this.model.bind("max-selections",this.setMaxSelections,this),this.model.bind("next_answer",this.onNextAnswer,this),this.$contentblock=cblock,this.updateVisuals(isVisible,interaction),this._addInteractionEvents(interaction)},createViewFor:function(model){return new a5.views.interaction.ISCheckboxChoiceView(model,this.showInColumns,this)},render:function(){return this._super(),this.showInColumns&&(_.first(this.children).node.before(this.label.$node),this.label.render(),this.node.addClass("checkbox-show-in-columns")),this.prefill&&!this.model.allowSelectAll&&this.node.addClass("no-more-choices"),this.node},_addInteractionEvents:function(interaction){interaction&&(interaction.bind("attemptsChanged",_.bind(this._onAttemptsChanged,this)),interaction.bind("restored",_.bind(this._onInteractionRestored,this)))},_onAttemptsChanged:function(attempts){this.model.attempts=attempts.checkAttempts},_onInteractionRestored:function(interaction){this.model.attempts>0&&this._onDisplayAnswer()},_onDisplayAnswer:function(){this.$contentblock.removeClass("contentblock--hidden")},updateVisuals:function(isVisible,interaction){if(this.model.isDisplayActive()){var question=this.$contentblock.find("p").first(),wrapperQuestion=question.parent();question.addClass("expandable-question"),question.addClass("expandableQuestion__title"),wrapperQuestion.addClass("has-expandable-question"),wrapperQuestion.addClass("expandableQuestion"),question.prepend(question.siblings("span.enum")),this.setActive(question,isVisible,wrapperQuestion,"expandableQuestion--active",!0,!0),question.on("click",_.bind(function(){var isActive=question.hasClass("active");!isActive&&interaction&&interaction.contentWrap.find(".expandable-question.active").click(),this.setActive(question,!isActive,wrapperQuestion,"expandableQuestion--active",!0,!0)},this))}(this.model.isDisplayShowNext()||this.model.isDisplayShowNextHidePrev())&&this.setActive(this.$contentblock,isVisible,this.$contentblock,"contentblock--hidden",!1,!0),this.model.isDisplayAll()&&(this.setActive(this.$contentblock,isVisible),this.$contentblock.on("click focus",_.bind(function(){this.setActive(this.$contentblock.siblings(".active"),!1),this.setActive(this.$contentblock,!0)},this)))},setActive:function($activeNode,isActive,$displayNode,className,classIsShown,hideInactive){$activeNode.toggleClass("active",isActive),$displayNode&&(isActive?className?$displayNode.toggleClass(className,classIsShown):$displayNode.show(isActive):hideInactive&&(className?$displayNode.toggleClass(className,!classIsShown):$displayNode.hide(isActive)))},setAnswer:function(){("Exam"===LOInfo.mode||"Trainer"===LOInfo.mode)&&this.model.totalSelected()<this.model.totalCorrect()&&this.addCheck({correct:!1}),this._onDisplayAnswer()},setInput:function(){this.removeCheck(!0),this._onDisplayAnswer()},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},setMaxSelections:function(maxSelected){if(this.node.toggleClass("no-more-choices",maxSelected&&!this.model.allowSelectAll),maxSelected&&this.$contentblock.next(".contentblock").length&&this._displayShowHideBehavior()){var $nCBlock=this.$contentblock.next(".contentblock");this.setActive($nCBlock,!0,$nCBlock,"contentblock--hidden",!1,!0),this.setActive(this.$contentblock,!1,this.$contentblock,"contentblock--hidden",!1,this.model.isDisplayShowNextHidePrev())}},_displayShowHideBehavior:function(){return(this.model.isDisplayShowNext()||this.model.isDisplayShowNextHidePrev())&&0===this.model.attempts}},a5.views.Checkbox.extend("a5.views.interaction.ISCheckboxView"),a5.views.interaction.ISCheckboxChoiceView={contentTemplate:"a5.view.interaction.ISCheckboxChoice",template:"a5.view.interaction.ISCheckboxChoiceWrapper",init:function(model,showInColumns,parent){this.showInColumns=showInColumns,this._super(model,parent),showInColumns||this.contentNode.find(".is-checkbox-choice-text").append(model.content.contents()),model.enumeration&&(this.contentNode.prepend('<span class="enum-placeholder"></span>'),model.enumeration.then(function(enumSymbol){this.contentNode.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this))),model.hasCheckbox?this.addInput():this.node.addClass("input-noradio"),this.model.prefill&&(this.disable(),this.model.hasCorrectAnswer()&&this.select(!0),this.node.addClass("prefill")),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.tryAgain,this),this.model.bind("clear",this.onClear,this),this.model.bind("change",this.onChange,this),this.model.bind("next_answer",this.onNextAnswer,this),this.model.parent.bind("state_update",this.onStateUpdate,this),this.updateSelected()},render:function(){return this._super(),this.showInColumns&&this.node.wrapInner("<div class='input-wrapper'></div>"),this.node},select:function(silent){this._super(),this.node.addClass("input-checkbox-checked"),silent||this.model.select(),this.input?this.input.attr("checked",!0):this.model.isSelectedAnswer()&&this.node.addClass("clickedanswer")},unselect:function(silent){this._super(),this.input&&this.input.attr("checked",!1),this.node.removeClass("clickedanswer"),this.node.removeClass("input-checkbox-checked"),silent||this.model.unselect()},disable:function(){this._super(),this.input&&this.input.attr("disabled",!0)},enable:function(){this._super(),this.input&&this.input.attr("disabled",!1)},onNextAnswer:function(){this.updateFeedbackState()},onChange:function(){this.updateSelected()},onStateUpdate:function(){this.updateFeedbackState(),this.updateSelected()},onClear:function(){this.removeCheck(!0),this.clearFeedbackState()},onMouseOver:function(e){this._super(),this.node.addClass("input-checkbox-hover"),this.input||this.node.addClass("input-noradio-hover")},onMouseOut:function(e){this._super(),this.node.removeClass("input-checkbox-hover"),this.node.removeClass("input-noradio-hover")},setAnswer:function(){if(!this.model.prefill){var tooltip=this._getFeedbackForTooltip();this.removeCheck(!0),this.node.toggleClass("has-feedback",!!tooltip),this.model.isRevealedBySeeNext()?this.addCheck({correct:!1,tooltip:tooltip,parent:this.node.find(".input-wrapper").length?this.node.find(".input-wrapper"):this.node}):this.model.selected&&(this.addCheck({correct:this.model.isCorrect(),tooltip:tooltip,correctTooltip:!0,parent:this.node.find(".input-wrapper").length?this.node.find(".input-wrapper"):this.node}),_.defer(_.bind(this.bindAnswerFeedback,this,this.model)))}if(!this.showInColumns){var check=this.node.find(".check");check.css("position","static"),check.prependTo(check.parent())}},showAnswer:function(){if(!this.model.prefill){var tooltip=this._getFeedbackForTooltip();this.removeCheck(!0),this.node.toggleClass("has-feedback",!!tooltip),this.model.isRevealedBySeeNext()?"input"===this.model.parent.state?this.addCheck({empty:!0,tooltip:tooltip,state:"answers",parent:this.node.find(".input-wrapper").length?this.node.find(".input-wrapper"):this.node}):this.addCheck({correct:!1,tooltip:tooltip,state:"answers",parent:this.node.find(".input-wrapper").length?this.node.find(".input-wrapper"):this.node}):(this.model.correct&&!this.model.selected&&this.addCheck({empty:!0,tooltip:tooltip,state:"answers",parent:this.node.find(".input-wrapper").length?this.node.find(".input-wrapper"):this.node}),!this.model.correct&&this.model.selected&&this.addCheck({correct:!1,tooltip:tooltip,state:"answers",parent:this.node.find(".input-wrapper").length?this.node.find(".input-wrapper"):this.node}),this.model.correct&&this.model.selected&&this.addCheck({correct:!0,tooltip:tooltip,correctTooltip:!0,state:"answers",parent:this.node.find(".input-wrapper").length?this.node.find(".input-wrapper"):this.node}))}if(!this.showInColumns){var check=this.node.find(".check");check.css("position","static"),check.prependTo(check.parent())}this.updateSelected()},tryAgain:function(){this.node.removeClass("has-feedback"),this.removeCheck(!0)},updateSelected:function(){if(!this.model.prefill)return this.model.isRevealed()?(this.disable(),void this.select(!0)):(this.model.isSelectedAnswer()?this.select(!0):this.unselect(!0),this.disable(),"input"===this.model.parent.state&&"answers"!==this.model.state&&(this.model.tryAgainIsFrozen&&this.isLocked()||this.enable()),"answers"!==this.model.parent.state&&"answers"!==this.model.state||this.model.hasCorrectAnswer()&&this.select(!0),this)},clearFeedbackState:function(){this.node.removeClass("checked-empty checked-incorrect checked-correct"),this.node.removeClass("solution-empty solution-incorrect solution-correct solution-revealed")},updateFeedbackState:function(){if(this.checkLocked(),this.clearFeedbackState(),this.model.isRevealedBySeeNext())return void this.node.addClass("solution-revealed");"feedback"===this.model.parent.state?this.model.isCorrect()?this.node.addClass("checked-correct"):this.model.selected?this.node.addClass("checked-incorrect"):this.node.addClass("checked-empty"):"answers"===this.model.parent.state&&(this.model.correct==this.model.selected?this.node.addClass("solution-correct"):(this.node.addClass("solution-incorrect"),this.model.selected||this.node.addClass("solution-empty")))},_getFeedbackForTooltip:function(){return this.model.answerFeedback||this.model.parent.getAnswerFeedback()}},a5.views.CheckboxChoiceView.extend("a5.views.interaction.ISCheckboxChoiceView"),a5.views.interaction.ISCheckboxLabel={init:function(label){this.$node=$("<div class='checkbox-column-label'></div>").append(label)},render:function(){return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCheckboxLabel"),a5.views.interaction.ISCheckboxHeader={init:function(answers){this.$node=$("<div class='checkbox-column-header'><div class='header-spacer'></div></div>"),this.answers=answers},render:function(){for(var i=0;i<this.answers.length;i++){var $answerCell=$("<div class='answer-cell'></div>").append(this.answers[i]);this.$node.append($answerCell)}return this.$node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISCheckboxHeader"),a5.view.interaction.ICExtendedWriting={init:function(model,parent,node,interaction){this._super(model,parent,node),_.bindAll(this,"initGaps","onInteractionReady","onModelChange"),this.interaction=interaction,interaction.dataObj||(interaction.dataObj={sectionHash:{},sectionCount:0,sections:[],supergapCount:0,gapCount:0,cks:[]},interaction.onInteractionReadyListeners.register(this.onInteractionReady)),this.startCKEIndex=interaction.dataObj.supergapCount,this.startGapIndex=interaction.dataObj.gapCount;var txt=this.node.html(),res=txt.match(/\*([\s\S\w\W]*?)\*/g);if(null!=res){var name,token=res[0],sectionName=token.replace(/\*/g,"");void 0===interaction.dataObj.sectionHash[sectionName]&&(name="sect-"+ ++this.interaction.dataObj.sectionCount,interaction.dataObj.sectionHash[sectionName]=name,interaction.dataObj.sections.push(sectionName)),_.isUndefined(interaction.sections)&&(interaction.sections=[]),interaction.sections.push(interaction.dataObj.sectionHash[sectionName]),txt=txt.replace(token,""),txt=this.replaceGaps(txt),this.node.html(txt),this.endCKEIndex=interaction.dataObj.supergapCount,this.endGapIndex=interaction.dataObj.gapCount,interaction.onInteractionReadyListeners.register(this.initGaps),interaction.bind("reset",this.onInteractionReset,this,{once:!0})}},replaceGaps:function(txt){return _.each(txt.match(/\[(.*?)\]/g),function(res){var params=res.split("@"),content=res.replace(/\*/g,"");content=content.replace(/@(.+)@/g,""),content=content.substring(1,content.length-1);var options={maxLength:this.interaction.options.getMaxLength(),maxType:this.interaction.options.get("120"),autogrow:this.interaction.options.textboxAutogrowIsOn(),hasMaxLength:!this.interaction.options.maxLengthIsFalse(),width:"100%",height:"40px"};3===params.length&&_.extend(options,this._extractOptions(params[1]));var input;input="auto"!==options.height?0==res.indexOf("[***")?this._createRichTextArea(options,content):this._createTextArea(options,content):this._createTextInput(options,content),txt=txt.replace(res,input)},this),txt},_extractOptions:function(sizeOpt){var maxStr,options={},size=sizeOpt.split(":");return 1===size.length?(options.width=this._addPxIfNeeded(size[0]),options.height="auto"):2===size.length?(options.width=this._addPxIfNeeded(size[0]),size[1].indexOf("chars")>0||size[1].indexOf("words")>0?(maxStr=size[1].split(" "),options.maxLength=parseInt(maxStr[0],10),options.maxType=maxStr[1],options.height="auto"):options.height=this._addPxIfNeeded(size[1])):3===size.length&&(options.width=this._addPxIfNeeded(size[0]),options.height=this._addPxIfNeeded(size[1]),maxStr=size[2].split(" "),options.maxLength=parseInt(maxStr[0],10),options.maxType=maxStr[1]),options},_addPxIfNeeded:function(val){return-1===val.indexOf("px")&&-1===val.indexOf("%")?val+"px":val},_createTextInput:function(options,content){var maxTypeStr="";options.hasMaxLength&&(maxTypeStr=("chars"===options.maxType?"maxchars":"maxwords")+'="'+options.maxLength+'"');var id="fwti-"+this.interaction.dataObj.gapCount++;return _.str.sprintf('<input type="text" id="%s" style="width:%s;" %s value="%s"></input>',id,options.width,maxTypeStr,content)},_createTextArea:function(options,content){var maxTypeStr="";options.hasMaxLength&&(maxTypeStr=("chars"===options.maxType?"maxchars":"maxwords")+'="'+options.maxLength+'"');var id="fwta-"+this.interaction.dataObj.gapCount++;return _.str.sprintf('<textarea class="plain-editor" id="%s" style="width:%s;height:%s;" %s>%s</textarea>',id,options.width,options.height,maxTypeStr,content)},_createRichTextArea:function(options,content){var id="editor_"+this.interaction._uid+"_"+this.interaction.dataObj.supergapCount++,config={width:options.width,height:options.height,toolbar:[["Bold","Italic","Superscript","Subscript","-","NumberedList","BulletedList","-","Link","Unlink"]],customConfig:"",stylesSet:[]};return options.autogrow?(config.autoGrow_minHeight=50|config.height,config.extraPlugins="autogrow"):(config.resize_enabled=!0,config.resize_dir="both",config.removePlugins="autogrow"),options.hasMaxLength&&(config.MaxLength=options.maxLength,config.MaxLengthType=options.maxType,config.EditorName="cke_"+id),this.interaction.dataObj.cks.push([id,config]),_.str.sprintf('<textarea name="%s" id="%s">%s</textarea>',id,id,content)},insertMenu:function(parent){var tmpl=window.a5.mainBuilder.layout.getTemplate("writing"),subTmpl=window.a5.mainBuilder.layout.getSubpart(tmpl,"writing-item-button"),subTmplAll=window.a5.mainBuilder.layout.getSubpart(tmpl,"writing-item-button-all"),items=[];_.each(this.interaction.dataObj.sections,function(sectionName,index){var btn=subTmpl.replace("##label##",sectionName);btn=btn.replace("##class##","elem-"+index),items.push(btn)}),items.push(subTmplAll),tmpl=window.a5.mainBuilder.layout.replaceSubpart(tmpl,"writing-item-button",items.join("")),tmpl=window.a5.mainBuilder.layout.replaceSubpart(tmpl,"writing-item-button-all","");var html=this.node.html();this.node.empty(),tmpl=tmpl.replace("##right_col##",html),this.node.append(tmpl)},initGaps:function(){for(var dataObj=this.interaction.dataObj,i=this.startCKEIndex;i<this.endCKEIndex;i++){var editorName=dataObj.cks[i][0];window.CKEDITOR.replace(editorName,dataObj.cks[i][1]);var cke_instance=window.CKEDITOR.instances[editorName];cke_instance.on("key",a5.utils.checkCKLength),cke_instance.on("paste",a5.utils.checkCKLength),cke_instance.on("blur",a5.utils.hideMaxCharsLabel),cke_instance.on("change",this.onCKEChange.bind(this,editorName,cke_instance))}for(i=this.startGapIndex;i<this.endGapIndex;i++){var $gap=this.node.find("textarea,input[type=text]").eq(i),name=$gap.attr("id");$gap.on("blur keyup paste",this.onTextareaChange.bind(this,name,$gap))}this.model.bind("change",this.onModelChange)},onCKEChange:function(name,cke){this.model.updateCKEditor(name,cke.getData())},onTextareaChange:function(name,$gap){this.model.updateTextgap(name,$gap.val())},onModelChange:function(){_.each(this.model.ckes,function(value,name){window.CKEDITOR.instances[name].setData(value)}),_.each(this.model.textgaps,function(value,name){this.$("#"+name).val(value)},this)},attachEvents:function(){var self=this;_.each(this.$(".right_col .contentblock"),function(el,index){$(el).addClass(self.interaction.sections[index])}),this.$(".fw_nav  a").unbind("click"),this.$(".fw_nav  a").click(function(e){e.preventDefault(),$(this).toggleClass("fw_nav_selected");var index=$(this).parent().index();if(index==self.interaction.dataObj.sections.length)_.each(self.interaction.dataObj.sections,function(sectionName){self.$("."+self.interaction.dataObj.sectionHash[sectionName]).show()});else{self.$("."+self.interaction.dataObj.sectionHash[self.interaction.dataObj.sections[index]]).toggle()}self.updateMenu(self.$(".fw_nav"))}),a5.utils.setTextAreaMaxlength(this.interaction.contentWrap)},updateMenu:function(btn){var self=this,visCount=0;_.each(this.interaction.dataObj.sections,function(sectionName,index){"none"==this.$("."+self.interaction.dataObj.sectionHash[sectionName]).css("display")?$(btn).find(".elem-"+index).removeClass("fw_nav_selected"):(visCount++,$(btn).find(".elem-"+index).addClass("fw_nav_selected"))},this),visCount==this.interaction.dataObj.sections.length?$(btn).find(".all").addClass("fw_nav_selected"):$(btn).find(".all").removeClass("fw_nav_selected")},onInteractionReady:function(){this.insertMenu(),this.attachEvents()},onInteractionReset:function(){delete this.interaction.dataObj}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICExtendedWriting"),a5.views.interaction.ICTextGap={TEXT_PLACEHOLDER:"_",init:function(model,parent){this._super(model,parent,$('<div class="input-text"></div>')),this.pool_word=this._getPoolWord(),this.model.prefill?(this.node.append('<div class="prefill">'+this.model.getCorrect()+"</div>"),$(this.pool_word).addClass("prefill"),this.model.area&&this.node.children(".prefill").css({width:this.model.area[0],height:this.model.area[1]})):(this.model.area?(this.node.addClass("has-textarea"),this.input=this._createTextArea()):(this.node.addClass("has-input"),this.input=this._createTextInput()),this.node.append(this.input),this.bindEvents(),this._canShowCharactersInGap()&&(this.node.addClass("characters-in-gap"),this._initCharactersInGap())),this.model.enumeration&&(this.model.global_enumeration&&!this.model.charactersNumber&&a5.dp.config.continuousEnumerationInsideGaps?this.show_global_enumeration(!0):(this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this)))),this.model.isDistractor()&&this.node.addClass("distractor-gap")},inputValue:function(){return!this.input||this.input.is(".continuous-enumeration")?"":this.model.charactersNumber&&""===this.input.val().replace(new RegExp(this.TEXT_PLACEHOLDER,"g"),"").trim()?"":this.input.val()},bindEvents:function(){_.bindAll(this,"onInputChange","onInputClick","onInputFocus","onInputBlur","onInputMouseOver","onInputMouseOut","onWindowResize"),this.input.on("change input",this.onInputChange),this.input.on("click",this.onInputClick),this.input.on("focus",this.onInputFocus),this.input.on("blur",this.onInputBlur),this.input.on("mouseover",this.onInputMouseOver),this.input.on("mouseout",this.onInputMouseOut),this.onWindowResizeThrottled=_.throttle(this.onWindowResize,300),this._bindResize(),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("state_update:input",this.onStateInput,this),this.model.bind("state_update:feedback",this.onStateFeedback,this),this.model.bind("state_update:answers",this.onStateAnswers,this),this.model.bind("input_update:setAnswer",this.onStateInputFeedback,this),this.model.bind("next_answer",this.onNextAnswer,this)},onInputChange:function(e){this.model.setValue(this.inputValue()),this._setFilled(),this.adjustGapSizeAfterEvent("input:change")},onInputClick:function(e){},onInputFocus:function(e){this.node.addClass("focused"),this._unbindResize();var originalWidth=this.originalInput&&this._getMaxWidthFor(this.originalInput)||0;this.initialWidth=_.min([this.input.width(),originalWidth]),this.adjustGapSizeAfterEvent("input:focus")},onInputBlur:function(e){this.node.removeClass("focused mouseover"),this._bindResize(),this.adjustGapSizeAfterEvent("input:blur")},onInputMouseOver:function(e){this.node.addClass("mouseover")},onInputMouseOut:function(e){this.node.removeClass("mouseover")},onWindowResize:function(e){this.adjustGapSizeAfterEvent("window:resize")},onInteractionShow:function(){this.adjustGapSizeAfterEvent("interaction:show")},onStateUpdate:function(){this.adjustGapSizeAfterEvent("model:state_update")},onStateInput:function(){this.setInput()},onStateFeedback:function(){this.setAnswer()},onStateAnswers:function(){this.showAnswer(),this.adjustGapSizeAfterEvent("model:state_update:answers")},onStateInputFeedback:function(){this.setAnswerInput()},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},show_global_enumeration:function(bind_events){""!=this.inputValue()||this.model.charactersNumber||this.model.enumeration.then(function(enumSymbol){var enumText=a5.utils.enumText(this.model.enumSymbol);this.input.addClass("continuous-enumeration"),this.input.attr("id","enumeration-"+enumText),this.input.val(enumText)}.bind(this)),bind_events&&(this.input.on("focus",_.bind(this.hide_global_enumeration,this)),this.input.on("blur",_.bind(this.show_global_enumeration,this)))},hide_global_enumeration:function(){""!=this.inputValue()||this.model.charactersNumber||(this.input.removeClass("continuous-enumeration"),this.input.val(""))},setInput:function(){this.model.prefill||(this.model.isCorrectable()&&this.updateFeedbackState(this.node),this.input.val(this.model.value),this._canShowCharactersInGap()&&this._initCharactersInGap(),this.node.find(".check").remove(),this.input.attr("disabled",this.isLocked()),this.model.enumeration&&this.model.global_enumeration&&a5.dp.config.continuousEnumerationInsideGaps&&this.show_global_enumeration(),this.model.isFilled()||this.node.removeClass("filled"))},setAnswer:function(){if(!this.model.prefill){this.input.attr("disabled",!0),this.model.isRevealed()||this.input.val(this.model.value);var setCheck=this.model.isCorrectable();this.setAnswerCheck(setCheck)}},setAnswerInput:function(){if(!this.model.prefill){var setCheck=this.model.isCorrectable()&&this.model.isFilled();this.setAnswerCheck(setCheck),this.updateAnswerInputState(setCheck)}},setAnswerCheck:function(check){this.node.find(".check").remove(),check&&(this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))},showAnswer:function(){if(!this.model.prefill&&(this.input.attr("disabled",!0),this.input.val(this.model.value),this.node.find(".check").remove(),this.model.isCorrectable())){this.updateFeedbackState(this.node);var correct=this.model.getCorrect();this.input.val(correct),this.node.addClass("filled"),this.model.isCorrect()?this.model.isCorrect()&&this.addCheck({correct:!0,tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getAnswerFeedback():this.model.value}):this.addCheck({empty:!this.model.isFilled(),tooltip:a5.dp.config.displayFeedbackAfterSeeAnswer?this.model.getAnswerFeedback():this.model.value}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})}},updateFeedbackState:function(nodes){nodes.removeClass("input-checked-correct input-checked-incorrect input-checked-empty"),this._super(nodes)},updateAnswerInputState:function(check){check&&(this.model.isCorrect()?this.node.addClass("input-checked-correct"):this.model.isFilled()?this.node.addClass("input-checked-incorrect"):this.node.addClass("input-checked-empty"))},adjustGapSize:function(){if(this.inputValue()){var textWidth=this.input.textWidth();this.input.width(textWidth)}else this.adjustGapSizeToOriginal()},adjustGapSizeOnInput:function(){if(this.inputValue()){var textWidth=this.input.textWidth();textWidth>this.initialWidth||this.model.charactersNumber?this.input.width(textWidth):this.input.width(this.initialWidth)}else this.initialWidth=this.originalInput&&this._getMaxWidthFor(this.originalInput)||0,this.adjustGapSizeToOriginal()},adjustGapSizeAfterEvent:function(eventType){if(this.model.resizeGaps)return void("input:change"===eventType?this.adjustGapSizeOnInput():this.adjustGapSize());this.adjustGapSizeToOriginal()},adjustGapSizeToOriginal:function(){if(this.originalInput){var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)}},adjustGapSizeToLongestResponse:function(response){if(this.originalInput={answer:response.answer,width:response.width},/[\s;]*width:/gi.test(this.model.inputStyle))return void _.extend(this.originalInput,{width:this.input.width()});var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)},adjustGapSizeToLongestCorrect:function(response){if(this.originalInput={answer:response.answer,width:response.width},/[\s;]*width:/gi.test(this.model.inputStyle))return void _.extend(this.originalInput,{width:this.input.width()});var width=this._getMaxWidthFor(this.originalInput);this.input.width(width)},_createTextArea:function(){
var $textarea=$("<textarea></textarea>");return $textarea.attr("style",this.model.inputStyle),$textarea.css({width:this.model.area[0],height:this.model.area[1]}),$textarea.attr("spellcheck",this.model.spellcheck),$textarea.attr("autocapitalize","off"),$textarea.attr("autocorrect","off"),$textarea.attr("aria-label","Blank input"),$textarea},_createTextInput:function(){var correct_and_distractors=_(this.model.correct).without("%0").concat(this.model.distractors),$input=this.model.charactersNumber||_.isEmpty(correct_and_distractors)||!_.all(correct_and_distractors,a5.utils.isInteger)?$('<input type="text" />'):$('<input type="number" />');return $input.attr("size",this.model.length),$input.attr("style",this.model.inputStyle),$input.attr("spellcheck",this.model.spellcheck),$input.attr("autocapitalize","off"),$input.attr("autocorrect","off"),$input.attr("autocomplete",$("body").is(".isChrome")?"none":"off"),$input.attr("aria-label","Blank input"),$input},_canShowCharactersInGap:function(){return!this.model.prefill&&!this.model.isDistractor()&&this.model.charactersNumber&&this.model.getMaskPattern().trim()},_initCharactersInGap:function(){$.mask.definitions={"*":new RegExp("[^\\s"+this.TEXT_PLACEHOLDER+"]")},this.input.mask(this.model.getMaskPattern(),{autoclear:!1,allowpartial:!0,onInput:this.onInputChange}),this.input.attr("placeholder",this.model.getMaskPattern().replace(/\*/g,this.TEXT_PLACEHOLDER))},_getMaxWidthFor:function(response){if(/[\s;]*width:/gi.test(this.model.inputStyle))return response.width;var width=this.input.textWidth(response.answer);if(this.model.charactersNumber)if(0===response.width)width=this.input.textWidth(this.TEXT_PLACEHOLDER);else{var placeholderText=response.answer.replace(/\S/g,this.TEXT_PLACEHOLDER);width=this.input.textWidth(placeholderText)}return width},_setFilled:function(){this.model.isFilled()?(this.node.addClass("filled"),this.pool_word&&$(this.pool_word).addClass("gap-filled")):(this.pool_word&&$(this.pool_word).removeClass("gap-filled"),this.node.removeClass("filled"))},_getPoolWord:function(){var result,pool_words;return this.model.display_words.length>0&&this.model.wordpool?(pool_words=this.model.wordpool.pool.find(".static_word").not(".display-word"),result=_.find(pool_words,function(word){return _.contains(this.model.display_words,$(word).text())},this),$(result).addClass("display-word")):this.model.wordpool&&(pool_words=this.model.wordpool.pool.find(".static_word"),result=_.find(pool_words,function(word){return _.contains(this.model.correct,$(word).text())},this)),result},_bindResize:function(){$(window).on("resize",this.onWindowResizeThrottled)},_unbindResize:function(){$(window).off("resize",this.onWindowResizeThrottled)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGap"),a5.views.interaction.ICMath={init:function(model,parent,interaction,options){this._super(model,parent,$('<div class="input-text"></div>')),this.options=options,this.node.addClass("has-input"),this.input=$('<input type="text" />'),this.input.attr("autocorrect","off"),this.input.attr("style",this.model.inputStyle),this.node.append(this.input),this.bindEvents(interaction),this.model.enumeration&&!this.model.global_enumeration&&(this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this)))},inputValue:function(){return this.hasContinuousEnumeration()?"":this.input.val().trim()},addContinuousEnumeration:function(){this.__continous_enumeration=!0,this.input.addClass("continuous-enumeration")},removeContinuousEnumeration:function(){this.__continous_enumeration=!1,this.input.removeClass("continuous-enumeration")},hasContinuousEnumeration:function(){return this.__continous_enumeration},bindEvents:function(interaction){_.bindAll(this,"_onFocus","_onBlur","_onMouseover","_onMouseout","_onChange","_onFocusGlobalEnumeration","_onBlurGlobalEnumeration","_onInputState","_onSetAnswerState","_onShowAnswerState","_onShowInteraction"),this.input.on("focus",this._onFocus),this.input.on("blur",this._onBlur),this.input.on("mouseover",this._onMouseover),this.input.on("mouseout",this._onMouseout),this.input.on("change",this._onChange),this.input.on("input",this._onChange),this.model.enumeration&&this.model.global_enumeration&&(this.input.on("focus",this._onFocusGlobalEnumeration),this.input.on("blur",this._onBlurGlobalEnumeration),this.model.enumeration.then(function(enumSymbol){this.input.attr("id","enumeration-"+a5.utils.enumText(enumSymbol))}.bind(this)),this._onBlurGlobalEnumeration()),this.model.bind("state_update:input",this._onInputState),this.model.bind("state_update:feedback",this._onSetAnswerState),this.model.bind("state_update:answers",this._onShowAnswerState),0===this.options.index&&a5.dp.config.ICTextgapActive&&interaction.bind("show:deferred",this._onShowInteraction)},checkLocked:function(nodes){this.lastState!==this.model.state&&(this._super(nodes),this.lastState=this.model.state)},_onShowInteraction:function(){this.input.focus()},_onFocus:function(){this.node.addClass("focused")},_onBlur:function(){this.node.removeClass("focused"),this.node.removeClass("mouseover"),this.resizeGaps()},_onMouseover:function(){this.node.addClass("mouseover")},_onMouseout:function(){this.node.removeClass("mouseover")},_onChange:function(){this.model.setValue(this.inputValue()),this.node.toggleClass("filled",this.model.isFilled()),requestAnimationFrame(_.bind(function(){this.resizeGaps()},this))},_onBlurGlobalEnumeration:function(){""===this.inputValue()&&(this.addContinuousEnumeration(),this.model.enumeration.then(function(enumSymbol){this.input.val(enumSymbol)}.bind(this)))},_onFocusGlobalEnumeration:function(){""===this.inputValue()&&(this.removeContinuousEnumeration(),this.model.enumeration.then(function(enumSymbol){this.input.val("")}.bind(this)))},_onInputState:function(){this.model.prefill||(this.updateFeedbackState(this.node),this._onStateChange({disable:this.isLocked(),value:this.model.value}),this.model.enumeration&&this.model.global_enumeration&&this._onBlurGlobalEnumeration(),this.node.toggleClass("filled",this.model.isFilled()))},_onSetAnswerState:function(){this.model.prefill||(this._onStateChange({disable:!0,value:this.model.value}),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}))},_onShowAnswerState:function(){!this.model.prefill&&this.model.parent.showAnswers()&&(this.updateFeedbackState(this.node),this._onStateChange({disable:!0,value:this.model.getCorrect()}),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.value,empty:!this.model.isFilled()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()}),this.model.resizeGaps&&this.adjustGapSize(!0))},_onStateChange:function(opts){this.input.attr("disabled",opts.disable),this.input.val(opts.value),this.node.find(".check").remove(),this.resizeGaps(),this.updateFeedbackState(this.node)},resizeGaps:function(){this.options.resize&&(this.inputValue()?this.adjustGapSize(!0):this.adjustGapSizeToDefault())},adjustGapSize:function(force){var width=this.input.textWidth(),lastWidth=this.__lastWidth||this.input.width();(force||width>lastWidth)&&(this.__lastWidth=width,this.input.width(width))},adjustGapSizeToDefault:function(){if(this.options.defaultSize.value)if("px"===this.options.defaultSize.measure)this.input.width(this.options.defaultSize.value);else{var measuredWidth=this.input.textWidth(this.options.defaultSize.value);this.input.width(measuredWidth)}}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICMath"),a5.views.interaction.ICMathQuizz={DEBOUNCE_INTERVAL:300,init:function(parameters){this._super(parameters.model,parameters.parent,$('<div class="input-text"></div>')),_.bindAll(this,"onContentChangeStarted","onContentChanged","onInputKeyup"),this.bindEvents(),this.onContentChangedDebounced=_.debounce(this.onContentChanged,this.DEBOUNCE_INTERVAL),this.onInputKeyupDebounced=_.debounce(this.onInputKeyup,this.DEBOUNCE_INTERVAL);var uiBuilder=this.model.wirisBuilder.getQuizzesUIBuilder();this.input=uiBuilder.newAnswerField(this.model.questionObject,this.model.questionInstance,0),this.bindWirisEvents()},render:function(){return this.node.addClass("has-input"),this.$hover=$('<div class="editorHover"></div>'),this.node.append(this.$hover),this.node.append($(this.input.getElement())),this.$hover.hide(),this.node},bindWirisEvents:function(){this.input.addQuizzesFieldListener({contentChanged:this.onContentChangedDebounced,contentChangeStarted:this.onContentChangeStarted}),this.input.getFieldType()===com.wiris.quizzes.api.ui.QuizzesUIConstants.TEXT_FIELD&&$(this.input.getElement()).find("input").keyup(this.onInputKeyupDebounced)},onContentChanged:function(){this.setValue(this.input.getValue())},onContentChangeStarted:function(){},onInputKeyup:function(){this.setValue(this.input.getValue())},bindEvents:function(){this.model.bind("state_update:input",this.onStateInput,this),this.model.bind("state_update:feedback",this.onStateFeedback,this),this.model.bind("state_update:answers",this.onStateAnswers,this),this.model.bind("restore",this.onRestore,this)},onStateInput:function(){this.setInput()},onStateFeedback:function(){this.setAnswer()},onStateAnswers:function(){this.showAnswer()},onRestore:function(){this.model.value&&this.input.setValue(this.model.value)},setValue:function(value){"input"===this.model.state&&this.model.setValue(value)},setInput:function(){this.model.prefill||(this.node.find(".check").remove(),this.$hover.hide(),this.model.isFilled()||this.node.removeClass("filled"),this.model.isCorrectable()&&this.updateFeedbackState(this.node),this.model.value&&this.input.setValue(this.model.value))},setAnswer:function(){this.model.prefill||(this.node.find(".check").remove(),this.$hover.show(),this.model.isCorrectable()&&(this.updateFeedbackState(this.node),this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})))},showAnswer:function(){if(!this.model.prefill&&(this.node.find(".check").remove(),this.$hover.show(),this.model.isCorrectable())){this.updateFeedbackState(this.node);var correct=this.model.getCorrect();this.input.setValue(correct),this.node.addClass("filled"),this.model.isCorrect()?this.model.isCorrect()&&this.addCheck({correct:!0}):this.addCheck({correct:!1,empty:!this.model.isFilled()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})}}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICMathQuizz"),a5.views.interaction.ICTextGapInvisible={init:function(model,enumeration){this._super(model,null,$('<div class="contentblock"></div>'));var self=this;_.defer(function(){self.node.closest(".interaction").addClass("invisible")}),this.nodes=[],_.each(this.model.nodes,function(node){var view;node._instance_of("a5.models.interaction.ICTextGapInvisibleText")?(view=new a5.views.interaction.ICTextGapInvisibleText(node,self),self.node.append(view.render()),self.nodes.push(view)):node._instance_of("a5.models.interaction.ICTextGapInvisibleGap")&&(view=new a5.views.interaction.ICTextGapInvisibleGap(node,self),self.node.append(view.render()),self.nodes.push(view))}),enumeration&&(this.node.prepend('<span class="enumblock-placeholder"></span>'),enumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this)))},closeAll:function(){_.each(this.nodes,function(ca){ca.close()})}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGapInvisible"),a5.views.interaction.ICTextGapInvisibleText={init:function(model,parent){this._super(model,parent,$('<span class="word"></span>')),this.node.text(this.model.word)},close:function(){},updateState:function(){}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGapInvisibleText"),a5.views.interaction.ICTextGapInvisibleGap={init:function(model,parent){this._super(model,parent,$('<span class="input-text has-input"><span class="wrapper">&nbsp;<input type="text"></input>&nbsp;</span><span class="text"></span></span>')),this.wrapper=this.node.find(".wrapper").hide(),this.input=this.node.find("input"),this.text=this.node.find(".text"),this.model.hasAnswer()||this.node.addClass("no-answers"),this.debouncedUpdateInput=_.debounce(_.bind(this.inputUpdate,this),500),this.updateState(),this.updateValue()},updateState:function(){var self=this;this.node.unbind(),this.node.find(".check").remove(),this.model.prefill?this.node.addClass("prefill"):"input"==this.model.parent.state?this.node.click(function(e){self.parent.closeAll(),self.wrapper.show(),self.text.hide(),self.node.addClass("expanded"),self.node.unbind(),self.input.focus(),self.node.click(function(e){self.parent.closeAll()}),self.input.click(function(e){e.stopPropagation()}),self.input.bind("keyup change",function(e){self.model.setValue(self.input.val())}),self.input.blur(function(){self.parent.closeAll()})}):"feedback"==this.model.parent.state?this.model.hasAnswer()?this.addCheck({correct:this.model.isCorrect()}):this.model.isFilled()&&this.addCheck({correct:!1}):this.model.parent.state,this.updateValue()},close:function(){this.wrapper.hide(),this.text.show(),this.node.removeClass("expanded"),this.updateState()},inputUpdate:function(){this.input.val(this.model.value)},updateValue:function(){"answers"!=this.model.parent.state?(this.model.prefill?this.text.html(this.model.answers[0]):0==this.model.value.length?(this.text.html("&nbsp;"),this.node.addClass("empty")):(this.text.text(this.model.value),this.node.removeClass("empty")),this.debouncedUpdateInput()):this.model.hasAnswer()?(this.text.text(this.model.answers[0]),this.node.removeClass("empty")):(this.text.html("&nbsp;"),this.node.addClass("empty"))}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextGapInvisibleGap"),a5.views.interaction.ICTextCorrectionLine={TEMPLATE:'<div class="contentblock"><div class="inputs"><div class="checkbox"><input type="checkbox"></input></div><div class="input"><input type="text"></input></div></div></div>',init:function(model,parent){this._super(model,parent,$(this.TEMPLATE)),this.model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),this.model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),this.checkbox=this.node.find('input[type="checkbox"]'),this.input=this.node.find('input[type="text"]'),this.input.attr("autocapitalize","off"),this.input.attr("autocorrect","off"),this.input.attr("autocomplete","off"),this.model.answers.length>0&&_.all(this.model.answers,a5.utils.isInteger)&&this.input.attr("type","number"),_.defer(function(){this.node.closest(".interaction").addClass("line")}.bind(this)),_.each(this.model.nodes,function(node){var view=new a5.views.interaction.ICTextCorrectionLineText(node,this);this.node.append(view.render())},this),this.node.addClass(this.model.userSelection),_.bindAll(this,"onInputKeyup","onInputChange","onCheckboxChange"),this.checkbox.on("change",this.onCheckboxChange),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("next-answer",this.onNextAnswer,this),this.updateState()},onStateUpdate:function(){this.updateState()},onInputKeyup:function(e){this.model.inputUserAction=!0,this.model.setValue(this.input.val())},onInputChange:function(e){this.model.inputUserAction=!0,this.model.setValue(this.input.val())},onCheckboxChange:function(e){this.model.setChecked(this.checkbox.is(":checked")),"select_for_correct"===this.model.userSelection&&this.input.attr("disabled",this.checkbox.is(":checked"))},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.input.parent())},onSetEnabled:function(enabled){this._super(enabled),this.checkbox.attr("disabled",!enabled),this.input.attr("disabled",!enabled)},addCheck:function(options){this.model.state===this.model.STATES.CHECK&&("input"===options.context&&!this.model.inputUserAction||"checkbox"===options.context&&!this.model.checkboxUserAction)||this.model.state===this.model.STATES.ANSWERS&&"select_for_correct"===this.model.userSelection&&this.model.signalErrorsAlways&&!this.model.hasAnswer()||this._super(options)},updateState:function(){this.input.off(),this.checkbox.off(),this.node.find(".check").remove(),this.model.isPrefilled()?(this.checkbox.attr("checked",this.model.answers.length>0),this.input.val(this.model.answers.length>0?this.model.answers[0]:""),this.$(".inputs").addClass("prefilled"),this.model.setEnabled(!1)):(this.checkbox.attr("checked",this.model.checked),this.input.val(this.model.value),_.invoke(this.model.nodes,"unmark"),(this.model.signalErrorsEnabled||this.model.signalErrorsAlways)&&(_.each(this.model.nodes,function(n){n.wrong&&"select_for_error"===this.model.userSelection?(this.checkbox.attr("checked",!0),this.model.setChecked(!0),this.checkbox.attr("disabled",!0),n.mark()):n.wrong&&"select_for_correct"===this.model.userSelection?(this.checkbox.attr("checked",!1),this.model.setChecked(!1),this.checkbox.attr("disabled",!0),n.mark()):_.every(this.model.nodes,function(n){return!n.wrong})&&"select_for_correct"===this.model.userSelection&&(this.checkbox.attr("checked",!0),this.model.setChecked(!0),this.checkbox.attr("disabled",!0))},this),"select_for_correct"===this.model.userSelection&&this.input.attr("disabled",this.checkbox.is(":checked"))),this.model.state===this.model.STATES.INPUT?(this.input.on("keyup",this.onInputKeyup),this.input.on("change",this.onInputChange),this.checkbox.on("change",this.onCheckboxChange)):this.model.state===this.model.STATES.CHECK?("select_for_error"===this.model.userSelection&&this.setFeedbackForError(),"select_for_correct"===this.model.userSelection&&this.setFeedbackForCorrect()):this.model.state===this.model.STATES.ANSWERS&&("select_for_error"===this.model.userSelection&&this.showAnswerForError(),"select_for_correct"===this.model.userSelection&&this.showAnswerForCorrect()))},setFeedbackForError:function(){var signalError=this.model.signalErrorsEnabled||this.model.signalErrorsAlways;!this.model.hasAnswer()&&this.model.isCheckCorrect()||signalError||this.addCheck({correct:this.model.isCheckCorrect(),parent:this.checkbox.parent(),context:"checkbox"}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),parent:this.input.parent(),context:"input"})},setFeedbackForCorrect:function(){var signalError=this.model.signalErrorsEnabled||this.model.signalErrorsAlways;this.model.hasAnswer()&&this.model.isCheckCorrect()||signalError||this.addCheck({correct:this.model.isCheckCorrect(),parent:this.input.parent(),context:"checkbox"}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),parent:this.input.parent(),context:"input"})},showAnswerForError:function(){this.checkbox.attr("checked",this.model.hasAnswer()),this.model.hasAnswer()?(this.input.val(this.model.answers[0]),this.model.isCorrect()||_.find(this.model.nodes,function(n){return n.wrong}).mark()):this.input.val(""),!this.model.hasAnswer()&&this.model.isCheckCorrect()||this.addCheck({correct:this.model.isCheckCorrect(),empty:!this.model.checked,parent:this.checkbox.parent(),context:"checkbox"}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),empty:0===this.model.value.length&&this.model.hasAnswer(),parent:this.input.parent(),context:"input"})},showAnswerForCorrect:function(){this.checkbox.attr("checked",!this.model.hasAnswer()),this.model.hasAnswer()?(this.input.val(this.model.answers[0]),this.model.isCorrect()||_.find(this.model.nodes,function(n){return n.wrong}).mark()):this.input.val(""),this.addCheck({correct:this.model.isCheckCorrect(),parent:this.input.parent(),context:"input"}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),empty:0===this.model.value.length,parent:this.input.parent(),context:"checkbox"})}};a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextCorrectionLine"),a5.views.interaction.ICTextCorrectionLineText={init:function(model,parent){this._super(model,parent,$('<span class="text"></span>')),this.node.append(this.model.text),this.model.bind("change",this.onChange,this),this.updateState()},onChange:function(){this.model.isMarked()?this.mark():this.unmark()},mark:function(){this.node.addClass("wrong")},unmark:function(){this.node.removeClass("wrong")},updateState:function(){this.model.wrong&&this.model.parent.isPrefilled()&&this.node.addClass("prefilled"),this.model.parent.state===this.model.parent.STATES.CHECK&&this.bindAnswerFeedback(this.model,{correct:this.model.parent.isCorrect()})}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextCorrectionLineText"),a5.views.interaction.ICTextCorrectionSentence={init:function(model,parent){this._super(model,parent,$('<div class="contentblock"><div class="input"><textarea spellcheck="false"></textarea></div><div class="inputs"><div class="checkbox"><input type="checkbox"></input></div></div></div>'));var self=this;model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),this.checkbox=this.node.find("input[type='checkbox']"),this.input=this.node.find("textarea"),this.input.attr("autocapitalize","off"),this.input.attr("autocorrect","off"),this.input.attr("autocomplete","off"),this.input.attr("rows",this.model.getMaxTextRows()),(this.model.signalErrorsAlways||this.model.signalErrorsEnabled)&&this.node.addClass("signal-errors"),this.node.addClass(this.model.userSelection),_.bind(this.updateState,this),_.defer(function(){self.node.closest(".interaction").addClass("sentence"),self.updateState()}),this.model.bind("next-answer",this.onNextAnswer,this)},addCheck:function(options){if("feedback"!=this.model.state||!(options.parent.is(this.input.parent())&&!this.model.inputUserAction||options.parent.is(this.checkbox.parent())&&!this.model.checkboxUserAction)){if("answers"==this.model.state&&(options.parent.is(this.input.parent())&&!this.model.inputUserAction&&(options.empty=!0,options.correct=void 0),options.parent.is(this.checkbox.parent())&&!this.model.checkboxUserAction)){if(this.model.isCheckCorrect())return;options.empty=!0,options.correct=void 0}this._super(options)}},updateState:function(){var self=this;this.model.prefilled&&this.input.parent().addClass("prefilled"),this.input.attr("disabled","input"!=this.model.state||this.model.prefilled),this.checkbox.attr("disabled","input"!=this.model.state||this.model.prefilled),this.input.unbind(),this.checkbox.unbind(),this.node.find(".check").remove(),this.model.prefilled?(this.checkbox.attr("checked","select_for_correct"!=this.model.userSelection),this.input.val(this.model.getPermutations()[0])):(this.checkbox.attr("checked",this.model.checked),this.input.val(this.model.value),_.each(this.model.nodes,function(n){return n.callViews("unmark")}),(this.model.signalErrorsEnabled||this.model.signalErrorsAlways)&&(this.model.hasAnswer()?"select_for_correct"!=this.model.userSelection:"select_for_correct"==this.model.userSelection)&&(this.checkbox.attr("checked",!0),this.model.setChecked(!0),this.checkbox.attr("disabled",!0),"select_for_correct"==this.model.userSelection&&this.input.attr("disabled",!0)),"input"==this.model.state?(this.input.bind("keyup change",function(){self.model.inputUserAction=!0,self.model.setValue(self.input.val())}),this.checkbox.bind("change",function(){self.model.checkboxUserAction=!0,self.model.setChecked(self.checkbox.is(":checked"))}),"select_for_correct"==this.model.userSelection&&this.checkbox.bind("change",_.bind(function(){this.input.attr("disabled",this.checkbox.is(":checked"))},this))):"feedback"==this.model.state?(this.addCheck({correct:this.model.isCheckCorrect(),parent:this.checkbox.parent()}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),parent:this.input.parent()})):"answers"==this.model.state&&(this.model.hasAnswer()?(this.input.val(this.model.getPermutations()[0]),(!this.model.isCorrect()&&"select_for_correct"!=this.model.userSelection||this.model.isCorrect()&&"select_for_correct"==this.model.userSelection)&&this.checkbox.attr("checked",!0)):this.input.val(this.model.getInitialValue()),(this.model.hasAnswer()||!this.model.isCheckCorrect()||this.model.checkboxUserAction)&&this.addCheck({correct:this.model.isCheckCorrect(),empty:!this.model.checked,parent:this.checkbox.parent()}),!this.model.hasAnswer()&&this.model.isCorrect()||this.addCheck({correct:this.model.isCorrect(),empty:0==this.model.value.length,parent:this.input.parent()})))},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.input.parent())}},a5.views.interaction.BaseView.extend("a5.views.interaction.ICTextCorrectionSentence"),a5.view.interaction.ICTextCorrectionReplace={init:function(model,parent,classes){this._super(model,parent,$('<div class="contentblock ki24_view"><div class="inputs"><div class="checkbox"><input type="checkbox"></input></div> </div>')),this.node.addClass(classes),this.nodes=[],this.checkbox=this.node.find("input[type='checkbox']"),"off"===this.model.userSelection&&this.node.find(".inputs").hide(),model.blockEnumeration&&(this.node.append('<span class="enumblock-placeholder"></span>'),model.blockEnumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this))),_.defer(_.bind(function(){this.node.closest(".interaction").addClass("replace").toggleClass("user-selection","off"!==this.model.userSelection)},this)),this.node.addClass(this.model.userSelection),_.bindAll(this,"onCheckboxChange"),this.checkbox.on("change",this.onCheckboxChange),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("next-answer",this.onNextAnswer,this),this.updateState()},onStateUpdate:function(){this.updateState()},onCheckboxChange:function(e){this.model.setChecked(!!this.checkbox.attr("checked"))},onNextAnswer:function(){this._setShowAnswersCheckbox(),a5.utils.scrollIntoElementIfNeeded(this.checkbox)},onSetEnabled:function(enabled){this.checkbox.attr("disabled",!enabled)},addCheck:function(options){(this.model.checkboxChanged||!options.correct&&options.empty)&&this._super(options)},closeAllPopups:function(){this.model.sharedObject.editing&&this.model.sharedObject.editing.closePopup()},push:function(child){this.nodes.push(child),(this.model.isPrefilled()||this.model.signalErrorsAlways||this.model.signalErrorsEnabled)&&this._setShowAnswersCheckbox()},updateState:function(){this.node.find(".check").remove();var prefill=this.model.isPrefilled()||this.model.signalErrorsAlways||this.model.signalErrorsEnabled;this.model.state===this.model.STATES.INPUT&&(prefill?(this.model.setEnabled(!1),this._setShowAnswersCheckbox()):(this.checkbox.attr("disabled",!this.model.isCheckboxEnabled()),this.checkbox.attr("checked",this.model.checked))),this.model.state===this.model.STATES.CHECK&&(this.closeAllPopups(),prefill||("select_for_correct"===this.model.userSelection?this.model.hasAnswer()&&this.model.isCheckCorrect()||this.addCheck({correct:this.model.isCheckCorrect(),parent:this.node.find(".inputs")}):"select_for_error"===this.model.userSelection?!this.model.hasAnswer()&&this.model.isCheckCorrect()||this.addCheck({correct:this.model.isCheckCorrect(),parent:this.node.find(".inputs")}):this.addCheck({correct:this.model.isCheckCorrect(),parent:this.node.find(".inputs")}))),this.model.state===this.model.STATES.ANSWERS&&(this.closeAllPopups(),prefill||this.addCheck({correct:this.model.isCheckCorrect(),parent:this.node.find(".inputs"),empty:!this.model.checkboxChanged}),this._setShowAnswersCheckbox())},_setShowAnswersCheckbox:function(){"select_for_error"===this.model.userSelection&&this.checkbox.attr("checked",this.model.hasAnswer()),"select_for_correct"===this.model.userSelection&&this.checkbox.attr("checked",!this.model.hasAnswer())}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICTextCorrectionReplace"),a5.view.interaction.ICTextCorrectionReplaceText={ORIGINAL_TEXT_TEMPLATE:'<span class="original"></span>',SEPARATOR_TEXT_TEMPLATE:'<span class="whitespace"> </span>',ANSWER_TEXT_TEMPLATE:'<span class="answer"></span>',init:function(model,parent){this._super(model,parent,$('<span class="input-text"></span>')),_.bindAll(this,"onClick","onClickSubmit","onClickClose","onKeypress"),this.model.bind("state_update",this.onStateUpdate,this),this.model.bind("next_answer",this.onNextAnswer,this),this.updateState()},onStateUpdate:function(){this.updateState()},onClick:function(e){this.openPopup($(e.target))},onClickSubmit:function(e){e.preventDefault(),this.submitValue()},onClickClose:function(e){e.preventDefault(),this.closePopup()},onKeypress:function(e){13===e.keyCode&&this.submitValue()},onNextAnswer:function(){a5.utils.scrollIntoElementIfNeeded(this.node)},updateValue:function(){this.node.removeClass("modified");var children=this.node.children();this.node.contents().remove(),this.node.append(children),this.model.isPrefilled()?(this.node.empty(),this.node.append($(this.ORIGINAL_TEXT_TEMPLATE).text(this.model.text)),this.node.append($(this.SEPARATOR_TEXT_TEMPLATE)),this.node.append($(this.ANSWER_TEXT_TEMPLATE).text(this.model.answers[0])),this.node.addClass("prefilled"),this.model.setEnabled(!1)):(this.model.parent.state===this.model.parent.STATES.ANSWERS?this._showAnswerValue():this.node.append(this.model.value),(this.model.isFilled()||this.model.isRevealed())&&this.node.addClass("modified"),this.model.parent.state!==this.model.parent.STATES.ANSWERS&&this.model.isRevealed()&&(this.node.addClass("modified"),this.node.contents().remove(),this._showAnswerCheck(),this._showAnswerValue()))},updateState:function(){this.model.isPrefilled()||(this.node.off(),this.node.find(".check").remove(),this.updateFeedbackState(this.node),this.node.removeClass("correct wrong"),(this.model.parent.signalErrorsEnabled||this.model.parent.signalErrorsAlways)&&this.model.parent.state===this.model.parent.STATES.INPUT&&this.model.state!==this.model.STATES.ANSWERS&&this.node.addClass(this.model.needsAnswer()?"wrong":"correct"),this.model.parent.state===this.model.parent.STATES.INPUT&&!this.model.isRevealed()&&this.model.isEnabled()?this.node.on("click",this.onClick):this.model.parent.state===this.model.parent.STATES.CHECK?(this.model.isFilled()&&this.addCheck({correct:this.model.isCorrect(),tooltip:this.model.getAnswerFeedback()}),this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect()})):this.model.parent.state===this.model.parent.STATES.ANSWERS&&this._showAnswerCheck()),this.updateValue()},updateFeedbackState:function(nodes){if(nodes.removeClass("checked-empty checked-incorrect checked-correct"),nodes.removeClass("solution-empty solution-incorrect solution-correct solution-revealed"),nodes.removeClass("needs-answer"),this.model.needsAnswer()||this.model.isFilled()){this.model.needsAnswer()&&this.model.isFilled()&&nodes.addClass("needs-answer");var type;if(this.model.isRevealedBySeeNext())return void this.node.addClass("solution-revealed");if("feedback"===this.model.parent.state)type="checked";else{if("answers"!==this.model.parent.state)return;type="solution"}this.model.isCorrect()?nodes.addClass([type,"correct"].join("-")):this.model.isFilled()?nodes.addClass([type,"incorrect"].join("-")):nodes.addClass([type,"empty"].join("-"))}},openPopup:function($word){if(this.parent.closeAllPopups(),this.parent.model.sharedObject.editing=this,!$word.hasClass("correct")){this.popup=$(window.a5.mainBuilder.layout.getTemplate("popupki24")),this.popup.css("min-width","256px"),
(this.model.needsAnswer()&&_(this.model.answers).all(a5.utils.isInteger)||!this.model.needsAnswer()&&a5.utils.isInteger(this.model.text))&&this.popup.find("input").attr("type","number"),this.parent.node.append(this.popup),this.popup.find("h1").text(this.model.text);var container=a5.utils.scrollParent(this.parent.node),containerRight=container.left+container.width,viewportBottom=$(window).scrollTop()+$(window).height()-a5.dp.config.exclusionBottom,wordPosition=this.node.offset(),pushLeft=wordPosition.left+this.popup.width()-containerRight;pushLeft=pushLeft<0?0:pushLeft;var pushUp=this.node.offset().top+30+this.popup.height()-viewportBottom;pushUp=pushUp<0?0:this.popup.height()+30,this.popup.css({left:wordPosition.left-this.parent.node.offset().left-pushLeft,top:wordPosition.top-this.parent.node.offset().top+30-pushUp}),this.popup.find("a.close").on("click",this.onClickClose),this.popup.find("a:last").on("click",this.onClickSubmit),this.popup.find("input").attr("autocapitalize","off"),this.popup.find("input").attr("autocorrect","off"),this.popup.find("input").attr("autocomplete","off"),this.popup.find("input").on("keypress",this.onKeypress),this.node.addClass("editing"),this.popup.find("input").focus()}},submitValue:function(){var value=this.popup.find("input").val().trim();value.length>0&&this.model.setValue(value),this.closePopup()},closePopup:function(){this.node.removeClass("editing"),this.popup&&(this.popup.remove(),this.popup=!1),delete this.parent.model.sharedObject.editing},_showAnswerValue:function(){this.model.needsAnswer()?this.node.append(this.model.answers[0]):this.node.append(this.model.text)},_showAnswerCheck:function(){this.model.needsAnswer()?this.model.isCorrect()?this.addCheck({correct:!0,tooltip:this.model.value}):this.addCheck({empty:!(this.model.isFilled()||this.model.isRevealedBySeeNext()&&this.model.parent.state===this.model.parent.STATES.CHECK),tooltip:this.model.value}):this.model.isFilled()&&this.addCheck({empty:!1,tooltip:this.model.value})}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICTextCorrectionReplaceText"),a5.view.interaction.ICTextCorrectionReplacePlain={init:function(model,parent){this._super(model,parent,$('<span class="text"></span>')),this.node.append(this.model.text)},updateState:function(){},closePopup:function(){}},a5.views.interaction.BaseView.extend("a5.view.interaction.ICTextCorrectionReplacePlain"),a5.view.interaction.PPFlashcards={init:function(model,parent,mode){this._super(model,parent,$('<div class="fc_view"></div>')),this.mode=mode,_.each(this.model.cards,function(model){this.node.append(new a5.view.interaction.PPFlashcardsCard(model,this).render())},this),this.node.addClass(mode)}},a5.views.interaction.BaseView.extend("a5.view.interaction.PPFlashcards"),a5.view.interaction.PPFlashcardsCard={init:function(model,parent,mode){this._super(model,parent,$(a5.mainBuilder.layout.getTemplate("flashcards"))),this.$(".front-container").append(this.model.front),this.$(".back-container").append(this.model.back),this.node.addClass(this.parent.mode),_.bindAll(this,"_onClick","_onKeydown"),this.model.parent.bind("update_state",this.updateState,this),this.model.bind("flipped",this.flipped,this),this.model.bind("update_flipped",this.updateFlipped,this),this.updateState(),this.updateFlipped(),this.model.beforeFlipAudioPlayback&&this.bindFlipOnAudioEnd()},updateState:function(){this.node.unbind(),"input"==this.model.state&&(this.node.on("click",this._onClick),this.node.on("keydown",this._onKeydown))},_onClick:function(){this.flip()},_onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.flip()},flip:function(){this.model.beforeFlipAudioPlayback?this._playAudioAndFlip():this.model.flip()},bindFlipOnAudioEnd:function(){var front_audio=a5.service.media.find(this.$(".front-container")),back_audio=a5.service.media.find(this.$(".back-container")),doFlip=function(){this.model.flip()};front_audio&&(front_audio.bind("stopped",doFlip,this),front_audio.bind("error",doFlip,this)),back_audio&&(back_audio.bind("stopped",doFlip,this),back_audio.bind("error",doFlip,this))},_playAudioAndFlip:function(){var current_container=this.model.flipped?this.$(".back-container"):this.$(".front-container"),audio=a5.service.media.find(current_container),doFlip=_.bind(function(){this.model.flip()},this);!audio||audio.isPlaying()||audio.hasError()?audio&&audio.isPlaying()||doFlip():(a5.service.media.audio.stopAllPlaying(),audio.play())},flipped:function(){this.node.toggleClass("flip"),this.model.flipped&&this.model.autoAudioPlayback&&a5.service.media.play(this.node)},updateFlipped:function(){this.model.flipped?this.node.addClass("flip"):this.node.removeClass("flip")}},a5.views.interaction.BaseView.extend("a5.view.interaction.PPFlashcardsCard"),a5.view.interaction.PPSlideshow={init:function(model,parent){this._super(model,parent,$('<div class="slideshow"><ul></ul></div>')),this.model.bind("change:slide",this.onSlideChange,this),this.model.bind("slide:magnify:start",this.onSlideMagnifyStart,this),this.model.bind("slide:magnify:stop",this.onSlideMagnifyStop,this),this.model.bind("slide:playing",this.onPlay,this),this.model.bind("slide:paused",this.onPaused,this),this.model.bind("slide:ending",this.onSlideEnding,this),this.slides=[],this.toolbar=new a5.view.interaction.PPSlideshowToolbar(this.model,this)},render:function(){return this.$slides=this.node.find("ul"),this.model.shuffle&&(this.model.slides=_.shuffle(this.model.slides)),_.each(this.model.slides,function(slide){var slideView=new a5.view.interaction.PPSlideshowSlide(slide,this);slideView.hide(),this.slides.push(slideView),this.$slides.append(slideView.render())},this),this.node.append(this.toolbar.render()),this.model.goFirst(),this.node},hideAll:function(){_(this.slides).invoke("hide")},toggleDecode:function(){_(this.slides).invoke("toggleDecode")},onSlideChange:function(old,cur){var oldView=this._getSlideView(old),curView=this._getSlideView(cur);oldView&&oldView.hide(),curView&&curView.show()},onSlideMagnifyStart:function(cur){var curView=this._getSlideView(cur);curView&&curView.startMagnify()},onSlideMagnifyStop:function(cur){var curView=this._getSlideView(cur);curView&&curView.stopMagnify()},onPlay:function(){this.playing=!0,this.node.addClass("playing")},onPaused:function(){this.playing=!1,this.node.removeClass("playing")},onSlideEnding:function(cur){var curView=this._getSlideView(cur);curView&&curView.beforeHide()},_getSlideView:function(slide){return _(this.slides).find(function(view){return view.model===slide})}},a5.views.interaction.BaseView.extend("a5.view.interaction.PPSlideshow"),a5.view.interaction.PPSlideshowSlide={DECODE:'<div class="decode-image"></div>',init:function(model,parent){this._super(model,parent,$("<li></li>"))},render:function(){return this.node.append(this.model.content),this.model.decode&&(this.$decode=$(this.DECODE).append(this.model.decode),this.$decode.hide(),this.node.append(this.$decode)),this.node},show:function(){this.node.show()},hide:function(){this.node.hide(),this.node.removeClass("slide-ending")},beforeHide:function(){this.node.addClass("slide-ending")},startMagnify:function(){this.node.addClass("slide-magnified")},stopMagnify:function(){this.node.removeClass("slide-magnified")},toggleDecode:function(){this.$decode&&this.$decode.toggle()}},a5.views.interaction.BaseView.extend("a5.view.interaction.PPSlideshowSlide"),a5.view.interaction.PPSlideshowToolbar={init:function(model,parent){this._super(model,parent,$('<div class="slideshow-toolbar"></div>')),this.model.bind("change:delay",this.onDelayChange,this),this.model.bind("change:slide",this.onSlideChange,this),this.model.bind("slide:playing",this.onPlay,this),this.model.bind("slide:paused",this.onPaused,this),_.bindAll(this,"onClickFirst","onClickLast","onClickPrev","onClickNext","onClickPlay","onClickDelayUp","onClickDelayDown","onClickShuffleOrder","onClickDefaultOrder","onClickToggleDecode","onPlay","onPaused")},render:function(){var template=a5.service.templates.render("a5.view.PPSlideshowToolbar",{automatic:this.model.automaticControl,shuffle:this.model.shuffleControl,decode:this.model.additionalImageControl});return this.node.append(template),this._renderManualControls(),this._renderAutomaticControls(),this._renderShuffleControls(),this._renderAdditionalImageControls(),this.node},_renderManualControls:function(){0!==this.node.find(".slideshow-manual-buttons").length&&(this.node.on("click","a#first-slide",this.onClickFirst),this.node.on("click","a#last-slide",this.onClickLast),this.node.on("click","a#prev-slide",this.onClickPrev),this.node.on("click","a#next-slide",this.onClickNext))},_renderAutomaticControls:function(){var $automaticControls=this.node.find(".slideshow-automatic-buttons");0!==$automaticControls.length&&(this.$delay=$automaticControls.find("#slide-delay"),this.$delay.html(this.model.delay+" sec"),this.$play=$automaticControls.find("a#slide-play"),this.$pause=$automaticControls.find("a#slide-pause"),this.$pause.hide(),this.playText=this.$play.text(),this.pauseText=this.$pause.text(),this.node.on("click","a#slide-play",this.onClickPlay),this.node.on("click","a#slide-delay-dec",this.onClickDelayDown),this.node.on("click","a#slide-delay-inc",this.onClickDelayUp))},_renderShuffleControls:function(){var $shuffleControls=this.node.find(".slideshow-shuffle-buttons");if(0!==$shuffleControls.length){$shuffleControls.find("a#slide-shuffle-order"),$shuffleControls.find("a#slide-default-order");this.node.on("click","a#slide-shuffle-order",this.onClickShuffleOrder),this.node.on("click","a#slide-default-order",this.onClickDefaultOrder)}},_renderAdditionalImageControls:function(){var $additionalImageControls=this.node.find(".slideshow-decode-buttons");0!==$additionalImageControls.length&&(this.$decode=$additionalImageControls.find("a#slide-show-decode"),this.$decodeHide=$additionalImageControls.find("a#slide-hide-decode"),this.$decodeHide.hide(),this.decodeShowText=this.$decode.text(),this.decodeHideText=this.$decodeHide.text(),this.node.on("click","a#slide-show-decode",this.onClickToggleDecode))},onClickFirst:function(e){e.preventDefault(),this.model.goFirst(),this.parent.playing&&this.model.interrupt()},onClickLast:function(e){e.preventDefault(),this.model.goLast(),this.parent.playing&&this.model.interrupt()},onClickPrev:function(e){e.preventDefault(),this.model.goPrev(),this.parent.playing&&this.model.interrupt()},onClickNext:function(e){e.preventDefault(),this.model.goNext(),this.parent.playing&&this.model.interrupt()},onClickPlay:function(e){e.preventDefault(),this.parent.playing?this.model.pause():this.model.play()},onClickDelayUp:function(e){e.preventDefault(),this.model.incDelay(),this.parent.playing&&this.model.interrupt()},onClickDelayDown:function(e){e.preventDefault(),this.model.decDelay(),this.parent.playing&&this.model.interrupt()},onDelayChange:function(delay){this.$delay.html(delay+" sec")},onClickShuffleOrder:function(e){e.preventDefault(),this.parent.hideAll(),this.model.shuffleOrder(),this.parent.playing&&this.model.interrupt()},onClickDefaultOrder:function(e){e.preventDefault(),this.parent.hideAll(),this.model.defaultOrder(),this.parent.playing&&this.model.interrupt()},onClickToggleDecode:function(e){e.preventDefault(),this.$decode.toggleClass("slide-decode-hidden");var text=this.$decode.hasClass("slide-decode-hidden")?this.decodeHideText:this.decodeShowText;this.$decode.text(text),this.parent.toggleDecode()},onSlideChange:function(old,cur){this.$decode&&(cur.decode?this.$decode.show():this.$decode.hide())},onPlay:function(){this.$play.text(this.pauseText)},onPaused:function(){this.$play.text(this.playText)}},a5.views.interaction.BaseView.extend("a5.view.interaction.PPSlideshowToolbar"),a5.views.interaction.RadioAccordion={init:function(model){this._super(model,null,$('<div class="radio-accordion"></div>')),this.children=[]},append:function(child){child.model.bind("before_activate",this.deactivateAll,this),this.children.push(child)},render:function(){return this._super(),_.each(this.children,function(child){this.node.append(child.render())},this),this.children.length>0&&this.children[0].model.activate(),this.node},deactivateAll:function(){_.each(this.children,function(child){child.model.deactivate()},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.RadioAccordion"),a5.views.interaction.RadioAccordionElement={init:function(model,classes){this._super(model,null,$('<div class="radio-section"></div>')),this.node.addClass(classes),model.bind("change:active",this.render,this)},render:function(){this._super(),this.node.off();var data={content:this.model.content,enum:'<span class="enumblock-placeholder"></span>'};return this.node.html(a5.service.templates.render("a5.view.RadioAccordion",data)),this.model.active&&this.model.alertNode.html(a5.service.templates.render("a5.view.RadioAccordionOpenAlert",data)),this.node.toggleClass("active",this.model.active),this.$(".selection-indicator").prop("checked",this.model.active),this.model.enumeration.then(function(enumSymbol){this.node.find(".enumblock-placeholder").replaceWith(enumSymbol),this.model.alertNode.find(".enumblock-placeholder").replaceWith(enumSymbol)}.bind(this)),this.node.on("click",_.bind(function(e){e.preventDefault(),this.model.activate()},this)),this.node}},a5.views.interaction.BaseView.extend("a5.views.interaction.RadioAccordionElement"),a5.view.interaction.Syllabify={NODE_TEMPLATE:"<div class='syllabify-word'></div>",LETTER_TEMPLATE:"<span class='syllabify-letter'></span>",BREAK_TEMPLATE:"<span class='syllabify-break'></span>",SYLLABLE_TEMPLATE:"<span class='syllabify-syllable'></span>",SYLLABLE_WRONG_MARKER:"<span class='syllabify-marker'>&nbsp;</span>",GAP_TEMPLATE:"<span class='syllabify-gap'></span>",init:function(model){this.model=model,this.node=$(this.NODE_TEMPLATE),this.setInput(),this.model.tts_audio&&this.addTTSPlayer()},splitLetters:function(word){for(var result=[],buffer=[],inside=!1,i=0;i<word.length;i++)"|"!=word[i]?inside?buffer.push(word[i]):result.push(word[i]):(inside=!inside,buffer.join("")&&result.push(buffer.join("")),buffer=[]);return result},bindEvents:function(){this.model.bind("state_update:input",_.bind(this.setInput,this)),this.model.bind("state_update:feedback",_.bind(this.setAnswer,this)),this.model.bind("state_update:answers",_.bind(this.showAnswer,this))},addTTSPlayer:function(){var answer=this.model.correctResponse.values.join("").replace(/\|/g,"");this.tts_player=new a5.views.TTS_Player(answer),$(this.node).prepend(this.tts_player.render())},breakerClick:function(e){this.break_node&&(this.node.find(".syllabify-syllable.temp").removeClass("temp").removeClass("start").removeClass("end"),this.break_node.parent().is(".syllabify-syllable")&&this.break_node.unwrap(),this.break_node.replaceWith($(this.GAP_TEMPLATE)),this.break_node=void 0,this.setChoice())},setChoice:function(){var choice=[];this.node.find(".syllabify-syllable").each(function(i,el){var word="";$(el).find(".syllabify-letter").each(function(i,el){var letter=$(el).text();letter.length>1?word+="|"+letter+"|":word+=letter}),choice.push(word)}),this.model.setChoices(choice)},gapClick:function(e){e.preventDefault();var gap=$(e.currentTarget),next=gap.next(),prev=gap.prev();this._removeDeleting(),next.children(".syllabify-letter").appendTo(gap.prev()),next.remove(),1==this.node.find(".syllabify-syllable").length&&prev.children().first().unwrap(),gap.remove(),this.setChoice()},gapOver:function(e){e.preventDefault(),this._removeBreak(),this._removeEditing();var gap=$(e.currentTarget);if(!gap.is(".checked-correct-locked")){var next=gap.next(),prev=gap.prev();next.addClass("deleting"),prev.addClass("deleting")}},gapOut:function(e){this._removeDeleting(),this._removeEditing()},wordOut:function(e){this._removeEditing(),this._removeBreak()},splitSyllable:function(e){var $current=$(e.currentTarget);if(!$current.is(":last-child")&&!$current.parent().is(".checked-correct-locked")){this._removeBreak(),this._removeDeleting(),this._removeEditing(),$current.parents(".syllabify-syllable").addClass("editing");var start=$(this.SYLLABLE_TEMPLATE).addClass("start temp"),end=$(this.SYLLABLE_TEMPLATE).addClass("end temp");this._addBreakAfter($current),this.break_node.nextAll().wrapAll(end);Array.prototype.reverse.call(this.break_node.prevAll()).wrapAll(start)}},_removeBreak:function(){this.break_node&&this.break_node.remove(),this.node.find(".syllabify-syllable.temp").each(function(i,group){$(group).children().first().unwrap()})},_removeEditing:function(){this.node.find(".editing").removeClass("editing")},_removeDeleting:function(){this.node.find(".deleting").removeClass("deleting")},_addBreakAfter:function(node){this.break_node=$(this.BREAK_TEMPLATE),this.break_node.insertAfter(node)},_removeChecks:function(){this.node.find(".check").remove()},_restoreChoices:function(){if(this.model.getChoices().length)_.each(this.model.getChoices(),function(syllable,i){syllable=this.splitLetters(syllable);var $syllable=$(this.SYLLABLE_TEMPLATE);_.each(syllable,function(letter){var $letter=$(this.LETTER_TEMPLATE);$letter.html(letter),$syllable.append($letter)},this),this.node.append($syllable),this.node.append($(this.GAP_TEMPLATE))},this),this.node.find(".syllabify-gap").last().remove();else{var letters=this.splitLetters(this.model.correctResponse.values.join(""));_.each(letters,function(letter){var node=$(this.LETTER_TEMPLATE);node.html(letter),this.node.append(node)},this)}},setInput:function(data){if(this.node.empty(),this._restoreChoices(),this.updateFeedbackState(this.node),/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)?this.bindTouchEvents():this.bindMouseEvents(),this.model.tryAgainIsFrozen){var correct=this.model.getCorrectResponse();correct=_.map(correct,function(syllable){return syllable.replace(/\|/g,"")}),this.node.find(".syllabify-syllable").each(_.bind(function(i,syllable){_.contains(correct,$(syllable).text())&&($(syllable).addClass("checked-correct-locked"),$(syllable).next(".syllabify-gap").addClass("checked-correct-locked"),correct.splice(correct.indexOf($(syllable).text()),1))},this))}},bindMouseEvents:function(){this.node.on("mouseover",".syllabify-letter",_.bind(this.splitSyllable,this)),this.node.on("mouseleave",_.bind(this.wordOut,this)),this.node.on("click",".syllabify-letter",_.bind(this.breakerClick,this)),this.node.on("click",".syllabify-break",_.bind(this.breakerClick,this)),this.node.on("mouseover",".syllabify-gap",_.bind(this.gapOver,this)),this.node.on("mouseout",".syllabify-gap:not(.checked-correct-locked)",_.bind(this.gapOut,this)),this.node.on("click",".syllabify-gap:not(.checked-correct-locked)",_.bind(this.gapClick,this))},bindTouchEvents:function(){this.node.on("touchstart",".syllabify-letter",_.bind(this.splitSyllable,this)),$(document.body).on("touchmove",".syllabify-letter",_.bind(this.touchMove,this)),this.node.on("touchend",".syllabify-letter",_.bind(this.breakerClick,this)),this.node.on("touchend",".syllabify-break",_.bind(this.breakerClick,this)),this.node.on("touchstart",".syllabify-gap",_.bind(this.gapOver,this)),this.node.on("touchend",".syllabify-gap:not(.checked-correct-locked)",_.bind(this.gapClick,this))},touchMove:function(e){e.preventDefault();var touch=e.originalEvent.touches.item(0),element=document.elementFromPoint(touch.pageX,touch.pageY);$(element).is(".syllabify-letter")&&this.node.has(element).length?this.splitSyllable({currentTarget:element}):(this.wordOut(),this.gapOut())},setAnswer:function(data){this.node.off(),this.node.empty(),this._restoreChoices(),this.updateFeedbackState(this.node);var correct=this.model.getCorrectResponse();correct=_.map(correct,function(syllable){return syllable.replace(/\|/g,"")}),this.node.find(".syllabify-syllable").each(_.bind(function(i,syllable){if(_.contains(correct,$(syllable).text()))$(syllable).addClass("checked-correct"),$(syllable).next(".syllabify-gap").addClass("checked-correct"),this.addCheck({parent:$(syllable),correct:!0}),correct.splice(correct.indexOf($(syllable).text()),1);else{$(syllable).addClass("checked-incorrect");var gap=$(syllable).next(".syllabify-gap");gap.addClass("checked-incorrect");var prev=gap.prevAll().find(".syllabify-letter"),index=prev.text().length,tooltip=this.model.getFeedbackAt(index);this.addCheck({parent:$(syllable),correct:!1,tooltip:tooltip})}},this))},showAnswer:function(){this.node.off(),this.node.empty(),this._restoreChoices(),this.updateFeedbackState(this.node);var correctResponses=this.model.getCorrectResponse(),choices=this.model.getChoices(),breaks=[];_.each(choices.join(";"),function(letter,i){";"==letter&&breaks.push(i-breaks.length-1)});var letter_index=0;this.node.empty(),_.each(correctResponses,function(syllable,i){var $syllable=$(this.SYLLABLE_TEMPLATE);if(_.each(this.splitLetters(syllable),function(letter){var $letter=$(this.LETTER_TEMPLATE);$letter.html(letter),$syllable.append($letter);this.node.text().length;_.contains(breaks,letter_index)&&$syllable.append($(this.SYLLABLE_WRONG_MARKER)),letter_index+=1},this),this.model.isRevealedBySeeNext()&&$syllable.addClass("solution-revealed"),0===choices.length)this.addCheck({empty:!0,parent:$syllable});else if(_.contains(choices,syllable))$syllable.addClass("solution-correct"),this.addCheck({correct:!0,parent:$syllable}),choices.splice(choices.indexOf(syllable),1);else{$syllable.addClass("solution-incorrect");var tooltip=this.model.getChoices().join("-").replace(/\|/g,"");this.addCheck({correct:!1,parent:$syllable,tooltip:tooltip})}this.node.append($syllable),this.node.append($(this.GAP_TEMPLATE))},this),this.node.find(".syllabify-gap").last().remove()},render:function(){return this.bindEvents(),this.node}},a5.views.interaction.BaseView.extend("a5.view.interaction.Syllabify"),a5.views.interaction.PEScorable={template:"a5.views.interaction.PEScorable",init:function(model){this._super(model,null,$(a5.service.templates.render(this.template,{src:model.src}))),this.$iframe=this.node.find("iframe"),this.model.bind(this.model.CONTENT_RESIZE_EVENT,this.__onIframeContentResize,this),this.$iframe.load(function(ev){model.setIframe(ev.target)})},__onIframeContentResize:function(data){this.$iframe.width(data.width),this.$iframe.height(data.height)}},a5.views.interaction.BaseView.extend("a5.views.interaction.PEScorable"),a5.views.interaction.ISPelmanism={init:function(model,parent){this._super(model,parent,$('<div class="cards"></div>')),this.cardFormat=model.cardFormat,this.cardLayout=model.cardLayout,this.cardBack=model.cardBack,this.node.addClass("template-"+model.cards.length),this.model.bind("pair:match",this.onPairMatch,this)},render:function(){return this._createGame(),a5.eventBus.trigger("is-pelmanism:rendered",this.node),this.node},applyLayout:function(){var layoutNum=0,layoutClass=a5.mainBuilder.layout.getTemplate("pelmanism_card_layout-1");"landscape"===this.cardFormat?(layoutClass=a5.mainBuilder.layout.getTemplate("pelmanism_card_layout-2"),layoutNum=1):"portrait"===this.cardFormat&&(layoutClass=a5.mainBuilder.layout.getTemplate("pelmanism_card_layout-3"),layoutNum=2),this.layoutNum=layoutNum,this.layoutClass=layoutClass;var df1_layouts=[],df2_layouts=[];if(df1_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img1-lay1")),df1_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img1-lay2")),df1_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img1-lay3")),df1_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img1-lay4")),df2_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img2-lay1")),df2_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img2-lay2")),df2_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img2-lay3")),df2_layouts.push(a5.mainBuilder.layout.getTemplate("pelmanism_card_img2-lay4")),"sets"===this.cardLayout){var i=0;_.each([1,2],function(index){_.each(this.model.cards,function(card){card.setNum===index&&(i++,this.addCard(card,df1_layouts,df2_layouts,layoutClass,layoutNum,i<=this.model.cards.length/2))},this)},this)}"default"===this.cardLayout&&_.each(this.model.cards,function(card){this.addCard(card,df1_layouts,df2_layouts,layoutClass,layoutNum)},this)},onPairMatch:function(parameters){a5.eventBus.trigger("is-pelmanism:match",parameters)},_createGame:function(){this.node.empty(),this.cards=[],this.model.shuffle(),this.applyLayout(),this.setPrefill(),this.model.setVisualOrder(_.pluck(this.cards,"model")),this.node.append("<div style='clear:both'></div>")},setPrefill:function(){this.model.setPrefill(),_(this.cards).invoke("setPrefill")},addCard:function(card,df1_layouts,df2_layouts,layoutClass,layoutNum,toggle){var view=new a5.views.interaction.ISPelmanismCard(card,this,df1_layouts,df2_layouts,layoutClass,layoutNum,toggle);return this.node.append(view.render()),this.cards.push(view),view}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISPelmanism"),a5.views.interaction.ISPelmanismCard={init:function(model,parent,df1_layouts,df2_layouts,layoutClass,layoutNum,toggle){var id,$t,t=a5.mainBuilder.layout.getTemplate("pelmanism_card");t=a5.mainBuilder.layout.replaceSubpart(t,"pelmanism_card_front",model.back);do{id=a5.utils.createUID()}while(new RegExp(id).test(t));t=a5.mainBuilder.layout.replaceSubpart(t,"pelmanism_card_back",'<div id="'+id+'"></div>'),$t=$(t).find("#"+id).replaceWith(model.content).end(),this._super(model,parent,$t),_.bindAll(this,"_onClick","_onKeydown"),this.$front=this.$(".front"),this.$back=this.$(".back"),this.$front.attr("data-front",model.identifier),this.$back.attr("data-back",model.identifier),this.$back.find("[data-playable-media]").length&&this.$back.addClass("has_audio_attached");var cards=parent.model.cards.length;this.$front.parents(".panel").addClass("layout-"+cards+"-cards"),this.df1_layouts=df1_layouts,this.df2_layouts=df2_layouts,this.layoutNum=layoutNum,this.layoutClass=layoutClass,this.toggle=toggle,this._bindEvents()},_bindEvents:function(){this.$front.off(),this.$front.on("click",this._onClick),this.node.on("keydown",this._onKeydown),this.model.bind("position:change",this._onCardChange,this),this.model.bind("state_update:input",this.tryAgain,this),this.model.bind("state_update:feedback",this.setAnswer,this),this.model.bind("state_update:answers",this.showAnswer,this)},showAnswer:function(){this.$(".check").remove(),this.flip(),this.node.removeClass("notpaired"),this.node.addClass("paired"),this.addCheck({correct:this.model.isCorrect(),parent:this.$back}),this.updateFeedbackState(this.node)},setAnswer:function(){this.$(".check").remove(),this.node.removeClass("paired notpaired"),this.$front.removeClass("found"),this.model.isCorrect()?(this.$front.addClass("found"),this.node.addClass("paired")):(this.node.addClass("notpaired"),this.animationTimeout=setTimeout(this.failedPair.bind(this),a5.dp.config.pelmanismFailedPairTime),this.model.board.bind("cancelAnimations",this.failedPair,this)),this.addCheck({correct:this.model.isCorrect(),parent:this.$back}),this.updateFeedbackState(this.node),this.checkLocked()},failedPair:function(){this.model.board.unbind("cancelAnimations",this.failedPair),clearTimeout(this.animationTimeout),this.node.removeClass("notpaired"),this.model.tryAgain()},tryAgain:function(){this.flop(),this.$(".check").remove(),this.updateFeedbackState(this.node)},flip:function(silent){this.$front.removeClass("active"),this.$back.addClass("active"),this.node.addClass("flip"),!silent&&this.model.autoAudioPlayback&&"answers"!==this.model.state&&a5.service.media.play(this.$back)},flop:function(){this.$front.addClass("active"),this.$back.removeClass("active"),this.node.removeClass("flip")},_onCardChange:function(position,card,silent){"faceup"===position?this.flip(silent):this.flop()},_onClick:function(ev){this._startFlip()},_startFlip:function(){"input"===this.model.board.state&&(this.model.beforeFlipAudioPlayback?this._playAudioAndFlip():this.model.flip())},_onKeydown:function(ev){var key=ev.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this._startFlip()},_playAudioAndFlip:function(){var audio=a5.service.media.find(this.$back),doFlip=_.bind(function(){this.model.flip(!0)},this);!audio||audio.isPlaying()||audio.hasError()?audio&&audio.isPlaying()||doFlip():(a5.service.media.audio.stopAll(),audio.bind("stopped",doFlip,this),audio.bind("error",doFlip,this),audio.play())},setPrefill:function(){this.model.prefill&&setTimeout(_.bind(function(){this.flip(),this.node.addClass("prefill")},this),1e3)},applyLayout:function(){var defaultClass="";"default"===this.parent.cardLayout&&(defaultClass=" "+this.df1_layouts[this.layoutNum]),"default"===this.parent.cardBack?defaultClass=" "+this.df1_layouts[this.layoutNum]:"defaultsets"===this.parent.cardBack&&(defaultClass=" ",defaultClass+=1==this.model.setNum?this.df1_layouts[this.layoutNum]:this.df2_layouts[this.layoutNum]),"sets"===this.parent.cardLayout&&(defaultClass=" "+(this.toggle?this.df1_layouts[this.layoutNum]:this.df2_layouts[this.layoutNum])),this.node.addClass(this.layoutClass),this.$front.addClass("active"+defaultClass)},render:function(){return this.applyLayout(),this.model.flop(),this.$("td img").attr("style",""),this.$("td").each(function(){_.isEmpty($(this).html().trim())&&this.toggle&&$(this).html("<img src='"+this.$front.css("background-image").replace("url(","").replace(")","").replace(/"/gi,"")+"' />")}),_.each(this.$back.find("td"),function(b){_.isEmpty($(b).html().trim())&&$(b).html("<img src='"+this.$front.css("background-image").replace("url(","").replace(")","").replace(/"/gi,"")+"' />")}),this.node}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISPelmanismCard"),a5.views.interaction.IMVoice={template:"a5.view.IMVoice",noMatchTemplate:"a5.view.dialog.IMVoiceNoMatch",init:function(model){var html=a5.service.templates.render(this.template,this._serializeData(model)),$html=$(html);this._super(model,null,$html),this._initChildren(),_.bindAll(this,"onRecordStarted","onRecordEnded","onRecordProgress","onRecordError"),this.recording=new a5.views.interaction.SpeakingRecording(this.model.recording,{onSimpleRecordEnded:this.onRecordEnded,onSimpleRecordProgress:this.onRecordProgress,onSimpleRecordStarted:this.onRecordStarted,onSimpleRecordError:this.onRecordError}),this.model.bind("speech:start",this.onSpeechStart,this),this.model.bind("speech:result",this.onSpeechResult,this),this.model.bind("speech:error",this.onSpeechError,this),this.model.bind("clear",this.onClear,this),this.model.bind("state_update",this.onStateUpdate,this)},render:function(){return this.node.find(".imVoice__recorder").append(this.recording.render()),this.node},showMatchError:function(){this.warningDisplayed||(a5.view.dialog.display(this.noMatchTemplate,{dialogClass:"imVoice__dialog"},{close:function(){this.warningDisplayed=!1}.bind(this)}),this.warningDisplayed=!0)},onRecordStarted:function(){this.node.addClass("imVoice--recording"),this.model.clear()},onRecordProgress:function(progress){this.node.attr("style","--progress:"+progress)},onRecordEnded:function(){this.node.removeClass("imVoice--recording"),this.model.scorable||this.model.speechToText()},onRecordError:function(){this.node.removeClass("imVoice--recording"),this.model.clear()},onClear:function(){this.node.removeClass("imVoice--error imVoice--completed"),this.node.attr("style","--progress:0")},onSpeechStart:function(){this.node.addClass("imVoice--processing")},onSpeechError:function(){this.node.removeClass("imVoice--processing"),this.node.addClass("imVoice--error"),this.showMatchError()},onSpeechResult:function(data){this.node.removeClass("imVoice--completed"),this.node.removeClass("imVoice--processing"),this.model.completed?this.node.addClass("imVoice--completed"):(this.node.addClass("imVoice--error"),this.showMatchError())},onStateUpdate:function(){this.updateFeedbackState(this.node),"feedback"===this.model.state||"answers"===this.model.state?this.recording.disable():this.recording.enable()},_serializeData:function(model){return{
text:_.map(model.children,function(part){return{isElement:"element"===part.type,text:part.text}}),timelimit:model.timelimit}},_initChildren:function(){this.children=_.map(this.model.elements,function(element,index){return new a5.views.interaction.IMVoiceElement(element,this,this.node.find(".imVoice__element").eq(index))},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.IMVoice"),a5.views.interaction.IMVoiceElement={init:function(model,parent,$el){this._super(model,parent,$el),model.bind("change",this.onChange,this)},onChange:function(){this.node.toggleClass("imVoice__element--matched",this.model.isMatched())}},a5.views.interaction.BaseView.extend("a5.views.interaction.IMVoiceElement"),a5.views.interaction.ISRadiobuttonVoice={template:"a5.view.ISRadiobuttonVoice",noMatchTemplate:"a5.view.dialog.ISRadiobuttonVoiceNoMatch",init:function(model){var html=a5.service.templates.render(this.template,this._serializeData(model)),$html=$(html);this._super(model,null,$html),this._initChoices(),_.bindAll(this,"onRecordStarted","onRecordEnded","onRecordProgress","onRecordError","onChoiceBlur"),this.model.recording&&(this.recording=new a5.views.interaction.SpeakingRecording(this.model.recording,{onSimpleRecordEnded:this.onRecordEnded,onSimpleRecordProgress:this.onRecordProgress,onSimpleRecordStarted:this.onRecordStarted,onSimpleRecordError:this.onRecordError})),this.model.bind("speech:start",this.onSpeechStart,this),this.model.bind("speech:result",this.onSpeechResult,this),this.model.bind("speech:error",this.onSpeechError,this),this.model.bind("clear",this.onClear,this),this.model.bind("state_update",this.onStateUpdate,this),this.node.on("focusout",this.onChoiceBlur)},render:function(){return _.invoke(this.choices,"render"),this.firstChoice.node.attr("tabindex",0),this.recording&&this.node.find(".isRadiobuttonVoice__recorder").append(this.recording.render()),this.model.isPrefilled()&&this.model.setSelected(this.model.getCorrect()),this.node},showMatchError:function(){this.warningDisplayed||(a5.view.dialog.display(this.noMatchTemplate,{dialogClass:"isRadiobuttonVoice__dialog"},{close:function(){this.warningDisplayed=!1}.bind(this)}),this.warningDisplayed=!0)},focusPreviousChoice:function(current){var index,prev;current===this.firstChoice?prev=this.lastChoice:(index=this.choices.indexOf(current),prev=this.choices[index-1]),current.node.attr("tabindex",-1),prev.node.attr("tabindex",0),prev.node.focus()},focusNextChoice:function(current){var index,next;current===this.lastChoice?next=this.firstChoice:(index=this.choices.indexOf(current),next=this.choices[index+1]),current.node.attr("tabindex",-1),next.node.attr("tabindex",0),next.node.focus()},onRecordStarted:function(){this.node.addClass("isRadiobuttonVoice--recording"),this.model.clear()},onRecordProgress:function(progress){this.node.attr("style","--progress:"+progress)},onRecordEnded:function(){this.node.removeClass("isRadiobuttonVoice--recording"),this.model.speechToText()},onRecordError:function(){this.node.removeClass("isRadiobuttonVoice--recording"),this.model.clear()},onClear:function(){this.node.removeClass("isRadiobuttonVoice--error isRadiobuttonVoice--completed"),this.node.attr("style","--progress:0")},onSpeechStart:function(){this.node.addClass("isRadiobuttonVoice--processing")},onSpeechError:function(){this.node.removeClass("isRadiobuttonVoice--processing"),this.node.addClass("isRadiobuttonVoice--error"),this.showMatchError()},onSpeechResult:function(data){this.node.removeClass("isRadiobuttonVoice--completed"),this.node.removeClass("isRadiobuttonVoice--processing"),this.model.selected?this.node.addClass("isRadiobuttonVoice--completed"):(this.node.addClass("isRadiobuttonVoice--error"),this.showMatchError())},onChoiceBlur:function(){0===this.node.find("[tabindex=0]").length&&this.firstChoice.node.attr("tabindex",0)},onStateUpdate:function(){this.model.isCorrectable()&&("feedback"===this.model.state||"answers"===this.model.state?this.recording.disable():this.model.tryAgainIsFrozen||this.recording.enable(),_.invoke(this.choices,"updateState",this.model.state))},_serializeData:function(model){return{choices:model.choices,timelimit:model.timelimit}},_initChoices:function(){this.choices=_.map(this.model.choices,function(choice){var $choice=this.node.find("[data-identifier="+choice.value+"]");return new a5.views.interaction.ISRadiobuttonChoiceVoice(choice,this,$choice)},this),this.firstChoice=_.first(this.choices),this.lastChoice=_.last(this.choices)}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRadiobuttonVoice"),a5.views.interaction.ISRadiobuttonChoiceVoice={init:function(model,parent,$el){this._super(model,parent,$el),_.bindAll(this,"onClick","onKeydown"),this.node.on("click",this.onClick),this.node.on("keydown",this.onKeydown),this.model.bind("change",this.onChange,this)},render:function(){this.node.attr("tabindex",-1),a5.utils.buildModel(this.model.interaction,this.node,this.model.content.contents()),this.model.enumeration&&(this.node.prepend('<span class="enum-placeholder"></span>'),this.model.enumeration.then(function(enumSymbol){this.node.find(".enum-placeholder").replaceWith(enumSymbol)}.bind(this)))},select:function(){this.node.attr("aria-selected",!0),this.node.addClass("isRadiobuttonVoice__item--selected")},unselect:function(){this.node.removeAttr("aria-selected"),this.node.removeClass("isRadiobuttonVoice__item--selected")},onClick:function(){_.each(this.parent.choices,function(choice){choice.node.attr("tabindex",-1)}),this.node.attr("tabindex",0)},onChange:function(){this.model.selected?this.select():this.unselect()},onKeydown:function(e){var KEYS=a5.utils.keyCodes;switch(e.keyCode){case KEYS.UP:case KEYS.LEFT:this.parent.focusPreviousChoice(this);break;case KEYS.DOWN:case KEYS.RIGHT:this.parent.focusNextChoice(this);break;default:return}e.preventDefault(),e.stopPropagation()},updateState:function(state){this.updateFeedbackState(state),this.unbindAnswerFeedback(),this.node.removeClass("has-feedback"),this.node.find(".check").remove();var tooltip=this.model.answerFeedback||this.parent.model.getAnswerFeedback();"feedback"===state?this.model.selected&&(this.addCheck({correct:this.model.correct,tooltip:tooltip}),this.bindAnswerFeedback(this,{correct:this.model.correct}),this.node.toggleClass("has-feedback",!!tooltip)):"answers"===state&&(this.model.correct?(this.addCheck({empty:!this.model.selected,correct:this.model.selected,tooltip:tooltip}),this.bindAnswerFeedback(this),this.node.toggleClass("has-feedback",!!tooltip),this.select()):this.model.selected&&(this.addCheck({correct:!1,tooltip:tooltip}),this.bindAnswerFeedback(this),this.node.toggleClass("has-feedback",!!tooltip)))},updateFeedbackState:function(state){this.node.removeClass("checked-empty checked-incorrect checked-correct"),this.node.removeClass("solution-empty solution-incorrect solution-correct solution-revealed");var type;if("feedback"===state)type="checked";else{if("answers"!==state)return;type="solution"}if(this.parent.model.isRevealedBySeeNext()&&this.model.correct)return void this.node.addClass("solution-revealed");this.model.correct&&this.model.selected?this.node.addClass([type,"correct"].join("-")):this.model.selected?this.node.addClass([type,"incorrect"].join("-")):this.node.addClass([type,"empty"].join("-"))}},a5.views.interaction.BaseView.extend("a5.views.interaction.ISRadiobuttonChoiceVoice"),a5.view.controls={},a5.view.controls.noValidationInteractions=["Identify:Select:Maze","Identify:Select:Pelmanism","Identify:Select:Target game","Input:Creative:Dialogue recording","Input:Creative:Extended writing","Input:Creative:Free writing","Input:Creative:Free writing 2 col","Present:Present:Flashcards","Present:Present:Present","Present:Present:Quiz","Present:Present:Slideshow"],a5.views.interaction.BaseView.extend("a5.view.controls.BaseBar",{mapEventActions:{"interaction:min_length:change":["submit","forward"],"interaction:fill:change":["submit","check","answers","forward","solution_hint"],"interaction:state:change":["special_chars","signal","hide_signal","submit","check","next_answer","all_answer","solution_hint","answers","retry","sendscores","forward","is-hangman-answers","pp-quiz-skip","pp-quiz-back"],"interaction:show_next_answer":["submit","check","next_answer","all_answer","retry","sendscores","forward","is-hangman-answers","solution_hint"],"interaction:show_all_answer":["submit","check","next_answer","all_answer","retry","sendscores","forward","is-hangman-answers","solution_hint"],"interaction:show_solution_hint":["submit","check","solution_hint","retry","sendscores","forward","is-hangman-answers","next_answer","all_answer"]},init:function(parameters){this._super(parameters.lo,null,parameters.$el),this.lo=parameters.lo,_.chain(this.mapEventActions).keys().each(function(eventName){a5.eventBus.bind(eventName,function(interaction){interaction===this.getInteraction()&&this.updateByEvent(eventName)},this)},this)},update:function(){_.invoke(this.buttons,"update")},updateByEvent:function(event){var actions=this.mapEventActions[event];_.chain(actions).map(function(action){return _.where(this.buttons,{action:action})},this).flatten().invoke("update")},isNoValidationInteraction:function(interaction){return _.contains(a5.view.controls.noValidationInteractions,interaction.identifier)},getInteraction:function(){return this.interaction||this.lo.getCurrentInteraction()},createButtonViews:function(){this.buttons=[],_.each(this.$("*[data-event]"),function(e){var button,action=$(e).attr("data-event"),params={lo:this.lo,interaction:this.getInteraction(),toolbar:this,$el:$(e)};switch(action){case"special_chars":button=new a5.view.controls.SpecialCharsButton(params);break;case"hints":button=new a5.view.controls.HintsButton(params),this.hintsButton=button;break;case"pauseboxdrop":button=new a5.view.controls.PauseBoxdropButton(params);break;case"toc":button=new a5.view.controls.TocButton(params),this.tocButton=button;break;case"display-settings":button=new a5.view.controls.DisplaySettingsButton(params),this.displaySettingsButton=button;break;case"rights":button=new a5.view.controls.RightsButton(params),this.rightsButton=button;break;case"reveal":button=new a5.view.controls.RevealButton(params);break;case"hide":button=new a5.view.controls.HideButton(params);break;default:button=new a5.view.controls.Button(params)}this.buttons.push(button)},this),_.each(this.$(".scoredisplay"),function(e){this.buttons.push(new a5.view.controls.Score({lo:this.lo,interaction:this.getInteraction(),toolbar:this,$el:$(e)}))},this),_.each(this.$("*[data-interaction]"),function(e){this.buttons.push(new a5.view.controls.InteractionButton({lo:this.lo,interaction:this.getInteraction(),toolbar:this,$el:$(e)}))},this),_.each(this.$(".pagination"),function(e){this.buttons.push(new a5.view.controls.Pagination({lo:this.lo,interaction:this.getInteraction(),toolbar:this,$el:$(e)}))},this)},action:function(id){var lo=this.lo,interaction=this.getInteraction();switch(id){case"check":interaction.options.checkanswersinstantIsOn()?lo.checkAnswerInput():lo.checkAnswer();break;case"answers":case"is-hangman-answers":lo.showAnswer();break;case"next_answer":lo.showNextAnswer();break;case"all_answer":lo.showAllAnswer();break;case"solution_hint":lo.showSolutionHint();break;case"forward":lo.goNext();break;case"previous":lo.goPrev();break;case"forward_skip":lo.goLast(!0);break;case"previous_skip":lo.goFirst();break;case"forward_lo":lo.goToNextLO();break;case"previous_lo":lo.goToPrevLO();break;case"retry":lo.tryAgain();break;case"reset":lo.reset();break;case"reset_all":lo.resetAll();break;case"reload_item_bank":lo.reloadItemBank();break;case"boxdrop":interaction.trigger("boxdrop");break;case"pauseboxdrop":interaction.trigger("pause-boxdrop");break;case"reveal":lo.reveal();break;case"hide":lo.hideRevealed();break;case"hints":this.hintsButton.showHint();break;case"help_text":interaction.showHelpText();break;case"signal":lo.signal();break;case"hide_signal":lo.hideSignal();break;case"submit":lo.submit();break;case"sendscores":lo.sendScores();break;case"language_selector":break;case"results":lo.trigger("score_update"),lo.goToResultScreen();break;case"exercises":lo.goToExerciseScreen();break;case"save":lo.save();break;case"mic_settings":a5.service.media.audio_recorder.ready().then(function(){a5.service.media.audio_recorder.instance().show_mic_settings()});break;case"special_chars":interaction.insertSpecialCharacterDialog();break;case"display-settings":this.displaySettingsButton.openDisplaySettings();break;case"toc":this.tocButton.openToc();break;case"export":interaction.insertExportDialog();break;case"book":lo.openDigitalBook();break;case"lo-notes":lo.openNotes();break;case"notes":lo.showLessonNotes(this);break;case"lesson":lo.showLesson(this);break;case"tools":lo.toggleToolbox(this);break;case"wiki":lo.showWiki(this);break;case"fullscreen":lo.fullscreen();break;case"rights":this.rightsButton.openDialog();break;case"im-proofing-hint":interaction.trigger("im-proofing-hint");break;case"time-spent-in-sections":lo.showTimeSpentInSections();break;case"pp-quiz-skip":interaction.trigger("pp-quiz:skip");break;case"pp-quiz-back":interaction.trigger("pp-quiz:back");break;case"pp-quiz-new":interaction.trigger("pp-quiz:new");break;case"pp-quiz-restart":interaction.trigger("pp-quiz:restart")}},getStatus:function(buttonId){if(_.isUndefined(buttonId)){var buttons=this._findAllButtons();return _.invoke(buttons,"serialize")}var button=this._findButtonById(buttonId);if(button)return button.serialize()},enableVisibility:function(){this.node.css("visibility","")},disableVisibility:function(){this.node.css("visibility","hidden")},_findAllButtons:function(){return this.buttons.filter(function(button){return!!button.action})},_findButtonById:function(id){return this.buttons.find(function(button){return button.action&&button.action===id})}}),a5.view.controls.BaseBar.extend("a5.view.controls.interaction.Bar",{template:"a5.view.controls.interaction.Bar",init:function(parameters){this._super(parameters),this.interaction=parameters.interaction},render:function(){var html=a5.service.templates.render(this.template);this.node.html(html),this.createButtonViews(),this.update()},action:function(id){this.lo.curInteraction=this.interaction,this._super(id)}}),a5.view.controls.BaseBar.extend("a5.view.controls.Bar",{template:"a5.view.controls.Bar",render:function(){this.disableVisibility();var html=a5.service.templates.render(this.template,this.createTemplateModel());this.node.append(html),this.lo.options(!0).continuousEnumerationIsOn()&&(this.enumeration_nav=new a5.view.controls.EnumerationNavBar,this.node.prepend(this.enumeration_nav.render())),this.createButtonViews(),this.update(),this.enableVisibility(),a5.callbacks.controls.bar.trigger("added",this.node)},showHints:function(){this.hintsButton.showHint()},createTemplateModel:function(){var interactions=[],showSubmitData=this.lo.options(!0).getShowSubmit();if(this.lo.introScreen){var nextButtonLabel=this.lo.introScreen.options.getNextbuttontext();interactions.push({index:-1,name:0,nextButtonLabel:"default"===nextButtonLabel?"":nextButtonLabel})}return _.each(this.lo.intList,function(i){if(!i.isEndResultScreen()){var nextButtonLabel=i.options.getNextbuttontext();interactions.push({index:i.index,name:i.index+1,nextButtonLabel:"default"===nextButtonLabel?"":nextButtonLabel})}}),{interactions:interactions,screenSelection:a5.mainBuilder.options(!0).progressBarIsScreenSelection(),submitText:showSubmitData.submitText,submitTooltip:showSubmitData.submitTooltip,nextButtonLabelSupport:!0}}}),a5.view.controls.getEndResultOption=function(interaction){var ret={};return interaction.options.endResultScreenIsFalse()?interaction.options.endResultAlwaysIsOff()||(ret=interaction.options.getEndResultAlways()):ret=interaction.options.getEndResultScreen(),ret},a5.view.controls.statusReaders={results:function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=!1,active=!1;if(!interaction.isEndResultScreen()){if(interaction.options.endResultScreenIsFalse())interaction.options.endResultAlwaysIsOff()||(visible=active=!0);else if(visible=active=(lo.canSubmit||lo.canSendScores)&&!lo.isFirstAttempt(),interaction.options.endResultsButtonIsLast()){var lastScreen=interaction.isLastInteraction();visible=visible&&lastScreen,active=active&&lastScreen}var endResult=a5.view.controls.getEndResultOption(interaction);endResult.resultsLabel&&a5.utils.setLabel(button.node,endResult.resultsLabel),endResult.canReturn||(visible=active=!1)}return[visible,active]},special_chars:function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=interaction.options.getSpecialcharactersStudent().length>0,iID=interaction.identifier;if(visible=visible&&_.contains(["Input:Creative:Free writing","Input:Creative:Extended writing","Input:Completion:Crossword","Input:Completion:Text correction","Input:Completion:Text gap","Input:Completion:Text gap (Label an object)"],iID),_.contains(["Input:Creative:Free writing","Input:Creative:Extended writing"],iID)){var text_inputs_count=interaction.$(".a5-textinput").length;visible=visible&&0!=text_inputs_count}return[visible,a5.specialCharInserter.isActive()&&"input"===interaction.getStatus()]},exercises:function(lo,interaction,button){if(!interaction)return[!1,!1];if(interaction.isEndResultScreen()){var endResult=a5.view.controls.getEndResultOption(interaction);if(endResult.exercisesLabel)return a5.utils.setLabel(button.node,endResult.exercisesLabel),[!0,!0]}return[!1,!1]},signal:function(lo,interaction,button){if(!interaction)return[!1,!1];if(interaction.isEndResultScreen())return[!1,!1];var isTextCorrection="Input:Completion:Text correction"===interaction.identifier,isOff=interaction.options.signalErrorIsOff()||interaction.options.signalErrorIsHighlight(),isInputStatus="input"===interaction.getStatus(),isNotSignaled=!interaction.signalErrorActive,active=interaction.options.signalErrorIsButton()||interaction.options.signalErrorIsButtonAfterAttempts()&&lo.canSubmit&&!lo.hasMoreSubmitAttempts();return[isTextCorrection&&isNotSignaled&&!isOff,active&&isInputStatus]},hide_signal:function(lo,interaction,button){if(!interaction)return[!1,!1];if(interaction.isEndResultScreen())return[!1,!1];var isTextCorrection="Input:Completion:Text correction"===interaction.identifier,isOff=interaction.options.signalErrorIsOff()||interaction.options.signalErrorIsHighlight(),isInputStatus="input"===interaction.getStatus(),isSignaled=interaction.signalErrorActive;return[isTextCorrection&&isSignaled&&!isOff,isInputStatus]},hints:function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=!1,active=!1;if(interaction.options.showhintsIsAlways())visible=!0,active=!0;else if(interaction.options.showhintsIsCheckScore()&&(visible=!0,interaction.lastScore)){var hints_with_attempts=interaction.options.getValue("318").split("|"),hintPercent=parseInt(hints_with_attempts[0],10),hintAttempts=parseInt(hints_with_attempts[1],10)||0,percent=interaction.lastScore.percent(!0),attempts=interaction.checkAttempts;percent<hintPercent&&attempts>=hintAttempts&&(active=!0)}return[visible,active]},help_text:function(lo,interaction,button){return interaction&&interaction.options.activityhelpIsOn()?[!0,!0]:[!1,!1]},submit:function(lo,interaction,button){return!interaction||interaction.isEndResultScreen()||lo.options(!0).sendscoresIsFinal_check_answers()||"Formative"===LOInfo.mode?[!1,!1]:$.when(interaction.getResultsAsync(),lo.isFilled(),lo.areAllFilled()).then(function(results,loSomeFilled,loAllFilled){var active,afterCheckAnswers=!1;if(interaction.options.showForwardIsAfterCheckAnswers()){var reachedSubmitAttempts=lo.canSubmit&&!lo.hasMoreSubmitAttempts(),reachedCheckMaxAttempts=!reachedSubmitAttempts&&!interaction.hasMoreCheckAttempts(),percentageTreshold=parseFloat(interaction.options.getShowForward())||0;afterCheckAnswers=interaction.options.showForwardIsAfterCheckAnswers()&&(button.isNoValidationInteraction(interaction)||"input"!==interaction.getStatus()&&(reachedCheckMaxAttempts||results.percent(!0)>=percentageTreshold)||"input"===interaction.getStatus()&&"answers"===interaction.getItemsState())}if(lo.options(!0).finishSubmitIsOn())return active=lo.curTask==lo.numberOfInteractions()-1,[active,active];if(lo.options(!0).showSubmitIsEachScreen())return lo.hasMoreSubmitAttempts()?(active=!lo.justSubmitted,interaction.options.showForwardIsAfterCheckAnswers()&&(active=active&&afterCheckAnswers),[!0,active]):[!1,!1];var visible=lo.canSubmit&&lo.curTask==lo.numberOfInteractions()-1&&lo.hasMoreSubmitAttempts(),afterAll=lo.options(!0).showSubmitIsAfterAll()&&loAllFilled,afterOne=lo.options(!0).showSubmitIsAfterOne()&&loSomeFilled;return active=(lo.options(!0).showSubmitIsAlways()||afterOne||afterAll)&&!lo.justSubmitted,interaction.options.showForwardIsAfterCheckAnswers()&&(active=active&&afterCheckAnswers),active=active&&_.every(lo.intList,function(i){return!i.options.showSubmitIsAfterAll()||i.meetsMinLength()}),lo.options(!0).showSubmitIsOff()&&(visible=!1),interaction.options.seeAnswersIsBeforeInteraction()&&"Identify:Select:Pelmanism"===interaction.identifier&&lo.options(!0).showSubmitIsAlways()&&(active=active&&results.isPercent100(!0)||"answers"===interaction.getStatus()),[visible,active]})},check:function(lo,interaction,button){return interaction?interaction.isEndResultScreen()?[!1,!1]:$.when(interaction.isFilled(),interaction.areAllFilled()).then(function(someFilled,allFilled){var visible,active;if(interaction.options.checkanswersinstantIsOn())return visible=(someFilled||allFilled)&&!button.isNoValidationInteraction(interaction),active="input"===interaction.getStatus(),[visible,active];if(lo.options(!0).finishSubmitIsOn())return[!1,!1];if(interaction.options.seeAnswersIsBeforeInteraction()&&"input"===interaction.getStatus()&&!someFilled)return[!1,!1];var beforeSubmitted=lo.options(!0).checkAnswersIsBeforeSubmitted()&&(!lo.canSubmit||lo.hasMoreSubmitAttempts());visible=lo.options(!0).checkAnswersIsAlways()||lo.options(!0).checkAnswersIsAfterAll()||lo.options(!0).checkAnswersIsAfterOne()||beforeSubmitted,visible=visible&&!button.isNoValidationInteraction(interaction),active="input"===interaction.getStatus()&&"answers"!==interaction.getItemsState();var afterAll=lo.options(!0).checkAnswersIsAfterAll()&&allFilled,afterOne=lo.options(!0).checkAnswersIsAfterOne()&&someFilled;return active=(lo.options(!0).checkAnswersIsAlways()||afterOne||afterAll||beforeSubmitted)&&active,lo.options(!0).showSubmitIsOff()||!lo.hasMoreSubmitAttempts()||lo.options(!0).checkAnswersIsBeforeSubmitted()||(visible=!1),lo.getCheckMaxAttemptsNumber()&&(active=interaction.hasMoreCheckAttempts()&&active),[visible,active]}):[!1,!1]},next_answer:function(lo,interaction,button){return interaction?[interaction.options.seenextanswerIsOn(),"answers"!==interaction.getItemsState()&&"answers"!==interaction.getStatus()]:[!1,!1]},all_answer:function(lo,interaction,button){return interaction?[interaction.options.seeallanswersIsOn(),"answers"!==interaction.getStatus()]:[!1,!1]},solution_hint:function(lo,interaction,button){return interaction?$.when(interaction.canShowSolutionHint()).then(function(canShowSolutionHint){return[interaction.options.solutionHintIsOn(),canShowSolutionHint&&!interaction.hasShownSolutionHint()&&"answers"!==interaction.getStatus()]}):[!1,!1]},answers:function(lo,interaction,button){return interaction?interaction.isEndResultScreen()?[!1,!1]:lo.options(!0).finishSubmitIsOn()?[!1,!1]:$.when(interaction.getResultsAsync(),interaction.isFilled(),interaction.areAllFilled()).then(function(results,someFilled,allFilled){if(interaction.options.seeAnswersIsBeforeInteraction()){if("Identify:Select:Pelmanism"===interaction.identifier){if(results.isPercent100(!0))return[!1,!1];if("input"===interaction.getStatus()&&(someFilled||allFilled))return[!0,!0]}if("input"===interaction.getStatus()&&!someFilled)return[!0,!0];if("input"===interaction.getStatus()&&(someFilled||allFilled))return[!1,!1];if("corrected"===interaction.getStatus()&&(someFilled||allFilled)&&!results.isPercent100(!0))return[!0,!0]}var visible=interaction.options.seeAnswersIsOn();visible=visible&&(!lo.options(!0).showSubmitIsOff()||!lo.options(!0).checkAnswersIsFalse());var onlyCheckAnswersActive=interaction.options.showSubmitIsOff()&&!interaction.options.checkAnswersIsFalse();visible=visible&&(lo.canSubmit&&!lo.hasMoreSubmitAttempts()||onlyCheckAnswersActive);var active="corrected"===interaction.getStatus();visible=visible&&!button.isNoValidationInteraction(interaction);var afterAll=lo.options(!0).checkAnswersIsAfterAll()&&allFilled,afterOne=lo.options(!0).checkAnswersIsAfterOne()&&someFilled,always=lo.options(!0).checkAnswersIsAlways(),scored100="corrected"===interaction.getStatus()&&results.isPercent100(!0),reachedSubmitAttempts=lo.canSubmit&&!lo.hasMoreSubmitAttempts();if(active=(always||afterOne||afterAll||reachedSubmitAttempts)&&!scored100&&active,lo.getCheckMaxAttemptsNumber()&&!reachedSubmitAttempts){var checkAttemptsAvailable=interaction.hasMoreCheckAttempts();active=!checkAttemptsAvailable&&"answers"!==interaction.getStatus()&&!scored100,visible=interaction.options.seeAnswersIsOn()&&!checkAttemptsAvailable}return[visible,active]}):[!1,!1]},retry:function(lo,interaction,button){return interaction?interaction.isEndResultScreen()?[!1,!1]:lo.options(!0).finishSubmitIsOn()?[!1,!1]:$.when(interaction.getResultsAsync()).then(function(results){var reachedSubmitAttempts=lo.canSubmit&&!lo.hasMoreSubmitAttempts(),canCheckAnswersAfterSubmitted=lo.options(!0).checkAnswersIsAlways()||lo.options(!0).checkAnswersIsAfterAll()||lo.options(!0).checkAnswersIsAfterOne(),visible=!interaction.options.tryAgainIsFalse();visible=visible&&interaction.options.tryAgainBehaviourIsButton(),visible=visible&&!button.isNoValidationInteraction(interaction),visible=visible&&(!reachedSubmitAttempts||canCheckAnswersAfterSubmitted);var active="corrected"===interaction.getStatus()||"answers"===interaction.getStatus();active=active&&!interaction.isShowingAnswers(),active=active&&interaction.hasMoreCheckAttempts();var scored100="corrected"===interaction.getStatus()&&results.isPercent100(!0),hide_tryagain_100=interaction.options.getTryAgain().indexOf("hide_at_100")>=0;return visible=visible&&(!scored100||!hide_tryagain_100),[visible,active]}):[!1,!1]},reset:function(lo,interaction,button){if(!interaction)return[!1,!1];if(interaction.isEndResultScreen())return[!1,!1];if(("Formative"===LOInfo.mode||"Summative"===LOInfo.mode)&&interaction.isIntroScreen())return[!1,!1];return[interaction.options.resetIsOn()||interaction.options.resetIsBeforeSubmitted()&&(!lo.canSubmit||lo.hasMoreSubmitAttempts()),!0]},reset_all:function(lo,interaction,button){if(!interaction)return[!1,!1];var lastScreen=interaction.isLastInteraction(!0),visible=lo.options(!0).resetWholeLOIsOn()&&lastScreen&&(!lo.canSubmit&&!lo.canSendScores||!lo.isFirstAttempt());return[visible,visible]},reload_item_bank:function(lo,interaction,button){if(!interaction)return[!1,!1];return["item-bank"===interaction.source&&(interaction.options.resetIsOn()||interaction.options.resetIsBeforeSubmitted()&&(!lo.canSubmit||lo.hasMoreSubmitAttempts())),!0]},boxdrop:function(lo,interaction,button){if(!interaction)return[!1,!1];return["Order:Sort:Box drop"===interaction.identifier,!0]},pauseboxdrop:function(lo,interaction,button){if(!interaction)return[!1,!1];return["Order:Sort:Box drop"===interaction.identifier,!0]},reveal:function(lo,interaction,button){return interaction?interaction.isEndResultScreen()?[!1,!1]:[!(interaction.options.revealObjectIsFalse()||interaction.revealIsHiding)||interaction.options.revealObjectIsProgressiveplushide()&&a5.dp.config.revealHideAlwaysVisible,interaction.hasHiddenElements()]:[!1,!1]},hide:function(lo,interaction,button){return interaction?interaction.isEndResultScreen()?[!1,!1]:[interaction.options.revealObjectIsProgressiveplushide()&&(interaction.revealIsHiding||a5.dp.config.revealHideAlwaysVisible),!interaction.options.revealObjectIsProgressiveplushide()||interaction.hasRevealedElements()]:[!1,!1]},save:function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=interaction.options.saveIsSkinbutton()||interaction.options.saveIsButton_only();return[visible,visible]},sendscores:function(lo,interaction,button){return interaction?interaction.isEndResultScreen()||lo.options(!0).sendscoresIsFinal_check_answers()?[!1,!1]:$.when(interaction.getResultsAsync()).then(function(results){var visible=lo.canSendScores&&lo.curTask===lo.numberOfInteractions()-1&&lo.hasMoreSendScoreAttempts(),active=!0;if(interaction.options.showForwardIsAfterCheckAnswers()||interaction.options.showForwardIsAfterSeeAnswers()){var reachedCheckMaxAttempts=lo.hasMoreSendScoreAttempts()&&!interaction.hasMoreCheckAttempts(),percentageTreshold=parseFloat(interaction.options.getShowForward())||0,afterCheckAnswers=interaction.options.showForwardIsAfterCheckAnswers()&&(button.isNoValidationInteraction(interaction)||"input"!==interaction.getStatus()&&(reachedCheckMaxAttempts||results.percent(!0)>=percentageTreshold)||"input"===interaction.getStatus()&&"answers"===interaction.getItemsState()),afterSeeAnswers=interaction.options.showForwardIsAfterSeeAnswers()&&(button.isNoValidationInteraction(interaction)||"answers"===interaction.getStatus()||"corrected"===interaction.getStatus()&&results.percent(!0)>=percentageTreshold||"input"===interaction.getStatus()&&"answers"===interaction.getItemsState());active=active&&(afterSeeAnswers||afterCheckAnswers)}return[visible,active]}):[!1,!1]},previous:function(lo,interaction,button){if(!interaction||interaction.isEndResultScreen()||interaction.isIntroScreen())return[!1,!1];var visible=interaction.options.previousIsTrue()||interaction.options.previousIsAfterSubmitted()&&lo.canSubmit&&!lo.hasMoreSubmitAttempts();return visible=visible&&lo.hasPrev(),[visible,lo.hasPrev()]},forward:function(lo,interaction,button){return interaction?interaction.isEndResultScreen()?[!1,!1]:$.when(interaction.getResultsAsync(),interaction.isFilled(),interaction.areAllFilled()).then(function(results,someFilled,allFilled){var isPelmanism="Identify:Select:Pelmanism"===interaction.identifier,isSpeakingRecording="Present:Present:Present"===interaction.identifier&&interaction.getItemsByClass("a5.models.interaction.SpeakingRecording").length>0,isDialogueRecording="Input:Creative:Dialogue recording"===interaction.identifier,isPPFlashcards="Present:Present:Flashcards"===interaction.identifier,isPresentationWithRevealObject="Present:Present:Present"===interaction.identifier&&!interaction.options.revealObjectIsFalse(),lastPage=!lo.hasNext(!0),visible=interaction.options.showForwardIsAlways()||interaction.options.showForwardIsAfterOne()||interaction.options.showForwardIsAfterAll()||interaction.options.showForwardIsAfterCheckAnswers()||interaction.options.showForwardIsAfterSeeAnswers()||interaction.options.showForwardIsAfterSubmitted()&&lo.canSubmit&&!lo.hasMoreSubmitAttempts()||interaction.isIntroScreen()||button.isNoValidationInteraction(interaction);visible=visible&&!interaction.options.showForwardIsOff()&&lo.hasNext(!0);var always=interaction.options.showForwardIsAlways(),afterOne=interaction.options.showForwardIsAfterOne()&&someFilled,afterAll=interaction.options.showForwardIsAfterAll()&&(isPelmanism&&"answers"===interaction.getStatus()||allFilled);(isPPFlashcards||isDialogueRecording||isSpeakingRecording)&&(afterOne=interaction.options.showForwardIsAfterOne()&&someFilled,afterAll=interaction.options.showForwardIsAfterAll()&&allFilled),isPresentationWithRevealObject&&(afterOne=afterOne||interaction.options.showForwardIsAfterOne()&&interaction.wasRevealedOneElement(),afterAll=afterAll&&interaction.options.showForwardIsAfterAll()&&interaction.wereRevealedAllElements())
;var reachedSubmitAttempts=lo.canSubmit&&!lo.hasMoreSubmitAttempts(),reachedCheckMaxAttempts=!reachedSubmitAttempts&&!interaction.hasMoreCheckAttempts(),percentageTreshold=parseFloat(interaction.options.getShowForward())||0,afterCheckAnswers=interaction.options.showForwardIsAfterCheckAnswers()&&(button.isNoValidationInteraction(interaction)||"input"!==interaction.getStatus()&&(reachedCheckMaxAttempts||results.percent(!0)>=percentageTreshold)||"input"===interaction.getStatus()&&"answers"===interaction.getItemsState()),afterSeeAnswers=interaction.options.showForwardIsAfterSeeAnswers()&&(button.isNoValidationInteraction(interaction)||"answers"===interaction.getStatus()||"corrected"===interaction.getStatus()&&results.percent(!0)>=percentageTreshold||"input"===interaction.getStatus()&&"answers"===interaction.getItemsState()),confidenceLevel=lo.confidenceLevel,introAndConfidence=interaction.isIntroScreen();return introAndConfidence&&!_.isUndefined(confidenceLevel)&&(introAndConfidence=""!=confidenceLevel[0]||interaction.options.showForwardIsAfterSubmitted()&&""==confidenceLevel[1]),interaction.options.showForwardIsAfterAll()&&(afterAll=afterAll&&interaction.meetsMinLength()),[visible,(always||afterOne||afterAll||afterCheckAnswers||afterSeeAnswers||reachedSubmitAttempts||introAndConfidence)&&!lastPage]}):[!1,!1]},previous_skip:function(lo,interaction,button){if(!interaction)return[!1,!1];if(interaction.isEndResultScreen())return[!1,!1];if(interaction.isIntroScreen())return[!1,!1];var visible=interaction.options.previousIsTrue();return visible=visible&&lo.numberOfInteractions()>2,[visible,lo.hasPrev()]},forward_skip:function(lo,interaction,button){if(!interaction)return[!1,!1];if(interaction.isEndResultScreen())return[!1,!1];var visible=interaction.options.showForwardIsAlways()||interaction.options.showForwardIsAfterOne();return visible=visible&&lo.numberOfInteractions()>2,[visible,!!lo.hasNext(!0)]},forward_lo:function(lo,interaction,button){if(!interaction)return[!1,!1];var lastScreen=interaction.isLastInteraction(),active=lo.hasNextLO();return[interaction.options.showNextLOIsOn()&&lastScreen&&(!lo.canSubmit&&!lo.canSendScores||!lo.isFirstAttempt()),active]},previous_lo:function(lo,interaction,button){if(!interaction)return[!1,!1];var lastScreen=interaction.isLastInteraction(),active=lo.hasPrevLO();return[interaction.options.showPreviousLOIsOn()&&lastScreen&&(!lo.canSubmit&&!lo.canSendScores||!lo.isFirstAttempt()),active]},mic_settings:function(lo,interaction,button){return[!1,!1]},export:function(lo,interaction,button){if(!interaction)return[!1,!1];var active=interaction.options.exportFileIsOn();return[active,active]},book:function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=!!window.LOInfo.bookUrl;return[visible,visible]},"lo-notes":function(lo,interaction,button){return interaction?[lo.options(!0).lONotesAreaIsOn(),!0]:[!1,!1]},notes:function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=lo.lessonNotes&&lo.lessonNotes.hasNotes();return[visible,visible&&!lo.lessonNotes.isActive()]},lesson:function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=lo.lessonNotes&&lo.lessonNotes.hasNotes();return[visible,visible&&lo.lessonNotes.isActive()]},tools:function(lo,interaction,button){return interaction?[!0,!0]:[!1,!1]},wiki:function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=!!A5.WIKI&&interaction.wikiTool&&interaction.wikiTool.hasWiki();return[visible,visible]},fullscreen:function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=interaction.options.lOfullscreenbuttonIsOn();return[visible,visible]},"display-settings":function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=lo.options(!0).displaySettingsIsOn();return[visible,visible]},toc:function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=!lo.options(!0).navigationMenuIsOff();return[visible,visible]},rights:function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=interaction.options.copyrightInformationIsOn()&&interaction.resources&&interaction.resources.length&&_.some(interaction.resources,"rights");return[visible,visible]},"im-proofing-hint":function(lo,interaction,button){if(!interaction)return[!1,!1];var visible="Identify:Mark:Proofing"===interaction.identifier&&interaction.options.signaltargetsIsOn();return[visible,visible]},"is-hangman-answers":function(lo,interaction,button){return interaction?["Identify:Select:Hangman"===interaction.identifier&&interaction.options.revealSolutionIsWith_button(),"answers"!==interaction.getItemsState()&&"answers"!==interaction.getStatus()]:[!1,!1]},"time-spent-in-sections":function(lo,interaction){return interaction&&interaction.isEndResultScreen()&&interaction.options.timeSpentinSectionsIsOn()&&lo.options(!0).getLOParts().length>0?[!0,!0]:[!1,!1]},"pp-quiz-skip":function(lo,interaction,button){if(!interaction)return[!1,!1];var allowSkip=interaction.parent&&interaction.parent.options.skipIsOn(),visible=interaction.parent&&"Present:Present:Quiz"===interaction.parent.identifier;visible=visible&&"input"===interaction.getStatus()&&allowSkip;return[visible,!0]},"pp-quiz-back":function(lo,interaction,button){if(!interaction)return[!1,!1];var visible=interaction.parent&&"Present:Present:Quiz"===interaction.parent.identifier;visible=visible&&("input"!==interaction.getStatus()||"answers"===interaction.items.state);return[visible,!0]},"pp-quiz-new":function(lo,interaction,button){if(!interaction)return[!1,!1];var allowNewGame=interaction.options.newGameIsOn();return["Present:Present:Quiz"===interaction.identifier&&allowNewGame,!0]},"pp-quiz-restart":function(lo,interaction,button){if(!interaction)return[!1,!1];var allowRestartGame=interaction.options.restartGameIsOn();return["Present:Present:Quiz"===interaction.identifier&&allowRestartGame,!0]}},a5.views.interaction.BaseView.extend("a5.view.controls.Button",{init:function(parameters){this._super(parameters.lo,parameters.toolbar,parameters.$el),this.action=this.node.attr("data-event"),this.interaction=parameters.interaction,this.lo=parameters.lo,this.toolbar=parameters.toolbar,this.getStatusFn=a5.view.controls.statusReaders[this.action],_.bindAll(this,"onClick"),this.node.on("click",this.onClick),this.hide(),this.disable()},execute:function(){this.toolbar.action(this.action)},isNoValidationInteraction:function(interaction){return this.toolbar.isNoValidationInteraction(interaction)},update:function(){var interaction=this.toolbar.getInteraction();if(_.isFunction(this.getStatusFn)&&interaction&&interaction.isLiveCycle("loaded")){var hasChanged=!1;$.when(this.getStatusFn(this.lo,interaction,this)).then(function(status){var visible=status[0],active=status[1];active!==this.active&&(active?this.enable():this.disable(),hasChanged=!0),visible!==this.visible&&(visible?this.show():this.hide(),hasChanged=!0),hasChanged&&a5.eventBus.trigger("lo:controls:change",this.serialize())}.bind(this))}},serialize:function(){return{action:this.action,visible:this.visible,active:this.active,label:this.node.text()}},onClick:function(e){e.preventDefault(),this.visible&&this.active&&this.execute()},hide:function(){this.visible=!1,this.node.addClass("button--hidden")},show:function(){this.visible=!0,this.node.removeClass("button--hidden")},enable:function(){this.active=!0,this.node.addClass("active_button"),this.node.removeClass("inactive_button"),this.node.removeAttr("disabled")},disable:function(){this.active=!1,this.node.addClass("inactive_button"),this.node.removeClass("active_button"),this.node.attr("disabled",!0)}}),a5.view.controls.Button.extend("a5.view.controls.PauseBoxdropButton",{execute:function(){this._super(),this.node.toggleClass("boxdrop-paused")}}),a5.view.controls.Button.extend("a5.view.controls.SpecialCharsButton",{DELAY_TIME:600,init:function(parameters){this._super(parameters),a5.specialCharInserter.bind("active inactive",function(){_.delay(_.bind(function(){this.update()},this),this.DELAY_TIME)},this)}}),a5.view.controls.Button.extend("a5.view.controls.HintsButton",{init:function(parameters){this._super(parameters),this.node.find(".hint-label.hint-2").hide(),this.node.find(".hint-label.hint-3").hide(),this.originalLabel1=this.node.find(".hint-label.hint-1").text(),this.originalLabel2=this.node.find(".hint-label.hint-2").text(),this.originalLabel3=this.node.find(".hint-label.hint-3").text(),_.bindAll(this,"onCloseHintDialog","beforeCloseHintDialog")},update:function(){this._super(),this.visible&&this.resetHintLabel()},onCloseHintDialog:function(){var interaction=this.toolbar.getInteraction();interaction.rubricZone.removeClass("hint-visible"),interaction.trigger("interaction:hint:close"),interaction.trigger("interaction:dialog:close"),delete this.$dialog},beforeCloseHintDialog:function(){a5.service.media.stop(this.$dialog)},showHint:function(){var interaction=this.toolbar.getInteraction();this.$dialog&&(this.$dialog.is(":ui-dialog")?this.$dialog.dialog("close"):this.$dialog.empty(),delete this.$dialog);var hints=this._getInteractionHints(interaction),hint=hints.items[hints.current].label;hint=(new a5.preprocessor.TextToSpeech).preprocess(hint),this.renderHint(hint),interaction.trigger("interaction:hint",hints.current),this.changeHintLabel(hints)},renderHint:function(label){var interaction=this.toolbar.getInteraction();$("<div>");interaction.rubricZone.addClass("hint-visible");var model={label:label,dialogClass:"dialog-hint"},callbacks={close:this.onCloseHintDialog,beforeclose:this.beforeCloseHintDialog};this.$dialog=a5.view.dialog.display("a5.view.dialog.Hint",model,callbacks,null,!0,a5.dp.config.appendHintsTo)},resetHintLabel:function(){var interaction=this.toolbar.getInteraction(),hints=this._getInteractionHints(interaction),label1=hints&&hints.items[0]&&hints.items[0].button||this.originalLabel1;this.node.find(".hint-label.hint-1").text(label1);var label2=hints&&hints.items[1]&&hints.items[1].button||this.originalLabel2;this.node.find(".hint-label.hint-2").text(label2);var label3=hints&&hints.items[2]&&hints.items[2].button||this.originalLabel3;this.node.find(".hint-label.hint-3").text(label3),this.showHintLabel(hints.current)},changeHintLabel:function(hints){hints.current=(hints.current+1)%hints.items.length,this.showHintLabel(hints.current)},showHintLabel:function(current){this.node.find(".hint-label").hide(),this.node.find(".hint-label.hint-"+(current+1)).show()},_getInteractionHints:function(interaction){if(interaction.hints)return interaction.hints;try{var hints=interaction.options.getHints();1==interaction.options.getVersion()&&(hints=hints.replace(/"/g,'\\"')),hints=JSON.parse(_.unescape(hints)),hints.current=0,interaction.hints=hints}catch(e){}return _.each(interaction.hints.items,function(item){var preprocessor=new a5.preprocessor.TranslationBlock;preprocessor.isResponsible(interaction,interaction.identifier,item.label)&&(item.label=preprocessor.preprocess(item.label))}),interaction.hints}}),a5.views.interaction.BaseView.extend("a5.view.controls.InteractionButton",{init:function(parameters){this._super(parameters.lo,parameters.toolbar,parameters.$el),this.lo=parameters.lo,this.toolbar=parameters.toolbar,this.index=parseInt(this.node.attr("data-interaction"),10),a5.eventBus.bind("interaction:fill:change",function(interaction){this.toolbar.getInteraction()===interaction&&this.update()},this)},update:function(){var interaction=this.lo.getInteractionFromIndex(this.index);this.$().off("click"),this.$().removeClass("selected"),this.$().removeClass("finished"),this.$().removeClass("locked"),interaction&&interaction===this.lo.getCurrentInteraction()&&this.$().addClass("selected"),interaction&&interaction.areAllFilled().then(function(allFilled){allFilled&&this.$().addClass("finished")}.bind(this)),interaction&&interaction.locked?this.$().addClass("locked"):this.$().on("click",_.bind(this.click,this))},click:function(){this.lo.goTo(this.index)}}),a5.views.interaction.BaseView.extend("a5.view.controls.Score",{init:function(parameters){this._super(parameters.lo,parameters.toolbar,parameters.$el),this.lo=parameters.lo,this.interaction=parameters.interaction,this.toolbar=parameters.toolbar,a5.eventBus.bind("interaction:state:change interaction:value:change interaction:fill:change",function(interaction){this.toolbar.getInteraction()===interaction&&this.update()},this)},update:function(){var interaction=this.toolbar.getInteraction();if(interaction.options.runningscoreIsTrue()){this.node.show();var promise;promise=interaction.options.feedbackIsNormal()?this.lo.getResultsAsync(function(i){return"input"!==i.getStatus()}):this.lo.getResultsAsync(),promise.then(function(results){this.$(".current-score").text(results.correct()),this.$(".total-score").text(results.total())}.bind(this))}else this.node.hide()}}),a5.views.interaction.BaseView.extend("a5.view.controls.Pagination",{init:function(parameters){this._super(parameters.lo,parameters.toolbar,parameters.$el),this.lo=parameters.lo,this.interaction=parameters.interaction,this.toolbar=parameters.toolbar,a5.callbacks.controls.pagination.trigger("added",this.node)},update:function(){var total=this.lo.getNumberOfInteractions(),interaction=this.toolbar.getInteraction();this.$(".current-page").text(interaction.visibleIndex),this.$(".last-page").text(total),interaction.options.progressBarIsFalse()?this.node.hide():this.node.show(),interaction.isEndResultScreen()||interaction.options.progressBarIsAuto()&&total<=(interaction.options.introScreenIsOn()?0:1)?this.node.parent().hide():this.node.parent().show()}}),a5.views.interaction.BaseView.extend("a5.view.controls.EnumerationNavBar",{init:function(model,parent,node){this._super(model,parent,$('<div id="continous-enumeration-nav"></div>')),this.bindEvents(),this.parts={},this.resetting=!1;var partsOption=a5.mainBuilder.options(!0).getLOParts();0!==partsOption.length&&(_.each(partsOption,function(item,index){var part=new a5.view.controls.EnumerationNavPart(item.from,item.to,item.label,item.recommendedTime,index+1,this);this.add_part(part)},this),a5.mainBuilder.curInteraction&&(this.activityTypeClass=a5.mainBuilder.curInteraction.cssIdentifier(),this.node.addClass(this.activityTypeClass)))},add_part:function(part){this.node.append(part.render())},bindEvents:function(){a5.callbacks.interaction.bind("showed",this._handleInteractionShowed,this)},_handleInteractionShowed:function(interaction){var activityTypeClass=interaction.cssIdentifier();activityTypeClass!==this.activityTypeClass&&(this.node.removeClass(this.activityTypeClass),this.node.addClass(activityTypeClass),this.activityTypeClass=activityTypeClass)}}),a5.views.interaction.BaseView.extend("a5.view.controls.EnumerationNavPart",{template:"a5.view.controls.EnumerationNavPart",link_template:"a5.view.controls.EnumerationLink",init:function(fromScreen,toScreen,label,recommendedTime,number,parent){var content=$(a5.service.templates.render(this.template,{number:number,label:label,start:fromScreen-1,end:toScreen-1,recommendedTime:recommendedTime}));this._super(null,parent,$(content)),this.bindEvents(),this.interactions=_.range(fromScreen-1,toScreen),_.each(this.interactions,function(interactionIndex,index){var interaction=a5.mainBuilder.getInteractionFromIndex(interactionIndex);interaction.isIntroScreen()||this.add_interaction(interaction,index===this.interactions.length-1)},this)},bindEvents:function(){a5.callbacks.interaction.bind("showed",this._handleInteractionShowed,this),a5.callbacks.interaction.bind("showed",this._handleInteractionVisited,this),this.node.on("click","[data-interaction]",this._onClickLink)},add_interaction:function(interaction,isLast){a5.callbacks.interaction.bind("loaded",function(loadedInteraction){interaction===loadedInteraction&&interaction.enumerator&&(isLast&&this.trigger("loaded"),interaction.enumerator.ready().then(function(){this.add_buttons(interaction),interaction.visible&&(this._handleInteractionShowed(interaction),this._handleInteractionVisited(interaction))}.bind(this)))},this),a5.callbacks.interaction.bind("restored",function(interaction){interaction.visited&&this._handleInteractionVisited(interaction)},this)},add_buttons:function(interaction){var buttons=_.range(interaction.enumerator.offset+1,interaction.enumerator.counter+1),isCheckboxWithEnumInternalCorrect=interaction.options.enumerationinternalIsCorrect()&&"Identify:Select:Checkbox"===interaction.identifier,inputs=interaction.getActivityModels();_.each(buttons,function(n,inputIndex){var input,button,enumID=interaction.enumerator.getEnumSymbol(n,void 0,"|");if(enumID=enumID.replace(".",""),enumID=enumID.replace(")",""),!($("a[href=#enumeration-"+enumID+"]").length>0)){if(isCheckboxWithEnumInternalCorrect){input=this._getInputModelForCheckboxEnumCorrect(inputs,n);var firstEnumID=input.enumeration_internal[0];this._getInputView(firstEnumID),button=this._createButton(interaction,enumID,firstEnumID),input&&(this._toggleButtonFinishedForCheckboxEnumCorrect(input,firstEnumID),a5.eventBus.bind("interaction:value:change",_.bind(this._onValueChangeForCheckboxEnumCorrect,this,input,firstEnumID)))}else input=this._getInputModel(inputs,inputIndex),this._getInputView(enumID),button=this._createButton(interaction,enumID),input&&(this._toggleButtonFinished(input,enumID),a5.eventBus.bind("interaction:value:change",_.bind(this._onValueChange,this,input,enumID)));this.node.append(button)}},this)},_createButton:function(interaction,enumID,firstEnumID){var enumerationID=firstEnumID||enumID;return $(a5.service.templates.render(this.link_template,{interaction:interaction.index,label:enumID,targetId:"enumeration-"+enumerationID}))},_getInputModel:function(inputs,index){return inputs[index]},_getInputModelForCheckboxEnumCorrect:function(inputs,index){return _.find(inputs,function(input){return _.contains(input.enumeration_internal,index)})},_getInputView:function(enumID){var $view=$("#enumeration-"+enumID);return $view&&$view.on("focus",function(e){e.preventDefault(),$("#continous-enumeration-nav [data-interaction]").removeClass("selected"),$("#continous-enumeration-nav [href=#enumeration-"+enumID+"]").addClass("selected")}),$view},_toggleButtonFinishedForCheckboxEnumCorrect:function(input,enumID){var $buttons=$("#continous-enumeration-nav [href=#enumeration-"+enumID+"]");_.each($buttons,function(button,index){$(button).toggleClass("finished",index<input.totalSelected())})},_toggleButtonFinished:function(input,enumID){$.when(input.areAllFilled()).then(function(allFilled){$("#continous-enumeration-nav [href=#enumeration-"+enumID+"]").toggleClass("finished",allFilled)}.bind(this))},_handleInteractionShowed:function(interaction){_.contains(this.interactions,interaction.index)&&($("#continous-enumeration-nav .selected").removeClass("selected"),$("#continous-enumeration-nav [data-interaction="+interaction.index+"]").add(this.node).addClass("selected"))},_handleInteractionVisited:function(interaction){_.contains(this.interactions,interaction.index)&&$("#continous-enumeration-nav [data-interaction="+interaction.index+"]").add(this.node).addClass("visited")},_onClickLink:function(ev){var $target=$(ev.target),interaction=parseInt($target.data("interaction"),10);a5.mainBuilder.goTo(interaction);var node=$($target.attr("href"));_.defer(function(){node[0]&&(node.focus(),node.find(".expandable-question").trigger("expandable-show"),node.parents(".mCustomScrollbar").mCustomScrollbar("scrollTo",$target.attr("href")))}),ev.preventDefault()},_onValueChange:function(interaction,input,enumID){this._toggleButtonFinished(input,enumID)},_onValueChangeForCheckboxEnumCorrect:function(interaction,input,enumID){this._toggleButtonFinishedForCheckboxEnumCorrect(input,enumID)}}),a5.view.controls.Button.extend("a5.view.controls.TocButton",{openToc:function(){new a5.view.Toc({lo:this.lo}).show()}}),a5.view.controls.Button.extend("a5.view.controls.DisplaySettingsButton",{openDisplaySettings:function(){new a5.view.DisplaySettings({lo:this.lo}).show()}}),a5.view.controls.Button.extend("a5.view.controls.RevealButton",{init:function(parameters){this._super(parameters),this.originalRevealLabel=a5.utils.getLabel(this.node),_.bindAll(this,"onInteractionShowed"),a5.callbacks.interaction.bind("showed",this.onInteractionShowed)},onInteractionShowed:function(interaction){this.toolbar.getInteraction()===interaction&&this.updateButton(interaction)},updateButton:function(interaction){var revealObjectData=interaction.options.getRevealObject(),label=revealObjectData.revealLabel;a5.utils.setLabel(this.node,label||this.originalRevealLabel)}}),a5.view.controls.Button.extend("a5.view.controls.HideButton",{init:function(parameters){this._super(parameters),this.originalHideLabel=a5.utils.getLabel(this.node),_.bindAll(this,"onInteractionShowed"),a5.callbacks.interaction.bind("showed",this.onInteractionShowed)},onInteractionShowed:function(interaction){this.toolbar.getInteraction()===interaction&&this.updateButton(interaction)},updateButton:function(interaction){var revealObjectData=interaction.options.getRevealObject(),label=revealObjectData.hideLabel;a5.utils.setLabel(this.node,label||this.originalHideLabel)}}),a5.view.controls.Button.extend("a5.view.controls.RightsButton",{openDialog:function(){var interaction=this.toolbar.getInteraction();new a5.view.RightsView({resources:interaction.resources}).show()}}),a5.preprocessor.Preprocessor={hasTag:function(txt,tag,separator){return this.getTagRegExp(tag,separator).test(txt)},replaceTag:function(txt,tag,callback,separator){var self=this,re=this.getTagRegExp(tag,separator,!0);return txt.replace(re,function(_,__,args){if(args){args=args.split("*");for(var i=0;i<args.length-1;i++)a5.utils.endsWith(args[i],"\\")&&args.splice(i,2,args[i].slice(0,-1).concat("*",args[i+1]))}else args=[];return callback.apply(self,args)})},getTagRegExp:function(tag,separator,glob){var flag=glob?"gi":"i";return separator=separator||"\\*",new RegExp("#"+tag+"("+separator+"([\\s\\S]*?[^&]))?#",flag)},createXmlTag:function(tag,content,attributes){var xml="<"+tag;return _.each(attributes,function(value,attr){void 0!==value&&(xml+=" "+attr+"='"+value.toString().replace(/'/g,"&apos;")+"'")}),content?xml+">"+content+"</"+tag+">":xml+"/>"},replaceTagWithXml:function(txt,tag,xmltag){return xmltag=xmltag||tag,this.replaceTag(txt,tag,function(){return this.createXmlTag(xmltag)})},isResponsible:function(interaction,identifier,input){return!0}},Obj.extend("a5.preprocessor.Preprocessor"),a5.preprocessor.preprocessors=[],a5.preprocessor.apply=function(input,interaction){var identifier=a5.utils.getIdentifier(input)||interaction.identifier;return _.each(a5.preprocessor.preprocessors,function(prep){prep.isResponsible(interaction,identifier,input)&&(input=prep.preprocess(input,interaction))}),input},a5.preprocessor.applyToXMLText=function(text,interaction){return a5.preprocessor.apply(text,interaction)},a5.preprocessor.applyToXMLNode=function(xml,interaction,exclude){var excludeIds=exclude.split(" "),skipTexts={};_.each(excludeIds,function(excludeId){var skip=$(xml).find("#"+excludeId);skip.length&&(skipTexts[excludeId]=a5.utils.serializeXML(skip[0]),skip.empty())});var xmlText=a5.utils.serializeXML(xml);_.each(a5.preprocessor.preprocessors,function(prep){prep.isResponsible(interaction,interaction.identifier,xmlText)&&(xmlText=prep.preprocess(xmlText,interaction))});var resultXml=$.parseXML(xmlText);return _.each(excludeIds,function(excludeId){var skipText=skipTexts[excludeId],skip=$(resultXml).find("#"+excludeId);if(skipText){var skipXml=$.parseXML(skipText),clone=$(skipXml).find("#"+excludeId).clone();skip.after(clone),skip.remove()}}),resultXml},a5.preprocessor.OSSorting={isResponsible:function(interaction,identifier,txt){return"Order:Sort:Sorting"===identifier},preprocess:function(xml){return xml=xml.replace(/<p>\s*<\/p>/gi,""),xml=xml.replace(/<p\/>/gi,"")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.OSSorting"),a5.preprocessor.preprocessors.push(new a5.preprocessor.OSSorting),a5.preprocessor.TextToSpeech={isResponsible:function(interaction,identifier,xml){return interaction.options.audiosupportIsTrue()},preprocess:function(xml){return xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/p>/gi,"<TextToSpeechPlayer/></p>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/tr>/gi,"<TextToSpeechPlayer/></tr>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/h1>/gi,"<TextToSpeechPlayer/></h1>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/h2>/gi,"<TextToSpeechPlayer/></h2>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/h3>/gi,"<TextToSpeechPlayer/></h3>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/h4>/gi,"<TextToSpeechPlayer/></h4>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/h5>/gi,"<TextToSpeechPlayer/></h5>"),xml=xml.replace(/(<TextToSpeechPlayer\/>)*<\/li>/gi,"<TextToSpeechPlayer/></li>")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.TextToSpeech"),a5.preprocessor.preprocessors.push(new a5.preprocessor.TextToSpeech),a5.preprocessor.ClueLink={regex:/##h##([\s\w\W]*?)##h##/g,regex_responsible:/(#(CLUETEXT|CLUEWORD).*#)|(##h##([\s\w\W]*?)##h##)/i,isResponsible:function(interaction,identifier,txt){return this.regex_responsible.test(txt)},preprocess:function(txt){var clueLink=txt.match(this.regex);return null!=clueLink&&_.each(clueLink,function(s){var arr=s.replace(/##h##/g,"").split("*"),str=" invalid clue link ";2==arr.length?str='<clueLink cid="'+arr[1]+'">'+arr[0]+"</clueLink>":3==arr.length&&(str='<clueTarget cid="'+arr[1]+'" color="'+arr[2].replace(/#/g,"")+'">'+arr[0]+"</clueTarget>"),txt=txt.replace(s,str)}),txt=this.replaceTag(txt,"highlight",function(text,cid){return this.createXmlTag("clueLink",text,{cid:cid})}),txt=this.replaceTag(txt,"highlight-area",function(text,cid,color){return this.createXmlTag("clueTarget",text,{cid:cid,color:color.replace(/#/g,"")})}),txt=this.replaceTag(txt,"clueword",function(){var cid=_(arguments).initial().join("*"),text=_(arguments).last(),texts=[];return _(text.split("|")).each(function(text,index){texts.push(this.createXmlTag("clueLabel",text,{cid:cid}))},this),this.createXmlTag("clueLink",texts.join(""),{cid:cid})}),txt=this.replaceTag(txt,"cluetext",function(cid,text,color){return this.createXmlTag("clueTarget",text,{cid:cid,color:color})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ClueLink"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ClueLink),a5.preprocessor.Hidden={regex:/#hidden([\d]*)#/i,isResponsible:function(interaction,identifier,xml){return this.regex.test(xml)},preprocess:function(txt){return txt=txt.replace(/#hidden([\d]+)#/gi,"#hidden*$1#"),txt=this.replaceTag(txt,"hidden",function(){var args=[];args.push.apply(args,arguments);var opts;return args[0]&&(opts={prio:args[0]}),this.createXmlTag("hidden",null,opts)})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Hidden"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Hidden),a5.preprocessor.Buddy={regex:/#(buddy|endbuddy).*#/i,triggerBuddy:_.once(function(){var buddyConf;try{buddyConf=JSON.parse(A5.BUDDY_CONFIG)}catch(e){logger.error("Wrong JSON format of A5.BUDDY_CONFIG: ",A5.BUDDY_CONFIG)}buddyConf&&a5.eventBus.trigger("lo:hasBuddy",buddyConf)}),isResponsible:function(interaction,identifier,xml){var hasBuddy=this.regex.test(xml);return hasBuddy&&this.triggerBuddy(),hasBuddy},preprocess:function(xml){return xml=xml.replace(/(<p>)(#buddy\|)(.+?)(#)(?!\w)/gi,"<div id='buddy' data-state='$3'><p class='buddy-remove'>"),xml=xml.replace(/\s*<p>#endbuddy*#/gi,"</div><p class='buddy-remove'>"),xml=xml.replace(/(<p>)(.*?)(#buddyaudio\*)(.*?)(<object )(.+?)([\/>|<\/object>])(#)(.*?)(?!\w)/gim,"<p class='buddyAudioContainer'>$5$6$7"),xml=xml.replace(/<p class='buddy-remove'>(.*?)<\/p>\s*/g,"")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Buddy"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Buddy),a5.preprocessor.TextToggle={regex:/#(toggleText|tt).*#/i,isResponsible:function(interaction,identifier,txt){return this.regex.test(txt)},preprocess:function(txt){return txt=txt.replace(/#toggleText-?([\s\w\W]*?)#/g,function(match,text){return"<toggletext>"+(text=text||"Toggle")+"</toggletext>"}),txt=txt.replace(/#tt#(.*?)#\/tt#/gi,function(match,text){return"<togglingtext>"+text+"</togglingtext>"}),txt=this.replaceTag(txt,"toggletext",function(label){return this.createXmlTag("toggletext",label||"Toggle")}),txt=this.replaceTag(txt,"tt",function(text){return this.createXmlTag("togglingtext",text)})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.TextToggle"),a5.preprocessor.preprocessors.push(new a5.preprocessor.TextToggle),a5.preprocessor.ShowAnswer={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"answer")},preprocess:function(txt){return txt=txt.replace(/#answer\*(\d+),screen\*(\d+)#/g,function(match,answer,screen){return'<answer id="'+answer+'" screen="'+screen+'"/>'}),txt=this.replaceTag(txt,"answer",function(screen,answer){return this.createXmlTag("answer",null,{id:answer,screen:screen})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ShowAnswer"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ShowAnswer),a5.preprocessor.DynamicRadio={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"dynamicradio")},preprocess:function(txt){return txt=this.replaceTag(txt,"dynamicradio",function(screen,answer){for(var columns=[],i=2;i<arguments.length;i++)columns.push(arguments[i]);return this.createXmlTag("dynamicRadio",null,{id:answer,screen:screen,columns:columns.toString()})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.DynamicRadio"),a5.preprocessor.preprocessors.push(new a5.preprocessor.DynamicRadio),a5.preprocessor.DynamicCheckbox={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"dynamiccheckbox")},preprocess:function(txt){return txt=this.replaceTag(txt,"dynamiccheckbox",function(screen,answer){for(var columns=[],i=2;i<arguments.length;i++)columns.push(arguments[i]);return this.createXmlTag("dynamicCheckbox",null,{id:answer,screen:screen,columns:columns.toString()})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.DynamicCheckbox"),a5.preprocessor.preprocessors.push(new a5.preprocessor.DynamicCheckbox),a5.preprocessor.ShowText={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"showtext")},preprocess:function(txt){return this.replaceTag(txt,"showtext",function(screen,input){return this.createXmlTag("showtext",null,{screen:screen,input:input})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ShowText"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ShowText),a5.preprocessor.Syllabify={isResponsible:function(interaction,identifier,txt){return"Identify:Mark:Syllabify"===identifier},preprocess:function(xml){return xml=xml.replace(/#syllabify\*([a-zA-Z*]+)#/gi,"<syllabify>$1</syllabify>")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Syllabify"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Syllabify),a5.preprocessor.InlineEditor={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"inlineeditor")},preprocess:function(txt){return txt=this.replaceTag(txt,"inlineeditor",function(preset_text){return"<inlineEditor>"+preset_text+"</inlineEditor>"})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.InlineEditor"),a5.preprocessor.preprocessors.push(new a5.preprocessor.InlineEditor),a5.preprocessor.EndResult={allCorrectAttemptRegStr:"#allcorrectattempt([\\d]+)#",isResponsible:function(interaction,identifier,txt){var tags=["score","scorevisual","totalquestions","pointsavailable","correctanswers","pointsachieved","incorrectanswers","time\\s*taken","timeout","attempts","index","date","foreachinteraction","foreachsection","foreachmetadata","metadata","lomode","manuallymarked","automaticmarked","bandfeedback","unsolved","solved","notattempted"],reg=new RegExp(this.allCorrectAttemptRegStr,"i");return"Present:Present:Present"===identifier&&(_.some(tags,function(tag){return this.hasTag(txt,tag)},this)||reg.test(txt))},preprocess:function(txt){
txt=this.replaceTagWithXml(txt,"score"),txt=this.replaceTagWithXml(txt,"scorevisual"),txt=this.replaceTagWithXml(txt,"totalquestions"),txt=this.replaceTagWithXml(txt,"pointsavailable","totalquestions"),txt=this.replaceTagWithXml(txt,"correctanswers"),txt=this.replaceTagWithXml(txt,"pointsachieved","correctanswers"),txt=this.replaceTagWithXml(txt,"incorrectanswers"),txt=this.replaceTagWithXml(txt,"time\\s*taken","timetaken"),txt=this.replaceTagWithXml(txt,"timeout"),txt=this.replaceTagWithXml(txt,"attempts"),txt=this.replaceTagWithXml(txt,"index"),txt=this.replaceTagWithXml(txt,"date"),txt=this.replaceTagWithXml(txt,"metadata"),txt=txt.replace(/<p>#foreachinteraction#\s*<\/p>/gi,"#foreachinteraction#"),txt=txt.replace(/<p>#endeachinteraction#\s*<\/p>/gi,"#endeachinteraction#"),txt=this.replaceTag(txt,"foreachinteraction",function(){return"<forEachInteraction>"}),txt=this.replaceTag(txt,"endeachinteraction",function(){return"</forEachInteraction>"}),txt=txt.replace(/<p>#foreachsection#\s*<\/p>/gi,"#foreachsection#"),txt=txt.replace(/<p>#endeachsection#\s*<\/p>/gi,"#endeachsection#"),txt=this.replaceTag(txt,"foreachsection",function(){return"<forEachSection>"}),txt=this.replaceTag(txt,"endeachsection",function(){return"</forEachSection>"}),txt=txt.replace(/<p>#foreachmetadata(.*)#\s*<\/p>/gi,"#foreachmetadata$1#"),txt=txt.replace(/<p>#endeachmetadata#\s*<\/p>/gi,"#endeachmetadata#"),txt=this.replaceTag(txt,"foreachmetadata",function(item){var args=[];return args.push.apply(args,arguments),'<forEachMetadata item="'+item+'" values="'+args.slice(1).join("*")+'">'}),txt=this.replaceTag(txt,"endeachmetadata",function(){return"</forEachMetadata>"}),txt=this.replaceTag(txt,"lomode",function(mode){return'<LOMode mode="'+mode+'">'}),txt=this.replaceTag(txt,"endlomode",function(){return"</LOMode>"}),txt=this.replaceTag(txt,"manuallymarked",function(){return"<manuallyMarked>"}),txt=this.replaceTag(txt,"endmanuallymarked",function(){return"</manuallyMarked>"}),txt=this.replaceTag(txt,"automaticmarked",function(){return"<automaticMarked>"}),txt=this.replaceTag(txt,"endautomaticmarked",function(){return"</automaticMarked>"}),txt=this.replaceTag(txt,"bandfeedback",function(ps){var args=[];return args.push.apply(args,arguments),'<bandFeedback values="'+args.join("*")+'"/>'});var reg=new RegExp(this.allCorrectAttemptRegStr,"gi");return txt=txt.replace(reg,"#allcorrectattempt*$1#"),txt=this.replaceTag(txt,"allcorrectattempt",function(){var args=[];return args.push.apply(args,arguments),this.createXmlTag("allCorrectAttempt",null,{attempt:args[0]})}),txt=this.replaceTag(txt,"unsolved",function(){var args=[];return args.push.apply(args,arguments),this.createXmlTag("unsolved",null,{threshold:args[0]||100})}),txt=this.replaceTag(txt,"solved",function(){var args=[];return args.push.apply(args,arguments),this.createXmlTag("solved",null,{threshold:args[0]||100})}),this.replaceTagWithXml(txt,"notattempted","notAttempted")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.EndResult"),a5.preprocessor.preprocessors.push(new a5.preprocessor.EndResult),a5.preprocessor.Scramble={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"scramble")},preprocess:function(txt){return this.replaceTag(txt,"scramble",function(text){return this.createXmlTag("scramble",text)})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Scramble"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Scramble),a5.preprocessor.RadioCheck={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"radio")||this.hasTag(txt,"checkbox")},preprocess:function(txt){return txt=this.replaceTagWithGroupValue(txt,"radio"),txt=this.replaceTagWithGroupValue(txt,"checkbox")},replaceTagWithGroupValue:function(txt,tag){return this.replaceTag(txt,tag,function(group,value,selected){return this.createXmlTag(tag,null,{group:group,value:value,selected:selected})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.RadioCheck"),a5.preprocessor.preprocessors.push(new a5.preprocessor.RadioCheck),a5.preprocessor.Save={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"save")},preprocess:function(txt){return this.replaceTag(txt,"save",function(image){return this.createXmlTag("save",null,{image:image})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Save"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Save),a5.preprocessor.TextArea={minmax_regex:/^(?:(hide:)?(\d+\s(?:chars|words)))?(?:\|)?(?:(hide:)?(?:min:)?(\d+\s(?:chars|words)))?$/i,regex:/#(textinput|richtextinput|inlinetextinput).*#/i,isResponsible:function(interaction,identifier,txt){return this.regex.test(txt)},preprocess:function(txt){return txt=this.replaceTextInputTag(txt,"textinput"),txt=this.replaceTextInputTag(txt,"richtextinput"),txt=this.replaceTextInputTag(txt,"inlinetextinput")},replaceTextInputTag:function(txt,type){return txt=this.replaceTag(txt,type,function(width,height,max,count,content,screen,input){if(this._isMaxParam(height)?(input=screen,screen=content,content=count,count=max,max=height,height=""):this._isHeightParam(height)||(input=screen,screen=content,content=count,count=max,max=height,height=""),this._isMaxParam(max)||(input=screen,screen=content,content=count,count=max,max=""),this._isCountParam(count)?count=/char/.test(count)?"chars":"words":(input=screen,screen=content,content=count,count=""),max)var groups=this.minmax_regex.exec(max),hidemax=!!groups[1],hidemin=!!groups[3],maxvalue=groups[2],minvalue=groups[4];var options={width:width,height:height,max:maxvalue,min:minvalue};return hidemax&&(options.hidemax=!0),hidemin&&(options.hidemin=!0),count&&(options.count=count),this._isShowtextParam(content)&&(content="",options.showtext=screen+","+input),this.createXmlTag(type,content,options)})},_isHeightParam:function(param){return!this._isMaxParam(param)&&!_.isNaN(parseInt(param,10))},_isMaxParam:function(param){return this.minmax_regex.test(param)},_isCountParam:function(param){return/^(?:count)?(?:char|word)s?$/.test(param)},_isShowtextParam:function(param){return"showtext"===param}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.TextArea"),a5.preprocessor.preprocessors.push(new a5.preprocessor.TextArea),a5.preprocessor.TriggerWord={regex:/#(TRIGWORD|TRIGWORDONCE|TRIGWORDB|TRIGTEXT|RICHTRIGTEXT|ENDRICHTRIGTEXT|TriggerWord).*#/i,isResponsible:function(interaction,identifier,xml){return this.regex.test(xml)},preprocess:function(xml){return xml=xml.replace(/#TRIGWORD\*(.+?)\**(display)*\*([\s\S]+?)#(?!\w)/gi,'<triggerWord display="$2" id="$1">$3</triggerWord>'),xml=xml.replace(/#TRIGWORDONCE\*(.+?)\**(display)*\*([\s\S]+?)#(?!\w)/gi,'<triggerWord once="once" display="$2" id="$1">$3</triggerWord>'),xml=xml.replace(/#TRIGWORDB\*(.+?)\*([\s\S]+?)#(?!\w)/gi,'<triggerWord id="$1" simultaneous="true">$2</triggerWord>'),xml=xml.replace(/#TRIGTEXT\*(.+?)\*([\s\S]+?)#(?!\w)/gi,'<triggerText id="$1">$2</triggerText>'),xml=xml.replace(/<p>#RICHTRIGTEXT\*(.+?)#(?!\w)/gi,'<triggerText id="$1"><p class="trigtext-paragraph-placeholder">'),xml=xml.replace(/<p>#ENDRICHTRIGTEXT*#/gi,'</triggerText><p class="trigtext-paragraph-placeholder">'),xml=this.replaceTag(xml,"triggerWord",function(id){return this.createXmlTag("triggerWord",null,{id:id})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.TriggerWord"),a5.preprocessor.preprocessors.push(new a5.preprocessor.TriggerWord),a5.preprocessor.FeedbackText={regex:/#(FEEDBACKTEXT|ENDFEEDBACKTEXT).*#/i,isResponsible:function(interaction,identifier,xml){return this.regex.test(xml)},preprocess:function(xml){return xml=xml.replace(/<p>#FEEDBACKTEXT\*(.+?)#(?!\w)/gi,'<feedbackText id="$1"><p class="feedbacktext-paragraph-placeholder">'),xml=xml.replace(/\s*<p>#ENDFEEDBACKTEXT*#/gi,'</feedbackText><p class="feedbacktext-paragraph-placeholder">'),xml=xml.replace(/<p class="feedbacktext-paragraph-placeholder">\s*<\/p>\s*/g,"")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.FeedbackText"),a5.preprocessor.preprocessors.push(new a5.preprocessor.FeedbackText),a5.preprocessor.Confidence={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"confidence-selector")||this.hasTag(xml,"confidence-display")},preprocess:function(txt){return txt=this.replaceTag(txt,"confidence-selector",function(ps){var args=[];args.push.apply(args,arguments);var params={};return _.each(_.rest(args),function(v,i){params["v"+i]=v}),this.createXmlTag("confidenceSelector",arguments[0],params)}),txt=this.replaceTag(txt,"confidence-display",function(ps){return this.createXmlTag("confidenceDisplay")})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Confidence"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Confidence),a5.preprocessor.Alert={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"alert")},preprocess:function(txt){return this.replaceTag(txt,"alert",function(type){return'<alert type="'+type+'"/>'})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Alert"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Alert),a5.preprocessor.ViewText={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"viewtext")},preprocess:function(txt){return this.replaceTag(txt,"viewtext",function(id,text){return this.createXmlTag("div",text,{id:"view-text-"+id,class:"view-text",tabindex:"0"})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ViewText"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ViewText),a5.preprocessor.Navbutton={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"navbutton")},preprocess:function(txt){return this.replaceTag(txt,"navbutton",function(screen,label){return this.createXmlTag("navbutton",label,{screen:screen})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Navbutton"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Navbutton),a5.preprocessor.InfoText={regex:/#infotext[^#]*#/i,isResponsible:function(interaction,identifier,txt){return this.regex.test(txt)},preprocess:function(txt){var xml=this.replaceTag(txt,"infotext",function(){var text,attrs;return 3===arguments.length?(text=arguments[2],attrs={class:arguments[1]}):(text=arguments[1],attrs={icon:arguments[0]}),this.createXmlTag("infotext",text,attrs)});return xml=xml.replace(/([^>\s]*)(<infotext [^>]*>)/gi,'<span class="element-wrap">$1$2'),xml=xml.replace(/(<\/infotext>)([^\s<]*)/gi,"$1$2</span>")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.InfoText"),a5.preprocessor.preprocessors.push(new a5.preprocessor.InfoText),a5.preprocessor.UserSelection={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"userselection")},preprocess:function(txt){return this.replaceTag(txt,"userselection",function(arg1,arg2){var numbers=(arg2||arg1).split(","),multiple=!!arg2;return this.createXmlTag("userselection",null,{step:numbers[0],max:numbers[1],multiple:multiple})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.UserSelection"),a5.preprocessor.preprocessors.push(new a5.preprocessor.UserSelection),a5.preprocessor.Karaoke={isResponsible:function(interaction,identifier,txt){return"Present:Present:Present"===identifier&&this.hasTag(txt,"karaoke")},preprocess:function(txt){return this.replaceTag(txt,"karaoke",function(){var audioID=arguments[0],args=Array.prototype.slice.call(arguments,1),tags=[];return _.each(args,function(arg,index){if(index%2!=0){var times=args[index-1].split("-");tags.push(this.createXmlTag("karaoke",arg,{audio:audioID,from:times[0],to:times[1]}))}},this),tags.join("")})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Karaoke"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Karaoke),a5.preprocessor.Clock={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"clock")},preprocess:function(txt){return this.replaceTag(txt,"clock",function(){var text,attrs;return text=arguments[1],attrs={class:arguments[0],options:arguments[2]},this.createXmlTag("clock",text,attrs)})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Clock"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Clock),a5.preprocessor.ContentMessage={regex:/#contentmessage[^#]*#/i,isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"contentmessage")},preprocess:function(txt){return this.replaceTag(txt,"contentmessage",function(message,text){return this.createXmlTag("contentmessage",text,{message:message})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ContentMessage"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ContentMessage),a5.preprocessor.AnimateObject={regExp:/#animateobject\*([^*]+)\*([^ \t\r\n*#]+)#/gi,isResponsible:function(interaction,identifier,xml){return this.regExp.test(xml)},preprocess:function(txt,interaction){return txt.replace(this.regExp,_.bind(function(str,text,id){var match=a5.dp.animations&&a5.dp.animations[id];if(!match)return"";var animation=AnimationParser.parse(match);interaction.bind("show:deferred",function(){animation.start(interaction)});var blocks=_(text.split("|")).compact();return blocks=_(blocks).map(function(block){return"<span>"+block+"</span>"}),this.createXmlTag("div",blocks.join(""),{id:id,class:"object-animation"})},this))}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.AnimateObject"),a5.preprocessor.preprocessors.push(new a5.preprocessor.AnimateObject),a5.preprocessor.AlternativeText={isResponsible:function(interaction,identifier,xml){return this.hasTag(xml,"alttext")},preprocess:function(txt){return this.replaceTag(txt,"alttext",function(){var texts=[];return _(arguments).each(function(text,index){texts.push(this.createXmlTag("alternative",text,{id:"alt"+(index+1)}))},this),this.createXmlTag("alternativeText",texts.join(""))})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.AlternativeText"),a5.preprocessor.preprocessors.push(new a5.preprocessor.AlternativeText),a5.preprocessor.TranslationBlock={isResponsible:function(interaction,identifier,txt){return this.hasTag(txt,"translationBlock")},preprocess:function(txt){return txt=txt.replace(/<p>#translationBlock#\s*<\/p>/gi,"<translationBlock>"),txt=txt.replace(/<p>#endTranslationBlock#\s*<\/p>/gi,"</translationBlock>"),txt=txt.replace(/<p>#language\*([^#]+)#\s*<\/p>/gi,"<language lang='$1'>"),txt=txt.replace(/<p>#endLanguage#\s*<\/p>/gi,"</language>")}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.TranslationBlock"),a5.preprocessor.preprocessors.push(new a5.preprocessor.TranslationBlock),a5.preprocessor.ICTextGapPreprocessor={isResponsible:function(interaction,identifier,input){return"Input:Completion:Text gap"===identifier},preprocess:function(xml){return xml=xml.replace(/(?:[^>\s]*)(?:<textEntryInteraction[^>]+>[^\s<]*)+/gi,'<span class="element-wrap">$&</span>')}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ICTextGapPreprocessor"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ICTextGapPreprocessor),a5.preprocessor.ISDropdownPreprocessor={isResponsible:function(interaction,identifier,input){return"Identify:Select:Dropdown"===identifier},preprocess:function(xml){return xml=xml.replace(/(?:[^>\s]*)(?:<inlineChoiceInteraction\b(?:(?!<\/inlineChoiceInteraction).)*<\/inlineChoiceInteraction[^>]*>[^\s<]*)+/gi,'<span class="element-wrap">$&</span>')}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.ISDropdownPreprocessor"),a5.preprocessor.preprocessors.push(new a5.preprocessor.ISDropdownPreprocessor),a5.preprocessor.Poll={isResponsible:function(interaction,identifier,txt){return"Present:Present:Present"===identifier&&this.hasTag(txt,"poll")},preprocess:function(txt){return this.replaceTag(txt,"poll",function(){var texts=[],typeAndSets=arguments[0].split("|"),type=typeAndSets[0],sets=typeAndSets.slice(1),options=Array.prototype.slice.call(arguments,1);return sets.forEach(function(set,index){texts.push(this.createXmlTag("set",set,{id:"set"+index}))},this),options.forEach(function(option,index){texts.push(this.createXmlTag("option",option,{id:"alt"+index}))},this),this.createXmlTag("poll",texts.join(""),{type:type})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Poll"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Poll),a5.preprocessor.PollResults={isResponsible:function(interaction,identifier,txt){return"Present:Present:Present"===identifier&&this.hasTag(txt,"pollresults")},preprocess:function(txt){return this.replaceTag(txt,"pollresults",function(screen){return this.createXmlTag("pollresults",null,{screen:screen})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.PollResults"),a5.preprocessor.preprocessors.push(new a5.preprocessor.PollResults),a5.speaking_recording={},a5.preprocessor.SpeakingRecording={regex:/#[recorder|playAll].*#/i,isResponsible:function(interaction,identifier,xml){return xml.match(this.regex)},preprocess:function(xml){var results=xml.match(/#recorder:[^#]*#/g);if(results)for(var i=0;i<results.length;i+=1)xml=xml.replace(results[i],function(syntax){var options=["nopause","save","timelimit","text"],tag=syntax.replace(/#/g,"");tag=tag.split(":");for(var text="",result="<recorder ",i=0;i<tag.length;i+=1)tag[i]=tag[i].replace("#",""),"timelimit"==tag[i]&&tag[i+1].match(/\d+/)?(result+='timelimit="'+tag[i+1]+'" ',tag.splice(i+1,1)):"text"==tag[i]?(text=tag[i+1],tag.splice(i+1,1)):"save"==tag[i]?result+=' save="true" ':"nopause"==tag[i]?result+=' nopause="true" ':1==i&&-1==options.indexOf(tag[i])?result+='audio="'+tag[i]+'" ':2==i&&-1==options.indexOf(tag[i])&&(result+='time="'+tag[i]+'" ');return result+=">"+text+"</recorder>"}(results[i]));return xml=this.replaceTag(xml,"recorder",function(audio,time){return this.createXmlTag("recorder",null,{audio:audio,time:time})}),xml=this.replaceTag(xml,"playAll",function(screens){var from=0,to=0;return 2==screens.split("-").length?(from=parseInt(screens.split("-")[0],10),to=parseInt(screens.split("-")[1],10)):(from=parseInt(screens,10),to=from),this.createXmlTag("playAll",null,{from:from,to:to})})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.SpeakingRecording"),a5.preprocessor.preprocessors.push(new a5.preprocessor.SpeakingRecording),a5.model_builder.SpeakingRecording={isResponsible:function(node,interaction){return node.is("recorder, playAll")&&"Input:Match:Voice"!==interaction.identifier},buildRecorder:function(interaction,parentNode,node){var model=new a5.models.interaction.SpeakingRecording({parent:interaction,audioID:node.attr("audio"),timeData:node.attr("time"),nopause:node.attr("nopause")||!a5.dp.config.allowPauseRecordings,timelimit:parseInt(node.attr("timelimit"),10),scorable:"Present:Present:Present"===interaction.identifier&&interaction.isManuallyMarked()}),view=new a5.views.interaction.SpeakingRecording(model);parentNode.append(view.render()),interaction.blockItems.add(model)},buildPlayAll:function(interaction,parentNode,node){var playAll=new a5.speaking_recording.PlayAllView(parseInt(node.attr("from"),10)-1,parseInt(node.attr("to"),10)-1);parentNode.append(playAll.render())}},a5.model_builder.Base.extend("a5.model_builder.SpeakingRecording"),a5.model_builder.builders.push(new a5.model_builder.SpeakingRecording),a5.models.interaction.SpeakingRecording={init:function(parameters,defaults){this.records=[],this.timeline=[],this._super(parameters,$.extend({audioID:null,timeData:null,nopause:!1,timelimit:null,downloadEnabled:!0,listenEnabled:!0,scorable:!1},defaults)),this.timeData&&_.each(this.timeData.split(","),function(item){2==item.split("-").length?this.timeline.push({from:parseFloat(item.split("-")[0]),to:parseFloat(item.split("-")[1])}):this.timeline.push({record:parseFloat(item)})},this)},getScores:function(){var score=new a5.Score;return this.isScorable()&&(score.incTotal(),this.isFilled()&&score.incFilled()),score},store:function(){return this.records},restore:function(data){_.isUndefined(data)||(this.records=data,this.trigger("updated"))},clear:function(){this.records=[]},isFilled:function(){return this.records.length>0},isScorable:function(){return this.scorable}},a5.models.interaction.BaseModel.extend("a5.models.interaction.SpeakingRecording"),a5.speaking_recording.LNRInstances=[],a5.speaking_recording.LNRInstancesPerInteraction=[],a5.views.interaction.BaseView.extend("a5.views.interaction.SpeakingRecording",{init:function(model,callbacks){this._super(model,null,$(a5.service.templates.render("a5.speaking_recording.SpeakingRecording",{timelimit:model.timelimit}))),this.interaction=model.parent,this.group="lnr-"+this.model.id,this.callbacks=callbacks||{},this.listenButton=this.$(".lrp_listen"),this.recordButton=this.$(".lrp_record"),this.finishButton=this.$(".lrp_finish"),this.playButton=this.$(".lrp_play"),this.stopButton=this.$(".lrp_stop"),this.downloadButton=this.$(".lrp_download"),this.$progressBar=this.$("progress"),this.recordButtonLabels=a5.utils.getLabels(this.recordButton,["record","pause","stop"]),this.model.nopause&&!this.recordButtonLabels.stop&&(this.recordButtonLabels.stop=this.recordButtonLabels.pause),this.playButtonLabels=a5.utils.getLabels(this.playButton,["play","pause"]),this.allRecordsUploaded=!0,this.model.audioID&&a5.service.media.audio.bind("ready",function(){this.listenAudio=a5.service.media.audio.create(this.model.audioID,{preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase()),preload:!a5.dp.config.audioPreloadDisabled}),a5.dp.config.audioPreloadDisabled&&this.interaction.preloadAudio(this.listenAudio)},this),this.updateState("loading"),this.__ready=!1,a5.service.media.audio_recorder.ready().then(function(recorder){this.interaction.bind("show",function(){a5.service.media.audio_recorder.instance().checkSupport()})}.bind(this)),$.when(a5.service.media.audio.ready(),a5.service.media.audio_recorder.ready()).then(function(){this.__ready||(this.updateState("ready"),this.__ready=!0)}.bind(this)),a5.speaking_recording.LNRInstances.push(this),a5.speaking_recording.LNRInstancesPerInteraction[this.interaction.index]=a5.speaking_recording.LNRInstancesPerInteraction[this.interaction.index]||[],a5.speaking_recording.LNRInstancesPerInteraction[this.interaction.index].push(this),a5.service.media.audio.bind("dopause",function(except){except?this.stopAllExcept(except):this.stopAll()},this),this.model.bind("updated",this.updateState,this),this.interaction.bind("hide",function(){this.stopAll()},this),this.interaction.onInteractionReadyListeners.register(this.stopAll.bind(this)),this.listeningEnabled=!0,this.recordingEnabled=!0},isListeningEnabled:function(){return this.listeningEnabled&&this.listenAudio},isRecordingEnabled:function(){return this.recordingEnabled&&this.model.records.length>0},enableListening:function(){this.listeningEnabled=!0},enableRecording:function(){this.recordingEnabled=!0},disableListening:function(){this.listeningEnabled=!1},disableRecording:function(){this.recordingEnabled=!1},enable:function(){this.updateState("ready")},disable:function(){this.updateState("disabled")},updateState:function(state,rec_state){state&&(this.state=state),rec_state&&(this.rec_state=rec_state),this._initState(),this.model.listenEnabled&&this._updateListenButton(),this._updateRecordButton(),this._updateFinishButton(),this._updatePlayButton(),this._updateStopButton(),this.model.downloadEnabled&&this._updateDownloadButton(),this.trigger("state:changed",this.state,this.rec_state)},stopAll:function(){var currentTask=a5.tasks.current(this.group);currentTask&&currentTask.stop(),a5.tasks.clear(this.group),this.updateState("ready","ready")},stopAllExcept:function(except){this!==except&&this.stopAll()},listen:function(){a5.service.media.pauseAll(),a5.tasks.push(new a5.speaking_recording.LNRListen(this),this.group),a5.tasks.push(new a5.speaking_recording.LNREnded(this),this.group)},startPlayback:function(){a5.service.media.pauseAll(),this.model.timeline&&this.model.timeline.length>0?_.each(this.model.timeline,function(part,i){part.record?a5.tasks.push(new a5.speaking_recording.LNRPlayback(this,i,this.model.records),this.group):a5.tasks.push(new a5.speaking_recording.LNRPlay(this,part.from,part.to),this.group)},this):a5.service.media.audio_recorder.instance()instanceof ExternalAudioRecorder?a5.tasks.push(new a5.speaking_recording.LNRPlayback(this,0,this.model.records,!0),this.group,!0):a5.tasks.push(new a5.speaking_recording.LNRPlayback(this,0,this.model.records),this.group,!0),a5.tasks.push(new a5.speaking_recording.LNREnded(this),this.group),this.updateState("playback")},startRecording:function(){if(a5.service.media.pauseAll(),this.records=[],this.allRecordsUploaded=!1,this.model.timeline&&this.model.timeline.length>0){this.listenAudio.load();var uploadRecordTasks=[];_.each(this.model.timeline,function(part,i){if(part.record){a5.tasks.push(new a5.speaking_recording.LNRRecord(this,part.record,i,this.model.id,this.model.timelimit),this.group);var uploadRecordTask=new a5.speaking_recording.LNRRecordUpload(this,i);uploadRecordTasks.push(uploadRecordTask),a5.tasks.push(new a5.speaking_recording.LNRRecordUpload(this,i),this.group)}else a5.tasks.push(new a5.speaking_recording.LNRPlay(this,part.from,part.to),this.group)},this),a5.tasks.push(new a5.speaking_recording.LNRRecordEnded(this,uploadRecordTasks),this.group),this.updateState("recording")}else{var simpleRecordTask,recordEndedTask;if(a5.service.media.audio_recorder.instance()instanceof ExternalAudioRecorder)simpleRecordTask=new a5.speaking_recording.LNRSimpleRecord(this,this.model.id,this.model.timelimit),recordEndedTask=new a5.speaking_recording.LNRRecordEnded(this),simpleRecordTask.bind("start",this.onSimpleRecordStarted,this),simpleRecordTask.bind("progress",this.onSimpleRecordProgress,this),simpleRecordTask.bind("error",this.onSimpleRecordError,this),recordEndedTask.bind("stop",this.onSimpleRecordEnded,this),a5.tasks.push(simpleRecordTask,this.group,!0),a5.tasks.push(recordEndedTask,this.group);else{var uploadRecordTask=new a5.speaking_recording.LNRRecordUpload(this);simpleRecordTask=new a5.speaking_recording.LNRSimpleRecord(this,this.model.id,this.model.timelimit),recordEndedTask=new a5.speaking_recording.LNRRecordEnded(this,uploadRecordTask),simpleRecordTask.bind("start",this.onSimpleRecordStarted,this),simpleRecordTask.bind("progress",this.onSimpleRecordProgress,this),simpleRecordTask.bind("error",this.onSimpleRecordError,this),uploadRecordTask.bind("error",this.onSimpleRecordError,this),recordEndedTask.bind("stop",this.onSimpleRecordEnded,this),a5.tasks.push(simpleRecordTask,this.group,!0),a5.tasks.push(uploadRecordTask,this.group),a5.tasks.push(recordEndedTask,this.group)}this.updateState("simple-recording")}},onSimpleRecordEnded:function(){this.callbacks.onSimpleRecordEnded&&this.callbacks.onSimpleRecordEnded()},onSimpleRecordStarted:function(){this.callbacks.onSimpleRecordStarted&&this.callbacks.onSimpleRecordStarted()},onSimpleRecordProgress:function(progress){var seconds=Math.floor(progress/1e3);this.$progressBar.attr("value",seconds),this.node.attr("style","--progress:"+seconds),this.callbacks.onSimpleRecordProgress&&this.callbacks.onSimpleRecordProgress(seconds)},onSimpleRecordError:function(){this.stopAll(),this.callbacks.onSimpleRecordError&&this.callbacks.onSimpleRecordError()},askSaveAsFilenameAndDownload:function(){var $dialog=a5.view.dialog.display("a5.view.dialog.RecordingSaveAs",{filename:A5.DEFAULT_SAVEAS_FILENAME},{ok:_.bind(function(){this.downloadAs($dialog.find("#downloadFilename").val())},this)})},downloadAs:function(filename){this.model.timeline&&this.model.timeline.length>0?this.partPlayDownload(filename):this.simpleDownload(filename)},partPlayDownload:function(filename){var inputs=[],clips=[];inputs.push(a5.utils.getAbsoluteURL(a5.service.media.audio.buildUrl(this.model.audioID,"mp3"))),_(this.model.timeline).each(function(part,i){part.record?_(this.model.records[i]).each(function(snippet){inputs.push(a5.service.media.audio_recorder.instance().buildUrl(snippet)),clips.push({input:inputs.length-1})},this):clips.push({input:0,start:part.from,end:part.to})},this),a5.service.toolbelt.audioDownload({inputs:inputs,clips:clips,output:filename})},simpleDownload:function(filename){var inputs=[],clips=[];_(this.model.records[0]).each(function(snippet){inputs.push(a5.service.media.audio_recorder.instance().buildUrl(snippet)),clips.push({input:inputs.length-1})},this),a5.service.toolbelt.audioDownload({inputs:inputs,clips:clips,output:filename})},_showButton:function($button){$button.css("display","")},_hideButton:function($button){$button.css("display","none")},_enableButton:function($button){$button.removeClass("lrp_inactive")},_disableButton:function($button){$button.addClass("lrp_inactive")},_initButton:function($button){$button.removeClass("active lrp_listening lrp_playing lrp_recording lrp_uploading"),$button.off("click"),this._disableButton($button)},_initState:function(){this._initButton(this.listenButton),this._initButton(this.recordButton),this._initButton(this.finishButton),this._initButton(this.playButton),this._initButton(this.stopButton),this._initButton(this.downloadButton),this._hideButton(this.downloadButton),this.model.listenEnabled||this._hideButton(this.listenButton),this.node.removeClass("lrp_playing lrp_recording lrp_listening lrp_uploading")},_updateDOMState:function($button,state){$button.addClass(state),this.node.addClass(state)},_updateListenButton:function(){this.model.audioID?(this._showButton(this.listenButton),"ready"!==this.state&&"playback"!==this.state||(this._enableButton(this.listenButton),this.listenButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),this.listen()},this))),"listening"!==this.state&&("recording"!=this.state||"listening"!==this.rec_state&&"listening-paused"!==this.rec_state)||(this._enableButton(this.listenButton),"listening-paused"==this.rec_state?this.listenButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.tasks.current(this.group).unpause()},this)):(this._updateDOMState(this.listenButton,"lrp_listening"),this.listenButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.tasks.current(this.group).pause()},this))))):this._hideButton(this.listenButton)},_updateRecordButton:function(){a5.utils.setLabel(this.recordButton,this.recordButtonLabels.record),this.recordButton.attr("aria-pressed",!1),this._showButton(this.recordButton),"recording"!==this.state&&"simple-recording"!==this.state||(this._enableButton(this.recordButton),"recording"===this.rec_state||"waiting-for-mic"===this.rec_state?(this.model.nopause?(this.recordButton.addClass("lrp_nopause"),a5.utils.setLabel(this.recordButton,this.recordButtonLabels.stop)):a5.utils.setLabel(this.recordButton,this.recordButtonLabels.pause),this.recordButton.attr("aria-pressed",!0),this._updateDOMState(this.recordButton,"lrp_recording"),this.recordButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),this.model.nopause?a5.tasks.current(this.group).stop():a5.tasks.current(this.group).pause()},this))):"paused"===this.rec_state&&this.recordButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.tasks.current(this.group).unpause(),a5.tasks.push(a5.tasks.current(this.group),this.group,!0)},this))),"ready"!==this.state&&"playback"!==this.state&&"listening"!==this.state||(this._enableButton(this.recordButton),this.recordButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),this.startRecording()},this)))},_updatePlayButton:function(){this.model.records.length>0?(a5.utils.setLabel(this.playButton,this.playButtonLabels.play),this.playButton.attr("aria-pressed",!1),this._showButton(this.playButton),!this.allRecordsUploaded||"ready"!==this.state&&"listening"!==this.state||(this._enableButton(this.playButton),this.playButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),this.startPlayback()},this))),"playback"===this.state&&(this._enableButton(this.playButton),"playing-paused"===this.rec_state||"listening-paused"===this.rec_state?this.playButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),
a5.tasks.current(this.group).unpause()},this)):(a5.utils.setLabel(this.playButton,this.playButtonLabels.pause),this.playButton.attr("aria-pressed",!0),this._updateDOMState(this.playButton,"lrp_playing"),this.playButton.addClass("active"),this.playButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.tasks.current(this.group).pause()},this))))):this._hideButton(this.playButton)},_updateStopButton:function(){this._showButton(this.stopButton),"listening"!==this.state&&"playback"!==this.state&&"recording"!==this.state&&"simple-recording"!==this.state||(this._enableButton(this.stopButton),this.stopButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),this.stopAll()},this)))},_updateDownloadButton:function(){this.model.records.length>0&&(this.downloadButton.trigger("download:show"),!this.allRecordsUploaded||"ready"!==this.state&&"listening"!==this.state&&"playback"!==this.state||(this._enableButton(this.downloadButton),this.downloadButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.service.media.audio_recorder.instance()instanceof ExternalAudioRecorder?a5.mainBuilder.engine.invoke("open-link",this.model.records[0][0]):this.askSaveAsFilenameAndDownload()},this))))},_updateFinishButton:function(){"simple-recording"!==this.state||this.model.nopause?this._hideButton(this.finishButton):(this._showButton(this.finishButton),"uploading"===this.rec_state?this._updateDOMState(this.finishButton,"lrp_uploading"):(this._enableButton(this.finishButton),this.finishButton.on("click",_.bind(function(e){e.preventDefault(),e.stopPropagation(),a5.tasks.current(this.group).stop()},this))))}}),a5.speaking_recording.playAllInstances=[],a5.views.interaction.BaseView.extend("a5.speaking_recording.PlayAllView",{init:function(from,to){this.from=from,this.to=to,this._super(null,null,$(a5.service.templates.render("a5.speaking_recording.PlayAll"))),this.$play=this.$("a[data-button=play]"),this.$pause=this.$("a[data-button=pause]"),this.$stop=this.$("a[data-button=stop]"),this.$next=this.$("a[data-button=next]"),this.$prev=this.$("a[data-button=prev]"),this.$all=this.$("a"),this._setPlaying(null),a5.speaking_recording.playAllInstances.push(this)},_setPlaying:function(playing){this.playing=playing,this.$all.addClass("inactive"),this.$all.off("click"),this.playing?(this.$stop.removeClass("inactive"),this.$stop.on("click",_.bind(this.playing.stop,this.playing)),this.$play.removeClass("inactive"),this.$play.addClass("active"),this.playing.hasNext()&&(this.$next.removeClass("inactive"),this.$next.on("click",_.bind(this.playing.next,this.playing))),this.playing.hasPrev()&&(this.$prev.removeClass("inactive"),this.$prev.on("click",_.bind(this.playing.prev,this.playing))),this.playing.paused?(this.$play.removeClass("inactive"),this.$play.removeClass("active"),this.$pause.addClass("active"),this.$play.on("click",_.bind(this.playing.unpause,this.playing)),this.trigger("state:changed","paused")):(this.$pause.removeClass("inactive"),this.$play.removeClass("active").addClass("active"),this.$pause.removeClass("active"),this.$pause.on("click",_.bind(this.playing.pause,this.playing)),this.trigger("state:changed","playing"))):(this.$play.removeClass("inactive"),this.$pause.removeClass("active"),this.$play.on("click",_.bind(this._play,this)),this.trigger("state:changed","stopped"))},_play:function(){var iCounter=0,toPlay=[];for(iCounter=this.from;iCounter<=this.to;iCounter++){var views=a5.speaking_recording.LNRInstancesPerInteraction[iCounter];views&&_.each(views,function(view){0==view.model.timeline.length&&(view.isListeningEnabled()&&toPlay.push(new a5.speaking_recording.PlayAllListening(this,toPlay,toPlay.length,view.listenAudio)),view.isRecordingEnabled()&&toPlay.push(new a5.speaking_recording.PlayAllRecordings(this,toPlay,toPlay.length,view.model.records[0])))},this)}toPlay.length>0&&toPlay[0].play()},stopAll:function(){this.playing&&this.playing.stop()},stopAllExcept:function(except){this.playing&&this.playing!==except&&this.playing.stop()}}),Obj.extend("a5.speaking_recording.PlayAllPart",{init:function(playAll,parts,index){this.playAll=playAll,this.parts=parts,this.index=index,this.paused=!1},play:function(){this.paused=!1,this.playAll._setPlaying(this)},pause:function(){this.paused=!0,this.playAll._setPlaying(this)},unpause:function(){this.paused=!1,this.playAll._setPlaying(this)},stop:function(){this.paused=!1,this.playAll._setPlaying(null)},next:function(){this.stop(),this.hasNext()&&this.parts[this.index+1].play()},prev:function(){this.stop(),this.parts[this.index-1].play()},hasNext:function(){return this.index<this.parts.length-1},hasPrev:function(){return this.index>0}}),a5.speaking_recording.PlayAllPart.extend("a5.speaking_recording.PlayAllListening",{init:function(playAll,parts,index,audio){this._super(playAll,parts,index),this.audio=audio},play:function(){this._super(),this.audio.position(0),this.audio.bind("stopped",this.next,this),this.audio.play()},pause:function(){this._super(),this.audio.pause()},unpause:function(){this._super(),this.audio.play()},stop:function(){this._super(),this.audio.unbind("stopped"),this.audio.stop()}}),a5.speaking_recording.PlayAllPart.extend("a5.speaking_recording.PlayAllRecordings",{init:function(playAll,parts,index,audios){this._super(playAll,parts,index),this.audios=audios},play:function(){this._super();var index=0;function callback(){this.hasNextRecording(index)?(this.audio=a5.service.media.audio_recorder.instance().createSource(this.audios[index]),index+=1,this.audio.bind("stopped",callback,this),this.audio.play()):this.next()}this.audio=a5.service.media.audio_recorder.instance().createSource(this.audios[index]),index+=1,this.audio.bind("stopped",callback,this),this.audio.play()},hasNextRecording:function(index){return index<this.audios.length},pause:function(){this._super(),this.audio.pause()},unpause:function(){this._super(),this.audio.play()},stop:function(){this._super(),this.audio.unbind("stopped"),this.audio.stop()}}),function(){a5.view.JQDialog.extend("a5.view.dialog.SpeakingRecordingTest",{template:"a5.view.dialog.SpeakingRecordingTest",TIMELIMIT:10,init:function(){this._super({dialogClass:"testRecording__dialog"}),this.id=a5.utils.createUID(),this.group="lnr-"+this.id,this.records=[]},canShow:function(){return"true"!==a5.utils.getPersistentKey("a5_hide_recording_test")},autoOpen:function(interaction){this.canShow()&&interaction.bind("show",function(){this.canShow()&&"input"===interaction.getStatus()&&this.open()},this,{once:!0})},renderContent:function(){this.recordButton=this.$el.find(".testRecording__control--record"),this.playButton=this.$el.find(".testRecording__control--play"),this.updateState("loading"),this.__ready=!1,$.when(a5.service.media.audio.ready(),a5.service.media.audio_recorder.ready()).then(function(){this.__ready||(this.updateState("ready"),this.__ready=!0)}.bind(this))},onShow:function(){a5.service.media.pauseAll(),this._super()},onHide:function(){this.stopAll();var $input=this.$el.find('.testRecording__checkbox input[type="checkbox"]');a5.utils.setPersistentKey("a5_hide_recording_test",$input.is(":checked")),this._super()},updateState:function(state,rec_state){state&&(this.state=state),rec_state&&(this.rec_state=rec_state),this._initState(),this._updateRecordButton(),this._updatePlayButton()},stopAll:function(){this.records=[],a5.tasks.clear(this.group);var currentTask=a5.tasks.current(this.group);currentTask&&currentTask.stop(),this.updateState("ready","ready")},startPlayback:function(){var playbackTask=new a5.speaking_recording.LNRPlayback(this,0,this.records,!0);playbackTask.bind("stop",this.onPlaybackEnded,this),a5.tasks.push(playbackTask,this.group,!0),this.updateState("playback")},startRecording:function(){this.stopAll();var simpleRecordTask=new a5.speaking_recording.LNRSimpleRecord(this,this.id,this.TIMELIMIT);simpleRecordTask.bind("error",this.onSimpleRecordError,this),simpleRecordTask.bind("stop",this.onSimpleRecordEnded,this),a5.tasks.push(simpleRecordTask,this.group,!0),this.updateState("simple-recording")},onSimpleRecordEnded:function(){this.updateState("ready","ready")},onSimpleRecordError:function(){this.stopAll()},onPlaybackEnded:function(){this.updateState("ready")},_enableButton:function($button){$button.removeAttr("disabled")},_disableButton:function($button){$button.attr("disabled","disabled")},_initButton:function($button){$button.off("click"),this._disableButton($button)},_initState:function(){this._initButton(this.recordButton),this._initButton(this.playButton),this.$el.dialog("instance")&&this.$el.dialog("widget").removeClass("testRecording__dialog--recording testRecording__dialog--playing")},_updateRecordButton:function(){this.recordButton.attr("aria-pressed",!1),"simple-recording"===this.state&&(this._enableButton(this.recordButton),"recording"===this.rec_state&&(this.recordButton.attr("aria-pressed",!0),this.$el.dialog("widget").addClass("testRecording__dialog--recording"),this.recordButton.on("click",_.bind(function(e){a5.tasks.current(this.group).stop()},this)))),"ready"!==this.state&&"playback"!==this.state||(this._enableButton(this.recordButton),this.recordButton.on("click",_.bind(function(e){this.startRecording()},this)))},_updatePlayButton:function(){this.playButton.attr("aria-pressed",!1),this.records.length>0&&("ready"===this.state&&(this._enableButton(this.playButton),this.playButton.on("click",_.bind(function(e){this.startPlayback()},this))),"playback"===this.state&&(this._enableButton(this.playButton),"playing-paused"===this.rec_state?this.playButton.on("click",_.bind(function(e){a5.tasks.current(this.group).unpause()},this)):(this.playButton.attr("aria-pressed",!0),this.$el.dialog("widget").addClass("testRecording__dialog--playing"),this.playButton.on("click",_.bind(function(e){a5.tasks.current(this.group).pause()},this)))))}});var instance;a5.view.dialog.SpeakingRecordingTest.getInstance=function(){return instance||(instance=new a5.view.dialog.SpeakingRecordingTest)}}(),a5.Task.extend("a5.speaking_recording.LNRSimpleRecord",{init:function(view,id,timelimit){this.view=view,this.recordedParts=[],this.status="new",this.timelimit=timelimit,this.timelimitMs=1e3*this.timelimit,this.id=id},run:function(){if("new"===this.status){if(this.status="waiting",this.recording=a5.service.media.audio_recorder.instance().record(this.id+"_"+this.recordedParts.length),!this.recording)return!0;this.recording.bind("start",this.onRecordingStarted,this),this.recording.bind("recorded",this.onRecordingStopped,this),this.recording.bind("error",this.onRecordingError,this),this.recording.bind("mic_notallowed",this.onRecordingMicNotAllowed,this),this.view.updateState(null,"waiting-for-mic"),this.recording.start()}if("ended"===this.status)return this.view.records[0]=_.pluck(this.recordedParts,"filename"),!0;if(this.timelimit&&"recording"===this.status){var elapsedTime=this._getElapsedTime();elapsedTime>=this.timelimitMs?(this.stop(),this.trigger("progress",this.timelimitMs)):this.trigger("progress",elapsedTime)}return!1},pause:function(){this.recording&&(this.status="paused",this.view.updateState(null,"paused"),this.recording.stop())},unpause:function(){this.status="new"},stop:function(){this.recording&&(this.status="stopping",this.recording.stop())},onRecordingStarted:function(){this.startTime=+new Date,this.elapsedTime=0,this.recordedParts.push(this.recording),this.status="recording",this.view.updateState(null,"recording"),logger.info("start recording")},onRecordingError:function(){this.trigger("error")},onRecordingMicNotAllowed:function(){this.trigger("error")},onRecordingStopped:function(){"stopping"===this.status&&(this.status="ended",logger.info("end recording"))},_getElapsedTime:function(){var current=+new Date,elapsed=current-this.startTime;return this.startTime=current,this.elapsedTime+=elapsed,this.elapsedTime}}),a5.Task.extend("a5.speaking_recording.LNRRecord",{init:function(view,duration,part,id,timelimit){this.view=view,this.duration=1e3*duration,this.part=part,this.recordedElapsed=0,this.recordedParts=[],this.timelimit=timelimit,this.id=id,this.status="new"},start:function(){this.recordedParts.push(this.recording),this.status="recording",this.startTime=+new Date,this.timeStarted=+new Date,this.timePlayed=0,this.view.updateState(null,"recording"),logger.info("start recording")},run:function(){if("new"===this.status){if(this.status="waiting",this.recording=a5.service.media.audio_recorder.instance().record(this.id+"_"+this.recordedParts.length),!this.recording)return!0;this.recording.bind("start",this.start,this),this.recording.bind("error",this.onRecordingError,this),this.recording.start()}if("recording"===this.status||"terminate"===this.status){var total=this.recordedElapsed;total+=+new Date-this.startTime,total>this.duration&&(this.recording.stop(),this.status="stopping",this.recording.bind("recorded",function(){this.status="ended",logger.info("end recording")},this))}if(this.timelimit&&"recording"===this.status){var currentTime=+new Date,played=currentTime-this.timeStarted;this.timeStarted=currentTime,this.timePlayed+=played,this.timePlayed>=1e3*this.timelimit&&this.stop()}return"ended"===this.status&&(this.view.records[this.part]=_.pluck(this.recordedParts,"filename"),this.view.updateState(),!0)},pause:function(){this.recording&&(this.status="paused",this.recordedElapsed+=+new Date-this.startTime,this.recording.stop(),this.view.updateState(null,"paused"))},unpause:function(){this.status="new"},stop:function(){this.status="terminate"},onRecordingError:function(){this.trigger("error")}}),a5.Task.extend("a5.speaking_recording.LNRPlay",{init:function(view,from,to){this.view=view,this.from=1e3*from,this.to=1e3*to,this.status="new"},run:function(){return"new"===this.status&&this.view.listenAudio.position(this.from)&&(this.view.listenAudio.bind("progress",this.progress,this),this.view.listenAudio.bind("stopped",this.stopped,this,{once:!0}),this.view.updateState(null,"listening"),this.view.listenAudio.play(),this.status="playing"),"ended"===this.status},stop:function(){this.view.listenAudio.stop(),this.view.updateState(),this.status="ended"},pause:function(){this.status="paused",this.view.listenAudio.pause(),this.view.updateState(null,"listening-paused")},unpause:function(){this.status="playing",this.view.listenAudio.play(),this.view.updateState(null,"listening")},progress:function(time){time>this.to&&this.stop()},stopped:function(time){this.view.listenAudio.unbind("stopped",this.stopped),this.view.listenAudio.unbind("progress",this.progress),this.status="ended"}}),a5.Task.extend("a5.speaking_recording.LNRListen",{init:function(view,from,to){this.view=view,this.status="new"},run:function(){return"new"===this.status&&(this.view.listenAudio.bind("stopped",this.stopped,this),this.view.listenAudio.position(0),this.view.listenAudio.play(),this.status="playing",this.view.updateState("listening","listening")),"ended"===this.status},stop:function(){this.view.listenAudio.stop(),this.status="ended"},pause:function(){this.status="paused",this.view.listenAudio.pause(),this.view.updateState(null,"listening-paused")},unpause:function(){this.status="playing",this.view.listenAudio.play(),this.view.updateState(null,"listening")},stopped:function(time){this.view.listenAudio.unbind("stopped",this.stopped),this.status="ended"}}),a5.Task.extend("a5.speaking_recording.LNRRecordEnded",{init:function(view,uploadTasks){this.view=view,this.uploadTasks=uploadTasks||[]},run:function(){return this._uploadWithError()||(this.view.model.records=this.view.records,this.view.allRecordsUploaded=!0,this.view.model.notifyValueChange()),this.view.updateState("ready","ready"),!0},stop:function(){},_uploadWithError:function(){return _.isArray(this.uploadTasks)||(this.uploadTasks=[this.uploadTasks]),_.some(this.uploadTasks,function(task){return"error"===task.status})}}),a5.Task.extend("a5.speaking_recording.LNRPlayback",{init:function(view,part,records,local){this.view=view,this.part=part,this.snippet=0,this.records=records,this.local=local},run:function(){if(!this.playing&&!this.ended){var id=this.records[this.part][this.snippet];_.isUndefined(id)||(this.local?this.playing=a5.service.media.audio_recorder.instance().createLocalSource(id):this.playing=a5.service.media.audio_recorder.instance().createSource(id),this.playing.bind("stopped",_.bind(function(){this.playing=null},this)),this.playing.play()),this.snippet++}return this.ended||this.snippet>=this.records[this.part].length&&!this.playing},stop:function(){this.playing&&this.playing.stop(),this.ended=!0},pause:function(){this.playing&&(this.status="paused",this.playing.pause(),this.view.updateState(null,"playing-paused"))},unpause:function(){this.playing&&(this.status="playing",this.playing.play(),this.view.updateState(null,"playing"))}}),a5.Task.extend("a5.speaking_recording.LNRRecordUpload",{init:function(view,part){this.view=view,this.part=part||0,this.status="new"},run:function(){if("new"===this.status){var promises=[];_(this.view.records[this.part]).each(function(snippet,index){var promise=a5.service.media.audio_recorder.instance().upload(snippet).then(function(filename){filename&&(this.view.records[this.part][index]=filename)}.bind(this));promises.push(promise)},this),this.status="uploading",this.view.updateState(null,"uploading"),$.when.apply($,promises).done(_.bind(function(){this.stop()},this)).fail(_.bind(function(){this.error()},this))}return"ended"===this.status||"error"===this.status},stop:function(){this.status="ended"},error:function(){this.status="error",this.trigger("error")}}),a5.Task.extend("a5.speaking_recording.LNREnded",{init:function(view){this.view=view},run:function(){return this.view.updateState("ready"),!0},stop:function(){}}),a5.views.interaction.TemplateView={render:function(){return this.node.off(),this.node.empty().html(a5.mainBuilder.layout.getTemplate(_(this).result("template")))},bindNode:function(event,selector,handler,options){options=_.defaults(options||{},{preventDefault:!1,stopPropagation:!1}),_.isUndefined(handler)&&(handler=selector,selector=null);var self=this;this.node.on(event,selector,function(e){options.preventDefault&&e.preventDefault(),options.stopPropagation&&e.stopPropagation(),handler.apply(self,arguments)})},bindNodeD:function(event,selector,handler){this.bindNode(event,selector,handler,{preventDefault:!0})},bindNodeP:function(event,selector,handler){this.bindNode(event,selector,handler,{stopPropagation:!0})},bindNodeDP:function(event,selector,handler){this.bindNode(event,selector,handler,{preventDefault:!0,stopPropagation:!0})},unbindNode:function(){this.node.off.apply(this.node,arguments)}};a5.views.interaction.BaseView.extend("a5.views.interaction.TemplateView"),a5.model_builder.BookBuilder={buildBook:function($node,view,model){this._buildLinks($node,view),this._buildTitle(model.title),this._buildHelpLink(),this.engine.getBook().setProperties({model:model,view:view})},_buildLinks:function($node,view){var toolbar=view.toolbar,$links=$("ul.controls");_.each($node.find("> links > a"),function(link){var $link=$(link),linkView=new a5.views.BookLink($link.text(),$link.attr("href"),$link.attr("target"));linkView.bind("open",toolbar.audioPlayer.pause,toolbar.audioPlayer),$links.append(linkView.render())})},_buildTitle:function(title){$(".header > .title, head > title").text(title)},_buildHelpLink:function(){if(window.gon&&gon.helpLink){var link=gon.helpLink.help_links[0];$(".header .link-help a").attr("href",link.url).text(link.value)}}},a5.model_builder.Base.extend("a5.model_builder.BookBuilder"),a5.model_builder.PPEbookBuilder={isResponsible:function(node,interaction){return"Present:Present:Ebook"===interaction.identifier&&node.is("ebook")},buildEbook:function(interaction,$parentNode,$node){this.model=this._createModel(interaction,$node),this.view=this._createView(),$node.attr("annotations")&&!$node.is("[annotations=true]")||!this.view.toolbar.hasAnnotationsButton()||(this.model.annotations=this._createAnnotations(),this.model.annotations.toolbox.bind("toolbox:select",function(tool){"cursor"!==tool.name?(this.view.deselectTools(),this.view.pages.scroller.disableSwipe()):this.view.pages.scroller.enableSwipe()},this)),this._buildPages($node.find("> pages")),this.engine.invoke("book:enable-solution-view")&&this._buildSolutionPages($node.find("> solution-pages"),"true"===$node.attr("solution-hotspot-clone")),this._buildTocEntries($node.find("> toc"),this.view.toc),this.buildBook($node,this.view,this.model),interaction.bind("show",function(){this.bind("opened",function(){a5.eventBus.trigger("book:open_page",this.model.getCurrentPageNumber())},this),this.bind("opened-in-solution-view",function(current,options){options.afterSolutionOpened||a5.eventBus.trigger("book:open_page",this.model.getCurrentPageNumber())},this),a5.eventBus.trigger("book:open_page",this.model.getCurrentPageNumber())},this.view.pages,{once:!0}),interaction.bind("show:deferred",function(){this.updateScroller()},this.view.pages,{once:!0}),_.bindAll(this,"_onWindowResize","_onFullscreenChange"),$(window).on("resize",this._onFullscreenChange),screenfull.enabled&&screenfull.onchange(this._onFullscreenChange),this.model.bind("page_change overlay_change",function(){interaction.store()}),$node.attr("audiocontrols")||this.view.toolbar.audioPlayer.hide(),"true"==$node.attr("autosave")&&interaction.startAutosave(),$parentNode.append(this.view.render()),a5.hooks.ppebookRendered.call(this.view),interaction.blockItems.add(this.model)},_createModel:function(interaction,$node){var pageCount=$node.find("> pages > page").length;return new a5.models.interaction.PPEbook({title:$node.attr("title"),pageCount:pageCount,author:$node.attr("author"),cover:$node.is("[cover=true]"),pagesPerScreen:A5.DEFAULT_PAGES_PER_SCREEN||2,restorePerScreen:"url"!==A5.PAGES_PER_SCREEN_SOURCE,effects:$node.is("[effects=true]"),offset:parseInt($node.attr("offset")||0,10),parent:interaction,startingPage:parseInt(a5.getURLParameter("page"),10)})},_createView:function(){return new a5.views.interaction.PPEbook(this.model)},_createAnnotations:function(){var annotations=new a5.Annotations({language:a5.dp.config.bookAnnotationsLanguage,stage:"annotations",appendTo:a5.dp.config.bookAnnotationsToolbarAppendTo,toolboxInsideBounds:a5.dp.config.bookAnnotationsToolbarInsideBounds,toolboxInitialPosition:a5.dp.config.bookAnnotationsToolbarPosition,keyboard:!0,intView:this.view,displayAsPopup:a5.dp.config.bookAnnotationsToolbarAsPopup,stickyNoteWithTitle:a5.dp.config.bookStickyNoteWithTitle,stickyNoteMinSize:a5.dp.config.bookStickyNoteMinSize,toolbarDragOnlyFromHandle:a5.dp.config.bookAnnotationsToolbarDragOnlyFromHandle});return annotations.toolbox.use(_.map(A5.ANNOTATIONS_TOOLBOX.split(/, ?/),function(name){return new a5.Annotations.Tool[name]})),annotations.useTool(A5.ANNOTATIONS_INITIAL_TOOL),annotations},_buildPages:function($node){_.each($node.children("page"),function(pageNode,index){var $page=$(pageNode),pageModel=new a5.models.interaction.PPEbookPage({index:index,parent:this.model,type:$page.attr("content_type"),thumbnail:A5.ASSET_URL_BUILDER($page.attr("thumbnail")),url:A5.ASSET_URL_BUILDER($page.attr("url")),width:parseInt($page.attr("width"),10),height:parseInt($page.attr("height"),10),audio:$page.attr("audio"),engine:this.engine});this.model.append(pageModel),this._buildHotspots(pageModel,$page.find("> hotspots"));var pageView=new a5.views.interaction.PPEbookPage(pageModel,this.view);this.view.append(pageView)},this)},_buildSolutionPages:function($node,cloneHotspots){_.each($node.children("solution-page"),function(pageNode,index){var $page=$(pageNode),pageModel=new a5.models.interaction.PPEbookSolutionPage({index:index,parent:this.model,type:$page.attr("content_type"),thumbnail:A5.ASSET_URL_BUILDER($page.attr("thumbnail")),url:A5.ASSET_URL_BUILDER($page.attr("url")),width:parseInt($page.attr("width"),10),height:parseInt($page.attr("height"),10),audio:$page.attr("audio"),ref:$page.attr("ref"),engine:this.engine});this.model.appendSolutionPage(pageModel),cloneHotspots&&(pageModel.hotspots=pageModel.page.hotspots.slice()),this._buildHotspots(pageModel,$page.find("> hotspots"));var pageView=new a5.views.interaction.PPEbookPage(pageModel,this.view);this.view.appendSolutionPage(pageView)},this)},_buildTocEntries:function($node,parent){var currentSection=parent;_.each($node.children("entry, section"),function(item){var $item=$(item);if($item.is("section")){var section=new a5.views.interaction.PPEbookTOCSection(this.model,$item.attr("title"));parent.append(section),currentSection=section}else{var range=this._extractPageRange($item.attr("page")),entry=new a5.views.interaction.PPEbookTOCEntry(this.model,$item.attr("title"),range.start,range.end,$item.attr("pagelabel"));currentSection.append(entry),this._buildTocEntries($item,entry)}},this)},_buildHotspots:function(pageModel,$node){_.each($node.children(),function(entry){var $entry=$(entry),visibility=$entry.attr("visibility");if(!visibility||"all"===visibility||visibility===a5.service.lms.API.getUserRole().toLowerCase()){var options={tooltip:this._buildTooltip($entry),icon:$entry.attr("icon"),shape:$entry.attr("shape")||"",top:parseInt($entry.attr("top"),10),left:parseInt($entry.attr("left"),10),width:parseInt($entry.attr("width"),10),height:parseInt($entry.attr("height"),10)},hotspotClass=this._extractHotspotClassFromNode($entry),hotspot=new hotspotClass(this.model,this.view,$entry,options);"external"===hotspot.type&&(this.currentExternalHotspot&&(this.currentExternalHotspot.next=hotspot),hotspot.prev=this.currentExternalHotspot,this.currentExternalHotspot=hotspot),pageModel.addHotspot(hotspot)}},this)},_buildTooltip:function($node){var tooltip=$node.attr("tooltip");return tooltip&&(tooltip=tooltip.split("##")[0]),tooltip},_extractHotspotClassFromNode:function($node){var tagName=$node[0].tagName,className="PPEbookHotspot"+a5.utils.capitalize(tagName);"audio"===tagName?className+=a5.utils.capitalize($node.attr("mode")):"page-link"===tagName?className="PPEbookHotspotPageLink":"content-solution"===tagName?className="PPEbookHotspotContentSolution":"structure-node"===tagName?className=$node.find("> children").length>0?"PPEbookHotspotMultipleStructure":"PPEbookHotspotSingleStructure":"embedded"===tagName?className+=a5.utils.capitalize($node.attr("target")):"single-solution"===tagName?className="PPEbookHotspotSingleSolution":"solutions-group"===tagName&&(className="PPEbookHotspotSolutionsGroup");var hotspotClass=a5.views.interaction[className];return hotspotClass=hotspotClass||a5.views.interaction.PPEbookHotspotContent},_extractPageRange:function(pageAttr){var pos=pageAttr.indexOf("-",1),start=-1===pos?pageAttr:pageAttr.substring(0,pos),end=-1===pos?pageAttr:pageAttr.substring(pos+1);return{start:parseInt(start,10),end:parseInt(end,10)}},_onWindowResize:function(){this._updateScroller()},_onFullscreenChange:function(){this._updateScroller()},_updateScroller:function(){this.view.pages.updateScroller({afterResize:!0})}},a5.model_builder.BookBuilder.extend("a5.model_builder.PPEbookBuilder"),a5.models.interaction.Book={title:null},a5.models.interaction.BaseModel.extend("a5.models.interaction.Book"),a5.models.interaction.PPEbook={init:function(parameters){this._super(parameters,{lastVisitedPage:0,page:0,startingPage:null,pageCount:0,pagesPerScreen:0,restorePerScreen:!0,offset:0,cover:!1,effects:!1,author:null,title:null}),this.pages=[],this.solutionPages=[],this.annotations=null,this.overlay=new a5.models.interaction.PPEbookOverlay,this.overlay.bind("changed",function(){this.trigger("overlay_change")},this),this.isValidPage(this.startingPage)&&(this.skipRestorePage=!0,this.page=this.printedPageToPageIndex(this.startingPage))},canPrint:function(){return _.every(this.pages,function(page){return page.isPDF()})},append:function(page){this.pages.push(page),this.pageCount=this.pages.length,this.annotations&&this.annotations.allocate(page)},appendSolutionPage:function(solutionPage){this.solutionPages.push(solutionPage);var pageIndex=parseInt(solutionPage.ref,10)-1,page=this.pages[pageIndex];page&&(page.solutionPage=solutionPage,solutionPage.page=page),this.annotations&&this.annotations.allocate({index:solutionPage.index+this.pageCount})},storePages:function(){return{children:_(this.pages).reduce(function(result,page,index){var pageData=page.store();return _.isEmpty(pageData)||(result[index]=pageData),result},{})}},restorePages:function(data){_.each(this.pages,function(page,i){page.restore(data.children[i])},this)},serializePages:function(){return _.invoke(this.pages,"serialize")},store:function(){this.annotations&&this.annotations.save();var data=this.storePages();return data.lastVisitedPage=this.lastVisitedPage,data.page=this.page,data.pagesPerScreen=this.pagesPerScreen,data.overlay=this.overlay.store(),data},restore:function(data){data&&(data.children&&this.restorePages(data),this.skipRestorePage||(this.isValidPage(this.pageIndexToPrintedPage(data.page))?this.page=data.page:this.page=0,this.lastVisitedPage=data.lastVisitedPage),this.restorePerScreen&&(this.pagesPerScreen=data.pagesPerScreen),this.overlay.restore(data.overlay),this.trigger("restore"))},openPageNumber:function(pageNumber){this.openPage(this.printedPageToPageIndex(pageNumber))},nextPage:function(){var page=this.page+this.pagesPerScreen;page>=this.pageCount&&(this.trigger("page_missing"),page=this.pageCount-1),this.openPage(page)},previousPage:function(){var page=this.page-this.pagesPerScreen;page<0&&(this.trigger("page_missing"),page=0),this.openPage(page)},openPage:function(page,options){if(options=options||{},!this._inBounds(page))return void this.trigger("page_missing");(page!==this.page||options.afterSolutionClosed)&&(this.lastVisitedPage=this.page,this.page=page,this.trigger("page_change",options))},openLastVisitedPage:function(){this.openPage(this.lastVisitedPage)},setStartingPage:function(page){this.startingPage=page,this.openPageNumber(page)},setPagesPerScreen:function(value){this.pagesPerScreen=value,this.page=this.current.from,this.trigger("page_change"),this.trigger("per_screen_change")},getPagesPerScreen:function(){return this.pagesPerScreen},getRestrictedPages:function(){return this.restrictedPages||(this.restrictedPages=this._expandRestrictedList(a5.service.lms.API.getRestrictedPages())),this.restrictedPages},isRestrictedPage:function(page){return _.contains(this.getRestrictedPages(),this.pageIndexToPrintedPage(page))},hasSolutionPage:function(pageIndex){return pageIndex>=0&&pageIndex<this.pageCount&&!!this.pages[pageIndex].solutionPage},getBookmarks:function(){return _(this.pages).chain().filter(function(page){return page.bookmarked}).map(function(page){return{page:page.number,thumbnail:page.thumbnail,text:page.bookmarkText}}).value()},bookmark:function(printedPage,text){var pageIndex=this.printedPageToPageIndex(printedPage);this.pages[pageIndex].bookmark(text)},unbookmark:function(printedPage){var pageIndex=this.printedPageToPageIndex(printedPage);this.pages[pageIndex].unbookmark()},getNotes:function(){var notes=[];if(this.annotations){var annotations=this.annotations.current.serialize().annotations;_.chain(annotations).pick(function(annotation){return annotation.features.length>0&&_(annotation.features).some(function(feature){return"Block"===feature.type})}).each(function(annotation,pageIndex){_.each(annotation.features,function(feature){"sticky note"===feature.content.tool.name&&notes.push({page:this.pageIndexToPrintedPage(pageIndex),title:feature.content.title})},this)},this)}return notes},addFileHotspot:function(printedPage,hotspot){var page=this.getPageByPageNumber(printedPage);page&&page.addFileHotspot(hotspot)},closeAllHotspots:function(){_(this.pages).invoke("closeHotspots")},tryCloseAllHotspots:function(){_(this.pages).invoke("tryCloseHotspots")},getHotspotById:function(id){var found;return _.each(this.pages,function(page){found||(found=page.getHotspotById(id))}),found},getPageByPageNumber:function(printedPage){var pageIndex=this.printedPageToPageIndex(printedPage)
;return this.pages[pageIndex]},getPageByPageIndex:function(pageIndex){return this.pages[pageIndex]},getCurrentPage:function(){return this.pages[this.current.from]},getCurrentPageNumber:function(){return this.pageIndexToPrintedPage(this.current.from)},getPageRange:function(lower,upper){return lower=this.printedPageToPageIndex(lower),upper=this.printedPageToPageIndex(upper),_.filter(this.pages,function(page){return page.index>=lower&&page.index<=upper})},pageIndexToPrintedPage:function(pageIndex){return pageIndex-this.offset+1},printedPageToPageIndex:function(printedPage){return printedPage+this.offset-1},isValidPage:function(printedPage){var pageIndex=this.printedPageToPageIndex(printedPage);return!_.isNaN(pageIndex)&&_.isNumber(pageIndex)&&this._inBounds(pageIndex)},save:function(){a5.mainBuilder.curInteraction.store()},_expandRestrictedList:function(list){return _(list).chain().map(function(item){var range=item.split("-"),start=parseInt(_.first(range),10),end=parseInt(_.last(range),10);if(!_.isNaN(start)&&!_.isNaN(end))return _.range(start,end+1)}).compact().flatten().uniq().value()},_inBounds:function(page){return page>=0&&page<this.pageCount}},a5.models.interaction.Book.extend("a5.models.interaction.PPEbook"),a5.models.interaction.PPEbookPage={note:"",bookmarked:!1,bookmarkText:null,restricted:!1,number:null,solutionPage:null,cover:!1,init:function(parameters,defaults){this._super(parameters,{index:null,url:null,width:0,height:0,thumbnail:null,audio:null,type:null}),this.cover=this.parent.cover&&0===parameters.index,this.number=this.parent.pageIndexToPrintedPage(parameters.index),this.restricted=this.parent.isRestrictedPage(parameters.index),this.isPDF()&&(this.pdfWidth=this.width,this.pdfHeight=this.height,this.width=a5.utils.convertPTtoPXat96DPI(this.width),this.height=a5.utils.convertPTtoPXat96DPI(this.height)),this.hotspots=[]},isPDF:function(){return"application/pdf"===this.type},bookmark:function(text){this.bookmarked=!0,this.bookmarkText=text},unbookmark:function(){this.bookmarked=!1,this.bookmarkText=null},addFileHotspot:function(hotspot){hotspot.page=this,this.hotspots.push(hotspot),this.trigger("hotspot_added",hotspot)},removeFileHotspot:function(hotspot){this.hotspots=_(this.hotspots).reject(function(h){return h.id===hotspot.id})},addHotspot:function(hotspot){this.isPDF()&&(hotspot.top=hotspot.top*window.devicePixelRatio*1.33,hotspot.left=hotspot.left*window.devicePixelRatio*1.33,hotspot.width=hotspot.width*window.devicePixelRatio*1.33,hotspot.height=hotspot.height*window.devicePixelRatio*1.33),hotspot.page=this,this.hotspots.push(hotspot),this.trigger("hotspot_added",hotspot)},getVisibleHotspots:function(){return(this.dfdVisibleHotspots||(this.dfdVisibleHotspots=function(){var structureHotspotRefs=_.chain(this.hotspots).filter(function(hotspot){return"structure-single"===hotspot.type||"structure-multiple"===hotspot.type}).pluck("ref").value();return $.when(this.engine.invoke("book:hotspots:filter-structure-nodes",structureHotspotRefs))}.bind(this)())).then(function(visibleStructureHotspotRefs){return _.reject(this.hotspots,function(hotspot){return("structure-single"===hotspot.type||"structure-multiple"===hotspot.type)&&!_.contains(visibleStructureHotspotRefs,hotspot.ref)})}.bind(this))},closeHotspots:function(){_(this.hotspots).invoke("close")},tryCloseHotspots:function(){_(this.hotspots).invoke("tryClose")},getHotspotById:function(id){return _.find(this.hotspots,function(hotspot){return hotspot.id===id})},getHotspotsByType:function(type){return _.filter(this.hotspots,function(hotspot){return hotspot.type===type})},hasNotes:function(){return!_.isString(this.note)||$(this.note).text().trim().length>0},hasResources:function(){return $.when(this.engine.invoke("book:has-resources",{page:this.number,index:this.index,offset:this.parent.offset}))},hasHotspots:function(){return!!this.hotspots.length},hasSolutionPage:function(){return!!this.solutionPage},hasHotspotsByType:function(type){return!!this.getHotspotsByType(type).length},store:function(){var data={};if(this.note&&(data.note=this.note),this.bookmarked&&(data.bookmarked=!0),this.bookmarkText&&(data.bookmarkText=this.bookmarkText),this.hotspots){var hotspots=this._serializeFileHotspots();hotspots.length>0&&(data.hotspots=hotspots)}return data},restore:function(data){data&&("note"in data&&(this.note=data.note),"bookmarked"in data&&(this.bookmarked=data.bookmarked),"bookmarkText"in data&&(this.bookmarkText=data.bookmarkText),this.trigger("restore",data))},serialize:function(){return{page:this.number,cover:this.cover,restricted:this.restricted,thumbnail:this.thumbnail,bookmarked:this.bookmarked,url:this.url}},_serializeFileHotspots:function(){return _(this.hotspots).chain().filter(function(hotspot){return"file"===hotspot.type}).map(function(hotspot){return hotspot.serialize()}).value()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.PPEbookPage"),a5.models.interaction.PPEbookSolutionPage={init:function(parameters,defaults){this._super(parameters,{index:null,url:null,width:0,height:0,thumbnail:null,audio:null,ref:null,type:null,page:null}),this.isPDF()&&(this.pdfWidth=this.width,this.pdfHeight=this.height,this.width=a5.utils.convertPTtoPXat96DPI(this.width),this.height=a5.utils.convertPTtoPXat96DPI(this.height)),this.hotspots=[]},isPDF:function(){return"application/pdf"===this.type},addFileHotspot:function(hotspot){hotspot.page=this,this.hotspots.push(hotspot),this.trigger("hotspot_added",hotspot)},removeFileHotspot:function(hotspot){this.hotspots=_(this.hotspots).reject(function(h){return h.id===hotspot.id})},addHotspot:function(hotspot){this.isPDF()&&(hotspot.top=hotspot.top*window.devicePixelRatio*1.33,hotspot.left=hotspot.left*window.devicePixelRatio*1.33,hotspot.width=hotspot.width*window.devicePixelRatio*1.33,hotspot.height=hotspot.height*window.devicePixelRatio*1.33),this.hotspots.push(hotspot),this.trigger("hotspot_added",hotspot)},getVisibleHotspots:function(){return(this.dfdVisibleHotspots||(this.dfdVisibleHotspots=function(){var structureHotspotRefs=_.chain(this.hotspots).filter(function(hotspot){return"structure-single"===hotspot.type||"structure-multiple"===hotspot.type}).pluck("ref").value();return $.when(this.engine.invoke("book:hotspots:filter-structure-nodes",structureHotspotRefs))}.bind(this)())).then(function(visibleStructureHotspotRefs){return _.reject(this.hotspots,function(hotspot){return("structure-single"===hotspot.type||"structure-multiple"===hotspot.type)&&!_.contains(visibleStructureHotspotRefs,hotspot.ref)})}.bind(this))},store:function(){var data={};if(this.hotspots){var hotspots=this._serializeFileHotspots();hotspots.length>0&&(data.hotspots=hotspots)}return data},restore:function(data){data&&this.trigger("restore",data)},_serializeFileHotspots:function(){return _(this.hotspots).chain().filter(function(hotspot){return"file"===hotspot.type}).map(function(hotspot){return hotspot.serialize()}).value()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.PPEbookSolutionPage"),a5.models.interaction.PPEbookOverlay={setSwatch:function(swatch,isRestore){this.isDisabled(swatch)?(delete this.swatch,this.trigger("disable-overlay")):(this.swatch=swatch,this.trigger("set-swatch",swatch)),isRestore||this.trigger("changed")},isDisabled:function(swatch){return"swatch-none"===swatch},store:function(){return this.swatch},restore:function(data){data&&(this.setSwatch(data,!0),this.trigger("update",data))}},a5.models.interaction.BaseModel.extend("a5.models.interaction.PPEbookOverlay"),a5.views.interaction.BookAudioPlayer={template:"book_audio_player",init:function(model){this._super(model,null,$('<div class="audio-player"></div>')),this.volumeControl=new a5.views.interaction.BookSlider(1),this.volumeControl.bind("change",this.volumeControlChanged,this),this.player=new a5.SimpleAudioPlayer,this.player.bind("change_state",this.stateChanged,this),this.player.bind("change_state:deferred",this.afterStateChanged,this),this.player.bind("change_volume",this.volumeChanged,this)},render:function(){return this._super(),this.$(".sound-mute").before(this.volumeControl.render()),_.defer(_.bind(this.stateChanged,this)),_.defer(_.bind(this.volumeChanged,this)),this.bindNode("click",".sound-play",this.play),this.bindNode("click",".sound-pause",this.pause),this.bindNode("click",".sound-stop",this.stop),this.bindNode("click",".sound-mute",function(){this.player.changeVolume(0)}),this.bindNode("click",".sound-unmute",function(){this.player.changeVolume(1)}),this.node},hide:function(){this.node.hide()},play:function(){this.player.play()},pause:function(){this.player.pause()},stop:function(){this.player.stop()},stateChanged:function(){var playing="playing"==this.player.state;this.$(".sound-play").toggle(!playing),this.$(".sound-pause").toggle(playing)},afterStateChanged:function(){this.node.toggleClass("no-audio",!this.player.queue.length)},volumeControlChanged:function(){this.player.changeVolume(this.volumeControl.current)},volumeChanged:function(){this.volumeControl.setTo(this.player.volume);var muted=this.player.volume<=0;this.$(".sound-mute").toggle(!muted),this.$(".sound-unmute").toggle(muted)}},a5.views.interaction.TemplateView.extend("a5.views.interaction.BookAudioPlayer"),a5.views.BookLink={NODE_TEMPLATE:'<li class="link gui-control linkactivity"></li>',init:function(text,href,target){this.$el=$(this.NODE_TEMPLATE),this.href=href,this.target=target,this.text=text,_.bindAll(this,"_onClick"),this.$el.on("click","a",this._onClick)},render:function(){var $link=$("<a>").text(this.text);return $link.attr("href",this.href),$link.attr("title",this.href),this.$el.html($link),this.$el},open:function(){if(this.trigger("open"),"dialog"!==this.target||navigator.userAgent.toLowerCase().indexOf("nexus 7")>0)a5.mainBuilder.engine.invoke("open-link",this.href);else{var $dialog=$(a5.mainBuilder.layout.getTemplate("ebook_external_link"));$dialog.modal(),$dialog.on("hidden",function(){$dialog.remove()}),a5.mainBuilder.engine.invoke("open-link",this.href,{target:"iframe",$iframe:$dialog.find("iframe")})}},_onClick:function(e){e.preventDefault(),this.open()}},Obj.extend("a5.views.BookLink"),a5.views.interaction.BookSlider={template:"book_slider",disabled:!1,init:function(max){this._super(null,null,$('<div class="slider"></div>')),this.max=max},render:function(){return this._super(),this.bindNodeD("mousedown",this.mousedown),this.node},mousedown:function(e){this.setByCoordinate(e.pageX),$("body").on("mousemove",_.bind(this.mousemove,this)).on("mouseup mouseleave",_.bind(this.mouseup,this)),this.disabled=!0},mousemove:function(e){this.setByCoordinate(e.pageX)},mouseup:function(e){$("body").off("mousemove mouseup mouseleave"),this.disabled=!1},setByCoordinate:function(left){left-=this.node.offset().left,this._setTo(left/this.node.outerWidth()*this.max),this.trigger("change")},setTo:function(value){this.disabled||this._setTo(value)},_setTo:function(value){value>this.max&&(value=this.max),value<0&&(value=0),this.current=value;var valuePct=value/this.max*100;this.$(".handle").css("left",valuePct+"%"),this.$(".progress").css("width",valuePct+"%")},setMax:function(value){this.max=value}},a5.views.interaction.TemplateView.extend("a5.views.interaction.BookSlider"),a5.views.interaction.BookToolbar={init:function(model,parent){this._super(model,parent,$('<div class="toolbar"></div>')),this.audioPlayer=new a5.views.interaction.BookAudioPlayer},render:function(){return this._super(),this.$(".container").prepend(this.audioPlayer.render()),this.node}},a5.views.interaction.TemplateView.extend("a5.views.interaction.BookToolbar"),a5.views.interaction.PPEbook={template:"ebook",zoomedInTemplate:"a5.book.alert.ZoomedIn",zoomedOutTemplate:"a5.book.alert.ZoomedOut",announcePageTemplate:"a5.book.alert.AnnouncePage",missingPageTemplate:"a5.book.alert.MissingPage",bookmarkAddTemplate:"a5.book.alert.BookmarkAdd",bookmarkRemoveTemplate:"a5.book.alert.BookmarkRemove",init:function(model){this._super(model,null,$('<div class="ebook book"></div>')),this.options={},_.bindAll(this,"_onKeydown","_onKeyup","_onCloseCountdownSetup","_onFullscreenChange","_onClickGoPage","_onSubmitGoPage","_onClickCurrentPage","_onClick","_onClickGoFirst","_onClickGoLast","_onClickGoPrev","_onClickGoNext","_onChangePagePerScreen","_onClickPagePerScreen","_onClickZoomIn","_onClickZoomOut","_onClickZoomReset","_onClickMarqueeZoom","_onClickHand","_onClickCountdown","_onClickTOC","_onClickNotes","_onClickBookmarks","_onClickToggleBookmark","_onClickAnnotationTools","_onClickWiki","_onClickFullscreen","_onClickLastVisitedPage","_onClickAttachFile","_onClickSolutionView"),this.pages=new a5.views.interaction.PPEbookPages(model,this,model.cover),this.toolbar=new a5.views.interaction.PPEbookToolbar(model,this);var panelType=_.str.capitalize(a5.dp.config.bookPanelsType);this.toc=new a5.view["PPEbookTOC"+panelType](model),this.toc.bind("open",function(){this.node.addClass("toc-opened"),this.$(".go-toc").addClass("active"),this.pages.scroller.addPanOffset(this.$(".sidebar-panel.opened").outerWidth()),this.pages.scroller.toggleHand()},this),this.toc.bind("close",function(){this.node.removeClass("toc-opened"),this.$(".go-toc").removeClass("active").focus(),this.pages.scroller.isZoomedIn()||this.pages.scroller.resetPanOffset(),this.pages.scroller.disableHand(),a5.eventBus.trigger("book:toc_closed")},this),this.resourcesPanel=new a5.view["PPEbookResourcesPanel"+panelType](model),this.resourcesPanel.bind("open",function(){this.node.addClass("resources-opened"),this.$(".resources").addClass("active"),this.pages.scroller.addPanOffset(this.$(".sidebar-panel.opened").outerWidth()),this.pages.scroller.toggleHand()},this),this.resourcesPanel.bind("close",function(){this.node.removeClass("resources-opened"),this.$(".resources").removeClass("active"),this.pages.scroller.isZoomedIn()||this.pages.scroller.resetPanOffset(),this.pages.scroller.disableHand()},this),this.notes=new a5.view["PPEbookNotes"+panelType](model),this.notes.bind("open",this.onNotesOpen,this),this.notes.bind("close",this.onNotesClose,this),this.bookmarks=new a5.view["PPEbookBookmarks"+panelType](model),this.bookmarks.bind("open",function(){this.node.addClass("bookmarks-opened"),this.$(".bookmarks").addClass("active"),this.pages.scroller.addPanOffset(this.$(".sidebar-panel.opened").outerWidth()),this.pages.scroller.toggleHand()},this),this.bookmarks.bind("close",function(){this.node.removeClass("bookmarks-opened"),this.$(".bookmarks").removeClass("active").focus(),this.pages.scroller.isZoomedIn()||this.pages.scroller.resetPanOffset(),this.pages.scroller.disableHand(),this._updateBookmarkedFlag()},this),this.bookmarks.bind("change",this._updateBookmarkedFlag,this),this.bookmarks.bind("added",this._onBookmarkAdd,this),this.bookmarks.bind("removed",this._onBookmarkRemove,this),this.wiki=new a5.views.WikiTool(model.parent),this.audioPlayer=this.toolbar.audioPlayer.player,model.effects&&this.node.addClass("spine-shadow"),this.pages.bind("opened",this._onPageOpened,this),this.pages.bind("opened-in-solution-view",this._onSolutionPageOpened,this),this.model.overlay.bind("set-swatch",this._updateAddOverlayFlag,this),this.model.overlay.bind("disable-overlay",this._updateRemoveOverlayFlag,this),this.countdownSetup=new a5.views.CountdownSetup(model,this,{onClose:this._onCloseCountdownSetup}),screenfull.enabled&&screenfull.onchange(this._onFullscreenChange),this.model.bind("page_change",this._onPageChange,this),this.model.bind("page_missing",this._onPageMissing,this)},isNotesPanelOpen:function(){return this.__notes_opened},onNotesOpen:function(){this._disableKeyEvents(),this.__notes_opened=!0,this.node.addClass("notes-opened"),this.$(".notes").addClass("active").attr("aria-expanded",!0),this.pages.scroller.addPanOffset(this.$(".sidebar-panel.opened").outerWidth()),this.pages.scroller.toggleHand()},onNotesClose:function(){this._enableKeyEvents(),this.__notes_opened=!0,this.node.removeClass("notes-opened"),this.$(".notes").removeClass("active").attr("aria-expanded",!1).focus(),this.pages.scroller.isZoomedIn()||this.pages.scroller.resetPanOffset(),this.pages.scroller.disableHand(),this._updateHasNoteFlag()},append:function(page){this.pages.append(page)},appendSolutionPage:function(page){this.pages.appendSolutionPage(page)},render:function(){this._super(),this.pages.render(),this.toolbar.render(),this.node.prepend(this.toc.$el),this.node.prepend(this.resourcesPanel.$el),this.node.prepend(this.notes.$el),this.node.prepend(this.bookmarks.$el),this.toc.render(),this.resourcesPanel.render(),this.notes.render(),this.bookmarks.render(),this._updatePagesPerScreenFlag(),this._updateHasNoteFlag(),this._updateBookmarkedFlag(),this._updateHasResourceFlag(),this.node.toggleClass("with-annotations",!!this.model.annotations);var solutionPageLock=this.$(".solution-page").attr("data-lock");return this.options.solutionViewLock=_.isEmpty(solutionPageLock)||"page"!==solutionPageLock,this.bindNodeP("click",".go-page",this._onClickGoPage),this.bindNodeD("submit",".go-page",this._onSubmitGoPage),this.bindNodeDP("click",".current-page",this._onClickCurrentPage),this.bindNode("click",this._onClick),this.bindNodeD("click",".go-first",this._onClickGoFirst),this.bindNodeD("click",".go-last",this._onClickGoLast),this.bindNodeD("click",".go-previous:not(.disabled)",this._onClickGoPrev),this.bindNodeD("click",".go-next:not(.disabled)",this._onClickGoNext),this.bindNode("change",".per-screen-switch input",this._onChangePagePerScreen),this.bindNodeD("click",".per-screen-switch span.check",this._onClickPagePerScreen),this.bindNodeD("click",".zoom-in:not(.disabled)",this._onClickZoomIn),this.bindNodeD("click",".zoom-out:not(.disabled)",this._onClickZoomOut),this.bindNodeD("click",".fullscreen",this._onClickZoomReset),this.bindNodeD("click",".marquee-zoom:not(.disabled)",this._onClickMarqueeZoom),this.bindNodeD("click",".hand:not(.disabled)",this._onClickHand),this.bindNodeD("click",".countdown:not(.disabled)",this._onClickCountdown),this.bindNodeD("click",".go-toc",this._onClickTOC),this.bindNodeD("click",".notes",this._onClickNotes),this.bindNodeD("click",".bookmarks",this._onClickBookmarks),this.bindNodeD("click",".bookmark-page",this._onClickToggleBookmark),this.bindNodeD("click",".tools",this._onClickAnnotationTools),this.bindNodeD("click",".wiki",this._onClickWiki),this.bindNodeD("click",".full-screen",this._onClickFullscreen),this.bindNodeD("click",".go-last-visited",this._onClickLastVisitedPage),this.bindNodeD("click",".attach-file",this._onClickAttachFile),this.bindNodeD("click",".solution-page",this._onClickSolutionView),this.bindNodeD("click",".hotspots",this._onClickToggleHotspots),this.bindNodeD("click",".print",this._onClickPrint),this.bindNode("change",".zoomStatus__slider",this._onSliderChange),this._enableKeyEvents(),this._enableAlert(),this.trigger("render"),this.model.canPrint()?this.$(".print").show():this.$(".print").hide(),this.node},deselectTools:function(){this.pages.scroller.disableAttachFile(),this.pages.scroller.disableMarqueeZoom()},toggleCountdown:function(active){active?(this._disableKeyEvents(),this.countdownSetup.render().appendTo(a5.dp.config.appendCountdownTo||this.node),this.countdownSetupMode=!0):this.countdownSetup.close()},toggleBookmark:function(active){_.each(this.model.current,function(page){active?(page.model.bookmark(),a5.eventBus.trigger("book:bookmark_added",page.model.serialize())):(page.model.unbookmark(),a5.eventBus.trigger("book:bookmark_deleted",page.model.serialize()))}),this._updateBookmarkedFlag()},sendBack:function(){this.pages.sendBack()},bringFront:function(){this.pages.bringFront()},openResourcesPanel:function(ev){this.closeToc(),this.closeNotes(),this.closeBookmarks(),this.resourcesPanel.toggle()},closeResourcesPanel:function(){this.resourcesPanel.close()},openToc:function(ev){this.closeNotes(),this.closeBookmarks(),this.closeResourcesPanel(),this.toc.toggle()},closeToc:function(){this.toc.close()},openNotes:function(ev){this.closeToc(),this.closeBookmarks(),this.closeResourcesPanel(),this.notes.toggle()},closeNotes:function(){this.notes.close()},openBookmarks:function(ev){this.closeToc(),this.closeNotes(),this.closeResourcesPanel(),this.bookmarks.toggle()},closeBookmarks:function(){this.bookmarks.close()},openAnnotationTools:function(ev){this.model.annotations&&(this.model.annotations.toolbox.view.bind("show",function(){this.$(".tools").addClass("active")},this,{once:!0}),this.model.annotations.toolbox.view.bind("hide",function(){this.$(".tools").removeClass("active")},this,{once:!0}),this.model.annotations.toolbox.view.toggle())},openWiki:function(){this.wiki.show()},toggleFullscreen:function(fullscreen){(_.isUndefined(fullscreen)||fullscreen!=this.isFullscreen)&&(a5.dp.config.bookExternalFullscreen?this._onFullscreenChange():screenfull.enabled&&(this.isFullscreen?screenfull.exit():screenfull.request(document.body)))},toggleSolutionView:function(active){this._isSolutionView=_.isUndefined(active)?!this._isSolutionView:active,this.node.toggleClass("solution-view",this._isSolutionView)},isSolutionView:function(){return!!this._isSolutionView},addFileHotspot:function(page,options){var hotspot=new a5.views.interaction.PPEbookHotspotFile(this.model,this,options);this.model.addFileHotspot(page,hotspot)},_disableKeyEvents:function(){$(document).off("keydown",this._onKeydown),$(document).off("keyup",this._onKeyup)},_enableKeyEvents:function(){this._disableKeyEvents(),$(document).on("keydown",this._onKeydown),$(document).on("keyup",this._onKeyup)},_enableAlert:function(){this.pages.scroller.bind("zoom_changed",this._onZoomChanged,this);var $alert=$("#alert");$alert.length&&(this.$alert=$alert)},_updateCurrentTocEntry:function(){var $node=$(".current-toc-entry");if($node.length){var entries=this.toc.toc.getEntriesByRange(this.model.current.from,this.model.current.to-1);entries.length?$node.text(entries[0].text):$node.text("")}},_updateAnnotationsToolboxPosition:function(){this.model.annotations&&this.model.annotations.toolbox.view.update()},_keyboardGoPrev:function(){this.$(".toolbar .go-previous:first").addClass("active"),this.model.previousPage()},_keyboardGoNext:function(){this.$(".toolbar .go-next:last").addClass("active"),this.model.nextPage()},_onCloseCountdownSetup:function(){this.$(".countdown").removeClass("active"),this._enableKeyEvents(),this.countdownSetupMode=!1},_onFullscreenChange:function(){this.isFullscreen=!this.isFullscreen,$(document.body).toggleClass("fullscreen",this.isFullscreen),this.$(".full-screen").toggleClass("active",this.isFullscreen),a5.eventBus.trigger("book:fullscreen",this.isFullscreen)},_onKeydown:function(ev){if(!$(ev.target).closest(".per-screen-switch").length){var key=ev.which;key===a5.utils.keyCodes.PAGE_UP?(this._keyboardGoPrev(),ev.preventDefault()):key===a5.utils.keyCodes.PAGE_DOWN?(this._keyboardGoNext(),ev.preventDefault()):key===a5.utils.keyCodes.DOWN?(this.pages.scroller.panDown(),ev.preventDefault()):key===a5.utils.keyCodes.UP?(this.pages.scroller.panUp(),ev.preventDefault()):key===a5.utils.keyCodes.LEFT?(this.pages.scroller.panLeft()||this._keyboardGoPrev(),ev.preventDefault()):key===a5.utils.keyCodes.RIGHT?(this.pages.scroller.panRight()||this._keyboardGoNext(),ev.preventDefault()):key===a5.utils.keyCodes.HOME?this.model.openPage(0):key===a5.utils.keyCodes.END?this.model.openPage(this.model.pageCount-1):key>=96&&key<=105||key>=48&&key<=57?(this.$(".current-page").is(":focus")||this.$(".current-page").focus(),this.$(".current-page").trigger("keypress",{which:key}),this._disableKeyEvents()):"+"===ev.key?this.pages.scroller.zoomIn():"-"===ev.key&&this.pages.scroller.zoomOut()}},_onKeyup:function(ev){this.$(".toolbar .go-previous:first").removeClass("active"),this.$(".toolbar .go-next:last").removeClass("active")},_onPageChange:function(){this._updateAnnotationsToolboxPosition(),this._updateCurrentTocEntry(),this._closeAlerts()},_onPageOpened:function(current,options){var hasRestrictedPage=!1,hasSolutionPage=!1;this.$(".per-screen-switch [value="+this.model.pagesPerScreen+"]").attr("checked",!0),this.$(".per-screen-switch .check").removeClass("checked"),this.$(".per-screen-switch [data-value="+this.model.pagesPerScreen+"]").addClass("checked"),this.$(".go-next").removeClass("disabled"),this.$(".go-previous").removeClass("disabled"),this.$(".current-page").attr("disabled",!1),this.audioPlayer.clear(),_.each(current,function(page){page.model.audio&&this.audioPlayer.enque(page.model.audio),page.model.restricted&&(hasRestrictedPage=!0),page.model.solutionPage&&(hasSolutionPage=!0)},this),hasRestrictedPage&&a5.eventBus.trigger("book:show_restricted_page",this.model),this._updateSolutionViewFlag(hasSolutionPage),this._updatePagesPerScreenFlag(),this._updateHasNoteFlag(),this._updateBookmarkedFlag(),this._updateHasResourceFlag(),this._updateHasHotspotFlag(),this._announcePage(this.model.pageIndexToPrintedPage(current.from),current.length>1)},_onPageMissing:function(){this.$alert&&(this.$alert.empty(),this.$alert.html(a5.service.templates.render(this.missingPageTemplate)))},_onSolutionPageOpened:function(current,options){this._onPageOpened(current,options)},_onZoomChanged:function(current,old){this.$alert&&current!==old&&(this.$alert.empty(),current>old?this.$alert.html(a5.service.templates.render(this.zoomedInTemplate)):old>current&&this.$alert.html(a5.service.templates.render(this.zoomedOutTemplate)))},_onClickGoPage:function(){},_onSubmitGoPage:function(){var $currentPage=this.$(".current-page"),page=parseInt($currentPage.val(),10);this.model.isValidPage(page)||this._showInvalidPageAlert(page),this.model.openPageNumber(page),$currentPage.val("").blur(),this._enableKeyEvents()},_onClickCurrentPage:function(){this._disableKeyEvents()},_onClick:function(){this.$(".current-page").val("").blur(),this.countdownSetupMode||this.isNotesPanelOpen()||this._enableKeyEvents()},_onClickGoFirst:function(){this.model.openPage(0)},_onClickGoLast:function(){this.model.openPage(this.model.pageCount-1)},_onClickGoPrev:function(){this.model.previousPage()},_onClickGoNext:function(){this.model.nextPage()},_onChangePagePerScreen:function(ev){var pagesPerScreen=parseInt($(ev.target).val(),10);this.model.setPagesPerScreen(pagesPerScreen),a5.eventBus.trigger("book:pages_per_screen_changed",pagesPerScreen)},_onClickPagePerScreen:function(ev){var pagesPerScreen=parseInt($(ev.target).data("value"),10);this.model.setPagesPerScreen(pagesPerScreen),a5.eventBus.trigger("book:pages_per_screen_changed",pagesPerScreen)},_onClickZoomIn:function(){this.pages.scroller.zoomIn()},_onClickZoomOut:function(){this.pages.scroller.zoomOut()},_onClickZoomReset:function(){this.pages.scroller.resetZoom()},_onClickMarqueeZoom:function(){this.pages.scroller.toggleMarqueeZoom()},_onClickHand:function(){this.pages.scroller.toggleHand()},_onClickCountdown:function(ev){$(ev.target).toggleClass("active"),this.toggleCountdown($(ev.target).is(".active"))},_onClickFullscreen:function(){this.toggleFullscreen()},_onClickTOC:function(){this.openToc()},_onClickNotes:function(){this.openNotes()},_onClickBookmarks:function(){this.openBookmarks()},_onClickToggleBookmark:function(ev){$(ev.target).toggleClass("active"),this.toggleBookmark($(ev.target).is(".active"))},_onClickAnnotationTools:function(){this.openAnnotationTools()},_onClickWiki:function(){this.openWiki()},_onClickLastVisitedPage:function(){a5.eventBus.trigger("book:click_last_visited")},_onClickAttachFile:function(){this.pages.scroller.toggleAttachFile()},_onClickSolutionView:function(ev){this.toggleSolutionView(),this.isSolutionView()?this.pages.renderSolutionPage({afterSolutionOpened:!0}):this.model.openPage(this.model.page,{afterSolutionClosed:!0})},_onClickToggleHotspots:function(ev){$(ev.target).toggleClass("active"),this.node.toggleClass("hotspots-off")},_onSliderChange:function(evt){this.pages.scroller.onSlide(evt)},_onBookmarkAdd:function(){this.$alert&&(this.$alert.empty(),this.$alert.html(a5.service.templates.render(this.bookmarkAddTemplate)))},_onBookmarkRemove:function(){this.$alert&&(this.$alert.empty(),this.$alert.html(a5.service.templates.render(this.bookmarkRemoveTemplate)))},_onClickPrint:function(){this.pages.printDialog()},_updateHasNoteFlag:function(){this.node.toggleClass("has-note",this._hasNotes())},_updateBookmarkedFlag:function(){var bookmarked=this._isBookmarked();this.node.toggleClass("bookmarked",bookmarked),this.$(".bookmark-page").toggleClass("active",bookmarked)},_updateHasResourceFlag:function(){this.node.removeClass("has-resource"),this._hasResources().done(function(hasResource){this.node.toggleClass("has-resource",hasResource)}.bind(this))},_updateHasHotspotFlag:function(){var hasHotspot=_.some(this.model.current,function(page){return page.model.hasHotspots()});this.node.toggleClass("has-hotspot",hasHotspot)},_updatePagesPerScreenFlag:function(){this.node.removeClass("double-page single-page"),this.node.addClass(2===this.pages.current.length?"double-page":"single-page")},_updateAddOverlayFlag:function(){this.node.addClass("has-overlay")},_updateRemoveOverlayFlag:function(){this.node.removeClass("has-overlay")},_updateSolutionViewFlag:function(hasSolutionPage){this.node.toggleClass("has-solution-page",hasSolutionPage),this.$(".solution-page").toggleClass("active",this.isSolutionView())},_announcePage:function(page,double){this.$alert&&$.when(this._hasResources(),this._hasNotes(),this._isBookmarked()).done(function(hasResources,hasNotes,isBookmarked){var data={page:page,double:double,preliminary:page<=0,hasResources:hasResources,hasNotes:hasNotes,isBookmarked:isBookmarked};double&&(data.other=page+1),this.$alert.empty(),this.$alert.html(a5.service.templates.render(this.announcePageTemplate,data))}.bind(this))},_hasNotes:function(){return _.some(this.model.current,function(page){return page.model.hasNotes()})},_isBookmarked:function(){return _.some(this.model.current,function(page){return page.model.bookmarked})},_hasResources:function(){var from=this.model.current.from,to=this.model.current.to,promises=_.map(this.model.current,function(page){return page.model.hasResources()}),deferred=$.Deferred();return $.when.apply($,promises).done(function(){if(from===this.model.current.from&&to===this.model.current.to){var hasResources=_.some(arguments);deferred.resolve(hasResources)}else deferred.resolve(!1)}.bind(this)).fail(function(){deferred.resolve(!1)}),deferred.promise()},_isEmpty:function(text){return _.isString(text)&&0==$(text).text().trim().length},_closeAlerts:function(){this.invalidPageAlert&&this.invalidPageAlert.close()},_showInvalidPageAlert:function(page){this.invalidPageAlert&&this.invalidPageAlert.close(),this.invalidPageAlert=new a5.view.Alert({template:"a5.view.alert.InvalidPage",data:{current:page,last:this.model.pageIndexToPrintedPage(this.model.pageCount-1)},$root:this.$(".go-page"),alertClass:"invalid-page-alert"}),this.invalidPageAlert.show()}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPEbook"),a5.views.interaction.PPEbookToolbar={template:"ebook_toolbar",init:function(model,parent){this._super(model,parent),a5.dp.config.bookShowCurrentPagePlaceholder&&this.model.bind("page_change",this._onPageChange,this)},render:function(){return this._super(),this.overlayPicker=new a5.views.interaction.PPEbookOverlayPicker(this.model.overlay,this,this.node),this.node.appendTo(this.parent.node),this.showResourcesPanelButton(),this.parent.pages.scroller.bind("zoom_changed",this.toggleZoomButtons,this),this.parent.pages.scroller.bind("size_updated",this.setZoomSlider,this),this.$(".btn, .single-page, .dual-page, .current-page").delayedTooltip({delay:a5.dp.config.bookTooltipDelay,duration:a5.dp.config.bookTooltipDuration,cancel:"#annotations-toolbox"}),this.trigger("render"),this.node},hasAnnotationsButton:function(){var html=a5.mainBuilder.layout.getTemplate(this.template);return $(html).find(".tools").length>0},getCurrentPagePlaceholderText:function(){
for(var text=[],n=this.model.getCurrentPageNumber(),p=n;p<n+this.model.current.length;p++)text.push(p);return 2===text.length&&text[0]>=0?text.join(" - "):1===text.length?text[0]<=0?"":text[0]:""},toggleZoomButtons:function(){_.defer(_.bind(function(){var scroller=this.parent.pages.scroller;this.$(".fullscreen").toggleClass("disabled",scroller.isInitialZoom()).attr("disabled",scroller.isInitialZoom()),this.$(".zoom-in").toggleClass("disabled",scroller.isLastZoomIn()).attr("disabled",scroller.isLastZoomIn()),this.$(".zoom-out").toggleClass("disabled",scroller.isLastZoomOut()).attr("disabled",scroller.isLastZoomOut()),this.$(".marquee-zoom").toggleClass("disabled",scroller.isLastZoomIn()).attr("disabled",scroller.isLastZoomIn()),this.updateZoomSliderValue(scroller.zoom)},this))},showResourcesPanelButton:function(){var self=this;$.when(a5.service.lms.API.isEbookShowResourcesEnabled()).done(function(isEnabled){isEnabled?self.bindNode("click",".resources",function(ev){self.parent.openResourcesPanel(ev)}):self.$(".resources").addClass("disabled").attr("disabled",!0)}).fail(function(){self.$(".resources").addClass("disabled").attr("disabled",!0)})},setZoomSlider:function(){var slider=this.$(".zoomStatus__slider");if(slider.length>0){var scroller=this.parent.pages.scroller,value=scroller.zoom?Math.round(100*scroller.zoom):0;slider.attr("min",Math.round(100*scroller.minZoom)),slider.attr("max",Math.round(100*scroller.maxZoom)),slider.val(value)}},updateZoomSliderValue:function(value){this.$(".zoomStatus__slider").val(Math.round(100*value))},_onPageChange:function(){this.$(".current-page").attr("placeholder",this.getCurrentPagePlaceholderText())}},a5.views.interaction.BookToolbar.extend("a5.views.interaction.PPEbookToolbar"),a5.views.interaction.PPEbookOverlay={init:function(model,parent,pagesNode){this._super(model,parent,pagesNode.find(".overlay")),_.bindAll(this,"setSwatch","disableOverlay"),model.bind("set-swatch",this.setSwatch),model.bind("disable-overlay",this.disableOverlay),_.isUndefined(getComputedStyle(document.body).mixBlendMode)&&this.node.attr("data-no-blend","true")},updatePosition:function($pages,scroller){var rect=$pages[0].getBoundingClientRect();this.node.css({width:rect.width,height:rect.height,marginTop:scroller.roundedTop(),left:"50%",marginLeft:scroller.roundedLeft()-rect.width/2})},setSwatch:function(swatch){this.node.attr("class","overlay "+swatch)},disableOverlay:function(){this.node.attr("class","overlay")}},a5.views.interaction.BaseView.extend("a5.views.interaction.PPEbookOverlay"),a5.views.interaction.PPEbookOverlayPicker={init:function(model,parent,toolbarNode){this._super(model,parent,toolbarNode.find(".overlay")),_.bindAll(this,"_onClick","_onClickSwatch","_onKeydown","_setSwatch","_update"),model.bind("update",this._update),this.node.on("click",this._onClick),this.node.parent().find(".swatch").on("click",this._onClickSwatch),this.node.parent().find(".swatches").on("keydown",this._onKeydown)},toggle:function(){this.node.toggleClass("active"),this.node.parent().find(".popup").toggleClass("hidden"),this.node.hasClass("active")?this._focusActive():this.node.focus()},_onClick:function(ev){ev.target===this.node[0]&&this.toggle()},_onClickSwatch:function(ev){this._selectSwatchNode($(ev.target)),this.toggle()},_onKeydown:function(e){var key=e.which,$item=$(e.target);key===a5.utils.keyCodes.SPACE||key===a5.utils.keyCodes.ENTER?(this._selectSwatchNode($item.is(".swatch")?$item:$item.find(".swatch")),this.toggle()):key===a5.utils.keyCodes.DOWN||key===a5.utils.keyCodes.RIGHT?this._focusNext($item):key===a5.utils.keyCodes.UP||key===a5.utils.keyCodes.LEFT?this._focusPrev($item):key!==a5.utils.keyCodes.TAB&&key!==a5.utils.keyCodes.ESCAPE||this.toggle(),e.stopPropagation(),e.preventDefault()},_selectSwatchNode:function($swatch){var swatch=_.filter($swatch.attr("class").split(/\s+/),function(s){return!_.contains(["swatch","active"],s)}).join(" ");this._setSwatch(swatch)},_focusActive:function(){this.node.parent().find(".popup .swatch.active").closest(":focusable").focus()},_focusNext:function($item){var $next=$item.next();$next.length||($next=$item.siblings().first()),$next.focus()},_focusPrev:function($item){var $prev=$item.prev();$prev.length||($prev=$item.siblings().last()),$prev.focus()},_setSwatch:function(swatch){this.model.setSwatch(swatch),this._update(swatch)},_update:function(swatch){var selector="."+swatch.split(/\s+/).join("."),$target=this.node.parent().find(selector),$item=$target.closest("[role=menuitemradio]"),$items=this.node.parent().find("[role=menuitemradio]");$target.closest(".swatches").find(".swatch").removeClass("active"),$items.attr("aria-checked",!1),$target.addClass("active"),$item.attr("aria-checked",!0)}},a5.views.interaction.BaseView.extend("a5.views.interaction.PPEbookOverlayPicker"),a5.view.PPEbookDialog={init:function(){this._super({backdrop:a5.dp.config.bookDialogModal}),this.bind("render",this.onRender,this),this.bind("open",this.onOpen,this)},onRender:function(){a5.hooks.ppebookDialogRendered.call(this)},onOpen:function(){a5.hooks.ppebookDialogShowed.call(this)}},a5.view.BSModal.extend("a5.view.PPEbookDialog"),a5.view.PPEbookSidebar={init:function(){this._super(),this.bind("render",this.onRender,this),this.bind("open",this.onOpen,this)},onRender:function(){a5.hooks.ppebookSidebarRendered.call(this)},onOpen:function(){a5.hooks.ppebookSidebarShowed.call(this)}},a5.view.Sidebar.extend("a5.view.PPEbookSidebar"),a5.view.PPEbookClearAnnotationsDialog={template:"ebook_clear_annotations_dialog",init:function(){this._super(),this.$el.addClass("clear-annotations-popup"),_.bindAll(this,"_onClickClear"),this.$el.on("click",".clear-annotations",this._onClickClear)},_onClickClear:function(){this.trigger("submit")}},a5.view.PPEbookDialog.extend("a5.view.PPEbookClearAnnotationsDialog"),a5.view.PPEbookClearAllAnnotationsDialog={template:"ebook_clear_all_annotations_dialog"},a5.view.PPEbookClearAnnotationsDialog.extend("a5.view.PPEbookClearAllAnnotationsDialog"),a5.view.PPEbookBookmarksDialog={template:"ebook_bookmarks",init:function(model){this._super(),this.bookmarks=new a5.views.interaction.PPEbookBookmarks(model),this.model=model,this.$el.addClass("bookmarks-popup"),_.bindAll(this,"_onClickAdd","_onClickRemove"),this.$el.on("click",".add-bookmark",this._onClickAdd),this.$el.on("click",".remove-bookmark",this._onClickRemove),this.bookmarks.bind("bookmark:open",this._onBookmarkOpen,this),this.bookmarks.bind("bookmark:added",this._onBookmarkAdded,this),this.bookmarks.bind("bookmark:updated",this._onBookmarkUpdated,this),this.bookmarks.bind("bookmark:deleted",this._onBookmarkDeleted,this)},renderContent:function(){this.$el.find(".modal-body").html(this.bookmarks.$el),this.bookmarks.render()},onShow:function(){this.bookmarks.updateBookmarks(),this.bookmarks.refresh(),this._super()},_onClickAdd:function(){this.bookmarks.bookmark()},_onClickRemove:function(){this.bookmarks.unbookmark(),this.$el.find(".add-bookmark").focus()},_onBookmarkOpen:function(){this.close()},_onBookmarkAdded:function(){this.trigger("change"),this.trigger("added")},_onBookmarkUpdated:function(){this.trigger("change")},_onBookmarkDeleted:function(){this.trigger("change"),this.trigger("removed")}},a5.view.PPEbookDialog.extend("a5.view.PPEbookBookmarksDialog"),a5.view.PPEbookBookmarksSidebar={template:"ebook_bookmarks",init:function(model){this._super(),this.bookmarks=new a5.views.interaction.PPEbookBookmarks(model),this.model=model,this.$el.addClass("bookmarks-popup"),_.bindAll(this,"_onClickAdd","_onClickRemove"),this.$el.on("click",".add-bookmark",this._onClickAdd),this.$el.on("click",".remove-bookmark",this._onClickRemove),this.bookmarks.bind("bookmark:open",this._onBookmarkOpen,this),this.bookmarks.bind("bookmark:added",this._onBookmarkAdded,this),this.bookmarks.bind("bookmark:updated",this._onBookmarkUpdated,this),this.bookmarks.bind("bookmark:deleted",this._onBookmarkDeleted,this)},renderContent:function(){this.$el.find(".modal-body").html(this.bookmarks.$el),this.bookmarks.render()},_onClickAdd:function(){this.bookmarks.bookmark()},_onClickRemove:function(){this.bookmarks.unbookmark(),this.$el.find(".add-bookmark").focus()},_onBookmarkOpen:function(){this.close()},_onBookmarkAdded:function(){this.trigger("change"),this.trigger("added")},_onBookmarkUpdated:function(){this.trigger("change")},_onBookmarkDeleted:function(){this.trigger("change"),this.trigger("removed")},open:function(){this.bookmarks.updateBookmarks(),this.bookmarks.refresh(),this.model.openSidebar="bookmarks",this._super(),this.$el.find(":focusable:first").focus()},close:function(){delete this.model.openSidebar,this._super()}},a5.view.PPEbookSidebar.extend("a5.view.PPEbookBookmarksSidebar"),a5.views.interaction.PPEbookBookmarks={template:"ebook_bookmarks",init:function(model){this.model=model,this.$el=$("<div>",{class:"ebook-bookmarks"}),this.bookmarks=[],this.model.bind("restore",this._onBookRestore,this)},render:function(){this._detachBookmarks();var html=a5.mainBuilder.layout.getTemplate(_.result(this,"template")),$root=$("<div></div>");return $root.html(html),html=$root.find(".modal-body").html(),this.$el.html(html),this._renderBookmarks("ul"),this.trigger("render"),this.$el},refresh:function(){this.render()},bookmark:function(){var pages=a5.dp.config.bookBookmarkMultiple?this.model.current:[_.first(this.model.current)];_.each(pages,function(page){if(!page.model.bookmarked){var bookmark=new a5.views.interaction.PPEbookBookmark(page.model,this);this._addBookmark(bookmark)}},this)},unbookmark:function(){_.each(this.model.current,function(page){var bookmark=this._getBookmarkByPage(page.model);bookmark&&bookmark.remove()},this)},updateBookmarks:function(){this.bookmarks=[],_.each(this.model.pages,function(page){if(page.bookmarked){var bookmark=new a5.views.interaction.PPEbookBookmark(page,this);this._addBookmark(bookmark,!0)}},this)},_onBookmarkOpen:function(bookmark){this.model.openPageNumber(bookmark.page.number),this.trigger("bookmark:open")},_onBookmarkAdded:function(bookmark){this.refresh(),bookmark.focusInput(),this.trigger("bookmark:added"),a5.eventBus.trigger("book:bookmark_added",bookmark.page.serialize())},_onBookmarkUpdated:function(bookmark){a5.mainBuilder.curInteraction.store(),this.trigger("bookmark:updated"),a5.eventBus.trigger("book:bookmark_updated",bookmark.page.serialize())},_onBookmarkDeleted:function(bookmark){this._removeBookmark(bookmark),this.refresh(),a5.mainBuilder.curInteraction.store(),this.trigger("bookmark:deleted"),a5.eventBus.trigger("book:bookmark_deleted",bookmark.page.serialize())},_onBookRestore:function(){this.updateBookmarks(),this.refresh()},_renderBookmarks:function($appendTo){var $target=$appendTo||this.$el;_.isString($target)&&($target=this.$el.find($target));var fragment=document.createDocumentFragment();_.each(this.bookmarks,function(child){fragment.appendChild(child.$el[0]),child.render()}),$target.append(fragment)},_detachBookmarks:function(){_.each(this.bookmarks,function(child){child.$el.detach()})},_getBookmarkByPage:function(page){return _.find(this.bookmarks,function(bookmark){return bookmark.page===page})},_removeBookmark:function(bookmark){this.bookmarks=_.without(this.bookmarks,bookmark)},_addBookmark:function(bookmark,silent){this.bookmarks.push(bookmark),this.bookmarks=_.sortBy(this.bookmarks,function(bookmark){return bookmark.page.index}),bookmark.bind("open",this._onBookmarkOpen,this),bookmark.bind("change",this._onBookmarkUpdated,this),bookmark.bind("remove",this._onBookmarkDeleted,this),bookmark.page.bookmark(bookmark.page.bookmarkText),silent||this._onBookmarkAdded(bookmark)}},Obj.extend("a5.views.interaction.PPEbookBookmarks"),a5.views.interaction.PPEbookBookmark={read_template:"ebook_bookmarks_read",write_template:"ebook_bookmarks_write",default_read_template:'<div class="clearfix">    <strong>        <span class="page-label">            <button class="gui-fancy remove" title="Remove bookmark"></button>            <button class="gui-fancy edit" title="Edit bookmark"></button>            <span class="title<%= page.bookmarkText ? "" : " untitled" %>"><%= page.bookmarkText || "untitled" %></span>        </span>    </strong>    <span class="page-number"><%= page.number || "" %></span></div>',default_write_template:'<div class="clearfix">    <form><strong>        <span class="page-label">            <button class="gui-fancy remove" title="Remove bookmark"></button>            <button class="gui-fancy edit" title="Edit bookmark"></button>            <span class="title"><input type="text" value="<%= page.bookmarkText %>" maxlength="64" placeholder="Bookmark title" title="Type in a custom bookmark title" /></span>        </span>    </strong></form>    <span class="page-number"><%= page.number || "" %></span></div>',init:function(page,parent){this.page=page,this.$el=$("<li>",{class:"bookmarks-entry"}),this.editing=_.isNull(this.page.bookmarkText),_.bindAll(this,"_onFormSubmit","_onFormBlur","_onClickEdit","_onClickRemove","_onActivate","_onInputKeydown"),this.$el.on("submit","form",this._onFormSubmit),this.$el.on("blur","form",this._onFormBlur),this.$el.on("keydown","input",this._onInputKeydown),this.$el.on("click",".edit",this._onClickEdit),this.$el.on("click",".remove",this._onClickRemove),this.$el.on("click","[data-event=activate]",this._onActivate),this.$el.on("click",".title",this._onActivate),this.$el.on("click",".page-number",this._onActivate)},render:function(){return this.editing?this._renderWrite():this._renderRead(),this.$el.toggleClass("editing",this.editing),this.trigger("render"),this.$el},refresh:function(){this.render()},_onFormSubmit:function(e){e.preventDefault(),this.updateText()},_onFormBlur:function(e){e.preventDefault(),this.updateText()},_onInputKeydown:function(e){e.stopPropagation(),27===e.which&&this.escapeBlur()},_onClickEdit:function(e){e.stopPropagation(),this.editing||this.edit()},_onClickRemove:function(e){e.stopPropagation(),this.editing||this.remove()},_onActivate:function(e){e.stopPropagation(),this.editing||this.openPage()},_renderRead:function(){var html=a5.mainBuilder.layout.getTemplate(_.result(this,"read_template"));if(""===html){html=_.template(this.default_read_template)({page:this.page})}else{var $html=$(html),$title=$html.find(".page-label .title");$title.toggleClass("untitled",!this.page.bookmarkText),this.page.bookmarkText&&$title.html(this.page.bookmarkText);var $pageNum=$html.find(".page-number");this.page.number&&$pageNum.html(this.page.number),html=$html.get(0)}this.$el.empty().append(html)},_renderWrite:function(){var html=a5.mainBuilder.layout.getTemplate(_.result(this,"write_template"));if(""===html){html=_.template(this.default_write_template)({page:this.page})}else{var $html=$(html),$title=$html.find(".page-label .title input[type=text]");$title.toggleClass("untitled",!this.page.bookmarkText),this.page.bookmarkText&&$title.val(this.page.bookmarkText);var $pageNum=$html.find(".page-number");this.page.number&&$pageNum.html(this.page.number),html=$html.get(0)}this.$el.empty().append(html)},updateText:function(){this.editing&&(this.editing=!1,this.page.bookmark(this.$el.find("input").val()),this.refresh(),this.trigger("change",this))},escapeBlur:function(){this.editing&&this.$el.find("input").val(this.page.bookmarkText).blur()},focusInput:function(){this.$el.find("input").focus()},openPage:function(){this.trigger("open",this)},edit:function(){this.editing=!0,this.refresh(),this.focusInput()},remove:function(){this.page.unbookmark(),this.trigger("remove",this)}},Obj.extend("a5.views.interaction.PPEbookBookmark"),a5.views.interaction.PPEbookBookmark.version=5,a5.view.PPEbookNotesDialog={template:"ebook_notes",init:function(book){this._super(),this.notes=a5.dp.config.bookNotesAsTabPanel?new a5.view.PPEbookNotebook(book):new a5.views.interaction.PPEbookNotes(book),this.book=book,this.$el.addClass("notes-popup"),this.notes.bind("page-number:click",this._onClickPageNumber,this)},renderContent:function(){var $notes=this.notes.render();this.$el.find(".modal-body").html($notes)},onShown:function(){this.notes.setup(),this.notes.focus(),this._super()},onHidden:function(){this.notes.checkChanges(),this._super()},onShow:function(){this.notes.teardown(),this.notes.goTo(this.book.page,!0),this.notes.updateNotes(),this._super()},onHide:function(){this.notes.teardown(),this._super()},_onClickPageNumber:function(){this.close()}},a5.view.PPEbookDialog.extend("a5.view.PPEbookNotesDialog"),a5.view.PPEbookNotesSidebar={template:"ebook_notes",init:function(book){this._super(),this.notes=a5.dp.config.bookNotesAsTabPanel?new a5.view.PPEbookNotebook(book):new a5.views.interaction.PPEbookNotes(book),this.book=book,this.$el.addClass("notes-popup"),this.notes.bind("page-number:click",this._onClickPageNumber,this)},renderContent:function(){var $notes=this.notes.render();this.$el.find(".modal-body").html($notes)},open:function(){this.notes.teardown(),this.notes.goTo(this.book.page,!0),this.notes.updateNotes(),this.notes.setup(),this.book.openSidebar="notes",_.defer(function(){this.notes.focus()}.bind(this)),this._super()},close:function(){this.notes.teardown(),this.notes.checkChanges(),delete this.book.openSidebar,this._super()},_onClickPageNumber:function(){this.close()}},a5.view.PPEbookSidebar.extend("a5.view.PPEbookNotesSidebar"),a5.view.PPEbookNotebook={init:function(model,options){this.book=model,this._super(model,{offset:this.book.offset,editorSettings:_.result(a5.dp.config,"bookNotesEditor")}),this.bind("page-number:click",this._onClickPageNumber,this)},getPages:function(){return this.pages||(this.pages=this.book.pages),this.pages},getTotalPages:function(){return this.book.pageCount},getPagesPerScreen:function(){return this.book.getPagesPerScreen()},getTitle:function(){return this.book.title},getCurrentPageText:function(){for(var text=[],n=this.book.getCurrentPageNumber(),p=n;p<n+this.book.current.length;p++)text.push(p);return 2===text.length&&text[0]>=0?text.join(" - "):1===text.length?text[0]<=0?"":text[0]:""},getCurrent:function(pageIndex){var pagesPerScreen=this.getPagesPerScreen(),offset=this.book.cover?pagesPerScreen-1:0,pageFrom=Math.floor((pageIndex+offset)/pagesPerScreen)*pagesPerScreen-offset;return pageFrom=Math.min(Math.max(pageFrom,0),this.getTotalPages()-1)},save:function(){this._super(),this.book.save()},_onClickPageNumber:function(pageNumber){this.book.openPageNumber(pageNumber)}},a5.view.Notebook.extend("a5.view.PPEbookNotebook"),a5.views.interaction.PPEbookNotes={template:"ebook_notes",exportTemplate:"a5.view.NotebookExport",defaultExportTemplate:"<h1>Notes</h1>{{#each pages as |page|}}<h2>Page {{page.number}}</h2><p>{{{page.note}}}</p>{{/each}}",init:function(model){this.book=model,this.vent=new Obj,this.notes=[],this.$el=$("<div>",{class:"ebook-notes"}),_.bindAll(this,"_onClickSave","_onClickPrev","_onClickNext","_onBeforeFlip","_onEndFlip","_onWindowResize"),this.$el.on("click",".save",this._onClickSave),this.$el.on("click",".prev",this._onClickPrev),this.$el.on("click",".next",this._onClickNext),$(window).resize(_.throttle(this._onWindowResize,500)),this.vent.bind("page-number:click",this._onClickPageNumber,this),this.vent.bind("notebook-page:change",this._onNotebookPageChange,this),this.vent.bind("note:change",this._onNoteChange,this),this.vent.bind("note:reset",this._onNoteReset,this)},render:function(){var html=a5.mainBuilder.layout.getTemplate(_(this).result("template")),$root=$("<div></div>");return $root.html(html),html=$root.find(".ebook-notes").html(),this.$el.html(html),this.exportFormatSelect=new a5.view.ExportFormatSelect({$button:this.$el.find(".export")}),this.exportFormatSelect.bind("submit",this._onExport,this),this.$bookblock=this.$el.find(".bb-bookblock"),this.$notes=this.$bookblock.children(".bb-item"),this.trigger("render"),this.$el},refresh:function(){this.render()},append:function(note){this.notes.push(note)},updateNotes:function(){var current=this.book.getPageByPageIndex(this.page),pagesWithSlots=[{page:this.book.getPageByPageIndex(this.page-2),slot:0},{page:this.book.getPageByPageIndex(this.page-1),slot:0},{page:current,slot:1},{page:this.book.getPageByPageIndex(this.page+1),slot:current.cover?2:1},{page:this.book.getPageByPageIndex(this.page+2),slot:2},{page:this.book.getPageByPageIndex(this.page+3),slot:current.cover?3:2}];_.each(pagesWithSlots,function(pageWithSlot){if(pageWithSlot.page){var note=new a5.views.interaction.PPEbookNote({vent:this.vent,page:pageWithSlot.page,book:this.book});this.append(note),this.$notes.eq(pageWithSlot.slot).append(note.$el),note.render()}},this),this.flag(),this.$bookblock.bookblock({shadowSides:0,shadowFlip:.7,startPage:2,onBeforeFlip:this._onBeforeFlip,onEndFlip:this._onEndFlip})},flag:function(){this.$el.toggleClass("no-prev",this.$notes.eq(0).is(":empty")).toggleClass("no-next",this.$notes.eq(2).is(":empty")).toggleClass("single-page",1==this.$notes.eq(1).children().length)},reportChange:function(changes){this.hasChanges=!!changes,this.$el.toggleClass("hasChanges",this.hasChanges),this.hasChanges&&this.save()},checkChanges:function(){this.hasChanges?this.save():this.reset()},focus:function(){var current=this.book.getPageByPageIndex(this.page);_.find(this.notes,function(note){return note.page===current},this).focus()},save:function(){this._eachNote("save"),a5.mainBuilder.curInteraction.store(),this.reportChange(!1)},reset:function(){this._eachNote("reset")},setup:function(){this._eachNote("editable")},teardown:function(){this._eachNote("cleanup"),this.$notes.empty(),this.$bookblock.is(".bb-vertical")&&this.$bookblock.bookblock("destroy"),this.exportFormatSelect.close(),this.notes=[],this.reportChange(!1)},exportTo:function(formats){var pages=_.filter(this.book.pages,function(page){return page.hasNotes()}),html=a5.service.templates.render(this.exportTemplate,{pages:pages,title:this.book.title},this.defaultExportTemplate);a5.service.converter.exportTo({formats:formats,input:html,output:"notes"})},goPrev:function(){this.$bookblock.bookblock("prev")},goNext:function(){this.$bookblock.bookblock("next")},goTo:function(pageIndex){this.page=this._getCurrent(pageIndex)},_onExport:function(formats){this.exportTo(formats)},_onNotebookPageChange:function(){this.checkChanges(),this.teardown(),this.updateNotes(),this.setup()},_onBeforeFlip:function(current,dir){current=this.book.getPageByPageIndex(this.page);var direction="next"==dir?1:-1,page=this.page+direction*(current.cover?1:2);if((page=Math.max(0,Math.min(this.book.pageCount-1,page)))===this.page)return!0;this.goTo(page)},_onEndFlip:function(old,pageIndex,isLimit){this.vent.trigger("notebook-page:change")},_onClickSave:function(e){e.preventDefault(),this.save()},_onClickPrev:function(e){e.preventDefault(),this.goPrev()},_onClickNext:function(e){e.preventDefault(),this.goNext()},_onClickPageNumber:function(pageNumber){this.book.openPageNumber(pageNumber),this.trigger("page-number:click")},_onNoteChange:function(){this.reportChange(!0)},_onNoteReset:function(){this.reportChange(!1)},_onWindowResize:function(){this._fixCkeToolbox()},_eachNote:function(handler,notes){_.each(notes||this.notes,function(note){return"string"==typeof handler?note[handler].apply(note):handler(note)})},_getCurrent:function(pageIndex){var pagesPerScreen=this.book.pagesPerScreen,offset=this.book.cover?pagesPerScreen-1:0,pageFrom=Math.floor((pageIndex+offset)/pagesPerScreen)*pagesPerScreen-offset;return pageFrom=Math.min(Math.max(pageFrom,0),this.book.pageCount-1)},_fixCkeToolbox:function(){this.$bookblock.length>0&&$(".cke_chrome").css({top:this.$bookblock.offset().top-$(".cke_chrome").height()+20})}},Obj.extend("a5.views.interaction.PPEbookNotes"),a5.views.interaction.PPEbookNote={init:function(parameters){this.book=parameters.book,this.page=parameters.page,this.vent=parameters.vent,this.$el=$("<div>",{class:"note gui-landmark"}),this.$el.toggleClass("cover",this.page.cover),this.noteText=new a5.views.interaction.PPEbookNoteText({text:this.page.note,vent:this.vent,parent:this}),this.pageNumber=new a5.views.interaction.PPEbookNotePageNumber({number:this.page.number,vent:this.vent})},render:function(){return this.$el.empty(),this.$el.append(this.noteText.$el),this.$el.append(this.pageNumber.$el),this.noteText.render(),this.pageNumber.render(),this.$el},editable:function(){this.$el.is(":visible")&&this.noteText.editable()},cleanup:function(){this.noteText.cleanup()},reset:function(){this.noteText.reset()},save:function(){var note=this.noteText.save();_.isString(note)&&(this.page.note=note)},focus:function(){this.noteText.focus()}},Obj.extend("a5.views.interaction.PPEbookNote"),a5.views.interaction.PPEbookNoteText={init:function(parameters){this.text=parameters.text,this.parent=parameters.parent,this.vent=parameters.vent,this.$el=$("<div>",{class:"note-text gui-landmark"}),_.bindAll(this,"compare","destroy","_onClick"),this.$el.on("click",this._onClick)},render:function(){return this.$el.html(this.text),this.$el},editable:function(){this.$el.attr("contenteditable",!0),this.editor=CKEDITOR.inline(this.$el[0],{toolbarCanCollapse:!0,dialog_backgroundCoverColor:"black",language:"en",extraPlugins:"sharedspace",sharedSpaces:{top:this.parent.$el[0]},toolbarGroups:[{name:"clipboard",groups:["clipboard","undo"]},{name:"editing",groups:["find","selection"]},{name:"links"},{name:"forms"},{name:"tools"},{name:"document",groups:["mode","document","doctools"]},{name:"others"},{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","blocks","align"]},{name:"styles"},{name:"colors"}],removeButtons:"Underline,Subscript,Superscript"}),this.editor.on("key",this._onEditorKey,this),this.editor.on("change",this._onEditorChange,this),this.editor.on("focus",this._onEditorFocus,this,null,100),this.editor.on("blur",this._onEditorBlur,this,null,100)},cleanup:function(){_.defer(this.destroy)},destroy:function(){this.editor&&(this.editor.destroy(),this.editor=null)},reset:function(){this.cleanup(),this.model&&this.$el.html(this.model.note),this.vent.trigger("note:reset")},compare:function(){this.text!==this.editor.getData()&&this.vent.trigger("note:change")},save:function(){return this.editor&&this.editor.getData()},focus:function(){this.$el.focus()},_onEditorKey:function(e){_.defer(this.compare),e.stop(),e.data.domEvent.stopPropagation()},_onEditorChange:function(e){_.defer(this.compare)},_onEditorFocus:function(e){this.parent.$el.children(".cke").css("display","block")},_onEditorBlur:function(e){this.parent.$el.children(".cke").css("display","")},_onClick:function(e){var href=$(e.target).attr("href");href&&(e.preventDefault(),a5.mainBuilder.engine.invoke("open-link",href))}},Obj.extend("a5.views.interaction.PPEbookNoteText"),a5.views.interaction.PPEbookNotePageNumber={init:function(parameters){this.vent=parameters.vent,this.number=parameters.number,this.$el=$("<div>",{class:"page-number gui-landmark"}),_.bindAll(this,"_onClick"),this.$el.on("click",this._onClick)},render:function(){return this.number>0&&this.$el.html(this.number),this.$el},_onClick:function(e){e.preventDefault(),this.vent.trigger("page-number:click",this.number)}},Obj.extend("a5.views.interaction.PPEbookNotePageNumber"),a5.views.interaction.PPEbookNotes.version=5,a5.views.interaction.PPEbookPages={template:"ebook_pages",init:function(model,parent,cover){this._super(model,parent,$('<div class="pages-wrapper"></div>')),this.cover=cover,this.pages=[],this.solutionPages=[],this.model.bind("page_change",this.renderPage,this),this.model.bind("restore",this.renderPage,this),this.model.bind("per_screen_change",this.onPerScreenChange,this)},printDialog:function(){this.printRangeDialog=a5.view.dialog.display("a5.book.dialog.PrintingRange",{dialogClass:"printingRange",currentPage:[_.first(this.current).getPageNumber(),_.last(this.current).getPageNumber()],maxPage:_.last(this.pages).getPageNumber()},{print:_.bind(function(){if(!this.printRangeDialog.find("*[data-button=print]").hasClass("inactive")){var lower=this.printRangeDialog.find("input[name=range-lower]").attr("value").trim(),upper=this.printRangeDialog.find("input[name=range-upper]").attr("value").trim();this.printPages(parseInt(lower,10),parseInt(upper,10))}},this)},_.bind(function(event){if(!$(event.currentTarget).is(".ui-dialog-titlebar-close"))return this._isPrintDialogValid()},this)),this.printRangeDialog.find("input").on("input",_.bind(this.onPrintDialogInput,this)),this.model.bind("page_change",function(){this.printRangeDialog.data("ui-dialog")&&this.printRangeDialog.dialog("close")},this,{once:!0})},_isPrintDialogValid:function(){var lower=this.printRangeDialog.find("input[name=range-lower]").attr("value").trim(),upper=this.printRangeDialog.find("input[name=range-upper]").attr("value").trim(),isLowerValid=parseInt(lower,10)>=0,isUpperValid=parseInt(upper,10)<=_.last(this.pages).getPageNumber();return isLowerValid&&isUpperValid&&parseInt(lower,10)<=parseInt(upper,10)},_createPrintFrame:function(){var pageSize=this.pages[0].model;this.printFrame=document.createElement("iframe"),this.printFrame.style.visibility="hidden",this.printFrame.style.width="100%",this.printFrame.style.height="100vw",this.pageStyleSheet=document.createElement("style"),this.pageStyleSheet.textContent=a5.service.templates.render("a5.book.style.printStyleSheet",{width:pageSize.pdfWidth,height:pageSize.pdfHeight}),document.body.appendChild(this.printFrame),this.printFrame.contentDocument.body.appendChild(this.pageStyleSheet)},onPrintDialogInput:function(e){this._isPrintDialogValid()?this.printRangeDialog.find("*[data-button=print]").removeClass("inactive"):this.printRangeDialog.find("*[data-button=print]").addClass("inactive")},printPages:function(lower,upper){this.pdfPages=[],this.renderedPdfPages={};var promises={},chosenPages=(this.pages[0].model,this.model.getPageRange(lower,upper));this._createPrintFrame(),this.printLoadingDialog=a5.view.dialog.display("a5.book.alert.PrintingProgressBar",{dialogClass:"printingProgress"}),this.printLoadingDialog.find("progress").attr("max",2*chosenPages.length),_.each(chosenPages,function(page){promises[page.index]=new Promise(_.bind(function(resolve,reject){var onUrlLoad=_.bind(function(pdf){pdf.getPage(1).then(onPageLoad)},this),onPageLoad=_.bind(function(pdfPage){this.onPdfPageLoaded(pdfPage,page,resolve,reject)},this);pdfjsLib.getDocument(page.url).promise.then(onUrlLoad)},this))},this),Promise.all(_.values(promises)).then(_.bind(function(){var iframePromises=[];_.each(this.renderedPdfPages,function(img){var node=this.printFrame.contentDocument.body,promise=new Promise(function(resolve,reject){var i=node.appendChild(img);i.onload=resolve,i.onerror=reject});iframePromises.push(promise)},this),Promise.all(iframePromises).then(_.bind(function(){this.printFrame.contentWindow.onafterprint=_.bind(function(){this.printLoadingDialog.dialog("close"),_.defer(_.bind(function(){$(this.printFrame).remove()},this))},this),this.printFrame.contentWindow.print()},this))},this))},onPdfPageLoaded:function(pdfPage,page,resolve,reject){this.pdfPages.push(pdfPage);var pdfCanvas=document.createElement("canvas");pdfCanvas.width=page.pdfWidth*(150/72),pdfCanvas.height=page.pdfHeight*(150/72);var renderContext={canvasContext:pdfCanvas.getContext("2d"),transform:[150/72,0,0,150/72,0,0],viewport:pdfPage.getViewport({scale:1}),intent:"print"};pdfPage.render(renderContext).promise.then(_.bind(function(){this.onPdfPageRendered(pdfCanvas,page,resolve,reject)},this))},onPdfPageRendered:function(pdfCanvas,page,resolve,reject){var img=document.createElement("img");img.style.width=page.pdfWidth+"pt",img.style.height=page.pdfHeight+"pt",this.printLoadingDialog.find("progress").attr("value",this.pdfPages.length+_.keys(this.renderedPdfPages).length),pdfCanvas.toBlob(_.bind(function(blob){img.src=URL.createObjectURL(blob),img.onload=resolve,img.onerror=reject,this.renderedPdfPages[page.index]=img,this.printLoadingDialog.find("progress").attr("value",this.pdfPages.length+_.keys(this.renderedPdfPages).length)},this))},append:function(page){
page.bind("loaded",this.pageLoaded,this),page.bind("page_click",this.onPageClick,this),this.pages.push(page)},appendSolutionPage:function(page){this.solutionPages.push(page)},allPagesLoaded:function(){return!0},pageLoaded:function(){this.allPagesLoaded()&&this.$(".pages-spinner").hide()},swiped:function(e){if(this.scroller.isZoomedIn()&&!this.scroller.isInitialZoom()||this.model.openSidebar)return!1;e.gesture.direction==Hammer.DIRECTION_RIGHT?this.model.previousPage():e.gesture.direction==Hammer.DIRECTION_LEFT&&this.model.nextPage()},prerender:function(){var pages=[];_.each(_.range(1,this.model.pagesPerScreen+1),function(i){this.pages[this.current.to-1+i]&&pages.push(this.pages[this.current.to-1+i]),this.pages[this.current.from-i]&&pages.push(this.pages[this.current.from-i])},this),_(pages).each(function(page){page.prerender(),page.model.solutionPage&&this.getSolutionPage(page.model).render()},this)},setCurrent:function(){var offset=this.cover?this.model.pagesPerScreen-1:0,pageFrom=Math.floor((this.model.page+offset)/this.model.pagesPerScreen)*this.model.pagesPerScreen-offset,pageTo=pageFrom+this.model.pagesPerScreen;pageFrom=Math.max(pageFrom,0),pageTo=Math.min(pageTo,this.model.pageCount),this.current=this.pages.slice(pageFrom,pageTo),this.current.from=pageFrom,this.current.to=pageTo,this.model.current=this.current},onPerScreenChange:function(){this.scroller&&(this.scroller.zoom=null,this.scroller.left=0,this.scroller.top=0,this.model.openSidebar||(this.scroller.panOffset=0),this.renderPage())},renderPage:function(options){if(this.setCurrent(),this.parent.options.solutionViewLock&&this.parent.isSolutionView())return void this.renderSolutionPage();this.parent.toggleSolutionView(!1),this.$(".page").remove(),_(this.current).each(function(page){this.$(".pages").append(page.node),page.render()},this),this.prerender(),this.model.annotations&&a5a.activate(_.map(this.current,function(page,index){return _.extend(page,{index:this.current.from+index})},this)),this.$(".pages-spinner").toggle(!this.allPagesLoaded()),this.renderImages(),this.updateScroller({afterPageChange:!0}),this.trigger("opened",this.current,options||{})},renderSolutionPage:function(options){this._copySpotlight(),this.$(".page").remove();var solutionPages=[];_.each(this.current,function(page){var _page=page;_page.model.solutionPage&&(_page=this.getSolutionPage(_page.model),solutionPages.push(_page)),this.$(".pages").append(_page.render())},this),this.model.annotations&&(a5a.activate(_.map(solutionPages,function(solutionPage,index){return _.extend(solutionPage,{index:solutionPage.model.index+this.model.pageCount})},this)),this._pasteSpotlight()),this.renderSolutionImages(),this.updateScroller({afterPageChange:!0}),this.trigger("opened-in-solution-view",this.current,options||{})},updateScroller:function(options){if(this.scroller){var initialScale,pagesWidth=_.reduce(this.current,function(memo,page){return memo+page.width},0),pagesHeight=_.max(_.map(this.current,function(page){return page.height})),onePageWidth=_.max(_.pluck(this.current,"width")),onePageHeight=_.max(_.pluck(this.current,"height"));1===this.model.pagesPerScreen&&a5.dp.config.bookZoomSinglePage&&(initialScale=parseInt(a5.dp.config.bookZoomSinglePage,10)/100,this.scroller.left=0,this.scroller.top=0),this.scroller.updateSize(pagesWidth,pagesHeight,initialScale,onePageWidth,onePageHeight,options)}},renderImages:function(){this.node.find("> img").remove();var length=this.current.length;_.each(this.current,function(page,index){page.reposition(this.scroller,index,length,this.node)},this),this.$(".pages").css("z-index",1)},renderSolutionImages:function(){this.node.find("> img").remove();var length=this.current.length;_.each(this.current,function(page,index){var _page=page;_page.model.solutionPage&&(_page=this.getSolutionPage(_page.model)),_page.reposition(this.scroller,index,length,this.node)},this),this.$(".pages").css("z-index",1)},updateImages:function(){var length=this.current.length;_.each(this.current,function(page,index){if(page.reposition(this.scroller,index,length),page.model.solutionPage){this.getSolutionPage(page.model).reposition(this.scroller,index,length,this.node)}},this)},updateState:function(){var handDisabled=this.scroller.isLastZoomOut()&&0===this.scroller.panOffset;this.parent.$(".hand").toggleClass("disabled",handDisabled).attr("disabled",handDisabled),this.parent.$(".hand:not(.disabled)").toggleClass("active",!handDisabled&&!this.scroller.marqueeZoomEnabled),this.parent.$(".marquee-zoom").toggleClass("disabled",this.scroller.isLastZoomIn()).attr("disabled",this.scroller.isLastZoomIn()),this.parent.$(".marquee-zoom:not(.disabled)").toggleClass("active",!!this.scroller.marqueeZoomEnabled),this.parent.$(".attach-file:not(.disabled)").toggleClass("active",!!this.scroller.attachFileEnabled),this.node.toggleClass("pan-mode",(!this.scroller.isLastZoomOut()||this.scroller.panOffset>0)&&!this.scroller.marqueeZoomEnabled),this.node.toggleClass("marquee-mode",!!this.scroller.marqueeZoomEnabled),this.node.toggleClass("attach-file-mode",!!this.scroller.attachFileEnabled)},updateOverlay:function(){this.overlay.updatePosition(this.$(".pages"),this.scroller)},onRepositioned:function(){this.updateImages(),this.updateOverlay()},onSizeUpdated:function(){this.updateOverlay()},onZoomChanged:function(){this.updateState(),this.scroller.isLastZoomIn()&&_.invoke(this.current,"maximumZoomReached"),this.scroller.isLastZoomOut()&&_.invoke(this.current,"minimumZoomReached")},onMarqueeToggled:function(){this.updateState()},onHandToggled:function(){this.updateState()},onAttachFileToggled:function(){this.updateState()},render:function(){return this._super(),this.node.appendTo(this.parent.node),this.renderPage(),this.scroller=new a5.views.interaction.PPEbookScroller(this.node,this.$(".pages"),{step:a5.dp.config.bookZoomStep/100,marqueeStep:a5.dp.config.bookZoomMarqueeClick/100,wheelStep:a5.dp.config.bookZoomWheelStep/100,pinchStep:a5.dp.config.bookZoomPinchStep/100,keyboardPanStep:a5.dp.config.bookKeyboardPanStep,wheelPan:a5.dp.config.mousewheelActsAsPan,parent:this}),this.scroller.bind("repositioned",this.onRepositioned,this),this.scroller.bind("size_updated",this.onSizeUpdated,this),this.scroller.bind("zoom_changed",this.onZoomChanged,this),this.scroller.bind("marquee_toggled",this.onMarqueeToggled,this),this.scroller.bind("hand_toggled",this.onHandToggled,this),this.scroller.bind("attach_file_toggled",this.onAttachFileToggled,this),this.scroller.render(),this.overlay=new a5.views.interaction.PPEbookOverlay(this.model.overlay,this,this.node),$.support.touch&&this.bindNode("swipe",this.swiped),this.node},sendBack:function(){this.node.addClass("in-background")},bringFront:function(){this.node.removeClass("in-background")},onPageClick:function(page,coords){if(this.scroller.attachFileEnabled){var hotspot={page:page.number,top:Math.round(coords.y/this.scroller.zoom),left:Math.round(coords.x/this.scroller.zoom)};a5.eventBus.trigger("book:new_file_hotspot",hotspot),this.scroller.attachFileEnabled=!1,this.updateState()}},getSolutionPage:function(page){var index=page.solutionPage.index;return this.solutionPages[index]},getPage:function(page){var index=page.index;return this.pages[index]},_copySpotlight:function(){this.model.annotations&&(this.spotlights=this.$(".page").map(function(index,page){return $(page).find(".content-block-out").detach()}))},_pasteSpotlight:function(){this.model.annotations&&(this.$(".page").each(function(index,page){var $spotlight=this.spotlights[index],$annotations=$(page).find("."+this.model.annotations.options.stage);$annotations.one("redraw.stage",function(){$annotations.append($spotlight)})}.bind(this)),this.spotlights=[])}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPEbookPages"),a5.views.interaction.PPEbookPage={PDF_QUALITY_LOW:.3,PDF_QUALITY_NORMAL:1,PDF_QUALITY_HIGH:2,init:function(model,parent){this._super(model,parent,$('<div class="page"></div>')),this.loaded=!1,this.model.bind("hotspot_added",this.onHotspotAdded,this),this.model.bind("restore",this.onRestore,this),this.width=this.model.width,this.height=this.model.height,this._isSolutionView()&&this.node.addClass("solution-view"),a5.eventBus.bind("swipe-enabled",_.bind(this.enablePDFText,this)),a5.eventBus.bind("swipe-disabled",_.bind(this.disablePDFText,this))},getPageNumber:function(){return this.model.number},enablePDFText:function(){this.pdfTextContainer&&this.pdfTextContainer.show()},disablePDFText:function(){this.pdfTextContainer&&this.pdfTextContainer.hide()},maximumZoomReached:function(){this.quality<this.PDF_QUALITY_HIGH&&this.renderPDFPage(this.pdfPage,this.PDF_QUALITY_HIGH)},minimumZoomReached:function(){this.quality===this.PDF_QUALITY_HIGH&&(this.quality=this.PDF_QUALITY_NORMAL,this.pdfWrap.find("*[data-quality="+this.PDF_QUALITY_HIGH+"]").remove())},_createThumbnail:function(){this.thumbnail=$("<img class='pageContent pageContent--thumbnail' src='"+this.model.thumbnail+"' alt='loading' />"),this.thumbnail.css({width:this.model.width,height:this.model.height})},renderPDF:function(quality){if(this.pdfWrap=$("<div class='pageContent pageContent--pdf'/>"),this.pdfTextContainer=this.pdfTextContainer||$("<div class='pageText pageText--pdf'/>"),this.pdfWrap.append(this.pdfTextContainer),this.node.prepend(this.pdfWrap),quality||(quality=this.PDF_QUALITY_NORMAL),this.thumbnail||this._createThumbnail(),this.pdfCanvas||this.pdfWrap.prepend(this.thumbnail),this.pdfCanvas&&this.pdfWrap.prepend(this.pdfCanvas),this.pdfPage)this.renderPDFPage(this.pdfPage,quality);else{pdfjsLib.getDocument(this.model.url).promise.then(_.bind(function(pdf){pdf.getPage(1).then(_.bind(function(page){this.renderPDFPage(page,quality)},this))},this))}},renderPDFPage:function(page,quality){this.pdfPage=page;function renderCanvas(){quality<this.quality||(this.pdfWrap.append(this.pdfCanvas),this.loaded=!0,this.trigger("loaded"))}function renderTextLayer(textContent){this.pdfTextContainer.empty(),pdfjsLib.renderTextLayer({textContent:textContent,container:this.pdfTextContainer.get(0),viewport:textViewport,textDivs:[]})}if(!this.pdfCanvas||quality>this.quality){var nativeSize=page.getViewport({scale:1});this.pdfCanvas=document.createElement("canvas");var context=this.pdfCanvas.getContext("2d"),width=this.model.width,canvasScale=width*quality/nativeSize.width,canvasViewport=page.getViewport({scale:canvasScale}),textScale=width/nativeSize.width,textViewport=page.getViewport({scale:textScale});this.pdfCanvas.height=this.model.height*quality,this.pdfCanvas.width=this.model.width*quality,$(this.pdfCanvas).attr("data-quality",quality),$(this.pdfCanvas).css("transform","scale("+1/quality+")"),$(this.pdfCanvas).css("transform-origin","top left"),this.quality=quality;var renderContext={canvasContext:context,viewport:canvasViewport};page.render(renderContext).promise.then(_.bind(renderCanvas,this)),page.getTextContent().then(_.bind(renderTextLayer,this))}else renderCanvas.call(this)},renderImage:function(){this.$image=$("<img/>").attr("width",this.model.width).attr("height",this.model.height),this.$image.load(_.bind(function(){this.loaded=!0,this.trigger("loaded")},this)),this.$image.attr("src",this.model.url)},prerender:function(){this.model.isPDF()?this.render(this.PDF_QUALITY_LOW):this.render()},render:function(quality){return this._super(),this.node.empty(),this.node.on("contextmenu",function(e){if(a5.dp.config.protectBookPages)return e.preventDefault(),!1}),this.model.parent.annotations&&$('<div class="annotations"></div>').appendTo(this.node),this.$container=$('<div class="content" style="width:'+this.model.width+"px;height:"+this.model.height+'px;"></div>'),this.$container.appendTo(this.node),this.model.restricted?(this.node.addClass("page-restricted"),this.node):(this.model.isPDF&&this.model.isPDF()?this.renderPDF(quality):this.renderImage(),this.renderHotspots(),this.bindNode("click",this.onClick),this.node)},reposition:function(scroller,index,length,$parent){if(this.$image){var w=this.node.get(0).getBoundingClientRect().width,h=this.node.get(0).getBoundingClientRect().height;if(this.$image.attr("width",w),this.$image.attr("height",h),w=parseFloat(this.$image.attr("width")),h=parseFloat(this.$image.attr("height")),this.$image.css("position","absolute"),this.$image.css("left","50%"),this.$image.css("max-width","none"),$parent&&$parent.append(this.$image),scroller){var marginLeft=index?0:w*length/2;this.$image.css("margin-left",scroller.roundedLeft()-marginLeft+"px"),this.$image.css("margin-top",scroller.roundedTop()+"px")}}},renderHotspots:function(){!this._isSolutionView()&&this.model.hasSolutionPage()&&this.model.hasHotspotsByType("single-solution")&&this.renderSVGClips(),$.when(this.model.getVisibleHotspots()).then(function(hotspots){this.node.append(_.pluck(hotspots,"node")),_.invoke(hotspots,"render")}.bind(this))},renderSVGClips:function(){var svg=a5.service.templates.render("a5.book.SolutionClips",{width:this.model.width,height:this.model.height,url:this.model.solutionPage.url,id:"solution-clips-"+this.model.index});this.$svg=$(svg),this.$container.html(this.$svg);var singleSolutionHotspots=this.model.getHotspotsByType("single-solution");_.each(singleSolutionHotspots,function(hotspot){hotspot.unbind("change",this.onSingleSolutionHotspotChange,this),hotspot.bind("change",this.onSingleSolutionHotspotChange,this)},this)},refreshSVGClips:function(){var $clipPath=this.$svg.find("clipPath");$clipPath.contents().remove();var hotspots=this.model.getHotspotsByType("single-solution"),clips=_.chain(hotspots).invoke("toSVG").compact().value();$clipPath.append(clips)},_isSolutionView:function(){return this.model instanceof a5.models.interaction.PPEbookSolutionPage},onClick:function(ev){var pageOffset=this.node.offset(),coords={x:ev.pageX-pageOffset.left,y:ev.pageY-pageOffset.top};this.trigger("page_click",this.model,coords),a5.mainBuilder.trigger("page_click",this)},onHotspotAdded:function(hotspot){this.node.append(hotspot.node),hotspot.render()},onRestore:function(data){data.hotspots&&_.each(data.hotspots,function(hotspot){this.parent.addFileHotspot(this.model.number,hotspot)},this)},onSingleSolutionHotspotChange:function(){this.refreshSVGClips()}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPEbookPage"),a5.views.interaction.PPEbookEmptyPage={init:function(model,parent){this._super(model,parent,$('<div class="page empty-page"></div>')),this.width=this.model.width,this.height=this.model.height},render:function(){return this._super(),this.node.empty(),$('<div class="content" style="display:inline-block;width:'+this.model.width+"px;height:"+this.model.height+'px;"></div>').appendTo(this.node),this.node}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPEbookEmptyPage"),a5.views.interaction.PPEbookHotspot={template:"a5.view.Hotspot",DEFAULT_TEMPLATE:'<div class="hotspot"></div>',width:0,height:0,top:0,left:0,visited:!1,id:null,page:null,init:function(model,parent,$node,options){_.extend(this,options||{});var html=a5.service.templates.render(this.template,{label:this.tooltip},this.DEFAULT_TEMPLATE),$html=$(html);this._super(model,parent,$html),$node&&(this.id=$node.attr("id")),_.bindAll(this,"onClickOpen")},render:function(){return this.node.off(),this.node.css({width:this.width+"px",height:this.height+"px",top:this.top+"px",left:this.left+"px"}),this.node.addClass([this.icon,this.type,this.shape].join(" ")),this.tooltip&&this.renderTooltip(),this.visited&&this.node.addClass("visited"),this.enable(),a5.hooks.ppebookHotspotRendered.call(this),this.node},open:function(){this.visited=!0,this.node.addClass("visited"),"a5.views.interaction.PPEbookHotspotAudioToolbar"!=this._class_name&&a5.eventBus.trigger("audio-toolbar:stop"),this.model.bind("page_change",this.onPageChange,this,{once:!0})},close:function(){},tryClose:function(){this.canClose()&&this.close()},canClose:function(){return!0},disable:function(){this.node.off("click",this.onClickOpen)},enable:function(){this.node.on("click",this.onClickOpen)},onPageChange:function(){this.close()},onClickOpen:function(e){e.stopPropagation(),this.model.tryCloseAllHotspots(),this.open()},draggableRemoveMarginsOnCreate:function(ev){var $draggable=$(ev.target),marginLeft=parseInt($draggable.css("margin-left"),10);if(parseInt($draggable.css("margin-top"),10)||marginLeft){var offset=$draggable.offset();$draggable.css({"margin-left":0,"margin-top":0}).offset({top:offset.top,left:offset.left})}},renderTooltip:function(){this.node.find(".tooltip").remove(),this.node.append($('<div class="tooltip">').text(this.tooltip));var originalTransform;this.node.delayedTooltip({delay:a5.dp.config.bookTooltipDelay,duration:a5.dp.config.bookTooltipDuration,start:function($tooltip){originalTransform=$tooltip.css("transform"),$tooltip.css("transform","");var transform=$tooltip.css("transform");transform="none"===transform?"":" "+transform,$tooltip.css("transform","scale("+1/this.parent.pages.scroller.zoom+")"+transform)}.bind(this),end:function($tooltip){$tooltip.css("transform",originalTransform)},container:function(){return this.node.closest(".pages-wrapper")}.bind(this)})}},a5.views.interaction.BaseView.extend("a5.views.interaction.PPEbookHotspot"),a5.views.interaction.PPEbookHotspotContent={type:"content",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.interaction=model.parent,this.content=a5.utils.buildContents($node,this.interaction).html(),this.contentWidth=$node.attr("content-width"),this.contentHeight=$node.attr("content-height"),this.contentLeft=$node.attr("content-left"),this.contentTop=$node.attr("content-top"),_.bindAll(this,"onClose")},render:function(){return this._super(),this.$dialog=$(a5.mainBuilder.layout.getTemplate("ebook_hotspot_tip")),this.$dialog.addClass([this.icon,this.shape,"hotspot-dialog-content"].join(" ")),this.$dialog.find(".modal-body").html(this.content),a5.dp.config.draggableHotspotWindow&&this.$dialog.draggable(_.extend({cancel:".close",handle:".modal-header, .modal-footer",containment:"document",create:_.partial(_.defer,this.draggableRemoveMarginsOnCreate)},a5.dp.config.draggableHotspotWindow)),this.$dialog.css({left:_.isUndefined(this.contentLeft)?"":this.contentLeft+"px",top:_.isUndefined(this.contentTop)?"":this.contentTop+"px",marginTop:_.isUndefined(this.contentTop)?"":0,marginLeft:_.isUndefined(this.contentLeft)?"":0,height:_.isUndefined(this.contentHeight)?"":this.contentHeight+"px",width:_.isUndefined(this.contentWidth)?"":this.contentWidth+"px"}),this.node},open:function(){this.opened||(this._super(),this.$modal=this.$dialog.modal({backdrop:a5.dp.config.bookHotspotPopupModal}),this.$modal.on("hidden",this.onClose),this.opened=!0)},close:function(){this.$modal&&(this.$modal.remove(),this.$modal=null),this.opened=!1},canClose:function(){return!1},onClickOpen:function(e){e.stopPropagation(),this.open()},onClose:function(e){e.preventDefault(),this.close()}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotContent"),a5.views.interaction.PPEbookHotspotContentSolution={type:"content-solution",contentTemplate:"a5.view.dialog.HotspotContentSolution",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.interaction=model.parent,this.title=$node.attr("title"),this.content=a5.utils.buildContents($node,this.interaction).html(),_.bindAll(this,"onClose","onClickNext","onClickPrev","onClickToggleAll");var html=a5.service.templates.render(this.contentTemplate,this._serializeData()),$html=$(html);this.$el=$html,this.$next=this.$el.find(".btn-next"),this.$prev=this.$el.find(".btn-prev"),this.$all=this.$el.find(".btn-toggle-all"),this.hideAllLabel=this.$all.attr("data-label-hide"),this.showAllLabel=this.$all.attr("data-label-show"),this.$el.addClass([this.icon,this.shape].join(" ")),this.$el.on("click",".btn-toggle-all",this.onClickToggleAll),this.$el.on("click",".btn-next",this.onClickNext),this.$el.on("click",".btn-prev",this.onClickPrev),this.items=this.$el.find(".solution-item").toArray(),this.contentWidth=$node.attr("content-width"),this.contentHeight=$node.attr("content-height"),this.contentLeft=$node.attr("content-left"),this.contentTop=$node.attr("content-top")},render:function(){return this._super(),this.curItemIndex=0,this._hideAll(),this._updateButtons(),this.node},open:function(){this.opened||(this._super(),this.$dialog=this.$el.dialog({dialogClass:"hotspot-dialog-content-solution",height:this.contentHeight,width:this.contentWidth,position:{my:"left top",at:"left+"+this.contentLeft+" top+"+this.contentTop},resizable:!1}),this.$dialog.on("dialogclose",this.onClose),this.opened=!0)},close:function(){this.$dialog&&(this.$dialog.dialog("destroy"),this.$dialog=null),this.opened=!1},canClose:function(){return!1},onClickOpen:function(e){e.stopPropagation(),this.open()},onClose:function(e){e.preventDefault(),this.close()},onClickNext:function(e){e.preventDefault(),this.$next.is(".disabled")||(this._show(),this._goNext(),this._updateButtons())},onClickPrev:function(e){e.preventDefault(),this.$prev.is(".disabled")||(this._goPrev(),this._hide(),this._updateButtons())},onClickToggleAll:function(e){e.preventDefault(),this.$all.is(".disabled")||(this._isLast()&&!$(this.items[this.curItemIndex]).hasClass("hidden")?(this._hideAll(),this._goFirst()):(this._showAll(),this._goLast()),this._updateButtons())},_serializeData:function(){return{title:this.title,content:this.content}},_showAll:function(){this.$el.find(".solution-item").removeClass("hidden")},_show:function(){var $current=$(this.items[this.curItemIndex]);$current.removeClass("hidden"),a5.utils.scrollIntoElementIfNeeded($current,{behavior:"smooth",block:"nearest"})},_hideAll:function(){this.$el.find(".solution-item").addClass("hidden")},_hide:function(){var $current=$(this.items[this.curItemIndex]),$prev=$(this.items[_.max([this.curItemIndex-1,0])]);$current.addClass("hidden"),a5.utils.scrollIntoElementIfNeeded($prev,{behavior:"smooth",block:"end"})},_goNext:function(){$(this.items[this.curItemIndex]).hasClass("hidden")||(this.curItemIndex=_.min([this.curItemIndex+1,this.items.length-1]))},_goPrev:function(){$(this.items[this.curItemIndex]).hasClass("hidden")&&(this.curItemIndex=_.max([this.curItemIndex-1,0]))},_goFirst:function(){this.curItemIndex=0},_goLast:function(){this.curItemIndex=this.items.length-1},_isFirst:function(){return 0===this.curItemIndex},_isLast:function(){return this.curItemIndex===this.items.length-1},_isEmpty:function(){return!this.items.length},_updateButtons:function(){this.$prev.toggleClass("disabled",this._isEmpty()||this._isFirst()&&$(this.items[this.curItemIndex]).hasClass("hidden")),this.$next.toggleClass("disabled",this._isEmpty()||this._isLast()&&!$(this.items[this.curItemIndex]).hasClass("hidden")),this.$all.toggleClass("disabled",this._isEmpty()),this._isLast()&&!$(this.items[this.curItemIndex]).hasClass("hidden")?this.$all.text(this.hideAllLabel):this.$all.text(this.showAllLabel)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotContentSolution"),a5.views.interaction.PPEbookHotspotUrl={type:"url",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.url=$node.attr("url")},open:function(){this._super(),a5.eventBus.trigger("book:open_url_hotspot",this.url),a5.mainBuilder.engine.invoke("open-link",this.url)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotUrl"),a5.views.interaction.PPEbookHotspotFile={type:"file",longPressTime:500,template:"a5.view.hotspot.File",init:function(model,parent,options){this._super(model,parent,null,options),this.id=this.id||a5.utils.createUID(),_.bindAll(this,"onClickRemove","onContextMenu","onLongPress","onTap","onBlur","onDragStart","onDragStop","onDrag"),$(document).on("click",this.onBlur),this.hammerManager=new Hammer.Manager(this.node[0],{recognizers:[[Hammer.Press,{time:this.longPressTime}],[Hammer.Tap]]})},open:function(){this._super(),a5.eventBus.trigger("book:open_file_hotspot",this.file)},render:function(){return this._super(),this.renderChildrenTooltip(),this.hammerManager.off("press tap"),this.hammerManager.on("press",this.onLongPress),this.node.off("click",this.onClickOpen),this.hammerManager.on("tap",this.onTap),this.node.on("click",function(e){e.stopPropagation()}),this.node.on("click",".trash",this.onClickRemove),this.node.on("contextmenu",this.onContextMenu),this.makeDraggable(),this.node},bounds:function(){var $page=this.node.closest(".page");return[0,0,$page.width()-this.node.width(),$page.height()-this.node.height()]},remove:function(){this.node.remove(),this.page.removeFileHotspot(this),a5.eventBus.trigger("book:remove_file_hotspot",{id:this.id,file:this.file})},serialize:function(){return{id:this.id,file:this.file,width:this.width,height:this.height,top:this.top,left:this.left}},toggleToolbar:function(active){this.node.toggleClass("with-toolbar",active)},makeDraggable:function(){this.node.draggable("instance")&&this.node.draggable("destroy"),this.node.draggable({handle:".handle",start:this.onDragStart,drag:this.onDrag,stop:this.onDragStop}),this.node.css("position","")},onClickRemove:function(ev){ev.stopPropagation(),this.remove()},onContextMenu:function(e){this.toggleToolbar(!0)},onBlur:function(e){$.contains(this.node[0],e.srcElement)||this.toggleToolbar(!1)},onTap:function(e){$(e.target).closest(".toolbar").length||(this.model.tryCloseAllHotspots(),this.open())},onLongPress:function(e){$(e.target).closest(".toolbar").length>0||this.toggleToolbar()},onDragStart:function(e,ui){var hammerPan=this.parent.pages.scroller.node.data("hammer").get("pan");this.panEnabled=hammerPan.options.enable,hammerPan.set({enable:!1}),e.stopPropagation(),this.cursorPosition={x:e.clientX,y:e.clientY}},onDrag:function(e,ui){e.stopPropagation();var zoom=this.parent.pages.scroller.zoom,deltaX=e.clientX-this.cursorPosition.x,deltaY=e.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+deltaX)/zoom),newTop=Math.round((ui.originalPosition.top+deltaY)/zoom),bounds=this.bounds();ui.position.left=this.left=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=this.top=Math.min(Math.max(newTop,bounds[1]),bounds[3])},onDragStop:function(e,ui){this.parent.pages.scroller.node.data("hammer").get("pan").set({enable:this.panEnabled}),$(e.originalEvent.target).one("click",function(e){e.stopImmediatePropagation()})},renderChildrenTooltip:function(){var originalTransform;this.node.children().find(".tooltip").each(function(_,el){$(el).parent().delayedTooltip({delay:a5.dp.config.bookTooltipDelay,duration:a5.dp.config.bookTooltipDuration,start:function($tooltip){originalTransform=$tooltip.css("transform"),$tooltip.css("transform","");var transform=$tooltip.css("transform");transform="none"===transform?"":" "+transform,$tooltip.css("transform","scale("+1/this.parent.pages.scroller.zoom+")"+transform)}.bind(this),end:function($tooltip){$tooltip.css("transform",originalTransform)},container:function(){return this.node.closest(".pages-wrapper")}.bind(this)})}.bind(this))}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotFile"),a5.views.interaction.PPEbookHotspotPlatform={type:"platform",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.platformId=$node.attr("platformid")},render:function(){return this._super(),this.$iframe=$("<iframe>",{class:"hotspot",frameborder:0,allowfullscreen:!0,webkitallowfullscreen:!0,mozallowfullscreen:!0,src:this._buildUrl()}),this.node},open:function(){this._super(),this.$iframe.iframeModal()},_buildUrl:function(){return(A5&&A5.PLATFORM_URL_BUILDER||this._defaultUrl).call(null,this.platformId)},_defaultUrl:function(platformId){var course,match=/courses\/(\d+)/.exec(window.location.href);return match&&(course=match[1]),"/api/courses/"+course+"/interactives/"+platformId+".html"}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotPlatform"),a5.views.interaction.PPEbookHotspotEmbeddedTab={type:"embedded",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.ref=$node.attr("ref"),this.options={target:"tab"}},open:function(){this._super(),a5.eventBus.trigger("book:open_embedded",this.ref,this.options)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotEmbeddedTab"),a5.views.interaction.PPEbookHotspotEmbeddedIframe={type:"embedded",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.options={target:"iframe",width:$node.attr("content-width"),height:$node.attr("content-height"),left:$node.attr("content-left"),top:$node.attr("content-top")}}},a5.views.interaction.PPEbookHotspotEmbeddedTab.extend("a5.views.interaction.PPEbookHotspotEmbeddedIframe"),a5.views.interaction.PPEbookHotspotExternal={type:"external",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.ref=$node.attr("ref"),_.bindAll(this,"onClickNextExternalHotspot","onClickPreviousExternalHotspot")},open:function(){this._super();var src=this._buildUrl();if(src){this.$iframe=$("<iframe>",{class:"hotspot",frameborder:0,allowfullscreen:!0,webkitallowfullscreen:!0,mozallowfullscreen:!0,src:src});var $buttons=$("body").find(".hotspot-external-navigation");0===$buttons.length&&($buttons=$(a5.mainBuilder.layout.getTemplate("ebook_hotspot_external_navigation")),$buttons.addClass("invisible"),$buttons.appendTo($("body"))),$buttons.off(),$buttons.on("click",".go-prev-external-hotspot",this.onClickPreviousExternalHotspot),$buttons.on("click",".go-next-external-hotspot",this.onClickNextExternalHotspot),this.$iframe.iframeModal({open:function(){$buttons.removeClass("invisible"),$buttons.find(".go-prev-external-hotspot").toggleClass("is-first-hotspot",!this.prev),$buttons.find(".go-next-external-hotspot").toggleClass("is-last-hotspot",!this.next)}.bindTo(this),close:function(){$buttons.addClass("invisible"),$buttons.find(".go-prev-external-hotspot").removeClass("is-first-hotspot"),$buttons.find(".go-next-external-hotspot").removeClass("is-last-hotspot")}.bindTo(this)})}else a5.eventBus.trigger("book:open_external_hotspot",this.ref)},onClickPreviousExternalHotspot:function(){this.prev&&this.prev.open()},onClickNextExternalHotspot:function(){this.next&&this.next.open()},_buildUrl:function(){var urlFn=A5&&A5.EXTERNAL_URL_BUILDER;if(_.isFunction(urlFn))return urlFn.call(null,this.ref)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotExternal"),a5.views.interaction.PPEbookHotspotAuthor={type:"author"},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotAuthor"),a5.views.interaction.PPEbookHotspotAudioSmall={type:"audio",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.ref=$node.attr("ref"),_.bindAll(this,"attachAudio"),this.attachAudioOnce=_.once(this.attachAudio)},render:function(){return this._super(),this.attachAudioOnce(),this.node},open:function(){this._super(),this.playing?this.player.pause():(0===this.player.position()&&a5.eventBus.trigger("book:open_audio_hotspot",this.ref,{mode:"small"}),this.node.addClass("playing"),a5.service.media.pauseAllExcept(this.player),this.player.play(),this.playing=!0),this.opened=!0},close:function(){this.opened&&(this.player.stop(),this.opened=!1)},onClickOpen:function(e){e.stopPropagation(),this.opened||this.model.tryCloseAllHotspots(),this.open()},attachAudio:function(){this.node.addClass("inactive"),a5.service.media.audio.bind("ready",function(){this.player=a5.service.media.audio.create(this.ref,{preload:!a5.dp.config.audioPreloadDisabled}),this.node.attr("data-playable-media",this.player.uid),this.player.bind("stopped",function(){this.node.removeClass("playing"),this.playing=!1},this),this.player.bind("paused",function(){this.node.removeClass("playing"),this.playing=!1},this),this.node.removeClass("inactive")},this)}},
a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotAudioSmall"),a5.views.interaction.PPEbookHotspotAudioFull={type:"audio",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.ref=$node.attr("ref"),this.subtitles=$node.children("subtitles"),this.transcript=$node.children("transcript"),this.contentLeft=$node.attr("content-left"),this.contentTop=$node.attr("content-top"),this.interaction=model.parent,_.bindAll(this,"onClose","attachAudio"),this.$dialog=$(a5.mainBuilder.layout.getTemplate("ebook_hotspot_tip")),this.attachAudioOnce=_.once(this.attachAudio)},render:function(){return this._super(),this.$dialog.addClass([this.icon,this.shape,"hotspot-dialog-audio"].join(" ")),a5.dp.config.draggableHotspotWindow&&this.$dialog.draggable(_.extend({cancel:".media-footer, .close",containment:"document",create:_.partial(_.defer,this.draggableRemoveMarginsOnCreate),stop:function(ev){$(ev.originalEvent.target).one("click",function(e){e.stopImmediatePropagation()})}},a5.dp.config.draggableHotspotWindow)),this.$dialog.css({left:_.isUndefined(this.contentLeft)?"":this.contentLeft+"px",top:_.isUndefined(this.contentTop)?"":this.contentTop+"px",marginTop:_.isUndefined(this.contentTop)?"":0,marginLeft:_.isUndefined(this.contentLeft)?"":0}),this.$audio=this.attachAudioOnce(),this.$dialog.find(".modal-body").append(this.$audio),this.$modal=this.$dialog.modal({backdrop:a5.dp.config.bookHotspotPopupModal,show:!1}),this.$modal.on("hidden",this.onClose),this.node},open:function(){this._super(),a5.eventBus.trigger("book:open_audio_hotspot",this.ref,{mode:"full"}),this.$modal.modal("show")},close:function(){this.$modal&&this.$modal.modal("hide")},onClose:function(){this.player.stop(),a5.eventBus.trigger("transcript:close")},attachAudio:function(){var $html=$(window.a5.mainBuilder.layout.getTemplate("audio_widget")),$inlineTranscript=$(window.a5.mainBuilder.layout.getTemplate("media_transcript"));return $html.find(".the_audio").hide(),a5.service.media.audio.bind("ready",function(){this.player=a5.service.media.audio.create(this.ref,{preload:!a5.dp.config.audioPreloadDisabled,persistVolume:a5.dp.config.audioVolumeStore}),$html.attr("data-playable-media",this.player.uid),a5.model_builder.audioVideoUtils.addAudioPlayerEvents(this.player,$html),a5.model_builder.audioVideoUtils.linkSubtitles(this.subtitles,this.interaction,$html,this.player),a5.model_builder.audioVideoUtils.linkTranscript(this.transcript,this.interaction,$html,this.player,$inlineTranscript)},this),$inlineTranscript.length?$('<div class="transcript-wrap audio">').append($html).append($inlineTranscript):$html}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotAudioFull"),a5.views.interaction.PPEbookHotspotAudioToolbar={type:"audio",announceCloseTemplate:"a5.book.alert.CloseHotspotAudioToolbar",announceOpenTemplate:"a5.book.alert.OpenHotspotAudioToolbar",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.ref=$node.attr("ref"),this.subtitles=$node.children("subtitles"),this.transcript=$node.children("transcript"),this.interaction=model.parent,this.active=!1,this.$node=$node,_.bindAll(this,"attachAudio"),this.attachAudioOnce=_.once(this.attachAudio);var toolbarRendered=$.Deferred(),audioReady=$.Deferred();this.parent.toolbar.bind("render",function(){toolbarRendered.resolve()},this),a5.service.media.audio.bind("ready",function(){audioReady.resolve()},this),this._ready=$.when(toolbarRendered,audioReady)},ready:function(){return this._ready},render:function(){return this._super(),this.attachAudioOnce(),this.node},attachAudio:function(){this.ready().then(function(){this.$toolbar=this.parent.$("#audio-toolbar"),this.player=a5.service.media.audio.create(this.ref,{preload:!a5.dp.config.audioPreloadDisabled,persistVolume:a5.dp.config.audioVolumeStore}),this.node.attr("data-playable-media",this.player.uid),a5.model_builder.audioVideoUtils.addAudioPlayerEvents(this.player,this.$toolbar),this.player.bind("stopped paused",function(){this.node.removeClass("playing"),this.playing=!1},this),this.player.bind("stopped",function(){this.$toolbar.removeClass("active"),this.$toolbar.attr("aria-expanded",!1),this.parent.$alert&&(this.parent.$alert.empty(),this.parent.$alert.html(a5.service.templates.render(this.announceCloseTemplate))),this.active=!1,this.$toolbar.find(":focus").length>0&&this.node.focus()},this),this.player.bind("start",function(){this.node.addClass("playing"),this.$toolbar.addClass("active"),this.$toolbar.attr("aria-expanded",!0),this.parent.$alert&&(this.parent.$alert.empty(),this.parent.$alert.html(a5.service.templates.render(this.announceOpenTemplate))),this.active=!0,this.playing=!0,this.$toolbar.find(":focus").length||this.$toolbar.find(":focusable:first").focus()},this),a5.eventBus.bind("audio-toolbar:stop",this.player.stop,this.player)}.bind(this))},bindToolbarEvents:function(){a5.model_builder.audioVideoUtils.removeInterfaceEvents(this.$toolbar,this.player),a5.model_builder.audioVideoUtils.addInterfaceEvents(this.$toolbar,this.player),a5.model_builder.audioVideoUtils.linkSubtitles(this.subtitles,this.interaction,this.$toolbar,this.player),a5.model_builder.audioVideoUtils.linkTranscript(this.transcript,this.interaction,this.$toolbar,this.player,$()),this.player.trigger("volume")},open:function(){this._super(),this.playing?this.player.pause():(this.active||(this.player.position(0),this.$toolbar.find(".duration").html(a5.utils.seconds_to_text(Math.floor(this.player.duration()/1e3))),a5.eventBus.trigger("book:open_audio_hotspot",this.ref,{mode:"toolbar"})),a5.service.media.pauseAllExcept(this.player),this.player.play(),this.bindToolbarEvents()),this.opened=!0},close:function(){this.opened&&(this.player.stop(),this.opened=!1,this.$toolbar.find(":focus").length>0&&this.node.focus())},onClickOpen:function(e){e.stopPropagation(),this.opened||this.model.tryCloseAllHotspots(),this.open()}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotAudioToolbar"),a5.views.interaction.PPEbookHotspotVideo={type:"video",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.ref=$node.attr("ref"),this.subtitles=$node.children("subtitles"),this.transcript=$node.children("transcript"),this.contentLeft=$node.attr("content-left"),this.contentTop=$node.attr("content-top"),this.interaction=model.parent,_.bindAll(this,"onClose","onOpen","attachVideo"),this.$dialog=$(a5.mainBuilder.layout.getTemplate("ebook_hotspot_tip")),this.attachVideoOnce=_.once(this.attachVideo)},render:function(){return this._super(),this.$dialog.addClass([this.icon,this.shape,"hotspot-dialog-video"].join(" ")),a5.dp.config.draggableHotspotWindow&&this.$dialog.draggable(_.extend({cancel:".media-footer, .close",containment:"document",create:_.partial(_.defer,this.draggableRemoveMarginsOnCreate),stop:function(ev){$(ev.originalEvent.target).one("click",function(e){e.stopImmediatePropagation()})}},a5.dp.config.draggableHotspotWindow)),this.$dialog.css({left:_.isUndefined(this.contentLeft)?"":this.contentLeft+"px",top:_.isUndefined(this.contentTop)?"":this.contentTop+"px",marginTop:_.isUndefined(this.contentTop)?"":0,marginLeft:_.isUndefined(this.contentLeft)?"":0}),this.video=this.attachVideoOnce(),this.$dialog.find(".modal-body").append(this.video.$html),this.$modal=this.$dialog.modal({backdrop:a5.dp.config.bookHotspotPopupModal,show:!1}),this.$modal.on("shown",this.onOpen),this.$modal.on("hidden",this.onClose),this.node},open:function(){this._super(),this.$modal.modal("show")},close:function(){this.$modal&&this.$modal.modal("hide")},onClose:function(){this.video.instance.stop(),a5.eventBus.trigger("transcript:close")},onOpen:function(){this.video.instance.adjustSize()},onFullscreenChange:function(fullscreen){fullscreen?this.$dialog.draggable("disable"):this.$dialog.draggable("enable")},attachVideo:function(){var $html=$(window.a5.mainBuilder.layout.getTemplate("video_widget")),$inlineTranscript=$(window.a5.mainBuilder.layout.getTemplate("media_transcript")),$target=$html.find(".the_video"),video=a5.service.media.video.create(this.ref,$target);return a5.model_builder.audioVideoUtils.addVideoPlayerEvents(video,$html),a5.model_builder.audioVideoUtils.linkSubtitles(this.subtitles,this.interaction,$html,video),a5.model_builder.audioVideoUtils.linkTranscript(this.transcript,this.interaction,$html,video,$inlineTranscript),a5.dp.config.draggableHotspotWindow&&video.bind("fullscreenchange",this.onFullscreenChange,this),{$html:$inlineTranscript.length?$('<div class="transcript-wrap video">').append($html).append($inlineTranscript):$html,instance:video}}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotVideo"),a5.views.interaction.PPEbookHotspotPageLink={type:"page-link",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.pageNumber=parseInt($node.attr("page"),10)||0,this.book=$node.attr("book")||null,this.model=model},open:function(){this._super(),this.book?a5.eventBus.trigger("book:open_page_link_hotspot",this.book,this.pageNumber):this.model.openPageNumber(this.pageNumber)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotPageLink"),a5.views.interaction.PPEbookHotspotSingleStructure={type:"structure-single",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.ref=$node.attr("ref")},open:function(){this._super(),a5.eventBus.trigger("book:open_structure_hotspot",this.ref)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotSingleStructure"),a5.views.interaction.PPEbookHotspotMultipleStructure={type:"structure-multiple",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.ref=$node.attr("ref"),this.items=[],$node.find("> children > node").each(function(index,child){var $child=$(child),className=$child.find("> children").length>0?"PPEbookHotspotMultipleStructure":"PPEbookHotspotSingleStructure",hotspot=new a5.views.interaction[className](model,parent,$child);hotspot.icon=$child.attr("icon"),hotspot.shape=$child.attr("shape")||"",_.each(["top","left","width","height"],function(attr){hotspot[attr]=parseInt($child.attr(attr),10)}),this.items.push(hotspot)}.bind(this))},closeItems:function(){_(this.items).each(function(item){item.node.remove()})},open:function(){if(this.opened=!this.opened,this.node.toggleClass("active",this.opened),!this.opened)return void this.closeItems();this._super(),_(this.items).each(function(item){this.node.append(item.render())},this),a5.eventBus.trigger("book:open_structure_hotspot",this.ref)}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotMultipleStructure"),a5.views.interaction.PPEbookHotspotMenu={type:"menu",template:"a5.view.hotspot.Menu",menuTemplate:"a5.view.dialog.HotspotMenu",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.items=[],this.itemRefs=[],$node.find("> items > item").each(function(index,item){var $item=$(item);this.itemRefs.push($item.attr("ref"))}.bind(this)),_.bindAll(this,"onClickItem","onBlur","onKeydown","onKeydownItem"),$(document).on("click",this.onBlur),this.parent.bind("render",this.onBookRendered,this)},render:function(){return this._super(),this._bindMenuEvents(),this.node},close:function(){this.opened&&(this.$el.hide(),this.$clickTarget.attr("aria-expanded",!1),this.node.removeClass("in-front"),this.$clickTarget.focus(),this.opened=!1)},open:function(){this.opened||(this._adjustMenuPosition(),this.$el.show(),this.focusFirst(),this.node.addClass("in-front"),this.$clickTarget.attr("aria-expanded",!0),this.opened=!0)},focusFirst:function(){this.$firstItem.focus()},focusNext:function($li){var $next=$li.next();$next.length||($next=this.$firstItem),$next.focus()},focusPrev:function($li){var $prev=$li.prev();$prev.length||($prev=this.$lastItem),$prev.focus()},onBlur:function(e){$.contains(this.$el[0],e.srcElement)||this.close()},onClickItem:function(e){e.preventDefault(),e.stopPropagation(),this.close();var $li=$(e.target).closest(".hotspot-menu-item"),id=$li.attr("data-hotspot-id");this._findItemById(id).open()},onKeydown:function(e){e.which===a5.utils.keyCodes.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.close())},onKeydownItem:function(e){var key=e.which,$li=$(e.target).closest(".hotspot-menu-item");if(key===a5.utils.keyCodes.SPACE||key===a5.utils.keyCodes.ENTER){e.stopPropagation(),e.preventDefault(),this.close();var id=$li.attr("data-hotspot-id");this._findItemById(id).open()}else key===a5.utils.keyCodes.DOWN||key===a5.utils.keyCodes.RIGHT?(e.stopPropagation(),e.preventDefault(),this.focusNext($li)):key===a5.utils.keyCodes.UP||key===a5.utils.keyCodes.LEFT?(e.stopPropagation(),e.preventDefault(),this.focusPrev($li)):key===a5.utils.keyCodes.TAB&&(e.stopPropagation(),e.preventDefault(),this.close())},onClickOpen:function(e){e.stopPropagation(),this.opened?this.close():(this.$clickTarget=$(e.target),this.model.tryCloseAllHotspots(),this.open())},onBookRendered:function(){this._initItems(),this._renderItems(),this._renderBadge()},_bindMenuEvents:function(){this.$el&&(this.$el.off(),this.$el.on("click",".hotspot-menu-item",this.onClickItem),this.$el.on("keydown",".hotspot-menu-item",this.onKeydownItem),this.$el.on("keydown",this.onKeydown))},_initItems:function(){this.items=_.chain(this.itemRefs).map(function(ref){return this.model.getHotspotById(ref)},this).compact().value();var itemsCountClass="empty-menu";this.items.length>1?itemsCountClass="multiple-items-menu":1===this.items.length&&(itemsCountClass="single-item-menu"),this.node.addClass(itemsCountClass),_.each(this.items,function(item){item.node.addClass("belongs-to-menu belongs-to-"+itemsCountClass)})},_renderItems:function(){var html=a5.service.templates.render(this.menuTemplate,{items:this.items}),$html=$(html);this.$el=$html,this.$firstItem=this.$el.find(".hotspot-menu-item").first(),this.$lastItem=this.$el.find(".hotspot-menu-item").last(),this._bindMenuEvents(),this.node.append(this.$el)},_renderBadge:function(){var $badge=$('<div class="badge"></div>');$badge.append(this.items.length),this.node.prepend($badge)},_findItemById:function(id){return _.find(this.items,function(item){return item.id===id})},_adjustMenuPosition:function(){this.$el.removeClass("overflow-bottom overflow-right overflow-left"),this.$el.css("visibility","hidden"),this.$el.show();var bbox=this.$el[0].getBoundingClientRect(),pageBox=this.$el.closest(".page")[0].getBoundingClientRect(),viewportBox=this.parent.pages.node[0].getBoundingClientRect(),overflowBottom=bbox.bottom>viewportBox.bottom,overflowRight=bbox.right>pageBox.right,overflowLeft=bbox.left<pageBox.left;this.$el.toggleClass("overflow-bottom",overflowBottom),this.$el.toggleClass("overflow-right",overflowRight),this.$el.toggleClass("overflow-left",overflowLeft),this.$el.hide(),this.$el.css("visibility","")}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotMenu"),a5.views.interaction.PPEbookHotspotSolutionsGroup={type:"solutions-group",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.items=[],this.itemRefs=[],this.next=0,$node.find("> items > single-solution").each(function(index,item){var $item=$(item);this.itemRefs.push($item.attr("ref"))}.bind(this)),this.parent.bind("render",this.onBookRendered,this)},close:function(){this.next=0,_.invoke(this.items,"close")},canClose:function(){return!1},open:function(){this.model.unbind("page_change",this.onPageChange),this.model.bind("page_change",this.onPageChange,this,{once:!0}),this.cycle()},cycle:function(){this.next===this.items.length?_.invoke(this.items,"close"):this.items[this.next].open(),this.next=(this.next+1)%(this.items.length+1)},onClickOpen:function(e){e.stopPropagation(),this.open()},onBookRendered:function(){this._initItems()},_initItems:function(){this.items=_.chain(this.itemRefs).map(function(ref){return this.model.getHotspotById(ref)},this).compact().value(),_.each(this.items,function(item){item.node.addClass("hotspot--belongsToSolutionGroup")})}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotSolutionsGroup"),a5.views.interaction.PPEbookHotspotSingleSolution={type:"single-solution",init:function(model,parent,$node,options){this._super(model,parent,$node,options),this.interaction=model.parent},render:function(){return this._super(),this.node.hasClass("hotspot--belongsToSolutionGroup")&&this.disable(),this.node},serialize:function(){if(this.opened)return{x:this.left,y:this.top,width:this.width,height:this.height}},toSVG:function(){if(this.opened){var rect=document.createElementNS("http://www.w3.org/2000/svg","rect");return rect.setAttribute("x",this.left),rect.setAttribute("y",this.top),rect.setAttribute("width",this.width),rect.setAttribute("height",this.height),rect}},open:function(){this.opened||(this._super(),this.opened=!0,this.trigger("change"))},close:function(){this.opened=!1,this.trigger("change")},canClose:function(){return!1},onClickOpen:function(e){e.stopPropagation(),this.opened?this.close():this.open()}},a5.views.interaction.PPEbookHotspot.extend("a5.views.interaction.PPEbookHotspotSingleSolution"),a5.view.PPEbookResourcesPanelDialog={template:"ebook_resourcesPanel",init:function(model){this._super(),this.resourcesPanel=new a5.views.interaction.PPEbookResourcesPanel(model),this.model=model,this.$el.addClass("resources-panel-popup")},onShow:function(){this.$el.find("iframe").attr("src",this.resourcesPanel.resourcesUrl()),this._super()},onShown:function(){this.$el.find("iframe").focus(),this._super()}},a5.view.PPEbookDialog.extend("a5.view.PPEbookResourcesPanelDialog"),a5.view.PPEbookResourcesPanelSidebar={template:"ebook_resourcesPanel",init:function(model){this._super(),model.bind("change:resourcePanelMode",_.bind(function(options){this.$el.removeClass("resources-panel-mode-"+options.oldMode),this.$el.addClass("resources-panel-mode-"+options.newMode)},this)),this.resourcesPanel=new a5.views.interaction.PPEbookResourcesPanel(model),this.model=model,this.$el.addClass("resources-panel-popup")},open:function(){var resourcesUrl=this.resourcesPanel.resourcesUrl(),iframe=this.$el.find("iframe");iframe.attr("src")!=resourcesUrl&&(iframe.replaceWith(this.resourcesPanel.template),this.$el.find("iframe").attr("src",resourcesUrl)),this.model.openSidebar="resources",this._super()},close:function(){delete this.model.openSidebar,this._super()}},a5.view.PPEbookSidebar.extend("a5.view.PPEbookResourcesPanelSidebar"),a5.views.interaction.PPEbookResourcesPanel={template:'<iframe frameborder="0" height="100%" width="100%"></iframe>',init:function(model,parent){this.$el=$("<div>",{class:"resources-panel"}),this.model=model},render:function(){return this.$el.html(this.template),this.$el},resourcesUrl:function(){return a5.service.lms.API.getEbookResourcesUrl(this.model.page,this.model.offset)}},Obj.extend("a5.views.interaction.PPEbookResourcesPanel"),a5.vendoredCssName=function(property){var element=$("<div/>")[0],properties=_.map(["","Webkit","Moz","ms","O"],function(prefix){return prefix+property});return _.find(properties,function(property){return!_.isUndefined(element.style[property])})},a5.views.interaction.PPEbookScroller={minZoom:1,maxZoom:1,left:0,top:0,zoom:null,step:.2,marqueeStep:.2,wheelStep:.2,pinchStep:.2,keyboardPanStep:20,wheelPan:!1,init:function($node,$content,params){this._super(null,params.parent,$node),this.$content=$content,this.step=params.step||this.step,this.marqueeStep=params.marqueeStep||this.marqueeStep,this.wheelStep=params.wheelStep||this.wheelStep,this.pinchStep=params.pinchStep||this.pinchStep,this.keyboardPanStep=params.keyboardPanStep||this.keyboardPanStep,this.wheelPan=params.wheelPan||this.wheelPan,this.panOffset=0},zoomTo:function(value,orig){orig=orig||{x:0,y:0};var newZoom=this.inBounds(value,this.minZoom,this.maxZoom),prevZoom=this.zoom||newZoom,scalechange=newZoom/prevZoom,x=scalechange*(orig.x+this.left),y=scalechange*(orig.y+this.top);this.zoom=newZoom,this.left=x-orig.x,this.top=y-orig.y,this.reposition(),this.trigger("zoom_changed",newZoom,prevZoom)},zoomIn:function(){var value=1+this.step;null!=this.nextZoomIn&&(value=this.nextZoomIn,this.nextZoomIn=null),this._round(this.zoom*(1+this.step),6)>this._round(this.maxZoom,6)?this.nextZoomOut=this.zoom/this.maxZoom:this.nextZoomOut=null,this.zoomBy(value)},zoomOut:function(){var value=1/(1+this.step);null!=this.nextZoomOut&&(value=this.nextZoomOut,this.nextZoomOut=null),this._round(this.zoom/(1+this.step),6)<this._round(this.minZoom,6)?this.nextZoomIn=this.zoom/this.minZoom:this.nextZoomIn=null,this.zoomBy(value)},zoomBy:function(value,origin){this.zoomTo(this.zoom*value,origin)},resetZoom:function(){this.left=0,this.top=0,this.zoom=null,this.zoomTo(this.initialScale)},onPinch:function(e){var touches=e.gesture.pointers,delta=e.gesture.scale>1?1:-1;if(touches.length>1){var orig=this.calculateOrigin((touches[0].pageX+touches[1].pageX)/2,(touches[0].pageY+touches[1].pageY)/2);this.zoomBy(Math.pow(1+this.pinchStep,delta),orig)}},calculateOrigin:function(xx,yy){return{x:xx-this.wrapperPosition.left-this.wrapperOuterWidth/2,y:yy-this.wrapperPosition.top-(this.wrapperOuterHeight-this.wrapperHeight)/2}},onMouseWheel:function(e,delta){if(!this.isMousePressed)if(delta=delta>0?1:-1,this.wheelPan)delta>0?this.panUp():this.panDown();else{var orig=this.calculateOrigin(e.pageX,e.pageY);this.zoomBy(Math.pow(1+this.wheelStep,delta),orig)}},onPanStart:function(e){if(this.initialZoom=this.zoom,this.initialTop=this.top,this.initialLeft=this.left,this.marqueeZoomEnabled&&(this.$marqueeBox.css({width:0,height:0}),this.$marqueeBox.appendTo(this.node)),e.gesture&&"mouse"===e.gesture.pointerType&&"text"===$(e.gesture.target).css("cursor"))return e.preventDefault(),e.stopPropagation(),this.node.data("hammer").stop(),!1},onDragStart:function(e){this.initialZoom=this.zoom,this.initialTop=this.top,this.initialLeft=this.left,this.marqueeZoomEnabled&&(this.$marqueeBox.css({width:0,height:0}),this.$marqueeBox.appendTo(this.node))},onDrag:function(e){var touches=e.gesture.pointers,initialX=touches[0].pageX-e.gesture.deltaX,initialY=touches[0].pageY-e.gesture.deltaY,finalX=touches[0].pageX,finalY=touches[0].pageY,left=Math.min(initialX,finalX),top=Math.min(initialY,finalY);this.marqueeZoomEnabled?this.$marqueeBox.css({left:left-this.wrapperPosition.left,top:top-this.wrapperPosition.top,width:Math.abs(e.gesture.deltaX)+"px",height:Math.abs(e.gesture.deltaY)+"px"}):(this.left=this.initialLeft-e.gesture.deltaX*this.zoom,this.top=this.initialTop-e.gesture.deltaY*this.zoom,this.reposition())},onDragEnd:function(e){if(this.marqueeZoomEnabled){this.disableMarqueeZoom();var value=Math.min(this.wrapperWidth/Math.abs(e.gesture.deltaX),this.wrapperHeight/Math.abs(e.gesture.deltaY)),touches=e.gesture.pointers,initialX=touches[0].pageX-e.gesture.deltaX,initialY=touches[0].pageY-e.gesture.deltaY,finalX=touches[0].pageX,finalY=touches[0].pageY,centerX=(finalX-initialX)/2+initialX,centerY=(finalY-initialY)/2+initialY,orig=this.calculateOrigin(centerX,centerY);this.zoomBy(value,orig);var viewportCenterX=$(window).width()/2,viewportCenterY=$(window).height()/2,viewportOrig=this.calculateOrigin(viewportCenterX,viewportCenterY);this.left=this.left+orig.x-viewportOrig.x,this.top=this.top+orig.y-viewportOrig.y,this.reposition(),this.$marqueeBox.detach()}},onSlide:function(evt){this.zoomTo(evt.target.value/100)},onClick:function(e){if(this.marqueeZoomEnabled){this.disableMarqueeZoom();var orig=this.calculateOrigin(e.pageX,e.pageY);this.zoomBy(1+this.marqueeStep,orig)}},panUp:function(){var top=this.top;return this.top-=this.keyboardPanStep*this.zoom,this.reposition(),top!==this.top},panDown:function(){var top=this.top;return this.top+=this.keyboardPanStep*this.zoom,this.reposition(),top!==this.top},panLeft:function(){var left=this.left;return this.left-=this.keyboardPanStep*this.zoom,this.reposition(),left!==this.left},panRight:function(){var left=this.left;return this.left+=this.keyboardPanStep*this.zoom,this.reposition(),left!==this.left},toggleMarqueeZoom:function(){this.marqueeZoomEnabled=!this.marqueeZoomEnabled,this.marqueeZoomEnabled?(this.panEnabled=!1,window.a5a&&a5a.useTool("cursor"),this.disableSwipe()):this.enableSwipe(),this.attachFileEnabled=!1,this.trigger("marquee_toggled")},disableMarqueeZoom:function(){this.marqueeZoomEnabled=!1,this.trigger("marquee_toggled"),this.enableSwipe()},toggleHand:function(){this.panEnabled||(this.panEnabled=!0,this.marqueeZoomEnabled=!1,this.attachFileEnabled=!1,this.trigger("hand_toggled"))},disableHand:function(){this.panEnabled=!1,this.trigger("hand_toggled")},toggleAttachFile:function(){this.attachFileEnabled=!this.attachFileEnabled,this.attachFileEnabled&&window.a5a&&a5a.useTool("cursor"),this.marqueeZoomEnabled=!1,this.trigger("attach_file_toggled"),a5.eventBus.trigger("attach_file_toggled",this.attachFileEnabled)},disableAttachFile:function(){this.attachFileEnabled=!1,this.trigger("attach_file_toggled"),a5.eventBus.trigger("attach_file_toggled",!1)},addPanOffset:function(offset){this.panOffset=offset},resetPanOffset:function(){this.panOffset=0,this.reposition()},disableSwipe:function(){this.node.data("hammer").get("swipe").set({enable:!1}),a5.eventBus.trigger("swipe-disabled")},enableSwipe:function(){this.node.data("hammer").get("swipe").set({enable:!0}),a5.eventBus.trigger("swipe-enabled")},updateSize:function(contentWidth,contentHeight,initialScale,onePageWidth,onePageHeight,options){this.contentWidth=contentWidth,this.contentHeight=contentHeight,this.wrapperWidth=this.node.width(),this.wrapperOuterWidth=this.node.outerWidth(),this.wrapperHeight=this.node.height(),this.wrapperOuterHeight=this.node.outerHeight(),this.wrapperPosition=this.node.offset();var defaultInitialView=Math.min(this.wrapperWidth/contentWidth,this.wrapperHeight/contentHeight);a5.dp.config.bookZoomMax?this.maxZoom=parseInt(a5.dp.config.bookZoomMax,10)/100:this.maxZoom=Math.max(1,this.wrapperWidth/onePageWidth,this.wrapperHeight/onePageHeight),a5.dp.config.bookZoomMin?this.minZoom=parseInt(a5.dp.config.bookZoomMin,10)/100:this.minZoom=defaultInitialView;var prevInitialScale=this.initialScale;this.initialScale=initialScale?this.inBounds(this.wrapperWidth/contentWidth*initialScale,this.minZoom,this.maxZoom):Math.max(defaultInitialView,this.minZoom),prevInitialScale||(prevInitialScale=this.initialScale);var scale;this.zoom&&options&&options.afterPageChange&&a5.dp.config.bookZoomPreserve&&(scale=this.zoom),this.zoom&&this.zoom>prevInitialScale&&options&&options.afterResize&&(scale=this.zoom*this.initialScale/prevInitialScale),this.zoomTo(scale||this.initialScale),this.$content.css({height:contentHeight,width:contentWidth}),this.trigger("size_updated")},render:function(){this.node.hammer({cssProps:{userSelect:"none"}});var hammertime=this.node.data("hammer");hammertime.get("pan").set({direction:Hammer.DIRECTION_ALL}),hammertime.get("pinch").set({enable:!0}),this.$content.css(a5.vendoredCssName("TransformOrigin"),"center top"),this.bindNodeD("panstart",this.onPanStart),this.bindNodeD("transformstart",this.onDragStart),this.bindNodeD("mousewheel",this.onMouseWheel),this.bindNodeD("pinch",this.onPinch),this.bindNodeD("panmove",this.onDrag),this.bindNodeD("click",this.onClick),this.bindNodeD("panend transformend",this.onDragEnd),this.bindNode("mousedown",function(e){this.isMousePressed=!0,a5.mainBuilder.$body.find("#content_wrap .header").css("user-select","none"),this.parent.parent.toolbar.node.css("user-select","none")}),$(document).on("mouseup",function(e){this.isMousePressed=!1,a5.mainBuilder.$body.find("#content_wrap .header").css("user-select",""),this.parent.parent.toolbar.node.css("user-select","")}.bind(this)),this.$marqueeBox=$('<div class="marquee-box"></div>')},_round:function(number,decimals){return parseFloat(number.toFixed(decimals))},roundedLeft:function(){return this._round(-this.left,6)},roundedTop:function(){return this._round(-this.top,6)},isLastZoomIn:function(){return this._round(this.zoom,6)>=this._round(this.maxZoom,6)},isLastZoomOut:function(){return this._round(this.zoom,6)<=this._round(this.minZoom,6)},isZoomedIn:function(){return this._round(this.zoom,6)>this._round(this.initialScale,6)},isInitialZoom:function(){return this._isWithinHalfAStep(this.zoom,this.initialScale)},_isWithinHalfAStep:function(value1,value2){var minStep=Math.min(this.wheelStep,this.pinchStep),halfStepMultiplier=1+minStep/2,lower=value2/halfStepMultiplier,upper=value2*halfStepMultiplier;return lower<value1&&value1<upper},computeScrollBoundaries:function(){var zoomedWidth=this.contentWidth*this.zoom,zoomedHeight=this.contentHeight*this.zoom,offset=this.panOffset-(this.wrapperWidth-zoomedWidth)/2;offset=this.inBounds(offset,0,this.panOffset);var boundaries={};return boundaries.maxLeft=_.max([(zoomedWidth-this.wrapperWidth)/2,0]),boundaries.maxTop=_.max([zoomedHeight-this.wrapperHeight,0]),boundaries.minLeft=-(boundaries.maxLeft+offset),boundaries.minTop=0,boundaries},inBounds:function(value,min,max){return value>max?max:value<min?min:value},reposition:function(){var bounds=this.computeScrollBoundaries();this.left=this.inBounds(this.left,bounds.minLeft,bounds.maxLeft),this.top=this.inBounds(this.top,bounds.minTop,bounds.maxTop),this.renderReposition(),this.trigger("repositioned")},renderReposition:function(){var property=a5.vendoredCssName("Transform");return property?function(){this.$content.css(property,"translate("+this._round(-(this.left+this.contentWidth/2))+"px,"+this._round(-this.top)+"px) scale("+this._round(this.zoom,6)+")")}:function(){this.$content.css({marginLeft:this._round(-(this.left+this.contentWidth*this.zoom/2)/this.zoom,6)+"px",marginTop:this._round(-this.top/this.zoom,6)+"px",zoom:this._round(this.zoom,6)||""})}}()},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPEbookScroller"),a5.view.PPEbookTOCDialog={template:"ebook_toc",init:function(book){this._super(),this.toc=new a5.views.interaction.PPEbookTOC(book),this.book=book,this.$el.addClass("toc-popup"),this.toc.bind("select:entry",this._onSelectEntry,this)},renderContent:function(){var $title=this.$el.find("h3");$title.attr("data-without-title")||$title.text(this.book.title+" - "+($title.text()||"Table of contents"));var $thumbnail=this.$el.find(".thumbnail");this.book.pages[0].thumbnail&&$thumbnail.length>0&&$thumbnail.html('<img src="'+this.book.pages[0].thumbnail+'"/>'),this.$el.find(".page-count").text(this.book.pageCount);var $toc=this.toc.render();this.$el.find(".modal-body").html($toc)},append:function(entry){this.toc.append(entry)},onOpen:function(){this._super(),this.toc.focus()},_onSelectEntry:function(){this.close()}},a5.view.PPEbookDialog.extend("a5.view.PPEbookTOCDialog"),a5.view.PPEbookTOCSidebar={template:"ebook_toc",init:function(book){this._super(),this.toc=new a5.views.interaction.PPEbookTOC(book),this.book=book,this.$el.addClass("toc-popup"),this.toc.bind("select:entry",this._onSelectEntry,this)},renderContent:function(){var $title=this.$el.find("h3");$title.attr("data-without-title")||$title.text(this.book.title+" - "+($title.text()||"Table of contents"));var $thumbnail=this.$el.find(".thumbnail");this.book.pages[0].thumbnail&&$thumbnail.length>0&&$thumbnail.html('<img src="'+this.book.pages[0].thumbnail+'"/>'),this.$el.find(".page-count").text(this.book.pageCount);var $toc=this.toc.render();this.$el.find(".modal-body").html($toc)},append:function(entry){this.toc.append(entry)},_onSelectEntry:function(){this.close()},open:function(){this.book.openSidebar="toc",this._super(),this.toc.focus()},close:function(){delete this.book.openSidebar,this._super()}},a5.view.PPEbookSidebar.extend("a5.view.PPEbookTOCSidebar"),a5.views.interaction.PPEbookTOC={init:function(book){this.book=book,this.$el=$("<ol>",{class:"toc"}),this.children=[],this.book.bind("page_change",this._onPageChange,this),this.book.bind("restore",this._onBookRestore,this)},
append:function(entry){this.children.push(entry),entry.bind("select",this._onSelectEntry,this)},render:function(){return this._renderChildren(),this._highlightEntry(),this.$el},getEntriesByRange:function(leftPage,rightPage){var candidates=[];return _(this.children).each(function(entry){if(entry instanceof a5.views.interaction.PPEbookTOCEntry){var range=entry.getRange();(range.start<=leftPage&&leftPage<=range.end||range.start<=rightPage&&rightPage<=range.end)&&candidates.push(entry)}entry.isLeaf()||(candidates=entry.getEntriesByRange(leftPage,rightPage).concat(candidates))},this),candidates},focus:function(){var $current=this.$el.find(".highlighted");$current.length&&$current.focus()},_onSelectEntry:function(entry){this.book.openPageNumber(entry.startPageNumber),this.trigger("select:entry")},_onPageChange:function(){this._highlightEntry()},_onBookRestore:function(){this._highlightEntry()},_highlightEntry:function(){this.$el.find(".highlighted").removeClass("highlighted");var candidates=this.getEntriesByRange(this.book.current.from,this.book.current.to-1),selected=_(candidates).chain().sortBy(function(candidate){var range=candidate.getRange();return range.end-range.start}).first().value();if(selected){var eventNode=selected.$el.find("[data-event=activate]");eventNode.length?eventNode.addClass("highlighted"):selected.$el.addClass("highlighted")}},_renderChildren:function($target){$target=$target||this.$el,_.isString($target)&&($target=this.$el.find($target));var fragment=document.createDocumentFragment();_.each(this.children,function(child){var $node=child.render&&child.render()||child.$el;$node&&fragment.appendChild($node[0])}),$target.append(fragment)}},Obj.extend("a5.views.interaction.PPEbookTOC"),a5.views.interaction.PPEbookTOCEntry={template:"ebook_toc_entry",init:function(book,text,startPageNumber,endPageNumber,pageLabel){this.$el=$("<li>",{class:"toc-entry"}),this.book=book,this.page=this.book.getPageByPageNumber(startPageNumber),this.page&&(this.thumbnail=this.page.thumbnail),this.text=text,this.startPageNumber=startPageNumber,this.endPageNumber=endPageNumber,this.pageLabel=pageLabel||startPageNumber,this.children=[],_.bindAll(this,"_onClick");this.$el.find("[data-event=activate]").length?this.$el.on("click","[data-event=activate]",this._onClick):this.$el.on("click",this._onClick)},append:function(entry){this.children.push(entry),entry.bind("select",this._onSelectEntry,this)},render:function(){this.$el.html(a5.mainBuilder.layout.getTemplate(_(this).result("template")));var $thumbnail=this.$el.find(".thumbnail");if(this.thumbnail&&$thumbnail.length>0){var $thumbnailImage=$('<img src="'+this.thumbnail+'"/>');$thumbnail.html($thumbnailImage)}return this.$el.find(".title").text(this.text),this.$el.find(".page-number").text(this.pageLabel),this._renderChildren(this.$el.find("> ol")),this.trigger("render"),this.$el},getRange:function(){return{start:this.book.printedPageToPageIndex(this.startPageNumber),end:this.book.printedPageToPageIndex(this.endPageNumber)}},isLeaf:function(){return 0===this.children.length},getEntriesByRange:function(leftPage,rightPage){var candidates=[];return _(this.children).each(function(entry){if(entry instanceof a5.views.interaction.PPEbookTOCEntry){var range=entry.getRange();(range.start<=leftPage&&leftPage<=range.end||range.start<=rightPage&&rightPage<=range.end)&&candidates.push(entry)}entry.isLeaf()||(candidates=entry.getEntriesByRange(leftPage,rightPage).concat(candidates))},this),candidates},_onClick:function(e){e.stopPropagation(),this.trigger("select",this)},_onSelectEntry:function(entry){this.trigger("select",entry)},_renderChildren:function($target){$target=$target||this.$el,_.isString($target)&&($target=this.$el.find($target));var fragment=document.createDocumentFragment();_.each(this.children,function(child){var $node=child.render&&child.render()||child.$el;$node&&fragment.appendChild($node[0])}),$target.append(fragment)}},Obj.extend("a5.views.interaction.PPEbookTOCEntry"),a5.views.interaction.PPEbookTOCSection={template:"ebook_toc_section",defaultTemplate:'<span class="title"></span><ol></ol>',init:function(book,text){this.$el=$("<li>",{class:"toc-section"}),this.book=book,this.text=text,this.children=[]},append:function(entry){this.children.push(entry),entry.bind("select",this._onSelectEntry,this)},render:function(){var html=a5.mainBuilder.layout.getTemplate(_(this).result("template"));return this.$el.html(html||this.defaultTemplate),this.$el.find(".title").text(this.text),this._renderChildren(this.$el.find("> ol")),this.trigger("render"),this.$el},isLeaf:function(){return!1},getEntriesByRange:function(leftPage,rightPage){var candidates=[];return _(this.children).each(function(entry){if(entry instanceof a5.views.interaction.PPEbookTOCEntry){var range=entry.getRange();(range.start<=leftPage&&leftPage<=range.end||range.start<=rightPage&&rightPage<=range.end)&&candidates.push(entry)}entry.isLeaf()||(candidates=entry.getEntriesByRange(leftPage,rightPage).concat(candidates))},this),candidates},_onSelectEntry:function(entry){this.trigger("select",entry)},_renderChildren:function($target){$target=$target||this.$el,_.isString($target)&&($target=this.$el.find($target));var fragment=document.createDocumentFragment();_.each(this.children,function(child){var $node=child.render&&child.render()||child.$el;$node&&fragment.appendChild($node[0])}),$target.append(fragment)}},Obj.extend("a5.views.interaction.PPEbookTOCSection"),Obj.extend("a5.Annotations",{init:function(options){a5a=this,this.defaults={language:"en",stage:"annotations",appendTo:null,intView:null,displayAsPopup:!0,stickyNoteWithTitle:!1,stickyNoteMinSize:!1},this.options=$.extend({},this.defaults,options),this.intView=this.options.intView,this.config=new a5.Annotations.Config,this.i18n=this.config.i18n,this.current=new a5.Annotations.Current,this.history=new a5.Annotations.History,this.stage=null,this.toolbox=new a5.Annotations.Toolbox,this.cursor=new a5.Annotations.Cursor,this.options.keyboard&&(this.keyboard=new a5.Annotations.KeyboardEvents),this.API=a5.service.lms.API,this.API&&this.API.getData("annotations").done(_.bind(function(annotations){this.current.fromObject(annotations)},this))},allocate:function(interaction){this.current.drawings[interaction.index]||(this.current.drawings[interaction.index]=new a5.Annotations.Drawing)},activate:function(interactions){this.stage&&this.stage.destroy(),_.isArray(interactions)||(interactions=[interactions]),this.stage=new a5.Annotations.Stage(interactions),this.current.view.activate(),this.history.view.activate()},deactivate:function(){},useTool:function(identifier){var tool;tool="number"==typeof identifier?this.toolbox.tools[identifier]:_.find(this.toolbox.tools,function(tool){return identifier==tool.name}),this.toolbox.select(tool,!0)},save:function(){var data=this.current.serialize();_.isEmpty(data.annotations)&&!this.current.hasChanges||this.API.setData("annotations",this.current.serialize()),this.current.changed(!1)}}),Obj.extend("a5.Annotations.C",{init:function(){a5a.config&&(this.i18n=a5a.config.i18n),_.bindAll(this,"i18n")}}),a5.Annotations.C.extend("a5.Annotations.ConfigController",{init:function(){this._super()}}),a5.Annotations.C.extend("a5.Annotations.CurrentController",{init:function(){this.view=new a5.Annotations.CurrentView(this)}}),a5.Annotations.C.extend("a5.Annotations.HistoryController",{init:function(){this._super(),this.view=new a5.Annotations.HistoryView(this)},expectChange:function(drawing){a5a.stage.drawing=drawing,drawing.nextBefore=a5a.stage.drawing.serialize(!0)},expectBatchChange:function(){var drawings=_.values(a5a.current.drawings);_.each(drawings,function(drawing){_.isUndefined(drawing.annotation)||this.expectChange(drawing)},this)},takeBatchSnapshot:function(){var drawings=_.values(a5a.current.drawings),snapshots=_.chain(drawings).filter(function(drawing){return!_.isUndefined(drawing.annotation)}).map(function(drawing){return new a5.Annotations.Moment({annotation:drawing.annotation,before:drawing.nextBefore,after:drawing.serialize(!0)})}).value();this.level>0&&this.reset(),this.snapshots.unshift(snapshots),this.trim(),this.view.update()},takeSnapshot:function(){var drawing=a5a.stage.drawing||a5a.stage.view.$.get(0).drawingInstance,snapshot=new a5.Annotations.Moment({annotation:drawing.annotation,before:drawing.nextBefore,after:drawing.serialize(!0)});this.level>0&&this.reset(),this.snapshots.unshift(snapshot),this.trim(),this.view.update()},undo:function(){if(this.level<this.snapshots.length){this.level++;var snapshot=this.snapshots[this.level-1];_.isArray(snapshot)?_.invoke(snapshot,"undo"):snapshot.undo(),this.view.update(),a5.hooks.ppebookHistoryUndo.call()}},redo:function(){if(this.level>0){var snapshot=this.snapshots[this.level-1];_.isArray(snapshot)?_.invoke(snapshot,"redo"):snapshot.redo(),this.level--,this.view.update(),a5.hooks.ppebookHistoryRedo.call()}},reset:function(){this.snapshots.splice(0,this.level),this.level=0},trim:function(){this.snapshots.length>this.levels&&this.snapshots.pop()}}),a5.Annotations.C.extend("a5.Annotations.MomentController",{init:function(data){this._super(data)},undo:function(){var drawing=a5a.current.drawings[this.annotation];drawing.removeAllFeatures(!0),drawing.fromObject(this.before),a5a.stage.view.redraw()},redo:function(){var drawing=a5a.current.drawings[this.annotation];drawing.removeAllFeatures(!0),drawing.fromObject(this.after),a5a.stage.view.redraw()},trash:function(){}}),a5.Annotations.C.extend("a5.Annotations.StageController",{init:function(interactions){this.view=new a5.Annotations.StageView(this,interactions)},last:function(){return this.drawing.last()},toggle:function(){this.visible=!this.visible,this.view.toggle()},destroy:function(){this.view.destroy()}}),a5.Annotations.C.extend("a5.Annotations.CursorController",{init:function(){this.view=new a5.Annotations.CursorView(this)},select:function(tool){this.tool=tool.name,this.view.update()}}),a5.Annotations.C.extend("a5.Annotations.ToolboxController",{init:function(){this._super(),this.view=this.displayAsPopup?new a5.Annotations.ToolboxPopupView(this):new a5.Annotations.ToolboxStaticView(this)},use:function(tools){this.tools=_.filter(tools,function(tool){return!$(tool.exclude).length}),this.length=this.tools.length,this.view.onToolsChanged&&this.view.onToolsChanged()},specific:function(specifics){_.each(specifics,function(properties,tool){var theTool=_.find(this.tools,function(t){return tool==t.name});_.extend(theTool,properties)},this)},tool:function(name){return _.find(this.tools,function(tool){if(tool.name==name)return tool})||{}},select:function(tool,quiet){this.view.$.is(".lifted")||(this.trigger("toolbox:beforeSelect",tool),tool.isSelectable?(this.selected&&this.selected.deselect&&this.selected.deselect(),this.selected=a5a.current.tool=tool,tool.select&&tool.select(),this.view.select(quiet),this.trigger("toolbox:select",tool)):(tool.action(),"hide"===tool.name&&this.view.update&&this.view.update()))}}),a5.Annotations.C.extend("a5.Annotations.ToolController",{init:function(){this.view=new a5.Annotations.ToolView(this),this.isPressed=!1},press:function(x,y,e,ev){var isEraser="eraser"===a5a.toolbox.selected.name;$("body").removeClass("isInputing");var drawing=e.target.drawingInstance||a5a.stage.drawing;a5a.history.expectChange(drawing),isEraser||drawing.addFeature(e,ev),a5a.current.tool.palette&&(this.color=a5a.current.tool.palette.selected),a5a.current.tool.thicknessList&&(this.thickness=a5a.current.tool.thicknessList.selected),this.start=new a5.Annotations.Point(x,y),this.points?(this.points=[],this.points.push(this.start)):isEraser||a5a.stage.last().content.view.render(),$("body").disableSelection(),this.isPressed=!0},drag:function(x,y,e,ev){this.isPressed&&(this.points||"spotlight"===a5a.toolbox.selected.name)&&(this.end=new a5.Annotations.Point(x,y),this.points&&this.points.push(this.end),"eraser"!==a5a.toolbox.selected.name&&a5a.stage.last().content.view.preview(this.end,e,ev))},lift:function(x,y,e,ev){this.isPressed&&(this.end=new a5.Annotations.Point(x,y),this.points&&(this.points.push(this.end),a5a.stage.last().content.view.render(this.points)),"eraser"!==a5a.toolbox.selected.name&&a5a.stage.last().content.view.postview(this.end,e,ev),"spotlight"!==a5a.toolbox.selected.name&&a5a.current.changed(!0),$("body").enableSelection()),this.isPressed=!1}}),a5.Annotations.C.extend("a5.Annotations.ColorPaletteController",{init:function(tool,colors){this.tool=tool,this.view=new a5.Annotations.ColorPaletteView(this),this.select()},select:function(color,dont_close,quiet){color=color||this.colors[0],this.selected=color,this.view.select(dont_close),quiet||this.trigger("select",color)},cycle:function(){var index=_.indexOf(this.colors,this.selected)+1;this.select(this.colors[index],!0)}}),a5.Annotations.C.extend("a5.Annotations.ColorController",{init:function(color){}}),a5.Annotations.C.extend("a5.Annotations.ThicknessListController",{init:function(tool,thicknesses){this.tool=tool,this.view=new a5.Annotations.ThicknessSelectorView(this),this.select()},select:function(thickness,dont_close,quiet){thickness=thickness||this.thicknesses[0],this.selected=thickness,this.view.select(dont_close),quiet||this.trigger("select",thickness)},cycle:function(){var index=_.indexOf(this.thicknesses,this.selected)+1;this.select(this.thicknesses[index],!0)}}),a5.Annotations.C.extend("a5.Annotations.ThicknessController",{init:function(thickness){}}),a5.Annotations.C.extend("a5.Annotations.DrawingController",{init:function(payload){},addFeature:function(e,ev){a5a.stage.drawing=this,a5a.stage.view.$current=a5a.stage.view.$.not(function(){return this!=e.target}),a5a.stage.view.$.find(".content-block-out").each(function(){this.annotationsFeature&&this.annotationsFeature.remove()});var feature=new a5.Annotations.Feature(this,{content:{x:a5a.current.view.coord(ev,"x",a5a.stage.view.$current),y:a5a.current.view.coord(ev,"y",a5a.stage.view.$current)}});feature.contentClass&&"BlockOut"!=feature.contentType&&this.features.push(feature)},removeFeature:function(feature){var index=_.indexOf(this.features,feature);index>=0&&this.features.splice(index,1),this.hasChanges=!0},removeAllFeatures:function(silent){silent||a5a.history.expectChange(this);var features=this.features.slice(0);_.each(features,function(feature){feature.isExportable&&(this.removeFeature(feature),feature.content.remove())},this),silent||a5a.current.changed(!0),this.hasChanges=!0},last:function(){return"BlockOut"==a5a.toolbox.selected.type?a5a.stage.view.$current.find(".content-block-out")[0].annotationsFeature:this.features.slice(-1)[0]}}),a5.Annotations.C.extend("a5.Annotations.FeatureController",{init:function(context,payload){},share:function(){return!!this.isExportable&&(a5a.history.expectChange(this.drawing),this.lock=!this.lock,a5a.current.changed(!0),this.content.view.reportSharingChange(),this.lock)},remove:function(){this.isExportable&&(a5a.history.expectChange(this.drawing),this.drawing.removeFeature(this),this.content.remove(),a5a.current.changed(!0))}}),Obj.extend("a5.Annotations.Content",{}),a5.Annotations.C.extend("a5.Annotations.Content.StrokeController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.StrokeView(this,annotation)},remove:function(){this.view.$.remove()}}),a5.Annotations.C.extend("a5.Annotations.Content.TextController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.TextView(this,annotation)},remove:function(){this.view.$.remove(),a5.eventBus.trigger("book:text_deleted")}}),a5.Annotations.C.extend("a5.Annotations.Content.LinkController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.LinkView(this,annotation)},remove:function(){this.view.$.remove(),a5.eventBus.trigger("book:link_deleted")}}),a5.Annotations.C.extend("a5.Annotations.Content.BlockController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.BlockView(this,annotation)},remove:function(){this.view.$.remove(),a5.eventBus.trigger("book:sticky_note_deleted")}}),a5.Annotations.C.extend("a5.Annotations.Content.BlockOutController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.BlockOutView(this,annotation)},remove:function(){this.view.$.remove(),this.view.$others.remove()}}),a5.Annotations.C.extend("a5.Annotations.Content.InverseMaskController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.InverseMaskView(this,annotation)},remove:function(){this.view.$.remove()}}),a5.Annotations.C.extend("a5.Annotations.Content.MaskController",{init:function(annotation,payload){this._super(),this.view=new a5.Annotations.Content.MaskView(this,annotation)},remove:function(){this.view.$.remove()}}),a5.Annotations.C.extend("a5.Annotations.StrokeSegmentController",{init:function(annotation,x,y){this.annotation=annotation,this.view=new a5.Annotations.StrokeSegmentView(this,x,y),this.previous=void 0,this.next=void 0},push:function(x,y){return this.x=Math.min(x,this.x),this.y=Math.min(y,this.y),this.view.extentX=Math.max(x,this.view.extentX),this.view.extentY=Math.max(y,this.view.extentY),this.view.width=this.view.extentX-this.x,this.view.height=this.view.extentY-this.y,!(this.length>1&&(this.view.width>a5a.current.tool.maxSegmentPerimeter||this.view.height>a5a.current.tool.maxSegmentPerimeter))&&(this.length=this.points.push(new a5.Annotations.Point(x,y)),!0)}}),a5.Annotations.C.extend("a5.Annotations.PointController",{init:function(x,y){}}),a5.Annotations.C.extend("a5.Annotations.KeyboardEventsController",{init:function(){this._super(),_.bindAll(this,"fireEvent"),this.view=new a5.Annotations.KeyboardEventsView(this),$(document).on("keydown",this.fireEvent)},fireEvent:function(e){if(!(e.originalEvent.repeat||$("body .modal.in").length||$("body").is(".fullscreen")&&27===e.which)){var self=this,modifiers=[],type=$(e.target).is(":input:not(button),[contenteditable]")?"key:input:":"key:";e.shiftKey&&modifiers.push("shift"),e.ctrlKey&&modifiers.push("ctrl"),e.altKey&&modifiers.push("alt");var key=this.nameEventKey(e);key&&""!=key&&$.each(key.split(" "),function(){var keys=modifiers.concat(this.toLowerCase()),main=key[key.length-1];self.view.$node.trigger("annotations:"+type+keys.join("+"),main)})}},nameEventKey:function(e){var name;return!!e.which&&(name=this.key[e.which],name||(name=String.fromCharCode(e.which)),""==name&&(name=e.which),name)}}),a5.Annotations.ConfigController.extend("a5.Annotations.Config",{init:function(){this._super(),this.focusToClickDelay=100,this.historyLevels=100,this.stickyNoteBorder=2,this.stickyNoteThreshold=30,this.defaultCursorColor="black",this.referenceStageWidth=810,this.defaultStickyNoteSize=260,this.defaultTextSize=[40,40],this.defaultLinkSize=[260,80],this.minStickyNoteSize=!!a5a.options.stickyNoteMinSize&&this.defaultStickyNoteSize*parseInt(a5a.options.stickyNoteMinSize,10)/100,this.defaultMaskSize=500,this.stickyNoteWithTitle=a5a.options.stickyNoteWithTitle,this.language=a5a.options.language,this.vocabulary={en:_.extend({undoTool:"Undo",redoTool:"Redo",cursorTool:'<span class="keyboard-key">C</span>ursor',penTool:'<span class="keyboard-key">P</span>en',highlighterTool:'<span class="keyboard-key">H</span>ighlighter',eraserTool:'<span class="keyboard-key">E</span>raser',stickyNoteTool:'<span class="keyboard-key">S</span>ticky Note',textTool:'<span class="keyboard-key">T</span>ext',linkTool:'<span class="keyboard-key">L</span>ink',spotlightTool:'Spotli<span class="keyboard-key">g</span>ht',inverseMaskTool:"Inverse mask",maskTool:"Mask",saveTool:"Save",hideTool:"Hide",showTool:"Show",clearTool:"Clear",clearAllTool:"Clear All",undoToolHint:"Undo last action",redoToolHint:"Redo last undone action",cursorToolHint:"Cursor",penToolHint:"Pen Tool",highlighterToolHint:"Highlighter Tool",eraserToolHint:"Eraser Tool",stickyNoteDefaultTitle:"Untitled",stickyNoteToolHint:"Sticky Note Tool",stickyNoteCollapseHint:"Collapse this sticky note",stickyNoteExpandHint:"Expand sticky note",stickyNoteShareHint:"Share this sticky note with others",stickyNoteUnshareHint:"Revoke sharing of this sticky note",stickyNoteTrashHint:"Delete this sticky note",stickyNoteResizeHint:"Drag this corner to resize",textHandleHint:"Move this text",textToolHint:"Text Tool",textTrashHint:"Delete this text",linkCollapseHint:"Collapse this link",linkExpandHint:"Expand link",linkHandleHint:"Move this link",linkToolHint:"Link Tool",linkTrashHint:"Delete this link",spotlightToolHint:"Spotlight Tool",inverseMaskToolHint:"Inverse Mask Tool",maskToolHint:"Mask Tool",saveToolHint:"Save changes",hideToolHint:"Show/hide annotations",clearToolHint:"Delete annotations",clearAllToolHint:"Delete all annotations",toolboxDragHint:"You can drag the toolbox over to anywhere on the screen",redColor:"Red",blueColor:"Blue",greenColor:"Green",grayColor:"Gray",blackColor:"Black",yellowColor:"Yellow",pinkColor:"Pink",limeColor:"Lime",violetColor:"Violet",orangeColor:"Orange",turquoiseColor:"Turquoise",lightyellowColor:"Light yellow",lightgreyColor:"Light grey",lightblueColor:"Light blue",lightgreenColor:"Light green",lightpinkColor:"Light red",smallThickness:"small",bigThickness:"big",unsavedContentWarning:"Caution: There are some unsaved annotations on this page. If you wish to save them before leaving, choose to stay on the page. To continue without saving choose to leave the page.",stickyNoteTrashQuestionTitle:"Confirm delete",stickyNoteTrashQuestion:"Are you sure you want to delete this Sticky Note?\nClick OK to confirm or Cancel to go back.",stickyNoteSharedTrashQuestion:"Are you sure you want to delete this shared Sticky Note?\nIt will be deleted for everybody you share it with.\nClick OK to confirm or Cancel to go back.",stickyNoteTrashOKLabel:"OK",stickyNoteTrashCancelLabel:"Cancel",stickyNoteShareAnnouncement:"OK, the note will be shared to others after you save changes.\nClick the share icon again to unshare.",stickyNoteUnshareAnnouncement:"OK, this note will no longer be shared with others.\nDon't forget to save your changes.",textTrashQuestionTitle:"Confirm delete",textTrashQuestion:"Are you sure you want to delete this Text?\nClick OK to confirm or Cancel to go back.",textTrashOKLabel:"OK",textTrashCancelLabel:"Cancel",linkTrashQuestionTitle:"Confirm delete",linkTrashQuestion:"Are you sure you want to delete this Link?\nClick OK to confirm or Cancel to go back.",linkTrashOKLabel:"OK",linkTrashCancelLabel:"Cancel",missingApiWarning:"Author API Not Found.",key:{toolCursor:"annotations:key:c annotations:key:esc annotations:key:input:esc",toolPen:"annotations:key:p",toolHighlighter:"annotations:key:h",toolEraser:"annotations:key:e",toolStickyNote:"annotations:key:s",toolSpotlight:"annotations:key:g",toolText:"annotations:key:t",toolLink:"annotations:key:l"}},A5.ANNOTATIONS_VOCABULARY.en),cs:_.extend({undoTool:"ZpÄt",redoTool:"Znovu",cursorTool:'<span class="keyboard-key">K</span>urzor',penTool:'<span class="keyboard-key">P</span>ero',highlighterTool:'<span class="keyboard-key">Z</span>vÃ½razovaÄ',eraserTool:'<span class="keyboard-key">G</span>uma',stickyNoteTool:'PoznÃ¡<span class="keyboard-key">m</span>ka',textTool:'<span class="keyboard-key">T</span>ext',spotlightTool:'<span class="keyboard-key">V</span>ysvÃ­cenÃ­',inverseMaskTool:"Inverse mask",maskTool:"Mask",saveTool:"UloÅ¾it",hideTool:"SkrÃ½t",showTool:"Zobrazit",clearTool:"Clear",penToolHint:"NÃ¡stroj pero",highlighterToolHint:"NÃ¡stroj zvÃ½razovaÄ",eraserToolHint:"NÃ¡stroj guma",stickyNoteDefaultTitle:"Untitled",stickyNoteToolHint:"NÃ¡stroj poznÃ¡mka",stickyNoteCollapseHint:"Sbalit tuto poznÃ¡mku",stickyNoteExpandHint:"Rozbalit poznÃ¡mku",stickyNoteShareHint:"SdÃ­let tuto poznÃ¡mku s ostatnÃ­mi",stickyNoteUnshareHint:"PÅestat sdÃ­let tuto poznÃ¡mku",stickyNoteTrashHint:"Smazat tuto poznÃ¡mku",stickyNoteResizeHint:"TaÅ¾enÃ­m tohoto rohu zmÄnÃ­te velikost",textHandleHint:"TÃ¡hnout",textToolHint:"TextovÃ½ nÃ¡stroj",textTrashHint:"Smazat tuto textovÃ½",linkCollapseHint:"Collapse this link",linkExpandHint:"Expand link",linkHandleHint:"Move this link",linkToolHint:"Link Tool",linkTrashHint:"Delete this link",spotlightToolHint:"NÃ¡stroj vysvÃ­cenÃ­",inverseMaskToolHint:"Inverse Mask Tool",maskToolHint:"Mask Tool",cursorToolHint:"Kurzor",undoToolHint:"VrÃ¡tit zpÄt poslednÃ­ akci",redoToolHint:"Zopakovat poslednÄ vrÃ¡cenou akci",saveToolHint:"UloÅ¾it zmÄny",hideToolHint:"Zobrazit/skrÃ½t anotace",clearToolHint:"Delete annotations",toolboxDragHint:"Paletu s nÃ¡stroji mÅ¯Å¾ete pÅemÃ­stit kamkoliv po obrazovce",redColor:"ÄervenÃ¡",blueColor:"ModrÃ¡",greenColor:"ZelenÃ¡",grayColor:"Å edÃ¡",blackColor:"ÄernÃ¡",yellowColor:"Å½lutÃ¡",pinkColor:"Pink",limeColor:"LimetkovÃ¡",violetColor:"RÅ¯Å¾ovÃ¡",orangeColor:"OranÅ¾ovÃ¡",turquoiseColor:"TyrkysovÃ¡",lightyellowColor:"SvÄtle Å¾lutÃ¡",lightgreyColor:"SvÄtle Å¡edÃ¡",lightblueColor:"SvÄtle modrÃ¡",lightgreenColor:"SvÄtle zelenÃ¡",lightpinkColor:"SvÄtle ÄervenÃ¡",smallThickness:"small",bigThickness:"big",unsavedContentWarning:"VarovÃ¡nÃ­: Na strÃ¡nce jsou nÄkterÃ© neuloÅ¾enÃ© anotace. Pokud je chcete pÅed odchodem uloÅ¾it, zvolte zÅ¯stat na strÃ¡nce. Nebo pokraÄujte bez uloÅ¾enÃ­ opuÅ¡tÄnÃ­m tÃ©to strÃ¡nky.",stickyNoteTrashQuestionTitle:"Confirm delete",stickyNoteTrashQuestion:"Opravdu chcete tuto poznÃ¡mku vymazat?\nPro potvrzenÃ­ zvolte OK nebo se vraÅ¥te volbou ZruÅ¡it.",stickyNoteTrashOKLabel:"OK",stickyNoteTrashCancelLabel:"Cancel",stickyNoteShareAnnouncement:"OK, poznÃ¡mka bude sdÃ­lena s ostatnÃ­mi, jakmile zmÄny uloÅ¾Ã­te.\nKliknÄte znovu pro zruÅ¡enÃ­ sdÃ­lenÃ­.",stickyNoteUnshareAnnouncement:"OK, tato poznÃ¡mka nebude jiÅ¾ nadÃ¡le sdÃ­lena s ostatnÃ­mi.\nNezapomete zmÄny uloÅ¾it.",textTrashQuestionTitle:"Confirm delete",textTrashQuestion:"Opravdu chcete tuto textovÃ½ vymazat?\nPro potvrzenÃ­ zvolte OK nebo se vraÅ¥te volbou ZruÅ¡it.",textTrashOKLabel:"OK",textTrashCancelLabel:"Cancel",linkTrashQuestionTitle:"Confirm delete",linkTrashQuestion:"Are you sure you want to delete this Link?\nClick OK to confirm or Cancel to go back.",linkTrashOKLabel:"OK",linkTrashCancelLabel:"Cancel",missingApiWarning:"Author API nenalezeno.",key:{toolCursor:"annotations:key:k annotations:key:esc annotations:key:input:esc",toolPen:"annotations:key:p",toolHighlighter:"annotations:key:z",toolEraser:"annotations:key:g",toolStickyNote:"annotations:key:m",toolSpotlight:"annotations:key:v",toolText:"annotations:key:t",toolLink:"annotations:key:l"}},A5.ANNOTATIONS_VOCABULARY.cs),de:_.extend({undoTool:"RÃ¼ckgÃ¤ngig",redoTool:"Wiederholen",cursorTool:'<span class="keyboard-key">A</span>uswahl',penTool:'<span class="keyboard-key">S</span>tift',highlighterTool:'<span class="keyboard-key">M</span>arker',eraserTool:'<span class="keyboard-key">R</span>adiergummi',stickyNoteTool:'<span class="keyboard-key">N</span>otiz',textTool:'<span class="keyboard-key">T</span>ext',spotlightTool:'<span class="keyboard-key">H</span>ervorheben',inverseMaskTool:"Inverse mask",maskTool:"Mask",saveTool:"Speichern",hideTool:"Ausblenden",showTool:"Einblenden",clearTool:"Clear",clearAllTool:"Clear All",undoToolHint:"Letzte Aktion rÃ¼ckgÃ¤ngig machen",redoToolHint:"Letzte Aktion wiederherstellen",cursorToolHint:"Cursor",penToolHint:"Stift-Werkzeug",highlighterToolHint:"Marker-Werkzeug",eraserToolHint:"Radiergummi",stickyNoteDefaultTitle:"Untitled",stickyNoteToolHint:"Notiz-Werkzeug",stickyNoteCollapseHint:"Notiz einklappen",stickyNoteExpandHint:"Notiz ausklappen",stickyNoteShareHint:"Notiz mit anderen teilen",stickyNoteUnshareHint:"Notiz nicht lÃ¤nger mit anderen teilen",stickyNoteTrashHint:"Notiz lÃ¶schen",stickyNoteResizeHint:"Diese Ecke ziehen um die GrÃ¶Ãe zu verÃ¤ndern",textHandleHint:"Verschieben",textToolHint:"Text einfÃ¼gen",textTrashHint:"LÃ¶schen",linkCollapseHint:"Collapse this link",linkExpandHint:"Expand link",linkHandleHint:"Move this link",linkToolHint:"Link Tool",linkTrashHint:"Delete this link",spotlightToolHint:"Hervorheben-Werkzeug",inverseMaskToolHint:"Inverse Mask Tool",maskToolHint:"Mask Tool",saveToolHint:"Speichern",hideToolHint:"Anmerkungen einblenden / ausblenden",clearToolHint:"Delete annotations",clearAllToolHint:"Delete all annotations",toolboxDragHint:"Werkzeugleiste verschieben",redColor:"Rot",blueColor:"Blau",greenColor:"GrÃ¼n",grayColor:"Grau",blackColor:"Schwarz",yellowColor:"Gelb",pinkColor:"Pink",limeColor:"Limettenfarben",violetColor:"Violett",orangeColor:"Orange",turquoiseColor:"TÃ¼rkis",lightyellowColor:"Gelb",lightgreyColor:"Grau",lightblueColor:"Blau",lightgreenColor:"GrÃ¼n",lightpinkColor:"Rot",smallThickness:"small",bigThickness:"big",unsavedContentWarning:"Achtung: Einige Ãnderungen auf dieser Seite wurden noch nicht gespeichert. Um sie zu speichern, bleibe auf der Seite. Um ohne Speichern fortzufahren, verlasse die Seite.",stickyNoteTrashQuestionTitle:"LÃ¶schen bestÃ¤tigen",stickyNoteTrashQuestion:"Diese Notiz lÃ¶schen? OK fÃ¼r LÃ¶schen, anderenfalls Abbrechen auswÃ¤hlen.",stickyNoteSharedTrashQuestion:"Diese mit anderen geteilte Notiz lÃ¶schen?\nSie wird fÃ¼r alle gelÃ¶scht, mit denen sie geteilt ist.\nOK fÃ¼r LÃ¶schen, anderenfalls Abbrechen auswÃ¤hlen.",stickyNoteTrashOKLabel:"OK",stickyNoteTrashCancelLabel:"Abbrechen",stickyNoteShareAnnouncement:"OK, diese Notiz wird mit anderen geteilt nach dem die Ãnderungen gespeichert wurden\ncon nochmals klicken, um rÃ¼ckgÃ¤ngig zu machen.",stickyNoteUnshareAnnouncement:"OK, diese Notiz wird nicht mehr mit anderen geteilt.\nÃnderungen speichern nicht vergessen.",textTrashQuestionTitle:"LÃ¶schen bestÃ¤tigen",textTrashQuestion:"Diese Text lÃ¶schen? OK fÃ¼r LÃ¶schen, anderenfalls Abbrechen auswÃ¤hlen.",textTrashOKLabel:"OK",textTrashCancelLabel:"Abbrechen",linkTrashQuestionTitle:"Confirm delete",linkTrashQuestion:"Are you sure you want to delete this Link?\nClick OK to confirm or Cancel to go back.",linkTrashOKLabel:"OK",linkTrashCancelLabel:"Cancel",missingApiWarning:"Author API nicht gefunden.",key:{toolCursor:"annotations:key:a annotations:key:esc annotations:key:input:esc",toolPen:"annotations:key:s",toolHighlighter:"annotations:key:m",toolEraser:"annotations:key:r",toolStickyNote:"annotations:key:n",toolSpotlight:"annotations:key:h",toolText:"annotations:key:t",toolLink:"annotations:key:l"}},A5.ANNOTATIONS_VOCABULARY.de),es:_.extend({undoTool:"Deshacer",redoTool:"Rehacer",cursorTool:'<span class="keyboard-key">C</span>ursor',penTool:'<span class="keyboard-key">L</span>Ã¡piz',highlighterTool:'<span class="keyboard-key">M</span>arcador',eraserTool:'<span class="keyboard-key">G</span>oma',stickyNoteTool:'<span class="keyboard-key">P</span>ost-it',textTool:'<span class="keyboard-key">T</span>exto',spotlightTool:'<span class="keyboard-key">F</span>oco',inverseMaskTool:"Inverse mask",maskTool:"Mask",saveTool:"Guardar",hideTool:"Ocultar",showTool:"Mostrar",clearTool:"Clear",clearAllTool:"Clear All",undoToolHint:"Deshacer",redoToolHint:"Rehacer",cursorToolHint:"Cursor",penToolHint:"LÃ¡piz",highlighterToolHint:"Marcador",eraserToolHint:"Goma",stickyNoteDefaultTitle:"Sin tÃ­tulo",stickyNoteToolHint:"Post-it",stickyNoteCollapseHint:"Ocultar el Post-it",stickyNoteExpandHint:"Mostrar el Post-it",stickyNoteShareHint:"Share this sticky note with others",stickyNoteUnshareHint:"Revoke sharing of this sticky note",stickyNoteTrashHint:"Eliminar el Post-it",stickyNoteResizeHint:"Arrastrar la esquina del Post-it para modificar su tamaÃ±o",textHandleHint:"Mover el texto",textToolHint:"Texto",textTrashHint:"Eliminar el texto",linkCollapseHint:"Ocultar el enlace",linkExpandHint:"Mostrar el enlace",linkHandleHint:"Mover el enlace",linkToolHint:"Link",linkTrashHint:"Eliminar el enlace",spotlightToolHint:"Foco",inverseMaskToolHint:"Inverse Mask Tool",maskToolHint:"Mask Tool",saveToolHint:"Guardar",hideToolHint:"Mostrar/ocultar las anotaciones",clearToolHint:"Delete annotations",clearAllToolHint:"Delete all annotations",toolboxDragHint:"Puedes mover la barra de herramientas a cualquier parte de la pantalla",redColor:"Rojo",blueColor:"Azul",greenColor:"Verde",grayColor:"Gris",blackColor:"Negro",yellowColor:"Amarillo",pinkColor:"Rosa",limeColor:"Verde",
violetColor:"Violeta",orangeColor:"Naranja",turquoiseColor:"Turquesa",lightyellowColor:"Amarillo",lightgreyColor:"Gris",lightblueColor:"Azul",lightgreenColor:"Verde",lightpinkColor:"Rosa",smallThickness:"small",bigThickness:"big",unsavedContentWarning:"AtenciÃ³n: no has guardado todas tus anotaciones en esta pÃ¡gina. Si quieres guardarlas antes de salir, no cierres la pÃ¡gina del libro y haz clic en Guardar en la barra de herramientas. Si quieres seguir sin guardarlas, puedes cerrar la pÃ¡gina del libro.",stickyNoteTrashQuestionTitle:"Confirm delete",stickyNoteTrashQuestion:"Â¿EstÃ¡s seguro/a de que quieras eliminar este post-it?\nHaz clic en Aceptar para confirmarlo o en Cancelar para volver atrÃ¡s.",stickyNoteSharedTrashQuestion:"Are you sure you want to delete this shared Sticky Note?\nIt will be deleted for everybody you share it with.\nClick OK to confirm or Cancel to go back.",stickyNoteTrashOKLabel:"OK",stickyNoteTrashCancelLabel:"Cancel",stickyNoteShareAnnouncement:"OK, the note will be shared to others after you save changes.\nClick the share icon again to unshare.",stickyNoteUnshareAnnouncement:"OK, this note will no longer be shared with others.\nDon't forget to save your changes.",textTrashQuestionTitle:"Borrar texto",textTrashQuestion:"Â¿EstÃ¡s seguro/a de que quieres eliminar este texto?\nHaz clic en Aceptar para confirmarlo o en Cancelar para volver atrÃ¡s.",textTrashOKLabel:"Aceptar",textTrashCancelLabel:"Cancelar",linkTrashQuestionTitle:"Borrar enlace",linkTrashQuestion:"Â¿EstÃ¡s seguro/a de que quieres eliminar este enlace?\nHaz clic en Aceptar para confirmarlo o en Cancelar para volver atrÃ¡s.",linkTrashOKLabel:"OK",linkTrashCancelLabel:"Cancel",missingApiWarning:"Author API Not Found.",key:{toolCursor:"annotations:key:c annotations:key:esc annotations:key:input:esc",toolPen:"annotations:key:l",toolHighlighter:"annotations:key:m",toolEraser:"annotations:key:g",toolStickyNote:"annotations:key:p",toolSpotlight:"annotations:key:f",toolText:"annotations:key:t",toolLink:"annotations:key:l"}},A5.ANNOTATIONS_VOCABULARY.es),fr:_.extend({undoTool:"Annuler",redoTool:"RÃ©tablir",cursorTool:'<span class="keyboard-key">C</span>urseur',penTool:'Cra<span class="keyboard-key">y</span>on',highlighterTool:'<span class="keyboard-key">S</span>urligneur',eraserTool:'<span class="keyboard-key">G</span>omme',stickyNoteTool:'<span class="keyboard-key">P</span>ost-it',textTool:'<span class="keyboard-key">T</span>exte',spotlightTool:'<span class="keyboard-key">F</span>ocus',inverseMaskTool:"Inverse mask",maskTool:"Mask",saveTool:"Enregistrer",hideTool:"Cacher",showTool:"Montrer",clearTool:"Clear",clearAllTool:"Clear all",undoToolHint:"Annuler",redoToolHint:"RÃ©tablir",cursorToolHint:"Curseur",penToolHint:"Crayon",highlighterToolHint:"Surligneur",eraserToolHint:"Gomme",stickyNoteDefaultTitle:"Untitled",stickyNoteToolHint:"Post-it",stickyNoteCollapseHint:"Cacher le Post-it",stickyNoteExpandHint:"Montrer le Post-it",stickyNoteShareHint:"Share this sticky note with others",stickyNoteUnshareHint:"Revoke sharing of this sticky note",stickyNoteTrashHint:"Eliminer le Post-it",stickyNoteResizeHint:"Ãtirer le coin du Post-it pour le redimensionner",textHandleHint:"DÃ©placer le texte",textToolHint:"Texte",textTrashHint:"Eliminer le texte",linkCollapseHint:"Collapse this link",linkExpandHint:"Expand link",linkHandleHint:"Move this link",linkToolHint:"Link Tool",linkTrashHint:"Delete this link",spotlightToolHint:"Focus",inverseMaskToolHint:"Inverse Mask Tool",maskToolHint:"Mask Tool",saveToolHint:"Enregistrer",hideToolHint:"Montrer/cacher les annotations",clearToolHint:"Delete annotations",clearAllToolHint:"Delete all annotations",toolboxDragHint:"Vous pouvez dÃ©placer la barre dâoutils nâimporte oÃ¹ sur lâÃ©cran",redColor:"Rouge",blueColor:"Bleu",greenColor:"Vert",grayColor:"Gris",blackColor:"Noir",yellowColor:"Jaune",pinkColor:"Pink",limeColor:"Vert",violetColor:"Violet",orangeColor:"Orange",turquoiseColor:"Turquoise",lightyellowColor:"Jaune",lightgreyColor:"Gris",lightblueColor:"Bleu",lightgreenColor:"Vert",lightpinkColor:"Rose",smallThickness:"small",bigThickness:"big",unsavedContentWarning:"Attention : vous nâavez pas sauvegardÃ© toutes vos annotations. Si vous souhaitez les sauvegarder, ne fermez pas la page du livre et cliquez sur Enregistrer dans la barre dâoutils. Si vous ne souhaitez pas les sauvegarder, vous pouvez fermer la page du livre.",stickyNoteTrashQuestionTitle:"Confirm delete",stickyNoteTrashQuestion:"Vous allez supprimer ce Post-it. \nCliquez sur Accepter pour le supprimer ou Annuler pour revenir en arriÃ¨re.",stickyNoteTrashOKLabel:"OK",stickyNoteTrashCancelLabel:"Cancel",stickyNoteSharedTrashQuestion:"Are you sure you want to delete this shared Sticky Note?\nIt will be deleted for everybody you share it with.\nClick OK to confirm or Cancel to go back.",stickyNoteShareAnnouncement:"OK, the note will be shared to others after you save changes.\nClick the share icon again to unshare.",stickyNoteUnshareAnnouncement:"OK, this note will no longer be shared with others.\nDon't forget to save your changes.",textTrashQuestionTitle:"Confirm delete",textTrashQuestion:"Vous allez supprimer ce texte. \nCliquez sur Accepter pour le supprimer ou Annuler pour revenir en arriÃ¨re.",textTrashOKLabel:"OK",textTrashCancelLabel:"Cancel",linkTrashQuestionTitle:"Confirm delete",linkTrashQuestion:"Vous allez supprimer ce texte. \nCliquez sur Accepter pour le supprimer ou Annuler pour revenir en arriÃ¨re.",linkTrashOKLabel:"OK",linkTrashCancelLabel:"Cancel",missingApiWarning:"Author API Not Found.",key:{toolCursor:"annotations:key:c annotations:key:esc annotations:key:input:esc",toolPen:"annotations:key:y",toolHighlighter:"annotations:key:s",toolEraser:"annotations:key:g",toolStickyNote:"annotations:key:p",toolSpotlight:"annotations:key:f",toolText:"annotations:key:t",toolLink:"annotations:key:l"}},A5.ANNOTATIONS_VOCABULARY.fr)}},i18n:function(term){return"function"==typeof term&&(term=term()),this.vocabulary[this.language][term]||'translate:"'+term},i18nKey:function(){return this.vocabulary[this.language].key||{}}}),A5.ANNOTATIONS_TOOLBOX=A5.ANNOTATIONS_TOOLBOX||"Undo,Redo,Cursor,Pen,Highlighter,Eraser,StickyNote,Spotlight,Save,Hide",A5.ANNOTATIONS_INITIAL_TOOL=A5.ANNOTATIONS_INITIAL_TOOL||"cursor",A5.ANNOTATIONS_PEN_COLORS=A5.ANNOTATIONS_PEN_COLORS||"red,blue,green,gray,black",A5.ANNOTATIONS_PEN_SIZES=A5.ANNOTATIONS_PEN_SIZES||"small 1.5",A5.ANNOTATIONS_TEXT_COLORS=A5.ANNOTATIONS_TEXT_COLORS||"red,blue,green,black",A5.ANNOTATIONS_TEXT_SIZES=A5.ANNOTATIONS_TEXT_SIZES||"small 12, medium 18, big 24",A5.ANNOTATIONS_HIGHLIGHTER_COLORS=A5.ANNOTATIONS_HIGHLIGHTER_COLORS||"yellow,lime,violet #ee82ee,orange #ffa500,turquoise #40e0d0",A5.ANNOTATIONS_HIGHLIGHTER_SIZES=A5.ANNOTATIONS_HIGHLIGHTER_SIZES||"small 25",A5.ANNOTATIONS_STICKYNOTE_COLORS=A5.ANNOTATIONS_STICKYNOTE_COLORS||"lightyellow,lightgrey,lightblue,lightgreen,lightpink",A5.ANNOTATIONS_VOCABULARY=A5.ANNOTATIONS_VOCABULARY||{},A5.ANNOTATIONS_VOCABULARY={en:A5.ANNOTATIONS_VOCABULARY.en||{},cs:A5.ANNOTATIONS_VOCABULARY.cs||{},de:A5.ANNOTATIONS_VOCABULARY.de||{}},a5.Annotations.CurrentController.extend("a5.Annotations.Current",{init:function(){this._super(),this.tool=void 0,this.drawings={},this.canLock=void 0,this.hasChanges=!1},changed:function(changed){changed&&a5a.history.takeSnapshot(),this.hasChanges=changed,this.view.flagChange()},batchChanged:function(changed){changed&&a5a.history.takeBatchSnapshot(),this.hasChanges=changed,this.view.flagChange()},serialize:function(){return{annotations:function(drawings){var result={};return _.each(drawings,function(drawing,index){var data=drawing.serialize();(data.features.length>0||drawing.hasChanges)&&(result[index]=data,drawing.hasChanges=!1)}),result}(this.drawings)}},fromObject:function(data){data&&(this.canLock=data.locking,_.each(data.annotations,_.bind(function(annotation,index){this.drawings[index]=new a5.Annotations.Drawing(annotation)},this)))}}),a5.Annotations.HistoryController.extend("a5.Annotations.History",{init:function(){this._super(),this.snapshots=[],this.levels=a5a.config.historyLevels,this.level=0}}),a5.Annotations.MomentController.extend("a5.Annotations.Moment",{init:function(data){this._super(data),this.timestamp=new Date,this.annotation=data.annotation,this.before=data.before,this.after=data.after}}),a5.Annotations.StageController.extend("a5.Annotations.Stage",{init:function(interactions){this._super(interactions),this.interaction=interactions,_.defer(this.view.measure),this.drawing=null,this.drawings=_.map(interactions,_.bind(function(interaction,index){return this.view.$[index].drawingInstance=$.extend(a5a.current.drawings[interaction.index],{annotation:interaction.index})},this)),this.visible=!a5a.toolbox.tool("hide").selected}}),a5.Annotations.CursorController.extend("a5.Annotations.Cursor",{init:function(){this._super(),this.tool="cursor"}}),a5.Annotations.ToolboxController.extend("a5.Annotations.Toolbox",{init:function(){this.appendTo=a5a.options.appendTo,this.insideBounds=a5a.options.toolboxInsideBounds,this.displayAsPopup=a5a.options.displayAsPopup,this.tools=[],this.length=0,this.selected=void 0,this.x=0,this.y=0,this.visible=!1,this._super()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Pen",{init:function(){this.i18n=a5a.config.i18n,this.name="pen",this.label=this.i18n("penTool"),this.hint=this.i18n("penToolHint"),this.isSelectable=!0,this.type="Stroke",this.lineCap="round",this.opacity=1,this.palette=new a5.Annotations.ColorPalette(this,A5.ANNOTATIONS_PEN_COLORS.split(/, ?/)),this.thicknessList=new a5.Annotations.ThicknessList(this,A5.ANNOTATIONS_PEN_SIZES.split(/, ?/)),this.maxSegmentPerimeter=5,this.points=[],this._super()},serialize:function(){return{name:this.name,thickness:a5a.current.tool.thicknessList.selected.serialize(),opacity:this.opacity,color:a5a.current.tool.palette.selected.serialize()}},deselect:function(){this.view.colorClosed(),this.view.thicknessClosed()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Highlighter",{init:function(){this.i18n=a5a.config.i18n,this.name="highlighter",this.label=this.i18n("highlighterTool"),this.hint=this.i18n("highlighterToolHint"),this.isSelectable=!0,this.type="Stroke",this.lineCap="butt",this.opacity=.25,this.palette=new a5.Annotations.ColorPalette(this,A5.ANNOTATIONS_HIGHLIGHTER_COLORS.split(/, ?/)),this.thicknessList=new a5.Annotations.ThicknessList(this,A5.ANNOTATIONS_HIGHLIGHTER_SIZES.split(/, ?/)),this.i=0,this.maxSegmentPerimeter=5,this.points=[],this._super()},serialize:function(){return{name:this.name,thickness:a5a.current.tool.thicknessList.selected.serialize(),opacity:this.opacity,color:a5a.current.tool.palette.selected.serialize()}},deselect:function(){this.view.colorClosed(),this.view.thicknessClosed()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Eraser",{init:function(){this.i18n=a5a.config.i18n,this.name="eraser",this.label=this.i18n("eraserTool"),this.hint=this.i18n("eraserToolHint"),this.isSelectable=!0,this.type="Stroke",this.isActive=!1,this._super()},stage_events:{"mousedown.eraser":"activate","mousemove.eraser":"scratchFeatures","mouseup.eraser":"deactivate"},select:function(){this.load(a5a.stage.view)},deselect:function(){this.unload(a5a.stage.view)},load:function(stageView){this._bindEventsToStageView(stageView)},unload:function(stageView){this._unbindEventsFromStageView(stageView)},activate:function(e){this.isActive=!0},deactivate:function(e){this.isActive=!1},scratchFeatures:function(e){if(this.isActive){var $content=$(e.target).parents(".content:not(.content-sticky-note,.content-mask,.content-inverse-mask,.content-link)");if($content.length||($content=$(e.target).filter(".content:not(.content-sticky-note,.content-mask,.content-inverse-mask,.content-link)")),$content.length){$content[0].annotationsFeature.remove()}}},_bindEventsToStageView:function(stageView){_.each(this.stage_events,function(handler,event){stageView.$.bind(event,this[handler])},this)},_unbindEventsFromStageView:function(stageView){_.each(this.stage_events,function(handler,event){stageView.$.unbind(event,this[handler])},this)}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.StickyNote",{init:function(){this.i18n=a5a.config.i18n,this.name="sticky note",this.label=this.i18n("stickyNoteTool"),this.hint=this.i18n("stickyNoteToolHint"),this.isSelectable=!0,this.type="Block",this.palette=new a5.Annotations.ColorPalette(this,A5.ANNOTATIONS_STICKYNOTE_COLORS.split(/, ?/)),this._super()},select:function(){a5a.stage.view.$.find(".content-sticky-note:not(.locked) .text").attr({contentEditable:"true"}),a5a.stage.view.$.find(".content-sticky-note:not(.locked) .title").attr({contentEditable:"true"})},deselect:function(){a5a.stage.view.$.find(".content-sticky-note:not(.locked) .text").attr({contentEditable:"false"}),a5a.stage.view.$.find(".content-sticky-note:not(.locked) .title").attr({contentEditable:"false"})},serialize:function(){return{name:this.name,color:a5a.current.tool.palette.selected.serialize()}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Text",{init:function(){this.i18n=a5a.config.i18n,this.name="text",this.label=this.i18n("textTool"),this.hint=this.i18n("textToolHint"),this.isSelectable=!0,this.type="Text",this.palette=new a5.Annotations.ColorPalette(this,A5.ANNOTATIONS_TEXT_COLORS.split(/, ?/)),this.thicknessList=new a5.Annotations.ThicknessList(this,A5.ANNOTATIONS_TEXT_SIZES.split(/, ?/)),this._super()},select:function(){a5a.stage.view.$.find(".content-text .text").attr({contentEditable:"true"})},deselect:function(){a5a.stage.view.$.find(".content-text .text").attr({contentEditable:"false"})},serialize:function(){return{name:this.name,color:a5a.current.tool.palette.selected.serialize(),size:a5a.current.tool.thicknessList.selected.serialize()}},restore:function(data){var size,color;data.color&&(color=_.find(this.palette.colors,{hex:data.color}),this.palette.select(color,!0,!0)),data.size&&(size=_.find(this.thicknessList.thicknesses,{size:data.size}),this.thicknessList.select(size,!0,!0))}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Link",{init:function(){this.i18n=a5a.config.i18n,this.name="link",this.label=this.i18n("linkTool"),this.hint=this.i18n("linkToolHint"),this.isSelectable=!0,this.type="Link",this._super()},select:function(){a5a.stage.view.$.find(".content-link .text").attr({contentEditable:"true"})},deselect:function(){a5a.stage.view.$.find(".content-link .text").attr({contentEditable:"false"})},serialize:function(){return{name:this.name}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Spotlight",{init:function(){this.i18n=a5a.config.i18n,this.name="spotlight",this.label=this.i18n("spotlightTool"),this.hint=this.i18n("spotlightToolHint"),this.isSelectable=!0,this.type="BlockOut",this.exclude="",this._super()},select:function(){},deselect:function(){},serialize:function(){return{name:this.name}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.InverseMask",{init:function(){this.i18n=a5a.config.i18n,this.name="inverse mask",this.label=this.i18n("inverseMaskTool"),this.hint=this.i18n("inverseMaskToolHint"),this.isSelectable=!0,this.type="InverseMask",this.exclude="",this._super()},select:function(){},deselect:function(){},serialize:function(){return{name:this.name}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Mask",{init:function(){this.i18n=a5a.config.i18n,this.name="mask",this.label=this.i18n("maskTool"),this.hint=this.i18n("maskToolHint"),this.isSelectable=!0,this.type="Mask",this.exclude="",this._super()},select:function(){},deselect:function(){},serialize:function(){return{name:this.name}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Cursor",{init:function(){this.i18n=a5a.config.i18n,this.name="cursor",this.label=this.i18n("cursorTool"),this.hint=this.i18n("cursorToolHint"),this.isSelectable=!0,this.isDeactivating=!0,this.type=null,this._super()},select:function(){a5a.intView&&a5a.intView.pages.scroller&&a5a.intView.pages.scroller.node.data("hammer").get("pan").set({enable:!0})},deselect:function(){a5a.intView&&a5a.intView.pages.scroller&&a5a.intView.pages.scroller.node.data("hammer").get("pan").set({enable:!1})}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Undo",{init:function(){this.i18n=a5a.config.i18n,this.name="undo",this.label=this.i18n("undoTool"),this.hint=this.i18n("undoToolHint"),this.isSelectable=!1,this.type="Action",this._super()},action:function(){a5a.history.undo()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Redo",{init:function(){this.i18n=a5a.config.i18n,this.name="redo",this.label=this.i18n("redoTool"),this.hint=this.i18n("redoToolHint"),this.isSelectable=!1,this.type="Action",this._super()},action:function(){a5a.history.redo()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Save",{init:function(){this.i18n=a5a.config.i18n,this.name="save",this.label=this.i18n("saveTool"),this.hint=this.i18n("saveToolHint"),this.isSelectable=!1,this.type="Action",this._super()},action:function(){a5a.current.hasChanges&&a5a.save()}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Hide",{init:function(){this.i18n=a5a.config.i18n,this.name="hide",this.label=this.i18n("hideTool"),this.hint=this.i18n("hideToolHint"),this.isSelectable=!1,this.type="Action",this.selected=!1,this._super()},action:function(){this.selected=!this.selected,a5a.stage.toggle(),this.view.render({label:this.selected?this.i18n("showTool"):this.i18n("hideTool")})}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.Clear",{init:function(){this.i18n=a5a.config.i18n,this.name="clear",this.label=this.i18n("clearTool"),this.hint=this.i18n("clearToolHint"),this.isSelectable=!1,this.type="Action",this._super()},action:function(){if(!this.open){var dialog=new a5.view.PPEbookClearAnnotationsDialog,$dialog=dialog.render();""!==$dialog.html()?(this.open=!0,dialog.bind("submit",function(){_.each(a5a.stage.drawings,function(drawing){drawing.removeAllFeatures()})}),dialog.bind("close",function(){$dialog.remove(),this.open=!1},this),dialog.open()):_.each(a5a.stage.drawings,function(drawing){drawing.removeAllFeatures()})}}}),a5.Annotations.ToolController.extend("a5.Annotations.Tool.ClearAll",{init:function(){this.i18n=a5a.config.i18n,this.name="clearAll",this.label=this.i18n("clearAllTool"),this.hint=this.i18n("clearAllToolHint"),this.isSelectable=!1,this.type="Action",this._super()},action:function(){if(!this.open){var dialog=new a5.view.PPEbookClearAllAnnotationsDialog,$dialog=dialog.render();""!==$dialog.html()?(this.open=!0,dialog.bind("submit",_.bind(function(){this._clear()},this)),dialog.bind("close",function(){$dialog.remove(),this.open=!1},this),dialog.open()):this._clear()}},_clear:function(){var drawings=_.values(a5a.current.drawings);a5a.history.expectBatchChange(),_.each(drawings,function(drawing,index){drawing.removeAllFeatures(!0)}),a5a.current.batchChanged(!0)}}),a5.Annotations.ColorPaletteController.extend("a5.Annotations.ColorPalette",{init:function(tool,colors){this.colors=_.map(colors,function(color){return new a5.Annotations.Color(color)}),this.selected=void 0,this._super(tool,colors)}}),a5.Annotations.ColorController.extend("a5.Annotations.Color",{init:function(color){this.i18n=a5a.config.i18n,color=color.split(/ /),this.name=color[0],this.label=this.i18n(color[0]+"Color"),this.hex=color[1]||color[0],this._super()},serialize:function(){return this.hex}}),a5.Annotations.ThicknessListController.extend("a5.Annotations.ThicknessList",{init:function(tool,thicknesses){this.thicknesses=_.map(thicknesses,function(thickness){return new a5.Annotations.Thickness(thickness)}),this.selected=void 0,this._super(tool,thicknesses)}}),a5.Annotations.ThicknessController.extend("a5.Annotations.Thickness",{init:function(thickness){this.i18n=a5a.config.i18n,thickness=thickness.split(/ /),this.name=thickness[0],this.label=this.i18n(thickness[0]+"Thickness"),this.size=parseFloat(thickness[1]),this._super()},serialize:function(){return this.size}}),a5.Annotations.DrawingController.extend("a5.Annotations.Drawing",{init:function(payload){this._super(payload),payload=payload||{},this.nextBefore={},this.fromObject({features:payload.features})},serialize:function(forHistory){return{features:_.map(this.features,function(feature){if(forHistory||feature.isExportable)return feature.serialize()})}},fromObject:function(data){data&&(this.features=_.map(data.features,function(feature){return new a5.Annotations.Feature(this,feature)},this))}}),a5.Annotations.FeatureController.extend("a5.Annotations.Feature",{init:function(context,payload){this._super(payload),payload=payload||{},this.contentType=payload.type||a5a.current.tool.type,this.drawing=context,this.contentClass=eval("a5.Annotations.Content."+this.contentType),this.contentClass&&(this.content=new this.contentClass(this,payload.content)),this.lock=payload.lock,this.isExportable="string"!=typeof this.lock},serialize:function(){return{type:this.contentType,lock:this.lock,content:this.content.serialize()}}}),a5.Annotations.Content.StrokeController.extend("a5.Annotations.Content.Stroke",{init:function(annotation,payload){payload=payload||{},this.type="Stroke",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.segments=[],this.points=_.map(payload.points,function(point){return new a5.Annotations.Point(point[0],point[1])}),this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){var points=[];return $.each(this.points,function(ix,point){points.push(point.serialize())}),{tool:this.toolSnapshot,points:points}}}),a5.Annotations.StrokeSegmentController.extend("a5.Annotations.StrokeSegment",{init:function(annotation,x,y){this._super(annotation,x,y),this.x=this.view.extentX=x,this.y=this.view.extentY=y,this.points=[],this.length=0},serialize:function(){var points=[];return $.each(this.points,function(ix,point){points.push(point.serialize())}),points}}),a5.Annotations.PointController.extend("a5.Annotations.Point",{init:function(x,y){this._super(x,y),this.x=x,this.y=y},serialize:function(){return[this.x,this.y]}}),a5.Annotations.Content.TextController.extend("a5.Annotations.Content.Text",{init:function(annotation,payload){payload=payload||{},this.type="Text",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.content=payload.content||"",this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,content:this.content}}}),a5.Annotations.Content.LinkController.extend("a5.Annotations.Content.Link",{init:function(annotation,payload){payload=payload||{},this.type="Link",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.width=payload.width,this.height=payload.height,this.content=payload.content||"",this.isCollapsed=!!payload.shrunk,this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,width:this.width,height:this.height,shrunk:this.isCollapsed,content:this.content}}});a5.Annotations.Content.BlockController.extend("a5.Annotations.Content.Block",{init:function(annotation,payload){payload=payload||{},this.type="Block",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.width=payload.width,this.height=payload.height,this.content=payload.content||"",this.title=payload.title,this.isCollapsed=!!payload.shrunk,this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,width:this.width,height:this.height,shrunk:this.isCollapsed,content:this.content,title:this.title}}}),a5.Annotations.Content.BlockOutController.extend("a5.Annotations.Content.BlockOut",{init:function(annotation,payload){payload=payload||{},this.type="BlockOut",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.width=0,this.height=0,this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,width:this.width,height:this.height,content:this.content}}}),a5.Annotations.Content.InverseMaskController.extend("a5.Annotations.Content.InverseMask",{init:function(annotation,payload){payload=payload||{},this.type="InverseMask",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.width=payload.width,this.height=payload.height,this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,width:this.width,height:this.height,content:this.content}}}),a5.Annotations.Content.MaskController.extend("a5.Annotations.Content.Mask",{init:function(annotation,payload){payload=payload||{},this.type="Mask",this.toolSnapshot=payload.tool||a5a.current.tool.serialize(),this.startX=this.x=payload.x,this.startY=this.y=payload.y,this.width=payload.width,this.height=payload.height,this.isLoaded=!!payload.tool,this._super(annotation,payload)},serialize:function(){return{tool:this.toolSnapshot,x:this.x,y:this.y,width:this.width,height:this.height,content:this.content}}}),a5.Annotations.KeyboardEventsController.extend("a5.Annotations.KeyboardEvents",{init:function(){this.key={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"MODIFIER SHIFT",17:"MODIFIER CTRL",18:"MODIFIER ALT",19:"BREAK",20:"CAPS-LOCK",27:"ESC",32:"SPACE",33:"PAGE-UP",34:"PAGE-DOWN",35:"END",36:"HOME",37:"ARROW LEFT",38:"ARROW UP",39:"ARROW RIGHT",40:"ARROW DOWN",45:"INSERT",46:"DELETE",144:"NUM-LOCK",145:"SCROLL-LOCK",91:"MODIFIER CMD",224:"MODIFIER CMD",93:"MENU",96:"NUMBER 0",97:"NUMBER 1",98:"NUMBER 2",99:"NUMBER 3",100:"NUMBER 4",101:"NUMBER 5",102:"NUMBER 6",103:"NUMBER 7",104:"NUMBER 8",105:"NUMBER 9",106:"MULTIPLY",107:"ADD",109:"SUBTRACT",111:"DIVIDE",112:"FUNC F1",113:"FUNC F2",114:"FUNC F3",115:"FUNC F4",116:"FUNC F5",117:"FUNC F6",118:"FUNC F7",119:"FUNC F8",120:"FUNC F9",121:"FUNC F10",122:"FUNC F11",123:"FUNC F12",124:"FUNC F13",125:"FUNC F14",126:"FUNC F15",127:"FUNC F16",128:"FUNC F17",129:"FUNC F18",130:"FUNC F19",187:"EQUAL"},this._super()}}),Obj.extend("a5.Annotations.V",{init:function(that){this.that=that,this.i18n=that.i18n}}),Obj.extend("a5.Annotations.Utilities",{init:function(){this.touchClickSupport=new a5.Annotations.Utilities.TouchClick,this.extendjQuery()},coord:function(evnt,axis,elem){var coord,scale,el=elem?$(elem):$(evnt.target),offset=el.offset(),box=el[0].getBoundingClientRect(),pageX=this.inBounds(evnt.pageX,offset.left,offset.left+box.width),pageY=this.inBounds(evnt.pageY,offset.top,offset.top+box.height);return"x"===axis?(scale=el[0].offsetWidth/box.width,coord=Math.round((pageX-offset.left)*scale)):"y"===axis&&(scale=el[0].offsetHeight/box.height,coord=Math.round((pageY-offset.top)*scale)),coord},zoom:function(){return a5.player?a5.player.viewportScaling.zoom:a5a.intView&&a5a.intView.pages&&a5a.intView.pages.scroller?a5a.intView.pages.scroller.zoom:1},extendjQuery:function(){var originalRemoveClass=jQuery.fn.removeClass;jQuery.fn.removeClass=function(){if(arguments[0]instanceof RegExp){var pattern=arguments[0];return $(this).each(function(){this.className=this.className.replace(pattern,"")})}return originalRemoveClass.apply(this,arguments)},jQuery.extend(jQuery.expr[":"],{outside:function(element,i,selector){return 0==$(element).parents(selector[3]).length}})},inBounds:function(val,min,max){return val<min?val=min:val>max&&(val=max),val}}),a5.Annotations.Utilities.extend("a5.Annotations.CurrentView",{init:function(that){this._super(that),_.bindAll(this,"flagChange","offerSave"),this.that=that,this.i18n=a5a.config.i18n,this.domSelector=a5a.options.stage,this.LEFT_BUTTON=0,this.RIGHT_BUTTON=2,this.touchAgent=/iphone|ipod|ipad|android|fennec|rim tablet/i.test(navigator.userAgent),this.isActive=!1,this.supportsCanvas=!$("body").is(".isQt"),$(window).on("beforeunload",this.offerSave),_.defer(this.flagChange)},activate:function(){this.isActive=!0},deactivate:function(){this.isActive=!1},flagChange:function(){$("body").toggleClass("hasUnchangedAnnotations",!a5a.current.hasChanges)},offerSave:function(e){if(this.that.hasChanges)return a5a.toolbox.view.show(),this.i18n("unsavedContentWarning")}}),Obj.extend("a5.Annotations.Utilities.TouchClick",{init:function(){this.touchedOn=null,this.active=!1,_.bindAll(this,"touchHandler")},bindEvents:function(tool){"Stroke"==tool.type||"Block"==tool.type||"BlockOut"==tool.type||"Mask"==tool.type||"InverseMask"==tool.type||"Link"==tool.type?this.active||(this.active=!this.active,document.addEventListener("touchstart",this.touchHandler,!0),document.addEventListener("touchmove",this.touchHandler,!0),document.addEventListener("touchend",this.touchHandler,!0),document.addEventListener("touchcancel",this.touchHandler,!0)):this.active&&(this.active=!this.active,document.removeEventListener("touchstart",this.touchHandler,!0),document.removeEventListener("touchmove",this.touchHandler,!0),document.removeEventListener("touchend",this.touchHandler,!0),document.removeEventListener("touchcancel",this.touchHandler,!0))},touchHandler:function(event){var type;if(event.touches.length<=1){var touch=event.changedTouches[0],target=document.elementFromPoint(touch.clientX,touch.clientY);if($(target).is("[contenteditable], input"))return;switch(event.preventDefault(),event.type){case"touchstart":type="mousedown";break;case"touchmove":type="mousemove";break;case"touchcancel":case"touchend":type="mouseup";break;default:return}switch(event.type){case"touchstart":this.touchedOn=target;break;case"touchend":target==this.touchedOn&&(type+=" click"),this.touchedOn=null}for(var types=type.split(" "),i=0;i<types.length;i++){var simulation=document.createEvent("MouseEvent");simulation.initMouseEvent(types[i],!0,!0,window,1,touch.screenX,touch.screenY,touch.clientX,touch.clientY,!1,!1,!1,!1,a5a.current.view.LEFT_BUTTON,null),target.dispatchEvent(simulation)}return!1}}}),a5.Annotations.V.extend("a5.Annotations.HistoryView",{init:function(that){this._super(that)},activate:function(){this.update()},update:function(){var undoAvailable=this.that.snapshots.length>0&&this.that.level<this.that.snapshots.length,redoAvailable=this.that.level>0;$("body").toggleClass("hasAnnotationsNoUndo",!undoAvailable),$("body").toggleClass("hasAnnotationsNoRedo",!redoAvailable)}}),a5.Annotations.V.extend("a5.Annotations.StageView",{init:function(that,interactions){this._super(that),_.bindAll(this,"redraw","updateSize","measure");var $node=$();_.each(interactions,function(interaction){$node=$node.add(interaction.view?interaction.view.$node:interaction.node||interaction.$)}),this.$=$node.find("."+a5a.current.view.domSelector),$(".active."+a5a.current.view.domSelector).removeClass("active"),this.$.empty(),this.$.addClass("active tool-"+a5a.current.tool.name.replace(/ /g,"-")),this.$.addClass(a5a.current.view.domSelector+"-stage"),this.$drawable=$("<div>",{class:a5a.current.view.domSelector+"-drawable"}).appendTo(this.$),_.defer(_.bind(this.updateSize,this)),this.bindEvents(),_.defer(_.bind(this.calculateStageRatio,this)),$(window).on("resize.stage",_.debounce(this.updateSize,600)),_.defer(this.redraw)},bindEvents:function(){var self=this;a5a.current.tool&&_(a5a.current.tool.load).isFunction()&&a5a.current.tool.load(this),this.$drawable.on("mousedown.stage",function(e){if(a5a.current.tool&&e.button==a5a.current.view.LEFT_BUTTON)return $(e.target).parent().trigger("toolPress",[a5a.current.view.coord(e,"x",this),a5a.current.view.coord(e,"y",this),e]),!!e.preventDefault()}),this.$.on("toolPress.stage",function(e,x,y,ev){$(document).on("mousemove",this,move).on("mouseup",this,up),self.$.addClass("isDrawing"),self.$current=self.$.filter(e.target),a5a.current.tool.press(x,y,e,ev)}).on("toolDrag.stage",function(e,x,y,ev){
$(e.target).is(self.$current)&&a5a.current.tool.drag(x,y,e,ev)}).on("toolLift.stage",function(e,x,y,ev){$(document).off("mousemove",move).off("mouseup",up),self.$.removeClass("isDrawing"),a5a.current.tool.lift(x,y,e,ev)});function move(e){$(e.target).parent().trigger("toolDrag",[a5a.current.view.coord(e,"x",e.data),a5a.current.view.coord(e,"y",e.data),e])}function up(e){self.$drawable.parent().trigger("toolLift",[a5a.current.view.coord(e,"x",e.data),a5a.current.view.coord(e,"y",e.data),e])}},redraw:function(){this.$.children().not(this.$drawable).remove(),_.each(this.that.drawings,function(drawing,index){this.$current=this.$.eq(index),this.that.drawing=drawing;var features=drawing.features.slice(0);_.each(features,function(feature,index){feature.content.view.render()}),drawing.features=features},this),this.$.trigger("redraw.stage")},show:function(){this.$.show()},hide:function(){this.$.hide()},toggle:function(){$("body").toggleClass("hidden-annotations",!this.that.visible)},measure:function(){this.that.dimensions={width:this.$.parent().width(),height:this.$.parent().height()}},calculateStageRatio:function(){this.$.each(function(){this.ratio=$(this).parent().width()/a5a.config.referenceStageWidth})},destroy:function(){this.$drawable.unbind(".stage"),this.$.unbind(".stage"),this.$.children().remove(),a5a.current.tool&&_(a5a.current.tool.unload).isFunction()&&a5a.current.tool.unload(this),$(window).off("resize.stage")},updateSize:function(){this.$drawable.css({height:this.$.parent().height()})}}),a5.Annotations.V.extend("a5.Annotations.CursorView",{init:function(that){this._super(that),_.bindAll(this,"update","flagIfWithin"),this.$=$("<div>",{id:a5a.current.view.domSelector+"-cursor",class:""}).appendTo("body"),this.paletteClass=null,this.bindEvents(),_.defer(this.update)},bindEvents:function(){$(document).on("mousemove",this.flagIfWithin)},flagIfWithin:function(e){var show,cursor=this.that.tool;"cursor"!=cursor&&(show="eraser"==cursor?!!$(e.target).parents(".main-content, .page").length:$(e.target).is(a5a.stage.view.$drawable),this.$.toggleClass("within",show||$(e.target).is(this.$)),this.$.css({left:e.clientX,top:e.clientY}))},update:function(newPaletteClass){var color,tool=this.that.tool;this.$.removeClass(/ ?tool-\S+/g),this.$.addClass("tool-"+tool.replace(/ /g,"-")),a5a.current.tool.palette?(color=a5a.current.tool.palette.selected.hex,this.updatePalette(newPaletteClass)):color=a5a.config.defaultCursorColor,this.$.css({color:color})},updatePalette:function(newPaletteClass){var classes=this.$.attr("class").split(" "),tool=this.that.tool;tool=tool.replace(/ /g,"-");var regexp=new RegExp(tool+"-color-");newPaletteClass&&(newPaletteClass=newPaletteClass.replace(/ /g,"-"),regexp.test(newPaletteClass)&&(classes=_.reject(classes,function(c){return regexp.test(c)}),this.paletteClass=newPaletteClass,this.$.attr("class",classes.join(" ")),this.$.addClass(newPaletteClass)))}}),a5.Annotations.V.extend("a5.Annotations.ToolBoxBaseView",{select:function(){var tool=this.that.selected;this.$.children(".selected").removeClass("selected"),tool.view.$.addClass("selected"),a5a.stage&&(a5a.stage.view.$.removeClass(/ ?tool-\S+/g),a5a.stage.view.$.addClass("tool-"+tool.name.replace(/ /g,"-"))),tool.palette&&tool.palette.view.open(),tool.thicknessList&&tool.thicknessList.view.open(),$("body").toggleClass("isUnselectable","cursor"!==tool.name),a5a.current.view.touchClickSupport.bindEvents(tool),a5a.cursor.select(tool)},hide:function(){this.$.hide(),this.that.visible=!1,this.trigger("hide")},show:function(){this.$.show(),this.focus(),this.that.visible=!0,this.trigger("show")},toggle:function(){this.that.visible?this.hide():this.show()},update:function(){},focus:function(){var tool=this.that.selected;$.contains(tool.view.$[0],document.activeElement)||(tool.view.$.is(":focusable")?tool.view.$.focus():tool.view.$.find(":focusable:first").focus())}}),a5.Annotations.ToolBoxBaseView.extend("a5.Annotations.ToolboxStaticView",{init:function(that){this._super(that),_.bindAll(this,"appendToolbox"),this.$=$("<ul>",{id:a5a.current.view.domSelector+"-toolbox"}),_.defer(this.appendToolbox)},appendToolbox:function(){this.$appendTo=$(this.that.appendTo),this.$.appendTo(this.$appendTo),this.that.visible=!0}}),a5.Annotations.ToolBoxBaseView.extend("a5.Annotations.ToolboxPopupView",{init:function(that){this._super(that),_.bindAll(this,"appendToolbox","_onResize","update"),this.downX=void 0,this.downY=void 0,this.hasMoved=!1,this.$=$("<ul>",{id:a5a.current.view.domSelector+"-toolbox"}),this.$close=$("<li>",{class:"control control-close"}).appendTo(this.$),this.$drag=$("<li>",{class:"control control-drag",title:this.i18n("toolboxDragHint")}).appendTo(this.$),_.defer(this.appendToolbox),this.bindEvents()},appendToolbox:function(){switch(this.$appendTo=$(this.that.appendTo),this.that.insideBounds){case!0:this.$insideBounds=this.$appendTo;break;case!1:this.$insideBounds=$();break;default:this.$insideBounds=$(this.that.insideBounds)}this.$.appendTo(this.$appendTo),this.updateInitialPosition()},bindEvents:function(){var self=this;this.$.on("click",function(e){e.stopPropagation()}).on("toolboxDown",function(e,x,y){$(document).on("touchmove mousemove",move).bind("touchend mouseup",up),a5.utils.preventTextSelection(),self.lastX=self.x,self.lastY=self.y,self.downX=x,self.downY=y}).on("toolboxDrag",function(e,x,y){self.hasMoved=!0,self.$.addClass("lifted"),self.x=self.lastX+(x-self.downX),self.y=self.lastY+(y-self.downY),self.update()}).on("toolboxLift",function(e,x,y){$(document).off("touchmove mousemove",move).off("touchend mouseup",up),a5.utils.allowTextSelection(),self.x=self.lastX+(x-self.downX),self.y=self.lastY+(y-self.downY),self.update(),_.defer(function(){self.$.removeClass("lifted")})}).on("mousedown",a5a.options.toolbarDragOnlyFromHandle?".control-drag":null,function(e){self._mouseDownEvent=e,e.button==a5a.current.view.LEFT_BUTTON&&self.$.trigger("toolboxDown",[e.clientX,e.clientY])}).on("touchstart",a5a.options.toolbarDragOnlyFromHandle?".control-drag":null,function(e){var touch=event.changedTouches[0];self.$.trigger("toolboxDown",[touch.clientX,touch.clientY])}),$(window).on("resize",_.throttle(this._onResize,300));var hammerPan,panEnabled,hasMoved=!1;function move(e){if(hasMoved||(hammerPan=a5a.intView.pages.scroller.node.data("hammer").get("pan"),panEnabled=hammerPan.options.enable,hammerPan.set({enable:!1}),hasMoved=!0),"mousemove"===e.type&&e.pageX===self._mouseDownEvent.pageX&&e.pageY===self._mouseDownEvent.pageY)return!0;if("touchmove"===e.type){var touch=event.changedTouches[0];e.clientX=touch.clientX,e.clientY=touch.clientY}self.$.trigger("toolboxDrag",[e.clientX,e.clientY])}function up(e){if(hasMoved&&(hammerPan.set({enable:panEnabled}),hasMoved=!1),"touchend"===e.type){var touch=event.changedTouches[0];e.clientX=touch.clientX,e.clientY=touch.clientY}self.$.trigger("toolboxLift",[e.clientX,e.clientY])}this.$.on("click",".control-close",function(e){self.hide()})},onToolsChanged:function(){this.that.tools.forEach(function(tool){tool.view.unbind("color:open",this.update),tool.view.unbind("thickness:open",this.update),tool.view.bind("color:open",this.update,this),tool.view.bind("thickness:open",this.update,this)},this)},update:function(){this.hasMoved?this.updatePosition():a5a.options.toolboxInitialPosition&&this.updateInitialPosition()},updatePosition:function(){this.$insideBounds.length&&this._inBounds(),this.$appendTo.length>0&&this.$appendTo.outerWidth()>0&&this.$appendTo.outerHeight()>0&&this.$.css({left:100*this.x/this.$appendTo.outerWidth()+"%",top:100*this.y/this.$appendTo.outerHeight()+"%",bottom:"auto"})},updateInitialPosition:function(){if(this.that.visible||(this.$.css("visibility","hidden"),this.$.css("display","block")),a5a.options.toolboxInitialPosition){var position=_.result(a5a.options,"toolboxInitialPosition");position.left&&(this.x=parseFloat(position.left)),position.top&&(this.y=parseFloat(position.top))}else{var styles=getComputedStyle(this.$.get(0));styles.left.indexOf("%")<0?this.x=parseFloat(styles.left)||this.$.position().left:this.x=parseFloat(styles.left)*this.$appendTo.outerWidth()/100,styles.top.indexOf("%")<0?this.y=parseFloat(styles.top)||this.$.position().top:this.y=parseFloat(styles.top)*this.$appendTo.outerHeight()/100}this.updatePosition(),this.updateLastPosition(),this.that.visible||(this.$.css("display",""),this.$.css("visibility",""))},updateLastPosition:function(){this.lastX=this.x,this.lastY=this.y},select:function(quiet){this._super(),quiet||this.show()},show:function(){this.update(),this._super()},_onResize:function(event){_.defer(this.update)},_inBounds:function(){var offset=this.$insideBounds.offset(),width=this.$insideBounds.outerWidth(),height=this.$insideBounds.outerHeight(),parentOffset=this.$appendTo.offset();this.x<offset.left-parentOffset.left&&(this.x=offset.left-parentOffset.left),this.x+this.$.outerWidth()>offset.left+width-parentOffset.left&&(this.x=offset.left+width-parentOffset.left-this.$.outerWidth()),this.y<offset.top-parentOffset.top&&(this.y=offset.top-parentOffset.top),this.y+this.$.outerHeight()>offset.top+height-parentOffset.top&&(this.y=offset.top+height-parentOffset.top-this.$.outerHeight())}}),a5.Annotations.V.extend("a5.Annotations.ToolView",{template:"a5.book.annotations.Tool",init:function(that){this.that=that,this.bindEvents(),this.render()},bindEvents:function(){this.bind("color:open",this.colorOpened,this),this.bind("color:close",this.colorClosed,this),this.bind("thickness:open",this.thicknessOpened,this),this.bind("thickness:close",this.thicknessClosed,this)},render:function(options){if($(this.that.exclude).length)this.$=$();else{var html=a5.service.templates.render(this.template,_.extend({name:this.that.name.replace(/\s+/g,"-"),label:this.that.label,type:this.that.type,title:this.that.hint},options)),$html=$(html);this.$?this.$.replaceWith($html):$html.appendTo(a5a.toolbox.view.$),this.$=$html;(this.$.is("[data-event=activate]")?this.$:this.$.find("[data-event=activate]")).on("click",_.bind(a5a.toolbox.select,a5a.toolbox,this.that,!1))}},colorOpened:function(){this.$.addClass("color-open")},colorClosed:function(){this.$.removeClass("color-open")},thicknessOpened:function(){this.$.addClass("thickness-open")},thicknessClosed:function(){this.$.removeClass("thickness-open")},closeChoosers:function(){this.that.palette&&this.that.palette.view.close(),this.that.thicknessList&&this.that.thicknessList.view.close()}}),a5.Annotations.V.extend("a5.Annotations.ColorPaletteView",{template:"a5.book.annotations.ColorPalette",init:function(that){this.actualClass=null,this.oldClass=null,this._super(that),_.bindAll(this,"append","updateToolClass","updateSample","_onClick"),this.render(),this.bindEvents(),_.defer(this.append)},render:function(){var colors=_.map(this.that.colors,function(color){return{name:color.name,title:color.label,hex:color.hex}}),html=a5.service.templates.render(this.template,{colors:colors});this.$=$(html)},bindEvents:function(){this.$.on("click","[data-event=activate]",this._onClick)},append:function(){this.$.appendTo(this.that.tool.view.$)},select:function(dont_close){this.$.find(".selected").removeClass("selected"),this.$.find(".color-"+this.that.selected.name).addClass("selected"),_.defer(this.updateToolClass),_.defer(this.updateSample),!dont_close&&this.that.tool.view&&this.that.tool.view.closeChoosers()},updateToolClass:function(){var index=_.indexOf(this.that.colors,this.that.selected)+1;!_.isUndefined(this.that.tool.view)&&index>0&&(this.oldClass=this.actualClass,this.that.tool.view.$.removeClass(this.actualClass),this.actualClass=this.that.tool.name+"-color-"+index,this.that.tool.view.$.addClass(this.actualClass))},updateSample:function(){this.updateCursor(),this.that.tool.view.$.css({color:this.that.selected.hex})},updateCursor:function(){a5a.cursor.view.update(this.actualClass)},open:function(){this.$.css({display:""}),_.isUndefined(this.that.tool.view)||this.that.tool.view.trigger("color:open")},close:function(){this.$.hide(),_.isUndefined(this.that.tool.view)||this.that.tool.view.trigger("color:close")},_onClick:function(ev){var name=$(ev.target).data("name"),color=_.find(this.that.colors,{name:name});a5a.current.tool.palette.select(color,a5.dp.config.annotationsKeepPaletteOpen),ev.stopPropagation()}}),a5.Annotations.V.extend("a5.Annotations.ThicknessSelectorView",{template:"a5.book.annotations.ThicknessSelector",init:function(that){this.$=$("<ul>",{class:"thicknessSelector"}),this.actualClass=null,this.oldClass=null,this._super(that),_.bindAll(this,"append","updateToolClass","updateSample","_onClick"),this.render(),this.bindEvents(),_.defer(this.append)},render:function(){var thicknesses=_.map(this.that.thicknesses,function(thickness){return{name:thickness.name,title:thickness.label}}),html=a5.service.templates.render(this.template,{thicknesses:thicknesses});this.$=$(html)},bindEvents:function(){this.$.on("click","[data-event=activate]",this._onClick)},append:function(){this.$.appendTo(this.that.tool.view.$)},select:function(dont_close){this.$.find(".selected").removeClass("selected"),this.$.find(".thickness-"+this.that.selected.name).addClass("selected"),_.defer(this.updateToolClass),_.defer(this.updateSample),!dont_close&&this.that.tool.view&&this.that.tool.view.closeChoosers()},updateToolClass:function(){var index=_.indexOf(this.that.thicknesses,this.that.selected)+1;!_.isUndefined(this.that.tool.view)&&index>0&&(this.oldClass=this.actualClass,this.that.tool.view.$.removeClass(this.actualClass),this.actualClass=this.that.tool.name+"-thickness-"+index,this.that.tool.view.$.addClass(this.actualClass))},updateSample:function(){this.updateCursor(),this.that.tool.view.$.css({thickness:this.that.selected.size})},updateCursor:function(){a5a.cursor.view.update(this.actualClass)},open:function(){this.$.css({display:""}),_.isUndefined(this.that.tool.view)||this.that.tool.view.trigger("thickness:open")},close:function(){this.$.hide(),_.isUndefined(this.that.tool.view)||this.that.tool.view.trigger("thickness:close")},_onClick:function(ev){var name=$(ev.target).data("name"),thickness=_.find(this.that.thicknesses,{name:name});a5a.current.tool.thicknessList.select(thickness,a5.dp.config.annotationsKeepPaletteOpen),ev.stopPropagation()}}),a5.Annotations.V.extend("a5.Annotations.Content.StrokeView",{init:function(that,feature){if(this._super(that),this.feature=feature,this.$=$(),this.that.isLoaded)this.$canvas=$();else if(a5a.current.view.supportsCanvas)this.$canvas=$("<canvas>",{class:"preview"}).attr(a5a.stage.dimensions).appendTo(a5a.stage.view.$current),this.context=this.$canvas[0].getContext("2d"),a5a.current.tool.palette&&(this.context.strokeStyle=a5a.current.tool.palette.selected.hex),this.context.lineWidth=a5a.current.tool.thicknessList.selected.size*a5a.stage.view.$current[0].ratio,this.context.lineCap=a5a.current.tool.lineCap,this.context.lineJoin="bevel",this.context.globalAlpha=a5a.current.tool.opacity,this.lastX=void 0,this.lastY=void 0;else{this.paper=Raphael(a5a.stage.view.$current[0],a5a.stage.dimensions.width,a5a.stage.dimensions.height),this.$canvas=$(this.paper.canvas),this.$canvas.attr("class","preview"),this.stroke=this.paper.path();var options={opacity:a5a.current.tool.opacity,"stroke-width":a5a.current.tool.thicknessList.selected.size*a5a.stage.view.$current[0].ratio,"stroke-linecap":a5a.current.tool.lineCap,"stroke-linejoin":"bevel"};a5a.current.tool.palette&&(options.stroke=a5a.current.tool.palette.selected.hex),this.stroke.attr(options)}},preview:function(point){if(a5a.current.view.supportsCanvas)this.context.beginPath(),this.context.moveTo(this.lastX||point.x,this.lastY||point.y),this.context.lineTo(this.lastX=point.x,this.lastY=point.y),this.context.stroke();else{var path=this.stroke.attr("path");path&&"M0,0"!=path?path+=["L",point.x,point.y].join(","):path=["M",point.x,point.y].join(","),this.stroke.attr("path",path)}},postview:function(point){},render:function(points){var tool;if(points)this.that.points=points,tool={};else{tool=this.feature.content.toolSnapshot,points=this.that.points;var exclude=a5a.toolbox.tool(tool.name).exclude}if(!points||!points.length)return void this.feature.remove();a5a.stage.view.$current&&!$("body").is(exclude)&&(this.$=$("<div>",{class:"content content-stroke"}).appendTo(a5a.stage.view.$current),this.$.css({opacity:tool.opacity||a5a.current.tool.opacity}),this.$[0].annotationsFeature=this.feature,this.that.segments.length||(this.that.segments=this.segment(points)),$.each(this.that.segments,function(index,segment){segment.view.render(tool)}),this.$canvas.remove())},segment:function(points){var segments=[];return segments.push(new a5.Annotations.StrokeSegment(this.feature,points[0].x,points[0].y)),$.each(points,_.bind(function(index,point){var segment=segments.slice(-1)[0];if(!segment.push(point.x,point.y)){var newSegment=new a5.Annotations.StrokeSegment(this.feature,point.x,point.y);newSegment.previous=segment,segment.next=newSegment,newSegment.annotation=this.feature,segments.push(newSegment)}},this)),segments}}),a5.Annotations.V.extend("a5.Annotations.StrokeSegmentView",{init:function(that,x,y){this._super(that),this.$=void 0,this.width=0,this.height=0,this.extentX=0,this.extentY=0,this.padding=3},render:function(toolSnapshot){toolSnapshot=toolSnapshot||{};var padding=this.padding=2+(toolSnapshot.thickness||a5a.current.tool.thickness.size)*a5a.stage.view.$current[0].ratio,width=this.width+2*padding,height=this.height+2*padding;a5a.current.view.supportsCanvas?(this.$=$("<canvas>",{class:"segment"}).appendTo(this.that.annotation.content.view.$),this.$.attr({width:width,height:height})):(this.paper=Raphael(this.that.annotation.content.view.$[0],width,height),this.$=$(this.paper.canvas),this.$.attr("class","segment")),this.$.css({left:this.that.x-padding,top:this.that.y-padding}),this.draw(toolSnapshot)},draw:function(toolSnapshot){toolSnapshot=toolSnapshot||{};var tool=a5a.toolbox.tool(toolSnapshot.name||a5a.current.tool.name),points=[].concat(this.that.points);this.that.previous&&points.unshift(this.that.previous.points.slice(-1)[0]),this.that.previous&&points.unshift(this.that.previous.points.slice(-2,-1)[0]),this.that.next&&(points=points.concat(this.that.next.points.slice(0,2))),a5a.current.view.supportsCanvas&&(this.context=this.$[0].getContext("2d"),this.context.strokeStyle=toolSnapshot.color||tool.color.hex,this.context.lineWidth=(toolSnapshot.thickness||tool.thickness.size)*a5a.stage.view.$current[0].ratio,this.context.lineCap=toolSnapshot.lineCap||tool.lineCap,this.context.lineJoin="bevel");for(var pts=[],i=0;i<points.length;i++)pts.push(this.relX(points[i].x)),pts.push(this.relY(points[i].y));var stroke=this.drawSpline(pts,.5);!a5a.current.view.supportsCanvas&&stroke&&stroke.attr({stroke:toolSnapshot.color||tool.color.hex,"stroke-width":(toolSnapshot.thickness||tool.thickness.size)*a5a.stage.view.$current[0].ratio,"stroke-linecap":toolSnapshot.lineCap||tool.lineCap,"stroke-linejoin":"bevel"})},drawSpline:function(pts,t){var i,cp=[],n=pts.length;for(i=0;i<n-4;i+=2)cp=cp.concat(function(x0,y0,x1,y1,x2,y2,t){var d01=Math.sqrt(Math.pow(x1-x0,2)+Math.pow(y1-y0,2));var d12=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2));var fa=t*d01/(d01+d12);var fb=t-fa;var p1x=x1+fa*(x0-x2);var p1y=y1+fa*(y0-y2);var p2x=x1-fb*(x0-x2);var p2y=y1-fb*(y0-y2);return[p1x,p1y,p2x,p2y]}(pts[i],pts[i+1],pts[i+2],pts[i+3],pts[i+4],pts[i+5],t));if(!a5a.current.view.supportsCanvas){var def=[["M",pts[0],pts[1]].join(" ")];for(def.push(["Q",cp[0],cp[1],pts[2],pts[3]].join(" ")),i=2;i<pts.length-5;i+=2)def.push(["C",cp[2*i-2],cp[2*i-1],cp[2*i],cp[2*i+1],pts[i+2],pts[i+3]].join(" "));return def.push(["Q",cp[2*n-10],cp[2*n-9],pts[n-4],pts[n-3]]),this.paper.path(def.join(" "))}for(i=2;i<pts.length-5;i+=2)this.context.beginPath(),this.context.moveTo(pts[i],pts[i+1]),this.context.bezierCurveTo(cp[2*i-2],cp[2*i-1],cp[2*i],cp[2*i+1],pts[i+2],pts[i+3]),this.context.stroke(),this.context.closePath();this.context.beginPath(),this.context.moveTo(pts[0],pts[1]),this.context.quadraticCurveTo(cp[0],cp[1],pts[2],pts[3]),this.context.stroke(),this.context.closePath(),this.context.beginPath(),this.context.moveTo(pts[n-2],pts[n-1]),this.context.quadraticCurveTo(cp[2*n-10],cp[2*n-9],pts[n-4],pts[n-3]),this.context.stroke(),this.context.closePath()},relX:function(x){return x-this.that.x+this.padding},relY:function(y){return y-this.that.y+this.padding}}),a5.Annotations.V.extend("a5.Annotations.Content.TextView",{template:"a5.book.annotations.Text",init:function(that,feature){this._super(that),_.bindAll(this,"updateSizeAndPosition","askToTrash","enterFocus","flagFocus","onBlur","moveStart","moveDrag","moveEnd","onInput","onKeydown","onClickDocument","onClick","onClickText"),this.feature=feature,this.$=$("<div>",{class:"content content-text"})},render:function(){if(a5a.stage.view.$current){var html=a5.service.templates.render(this.template,this.serializeData());this.$.html($(html).html()),this.$.css({color:this.that.toolSnapshot.color,"font-size":this.that.toolSnapshot.size}),this.$text=this.$.find(".text"),this.$handle=this.$.find(".handle"),this.feature.isExportable&&"text"===a5a.toolbox.selected.name?this.enableEditable():this.disableEditable(),this.$.appendTo(a5a.stage.view.$current),this.$[0].annotationsFeature=this.feature,this.enableDraggable(),this.scale=a5a.stage.view.$current[0].ratio,this.$.css({transform:"scale("+this.scale+")","transform-origin":"top left"}),this.$text.css({minWidth:a5a.config.defaultTextSize[0],minHeight:a5a.config.defaultTextSize[1]}),this.updateSizeAndPosition(),this.bindEvents(),a5.eventBus.trigger("book:text_added")}},enableDraggable:function(){this.$.draggable({handle:".handle"})},getContent:function(){var text=this.$text.html();return"<br>"===text&&(text=""),text},enableEditable:function(){this.$text.attr("contentEditable",!0)},disableEditable:function(){this.$text.attr("contentEditable",!1)},serializeData:function(){return{text:this.that.content,handleHint:this.i18n("textHandleHint"),trashHint:this.i18n("textTrashHint")}},preview:function(point,e,ev){this.that.x=this.that.startX,this.that.y=this.that.startY},postview:function(point,e,ev){this.updateSizeAndPosition(),this.focus(),_.defer(function(){this.$.addClass("content-text-selected")}.bind(this))},onClick:function(e){this.$.addClass("content-text-selected")},onClickDocument:function(e){0===$(e.target).closest(this.$).length&&this.$.removeClass("content-text-selected")},onClickText:function(e){this.enterFocus()},bindEvents:function(){this.$.on("keydown",this.onKeydown).on("click",".trash",this.askToTrash).on("click",".text",this.onClickText).on("focus",".text",this.flagFocus).on("blur",".text",this.onBlur).on("dragstart",this.moveStart).on("drag",this.moveDrag).on("dragstop",this.moveEnd).on("input",this.onInput).on("click",this.onClick),$(window).on("resize",_.debounce(this.updateSizeAndPosition,600)),$(document).off("click",this.onClickDocument).on("click",this.onClickDocument),a5a.toolbox.tool("text").palette.bind("select",this.onChangeColor,this),a5a.toolbox.tool("text").thicknessList.bind("select",this.onChangeThickness,this)},updateSizeAndPosition:function(){this.updateSize(),this.updatePosition()},updateSize:function(){this.$text.css({maxWidth:(this.$.parent().width()-this.that.x+1)/this.scale,maxHeight:(this.$.parent().height()-this.that.y+1)/this.scale})},updatePosition:function(){var bounds=this.bounds();this.that.x-=Math.max(0,this.that.x-bounds[2]),this.that.y-=Math.max(0,this.that.y-bounds[3]),this.$.css({left:this.that.x,top:this.that.y})},bounds:function(){var $stage=this.$.parents(".annotations-stage");return[0,0,$stage.width()-this.$.outerWidth()*this.scale,$stage.height()-this.$.outerHeight()*this.scale]},askToTrash:function(e){var $dialog=$('<div class="text-trash-confirm-popup modal hide" tabindex="-1" role="dialog" aria-labelledby="tip" aria-hidden="true"><div class="modal-header"><button type="button" class="close gui-fancy" data-dismiss="modal" aria-hidden="true"></button><h3>'+this.i18n("textTrashQuestionTitle")+'</h3></div><div class="modal-body"><p>'+this.i18n("textTrashQuestion")+'</p></div><div class="modal-footer"><button class="btn btn-ok" data-dismiss="modal" aria-hidden="true">'+this.i18n("textTrashOKLabel")+'</button><button class="btn btn-cancel" data-dismiss="modal" aria-hidden="true">'+this.i18n("textTrashCancelLabel")+"</button></div></div>");$dialog.on("hidden.bs.modal",function(){$dialog.remove()}),$dialog.on("click",".btn-ok",function(){this.feature.remove()}.bind(this)),$dialog.draggable({}),$dialog.modal({})},focus:function(){_.defer(_.bind(this.$text.focus,this.$text))},enterFocus:function(silent){this.$.is(".focused")||("text"!==a5a.current.tool.name&&a5a.useTool("text"),this.$text.focus())},flagFocus:function(e){"text"==a5a.current.tool.name&&a5a.current.tool.restore({size:this.that.toolSnapshot.size,color:this.that.toolSnapshot.color}),this.$.addClass("focused"),$("body").addClass("isInputing"),this.$text.html(this.that.content),this.updateSize()},onBlur:function(e){this.$.removeClass("focused"),$("body").removeClass(" isInputing"),this.persistContent()},persistContent:function(){var content=this.getContent();this.that.content!==content&&(a5a.history.expectChange(this.feature.drawing),this.that.content=content,a5a.current.changed(!0),a5.eventBus.trigger("book:text_updated"))},moveStart:function(ev,ui){ev.stopPropagation(),a5a.useTool("text"),this.cursorPosition={x:ev.clientX,y:ev.clientY},a5a.history.expectChange(this.feature.drawing)},moveDrag:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var changeLeft=ev.clientX-this.cursorPosition.x,changeTop=ev.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+changeLeft)/this.zoomScale),newTop=Math.round((ui.originalPosition.top+changeTop)/this.zoomScale),bounds=this.bounds();ui.position.left=this.that.x=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=this.that.y=Math.min(Math.max(newTop,bounds[1]),bounds[3])}this.updatePosition()},moveEnd:function(ev,ui){ui&&(ev.stopPropagation(),this.that.startX=ui.position.left,this.that.startY=ui.position.top,this.feature.isExportable&&a5a.current.changed(!0))},onInput:function(e){},onKeydown:function(e){e.stopPropagation(),$("body.isIE11").length>0&&_.defer(this.onInput,e)},onChangeColor:function(color){this.$.is(".content-text-selected")&&(a5a.history.expectChange(this.feature.drawing),this.that.toolSnapshot.color=color.hex,this.$text.css("color",color.hex),_.defer(this.enterFocus))},onChangeThickness:function(thickness){this.$.is(".content-text-selected")&&(a5a.history.expectChange(this.feature.drawing),this.that.toolSnapshot.size=thickness.size,this.$text.css("font-size",thickness.size+"px"),this.updateSize(),_.defer(this.enterFocus))}}),a5.Annotations.V.extend("a5.Annotations.Content.LinkView",{template:"a5.book.annotations.Link",longPressTime:500,init:function(that,feature){this._super(that),_.bindAll(this,"updateSizeAndPosition","enterFocus","flagFocus","onBlur","resize","moveStart","moveDrag","moveEnd","expandHint","sizeDrag","sizeEnd","onLongPress","onTap","onContextMenuExpander"),this.feature=feature,this.$=$("<div>",{class:"content content-link"}),this.hammerManager=new Hammer.Manager(this.$[0],{recognizers:[[Hammer.Press,{time:this.longPressTime}],[Hammer.Tap]]})},open:function(){a5.mainBuilder.engine.invoke("open-link",this.that.content)},render:function(){if(a5a.stage.view.$current){var html=a5.service.templates.render(this.template,this.serializeData());this.$.html($(html).html());var originalTransform;this.$.children().find(".tooltip").each(function(_,el){$(el).parent().delayedTooltip({delay:a5.dp.config.bookTooltipDelay,duration:a5.dp.config.bookTooltipDuration,start:function($tooltip){originalTransform=$tooltip.css("transform");var scale=a5a.current.view.zoom();$tooltip.closest(".wrap").length&&(scale*=parseFloat($tooltip.closest(".wrap").css("transform").split(",")[3])),$tooltip.css("transform","");var transform=$tooltip.css("transform");transform="none"===transform?"":" "+transform,$tooltip.css("transform","scale("+1/scale+")"+transform)}.bind(this),end:function($tooltip){$tooltip.css("transform",originalTransform)},container:function(){return this.$.closest(".pages-wrapper")}.bind(this)})}.bind(this)),this.$.toggleClass("collapsed",this.that.isCollapsed),this.$wrap=this.$.find(".wrap"),this.$text=this.$.find(".text"),this.$expander=this.$.find(".expander"),this.feature.isExportable&&"link"===a5a.toolbox.selected.name?this.enableEditable():this.disableEditable(),this.$.appendTo(a5a.stage.view.$current);var scale=a5a.stage.view.$current[0].ratio;if(void 0===this.that.width||void 0===this.that.height){this.that.width=a5a.config.defaultLinkSize[0]*scale,this.that.height=a5a.config.defaultLinkSize[1]*scale;var bounds=this.bounds();this.that.x-=Math.max(0,this.that.x-bounds[2]),this.that.y-=Math.max(0,this.that.y-bounds[3])}this.$[0].annotationsFeature=this.feature,this.enableDraggable(),this.$wrap.css({transform:"scale("+scale+")","transform-origin":"left top"}),this.updateSizeAndPosition(),this.bindEvents(),a5.eventBus.trigger("book:link_added")}},enableDraggable:function(){this.$.draggable({cancel:".resize-handle, .text, .toolbar :not(.handle)",handle:".handle"})},enableEditable:function(){this.$text.attr("contentEditable",!0)},disableEditable:function(){this.$text.attr("contentEditable",!1)},serializeData:function(){return{text:this.that.content,expandHint:this.i18n(this.expandHint),handleHint:this.i18n("linkHandleHint"),trashHint:this.i18n("linkTrashHint"),isResizable:!0}},preview:function(point){this.that.x=Math.min(Math.max(this.that.x,this.that.startX),point.x),this.that.y=Math.min(Math.max(this.that.y,this.that.startY),point.y),this.that.width=Math.abs(point.x-this.that.startX),this.that.height=Math.abs(point.y-this.that.startY),this.updateSizeAndPosition()},postview:function(point){this.that.startX=this.that.x,this.that.startY=this.that.y,this.updateSizeAndPosition(),this.focus()},bindEvents:function(){this.hammerManager.off("press tap"),this.hammerManager.on("press",this.onLongPress),this.hammerManager.on("tap",this.onTap),this.$.on("contextmenu",this.onContextMenuExpander).on("focus",".text",this.flagFocus).on("keydown",function(e){e.stopPropagation()}).on("blur",".text",this.onBlur).on("mousedown",".resize-handle",this.resize).on("dragstart",this.moveStart).on("drag",this.moveDrag).on("dragstop",this.moveEnd),$(window).on("resize",_.debounce(this.updateSizeAndPosition,600))},getSize:function(){return{width:this.$.width()||this.that.width,height:this.$.height()||this.that.height}},bounds:function(){var $stage=this.$.parents(".annotations-stage"),noteSize=this.getSize();return[0,0,$stage.width()-noteSize.width,$stage.height()-noteSize.height]},focus:function(e){this.$text.is(":focus")||_.defer(_.bind(this.$text.focus,this.$text)),e&&e.stopPropagation()},enterFocus:function(e){this.$.is(".focused")||!($(e.target).closest(".text, .content").length>0)&&$(e.target).is(":outside(.text)")||(a5a.useTool("link"),this.$text.focus())},updateSizeAndPosition:function(){this.$.css({height:this.that.height,width:this.that.width,left:this.that.x,top:this.that.y}),this.$wrap.css({height:this.that.height/a5a.stage.view.$current[0].ratio,width:this.that.width/a5a.stage.view.$current[0].ratio}),this.that.isCollapsed?(this.$.css({"min-height":"","min-width":""}),this.$wrap.css({"min-height":"","min-width":""})):a5a.config.minStickyNoteSize&&(this.$.css({"min-height":a5a.config.minStickyNoteSize*a5a.stage.view.$current[0].ratio,"min-width":a5a.config.minStickyNoteSize*a5a.stage.view.$current[0].ratio}),this.$wrap.css({"min-height":a5a.config.minStickyNoteSize,"min-width":a5a.config.minStickyNoteSize})),this.updateMaxSize(),this.$.show()},updateMaxSize:function(){this.$wrap.css({maxWidth:(this.$.parent().width()-this.that.x)/this.scale,maxHeight:(this.$.parent().height()-this.that.y)/this.scale})},expandCollapse:function(e){
a5a.history.expectChange(this.$[0].annotationsFeature.drawing),this.that.isCollapsed=!this.that.isCollapsed,this.$.toggleClass("collapsed",this.that.isCollapsed),this.toggleToolbar(!1),this.$expander.find(".tooltip").length?this.$expander.find(".tooltip").text(this.i18n(this.expandHint)):this.$expander.attr("title",this.i18n(this.expandHint));var bounds=this.bounds();this.that.x=Math.min(Math.max(this.that.x,bounds[0]),bounds[2]),this.that.y=Math.min(Math.max(this.that.y,bounds[1]),bounds[3]),this.updateSizeAndPosition(),this.that.isCollapsed||this.focus(),this.feature.isExportable&&a5a.current.changed(!0)},askToTrash:function(e){var $dialog=$('<div class="link-trash-confirm-popup modal hide" tabindex="-1" role="dialog" aria-labelledby="tip" aria-hidden="true"><div class="modal-header"><button type="button" class="close gui-fancy" data-dismiss="modal" aria-hidden="true"></button><h3>'+this.i18n("linkTrashQuestionTitle")+'</h3></div><div class="modal-body"><p>'+this.i18n("linkTrashQuestion")+'</p></div><div class="modal-footer"><button class="btn btn-ok" data-dismiss="modal" aria-hidden="true">'+this.i18n("linkTrashOKLabel")+'</button><button class="btn btn-cancel" data-dismiss="modal" aria-hidden="true">'+this.i18n("linkTrashCancelLabel")+"</button></div></div>");$dialog.on("hidden.bs.modal",function(){$dialog.remove()}),$dialog.on("click",".btn-ok",function(){this.feature.remove()}.bind(this)),$dialog.draggable({}),$dialog.modal({})},flagFocus:function(e){this.$.addClass("focused"),$("body").addClass("isInputing"),this.$text.text(this.that.content),this.$.on("mousewheel",this.onMouseWheel)},onBlur:function(e){this.$.removeClass("focused"),$("body").removeClass(" isInputing"),this.persistContent(),this.$.off("mousewheel",this.onMouseWheel)},onMouseWheel:function(e){e.stopPropagation()},persistContent:function(e){var content=this.$text.text();this.that.content!==content&&(a5a.history.expectChange(this.feature.drawing),this.that.content=content,a5a.current.changed(!0),a5.eventBus.trigger("book:link_updated"))},expandHint:function(){return this.that.isCollapsed?"linkExpandHint":"linkCollapseHint"},toggleToolbar:function(active){this.$.toggleClass("with-toolbar",active)},moveStart:function(ev,ui){var hammerPan=a5a.intView.pages.scroller.node.data("hammer").get("pan");this.panEnabled=hammerPan.options.enable,hammerPan.set({enable:!1}),ev.stopPropagation(),this.cursorPosition={x:ev.clientX,y:ev.clientY},a5a.history.expectChange(this.feature.drawing)},moveDrag:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var changeLeft=ev.clientX-this.cursorPosition.x,changeTop=ev.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+changeLeft)/this.zoomScale),newTop=Math.round((ui.originalPosition.top+changeTop)/this.zoomScale),bounds=this.bounds();ui.position.left=this.that.x=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=this.that.y=Math.min(Math.max(newTop,bounds[1]),bounds[3])}},moveEnd:function(ev,ui){if(ui){ev.stopPropagation(),this.that.startX=ui.position.left,this.that.startY=ui.position.top;a5a.intView.pages.scroller.node.data("hammer").get("pan").set({enable:this.panEnabled}),this.feature.isExportable&&a5a.current.changed(!0)}},resize:function(e){if(e.button===a5a.current.view.LEFT_BUTTON)return a5a.stage.view.$current.addClass("isDrawing"),a5a.history.expectChange(this.feature.drawing),$(document).unbind(".resize"),$(document).bind("mousemove.resize",this.sizeDrag),$(document).bind("mouseup.resize",this.sizeEnd),!!e.preventDefault()},sizeDrag:function(e){var target=this.$.parents(".annotations-stage").find(".annotations-drawable")[0],x=a5a.current.view.coord(e,"x",target),y=a5a.current.view.coord(e,"y",target);this.preview(new a5.Annotations.Point(x,y))},sizeEnd:function(e){a5a.stage.view.$.removeClass("isDrawing"),this.that.startX=this.that.x,this.that.startY=this.that.y,$(document).unbind(".resize"),this.feature.isExportable&&a5a.current.changed(!0)},onLongPress:function(e){$(e.target).closest(".toolbar").length>0||(this.that.isCollapsed?this.toggleToolbar():this.toggleToolbar(!1))},onTap:function(e){var $target=$(e.target);$target.closest(".expander").length>0?this.expandCollapse(e):$target.closest(".trash").length>0?this.askToTrash(e):this.that.isCollapsed&&!$target.closest(".toolbar").length&&this.open(),this.that.isCollapsed?$("body").removeClass("isInputing"):this.enterFocus(e)},onContextMenuExpander:function(e){this.that.isCollapsed?this.toggleToolbar(!0):this.toggleToolbar(!1)}}),a5.Annotations.V.extend("a5.Annotations.Content.BlockView",{template:"a5.book.annotations.StickyNote",longPressTime:500,init:function(that,feature){this._super(that),_.bindAll(this,"toggleShare","updateSizeAndPosition","flagFocus","persistContent","persistTitle","resize","moveStart","moveDrag","moveEnd","expandHint","shareHint","sharingChangeAnnouncement","trashQuestion","trashQuestionTitle","sizeDrag","sizeEnd","onLongPress","onTap","onContextMenuExpander"),this.feature=feature,this.$=$("<div>",{class:"content content-sticky-note default"}),this.hammerManager=new Hammer.Manager(this.$[0],{recognizers:[[Hammer.Press,{time:this.longPressTime}],[Hammer.Tap]]})},render:function(){if(a5a.stage.view.$current){var html=a5.service.templates.render(this.template,this.serializeData());this.$.html($(html).html());var originalTransform;this.$.children().find(".tooltip").each(function(_,el){$(el).parent().delayedTooltip({delay:a5.dp.config.bookTooltipDelay,duration:a5.dp.config.bookTooltipDuration,start:function($tooltip){originalTransform=$tooltip.css("transform");var scale=a5a.current.view.zoom();$tooltip.closest(".wrap").length&&(scale*=parseFloat($tooltip.closest(".wrap").css("transform").split(",")[3])),$tooltip.css("transform","");var transform=$tooltip.css("transform");transform="none"===transform?"":" "+transform,$tooltip.css("transform","scale("+1/scale+")"+transform)}.bind(this),end:function($tooltip){$tooltip.css("transform",originalTransform)},container:function(){return this.$.closest(".pages-wrapper")}.bind(this)})}.bind(this)),this.$.toggleClass("collapsed",this.that.isCollapsed),this.$.toggleClass("locked",!this.feature.isExportable),this.$.toggleClass("locking",this.feature.lock),this.$.css("background-color",this.that.toolSnapshot.color),this.$wrap=this.$.find(".wrap"),this.$text=this.$.find(".text"),this.$title=this.$.find(".title"),this.$expander=this.$.find(".expander"),this.$sharer=this.$.find(".share"),this.feature.isExportable&&"sticky note"===a5a.toolbox.selected.name?this.enableEditable():this.disableEditable(),this.$.appendTo(a5a.stage.view.$current);var scale=a5a.stage.view.$current[0].ratio;if(void 0===this.that.width||void 0===this.that.height){this.that.width=a5a.config.defaultStickyNoteSize*scale,this.that.height=a5a.config.defaultStickyNoteSize*scale;var bounds=this.bounds();this.that.x-=Math.max(0,this.that.x-bounds[2]),this.that.y-=Math.max(0,this.that.y-bounds[3])}this.$[0].annotationsFeature=this.feature,this.enableDraggable(),this.$wrap.css({transform:"scale("+scale+")","transform-origin":"left top"}),this.updateSizeAndPosition(),this.bindEvents(),this.$text.linkify(),a5.eventBus.trigger("book:sticky_note_added")}},enableDraggable:function(){this.$.draggable({cancel:".resize-handle, .title, .text, .toolbar :not(.handle)",handle:".handle"})},enableEditable:function(){this.$text.attr("contentEditable",!0),this.$title.attr("contentEditable",!0)},disableEditable:function(){this.$text.attr("contentEditable",!1),this.$title.attr("contentEditable",!1)},serializeData:function(){return{text:this.that.content,title:this.that.title||this.i18n("stickyNoteDefaultTitle"),expandHint:this.i18n(this.expandHint),shareHint:this.i18n(this.shareHint),trashHint:this.i18n("stickyNoteTrashHint"),resizeHint:this.i18n("stickyNoteResizeHint"),isEditable:this.feature.isExportable,isShareable:a5a.current.canLock&&this.feature.isExportable,isResizable:!0,withTitle:a5a.config.stickyNoteWithTitle}},preview:function(point){this.that.x=Math.min(Math.max(this.that.x,this.that.startX),point.x),this.that.y=Math.min(Math.max(this.that.y,this.that.startY),point.y),this.that.width=Math.abs(point.x-this.that.startX),this.that.height=Math.abs(point.y-this.that.startY),(!this.$.is(".default")||Math.max(this.that.width,this.that.height)>a5a.config.stickyNoteThreshold)&&(this.$.removeClass("default"),this.updateSizeAndPosition())},postview:function(point){this.that.startX=this.that.x,this.that.startY=this.that.y,this.updateSizeAndPosition(),this.focus()},bindEvents:function(){this.hammerManager.off("press tap"),this.hammerManager.on("press",this.onLongPress),this.hammerManager.on("tap",this.onTap),this.$.on("contextmenu",this.onContextMenuExpander).on("click",".share",this.toggleShare).on("focus",".text",this.flagFocus).on("focus",".title",this.flagFocus).on("keydown",function(e){e.stopPropagation()}).on("blur",".text",this.persistContent).on("blur",".title",this.persistTitle).on("mousedown",".resize-handle",this.resize).on("dragstart",this.moveStart).on("drag",this.moveDrag).on("dragstop",this.moveEnd),this.$text.on("click","a",function(e){e.preventDefault(),a5.mainBuilder.engine.invoke("open-link",e.target.href)}),$(window).on("resize",_.debounce(this.updateSizeAndPosition,600))},getSize:function(){return{width:this.$.width()||this.that.width,height:this.$.height()||this.that.height}},bounds:function(){var $stage=this.$.parents(".annotations-stage"),noteSize=this.getSize();return[0,0,$stage.width()-noteSize.width-a5a.config.stickyNoteBorder,$stage.height()-noteSize.height-a5a.config.stickyNoteBorder]},focus:function(e){this.$text.is(":focus")||_.defer(_.bind(this.$text.focus,this.$text)),e&&e.stopPropagation()},updateSizeAndPosition:function(){this.$.css({height:this.that.height,width:this.that.width,left:this.that.x,top:this.that.y}),this.$wrap.css({height:this.that.height/a5a.stage.view.$current[0].ratio,width:this.that.width/a5a.stage.view.$current[0].ratio}),this.that.isCollapsed?(this.$.css({"min-height":"","min-width":""}),this.$wrap.css({"min-height":"","min-width":""})):a5a.config.minStickyNoteSize&&(this.$.css({"min-height":a5a.config.minStickyNoteSize*a5a.stage.view.$current[0].ratio,"min-width":a5a.config.minStickyNoteSize*a5a.stage.view.$current[0].ratio}),this.$wrap.css({"min-height":a5a.config.minStickyNoteSize,"min-width":a5a.config.minStickyNoteSize})),this.$.show()},expandCollapse:function(e){a5a.history.expectChange(this.$[0].annotationsFeature.drawing),this.that.isCollapsed=!this.that.isCollapsed,this.$.toggleClass("collapsed",this.that.isCollapsed),this.toggleToolbar(!1),this.$expander.find(".tooltip").length?this.$expander.find(".tooltip").text(this.i18n(this.expandHint)):this.$expander.attr("title",this.i18n(this.expandHint));var bounds=this.bounds();this.that.x=Math.min(Math.max(this.that.x,bounds[0]),bounds[2]),this.that.y=Math.min(Math.max(this.that.y,bounds[1]),bounds[3]),this.updateSizeAndPosition(),this.feature.isExportable&&a5a.current.changed(!0)},askToTrash:function(e){var $dialog=$('<div class="stickynote-trash-confirm-popup modal hide" tabindex="-1" role="dialog" aria-labelledby="tip" aria-hidden="true"><div class="modal-header"><button type="button" class="close gui-fancy" data-dismiss="modal" aria-hidden="true"></button><h3>'+this.i18n(this.trashQuestionTitle)+'</h3></div><div class="modal-body"><p>'+this.i18n(this.trashQuestion)+'</p></div><div class="modal-footer"><button class="btn btn-ok" data-dismiss="modal" aria-hidden="true">'+this.i18n("stickyNoteTrashOKLabel")+'</button><button class="btn btn-cancel" data-dismiss="modal" aria-hidden="true">'+this.i18n("stickyNoteTrashCancelLabel")+"</button></div></div>");$dialog.on("hidden.bs.modal",function(){$dialog.remove()}),$dialog.on("click",".btn-ok",function(){this.feature.remove()}.bind(this)),$dialog.draggable({}),$dialog.modal({})},toggleShare:function(e){this.$.toggleClass("locking",this.feature.share())},reportSharingChange:function(){alert(this.i18n(this.sharingChangeAnnouncement)),this.$sharer.attr("title",this.i18n(this.shareHint))},enterFocus:function(e){this.$.is(".focused")||$(e.target).is("a")||!($(e.target).closest(".text, .title, .content").length>0)&&$(e.target).is(":outside(.text), :outside(.title)")||(a5a.useTool("sticky note"),$(e.target).is(".title")?this.$title.focus():this.$text.focus())},flagFocus:function(e){$(e.target).is(":outside(.tool-sticky-note)")||(this.$.addClass("focused"),$("body").addClass("isInputing"),this.$text.html(this.that.content),this.$.on("mousewheel",this.onMouseWheel))},persistContent:function(e){this.$.removeClass("focused");var prevContent=this.that.content,curContent=this.$text.html();prevContent!==curContent&&(a5a.history.expectChange(this.feature.drawing),this.that.content=curContent,a5a.current.changed(!0),a5.eventBus.trigger("book:sticky_note_updated")),this.$text.linkify(),this.$.off("mousewheel",this.onMouseWheel)},persistTitle:function(e){this.$.removeClass("focused"),this.that.title!==$(e.target).html()&&(a5a.history.expectChange(this.feature.drawing),this.that.title=$(e.target).html(),a5a.current.changed(!0),a5.eventBus.trigger("book:sticky_note_updated")),this.$.off("mousewheel",this.onMouseWheel)},expandHint:function(){return this.that.isCollapsed?"stickyNoteExpandHint":"stickyNoteCollapseHint"},shareHint:function(){return!0===this.feature.lock?"stickyNoteUnshareHint":"stickyNoteShareHint"},sharingChangeAnnouncement:function(){return this.feature.lock?"stickyNoteShareAnnouncement":"stickyNoteUnshareAnnouncement"},trashQuestion:function(){return this.feature.lock?"stickyNoteSharedTrashQuestion":"stickyNoteTrashQuestion"},trashQuestionTitle:function(){return"stickyNoteTrashQuestionTitle"},toggleToolbar:function(active){this.$.toggleClass("with-toolbar",active)},moveStart:function(ev,ui){var hammerPan=a5a.intView.pages.scroller.node.data("hammer").get("pan");this.panEnabled=hammerPan.options.enable,hammerPan.set({enable:!1}),ev.stopPropagation(),this.cursorPosition={x:ev.clientX,y:ev.clientY},a5a.history.expectChange(this.feature.drawing)},moveDrag:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var changeLeft=ev.clientX-this.cursorPosition.x,changeTop=ev.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+changeLeft)/this.zoomScale),newTop=Math.round((ui.originalPosition.top+changeTop)/this.zoomScale),bounds=this.bounds();ui.position.left=this.that.x=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=this.that.y=Math.min(Math.max(newTop,bounds[1]),bounds[3])}},moveEnd:function(ev,ui){if(ui){ev.stopPropagation(),this.that.startX=ui.position.left,this.that.startY=ui.position.top;a5a.intView.pages.scroller.node.data("hammer").get("pan").set({enable:this.panEnabled}),this.feature.isExportable&&a5a.current.changed(!0)}},resize:function(e){if(e.button===a5a.current.view.LEFT_BUTTON)return a5a.stage.view.$current.addClass("isDrawing"),a5a.history.expectChange(this.feature.drawing),$(document).unbind(".resize"),$(document).bind("mousemove.resize",this.sizeDrag),$(document).bind("mouseup.resize",this.sizeEnd),!!e.preventDefault()},sizeDrag:function(e){this.$.removeClass("default");var target=this.$.parents(".annotations-stage").find(".annotations-drawable")[0],x=a5a.current.view.coord(e,"x",target),y=a5a.current.view.coord(e,"y",target);this.preview(new a5.Annotations.Point(x,y))},sizeEnd:function(e){a5a.stage.view.$.removeClass("isDrawing"),this.that.startX=this.that.x,this.that.startY=this.that.y,$(document).unbind(".resize"),this.feature.isExportable&&a5a.current.changed(!0)},onLongPress:function(e){$(e.target).closest(".toolbar").length>0||(this.that.isCollapsed?this.toggleToolbar():this.toggleToolbar(!1))},onTap:function(e){var $target=$(e.target);$target.closest(".expander").length>0?this.expandCollapse(e):$target.closest(".trash").length>0?this.askToTrash(e):this.that.isCollapsed&&!$target.closest(".toolbar").length&&this.expandCollapse(e),this.that.isCollapsed?$("body").removeClass("isInputing"):this.enterFocus(e)},onContextMenuExpander:function(e){this.that.isCollapsed?this.toggleToolbar(!0):this.toggleToolbar(!1)},onMouseWheel:function(e){e.stopPropagation()}}),a5.Annotations.V.extend("a5.Annotations.Content.BlockOutView",{init:function(that,feature){this._super(that),_.bindAll(this,"updateSizeAndPosition"),this.feature=feature,this.$=void 0,this.render()},render:function(){if(!this.$){if(this.$=$("<div>",{class:"content content-block-out"}).appendTo(a5a.stage.view.$current),this.$top=$("<div>",{class:"block-out top"}).appendTo(this.$),this.$left=$("<div>",{class:"block-out left"}).appendTo(this.$),this.$right=$("<div>",{class:"block-out right"}).appendTo(this.$),this.$bottom=$("<div>",{class:"block-out bottom"}).appendTo(this.$),this.$others=$(),a5a.stage.view.$.length>1){var that=this;a5a.stage.view.$.not(function(){return this==a5a.stage.view.$current[0]}).each(function(){that.$others=that.$others.add($("<div>",{class:"content content-block-out complete"}).appendTo($(this)))})}this.$[0].annotationsFeature=this.feature,_.defer(this.updateSizeAndPosition)}},preview:function(point){this.that.x=Math.min(Math.max(this.that.x,this.that.startX),point.x),this.that.y=Math.min(Math.max(this.that.y,this.that.startY),point.y),this.that.width=Math.abs(point.x-this.that.startX),this.that.height=Math.abs(point.y-this.that.startY),this.updateSizeAndPosition()},postview:function(point){this.that.width||this.that.height||this.feature.remove()},updateSizeAndPosition:function(){this.$.css({height:this.that.height,width:this.that.width,left:this.that.x,top:this.that.y}),this.$.show()}}),a5.Annotations.V.extend("a5.Annotations.Content.InverseMaskView",{init:function(that,feature){this._super(that),_.bindAll(this,"updateSizeAndPosition","moveStart","moveDrag","moveEnd","onClickClose","onClickOutside","resizeStart","resize","resizeEnd"),this.feature=feature,this.$=void 0},render:function(){if(a5a.stage.view.$current){if(this.$=$("<div>",{class:"content content-inverse-mask"}),this.$.appendTo(a5a.stage.view.$current),this.$close=$("<div>",{class:"close"}).appendTo(this.$),this.$top=$("<div>",{class:"inverse-mask-out top"}).appendTo(this.$),this.$left=$("<div>",{class:"inverse-mask-out left"}).appendTo(this.$),this.$right=$("<div>",{class:"inverse-mask-out right"}).appendTo(this.$),this.$bottom=$("<div>",{class:"inverse-mask-out bottom"}).appendTo(this.$),void 0===this.that.width||void 0===this.that.height){this.that.width=a5a.config.defaultMaskSize*a5a.stage.view.$current[0].ratio,this.that.height=a5a.config.defaultMaskSize*a5a.stage.view.$current[0].ratio;var bounds=this.bounds();this.that.x-=Math.max(0,this.that.x-bounds[2]),this.that.y-=Math.max(0,this.that.y-bounds[3])}this.$[0].annotationsFeature=this.feature,this.$.resizable().draggable({cancel:".inverse-mask-out, .close"});var page=a5a.intView.model.pages[a5a.stage.drawing.annotation];a5.hooks.ppebookInverseMaskRendered.call(this,{x:this.that.x,y:this.that.y,url:page.url}),this.updateSizeAndPosition(),this.bindEvents()}},preview:function(point){},postview:function(point){},bindEvents:function(){this.$.on("click",".close",this.onClickClose).on("click",".inverse-mask-out",this.onClickOutside).on("dragstart",this.moveStart).on("drag",this.moveDrag).on("dragstop",this.moveEnd).on("resizestart",this.resizeStart).on("resize",this.resize).on("resizestop",this.resizeEnd)},bounds:function(){var $stage=this.$.parents(".annotations-stage");return[0,0,$stage.width()-this.that.width,$stage.height()-this.that.height]},updateSizeAndPosition:function(){this.$.css({height:this.that.height,width:this.that.width,left:this.that.x,top:this.that.y}),this.$.show()},close:function(){a5.hooks.ppebookInverseMaskClose.call(this),this.feature.remove()},onClickClose:function(e){e.stopPropagation(),this.close()},onClickOutside:function(e){e.stopPropagation(),this.close()},moveStart:function(ev,ui){ev.stopPropagation(),this.cursorPosition={x:ev.clientX,y:ev.clientY},a5a.history.expectChange(this.feature.drawing)},moveDrag:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var changeLeft=ev.clientX-this.cursorPosition.x,changeTop=ev.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+changeLeft)/this.zoomScale),newTop=Math.round((ui.originalPosition.top+changeTop)/this.zoomScale),bounds=this.bounds();ui.position.left=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=Math.min(Math.max(newTop,bounds[1]),bounds[3]),a5.hooks.ppebookInverseMaskDragging.call(this,{x:ui.position.left,y:ui.position.top})}},moveEnd:function(ev,ui){ui&&(ev.stopPropagation(),this.that.startX=this.that.x=ui.position.left,this.that.startY=this.that.y=ui.position.top,this.feature.isExportable&&a5a.current.changed(!0))},resizeStart:function(ev,ui){a5a.stage.view.$current.addClass("isDrawing"),a5a.history.expectChange(this.feature.drawing)},resize:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var deltaX=ui.size.width-ui.originalSize.width,deltaY=ui.size.height-ui.originalSize.height,newWidth=ui.originalSize.width+deltaX/this.zoomScale,newHeight=ui.originalSize.height+deltaY/this.zoomScale,$stage=this.$.parents(".annotations-stage");ui.originalPosition.left+newWidth>$stage.width()&&(newWidth=$stage.width()-ui.originalPosition.left),ui.originalPosition.top+newHeight>$stage.height()&&(newHeight=$stage.height()-ui.originalPosition.top),ui.size.width=newWidth,ui.size.height=newHeight}},resizeEnd:function(ev,ui){this.that.width=ui.size.width,this.that.height=ui.size.height,a5a.stage.view.$.removeClass("isDrawing"),this.feature.isExportable&&a5a.current.changed(!0)}}),a5.Annotations.V.extend("a5.Annotations.Content.MaskView",{init:function(that,feature){this._super(that),_.bindAll(this,"updateSizeAndPosition","moveStart","moveDrag","moveEnd","resizeStart","resizeEnd","onClickClose","resize"),this.feature=feature,this.$=void 0},render:function(){if(a5a.stage.view.$current){if(this.$=$("<div>",{class:"content content-mask"}),this.$.appendTo(a5a.stage.view.$current),this.$close=$("<div>",{class:"close"}).appendTo(this.$),this.$effects=$("<div>",{class:"effects"}).appendTo(this.$),void 0===this.that.width||void 0===this.that.height){this.that.width=a5a.config.defaultMaskSize*a5a.stage.view.$current[0].ratio,this.that.height=a5a.config.defaultMaskSize*a5a.stage.view.$current[0].ratio;var bounds=this.bounds();this.that.x-=Math.max(0,this.that.x-bounds[2]),this.that.y-=Math.max(0,this.that.y-bounds[3])}this.$[0].annotationsFeature=this.feature,this.$.resizable().draggable({cancel:".close"});var page=a5a.intView.model.pages[a5a.stage.drawing.annotation];a5.hooks.ppebookMaskRendered.call(this,{x:this.that.x,y:this.that.y,url:page.url}),this.updateSizeAndPosition(),this.bindEvents()}},preview:function(point){},postview:function(point){},bindEvents:function(){this.$.on("click",".close",this.onClickClose).on("dragstart",this.moveStart).on("drag",this.moveDrag).on("dragstop",this.moveEnd).on("resizestart",this.resizeStart).on("resize",this.resize).on("resizestop",this.resizeEnd)},bounds:function(){var $stage=this.$.parents(".annotations-stage");return[0,0,$stage.width()-this.that.width,$stage.height()-this.that.height]},updateSizeAndPosition:function(){this.$.css({height:this.that.height,width:this.that.width,left:this.that.x,top:this.that.y}),this.$.css("display","")},close:function(){a5.hooks.ppebookMaskClose.call(this),this.feature.remove()},onClickClose:function(e){e.stopPropagation(),this.close()},moveStart:function(ev,ui){ev.stopPropagation(),this.cursorPosition={x:ev.clientX,y:ev.clientY},a5a.history.expectChange(this.feature.drawing)},moveDrag:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var changeLeft=ev.clientX-this.cursorPosition.x,changeTop=ev.clientY-this.cursorPosition.y,newLeft=Math.round((ui.originalPosition.left+changeLeft)/this.zoomScale),newTop=Math.round((ui.originalPosition.top+changeTop)/this.zoomScale),bounds=this.bounds();ui.position.left=Math.min(Math.max(newLeft,bounds[0]),bounds[2]),ui.position.top=Math.min(Math.max(newTop,bounds[1]),bounds[3]),a5.hooks.ppebookMaskDragging.call(this,{x:ui.position.left,y:ui.position.top})}},moveEnd:function(ev,ui){ui&&(ev.stopPropagation(),this.that.startX=this.that.x=ui.position.left,this.that.startY=this.that.y=ui.position.top,this.feature.isExportable&&a5a.current.changed(!0))},resizeStart:function(ev,ui){a5a.stage.view.$current.addClass("isDrawing"),a5a.history.expectChange(this.feature.drawing)},resize:function(ev,ui){if(ev.stopPropagation(),ui){this.zoomScale=a5a.current.view.zoom();var deltaX=ui.size.width-ui.originalSize.width,deltaY=ui.size.height-ui.originalSize.height,newWidth=ui.originalSize.width+deltaX/this.zoomScale,newHeight=ui.originalSize.height+deltaY/this.zoomScale,$stage=this.$.parents(".annotations-stage");ui.originalPosition.left+newWidth>$stage.width()&&(newWidth=$stage.width()-ui.originalPosition.left),ui.originalPosition.top+newHeight>$stage.height()&&(newHeight=$stage.height()-ui.originalPosition.top),ui.size.width=newWidth,ui.size.height=newHeight}},resizeEnd:function(ev,ui){this.that.width=ui.size.width,this.that.height=ui.size.height,a5a.stage.view.$.removeClass("isDrawing"),this.feature.isExportable&&a5a.current.changed(!0)}}),a5.Annotations.V.extend("a5.Annotations.KeyboardEventsView",{init:function(that){this._super(that);var key=a5a.config.i18nKey();this.$node=a5a.toolbox.view.$,this.$node.on(key.toolCursor,this._onToolCursor.bind(this)),this.$node.on(key.toolPen,this.clickOn("#annotations-toolbox .tool-pen")),this.$node.on(key.toolHighlighter,this.clickOn("#annotations-toolbox .tool-highlighter")),this.$node.on(key.toolEraser,this.clickOn("#annotations-toolbox .tool-eraser")),this.$node.on(key.toolStickyNote,this.clickOn("#annotations-toolbox .tool-sticky-note")),this.$node.on(key.toolSpotlight,this.clickOn("#annotations-toolbox .tool-spotlight")),this.$node.on(key.toolHide,this.clickOn("#annotations-toolbox .tool-hide")),this.$node.on(key.toolShow,this.clickOn("#annotations-toolbox .tool-hide"))},clickOn:function(domSelector,beforeClicks,quiet){return _.bind(function(e){_.each(beforeClicks,function(selector){$(selector).trigger("click",quiet)}),$(domSelector).focus(),setTimeout(function(){$(domSelector).trigger("click",quiet)},a5a.config.focusToClickDelay)},this)},_onToolCursor:function(e){this.clickOn("#annotations-toolbox .tool-cursor",void 0,!0).call(this,e)}}),a5.SimpleAudioPlayer={volume:1,state:"stopped",playingIndex:0,playing:null,init:function(){this.queue=[]},createAudio:function(url){var audio=new Audio;return audio.volume=this.volume,audio.canPlayType("audio/mpeg;")?audio.src=url+".mp3":audio.src=url+".ogg",$(audio).bind("ended",_.bind(this.playNext,this)).bind("play",_.bind(this.setState,this,"playing")).bind("pause",_.bind(this.setState,this,"paused")).bind("timeupdate",_.bind(this.timeUpdate,this)),audio},enque:function(url){url=url.replace(/\.\w+$/,""),this.queue.push(url)},playFirst:function(){this.playAt(0)},playAt:function(index){this.stop(),index>=0&&index<this.queue.length&&(this.playingIndex=index,this.playing=this.createAudio(this.queue[this.playingIndex]),this.playing.play())},playNext:function(){this.playAt(this.playingIndex+1)},playPrevious:function(){this.playAt(this.playingIndex-1)},play:function(){this.playing?this.playing.play():this.playAt(0)},pause:function(){this.playing&&this.playing.pause()},stop:function(){this.playing&&this.playing.pause(),this.playing=null,this.playingIndex=0,this.setState("stopped")},clear:function(){this.stop(),this.queue=[]},changeVolume:function(value){this.volume=value,this.playing&&(this.playing.volume=value),this.trigger("change_volume")},setState:function(newState){this.state=newState,this.trigger("change_state")},timeUpdate:function(){this.playing?this.trigger("time_update",this.playing.currentTime,this.playing.duration):this.trigger("time_update",NaN,NaN)}},Obj.extend("a5.SimpleAudioPlayer"),a5.models.interaction.PPAudioBook={init:function(parameters){this._super(parameters,{coverUrl:"",title:null})}},a5.models.interaction.Book.extend("a5.models.interaction.PPAudioBook"),a5.views.interaction.PPAudioBook={template:"audio_book",init:function(model){this._super(model,null,$('<div class="audio-book book"></div>')),this.toolbar=new a5.views.interaction.PPAudioBookToolbar(model,this),this.audioPlayer=this.toolbar.audioPlayer.player,this.audioPlayer.bind("change_state",this.changeActive,this),this.chapters=[]},append:function(title,audio){this.audioPlayer.enque(audio);var index=this.chapters.length,chapter=new a5.views.interaction.PPAudioBookChapter(title);chapter.bind("click",function(){this.openChapter(index)},this),this.chapters.push(chapter)},render:function(){return this._super(),this.node.append(this.toolbar.render()),this.$(".cover-image").attr("src",this.model.coverUrl),_(this.chapters).each(function(chapter){this.$(".chapters").append(chapter.render())},this),this.bindNode("click",".go-next",function(){this.audioPlayer.playNext()}),this.bindNode("click",".go-previous",function(){this.audioPlayer.playPrevious()}),this.node},openChapter:function(index){this.audioPlayer.playAt(index)},changeActive:function(){this.$(".chapter").removeClass("active"),this.audioPlayer.playing&&this.chapters[this.audioPlayer.playingIndex].node.addClass("active")}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPAudioBook"),a5.views.interaction.PPAudioBookToolbar={template:"audio_book_toolbar",init:function(model,parent){this._super(model,parent),this.audioProgress=new a5.views.interaction.BookSlider,this.audioProgress.bind("change",this.changeAudioProgress,this),this.audioPlayer.player.bind("time_update",this.timeUpdate,this)},render:function(){return this._super(),this.$(".time-progress").after(this.audioProgress.render()),this.node},secondsToTime:function(seconds){return isNaN(seconds)?"--:--":a5.utils.secondsToTime(seconds)},timeUpdate:function(current,total){this.audioProgress.setMax(total),this.audioProgress.setTo(current),this.$(".time-progress").text(this.secondsToTime(current)),this.$(".time-total").text(this.secondsToTime(total))},changeAudioProgress:function(){var playing=this.audioPlayer.player.playing;playing&&(playing.currentTime=this.audioProgress.current)}},a5.views.interaction.BookToolbar.extend("a5.views.interaction.PPAudioBookToolbar"),a5.views.interaction.PPAudioBookChapter={init:function(title){this._super(null,null,$('<div class="chapter"></div>')),this.title=title},render:function(){return this._super(),this.node.text(this.title),this.bindNode("click",this.clicked),this.node},clicked:function(){this.trigger("click")}},a5.views.interaction.TemplateView.extend("a5.views.interaction.PPAudioBookChapter"),a5.model_builder.PPAudioBook={isResponsible:function($node){return $node.is("audiobook")},buildAudiobook:function(interaction,$parentNode,$node){var model=new a5.models.interaction.PPAudioBook({title:$node.attr("title"),coverUrl:A5.ASSET_URL_BUILDER($node.attr("coverurl"))});interaction.blockItems.add(model);var view=new a5.views.interaction.PPAudioBook(model);_.each($node.find("> chapters > chapter"),function(chapterNode){var $chapter=$(chapterNode);view.append($chapter.attr("title"),$chapter.attr("audio"))},this),this.buildBook($node,view,model),$parentNode.append(view.render()),view.audioPlayer.play()}},a5.model_builder.BookBuilder.extend("a5.model_builder.PPAudioBook"),a5.annotations.Canvas={init:function(options,defaults){this._super(options,$.extend({readOnly:!1},defaults)),this.children=[],this.history=[],this.redoHistory=[]},append:function(child){return this.children.push(child),this.trigger("change:children"),child},savePoint:function(){this.redoHistory=[],this.history.push(this.children.slice(0)),this.trigger("change:history")},setChildren:function(children){this.children=children,this.trigger("change:children")},undo:function(){
this.redoHistory.push(this.children),this.setChildren(this.history.pop()),this.trigger("change:history")},redo:function(){this.history.push(this.children.slice(0)),this.setChildren(this.redoHistory.pop()),this.trigger("change:history")},store:function(){return{children:this.children}},restore:function(data){data&&(this.children=data.children)}},a5.models.interaction.BaseModel.extend("a5.annotations.Canvas"),a5.annotations.CanvasView={init:function(model,$node){this._super(model,null,$node),this.bindEvents()},reset:function(){this.unbindEvents()},clear:function(){this.model.setChildren([])},bindEvents:function(){this.model.bind("change:children",this.repaint,this)},unbindEvents:function(){this.model.unbind("change:children",this.repaint)},render:function(){return this._super(),this.node.toggleClass("read-only",this.model.readOnly),this.paper=this.paper||Raphael(this.node[0],this.node.width(),this.node.height()),this.repaint(),this.$svg=$(this.paper.canvas),this.$svg.off("mousedown").on("mousedown",_.bind(this.mousedown,this)),this.$svg.off("touchstart").on("touchstart",_.bind(this.touchstart,this)),this.node.off("click").on("click",_.bind(this.click,this)),this.node},toRelative:function(x,y){var offset=this.node.offset(),matrix=this.node.transformationMatrix(!0),scale=matrix.getScale();return new Point((x-offset.left)/scale,(y-offset.top)/scale)},triggerTool:function(type,e){this.currentTool.trigger(type,this,this.toRelative(e.pageX,e.pageY))},mousedown:function(e){0===e.button&&(e.preventDefault(),e.stopPropagation(),this.$svg.on("mousemove",_.bind(this.mousemove,this)),this.$svg.on("mouseup mouseleave",_.bind(this.mouseup,this)),this.triggerTool("mousedown",e))},mousemove:function(e){e.preventDefault(),e.stopPropagation(),this.triggerTool("mousemove",e)},mouseup:function(e){0===e.button&&(this.$svg.off("mousemove mouseup mouseleave"),this.triggerTool("mouseup",e))},touchstart:function(e){e.preventDefault(),e.stopPropagation(),this.node.on("touchmove",_.bind(this.touchmove,this)),this.node.on("touchend touchcancel",_.bind(this.touchend,this)),this.triggerTool("mousedown",e.originalEvent.changedTouches[0])},touchmove:function(e){e.preventDefault(),e.stopPropagation(),this.triggerTool("mousemove",e.originalEvent.changedTouches[0])},touchend:function(e){this.node.off("touchmove touchend touchcancel"),this.triggerTool("mouseup",e.originalEvent.changedTouches[0])},click:function(e){$(e.target).is(this.node)&&0===e.button&&this.triggerTool("click",e)},repaint:function(){this.paper&&(this.paper.clear(),this.node.find(".sticky-note").remove(),_.each(this.model.children,function(child){"sticky-note"==child.type?this.paintNote(child):this.paper.add([child])},this))},paintNote:function(model){var view=new a5.annotations.StickyNoteView(model,this);view.bind("remove",function(){this.model.children=_.without(this.model.children,model),this.repaint()},this),this.node.append(view.render())},setScale:function(scale){this.scale=scale,this.trigger("zoom:change",scale)}},a5.views.interaction.BaseView.extend("a5.annotations.CanvasView"),a5.annotations.ToolbarView={currentButton:null,init:function(model){this._super(model,null,$('<div class="annotations-toolbar"></div>')),this.model.annotationsCanvas.model.bind("change:children",this._onChangeChildren,this),this.buttons={}},setModel:function(model){this.model=model,this.model.annotationsCanvas.model.bind("change:children",this._onChangeChildren,this),_.each(this.buttons,function(button){button.reset(),button.canvas=this.model.annotationsCanvas},this)},store:function(){return _.map(this.buttons,function(button){return button.store?button.store():void 0})},restore:function(data){_.each(data,function(button_data,index){button_data&&this.buttons[index]&&this.buttons[index].restore(button_data)},this)},reset:function(){this.model.annotationsCanvas.model.unbind("change:children",this._onChangeChildren),_.each(this.buttons,function(button){button.reset()},this)},renderToggleButton:function(tool,$node){return this.renderButton(new a5.annotations.ToolbarToggleButtonView($node,tool))},renderButton:function(button){return button.canvas=this.model.annotationsCanvas,button.bind("clicked",function(){this.currentButton&&button.deselects_active&&this.currentButton.deactivate(),button.deactivate&&(this.currentButton=button)},this),button.render(),this.buttons.push(button),button},render:function(){this._super(),this.buttons=[],this.node.empty(),this.node.removeClass("open"),this.$().append(a5.service.templates.render("a5.annotations.Toolbar",{}));var model=this.model.annotationsCanvas.model;this.renderButton(new a5.annotations.OnOff(this.$(".on-off"),model)),this.renderButton(new a5.annotations.ClearAll(this.$(".clear-all"),model)),this.renderButton(new a5.annotations.Undo(this.$(".undo"),model)),this.renderButton(new a5.annotations.Redo(this.$(".redo"),model)),this.renderButton(new a5.annotations.Timer(this.$(".toggle-countdown"),model)),this.renderButton(new a5.annotations.Zoom(this.$(".zoom"),model)),_.each(this.$(".overlay-image"),function(node){this.renderButton(new a5.annotations.OverlayImage($(node),model))},this);var togglebuttons={stickynote:[new a5.annotations.StickyNotes,this.$(".sticky-notes")],pen:[new a5.annotations.Pen,this.$(".pen")],eraser:[a5.dp.config.annotationsUseRealEraser?new a5.annotations.SvgPathEraser:new a5.annotations.Eraser,this.$(".eraser")],brush:[new a5.annotations.Brush,this.$(".brush")],pointer:[new a5.annotations.Pointer,this.$(".pointer")],"straight-line":[new a5.annotations.StraightLine,this.$(".straight-line")]};return _.each(togglebuttons,function(value,key){var button=this.renderToggleButton.apply(this,value);key===a5.dp.config.annotationsDefaultTool&&button.activate()},this),this.node.off("click",".toggle").on("click",".toggle",_.bind(this.toggleTools,this)),this.node.off("click",".zoom").on("click",".zoom",_.bind(this.toggleZoom,this)),this.node},toggleZoom:function(){var $subject=$("#maincontent"),zoomed=this.node.hasClass("zoomed");zoomed?(this.node.removeClass("zoomed"),this.node.off("click",".toggle").on("click",".toggle",_.bind(this.toggleTools,this)),this.enableAll(),this.model.annotationsCanvas.setScale(1),$subject.zoom(1)):(this.node.addClass("zoomed"),this.node.off("click",".toggle"),this.$(".tools .toggle-countdown button").prop("disabled",!0),this.$(".tools .punctuation button").prop("disabled",!0),this.$(".tools .connectives button").prop("disabled",!0),this.model.annotationsCanvas.setScale(2),$subject.zoom(2),this.$(".tools .pointer.tool button").click());var scaledHeight=$subject[0].getBoundingClientRect().height,isScaled=$subject.outerHeight()!==scaledHeight;this.model.$("div.scroll.mCustomScrollbar").css({height:isScaled?scaledHeight:""}),this.model.$("div.scroll.mCustomScrollbar").toggleClass("scaled",isScaled),this.model.$("div.scroll.mCustomScrollbar").mCustomScrollbar("update"),zoomed||this.model.$("div.scroll.mCustomScrollbar").mCustomScrollbar("disable"),$("#micro_controls, #page_controls").toggle(zoomed)},toggleTools:function(){this.$(".tools").toggle(),"none"!=this.$(".tools").css("display")?this.node.addClass("open"):this.node.removeClass("open")},minimizeTools:function(){this.$(".tools").toggle(!1),this.node.removeClass("open")},maximizeTools:function(){this.$(".tools").toggle(!0),this.node.addClass("open")},toolsAreVisible:function(){return this.node.is(".open")},disableAll:function(){this.$(".tools button").prop("disabled",!0),_.each(this.buttons,function(button){button.deactivate&&button.deactivate()},this)},enableAll:function(){_.each(this.buttons,function(button){button.checkEnabled()},this)},_onChangeChildren:function(){this.model.store&&this.model.store(),this.model.model&&this.model.model.store&&this.model.model.store()}},a5.views.interaction.BaseView.extend("a5.annotations.ToolbarView"),a5.annotations.ToolbarButtonView={canvas:null,deselects_active:!1,init:function($node,model){this._super(model,null,$node)},render:function(){return this._super(),this.checkEnabled(),this.node.on("click","button",_.bind(this.clicked,this)),this.node},clicked:function(){this.enabled&&this.activate(),this.checkEnabled()},activate:function(){this.trigger("clicked")},reset:function(){},enabled:function(){return!0},checkEnabled:function(){this.$("button").prop("disabled",!this.enabled())}},a5.views.interaction.BaseView.extend("a5.annotations.ToolbarButtonView"),a5.annotations.ToolbarToggleButtonView={deselects_active:!0,render:function(){return this._super(),this.node.on("click",".color",_.bind(this.setToolColor,this)),this.node.on("click",".shape",_.bind(this.setToolShape,this)),this.$(".color:first").click(),this.$(".shape:first").click(),this.node},store:function(){return{active:this.model.activated,color:this.model.color,shape:this.model.shape,palette_index:this.palette_index}},restore:function(data){if(data.active&&this.activate(),data.shape&&this._setShape(data.shape),data.color){this._setColor(data.color);var color_node=this.node.find(".palette").children().get(data.palette_index);$(color_node).click()}},activate:function(){this._super(),this.node.addClass("active"),this.$(".colors, .shapes").show(),this.model.activate(this.canvas),this.canvas.currentTool=this.model},deactivate:function(){this.model.deactivate(this.canvas);this.canvas.currentTool;this.canvas.currentTool=null,this.node.removeClass("active"),a5.dp.config.annotationsKeepPaletteOpen||this.$(".colors, .shapes").hide()},setToolColor:function(e){e.clientX&&this.activate(),this._setColor($(e.target).css("background-color"),$(e.target).index()),a5.dp.config.annotationsKeepPaletteOpen||this.$(".colors").hide()},_setColor:function(color,palette_index){this.model.color=color,this.palette_index=palette_index},setToolShape:function(e){e.clientX&&this.activate(),this._setShape($(e.target).data("shape"),$(e.target).index()),a5.dp.config.annotationsKeepPaletteOpen||this.$(".shapes").hide()},_setShape:function(shape,palette_index){this.model.shape=shape,this.palette_index=palette_index}},a5.annotations.ToolbarButtonView.extend("a5.annotations.ToolbarToggleButtonView"),a5.annotations.TeacherToolbarView={init:function(model,parent,node){this._super(model,parent,$('<div class="annotations-toggle">')),_.bindAll(this,"onToggle")},render:function(){return this.cleanup(),this.node.on("click",this.onToggle),this._super()},cleanup:function(){this.node.off(),this.node.removeClass("off")},setModel:function(model){this.model=model},onToggle:function(){this.model.annotationsCanvas.node.toggle(),this.node.toggleClass("off")},store:function(){return!this.node.hasClass("off")},restore:function(data){this.node.toggleClass("off",!data)}},a5.views.interaction.BaseView.extend("a5.annotations.TeacherToolbarView"),a5.annotations.MouseTool={activate:function(canvas){this.activated=!0,canvas.$svg.css("pointer-events","visiblePainted"),canvas.node.css("background","rgba(0, 0, 0, 0)"),canvas.node.addClass(this.canvasClass)},deactivate:function(canvas){this.activated=!1,canvas.$svg.css("pointer-events","none"),canvas.node.css("background",""),canvas.node.removeClass(this.canvasClass)}},Obj.extend("a5.annotations.MouseTool"),a5.annotations.Pointer={activate:function(canvas){},deactivate:function(canvas){}},Obj.extend("a5.annotations.Pointer"),a5.annotations.Pen={strokeWidth:2,color:"#000000",canvasClass:"using-pen",init:function(){this.bind("mousedown",this.onStart,this),this.bind("mousemove",this.onMove,this),this.bind("mouseup",this.onEnd,this)},onStart:function(canvas,point){this.currentPathPoints="M"+point.left+","+point.top,this.currentPath=canvas.paper.path(this.currentPathPoints),this.currentPath.attr({stroke:this.color,"stroke-width":this.strokeWidth,"stroke-linecap":"round","stroke-linejoin":"bevel"})},onMove:function(canvas,point){this.currentPathPoints+="L"+point.left+","+point.top,this.currentPath.attr({path:this.currentPathPoints})},onEnd:function(canvas,point){canvas.model.savePoint();var attrs=_.extend(this.currentPath.attrs,{type:"path"});canvas.model.append(attrs)}},a5.annotations.MouseTool.extend("a5.annotations.Pen"),a5.annotations.Brush={strokeWidth:12,canvasClass:"using-brush"},a5.annotations.Pen.extend("a5.annotations.Brush"),a5.annotations.StraightLine={distance:20,strokeWidth:2,color:"#000000",canvasClass:"using-straight-line",init:function(){this.$point=$('<div class="straight-line-anchor-point"></div>'),this.bind("mousedown",this.onStart,this),this.bind("mousemove",this.onMove,this),this.bind("mouseup",this.onEnd,this)},deactivate:function(canvas){this._super(canvas),this.isDragging=!1,this.wasFirstClicked=!1,this.$point.remove()},onStart:function(canvas,point){this.isDragging=!1,this.wasFirstClicked||(canvas.node.append(this.$point),this.$point.css({left:point.left,top:point.top}),this.currentPathStartPoint="M"+point.left+","+point.top,this.currentPath=canvas.paper.path(this.currentPathStartPoint),this.currentPath.attr({stroke:this.color,"stroke-width":this.strokeWidth,"stroke-linecap":"round","stroke-linejoin":"bevel"}),this.origin=point)},onMove:function(canvas,point){var dx=Math.abs(point.left-this.origin.left),dy=Math.abs(point.top-this.origin.top);!this.isDragging&&dx<this.distance&&dy<this.distance||(this.$point.remove(),this.isDragging=!0,this.currentPathPoints=this.currentPathStartPoint+"L"+point.left+","+point.top,this.currentPath.attr({path:this.currentPathPoints}))},onEnd:function(canvas,point){var isSecondClick=!this.isDragging&&this.wasFirstClicked;if(isSecondClick&&(this.$point.remove(),this.currentPathPoints=this.currentPathStartPoint+"L"+point.left+","+point.top,this.currentPath.attr({path:this.currentPathPoints})),this.isDragging||isSecondClick){canvas.model.savePoint();var attrs=_.extend(this.currentPath.attrs,{type:"path"});canvas.model.append(attrs)}this.wasFirstClicked=!this.isDragging&&!this.wasFirstClicked}},a5.annotations.MouseTool.extend("a5.annotations.StraightLine"),a5.annotations.Eraser={canvasClass:"using-eraser",init:function(){this.bind("mousedown mousemove mouseup",this.erase,this)},erase:function(canvas,point){var offset=canvas.$svg.parent().offset(),element=canvas.paper.getElementByPoint(point.left+offset.left-window.pageXOffset,point.top+offset.top-window.pageYOffset);element&&(canvas.model.savePoint(),canvas.model.children=_.reject(canvas.model.children,function(child){return _.isEqual(child.path,element.attr("path"))}),canvas.model.trigger("change:children"))}},a5.annotations.MouseTool.extend("a5.annotations.Eraser"),a5.annotations.SvgPathEraser={strokeWidth:12,canvasClass:"using-eraser",init:function(){this.bind("mousedown",this.onStart,this),this.bind("mousemove",this.onMove,this),this.bind("mouseup",this.onEnd,this)},onStart:function(canvas,point){canvas.model.savePoint(),this.currentPathPoints="M"+point.left+","+point.top,this.currentPath=canvas.paper.path(this.currentPathPoints),this.currentPath.attr({"stroke-opacity":0,"stroke-width":this.strokeWidth,"stroke-linecap":"round","stroke-linejoin":"bevel"})},onMove:function(canvas,point){this.currentPathPoints+="L"+point.left+","+point.top,this.currentPath.attr({path:this.currentPathPoints}),this._erase(canvas)},onEnd:function(canvas,point){this._erase(canvas)},_erase:function(canvas){var newpaths=erase(this._getCurrentPaths(canvas),{points:this._convertToArrayPath(this.currentPath.attr("path")),attrs:this.currentPath.attrs},this.strokeWidth);this._update(canvas,newpaths)},_update:function(canvas,newpaths){var children=[];_(newpaths).each(function(path){var strPath=this._convertToRaphaelStringPath(path.points),p=canvas.paper.path(strPath);p.attr(path.attrs),p.attr("stroke",""),children.push(_.extend(p.attrs,{stroke:path.attrs.stroke,type:"path"}))},this),canvas.model.setChildren(children)},_getCurrentPaths:function(canvas){return _(canvas.model.children).chain().where({type:"path"}).map(function(child){return{attrs:_.omit(child,"path"),points:this._convertToArrayPath(child.path)}},this).value()},_convertToRaphaelStringPath:function(path){return _(path).reduce(function(memo,point,index){return memo+(0===index?"M":"L")+point.join(",")},"")},_convertToArrayPath:function(path){return _(path).map(function(point){return _.rest(point)})}},a5.annotations.MouseTool.extend("a5.annotations.SvgPathEraser"),a5.annotations.ClearAll={activate:function(){this._super(),this.canvas.model.savePoint(),this.canvas.model.setChildren([])}},a5.annotations.ToolbarButtonView.extend("a5.annotations.ClearAll"),a5.annotations.OnOff={activated:!0,activate:function(){this._super(),this.activated=!this.activated,this.updateDomStatus()},updateDomStatus:function(){this.canvas.node.toggle(this.activated),this.node.toggleClass("off",!this.activated)},store:function(){return{active:this.activated}},restore:function(data){this.activated=data.active,this.updateDomStatus()}},a5.annotations.ToolbarButtonView.extend("a5.annotations.OnOff"),a5.annotations.Undo={init:function($node,model){this._super($node,model),this.model.bind("change:history",this.checkEnabled,this)},activate:function(){this._super(),this.model.undo()},enabled:function(){return this.model.history.length>0}},a5.annotations.ToolbarButtonView.extend("a5.annotations.Undo"),a5.annotations.Redo={init:function($node,model){this._super($node,model),this.model.bind("change:history",this.checkEnabled,this)},activate:function(){this._super(),this.canvas.model.redo()},enabled:function(){return this.canvas.model.redoHistory.length>0}},a5.annotations.ToolbarButtonView.extend("a5.annotations.Redo"),a5.annotations.OverlayImage={render:function(){return this._super(),this.$image=this.$("img").detach(),this.node},activate:function(){this._super(),this.$image.parent().length>0?this.$image.detach():this.$image.appendTo($("body")).draggable()},reset:function(){this.$image&&this.$image.remove()}},a5.annotations.ToolbarButtonView.extend("a5.annotations.OverlayImage"),a5.annotations.StickyNotes={canvasClass:"using-sticky-notes",color:"black",shape:"",init:function(){this.bind("click",this.addNote,this)},activate:function(canvas){this.activated=!0,canvas.$svg.css("pointer-events","none"),canvas.node.css("pointer-events","auto"),canvas.node.css("background","rgba(0, 0, 0, 0)"),canvas.node.addClass(this.canvasClass)},deactivate:function(canvas){this.activated=!1,canvas.$svg.css("pointer-events",""),canvas.node.css("pointer-events",""),canvas.node.css("background",""),canvas.node.removeClass(this.canvasClass)},addNote:function(canvas,point){canvas.$svg.offset();canvas.model.savePoint(),canvas.model.append({type:"sticky-note",left:point.left,top:point.top,collapsed:!1,content:"",shape:this.shape,color:this.color})}},Obj.extend("a5.annotations.StickyNotes"),a5.annotations.StickyNoteView={init:function(model,canvas){this._super(model,null,$('<div class="sticky-note"></div>')),this.canvas=canvas,this.canvas.bind("zoom:change",_.bind(this._updateScale,this))},render:function(){this._super(),this.node.empty(),this.node.off(),this.node.hasClass("ui-draggable")&&this.node.draggable("destroy"),this.node.hasClass("ui-resizable")&&this.node.resizable("destroy"),this.node.toggleClass("expanded",!this.model.collapsed);var template="a5.annotations.StickyNote";if(this.model.collapsed?(template+="Collapsed",this.node.css({width:"auto",height:"auto"})):(template+=this.model.shape,this.node.css({width:this.model.width+"px",height:this.model.height+"px"})),this.node.append(a5.service.templates.render(template,{content:this.model.content})),this.node.addClass(this.model.shape.toLowerCase()),this.node.css({position:"absolute",top:this.model.top+"px",left:this.model.left+"px",backgroundColor:this.model.color,pointerEvents:"auto"}),this.node.on("click",".icon-collapse",_.bind(this.collapse,this)),this.node.on("click",".icon-expand",_.bind(this.expand,this)),this.canvas.model.readOnly){var textNode=this.$(".text-content");textNode.is("[contenteditable]")?textNode.attr("contenteditable",null):textNode.attr("disabled",!0),this.$(".icon-delete").hide()}else this.node.on("click",".icon-delete",_.bind(this.remove,this)),this.node.on("keyup",".text-content",_.bind(this.changed,this)),this.node.draggable({stop:_.bind(this.dragged,this),drag:_.bind(this._onDrag,this),cancel:"[contenteditable]"}),this.node.resizable({stop:_.bind(this.resized,this)});return this.node.on("touchstart",function(e){e.stopPropagation()}),this.node.on("touchstart",".text-content",function(e){e.stopPropagation()}),this.node},expand:function(){this.model.collapsed=!1,this.render()},collapse:function(){this.model.collapsed=!0,this.render()},dragged:function(e,ui){this.model.top=ui.position.top,this.model.left=ui.position.left},resized:function(){this.model.height=this.node.height(),this.model.width=this.node.width()},changed:function(){this.model.content=this.$(".text-content").html()},remove:function(){this.trigger("remove"),this.canvas.unbind("zoom:change",this._updateScale)},_onDrag:function(e,ui){ui.position.top=ui.position.top/(this.scale||1),ui.position.left=ui.position.left/(this.scale||1)},_updateScale:function(scale){this.scale=scale}},a5.views.interaction.BaseView.extend("a5.annotations.StickyNoteView"),a5.annotations.Timer={active:!1,activate:function(){if(this._super(),this.active=!this.active,this.node.toggleClass("active",this.active),this.active){this.view=new a5.annotations.TimerView,$("body").append(this.view.render());var offset=this.node.offset();this.view.node.css({position:"absolute",top:offset.top-this.view.node.outerHeight(!0)+"px",left:offset.left})}else this.view.node.remove()},reset:function(){this.view&&(this.view.stop(),this.view.node.remove())}},a5.annotations.ToolbarButtonView.extend("a5.annotations.Timer"),a5.annotations.TimerView={init:function(model){this._super(model,null,$('<div class="countdown"></div>'))},render:function(){return this._super(),this.node.append(a5.service.templates.render("a5.annotations.Timer")),this.stop(),this.node.draggable(),this.node.on("click",".start",_.bind(this.start,this)),this.node.on("click",".stop",_.bind(this.stop,this)),this.node},currentTime:function(){return(new Date).getTime()/1e3},start:function(){this.startTime=this.currentTime(),this.totalTime=60*parseInt(this.$(".total-time").val(),10),this.timeChangeTimer=setInterval(_.bind(this.changeTime,this),100),this.$(".start, .total-time").hide(),this.$(".stop, .time").show()},stop:function(){clearInterval(this.timeChangeTimer),this.$(".start, .total-time").show(),this.$(".stop, .time").hide()},changeTime:function(){var secondsLeft=Math.ceil(this.totalTime+this.startTime-this.currentTime());secondsLeft<0&&(secondsLeft=0),this.$(".time").text(a5.utils.secondsToTime(secondsLeft)),0==secondsLeft&&this.stop()}},a5.views.interaction.BaseView.extend("a5.annotations.TimerView"),a5.annotations.Zoom={},a5.annotations.ToolbarButtonView.extend("a5.annotations.Zoom"),AnimationParser=function(){function SyntaxError(message,expected,found,offset,line,column){this.message=message,this.expected=expected,this.found=found,this.offset=offset,this.line=line,this.column=column,this.name="SyntaxError"}!function(child,parent){function ctor(){this.constructor=child}ctor.prototype=parent.prototype,child.prototype=new ctor}(SyntaxError,Error);function parse(input){var peg$result,options=arguments.length>1?arguments[1]:{},peg$FAILED={},peg$startRuleFunctions={start:peg$parsestart},peg$startRuleFunction=peg$parsestart,peg$c0=peg$FAILED,peg$c1="#scale",peg$c2={type:"literal",value:"#scale",description:'"#scale"'},peg$c3="#",peg$c4={type:"literal",value:"#",description:'"#"'},peg$c5=function(id,scale,flags){return new a5.animations.Scale(id,scale,flags)},peg$c6="#animate",peg$c7={type:"literal",value:"#animate",description:'"#animate"'},peg$c9=function(id,points,flags){return new a5.animations.Move(id,points,flags)},peg$c10="#sequence",peg$c11={type:"literal",value:"#sequence",description:'"#sequence"'},peg$c12=function(id,ids,flags){return new a5.animations.Sequence(id,ids,flags)},peg$c13="*",peg$c14={type:"literal",value:"*",description:'"*"'},peg$c15=/^[^ \t\r\n*#]/,peg$c16={type:"class",value:"[^ \\t\\r\\n*#]",description:"[^ \\t\\r\\n*#]"},peg$c17=function(id){return id.join("")},peg$c18=function(values){return a5.utils.mergeObjects(values)},peg$c19=function(content){return content},peg$c20="duration:",peg$c21={type:"literal",value:"duration:",description:'"duration:"'},peg$c22=function(time){return{duration:time}},peg$c23="pause:",peg$c24={type:"literal",value:"pause:",description:'"pause:"'},peg$c25=function(time){return{pause:time}},peg$c26="endvalue:",peg$c27={type:"literal",value:"endvalue:",description:'"endvalue:"'},peg$c28=function(value){return{endvalue:value}},peg$c29="variable:",peg$c30={type:"literal",value:"variable:",description:'"variable:"'},peg$c31=function(name){return{variable:new a5.animations.VariableEvaluator(name)}},peg$c32="repeat:",peg$c33={type:"literal",value:"repeat:",description:'"repeat:"'},peg$c34=function(times){return{repeat:times}},peg$c35="reverse",peg$c36={type:"literal",value:"reverse",description:'"reverse"'},peg$c37=function(){return{reverse:!0}},peg$c38="audio:",peg$c39={type:"literal",value:"audio:",description:'"audio:"'},peg$c40=/^[^*#]/,peg$c41={type:"class",value:"[^*#]",description:"[^*#]"},peg$c42=function(id){return{audio:id.join("")}},peg$c43="audioloop",peg$c44={type:"literal",value:"audioloop",description:'"audioloop"'},peg$c45=function(){return{audioloop:!0}},peg$c46="transition:",peg$c47={type:"literal",value:"transition:",description:'"transition:"'},peg$c48=function(name){return{transition:name}},peg$c49=null,peg$c50=function(left,top){return new a5.animations.PointEvaluator(left,top)},peg$c51=",",peg$c52={type:"literal",value:",",description:'","'},peg$c53=function(coord){return coord},peg$c54="%",peg$c55={type:"literal",value:"%",description:'"%"'},peg$c56=function(value){return new a5.animations.PctEvaluator(value)},peg$c57=/^[+\-]/,peg$c58={type:"class",value:"[+\\-]",description:"[+\\-]"},peg$c59=function(left,op,right){return new a5.animations.OperationEvaluator(left,right,op)},peg$c60=/^[*\/]/,peg$c61={type:"class",value:"[*\\/]",description:"[*\\/]"},peg$c62="(",peg$c63={type:"literal",value:"(",description:'"("'},peg$c64=")",peg$c65={type:"literal",value:")",description:'")"'},peg$c66=function(additive){return additive},peg$c67="[",peg$c68={type:"literal",value:"[",description:'"["'},peg$c69="]",peg$c70={type:"literal",value:"]",description:'"]"'},peg$c71=function(name){return new a5.animations.VariableEvaluator(name)},peg$c72=".",peg$c73={type:"literal",value:".",description:'"."'},peg$c74=function(content){return new a5.animations.NumberEvaluator(content.join(""))},peg$c75=function(value){return new a5.animations.NumberEvaluator(value)},peg$c76="forever",peg$c77={type:"literal",value:"forever",description:'"forever"'},peg$c78=function(){return 1/0},peg$c79=function(digits){return parseInt(digits)},peg$c80=/^[0-9]/,peg$c81={type:"class",value:"[0-9]",description:"[0-9]"},peg$c82=function(content){return parseInt(content.join(""))},peg$c83=/^[a-zA-Z]/,peg$c84={type:"class",value:"[a-zA-Z]",description:"[a-zA-Z]"},peg$c85=function(chars){return chars.join("")},peg$c86=/^[ \t\r\n]/,peg$c87={type:"class",value:"[ \\t\\r\\n]",description:"[ \\t\\r\\n]"},peg$currPos=0,peg$reportedPos=0,peg$cachedPos=0,peg$cachedPosDetails={line:1,column:1,seenCR:!1},peg$maxFailPos=0,peg$maxFailExpected=[],peg$silentFails=0;if("startRule"in options){if(!(options.startRule in peg$startRuleFunctions))throw new Error("Can't start parsing from rule \""+options.startRule+'".');peg$startRuleFunction=peg$startRuleFunctions[options.startRule]}function peg$computePosDetails(pos){return peg$cachedPos!==pos&&(peg$cachedPos>pos&&(peg$cachedPos=0,peg$cachedPosDetails={line:1,column:1,seenCR:!1}),function(details,startPos,endPos){var p,ch;for(p=startPos;p<endPos;p++)ch=input.charAt(p),"\n"===ch?(details.seenCR||details.line++,details.column=1,details.seenCR=!1):"\r"===ch||"\u2028"===ch||"\u2029"===ch?(details.line++,details.column=1,details.seenCR=!0):(details.column++,details.seenCR=!1)}(peg$cachedPosDetails,peg$cachedPos,pos),peg$cachedPos=pos),peg$cachedPosDetails}function peg$fail(expected){peg$currPos<peg$maxFailPos||(peg$currPos>peg$maxFailPos&&(peg$maxFailPos=peg$currPos,peg$maxFailExpected=[]),peg$maxFailExpected.push(expected))}function peg$buildException(message,expected,pos){var posDetails=peg$computePosDetails(pos),found=pos<input.length?input.charAt(pos):null;return null!==expected&&function(expected){var i=1;for(expected.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0});i<expected.length;)expected[i-1]===expected[i]?expected.splice(i,1):i++}(expected),new SyntaxError(null!==message?message:function(expected,found){var expectedDesc,foundDesc,i,expectedDescs=new Array(expected.length);for(i=0;i<expected.length;i++)expectedDescs[i]=expected[i].description;return expectedDesc=expected.length>1?expectedDescs.slice(0,-1).join(", ")+" or "+expectedDescs[expected.length-1]:expectedDescs[0],foundDesc=found?'"'+function(s){function hex(ch){return ch.charCodeAt(0).toString(16).toUpperCase()}return s.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(ch){return"\\x0"+hex(ch)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(ch){return"\\x"+hex(ch)}).replace(/[\u0180-\u0FFF]/g,function(ch){return"\\u0"+hex(ch)}).replace(/[\u1080-\uFFFF]/g,function(ch){return"\\u"+hex(ch)})}(found)+'"':"end of input","Expected "+expectedDesc+" but "+foundDesc+" found."}(expected,found),expected,found,pos,posDetails.line,posDetails.column)}function peg$parsestart(){var s0;return s0=peg$parseanimationmove(),s0===peg$FAILED&&(s0=peg$parseanimationscale())===peg$FAILED&&(s0=peg$parseanimationsequence()),s0}function peg$parseanimationscale(){var s0,s1,s2,s3,s4,s5;return s0=peg$currPos,input.substr(peg$currPos,6)===peg$c1?(s1=peg$c1,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c2)),s1!==peg$FAILED?(s2=peg$parseobjectid(),s2!==peg$FAILED?(s3=peg$parsepoint(),s3!==peg$FAILED?(s4=peg$parseflags(),s4!==peg$FAILED?(35===input.charCodeAt(peg$currPos)?(s5=peg$c3,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c4)),s5!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c5(s2,s3,s4),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parseanimationmove(){var s0,s1,s2,s3,s4,s5;if(s0=peg$currPos,input.substr(peg$currPos,8)===peg$c6?(s1=peg$c6,peg$currPos+=8):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c7)),s1!==peg$FAILED)if((s2=peg$parseobjectid())!==peg$FAILED){if(s3=[],(s4=peg$parsepoint())!==peg$FAILED)for(;s4!==peg$FAILED;)s3.push(s4),s4=peg$parsepoint();else s3=peg$c0;s3!==peg$FAILED?(s4=peg$parseflags(),s4!==peg$FAILED?(35===input.charCodeAt(peg$currPos)?(s5=peg$c3,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c4)),s5!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c9(s2,s3,s4),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)}else peg$currPos=s0,s0=peg$c0;else peg$currPos=s0,s0=peg$c0;return s0}function peg$parseanimationsequence(){var s0,s1,s2,s3,s4,s5;if(s0=peg$currPos,input.substr(peg$currPos,9)===peg$c10?(s1=peg$c10,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c11)),s1!==peg$FAILED)if((s2=peg$parseobjectid())!==peg$FAILED){for(s3=[],s4=peg$parseobjectid();s4!==peg$FAILED;)s3.push(s4),s4=peg$parseobjectid();s3!==peg$FAILED?(s4=peg$parseflags(),s4!==peg$FAILED?(35===input.charCodeAt(peg$currPos)?(s5=peg$c3,peg$currPos++):(s5=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c4)),s5!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c12(s2,s3,s4),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)}else peg$currPos=s0,s0=peg$c0;else peg$currPos=s0,s0=peg$c0;return s0}function peg$parseobjectid(){var s0,s1,s2,s3;if(s0=peg$currPos,
42===input.charCodeAt(peg$currPos)?(s1=peg$c13,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c14)),s1!==peg$FAILED){if(s2=[],peg$c15.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c16)),s3!==peg$FAILED)for(;s3!==peg$FAILED;)s2.push(s3),peg$c15.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c16));else s2=peg$c0;s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c17(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)}else peg$currPos=s0,s0=peg$c0;return s0}function peg$parseflags(){var s0,s1,s2;for(s0=peg$currPos,s1=[],s2=peg$parseflag();s2!==peg$FAILED;)s1.push(s2),s2=peg$parseflag();return s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c18(s1)),s0=s1}function peg$parseflag(){var s0,s1,s2;return s0=peg$currPos,42===input.charCodeAt(peg$currPos)?(s1=peg$c13,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c14)),s1!==peg$FAILED?(s2=peg$parsedurationflag(),s2===peg$FAILED&&(s2=peg$parsepauseflag())===peg$FAILED&&(s2=peg$parseendvalueflag())===peg$FAILED&&(s2=peg$parsevariableflag())===peg$FAILED&&(s2=peg$parserepeatflag())===peg$FAILED&&(s2=peg$parsereverseflag())===peg$FAILED&&(s2=peg$parseaudioflag())===peg$FAILED&&(s2=peg$parseaudioloopflag())===peg$FAILED&&(s2=peg$parsetransitionflag()),s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c19(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsedurationflag(){var s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,9)===peg$c20?(s1=peg$c20,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c21)),s1!==peg$FAILED?(s2=peg$parsespace(),s2!==peg$FAILED?(s3=peg$parseinteger(),s3!==peg$FAILED?(s4=peg$parsespace(),s4!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c22(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsepauseflag(){var s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,6)===peg$c23?(s1=peg$c23,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c24)),s1!==peg$FAILED?(s2=peg$parsespace(),s2!==peg$FAILED?(s3=peg$parseinteger(),s3!==peg$FAILED?(s4=peg$parsespace(),s4!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c25(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parseendvalueflag(){var s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,9)===peg$c26?(s1=peg$c26,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c27)),s1!==peg$FAILED?(s2=peg$parsespace(),s2!==peg$FAILED?(s3=peg$parseinteger(),s3!==peg$FAILED?(s4=peg$parsespace(),s4!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c28(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsevariableflag(){var s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,9)===peg$c29?(s1=peg$c29,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c30)),s1!==peg$FAILED?(s2=peg$parsespace(),s2!==peg$FAILED?(s3=peg$parseword(),s3!==peg$FAILED?(s4=peg$parsespace(),s4!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c31(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parserepeatflag(){var s0,s1,s2,s3,s4;return s0=peg$currPos,input.substr(peg$currPos,7)===peg$c32?(s1=peg$c32,peg$currPos+=7):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c33)),s1!==peg$FAILED?(s2=peg$parsespace(),s2!==peg$FAILED?(s3=peg$parseinteger(),s3===peg$FAILED&&(s3=peg$parseforever()),s3!==peg$FAILED?(s4=peg$parsespace(),s4!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c34(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsereverseflag(){var s0,s1;return s0=peg$currPos,input.substr(peg$currPos,7)===peg$c35?(s1=peg$c35,peg$currPos+=7):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c36)),s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c37()),s0=s1}function peg$parseaudioflag(){var s0,s1,s2,s3;if(s0=peg$currPos,input.substr(peg$currPos,6)===peg$c38?(s1=peg$c38,peg$currPos+=6):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c39)),s1!==peg$FAILED){for(s2=[],peg$c40.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c41));s3!==peg$FAILED;)s2.push(s3),peg$c40.test(input.charAt(peg$currPos))?(s3=input.charAt(peg$currPos),peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c41));s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c42(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)}else peg$currPos=s0,s0=peg$c0;return s0}function peg$parseaudioloopflag(){var s0,s1;return s0=peg$currPos,input.substr(peg$currPos,9)===peg$c43?(s1=peg$c43,peg$currPos+=9):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c44)),s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c45()),s0=s1}function peg$parsetransitionflag(){var s0,s1,s2;return s0=peg$currPos,input.substr(peg$currPos,11)===peg$c46?(s1=peg$c46,peg$currPos+=11):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c47)),s1!==peg$FAILED?(s2=peg$parseword(),s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c48(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsepoint(){var s0,s1,s2,s3;return s0=peg$currPos,42===input.charCodeAt(peg$currPos)?(s1=peg$c13,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c14)),s1!==peg$FAILED?(s2=peg$parsepercent(),s2===peg$FAILED&&(s2=peg$parseprimary()),s2!==peg$FAILED?(s3=peg$parsesecondcoord(),s3===peg$FAILED&&(s3=peg$c49),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c50(s2,s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsesecondcoord(){var s0,s1,s2;return s0=peg$currPos,44===input.charCodeAt(peg$currPos)?(s1=peg$c51,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c52)),s1!==peg$FAILED?(s2=peg$parsepercent(),s2===peg$FAILED&&(s2=peg$parseprimary()),s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c53(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsepercent(){var s0,s1,s2;return s0=peg$currPos,s1=peg$parseprimary(),s1!==peg$FAILED?(37===input.charCodeAt(peg$currPos)?(s2=peg$c54,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c55)),s2!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c56(s1),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parseadditive(){var s0,s1,s2,s3;return s0=peg$currPos,s1=peg$parsemultiplicative(),s1!==peg$FAILED?(peg$c57.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c58)),s2!==peg$FAILED?(s3=peg$parseadditive(),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c59(s1,s2,s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0===peg$FAILED&&(s0=peg$parsemultiplicative()),s0}function peg$parsemultiplicative(){var s0,s1,s2,s3;return s0=peg$currPos,s1=peg$parseprimary(),s1!==peg$FAILED?(peg$c60.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c61)),s2!==peg$FAILED?(s3=peg$parsemultiplicative(),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c59(s1,s2,s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0===peg$FAILED&&(s0=peg$parseprimary()),s0}function peg$parseprimary(){var s0,s1,s2,s3;return s0=peg$parsefloatvalue(),s0===peg$FAILED&&(s0=peg$parsevariable())===peg$FAILED&&(s0=peg$currPos,40===input.charCodeAt(peg$currPos)?(s1=peg$c62,peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c63)),s1!==peg$FAILED?(s2=peg$parseadditive(),s2!==peg$FAILED?(41===input.charCodeAt(peg$currPos)?(s3=peg$c64,peg$currPos++):(s3=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c65)),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c66(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)),s0}function peg$parsevariable(){var s0,s1,s2,s3,s4,s5;return s0=peg$currPos,s1=peg$parsespace(),s1!==peg$FAILED?(91===input.charCodeAt(peg$currPos)?(s2=peg$c67,peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c68)),s2!==peg$FAILED?(s3=peg$parseword(),s3!==peg$FAILED?(93===input.charCodeAt(peg$currPos)?(s4=peg$c69,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c70)),s4!==peg$FAILED?(s5=peg$parsespace(),s5!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c71(s3),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsefloatvalue(){var s0,s1,s2,s3,s4,s5;return s0=peg$currPos,s1=peg$parsespace(),s1!==peg$FAILED?(s2=peg$currPos,s3=peg$parsedigits(),s3!==peg$FAILED?(46===input.charCodeAt(peg$currPos)?(s4=peg$c72,peg$currPos++):(s4=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c73)),s4!==peg$FAILED?(s5=peg$parsedigits(),s5!==peg$FAILED?(s3=[s3,s4,s5],s2=s3):(peg$currPos=s2,s2=peg$c0)):(peg$currPos=s2,s2=peg$c0)):(peg$currPos=s2,s2=peg$c0),s2!==peg$FAILED?(s3=peg$parsespace(),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c74(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0===peg$FAILED&&(s0=peg$parseintegervalue()),s0}function peg$parseintegervalue(){var s0,s1;return s0=peg$currPos,s1=peg$parseinteger(),s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c75(s1)),s0=s1}function peg$parseforever(){var s0,s1;return s0=peg$currPos,input.substr(peg$currPos,7)===peg$c76?(s1=peg$c76,peg$currPos+=7):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c77)),s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c78()),s0=s1}function peg$parseinteger(){var s0,s1,s2,s3;return s0=peg$currPos,s1=peg$parsespace(),s1!==peg$FAILED?(s2=peg$parsedigits(),s2!==peg$FAILED?(s3=peg$parsespace(),s3!==peg$FAILED?(peg$reportedPos=s0,s1=peg$c79(s2),s0=s1):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0)):(peg$currPos=s0,s0=peg$c0),s0}function peg$parsedigits(){var s0,s1,s2;if(s0=peg$currPos,s1=[],peg$c80.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c81)),s2!==peg$FAILED)for(;s2!==peg$FAILED;)s1.push(s2),peg$c80.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c81));else s1=peg$c0;return s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c82(s1)),s0=s1}function peg$parseword(){var s0,s1,s2;if(s0=peg$currPos,s1=[],peg$c83.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c84)),s2!==peg$FAILED)for(;s2!==peg$FAILED;)s1.push(s2),peg$c83.test(input.charAt(peg$currPos))?(s2=input.charAt(peg$currPos),peg$currPos++):(s2=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c84));else s1=peg$c0;return s1!==peg$FAILED&&(peg$reportedPos=s0,s1=peg$c85(s1)),s0=s1}function peg$parsespace(){var s0,s1;for(s0=[],peg$c86.test(input.charAt(peg$currPos))?(s1=input.charAt(peg$currPos),peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c87));s1!==peg$FAILED;)s0.push(s1),peg$c86.test(input.charAt(peg$currPos))?(s1=input.charAt(peg$currPos),peg$currPos++):(s1=peg$FAILED,0===peg$silentFails&&peg$fail(peg$c87));return s0}if((peg$result=peg$startRuleFunction())!==peg$FAILED&&peg$currPos===input.length)return peg$result;throw peg$result!==peg$FAILED&&peg$currPos<input.length&&peg$fail({type:"end",description:"end of input"}),peg$buildException(null,peg$maxFailExpected,peg$maxFailPos)}return{SyntaxError:SyntaxError,parse:parse}}(),a5.preprocessor.Animations={preprocess:function(txt,interaction){return txt.replace(/#(animate|scale|sequence)[\s\S]*?#/g,function(match){var animation=AnimationParser.parse(match);return interaction.bind("show:deferred",function(){animation.start(interaction)}),""})}},a5.preprocessor.Preprocessor.extend("a5.preprocessor.Animations"),a5.preprocessor.preprocessors.push(new a5.preprocessor.Animations),a5.animations.NumberEvaluator={init:function(value){this.value=parseFloat(value)},exec:function(){return this.value}},Obj.extend("a5.animations.NumberEvaluator"),a5.animations.PctEvaluator={init:function(value){this.value=value},exec:function(animation,options){return this.value.exec(animation,options)/100*animation[options.scale+"scale"]()}},Obj.extend("a5.animations.PctEvaluator"),a5.animations.PointEvaluator={init:function(left,top){this.left=left,this.top=top||left},exec:function(animation,options){return new Point(this.left.exec(animation,_.extend(options||{},{scale:"x"})),this.top.exec(animation,_.extend(options||{},{scale:"y"})))}},Obj.extend("a5.animations.PointEvaluator"),a5.animations.OperationEvaluator={init:function(left,right,op){this.left=left,this.right=right,this.op=op},exec:function(animation,options){var left=this.left.exec(animation,options),right=this.right.exec(animation,options);switch(this.op){case"+":return left+right;case"-":return left-right;case"*":return left*right;case"/":return left/right}}},Obj.extend("a5.animations.OperationEvaluator"),a5.animations.VariableEvaluator={init:function(name){this.name=name},exec:function(animation){return this[this.name](animation)},originx:function(animation){return animation.$node.offset().left-animation.offset.left},originy:function(animation){return animation.$node.offset().top-animation.offset.top},getResults:function(){return a5.mainBuilder.getResults()},score:function(){return this.getResults().percent()},correctanswers:function(){return this.getResults().correct()},revealedanswers:function(){return this.getResults().revealed()},pointsachieved:function(){return this.correctanswers()},totalquestions:function(){return this.getResults().total()},pointsavailable:function(){return this.totalquestions()},incorrectanswers:function(){return this.totalquestions()-this.revealedanswers()-this.correctanswers()}},Obj.extend("a5.animations.VariableEvaluator"),a5.animations.Base={init:function(objectid,options){this.objectid=objectid,this.options=_.defaults(options,{duration:1e3,pause:0,repeat:1}),this.started=!1},start:function(interaction){this.started||(this.started=!0,this.$node=interaction.contentWrap.find("#"+this.objectid),this.prepare(interaction),this.playAudio(),this.restart())},prepare:function(interaction){},playAudio:function(){this.options.audio&&a5.service.media.audio.bind("ready",function(){var playing=a5.service.media.audio.create(this.options.audio,{preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())});this.options.audioloop&&playing.bind("stopped",function(){playing.play()}),playing.play()},this)},animate:function(properties,callback){this.$node.animate(properties,this.options.duration,"linear",callback)},restart:function(){this.options.repeat-=1,this.reset(),this.$node.delay(this.options.pause),this.animateForward(_.bind(this.animationEnded,this))},animationEnded:function(){this.options.reverse?this.animateBackward(_.bind(this.animationEndedNoReverse,this)):this.animationEndedNoReverse()},animationEndedNoReverse:function(){this.options.repeat>0&&this.restart()},createPlaceholder:function(){return $('<span style="display: inline-block;"></span>').css({height:this.$node.outerHeight(!0),width:this.$node.outerWidth(!0)})},chooseFrame:function(frames){var step=this.options.endvalue/frames.length,index=Math.floor(this.options.variable.exec(this)/step);return index<0&&(index=0),index>=frames.length&&(index=frames.length-1),frames[index]}},Obj.extend("a5.animations.Base"),a5.animations.Move={init:function(objectid,points,options){this._super(objectid,options),this.points=points},prepare:function(interaction){this.offset=interaction.contentWrap.offset(),this.startPoint=this.points[0].exec(this),2==this.points.length?this.endPoint=this.twopointEnd(this.startPoint):this.endPoint=this.multipointEnd(),"static"==this.$node.css("position")&&this.addPlaceholder(),this.$node.detach().appendTo(interaction.contentWrap)},addPlaceholder:function(){this.createPlaceholder().insertAfter(this.$node)},animate:function(to,callback){this._super({left:to.left,top:to.top},callback)},reset:function(){this.$node.css({position:"absolute",zIndex:"1000",left:this.startPoint.left,top:this.startPoint.top})},animateForward:function(callback){this.animate(this.endPoint,callback)},animateBackward:function(callback){this.animate(this.startPoint,callback)},twopointEnd:function(start){var end=this.points[1].exec(this);if(this.options.variable){var part=this.options.variable.exec(this)/this.options.endvalue;end.left=start.left+(end.left-start.left)*part,end.top=start.top+(end.top-start.top)*part}return end},multipointEnd:function(){return this.options.variable?this.chooseFrame(this.points.slice(1)).exec(this):this.points[this.points.length-1].exec(this)}},a5.animations.Base.extend("a5.animations.Move"),a5.animations.Scale={init:function(objectid,to,options){this._super(objectid,options),this.to=to},prepare:function(){this.startSize=new Point(this.xscale(),this.yscale()),this.endSize=this.to.exec(this,{})},xscale:function(){return this.$node.width()},yscale:function(){return this.$node.height()},animate:function(to,callback){this._super({width:to.left,height:to.top},callback)},reset:function(){this.$node.css({width:this.startSize.left,height:this.startSize.top})},animateForward:function(callback){this.animate(this.endSize,callback)},animateBackward:function(callback){this.animate(this.startSize,callback)}},a5.animations.Base.extend("a5.animations.Scale"),a5.animations.Sequence={init:function(objectid,ids,options){this._super(objectid,options),this.ids=ids},prepare:function(interaction){_.each(this.ids,function(id){interaction.contentWrap.find("#"+id).hide()},this),this.$node.wrap(this.createPlaceholder().css({position:"relative"})),this.$node.css({position:"absolute",zIndex:"1000"});var resultId=this.chooseFrame(this.ids);interaction.contentWrap.find("#"+resultId).show().css({position:"absolute",zIndex:"900"}).detach().prependTo(this.$node.parent())},animate:function(value,callback){this._super({opacity:value},callback)},reset:function(){this.$node.css({opacity:1})},animateForward:function(callback){this.animate(0,callback)},animateBackward:function(callback){this.animate(1,callback)}},a5.animations.Base.extend("a5.animations.Sequence"),a5.components.Resources={init:function(parameters){this.interaction=parameters.interaction,this.banks=this._getBanks(),this.resourcesPanelView=new a5.view.ResourcesTabPanel({banks:this.banks,maxAddBy:parameters.maxAddBy,interaction:this.interaction})},_initStage:function(){this.resourcesStage=new a5.model.ResourcesStage({banks:this.banks}),this.resourcesStageView=new a5.view.ResourcesStage({model:this.resourcesStage,interaction:this.interaction,$el:this.interaction.$(".interaction")}),this.combinedUndoRedoManager=new a5.CombinedUndoRedoManager({annotations:this.interaction.annotations,stage:this.resourcesStage}),this.combinedUndoRedoManager.bind("change:history",function(){this.trigger("change")},this)},addActivity:function(activityView){this.activity=activityView},show:function(){return this.interaction.resourcesZone.append(this.resourcesPanelView.$el),this.resourcesPanelView.bind("more-resources:show",this._onMoreResourcesShow,this),this.resourcesPanelView.render(),this.resourcesPanelView.isStageEnabled()&&this._initStage(),this.resourcesStageView&&(this.resourcesStageView.bind("resource-item:drop",function($items){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll();var bounds=this.resourcesStageView.region()[0].getBoundingClientRect(),box=$items.addClass("dropping")[0].getBoundingClientRect(),pushLeft=0,pushRight=0,pushTop=0,pushBottom=0;box.left<bounds.left&&(pushRight=bounds.left-box.left),box.right>bounds.right&&(pushLeft=box.right-bounds.right),box.top<bounds.top&&(pushBottom=bounds.top-box.top),box.bottom>bounds.bottom&&(pushTop=box.bottom-bounds.bottom);var $item=$items;$item.children(":first").is(".resource-item")&&($item=$item.children(":first"));var addBy=1;if($item.is(".resource-item")&&(addBy=this.resourcesPanelView.addBy),$item.hasClass("resource-item-composed"))$item.children("[data-item-id]").each(function(index,el){var $el=$(el),x=$el.offset().left-this.resourcesStageView.region().offset().left+pushRight-pushLeft,y=$el.offset().top-this.resourcesStageView.region().offset().top+pushBottom-pushTop,dx=$item[0].getBoundingClientRect().width;_(addBy).times(function(n){this._drop({x:x+dx*n,y:y,id:$el.attr("data-item-id"),bankItemId:$el.attr("data-bank-item-id")})},this)}.bind(this));else{var x=$item.offset().left-this.resourcesStageView.region().offset().left+pushRight-pushLeft,y=$item.offset().top-this.resourcesStageView.region().offset().top+pushBottom-pushTop,dx=$item[0].getBoundingClientRect().width;_(addBy).times(function(n){this._drop({x:x+dx*n,y:y,id:$item.attr("data-item-id"),bankItemId:$item.attr("data-bank-item-id"),$el:$item})},this)}$item.is(".resource-item")&&this.resourcesPanelView.resetAddBy()},this),this.resourcesPanelView.bind("resource-bank-item:click",function($item){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll(),_(this.resourcesPanelView.addBy).times(function(n){$item.hasClass("resource-item-composed")?this._addCompositeToGrid($item):0===$item.closest(".resource-item-composed").length&&this._addToGrid({id:$item.attr("data-item-id"),bankItemId:$item.attr("data-bank-item-id")})},this),this.resourcesPanelView.resetAddBy()},this),this.resourcesStageView.bind("resource-stage-item:drag",this._onResourceStageItemDrag,this),this.resourcesStageView.bind("action:end",this._onActionEnd,this),this.resourcesStageView.bind("resources-stage:change",this._onResourcesStageChange,this),this.resourcesPanelView.bind("resources-toolbar:flip-horizontal",this._onClickFlipHorizontal,this),this.resourcesPanelView.bind("resources-toolbar:flip-vertical",this._onClickFlipVertical,this),this.resourcesPanelView.bind("resources-toolbar:rotate",this._onClickRotate,this),this.resourcesPanelView.bind("resources-toolbar:delete-selected",this._onClickDeleteSelected,this),this.resourcesPanelView.bind("resources-toolbar:delete-all",this._onClickDeleteAll,this),this.resourcesPanelView.bind("resources-toolbar:save",this._onClickSave,this),this.resourcesPanelView.bind("resources-toolbar:undo",this._onClickUndo,this),this.resourcesPanelView.bind("resources-toolbar:add-all",this._onClickAddAll,this),this.resourcesPanelView.bind("resources-toolbar:add-random",this._onClickAddRandom,this),this.resourcesPanelView.bind("resources-toolbar:add-random-selection",this._onClickAddRandomSelection,this),this.resourcesPanelView.bind("resources-toolbar:reset",this._onClickReset,this),this.resourcesPanelView.bind("resource-bank:activate",this._onResourceBankActivate,this),$(document).on("keyup",function(e){46!==e.which&&8!==e.which||(this.resourcesStage.savePoint(),this.resourcesStageView.deleteSelectedItems())}.bind(this)),$(window).on("resize",_.throttle(this._onResize.bind(this),300)),this.resourcesStageView.render()),this},store:function(){return this.resourcesStage?this.resourcesStage.getState():{}},restore:function(object){this.resourcesStage&&this.resourcesStage.setState(object)},addItem:function($item,x,y){var bankItem=this.banks.findItemById($item.attr("data-item-id")),type=bankItem.bank.id,item=new a5.model.ResourceStageItem({path:bankItem.path,inline:bankItem.inline,type:type,bankItemId:bankItem.id}),resourceStageItem=this.resourcesStageView.addItem(item);resourceStageItem.moveTo(x,y),this.resourcesStageView.selectItem(resourceStageItem),this.resourcesStage.add(item)},addArray:function($item,rows,cols,sepX,sepY){var bankItem=this.banks.findItemById($item.attr("data-item-id")),type=bankItem.bank.id;this.resourcesStage.savePoint();var $clone=$item.clone().css({margin:0,visibility:"hidden"}).addClass("resource-stage-item").addClass(type);this.resourcesStageView.region().append($clone);var matrix=this.resourcesStageView.region().transformationMatrix(!0),scale=matrix.getScale(),box=$clone[0].getBoundingClientRect(),size={width:cols*Math.round(box.width/scale)+(cols-1)*sepX,height:rows*Math.round(box.height/scale)+(rows-1)*sepY},origin={sox:$clone.position().left,soy:$clone.position().top};origin.ox=Math.round(origin.sox/scale*10)/10,origin.oy=Math.round(origin.soy/scale*10)/10;var offset=this.resourcesStage.clickToAddGrid.relativeTo(this.resourcesStageView.region()),offsetX=Math.round(offset.left/scale),offsetY=Math.round(offset.top/scale),snap=this.resourcesStage.clickToAddGrid.snap(size),x=offsetX+snap.x-origin.ox,y=offsetY+snap.y-origin.oy;snap.fit||(x=0,y=0);for(var dx,dy=0,i=0;i<rows;i++){dx=0;for(var j=0;j<cols;j++)this.addItem($item,x+dx,y+dy),j<cols-1&&(dx+=Math.round(box.width/scale)+sepX);dy+=Math.round(box.height/scale)+sepY}$clone.remove()},_onClickRotate:function(anticlockwise){this.resourcesStage.savePoint(),this.resourcesPanelView.unbind("resources-toolbar:flip-horizontal",this._onClickFlipHorizontal),this.resourcesPanelView.unbind("resources-toolbar:flip-vertical",this._onClickFlipVertical),this.resourcesPanelView.unbind("resources-toolbar:rotate",this._onClickRotate),this.resourcesStageView.rotateSelectedItems(anticlockwise)},_onClickFlipHorizontal:function(){this.resourcesStage.savePoint(),this.resourcesPanelView.unbind("resources-toolbar:flip-horizontal",this._onClickFlipHorizontal),this.resourcesPanelView.unbind("resources-toolbar:flip-vertical",this._onClickFlipVertical),this.resourcesPanelView.unbind("resources-toolbar:rotate",this._onClickRotate),this.resourcesStageView.flipHorizontalSelectedItems()},_onClickFlipVertical:function(){this.resourcesStage.savePoint(),this.resourcesPanelView.unbind("resources-toolbar:flip-horizontal",this._onClickFlipHorizontal),this.resourcesPanelView.unbind("resources-toolbar:flip-vertical",this._onClickFlipVertical),this.resourcesPanelView.unbind("resources-toolbar:rotate",this._onClickRotate),this.resourcesStageView.flipVerticalSelectedItems()},_onClickDeleteAll:function(){var resourcesDeleteAllModal=new a5.view.dialog.DeleteAll;resourcesDeleteAllModal.bind("submit",function(){this.resourcesStage.savePoint(),this.resourcesStageView.deleteAllItems(),this.interaction.annotations.setChildren([]),this.trigger("delete-all")},this),resourcesDeleteAllModal.show()},_onClickDeleteSelected:function(){this.resourcesStage.savePoint(),this.resourcesStageView.deleteSelectedItems()},_onClickSave:function(){a5.mainBuilder.save()},_onResourceStageItemDrag:function(draggedItem){this.resourcesStage.savePoint()},_onClickUndo:function(){this.combinedUndoRedoManager.undo()},_onClickAddAll:function(){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll();var items=this.resourcesPanelView.getCurrentResourceBank().getItemsBySelector(".resource-item:visible");_(items).each(function(item){var $item=item.$el;$item.hasClass("resource-item-composed")?$item.children("[data-item-id]").each(function(index,el){var $el=$(el);this._addToGrid({id:$el.attr("data-item-id")})}.bind(this)):0===$item.closest(".resource-item-composed").length&&this._addToGrid({id:$item.attr("data-item-id")})},this)},_onClickAddRandom:function(){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll();var items=this.resourcesPanelView.getCurrentResourceBank().getItemsBySelector(".resource-item:visible:not(.already-added-to-stage)"),item=_(items).sample();if(item){var $item=item.$el;$item.hasClass("resource-item-composed")?$item.children("[data-item-id]").each(function(index,el){var $el=$(el);this._addToGrid({id:$el.attr("data-item-id")})}.bind(this)):0===$item.closest(".resource-item-composed").length&&this._addToGrid({id:$item.attr("data-item-id")})}},_onClickAddRandomSelection:function(){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll();var items=this.resourcesPanelView.getCurrentResourceBank().getItemsBySelector(".resource-item:visible"),numberOfItems=Math.floor(13*Math.random())+3;_.times(numberOfItems,function(){var item=_(items).sample(),$item=item.$el;$item.hasClass("resource-item-composed")?$item.children("[data-item-id]").each(function(index,el){var $el=$(el);this._addToGrid({id:$el.attr("data-item-id")})}.bind(this)):0===$item.closest(".resource-item-composed").length&&this._addToGrid({id:$item.attr("data-item-id")})},this)},_onClickReset:function(){if(this.resourcesPanelView.getBankById("numeral-cards")){this.resourcesStage.savePoint(),this.resourcesStageView.deselectAll();var items=this.resourcesStage.getItemsByType("numeral-cards");_(items).each(function(item){this.resourcesStageView.removeItemById(item.id)},this),this.resourcesStage.resetGrids()}},_onActionEnd:function(){this.resourcesPanelView.bind("resources-toolbar:flip-horizontal",this._onClickFlipHorizontal,this),this.resourcesPanelView.bind("resources-toolbar:flip-vertical",this._onClickFlipVertical,this),this.resourcesPanelView.bind("resources-toolbar:rotate",this._onClickRotate,this)},_onResize:function(e){this.resourcesStage.clickToAddGrid&&this.resourcesStage.clickToAddGrid.refreshDimensions()},_onMoreResourcesShow:function(){var resourcesSelectModal=new a5.view.dialog.ResourceBanksSelect({banks:this.banks});resourcesSelectModal.bind("submit",function(selection){this.banks.updateSelection(selection),this.resourcesPanelView.refresh()},this),resourcesSelectModal.show()},_onResourceBankActivate:function(bank){this.resourcesStageView.$el.toggleClass("numeral-cards","numeral-cards"===bank.id),"numeral-cards"===bank.id?(this.resourcesPanelView.disableAddBy(),this._refreshNumeralCards()):this.resourcesPanelView.enableAddBy()},_onResourcesStageChange:function(){this._refreshNumeralCards()},_drop:function(draggedItem){this.activity&&this.activity.removeItemById(draggedItem.id);var item,bankItem=this.banks.findItemById(draggedItem.bankItemId),type=bankItem.bank.id;if("numeral-cards"===type){if(this.resourcesStage.getItemsByBankItemId(bankItem.id).length>0)return;var numeralCardsBankView=this.resourcesPanelView.getCurrentResourceBank();item=new a5.model.CardStageItem({path:bankItem.path,inline:bankItem.inline,type:type,face:numeralCardsBankView.addFaceMode,bankItemId:bankItem.id})}else item=new a5.model.ResourceStageItem({path:bankItem.path,inline:bankItem.inline,type:type,bankItemId:bankItem.id}),"keypad"===type&&draggedItem.$el&&(item.inline=draggedItem.$el.html());var resourceStageItem=this.resourcesStageView.addItem(item),matrix=this.resourcesStageView.region().transformationMatrix(!0),scale=matrix.getScale(),origin={sox:resourceStageItem.$el.position().left,soy:resourceStageItem.$el.position().top};origin.ox=Math.round(10*origin.sox/scale)/10,origin.oy=Math.round(10*origin.soy/scale)/10;var snap=this.resourcesStage.generalGrid.snap({x:draggedItem.x/scale,y:draggedItem.y/scale}),x=snap.x-origin.ox,y=snap.y-origin.oy;resourceStageItem.moveTo(x,y),this.resourcesStageView.selectItem(resourceStageItem),this.resourcesStage.add(item)},_addToGrid:function(clickedItem){var item,bankItem=this.banks.findItemById(clickedItem.id),type=bankItem.bank.id;if("numeral-cards"===type){if(this.resourcesStage.getItemsByBankItemId(bankItem.id).length>0)return;var numeralCardsBankView=this.resourcesPanelView.getCurrentResourceBank();item=new a5.model.CardStageItem({path:bankItem.path,inline:bankItem.inline,type:type,face:numeralCardsBankView.addFaceMode,bankItemId:bankItem.id})}else item=new a5.model.ResourceStageItem({path:bankItem.path,inline:bankItem.inline,type:type,bankItemId:bankItem.id});var resourceStageItem=this.resourcesStageView.addItem(item),matrix=this.resourcesStageView.region().transformationMatrix(!0),scale=matrix.getScale(),origin={sox:resourceStageItem.$el.position().left,soy:resourceStageItem.$el.position().top};origin.ox=Math.round(origin.sox/scale*10)/10,origin.oy=Math.round(origin.soy/scale*10)/10
;var box=resourceStageItem.$el[0].getBoundingClientRect(),size={width:Math.round(box.width/scale),height:Math.round(box.height/scale)},offset=this.resourcesStage.clickToAddGrid.relativeTo(this.resourcesStageView.region()),offsetX=Math.round(offset.left/scale),offsetY=Math.round(offset.top/scale),snap=this.resourcesStage.clickToAddGrid.snap(size),x=offsetX+snap.x-origin.ox,y=offsetY+snap.y-origin.oy;snap.fit?(resourceStageItem.moveTo(x,y),this.resourcesStageView.selectItem(resourceStageItem),this.resourcesStage.add(item)):this.resourcesStageView.removeItem(resourceStageItem)},_addCompositeToGrid:function($compositeItem){var compositeItem=this.banks.findItemById($compositeItem.attr("data-item-id")),type=compositeItem.bank.id,$clone=$compositeItem.clone().css({margin:0,visibility:"hidden"}).addClass("resource-stage-item").addClass(type);this.resourcesStageView.region().append($clone);var matrix=this.resourcesStageView.region().transformationMatrix(!0),scale=matrix.getScale(),box=$clone[0].getBoundingClientRect(),size={width:Math.round(box.width/scale),height:Math.round(box.height/scale)},offset=this.resourcesStage.clickToAddGrid.relativeTo(this.resourcesStageView.region()),offsetX=Math.round(offset.left/scale),offsetY=Math.round(offset.top/scale),snap=this.resourcesStage.clickToAddGrid.snap(size);$clone.children("[data-item-id]").each(function(index,el){var $el=$(el),bankItem=this.banks.findItemById($el.attr("data-item-id")),item=new a5.model.ResourceStageItem({path:bankItem.path,inline:bankItem.inline,type:type,bankItemId:bankItem.id}),resourceStageItem=this.resourcesStageView.addItem(item);if(snap.fit){var compOffset={sox:$el.offset().left-$clone.offset().left,soy:$el.offset().top-$clone.offset().top};compOffset.ox=Math.round(compOffset.sox/scale*10)/10,compOffset.oy=Math.round(compOffset.soy/scale*10)/10;var origin={sox:resourceStageItem.$el.position().left,soy:resourceStageItem.$el.position().top};origin.ox=Math.round(origin.sox/scale*10)/10,origin.oy=Math.round(origin.soy/scale*10)/10;var x=offsetX+snap.x-origin.ox+compOffset.ox,y=offsetY+snap.y-origin.oy+compOffset.oy;resourceStageItem.moveTo(x,y),this.resourcesStageView.selectItem(resourceStageItem),this.resourcesStage.add(item)}else this.resourcesStageView.removeItem(resourceStageItem)}.bind(this)),$clone.remove()},_getBanks:function(){if(!this.banks){var allBanks=_(a5.dp.resourceBanks).map(function(bank){return new a5.model.ResourceBank(bank,this)},this);this.banks=new a5.model.ResourceBankList({availableBanks:this._getAvailableBanks(),allBanks:allBanks})}return this.banks},_getAvailableBanks:function(){var availableBanks=[];try{availableBanks=$.parseJSON(this.interaction.options.getResourceBanks()).items}catch(e){}return availableBanks},_refreshNumeralCards:function(){var bankView=this.resourcesPanelView.getBankById("numeral-cards");if(bankView){var items=this.resourcesStage.getItemsByType("numeral-cards"),alreadyAddedItemIds=_.map(items,function(item){return item.bankItemId}),bankItems=bankView.getItemsBySelector(".resource-item");_.each(bankItems,function(bankItem){bankItem.$el.removeClass("already-added-to-stage"),_.contains(alreadyAddedItemIds,bankItem.$el.attr("data-bank-item-id"))&&bankItem.$el.addClass("already-added-to-stage")})}}},Obj.extend("a5.components.Resources"),a5.LOInfo={init:function(initObj){var info=initObj.info;this.loOptions=new a5.models.options.Options,this.assessmentOptions=new a5.models.options.Options,this.debuggerOptions=new a5.models.options.Options,this.LOOptions=new a5.models.options.Options([this.loOptions,this.assessmentOptions,this.debuggerOptions]),_.isUndefined(info)||(_.isUndefined(info.LOOptions)||this.loOptions.readAll(info.LOOptions),_.isUndefined(info.assessmentOptions)||this.assessmentOptions.readAll(info.assessmentOptions),_.isUndefined(info.debugOptions)||this.debuggerOptions.readAll(info.debugOptions),_.isUndefined(info.UID)||(this.uid=info.UID),_.isUndefined(info.ID)||(this.id=info.ID),_.isUndefined(info.title)||(this.title=info.title))}},Obj.extend("a5.LOInfo",a5.LOInfo),a5.MainBuilder={init:function(){a5.eventBus.trigger("performance:engine_mainbuilder:start"),this.document=document,this.$body=$(document.body),this.xmlList=[],this.curInteraction=null,this.curTask=0,this.intList=[],this.allInteractionsList=[],this.introScreen=null,this.loadScreensOnDemand=a5.dp.config.loadScreensOnDemand,this.interactionsLoader=new a5.service.InteractionsLoader,this.ready=!1,this.LOInfo=null,this.platformOptions=null,this.metadata=null,this.startTime=(new Date).getTime(),this.loTimer=new a5.utils.Timer,this.aggregatedLODuration=0,this.sessionLODuration=0,this.submitAttempts=0,this.sendScoreAttempts=0,this.justSubmitted=!1,this.justScoresSent=!1,this.totalSubmitted=!1,this.resultsGenerator=new a5.model_builder.EndResultsGenerator,this.validationLock=new a5.utils.Lock,this.curFontSize=null,this.confidenceLevel=["",""],this.note="",this.navigationHistory=new a5.model.NavigationHistory,a5.hooks.interactionShowed.add(_.bind(function(interaction){this.navigationHistory.addNavigationAction(interaction)},this)),$("a[href='close']").click(function(e){e.preventDefault(),a5_closeLO()}),$("#page-close").on("click",_.bind(this.onClickClose,this)),a5.dp.config.postMessageUIManagement&&a5.service.postMessager.addListener("finalizeLO",_.bind(this.close,this)),a5.service.postMessager.addListener("pauseLO",_.bind(this.pauseLO,this)),$(window).on("beforeunload",_.bind(this.onWindowBeforeUnload,this)),$(window).on("unload",_.bind(this.onWindowUnload,this)),a5.eventBus.bind("interaction:fill:change",function(interaction,fillStatus){interaction===this.curInteraction&&interaction.options.automaticNextIsQuestions()&&"all"===fillStatus&&this.goNext()},this),a5.eventBus.bind("interaction:value:change interaction:state:change interaction:show_solution_hint interaction:show_next_answer interaction:show_all_answer",function(interaction){interaction===this.curInteraction&&this.layout.checkSize()},this),this.initLOInfo(),this.initPlatformOptions(),this.initFontSize(),a5.service.reactEngineInterface.addToState(a5.service.React.actions.lo.SET_LO_OPTIONS,this.LOInfo.LOOptions),this.canSubmit=!this.options(!0).showSubmitIsOff()||!this.options(!0).finishSubmitIsOff()||"Formative"===LOInfo.mode,this.canSendScores=!this.options(!0).sendscoresIsOff(),this.initMaxAttempts(),this.initExamTimer(),Object.defineProperty(this,"checkMaxAttempts",{get:function(value){return logger.warn("Deprecated 'a5.mainBuilder.checkMaxAttempts' object. Use 'a5.mainBuilder.getCheckMaxAttemptsNumber()' instead."),this.getCheckMaxAttemptsNumber()}}),this.spinner=new a5.Spinner;var loTitleClass="lo-title-"+(this.options(!0).lOtitledisplayIsOff()?"off":"on"),activityTitleClass="activity-title-"+(this.options(!0).activitytitledisplayIsOff()?"off":"on"),fontSizeClass="lo-fontsize-"+a5.service.lms.API.getLOFontSize(),loControlsClass="lo-controls-"+(A5.LO_WITHOUT_CONTROLS?"off":"on");this.$body.addClass(loTitleClass),this.$body.addClass(activityTitleClass),this.$body.addClass(fontSizeClass),this.$body.addClass(loControlsClass),a5.dp.config.protectImages&&$(document).on("dragstart contextmenu","img",!1),this.loTimer.stamp(),a5.eventBus.trigger("lo:start",{uid:this.LOInfo.uid,id:this.LOInfo.id,lo:this}),a5.eventBus.trigger("performance:engine_mainbuilder:end")},goToPrevLO:function(){a5.eventBus.trigger("lo:prev")},goToNextLO:function(){a5.eventBus.trigger("lo:next")},hasNextLO:function(){return this.engine.invoke("lo:has-next")},hasPrevLO:function(){return this.engine.invoke("lo:has-prev")},initFontSize:function(){this.availableFontSizes=_.range(1,a5.dp.config.fontSizeSteps+1),this.availableFontSizes.length&&this.setFontSize(this.getDefaultFontSize())},getAvailableFontSizes:function(){return this.availableFontSizes},getDefaultFontSize:function(){return a5.dp.config.fontSizeDefault},getCurrentFontSize:function(){return this.curFontSize},setFontSize:function(size){if(_.contains(this.availableFontSizes,size)){var $html=$(this.document.documentElement);this.curFontSize&&$html.removeClass("lo-fontsize-"+this.curFontSize),this.curFontSize=size,$html.addClass("lo-fontsize-"+this.curFontSize),a5.hooks.interactionFontUpdated.call()}},resetFontSize:function(){this.setFontSize(this.getDefaultFontSize())},setFontFamily:function(family){$(this.document.documentElement).addClass("lo-fontfamily-"+family),a5.hooks.interactionFontUpdated.call()},resetFontFamily:function(family){family?$(this.document.documentElement).removeClass("lo-fontfamily-"+family):$(this.document.documentElement).removeClass(function(index,className){return className.split(/\s+/).filter(function(c){var regex=new RegExp("^lo-fontfamily-");return c.match(regex)}).join(" ")}),a5.hooks.interactionFontUpdated.call()},getCurrentFontClasses:function(){return $(this.document.documentElement).attr("class").split(/\s+/).filter(function(c){var regex=new RegExp("^lo-(fontfamily|fontsize)-");return c.match(regex)})},getFontClassesRegex:function(){return new RegExp("^lo-(fontfamily|fontsize)-")},showDebugToolbar:function(){this.debugToolbar=new a5.debug.DebugToolbar,this.debugToolbar.render(this.$body)},numberOfInteractions:function(withEndResult){var count=this.intList.length;return withEndResult||this.options().endResultScreenIsFalse()&&this.options().endResultAlwaysIsOff()||(count-=1),count},getNumberOfInteractions:function(withEndResult){return this.numberOfInteractions(withEndResult)},getCurrentInteraction:function(){return this.curInteraction},getInteractionsWithoutIntroScreen:function(intList){return this.options().introScreenIsOn()&&(intList=_.rest(intList)),_(intList).reject(function(interaction){return interaction.locked})},getInteractionsWithoutEndResult:function(){var intList=this.intList;return this.options().endResultScreenIsFalse()&&this.options().endResultAlwaysIsOff()||(intList=_.initial(intList)),_(intList).reject(function(interaction){return interaction.locked})},getAdaptiveInteractions:function(){var intList=this.intList;return _.reject(intList,function(interaction){return interaction.skippedByAdaptive&&0===interaction.manualCheckAttempts},this)},getInteractionsWithAttachments:function(){var interactions=_.chain([this.introScreen,this.intList]).flatten().compact().value();return _.filter(interactions,function(interaction){return interaction.hasAttachments()})},getCheckMaxAttempts:function(){var result={items:[],selection:"off",number:0};try{result=JSON.parse(this.options().getCheckmaxattempts()),"LO_setting"===result.selection&&(result=JSON.parse(htmlDecode(this.options(!0).getCheckmaxattempts()))),result.number=parseInt(result.selection,10)||0,_.isUndefined(result.selection)&&(result.selection="off")}catch(e){}return _.extend(result,{get:function(index){return result.items[index]&&result.items[index].label||""}})},getCheckMaxAttemptsNumber:function(){return this.getCheckMaxAttempts().number},options:function(loOptions){return this.curInteraction&&!loOptions?this.curInteraction.options:this.LOInfo.LOOptions},setLanguageToAllInteractions:function(lang,except){_.each(this.intList,function(interaction){interaction!=except&&_.contains(interaction.getRegisteredLanguages(),lang)&&interaction.setLanguage(lang,this)},this)},notifyFrequentScoreUpdateEvent:function(){this.getCurrentInteractionScoresAsync().then(function(){requestAnimationFrame(function(){this.trigger("frequent_score_update")}.bind(this))}.bind(this))},notifyBeginAction:function(action){a5.eventBus.trigger("lo:action:begin",action)},notifyEndAction:function(action){a5.eventBus.trigger("lo:action:end",action)},areAllChecked:function(interactions){var intList=interactions||this.getInteractionsWithoutEndResult(),promises=_.map(intList,function(interaction){return interaction.isSolvable().then(function(solvable){return 0===interaction.checkAttempts&&solvable}.bind(this))});return $.when.apply($,promises).then(function(){var interactions=Array.prototype.slice.call(arguments);return!_.some(interactions)}.bind(this))},checkAnswerWithFeedbackAllCorrect:function(){return this.curInteraction.setAnswer().then(function(){this.curInteraction.manualCheckAttempts++}.bind(this)).then(function(){return this.curInteraction.getResultsAsync()}.bind(this)).then(function(results){return $.when(results,this.showActivityScoreWithFeedbackAllCorrect(results))}.bind(this)).then(function(results){a5.eventBus.trigger("interaction:check_answer",{score:results,interaction:this.curInteraction})}.bind(this))},checkAnswerInput:function(){if(this.validationLock.isLocked())return logger.warn("Cannot run concurrent actions."),$.Deferred().reject().promise();this.validationLock.lock(),this.notifyBeginAction("checkAnswerInput");var promise;try{promise=this.curInteraction.setAnswerInput()}catch(e){logger.error(e),promise=$.Deferred().reject().promise()}return promise.always(function(){this.validationLock.unlock(),this.notifyEndAction("checkAnswerInput")}.bind(this))},checkAnswer:function(){if(this.validationLock.isLocked())return logger.warn("Cannot run concurrent actions."),$.Deferred().reject().promise();this.validationLock.lock(),this.notifyBeginAction("checkAnswer");var promise;try{promise="Formative"===LOInfo.mode?this.checkAnswerFormative():this._checkAnswer(),promise=$.when(promise).then(function(){return this.curInteraction.store(),this.areAllChecked().then(function(allChecked){this.options(!0).sendscoresIsFinal_check_answers()&&allChecked&&this.sendScores()}.bind(this))}.bind(this))}catch(e){logger.error(e),promise=$.Deferred().reject().promise()}return promise.always(function(){this.validationLock.unlock(),this.notifyEndAction("checkAnswer")}.bind(this))},_showResultsDialog:function(){(new a5.view.AutoEndResults).display()},_checkAnswer:function(){if(!this.options().delayedFeedbackIsFalse())return void this.showDelayedFeedback();var interactions=this.getDelayedFeedbackInteractions();interactions.unshift(this.curInteraction);var promises=_.invoke(interactions,"setAnswer");return $.when.apply($,promises).then(function(){return this.getResultsAsync(function(interaction){return _.contains(interactions,interaction)})}.bind(this)).then(function(results){if(this.options().checkAnswersDisplayIsMarking_and_feedback()&&"Exam"!==LOInfo.mode&&"Trainer"!==LOInfo.mode)return this.showActivityScore(results)}.bind(this)).then(function(){var promises=_.map(interactions,function(interaction){return interaction.getResultsAsync().then(function(results){return{interaction:interaction,score:results}}.bind(this))}.bind(this));return $.when.apply($,promises).then(function(){var interactionsData=Array.prototype.slice.call(arguments);_.each(interactionsData,function(data){data.interaction.manualCheckAttempts++,a5.eventBus.trigger("interaction:check_answer",data)})}.bind(this))}.bind(this)).then(function(){if(this.options().seeAnswersIsBeforeInteraction()&&!this.curInteraction.hasMoreCheckAttempts())return this.curInteraction.showAnswer()}.bind(this))},getLastFeedbackBand:function(){return this._lastFeedbackBand},setLastFeedbackBand:function(feedback){this._lastFeedbackBand=feedback},getLastCheckMaxFeedback:function(){return this._lastCheckMaxFeedback},setLastCheckMaxFeedback:function(feedback){this._lastCheckMaxFeedback=feedback},getDelayedFeedbackInteractions:function(){for(var interactions=[],i=this.curTask-1;i>=0;i--){var interaction=this.intList[i];if(!interaction.options.delayedFeedbackIsTrue())break;interactions.push(interaction)}return interactions},showDelayedFeedback:function(){var data={dialogClass:"dialog-delayed-feedback"},options=this.curInteraction.options;options.delayedFeedbackIsCustom()&&(data.text=options.getDelayedFeedback()),a5.view.dialog.display("a5.view.dialog.DelayedFeedback",data,{})},showActivityScore:function(results){return this.getFeedbackBand().then(function(feedbackBand){var feedback,random_band=a5.utils.getRandomSubstring(feedbackBand);this.setLastFeedbackBand(random_band);var allCorrect=results.isPercent100(!0),correctClass=allCorrect?"all-correct":"some-errors";$(a5.dp.config.appendFeedbackTo).removeClass("all-correct some-errors"),$(a5.dp.config.appendFeedbackTo).addClass(correctClass),this.getCheckMaxAttemptsNumber()&&(feedback=this.getCheckMaxAttempts().get(this.curInteraction.checkAttempts-1),feedback=a5.utils.getRandomSubstring(feedback),feedback=a5.preprocessor.apply(feedback,this.curInteraction),this.setLastCheckMaxFeedback(feedback)),a5.view.dialog.display("a5.view.dialog.CheckInfo",{dialogClass:"feedback-dialog dialog-check-info "+correctClass,percent:Math.round(results.percent()),total:results.total(),correct:results.correct(),allCorrect:allCorrect,feedback:feedback,feedbackBand:random_band,attempt:this.curInteraction.checkAttempts},{close:function(){this.curInteraction.trigger("interaction:feedback_band:close")}.bind(this)},!1,!0,a5.dp.config.appendFeedbackTo),this.curInteraction.trigger("interaction:feedback_band")}.bind(this))},showActivityScoreWithFeedbackAllCorrect:function(results){return this.getFeedbackBand().then(function(feedbackBand){var random_band=a5.utils.getRandomSubstring(feedbackBand);this.setLastFeedbackBand(random_band);var allCorrect=results.isPercent100(!0),correctClass=allCorrect?"all-correct":"some-errors";a5.view.dialog.display("a5.view.dialog.CheckInfo",{dialogClass:"feedback-dialog dialog-check-info "+correctClass,total:results.total(),correct:results.correct(),allCorrect:allCorrect,feedbackBand:random_band},{close:function(){this.curInteraction.trigger("interaction:feedback_band:close")}.bind(this)},!1,!0,a5.dp.config.appendFeedbackTo),this.curInteraction.trigger("interaction:feedback_band")}.bind(this))},showActivityScoreWithFeedbackBeforeInteraction:function(results){return this.getFeedbackBand().then(function(feedbackBand){var random_band=a5.utils.getRandomSubstring(feedbackBand);this.setLastFeedbackBand(random_band),a5.view.dialog.display("a5.view.dialog.CheckInfo",{dialogClass:"feedback-dialog dialog-check-info some-errors",total:results.total(),correct:results.correct(),allCorrect:!1,feedbackBand:random_band},{close:function(){this.curInteraction.trigger("interaction:feedback_band:close")}.bind(this)},!1,!0,a5.dp.config.appendFeedbackTo),this.curInteraction.trigger("interaction:feedback_band")}.bind(this))},showActivityScoreWithFeedbackFormative:function(results){return this.getFeedbackBand().then(function(feedback){var showSubmitData=this.options(!0).getShowSubmit(),showDialog=_.partial(a5.view.dialog.display,"a5.view.dialog.CheckedAnswers",{dialogClass:"dialog-checked-answers",lastPage:this.curInteraction.isLastInteraction(),checked:this.curInteraction.timesChecked,total:results.human().total(),correct:results.human().correct(),feedback:a5.utils.getRandomSubstring(feedback),submitText:showSubmitData.submitText,submitTooltip:showSubmitData.submitTooltip},{tryAgain:_.bind(function(){this.tryAgain(),this.curInteraction.timesChecked++},this),next:_.bind(function(){this.goNext()},this),submit:_.bind(function(){this.options(!0).onlineCheckIsOn()&&!navigator.onLine?a5.view.dialog.display("a5.view.dialog.OfflineCheck",{dialogClass:"offline-check"},{close:_.partial(_.defer,showDialog)},!1,!1,a5.dp.config.appendOfflineTextTo):(this.submit(),_.invoke(this.intList,"showAnswer"))},this)},!1,!0).bind(a5.view.dialog);showDialog()}.bind(this))},getFeedbackBand:function(){return this.curInteraction.getResultsAsync().then(function(results){for(var bands=_.map(this.options().getActivityFeedbackThresholds().split(","),function(x){return parseInt(x,10)});bands.length<3;)bands.unshift(0);var percent=results.percent(),band=3;percent<bands[2]&&(band=2),percent<bands[1]&&(band=1),percent<bands[0]&&(band=0);var bandID=["356","355","354","353"][band],feedback="";for(this.options().has(bandID)&&"false"!=this.options().get(bandID)&&(feedback=_.unescape(this.options().getValue(bandID))),bands=_.map(this.options().getActivityFeedbackThresholds().split(","),function(x){return parseInt(x,10)});bands.length<3;)bands.unshift(0);percent=results.percent(),band=3,percent<bands[2]&&(band=2),percent<bands[1]&&(band=1),percent<bands[0]&&(band=0),bandID=["356","355","354","353"][band],feedback="",this.options().has(bandID)&&"false"!=this.options().get(bandID)&&(feedback=_.unescape(this.options().getValue(bandID))),feedback=feedback.replace(/src=(['"])http(s)*:/gi,"src=$1");var preprocessor=new a5.preprocessor.TranslationBlock;return preprocessor.isResponsible(this.curInteraction,this.curInteraction.identifier,feedback)&&(feedback=preprocessor.preprocess(feedback)),feedback}.bind(this))},checkAnswerFormative:function(){return this.curInteraction.setAnswer().then(function(){return this.curInteraction.getResultsAsync()}.bind(this)).then(function(results){return this.showActivityScoreWithFeedbackFormative(results)}.bind(this))},showAnswer:function(){if(this.validationLock.isLocked())return logger.warn("Cannot run concurrent actions."),$.Deferred().reject().promise();this.validationLock.lock(),this.notifyBeginAction("showAnswer");var promise;try{if(this.options().seeAnswersIsBeforeInteraction()){var dialogTemplate=this.curInteraction.checkAttempts?"a5.view.dialog.SeeAnswersAfterCheck":"a5.view.dialog.SeeAnswersBeforeCheck";a5.view.dialog.display(dialogTemplate,{dialogClass:"confirmation-dialog dialog-see-answers"},{ok:_.bind(function(){this.curInteraction.showAnswerBeforeInteraction().then(function(){return this.curInteraction.getResultsAsync()}.bind(this)).then(function(results){if(a5.dp.config.showActivityFeedbackAfterSeeAnswersBeforeInteraction)return this.showActivityScoreWithFeedbackBeforeInteraction(results)}.bind(this))},this),cancel:_.noop}),promise=$.Deferred().resolve().promise()}else promise=this.curInteraction.showAnswer()}catch(e){logger.error(e),promise=$.Deferred().reject().promise()}return promise.always(function(){this.validationLock.unlock(),this.notifyEndAction("showAnswer")}.bind(this))},showNextAnswer:function(){if(this.validationLock.isLocked())return logger.warn("Cannot run concurrent actions."),$.Deferred().reject().promise();this.validationLock.lock(),this.notifyBeginAction("showNextAnswer");var promise;try{promise=this.curInteraction.showNextAnswer()}catch(e){logger.error(e),promise=$.Deferred().reject().promise()}return promise.always(function(){this.validationLock.unlock(),this.notifyEndAction("showNextAnswer")}.bind(this))},showAllAnswer:function(){if(this.validationLock.isLocked())return logger.warn("Cannot run concurrent actions."),$.Deferred().reject().promise();this.validationLock.lock(),this.notifyBeginAction("showAllAnswer");var promise;try{promise=this.curInteraction.showAllAnswer()}catch(e){logger.error(e),promise=$.Deferred().reject().promise()}return promise.always(function(){this.validationLock.unlock(),this.notifyEndAction("showAllAnswer")}.bind(this))},showSolutionHint:function(){if(this.validationLock.isLocked())return logger.warn("Cannot run concurrent actions."),$.Deferred().reject().promise();this.validationLock.lock(),this.notifyBeginAction("showSolutionHint");var promise;try{promise=this.curInteraction.showSolutionHint()}catch(e){logger.error(e),promise=$.Deferred().reject().promise()}return promise.always(function(){this.validationLock.unlock(),this.notifyEndAction("showSolutionHint")}.bind(this))},signal:function(){this.curInteraction.signal(),this.updateControls()},hideSignal:function(){this.curInteraction.hideSignal(),this.updateControls()},reveal:function(){this.curInteraction.revealHiddenElements(),this.updateControls(),this.layout.checkSize()},hideRevealed:function(){this.curInteraction.hideRevealedElements(),this.updateControls(),this.layout.checkSize()},tryAgain:function(){if(this.validationLock.isLocked())return logger.warn("Cannot run concurrent actions."),$.Deferred().reject().promise();this.validationLock.lock(),this.notifyBeginAction("tryAgain");var promise;try{this.justSubmitted=!1,this.justScoresSent=!1,promise=this.curInteraction.tryAgain().then(function(){a5.eventBus.trigger("interaction:try_again")}.bind(this))}catch(e){logger.error(e),promise=$.Deferred().reject().promise()}return promise.always(function(){this.validationLock.unlock(),this.notifyEndAction("tryAgain")}.bind(this))},reset:function(){a5.view.dialog.display("a5.view.dialog.ReallyReload",{dialogClass:"dialog-really-reload"},{ok:_.bind(function(){this.reloadCurrentInteraction()},this)})},resetAll:function(){a5.view.dialog.display("a5.view.dialog.ReallyReloadAll",{dialogClass:"dialog-really-reload-all"},{ok:_.bind(function(){this.reloadAllInteractions().then(function(){this.goFirst()}.bind(this))},this)})},reloadItemBank:function(){a5.view.dialog.display("a5.view.dialog.ReallyReload",{dialogClass:"dialog-really-reload"},{ok:_.bind(function(){this.reloadCurrentInteractionFromItemBank()},this)})},reloadInteractions:function(interactions,config){return this.trigger("reset",interactions),this.justSubmitted=!1,this.justScoresSent=!1,$.when.apply($,_.invoke(interactions,"reload",config))},reloadCurrentInteraction:function(){return this.reloadInteractions([this.curInteraction])},reloadAllInteractions:function(){return this.submitAttempts=0,this.sendScoreAttempts=0,this.confidenceLevel=["",""],this.pauseLO(),this.reloadInteractions(this.intList,{skipRestore:!0})},reloadCurrentInteractionFromItemBank:function(){if(this.curInteraction.hasItemBank())return this.interactionsLoader.reload(this.curInteraction).then(function(){return this.reloadInteractions([this.curInteraction],{skipReset:!0})}.bind(this))},meetsMinLength:function(){return _.every(this.intList,function(interaction){return interaction.meetsMinLength()})},submit:function(no_confirm){if(this.validationLock.isLocked())return logger.warn("Cannot run concurrent actions."),$.Deferred().reject().promise();this.validationLock.lock(),this.notifyBeginAction("submit");var deferredSubmit=$.Deferred();try{this.$body.addClass("lo-submit-in-progress"),this.hasMoreSubmitAttempts()?this.options(!0).onlineCheckIsOn()&&!navigator.onLine?(this.showOfflineWarning(),deferredSubmit.reject()):this.options(!0).finishSubmitIsOn()?this.submitFinish(deferredSubmit):this.areAllFilled().then(function(allFilled){var confirmIfUnanswered=!("if-unanswered"!==a5.dp.config.confirmBeforeSubmit||allFilled&&this.meetsMinLength()),confirmAlways="always"===a5.dp.config.confirmBeforeSubmit;"Formative"===LOInfo.mode||no_confirm||!confirmIfUnanswered&&!confirmAlways?this.submitEverything(deferredSubmit):this.showSubmitWarning({onConfirm:function(){this.submitEverything(deferredSubmit)}.bind(this),onCancel:function(){deferredSubmit.reject()}.bind(this)})}.bind(this)):deferredSubmit.reject()}catch(e){logger.error(e),deferredSubmit.reject()}return deferredSubmit.always(function(){this.$body.removeClass("lo-submit-in-progress"),this.validationLock.unlock(),this.notifyEndAction("submit")}.bind(this)),deferredSubmit.then(function(submitData){return a5.eventBus.trigger("lo:submit",submitData),a5.eventBus.trigger("lo:finish"),submitData})},submitEverything:function(deferredSubmit){this.justSubmitted=!0,this.submitAttempts++,this.totalSubmitted=!this.hasMoreSubmitAttempts(),this.setProgress(),this.timer&&this.timer.stop();var promises=_.map(this.intList,function(interaction){var promise;return"input"===interaction.getStatus()&&(promise=interaction.setAnswer().then(function(){return interaction.getResultsAsync()}.bind(this)).then(function(results){a5.eventBus.trigger("interaction:check_answer:submit",{score:results,interaction:interaction})}.bind(this))),$.when(promise).then(function(){return interaction.store()}.bind(this))},this);$.when.apply($,promises).then(function(){return this.updateLODuration(),this.saveDuration(),this.saveAttempts(),this.pauseLO(),this.saveScores()}.bind(this)).then(function(){return this.getResultsForSubmittedAsync()}.bind(this)).then(function(results){return $.when(results,a5.service.lms.API.submit(results,this.sessionLODuration))}.bind(this)).then(function(results,isLOFinished){isLOFinished||(this.hasEndResultScreen()?this.options().endResultScreenIsButtonAfterScore()||this.options().endResultAlwaysIsButtonAfterScore()?(this.showSubmitInfo(),this.updateControls()):this.goToResultScreen():a5.dp.config.closeLOAfterSubmit?this.close():(this.showSubmitInfo(),this.updateControls())),deferredSubmit.resolve({score:results,duration:this.sessionLODuration})}.bind(this))},submitFinish:function(deferredSubmit){var results=this.getResultsAsCompleted();this.justSubmitted=!0,this.submitAttempts++,this.totalSubmitted=!this.hasMoreSubmitAttempts(),this.setProgress(),this.timer&&this.timer.stop(),this.updateLODuration(),this.saveDuration(),this.saveScoresAsCompleted(),this.saveAttempts(),this.pauseLO(),a5.service.lms.API.submit(results,this.sessionLODuration).then(function(isLOFinished){isLOFinished?this.updateControls():this.showSubmitFinish({onClose:function(){this.goToResultScreen()}.bind(this)}),deferredSubmit.resolve({score:results,duration:this.sessionLODuration})}.bind(this))},showSendScoresInfo:function(){this.getResultsAsync().then(function(results){a5.view.dialog.display("a5.view.dialog.SendScoresInfo",{dialogClass:"dialog-send-scores",correct:results.human().correct(),total:results.human().total()})}.bind(this))},showNotAllCheckedWarning:function(callbacks){a5.view.dialog.display("a5.view.dialog.sendScores",{dialogClass:"dialog-send-scores"},{ok:function(){callbacks.onConfirm()},close:function(okClicked){okClicked||callbacks.onCancel()}})},showOfflineWarning:function(){a5.view.dialog.display("a5.view.dialog.OfflineCheck",{dialogClass:"offline-check"},{},!1,!1,a5.dp.config.appendOfflineTextTo)},showSubmitFinish:function(callbacks){a5.view.dialog.display("a5.view.dialog.SubmitFinish",{dialogClass:"dialog-submit-finish"},{close:callbacks.onClose})},showSubmitWarning:function(callbacks){var showSubmitData=this.options(!0).getShowSubmit(),data={dialogClass:"confirmation-dialog dialog-really-submit",minLengthNotReached:!this.meetsMinLength(),heading:showSubmitData.dialogHeadingText,headingTooltip:showSubmitData.dialogHeadingTooltip,text:showSubmitData.dialogContentText,textTooltip:showSubmitData.dialogContentTooltip,cancelLabel:showSubmitData.dialogCancelText,cancelTooltip:showSubmitData.dialogCancelTooltip,submitLabel:showSubmitData.dialogSubmitText,submitTooltip:showSubmitData.dialogSubmitTooltip};a5.view.dialog.display("a5.view.dialog.ReallySubmit",data,{ok:function(){callbacks.onConfirm()},close:function(okClicked){okClicked||callbacks.onCancel(),this.$body.removeClass("dialog-no-overlay")}.bind(this)},void 0,!0),this.$body.addClass("dialog-no-overlay")},sendScores:function(){if(this.validationLock.isLocked())return logger.warn("Cannot run concurrent actions."),$.Deferred().reject().promise();this.validationLock.lock(),this.notifyBeginAction("sendScores");var deferredSendScores=$.Deferred();try{this.$body.addClass("lo-send-scores-in-progress"),this.hasMoreSendScoreAttempts()?$.when(this.getResultsForSubmittedAsync(),this.areAllChecked()).then(function(results,allChecked){var hasEndResultScreen=this.hasEndResultScreen(),isAdaptive=this.options().forwardButtonIsAdaptive();allChecked||isAdaptive?hasEndResultScreen?this.saveScores().then(function(){this.sendScoreAttempts++,this.pauseLO(),this.saveAttempts(),this.updateLODuration(),this.saveDuration(),this.options().endResultScreenIsButtonAfterScore()||this.options().endResultAlwaysIsButtonAfterScore()?(this.showSendScoresInfo(),this.updateControls()):this.goToResultScreen(),deferredSendScores.resolve({score:results})}.bind(this)):this.saveScores().then(function(){this.sendScoreAttempts++,this.pauseLO(),this.options(!0).sendscoresIsFinal_check_answers()?this._showResultsDialog():this.showSendScoresInfo(),this.saveAttempts(),this.updateLODuration(),this.saveDuration(),this.updateControls(),deferredSendScores.resolve({score:results}),a5.dp.config.postMessageUIManagement&&this.sendPostMessageComplete()}.bind(this)):this.showNotAllCheckedWarning({onConfirm:function(){this.sendScoreAttempts++,this.pauseLO(),hasEndResultScreen?this.saveScores().then(function(){this.saveAttempts(),
this.updateLODuration(),this.saveDuration(),this.options().endResultScreenIsButtonAfterScore()||this.options().endResultAlwaysIsButtonAfterScore()?(this.showSendScoresInfo(),this.updateControls()):this.goToResultScreen(),deferredSendScores.resolve({score:results})}.bind(this)):_.defer(function(){this.saveScores().then(function(){this.showSendScoresInfo(),this.saveAttempts(),this.updateLODuration(),this.saveDuration(),this.updateControls(),deferredSendScores.resolve({score:results})}.bind(this))}.bind(this))}.bind(this),onCancel:function(){deferredSendScores.reject()}})}.bind(this)):deferredSendScores.reject()}catch(e){logger.error(e),deferredSendScores.reject()}return deferredSendScores.always(function(){this.$body.removeClass("lo-send-scores-in-progress"),this.validationLock.unlock(),this.notifyEndAction("sendScores")}.bind(this)),deferredSendScores.then(function(scoreData){return a5.eventBus.trigger("lo:total_score",scoreData),a5.eventBus.trigger("lo:finish"),scoreData})},saveDuration:function(){a5.service.lms.API.setData("duration",this.aggregatedLODuration)},saveAttempts:function(){var attempts=0;this.canSubmit?attempts=this.submitAttempts:this.canSendScores&&(attempts=this.sendScoreAttempts),a5.service.lms.API.setData("attempts",attempts)},saveExamTime:function(){a5.service.lms.API.setData("examTimeElapsed",this.examTimeElapsed),a5.service.lms.API.setData("examTimeOnExtraTime",this.examTimeOnExtraTime)},saveScores:function(){return $.when(this.getDetailedScores(),this.getResultsForSubmittedAsync()).then(function(detailedScores,results){a5.service.lms.API.setDetailedScore(detailedScores),a5.service.lms.API.setScore(results),this.justScoresSent=!0,this.trigger("score_update"),this.updateLocalStorage(results)}.bind(this))},saveScoresAsCompleted:function(){var results=this.getResultsAsCompleted();a5.service.lms.API.setScore(results),this.justScoresSent=!0,this.updateLocalStorage(results)},saveNotes:function(){a5.service.lms.API.setData("note",this.note)},updateNotes:function(note){this.note=note},openNotes:function(){this.notebook&&this.notebook.toggle()},closeNotes:function(){this.notebook&&this.notebook.close()},updateLocalStorage:function(results){try{!_.isUndefined(window.mu)&&window.localStorage&&(window.localStorage.getItem(window.project+window.mu[0])?window.localStorage.setItem(window.project+"last_"+window.mu[0],JSON.stringify({u:window.mu[1],l:window.mu[2],c:window.mu[3],total:results.total(),correct:results.correct(),filled:results.filled()})):window.localStorage.setItem(window.project+window.mu[0],JSON.stringify({u:window.mu[1],l:window.mu[2],c:window.mu[3],total:results.total(),correct:results.correct(),filled:results.filled()})))}catch(e){logger.warn(e)}},showSubmitInfo:function(){this.getResultsAsync().then(function(results){var attemptsLeft=this.maxAttempts-this.submitAttempts,maxAttempts=this.maxAttempts;_.isFinite(maxAttempts)||(attemptsLeft="Unlimited",maxAttempts="Unlimited"),a5.view.dialog.display("a5.view.dialog.SubmitInfo",{dialogClass:"dialog-submit-info",maxAttempts:maxAttempts,attemptsLeft:attemptsLeft,correct:results.human().correct(),incorrect:results.human().incorrect(),filled:results.human().filled(),total:results.human().total(),attempts:this.submitAttempts,percent:Math.round(results.percent())})}.bind(this))},showResults:function(){this.options().endResultScreenIsFalse()&&this.options().endResultAlwaysIsOff()||(A5.LO_WITH_EXTERNAL_RESULT_SCREEN?(this.showExternalResults(),this.updateControls()):("Exam"!==LOInfo.mode&&"Trainer"!==LOInfo.mode||_.last(this.intList).rubricZone.hide(),this.resultsGenerator.cacheScores().then(function(){this.goLast()}.bind(this))))},showExternalResults:function(){var promise;this.justScoresSent&&(promise=this.getResultsForSubmittedAsync().then(function(results){var score={scaled:results.scaled(),raw:results.raw(),min:results.min(),max:results.max()};a5.service.lms.API.setData("score",score)}.bind(this))),$.when(promise).then(function(){return a5.service.lms.API.getData("score")}.bind(this)).then(function(score){var data={score:score,timetaken:Math.round(this.aggregatedLODuration),review:Boolean(a5.view.controls.getEndResultOption(this.curInteraction).exercisesLabel)};a5.eventBus.trigger("lo:show_external_results",data)}.bind(this))},showExercises:function(){this.options().endResultAlwaysIsOn()||this.options().endresultsreturnIsFirst()?this.goFirst(!0):this.goLast(!0)},getScores:function(){var scores=new a5.Score,intList=this.getAdaptiveInteractions();return _.each(intList,function(interaction){if(void 0!==interaction){var score=interaction.getScores();void 0!==score&&(scores.total+=score.total,scores.correct+=score.correct,scores.filled+=score.filled,scores.totalBlocks+=score.totalBlocks,scores.correctBlocks+=score.correctBlocks)}}),scores},getScoresAsync:function(){var intList=this.getAdaptiveInteractions(),promises=_.invoke(intList,"getScoresAsync");return $.when.apply($,promises).then(function(){var scores=Array.prototype.slice.call(arguments);return _.reduce(scores,function(memo,score){return memo.total+=score.total,memo.correct+=score.correct,memo.filled+=score.filled,memo.totalBlocks+=score.totalBlocks,memo.correctBlocks+=score.correctBlocks,memo},new a5.Score)})},getDetailedScores:function(){var intList=this.getAdaptiveInteractions(),promises=_.map(intList,function(i){var promise=i.getResultsAsync(),type="";return type=i.isIntroScreen()?"intro":i.isEndResultScreen()?"endresult":i.isManuallyMarked()?"manual":"auto",promise.then(function(res){return[type,"auto"===type?res.correct():null,res.total()]})});return $.when.apply($,promises).then(function(){return Array.prototype.slice.call(arguments)})},getResults:function(limitTo,scoreFetcher){limitTo=limitTo||function(){return!0};var results=new a5.ResultList,intList=this.getAdaptiveInteractions();return _.each(_.filter(intList,limitTo),function(interaction){var result=interaction.getResults(scoreFetcher);results.push(result)}),results},getResultsAsync:function(limitTo,scoreFetcher){limitTo=limitTo||function(){return!0};var intList=this.getAdaptiveInteractions(),promises=_.invoke(_.filter(intList,limitTo),"getResultsAsync",scoreFetcher);return $.when.apply($,promises).then(function(){var resultList=new a5.ResultList,results=Array.prototype.slice.call(arguments);return _.each(results,function(result){resultList.push(result)}),resultList}.bind(this))},getResultsAsCompleted:function(){return new a5.CompletedResult},getCurrentInteractionScores:function(){var curInteraction=this.getCurrentInteraction();if(curInteraction){var scores=curInteraction.getScores(),results=curInteraction.getResults(function(){return scores});return{scores:scores,results:results}}},getCurrentInteractionScoresAsync:function(){var curInteraction=this.getCurrentInteraction();return curInteraction?$.when(curInteraction.getScoresAsync(),curInteraction.getResultsAsync()).then(function(scores,results){return{scores:scores,results:results}}.bind(this)):$.when()},getResultsForSubmittedAsync:function(){return this.getResultsAsync(void 0,function(interaction){return interaction.getScoresAsync().then(function(score){return"input"===interaction.getStatus()&&(score.correct=0,score.correctBlocks=0),score})})},getResultsForSubmitted:function(){return this.getResults(void 0,function(interaction){var score=interaction.getScores();return"input"===interaction.getStatus()&&(score.correct=0,score.correctBlocks=0),score})},getMaximumScore:function(){var intList=this.getAdaptiveInteractions(),promises=_.invoke(intList,"getMaximumScore");return $.when.apply($,promises).then(function(){var scores=Array.prototype.slice.call(arguments);return _.reduce(scores,function(memo,maximumScore){return memo+maximumScore},0)}.bind(this))},getTotalFilled:function(){var intList=this.getAdaptiveInteractions(),promises=_.invoke(intList,"getTotalFilled");return $.when.apply($,promises).then(function(){var counts=Array.prototype.slice.call(arguments);return _.reduce(counts,function(memo,count){return memo+count},0)}.bind(this))},isFilled:function(){var promises=_.map(this.intList,function(interaction){return $.when(interaction.isFilled()).then(function(someFilled){return{someFilled:someFilled}})});return $.when.apply($,promises).then(function(){var interactions=Array.prototype.slice.call(arguments);return _.some(interactions,"someFilled")})},areAllFilled:function(){var promises=_.map(this.intList,function(interaction){return $.when(interaction.areAllFilled()).then(function(allFilled){return{allFilled:allFilled}})});return $.when.apply($,promises).then(function(){var interactions=Array.prototype.slice.call(arguments);return _.isEmpty(interactions)||_.every(interactions,"allFilled")})},getAttempts:function(){var attempts=0;return this.canSubmit?attempts=this.submitAttempts:this.canSendScores&&(attempts=this.sendScoreAttempts),attempts},_applyPreScreenTransition:function(from,to){var direction=from-to<0?"right":"left",$from=this._getInteractionNode(from),$to=this._getInteractionNode(to),offset=$from.offset();$from.css({top:-window.scrollY+offset.top}),this.$body.addClass("screen-transition transition-"+direction),$from.addClass("former"),$to.css({top:offset.top}),a5.dp.config.screenTransitionStart($from,$to)},_applyPostScreenTransition:function(from,to){var $from=this._getInteractionNode(from),$to=this._getInteractionNode(to);$to.addClass("current"),_.defer(function(){this.$body.addClass("transition")}.bind(this)),setTimeout(function(e){this.$body.removeClass("screen-transition transition"),this.$body.removeClass("transition-left transition-right"),$(".content-wrap").removeClass("current former"),this.curInteraction.trigger("screen_transition:end"),a5.dp.config.screenTransitionEnd($from,$to)}.bind(this),a5.dp.config.screenTransitionDuration)},_getInteractionNode:function(interactionIndex){return this.getInteractionFromIndex(interactionIndex).contentWrap},_unfocusEverything:function(){this.curInteraction.contentWrap.find(":focus").blur(),window.CKEDITOR&&CKEDITOR.instances&&_.each(CKEDITOR.instances,function(instance){instance.focusManager.blur(!0)})},goTo:function(interactionIndex){this.curInteraction&&(this.curInteraction.store(),this._unfocusEverything(),a5.dp.config.screenTransitionEnabled&&this._applyPreScreenTransition(this.curInteraction.index,interactionIndex),this.curInteraction.contentWrap.find(":focus").blur()),this.startTask(interactionIndex),this._adjustForwardButtonLabel(this.curTask),this.curInteraction&&a5.dp.config.screenTransitionEnabled&&this._applyPostScreenTransition(this.curInteraction.index,interactionIndex)},goNext:function(){return this._nextAdaptiveInteraction().then(function(tNum){if(-1==tNum){var intList=_([this.introScreen,this.intList]).chain().flatten().compact().value();tNum=this._nextAvailableInteraction(intList,this.curTask)}if(tNum!==this.curTask){if(!a5.dp.config.forwardConfirmation)return this.goTo(tNum),!0;a5.view.dialog.display("a5.view.dialog.ForwardConfirmation",{dialogClass:"confirmation-dialog dialog-forward"},{ok:function(){this.goTo(tNum)}.bind(this)})}return!1}.bind(this))},goLast:function(withoutEndResult){var intList=withoutEndResult?this.getInteractionsWithoutEndResult():this.intList;intList=_([this.introScreen,intList]).chain().flatten().compact().value();var tNum=this._lastAvailableInteraction(intList);return tNum!==this.curTask&&(this.goTo(tNum),!0)},goPrev:function(){var intList=_([this.introScreen,this.intList]).chain().flatten().compact().value(),tNum=this._previousAvailableInteraction(intList,this.curTask);return tNum!==this.curTask&&(this.goTo(tNum),!0)},goFirst:function(withoutIntroScreen){var intList=_([this.introScreen,this.intList]).chain().flatten().compact().value();withoutIntroScreen&&(intList=this.getInteractionsWithoutIntroScreen(intList));var tNum=this._firstAvailableInteraction(intList);return tNum!==this.curTask&&(this.goTo(tNum),!0)},goToResultScreen:function(){this.showResults()},goToExerciseScreen:function(){this.showExercises()},hasPrev:function(){var intList=_([this.introScreen,this.intList]).chain().flatten().compact().value();return this.curTask>this._firstAvailableInteraction(intList)},hasNext:function(withoutEndResult){var intList=withoutEndResult?this.getInteractionsWithoutEndResult():this.intList;return intList=_([this.introScreen,intList]).chain().flatten().compact().value(),this.curTask<this._lastAvailableInteraction(intList)},hasIntroScreen:function(){return!!this.introScreen},hasEndResultScreen:function(){return _.last(this.intList).isEndResultScreen()},addInteraction:function(url,preview,helpText,resources){this._addInteraction({url:url,preview:preview,helpText:helpText,resources:resources})},setAttempts:function(){if(this.maxAttempts>1&&this.maxAttempts<1e3&&this.submitAttempts<this.maxAttempts&&this.options(!0).finishSubmitIsOff()){$("#the_timer_wrap").show();var cAttempt=Math.min(this.maxAttempts,this.submitAttempts+1);$("#the_timer_wrap .timer_label").text("Attempt: "+cAttempt+"/"+this.maxAttempts)}else $("#the_timer_wrap").hide()},initIntroScreen:function(interaction){this.introScreen=interaction,interaction&&(this.introScreen.index=-1,this.introScreen.visibleIndex=0)},checkIntroScreen:function(list){if(this.options().introScreenIsOn())return _(list).first()},checkEndResultScreen:function(list){if(!this.options().endResultScreenIsFalse()||!this.options().endResultAlwaysIsOff())return _(list).last()},checkVisibility:function(interaction){var userVisibility=interaction.options.getUserVisibility();return"all"===userVisibility||userVisibility===a5.service.lms.API.getUserRole().toLowerCase()},getAllInteractionsGroups:function(){return a5.utils.getInteractionsGroups(this.allInteractionsList)},initIntList:function(params){var setParams=_.extend({allowIntroScreen:!0,shuffle:!1,groups:null,count:!1},params),groups=[],allInteractionsList=this.allInteractionsList;if(setParams.groups){var filteredActivities=_.filter(allInteractionsList,function(interaction){return!_.isEmpty(interaction.group)&&_.contains(setParams.groups,interaction.group)});filteredActivities.length&&(groups=setParams.groups,allInteractionsList=this.userSelectScreen.concat(filteredActivities))}this.userSelectScreen&&this.userSelectScreen.length&&(allInteractionsList=groups.length?this.userSelectScreen.concat(allInteractionsList):this.userSelectScreen);var filteredList=_(allInteractionsList).filter(this.checkVisibility,this),introScreen=this.checkIntroScreen(allInteractionsList),endResultScreen=this.checkEndResultScreen(filteredList);filteredList=_(filteredList).filter(function(interaction){return interaction!==endResultScreen&&interaction!==introScreen}),setParams.shuffle&&(filteredList=_.shuffle(filteredList)),filteredList=groups.length?this.sliceInteractionsGroup(filteredList,groups,{shuffle:params.shuffle,count:params.count}):this.sliceInteractions(filteredList,{count:params.count}),endResultScreen&&(filteredList=filteredList.concat(endResultScreen)),_.each(filteredList,function(interaction,index){interaction.index=index,interaction.visibleIndex=index+1}),this.intList=filteredList,introScreen&&(introScreen=setParams.allowIntroScreen?introScreen:null,this.initIntroScreen(introScreen))},sliceInteractionsGroup:function(interactionsList,groups,config){var list=interactionsList,groupList=groups,count=config.count;if(count){count>groups.length&&(groupList=groupList.slice(0,config.count));var groupsOrdered=_.map(groupList,function(group){var interlist=_.where(list,{group:group});return config.shuffle&&(interlist=_.shuffle(interlist)),interlist});count=Math.min(count,_.reduce(groupsOrdered,function(memo,item){return memo+item.length},0)),config.shuffle&&(groupsOrdered=_.shuffle(groupsOrdered));for(var nextCatIndex=0,newList=[],i=0;i<count;i++){var cat=groupsOrdered[nextCatIndex],iteraction=cat.splice(0,1),nextCat=groupsOrdered[(nextCatIndex+1)%groupsOrdered.length];0===cat.length&&groupsOrdered.splice(nextCatIndex,1),nextCatIndex=groupsOrdered.indexOf(nextCat),newList=newList.concat(iteraction)}list=_.sortBy(newList,function(item){return groupList.indexOf(item.group)})}return config.shuffle&&(list=_.shuffle(list)),list},sliceInteractions:function(interactionsList,config){var list=interactionsList;return config.count&&(list=list.slice(0,config.count)),list},renderInteraction:function(interaction){return interaction.bind("show",function(){a5.eventBus.trigger("interaction:start",{id:this.index,interaction:this})}),interaction.render().then(function(){if(!interaction.isEndResultScreen())return this.resultsGenerator.cacheSolvable(interaction)}.bind(this)).then(function(){this.updateControls(),this.layout.checkSize()}.bind(this))},renderInteractions:function(interactions){var promises=[];return _(interactions).each(function(interaction){promises.push(this.renderInteraction(interaction))},this),promises},renderInteractionDelayed:function(interaction,group){group=group||"interactions";var deferred=$.Deferred();return a5.tasks.push(new a5.FunctionTask(_.bind(function(){return a5.eventBus.trigger("performance:render_"+interaction.url+":start"),this.renderInteraction(interaction).done(function(){a5.eventBus.trigger("interaction:ready",interaction),deferred.resolve(),a5.eventBus.trigger("performance:render_"+interaction.url+":end")}),!0},this)),group),deferred.promise()},renderInteractionsDelayed:function(interactions,group){var promises=[];return _.each(interactions,function(interaction,i){promises.push(this.renderInteractionDelayed(interaction,group))},this),$.when.apply($,promises)},openIntList:function(interactions,interactionIndex){this._notifyOnLORestored(interactions),(a5.dp.config.displayAllScreens?this.openAll(interactions):this.openOne(interactions,interactionIndex)).then(function(){this.ready=!0,a5.eventBus.trigger("lo:ready",interactions),a5.eventBus.trigger("performance:render_LO:end"),a5.tasks.clear("interactions")}.bind(this))},openOne:function(interactions,interactionIndex){var landingScreen=this.getInteractionFromIndex(interactionIndex),rest=_.without(interactions,landingScreen),renderLandingScreen=this.renderInteractionDelayed(landingScreen),renderRest=this.renderInteractionsDelayed(rest);return this.goTo(interactionIndex),$.when(renderLandingScreen,renderRest)},openAll:function(interactions){var renderAll=_.map(interactions,function(interaction){return this.curTask=interaction.index,interaction.show(),this.curInteraction=interaction,this.renderInteraction(interaction)}.bind(this));return $.when.apply($,renderAll)},_notifyOnLORestored:function(interactions){if(this.options(!0).restoreLOStateIsOn()){this.restoring=!0;var interactionsToBeRestored=interactions,restoredListener=_.bind(function(interaction){interaction.unbind("restored",restoredListener),interactionsToBeRestored=_.without(interactionsToBeRestored,interaction),0===interactionsToBeRestored.length&&(this.restoring=!1,a5.eventBus.trigger("lo:restored",interactions))},this);_.invoke(interactions,"bind","restored",restoredListener)}},_loadInteractions:function(){var deferred=$.Deferred();return this.interactionsLoader.bind("finished",function(intList,userSelectScreen){this.allInteractionsList=intList,this.userSelectScreen=userSelectScreen,this.initIntList({shuffle:this.options().activitypoolIsRandomiseAll()});var interactions=_([this.introScreen,this.intList]).chain().flatten().compact().value();deferred.resolve(interactions)},this),this.interactionsLoader.start(),deferred.promise()},_loadLMSData:function(){return a5.service.lms.API.getData().then(function(data){if(this.confidenceLevel=data.confidenceLevel||["",""],this.aggregatedLODuration=data.duration,this.examTimeElapsed=data.examTimeElapsed,this.examTimeOnExtraTime=data.examTimeOnExtraTime,this.note=data.note||"",!this.options(!0).restoreLOStateIsOff()){var attempts=data.attempts||0;this.canSubmit?this.submitAttempts=attempts:this.canSendScores&&(this.sendScoreAttempts=attempts),data.displaySettings&&(this.currentDisplayPattern=data.displaySettings.pattern,this.currentDisplayBackground=data.displaySettings.background,this.$body.addClass(this.currentDisplayPattern),this.$body.addClass(this.currentDisplayBackground))}}.bind(this))},_getStartInteractionIndex:function(startActivity,interactions,bookmark){var interactionIndex;if(_.isNumber(startActivity)?(interactionIndex=startActivity,this.options().introScreenIsOn()&&(interactionIndex-=1)):_.isNumber(A5.START_TASK)?(interactionIndex=A5.START_TASK,this.options().introScreenIsOn()&&(interactionIndex-=1)):_.isNumber(bookmark)&&(interactionIndex=bookmark),null==interactionIndex&&(interactionIndex=this.options().introScreenIsOn()?-1:0),A5.DICTIONARY_REF){var target=_.find(interactions,function(interaction){return interaction.highlightDictionaryEntry()});target&&target.index>=0&&(interactionIndex=target.index)}var theInt=this.getInteractionFromIndex(interactionIndex);if(!theInt||theInt.locked){var firstAvailable=this._firstAvailableInteraction(interactions);if(interactionIndex===firstAvailable)throw"No available activities found";interactionIndex=firstAvailable}return interactionIndex},_start:function(interactions,interactionIndex){a5.eventBus.trigger("performance:render_LO:start"),this.timer&&this.timer.startOnShow(interactions),this.loadScreensOnDemand?this.goTo(interactionIndex):this.openIntList(interactions,interactionIndex),this.controls=new a5.view.controls.Bar({lo:this,$el:$("#activity_controls")}),this.controls.render(),this._adjustForwardButtonLabel(this.curTask),this.screenNavigation=new a5.views.ScreenNavigation($("#unit-menu")),this.lessonNotes=new a5.views.LessonNotes($("#lesson-notes")),this.options(!0).lONotesAreaIsOn()&&(this.notebook=new a5.view.LONotesDialog(this),this.notebook.bind("open",function(){this.$body.addClass("notes-opened")},this),this.notebook.bind("close",function(){this.$body.removeClass("notes-opened")},this),this.$body.append(this.notebook.$el),this.notebook.render()),$("*[data-event=tools]").length>0&&(this.whiteboardTools=new a5.views.WhiteboardTools("*[data-event=tools]",interactions))},start:function(startActivity){var promises=[];promises.push($.when().then(function(){a5.eventBus.trigger("performance:engine_lmsdata:start")}).then(this._loadLMSData.bind(this)).then(function(){a5.eventBus.trigger("performance:engine_lmsdata:end"),a5.eventBus.trigger("performance:engine_load_interactions:start")}).then(this._loadInteractions.bind(this)).then(function(interactions){return a5.eventBus.trigger("performance:engine_load_interactions:end"),interactions})),_.isUndefined(startActivity)&&promises.push($.when(this.getBookmark())),$.when.apply(this,promises).then(function(interactions,bookmark){var interactionIndex=this._getStartInteractionIndex(startActivity,interactions,bookmark);this._start(interactions,interactionIndex)}.bind(this))},getBookmark:function(){if(!this.options().restoreLOStateIsOff())return a5.service.lms.API.getBookmark()},onWindowBeforeUnload:function(e){if(a5.service.lms.API.isDataDirty()){return e.returnValue="Are you sure you want to close the LO?","Are you sure you want to close the LO?"}},onWindowUnload:function(){a5.service.lms.API.clearDataDirty(),this.close(!0)},onClickClose:function(e){e.preventDefault();var dialog,dirty=a5.service.lms.API.isDataDirty();(a5.dp.config.confirmBeforeClose||dirty)&&(dialog=a5.view.dialog.display("a5.view.dialog.Close",{dialogClass:"dialog-close-lo",unsavedChanges:dirty},{ok:function(){a5.service.lms.API.clearDataDirty(),this.close()}.bind(this),cancel:function(){logger.info("LO Close Canceled")}},!1,!1,a5.dp.config.closeDialogAppendTo)),a5.dp.config.postMessageUIManagement?a5.service.postMessager.sendMessage("closeLO"):dialog||this.close()},sendPostMessageComplete:function(){a5.service.postMessager.sendMessage("completeLO"),a5.service.postMessager.sendMessage("closeLO")},save:function(){_(this.intList).invoke("store",!0),a5.service.lms.API.setData("displaySettings",{pattern:this.currentDisplayPattern,background:this.currentDisplayBackground}),a5.eventBus.trigger("lo:save")},pauseLO:function(){a5.service.media.pauseAll(),a5.service.media.audio.stopAll()},close:function(sync){if(!this.closed){var deferredClose=$.Deferred();this.closed=!0,logger.log("exit..."),null!=this.curInteraction&&(this.curInteraction.activityTimer.stop(),this.curInteraction.updateActivityDuration(),this.curInteraction.store()),this.hasMoreSubmitAttempts()&&(this.updateLODuration(),this.saveDuration()),this.timer&&(this.updateExamTime(),this.saveExamTime()),A5.LMS_CLOSE?a5.service.lms.API.close(sync).then(function(){deferredClose.resolve()}):deferredClose.resolve(),this.deferredClose=deferredClose.then(function(){a5.eventBus.trigger("lo:end",this),a5.dp.config.allowLOSelfClosing&&window.close()})}return this.deferredClose},resetLO:function(){this.close(),this.$body.html("");var mainBuilder=new a5.MainBuilder(window.LOInfo),layout=new a5.Layout(A5.SKIN_URL,_.bind(function(){layout.applyPackageLayout().done(_.bind(function(){_.each(a5.mainBuilder.xmlList,function(path){mainBuilder.addInteraction(path)}),a5.mainBuilder=mainBuilder,a5.mainBuilder.layout=this.layout,a5.mainBuilder.start()},this))},this),!0)},getInteractionFromIndex:function(interactionIndex){return interactionIndex<0?this.introScreen:this.intList[interactionIndex]},startTask:function(interactionIndex){null!=this.curInteraction&&(this.curInteraction.hide(),this.curInteraction.stopAutosave(),a5.eventBus.trigger("interaction:end")),this.curTask=interactionIndex;var theInt=this.getInteractionFromIndex(interactionIndex);this.loadScreensOnDemand&&(theInt.isLiveCycle("loaded")||this.renderInteraction(theInt).done(function(){if(a5.eventBus.trigger("interaction:ready",theInt),!this.ready){this.ready=!0;var interactions=_([this.introScreen,this.intList]).chain().flatten().compact().value();a5.eventBus.trigger("lo:ready",interactions),a5.eventBus.trigger("performance:render_LO:end")}}.bind(this))),theInt.show(),this.curInteraction=theInt,this.curInteraction.options.autosaveIsOn()&&this.curInteraction.startAutosave(),this.spinner.toggleFor(theInt),a5.service.lms.API.setBookmark(this.curTask),this.setProgress(),this.updateControls()},updateControls:function(){this.controls&&this.controls.update(),this.curInteraction&&this.curInteraction.controls&&this.curInteraction.controls.update()},_adjustForwardButtonLabel:function(interactionIndex){this.controls&&(this.controls.node.find("*[data-event='forward'] *[data-label-interaction]").css("display","none"),this.controls.node.find("*[data-event='forward'] *[data-label-interaction='"+interactionIndex+"']").css("display",""))},initLOInfo:function(){null==this.LOInfo&&(this.LOInfo=new a5.LOInfo({info:window.LOInfo}))},initPlatformOptions:function(){if(null==this.platformOptions){var options={};a5.service.lms.API.isTTSDisabled()&&(options["052"]={key:"false"},options["034"]={key:"false"}),this.platformOptions=new a5.models.options.Options,this.platformOptions.readAllFromObject(options)}},initMaxAttempts:function(){this.canSubmit?this.options(!0).submissionsIsUnlimited()||this.options(!0).finishSubmitIsOn()?this.maxAttempts=1/0:this.maxAttempts=parseInt(this.options(!0).getSubmissions(),10):this.canSendScores?this.options(!0).sendscoresIsUnlimited()||this.options(!0).sendscoresIsFinal_check_answers()?this.maxAttempts=1/0:this.maxAttempts=parseInt(this.options(!0).getSendscores(),10):this.maxAttempts=0},setProgress:function(){this.setAttempts()},getElapsedTime:function(){return this.loTimer.getTime()},updateLODuration:function(){this.sessionLODuration=this.getElapsedTime(),this.aggregatedLODuration=this.aggregatedLODuration||0,this.aggregatedLODuration+=this.sessionLODuration},updateExamTime:function(){this.examTimeElapsed=this.timer.getElapsedTime(),this.examTimeOnExtraTime=this.timer.isOnExtraTime()},initExamTimer:function(){if(this.options(!0).examsTimerIsOn()){var examTimerData=this.options(!0).getExamsTimer();if(examTimerData){var originalTime=examTimerData.time;this.timer=new a5.model_builder.ExamTimer(_.extend({originalTime:originalTime,lo:this},examTimerData))}}},getAnswerFromScreen:function(answerNum,screenNum){logger.warn("getAnswerFromScreen is not implemented")},interactionDataLoaded:function(interaction){var templateName=$(interaction.xml).children("assessmentitem").attr("template")||"default";a5.service.templates.loadLayoutTemplate(templateName,_.bind(interaction.templateLoaded,interaction),window.LOInfo.template)},loadTemplates:function(){},openDigitalBook:function(){this.engine.invoke("open-link",LOInfo.bookUrl,{target:"lessonPlan"+LOInfo.id+"DigitalBook"})},showLessonNotes:function(buttons){this.lessonNotes.show(),buttons.update()},showLesson:function(buttons){this.lessonNotes.hide(),buttons.update()},toggleToolbox:function(){window.a5a&&a5a.toolbox.view.toggle()},showWiki:function(buttons){this.curInteraction.wikiTool.show(),buttons.update()},fullscreen:function(){screenfull.enabled&&screenfull.toggle()},showTimeSpentInSections:function(){var sections=this.options(!0).getLOParts(),totalRecommendedTime=0,totalTimeSpent=0;sections=_.reject(sections,function(section){var interactionIndex=section.from-1,interaction=this.getInteractionFromIndex(interactionIndex);return this.timer&&"off"===this.timer.countIntroScreen&&section.from===section.to&&interaction.isIntroScreen()},this),_.each(sections,function(section){_.isUndefined(section.timeSpent)&&(section.timeSpent=0),_.each(_.range(section.from-1,section.to),function(interactionIndex){var interaction=this.getInteractionFromIndex(interactionIndex);this.timer&&"off"===this.timer.countIntroScreen&&interaction.isIntroScreen()?section.timeSpent+=0:section.timeSpent+=Math.round(interaction.aggregatedDuration/1e3),section.inTime=!section.recommendedTime||section.timeSpent<60*section.recommendedTime},this),totalTimeSpent+=section.timeSpent,totalRecommendedTime+=60*section.recommendedTime,section.timeSpent=a5.utils.secondsToTime(section.timeSpent),section.recommendedTime=section.recommendedTime?a5.utils.secondsToTime(60*section.recommendedTime):""},this),a5.view.dialog.display("a5.view.dialog.TimeSpentInSections",{dialogClass:"dialog-time-spent-in-sections",sections:sections,totalRecommendedTime:a5.utils.secondsToTime(totalRecommendedTime),totalTimeSpent:a5.utils.secondsToTime(totalTimeSpent),totalInTime:totalTimeSpent<totalRecommendedTime})},hasMoreSubmitAttempts:function(){var attemptsLeft=this.maxAttempts-this.submitAttempts;return!_.isFinite(attemptsLeft)||attemptsLeft>0},hasMoreSendScoreAttempts:function(){var attemptsLeft=this.maxAttempts-this.sendScoreAttempts;return!_.isFinite(attemptsLeft)||attemptsLeft>0},isFirstAttempt:function(){return 0===this.getAttempts()},_addInteraction:function(parameters){var interaction;_.defaults(parameters||{},{originalIndex:this.interactionsLoader.queue.length,locked:this._isLockedInteraction(parameters.url)}),this.xmlList.push(parameters.url),interaction=new a5.Interaction(parameters),interaction.bind("show",function(){this.curInteraction&&(this.spinner.toggleFor(this.curInteraction),this.curInteraction.removeBodySubstyle()),interaction.addBodySubstyle()},this),this.interactionsLoader.push(interaction)},_isLockedInteraction:function(url){var lockedInteractions=a5.service.lms.API.getLockedInteractions();return _(lockedInteractions).contains(url)},_nextAvailableInteraction:function(intList,index){var nextInteraction=_(intList).find(function(interaction){return interaction.index>index&&!interaction.locked});return nextInteraction?nextInteraction.index:index},_previousAvailableInteraction:function(intList,index){var prevInteraction=_(intList).chain().filter(function(interaction){return interaction.index<index&&!interaction.locked}).max(function(interaction){return interaction.index}).value();return prevInteraction?prevInteraction.index:index},_firstAvailableInteraction:function(intList){var first=_(intList).find(function(interaction){return!interaction.locked});return first?first.index:this.curTask},_lastAvailableInteraction:function(intList){var list=intList.slice(0).reverse(),last=_(list).find(function(interaction){
return!interaction.locked});return last?last.index:this.curTask},_nextAdaptiveInteraction:function(){return this.curInteraction.getNextAdaptiveInteraction()}},Obj.extend("a5.MainBuilder",a5.MainBuilder),Obj.extend("a5.SpecialCharInserter",{init:function(){this.currentInput=null,this.lastInput=null,this.selectionStart=this.selectionEnd=0;var selectors=["textarea",'input[type="text"]'];$("body").on("blur",selectors.join(),_.bind(function(e){this.currentInput&&(this.lastInput=this.currentInput),this.executeDelay=!0,_.delay(_.bind(function(){this.executeDelay&&(this.currentInput=null,this.trigger("inactive"))},this),500)},this)),$("body").on("focus",selectors.join(),_.bind(function(e){if(this.executeDelay=!1,this.currentInput=$(e.target),this.trigger("active",this.currentInput),this.setSelection){var element=this.getInput();element&&(element=element.get(0),element.setSelectionRange(this.selectionStart,this.selectionEnd)),this.setSelection=!1}},this)),$("body").on("click keyup",selectors.join(),_.bind(function(e){this.selectionStart=this.getInput().prop("selectionStart"),this.selectionEnd=this.getInput().prop("selectionEnd")},this))},isActive:function(){return!!this.currentInput},getInput:function(){return this.currentInput?this.currentInput:this.lastInput},insert:function(text){text=$("<a>"+text+"</a>").text();var $element=this.getInput();if($element)if($element.closest(".input-text.characters-in-gap,.tehs_view.characters-in-gap").length)$element.trigger($.Event("keypress",{which:text.charCodeAt(0)}));else{var element=$element.get(0);if(element.selectionStart||0===element.selectionStart){var startPos=this.selectionStart,endPos=this.selectionEnd,scrollTop=element.scrollTop;element.value=element.value.substring(0,startPos)+text+element.value.substring(endPos,element.value.length),this.selectionStart=startPos+text.length,this.selectionEnd=startPos+text.length,this.setSelection=!0,element.scrollTop=scrollTop}else element.value+=text;$element.trigger("change");var evt=new Event("specialchars:inserted",{bubbles:!0});evt.value=text,element.dispatchEvent(evt)}}}),$(function(){a5.specialCharInserter=new a5.SpecialCharInserter}),a5.Spinner={init:function(){var $node=$("body > .spinner");$node.length||($node=$('<div class="spinner"></div>'),$("body").append($node)),this.$node=$node},toggleFor:function(interaction){interaction.isLiveCycle("loaded")?this.$node.hide():this.$node.show()}},Obj.extend("a5.Spinner"),a5.Layout={init:function(parameters){this.engine=parameters.engine,this.dp=parameters.dp,this.packageURL=this.dp.path,this.height=0,this.width=0},load:function(){var html=a5.service.templates.loadHandlebarsTemplateFromText(this.dp.body,{loTitle:window.LOInfo.title}),$html=this.dp.wrap(html);this.dp.correctLinks($html);var $body=$("body");$body.append($html.contents().clone()),$body.attr("data-mode",(LOInfo.mode||"").toLowerCase()),void 0!==LOInfo.title&&($body.find("#lo-title").html(window.LOInfo.title),$body.find("#activity_title").html(window.LOInfo.title)),a5.hooks.layoutStylesLoaded.call()},getTemplate:function(){return a5.service.templates.loadContentElementTemplate.apply(a5.service.templates,arguments)},replaceSubpart:function(){return a5.service.templates._replaceSubpart.apply(a5.service.templates,arguments)},getSubpart:function(){return a5.service.templates._getSubpart.apply(a5.service.templates,arguments)},checkSize:function(){var size=a5.dp.config.contentSize(),newHeight=size.height,newWidth=size.width;newHeight===this.height&&newWidth===this.width||(this.height=newHeight,this.width=newWidth,a5.eventBus.trigger("lo:size",{height:this.height,width:this.width}))}},Obj.extend("a5.Layout"),a5.DesignPack={cssFile:"css.css",init:function(parameters){a5.utils.endsWith(parameters.path,"/")||(parameters.path+="/"),a5.utils.endsWith(parameters.enginePath,"/")||(parameters.enginePath+="/"),this.path=parameters.path,this.development=!!parameters.development,this.enginePath=parameters.enginePath,this.loadingDocument=document.implementation.createHTMLDocument("New Document"),_.bindAll(this,"correctLinks","wrap","_stripLinks","_loadHeadForDevelopment","_addCss","_addJs","_addEngineCss","_loadDefaultLayoutTemplate","_addLessParser")},correctLinks:function(dom){var pattern=/^((https?:\/\/)|\/|#).*/,rep=function(link){return null!==link.match(pattern)?link:this.path+link}.bind(this);return dom.find("*[href]").each(function(i,e){$(e).attr("href",rep($(e).attr("href")))}),dom.find("*[src]").each(function(i,e){$(e).attr("src",rep($(e).attr("src")))}),dom},wrap:function(html){var $wrap=$("<root></root>",this.loadingDocument);return $wrap[0].innerHTML=html,$wrap},preload:function(){this.development||(a5.utils.preloadResource(this.enginePath+"player.css","style"),a5.utils.preloadResource(this.path+this.cssFile,"style"),a5.utils.preloadResource(this.path+"js.js","script"))},load:function(){var p=[this._loadContentElements(),this._loadHead(),this._loadBody()];return p=$.when.apply($,p),this.development&&(p=p.then(this._addLessParser)),p},loadLayoutTemplate:function(name){return this._load("templates/"+name+".html",!/http(s)*:/.test(window.location.protocol)).then(null,this._loadDefaultLayoutTemplate).then(this.wrap)},loadLayoutTemplateFromString:function(str){return this.wrap(str)},loadSkinTemplateSync:function(name){return this._loadSync("skinTemplates/"+name+".handlebars")},loadSkinTemplate:function(name){return this._load("skinTemplates/"+name+".handlebars")},_loadDefaultLayoutTemplate:function(){return this._load("templates/default.html")},_loadContentElements:function(){return this._load("contentElements.html").then(this.wrap).then(this.correctLinks).then(function(dom){this.contentElements=dom.html()}.bind(this))},_loadHead:function(){var p;return p=this.development?this._loadHeadForDevelopment():this._load("head.html").then(this.wrap).then(this._stripLinks).then(this._addEngineCss).then(this._addJs).then(this._addCss),p.then(function(dom){var promises=[];return dom.children("link, script").clone().each(function(i,e){var $e=$(e);if(!$e.attr("data-browser")||$("body."+$e.attr("data-browser")).length>0){if($e.is('link[rel="stylesheet"]')&&!$("body").is(".isPhantom")){var deferred=$.Deferred();e.onload=e.onerror=function(){deferred.resolve()},promises.push(deferred.promise())}$("head").append(e)}}),$.when.apply(this,promises)})},_loadHeadForDevelopment:function(){return this._load("head.html").then(this.wrap).then(this.correctLinks)},_loadBody:function(){return this._load("body.html").then(this.wrap).then(function(dom){this.body=dom.html()}.bind(this))},_loadFromCache:function(name){var absolutePath=this.path+name;return A5.TEMPLATES&&(A5.TEMPLATES[name]||A5.TEMPLATES[absolutePath])||window.ajaxData&&(window.ajaxData[name]||window.ajaxData[absolutePath])},_loadFromAjax:function(name,options){var path=this.path;options&&options.path&&(path=options.path,delete options.path);var url=path+name;return logger.info("LOADING\t",url.trim()),$.ajax(_.extend({url:url,dataType:"text"},options))},_loadSync:function(name){if(this._isCached(name))return this._loadFromCache(name);var ret;return this._loadFromAjax(name,{async:!1,cache:!0,success:function(data){ret=data}}),ret},_load:function(name){return this._isCached(name)?$.when(this._loadFromCache(name)):this._loadFromAjax(name)},_loadFromEngineSync:function(name){var ret;return this._loadFromAjax(name,{path:this.enginePath,async:!1,cache:!0,success:function(data){ret=data}}),ret},_loadFromEngine:function(name){return this._loadFromAjax(name,{path:this.enginePath})},_addEngineCss:function(dom){return dom.append($("<link rel='stylesheet' type='text/css' href='"+this.enginePath+"player.css'/>")),dom},_addCss:function(dom){return dom.append($("<link rel='stylesheet' type='text/css' href='"+this.path+this.cssFile+"'/>")),dom},_addJs:function(dom){var deferred=$.Deferred();return a5.getScript(this.path+"js.js",function(){deferred.resolve(dom)},function(){deferred.reject()}),deferred.promise()},_addLessParser:function(){var deferred=$.Deferred();return window.less={env:"development",logLevel:2,errorReporting:"console",async:!1,fileAsync:!1,poll:1e3,functions:{},dumpLineNumbers:"comments",relativeUrls:!1},a5.getScript("lib/third-party/less.js",function(){deferred.resolve()},function(){deferred.reject()}),deferred.promise()},_isCached:function(name){var absolutePath=this.path+name;return A5.TEMPLATES&&(_(A5.TEMPLATES).has(name)||_(A5.TEMPLATES).has(absolutePath))||window.ajaxData&&(_(window.ajaxData).has(name)||_(window.ajaxData).has(absolutePath))},_stripLinks:function(dom){return dom.find("*[href]").remove(),dom.find("*[src]").remove(),dom}},Obj.extend("a5.DesignPack"),a5.GitDesignPack={cssFile:"css/style.css",preload:function(){this._super(),a5.utils.preloadResource(this.path+"templates.js","script"),a5.utils.preloadResource(this.path+"js.js","script")},load:function(){return this._loadTemplatesJS().then(function(){var p=[this._loadContentElements(),this._loadHead(),this._loadBody()];return p=$.when.apply($,p),this.development&&(p=p.then(this._addLessParser)),p}.bind(this))},_loadHeadForDevelopment:function(){return this._load("head.html").then(this.wrap).then(this._stripLinks).then(this._addJs).then(this._addCss)},_loadTemplatesJS:function(){var deferred=$.Deferred();return a5.getScript(this.path+"templates.js",function(){deferred.resolve()},function(){deferred.reject()}),deferred.promise()},_loadSync:function(name){return this.development?this._super(name):this._isCached(name)?this._loadFromCache(name):void 0},_load:function(name){if(this.development)return this._super(name);return this._isCached(name)?$.when(this._loadFromCache(name)):$.Deferred().reject().promise()}},a5.DesignPack.extend("a5.GitDesignPack"),a5.InteractionNextTimer={init:function(interaction){interaction.options.automaticNextIsTimer()&&(interaction.bind("show",this.startTimer,this),interaction.bind("hide",this.stopTimer,this),this.time=1e3*parseInt(interaction.options.getAutomaticNext(),10))},timeIsUp:function(){a5.mainBuilder.goNext()},startTimer:function(){this.usedTime=0,this.state="ticking",a5.tasks.push(new a5.InteractionNextTimerTask(this),"automaticNext")},stopTimer:function(){this.state="vanished"}},Obj.extend("a5.InteractionNextTimer"),a5.InteractionNextTimerTask={init:function(manager){this.manager=manager,this.bind("start",function(){this.deltaStartTime=(new Date).getTime()},this)},run:function(){var now=(new Date).getTime();return this.manager.usedTime+=now-this.deltaStartTime,this.deltaStartTime=now,this.manager.usedTime>this.manager.time?(this.manager.timeIsUp(),!0):"vanished"==this.manager.state||void 0}},a5.Task.extend("a5.InteractionNextTimerTask"),a5.Interaction={init:function(parameters,defaults){this._super(parameters,$.extend({url:null,originalIndex:null,index:null,locked:!1,preview:"",helpText:"",resources:[],feedbackText:{},_languages:{},source:"",group:"",visible:!1},defaults)),this.activityTimer=new a5.utils.Timer,this.sessionDuration=0,this.aggregatedDuration=0,this.exporter=new a5.service.InteractionExporter(this),this.activityMetadata=a5.mainBuilder.metadata.getScreenMetadata(this.url,this.originalIndex),this.activityOptions=new a5.models.options.Options,this.options=new a5.models.options.Options([a5.mainBuilder.LOInfo.loOptions,this.activityOptions,a5.mainBuilder.LOInfo.assessmentOptions,a5.mainBuilder.platformOptions]),this._cache("getScores",new a5.Score),this.initItems(),this.timesChecked=0,this.checkAttempts=0,this.manualCheckAttempts=0,this.skippedByAdaptive=!1,this.itemBanks=[],this.contentWrap=$("#content_wrap").clone().empty().attr({class:"content-wrap",id:""}),$("#content_wrap").before(this.contentWrap),this.view={$:_.bind(this.$,this),$node:this.contentWrap},this.rubricWrap=$("#rubricWrap").clone().empty().attr({class:"rubricWrap",id:""}),$("#rubricWrap").before(this.rubricWrap),this.liveCycle="empty",this.hide(),this.bind("show:deferred",function(){a5.hooks.interactionShowed.call(this),a5.callbacks.interaction.trigger("showed",this)},this),this.bind("show:deferred",function(){if(this.options.flashfirstanswerIsOn()){var duration=parseInt(this.options.getFlashfirstanswer(),10)||a5.dp.config.flashfirstanswerDefaultDuration,answers=this.getFirstAnswer();this.showFlashFirstAnswer(duration,answers)}},this),this.bind("hide",function(){a5.service.media.pauseAll()},this),this.bind("show:deferred",_.bind(this.setMediaNoScroll,this)),$(window).bind("resize scroll",_.bind(this.setMediaNoScroll,this)),this.contentWrap.on("scroll",_.bind(this.setMediaNoScroll,this)),this.bind("show:deferred",_.bind(this.setMediaMode,this)),this.bind("show:deferred",_.bind(function(){this.annotationsToolbar?(this.annotationsToolbar.setModel(this),this.annotationsToolbar.render(),this.annotationsToolbar.node.show(),this.annotationsToolbar.enableAll(),this._annotationsToolbarState&&this.annotationsToolbar.restore(this._annotationsToolbarState)):this.detachAnnotations(),this.teacherAnnotationsToolbar?(this.teacherAnnotationsToolbar.setModel(this),this.teacherAnnotationsToolbar.render(),this.teacherAnnotationsToolbar.node.show(),"_teacherAnnotationsToolbarState"in this&&this.teacherAnnotationsToolbar.restore(this._teacherAnnotationsToolbarState)):this.detachTeacherAnnotations()},this)),this.bind("hide",_.bind(function(){this.annotationsToolbar&&(this._annotationsToolbarState=this.annotationsToolbar.store()),this.teacherAnnotationsToolbar&&(this._teacherAnnotationsToolbarState=this.teacherAnnotationsToolbar.store())},this)),this.bind("hide",function(){"Identify:Select:Catch"!==this.identifier&&this.activityTimer.isRunning()&&(this.activityTimer.stop(),this.updateActivityDuration())},this),this.bind("show",function(){"Identify:Select:Catch"!==this.identifier&&"input"===this.getStatus()&&this.activityTimer.stamp()},this)},$:function(selector){return this.contentWrap.find(selector)},showFlashFirstAnswer:function(duration,answers){this.$firstanswer_dialog&&(this.$firstanswer_dialog.dialog("close"),delete this.$firstanswer_dialog),_.isArray(answers)||(answers=[answers]);var model={answers:answers,dialogClass:"dialog-flash-first-answer"},callbacks={close:_.bind(function(){delete this.$firstanswer_dialog},this)};this.$firstanswer_dialog=a5.view.dialog.display("a5.view.dialog.FlashFirstAnswersOverlay",model,callbacks),setTimeout(_.bind(function(){this.$firstanswer_dialog.dialog("close")},this),duration)},showHelpText:function(){this.$help_dialog&&(this.$help_dialog.dialog("close"),delete this.$help_dialog);var model={label:this.helpText,dialogClass:"dialog-hint"},callbacks={close:_.bind(function(){delete this.$help_dialog},this)};this.$help_dialog=a5.view.dialog.display("a5.view.dialog.HelpText",model,callbacks,null,!0,a5.dp.config.appendHelpTextTo)},insertSpecialCharacterDialog:function(){function escape(input){return input.replace("&","&")}var characterSets=this.options.getSpecialcharactersStudent().map(function(name){return{name:name,letters:_.map(CATspecialChars[name],escape)}}),$dialog=a5.view.dialog.display("a5.view.dialog.SpecialCharacters",{dialogClass:"dialog-special-characters",characterSets:characterSets},{cancel:function(){var $input=a5.specialCharInserter.getInput();$input&&$input.focus()}});$dialog.on("click","a[data-char]",function(evt){evt.preventDefault();var data_char=$(evt.target).attr("data-char"),$input=a5.specialCharInserter.getInput();$dialog.dialog("close"),$input&&($input.closest(".input-text.characters-in-gap,.tehs_view.characters-in-gap").length&&$input.data("skipMaskFocus",!0),$input.focus(),$input.closest(".input-text.characters-in-gap,.tehs_view.characters-in-gap").length&&$input.data("skipMaskFocus",null),a5.specialCharInserter.insert(data_char),$input.trigger("specialchar:inserted"))})},insertExportDialog:function(){this.exporter.openDialog()},setLiveCycle:function(liveCycle){_.contains(["empty","loading","loaded"],liveCycle)||logger.error("invalid value "+liveCycle+" for liveCycle"),this.liveCycle=liveCycle},isLiveCycle:function(liveCycle){return this.liveCycle===liveCycle},isEndResultScreen:function(){return!(this.options.endResultScreenIsFalse()&&this.options.endResultAlwaysIsOff()||this.index!=_.last(a5.mainBuilder.intList).index)},isIntroScreen:function(){return-1==this.index},isLastInteraction:function(withEndResult){return a5.mainBuilder.numberOfInteractions(withEndResult)===this.index+1},isSolvable:function(){return this.getMaximumScore().then(function(maximumScore){return maximumScore>0}.bind(this))},isManuallyMarked:function(){return this.options.manualMarkingIsOn()},reload:function(config){return config=config||{},a5.eventBus.trigger("interaction:reset",this),this.trigger("reset",this),config.skipReset||this.reset(),this.afterReset=!0,this.forceSkipRestore=!!config.skipRestore,config.skipRestore&&(this.checkAttempts=0,this.manualCheckAttempts=0),this.render().then(function(){a5.mainBuilder.updateControls(),a5.mainBuilder.layout.checkSize()})},reset:function(){this.clear(),this.reset_enumerations(),this.initItems(),this.status="input",this.firstCall=!1,this.liveCycle="empty",this.interactionDone=!1,this.buildDone=!1,this.skipNextCharacters=0,this.hasMediaToExpand=!1,this.answersChecked=!1,this.itemBanks&&(this.itemBanks=[]),this.referenceToolbar&&this.referenceToolbar.reset(),this.annotationsToolbar&&this.annotationsToolbar.reset(),this.annotationsCanvas&&this.annotationsCanvas.reset(),this.notes=this.notes||new a5.models.NotesModel,this.annotations=this.annotations||new a5.annotations.Canvas({readOnly:this.options.annotationToolsIsOnly_for_teachers()&&"teacher"!==a5.service.lms.API.getUserRole().toLowerCase()}),a5.service.media.pause(this.contentWrap.add(this.rubricWrap)),window.CKEDITOR&&_(CKEDITOR.instances).each(function(cke,id){this.$("#cke_"+id).length&&cke.destroy()},this),this.hasReadyListener=!1,this.revealIsHiding=!1,this.__wereRevealedAllElements=!1,this.__wasRevealedOneElement=!1,this.__showingSolutionHint=!1},getID:function(){return this._interactionId||(this._interactionId=a5.service.lms.API.getInteractionIdFor(this.url))},setStatus:function(status){status!==this.status&&(this.status=status,a5.hooks.interactionStatusChanged.call(this),this.trigger("update-status-to-"+status)),this.$(".interaction").removeClass("status-answers status-input status-corrected").addClass("status-"+this.status)},setLanguage:function(lang,quiet){this.translationLanguage=lang,this.trigger("language:change",lang),quiet||a5.mainBuilder.setLanguageToAllInteractions(lang,this)},nextLanguage:function(lang){var languages=this.getRegisteredLanguages(),current=_.indexOf(languages,this.getLanguage()),next=languages[(current+1)%languages.length];this.setLanguage(next)},registerLanguage:function(lang){if(_.contains(lang,":")){var syntax=lang.split(":");return this._languages[syntax[1]]=syntax[0],syntax[1]}return this._language[lang]="",lang},getRegisteredLanguages:function(){return _.keys(this._languages)},getLanguage:function(){return this.translationLanguage||this.options.getTranslationBlock()},getLanguageLabel:function(lang){return this._languages[lang]},getStatus:function(){return this.status},getElapsedTime:function(){return this.activityTimer.getTime()},updateActivityDuration:function(){this.activityDuration=this.getElapsedTime(),this.sessionDuration=this.activityDuration,this.aggregatedDuration=this.aggregatedDuration||0,this.aggregatedDuration+=this.sessionDuration},hide:function(dontTriggerEvents){this.visible=!1,this.disableVisibility(),dontTriggerEvents||this.trigger("hide")},show:function(){this.visible=!0,this.visited=!0,this.isLiveCycle("loaded")&&(this.referenceToolbar&&!this.toolbarZone.length&&this.referenceToolbar.render(),this.enableVisibility(),this.annotationsCanvas&&this.annotationsCanvas.render(),this.trigger("show"),this.onInteractionShowedListeners.callEach({}),setTimeout(function(){a5.eventBus.trigger("interaction:show",this)}.bind(this),200))},getCorrectResponse:function(id){var cr=this.viewData.getVariable(id);return cr||{values:[]}},getAllResponseDeclaration:function(){return this.viewData.variables},_render:function(template,deferred){this.contentWrap.empty(),this.contentWrap.attr("id","content_wrap_"+this.index),this.rubricWrap.empty(),this.rubricWrap.attr("id","rubricWrap"+this.index);var tDOM=template.clone(),nodeMediaList=tDOM.find("#media"),nodeContentList=tDOM.find("#content"),nodeRubricList=tDOM.find("#rubric"),nodeResourcesList=tDOM.find("#resources"),nodeControlsList=tDOM.find("#controls"),nodeToolbarList=tDOM.find("#toolbar");_(nodeMediaList).each(function(e,index){var nodeMedia=$(e);nodeMedia.attr("id","media-"+this.index+"-"+index),nodeMedia.attr("data-zone-type","media"),nodeMedia.addClass("is-media-zone")},this),_(nodeContentList).each(function(e){var nodeContent=$(e);nodeContent.attr("id","content-"+this.index),nodeContent.attr("data-zone-type","content"),nodeContent.addClass("is-content-zone")},this),_(nodeRubricList).each(function(e){var nodeRubric=$(e);nodeRubric.attr("id","rubric-"+this.index),nodeRubric.attr("data-zone-type","rubric"),nodeRubric.addClass("is-rubric-zone")},this),_(nodeResourcesList).each(function(e){var nodeResources=$(e);nodeResources.attr("id","resources-"+this.index),nodeResources.attr("data-zone-type","resources"),nodeResources.addClass("is-resources-zone")},this),_(nodeControlsList).each(function(e){var nodeControls=$(e);nodeControls.attr("id","controls-"+this.index),nodeControls.attr("data-zone-type","controls")},this),_(nodeToolbarList).each(function(e){var nodeToolbar=$(e);nodeToolbar.attr("id","toolbar-"+this.index),nodeToolbar.attr("data-zone-type","toolbar")},this),this.contentWrap.append(tDOM.contents()),"Present:Present:Ebook"!==this.identifier&&"Present:Present:AudioBook"!==this.identifier||($("body").addClass("isEbook"),this.contentWrap.appendTo("#content_wrap")),this.contentZone=$(this.contentWrap.find("*[data-zone-type='content']")),this.rubricZone=$(this.contentWrap.find("*[data-zone-type='rubric']")),this.mediaZone=$(this.contentWrap.find("*[data-zone-type='media']")),this.resourcesZone=$(this.contentWrap.find("*[data-zone-type='resources']")),this.controlsZone=$(this.contentWrap.find("*[data-zone-type='controls']")),this.toolbarZone=$(this.contentWrap.find("*[data-zone-type='toolbar']")),this.rubricWrap.append(this.rubricZone),this.hasGlobalEnumerator()&&this.enumerator.start(this.getGlobalEnumerationOffset()),this.build_interaction(),this.hasGlobalEnumerator()&&this.enumerator.finish(),this._cache("getScores",this.getScoresAsync).then(function(){this.setStatus("input"),a5.dp.config.avatarSupport&&(this.avatar=new a5.service.Avatar(this)),a5.hooks.interactionLoaded.call(this),a5.callbacks.interaction.trigger("loaded",this);var forcedStatus;if(a5.dp.config.forceCorrectedAfterSubmitAttempts){a5.mainBuilder.options(!0).finishSubmitIsOn()||!a5.mainBuilder.canSubmit||a5.mainBuilder.hasMoreSubmitAttempts()||(forcedStatus="corrected")}this.afterReset&&(forcedStatus="input"),this.getSkipRestore()?(this._initQuestionPool(),this.setLiveCycle("loaded"),deferred.resolve(),this.visible&&this.show()):this.restore(forcedStatus).done(function(){this._initQuestionPool(this.questionPool),this.setLiveCycle("loaded"),deferred.resolve(),this.visible&&this.show()}.bind(this))}.bind(this))},getSkipRestore:function(){return this.options.restoreLOStateIsOff()||this.forceSkipRestore},isVisibleAndLoaded:function(){return this.visible&&this.isLiveCycle("loaded")},disableVisibility:function(){this.contentWrap.addClass("activity--hidden"),this.rubricWrap.addClass("rubricWrap--hidden")},enableVisibility:function(){this.contentWrap.removeClass("activity--hidden"),this.rubricWrap.removeClass("rubricWrap--hidden")},addToFlow:function(){this.contentWrap.removeClass("out-of-flow")},removeFromFlow:function(){this.contentWrap.addClass("out-of-flow")},runOutOfFlow:function(fn){this.visible&&this.isLiveCycle("loaded")||(this.removeFromFlow(),this.enableVisibility()),$.when(fn()).then(function(){this.visible||this.disableVisibility(),this.addToFlow()}.bind(this))},render:function(){this.addContentWrapSubstyle(),this.template=$(this.xml).find("assessmentItem").attr("template")||"default",this.viewData=new a5.ViewData,this.viewData.setXML(this.xml);var deferred=$.Deferred();return a5.service.templates.loadLayoutTemplate(this.template,function(template){this.runOutOfFlow(function(){return this._render(template,deferred),deferred}.bind(this))}.bind(this),window.LOInfo.template),deferred.then(function(){return this._cache("getScores",this.getScoresAsync)}.bind(this))},parseActivityOptions:function(){var xml=$(this.xml).find("#options").text();this.activityOptions.readAll(xml),this.debugOptions&&this.activityOptions.readAll(this.debugOptions)},dataLoaded:function(){return this.render()},attachAudios:function(){this.options.soundEffectsIsSound_effects()&&new a5.AudioEvents(a5.mainBuilder.layout.packageURL,this.cssIdentifier(),this)},preloadAudio:function(audio){this.visible?audio.load():this.bind("show",function(){audio.load()},this,{once:!0})},getScores:function(){return this._cache("getScores")},getScoresAsync:function(){return this.items.getScores().then(function(score){return this.hasShownSolutionHint()&&!score.revealed&&score.incRevealed(),score}.bind(this))},getMaximumScore:function(){return this.items.getMaximumScore().then(function(maximumScore){return this.options.scoreValuesIs1_point_question()?maximumScore.question:maximumScore.action}.bind(this))},getTotalFilled:function(){return this.items.getTotalFilled()},getResults:function(scoreFetcher){var scores=this.getScores();return scoreFetcher&&(scores=scoreFetcher(this)),new a5.Results(scores,this.options)},getResultsAsync:function(scoreFetcher){var promise;return promise=scoreFetcher?scoreFetcher(this):this.getScoresAsync(),$.when(promise).then(function(scores){return new a5.Results(scores,this.options)}.bind(this))},applyValidationMessage:function(score){var preprocessor=new a5.preprocessor.Preprocessor,txt=a5.utils.getRandomSubstring(this.options.getValidationmessage());txt=preprocessor.replaceTag(txt,"vm-incorrectanswers",function(){return score.scores.totalBlocks-score.scores.correctBlocks}),txt=preprocessor.replaceTag(txt,"vm-image",function(id){return'<img src="'+a5_makeMediaURL(id)+'"/>'});var $message=$('<div class="validation-message"></div>');$message.html(txt),this.contentWrap.append($message)},removeValidationMessage:function(){this.contentWrap.find(".validation-message").remove()},setAnswerInput:function(){return this.notifyBeginAction("setAnswerInput"),this.items.setAnswerInput().always(function(){this.notifyEndAction("setAnswerInput")}.bind(this))},setAnswer:function(){return this.notifyBeginAction("setAnswer"),this.items.setAnswer().then(function(){return this._cache("getScores",this.getScoresAsync)}.bind(this)).then(function(){return this.reapplySolutionHint()}.bind(this)).then(function(){return this.getResultsAsync()}.bind(this)).then(function(results){if(this.interactionDone=!0,this.onSetAnswerListeners.callEach({}),!this.options.feedbackSoundEffectsIsOff()){var commands=this.options.getFeedbackSoundEffects().split("|");_.each(commands,function(command){var parts=command.split(","),test=parts[0].split("-");if(results.percent()>=parseFloat(test[0])&&results.percent()<=parseFloat(test[1])){var audio=a5.service.media.audio.create(parts[1],{preferHtml5:!/android|ipad|iphone|ipod/.test(navigator.userAgent.toLowerCase())});a5.service.media.audio.pauseAll(),audio.play()}})}return this.options.validationmessageIsFalse()||results.isPercent100()||this.applyValidationMessage(results),this.lastScore=results,this.setStatus("corrected"),this.checkAttempts++,this.trigger("attemptsChanged",{checkAttempts:this.checkAttempts}),this.setupAutomaticTryAgain()}.bind(this)).then(function(){this.notifyStateChange("feedback")}.bind(this)).always(function(){this.notifyEndAction("setAnswer")}.bind(this))},getFirstAnswer:function(n){return this.items.getFirstAnswer(n)},showAnswer:function(){return this.notifyBeginAction("showAnswer"),this.items.showAnswer().then(function(){return this._cache("getScores",this.getScoresAsync)}.bind(this)).then(function(){return this.setStatus("answers"),this.setupAutomaticTryAgain()}.bind(this)).then(function(){this.notifyStateChange("answers")}.bind(this)).always(function(){this.notifyEndAction("showAnswer")}.bind(this))},showNextAnswer:function(){return this.notifyBeginAction("showNextAnswer"),this.items.showNextAnswer().then(function(){this.$(".interaction").addClass("status-showing-answers")}.bind(this)).then(function(){this.notifyShowNextAnswer()}.bind(this)).always(function(){this.notifyEndAction("showNextAnswer")}.bind(this))},canShowSolutionHint:function(){return this.items.canShowSolutionHint()},hasShownSolutionHint:function(){return!!this.__showingSolutionHint},clearSolutionHint:function(){return delete this.__showingSolutionHint,this.items.clearSolutionHint()},reapplySolutionHint:function(){if(this.hasShownSolutionHint())return $.when().then(function(){return this.clearSolutionHint()}.bind(this)).then(function(){return this.showSolutionHint()}.bind(this))},showSolutionHint:function(){return this.notifyBeginAction("showSolutionHint"),this.canShowSolutionHint().then(function(canShowSolutionHint){return canShowSolutionHint&&!this.hasShownSolutionHint()}.bind(this)).then(function(hasToShowSolutionHint){if(hasToShowSolutionHint)return $.when(!0,this.items.showSolutionHint())}.bind(this)).then(function(hasShownSolutionHint){hasShownSolutionHint&&(this.__showingSolutionHint=!0,this.$(".interaction").addClass("status-showing-solution-hint"))}.bind(this)).then(function(){this.notifyShowSolutionHint()}.bind(this)).always(function(){this.notifyEndAction("showSolutionHint")}.bind(this))},showAllAnswer:function(){return this.notifyBeginAction("showAllAnswer"),this.items.showAllAnswer().then(function(){this.$(".interaction").addClass("status-showing-answers"),this.setStatus("answers")}.bind(this)).then(function(){this.notifyShowAllAnswer()}.bind(this)).always(function(){this.notifyEndAction("showAllAnswer")}.bind(this))},isShowingAnswers:function(){return this.$(".interaction").hasClass("status-showing-answers")},showAnswerBeforeInteraction:function(){return this.checkAttempts=a5.mainBuilder.getCheckMaxAttemptsNumber(),this.unbindAutomaticTryAgain(),a5.dp.config.resetCheckAttemptsAfterSkipScreen&&(this.manualCheckAttempts=0),this.showAnswer().then(function(){a5.eventBus.trigger("interaction:see_answer_before_interaction")})},tryAgain:function(){return this.unbindAutomaticTryAgain(),this.options.tryAgainIsClear()?(this.notifyBeginAction("tryAgain"),this.reload(),this.notifyEndAction("tryAgain"),$.Deferred().resolve().promise()):(this.notifyBeginAction("tryAgain"),this.items.tryAgain().then(function(){return this.reapplySolutionHint()}.bind(this)).then(function(){this.setStatus("input"),this.removeValidationMessage(),this.interactionDone=!1,this.$(".interaction").removeClass("status-showing-answers"),this.onInteractionReadyListeners.callEach({tryAgain:!0})}.bind(this)).then(function(){this.notifyStateChange("input")}.bind(this)).always(function(){this.notifyEndAction("tryAgain")}.bind(this)))},setupAutomaticTryAgain:function(){return this.getResultsAsync().then(function(results){this.options.tryAgainBehaviourIsAutomatic()&&this.hasMoreCheckAttempts()&&!results.isPercent100(!0)&&(this.contentWrap.get(0).addEventListener("mousedown",this.automaticTryAgain,!0),this.contentWrap.get(0).addEventListener("touchstart",this.automaticTryAgain,!0))}.bind(this))},automaticTryAgain:function(event){"mousedown"===event.type&&0!==event.button||a5.mainBuilder.tryAgain()},unbindAutomaticTryAgain:function(){this.contentWrap.get(0).removeEventListener("mousedown",this.automaticTryAgain,!0),this.contentWrap.get(0).removeEventListener("touchstart",this.automaticTryAgain,!0)},signal:function(){this.items.signalErrors(!0),this.signalErrorActive=!0},hideSignal:function(){this.items.hideSignalErrors(!0),this.signalErrorActive=!1},revealHiddenElements:function(){
var elements=this._getHiddenElements();if(this.options.revealObjectIsAll())elements.removeClass("opt-021-hidden"),elements.addClass("opt-021-revealed"),this.__wasRevealedOneElement=!0,this.__wereRevealedAllElements=!0;else if(elements.length>0){var $next=this._getNextHiddenElements(elements);$next.removeClass("opt-021-hidden"),$next.addClass("opt-021-revealed"),a5.utils.scrollIntoElementIfNeeded($next,{behavior:"smooth",block:"start",inline:"nearest"}),this.__wasRevealedOneElement=!0,this.__wereRevealedAllElements=this.__wereRevealedAllElements||elements.length===$next.length,elements.length===$next.length&&this.options.revealObjectIsProgressiveplushide()&&(this.revealIsHiding=!0)}},hideRevealedElements:function(){var elements=this._getRevealedElements();if(this.options.revealObjectIsAll())elements.removeClass("opt-021-revealed"),elements.addClass("opt-021-hidden"),this.revealIsHiding=!1;else{var $next=this._getNextRevealedElements(elements);$next.removeClass("opt-021-revealed"),$next.addClass("opt-021-hidden"),elements.length>$next.length&&a5.utils.scrollIntoElementIfNeeded(elements.eq(-$next.length-1),{behavior:"smooth",block:"start",inline:"nearest"}),elements.length==$next.length&&(this.revealIsHiding=!1)}},hasRevealedElements:function(){return this.contentWrap.find(".opt-021-revealed").length>0},hasHiddenElements:function(){return this.contentWrap.find(".opt-021-hidden").length>0},wasRevealedOneElement:function(){return this.__wasRevealedOneElement},wereRevealedAllElements:function(){return this.__wereRevealedAllElements},_getRevealedElements:function(){var elements=this.contentWrap.find(".opt-021-revealed").toArray();return elements=_.sortBy(elements,function(elem){return parseInt(elem.getAttribute("data-opt-021-prio"),10)||1/0}),$(elements)},_getHiddenElements:function(){var elements=this.contentWrap.find(".opt-021-hidden").toArray();return elements=_.sortBy(elements,function(elem){return parseInt(elem.getAttribute("data-opt-021-prio"),10)||1/0}),$(elements)},_getNextHiddenElements:function(elements){var ref=elements.first();return _.isUndefined(ref.attr("data-opt-021-prio"))?ref:elements.filter(function(index,elem){return elem.getAttribute("data-opt-021-prio")===ref.attr("data-opt-021-prio")})},_getNextRevealedElements:function(elements){var ref=elements.last();return _.isUndefined(ref.attr("data-opt-021-prio"))?ref:elements.filter(function(index,elem){return elem.getAttribute("data-opt-021-prio")===ref.attr("data-opt-021-prio")})},cssIdentifier:function(){if(void 0===this.identifier)return logger.warn("interaction has no identifier: "+this.url),"invalid-identifier";var parts=this.identifier.split(":");return 3!=parts.length?(logger.warn("interaction has invalid identifier: "+this.identifier+" "+this.url),"invalid-identifier"):parts[0].substring(0,1).toLowerCase()+parts[1].substring(0,1).toLowerCase()+"-"+parts[2].trim().toLowerCase().replace(/[^A-Za-z0-9]+/g," ").trim().replace(/ /g,"-")},init_enumerations:function(){this.enumBlock=new a5.models.options.Enumeration(this.options.getEnumeration()),this.enumAnswers=new a5.models.options.Enumeration(this.options.getEnumerationAnswers(),'<span class="enum-answers">|</span>'),a5.mainBuilder.options(!0).continuousEnumerationIsOn()?"false"!==this.options.getEnumerationAnswers()?(this.enumAnswers=new a5.models.options.Enumeration(this.enumAnswers.value,'<span class="enum-answers continuous-enumeration">|</span>'),this.enumerator=this.enumAnswers,this.enumBlock.start()):"false"!==this.options.getEnumeration()&&(this.enumBlock=new a5.models.options.Enumeration(this.enumBlock.value,'<span class="enum">|</span>'),this.enumerator=this.enumBlock,this.enumAnswers.start()):(this.enumBlock.start(),this.enumAnswers.start())},reset_enumerations:function(){a5.mainBuilder.options(!0).continuousEnumerationIsOn()||(this.enumBlock&&this.enumBlock.ready().then(function(){this.enumBlock.reset()}.bind(this)),this.enumAnswers&&this.enumAnswers.ready().then(function(){this.enumAnswers.reset()}.bind(this)))},hasGlobalEnumerator:function(){return!!this.enumerator},getGlobalEnumerationOffset:function(){for(var offset=0,prev=this.index;prev>0;){var interaction=a5.mainBuilder.intList[prev-1];if(interaction&&interaction.hasGlobalEnumerator())break;prev-=1}return prev>0&&(offset=a5.mainBuilder.intList[prev-1].enumerator.getCounter()),offset},enumerationReady:function(){return $.when(this.enumAnswers.ready(),this.enumBlock.ready())},build_interaction:function(){var self=this;this.taskNum=window.a5.mainBuilder.curTask,this.karaoke=null,this.onInteractionReadyListeners=new Listeners(this),this.onInteractionShowedListeners=new Listeners(this),this.onInteractionRestoreListeners=new Listeners(this),this.onSetAnswerListeners=new Listeners(this);var interactionDomRoot=$('<div class="interaction"></div>');interactionDomRoot.addClass(this.cssIdentifier()),interactionDomRoot.addClass("package"),interactionDomRoot.addClass("package-editable"),interactionDomRoot.addClass("editor"),interactionDomRoot.addClass("ic-speaking-and-recording");var kidnappedInteractionDomRoot=interactionDomRoot;if(_.contains(["Identify:Select:Linking multiple lines","Identify:Select:Linking lines","Identify:Mark:Marking","Identify:Mark:Wordsearch"],this.identifier)){this.toolbar=new a5.model.InteractionToolbar;var toolbarView=new a5.view.InteractionToolbar(this.toolbar);kidnappedInteractionDomRoot.append(toolbarView.render()),kidnappedInteractionDomRoot.closest(".interaction").addClass("toolbar")}if(this.contentZone.append(interactionDomRoot),this.prefill=new a5.models.options.Prefill(this),this.rubricZone.html(""),$(this.xml).find("#rubric").length>0){var rubric=$("<div></div>");self.buildModel(rubric,$(this.xml).find("#rubric")),this.rubricZone.html(rubric.find("#rubric").contents())}new a5.views.ResourcesZone(this).render(),this.options.hasResourceBanks()&&"Order:Match:Text gap"!==this.identifier&&this.attachResourcesPanel(),$(this.xml).find("#headerAudio").length>0&&0===$("#activity").find(".headerAudio_"+this.index).length&&self.buildModel($("#activity"),$(this.xml).find("#headerAudio")),$(this.xml).find("#headerVideo").length>0&&0===$("#activity").find(".headerVideo_"+this.index).length&&self.buildModel($("#activity"),$(this.xml).find("#headerVideo")),"Exam"!==LOInfo.mode&&"Trainer"!==LOInfo.mode||self.isEndResultScreen()&&self.bind("show:deferred",function(){self.rubricZone.hide()});var content=$(this.xml).find("itemBody").find("#content");this.buildModel(kidnappedInteractionDomRoot,content),this.attachTeamScoring(kidnappedInteractionDomRoot),this.attachMedia(),this.attachControls(),this.attachReferenceToolbar(),this.attachModelText(),this.attachCustomText(),this.attachAnnotations(),this.attachWiki(),this.attachImageDivClass(),this.attachNoLabelClass(),this.attachTitle(this.title),this.attachAudios(),this.attachMetadataClasses(),this.referenceToolbar&&this.toolbarZone.length&&this.referenceToolbar.render(),this.trigger("rendered"),this.onInteractionReadyListeners.callEach({}),this.buildDone=!0,a5.mainBuilder.setProgress(),$(".option056").mouseenter(function(){$(this).find(".opt056-audio").hide(),$(this).find(".opt056-audio-over").show()}),$(".option056").mouseleave(function(){$(this).find(".opt056-audio").show(),$(this).find(".opt056-audio-over").hide()}),new a5.InteractionNextTimer(this)},setMediaNoScroll:function(){var scrollTop,scrollLeft;if(this.options.stayinviewIsTrue()&&this.visible)if(a5.dp.config.mediaAreaFixedInView){var stayInViewTop=parseInt(a5.utils.getCSSAttributeFromCSS("#"+this.mediaZone.attr("id"),"is-media-zone stay-in-view","top"),10)||0;scrollTop=$(window).scrollTop(),this.offsetMediaNode=this.offsetMediaNode||this.mediaZone.offset(),this.offsetMediaNode&&(scrollTop<this.offsetMediaNode.top-stayInViewTop?(this.mediaZone.removeClass("stay-in-view"),this.mediaZone.css("top","")):this.mediaZone.addClass("stay-in-view"))}else this.contentZone.length&&(scrollTop=this.contentWrap.scrollTop()||$(window).scrollTop(),scrollLeft=this.contentWrap.scrollLeft()||$(window).scrollLeft(),_.each(this.mediaZone,function(mediaZone){var $mediaZone=$(mediaZone),top=$mediaZone.css("top");$mediaZone.css("top",scrollTop),$mediaZone.offset().top+$mediaZone.outerHeight()>this.contentZone.offset().top+this.contentZone.outerHeight()&&$mediaZone.css("top",top);var left=$mediaZone.css("left");$mediaZone.css("left",scrollLeft),$mediaZone.offset().left+$mediaZone.outerWidth()>this.contentZone.offset().left+this.contentZone.outerWidth()&&$mediaZone.css("left",left)},this))},setMediaMode:function(){a5.dp.config.responsiveSupplements?this.setMediaResponsive():this.setMediaBounds(),clearInterval(this.mediaModeInterval)},setMediaResponsive:function(){var $parent=this.mediaZone.hasClass("ui-tabs")?this.mediaZone.children(".tab"):this.mediaZone;_.each($parent.children(),function(node){var $target=$(node);$target.hasClass("image-as-trigger")?$target=$target.add($target.children()):$target.hasClass("transcript-wrap")?$target=$target.add($target.find("> .v_a_media,.the_video,[poster]")):$target.hasClass("video")&&($target=$target.add($target.find(".the_video,[poster]"))),$target.css("position","").css("z-index","").css("left","").css("top","").css("width","").css("height","")})},setMediaBounds:function(){this.mediaZone.hasClass("ui-tabs")?_.each(this.mediaZone.children(".tab"),function(tab){var maxHeight=0,wasDisplay=$(tab).css("display");$(tab).css({display:"",visibility:"hidden"}),_.each($(tab).children(),function(element){element=$(element);var cssTop=parseInt(element.css("top"),10);isNaN(cssTop)&&(cssTop=0);var height=element.outerHeight()+cssTop;!isNaN(height)&&height>maxHeight&&(maxHeight=height)}),maxHeight<=0&&(maxHeight="auto"),$(tab).css("height",maxHeight+"px"),$(tab).css({display:"none"===wasDisplay?"none":"",visibility:""})},this):this.mediaZone.applyBoundingBox()},attachMedia:function(){this.isMediaRendering=!0;var mediaCounter=0;_.each($(this.xml).find("itemBody").children(),function(e){var targetMediaNode,node=$(e);node.is("#media")&&("tabbed"==node.attr("class")?(targetMediaNode=$("#media-"+this.index+"-"+mediaCounter),0==targetMediaNode.find("ul.tabnav").length&&targetMediaNode.append($("<ul class='tabnav'></ul>")),_.each($(node).find("div.tab"),function(tab,i){$(tab).attr("id","media-"+mediaCounter+"-tab-"+i);var $navElement="<li><a href='#"+$(tab).attr("id")+"'>"+$(tab).attr("label")+"</a></li>";targetMediaNode.find("ul.tabnav").append($navElement),this.buildModel(targetMediaNode,$(tab))},this),targetMediaNode.tabs({create:function(e,ui){this.trigger("interaction:supplements:tabs_create",ui)}.bind(this),activate:function(e,tabs){this.trigger("interaction:supplements:tabs_change",tabs.newTab)}.bind(this)})):(targetMediaNode=$("#media-"+this.index+"-"+mediaCounter),node.children().each(function(index,e){this.buildModel(targetMediaNode,$(e))}.bind(this)),mediaCounter++))},this),this.setMediaMode(),this.mediaZoneView=new a5.views.MediaZone(this),this.mediaZoneView.render(),this.hasMediaToExpand&&(this.mediaModeInterval=setInterval(this.setMediaMode.bindTo(this),50)),this.isMediaRendering=!1},attachControls:function(){this.controlsZone.length>0&&(this.controls=new a5.view.controls.interaction.Bar({$el:this.controlsZone,interaction:this,lo:a5.mainBuilder}),this.controls.render())},attachReferenceToolbar:function(){if(this.toolbarZone.length>0?this.referenceToolbar=new a5.views.Toolbar({lo:a5.mainBuilder,interaction:this,$el:this.toolbarZone}):this.referenceToolbar=new a5.views.Toolbar({lo:a5.mainBuilder,interaction:this,$el:$("#reference_toolbar")}),"false"!=this.options.getPrintable()&&this.referenceToolbar.addButton(new a5.views.Toolbar.PrintButton),(a5.mainBuilder.options(!0).dictionaryIsTrue()||this.options.dictionaryIsTrue())&&this.referenceToolbar.addButton(new a5.views.Toolbar.DictionaryButton),this.options.notesareaIsTrue()){var notesButton=new a5.views.Toolbar.NotesButton(this.notes,this);notesButton.bind("notes:show",function(){this.referenceToolbar.trigger("notes:show")},this),notesButton.bind("notes:hide",function(){this.referenceToolbar.trigger("notes:hide")},this),this.referenceToolbar.addButton(notesButton)}this.options.interactivePhonemicChartIsTrue()&&this.referenceToolbar.addButton(new a5.views.Toolbar.SoundButton),this.getRegisteredLanguages().length>1&&this.referenceToolbar.addButton(new a5.views.Toolbar.LanguageSwitcher(this))},attachModelText:function(){var modelText=$(this.xml).find("itemBody").find("#attachments #model_text");if(0!==modelText.length){if(0===$("#model_text").length){var modelTextDomRoot=$('<div id="model_text"></div>');$("body").append(modelTextDomRoot)}if(0===$("#model_text_temp").length){var modelTextTempDomRoot=$('<div id="model_text_temp" style="display:none"></div>');$("body").append(modelTextTempDomRoot)}var modelTextView=new a5.views.interaction.ModelTextView(modelText,this);modelTextView.render(),this.onInteractionRestoreListeners.register(modelTextView.render.bindTo(modelTextView))}},hasAttachments:function(){return Boolean(this.attachments)},attachCustomText:function(){var customText=$(this.xml).find("itemBody").find("#attachments #custom");0!==customText.length&&(this.attachments=new a5.views.interaction.CustomTextView(customText,this),this.attachments.render())},attachAnnotations:function(){this.options.annotationToolsIsOnly_supplements()?(this.attachTabAnnotations(),this.bind("interaction:supplements:tabs_change",_.bind(function(newTab){var id=newTab.find("a.ui-tabs-anchor").first().attr("href").replace("#","");this.switchTabAnnotation(id),this.annotationsCanvas=this._currentAnnotations.annotationsCanvas},this)),this._currentAnnotations?(this.annotationsCanvas=this._currentAnnotations.annotationsCanvas,this.attachAnnotationsToolbar()):(this.attachAnnotationsCanvas(),this.attachAnnotationsToolbar())):this.options.annotationToolsIsOn()||this.options.annotationToolsIsOnly_for_teachers()&&"teacher"===a5.service.lms.API.getUserRole().toLowerCase()?(this.attachAnnotationsCanvas(),this.attachAnnotationsToolbar()):this.options.annotationToolsIsOnly_for_teachers()&&this.attachTeacherAnnotations()},attachAnnotationsToolbar:function(){a5.mainBuilder.annotationsToolbar||(a5.mainBuilder.annotationsToolbar=new a5.annotations.ToolbarView(this),$("#activity_controls").append(a5.mainBuilder.annotationsToolbar.render().hide())),this.annotationsToolbar=a5.mainBuilder.annotationsToolbar},attachAnnotationsCanvas:function(){var $node=this.contentWrap.find(".annotations");0===$node.length&&($node=$('<div class="annotations"></div>').appendTo(this.contentWrap)),this.annotationsCanvas=new a5.annotations.CanvasView(this.annotations,$node),this.annotationsCanvas.render(),this._currentAnnotations=this.annotationsCanvas},detachAnnotations:function(){a5.mainBuilder.annotationsToolbar&&a5.mainBuilder.annotationsToolbar.node.hide()},attachTabAnnotations:function(tabs_ui){if(this._tabAnnotationsCollection={},this._toolbarButtonState={},this.mediaZone.is(".ui-tabs")){_.each(this.mediaZone.find(".tab"),function(tab){var $node=$("<div class='annotations'/>");$(tab).prepend($node);var model=new a5.annotations.Canvas,view=new a5.annotations.CanvasView(model,$node);view.render(),this.bind("interaction:trigword:clicked",function(){view.clear()}),this._tabAnnotationsCollection[$(tab).attr("id")]={model:model,annotationsCanvas:view,tabNode:$(tab),button_state:[]}},this);var first_tab=this.mediaZone.find(".tab").first();this._currentAnnotations=this._tabAnnotationsCollection[first_tab.attr("id")]}},attachTeacherAnnotations:function(){this.attachAnnotationsCanvas();var composedAnnotations={children:[]};a5.service.lms.API.getTeacherAnnotations(this.getID(),function(annotations){composedAnnotations=_.reduce(annotations,function(composed,current){return Array.prototype.push.apply(composed.children,current.children),composed},composedAnnotations),this.annotationsCanvas.model.restore(composedAnnotations)}.bindTo(this)),this.attachTeacherAnnotationsToolbar()},attachTeacherAnnotationsToolbar:function(){a5.mainBuilder.teacherAnnotationsToolbar||(a5.mainBuilder.teacherAnnotationsToolbar=new a5.annotations.TeacherToolbarView(this),$("#activity_controls").append(a5.mainBuilder.teacherAnnotationsToolbar.render().hide())),this.teacherAnnotationsToolbar=a5.mainBuilder.teacherAnnotationsToolbar},detachTeacherAnnotations:function(){a5.mainBuilder.teacherAnnotationsToolbar&&a5.mainBuilder.teacherAnnotationsToolbar.node.hide()},switchTabAnnotation:function(tab_id){var tools_open=this.annotationsToolbar.toolsAreVisible();this._currentAnnotations.button_state=this.annotationsToolbar.store(),this._currentAnnotations=this._tabAnnotationsCollection[tab_id],this.annotationsToolbar.disableAll(),this.annotationsToolbar.setModel(this._currentAnnotations),this.annotationsToolbar.render(),this.annotationsToolbar.enableAll(),this.annotationsToolbar.restore(this._currentAnnotations.button_state),tools_open&&this.annotationsToolbar.maximizeTools()},attachWiki:function(){this.options.wikiToolIsOn()&&(this.wikiTool=new a5.views.WikiTool(this))},attachResourcesPanel:function(){this.resourcesPanel=new a5.components.Resources({interaction:this,maxAddBy:a5.dp.config.multipleResourceMaximum}),this.resourcesPanel.bind("change",function(){a5.service.lms.API.setDataDirty(),a5.service.lms.API.notify(this)},this),this.resourcesPanel.show()},buildModels:function(parent,nodes){_.each(nodes,function(child){this.buildModel(parent,$(child))},this)},buildModel:function(parent,node,forceBuild){void 0===forceBuild&&(forceBuild=!1);var builder=_.find(a5.model_builder.builders,function(builder){return builder.isResponsible(node,this,forceBuild)},this);builder?builder.build(this,parent,node,forceBuild):(logger.log("nothing defined for node",node),alert("nothing defined for node <"+node[0].tagName+">"))},buildModelExludeNode:function(parent,node,forceBuild){var self=this;$(node).contents().each(function(index,e){self.buildModel(parent,$(e),forceBuild)})},postBuildModel:function(parent){var self=this;_.each(a5.model_postBuilder.builders,function(e){e.isResponsible(parent,self)&&e.build(self,parent)})},attachTeamScoring:function(parent){if(this.options.teamscoringIsOn()){var teams=this.options.getTeamscoring().split("|"),moderator=new a5.model.Moderator(teams,this),moderatorView=new a5.view.Moderator(moderator);parent.prepend(moderatorView.render())}},setBlockClass:function(node,className){node.closest(".contentblock").addClass(className)},store:function(force){if(force||this.canStore())return this.items.store().then(function(data){data=data||{},data.status=this.status,data.checkAttempts=this.checkAttempts,data.manualCheckAttempts=this.manualCheckAttempts,data.solutionHint=this.hasShownSolutionHint(),this.questionPool&&data.items&&(data.questionPool=this.questionPool),this.itemBanks.length&&(data.itemBanks=this.itemBanks),this.annotationsCanvas&&!this.teacherAnnotationsToolbar&&(data.annotations=this.annotationsCanvas.model.store()),this._tabAnnotationsCollection&&(data.tabAnnotations=_.chain(this._tabAnnotationsCollection).values().pluck("model").invoke("store").value()),this.notes&&(data.notes=this.notes.store()),this.resourcesPanel&&(data.resources=this.resourcesPanel.store()),this.tc_code&&(data.tc_code=this.tc_code),this.visited&&(data.visited=!0),this.aggregatedDuration&&(data.duration=this.aggregatedDuration),a5.service.lms.API.setData(this.getID(),data),a5.service.lms.API.notify(this)}.bind(this)).then(function(){return $.when(a5.mainBuilder.getTotalFilled(),a5.mainBuilder.getMaximumScore()).then(function(filled,total){var progress;progress=0===total?1:_.min([1,filled/total]),a5.service.lms.API.setProgress(progress)}.bind(this))})},canStore:function(){return!this.options.saveIsButton_only()},clear:function(){a5.service.lms.API.setData(this.getID(),{}),a5.service.lms.API.notify(this)},restore:function(status){return a5.service.lms.API.getData(this.getID()).then(function(data){var promise;return data=data||{},data.status=status||data.status,data.checkAttempts&&data.checkAttempts!==this.checkAttempts&&(this.checkAttempts=data.checkAttempts,this.trigger("attemptsChanged",{checkAttempts:this.checkAttempts})),data.manualCheckAttempts&&(this.manualCheckAttempts=data.manualCheckAttempts),data.questionPool&&(this.questionPool=data.questionPool),data.tc_code&&(this.tc_code=data.tc_code),data.duration&&(this.aggregatedDuration=data.duration),data.visited&&(this.visited=!0),data.itemBanks&&(this.itemBanks=data.itemBanks),data.annotations&&this.annotationsCanvas.model.restore(data.annotations),data.tabAnnotations&&_.chain(this._tabAnnotationsCollection).values().each(function(tabAnnotation,index){tabAnnotation.model.restore(data.tabAnnotations[index]),tabAnnotation.annotationsCanvas.repaint()}),data.notes&&this.notes.restore(data.notes),data.resources&&this.resourcesPanel.restore(data.resources),data.items&&(promise=this.items.restore(data.items)),data.solutionHint&&(promise=$.when(promise).then(function(){return this.showSolutionHint()}.bind(this))),data.status&&(promise=$.when(promise).then(function(){if("input"===data.status){if(this.checkAttempts&&this.options.tryAgainIsFrozen())return this.items.setAnswer().then(function(){return this.items.tryAgain()}.bind(this))}else{if("corrected"===data.status)return $.when(!0,this.items.setAnswer());if("answers"===data.status)return $.when(!0,this.items.showAnswer())}}.bind(this)).then(function(hasToSetupAutomaticTryAgain){return $.when(hasToSetupAutomaticTryAgain,this._cache("getScores",this.getScoresAsync))}.bind(this)).then(function(hasToSetupAutomaticTryAgain){if(this.setStatus(data.status),hasToSetupAutomaticTryAgain)return this.setupAutomaticTryAgain()}.bind(this)).then(function(){var state=data.status;"corrected"===data.status&&(state="feedback"),this.notifyStateChange(state)}.bind(this))),promise}.bind(this)).then(function(){a5.mainBuilder.trigger("score_update"),this.trigger("restored",this),a5.callbacks.interaction.trigger("restored",this)}.bind(this))},_initQuestionPool:function(questionPool){if(this.options.questionpoolIsYes())if(questionPool)this._setQuestionPool(questionPool);else{var size=parseInt(this.options.getQuestionpool(),10);this._makeQuestionPool(size)}},_setQuestionPool:function(questionPool){var $interaction=this.$(".interaction"),$contentBlocks=$interaction.children().detach();questionPool.forEach(function(block){$interaction.append($contentBlocks.eq(block))}),this._setQuestionPoolEnum(),this.items.sample(questionPool)},_makeQuestionPool:function(size){this.questionPool=_.sample(_.times(this.items.length(),_.identity),size),this._setQuestionPool(this.questionPool)},_setQuestionPoolEnum:function(){var $interaction=this.$(".interaction"),$contentBlocks=$interaction.children();this.enumBlock&&this.enumBlock.useEnum()&&this.enumBlock.ready().then(function(){this.enumBlock.reset(),$contentBlocks.each(function(index,cb){var $cb=$(cb),$currentEnum=$cb.find("> .enum");this.enumBlock.next().then(function(enumSpan){$currentEnum.after(enumSpan),$currentEnum.remove(),$cb.attr("id","enumeration-"+a5.utils.enumText(enumSpan))})}.bind(this))}.bind(this))},startAutosave:function(){this.autoSaveTimer||(this.autoSaveTimer=setInterval(_.bind(this.store,this),1e4))},stopAutosave:function(){clearInterval(this.autoSaveTimer),this.autoSaveTimer=null},addBodySubstyle:function(){this.addSubstyleTo($(document.body))},addContentWrapSubstyle:function(){this.addSubstyleTo(this.contentWrap)},addSubstyleTo:function($node){if(!this.options.designPackSubstyleIsOff()){var substyleClass=this.options.getDesignPackSubstyle().toLowerCase();substyleClass&&$node.addClass("substyle-"+substyleClass)}},removeBodySubstyle:function(){if(!this.options.designPackSubstyleIsOff()){var substyleClass=this.options.getDesignPackSubstyle().toLowerCase();substyleClass&&$("body").removeClass("substyle-"+substyleClass)}},attachTitle:function(title){this.contentWrap.find(".interaction-title").html(title)},attachMetadataClasses:function(){if(a5.dp.config.metadataAsCssClasses){var fields=a5.dp.config.metadataAsCssClasses.split(",");_.each(fields,function(field){field=field.trim();var metadata=this.activityMetadata.getValues(field),classes=_(metadata).map(function(m){return"md-"+_.str.slugify(field)+"-"+_.str.slugify(m.value||m.description)});this.contentWrap.addClass(classes.join(" "))},this)}},attachImageDivClass:function(){this.$("div:not(.image-as-trigger) > img").parent().addClass("image-div"),this.$("div > .image-as-trigger").parent().addClass("image-div")},attachNoLabelClass:function(){this.$(".has_audio_attached").each(function(){var $elem=$(this);$elem.toggleClass("no-label",!$elem.text().trim()),$elem.filter(".no-label").toggleClass("image-label",!!$elem.find("img").length)})},highlightDictionaryEntry:function(){var found=!1;return $(this.xml).find("#contentblock").each(function(index,contentblock){var ref=A5.DICTIONARY_REF||"",$entry=$(_.first($(contentblock).contents())),words=a5.utils.splitAndTrim($entry.text(),",");if(_(words).some(function(word){return word.toLowerCase()===ref.toLowerCase()}))return found=!0,$(contentblock).attr("dictionary-selected-entry","dictionary-selected-entry"),!1}),found},hasMoreCheckAttempts:function(){var checkMaxAttempts=a5.mainBuilder.getCheckMaxAttemptsNumber(),attemptsLeft=checkMaxAttempts-this.checkAttempts;return!checkMaxAttempts||attemptsLeft>0},getActivityModels:function(){return this.items.getItems()},getItemsByClass:function(classes){return this.items.getItemsByClass(classes)},meetsMinLength:function(){return this.items.meetsMinLength()},isFilled:function(){return this.items.isFilled()},areAllFilled:function(){return this.items.areAllFilled()},getItemsState:function(){return this.items.getState()},initItems:function(){this.items=new a5.models.interaction.BlockItems({parent:this,interaction:this}),this.items.bind(this.items.VALUE_CHANGE_EVENT,function(){this._cache("getScores",this.getScoresAsync).then(function(){a5.mainBuilder.notifyFrequentScoreUpdateEvent(),a5.eventBus.trigger("interaction:value:change",this)}.bind(this))},this),this.items.bind(this.items.FILL_CHANGE_EVENT,function(fill){this._cache("getScores",this.getScoresAsync).then(function(){a5.mainBuilder.notifyFrequentScoreUpdateEvent(),a5.eventBus.trigger("interaction:fill:change",this,fill)}.bind(this))},this),this.items.bind(this.items.STATE_CHANGE_EVENT,function(newState){this._cache("getScores",this.getScoresAsync).then(function(){a5.mainBuilder.notifyFrequentScoreUpdateEvent()}.bind(this))},this),this.items.bind(this.items.MIN_LENGTH_EVENT,function(meetsMinLength){this._cache("getScores",this.getScoresAsync).then(function(){a5.mainBuilder.notifyFrequentScoreUpdateEvent(),a5.eventBus.trigger("interaction:min_length:change",this,meetsMinLength)}.bind(this))},this)},notifyStateChange:function(newState){a5.eventBus.trigger("interaction:state:change",this,newState)},notifyShowNextAnswer:function(){a5.eventBus.trigger("interaction:show_next_answer",this)},notifyShowAllAnswer:function(){a5.eventBus.trigger("interaction:show_all_answer",this)},notifyShowSolutionHint:function(){a5.eventBus.trigger("interaction:show_solution_hint",this)},notifyBeginAction:function(action){a5.eventBus.trigger("interaction:action:begin",this,action)},notifyEndAction:function(action){a5.eventBus.trigger("interaction:action:end",this,action)},displaySpecificFeedback:function(show){show?a5.eventBus.trigger("interaction:specific-feedback:show",this):a5.eventBus.trigger("interaction:specific-feedback:close",this)},getNextAdaptiveInteraction:function(){var nextInteractionIndex=-1,fwdBtnOption=this.options.getForwardButton();return this.options.forwardButtonIsAdaptive()&&/^(?:\s*(\d+)\s*\*\s*(\d+)\s*\|)*\s*(\d+)\s*\*\s*(\d+)\s*$/.test(fwdBtnOption)?this.getScoresAsync().then(function(score){for(var match,interactionIndex,interaction,percent=score.percent(),regex=/\s*(\d+)\s*\*\s*(\d+)\s*(?:\||$)/g;match=regex.exec(fwdBtnOption);)interactionIndex=parseInt(match[2],10)-1,interaction=a5.mainBuilder.getInteractionFromIndex(interactionIndex),percent<=parseInt(match[1],10)&&-1===nextInteractionIndex?nextInteractionIndex=interactionIndex:-1===nextInteractionIndex&&(interaction.skippedByAdaptive=!0);return nextInteractionIndex}.bind(this)):$.when(nextInteractionIndex)},hasItemBank:function(){return"item-bank"===this.source},setTitleAndGroup:function(title){var regexp=/\{(.*)\}/,groupName="";this.title=title.replace(regexp,_.bind(function(match,group){return groupName=group,""},this)),this.group=groupName},_cache:function(key,value){return this.__cache=this.__cache||{},_.isUndefined(value)?this.__cache[key]:(_.isFunction(value)&&(value=value.apply(this,Array.prototype.slice.call(arguments,2))),$.when(value).then(function(value){this.__cache[key]=value}.bind(this)))}},a5.models.interaction.BaseModel.extend("a5.Interaction"),a5.ItemBankErrors={EMPTY:1,AT:2,SERVER:3,IDS:4,XML:5},a5.ItemBank={init:function(parameters){var defaults={itembankId:null,node:null,activityType:"",tags:[],sets:[],amount:0,questionsXML:[],answersXML:[],errors:[],itemIds:[]};_.chain(parameters).keys().difference(_.keys(defaults)).each(function(newKey){logger.raise("Parameter",newKey,"not supported for",this)},this);var mixedParameters=$.extend({},defaults,parameters||{});$.extend(this,mixedParameters),this.id=a5.utils.createUID()},setData:function(dataObj){var errors=[];if(dataObj.total&&dataObj.total!==this.amount&&logger.warn("Itembank Api: Requested "+this.amount+" entries and got "+dataObj.total),_.isArray(dataObj.item_ids)||logger.warn("Itembank Api not returning item ids on request"),_.isArray(dataObj.item_ids)&&this.itemIds.length&&(_.difference(dataObj.item_ids,this.itemIds).length>0||_.difference(this.itemIds,dataObj.item_ids).length>0))errors.push({type:a5.ItemBankErrors.IDS,msg:"Itembank Api requested for items "+this.itemIds.join(",")+" and received items "+dataObj.item_ids.join(",")});else if(_.isEmpty(dataObj.response_declaration)||_.isEmpty(dataObj.content))errors.push({type:a5.ItemBankErrors.empty,msg:"Empty response from "+this.itembankId+"|"+this.tags.join(",")+"|"+this.sets.join(",")});else if(dataObj.errors)errors=_.pluck(dataObj.errors,"msg").map(function(er){return{type:a5.ItemBankErrors.SERVER,msg:er}});else if(dataObj.activity_type&&dataObj.activity_type!==this.activityType)errors.push({type:a5.ItemBankErrors.AT,msg:"Wrong activity type: expected "+this.activityType+" and got "+dataObj.activity_type});else{var answersXML,questionsXML,itemIds;try{answersXML=$.parseXML("<responses>"+dataObj.response_declaration+"</responses>"),questionsXML=$.parseXML("<question>"+dataObj.content+"</question>"),dataObj.item_ids&&(itemIds=dataObj.item_ids)}catch(exception){errors.push({type:a5.ItemBankErrors.XML,msg:exception.message})}errors.length||(this.answersXML=answersXML,this.questionsXML=questionsXML,this.itemIds=itemIds||[],errors=null)}return errors},getUrl:function(){return A5.ITEM_BANK_API_URL},getAnswersResponsesXML:function(){return $(this.answersXML).find("responses").clone().children()},getQuestionsXML:function(){return $(this.questionsXML).find("question").clone().children()},getUrlParams:function(){var filter={items_bank_id:this.itembankId};this.tags.length&&(filter.tags=this.tags.join(",")),this.sets.length&&(filter.sets=this.sets.join(",")),this.itemIds.length&&(filter.item_ids=this.itemIds.join(","));var page={size:this.amount},params={filter:filter,page:page};return this.itemIds.length||(params.sort="random"),params}},Obj.extend("a5.ItemBank"),a5.Score={init:function(){this.total=0,this.correct=0,this.filled=0,this.revealed=0,this.totalBlocks=0,this.correctBlocks=0,this.blockScore=void 0},areAllFilled:function(){return this.filled+this.revealed>=this.total},isFirstFilled:function(){return this.filled+this.revealed>0},incTotal:function(val){_.isNumber(val)?this.total+=val:(val||void 0===val)&&this.total++},decTotal:function(val){_.isNumber(val)?this.total-=val:(val||void 0===val)&&this.total--,this.total<0&&(this.total=0)},incCorrect:function(val){
_.isNumber(val)?this.correct+=val:(val||void 0===val)&&this.correct++},incFilled:function(val){_.isNumber(val)?this.filled+=val:(val||void 0===val)&&this.filled++},incRevealed:function(val){_.isNumber(val)?this.revealed+=val:(val||void 0===val)&&this.revealed++},decCorrect:function(val){_.isNumber(val)?this.correct-=val:(val||void 0===val)&&this.correct--},min:function(){return 0},max:function(){return this.total},raw:function(){return this.correct},scaled:function(revealedAsCorrect){return this.percent(revealedAsCorrect)/100},percent:function(revealedAsCorrect){return 0==this.total?100:100*(this.correct+(revealedAsCorrect?this.revealed:0))/this.total||0},minBlocks:function(){return 0},maxBlocks:function(){return this.totalBlocks},rawBlocks:function(){return this.correctBlocks},scaledBlocks:function(){return this.percentBlocks()/100},percentBlocks:function(){return 0==this.totalBlocks?100:100*this.correctBlocks/this.totalBlocks||0},isPercent100:function(revealedAsCorrect){return 100===this.percent(revealedAsCorrect)},isPercentBlocks100:function(){return 100===this.percentBlocks()}},Obj.extend("a5.Score"),a5.Results={init:function(scores,options){this.scores=scores||new a5.Score,this.options=options},_noround:function(score){return score},_round:function(score){return Math.round(score)},_roundUp:function(score){return Math.ceil(score)},_roundDown:function(score){return Math.floor(score)},min:function(){return 0},max:function(){return this.total()},raw:function(){return this.correct()},scaled:function(revealedAsCorrect){return this.percent(revealedAsCorrect)/100},total:function(){return this.options.scoreValuesIs1_point_question()?this.scores.totalBlocks:this.scores.total},correct:function(){var onePointPerBlock=this.options.scoreValuesIs1_point_question(),rounding_function=this._noround,rounding_option=this.options.getScoreRounding();return"roundup"===rounding_option?rounding_function=this._roundUp:"round"===rounding_option?rounding_function=this._round:"rounddown"===rounding_option&&(rounding_function=this._roundDown),rounding_function(onePointPerBlock?this.scores.correctBlocks:this.scores.correct)},filled:function(){return this.scores.filled},revealed:function(){return this.options.scoreValuesIs1_point_question()?0:this.scores.revealed},percent:function(revealedAsCorrect){return 0==this.total()?100:100*(this.correct()+(revealedAsCorrect?this.revealed():0))/this.total()},areAllFilled:function(){return this.scores.areAllFilled()},isFirstFilled:function(){return this.scores.isFirstFilled()},human:function(){return new a5.HumanResult(this)},isPercent100:function(revealedAsCorrect){return 100===this.percent(revealedAsCorrect)}},Obj.extend("a5.Results"),a5.EmptyResult={init:function(){},min:function(){return 0},max:function(){return 0},raw:function(){return 0},scaled:function(){return 0},total:function(){return 0},correct:function(){return 0},filled:function(){return 0},revealed:function(){return 0},percent:function(){return 0},areAllFilled:function(){return!1},isFirstFilled:function(){return!1},human:function(){return new a5.HumanResult(this)},isPercent100:function(){return!1}},Obj.extend("a5.EmptyResult"),a5.CompletedResult={resetUserScore:function(){},min:function(){return 0},max:function(){return this.total()},raw:function(){return this.correct()},scaled:function(){return this.percent()/100},total:function(){return 1},correct:function(){return 1},filled:function(){return 1},revealed:function(){return 0},percent:function(){return 100},areAllFilled:function(){return!0},isFirstFilled:function(){return!0},human:function(){return new a5.HumanResult(this)},isPercent100:function(){return!0}},Obj.extend("a5.CompletedResult"),a5.ResultList={init:function(){this.results=[]},push:function(result){this.results.push(result)},min:function(){return 0},max:function(){return this.total()},raw:function(){return this.correct()},scaled:function(revealedAsCorrect){return this.percent(revealedAsCorrect)/100},total:function(){return _.reduce(this.results,function(a,b){return a+b.total()},0)},correct:function(){return _.reduce(this.results,function(a,b){return a+b.correct()},0)},filled:function(){return _.reduce(this.results,function(a,b){return a+b.filled()},0)},revealed:function(){return _.reduce(this.results,function(a,b){return a+b.revealed()},0)},percent:function(revealedAsCorrect){return 0==this.total()?100:100*(this.correct()+(revealedAsCorrect?this.revealed():0))/this.total()},areAllFilled:function(){return _.all(this.results,function(r){return r.scores.areAllFilled()})},isFirstFilled:function(){return _.any(this.results,function(r){return r.scores.isFirstFilled()})},human:function(){return new a5.HumanResult(this)},isPercent100:function(revealedAsCorrect){return 100===this.percent(revealedAsCorrect)}},Obj.extend("a5.ResultList");function toFixedNLZ(num,digits){var val=num.toFixed(digits||1);return/\.0*$/.test(val)&&(val=val.substring(0,val.lastIndexOf("."))),val}Obj.extend("a5.HumanResult",{init:function(subject){this.subject=subject},min:function(){return toFixedNLZ(this.subject.min())},max:function(){return this.total()},raw:function(){return this.correct()},scaled:function(revealedAsCorrect){return toFixedNLZ(this.subject.scaled(revealedAsCorrect))},total:function(){return toFixedNLZ(this.subject.total())},correct:function(){return toFixedNLZ(this.subject.correct())},filled:function(){return toFixedNLZ(this.subject.filled())},revealed:function(){return toFixedNLZ(this.subject.revealed())},percent:function(revealedAsCorrect){return Math.round(this.subject.percent(revealedAsCorrect))},incorrect:function(){return toFixedNLZ(this.subject.total()-this.subject.revealed()-this.subject.correct())},isPercent100:function(revealedAsCorrect){return 100===this.percent(revealedAsCorrect)}}),a5.parsers.TocParser={init:function(){this.tocEntryParser=new a5.parsers.TocEntryParser,this.tocSectionParser=new a5.parsers.TocSectionParser(this)},parse:function(lines){return"string"==typeof lines&&(lines=lines.trim().split("\n"),lines=_(lines).map(function(line){return line.replace(/\s+$/,"")})),this._chunkLinesPerLevel(lines).reduce(function(res,blockOfLines){return this._isASectionToken(blockOfLines[0])?res.push(this.tocSectionParser.parse(blockOfLines)):res.push(this.tocEntryParser.parse(blockOfLines[0])),res}.bind(this),[])},_chunkLinesPerLevel:function(lines){var level;return lines.length?(level=this._obtainLevelFor(lines[0]),lines.reduce(function(result,line){var lineLevel,lastLine;return""===line?result:(lineLevel=this._obtainLevelFor(line),lineLevel===level?result.push([line]):lineLevel>level&&(lastLine=result[result.length-1])&&lastLine.push(line),result)}.bind(this),[])):[]},_isASectionToken:function(line){return line.match(/#.*#/)},_obtainLevelFor:function(line){return line.match(/^\s*/)[0].length}},Obj.extend("a5.parsers.TocParser"),a5.parsers.TocSectionParser={init:function(parent){this.tocParser=parent},parse:function(lines){var tocLine,attributes;return tocLine=lines.shift(),attributes=this._extractAttributesFromLine(tocLine),{type:"section",page:parseInt(attributes.page,10),title:attributes.title,tocEntries:this.tocParser.parse(lines)}},_extractTitleFromLine:function(line){var matches=line.match(/#(.*)#/);return matches&&matches[1]&&matches[1].trim()},_extractAttributesFromLine:function(line){var page,regExp=/\[(.*?)\]$/,matches=line.match(regExp);return matches&&(page=matches[1]),{page:page&&page.trim(),title:this._extractTitleFromLine(line.replace(regExp,"").trim())}}},Obj.extend("a5.parsers.TocSectionParser"),a5.parsers.TocEntryParser={init:function(){},parse:function(line){var attributes=this._extractAttributesFromLine(line);return{page:parseInt(attributes.page,10),title:attributes.title}},_extractAttributesFromLine:function(line){var page,title,regExp=/\[(.*?)\]$/,matches=line.match(regExp);return matches&&(page=matches[1]),{page:page&&page.trim(),title:(title=line.replace(regExp,""))&&title.trim()}}},Obj.extend("a5.parsers.TocEntryParser"),function($){$(function(){window.self!==window.top&&$("body").is(".isMac")&&$("body").is(".isChrome")&&$("body").addClass("custom-scrollbar")})}(jQuery),a5.hooks.interactionShowed.add(function(interaction){a5.callbacks.interaction.bind("dp:uiLocaleChanged",function(lang){if(interaction.avatar){var last_audio_is_rubric=interaction.avatar.audios.last_audio===interaction.avatar.audios.rubric_audio;interaction.avatar.audios.rubric_audio.stop(),interaction.avatar.audios.rubric_audio.unbind(),interaction.avatar.__getRubricAudio(),last_audio_is_rubric&&(interaction.avatar.audios.last_audio=interaction.avatar.audios.rubric_audio)}})});try{"object"==typeof localStorage&&(localStorage.setItem("localStorage",1),localStorage.removeItem("localStorage"))}catch(e){logger.warn("No support for storing data. User might be using private mode browser. Disabling localStorage"),Storage.prototype._setItem=Storage.prototype.setItem,Storage.prototype.setItem=function(){}}!function($,document){var oldGetStyles=$.fn.getStyles;$.fn.getStyles=function(){var result=oldGetStyles.apply(this,arguments),$el=this;return document.documentMode&&("height"in result&&(result.height=$el.css("height")),"width"in result&&(result.width=parseInt($el.css("width"),10)+1)),result}}(jQuery,window.document),function($){$.ui.draggable.prototype._normalizeRightBottom=function(){}}(jQuery),function(){a5.hooks.interactionLoaded.add(_.once(function(){if(a5.dp.config.feedbackClickToggle){$(document.body).addClass("dp-config-nofeedbackhover");var active;$(document.body).on("click",".check",function(){active&&active.toggleClass("feedback-force-display"),$(this).is(active)||($(".feedback-force-display").removeClass("feedback-force-display"),$(this).addClass("feedback-force-display"),active=$(this))}),$(document.body).on("click",function(e){active&&!$(e.target).is(active)&&(active.removeClass("feedback-force-display"),active=void 0)})}}))}();var oldMouseStart=$.ui.draggable.prototype._mouseStart;$.ui.draggable.prototype._mouseStart=function(event,overrideHandle,noActivation){this._trigger("beforeStart",event,this._uiHash()),oldMouseStart.apply(this,[event,overrideHandle,noActivation])},function($){var $base=$("base");$base.length>0&&($.ui.tabs.prototype._isLocal=function(){var rhash=/#.*$/;return function(anchor){var anchorUrl,locationUrl;anchor=anchor.cloneNode(!1),anchorUrl=anchor.href.replace(rhash,""),locationUrl=$base.get(0).href.replace(rhash,"");try{anchorUrl=decodeURIComponent(anchorUrl)}catch(error){}try{locationUrl=decodeURIComponent(locationUrl)}catch(error){}return anchor.hash.length>1&&anchorUrl===locationUrl}}())}(jQuery),a5.views.ResourcesZone={init:function(interaction){this.interaction=interaction,this.$el=interaction.resourcesZone,this.$contentWrap=interaction.contentWrap},render:function(){var resources=this._getResourcesFromXML();this.$el.empty(),resources.length&&this.$el.append.apply(this.$el,_(resources).map(function(resource){return resource.render()})),$(".layout",this.$contentWrap).toggleClass("isWithoutResources",!resources.length)},_getResourcesFromXML:function(){return _($("#resources",this.interaction.xml).children()).map(function(resourceNode){return this._createResource($(resourceNode))},this)},_createResource:function($node){var className=a5.utils.capitalize($node[0].tagName)+"Resource";return new(0,a5.views[className])($node)}},Obj.extend("a5.views.ResourcesZone"),a5.views.Resource={template:'<a class="link" href="<%= url %>" data-type="<%= type %>"><strong class="name"><%= title %></strong></a>',init:function(interactionNode){_(this).bindAll("onResourceClick"),this._super(null,null,$('<div class="resource"></div>')),this.renderTemplate=_.template(this.template),this.interactionNode=interactionNode,this.node.on("click",".link",this.onResourceClick)},onResourceClick:function(e){e.preventDefault(),this.open()},render:function(){return this.node.html(this.renderTemplate(this._serializeData()))},open:function(){},buildTitle:function(){},buildUrl:function(){},buildType:function(){},_serializeData:function(){return{url:this.buildUrl(),type:this.buildType(),title:this.buildTitle()}}},a5.views.interaction.BaseView.extend("a5.views.Resource"),a5.views.UrlResource={init:function(interactionNode){this._super(interactionNode),this.url=interactionNode.attr("url"),this.title=interactionNode.attr("title")},open:function(){a5.mainBuilder.engine.invoke("open-link",this.url)},buildUrl:function(){return this.url},buildType:function(){return"url"},buildTitle:function(){return this.title}},a5.views.Resource.extend("a5.views.UrlResource"),a5.views.PlatformResource={init:function(interactionNode){this._super(interactionNode),this.platformId=interactionNode.attr("platformid"),this.title=interactionNode.attr("title")},open:function(){var $iframe=$('<iframe frameborder="0" scrolling="no" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true">');$iframe.attr("src",this.$(".link").attr("href")),$iframe.iframeModal()},buildUrl:function(){return(A5&&A5.PLATFORM_URL_BUILDER||this._defaultUrl).call(null,this.platformId)},buildType:function(){return"platform"},buildTitle:function(){return this.title},_defaultUrl:function(platformId){var course,match=/courses\/(\d+)/.exec(window.location.href);return match&&(course=match[1]),"/api/courses/"+course+"/interactives/"+platformId+".html"}},a5.views.Resource.extend("a5.views.PlatformResource"),function(a5,$,_){a5.views.ScreenNavigation={template:'<ul><% _.each(screens, function(screen) { %><li<% if(screen.isActive) { %> class="active"<% } %>><a href="#" data-index="<%= screen.index %>"><%= screen.title %></a></li><% }) %></ul>',init:function($el){_.bindAll(this,"onScreenClick","onInteractionShowed"),this.$el=$el,this._createScreens(),this.render(),this._bindEvents()},render:function(){this._hasToShowLinks()&&(this._markActiveScreen(),this.renderTemplate=_.template(this.template),this.$el.html(this.renderTemplate({screens:this.screens})))},onScreenClick:function(e){var $element=$(e.currentTarget),interactionIndex=$element.data("index");a5.mainBuilder.goTo(interactionIndex),e.preventDefault()},onInteractionShowed:function(){this.render()},_bindEvents:function(){this.$el.on("click","a",this.onScreenClick),a5.hooks.interactionShowed.add(this.onInteractionShowed)},_markActiveScreen:function(){_(this.screens).each(function(screen){screen.isActive=screen.index===this._getCurrentInteractionNumber()},this)},_createScreens:function(){this.screens=[{title:"Home",index:0}],_(this._getNumberOfInteractions()-1).times(function(n){this.screens.push({title:"Unit "+(n+1),index:n+1})},this)},_hasToShowLinks:function(){return this._getNumberOfInteractions()>1},_getNumberOfInteractions:function(){return a5.mainBuilder.getNumberOfInteractions()},_getCurrentInteractionNumber:function(){return a5.mainBuilder.curTask}},Obj.extend("a5.views.ScreenNavigation")}(a5,jQuery,_),a5.views.MediaZone={init:function(interaction){_.bindAll(this,"flag"),this.interaction=interaction,this.$el=interaction.mediaZone,this._pinnedText={},this._pinnedMedia={},this.interaction.bind("show",this.flag),this.interaction.bind("show",_.bind(this._setUpdatedMedia,this)),this.interaction.bind("show:deferred",_.bind(this._setUpdatedScroll,this)),interaction.options.audiosupportIsTrue()&&this.addTTSPlayer(),this._initPinnedText(),_.defer(_.bind(this._initPinnedMedia,this))},_initPinnedMedia:function(){this.$el.find("*[data-option023]").each(_.bind(this._registerPinnedMedia,this))},_registerPinnedMedia:function(i,el){var regex=/_(\d+)$/,media_uid=$(el).attr("data-playable-media"),media_baseid=media_uid.replace(regex,""),media_obj=a5.service.media.by_id[media_uid];this._pinnedMedia[media_baseid]={obj:media_obj,position:0},media_obj.bind("progress",_.bind(function(position){this._syncPinnedMedia(media_baseid,position)},this)),media_obj.bind("seeked",_.bind(function(position){this._syncPinnedMedia(media_baseid,position)},this)),media_obj.bind("stopped",_.bind(function(){media_obj.audioObject&&this._syncPinnedMedia(media_baseid,0)},this))},_setUpdatedMedia:function(){_.each(this._pinnedMedia,function(media,id){media.obj.position(media.position)},this)},_syncPinnedMedia:function(id,position){_.each(a5.mainBuilder.intList,function(interaction){if(interaction.mediaZoneView){var media=interaction.mediaZoneView._pinnedMedia[id];media&&(media.position=position)}},this)},_initPinnedText:function(){var regex=/option023:(\w+);/;this.$el.find("#text").each(_.bind(function(i,el){var match=$(el).attr("style").match(regex);match&&this.addPinnedText(match[1],el)},this))},_setUpdatedScroll:function(){_.defer(_.bind(function(){_.each(this._pinnedText,function(text,id){text.node.scrollTop(text.top),text.node.scrollLeft(text.left)},this)},this))},addPinnedText:function(id,el){var $el=$(el);this._pinnedText[id]={node:$el,top:$el.scrollTop(),left:$el.scrollLeft()},$el.on("scroll",_.bind(function(e){this.interaction.index==a5.mainBuilder.curInteraction.index&&this.syncPinnedText(id,$el.scrollTop(),$el.scrollLeft())},this))},syncPinnedText:function(id,top,left){_.each(a5.mainBuilder.intList,function(interaction){if(interaction.mediaZoneView){var text=interaction.mediaZoneView._pinnedText[id];text&&(text.top=top,text.left=left)}},this)},addTTSPlayer:function(){var nodes=this.$el.find("img[alt][alt!='']");_.each(nodes,function(node){var alt=$(node).attr("alt");if(!alt.match(/^\s*\.+\s*$/)){var wrap=$("<div class='tts_wrap' style='position:absolute;'>");wrap.css({left:$(node).css("left"),top:$(node).css("top"),width:$(node).width(),height:$(node).height()}),$(node).css({left:"",top:"",position:""});var tts=new a5.views.TTS_Player(alt).render();tts.css("z-index","1000"),$(node).wrap(wrap),$(node).parent().prepend(tts)}})},_hasTextContent:function(node){var hasImgAlt=node.find("img[alt][alt!='']").length>0,hasText=""!==node.text().trim()&&!node.text().trim().match(/^\s*\.+\s*$/);return hasImgAlt||hasText},render:function(){},flag:function(){$("body").toggleClass("isWithoutMedia",this.$el.is(":empty"))}},Obj.extend("a5.views.MediaZone"),a5.views.LessonNotes={template:'<div class="layout"><div class="annotations"></div><div class="list"><% if (notes.length){ %><% _.each(notes, function(note){ %><div class="note"><% if (note.screen) { %><a class="thumbnail" href="#" data-screen="<%= note.screen %>"><img src="<%= thumbnailsUrl+"?screen="+(note.screen - 1) %>" width="160" height="120"></a><% } %><div class="notes"><%= note.text %></div></div><% }) %><% }else{ %><span class="no_content">No notes.</span><% } %></div></div>',NOTES_REGEX:/<p>\s*<a [^>]*name=\\*"([0-9]+)\\*" ?[^>]*><\/a>\s*<\/p>\n?/,init:function($el){this.notes=this._parseNotes(window.LOInfo.notes,this.NOTES_REGEX),this.active=!1,this.$=$el,this.thumbnailsUrl=window.LOInfo.thumbnailsUrl,this.renderTemplate=_.template(this.template),this.render(),this._bindEvents()},hasNotes:function(){return!!this.notes.length},isActive:function(){return this.active},render:function(){this.$.empty(),this.$.hide(),$(this.renderTemplate(this)).appendTo(this.$)},onClickThumbnail:function(e){var $element=$(e.currentTarget),interactionIndex=$element.data("screen")-1;this.hide(),a5.mainBuilder.goTo(interactionIndex),e.preventDefault()},enableAnnotations:function(){},show:function(){this.active=!0,this.$.show(),$("#content_wrap, #page_controls").hide(),$("body").addClass("isNotesView")},hide:function(){this.active=!1,$("#content_wrap, #page_controls").show(),this.$.hide(),$("body").removeClass("isNotesView")},_bindEvents:function(){this.$.on("click",".thumbnail",_.bind(this.onClickThumbnail,this))},_parseNotes:function(text,regex){var parsedNotes=[];if(text){var notes=text.split(regex);if(""===notes[0]&&notes.shift(),notes.length){notes[0].match(/^[0-9]+$/)||notes.unshift("0");for(var i=0;i<notes.length;i+=2)parsedNotes.push({screen:+notes[i],text:notes[i+1]})}}return parsedNotes}},Obj.extend("a5.views.LessonNotes"),a5.views.WhiteboardTools={init:function(appendTo,interactions){this.annotations=new a5.Annotations({language:a5.dp.config.bookAnnotationsLanguage||"en",stage:"annotations",appendTo:appendTo,keyboard:!0}),this.annotations.config.defaultStickyNoteSize=200,this.annotations.toolbox.use([new a5.Annotations.Tool.Undo,new a5.Annotations.Tool.Redo,new a5.Annotations.Tool.Cursor,new a5.Annotations.Tool.Pen,new a5.Annotations.Tool.Highlighter,new a5.Annotations.Tool.Eraser,new a5.Annotations.Tool.StickyNote,new a5.Annotations.Tool.Spotlight,new a5.Annotations.Tool.Save,new a5.Annotations.Tool.Hide]),this.annotations.useTool("cursor"),_(interactions).each(function(interaction){"Present:Present:Ebook"!==interaction.identifier&&"Present:Present:AudioBook"!==interaction.identifier||this.activate(interaction)},this)},activate:function(interaction){(interaction.view?interaction.view.$node:interaction.node||interaction.$).find("."+a5a.current.view.domSelector).length>0&&(this.annotations.allocate(interaction),interaction.bind("show:deferred",_.bind(function(){this.annotations.activate([interaction])},this)))}},Obj.extend("a5.views.WhiteboardTools"),a5.service.Toolbelt={init:function(){this.convertURL=A5.TOOLBELT_URL+"/convert",this.audioManipulatorURL=A5.TOOLBELT_URL+"/audio-manipulator"},exportTo:function(options){if(_.isArray(options.formats)&&options.formats.length>1){var formats=options.formats;this._exportToMultipleFormats(formats,_.omit(options,"formats"))}else{var format=_.isArray(options.formats)?options.formats[0]:options.formats;this._exportToSingleFormat(format,_.omit(options,"formats"))}},audioDownload:function(options){var data={input:options.inputs.map(function(input){return a5.utils.startsWith(input,"//")?"http:"+input:input}),clips:options.clips,output:options.output},_getLink=$.ajax({type:"POST",data:JSON.stringify(data),contentType:"application/json",url:this.audioManipulatorURL});a5.mainBuilder.engine.invoke("open-link",_getLink,{target:"iframe"})},_exportToSingleFormat:function(format,options){var data=_.extend({from:"html",to:format},options),$form=this._buildForm(this.convertURL,data);$("body").append($form),$form.submit(),$form.remove()},_exportToMultipleFormats:function(formats,options){_(formats).each(function(format){var data=_.extend({from:"html",to:format},options),$form=this._buildForm(this.convertURL,data),$iframe=$("<iframe>",{id:"iframe-toolbelt-export",src:"about:blank"}).hide().appendTo("body");$iframe.contents().find("body").append($form),$form.attr("target","_self"),$form.submit(),setTimeout(function(){$iframe.remove()},1e3)},this)},_buildForm:function(action,data){var $form=$("<form>",{action:action,method:"post",target:"_blank"});return _.each(data,function(v,k){_.isArray(v)?_.each(v,function(item){$form.append($("<input>").attr("name",k+"[]").attr("type","hidden").val(item))}):$form.append($("<input>").attr("name",k).attr("type","hidden").val(v))}),$form}},Obj.extend("a5.service.Toolbelt",a5.service.Toolbelt),a5.service.Wiki={init:function(identifier){this.adapter=A5.WIKI&&A5.WIKI.getWikiServiceFor(identifier)},start:function(){return this.adapter.start()},stop:function(){this.adapter.stop()},write:function(content){return this.adapter.write(content)},startEditing:function(){return this.adapter.startEditing()},stopEditing:function(){return this.adapter.stopEditing()},subscribe:function(){this.adapter.subscribe.apply(this.adapter,arguments)},ping:function(){this.adapter.ping()},fetchLogs:function(){return this.adapter.fetchLogs()},fetchLog:function(id){return this.adapter.fetchLog(id)},canEdit:function(){return this.adapter.canEdit()},canExport:function(){return this.adapter.canExport()},canSeeWikiLogs:function(){return this.adapter.canSeeWikiLogs()}},Obj.extend("a5.service.Wiki"),a5.views.Wiki={PING_INTERVAL:5e3,template:'<div class="wiki modal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4>{{{wikiTitle}}}</h4></div><div class="modal-body"></div></div></div></div>',tabsTemplate:'<ul class="nav nav-tabs" id="wiki-tabs"><li class="active"><a href="#wiki-main-panel" data-toggle="tab">Wiki</a></li><li><a href="#wiki-history-panel" data-toggle="tab">History</a></li></ul><div class="tab-content"><div class="tab-pane active" id="wiki-main-panel"></div><div class="tab-pane" id="wiki-history-panel"></div></div>',historyTemplate:'<ul>{{#each wikiEntries as |entry|}}<li><a href="#" data-entry="{{entry.id}}">{{entry.user}} - {{entry.timestamp}}</a></li>{{else}}<p>No entries added yet.</p>{{/each}}</ul>',currentTemplate:'<div class="wiki-status"></div><div class="wiki-content"><textarea readonly="readonly">{{{wikiContent}}}</textarea></div><div class="wiki-toolbar btn-toolbar" role="toolbar"><button id="btn_wiki_take_control" type="button" class="btn btn-primary disabled">Take control</button><button id="btn_wiki_export" type="button" class="btn btn-primary disabled">Export to RTF</button><button id="btn_wiki_save"   type="button" class="btn btn-primary disabled">Save</button></div>',oldTemplate:'<p>This is an old wiki version. See latest wiki <a id="btn_current_wiki" href="#">here</a></p><div class="wiki-content">{{{wikiContent}}}</div>',exportTemplate:'<div class="wiki"><div class="wiki-header"><h4>{{{wikiTitle}}}</h4></div><div class="wiki-body"><div class="wiki-content">{{{wikiContent}}}</div></div></div>',init:function(model,service,exportService){this.model=model,this.service=service,this.exportService=exportService,this.service.subscribe("updated",_.bind(function(content){this.model.setContent(content)},this)),this.service.subscribe("locked",_.bind(function(lock){this.model.setLock({status:lock.status,owner:lock.owner})},this)),this.service.subscribe("unlocked",_.bind(function(){this.model.setLock({status:"unlocked"})},this))},render:function(){var html=a5.service.templates.render("a5.view.Wiki",{wikiTitle:this.model.title},this.template);this.$=$(html),this.$current=$('<div id="wiki-current"></div>'),this.$history=$('<div id="wiki-history"></div>'),this.$old=$('<div id="wiki-old"></div>');var current=a5.service.templates.render("a5.view.WikiCurrent",{wikiContent:this.model.content},this.currentTemplate);this.$current.append(current),this.$.addClass("wiki-loading"),this.editor=this._initCK(),this.editor.on("instanceReady",function(){this.renderContent(),this.model.bind("content:change",function(){this.renderContent()},this),this.renderStatus(),this.model.bind("status:change",function(){this.renderStatus()},this)},this),this.editor.on("destroy",function(){this.model.unbind("content:change"),this.model.unbind("status:change")},this),this.renderToolbar(),this.$.find(".modal-body").empty(),this.$.find(".modal-body").append(this.$current),this.service.start().done(function(){this.renderToolbar(),this.renderTabs(),this.$.removeClass("wiki-loading")}.bind(this)).fail(function(){this.$.removeClass("wiki-loading")}.bind(this))},renderContent:function(){this.model.content&&this.editor.setData(this.model.content)},renderStatus:function(){this.$.removeClass("wiki-locked wiki-unlocked wiki-editing"),this.$current.find(".wiki-status").empty(),this.model.lock&&("unlocked"===this.model.lock.status&&this._unlock(),"owned"===this.model.lock.status&&this._own(),"locked"===this.model.lock.status&&this._lock(this.model.lock.owner))},renderToolbar:function(){this.service.canExport()?(this._showButton("btn_wiki_export"),this._enableButton("btn_wiki_export",this.onExport)):(this._hideButton("btn_wiki_export"),this._disableButton("btn_wiki_export"))},renderTabs:function(){if(this.service.canSeeWikiLogs()){var tabs=a5.service.templates.render("a5.view.WikiTabs",{},this.tabsTemplate),$tabs=$(tabs);$tabs.find("#wiki-main-panel").append(this.$current),$tabs.find("#wiki-main-panel").append(this.$old),$tabs.find("#wiki-history-panel").append(this.$history),$tabs.find("a[href=#wiki-history-panel]").on("show.bs.tab",_.bind(this.onSeeWikiLog,this)),this.$old.hide(),this.$.find(".modal-body").empty(),this.$.find(".modal-body").append($tabs),this.$mainTab=$tabs.find("a[href=#wiki-main-panel]"),this.$historyTab=$tabs.find("a[href=#wiki-history-panel]")}},showAsModal:function(){this.render(),this.$.modal({}).on("hidden",_.bind(this.onCloseModal,this))},onCloseModal:function(){this._destroyCK(),this.service.stopEditing().done(function(){this.service.stop()}.bind(this)),this.$.remove()},onTakeControl:function(e){e.preventDefault(),this.service.startEditing().done(function(){}.bind(this)).fail(function(){}.bind(this))},onSave:function(e){e.preventDefault(),this.service.write(this._getContent()).then(this.service.stopEditing.bind(this.service)).done(function(){}.bind(this)).fail(function(){}.bind(this))},onExport:function(e){e.preventDefault();var input=a5.service.templates.render("a5.view.WikiExport",this._createModel(),this.exportTemplate);this.exportService.exportTo({formats:"rtf",input:input})},onSeeWikiLog:function(e){e.preventDefault(),this.service.fetchLogs().done(function(entries){var logs=a5.service.templates.render("a5.view.WikiHistory",{wikiEntries:_(entries).map(function(entry){return entry.timestamp=new Date(entry.timestamp).toLocaleString(),entry})},this.historyTemplate),$logs=$(logs);this.$history.empty(),this.$history.append($logs),$logs.on("click","li",_.bind(this.onSeeWikiLogEntry,this))}.bind(this))},onSeeWikiLogEntry:function(e){e.preventDefault();var id=$(e.currentTarget).find("a[data-entry]").attr("data-entry");this.service.fetchLog(id).done(function(entry){this.$old.empty();var old=a5.service.templates.render("a5.view.WikiOld",{wikiContent:entry.text},this.oldTemplate);this.$old.append(old),this.$current.hide(),this.$old.show(),this._enableButton("btn_current_wiki",function(){this.$current.show(),this.$old.hide()}.bind(this)),this.$mainTab.tab("show")}.bind(this))},onUpdated:function(content){this.model.setContent(content)},_lock:function(owner){this.$.addClass("wiki-locked"),this.$current.find(".wiki-status").append(owner),this._disableEditor(),this._disableButton("btn_wiki_save"),this._disableButton("btn_wiki_take_control")},_unlock:function(){this.$.addClass("wiki-unlocked"),this._disableEditor(),this._disableButton("btn_wiki_save"),this._enableButton("btn_wiki_take_control",this.onTakeControl)},_own:function(){this.$.addClass("wiki-editing"),this._enableEditor(),this._enableButton("btn_wiki_save",this.onSave),this._disableButton("btn_wiki_take_control")},_createModel:function(){return{wikiTitle:this.model.title,wikiContent:this.model.content}},_disableButton:function(btnID){var $button=this.$.find("#"+btnID);$button.off(),$button.removeClass("btn_active"),$button.addClass("btn_inactive disabled")},_enableButton:function(btnID,clickFn){var $button=this.$.find("#"+btnID);$button.off(),$button.on("click",clickFn.bind(this)),$button.addClass("btn_active"),$button.removeClass("btn_inactive disabled")},_hideButton:function(btnID){this.$.find("#"+btnID).hide()},_showButton:function(btnID){this.$.find("#"+btnID).show()},_initCK:function(){var $textarea=this.$current.find("textarea");return CKEDITOR.replace($textarea[0])},_destroyCK:function(){this.editor.destroy(!0)},_disableEditor:function(){this.editor.removeListener("change",this._ping),this.editor.setReadOnly(!0)},_enableEditor:function(){this.editor.removeListener("change",this._ping),this.editor.on("change",this._ping,this),this.editor.setReadOnly(!1)},_ping:function(){_.debounce(this.service.ping.bind(this.service),this.PING_INTERVAL)},_getContent:function(){return this.editor.getData()}},Obj.extend("a5.views.Wiki"),a5.views.WikiTool={init:function(interaction){var wiki=this.findWiki(interaction.xml);wiki&&(this.model=new a5.models.Wiki({id:interaction.getID(),title:wiki.title,content:wiki.content}))},findWiki:function(xml){var $wiki=$(xml).find("itemBody").find("#wiki");return $wiki.length>0&&{title:$wiki.find("title").html(),content:$wiki.find("content").html()}},hasWiki:function(){return!!this.model},show:function(){if(this.hasWiki()){
var wikiService=new a5.service.Wiki(this.model.id);new a5.views.Wiki(this.model,wikiService,a5.service.converter).showAsModal()}}},Obj.extend("a5.views.WikiTool"),a5.models.Wiki={init:function(parameters){this.id=parameters.id,this.title=parameters.title,this.content=parameters.content},setContent:function(content){this.content!==content&&(this.content=content,this.trigger("content:change"))},setLock:function(lock){_(this.lock).isEqual(lock)||(this.lock=lock,this.trigger("status:change"))}},Obj.extend("a5.models.Wiki"),a5.model_builder.OSSortingInteraction={isResponsible:function(node,interaction){return"Order:Sort:Sorting"===interaction.identifier&&node.is("matchInteraction, simpleMatchSet, simpleAssociableChoice")},buildMatchInteraction:function(interaction,parentNode,node){this.vent=this._createEventBus(),this.elementRepository=this._createElementRepository(),this.elementViewRepository=this._createElementViewRepository(this.elementRepository),this.responses=this._createResponses(interaction,node),this.model=this._createInteractiveModel(interaction,this.elementRepository),this.pool=this._createPool(interaction,this.vent),this.targets=this._createTargets(interaction,this.vent),this.targetViewFactory=this._createTargetViewFactory(interaction,this.vent,this.responses),this.view=this._createView(interaction),this.buildContents(node,interaction,parentNode),interaction.options.prefillIsFirstitem()&&this.model.setPrefill(),parentNode.append(this.view.render()),parentNode.addInteractionStyle("drag-drop"),parentNode.addInteractionStyle("wordpool-"+this.pool.align),interaction.options.multipleDestinationsIsOne()||parentNode.addInteractionStyle("multiple-destinations"),interaction.blockItems.add(this.model)},buildSimpleMatchSet:function(interaction,parentNode,node){this.buildContents(node,interaction,parentNode)},buildSimpleAssociableChoice:function(interaction,parentNode,node){if(this._isNodeForTargetBuilding(node)){var targetTable=this._createTargetTable(interaction,parentNode,node);this.targets.add(targetTable)}else{var element=this._createElement(interaction,parentNode,node),elementView=this._createElementView(interaction,element),method=interaction.options.multipleDestinationsIsOne()?"add":"merge";this.elementRepository[method](element),this.elementViewRepository[method](elementView),this.pool[method](element)}},_createEventBus:function(){return new Obj},_createElementRepository:function(){return new a5.models.interaction.OSSortingElementRepository},_createResponses:function(interaction,node){return interaction.getCorrectResponse(node.attr("responseIdentifier"))},_createInteractiveModel:function(interaction,elementRepository){var behavior=this._getGapfillBehavior(interaction);return new a5.models.interaction.OSSortingModel({behavior:behavior,repository:elementRepository,interaction:interaction,responses:this.responses})},_getGapfillBehavior:function(interaction){var behavior=interaction.options.getGapfillbehaviour();return"tap_item"!==behavior&&"tap_target"!==behavior||"mobile"===a5.dp.config.gapfillBehaviourApplicable&&a5.utils.isDocumentOverMobileBreakpoint()&&(behavior="drag"),behavior},_createElementViewRepository:function(elementRepository){return new a5.views.interaction.OSSortingElementViewRepository({elementRepository:elementRepository})},_createView:function(interaction){return new a5.views.interaction.OSSortingView({model:this.model,vent:this.vent,interaction:interaction,pool:this.pool,targets:this.targets})},_createPool:function(interaction,vent){return new a5.views.interaction.OSSortingPoolView({vent:vent,interaction:interaction,elementViewRepository:this.elementViewRepository,elementRepository:this.elementRepository})},_createTargets:function(interaction,vent){return new a5.views.interaction.OSSortingTargetsView({vent:vent,interaction:interaction})},_createTargetViewFactory:function(interaction,vent,responses){return new a5.views.interaction.OSSortingTargetViewFactory({interaction:interaction,vent:vent,responses:responses})},_createTargetTable:function(interaction,parentNode,node){var targetModel=new a5.models.interaction.OSSortingTarget({parent:this.model,identifier:node.attr("identifier"),node:node,interaction:interaction});return this.targetViewFactory.createTargetView({model:targetModel,elementViewRepository:this.elementViewRepository,elementRepository:this.elementRepository,containerImage:this._extractContainerImage(interaction)})},_createElement:function(interaction,parentNode,node){var element=new a5.models.interaction.OSSortingElement({parent:this.model,identifier:node.attr("identifier"),correctTarget:this._retrieveCorrectResponseFromNode(node),interaction:interaction,node:node,correctFeedback:interaction.options.getFeedbackCorrect(),incorrectFeedback:interaction.options.getFeedbackIncorrect(),tryAgainIsFrozen:interaction.options.tryAgainIsFrozen()});return element.assignAnswerFeedback(node),element},_createElementView:function(interaction,element){return new a5.views.interaction.OSSortingElementView({interaction:interaction,model:element,vent:this.vent})},_retrieveCorrectResponseFromNode:function(node){return this.responses.asMap()[node.attr("identifier")]},_isNodeForTargetBuilding:function(node){return _(this.responses.asMapMulti()).has(node.attr("identifier"))},_extractContainerImage:function(interaction){return $(interaction.options.getContainerStyle()).find("img").get(this.targets.size())}},a5.model_builder.Base.extend("a5.model_builder.OSSortingInteraction"),a5.model_builder.builders.push(new a5.model_builder.OSSortingInteraction),a5.models.interaction.OSSortingModel={init:function(parameters){this._super(parameters,{behavior:"drop",repository:null,interaction:null,responses:null}),this.targets=[]},addTarget:function(target){this.targets.push(target)},getTargetStatus:function(){var result={};return _.each(_.pluck(this.targets,"identifier"),function(target){result[target]=_.filter(this._getElements(),function(element){return element.isInTarget(target)}).length},this),result},getSmallestTarget:function(except){var resp=this.responses.asInverseMap();return _.findKey(this.getTargetStatus(),function(v,k){return v<resp[k].length&&!_.contains(except,k)})},setPrefill:function(){var element=this._firstElement();this.prefilled=!0,element&&element.setPrefill()},store:function(){return _(this._getElements()).map(function(element){return element.store()})},restore:function(attrsList){_(this._getElements()).each(function(element,index){element.restore(attrsList[index])})},getScores:function(){var totalCorrect=this._getTotalCorrectElements(),totalWrong=this._getTotalWrongElements(),total=(this._getTotalMissingElements(),this._getTotalElements()),scores=this._super();return scores.incTotal(total),scores.incFilled(_.min([total,totalCorrect+totalWrong])),this.interaction.options.scorecalculationIsSubtractIncorrect()&&(totalCorrect=_.max([0,totalCorrect-totalWrong])),scores.incCorrect(totalCorrect),scores},isCorrect:function(){return _.every(this._getElements(),function(element){return element.isCorrect(_.first(element.currentTarget))})},isFilled:function(){return _.some(this._getElements(),function(target){return target.isInSomeTarget()})},areAllFilled:function(){return this.getScores().areAllFilled()},isDrag:function(){return"drag"===this.behavior},isTapItem:function(){return"tap_item"===this.behavior},isTapTarget:function(){return"tap_target"===this.behavior},findElementInTarget:function(target){return _.find(this._getElements(),function(element){return element.isInTarget(target)})},getCandidatesForSolutionHint:function(){return _.filter(this._getElements(),function(item){return!("answers"===item.state||item.isDistractor()||item.isInSomeTarget()||item.prefill||item.prefilled)})},getCandidatesForShowNextAnswer:function(){return _.filter(this._getElements(),function(item){return!(item.isRevealed()||item.isDistractor()||item.isCorrect()||item.prefill||item.prefilled)})},getCandidatesForValidation:function(){return _.filter(this._getElements(),function(item){return"answers"!==item.state&&!item.isDistractor()&&!item.prefill&&!item.prefilled})},hasCandidatesForSolutionHint:function(){return!_.isEmpty(this.getCandidatesForSolutionHint())},hasCandidatesForShowNextAnswer:function(){return!_.isEmpty(this.getCandidatesForShowNextAnswer())},hasCandidatesForValidation:function(){return!_.isEmpty(this.getCandidatesForValidation())},getElementsForTarget:function(target){return _.filter(this._getElements(),function(element){return _.contains(element.correctTarget,target)})},getElementsInTarget:function(target){return _.filter(this._getElements(),function(element){return _.contains(element.currentTarget,target)||element.isRevealed()&&element.correctTarget[0]===target})},showNextAnswer:function(){var items=this.getCandidatesForShowNextAnswer(),question=items.shift();question&&question.showNextAnswer();var currentTarget=_.first(question.correctTarget);return this.__prevTarget&&currentTarget!==this.__prevTarget&&this.clearWrongAnswersForTarget(this.__prevTarget),this.__prevTarget=currentTarget,0!==items.length||this.hasCandidatesForShowNextAnswer()||(this.state="answers"),question},showSolutionHint:function(){var items=this.getCandidatesForSolutionHint(),question=items.shift();return question&&question.showSolutionHint(),this.hasCandidatesForValidation()||(this.state="answers"),question},clearAll:function(){_(this._getElements()).invoke("unsetTarget")},clearWrong:function(){_(this._getElements()).invoke("unsetWrongTargets")},clearWrongAnswersForTarget:function(target){_.invoke(this.getElementsInTarget(target),"unsetWrongTargets")},tryAgain:function(){this.interaction.options.tryAgainIsLock()||this.interaction.options.tryAgainIsFrozen()||this.interaction.options.tryAgainIsFalse()?this.clearWrong():this.interaction.options.tryAgainIsClear()&&this.clearAll(),_(this._getElements()).invoke("tryAgain"),this._super()},setAnswer:function(){_(this._getElements()).invoke("setAnswer"),this._super()},setAnswerInput:function(){_(this._getElements()).invoke("setAnswerInput"),this._super()},showAnswer:function(){_(this._getElements()).invoke("showAnswer"),this._super()},setSelected:function(element,view){this.selected&&this.selected.deselect(),this.selected!==element?(this.selected=element,this.selectedView=view,this.selected.select()):(this.selected.deselect(),this.selected=void 0,this.selectedView=void 0)},deselect:function(){this.selected&&(this.selected.deselect(),this.selected=void 0,this.selectedView=void 0)},getSelected:function(){return this.selected},getSelectedView:function(){return this.selectedView},_getElements:function(){return this.repository.getElements()},_firstElement:function(){return this.repository.first()},_getWrongOrMissingElements:function(){return this.repository.findWrong().concat(this.repository.findMissing())},_getTotalCorrectElements:function(){return this.repository.getTotalCorrect()},_getTotalWrongElements:function(){return this.repository.getTotalWrong()},_getTotalMissingElements:function(){return this.repository.getTotalMissing()},_getTotalDistractorElements:function(){return this.repository.getTotalDistractor()},_getTotalElements:function(){return this.repository.getTotal()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSSortingModel"),a5.models.interaction.OSSortingElement={init:function(parameters){this._super(parameters,{identifier:"",text:"",correctTarget:[],currentTarget:[],interaction:null,node:"",tryAgainIsFrozen:!1}),this.isMulti=!this.interaction.options.multipleDestinationsIsOne(),this.gaptextaudio=this.interaction.options.gaptextaudioIsTrue(),this.buildText()},buildText:function(){return this.text=this._extractContentFromNode(),this.gaptextaudio&&this.text.prepend(this._createTTSAudio(this.text.text()).render()),this.text},merge:function(element){this.correctTarget=_.union(this.correctTarget,element.correctTarget),this.currentTarget=_.union(this.currentTarget,element.currentTarget)},setPrefill:function(){this.prefilled=!0},isPrefilled:function(){return!!this.prefilled},isInCorrectTarget:function(target){return _.contains(this.correctTarget,target)},isInSomeTarget:function(){return this.currentTarget.length>0},isInAllCorrectTargets:function(){return!_.difference(this.currentTarget,this.correctTarget).length},belongsToPool:function(){var belongs=!1;return belongs="answers"===this.state?this.isDistractor():this.isMulti||!this.isInSomeTarget()&&!this.isRevealed(),!this.isPrefilled()&&belongs},isInTarget:function(target){return target&&_.contains(this.currentTarget,target)},isCorrect:function(target){return target?!this.isDistractor()&&this.isInTarget(target)&&this.isInCorrectTarget(target):!this.isDistractor()&&this.isInSomeTarget()&&this.isInAllCorrectTargets()},countCorrect:function(){return!this.isPrefilled()&&_.intersection(this.currentTarget,this.correctTarget).length||0},isWrong:function(target){return this.isInTarget(target)&&!this.isInCorrectTarget(target)},countWrong:function(){return!this.isPrefilled()&&_.difference(this.currentTarget,this.correctTarget).length||0},isMissing:function(target){if(target){var wrongs=_.difference(this.currentTarget,this.correctTarget);return _.difference(this.correctTarget,this.currentTarget).indexOf(target)>=wrongs.length}return this.currentTarget.length<this.correctTarget.length},countMissing:function(){return!this.isPrefilled()&&_.max([this.correctTarget.length-this.currentTarget.length,0])||0},countTotal:function(){return!this.isPrefilled()&&this.correctTarget.length},isDistractor:function(){return!this.correctTarget.length},isEqualTo:function(element){var $elementText=element.text,$text=this.text;return($.trim($elementText.text())||$elementText.find("img[data-mathml]").data("mathml")||$elementText.find("img[src]").attr("src")||$elementText.find('object[type="audio/audio"]').attr("data"))===($.trim($text.text())||$text.find("img[data-mathml]").data("mathml")||$text.find("img[src]").attr("src")||$text.find('object[type="audio/audio"]').attr("data"))},setTarget:function(target,silent){_.contains(this.currentTarget,target)||(this.isMulti||this.unsetTarget(null,!0),this.currentTarget.push(target),silent||this.trigger("changed"))},moveToPool:function(){this.trigger("move_to_pool")},unsetTarget:function(target,silent){var newTarget;target?_.contains(this.currentTarget,target)&&(newTarget=_(this.currentTarget).without(target)):newTarget=[],0!==_.difference(this.currentTarget,newTarget).length&&(this.currentTarget=newTarget,silent||this.trigger("changed"))},select:function(){this.trigger("selected")},deselect:function(){this.trigger("deselected")},unsetWrongTargets:function(){var targets=_.difference(this.currentTarget,this.correctTarget);_(targets).each(function(target){this.unsetTarget(target)},this)},_makeSpaceForNextAnswer:function(){var correctTargetId=this.correctTarget[0],target=_.find(this.parent.targets,function(target){return target.identifier===correctTargetId}),elements=this.parent.getElementsInTarget(correctTargetId),maxZones=target.maxZones;maxZones&&(this.parent._firstElement().correctTarget[0]===target.identifier&&(maxZones-=1),elements.length>=maxZones&&_.last(elements).moveToPool())},showNextAnswer:function(){this.setRevealedBySeeNext(),this.isInSomeTarget()&&this.unsetWrongTargets(),this._makeSpaceForNextAnswer(),this.showAnswer(),this.trigger("changed")},showSolutionHint:function(){this.setRevealedBySolutionHint(),this.isInSomeTarget()&&this.unsetWrongTargets(),this._makeSpaceForNextAnswer(),this.showAnswer(),this.trigger("changed")},store:function(){return this.currentTarget},restore:function(targets){_(targets).each(function(target){this.setTarget(target)},this)},_extractContentFromNode:function(){return a5.utils.buildContents(this.node,this.interaction,$("<div></div>"))},_createTTSAudio:function(text){return new a5.views.TTS_Player(text)}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSSortingElement"),a5.models.interaction.OSSortingTarget={init:function(parameters){this._super(parameters,{identifier:null,title:"",node:"",interaction:null}),this.buildTitle(),this.parent.addTarget(this)},buildTitle:function(){return this.title=this._extractContentFromNode(),this.title},_extractContentFromNode:function(){return a5.utils.buildContents(this.node,this.interaction,$("<h1></h1>"))}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSSortingTarget"),a5.models.interaction.OSSortingElementRepository={getElements:function(){return this._elements||(this._elements=[])},add:function(element){this.getElements().push(element),element.bind("changed",_.bind(this.onElementChanged,this,element))},merge:function(element){var existing=this.findByElement(element);existing.length?_.first(existing).merge(element):this.add(element)},first:function(){return _(this.getElements()).first()},findByTarget:function(target){return this._filterElements(function(e){return e.isInTarget(target)})},findPrefilledByTarget:function(target){return this._filterElements(function(e){return e.isPrefilled()&&e.isInCorrectTarget(target)})},findRevealedByTarget:function(target){return this._filterElements(function(e){return e.isRevealed()&&e.isInCorrectTarget(target)})},findExpectedByTarget:function(target){return this._filterElements(function(e){return e.isInCorrectTarget(target)})},findCorrect:function(){return this._filterElements(function(e){return!e.isPrefilled()&&e.isCorrect()})},findWrong:function(){return this._filterElements(function(e){return!e.isPrefilled()&&e.isWrong()})},findMissing:function(){return this._filterElements(function(e){return!e.isPrefilled()&&e.isMissing()})},findDistractor:function(){return this._filterElements(function(e){return!e.isPrefilled()&&e.isDistractor()})},findByElement:function(element){return this._filterElements(function(e){return e.isEqualTo(element)})},findAll:function(){return this._filterElements(function(e){return!e.isPrefilled()&&!e.isDistractor()})},getTotalCorrect:function(){return _(this.getElements()).reduce(function(memo,element){return memo+element.countCorrect()},0)},getTotalWrong:function(){return _(this.getElements()).reduce(function(memo,element){return memo+element.countWrong()},0)},getTotalMissing:function(){return _(this.getElements()).reduce(function(memo,element){return memo+element.countMissing()},0)},getTotalDistractor:function(){return this.findDistractor().length},getTotal:function(){return _(this.getElements()).reduce(function(memo,element){return memo+element.countTotal()},0)},onElementChanged:function(element){element.parent.notifyValueChange(),this.trigger("element:changed",element)},_filterElements:function(criteria){return _(this.getElements()).filter(criteria,this)}},Obj.extend("a5.models.interaction.OSSortingElementRepository"),a5.views.interaction.OSSortingView={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="dds_view"></div>')),this.align=this.interaction.options.getPoolAlignment(),this.model.bind("state_update",this.onStateUpdated,this),this.model.bind("next",this.showNext,this)},render:function(){this._super(),this.node.empty();var $pool=this.pool.render(),$targets=this.targets.render();return this.node.append($pool),this.node.append($targets),"bottom"===this.align&&this.node.append($pool),this.node},onStateUpdated:function(){this.vent.trigger("state:changed",this.model.state)}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingView"),a5.views.interaction.OSSortingElementView={currentTarget:null,init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="drag_item os-sorting-element"></div>')),this.model.bind("state_update",this.onStateUpdated,this),this.model.bind("move_to_pool",this.moveToPool,this),this.model.bind("input_update:setAnswer",this.onSetAnswerInput,this),_.bindAll(this,"beforeStart","_onBodyMousedown","_onBodyMousemove","onStart","onStop","onDrag")},merge:function(elementView){this.model.merge(elementView.model)},copy:function(){return(!this.model.isMulti||!!this.currentTarget)&&this||new a5.views.interaction.OSSortingElementView({interaction:this.interaction,model:this.model,vent:this.vent})},setTarget:function(target){this.currentTarget=target},unsetTarget:function(){this.currentTarget=null},getElementIdentifier:function(){return this.model.identifier},render:function(){this._super(),a5.service.media.pause(this.node);var $text=this.model.buildText();return this.node.html($text),this.node.find(".has_audio_attached").toggleClass("no-label",!$text.text()),this.node.find("div:not(.image-as-trigger) > img").parent().addClass("image-div"),this.node.find("div > .image-as-trigger").parent().addClass("image-div"),this.model.parent.isDrag()&&this._createDraggable(),this.disable(),this.model.isPrefilled()?this.node.addClass("prefilled"):"input"===this.model.state?(this.node.attr("tabindex",0),this.enable()):this.node.removeAttr("tabindex"),this._updateState(),this._setData(),this.deactivateDropOver(),this.model.bind("selected",_.bind(this.onSelected,this)),this.model.bind("deselected",_.bind(this.onDeselected,this)),this.node},enable:function(){this.model.parent.isDrag()?this._enableDraggable():this.model.parent.isTapTarget()?this._bindTapTargetEvents():this.model.parent.isTapItem()&&this._bindTapItemEvents()},disable:function(){this.model.parent.isDrag()?this._disableDraggable():this.model.parent.isTapTarget()?this._unbindTapTargetEvents():this.model.parent.isTapItem()&&this._unbindTapItemEvents()},onSelected:function(e){this.model.parent.selectedView===this&&this.node.addClass("selected")},onDeselected:function(e){this.node.removeClass("selected")},hasElement:function(element){return this.model===element},activateDropOver:function(){this._hasToShowDropIndicator()&&(this.node.addClass("is-active-target-source dragging_over"),this.interaction.$(".is-content-zone").addClass("drop_indicator"))},deactivateDropOver:function(){this._hasToShowDropIndicator()&&(this.node.removeClass("is-active-target-source dragging_over"),this.interaction.$(".is-content-zone").removeClass("drop_indicator"))},updateFeedbackState:function(){this.lastState!==this.model.state&&this.currentTarget&&(this.checkLocked(),this.lastState=this.model.state),this.node.removeClass("checked-empty checked-incorrect checked-correct"),this.node.removeClass("solution-empty solution-incorrect solution-correct solution-revealed");var type;if(this.model.isRevealedBySeeNext())return void this.node.addClass("solution-revealed");if("feedback"===this.model.state)type="checked";else{if("answers"!==this.model.state)return;type="solution"}this.model.isCorrect(this.currentTarget)?this.node.addClass([type,"correct"].join("-")):this.model.isMissing(this.currentTarget)?this.node.addClass([type,"empty"].join("-")):this.node.addClass([type,"incorrect"].join("-"))},onStateUpdated:function(){this.render()},onSetAnswerInput:function(){this.node.find(".check").remove(),this.updateFeedbackState(this.node),this._setAnswer(this._hasToShowChecksForFeedback()&&this.model.isInSomeTarget())},_updateState:function(){this.node.find(".check").remove(),this.updateFeedbackState(this.node),"answers"===this.model.state?this._showAnswer():"feedback"===this.model.state?this._setAnswer(this._hasToShowChecksForFeedback()):this._tryAgain()},_setAnswerInput:function(){this._hasToShowChecksForFeedback()&&this.model.isFilled();this._setAnswer()},_tryAgain:function(){this.isLocked()&&this.disable()},_hasToShowChecksForFeedback:function(){return!this.model.isPrefilled()&&(this.currentTarget||this.model.isMissing())},_hasToShowChecksForAnswers:function(){return!this.model.isPrefilled()&&!this.model.isDistractor()&&!!this.currentTarget},_setAnswer:function(check){check&&(this.addCheck({correct:this.model.isCorrect(this.currentTarget),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect(this.currentTarget)}))},_showAnswer:function(){this._hasToShowChecksForAnswers()&&(this.addCheck({correct:this.model.isCorrect(this.currentTarget),empty:this.model.isMissing(this.currentTarget)&&(!this.model.isRevealedBySeeNext()||"feedback"!==this.model.parent.state),tooltip:this.model.getAnswerFeedback()}),this.showAnswerFeedback||this.bindAnswerFeedback(this.model,{correct:this.model.isCorrect(this.currentTarget)}))},_setData:function(){this.node.data("mvc-view",this)},_createDraggable:function(){this.model.isPrefilled()||this.node.draggable($.extend({revert:"invalid",disabled:!0,delay:150,revertDuration:350,start:this.onStart,stop:this.onStop,drag:this.onDrag,helper:this._createHelper,appendTo:"body",containment:"document",cancel:".checked-correct-locked",beforeStart:this.beforeStart,scope:"screen-"+this.interaction.index},a5.utils.getDraggableOptions(this.interaction)))},_enableDraggable:function(){this.model.isPrefilled()||this.node.draggable("enable")},_disableDraggable:function(){this.model.isPrefilled()||this.node.draggable("disable")},_bindTapTargetEvents:function(){this._bindMoveToPoolEvents(),this._unbindTapTargetEvents(),this.node.on("click touchend",_.bind(this.onClickTapTarget,this)),this.node.on("keydown",_.bind(this.onKeydownTapTarget,this))},_bindTapItemEvents:function(){this._unbindTapItemEvents(),this.node.on("click",_.bind(this.onClickTapItem,this)),this.node.on("keydown",_.bind(this.onKeydownTapItem,this))},_bindMoveToPoolEvents:function(){this._unbindMoveToPoolEvents(),this.hammer=new Hammer.Manager(this.node[0],{});var doubleTap=new Hammer.Tap({event:"doubletap",taps:2});this.hammer.add(doubleTap),this.hammer.on("doubletap",_.bind(this.onDoubleTap,this)),this.node.on("keydown",_.bind(this.onKeydownMoveToPool,this))},_unbindTapTargetEvents:function(){this._unbindMoveToPoolEvents(),this.node.off("click touchend keydown")},_unbindTapItemEvents:function(){this.node.off("click keydown")},_unbindMoveToPoolEvents:function(){this.hammer&&this.hammer.destroy(),this.node.off("keydown")},onDoubleTap:function(e){this.moveToPool()},onKeydownMoveToPool:function(e){var key=e.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.moveToPool()},moveToPool:function(){this.currentTarget?(this.model.isMulti&&this.node.detach(),this.model.unsetTarget(this.currentTarget,!1)):this.model.unsetTarget(null,!1),this.model.parent.deselect()},isInPool:function(){return!!this.node.parents(".wordpool").length},isAppendedTo:function(node){return this.model.isMulti?node.find(".os-sorting-element[data-model-id="+this.node.attr("data-model-id")+"]").length:this.node.parent().is(node)},onClickTapItem:function(e){this.activateTapItem()},onKeydownTapItem:function(e){var key=e.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.activateTapItem()},activateTapItem:function(){if("input"===this.model.state)if(this.isInPool()){var except=this.model.currentTarget,smallestTarget=this.model.parent.getSmallestTarget(except);smallestTarget&&this.model.setTarget(smallestTarget)}else this.model.isMulti&&this.node.detach(),this.model.unsetTarget(this.currentTarget,!1)},onClickTapTarget:function(e){this.activateTapTarget()},onKeydownTapTarget:function(e){var key=e.which;key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.activateTapTarget()},activateTapTarget:function(){var curSelected=this.model.parent.getSelected();"input"===this.model.state&&curSelected!=this.model&&this.setSelected()},setSelected:function(){$(document).off("mousedown touchstart",this._onBodyMousedown),$(document).off("keydown",this._onBodyKeydown),this.vent.unbind("pool:element:emptyactivate",this._onPoolEmptyActivate),this.model.parent.setSelected(this.model,this),this.vent.bind("pool:element:emptyactivate",this._onPoolEmptyActivate,this),$(document).on("mousedown touchstart",this._onBodyMousedown),$(document).on("keydown",this,this._onBodyKeydown)},_onPoolEmptyActivate:function(e){this.model.parent.selected&&e.pool.recieveElement(this.model.parent.selected)},_onBodyClick:function(e){$(e.target).is(".drop_zone")||$(e.target).is(".drop_item_zone")||0!==$(e.target).parents(".drag_item").length||e.data.model.parent.deselect()},_onBodyMousedown:function(){$(document).on("click touchend",this,this._onBodyClick),$(document).on("mousemove touchmove",this._onBodyMousemove)},_onBodyMousemove:function(){$(document).off("click touchend",this._onBodyClick),$(document).off("mousemove touchmove",this._onBodyMousemove)},_onBodyKeydown:function(e){var key=e.which;key!==a5.utils.keyCodes.ESCAPE&&(e.data.node[0]===e.target||key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER)||e.data.model.parent.deselect()},_createHelper:function(){var $this=$(this),$clone=$this.addClass("ui-draggable-dragging").clone();return $this.removeClass("ui-draggable-dragging"),a5.dp.config.ossortingCloneCss&&($clone.copyCSS(this),$clone.find("> div").copyCSS($(this).find("> div")),$clone.find("img").copyCSS($(this).find("img")),$clone.find(".drag_audio_player").copyCSS($(this).find(".drag_audio_player"))),$clone},beforeStart:function(e,ui){this.node.find(".check").remove()},onStart:function(e,ui){this.model.isMulti&&!this.currentTarget||this.node.hide(),this.node.draggable("option","scroll",!1),this.lastY=null},onStop:function(e,ui){this.model.isMulti&&!this.currentTarget||this.node.show()},onDrag:function(e,ui){this._adjustVerticalScrollSensitivity(this.lastY,e.pageY,e.clientY),this.lastY=e.pageY},_adjustVerticalScrollSensitivity:function(lastY,currentY,clientY){var currentScrollSensitivity=this.node.draggable("option","scrollSensitivity"),newScrollSensitivity=20;this._isMovingDown(lastY,currentY)&&this._touchBottom(clientY)&&(newScrollSensitivity+=a5.dp.config.exclusionBottom),currentScrollSensitivity!==newScrollSensitivity&&this.node.draggable("option","scrollSensitivity",newScrollSensitivity),this._touchTop(clientY)||this._touchBottom(clientY)||this.node.draggable("option","scroll",!0)},_touchBottom:function(clientY){return clientY>$(window).height()-20-a5.dp.config.exclusionBottom},_touchTop:function(clientY){return clientY<20+a5.dp.config.exclusionTop},_isMovingDown:function(lastY,currentY){return lastY&&currentY>lastY},_hasToShowDropIndicator:function(){return this.interaction.options.dropIndicatorIsTrue()}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingElementView"),a5.views.interaction.OSSortingElementPoolView={init:function(args){_.extend(this,args),this._super(null,null,$('<div class="drop_item_zone"></div>')),_(this.elements).each(function(element){element.bind("changed",this.onElementChanged,this)},this),_.bindAll(this,"onDrop","onDropOut","onDropOver","onPoolClick","onPoolKeydown"),this.node.on("click",this.onPoolClick),this.node.on("keydown",this.onPoolKeydown)},onPoolClick:function(e){this.isEmpty()&&this.activate()},onPoolKeydown:function(e){var key=e.which;!this.isEmpty()||key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.activate()},activate:function(){this.vent.trigger("pool:element:emptyactivate",{element:this.elements[0],elementView:this._getElementView(this.elements[0]),pool:this})},render:function(){return this._super(),!this.stackable&&this.isPrefilled()&&this.node.hide(),this._renderElementsIfBelongsToPool(),this._createDroppable(),this.node.toggleClass("stacked",this.stackable),this.node.toggleClass("has_drag_item",this._hasElements()),this.isEmpty()?this.node.attr("tabindex",0):this.node.removeAttr("tabindex"),this.node},isEmpty:function(){return!this._hasElements()},isPrefilled:function(){return this.elements.length>0&&_.all(this.elements,function(element){return element.isPrefilled()})},add:function(element){this.interaction.options.randomiseanswersIsTrue()?this._addRandom(element):this.push(element)},merge:function(element){this._findByElement(element).merge(element)},remove:function(element){this.elements=_(this.elements).without(element)},push:function(element){this.elements.push(element)},pop:function(){return this.elements.pop()},hasElement:function(element){return _.contains(this.elements,element)},hasElementByText:function(element){
return _.some(this.elements,function(e){return e.isEqualTo(element)})},onElementChanged:function(){this.render()},onDrop:function(e,ui){var elementView=ui.draggable.data("mvc-view"),element=elementView.model;ui.draggable.detach(),ui.draggable.css({left:"",top:"",width:"",height:"",bottom:"",right:""}),elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),this.vent.trigger("pool:element:dropped",{srcElement:element,dstElementPool:this})},onDropOut:function(){this._draggingElement&&_(this._draggingElement.deactivateDropOver).isFunction()&&this._draggingElement.deactivateDropOver()},onDropOver:function(event,ui){this._draggingElement=ui.draggable.data("mvc-view"),this._draggingElement&&_(this._draggingElement.activateDropOver).isFunction()&&this._draggingElement.activateDropOver()},recieveElement:function(element){var view=this._getElementView(element);this.node.append(view.render()),view.currentTarget&&element.unsetTarget(view.currentTarget),this.vent.trigger("pool:element:dropped",{srcElement:element,dstElementPool:this})},_renderElementsIfBelongsToPool:function(){_(this.elements).each(function(element){element.belongsToPool()&&this._renderElement(element)},this)},_renderElement:function(element){var elementView=this._getElementView(element),alreadyRendered=elementView.isAppendedTo(this.node);elementView&&(elementView.unsetTarget(),alreadyRendered||this.node.append(elementView.render()))},_getElementView:function(element){return this.elementViewRepository.getElementView(element)},_createDroppable:function(){var config={drop:this.onDrop,out:this.onDropOut,over:this.onDropOver,accept:_.bind(function(el){var elementView=el.data("mvc-view");return this.stackable||this._acceptDrop(elementView&&elementView.model)},this),greedy:!0,tolerance:"pointer",scope:"screen-"+this.interaction.index};this._hasToShowDropIndicator()?_(config).extend({hoverClass:"drop-indicator hovered"}):_(config).extend({hoverClass:"hwb"}),this.node.droppable(config)},_acceptDrop:function(element){return _.all(this.elements,function(element){return!element.belongsToPool()})||_.contains(this.elements,element)},_hasToShowDropIndicator:function(){return this.interaction.options.dropIndicatorIsTrue()},_addRandom:function(element){var pos=Math.floor(Math.random()*(this.elements.length+1));this.elements.splice(pos,0,element)},_hasElements:function(){return _(this.elements).some(function(element){return element.belongsToPool()})},_findByElement:function(element){return _(this.elements).find(function(e){return e.isEqualTo(element)})}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingElementPoolView"),a5.views.interaction.OSSortingElementTargetView={init:function(args){_.extend(this,args),this._super(null,null,$("<li></li>"))},hasElement:function(element){return this.elementView.hasElement(element)},render:function(){return this._super(),this._renderElementView(),this.node},_renderElementView:function(){this.elementView&&this.node.html(this.elementView.render())}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingElementTargetView"),a5.views.interaction.OSSortingElementTargetZoneView={init:function(params){_.extend(this,params),this._super({},this.parent,$('<div class="drop_item_zone"></div>')),_.bindAll(this,"onDrop","onDropOut","onDropOver"),this.mainModel=this.parent.model.parent},render:function(){return this._super(),this.node.empty(),this._renderElement(),this.mainModel.isDrag()&&this._bindDragEvents(),this.mainModel.isTapTarget()&&this._bindTapTargetEvents(),this.node.toggleClass("has_drag_item",!this.isEmpty()),this.isEmpty()&&this.node.attr("tabindex",0),this.node},refresh:function(){this._renderElement(),this.node.toggleClass("has_drag_item",!this.isEmpty()),this.isEmpty()?this.node.attr("tabindex",0):this.node.removeAttr("tabindex")},renderEnumeration:function(){var ret=this.enumeration&&$('<div class="enumanswer"></div>');return ret&&(ret.html('<span class="enum-placeholder"></span>'),this.enumeration.then(function(enumSymbol){ret.find(".enum-placeholder").replaceWith(enumSymbol)})),ret},getElement:function(){return this.element},setElement:function(element){this.element=element},unsetElement:function(){this.element=null},hasElement:function(element){return this.element===element},isEmpty:function(){return!this.element},onDrop:function(e,ui){var elementView=ui.draggable.data("mvc-view"),element=elementView.model;ui.draggable.detach(),ui.draggable.css({left:"",top:"",width:"",height:"",bottom:"",right:""}),elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),this.vent.trigger("target:zone:dropped",{target:this.parent,zone:this,element:element,from:elementView.currentTarget})},onDropOut:function(){this._draggingElement&&_(this._draggingElement.deactivateDropOver).isFunction()&&this._draggingElement.deactivateDropOver()},onDropOver:function(event,ui){this._draggingElement=ui.draggable.data("mvc-view"),this._draggingElement&&_(this._draggingElement.activateDropOver).isFunction()&&this._draggingElement.activateDropOver()},_renderElement:function(){var elementView=this._getElementView(),node=this.node.find(".os-sorting-element");if(elementView){elementView=elementView.copy();elementView.isAppendedTo(this.node)||(elementView.setTarget(this._getTargetIdentifier()),this.node.html(elementView.node),elementView.render())}else node.length&&node.remove()},_getElementView:function(){return this.element&&this.elementViewRepository.getElementView(this.element)},_bindTapTargetEvents:function(){this.node.off("click keydown"),this.node.on("click",_.bind(this.onClick,this)),this.node.on("keydown",_.bind(this.onKeydown,this))},onClick:function(e){if($(e.target).is(this.node)){this.mainModel.getSelected()&&this._doTargetMove()}},onKeydown:function(e){var key=e.which;e.target!==this.node[0]||key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this.mainModel.getSelected()&&this._doTargetMove()},_doTargetMove:function(){var element=this.mainModel.getSelected(),elementView=this.mainModel.getSelectedView();elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),this.mainModel.deselect(),this.vent.trigger("target:zone:dropped",{target:this.parent,zone:this,element:element,from:elementView.currentTarget})},_bindDragEvents:function(){var config={drop:this.onDrop,out:this.onDropOut,over:this.onDropOver,accept:_.bind(function(el){return el.is(".drag_item")&&this._acceptDrop(el)},this),tolerance:"pointer",scope:"screen-"+this.interaction.index};this._hasToShowDropIndicator()?_(config).extend({hoverClass:"drop-indicator hovered"}):_(config).extend({hoverClass:"hwb"}),this.$().droppable(config)},_acceptDrop:function(el){var elementView=el.data("mvc-view"),element=elementView.model;return this.isEmpty()&&(elementView.currentTarget===this.parent.getTargetIdentifier()||!this.parent.hasElement(element))},_getTargetIdentifier:function(){return this.parent.getTargetIdentifier()},_hasToShowDropIndicator:function(){return this.interaction.options.dropIndicatorIsTrue()}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingElementTargetZoneView"),a5.views.interaction.OSSortingPoolView={POOL_HANDLE_TEMPLATE:"a5.view.WordpoolDragHandle",init:function(args){_.extend(this,args),this._super(null,null,$('<div class="dds_wordpool_view"></div>')),this._renderPoolOnce=_.once(this._renderPool),this.children=[],this.align=this.interaction.options.getPoolAlignment(),this.vent.bind("pool:element:dropped",this.onPoolElementViewDropped,this),this.elementRepository.bind("element:changed",this.onElementChanged,this),this.vent.bind("state:changed",this.onStateChanged,this),this.stack_counter=0,_.bindAll(this,"onDrop","onDropOut","onDropOver")},add:function(element){var elementPoolView;if(!this._hasStacks()||this.children.length<this._getNumberOfStacks())elementPoolView=this._createElementPoolView(element),this.interaction.options.randomiseanswersIsTrue()?this._addRandom(elementPoolView):this.children.push(elementPoolView);else{var stack=this.stack_counter++%this._getNumberOfStacks();elementPoolView=this.children[stack],elementPoolView.add(element)}},merge:function(element){var existing=this._getElementPoolViewByText(element);existing?existing.merge(element):this.add(element)},render:function(){return this.interaction.trigger("before:pool:rendered"),this._renderPoolOnce(),this.renderChildren(".elements"),this.interaction.trigger("pool:rendered"),this.node},onStateChanged:function(state){this.render()},onElementChanged:function(element){var ele=this._getElementPoolView(element);this.render(),_.defer(_.bind(function(){this.interaction.trigger("pool:changed",ele?ele.node:ele)},this))},onPoolElementViewDropped:function(options){var srcElement=options.srcElement,dstElementPool=options.dstElementPool;this._hasStacks()?this._stackElement(srcElement,dstElementPool):this._swapElementPositions(srcElement,dstElementPool),this.render()},onDrop:function(e,ui){var elementView=ui.draggable.data("mvc-view"),element=elementView.model;ui.draggable.detach(),ui.draggable.css({left:"",top:""}),elementView.currentTarget&&element.unsetTarget(elementView.currentTarget)},onDropOut:function(){},onDropOver:function(event,ui){},_renderPool:function(){var $pool=$('<div class="wordpool"><div class="elements pool"></div></div>');if($pool.addClass(this.align),"free"===this.align){var html=a5.service.templates.render(this.POOL_HANDLE_TEMPLATE),$handle=$(html);$handle.on("click",".reset_position",function(){$handle.find(".reset_position").addClass("hidden"),$pool.css({top:"",left:""})}),$pool.prepend($handle),$pool.draggable({handle:".drag-handle",cancel:".reset_position",containment:this.interaction.contentWrap,start:function(){$handle.find(".reset_position").removeClass("hidden").show()}})}this._makeDroppable($pool),this.node.html($pool)},_addRandom:function(child){var pos=Math.floor(Math.random()*(this.children.length+1));this.children.splice(pos,0,child)},_swapElementPositions:function(srcElement,dstElementPool){var srcIndex=this._getIndexOfElement(srcElement),dstIndex=this._getIndexOfElementPool(dstElementPool);a5.utils.array.swap(this.children,srcIndex,dstIndex)},_stackElement:function(srcElement,dstElementPool){var srcIndex=this._getIndexOfElement(srcElement);this.children[srcIndex].remove(srcElement),dstElementPool.push(srcElement)},_getIndexOfElement:function(element){return _(this.children).findIndex(function(elementPoolView){return elementPoolView.hasElement(element)})},_getIndexOfElementPool:function(elementPool){return this.children.indexOf(elementPool)},_createElementPoolView:function(element){return new a5.views.interaction.OSSortingElementPoolView({vent:this.vent,interaction:this.interaction,elements:[element],elementViewRepository:this.elementViewRepository,stackable:this._hasStacks()})},_makeDroppable:function($pool){var config={drop:this.onDrop,out:this.onDropOut,over:this.onDropOver,accept:_.bind(function(el){var elementView=el.data("mvc-view");return this._acceptDrop(elementView)},this),scope:"screen-"+this.interaction.index};$pool.droppable(config)},_acceptDrop:function(elementView){return elementView&&!!elementView.currentTarget},_hasStacks:function(){return this._getNumberOfStacks()>0},_getNumberOfStacks:function(){var stacks=parseInt(this.interaction.options.getPoolStacks(),10);return _.isNumber(stacks)&&!_.isNaN(stacks)&&stacks||0},_getElementPoolViewByText:function(element){return _.find(this.children,function(elementPoolView){return elementPoolView.hasElementByText(element)})},_getElementPoolView:function(element){return _.find(this.children,function(elementPoolView){return elementPoolView.hasElement(element)})}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingPoolView"),a5.views.interaction.OSSortingTargetsView={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="dds_target_view"></div>')),this.children=[]},add:function(child){this.children.push(child)},size:function(){return this.children.length},render:function(){return this._super(),this.node.empty(),this.renderChildren(),this.node}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingTargetsView"),a5.views.interaction.OSSortingTargetViewWithoutZones={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="drop_zone"><div class="elements"></div></div>')),this._renderTitleOnce=_.once(this._renderTitle),this._renderContainerImageOnce=_.once(this._renderContainerImage),this.mainModel=this.model.parent,this.children=[],this.elementRepository.bind("element:changed",this.onElementChanged,this),this.vent.bind("state:changed",this.onStateChanged,this),_.bindAll(this,"onDrop","onDropOut","onDropOver"),this._setupGapfillBehavior()},_setupGapfillBehavior:function(){this.mainModel.isTapTarget()&&(this._bindTapEvents(),this.node.attr("tabindex",0)),this.mainModel.isTapItem()&&this.node.addClass("ui-droppable")},getTargetIdentifier:function(){return this.model.identifier},render:function(){return this._renderTitleOnce(),this._renderContainerImageOnce(),this._syncElementsFromRepository(),this._removeElementViews(),this._addElementViews(),this.mainModel.isDrag()&&this._createDroppable(),this.node},onElementChanged:function(element){this.render()},onStateChanged:function(state){this.state=state,this.render()},onDrop:function(e,ui){var elementView=ui.draggable.data("mvc-view"),element=elementView.model;ui.draggable.detach(),ui.draggable.css({left:"",top:"",width:"",height:"",bottom:"",right:""}),elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),element.setTarget(this.getTargetIdentifier())},onDropOut:function(){this._draggingElement&&_(this._draggingElement.deactivateDropOver).isFunction()&&this._draggingElement.deactivateDropOver()},onDropOver:function(event,ui){this._draggingElement=ui.draggable.data("mvc-view"),this._draggingElement&&_(this._draggingElement.activateDropOver).isFunction()&&this._draggingElement.activateDropOver()},_renderTitle:function(){var $title=this.model.buildTitle();this.node.prepend($title)},_getElementView:function(element){return element&&this.elementViewRepository.getElementView(element)},_addElementView:function(element){var elementView=this._getElementView(element);if(elementView=elementView.copy()){elementView.isAppendedTo(this.$(".elements"))||(elementView.setTarget(this.getTargetIdentifier()),this.$(".elements").append(elementView.node),elementView.render())}},_addElementViews:function(){_.each(this.elements,function(element){this._addElementView(element)},this)},_removeElementView:function(element){var elementView=this._getElementView(element);if(elementView){this.$(".elements").find(".os-sorting-element[data-model-id="+elementView.node.attr("data-model-id")+"]").remove()}},_removeElementViews:function(){_.each(this.elementsToRemove,function(element){this._removeElementView(element)},this)},_removeElements:function(elements){this.elements=_(this.elements).difference(elements)},_addElements:function(elements){this.elements=this.elements.concat(elements)},_syncElementsFromRepository:function(){var elementsToRemove,elementsToAdd,elementsInTarget=this._findAllElements(),elementsInRepository=this._findAllElementsFromRepository();elementsToRemove=_(elementsInTarget).difference(elementsInRepository),elementsToAdd=_(elementsInRepository).difference(elementsInTarget),this._removeElements(elementsToRemove),this._addElements(elementsToAdd),this.elementsToRemove=elementsToRemove},_findAllElements:function(){return this.elements},_findAllElementsFromRepository:function(){return"answers"===this.state?this._getExpectedElements():this._getPrefilledElements().concat(this._getCurrentElements().concat(this._getRevealedElements()))},_getCurrentElements:function(){return this.elementRepository.findByTarget(this.getTargetIdentifier())},_getRevealedElements:function(){return this.elementRepository.findRevealedByTarget(this.getTargetIdentifier())},_getExpectedElements:function(){return this.elementRepository.findExpectedByTarget(this.getTargetIdentifier())},_getPrefilledElements:function(){return this.elementRepository.findPrefilledByTarget(this.getTargetIdentifier())},_wrapElementView:function(elementView){return new a5.views.interaction.OSSortingElementTargetView({elementView:elementView})},_createDroppable:function(){var config={drop:this.onDrop,out:this.onDropOut,over:this.onDropOver,accept:_.bind(function(el){return el.is(".drag_item")&&!this._hasElementView(el.data("mvc-view"))},this),tolerance:"pointer",scope:"screen-"+this.interaction.index};this._hasToShowDropIndicator()?_(config).extend({hoverClass:"drop-indicator hovered"}):_(config).extend({hoverClass:"hwb"}),this.$().droppable(config)},_bindTapEvents:function(){this.node.addClass("ui-droppable"),this.node.off("click"),this.node.on("click",_.bind(this.onClick,this)),this.node.on("keydown",_.bind(this.onKeydown,this))},onClick:function(e){$(e.target).is(this.node)&&this.mainModel.getSelected()&&this._doItemMove()},onKeydown:function(e){var key=e.which;e.target!==this.node[0]||!this.mainModel.getSelected()||key!==a5.utils.keyCodes.SPACE&&key!==a5.utils.keyCodes.ENTER||this._doItemMove()},_doItemMove:function(){var element=this.mainModel.getSelected(),elementView=this.mainModel.getSelectedView();elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),element.setTarget(this.getTargetIdentifier()),this.mainModel.deselect()},_doTargetMove:function(){var element=this.mainModel.getSelected(),elementView=this.mainModel.getSelectedView();elementView.currentTarget&&element.unsetTarget(elementView.currentTarget),element.setTarget(this.getTargetIdentifier()),this.mainModel.deselect()},_renderContainerImage:function(){var image=$(this.containerImage);image.length&&(this.node.addClass("has_container_image"),this.node.css({backgroundImage:"url("+image.attr("src")+")",backgroundRepeat:"no-repeat",minWidth:image.width()+"px",width:image.width()+"px",minHeight:image.height()+"px"}))},_hasElementView:function(elementView){var element;return elementView&&(element=elementView.model)&&element.isInTarget(this.getTargetIdentifier())},_hasToShowDropIndicator:function(){return this.interaction.options.dropIndicatorIsTrue()}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingTargetViewWithoutZones"),a5.views.interaction.OSSortingTargetViewWithZones={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="drop_zone"><div class="elements"></div></div>')),this._renderTitleOnce=_.once(this._renderTitle),this._renderContainerImageOnce=_.once(this._renderContainerImage),this._renderTargetZonesOnce=_.once(this._renderTargetZones),this.children=[],this._addTargetZones(),this.elementRepository.bind("element:changed",this.onElementChanged,this),this.vent.bind("target:zone:dropped",this.onTargetZoneDropped,this),this.vent.bind("state:changed",this.onStateChanged,this)},render:function(){return this._renderTitleOnce(),this._renderContainerImageOnce(),this._renderTargetZonesOnce(),this._syncElementsFromRepository(),this._refreshTargetZones(),this.node},getTargetIdentifier:function(){return this.model.identifier},hasElement:function(element){return _(this.children).some(function(zone){return zone.hasElement(element)})},onElementChanged:function(){this.render()},onStateChanged:function(state){this.state=state,this.render()},onTargetZoneDropped:function(params){var element=params.element,zone=params.zone,target=params.target;params.from===this&&this._unsetElementFromAllZones(element),target===this&&(zone.setElement(element),element.setTarget(this.getTargetIdentifier()))},_renderTitle:function(){var $title=this.model.buildTitle();this.node.prepend($title)},_addTargetZones:function(){_(this.maxZones).times(function(){var zoneView=new a5.views.interaction.OSSortingElementTargetZoneView({parent:this,interaction:this.interaction,vent:this.vent,elementRepository:this.elementRepository,elementViewRepository:this.elementViewRepository,enumeration:this._nextEnumeration()});this.children.push(zoneView)},this)},_renderTargetZones:function(){_(this.children).each(function(child){this.$(".elements").append(child.renderEnumeration()),this.$(".elements").append(child.render())},this)},_refreshTargetZones:function(){_.invoke(this.children,"refresh")},_wrapElementView:function(elementView){return new a5.views.interaction.OSSortingElementTargetView({elementView:elementView})},_renderContainerImage:function(){var image=$(this.containerImage);image.length&&(this.node.addClass("has_container_image"),this.node.css({backgroundImage:"url("+image.attr("src")+")",backgroundRepeat:"no-repeat",minWidth:image.width()+"px",width:image.width()+"px",minHeight:image.height()+"px"}))},_unsetElementFromAllZones:function(element){_(this.children).chain().filter(function(zone){return zone.hasElement(element)}).invoke("unsetElement")},_unsetElementsFromAllZones:function(elements){_(elements).each(this._unsetElementFromAllZones,this)},_addElementsToEmptyZones:function(elements){_(this.children).chain().filter(function(zone){return zone.isEmpty()}).first(elements.length).each(function(zone,index){zone.setElement(elements[index])})},_nextEnumeration:function(){return this.interaction.enumAnswers.next()},_syncElementsFromRepository:function(){var elementsToRemove,elementsToAdd,elementsInZones=this._findAllElementsFromZones(),elementsInRepository=this._findAllElementsFromRepository();elementsToRemove=_(elementsInZones).difference(elementsInRepository),elementsToAdd=_(elementsInRepository).difference(elementsInZones),this._unsetElementsFromAllZones(elementsToRemove),this._addElementsToEmptyZones(elementsToAdd)},_findAllElementsFromZones:function(){return _(this.children).chain().reject(function(zone){return zone.isEmpty()}).invoke("getElement").value()},_findAllElementsFromRepository:function(){return"answers"===this.state?this._getExpectedElements():this._getPrefilledElements().concat(this._getCurrentElements().concat(this._getRevealedElements()))},_getCurrentElements:function(){return this.elementRepository.findByTarget(this.getTargetIdentifier())},_getExpectedElements:function(){return this.elementRepository.findExpectedByTarget(this.getTargetIdentifier())},_getRevealedElements:function(){return this.elementRepository.findRevealedByTarget(this.getTargetIdentifier())},_getPrefilledElements:function(){return this.elementRepository.findPrefilledByTarget(this.getTargetIdentifier())}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSSortingTargetViewWithZones"),a5.views.interaction.OSSortingElementViewRepository={init:function(args){_.extend(this,args)},add:function(elementView){this._getElements()[elementView.getElementIdentifier()]=elementView},merge:function(elementView){var existing=this.findByElement(elementView.model);existing.length?_.first(existing).merge(elementView):this.add(elementView)},getElementView:function(element){return this._getElements()[element.identifier]},findByTarget:function(target){return this._findElementViewsBy("findByTarget",target)},findPrefilledByTarget:function(target){return this._findElementViewsBy("findPrefilledByTarget",target)},findExpectedByTarget:function(target){return this._findElementViewsBy("findExpectedByTarget",target)},findByElement:function(element){return this._findElementViewsBy("findByElement",element)},_getElements:function(){return this.elements||(this.elements={})},_findElementViewsBy:function(criteria){var args=_(arguments).rest(),method=this.elementRepository[criteria],ret=_(method.apply(this.elementRepository,args)).map(function(element){return this.getElementView(element)},this);return _.compact(ret)}},Obj.extend("a5.views.interaction.OSSortingElementViewRepository"),a5.views.interaction.OSSortingTargetViewFactory={init:function(params){_.extend(this,_(params).pick("interaction","responses","vent"))},createTargetView:function(params){return this._hasTargetZones()?this._createTargetViewWithZones(params):this._createTargetViewWithoutZones(params)},_createTargetViewWithZones:function(params){var model=params.model,maxZones=this._calculateMaxZones(model);return model.maxZones=maxZones,new a5.views.interaction.OSSortingTargetViewWithZones(_(params).extend({interaction:this.interaction,vent:this.vent,maxZones:maxZones}))},_createTargetViewWithoutZones:function(params){return new a5.views.interaction.OSSortingTargetViewWithoutZones(_(params).extend({interaction:this.interaction,vent:this.vent}))},_calculateMaxZones:function(model){var responses=this._extractResponsesFromModel(model);return responses?responses.length:0},_extractResponsesFromModel:function(model){return this.responses.asInverseMap()[model.identifier]},_hasTargetZones:function(){return this.interaction.options.targetzonesIsTrue()}},Obj.extend("a5.views.interaction.OSSortingTargetViewFactory"),a5.model_builder.OSNumberStacksBuilder={isResponsible:function(node,interaction){return"Order:Sort:Number stacks"===interaction.identifier&&node.is("matchInteraction, simpleMatchSet, simpleAssociableChoice")&&interaction.resourcesPanel},buildMatchInteraction:function(interaction,parentNode,node){this.vent=this._createEventBus(),this.model=this._createModel(interaction),this.buildContents(node,interaction,parentNode),this.view=this._createView(interaction),parentNode.append(this.view.node),this.view.render(),interaction.blockItems.add(this.model),interaction.resourcesPanel&&interaction.resourcesPanel.addActivity(this.view)},buildSimpleMatchSet:function(interaction,parentNode,node){this.buildContents(node,interaction,parentNode)},buildSimpleAssociableChoice:function(interaction,parentNode,node){if(this._isNodeForTargetBuilding(node)){var target=this._createTarget(interaction,parentNode,node);this.model.addTarget(target)}},_createEventBus:function(){return new Obj},_createModel:function(interaction){return new a5.models.interaction.OSNumberStacksPanBalance({interaction:interaction})},_createView:function(interaction){return new a5.views.interaction.OSNumberStacksPanBalance({model:this.model,vent:this.vent,interaction:interaction})},_createTarget:function(interaction,parentNode,node){return new a5.models.interaction.OSNumberStacksTarget({identifier:node.attr("identifier"),interaction:interaction,correct:this._extractValue(node)})},_isNodeForTargetBuilding:function(node){return a5.utils.startsWith(node.attr("identifier"),"T")},_extractValue:function(node){var value,jsonString=node.attr("data-author");try{value=JSON.parse(jsonString).value}catch(e){logger.warn("Invalid JSON value for node",node[0])}return value||0}},a5.model_builder.Base.extend("a5.model_builder.OSNumberStacksBuilder"),a5.model_builder.builders.push(new a5.model_builder.OSNumberStacksBuilder),a5.models.interaction.OSNumberStacks={init:function(parameters){this._super(parameters,{interaction:null}),this.targets=[]},addTarget:function(target){this.targets.push(target)},getTargets:function(){return this.targets}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacks"),a5.models.interaction.OSNumberStacksPanBalance={threshold:3,init:function(parameters){this._super(parameters,{interaction:null}),this.targets=[],this.panState="balanced"},addTarget:function(target){this.targets.push(target),target.bind("change",this._onChange,this)},getTargets:function(){return this.targets},getPanLeft:function(){return this.targets[0]},getPanRight:function(){return this.targets[1]},getPanState:function(){return this.panState},updatePanState:function(){var panLeft=this.getPanLeft(),panRight=this.getPanRight(),leftValue=panLeft.getValue(),rightValue=panRight.getValue();leftValue===rightValue?this.panState="balanced":leftValue<rightValue&&rightValue-leftValue<=this.threshold?this.panState="left-high":leftValue<rightValue&&rightValue-leftValue>this.threshold?this.panState="left-highest":rightValue<leftValue&&leftValue-rightValue<=this.threshold?this.panState="left-low":rightValue<leftValue&&leftValue-rightValue>this.threshold&&(this.panState="left-lowest")},store:function(){var targets={};return _.each(this.targets,function(target){targets[target.identifier]=target.store()}),{targets:targets}},restore:function(data){_.each(this.targets,function(target){target.restore(data.targets[target.identifier])}),this.trigger("restore")},_onChange:function(){this.updatePanState(),this.trigger("change")}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacksPanBalance"),a5.models.interaction.OSNumberStacksTarget={init:function(parameters){this._super(parameters,{identifier:null,interaction:null,correct:0,value:0}),this.items=[]},add:function(item){this.items.push(item);var v=item.getValue();v=_.isNumber(v)?v:0,this.value+=v,this.trigger("change")},remove:function(item){if(_.contains(this.items,item)){this.items=_.without(this.items,item);var v=item.getValue();v=_.isNumber(v)?v:0,this.value-=v,this.trigger("change")}},empty:function(){this.items=[]},getValue:function(){return this.value},updateValue:function(){this.value=_.reduce(this.items,function(memo,item){var v=item.getValue();return v=_.isNumber(v)?v:0,memo+v},0)},getItems:function(){return this.items},isCorrect:function(){return this.value===this.correct},restore:function(object){this.empty();var banks=this.interaction.resourcesPanel.banks;_.each(object.items,function(item){var bankItem=banks.findItemById(item.bankItemId);bankItem&&"keypad"!==item.type&&(item.inline=bankItem.inline);var stageItem;stageItem="numeral-cards"===item.type?new a5.model.CardStageItem(item):new a5.model.ResourceStageItem(item),this.add(stageItem)},this)},store:function(){return{items:_.invoke(this.items,"serialize")}}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacksTarget"),a5.views.interaction.OSNumberStacks={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="os-number-stacks"></div>')),this.children=this._initTargets()},render:function(){return this.node.empty(),this.renderChildren(),this.node},_initTargets:function(){var targets=this.model.getTargets();return _.map(targets,function(target){return new a5.views.interaction.OSNumberStacksTarget({model:target,vent:this.vent,interaction:this.interaction})},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacks"),a5.views.interaction.OSNumberStacksPanBalance={template:"a5.views.interaction.OSNumberStacksPanBalance",init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="pan-balance-wrapper"></div>')),this.panLeft=new a5.views.interaction.OSNumberStacksPan({model:this.model.getPanLeft(),vent:this.vent,interaction:this.interaction,balance:this}),this.panRight=new a5.views.interaction.OSNumberStacksPan({model:this.model.getPanRight(),vent:this.vent,interaction:this.interaction,balance:this}),this.model.bind("change",this._onChange,this),this.model.bind("restore",this._onRestore,this)},removeItemById:function(id){this.panLeft.removeItemById(id),this.panRight.removeItemById(id)},contains:function($el){return this.panLeft.contains($el)||this.panRight.contains($el)},render:function(){var html=a5.service.templates.render(this.template);return this.node.html(html),this.$(".pan-left").append(this.panLeft.node),this.$(".pan-right").append(this.panRight.node),this.panLeft.render(),this.panRight.render(),this.$panBalance=this.node.find(".pan-balance"),this.node},_onChange:function(){this.$panBalance.removeClass("balanced left-low left-lowest left-high left-highest"),this.$panBalance.addClass(this.model.getPanState())},_onRestore:function(){this.panLeft.refresh(),this.panRight.refresh()}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksPanBalance"),a5.views.interaction.OSNumberStacksTarget={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="os-number-stacks-target"></div>'))},render:function(){return this.node.empty(),this.node}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksTarget"),
a5.views.interaction.OSNumberStacksPan={init:function(args){_.extend(this,args),this._super(this.model,null,$('<div class="os-number-stacks-pan"></div>')),_.bindAll(this,"_onDrop","_onItemDragStart","_onItemDrag","_onItemDragStop"),this.node.on("drop",this._onDrop),this.node.on("dragstart","> .resource-stage-item",this._onItemDragStart),this.node.on("drag","> .resource-stage-item",this._onItemDrag),this.node.on("dragstop","> .resource-stage-item",this._onItemDragStop),this.interaction.resourcesPanel.bind("delete-all",this._onDeleteAll,this),this.children=[]},render:function(){return this.node.empty(),this._makeDroppable(),this._createGrid(),this.node},region:function(){return this.node},refresh:function(){_.invoke(this.children,"remove"),this.children=[],_.each(this.model.getItems(),function(item){this.addItem(item)},this)},addItem:function(item){var resourceStageItem=new a5.view.ResourceStageItem({item:item,interaction:this.interaction});return this.region().append(resourceStageItem.$el),item.cssmatrix=resourceStageItem.$el.transformationMatrix(),resourceStageItem.render(),this.children.push(resourceStageItem),resourceStageItem},removeItem:function(itemView){itemView.remove();var index=this.children.indexOf(itemView);index>=0&&this.children.splice(index,1),this.model.remove(itemView.item)},removeItemById:function(id){var itemView=this._getItemById(id);itemView&&this.removeItem(itemView)},removeAll:function(){var items=this.children.slice(0);_.each(items,function(itemView){this.removeItem(itemView)},this)},contains:function($el){return $el.closest(this.region()).length>0},_onItemDragStart:function(e,ui){this.matrix=this.node.transformationMatrix(!0),this.scale=this.matrix.getScale(),this.draggedItem=this._getItemById(ui.helper.attr("data-item-id")),this.origin={sx:ui.offset.left,sy:ui.offset.top}},_onItemDrag:function(e,ui){this.sdx=ui.offset.left-this.origin.sx,this.sdy=ui.offset.top-this.origin.sy;var bounds=this.interaction.resourcesPanel.resourcesStageView.$el[0].getBoundingClientRect(),box=ui.helper[0].getBoundingClientRect();this.origin.sx+this.sdx<bounds.left?this.sdx=bounds.left-this.origin.sx:this.origin.sx+this.sdx+box.width>bounds.right&&(this.sdx=bounds.right-this.origin.sx-box.width),this.origin.sy+this.sdy<bounds.top?this.sdy=bounds.top-this.origin.sy:this.origin.sy+this.sdy+box.height>bounds.bottom&&(this.sdy=bounds.bottom-this.origin.sy-box.height),ui.position.left=(this.origin.sx+this.sdx-this.node.offset().left)/this.scale,ui.position.top=(this.origin.sy+this.sdy-this.node.offset().top)/this.scale},_onItemDragStop:function(e,ui){},_onDrop:function(e,ui){if(e.stopPropagation(),this.contains(ui.helper)&&!this._isInEdges(ui.helper)){var snap=this.interaction.resourcesPanel.resourcesStage.generalGrid.snap({x:this.dx,y:this.dy});return void this.draggedItem.moveEnd(snap)}this.balance.contains(ui.helper)&&this.balance.removeItemById(ui.helper.attr("data-item-id"));var $item=ui.helper;$item.children(":first").is(".resource-item")&&($item=$item.children(":first"));var addBy=1;$item.is(".resource-item")&&(addBy=this.interaction.resourcesPanel.resourcesPanelView.addBy),_.times(addBy,function(n){if($item.hasClass("resource-item-composed"))$item.children("[data-item-id]").each(function(index,el){var $el=$(el);this._addToGrid({id:$el.attr("data-item-id"),bankItemId:$el.attr("data-bank-item-id")})}.bind(this));else if(0===$item.closest(".resource-item-composed").length){var selectedItems=$item.siblings(".ui-selected").addBack();selectedItems.each(function(index,el){var $el=$(el);this._addToGrid({id:$el.attr("data-item-id"),bankItemId:$el.attr("data-bank-item-id"),$el:$el})}.bind(this))}},this),$item.is(".resource-item")&&this.interaction.resourcesPanel.resourcesPanelView.resetAddBy(),this.vent.trigger("item:drop",this,ui.helper)},_onDeleteAll:function(){this.removeAll()},_makeDroppable:function(){this.node.droppable({accept:".resource-item, .resource-stage-item",scope:"resources-"+this.interaction.index,tolerance:"touch",greedy:!0})},_createGrid:function(){this.grid=new a5.ResourcesStageClickToAddGrid({$grid:this.node})},_addToGrid:function(draggedItem){var resourcesPanel=this.interaction.resourcesPanel;resourcesPanel.resourcesStageView.removeItemById(draggedItem.id);var bankItem=resourcesPanel.banks.findItemById(draggedItem.bankItemId),type=bankItem.bank.id,item=new a5.model.ResourceStageItem({path:bankItem.path,inline:bankItem.inline,type:type,value:bankItem.value,bankItemId:bankItem.id});"keypad"===type&&draggedItem.$el&&(item.inline=draggedItem.$el.html());var resourceStageItem=this.addItem(item),matrix=this.region().transformationMatrix(!0),scale=matrix.getScale(),origin={sox:resourceStageItem.$el.position().left,soy:resourceStageItem.$el.position().top};origin.ox=Math.round(10*origin.sox/scale)/10,origin.oy=Math.round(10*origin.soy/scale)/10;var box=resourceStageItem.$el[0].getBoundingClientRect(),size={width:Math.round(box.width/scale),height:Math.round(box.height/scale)},offset=this.grid.relativeTo(this.node),offsetX=Math.round(offset.left/scale),offsetY=Math.round(offset.top/scale),snap=this.grid.snap(size),x=offsetX+snap.x-origin.ox,y=offsetY+snap.y-origin.oy;resourceStageItem.moveTo(x,y),this.model.add(item)},_getItemById:function(id){return _.find(this.children,function(child){return child.hasId(id)})},_isInEdges:function($el){var box=$el[0].getBoundingClientRect(),container=this.node[0].getBoundingClientRect();return box.right>container.right&&box.left<container.right||box.left<container.left&&box.right>container.left||box.bottom>container.bottom&&box.top<container.bottom},_isOutBounds:function($el){var box=$el[0].getBoundingClientRect(),container=this.node[0].getBoundingClientRect();return box.right<container.left||box.left>container.right||box.bottom<container.top||box.top>container.bottom}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksPan"),a5.model_builder.OSNumberStacksActivityBuilder={isResponsible:function(node,interaction){return"Order:Sort:Number stacks"===interaction.identifier&&node.is("matchInteraction, simpleMatchSet, simpleAssociableChoice")&&!interaction.resourcesPanel},_extractValue:function(node){var value,jsonString=node.attr("data-author");try{value=JSON.parse(jsonString).value}catch(e){logger.warn("Invalid JSON value for node",node[0])}return value||0},_serializeXML:function(node){var xmlText="";return xmlText=(new XMLSerializer).serializeToString(node),xmlText.replace(/<simpleAssociableChoice(.*?)>/gi,"").replace(/<\/simpleAssociableChoice>/gi,"")},buildSimpleMatchSet:function(interaction,parentNode,node){this.buildContents(node,interaction,parentNode)},buildSimpleAssociableChoice:function(interaction,parentNode,node){this.buildContents(node,interaction,parentNode)},buildMatchInteraction:function(interaction,parentNode,node){parentNode.addInteractionStyle("drag-drop");var choices=node.find("simpleAssociableChoice").filter(function(i,node){return a5.utils.startsWith($(node).attr("identifier"),"C")}).map(_.bind(function(i,choice){var content=$("<div class='content'></div>");return a5.utils.buildModel(interaction,content,$("<div>"+this._serializeXML(choice)+"</div>",node.ownerDocument)),{identifier:$(choice).attr("identifier"),value:this._extractValue($(choice)),content:content}},this)),targets=node.find("simpleAssociableChoice").filter(function(i,node){return a5.utils.startsWith($(node).attr("identifier"),"T")}).map(_.bind(function(i,target){var content=$("<div class='content'></div>");return a5.utils.buildModel(interaction,content,$("<div>"+this._serializeXML(target)+"</div>",node.ownerDocument)),{identifier:$(target).attr("identifier"),value:this._extractValue($(target)),content:content}},this)),stacks=parseInt(interaction.options.getPoolStacks(),10),model=new a5.models.interaction.OSNumberStacksActivityModel({choices:choices,targets:targets,drag_behavior:interaction.options.getGapfillbehaviour(),pool_alignment:interaction.options.getPoolAlignment(),tryAgainKeep:interaction.options.tryAgainIsKeepall(),stacks:parseInt(interaction.options.getPoolStacks(),10),multidest:interaction.options.multipleDestinationsIsUnlimited()},null,interaction),view=new a5.views.interaction.OSNumberStacksActivityView(model,stacks);$(parentNode).append(view.render()),interaction.blockItems.add(model)}},a5.model_builder.Base.extend("a5.model_builder.OSNumberStacksActivityBuilder"),a5.model_builder.builders.push(new a5.model_builder.OSNumberStacksActivityBuilder),a5.models.interaction.OSNumberStacksActivityModel={init:function(parameters,defaults,interaction){this._super(parameters,$.extend({choices:!1,targets:!1,response:!1,pool_alignment:"none",multidest:!1,stacks:0,tryAgainKeep:!1,drag_behavior:"drag"})),this.parent=interaction,this.poolChoices=new a5.models.interaction.OSNumberStacksActivityTarget({identifier:"POOL-1"},this),this.choices=_.map(this.choices,function(choice){var model=new a5.models.interaction.OSNumberStacksActivityChoice(choice,this);return this.poolChoices.drop(model),model},this),this.targets=_.map(this.targets,function(target){return new a5.models.interaction.OSNumberStacksActivityTarget(target,this)},this)},isDrag:function(){return"drag"===this.drag_behavior},isTapItem:function(){return"tap_item"===this.drag_behavior},isTapTarget:function(){return"tap_target"===this.drag_behavior},getDragByID:function(id){return _.find(this.choices,function(drag){return drag.id===id})},store:function(){return{items:_.map(this.targets,function(target){var data={};return data[target.identifier]=_.pluck(target.residents,"identifier"),data})}},showAnswer:function(){_.invoke(this.targets,"showAnswer"),this._super()},setAnswer:function(){_.invoke(this.targets,"setAnswer"),this._super()},tryAgain:function(){_.invoke(this.targets,"tryAgain"),this._super()},restore:function(data){_.each(data.items,function(target){var target_id=_.keys(target)[0],choice_ids=target[target_id],target_model=_.find(this.targets,function(target){return target_id===target.identifier});_.each(choice_ids,function(choice_id){var choice_model=_.find(this.choices,function(ch){return choice_id===ch.identifier});choice_model&&target_model.drop(choice_model)},this)},this),this.trigger("restore")},getScores:function(){var score=new a5.Score;return _.each(this.targets,function(target){score.incTotal(),target.isCorrect()&&score.incCorrect(),target.isFilled()&&score.incFilled()}),score}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacksActivityModel"),a5.models.interaction.OSNumberStacksActivityChoice={init:function(parameters,parent){this._super(parameters,$.extend({identifier:"",value:0,content:"",parent:parent}))}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacksActivityChoice"),a5.models.interaction.OSNumberStacksActivityTarget={init:function(parameters,parent){this._super(parameters,$.extend({identifier:"",value:0,contents:"",residents:null,parent:parent})),this.residents||(this.residents=[])},isCorrect:function(){return this.getSum()===parseInt(this.value,10)},isFilled:function(){return this.residents&&this.residents.length>0},getSum:function(){return _.reduce(this.residents,function(memo,num){return parseInt(num.value,10)+memo},0)},drop:function(choice){this.residents.push(choice),this.parent.notifyValueChange()},remove:function(choice){this.residents.splice(_.findIndex(this.residents,choice),1),this.parent.notifyValueChange()},tryAgain:function(){this._super(),this.isCorrect()||this.parent.tryAgainKeep||(this.residents=[]),this.parent.notifyValueChange()}},a5.models.interaction.BaseModel.extend("a5.models.interaction.OSNumberStacksActivityTarget"),a5.views.interaction.OSNumberStacksActivityView={NODE_TEMPLATE:'<div class="os-number-stacks-wrapper"></div>',TARGET_ZONE:'<div class="target-zone"></div>',init:function(model,stacks,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.node.append($(this.POOL_TEMPLATE)),this._sortingEnabled=!0,this.targets=_.map(this.model.targets,function(target){return target=new a5.views.interaction.OSNumberStacksActivityTarget(target,this),target.residents&&_.each(target.residents,function(resident){var choice=new a5.views.interaction.OSNumberStacksActivityElement(resident,this);target.drop(choice)},this),target},this),this.pool=new a5.views.interaction.OSNumberStacksActivityPool(this.model.poolChoices,stacks,this),this.node.addClass("wordpool-"+this.model.pool_alignment),this.node.append(this.pool.render()),this.target_zone=$(this.TARGET_ZONE),_.each(this.targets,function(target){this.target_zone.append(target.render())},this),"bottom"===this.model.pool_alignment?this.node.prepend(this.target_zone):this.node.append(this.target_zone),this.model.bind("state_update:answers",this.showAnswers,this),this.model.bind("state_update:input",this.tryAgain,this),this.model.bind("restore",this._restoreResidents,this)},_restoreResidents:function(){_.each(this.targets,function(target){target._restoreResidents()})},getElementByID:function(id){var elements=this.getElementList();return _.find(elements,function(element){return parseInt(element.model.id,10)===parseInt(id,10)})},getElementList:function(){return _.union(_.flatten(_.pluck(this.targets,"residents")),this.pool.residents,this.active_choice?[this.active_choice]:[])},_getItems:function(){var items=_.map(this.model.choices,function(e){var result={};return result[e.id]=parseInt(e.value,10),result});return this.model.multidest&&(items=_.flatten(_.map(items,function(item){return[item,item,item,item,item,item,item,item,item,item]}))),items},showAnswers:function(){this.node.find(".check").remove(),this.disableSorting();var targets=_.sortBy(this.targets,function(target){return parseInt(target.model.value,10)}),items=this._getItems();_.each(targets,function(target){target.addCheck({empty:target.model.residents.length,correct:target.model.isCorrect()}),target.updateFeedbackState(target.node),this.model.multidest&&(items=this._getItems());var solution,targetValue=parseInt(target.model.value,10);if(targetValue>target.model.getSum())solution=a5.utils.knapsack.resolve(targetValue-target.model.getSum(),items);else{if(!(targetValue<target.model.getSum()))return;solution=a5.utils.knapsack.resolve(targetValue,items),_.each(target.residents,function(resident){target.remove(resident),this.pool.drop(resident)},this)}items=_.filter(items,function(item){var key=_.keys(item)[0],solution_keys=_.map(solution,function(s){return _.keys(s)[0]});return!_.contains(solution_keys,key)}),_.each(solution,function(item){item=this.getElementByID(_.keys(item)[0]),item.target.remove(item,!0),target.drop(item,!1,!0)},this)},this)},tryAgain:function(){this.node.find(".check").remove(),this.enableSorting(),_.each(this.getElementList(),function(element){element.target.remove(element,!0),this.pool.drop(element)},this),_.each(this.targets,function(target){target.tryAgain()})},isSortingEnabled:function(){return this._sortingEnabled},disableSorting:function(){this._sortingEnabled=!1,this.model.isDrag()&&this._disableSortingPlugin()},_disableSortingPlugin:function(){this.pool.parent.model.stacks?_.each(this.pool.stacks,function(stack){stack.sortable("option","disabled",!0)},this):this.pool.pool.sortable("option","disabled",!0),_.each(this.targets,function(target){target.pool.sortable("option","disabled",!0)},this)},enableSorting:function(){this._sortingEnabled=!0,this.model.isDrag()&&this._enableSortingPlugin()},_enableSortingPlugin:function(){this.pool.parent.model.stacks?_.each(this.pool.stacks,function(stack){stack.sortable("option","disabled",!1)},this):this.pool.pool.sortable("option","disabled",!1),_.each(this.targets,function(target){target.pool.sortable("option","disabled",!1)},this)}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksActivityView"),a5.views.interaction.OSNumberStacksActivityPool={NODE_TEMPLATE:'<div class="ddns_wordpool_view os-number-stacks-pool">',POOL_TEMPLATE:'<div class="pool"></div>',STACK_TEMPLATE:'<div class="drop_item_zone stacked"></div>',init:function(model,stacks,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.pool=$(this.POOL_TEMPLATE),this.node.append(this.pool),this.residents=[],this.stacks=[],_.each(this.model.residents,function(choice){choice=new a5.views.interaction.OSNumberStacksActivityElement(choice,this.parent),this.drop(choice)},this),this.node.addClass("wordpool-"+this.parent.model.pool_alignment)},drop:function(choice,dont_render){if(!dont_render)if(this.parent.model.stacks){var stack=this._getSmallestStack();stack&&stack.append(choice.render())}else this.pool.append(choice.render());return this.residents.push(choice),choice.setTarget(this),choice},_getSmallestStack:function(){var stackBySize=_.map(this.stacks,function(stack){return{size:stack.children().length,node:stack}}),sorted=_.sortBy(stackBySize,function(stack){return stack.size});if(!_.isEmpty(sorted))return _.first(sorted).node},remove:function(choice,dont_detach_node){return this.residents=_.without(this.residents,choice),dont_detach_node||choice.node.detach(),choice},render:function(){return this._super(),this.parent.model.stacks?this._render_stacks():this._render_normal(),this.node},_render_normal:function(){_.each(this.residents,function(choice){this.pool.append(choice.render())},this),this.pool.sortable({disabled:!this.parent.model.isDrag(),start:_.bind(function(e,ui){this.parent.model.multidest&&ui.item.show()},this),receive:_.bind(this.onReceive,this),remove:_.bind(this.onRemove,this),helper:"clone"}),this.pool.sortable("option","connectWith",".drop_zone .drop_item_zone, .pool .drop_item_zone")},_render_stacks:function(){_.times(this.parent.model.stacks,function(){var stack=this._init_stack();this.stacks.push(stack),this.pool.append(stack)},this),_.each(this.residents,function(choice,i){this.stacks[i%this.stacks.length].append(choice.render())},this)},_init_stack:function(){var stack=$(this.STACK_TEMPLATE);return stack.sortable({disabled:!this.parent.model.isDrag(),receive:_.bind(this.onReceive,this),remove:_.bind(this.onRemove,this)}),stack.sortable("option","connectWith",".drop_zone .drop_item_zone, .pool .drop_item_zone"),stack},onReceive:function(event,ui){if(this.parent.model.multidest){var id=$(ui.item).attr("data-model");this.node.find("[data-model="+id+"]").length&&ui.item.remove()}else{var item=this.parent.getElementByID($(ui.item).attr("data-model"));this.model.drop(item.model),this.drop(item,!0)}},onRemove:function(event,ui){var item=this.parent.getElementByID($(ui.item).attr("data-model"));if(this.model.remove(item.model),this.parent.active_choice=this.remove(item,!0),this.parent.model.multidest)return ui.item.clone(!0).appendTo(ui.item.parent()),!1}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksActivityPool"),a5.views.interaction.OSNumberStacksActivityTarget={NODE_TEMPLATE:'<div class="drop_zone os-number-stacks-target">',HEADER_TEMPLATE:"<h1>",POOL_TEMPLATE:'<div class="drop_item_zone">',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.pool=$(this.POOL_TEMPLATE),this.header=$(this.HEADER_TEMPLATE),this.header.html(model.content),this.residents=[],this.node.append(this.header),this.node.append(this.pool),this.model.parent.bind("state_update:feedback",this.setAnswer,this),this.bindEvents()},bindEvents:function(){this.parent.model.isTapItem()&&this.bindTapItem()},bindTapItem:function(){this.pool.on("click",_.bind(function(e){if(this.parent.isSortingEnabled()&&$(e.target).parents(".drag_element").length>0){var drag_element=$(e.target).parents(".drag_element"),drag_id=drag_element.data("model-id"),drag=this.parent.getElementByID(drag_id);drag_element.data("clone")?(drag_element.remove(),drag.target.model.remove(drag.model)):(drag.target.remove(drag),drag.target.model.remove(drag.model),this.parent.pool.drop(drag))}},this))},setAnswer:function(){this.node.find(".check").remove(),this.parent.disableSorting(),this.addCheck({correct:this.model.isCorrect()}),this.updateFeedbackState(this.node)},tryAgain:function(){this.pool.find("[data-clone=true]").remove(),this.node.find(".drag_element").remove(),_.each(this.model.residents,function(item){item=this.parent.getElementByID(item.id);var multidest=this.model.parent.multidest;this.drop(item,!1,multidest)},this),this.updateFeedbackState(this.node)},_restoreResidents:function(){_.each(this.model.residents,function(item){item=this.parent.getElementByID(item.id);var multidest=this.model.parent.multidest;this.drop(item,!1,multidest)},this)},drop:function(choice,dont_render,clone){if(!dont_render){var $choice=choice.render();clone&&($choice=$choice.clone(),$choice.attr("data-clone",!0)),this.pool.append($choice)}return this.residents.push(choice),choice.setTarget(this),choice},remove:function(choice,dont_detach_node){if(this.residents=_.without(this.residents,choice),!dont_detach_node){choice.node.detach();this.node.find("[data-model="+choice.model.id+"]").detach()}return choice},render:function(){return this.pool.sortable({disabled:!this.parent.model.isDrag(),receive:_.bind(this.onReceive,this),remove:_.bind(this.onRemove,this)}),this.pool.sortable("option","connectWith",".ddns_wordpool_view .pool,.wordpool .pool .drop_item_zone, .drop_zone .drop_item_zone"),this._super()},onReceive:function(event,ui){var item=this.parent.getElementByID($(ui.item).attr("data-model"));this.model.drop(item.model),this.drop(item,!0)},onRemove:function(event,ui){var item=this.parent.getElementByID($(ui.item).attr("data-model"));this.model.remove(item.model),this.remove(item,!0),this.parent.active_choice=this.remove(item,!0)}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksActivityTarget"),a5.views.interaction.OSNumberStacksActivityElement={NODE_TEMPLATE:'<div class="drag_element os-number-stacks-element">',init:function(model,parent){this._super(model,parent,$(this.NODE_TEMPLATE)),this.node.html(this.model.content),this.bindEvents()},bindEvents:function(){this.parent.model.isTapItem()&&this.bindTapItem()},bindTapItem:function(){this.node.click(_.bind(function(e){if(this.parent.isSortingEnabled()){var target=_.first(this.parent.targets);target.drop(this,!1,this.parent.model.multidest),target.model.drop(this.model)}},this))},render:function(){return this.node.attr("data-model",this.model.id),this._super()},setTarget:function(target){this.target=target,this.model.target=target.model}},a5.views.interaction.BaseView.extend("a5.views.interaction.OSNumberStacksActivityElement"),a5.model_builder.ICDialogueRecording={isResponsible:function(node,interaction){return"Input:Creative:Dialogue recording"===interaction.identifier&&node.is("#contentblock")},buildDiv:function(interaction,parentNode,node){new a5.views.interaction.ICDialogueRecording({characters:this._extractCharacters(node,interaction.options.getSetUserRole()),dialogues:this._extractDialogues(node),hideLinesEnabled:interaction.options.hidelinesIsOn(),downloadAudioEnabled:interaction.options.downloadaudioIsOn(),playAllEnabled:interaction.options.playallIsOn(),originalAudioPlayback:interaction.options.getOriginalAudioPlayback(),interaction:interaction}).render()},_extractCharacters:function(node,userRole){var characters=node.find(".character");return _.map(characters,function(characterNode,i){var $character=$(characterNode);return{label:$character.attr("label"),id:$character.attr("id"),photoUrl:A5.ASSET_URL_BUILDER($character.find("> img").attr("src")),disabled:0!==i&&"role_1"===userRole||1!==i&&"role_2"===userRole}})},_extractDialogues:function(node){var dialogues=node.find(".dialogue");return _.map(dialogues,function(dialogueNode){var $dialogue=$(dialogueNode);return{audioId:$dialogue.find('> [type="audio/audio"]').attr("data"),id:$dialogue.attr("id"),characterId:$dialogue.attr("class").split(" ")[1],content:a5.utils.serializeXML($dialogue.find("> div").get(0))}})}},a5.model_builder.Base.extend("a5.model_builder.ICDialogueRecording"),a5.views.interaction.ICDialogueRecording={template:"a5.views.interaction.DialogueRecording",init:function(parameters){_.extend(this,parameters),this.$el=this.interaction.$(".interaction"),this._initDialogues(),_.bindAll(this,"_onClickRole","_onClickHideLines","_onClickHideAll","_onClickDownloadAll"),this.$el.on("click",".role",this._onClickRole),this.$el.on("click",".btn-hide-lines",this._onClickHideLines),this.$el.on("click",".btn-hide-all",this._onClickHideAll),this.$el.on("click",".btn-download-all",this._onClickDownloadAll),this.speakingRecordingInstances={}},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());this.$el.append($(html).html()),"non_selected_role_only"===this.originalAudioPlayback&&this.$el.addClass("original-audio-for-non-selected-role"),this._renderListenAndRecord(),this.playAllEnabled&&this._renderPlayAll();var roleId=_.find(this.characters,{disabled:!1}).id;this._selectRole(roleId)},serializeData:function(){return{hideLinesEnabled:this.hideLinesEnabled,downloadAudioEnabled:this.downloadAudioEnabled,playAllEnabled:this.playAllEnabled,roles:this.characters,dialogues:this.dialogues}},_onClickRole:function(e){e.preventDefault();var $btn=$(e.currentTarget);if(!$btn.is(".disabled")){var roleId=$btn.attr("id");this._selectRole(roleId),this._refreshDialogues()}},_onClickHideLines:function(e){e.preventDefault();var $btn=$(e.currentTarget);this._toggleHideLines(!$btn.is(".active")),this._toggleHideAll(!1),this._refreshDialogues()},_onClickHideAll:function(e){e.preventDefault();var $btn=$(e.currentTarget);this._toggleHideAll(!$btn.is(".active")),this._toggleHideLines(!1),this._refreshDialogues()},_onClickDownloadAll:function(e){e.preventDefault(),this._askSaveAsFilenameAndDownload()},_toggleHideAll:function(active){this.$el.toggleClass("hide-all-lines",active),this.$el.find(".btn-hide-all").toggleClass("active",active)},_toggleHideLines:function(active){this.$el.toggleClass("hide-my-lines",active),this.$el.find(".btn-hide-lines").toggleClass("active",active)},_initDialogues:function(){_.each(this.dialogues,function(dialogue){dialogue.role=this._findCharacterById(dialogue.characterId)},this)},_refreshDialogues:function(){this.$el.find(".dialogue").removeClass("hidden-line"),this.$el.is(".hide-all-lines")?this.$el.find(".dialogue").addClass("hidden-line"):this.$el.is(".hide-my-lines")&&this.$el.find(".dialogue.role-active").addClass("hidden-line")},_findCharacterById:function(id){return _.find(this.characters,function(character){return character.id===id})},_selectDialoguesByRole:function(roleId){this.$el.find(".dialogue.role-active").removeClass("role-active"),this.$el.find("[data-role-id="+roleId+"]").addClass("role-active")},_enableRecordingsByRole:function(roleId){_.each(a5.speaking_recording.LNRInstancesPerInteraction[this.interaction.index],function(speakingRecordingView){speakingRecordingView.disableRecording(),speakingRecordingView.enableListening()},this),_.each(this.speakingRecordingInstances[roleId],function(speakingRecordingView){speakingRecordingView.enableRecording(),speakingRecordingView.isRecordingEnabled()&&speakingRecordingView.disableListening()},this)},_selectRole:function(roleId){this.$el.find(".role.active").removeClass("active"),this.$el.find("#"+roleId).addClass("active");var roleClasses=_.map(this.characters,function(character){return"role-"+character.id});this.$el.removeClass(roleClasses.join(" ")),this.$el.addClass("role-"+roleId),this._selectDialoguesByRole(roleId),this._enableRecordingsByRole(roleId)},_renderListenAndRecord:function(){_.each(this.dialogues,function(dialogue){this._renderRecorder(dialogue),this._renderAudioPlayer(dialogue)},this)},_renderAudioPlayer:function(dialogue){var $dialogue=this.$el.find("#"+dialogue.id),$player=$dialogue.find(".player");$player.addClass("playbutton");var hasPauseBehaviour=this.interaction.options.audioiconbehaviourIsPause();$player.toggleClass("show-pause-on-playing",hasPauseBehaviour),a5.service.media.audio.bind("ready",function(){var playing=!1,tinyAudio=a5.service.media.audio.create(dialogue.audioId,{preload:!a5.dp.config.audioPreloadDisabled});$player.attr("data-playable-media",tinyAudio.uid),a5.dp.config.audioPreloadDisabled&&this.interaction.preloadAudio(tinyAudio),tinyAudio.bind("paused",function(){$dialogue.removeClass("is-playing"),$player.removeClass("playing"),playing=!1,a5.eventBus.trigger("ic-dialogue:player:state:changed",$player.get(0),"paused")}),tinyAudio.bind("stopped",function(){$dialogue.removeClass("is-playing"),$player.removeClass("playing"),playing=!1,a5.eventBus.trigger("ic-dialogue:player:state:changed",$player.get(0),"stopped")}),tinyAudio.bind("start",function(){$dialogue.addClass("is-playing"),$player.addClass("playing"),playing=!0,a5.eventBus.trigger("ic-dialogue:player:state:changed",$player.get(0),"playing")}),$player.on("click",function(e){playing?hasPauseBehaviour?tinyAudio.pause():tinyAudio.stop():(a5.service.media.pauseAllExcept(tinyAudio),tinyAudio.play()),e.stopPropagation()}),$player.removeClass("inactive")})},_renderRecorder:function(dialogue){var $dialogue=this.$el.find("#"+dialogue.id),$root=$dialogue.find(".recorder"),model=new a5.models.interaction.ICDialogueRecording({parent:this.interaction,downloadEnabled:!1,listenEnabled:!1,nopause:!0,audioID:dialogue.audioId}),view=new a5.views.interaction.SpeakingRecording(model);view.bind("state:changed",function(state,recState){$dialogue.toggleClass("is-playing","playback"===state&&"playing"===recState),$dialogue.toggleClass("is-recording","recording"===recState),$dialogue.toggleClass("has-recording",model.records.length>0),this.$el.toggleClass("recording-in-progress","recording"===recState),view.isRecordingEnabled()&&view.disableListening(),recState&&a5.eventBus.trigger("ic-dialogue:recorder:state:changed",$root.get(0),recState)},this),$root.append(view.render()),_.isUndefined(this.speakingRecordingInstances[dialogue.role.id])&&(this.speakingRecordingInstances[dialogue.role.id]=[]),this.speakingRecordingInstances[dialogue.role.id].push(view),this.interaction.blockItems.add(model)},_renderPlayAll:function(){var $root=this.$el.find(".play-all"),playAll=new a5.speaking_recording.PlayAllView(this.interaction.index,this.interaction.index);playAll.bind("state:changed",function(state){$root.toggleClass("is-playing","playing"===state),"playing"!==state||this.firstPlayAll||(this._setAllFilled(),this.firstPlayAll=!0)},this);var $playAll=playAll.render();$root.append($playAll.contents())},_askSaveAsFilenameAndDownload:function(){var $dialog=a5.view.dialog.display("a5.view.dialog.RecordingSaveAs",{filename:A5.DEFAULT_SAVEAS_FILENAME},{ok:_.bind(function(){this._downloadAll($dialog.find("#downloadFilename").val())},this)})},_downloadAll:function(filename){var inputs=[],clips=[],recordingViews=a5.speaking_recording.LNRInstancesPerInteraction[this.interaction.index];_.each(this.dialogues,function(dialogue,index){var recordingView=recordingViews[index];recordingView.isListeningEnabled()&&(inputs.push(a5.utils.getAbsoluteURL(a5.service.media.audio.buildUrl(dialogue.audioId,"mp3"))),clips.push({input:inputs.length-1})),recordingView.isRecordingEnabled()&&_.each(recordingView.model.records[0],function(snippet){inputs.push(a5.service.media.audio_recorder.instance().buildUrl(snippet)),clips.push({input:inputs.length-1})},this)},this),a5.service.toolbelt.audioDownload({inputs:inputs,clips:clips,output:filename})},_setAllFilled:function(){_.chain(this.speakingRecordingInstances).values().flatten().pluck("model").invoke("setFilled"),this.interaction.items.notifyFillChange("all")}},Obj.extend("a5.views.interaction.ICDialogueRecording"),a5.models.interaction.ICDialogueRecording={setFilled:function(){this.filled=!0},isFilled:function(){return this.filled}},a5.models.interaction.SpeakingRecording.extend("a5.models.interaction.ICDialogueRecording"),a5.model_builder.ISHangman={isResponsible:function(node,interaction){return"Identify:Select:Hangman"===interaction.identifier&&node.is("#content, textEntryInteraction")},buildDiv:function(interaction,parentNode,node){
if(node.is("#content")){this.words=[],this.vent=new Obj,this._super(interaction,parentNode,node);var model=new a5.model.interaction.ISHangman({words:_.pluck(this.words,"model"),scoreValueIs1PerQuestion:interaction.options.scoreValuesIs1_point_question()});new a5.view.ISHangman({$el:interaction.$(".interaction"),words:this.words,vent:this.vent,$content:parentNode.contents(),model:model,lives:parseInt(interaction.options.getNumberofchances(),10),showAnswerAuto:interaction.options.revealSolutionIsAfter_final_chance()}).render(),interaction.blockItems.add(model)}else this._super(interaction,parentNode,node)},buildTextEntryInteraction:function(interaction,parentNode,node){var response=interaction.getCorrectResponse(node.attr("responseIdentifier")),word=_.first(response.values),model=new a5.model.interaction.ISHangmanWord({text:word}),view=new a5.view.ISHangmanWord({model:model,vent:this.vent});this.words.push(view),parentNode.append(view.$el),view.render()}},a5.model_builder.Content.extend("a5.model_builder.ISHangman"),a5.view.ISHangman={template:"a5.view.interaction.ISHangman",init:function(parameters){this.model=parameters.model,this.$el=parameters.$el,this.vent=parameters.vent,this.words=parameters.words,this.$content=parameters.$content,this.showAnswerAuto=parameters.showAnswerAuto,this.errorCounter=new a5.model.ISHangmanErrorCounter({total:parameters.lives}),this.vent.bind("success:key",this._onSuccessKey,this),this.vent.bind("wrong:key",this._onWrongKey,this),this.errorCounter.bind("change",this._onErrorChange,this),this.model.bind("restore",this._onRestore,this),this.model.bind("state_update:answers",this.showAnswer,this),this.model.bind("state_update:input",this.tryAgain,this)},render:function(){var html=a5.service.templates.render(this.template);return this.$el.append($(html).html()),this.board=new a5.view.ISHangmanBoard({model:this.model,$el:this.$el.find(".is-hangman-board"),$content:this.$content,vent:this.vent,words:this.words}),this.board.render(),this.keyboard=new a5.view.ISHangmanKeyboard({$el:this.$el.find(".is-hangman-keyboard"),vent:this.vent}),this.keyboard.render(),this.lifeFeedback=new a5.view.ISHangmanLifeFeedback({$el:this.$el.find(".is-hangman-life-feedback"),errorCounter:this.errorCounter}),this.lifeFeedback.render(),this.lifeCounter=new a5.view.ISHangmanLifeCounter({$el:this.$el.find(".is-hangman-life-counter"),errorCounter:this.errorCounter}),this.lifeCounter.render(),this.$el},showAnswer:function(){this.keyboard.disable(),this.board.showAnswer()},tryAgain:function(){this.errorCounter.reset(),this.board.reset(),this.keyboard.reset(),this.renderGameStart()},renderGameOver:function(){this.keyboard.disable(),this.$el.addClass("is-hangman-game-over"),this.skipValidation||(a5.mainBuilder.checkAnswer(),this.showAnswerAuto&&a5.mainBuilder.showAnswer())},renderGameCompleted:function(){this.keyboard.disable(),this.$el.addClass("is-hangman-game-completed"),this.skipValidation||(a5.mainBuilder.checkAnswerWithFeedbackAllCorrect(),this.showAnswerAuto&&a5.mainBuilder.showAnswer())},renderGameStart:function(){this.$el.removeClass("is-hangman-game-completed"),this.$el.removeClass("is-hangman-game-over")},_onErrorChange:function(cur,prev){this.$el.removeClass("is-hangman-life-"+prev),this.$el.addClass("is-hangman-life-"+cur)},_onWrongKey:function(){this.errorCounter.increase(),a5.eventBus.trigger("is-hangman:failure"),this.errorCounter.count===this.errorCounter.total&&this.renderGameOver()},_onSuccessKey:function(){a5.eventBus.trigger("is-hangman:success"),this.board.revealed&&this.renderGameCompleted()},_onRestore:function(){this.skipValidation=!0,_.each(this.model.attemptedLetters,function(c){this.keyboard.hit(c)},this),this.skipValidation=!1}},Obj.extend("a5.view.ISHangman"),a5.view.ISHangmanBoard={init:function(parameters){this.model=parameters.model,this.$el=parameters.$el,this.$content=parameters.$content,this.vent=parameters.vent,this.words=parameters.words,this.vent.bind("hit:key",this._onHitKey,this)},render:function(){return this.$el.append(this.$content),this.$el},test:function(c){if(!this.revealed){var found=!1;_.each(this.words,function(word){var letters=word.test(c);_.isEmpty(letters)||(found=!0,word.reveal(letters))}),this.model.test(c),_.all(this.words,function(word){return word.revealed})&&(this.revealed=!0),found?this.vent.trigger("success:key",c):this.vent.trigger("wrong:key",c)}},reveal:function(){this.revealed=!0,_.invoke(this.words,"reveal")},showAnswer:function(){this.revealed=!0,_.invoke(this.words,"showAnswer")},reset:function(){this.revealed=!1,_.invoke(this.words,"reset")},_onHitKey:function(key){this.test(key.value)}},Obj.extend("a5.view.ISHangmanBoard"),a5.view.ISHangmanWord={template:"a5.view.interaction.ISHangmanWord",init:function(parameters){this.$el=$('<div class="is-hangman-word"></div>'),this.model=parameters.model,this.vent=parameters.vent,this.word=this.model.text},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html($(html).html()),this.letters=_.map(this.word,function(letter,index){return new a5.view.ISHangmanLetter({$el:this.$el.find(".is-hangman-letter").eq(index),value:letter,vent:this.vent})},this),_.invoke(this.letters,"render"),this.$el},serializeData:function(){return{letters:_.range(this.word.length)}},test:function(c){var letters=[];return this.revealed||(letters=_.filter(this.letters,function(letter){return letter.test(c)})),letters},reveal:function(letters){letters=letters||this.letters,_.invoke(letters,"reveal"),_.all(this.letters,function(letter){return letter.revealed})&&(this.$el.addClass("is-hangman-word-revealed"),this.revealed=!0,this.model.reveal())},showAnswer:function(){_.invoke(this.letters,"showAnswer"),this.$el.addClass("is-hangman-word-answer"),this.revealed=!0},reset:function(){_.invoke(this.letters,"reset"),this.$el.removeClass("is-hangman-word-revealed"),this.$el.removeClass("is-hangman-word-answer"),this.revealed=!1}},Obj.extend("a5.view.ISHangmanWord"),a5.view.ISHangmanLetter={init:function(parameters){this.$el=parameters.$el,this.value=parameters.value,this.vent=parameters.vent},render:function(){return this.$el},test:function(c){return a5.utils.removeAccents(this.value.toLowerCase())===a5.utils.removeAccents(c.toLowerCase())&&!this.revealed},reveal:function(){this.$el.addClass("is-hangman-letter-revealed"),this.$el.text(this.value),this.revealed=!0},showAnswer:function(){this.revealed||(this.$el.addClass("is-hangman-letter-empty"),this.$el.text(this.value),this.revealed=!0,this.vent.trigger("empty:key",this.value))},reset:function(){this.$el.removeClass("is-hangman-letter-revealed"),this.$el.removeClass("is-hangman-letter-empty"),this.$el.text(""),this.revealed=!1}},Obj.extend("a5.view.ISHangmanLetter"),a5.view.ISHangmanKeyboard={init:function(parameters){this.$el=parameters.$el,this.vent=parameters.vent,this._initKeys()},render:function(){return this.$el},enable:function(){_.invoke(this.keys,"enable")},disable:function(){_.invoke(this.keys,"disable")},reset:function(){_.invoke(this.keys,"reset")},hit:function(c){var key=this._findKey(c);key&&key.hit()},_findKey:function(value){return this.keys.find(function(key){return key.value===value})},_initKeys:function(){this.keys=[],this.$el.find(".is-hangman-key").each(function(index,key){var $key=$(key),keyView=new a5.view.ISHangmanKey({$el:$key,value:$key.attr("data-char"),vent:this.vent});this.keys.push(keyView)}.bind(this))}},Obj.extend("a5.view.ISHangmanKeyboard"),a5.view.ISHangmanKey={init:function(parameters){this.$el=parameters.$el,this.value=parameters.value,this.vent=parameters.vent,this.vent.bind("success:key",this._onSuccessKey,this),this.vent.bind("wrong:key",this._onWrongKey,this),this.vent.bind("empty:key",this._onEmptyKey,this),_.bindAll(this,"_onClick"),this.enable()},hit:function(){this.attempted||(this.attempted=!0,this.$el.addClass("is-hangman-key-attempted"),this.vent.trigger("hit:key",this))},reset:function(){this.attempted=!1,this.$el.removeClass("is-hangman-key-attempted"),this.$el.removeClass("is-hangman-key-correct"),this.$el.removeClass("is-hangman-key-incorrect"),this.$el.removeClass("is-hangman-key-empty"),this.enable()},enable:function(){this.$el.on("click",this._onClick)},disable:function(){this.$el.off("click",this._onClick)},_onClick:function(e){e.preventDefault(),this.hit()},_onSuccessKey:function(c){a5.utils.removeAccents(this.value.toLowerCase())===a5.utils.removeAccents(c.toLowerCase())&&this.$el.addClass("is-hangman-key-correct")},_onWrongKey:function(c){a5.utils.removeAccents(this.value.toLowerCase())===a5.utils.removeAccents(c.toLowerCase())&&this.$el.addClass("is-hangman-key-incorrect")},_onEmptyKey:function(c){a5.utils.removeAccents(this.value.toLowerCase())===a5.utils.removeAccents(c.toLowerCase())&&this.$el.addClass("is-hangman-key-empty")}},Obj.extend("a5.view.ISHangmanKey"),a5.view.ISHangmanLifeCounter={template:"a5.view.interaction.ISHangmanLifeCounter",init:function(parameters){this.$el=parameters.$el,this.errorCounter=parameters.errorCounter,this.errorCounter.bind("change",this._onError,this)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html($(html).html()),this.$el},refresh:function(){this.render()},serializeData:function(){var lives=_.times(this.errorCounter.total,function(number){return{id:number+1,used:number<this.errorCounter.count}},this);return{errors:this.errorCounter.count,total:this.errorCounter.total,remaining:this.errorCounter.total-this.errorCounter.count,lives:lives}},_onError:function(){this.refresh()}},Obj.extend("a5.view.ISHangmanLifeCounter"),a5.view.ISHangmanLifeFeedback={template:"a5.view.interaction.ISHangmanLifeFeedback",init:function(parameters){this.$el=parameters.$el,this.errorCounter=parameters.errorCounter,this.errorCounter.bind("change",this._onError,this)},render:function(){var html=a5.service.templates.render(this.template,this.serializeData());return this.$el.html($(html).html()),this.$el},refresh:function(){this.render()},serializeData:function(){return{errors:this.errorCounter.count,total:this.errorCounter.total,remaining:this.errorCounter.total-this.errorCounter.count}},_onError:function(){this.refresh()}},Obj.extend("a5.view.ISHangmanLifeFeedback"),a5.model.interaction.ISHangman={init:function(parameters,defaults){this._super(parameters,$.extend({attemptedLetters:[],words:[],scoreValueIs1PerQuestion:!1},defaults))},test:function(c){_.contains(this.attemptedLetters,c)||this.attemptedLetters.push(c)},store:function(){return this.attemptedLetters},restore:function(attemptedLetters){this.attemptedLetters=attemptedLetters,this.trigger("restore")},getScores:function(){var score=new a5.Score;return _.each(this.words,function(word){word.getScores(score)}),score.incFilled(this.isFilled()),this.scoreValueIs1PerQuestion&&(score.totalBlocks=1,score.correctBlocks=score.total?score.correct/score.total:1),score},tryAgain:function(){this.attemptedLetters=[],this._super()},isFilled:function(){return this.attemptedLetters.length>0}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ISHangman"),a5.model.interaction.ISHangmanWord={init:function(parameters,defaults){this._super(parameters,$.extend({text:"",revealed:!1},defaults))},getScores:function(score){score.incCorrect(this.isCorrect()),score.incTotal()},isCorrect:function(){return this.revealed},reveal:function(){this.revealed=!0},hide:function(){this.revealed=!1}},a5.models.interaction.BaseModel.extend("a5.model.interaction.ISHangmanWord"),a5.model.ISHangmanErrorCounter={init:function(parameters){this.count=0,this.total=parameters.total},reset:function(value){var prev=this.count;this.count=value||0,this.trigger("change",this.count,prev)},increase:function(){var prev=this.count;this.count=_.min([prev+1,this.total]),this.trigger("change",this.count,prev)}},Obj.extend("a5.model.ISHangmanErrorCounter"),A5.ENGINE_TEMPLATES={"a5.view.export.ExtendedWriting":Handlebars.template({1:function(container,depth0,helpers,partials,data){var stack1;return"    "+(null!=(stack1=container.lambda(depth0,depth0))?stack1:"")+"\n"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing;return'<div class="content">\n  <h1 class="course-title">'+(null!=(helper=null!=(helper=helpers.courseTitle||(null!=depth0?depth0.courseTitle:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"courseTitle",hash:{},data:data}):helper)?stack1:"")+'</h1>\n  <h2 class="student-label">Name: </h2>\n  <h2 class="class-label">Class: </h2>\n  <hr>\n  <h2 class="rubric">'+(null!=(helper=null!=(helper=helpers.rubric||(null!=depth0?depth0.rubric:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"rubric",hash:{},data:data}):helper)?stack1:"")+'</h2>\n  <h2 class="title-label">Title: </h2>\n'+(null!=(stack1=helpers.each.call(alias1,null!=depth0?depth0.sections:depth0,{name:"each",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+"</div>"},useData:!0}),"a5.view.export.General":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing;return'<div class="content-wrap">\n  <h2 class="rubric">'+(null!=(helper=null!=(helper=helpers.rubric||(null!=depth0?depth0.rubric:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"rubric",hash:{},data:data}):helper)?stack1:"")+'</h2>\n  <div class="content">'+(null!=(helper=null!=(helper=helpers.content||(null!=depth0?depth0.content:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"content",hash:{},data:data}):helper)?stack1:"")+'</div>\n  <div class="media">'+(null!=(helper=null!=(helper=helpers.media||(null!=depth0?depth0.media:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"media",hash:{},data:data}):helper)?stack1:"")+"</div>\n</div>"},useData:!0}),"a5.view.ExamTimer":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="exam-timer">\n  <div class="timer-message"></div>\n  <div class="time"></div>\n</div>\n'},useData:!0}),"a5.view.ExamTimerTime":Handlebars.template({1:function(container,depth0,helpers,partials,data){var stack1,alias1=null!=depth0?depth0:{};return(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.negative:depth0,{name:"if",hash:{},fn:container.program(2,data,0),inverse:container.noop,data:data}))?stack1:"")+" "+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.onlySeconds:depth0,{name:"if",hash:{},fn:container.program(4,data,0),inverse:container.program(6,data,0),data:data}))?stack1:"")},2:function(container,depth0,helpers,partials,data){return"-"},4:function(container,depth0,helpers,partials,data){var helper;return'<span class="number">'+container.escapeExpression((helper=null!=(helper=helpers.s||(null!=depth0?depth0.s:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"s",hash:{},data:data}):helper))+"</span> seconds"},6:function(container,depth0,helpers,partials,data){var helper;return'<span class="number">'+container.escapeExpression((helper=null!=(helper=helpers.m||(null!=depth0?depth0.m:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"m",hash:{},data:data}):helper))+"</span> minutes"},8:function(container,depth0,helpers,partials,data){var stack1,alias1=null!=depth0?depth0:{};return(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.onlySeconds:depth0,{name:"if",hash:{},fn:container.program(4,data,0),inverse:container.program(6,data,0),data:data}))?stack1:"")+" "+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.negative:depth0,{name:"if",hash:{},fn:container.program(9,data,0),inverse:container.program(11,data,0),data:data}))?stack1:"")},9:function(container,depth0,helpers,partials,data){return"extra"},11:function(container,depth0,helpers,partials,data){return"left"},13:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.negative:depth0,{name:"if",hash:{},fn:container.program(2,data,0),inverse:container.noop,data:data}))?stack1:"")+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.withHours:depth0,{name:"if",hash:{},fn:container.program(14,data,0),inverse:container.noop,data:data}))?stack1:"")+alias4((helper=null!=(helper=helpers.m||(null!=depth0?depth0.m:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"m",hash:{},data:data}):helper))+":"+alias4((helper=null!=(helper=helpers.s||(null!=depth0?depth0.s:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"s",hash:{},data:data}):helper))},14:function(container,depth0,helpers,partials,data){var helper;return container.escapeExpression((helper=null!=(helper=helpers.h||(null!=depth0?depth0.h:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"h",hash:{},data:data}):helper))+":"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing;return(null!=(stack1=(helpers.ifEq||depth0&&depth0.ifEq||alias2).call(alias1,null!=depth0?depth0.format:depth0,"time",{name:"ifEq",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+(null!=(stack1=(helpers.ifEq||depth0&&depth0.ifEq||alias2).call(alias1,null!=depth0?depth0.format:depth0,"countdown",{name:"ifEq",hash:{},fn:container.program(8,data,0),inverse:container.noop,data:data}))?stack1:"")+(null!=(stack1=(helpers.ifEq||depth0&&depth0.ifEq||alias2).call(alias1,null!=depth0?depth0.format:depth0,"hmmss",{name:"ifEq",hash:{},fn:container.program(13,data,0),inverse:container.noop,data:data}))?stack1:"")},useData:!0}),"a5.view.multiselectCheck":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<ul class="multiselectCheckList group">\n</ul>\n'},useData:!0}),"a5.view.multiselectCheckChoice":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper;return'<li class="group__item">\n  <label class="formCheck formCheck--checkbox">\n    <input class="formCheck__input" type="checkbox">\n    <span class="formCheck__label">'+(null!=(helper=null!=(helper=helpers.data||(null!=depth0?depth0.data:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"data",hash:{},data:data}):helper)?stack1:"")+"</span>\n  </label>\n</li>\n"},useData:!0}),"a5.view.toolbar.erase":Handlebars.template({1:function(container,depth0,helpers,partials,data){return'<div class="highlighter eraser"><span style="background-color:white;">A</span>Erase</div>'},3:function(container,depth0,helpers,partials,data){return'<div class="button toggle">Erase</div>'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return null!=(stack1=helpers.if.call(null!=depth0?depth0:{},null!=depth0?depth0.isColouringAT:depth0,{name:"if",hash:{},fn:container.program(1,data,0),inverse:container.program(3,data,0),data:data}))?stack1:""},useData:!0}),"a5.view.Check":Handlebars.template({1:function(container,depth0,helpers,partials,data){return" correct"},3:function(container,depth0,helpers,partials,data){var stack1;return null!=(stack1=helpers.if.call(null!=depth0?depth0:{},null!=depth0?depth0.empty:depth0,{name:"if",hash:{},fn:container.program(4,data,0),inverse:container.program(6,data,0),data:data}))?stack1:""},4:function(container,depth0,helpers,partials,data){return" wrong_2"},6:function(container,depth0,helpers,partials,data){return" wrong"},8:function(container,depth0,helpers,partials,data,blockParams){return" "+container.escapeExpression(container.lambda(blockParams[0][0],depth0))},10:function(container,depth0,helpers,partials,data){return"Correct"},12:function(container,depth0,helpers,partials,data){var stack1;return null!=(stack1=helpers.if.call(null!=depth0?depth0:{},null!=depth0?depth0.empty:depth0,{name:"if",hash:{},fn:container.program(13,data,0),inverse:container.program(15,data,0),data:data}))?stack1:""},13:function(container,depth0,helpers,partials,data){return"Empty"},15:function(container,depth0,helpers,partials,data){return"Incorrect"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data,blockParams){var stack1,alias1=null!=depth0?depth0:{};return'<div class="check'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.correct:depth0,{name:"if",hash:{},fn:container.program(1,data,0,blockParams),inverse:container.program(3,data,0,blockParams),data:data,blockParams:blockParams}))?stack1:"")+(null!=(stack1=helpers.each.call(alias1,null!=depth0?depth0.classes:depth0,{name:"each",hash:{},fn:container.program(8,data,1,blockParams),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+'" aria-label="'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.correct:depth0,{name:"if",hash:{},fn:container.program(10,data,0,blockParams),inverse:container.program(12,data,0,blockParams),data:data,blockParams:blockParams}))?stack1:"")+'"></div>'},useData:!0,useBlockParams:!0}),"a5.book.annotations.ColorPalette":Handlebars.template({1:function(container,depth0,helpers,partials,data){var helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return'<li data-event="activate" data-name="'+alias4((helper=null!=(helper=helpers.name||(null!=depth0?depth0.name:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"name",hash:{},data:data}):helper))+'" class="color color-'+alias4((helper=null!=(helper=helpers.name||(null!=depth0?depth0.name:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"name",hash:{},data:data}):helper))+'" title="'+alias4((helper=null!=(helper=helpers.title||(null!=depth0?depth0.title:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"title",hash:{},data:data}):helper))+'" style="background-color: '+alias4((helper=null!=(helper=helpers.hex||(null!=depth0?depth0.hex:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"hex",hash:{},data:data}):helper))+'"></li>'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return'<ul class="colorPalette">'+(null!=(stack1=helpers.each.call(null!=depth0?depth0:{},null!=depth0?depth0.colors:depth0,{name:"each",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+"</ul>"},useData:!0}),"a5.book.annotations.ThicknessSelector":Handlebars.template({1:function(container,depth0,helpers,partials,data){var helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return'<li data-event="activate" data-name="'+alias4((helper=null!=(helper=helpers.name||(null!=depth0?depth0.name:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"name",hash:{},data:data}):helper))+'" class="thickness thickness-'+alias4((helper=null!=(helper=helpers.name||(null!=depth0?depth0.name:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"name",hash:{},data:data}):helper))+'" title="'+alias4((helper=null!=(helper=helpers.title||(null!=depth0?depth0.title:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"title",hash:{},data:data}):helper))+'"></li>'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return'<ul class="thicknessSelector">'+(null!=(stack1=helpers.each.call(null!=depth0?depth0:{},null!=depth0?depth0.thicknesses:depth0,{name:"each",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+"</ul>"},useData:!0}),"a5.book.annotations.Tool":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return'<li data-event="activate" class="tool tool-'+alias4((helper=null!=(helper=helpers.name||(null!=depth0?depth0.name:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"name",hash:{},data:data}):helper))+'" data-tool-type="'+alias4((helper=null!=(helper=helpers.type||(null!=depth0?depth0.type:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"type",hash:{},data:data}):helper))+'" title="'+alias4((helper=null!=(helper=helpers.title||(null!=depth0?depth0.title:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"title",hash:{},data:data}):helper))+'"\n  ><span class="name">'+(null!=(helper=null!=(helper=helpers.label||(null!=depth0?depth0.label:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"label",hash:{},data:data}):helper)?stack1:"")+"</span\n></li>"},useData:!0}),"a5.view.alert.InvalidPage":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return'<div data-duration="10">\n  <span class="close">x</span>\n  The last page is '+container.escapeExpression((helper=null!=(helper=helpers.last||(null!=depth0?depth0.last:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"last",hash:{},data:data}):helper))+". Please re-enter page number.\n</div>\n"},useData:!0}),"a5.view.hotspot.File":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="hotspot file">\n  <div class="toolbar">\n    <div class="handle"></div>\n    <div class="trash"></div>\n  </div>\n  <div class="tooltip"></div>\n</div>\n'},useData:!0}),"a5.speaking_recording.SpeakingRecording":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="lrp_wrap">\n  <a class="lrp_listen button">Listen</a>\n  <a class="lrp_record button">Record</a>\n  <a class="lrp_finish button">Finish</a>\n  <a class="lrp_play button">Play</a>\n  <a class="lrp_stop button">Stop</a>\n  <a class="lrp_download button">Download</a>\n</div>\n'},useData:!0}),"a5.view.controls.EnumerationLink":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing;return'<a class="nav-button" data-interaction="'+(null!=(helper=null!=(helper=helpers.interaction||(null!=depth0?depth0.interaction:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"interaction",hash:{},data:data}):helper)?stack1:"")+'" href="#'+(null!=(helper=null!=(helper=helpers.targetId||(null!=depth0?depth0.targetId:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"targetId",hash:{},data:data}):helper)?stack1:"")+'">'+container.escapeExpression((helper=null!=(helper=helpers.label||(null!=depth0?depth0.label:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"label",hash:{},data:data}):helper))+"</a>"},useData:!0}),"a5.view.controls.EnumerationNavPart":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing;return'<div class="nav-part" id="screen-part-'+(null!=(helper=null!=(helper=helpers.number||(null!=depth0?depth0.number:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"number",hash:{},data:data}):helper)?stack1:"")+'">\n  <span>'+container.escapeExpression((helper=null!=(helper=helpers.label||(null!=depth0?depth0.label:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"label",hash:{},data:data}):helper))+"</span>\n</div>"},useData:!0}),"a5.view.InfoTextDictionary":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper;return'<div class="info-text info-text-dictionary infotext infotext--dictionary">\n  <div class="handle infotext__handle">\n    '+(null!=(helper=null!=(helper=helpers.handle||(null!=depth0?depth0.handle:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"handle",hash:{},data:data}):helper)?stack1:"")+"\n  </div>\n</div>\n"},useData:!0}),"a5.view.InfoTextReference":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper;return'<div class="info-text info-text-reference infotext infotext--reference">\n  <div class="handle infotext__handle">\n    '+(null!=(helper=null!=(helper=helpers.handle||(null!=depth0?depth0.handle:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"handle",hash:{},data:data}):helper)?stack1:"")+"\n  </div>\n</div>\n"},useData:!0}),"a5.view.InfoTextTooltip":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing;return'<div class="info-text infotext infotext--tooltip" data-force-width="true">\n  <div class="handle infotext__handle">\n    '+(null!=(helper=null!=(helper=helpers.handle||(null!=depth0?depth0.handle:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"handle",hash:{},data:data}):helper)?stack1:"")+'\n  </div>\n  <div class="tooltip infotext__content">\n    <div>'+(null!=(helper=null!=(helper=helpers.content||(null!=depth0?depth0.content:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"content",hash:{},data:data}):helper)?stack1:"")+"</div>\n  </div>\n</div>\n"},useData:!0}),"a5.view.WordpoolDragHandle":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<h2 class="drag-handle">:: drag to move wordpool :: <span class="reset_position hidden">dock</span></h2>'},useData:!0}),"a5.view.DropDownButton":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper;return'<div>\n  <div class="dropdown">\n    <a href="#" class="act_head_button" tabindex="0">\n      <span class="label">'+(null!=(helper=null!=(helper=helpers.label||(null!=depth0?depth0.label:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"label",hash:{},data:data}):helper)?stack1:"")+'</span>\n      <span class="toggle"></span>\n    </a>\n    <div class="dropdown-slider">\n    </div>\n  </div>\n</div>\n'},useData:!0}),"a5.view.DropDownItem":Handlebars.template({1:function(container,depth0,helpers,partials,data){var stack1,helper;return'<a href="#" class="act_head_button tooltipz">'+(null!=(helper=null!=(helper=helpers.label||(null!=depth0?depth0.label:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"label",hash:{},data:data}):helper)?stack1:"")+"</a>"},3:function(container,depth0,helpers,partials,data){var stack1,helper;return'<a href="#" class="ddm" tabindex="-1"><span class="label">'+(null!=(helper=null!=(helper=helpers.label||(null!=depth0?depth0.label:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"label",hash:{},data:data}):helper)?stack1:"")+"</span></a>"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return null!=(stack1=helpers.if.call(null!=depth0?depth0:{},null!=depth0?depth0.main:depth0,{name:"if",hash:{},fn:container.program(1,data,0),
inverse:container.program(3,data,0),data:data}))?stack1:""},useData:!0}),"a5.view.interaction.ICCrosswordCell":Handlebars.template({1:function(container,depth0,helpers,partials,data){var stack1,alias1=null!=depth0?depth0:{};return(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.word1:depth0,{name:"if",hash:{},fn:container.program(2,data,0),inverse:container.noop,data:data}))?stack1:"")+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.word2:depth0,{name:"if",hash:{},fn:container.program(7,data,0),inverse:container.noop,data:data}))?stack1:"")},2:function(container,depth0,helpers,partials,data){var stack1,alias1=container.lambda,alias2=container.escapeExpression;return"Letter "+alias2(alias1(null!=(stack1=null!=depth0?depth0.word1:depth0)?stack1.cell:stack1,depth0))+" of word "+alias2(alias1(null!=(stack1=null!=depth0?depth0.word1:depth0)?stack1.index:stack1,depth0))+" "+(null!=(stack1=helpers.if.call(null!=depth0?depth0:{},null!=(stack1=null!=depth0?depth0.word1:depth0)?stack1.isVertical:stack1,{name:"if",hash:{},fn:container.program(3,data,0),inverse:container.program(5,data,0),data:data}))?stack1:"")},3:function(container,depth0,helpers,partials,data){return"down"},5:function(container,depth0,helpers,partials,data){return"across"},7:function(container,depth0,helpers,partials,data){var stack1,alias1=container.lambda,alias2=container.escapeExpression;return", letter "+alias2(alias1(null!=(stack1=null!=depth0?depth0.word2:depth0)?stack1.cell:stack1,depth0))+" of word "+alias2(alias1(null!=(stack1=null!=depth0?depth0.word2:depth0)?stack1.index:stack1,depth0))+" "+(null!=(stack1=helpers.if.call(null!=depth0?depth0:{},null!=(stack1=null!=depth0?depth0.word2:depth0)?stack1.isVertical:stack1,{name:"if",hash:{},fn:container.program(3,data,0),inverse:container.program(5,data,0),data:data}))?stack1:"")},9:function(container,depth0,helpers,partials,data){var stack1,helper;return'    <span class="clue-cell-enum">'+(null!=(helper=null!=(helper=helpers.enumLabel||(null!=depth0?depth0.enumLabel:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"enumLabel",hash:{},data:data}):helper)?stack1:"")+"</span>\n"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data,blockParams,depths){var stack1,helper,alias1=null!=depth0?depth0:{};return'\n<div class="cell">\n  <input type="text" maxlength="1" aria-label="'+(null!=(stack1=container.invokePartial(partials.label,depth0,{name:"label",hash:{word2:null!=depth0?depth0.word2:depth0,word1:null!=depth0?depth0.word1:depth0},data:data,helpers:helpers,partials:partials,decorators:container.decorators}))?stack1:"")+'" tabIndex="'+container.escapeExpression((helper=null!=(helper=helpers.tabIndex||(null!=depth0?depth0.tabIndex:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(alias1,{name:"tabIndex",hash:{},data:data}):helper))+'"></input>\n'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.enumLabel:depth0,{name:"if",hash:{},fn:container.program(9,data,0,blockParams,depths),inverse:container.noop,data:data}))?stack1:"")+"</div>\n"},main_d:function(fn,props,container,depth0,data,blockParams,depths){return fn=container.decorators.inline(fn,props,container,{name:"inline",hash:{},fn:container.program(1,data,0,blockParams,depths),inverse:container.noop,args:["label"],data:data})||fn},useDecorators:!0,usePartial:!0,useData:!0,useDepths:!0}),"a5.views.interaction.DialogueRecording":Handlebars.template({1:function(container,depth0,helpers,partials,data){var stack1,alias1=null!=depth0?depth0:{},alias2=container.lambda,alias3=container.escapeExpression;return'  <div class="role'+(null!=(stack1=helpers.if.call(alias1,null!=(stack1=null!=depth0?depth0.role:depth0)?stack1.disabled:stack1,{name:"if",hash:{},fn:container.program(2,data,0),inverse:container.noop,data:data}))?stack1:"")+'" id="'+alias3(alias2(null!=(stack1=null!=depth0?depth0.role:depth0)?stack1.id:stack1,depth0))+'">\n    <div class="role-photo">'+(null!=(stack1=helpers.if.call(alias1,null!=(stack1=null!=depth0?depth0.role:depth0)?stack1.photoUrl:stack1,{name:"if",hash:{},fn:container.program(4,data,0),inverse:container.noop,data:data}))?stack1:"")+'</div>\n    <div class="role-label">'+alias3(alias2(null!=(stack1=null!=depth0?depth0.role:depth0)?stack1.label:stack1,depth0))+'</div>\n    <div class="btn-select-role"></div>\n  </div>\n'},2:function(container,depth0,helpers,partials,data){return" disabled"},4:function(container,depth0,helpers,partials,data){var stack1;return'        <img src="'+container.escapeExpression(container.lambda(null!=(stack1=null!=depth0?depth0.role:depth0)?stack1.photoUrl:stack1,depth0))+'"/>\n'},6:function(container,depth0,helpers,partials,data){var stack1,alias1=container.lambda,alias2=container.escapeExpression;return'  <div class="dialogue" id="'+alias2(alias1(null!=(stack1=null!=depth0?depth0.dialogue:depth0)?stack1.id:stack1,depth0))+'" data-role-id="'+alias2(alias1(null!=(stack1=null!=depth0?depth0.dialogue:depth0)?stack1.characterId:stack1,depth0))+'">\n    <div class="role-photo">'+(null!=(stack1=helpers.if.call(null!=depth0?depth0:{},null!=(stack1=null!=(stack1=null!=depth0?depth0.dialogue:depth0)?stack1.role:stack1)?stack1.photoUrl:stack1,{name:"if",hash:{},fn:container.program(7,data,0),inverse:container.noop,data:data}))?stack1:"")+'</div>\n    <div class="dialogue-content">\n      '+(null!=(stack1=alias1(null!=(stack1=null!=depth0?depth0.dialogue:depth0)?stack1.content:stack1,depth0))?stack1:"")+'\n    </div>\n    <div class="recorder"></div>\n    <div class="player"></div>\n  </div>\n'},7:function(container,depth0,helpers,partials,data){var stack1;return'        <img src="'+container.escapeExpression(container.lambda(null!=(stack1=null!=(stack1=null!=depth0?depth0.dialogue:depth0)?stack1.role:stack1)?stack1.photoUrl:stack1,depth0))+'"/>\n'},9:function(container,depth0,helpers,partials,data,blockParams){var stack1;return null!=(stack1=container.invokePartial(partials.role,depth0,{name:"role",hash:{role:blockParams[0][0]},data:data,blockParams:blockParams,indent:"      ",helpers:helpers,partials:partials,decorators:container.decorators}))?stack1:""},11:function(container,depth0,helpers,partials,data){return'    <div class="hide-lines-buttons">\n      <div class="btn-hide-lines">Hide my lines</div>\n      <div class="btn-hide-all">Hide all lines</div>\n    </div>\n'},13:function(container,depth0,helpers,partials,data,blockParams){var stack1;return null!=(stack1=container.invokePartial(partials.dialogue,depth0,{name:"dialogue",hash:{dialogue:blockParams[0][0]},data:data,blockParams:blockParams,indent:"      ",helpers:helpers,partials:partials,decorators:container.decorators}))?stack1:""},15:function(container,depth0,helpers,partials,data){return'    <div class="play-all"></div>\n'},17:function(container,depth0,helpers,partials,data){return'    <div class="btn-download-all"></div>\n'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data,blockParams,depths){var stack1,alias1=null!=depth0?depth0:{};return'\n\n<div class="ic-dialogue-recording">\n  <div class="role-selector">\n'+(null!=(stack1=helpers.each.call(alias1,null!=depth0?depth0.roles:depth0,{name:"each",hash:{},fn:container.program(9,data,1,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+"  </div>\n"+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.hideLinesEnabled:depth0,{name:"if",hash:{},fn:container.program(11,data,0,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+'\n  <div class="dialogues">\n'+(null!=(stack1=helpers.each.call(alias1,null!=depth0?depth0.dialogues:depth0,{name:"each",hash:{},fn:container.program(13,data,1,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+"  </div>\n"+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.playAllEnabled:depth0,{name:"if",hash:{},fn:container.program(15,data,0,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.downloadAudioEnabled:depth0,{name:"if",hash:{},fn:container.program(17,data,0,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+"</div>\n"},main_d:function(fn,props,container,depth0,data,blockParams,depths){var decorators=container.decorators;return fn=decorators.inline(fn,props,container,{name:"inline",hash:{},fn:container.program(1,data,0,blockParams,depths),inverse:container.noop,args:["role"],data:data,blockParams:blockParams})||fn,fn=decorators.inline(fn,props,container,{name:"inline",hash:{},fn:container.program(6,data,0,blockParams,depths),inverse:container.noop,args:["dialogue"],data:data,blockParams:blockParams})||fn},useDecorators:!0,usePartial:!0,useData:!0,useDepths:!0,useBlockParams:!0}),"a5.view.IMAutocorrectErrorCounter":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return'<div class="error-counter">\n  <p>\n    There are '+alias4((helper=null!=(helper=helpers.total||(null!=depth0?depth0.total:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"total",hash:{},data:data}):helper))+" errors. <br>\n    You have found "+alias4((helper=null!=(helper=helpers.correct||(null!=depth0?depth0.correct:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"correct",hash:{},data:data}):helper))+" errors.\n  </p>\n</div>\n"},useData:!0}),"a5.view.IMProofingErrorCounter":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return'<div class="error-counter">\n  <p>\n    There are '+alias4((helper=null!=(helper=helpers.total||(null!=depth0?depth0.total:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"total",hash:{},data:data}):helper))+" errors. <br>\n    You have found "+alias4((helper=null!=(helper=helpers.correct||(null!=depth0?depth0.correct:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"correct",hash:{},data:data}):helper))+" errors.\n  </p>\n</div>\n"},useData:!0}),"a5.view.IMProofingToolbar":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="tools">\n  <div class="markers">\n    <a href="#" class="btn-capital">Make capital</a>\n    <a href="#" class="btn-small">Make a small letter</a>\n    <a href="#" class="btn-add">Add something</a>\n    <a href="#" class="btn-delete">Take out something</a>\n    <a href="#" class="btn-spelling">Spelling error</a>\n    <a href="#" class="btn-grammar">Grammar error</a>\n    <a href="#" class="btn-fullstop">Add a period</a>\n    <a href="#" class="btn-para">New paragraph</a>\n    <a href="#" class="btn-indent">Indent</a>\n    <a href="#" class="btn-erase">Erase</a>\n  </div>\n</div>\n'},useData:!0}),"a5.view.is_catch_GameOver":Handlebars.template({1:function(container,depth0,helpers,partials,data){var helper;return"        "+container.escapeExpression((helper=null!=(helper=helpers.text||(null!=depth0?depth0.text:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"text",hash:{},data:data}):helper))+"\n"},3:function(container,depth0,helpers,partials,data){return"        Game Over\n"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return'<div title="ISCatchMessage">\n  <div class="content-dialog-wrapper">\n    <p>\n'+(null!=(stack1=helpers.if.call(null!=depth0?depth0:{},null!=depth0?depth0.text:depth0,{name:"if",hash:{},fn:container.program(1,data,0),inverse:container.program(3,data,0),data:data}))?stack1:"")+'    </p>\n    <div class="last-buttons">\n      <a href="#" data-button="ok">OK</a>\n   </div>\n  </div>\n</div>\n'},useData:!0}),"a5.view.is_catch_ScoreBoard":Handlebars.template({1:function(container,depth0,helpers,partials,data){return"    <div class='is_catch_board_timer'/>\n"},3:function(container,depth0,helpers,partials,data){return"    <div class='is_catch_board_score'/>\n"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,alias1=null!=depth0?depth0:{};return'<div title="ISCatchScoreBoard">\n    <p>\n      This is the score:\n    </p>\n'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.timer:depth0,{name:"if",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.score:depth0,{name:"if",hash:{},fn:container.program(3,data,0),inverse:container.noop,data:data}))?stack1:"")+"</div>\n"},useData:!0}),"a5.view.is_catch_TimeUp":Handlebars.template({1:function(container,depth0,helpers,partials,data){var helper;return"        "+container.escapeExpression((helper=null!=(helper=helpers.text||(null!=depth0?depth0.text:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"text",hash:{},data:data}):helper))+"\n"},3:function(container,depth0,helpers,partials,data){return"        You ran out of time!\n"},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return'<div title="ISCatchMessage">\n  <div class="content-dialog-wrapper">\n    <p>\n'+(null!=(stack1=helpers.if.call(null!=depth0?depth0:{},null!=depth0?depth0.text:depth0,{name:"if",hash:{},fn:container.program(1,data,0),inverse:container.program(3,data,0),data:data}))?stack1:"")+'    </p>\n    <div class="last-buttons">\n      <a href="#" data-button="ok">OK</a>\n   </div>\n  </div>\n</div>\n'},useData:!0}),"a5.view.interaction.ISCheckbox":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="group" aria-label="possible answers"></div>\n'},useData:!0}),"a5.view.interaction.ISCheckboxChoice":Handlebars.template({1:function(container,depth0,helpers,partials,data){return'<span class="is-checkbox-choice-text"></span>'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return'<span class="item">'+(null!=(stack1=helpers.unless.call(null!=depth0?depth0:{},null!=depth0?depth0.showInColumns:depth0,{name:"unless",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+"</span>\n"},useData:!0}),"a5.view.interaction.ISCheckboxChoiceWrapper":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="checkbox" aria-checked="false"></div>\n'},useData:!0}),"a5.view.interaction.ISHangman":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="is-hangman">\n  <div class="is-hangman-life-counter"></div>\n  <div class="is-hangman-life-feedback"></div>\n  <div class="is-hangman-board"></div>\n  <div class="is-hangman-keyboard">\n    <div class="is-hangman-key" data-char="a">A</div>\n    <div class="is-hangman-key" data-char="b">B</div>\n    <div class="is-hangman-key" data-char="c">C</div>\n    <div class="is-hangman-key" data-char="d">D</div>\n    <div class="is-hangman-key" data-char="e">E</div>\n    <div class="is-hangman-key" data-char="f">F</div>\n    <div class="is-hangman-key" data-char="g">G</div>\n    <div class="is-hangman-key" data-char="h">H</div>\n    <div class="is-hangman-key" data-char="i">I</div>\n    <div class="is-hangman-key" data-char="j">J</div>\n    <div class="is-hangman-key" data-char="k">K</div>\n    <div class="is-hangman-key" data-char="l">L</div>\n    <div class="is-hangman-key" data-char="m">M</div>\n    <div class="is-hangman-key" data-char="n">N</div>\n    <div class="is-hangman-key" data-char="o">O</div>\n    <div class="is-hangman-key" data-char="p">P</div>\n    <div class="is-hangman-key" data-char="q">Q</div>\n    <div class="is-hangman-key" data-char="r">R</div>\n    <div class="is-hangman-key" data-char="s">S</div>\n    <div class="is-hangman-key" data-char="t">T</div>\n    <div class="is-hangman-key" data-char="u">U</div>\n    <div class="is-hangman-key" data-char="v">V</div>\n    <div class="is-hangman-key" data-char="w">W</div>\n    <div class="is-hangman-key" data-char="x">X</div>\n    <div class="is-hangman-key" data-char="y">Y</div>\n    <div class="is-hangman-key" data-char="z">Z</div>\n  </div>\n</div>\n'},useData:!0}),"a5.view.interaction.ISHangmanLifeCounter":Handlebars.template({1:function(container,depth0,helpers,partials,data){var stack1;return'  <div class="is-hangman-life is-hangman-life-'+container.escapeExpression(container.lambda(null!=(stack1=null!=depth0?depth0.life:depth0)?stack1.id:stack1,depth0))+" "+(null!=(stack1=helpers.if.call(null!=depth0?depth0:{},null!=(stack1=null!=depth0?depth0.life:depth0)?stack1.used:stack1,{name:"if",hash:{},fn:container.program(2,data,0),inverse:container.noop,data:data}))?stack1:"")+'">\n  </div>\n'},2:function(container,depth0,helpers,partials,data){return"life-used"},4:function(container,depth0,helpers,partials,data,blockParams){var stack1;return null!=(stack1=container.invokePartial(partials.life,depth0,{name:"life",hash:{life:blockParams[0][0]},data:data,blockParams:blockParams,indent:"    ",helpers:helpers,partials:partials,decorators:container.decorators}))?stack1:""},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data,blockParams,depths){var stack1;return"\n<div>\n"+(null!=(stack1=helpers.each.call(null!=depth0?depth0:{},null!=depth0?depth0.lives:depth0,{name:"each",hash:{},fn:container.program(4,data,1,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+"</div>\n"},main_d:function(fn,props,container,depth0,data,blockParams,depths){return fn=container.decorators.inline(fn,props,container,{name:"inline",hash:{},fn:container.program(1,data,0,blockParams,depths),inverse:container.noop,args:["life"],data:data,blockParams:blockParams})||fn},useDecorators:!0,usePartial:!0,useData:!0,useDepths:!0,useBlockParams:!0}),"a5.view.interaction.ISHangmanLifeFeedback":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<div>\n  "+container.escapeExpression((helper=null!=(helper=helpers.remaining||(null!=depth0?depth0.remaining:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"remaining",hash:{},data:data}):helper))+" remaining chances\n</div>\n"},useData:!0}),"a5.view.interaction.ISHangmanWord":Handlebars.template({1:function(container,depth0,helpers,partials,data){return'  <div class="is-hangman-letter"></div>\n'},3:function(container,depth0,helpers,partials,data,blockParams){var stack1;return null!=(stack1=container.invokePartial(partials.letter,depth0,{name:"letter",hash:{letter:blockParams[0][0]},data:data,blockParams:blockParams,indent:"    ",helpers:helpers,partials:partials,decorators:container.decorators}))?stack1:""},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data,blockParams,depths){var stack1;return"\n<div>\n"+(null!=(stack1=helpers.each.call(null!=depth0?depth0:{},null!=depth0?depth0.letters:depth0,{name:"each",hash:{},fn:container.program(3,data,1,blockParams,depths),inverse:container.noop,data:data,blockParams:blockParams}))?stack1:"")+"</div>\n"},main_d:function(fn,props,container,depth0,data,blockParams,depths){return fn=container.decorators.inline(fn,props,container,{name:"inline",hash:{},fn:container.program(1,data,0,blockParams,depths),inverse:container.noop,args:["letter"],data:data,blockParams:blockParams})||fn},useDecorators:!0,usePartial:!0,useData:!0,useDepths:!0,useBlockParams:!0}),"a5.view.interaction.ISRadioButton":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="radiogroup" aria-label="possible answers"></div>\n'},useData:!0}),"a5.view.interaction.ISRadioButtonChoice":Handlebars.template({1:function(container,depth0,helpers,partials,data){return'<span class="is-radiobutton-choice-text"></span>'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1;return'<span class="item">'+(null!=(stack1=helpers.unless.call(null!=depth0?depth0:{},null!=depth0?depth0.showInColumns:depth0,{name:"unless",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+"</span>\n"},useData:!0}),"a5.view.interaction.ISRadioButtonChoiceWrapper":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="radio" aria-checked="false"></div>\n'},useData:!0}),"a5.view.interaction.ISRadioButtonColumns":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="radiogroup" tabindex="0" aria-label="possible answers"></div>\n'},useData:!0}),"a5.view.interaction.ISRadioButtonColumnsChoice":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<span class="item"></span>\n'},useData:!0}),"a5.view.interaction.ISRadioButtonColumnsChoiceWrapper":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div role="radio" aria-checked="false"></div>\n'},useData:!0}),"a5.views.interaction.PEScorable":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return'<div class="third-party-container">\n  <iframe class="third-party-content" src="'+container.escapeExpression((helper=null!=(helper=helpers.src||(null!=depth0?depth0.src:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"src",hash:{},data:data}):helper))+'">\n  </iframe>\n</div>\n'},useData:!0}),"a5.view.EndResultAllCorrectAttempt":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<span>"+container.escapeExpression((helper=null!=(helper=helpers.total||(null!=depth0?depth0.total:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"total",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.EndResultAttempts":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<span>"+container.escapeExpression((helper=null!=(helper=helpers.attempt||(null!=depth0?depth0.attempt:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"attempt",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.EndResultBandFeedback":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<span class="feedbackBand"></span>\n'},useData:!0}),"a5.view.EndResultCorrectAnswers":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<span>"+container.escapeExpression((helper=null!=(helper=helpers.correct||(null!=depth0?depth0.correct:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"correct",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.EndResultDate":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<span>"+container.escapeExpression((helper=null!=(helper=helpers.date||(null!=depth0?depth0.date:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"date",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.EndResultIncorrectAnswers":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<span>"+container.escapeExpression((helper=null!=(helper=helpers.incorrect||(null!=depth0?depth0.incorrect:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"incorrect",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.EndResultIndex":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return'<span class="index">'+container.escapeExpression((helper=null!=(helper=helpers.index||(null!=depth0?depth0.index:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"index",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.EndResultMetadata":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<span>"+container.escapeExpression((helper=null!=(helper=helpers.metadata||(null!=depth0?depth0.metadata:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"metadata",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.EndResultNotAttempted":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<span>"+container.escapeExpression((helper=null!=(helper=helpers.notattempted||(null!=depth0?depth0.notattempted:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"notattempted",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.EndResultScore":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return'<span class="score">'+container.escapeExpression((helper=null!=(helper=helpers.score||(null!=depth0?depth0.score:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"score",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.EndResultSolved":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<span>"+container.escapeExpression((helper=null!=(helper=helpers.solved||(null!=depth0?depth0.solved:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"solved",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.EndResultTimeTaken":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper;return"<span>"+(null!=(helper=null!=(helper=helpers.time||(null!=depth0?depth0.time:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"time",hash:{},data:data}):helper)?stack1:"")+"</span>\n"},useData:!0}),"a5.view.EndResultTimeout":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper;return"<span>"+(null!=(helper=null!=(helper=helpers.time||(null!=depth0?depth0.time:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"time",hash:{},data:data}):helper)?stack1:"")+"</span>\n"},useData:!0}),"a5.view.EndResultTotalQuestions":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<span>"+container.escapeExpression((helper=null!=(helper=helpers.total||(null!=depth0?depth0.total:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"total",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.EndResultUnsolved":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var helper;return"<span>"+container.escapeExpression((helper=null!=(helper=helpers.unsolved||(null!=depth0?depth0.unsolved:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"unsolved",hash:{},data:data}):helper))+"</span>\n"},useData:!0}),"a5.view.dialog.Countdown":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="countdown-panel">\n  <div class="display">\n    <span class="hours">00</span>\n    <span class="time-separator">:</span>\n    <span class="minutes">00</span>\n    <span class="time-separator">:</span>\n    <span class="seconds">00</span>\n  </div>\n  <div class="progress"></div>\n  <div class="buttons">\n    <button class="reset">Reset</button>\n    <button class="play">Play</button>\n    <button class="pause">Pause</button>\n    <button class="close">Close</button>\n  </div>\n</div>\n'},useData:!0}),"a5.view.dialog.CountdownSetup":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="countdown-setup-panel">\n  <span class="close">x</span>\n  <div class="display">\n    <div class="hours">\n      <input type="text" value="00" maxlength="2">\n    </div>\n    <span class="time-separator">:</span>\n    <div class="minutes">\n      <input type="text" value="00" maxlength="2">\n    </div>\n    <span class="time-separator">:</span>\n    <div class="seconds">\n      <input type="text" value="00" maxlength="2">\n    </div>\n  </div>\n  <button class="reset">Reset</button>\n  <button class="start">Start</button>\n  <button class="alarm">Alarm</button>\n  <div class="alarm-options"></div>\n</div>\n'},useData:!0}),"a5.view.dialog.CountdownSetupAlarm":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div class="countdown-setup-alarm">\n</div>\n'},useData:!0}),"a5.book.annotations.Link":Handlebars.template({1:function(container,depth0,helpers,partials,data){return'      <div class="resize-handle"></div>\n'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return'<div class="content-link">\n  <div class="wrap">\n    <div class="text">\n      '+(null!=(helper=null!=(helper=helpers.text||(null!=depth0?depth0.text:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"text",hash:{},data:data}):helper)?stack1:"")+'\n    </div>\n    <div class="toolbar">\n      <span class="control expander" title="'+alias4((helper=null!=(helper=helpers.expandHint||(null!=depth0?depth0.expandHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"expandHint",hash:{},data:data}):helper))+'"></span>\n      <span class="control handle" title="'+alias4((helper=null!=(helper=helpers.handleHint||(null!=depth0?depth0.handleHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"handleHint",hash:{},data:data}):helper))+'"></span>\n      <span class="control trash" title="'+alias4((helper=null!=(helper=helpers.trashHint||(null!=depth0?depth0.trashHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"trashHint",hash:{},data:data}):helper))+'"</span>\n    </div>\n'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.isResizable:depth0,{name:"if",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+"  </div>\n</div>\n"},useData:!0}),"a5.book.annotations.StickyNote":Handlebars.template({1:function(container,depth0,helpers,partials,data){var stack1,helper;return'      <div class="title">\n        '+(null!=(helper=null!=(helper=helpers.title||(null!=depth0?depth0.title:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"title",hash:{},data:data}):helper)?stack1:"")+"\n      </div>\n"},3:function(container,depth0,helpers,partials,data){var helper
;return'        <span class="control share" title="'+container.escapeExpression((helper=null!=(helper=helpers.shareHint||(null!=depth0?depth0.shareHint:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"shareHint",hash:{},data:data}):helper))+'"></span>\n'},5:function(container,depth0,helpers,partials,data){var helper;return'        <span class="control trash" title="'+container.escapeExpression((helper=null!=(helper=helpers.trashHint||(null!=depth0?depth0.trashHint:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"trashHint",hash:{},data:data}):helper))+'"</span>\n'},7:function(container,depth0,helpers,partials,data){var stack1,helper;return'      <div class="lock">'+(null!=(helper=null!=(helper=helpers.lock||(null!=depth0?depth0.lock:depth0))?helper:helpers.helperMissing,stack1="function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"lock",hash:{},data:data}):helper)?stack1:"")+"</div>\n"},9:function(container,depth0,helpers,partials,data){var helper;return'      <div class="resize-handle" title="'+container.escapeExpression((helper=null!=(helper=helpers.resizeHint||(null!=depth0?depth0.resizeHint:depth0))?helper:helpers.helperMissing,"function"==typeof helper?helper.call(null!=depth0?depth0:{},{name:"resizeHint",hash:{},data:data}):helper))+'"></div>\n'},compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing;return'<div class="sticky-note">\n  <div class="wrap handle">\n'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.withTitle:depth0,{name:"if",hash:{},fn:container.program(1,data,0),inverse:container.noop,data:data}))?stack1:"")+'    <div class="text">\n      '+(null!=(helper=null!=(helper=helpers.text||(null!=depth0?depth0.text:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"text",hash:{},data:data}):helper)?stack1:"")+'\n    </div>\n    <div class="toolbar">\n      <span class="control expander" title="'+container.escapeExpression((helper=null!=(helper=helpers.expandHint||(null!=depth0?depth0.expandHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"expandHint",hash:{},data:data}):helper))+'"></span>\n'+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.isShareable:depth0,{name:"if",hash:{},fn:container.program(3,data,0),inverse:container.noop,data:data}))?stack1:"")+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.isEditable:depth0,{name:"if",hash:{},fn:container.program(5,data,0),inverse:container.noop,data:data}))?stack1:"")+"    </div>\n"+(null!=(stack1=helpers.unless.call(alias1,null!=depth0?depth0.isEditable:depth0,{name:"unless",hash:{},fn:container.program(7,data,0),inverse:container.noop,data:data}))?stack1:"")+(null!=(stack1=helpers.if.call(alias1,null!=depth0?depth0.isResizable:depth0,{name:"if",hash:{},fn:container.program(9,data,0),inverse:container.noop,data:data}))?stack1:"")+"  </div>\n</div>\n"},useData:!0}),"a5.book.annotations.Text":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){var stack1,helper,alias1=null!=depth0?depth0:{},alias2=helpers.helperMissing,alias4=container.escapeExpression;return'<div class="content-text">\n  <div class="wrap">\n    <div class="text">\n      '+(null!=(helper=null!=(helper=helpers.text||(null!=depth0?depth0.text:depth0))?helper:alias2,stack1="function"==typeof helper?helper.call(alias1,{name:"text",hash:{},data:data}):helper)?stack1:"")+'\n    </div>\n    <div class="toolbar">\n      <span class="control handle" title="'+alias4((helper=null!=(helper=helpers.handleHint||(null!=depth0?depth0.handleHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"handleHint",hash:{},data:data}):helper))+'"></span>\n      <span class="control trash" title="'+alias4((helper=null!=(helper=helpers.trashHint||(null!=depth0?depth0.trashHint:depth0))?helper:alias2,"function"==typeof helper?helper.call(alias1,{name:"trashHint",hash:{},data:data}):helper))+'"></span>\n    </div>\n  </div>\n</div>\n'},useData:!0}),"a5.view.dialog.MicNotFound":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div title="Microphone not found">\n  <p>Please enable a microphone. It is required for this activity.</p>\n</div>\n'},useData:!0}),"a5.view.dialog.RecordingError":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div title="Recording error">\n  <p>A technical error occurred and stopped this recording. Please try again.</p>\n</div>\n'},useData:!0}),"a5.view.dialog.UnsupportedDevice":Handlebars.template({compiler:[7,">= 4.0.0"],main:function(container,depth0,helpers,partials,data){return'<div title="Unsupported device">\n  <p>This activity is not supported on this device. Please switch to a desktop device to complete.</p>\n</div>\n'},useData:!0})};
a5.Engine.version="buckminster-31.0.3";